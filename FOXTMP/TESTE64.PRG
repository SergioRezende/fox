SET DELE ON
SET DATE TO GERMAN
SET CENTU ON
SET ESCAPE ON
SET TALK ON
ON ERROR
ON KEY


CLOSE ALL


SELE 0
use Q:\scgc\LOJA\itemmov
SET ORDER TO TAG ITENSNOTA


SELE 0
use Q:\scgc\LOJA\NOTA
SET ORDER TO TAG DATA





SELE NOTA
SET NEAR ON

SEEK STR(8,3)+DTOS({01.01.2005})

do while !eof()

	if  EMPRESA <> 8 
	     EXIT
	ENDIF
  

	if LEFT(OPERACAO,1) <> "S" ;
	    OR ch_opera <> "1" ;
	    OR ch_desti <> "1" 
			skip
			loop
	endif
	
  
  	SELE ITEMMOV
	SEEK STR(NOTA.EMPRESA,3)+;
	    LEFT(NOTA.OPERACAO,1)+;
	    STR(NOTA.NOTA,7)

	M.BASE_CALC = 0
	M.BASE_ISENT = 0

	DO WHILE NOTA.EMPRESA = ITEMMOV.EMPRESA ;
	       AND NOTA.NOTA = ITEMMOV.NOTA

			IF NOTA.TIPO = ITEMMOV.TIPO
				M.BASE_CALC = ITEMMOV.BASE_CALC + M.BASE_CALC
				M.BASE_ISENT = ITEMMOV.BASE_ISENT + M.BASE_ISENT
			ENDIF
		SKIP
	ENDDO
	SELE NOTA

    =RLOCK()
    REPLACE BASE_ISENT WITH M.BASE_ISENT + M.BASE_CALC
    REPLACE BASE_ICMS  WITH M.BASE_CALC
    REPLACE VLR_ICMS   WITH M.BASE_CALC * NOTA.ALIQ_ICMS / 100
    Skip
enddo

