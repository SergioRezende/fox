

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDPI           DFVerifyInst VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:    2  
*        Variable:            DFVerifyInst                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      1                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddpi     &&  DFVerifyInst VALID
#REGION 1
return
*---------------------------------------------------------------*



FUNCTION DFVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("DocFisca")


	DO CASE

		CASE TYPE("PBDocFiscaAlias") = "U" ;
		   		OR EMPTY(PBDocFiscaAlias) ;
		   		OR !USED(PBDocFiscaAlias)
			=DFCreate()					

		CASE !("DOCFISCA.DBF" $ DBF(PBDocFiscaAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBDocFiscaAlias
			=DFCreate()					


		CASE  !(LSPath $ DBF(PBDocFiscaAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=DFDestroi()				
			=DFCreate()					
	ENDCASE

	
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDQ4           DFCreate VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:    3  
*        Variable:            DFCreate                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      2                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddq4     &&  DFCreate VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBDocFiscaAlias") <> "U" ;
	   		AND !EMPTY(PBDocFiscaAlias) ;
	   		AND USED(PBDocFiscaAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBDocFiscaAlias

	IF USED("DocFisca")
	     =NetArqAgain("DocFisca")
	     PBDocFiscaAlias     = Alias()
	ELSE
	     =NetArqAgain("DocFisca")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("DocFisca")
	     PBDocFiscaAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBDocFiscaAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTDocFisca[LMaxDim]
    PUBLIC DIMENSION VDDocFisca[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFDocFisca[1]      && VETOR CABECALHO DOS CAMPOS
    PUBLIC DIMENSION VCDocFisca[2,3]	&& VETOR PARA CONFIGURACOES
	=AFIELDS(VFDocFisca)



	*-----------------------------------------------------------*
	=DFReadProperty()
	=DFSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDR3           DFDestroi VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:    4  
*        Variable:            DFDestroi                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      3                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddr3     &&  DFDestroi VALID
#REGION 1
return
*---------------------------------------------------------------*


FUNCTION DFDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBDocFiscaAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBDocFiscaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBDocFiscaAlias
	*  3- Se aplicar um FECHAMENTO a PBDocFiscaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBDocFiscaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBDocFiscaAlias)) OR ;
	   !("DOCFISCA.DBF" $ DBF(PBDocFiscaAlias))

		RELEASE PBDocFiscaAlias
    	RELEASE VTDocFisca
	    RELEASE VDDocFisca
		RELEASE VFDocFisca
		RELEASE VCDocFisca
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBDocFiscaAlias) AND USED(PBDocFiscaAlias)
		SELECT &PBDocFiscaAlias
		USE
	ENDIF	
	RELEASE PBDocFiscaAlias
    RELEASE VTDocFisca
    RELEASE VDDocFisca
	RELEASE VFDocFisca
	RELEASE VCDocFisca

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDRU           DFReadProp VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:    5  
*        Variable:            DFReadProp                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      4                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddru     &&  DFReadProp VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=DFVerifyInst()

	SELE &PBDocFiscaAlias
	SCATTER TO VTDocFisca
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDS7           DFSetDerivadas VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:    6  
*        Variable:            DFSetDerivadas                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      5                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dds7     &&  DFSetDerivadas VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

**	=DFVerifyInst()
	*--------------------------------------------------------------*
    VDDocFisca(1,1) = "NAOINFORMADO"
   	VDDocFisca(1,2) = 0
   	VDDocFisca(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDSQ           DFSetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:    7  
*        Variable:            DFSetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      6                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddsq     &&  DFSetPropVT VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue


	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
						PrmValue,;
						    PBDocFiscaAlias,;
						    VTDocFisca,;
						    VDDocFisca,;
						    VFDocFisca,;
						    VCDocFisca)

RETURN(Lvalue)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDT9           DFGetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:    8  
*        Variable:            DFGetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      7                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddt9     &&  DFGetPropVT VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBDocFiscaAlias,;
	            VTDocFisca,;
	            VDDocFisca,;
			    VFDocFisca,;
			    VCDocFisca)

RETURN(Lvalue)





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDVA           DFChk_Identidade VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:    9  
*        Variable:            DFChk_Identidade                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      8                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddva     &&  DFChk_Identidade VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFChk_Identidade
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc



	PRIVATE LFretorno
	LFretorno = .t.



	=DFVerifyInst()
    =DFSetPropVT("EMPRESA",PrmEmp)
    =DFSetPropVT("MOD_DOC",PrmMod_doc)
    =DFSetPropVT("COD_IDFORN",PrmCod_IDForn)
    =DFSetPropVT("NRO_DOC",PrmNro_Doc)
    =DFSetPropVT("SERIE_DOC",PrmSerie_Doc)


	LFretorno=DFFind()
RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDVB           DFFind VALID                       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   10  
*        Variable:            DFFind                             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      9                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddvb     &&  DFFind VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFFind

	PRIVATE LEmpresa,;
			LMod_doc,;
			LCod_IDForn,;
			LNro_Doc,;
			LSerie_Doc
			
	
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=DFVerifyInst()


	LEmpresa    = DFGetPropVT("Empresa")
	LMod_Doc    = DFGetPropVT("Mod_Doc")
	LCod_IdForn = DFGetPropVT("Cod_IdForn")
	LNro_Doc    = DFGetPropVT("Nro_Doc")
	LSerie_Doc  = DFGetPropVT("Serie_Doc")


	SELE &PBDocFiscaAlias
	SET ORDER TO TAG DOCFISCAL

	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	     STR(LNro_Doc,7)+LSerie_Doc


	
	IF FOUND()
		=DFReadProperty()
		=DFSetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDVC           DFGetFieldValue VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   11  
*        Variable:            DFGetFieldValue                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      10                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddvc     &&  DFGetFieldValue VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFGetFieldValue
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmField

	IF !DFChk_Identidade(PrmEmp,;
					  PrmMod_doc,;
					  PrmCod_IDForn,;
					  PrmNro_Doc,PrmSerie_Doc)
					
		DO WHILE .T.
			=UPerrosys("Chamada GetFieldValue para Reg. Inexistente!")
		ENDDO
	ENDIF				



RETURN(DFGetPropVT(PrmField))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDVW           DF_Refresh VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   12  
*        Variable:            DF_Refresh                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      11                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddvw     &&  DF_Refresh VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DF_Refresh
PARAMETERS  PrmEmpresa,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc
			
	
	


	PRIVATE LFreturn

	=DFVerifyInst()


	= DFSetPropVT("Empresa"   ,PrmEmpresa)
	= DFSetPropVT("Mod_Doc"   ,PrmMod_doc)
	= DFSetPropVT("Cod_IdForn",PrmCod_IDForn)
	= DFSetPropVT("Nro_Doc"   ,PrmNro_Doc)
	= DFSetPropVT("Serie_Doc" ,PrmSerie_Doc)

	*----------------------------------------------------------------*


	=DFFind()
	
RETURN(.t.)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDWM           DFLerRegistro VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   14  
*        Variable:            DFLerRegistro                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      12                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddwm     &&  DFLerRegistro VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFLerRegistro
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = DFChk_Identidade(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,PrmSerie_Doc)
RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDX9           DFWriteProp VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   15  
*        Variable:            DFWriteProp                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      13                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddx9     &&  DFWriteProp VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=DFVerifyInst()

	SELE &PBDocFiscaAlias
	=RLOCK()
	GATHER FROM  VTDocFisca
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDXQ           DFSalvarRegistro VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   16  
*        Variable:            DFSalvarRegistro                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      14                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddxq     &&  DFSalvarRegistro VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFSalvarRegistro


	PRIVATE LFretorno
	LFretorno = .t.

	IF !DFExiste()
		SELE &PBDocFiscaAlias
		APPEND BLANK
		LFretorno=DFWriteProp()
	ELSE
		SELE &PBDocFiscaAlias
		LFretorno=DFWriteProp()
	ENDIF

RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDY5           DFExiste VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   17  
*        Variable:            DFExiste                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      15                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddy5     &&  DFExiste VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFExiste

	PRIVATE LEmpresa,;
			LMod_doc,;
			LCod_IDForn,;
			LNro_Doc,;
			LSerie_Doc
			
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()


	LEmpresa    = DFGetPropVT("Empresa")
	LMod_Doc    = DFGetPropVT("Mod_Doc")
	LCod_IdForn = DFGetPropVT("Cod_IdForn")
	LNro_Doc    = DFGetPropVT("Nro_Doc")
	LSerie_Doc  = DFGetPropVT("Serie_Doc")


	SELE &PBDocFiscaAlias
	SET ORDER TO TAG DOCFISCAL
	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	     STR(LNro_Doc,7)+LSerie_Doc

	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DDYW           DFGerNFDocFiscal VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   18  
*        Variable:            DFGerNFDocFiscal                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      16                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ddyw     &&  DFGerNFDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFGerNFDocFiscal
PARAMETER PrmEmp,PrmDtIni,PrmDtFim




    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTA")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=DFVerifyInst()



	SELE &ALSNota
	SET ORDER TO TAG DATA
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() AND &ALSNota .empresa = PrmEmp ;
				AND &ALSNota .data >= PrmDtIni ;
    	        AND &ALSNota .data <= PrmDtFim ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

	DO WHILE !EOF() ;
					AND	LFsegue = .t. ;
					AND &ALSNota .empresa = PrmEmp ;
					AND &ALSNota .data >= PrmDtIni ;
	                AND &ALSNota .data <= PrmDtFim
		
		=UPtermo()


		DO CASE
			CASE &ALSNota .Nota > 2000000 AND  &ALSNota .Nota < 3000000
				LsOrientacao = "SERVICO"

			CASE &ALSNota .Nota > 4000000 AND  &ALSNota .Nota < 5000000
				LsOrientacao = "SERVICO"

			CASE  &ALSNota .totservico > 0 AND &ALSNota .totproduto > 0
				LsOrientacao = "PRODUTO/SERVICO"

			CASE  &ALSNota .totservico > 0
				LsOrientacao = "SERVICO"

			CASE   &ALSNota .totproduto > 0
				LsOrientacao = "PRODUTO"
			OTHERWISE
				LsOrientacao = "PRODUTO/SERVICO"

			
		ENDCASE
		
		




		=DFConvrtNFDocFiscal(PrmEmp, &ALSNota .Nota,LsOrientacao)

		HFIM =TIME()
		MSG  = "NF Saida:"+ STR( &ALSNota .nota ,7);
                   +" de "+ DTOC( &ALSNota .data );
		 	   +"Geradas:"+ STR(CTR,6);
		 	   +    " de "+ HINI ;
		 	   +      "->"+ HFIM
		WAIT WINDOW MSG NOWAIT

		SELE  &ALSNota
		SKIP
		CTR = 	CTR + 1
	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DE0F           DFv10GravaXMLDocFiscal VALID       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   20  
*        Variable:            DFv10GravaXMLDocFiscal             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      17                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15de0f     &&  DFv10GravaXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFv10GravaXMLDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmFileXML,;
			PrmNroIDfileXML,;
			PrmObjetivo





	IF TYPE("PrmObjetivo") <> "C" ;
	   OR !(PrmObjetivo $ "ESCRITURACAO/EMISSAO/CANCELAMENTO" )
		  PrmObjetivo = "ESCRITURACAO"
	ENDIF


	IF !DFLerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+PrmMOD_DOC+;
		      "FORN. : "+STR(PrmCOD_IDFORN,6)+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC
   	  return(.F.)
   ENDIF


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	*-------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	=EMLerRegistro(PrmEmp)

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("CGC")
	UNEM_CNPJ    =  STR(LFieldTmp,14)
	UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")


	SET POINT TO ","
	SET SEPARATOR  TO "."




	LSLinhaXML = ULtratalinha('<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('XML_OBJETIVO="'+;
	             PrmObjetivo +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*==========================================================*
	*  CAMPOS IDENTIFICADORES
	*==========================================================*

	=W_DEFPROC("EMPRESA.SPR")

	LSEmite_NFe = EMGetPropVT("EMITE_NFE")




	IF LSEmite_NFe $ "H"   && H=HOMOLOGACAO

		LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             "55" +;
	             '"')
                =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	ELSE
		LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             DFGetPropVT("MOD_DOC") +;
	             '"')
                =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	ENDIF

	LSLinhaXML = ULtratalinha('DFIS_IND_OPERACAO="'+;
	             DFGetPropVT("IND_OPER") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
	LSLinhaXML = ULtratalinha('DFIS_TP_MOVIMENTO="'+;
	             DFGetPropVT("TP_MOV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*

	LNNro_Doc  = DFGetPropVT("NRO_DOC")
	IF LNNro_Doc > 3000000
		LNNro_Doc = LNNro_Doc - 3000000
	ENDIF



	LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO_FISCAL="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*----------------------------------------------------*
	* SERIE UNICA => "0"
	*----------------------------------------------------*
	

	LSLinhaXML = DFGetPropVT("SERIE_DOC")
	IF "U" $ LSLinhaXML
		LSLinhaXML = "0"
	ENDIF

	LSLinhaXML = ULtratalinha('DFIS_SERIE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*
	LSLinhaXML = ULtratalinha('DFIS_STATUS="'+;
	             DFGetPropVT("DFISSTATUS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_IE_SUB_TRIB="'+;
	             DFGetPropVT("IE_SUBTRIB") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_MUNI_IBGE_FATO_GERADOR="'+;
	             DFGetPropVT("MUNIFATOGR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_NOME="'+;
	             DFGetPropVT("NOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_RAZAO_SOCIAL="'+;
	             DFGetPropVT("RAZAOSOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CPF="'+;
	             DFGetPropVT("CPF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CNPJ="'+;
	             DFGetPropVT("CNPJ") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IE="'+;
	             DFGetPropVT("IE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_SUFRAMA="'+;
	             DFGetPropVT("SUFRAMA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))





*	LSLinhaXML = ULtratalinha('DFIS_E_MAIL="'+;
*	             DFGetPropVT("E_MAIL") +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*


	LSLinhaXML = ULtratalinha('DFIS_E_MAIL="'+;
	             DFGetPropVT("E_MAIL_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_E_MAIL_NFE="'+;
	             DFGetPropVT("E_MAIL_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*	LSLinhaXML = ULtratalinha('DFIS_DDD="'+;
*	             DFGetPropVT("DDD") +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*
	LSLinhaXML = ULtratalinha('DFIS_DDD="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_FONE="'+;
	             DFGetPropVT("FONE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TP_LOGADOURO="'+;
	             DFGetPropVT("TP_LOGRAD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_LOGRADOURO="'+;
	             DFGetPropVT("LOGRADOURO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_LOGRADOURO="'+;
	             DFGetPropVT("NRO_LOGRAD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_COMPL_LOGRADOURO="'+;
	             DFGetPropVT("COMPL_LOGR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_BAIRRO="'+;
	             DFGetPropVT("BAIRRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ZONA="'+;
	             ("") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ALLTRIM(DFGetPropVT("MUNI_IBGE"))
	IF LEN(LSLinhaXML) < 7
		LSLinhaXML = REPLICATE("0",7-LEN(LSLinhaXML))
	ENDIF


	LSLinhaXML = ULtratalinha('DFIS_MUNI_IBGE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MUNI_NOME="'+;
	             DFGetPropVT("MUNI_NOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_UF="'+;
	             DFGetPropVT("UF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_CEP="'+;
	             DFGetPropVT("CEP") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_PAIS="'+;
	             DFGetPropVT("PAIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CODIGO_PAIS="'+;
	              "1058" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------*


	LSLinhaXML = ULtratalinha('DFIS_OPCM_SIGLA="'+;
	             DFGetPropVT("TIPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NATUREZA_OPERACAO="'+;
	             DFGetPropVT("NAT_OPER") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IND_EMITENTE="'+;
	             DFGetPropVT("IND_EMITEN") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_SITUACAO_CODIGO="'+;
	             DFGetPropVT("COD_SIT") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = DFGetPropVT("IND_FRETE")
	IF LSLinhaXML = "1"
	    LSLinhaXML    =   "0"
	else
	    LSLinhaXML    =   "1"
	ENDIF
	LSLinhaXML = ULtratalinha('DFIS_IND_FRETE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DT_DOC="'+;
	             DTOC(DFGetPropVT("DT_DOC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_HORA_DOC="'+;
	             DFGetPropVT("HORA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*	LSLinhaXML = ULtratalinha('DFIS_DT_ENT_OU_SAIDA="'+;
*	             DTOC(DFGetPropVT("DT_ENTSAI")) +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*

	LSLinhaXML = ULtratalinha('DFIS_DT_ENT_OU_SAIDA="'+;
	             ;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*	LSLinhaXML = ULtratalinha('DFIS_HR_ENT_OU_SAIDA="'+;
*	             DFGetPropVT("HR_ENTSAI") +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*

	LSLinhaXML = ULtratalinha('DFIS_HR_ENT_OU_SAIDA="'+;
	             ;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DT_CANC="'+;
	             DTOC(DFGetPropVT("DT_CANC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_PGTO_CODIGO="'+;
	             DFGetPropVT("TP_PG") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_PGTO_DESCRICAO="'+;
	             DFGetPropVT("TP_PGDESCR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ESPECIE="'+;
	             DFGetPropVT("ESPECIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MARCA="'+;
	             DFGetPropVT("MARCA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IND_USO_ARMA="'+;
	             DFGetPropVT("INDUSOARMA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IND_OPER_VEICULO="'+;
	             DFGetPropVT("IND_OPVEIC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_AUT_SEFAZ_COMBUSTIVEL="'+;
	             DFGetPropVT("AUTSEFAZCM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_DOC_IMPORTACAO="'+;
	             DFGetPropVT("TPDOCIMPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
				
	LSLinhaXML = ULtratalinha('DFIS_NRO_DOC_IMPORTACAO="'+;
	             DFGetPropVT("NRODOCIMPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_NRO_PASSE_FISCAL="'+;
	             DFGetPropVT("NROPASSEFI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_PROC_CONCESSORIO="'+;
	             DFGetPropVT("NROPROCCON") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ORIGEM_PROC_CONCESSORIO="'+;
	             DFGetPropVT("ORGPROCCON") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_INF_COMPLEMENTARES="'+;
	             DFGetPropVT("INF_COMPLE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = "SIM"
	LSLinhaXML = ULtratalinha('DFIS_TRIBUTADA_MUNICIPIO="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

    *-------------------------------------------------------------*
   	LSLinhaXML = ULtratalinha('DFIS_PESO_BRUTO="'+;
	             STR(DFGetPropVT("PESO_BRUTO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PESO_LIQUIDO="'+;
	             STR(DFGetPropVT("PESO_LIQ"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_QTDE_VOLUMES="'+;
	             STR(DFGetPropVT("QTDE_VOL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_NUMERACAO_VOLUMES="'+;
	             "" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TP_CARGA="'+;
	             DFGetPropVT("TP_CARGA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TEMPERATURA="'+;
	             STR(DFGetPropVT("TEMPERATUR"),6,1) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_ECF_MODELO="'+;
	             DFGetPropVT("MODELO_ECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ECF_NUMERO_CAIXA="'+;
	             DFGetPropVT("NRO_CX_ECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ECF_NUMERO_CUPOM_COO="'+;
	             DFGetPropVT("NRO_CPMECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ECF_NUMERO_SERIE="'+;
	             DFGetPropVT("NRO_SERECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*------------------------------------------------------------*
	*----------
	*LSLinhaXML = ULtratalinha('DFIS_REF_NRO_DOCUMENTO="'+;
	*             SUBS(STR(DFGetPropVT("REF_NRODOC"),7),2) +;
	*             '"')
	*			=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *----------


	LNNro_Doc  = DFGetPropVT("REF_NRODOC")
	IF LNNro_Doc > 3000000
		LNNro_Doc = LNNro_Doc - 3000000
	ENDIF



	LSLinhaXML = ULtratalinha('DFIS_REF_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_SERIE="'+;
	             DFGetPropVT("REF_SERIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	

	LSLinhaXML = ULtratalinha('DFIS_REF_DT_DOC="'+;
	             DTOC(DFGetPropVT("REF_DT_DOC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_INDOPERACAO="'+;
	             DFGetPropVT("REF_INDOPE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_TP_MOVIMENTO="'+;
	             DFGetPropVT("REF_TP_MOV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_IND_EMITENTE="'+;
	             DFGetPropVT("REF_INDEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_MOD_DOCUMENTO="'+;
	             DFGetPropVT("REF_MODDOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_CHV_NFe="'+;
	             DFGetPropVT("REF_CHVNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_DGT_NFe="'+;
	             DFGetPropVT("REF_DGTNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_CODIGO_UF_EMITENTE="'+;
	             DFGetPropVT("REF_UF_CDG") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_DT_EMISSAO_NFE="'+;
	             DTOC(DFGetPropVT("REF_DTNFE")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_FORMATO_IMP_DANF="'+;
	             DFGetPropVT("REFFRDANF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_FORMA_EMISSAO_NFE="'+;
	             DFGetPropVT("REFTPEMIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_AMBIENTE_EMISSAO_NFE="'+;
	             DFGetPropVT("REFTPAMBIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_PROCESSO_EMISSAO_NFE="'+;
	             DFGetPropVT("REFPROCEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_VERSAO_NFE="'+;
	             DFGetPropVT("REFVERSAO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_FINALIDADE_EMISSAO_NFE="'+;
	             DFGetPropVT("REFFINALID") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*------------------------------------------------------------*
	LSLinhaXML = ULtratalinha('NFE_CHAVE_ACESSO="'+;
	             DFGetPropVT("NFE_CHV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_AMBIENTE_EMISSAO="'+;
	             DFGetPropVT("AMBIENTNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_DATA_EMISSAO="'+;
	             DTOC(DFGetPropVT("DTEMINFE")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('NFE_FINALIDADE_EMISSAO="'+;
	             DFGetPropVT("FNLDAD_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('NFE_FORMA_EMISSAO="'+;
	             DFGetPropVT("NFEFRMAEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_FORMATO_IMPRESSAO_DANF="'+;
	             DFGetPropVT("FRMTODANF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_PROCESSO_EMISSAO="'+;
	             DFGetPropVT("PROCEMINFE") +;
	             '"')
	             =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('NFE_STATUS="'+;
	             DFGetPropVT("NFE_STATUS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_STATUS_DESCRICAO="'+;
	             "" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('NFE_NUMERO_RECIBO="'+;
	             DFGetPropVT("NFE_RECIBO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_NUMERO_PROTOCOLO="'+;
	             DFGetPropVT("NFE_PROTOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('NFE_JUSTIFICATIVA="'+;
	             DFGetPropVT("NFEJSTFCAN") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_PROTOCOLO_CANCELAMENTO="'+;
	             DFGetPropVT("NFEPRTCCAN") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VERSAO_NFE="'+;
	             DFGetPropVT("VERSAO_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*-- TRANSPORTADORA  -------------------------------------*


	LSLinhaXML = ULtratalinha('DFTR_TEM_TRANSPORTADORA="'+;
	             DFGetPropVT("TRSTEM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_RNTC="'+;
	             DFGetPropVT("TRSRNTC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_PLACA_UF="'+;
	             DFGetPropVT("TRSPLACAUF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_PLACA_VEICULO="'+;
	             DFGetPropVT("TRSPLACA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_CPFCNPJ="'+;
	             DFGetPropVT("TRSCPFCNPJ") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_NOME="'+;
	             DFGetPropVT("TRSNOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_UF="'+;
	             DFGetPropVT("TRSUF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_IE="'+;
	             DFGetPropVT("TRSIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_TP_LOGRADOURO="'+;
	             DFGetPropVT("TRSLOGRA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_LOGRADOURO="'+;
	             DFGetPropVT("TRSLOGRA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_NRO="'+;
	             DFGetPropVT("TRSNRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COMPLEMENTO="'+;
	             DFGetPropVT("TRSCOMPLEM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_CEP="'+;
	             DFGetPropVT("TRSCEP") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_MUNI_IBGE="'+;
	             DFGetPropVT("TRSMUNIBGE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_MUNI_NOME="'+;
	             DFGetPropVT("TRSMUNNOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_BAIRRO="'+;
	             DFGetPropVT("TRSBAIRRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_PAIS="'+;
	             DFGetPropVT("TRSPAIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_FONE="'+;
	             DFGetPropVT("TRSFONE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*--------------------------------------------------------------*
	LSLinhaXML = ULtratalinha('DFTR_COLETA_CPFCNPJ="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COLETA_IE="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COLETA_NOME="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_COLETA_MUNI_IBGE="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COLETA_ENDERECO="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*--------------------------------------------------------------*
	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_CPFCNPJ="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_IE="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_NOME="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_MUNI_IBGE="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_ENDERECO="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*----------------------------------------------------*

	*----------------------------------------------------*

	LSLinhaXML = ULtratalinha('DFIS_VLR_DOCUMENTO="'+;
	             STR(DFGetPropVT("VLR_DOC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_SERVICOS="'+;
	             STR(DFGetPropVT("VLR_SERVIC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_FRETE="'+;
	             STR(DFGetPropVT("VLR_FRETE"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_DESCONTO="'+;
	             STR(DFGetPropVT("VLR_DESCON"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_SEGURO="'+;
	             STR(DFGetPropVT("VLR_SEGURO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_MERCADORIAS="'+;
	             STR(DFGetPropVT("VLR_MERCAD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ABATE_NT="'+;
	             STR(DFGetPropVT("VLRABAT_NT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_DESPESAS="'+;
	             STR(DFGetPropVT("VLR_DESPES"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_DESP_FINANCEIRA="'+;
	             STR(DFGetPropVT("DESPFINANC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_OUTRAS_DESP_ACES="'+;
	             STR(DFGetPropVT("OUTDSPACES"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	********************************************************************
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	********************************************************************
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	********************************************************************

	*----------------------------------------------------*
	*     Campos de Preenchimento Doc Fiscal Para EFD versao 1.0
	* (SERAO DESCARTADOS NA PROXIMA VERS홒 )-->
	* nao e necessario preencher para versoes NFe e EFD que se
	* baseiam na TABELA DFIS DOCUMENTOS FISCAIS
	*
	*----------------------------------------------------*



	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS="'+;
	             STR(DFGetPropVT("BC_ICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS="'+;
	             STR(DFGetPropVT("VLR_ICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS_RTD="'+;
	             STR(DFGetPropVT("BC_ICMSRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_RTD="'+;
	             STR(DFGetPropVT("VLRICMSRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_IPI="'+;
	             STR(DFGetPropVT("BC_IPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_IPI="'+;
	             STR(DFGetPropVT("VLR_IPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS="'+;
	             STR(DFGetPropVT("VLR_PIS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS="'+;
	             STR(DFGetPropVT("VLR_COFINS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_RTD="'+;
	             STR(DFGetPropVT("VLR_PISRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_RTD="'+;
	             STR(DFGetPropVT("VLR_COFRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_IMPORTACAO="'+;
	             STR(DFGetPropVT("VLRPISIMPO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_IMPORTACAO="'+;
	             STR(DFGetPropVT("VLRCOFIMPO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_SERVICO_NT="'+;
	             STR(DFGetPropVT("VLRSRVCONT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISS="'+;
	             STR(DFGetPropVT("VLRBCISSQN"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ISS="'+;
	             STR(DFGetPropVT("VLR_ISSQN"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_IR="'+;
	             STR(DFGetPropVT("VLR_BCIRRF"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_IR="'+;
	             STR(DFGetPropVT("VLR_IRRF"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
				

	LSLinhaXML = ULtratalinha('DFIS_VLR_IR_RTD="'+;
	             STR(0,18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_PREVIDENCIA="'+;
	             STR(DFGetPropVT("VLR_BCPREV"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PREVIDENCIA="'+;
	             STR(DFGetPropVT("VLR_PREV"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*-------------------------------------------------------*


*
*	LSLinhaXML = ULtratalinha('DFIS_TP_CREDITO="'+;
*	             DFGetPropVT("TP_CREDITO") +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS_RTD="'+;
	             STR(DFGetPropVT("BCBRICMSRT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS="'+;
	             STR(DFGetPropVT("BCBRICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS_SO="'+;
	             STR(DFGetPropVT("BCBRICMSSO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("BCBRRTDENT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_COFINS="'+;
	             STR(DFGetPropVT("BC_COFINS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_CSLL="'+;
	             STR(DFGetPropVT("BC_CSLL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS_SO="'+;
	             STR(DFGetPropVT("BC_ICMS_SO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_SO="'+;
	             STR(DFGetPropVT("VLR_ICMSSO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISENTA_ICMS="'+;
	             STR(DFGetPropVT("BCISENICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISENTA_IPI="'+;
	             STR(DFGetPropVT("BCISENIPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_OUTR_ICMS="'+;
	             STR(DFGetPropVT("BCOUTRICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_PIS="'+;
	             STR(DFGetPropVT("BC_PIS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("BCRTDENTRA"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_CSLL="'+;
	             STR(DFGetPropVT("VLR_CSLL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("ICMSRTDENT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISS_RTD="'+;
	             STR(DFGetPropVT("BC_ISS_RTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_ISS_RTD="'+;
	             STR(DFGetPropVT("ISS_RTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_PRODUTOS_SERVICOS="'+;
	             STR(DFGetPropVT("TTPRODSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_ALIQ_COFINS="'+;
	             STR(DFGetPropVT("VLRALQCOFI"),5,2) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IM="'+;
	             DFGetPropVT("IM_TOMADOR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_SERVICOS="'+;
	             STR(DFGetPropVT("VLRPISSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_SERVICOS="'+;
	             STR(DFGetPropVT("VLRCOFSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_CODIGO_PAIS_DESTINATARIO="'+;
	              "1058" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*-------------------------------------------------------*
	LSLinhaXML = ULtratalinha('/>')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)

FUNCTION ULtratalinha
PARAMETERS LSLINHA

	LSLINHA = UPPER(LSLINHA)
	LSLINHA = RTRIM(LSLINHA)

RETURN(LSLINHA)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DEG1           DFGetAlias VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   21  
*        Variable:            DFGetAlias                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      18                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15deg1     &&  DFGetAlias VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFGetAlias

	=DFVerifyInst()

RETURN(PBDocFiscaAlias)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DEGC           DFGerXMLPeriodoDocFiscal VALID     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   22  
*        Variable:            DFGerXMLPeriodoDocFiscal           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      19                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15degc     &&  DFGerXMLPeriodoDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFGerXMLPeriodoDocFiscal
PARAMETER PrmEmpresa,PrmDtIni,PrmDtFim





	PRIVATE	 PrmObjetivo
		
		
		
	*-----------------------------------------------------*
	* PrmObjetivo => indica o objetivo da gera눯o do xml pode ser:
	*
	*      "EMISSAO"      => Para EMISSOA - NFe/NFSe/CUPOM
	*      "ESCRITURACAO" => Para registro do documento
	*      "CANCELAMENTO" => Para Cancelar o Documento
	*-----------------------------------------------------*

    PrmObjetivo = "ESCRITURACAO"


	*-----------------------------------------------------*

	PRIVATE LSalias
	
	PRIVATE PrmAlsDF

	PRIVATE LNDocFiscaCtrRegistro	

	LSalias = ALIAS()
	PrmAlsDF = DFGetAlias()



	*-------------------------------------------------------*

	=DFModeloRefXML()  && VERIFICA ATUALIZACAO DO LAYOUT


	*-------------------------------------------------------*

	*-------------------------------------------------------*


   	PRIVATE LSfileXML,LNroIDfileXML, LSnomeArqXml

	LSnomeArqXml = STR(PrmEmpresa,2)+;
				   "DC"+;
				   STR(MONTH(PrmDtFim),2)+;
				   STR(DAY(PrmDtFim),2)

	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")

   	LSfileXML	= "\SCGC\EFD\"+LSnomeArqXml+".XML"

  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria눯o arquivo tempor쟲io '+LSfileXML+'- <ENTER> ' window
      return
   	endif


	*---------------------------------------------------*

	SELE &PrmAlsDF
	SET ORDER TO TAG DATA_DOC
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+DTOS(PrmDtIni)
	SET NEAR OFF

	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNDocFiscaCtrRegistro = RECNO()

	COUNT  WHILE !EOF() ;
	        AND PrmEmpresa =  &PrmAlsDF .empresa;
	        AND PrmDtIni   <= &PrmAlsDF .DT_ENTSAI ;
	        AND PrmDtFim   >= &PrmAlsDF .DT_ENTSAI ;
         TO LNimpressao
	GO LNDocFiscaCtrRegistro
	LNimpressos = 0
	*----------------------------------------------------*



	=DFInicioXML(LSfileXML,LNroIDfileXML)

	SELE &PrmAlsDF
	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa =  &PrmAlsDF .empresa;
	        AND PrmDtIni   <= &PrmAlsDF .DT_ENTSAI ;
	        AND PrmDtFim   >= &PrmAlsDF .DT_ENTSAI

		=UPtermo()



		=DFGravaXMLDocFiscal(;
				&PrmAlsDF .Empresa,;
				&PrmAlsDF .Mod_doc,;
				&PrmAlsDF .Cod_IDForn,;
				&PrmAlsDF .Nro_Doc,;
				&PrmAlsDF .Serie_Doc,;
				LSfileXML,;
				LNroIDfileXML,;
				PrmObjetivo)



		SELE &PrmAlsDF
		SET ORDER TO TAG DATA_DOC
		*-----------------------*
		GO LNDocFiscaCtrRegistro
	
		SKIP
	
		LNDocFiscaCtrRegistro = RECNO()

	ENDDO

	=DFFinalXML(LSfileXML,LNroIDfileXML)

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DEJS           DFModeloRefXML VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   23  
*        Variable:            DFModeloRefXML                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      20                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dejs     &&  DFModeloRefXML VALID
#REGION 1
RETURN

FUNCTION DFModeloRefXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\DOCFISCA.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\xmlDCFIS EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE xmlDCFIS


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DEJT           DFInicioXML VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   24  
*        Variable:            DFInicioXML                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      21                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dejt     &&  DFInicioXML VALID
#REGION 1
RETURN

FUNCTION DFInicioXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML




   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDCFIS
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND xmlDCFIS.XML_ORDEM < 9999999999901
	
		LSLinhaXML = xmlDCFIS.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE xmlDCFIS
	USE
		

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DEJU           DFFinalXML VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   25  
*        Variable:            DFFinalXML                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      22                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15deju     &&  DFFinalXML VALID
#REGION 1
RETURN

FUNCTION DFFinalXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDCFIS
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF xmlDCFIS.XML_ORDEM > 9999999999900
			LSLinhaXML = xmlDCFIS.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE xmlDCFIS
	USE
		

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DEK5           DFGerNEDocFiscal VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   26  
*        Variable:            DFGerNEDocFiscal                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      23                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dek5     &&  DFGerNEDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFGerNEDocFiscal
PARAMETER PrmEmp,PrmDtIni,PrmDtFim




    PRIVATE ARQNotaEnt,ALSNotaEnt
	LSalias = ALIAS()

    ARQNotaEnt     = NetArqAgain("NotaEnt")
    ALSNotaEnt     = Alias()

	IF ( ARQNotaEnt) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNotaEnt")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=DFVerifyInst()


	SELE &ALSNotaEnt
	SET ORDER TO TAG DATA_FAT
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() AND &ALSNotaEnt .empresa = PrmEmp ;
				AND &ALSNotaEnt .data >= PrmDtIni ;
    	        AND &ALSNotaEnt .data <= PrmDtFim ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

	DO WHILE !EOF() ;
					AND	LFsegue = .t. ;
					AND &ALSNotaEnt .empresa = PrmEmp ;
					AND &ALSNotaEnt .data >= PrmDtIni ;
	                AND &ALSNotaEnt .data <= PrmDtFim
	

		=UPtermo()
		
		IF &ALSNotaEnt .TIPO $ "QLA/SCA"
			SKIP
			LOOP
		ENDIF

		IF   &ALSNotaEnt .ch_opera $"56" ;
		  OR LEFT( &ALSNotaEnt .situacao,1) <> "C"
			SKIP
			LOOP
		ENDIF



		HFIM =TIME()
		MSG  = "GERANDO NF ENTRADA:" +HINI+ "  " +STR(CTR,3)+ "  " + HFIM


		MSG  = "NF Entrada:"+ STR( &ALSNotaEnt .Nota ,7);
                   +" de "+ DTOC( &ALSNotaEnt .data );
		 	   +"Geradas:"+ STR(CTR,6);
		 	   +    " de "+ HINI ;
		 	   +      "->"+ HFIM

		WAIT WINDOW MSG NOWAIT


		=DFConvrtNEDocFiscal(PrmEmp, ;
		                     &ALSNotaEnt .Nota,;
							 &ALSNotaEnt .CodForn)


		SELE  &ALSNotaEnt
		SKIP
		CTR = 	CTR + 1
	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =up_fecha("&ALSNotaEnt")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DELL           DFSetConfig VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   27  
*        Variable:            DFSetConfig                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      24                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dell     &&  DFSetConfig VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFSetConfig
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VCDocFisca(1,1) = "NAOINFORMADO"
   	VCDocFisca(1,2) = 0
   	VCDocFisca(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DEM2           DFConvrtNFDocFiscal VALID          
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   28  
*        Variable:            DFConvrtNFDocFiscal                
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      25                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dem2     &&  DFConvrtNFDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

* PRECISO DEFINIR :
*---------------------------------------------------------------*
*           PrmEmpresa :  - a empresa
*           PrmNota....:  - Nro da nota a converte
*
*
*           LNComBaseNaNota  -Se for converter uma Copia de Copom
*                                -> tenho que tomar por base os dados
*                                do cupom que gerou a c줽ia pq o cupom
*                                nao gera registro fisico de seus itens
*
*                             -Se for uma nota direta (no copia
*                                de cupom) sera gerado com base na
*                                 propria nota
*
*---------------------------------------------------------------*


FUNCTION DFConvrtNFDocFiscal
PARAMETERS PrmEmpresa,PrmNota,PrmOrientacao

	PRIVATE PrmAlias
	PRIVATE LCupomAlias
	PRIVATE LOrc_AnexAlias



	PRIVATE  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc,;
	 RtnDocEletro



	=DFVerifyInst()


	=W_DEFPROC("NOTA.SPR")
	PrmAlias = NFGetAlias()

	=W_DEFPROC("CUPOM.SPR")
	LCupomAlias = CPGetAlias()


	=W_DEFPROC("ORC_ANEX.SPR")
	LOrc_AnexAlias = OAGetAlias()



	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NFs nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"


		WAIT MSG NOWAIT
		RETURN(.F.)
	ENDIF





    IF   &PrmAlias .tipo ="ENT"   && NAO CONSIDERA "ENT"
		RETURN(.T.)
	ENDIF    	






	*---------------------------------------------------*
	* CONVERSAO DOS ITENS
	*---------------------------------------------------*

	=W_DEFPROC("DOCFISIT.SPR")
	=DIVerifyInst()




	=W_DEFPROC("DOCFISIT.SPR")
	IF !DIConvrtNFDocFiscal(PrmEmpresa,PrmNota,PrmOrientacao)
		WAIT WINDOW ;
		 "Nao foi possiver gerar itens do Doc Fiscal<ENTER> " NOWAIT
		RETURN(.F.)
	ENDIF



	*---------------------------------------------------*

	PRIVATE  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc,;
	 RtnDocEletro


	PrmSerie   		= &PrmAlias .Serie
	PrmTipo    		= &PrmAlias .tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""
	RtnDocEletro    = ""
	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc,RtnDocEletro)


    m.EMPRESA    =   &PrmAlias .Empresa
    m.TIPO    	 =   &PrmAlias .tipo
    m.MOD_DOC    =   RtnMod_Doc
    m.COD_IDFORN  =   RtnCOD_IDFORN
    m.NRO_DOC     =   RtnNro_Doc
    m.SERIE_DOC   =   RtnSerie_Doc


	m.DOC_ELETRO  = RtnDocEletro

	m.nro_nota  =  &PrmAlias .Nota
	m.nro_isi   =  &PrmAlias .orcamento


	*---------------------------------------------------*


    m.NAT_OPER    =   &PrmAlias .natureza

    IF EMPTY(m.nat_oper)
    	=W_DEFPROC("TIPOOPER.SPR")
		LFieldTmp    = TPGetFieldValue("S",  &PrmAlias .tipo ,"DESCNATU")
    	m.NAT_OPER   =   LFieldTmp
    ENDIF




	IF LEFT( &PrmAlias .tipo,2) = "ET"   && ENTRADAS DEVOLUCAO
	    m.IND_OPER    =   "0"    && 0-ENTRADA  1-SAIDA
    	m.TP_MOV      =   "ENTRADA" 	&& ENTRADA  // SAIDA
	ELSE	
	    m.IND_OPER    =   "1"    && 0-ENTRADA  1-SAIDA
    	m.TP_MOV      =   "SAIDA" 	&& ENTRADA  // SAIDA
	ENDIF


    m.IND_EMITEN  =   "0"  && 0-EMISSAO PROPRIA // 1-TERCEIROS

	&& 00-DOC REGULAR // 02-DOC CANCELADO
	DO CASE

		CASE  &PrmAlias .Status = 2   && CANCELADO
			LFieldTmp    = "02"

		CASE  &PrmAlias .TIPO = "CPM"   && COPIA DE CUPOM
			LFieldTmp    = "00"     && CUPOM


		OTHERWISE
			LFieldTmp    = "00"     && DOC REGULAR
	ENDCASE	

    m.COD_SIT    = LFieldTmp
    m.MOD_NOTA   = ""		&& NAO INFORMADO
    m.DT_DOC     = &PrmAlias .data
    m.HORA    	 = &PrmAlias .HORA

	IF EMPTY(M.HORA)
	  M.HORA = "08:00:00"
	ENDIF


    m.NFE_STATUS = &PrmAlias .NFE_STATUS
    m.NFE_CHV  	 = &PrmAlias .NFE_CHV
    m.NFE_RECIBO = &PrmAlias .NFE_RECIBO
    m.NFEJSTFCAN = &PrmAlias .NFEJSTFCAN
    m.NFEPRTCCAN = &PrmAlias .NFEPRTCCAN



	&& 00-DOC REGULAR // 02-DOC CANCELADO
	DO CASE
		CASE &PrmAlias .Status = 2   && CANCELADO
			LFieldTmp    = &PrmAlias .Data  && DATA CANCELAMENTO

		OTHERWISE
			LFieldTmp    = {}
	ENDCASE	
    m.DT_CANC    =  LFieldTmp
    m.VLR_DOC    =  &PrmAlias .Total_nota

*-> NFe ==>  0-A VISTA   1-A PRAZO   2-OUTROS SEM PGTO
*-> efd ==>  0-A VISTA   1-A PRAZO   9-OUTROS SEM PGTO

	IF &PrmAlias .Ch_Opera= "1"  && 1-VENDA
		IF &PrmAlias .Tp_pgto = 1
			LFieldTmp    = "0"
		ELSE
			LFieldTmp    = "1"
		ENDIF
	ELSE
		LFieldTmp    = "0"
	ENDIF
    m.TP_PG    =   LFieldTmp

	IF &PrmAlias .Ch_Opera= "1"  && 1-VENDA
		IF &PrmAlias .Tp_pgto = 1
			LFieldTmp    = "A VISTA"
		ELSE
			LFieldTmp    = "A PRAZO"
		ENDIF
	ELSE
		LFieldTmp    = "SEM PGTO"
	ENDIF
    m.TP_PGDESCR    =   LFieldTmp

    m.VLR_DESCON    =   0
    m.VLRABAT_NT    =   0
    m.VLR_SERVIC    =   &PrmAlias .TotServico
    m.VLR_MERCAD    =   &PrmAlias .TotProduto
	IF &PrmAlias .pgto_frete = 1
	    m.IND_FRETE    =   "1"
	else
	    m.IND_FRETE    =   "2"
	ENDIF	
    m.VLR_FRETE    =   &PrmAlias .VlrFrete
    m.VLR_SEGURO   =   &PrmAlias .VlrSeguro
    m.VLR_DESPES   =   &PrmAlias .VlrDespes
    m.OUTDSPACES   =   0
    m.BC_ICMS      =   &PrmAlias .Base_Icms
    m.VLR_ICMS     =   &PrmAlias .Vlr_Icms
    m.BC_ICMSRTD   =   &PrmAlias .Base_subs
    m.VLRICMSRTD   =   &PrmAlias .ICms_Subs
    m.BC_IPI   	   =   &PrmAlias .Base_IPI
    m.VLR_IPI      =   &PrmAlias .Vlr_ipi

    m.VLR_PIS      =   0   && NAO INFORMADO
    m.VLR_COFINS   =   0   && NAO INFORMADO
    m.VLR_PISRTD   =   0   && NAO INFORMADO
    m.VLR_COFRTD   =   0   && NAO INFORMADO

    m.INF_COMPLE   =  DFLimpaString(  &PrmAlias .citacao3 )

	IF  &PrmAlias .cupom > 0 AND m.MOD_DOC <> "2D"
		 m.INF_COMPLE = "COPIA DO CUPOM FISCAL N ";
		 				+ STR( &PrmAlias .cupom,6)
	ENDIF


    m.NROPROCCON   =   ""    && NAO INFORMADO
    m.ORGPROCCON   =   "0"   && NAO INFORMADO
    m.TPDOCIMPO    =   "0"   && NAO INFORMADO
    m.NRODOCIMPO   =   "0"   && NAO INFORMADO
    m.VLRPISIMPO   =   0     && NAO INFORMADO
    m.VLRCOFIMPO   =   0     && NAO INFORMADO

    m.VLRSRVCONT   =   &PrmAlias .Base_iss
    m.VLRBCISSQN   =   &PrmAlias .Base_iss
    m.VLR_ISSQN    =   &PrmAlias .Vlr_iss

    m.VLR_BCIRRF   =   0     && NAO INFORMADO
    m.VLR_IRRF     =   0     && NAO INFORMADO
    m.VLR_BCPREV   =   0     && NAO INFORMADO
    m.VLR_PREV     =   0     && NAO INFORMADO
    m.AUTSEFAZCM   =   ""    && NAO INFORMADO
    m.NROPASSEFI   =   ""    && NAO INFORMADO
    m.TEMPERATUR   =   0     && NAO INFORMADO


	
	=W_DEFPROC("CLIENTES.SPR")
	m.tp_pessoa =  CLDef_TipoPessoa( &PrmAlias .Favorecido)
	
	IF  m.tp_pessoa = 1
		LFieldTmp = CHRTRAN(STR(  &PrmAlias .Favorecido,11)," ","0")
	    m.CPF    =   LFieldTmp
	    m.CNPJ   =  ""

	ELSE
		LFieldTmp = CHRTRAN(STR(  &PrmAlias .Favorecido,14)," ","0")
	    m.CNPJ    =   LFieldTmp
	    m.CPF    =   ""
	ENDIF

    m.UF    	 =    &PrmAlias .UF

    m.UF_CODIGO  =    "" && NAO INFORMADO


    m.IE    	 =    &PrmAlias .Inscricao

	IF "ISENTO" $ m.IE
		m.IE = "ISENTO              " && ALGUNS CASOS ESTVA "IISENTO"
	ENDIF
		


    m.NOME          =   DFLimpaString( &PrmAlias .Nome )
    m.RAZAOSOC      =   DFLimpaString( &PrmAlias .Nome )


    m.e_mail         =   DFLimpaString( &PrmAlias .e_mail )
    m.e_mail_nfe     =   DFLimpaString( &PrmAlias .e_mail_nfe )
	m.im_tomador     =   DFLimpaString( &PrmAlias .im_tomador )


    m.TP_LOGRAD     =   "" && NAO INFORMADO
    m.LOGRADOURO    =   DFLimpaString(  &PrmAlias .Endereco )
    m.NRO_LOGRAD    =   "S/N"

	LFieldTmp 	    = CHRTRAN(STR(  &PrmAlias .CEP,8)," ","0")
    m.CEP           =   LFieldTmp

	LFieldTmp    =  &PrmAlias .Muni_IBGE
	LFieldTmp    =  CHRTRAN(STR(LFieldTmp,7)," ","0")
    m.MUNI_IBGE  =  LFieldTmp
    m.MUNI_NOME  =    &PrmAlias .Cidade

    m.BAIRRO     =   DFLimpaString(  &PrmAlias .Bairro)
    m.PAIS    	 =   "BRASIL"
    m.DDD    	 =  "00"
    m.FONE    	 =  LEFT( ALLTRIM( &PrmAlias .Fone) ,10)

    m.IE_SUBTRIB =  &PrmAlias .InscSubst
    m.SUFRAMA    =  ""

	*---------------------------------------------------*




	*---------------------------------------------------*

	IF &PrmAlias .referencia <> &PrmAlias .orcamento
		=W_DEFPROC("CUPOM.SPR")
		IF CPLerRegistro(PrmEmpresa,  &PrmAlias .referencia )
			LCupomAlias = CPGetAlias()
		    m.REF_NRODOC    =   &PrmAlias .referencia
		    m.REF_SERIE     =    LEFT( &LCupomAlias .Serie +"   ",3)


			IF EMPTY(m.REF_SERIE)
	    		m.REF_SERIE  =     LEFT( "01   ",3)
			endif

	    	m.REF_DT_DOC    =   &LCupomAlias .data
		    m.REF_INDOPER   =   "1"    && 0-ENTRADA  1-SAIDA
		    m.REF_TP_MOV    =   "SAIDA" 	&& ENTRADA  // SAIDA
	    	m.REF_INDEMI    =   "0" && 0-EMIS. PROPRIA // 1-TERCEIROS

			DO CASE

				CASE &LCupomAlias .Nota > 1000000 ;
				    AND &LCupomAlias .Nota < 2000000
			    		m.REF_MODDOC    =   "2D"

				CASE &LCupomAlias .Nota > 3000000 ;
				    AND &LCupomAlias .Nota < 4000000
			    		m.REF_MODDOC    =   "55"
				OTHERWISE
					=W_DEFPROC("TIPOOPER.SPR")
					LFieldTmp    = ;
					 TPGetFieldValue("S",  &LCupomAlias .tipo ,"Cod_Mod_Rf")
				    m.REF_MODDOC    =   LFieldTmp
			ENDCASE
		ELSE
		    m.REF_NRODOC    =   0
		    m.REF_SERIE    =    "   "
	    	m.REF_DT_DOC    =   {}
		    m.REF_INDOPER   =   " "    && 0-ENTRADA  1-SAIDA
		    m.REF_TP_MOV    =   "" 	&& ENTRADA  // SAIDA
	    	m.REF_INDEMI    =   "" && 0-EMIS. PROPRIA // 1-TERCEIROS
    		m.REF_MODDOC    =   ""
		ENDIF

	ELSE
		    m.REF_NRODOC    =   0
		    m.REF_SERIE     =    "   "
	    	m.REF_DT_DOC    =   {}
		    m.REF_INDOPER   =   " "    && 0-ENTRADA  1-SAIDA
		    m.REF_TP_MOV    =   "" 	&& ENTRADA  // SAIDA
	    	m.REF_INDEMI    =   "" && 0-EMIS. PROPRIA // 1-TERCEIROS
    		m.REF_MODDOC    =   ""
	ENDIF

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp       =   EMGet_ECFSerie(PrmEmpresa)
    m.NRO_SERECF    =   LFieldTmp
    m.NRO_CX_ECF    =   "01"

	LFieldTmp    =  &PrmAlias .Cupom
	LFieldTmp    = CHRTRAN(STR(LFieldTmp,6)," ","0")
    m.NRO_CPMECF =   LFieldTmp



	=W_DEFPROC("EMPRESA.SPR")
	M.MUNIFATOGR  =   EMGetFieldValue(PrmEmpresa,"MUNI_IBGE")

	*----------------------------------------------------*
	m.TP_CARGA    =   "0"
    m.QTDE_VOL    =    &PrmAlias .qtde_vol
    m.ESPECIE     =    ""
    m.MARCA       =    &PrmAlias .marca
    m.PESO_BRUTO  =    &PrmAlias .pes_brt
    m.PESO_LIQ    =    &PrmAlias .pes_liq


	M.TRSTEM  		= "NAO"
	STORE "" TO M.TRSRNTC,M.TRSPLACAUF,M.TRSPLACA,M.TRSCPFCNPJ,;
				M.TRSNOME,M.TRSUF,M.TRSIE,M.TRSLOGRA,;
				M.TRSMUNIBGE,M.TRSMUNNOME,M.TRSBAIRRO




	=W_DEFPROC("ORC_ANEX.SPR")

	IF OALerRegistro(PrmEmpresa, &PrmAlias .ORCAMENTO)
		=W_DEFPROC("ORC_ANEX.SPR")
		LOrc_AnexAlias = OAGetAlias()

		IF !EMPTY( &LOrc_AnexAlias .CPFCNPJTRN)
			M.TRSTEM  		= "SIM"
			M.TRSRNTC 		= &LOrc_AnexAlias .ANTT_TRANS
			M.TRSPLACAUF	= &LOrc_AnexAlias .PLACA_UFTR
			M.TRSPLACA 		= &LOrc_AnexAlias .PLACA_TRAN
			M.TRSCPFCNPJ	= STR( &LOrc_AnexAlias .CPFCNPJTRN,14)
			M.TRSNOME		= &LOrc_AnexAlias .TRANSPORTE
			
			M.TRSUF			= &LOrc_AnexAlias .UF_TRANS
			M.TRSIE			= &LOrc_AnexAlias .IE_TRANS
			M.TRSLOGRA		= &LOrc_AnexAlias .ENDE_TRANS

			M.TRSTPLOGRA 	= LEFT(M.TRSLOGRA,AT(" ",M.TRSLOGRA,1))
			M.TRSTPLOGRA 	= LEFT(M.TRSTPLOGRA,3)
			M.TRSNRO      	= "S.N"
  			M.TRSCOMPLEM  	= ""
  			
			M.TRSCEP        = &LOrc_AnexAlias .CEP_TRANS

			M.TRSMUNIBGE	= STR ( &LOrc_AnexAlias .IBGE_TRANS,10)
			M.TRSMUNNOME	= &LOrc_AnexAlias .MUNI_TRANS
			M.TRSBAIRRO		= &LOrc_AnexAlias .BAIR_TRANS
  			M.TRSPAIS       = "BRASIL"
			M.TRSFONE       = ""
		ENDIF			
	ENDIF


    m.DT_ENTSAI   =    &PrmAlias .data
    m.HR_ENTSAI   =    &PrmAlias .HORA
	IF EMPTY(m.HR_ENTSAI)
	  m.HR_ENTSAI = "08:00:00"
	ENDIF



	*---------------------------------------------------*

	LFieldTmp    =  &PrmAlias .REGIAO
	LFieldTmp    =  STR(LFieldTmp,8)
    m.ZONA    	 =  LFieldTmp


	*---------------------------------------------------*
    m.TTPRODSRVC  =  &PrmAlias .TotServico + &PrmAlias .TotProduto

	*---------------------------------------------------*
	M.FNLDAD_NFE = "1"

	
	LEmpresa    = M.Empresa
	LMod_Doc    = M.Mod_Doc
	LCod_IdForn = M.Cod_IdForn
	LNro_Doc    = M.Nro_Doc
	LSerie_Doc  = M.Serie_Doc


	SELE &PBDocFiscaAlias
	SET ORDER TO TAG DOCFISCAL
	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	     STR(LNro_Doc,7)+LSerie_Doc

	
	IF !FOUND()
		APPEND BLANK
	ENDIF
	
	
	=RLOCK()
	GATHER MEMVAR
	UNLOCK
	

RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DESW           DFConvrtNEDocFiscal VALID          
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   29  
*        Variable:            DFConvrtNEDocFiscal                
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      26                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15desw     &&  DFConvrtNEDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFConvrtNEDocFiscal
PARAMETERS PrmEmp,PrmNota,PrmFornCOD

	PRIVATE PrmAlias
	PRIVATE LFornAlias

	PRIVATE LCupomAlias





	*--------------------------------------------------*

	PRIVATE ;
    	 PrmSerie,;
		 PrmTipo,;
    	 RtnNro_Doc,;
		 RtnMod_Doc,;
		 RtnCOD_IDFORN,;
		 RtnSerie_Doc,;
		 RtnDocEletro
	*--------------------------------------------------*




	=DFVerifyInst()



	=W_DEFPROC("NOTAENT.SPR")
	PrmAlias = NEGetAlias()

	=W_DEFPROC("NOTA.SPR")
	LNFSaidaAlias = NFGetAlias()


	=W_DEFPROC("NOTAENT.SPR")
	IF !NELerRegistro(PrmEmp,PrmNota,PrmFornCOD)
		MSG = "NEnt nao localizada ";
		     +str(PrmNota,7);
		     +"Forn:"+str(PrmFornCOD,14);
		     +" <ENTER>"
		WAIT MSG NOWAIT
		RETURN(.F.)
	ENDIF




	=W_DEFPROC("FORNECED.SPR")
	IF !FRLerRegistro( &PrmAlias .codforn)
		WAIT WINDOW "NFs nao localizada  <ENTER> "
		MSG = "FORNECEDOR nao localizado ";
		     +str(PrmNota,7);
		     +"Forn:"+str(PrmFornCOD,14);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF





	IF  LEFT( &PrmAlias .SITUACAO,1) <> "C"

		* NAO PROCESSAR ENTRADAS NAO EFETIVADAS
		
		RETURN(.T.)
	ENDIF





	=W_DEFPROC("DOCFISIT.SPR")
	=DIVerifyInst()



    DIMENSION LVT_AcmItens[4]  && RETORNA COM ACUMULADO DOS ITENS
	STORE 0 to     LVT_AcmItens

		*-----------------------------------*
		* [1] - VLR_ICMS
		* [2] - BC_ICMS
		* [3] - VLR_IPI
		* [4] - VLR_TOTAL
		*-----------------------------------*
	
					



	=W_DEFPROC("DOCFISIT.SPR")
	IF !DIConvrtNEDocFiscal(PrmEmp,PrmNota,PrmFornCOD,LVT_AcmItens)
		WAIT WINDOW "Itens NF Entrada nao localizados  <ENTER> "
		RETURN(.F.)
	ENDIF


	=W_DEFPROC("FORNECED.SPR")
	IF !FRLerRegistro( &PrmAlias .codforn)
		WAIT WINDOW "NFs nao localizada  <ENTER> "
		MSG = "FORNECEDOR nao localizado ";
		     +str(PrmNota,7);
		     +"Forn:"+str(PrmFornCOD,14);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	*---------------------------------------------------*

	STORE 0 TO  ;
    	 PrmSerie,;
		 PrmTipo,;
    	 RtnNro_Doc,;
		 RtnMod_Doc,;
		 RtnCOD_IDFORN,;
		 RtnSerie_Doc,;
		 RtnDocEletro


	PrmSerie = &PrmAlias .serie
	PrmTipo  = &PrmAlias .tipo


	=W_DEFPROC("NOTAENT.SPR")
	=NEDefIDNFDocFiscal(PrmEmp,PrmNota,PrmFornCod,;
						PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						RtnSerie_Doc,RtnDocEletro)



    M.COD_IDFORN   	=  RtnCOD_IDFORN

    M.EMPRESA   	=  PrmEmp
    M.TIPO   		=  PrmTipo
    M.NRO_DOC   	=  RtnNro_Doc
    M.SERIE_DOC 	=  RtnSerie_Doc


    m.MOD_DOC       =  RtnMod_Doc


	M.DOC_ELETRO    =  RtnDocEletro

	*---------------------------------------------------*

    m.EMPRESA   =    &PrmAlias .Empresa



    m.IND_OPER   =   "0"   && 0-ENTRADA  1-SAIDA
    m.TP_MOV     =   "ENTRADA" 	&& ENTRADA  // SAIDA

    m.MOD_NOTA   =   "1"
	

	
	=W_DEFPROC("CLIENTES.SPR")
	m.tp_pessoa =  CLDef_TipoPessoa( &PrmAlias .Favorecido)
	
	IF  m.tp_pessoa = 1
		LFieldTmp = CHRTRAN(STR(  &PrmAlias .Favorecido,11)," ","0")
	ELSE
		LFieldTmp = CHRTRAN(STR(  &PrmAlias .Favorecido,14)," ","0")
	ENDIF




	=W_DEFPROC("CLIENTES.SPR")
	m.tp_pessoa =  CLDef_TipoPessoa( &PrmAlias .Favorecido)
	
	IF  m.tp_pessoa = 1
		LFieldTmp = CHRTRAN(STR(  &PrmAlias .Favorecido,11)," ","0")
	    m.CPF    =   LFieldTmp
	    m.CNPJ   =  ""

	ELSE
		LFieldTmp = CHRTRAN(STR(  &PrmAlias .Favorecido,14)," ","0")
	    m.CNPJ    =   LFieldTmp
	    m.CPF    =   ""
	ENDIF

    m.UF    	 =    &PrmAlias .UF

    m.UF_CODIGO  =    "" && NAO INFORMADO


    m.IE        	=     &PrmAlias .Inscricao

	IF "ISENTO" $ m.IE
		m.IE = "ISENTO              " && ALGUNS CASOS ESTVA "IISENTO"
	ENDIF

	*---------------------------------------------------*
	*---------------------------------------------------*


    m.TIPO   		=     &PrmAlias .tipo

    m.NAT_OPER   	=     &PrmAlias .natureza

    IF EMPTY(m.nat_oper)
    	=W_DEFPROC("TIPOOPER.SPR")
		LFieldTmp    = TPGetFieldValue("E",  &PrmAlias .tipo ,"DESCNATU")
    	m.NAT_OPER   =   LFieldTmp
    ENDIF



    m.IND_EMITEN   	=   "1"  && 0-EMISSAO PROPRIA // 1-TERCEIROS

	&& 00-DOC REGULAR // 02-DOC CANCELADO


	LFieldTmp    	=	 "00"     && DOC REGULAR
    m.COD_SIT   	=   		LFieldTmp
    m.DT_DOC   		=    		&PrmAlias .data_emi
    m.HORA   		=    		&PrmAlias .HORA
	IF EMPTY(M.HORA)
	  M.HORA = "08:00:00"
	ENDIF



    m.DT_ENTSAI   	=    	&PrmAlias .Data	

	LFieldTmp    	= {}
    m.DT_CANC   	=   		LFieldTmp




*-> && 0-A VISTA   1-A PRAZO   9-SEM PGTO
	IF &PrmAlias .Ch_Opera= "1"  && 1-VENDA
		IF &PrmAlias .Tp_pgto = 1
			LFieldTmp    = "0"
		ELSE
			LFieldTmp    = "1"
		ENDIF
	ELSE
		LFieldTmp    = "9"
	ENDIF
    m.TP_PG   =   LFieldTmp

	IF &PrmAlias .Ch_Opera= "1"  && 1-VENDA
		IF &PrmAlias .Tp_pgto = 1
			LFieldTmp    = "A VISTA"
		ELSE
			LFieldTmp    = "A PRAZO"
		ENDIF
	ELSE
		LFieldTmp    = "SEM PGTO"
	ENDIF

    m.TP_PGDESCR   =   LFieldTmp
    m.VLR_DESCON   =    0
    m.VLRABAT_NT   =    0
    m.VLR_SERVIC   =    &PrmAlias .TotServico
    m.VLR_MERCAD   =    &PrmAlias .TotProduto


	IF &PrmAlias .pgto_frete = 1
	    m.IND_FRETE   =    "1"
	else
	    m.IND_FRETE   =    "2"
	ENDIF	

    m.VLR_FRETE   =    &PrmAlias .VlrFrete
    m.VLR_SEGURO   =    &PrmAlias .VlrSeguro
    m.VLR_DESPES   =    &PrmAlias .VlrDespes
    m.OUTDSPACES   =    0

    m.VLR_ICMS     =    LVT_AcmItens[1] &&  &PrmAlias .Vlr_Icms

    m.BC_ICMS      =    LVT_AcmItens[2] &&  &PrmAlias .Base_Icms

    m.VLR_IPI      =    LVT_AcmItens[3] && &PrmAlias .Vlr_ipi

    IF ABS(	&PrmAlias .Total_nota - LVT_AcmItens[4]) < 0.03

	    m.VLR_DOC     =    LVT_AcmItens[4]

	ELSE

	    m.VLR_DOC     =    &PrmAlias .Total_nota
	
	ENDIF



	*-----------------------------------------*
	* AS ENTRADA ESTAO GERANDO SALDO CREDOR INDEVIDO
	* SENDO ASSIM PASSAMOS O CST = 060 PARA 030
	* E ZERAMOS CAMPOS DE SUBSTITUICAO
	*-----------------------------------------*
    m.BC_ICMSRTD   =    &PrmAlias .Base_subs
    m.VLRICMSRTD   =    &PrmAlias .ICms_Subs

	IF &PrmAlias .ICms_Subs > 0
	    m.BC_ICMSRTD   =    0
    	m.VLRICMSRTD   =    0
	ENDIF



    m.BC_IPI       =    &PrmAlias .Base_IPI
    m.VLR_PIS      =    0
    m.VLR_COFINS   =   0
    m.VLR_PISRTD   =   0
    m.VLR_COFRTD   =   0
    m.INF_COMPLE   =   ""
    m.NROPROCCON   =   ""
    m.ORGPROCCON   =   "0"
    m.TPDOCIMPO   =   "0"
    m.NRODOCIMPO   =   "0"
    m.VLRPISIMPO   =   0
    m.VLRSRVCONT   =   0
    m.VLRBCISSQN   =     &PrmAlias .Base_iss
    m.VLR_ISSQN   =    &PrmAlias .Base_iss * &PrmAlias .aliq_iss
    m.VLR_BCIRRF   =   0
    m.VLR_IRRF   =   0
    m.VLR_BCPREV   =   0
    m.VLR_PREV   =   0
    m.AUTSEFAZCM   =   ""
    m.NROPASSEFI   =   ""
    m.TEMPERATUR   =   0

	=W_DEFPROC("FORNECED.SPR")
	LFornAlias = FRGetAlias()


    m.NOME   =     	 DFLimpaString( &LFornAlias .Nome )
    m.RAZAOSOC   =   DFLimpaString( &LFornAlias .Nome )

    m.TP_LOGRAD   =   ""
    m.LOGRADOURO   =  DFLimpaString(   &LFornAlias .Endereco )
    m.NRO_LOGRAD    =   "S/N"



	LFieldTmp = CHRTRAN(STR( 	&LFornAlias .CEP,8)," ","0")
    m.CEP   =   LFieldTmp
	

	LFieldTmp    =  &LFornAlias .Muni_IBGE
	LFieldTmp    = CHRTRAN(STR(LFieldTmp,7)," ","0")
    m.MUNI_IBGE   =   LFieldTmp
    m.MUNI_NOME   =     &LFornAlias .Cidade
    m.BAIRRO   =   DFLimpaString(   &LFornAlias .Bairro)
    m.PAIS   =    &LFornAlias .Pais
    m.FONE    	 =  LEFT( ALLTRIM( &LFornAlias .Fone ) ,10)
	*---------------------------------------------------*

	IF &PrmAlias .NFDEVOLVE > 0
		=W_DEFPROC("NOTA.SPR")
		IF NFLerRegistro(PrmEmp,  &PrmAlias .NFDEVOLVE )
			LNFSaidaAlias = NFGetAlias()
		    m.REF_NRODOC   =    &PrmAlias .NFDEVOLVE
		    m.REF_SERIE   =   LEFT( &LNFSaidaAlias .Serie +"   ",3)

			IF EMPTY(m.REF_SERIE)
	    		m.REF_SERIE  =     LEFT( "01   ",3)
			endif


	    	m.REF_DT_DOC  =	&LNFSaidaAlias .data
		    m.REF_INDOPER   =   "1"    && 0-ENTRADA  1-SAIDA
		    m.REF_TP_MOV   =   "SAIDA" 	&& ENTRADA  // SAIDA
	    	m.REF_INDEMI   =   "0" && 0-EMIS. PROPRIA // 1-TERCEIROS

			IF &LNFSaidaAlias .Nota > 1000000 AND;
			   &LNFSaidaAlias .Nota < 2000000
			
	    		m.REF_MODDOC   =   "2D"
			ELSE
				=W_DEFPROC("TIPOOPER.SPR")
				LFieldTmp    = ;
					TPGetFieldValue("S", ;
					  &LNFSaidaAlias .tipo ,"Cod_Mod_Rf")
			    m.REF_MODDOC   =   LFieldTmp
			ENDIF
		ELSE
		    m.REF_NRODOC   =    0
		    m.REF_SERIE   =     "   "
	    	m.REF_DT_DOC   = {}
		    m.REF_INDOPER   =   " "    && 0-ENTRADA  1-SAIDA
		    m.REF_TP_MOV   =   "" 	&& ENTRADA  // SAIDA
	    	m.REF_INDEMI   =   "" && 0-EMIS. PROPRIA // 1-TERCEIROS
    		m.REF_MODDOC   =   ""
		ENDIF

	ELSE
		    m.REF_NRODOC   =    0
		    m.REF_SERIE   =     "   "
	    	m.REF_DT_DOC  = {}
		    m.REF_INDOPER   =   " "    && 0-ENTRADA  1-SAIDA
		    m.REF_TP_MOV   =   "" 	&& ENTRADA  // SAIDA
	    	m.REF_INDEMI   =   "" && 0-EMIS. PROPRIA // 1-TERCEIROS
    		m.REF_MODDOC   =   ""
	ENDIF
	*----------------------------------------------------*
	m.TP_CARGA   =   "0"
    m.QTDE_VOL   =     &PrmAlias .qtde_vol
    m.ESPECIE   =     &PrmAlias .espec_vol
    m.MARCA   =     &PrmAlias .marca
    m.PESO_BRUTO   =     &PrmAlias .pes_brt
    m.PESO_LIQ   =     &PrmAlias .pes_liq
    m.DT_ENTSAI   =    		&PrmAlias .data
    m.HR_ENTSAI   =    		&PrmAlias .HORA

	IF EMPTY(M.HR_ENTSAI)
	  M.HR_ENTSAI = "08:00:00"
	ENDIF

	*---------------------------------------------------*

	LFieldTmp    = 0
	LFieldTmp    = STR(LFieldTmp,8)
    m.ZONA   =   LFieldTmp
    m.IE_SUBTRIB   =     &LFornAlias . InscSubs
    m.SUFRAMA   =     &LFornAlias .SUFRAMA

    m.NRO_SERECF   =   ""
    m.NRO_CX_ECF   =   ""

    m.NRO_CPMECF   =   "0"
	*---------------------------------------------------*

	*---------------------------------------------------*
	M.FNLDAD_NFE = "1"

	
	LEmpresa    = M.Empresa
	LMod_Doc    = M.Mod_Doc
	LCod_IdForn = M.Cod_IdForn
	LNro_Doc    = M.Nro_Doc
	LSerie_Doc  = M.Serie_Doc


	SELE &PBDocFiscaAlias
	SET ORDER TO TAG DOCFISCAL
	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	     STR(LNro_Doc,7)+LSerie_Doc

	
	IF !FOUND()
		APPEND BLANK
	ENDIF
	
	
	=RLOCK()
	GATHER MEMVAR
	UNLOCK
	
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DEYI           DFGerXMLDocFiscal VALID            
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   30  
*        Variable:            DFGerXMLDocFiscal                  
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      27                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15deyi     &&  DFGerXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFGerXMLDocFiscal
PARAMETER PrmEmpresa,;
		  PrmMod_Doc,;
		  PrmCOD_IDFORN,;
		  PrmNro_Doc,;
		  PrmSerie_Doc,;
		  PrmObjetivo
		
		
		
	*-----------------------------------------------------*
	* PrmObjetivo => indica o objetivo da gera눯o do xml pode ser:
	*
	*      "EMISSAO"      => Para EMISSOA - NFe/NFSe/CUPOM
	*      "ESCRITURACAO" => Para registro do documento
	*      "CANCELAMENTO" => Para Cancelar o Documento
	*-----------------------------------------------------*


	IF TYPE("PrmObjetivo") <> "C" ;
	   OR !(PrmObjetivo $ "ESCRITURACAO/EMISSAO/CANCELAMENTO" )
		  PrmObjetivo = "ESCRITURACAO"
	ENDIF
	

	PRIVATE LFlagOK


	PRIVATE LSalias
	
	PRIVATE PrmAlsDF
	

	LSalias = ALIAS()
	PrmAlsDF = DFGetAlias()


	*-------------------------------------------------------*

	=DFModeloRefXML()  && VERIFICA ATUALIZACAO DO LAYOUT


	*-------------------------------------------------------*

   	PRIVATE LSfileXML,LNroIDfileXML


   	LSfileXML	= DFNmFileXMLDocFiscal(PrmEmpresa,PrmMod_doc,PrmNro_Doc)

   	LSfileXML	= "\SCGC\EFD\"+LSfileXML


  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria눯o arquivo tempor쟲io '+LSfileXML+'- <ENTER> ' window
      return(.F.)
   	endif





	*---------------------------------------------------*
	GO BOTT
	GO TOP


	SELE &PrmAlsDF
	SET ORDER TO TAG DOCFISCAL
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmMOD_DOC+;
	     PrmCOD_IDFORN+STR(PrmNro_Doc,7)+PrmSERIE_DOC
	
	SET NEAR OFF


	IF !FOUND()
      =fclose(LNroIDfileXML)
      wait 'Nao foi encontrado Documento em DOCFISCA '+;
           'para gerar XML- <ENTER> ' window
      return(.F.)

   	endif

	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() ;
	        AND PrmEmpresa    = &PrmAlsDF .empresa;
	        AND PrmMod_Doc    = &PrmAlsDF .MOD_DOC ;
	        AND PrmCOD_IDFORN = &PrmAlsDF .COD_IDFORN ;
	        AND PrmNro_Doc       = &PrmAlsDF .NRO_DOC ;
	        AND PrmSERIE_DOC  = &PrmAlsDF .SERIE_DOC;
         TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*


	=DFInicioXML(LSfileXML,LNroIDfileXML)

	SET POINT TO ','



    LFlagOK = .t.

	SELE &PrmAlsDF
	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa    = &PrmAlsDF .empresa;
	        AND PrmMod_Doc    = &PrmAlsDF .MOD_DOC ;
	        AND PrmCOD_IDFORN = &PrmAlsDF .COD_IDFORN ;
	        AND PrmNro_Doc    = &PrmAlsDF .NRO_DOC ;
	        AND PrmSERIE_DOC  = &PrmAlsDF .SERIE_DOC

		=UPtermo()


		=W_DEFPROC("DUPLICAT.SPR")
		IF !CRGerXMLDpDocFiscal(;
				&PrmAlsDF .Empresa,;
				&PrmAlsDF .NRO_NOTA,;
				&PrmAlsDF .NRO_DOC,;
				&PrmAlsDF .Mod_doc,;
				&PrmAlsDF .Serie_Doc)
			LFsegue = .f.
		    LFlagOK = .f.  && FALHA NO PROCESSO
		    LOOP
		ENDIF



		IF !DIGerXMLDocFiscal(;
				&PrmAlsDF .Empresa,;
				&PrmAlsDF .Mod_doc,;
				&PrmAlsDF .Cod_IDForn,;
				&PrmAlsDF .Nro_Doc,;
				&PrmAlsDF .Serie_Doc)

			LFsegue = .f.
		    LFlagOK = .f.  && FALHA NO PROCESSO
		    LOOP
		ENDIF




		IF !DFGravaXMLDocFiscal(;
				&PrmAlsDF .Empresa,;
				&PrmAlsDF .Mod_doc,;
				&PrmAlsDF .Cod_IDForn,;
				&PrmAlsDF .Nro_Doc,;
				&PrmAlsDF .Serie_Doc,;
				LSfileXML,;
				LNroIDfileXML,;
				PrmObjetivo)
			LFsegue = .f.
		    LFlagOK = .f.  && FALHA NO PROCESSO
		    LOOP
		ENDIF


		*-------------------------------------------------------*
		* A funcao TRGerXMLTransFiscal disposiociona a tabela
	    * &PrmAlsDF e provoca efeito colateral na rotina
	    * para evitar o efeito marca-se o registro para reposicionar
	    *-------------------------------------------------------*  		

		SELE &PrmAlsDF
		LNregTrspt = RECNO()


		=W_DEFPROC("TRANSPRT.SPR")
		IF !TRGerXMLTransFiscal(;
				&PrmAlsDF .Empresa,;
				&PrmAlsDF .Mod_doc,;
				&PrmAlsDF .Cod_IDForn,;
				&PrmAlsDF .Nro_Doc,;
				&PrmAlsDF .Serie_Doc)
			LFsegue = .f.
		    LFlagOK = .f.  && FALHA NO PROCESSO

			SELE &PrmAlsDF
			go LNregTrspt

		    LOOP
		ENDIF


		SELE &PrmAlsDF
		go LNregTrspt


		SKIP
	ENDDO

	=DFFinalXML(LSfileXML,LNroIDfileXML)


	SET POINT TO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(LFlagOK)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DF1E           DFEnviaNFeXML VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   34  
*        Variable:            DFEnviaNFeXML                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      28                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15df1e     &&  DFEnviaNFeXML VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFEnviaNFeXML
PARAMETERS PrmEmpresa,PrmMod_Doc,PrmNro_Doc
	


   	PRIVATE LSFDocXML,LSFItemXML,LSCobrXML,LSTransXML
   	LSFDocXML	= DFNmFileXMLDocFiscal(PrmEmpresa,PrmMod_Doc,PrmNro_Doc)


	IF !FILE("\SCGC\EFD\"+LSFDocXML)
	   RETURN(.F.)
	ENDIF


   	LSFItemXML	= DINmFileXMLDocFiscal(PrmEmpresa,PrmMod_Doc,PrmNro_Doc)

	IF !FILE("\SCGC\EFD\"+LSFItemXML)
	   RETURN(.F.)
	ENDIF


	=W_DEFPROC("DUPLICAT.SPR")
   	LSCobrXML	= CRNmFileXMLDocFiscal(PrmEmpresa,PrmMod_Doc,PrmNro_Doc)

	IF !FILE("\SCGC\EFD\"+LSCobrXML)
	   RETURN(.F.)
	ENDIF



	=W_DEFPROC("TRANSPRT.SPR")
   	LSTransXML	= TRNmFileXMLDocFiscal(PrmEmpresa,PrmMod_Doc,PrmNro_Doc)

	IF !FILE("\SCGC\EFD\"+LSTransXML)
	   RETURN(.F.)
	ENDIF


	*--------------------------------------------------*
	LSFileOrigem     = "\SCGC\EFD\"+LSFDocXML
	LSFileDestino    = "C:\NFE\"+LSFDocXML
			
	COPY FILE &LSFileOrigem TO &LSFileDestino


	IF FILE(LSFileOrigem)
		DELETE FILE &LSFileOrigem
	ENDIF

	*--------------------------------------------------*

	LSFileOrigem     = "\SCGC\EFD\"+LSFItemXML
	LSFileDestino    = "C:\NFE\"+LSFItemXML
			
	COPY FILE &LSFileOrigem TO &LSFileDestino


	IF FILE(LSFileOrigem)
		DELETE FILE &LSFileOrigem
	ENDIF
	*--------------------------------------------------*

	LSFileOrigem     = "\SCGC\EFD\"+LSCobrXML
	LSFileDestino    = "C:\NFE\"+LSCobrXML
			
	COPY FILE &LSFileOrigem TO &LSFileDestino


	IF FILE(LSFileOrigem)
		DELETE FILE &LSFileOrigem
	ENDIF


	*--------------------------------------------------*

	LSFileOrigem     = "\SCGC\EFD\"+LSTransXML
	LSFileDestino    = "C:\NFE\"+LSTransXML
			
	*COPY FILE &LSFileOrigem TO &LSFileDestino


	IF FILE(LSFileOrigem)
		DELETE FILE &LSFileOrigem
	ENDIF

	
	*--------------------------------------------------*



RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DF1F           DFEsperaRspNFe VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   35  
*        Variable:            DFEsperaRspNFe                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      29                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15df1f     &&  DFEsperaRspNFe VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFEsperaRspNFe
PARAMETERS PrmEmpresa, PrmMod_Doc, PrmNroDoc


	*-------------------------------------------------------*
	PRIVATE LSstatus
	PRIVATE CtrAguarda

	LSstatus = ""

    CtrAguarda = 0
	LFlgEspera = .t.

	DO WHILE LFlgEspera


		LSstatus=DFBuscaArqRspNFe(PrmEmpresa, PrmMod_Doc,PrmNroDoc)

		DO CASE
 		 	CASE LSstatus = "ERRO ! Espera interrompida por usr"
				LFlgEspera = .F.
		
			CASE LSstatus = "ERRO ! Nao houve retorno do comando"
				LFlgEspera = .T.

			CASE "ASSINADA" $ LSstatus
				LFlgEspera = .T.

			CASE "VALIDADA" $ LSstatus
				LFlgEspera = .T.

			CASE "TRANSMITIDA" $ LSstatus

				IF CtrAguarda > 5		&& D UM TEMPO PARA RETORNO
					LFlgEspera = .F.    && PROCESSADO
				ELSE
					CtrAguarda = CtrAguarda + 1
					=INKEY(4)
				ENDIF

			CASE "GRAVADA" $ LSstatus AND PrmMod_Doc = "03"
				LSstatus =  STRTRAN(LSstatus,"GRAVADA","PROCESSADA")
				LFlgEspera = .F.

			CASE "PROCESSADA" $ LSstatus
				LFlgEspera = .F.

			CASE "CANCELADA" $ LSstatus
				LFlgEspera = .F.

			CASE "ERRO EMISSAO" $ LSstatus
				LFlgEspera = .F.

		ENDCASE
	ENDDO

RETURN(LSstatus)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DF3M           DFBuscaRspNFe VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   38  
*        Variable:            DFBuscaRspNFe                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      30                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15df3m     &&  DFBuscaRspNFe VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFBuscaArqRspNFe
PARAMETERS PrmEmpresa,PrmMod_doc,PrmNro_Doc

	*-------------------------------------------------------*

	PRIVATE LSnroDoc
	PRIVATE LNfile
	PRIVATE LSstatus,LSFile,LNctr,TECLA




	*-------------------------------------------------------*
	*  obter o MOD_DOC
	*-------------------------------------------------------*



	*----------------------------------------------------------*

	LSstatus = ""
	LNfile = 0



	LSnroDoc  = CHRTRAN(STR(PrmNro_Doc,8)," ","0")


	LSFile    = "C:\NFe\"+LSnroDoc+"."+PrmMod_Doc



	LNctr = 0

	CLEAR TYPEAHEAD


	DO WHILE !(FILE(LSFile))

		DO CASE

			CASE PrmMod_Doc = "2D"
			    LSmsg = STR(LNctr,3)+"-Aguarda Cupom - <ESC>=Sai "+LSFile

			CASE PrmMod_Doc = "55"
			    LSmsg = STR(LNctr,3)+"-Aguarda NFe  - <ESC>=Sai "+LSFile

			CASE PrmMod_Doc = "03"
			    LSmsg = STR(LNctr,3)+"-Aguarda NFSe  - <ESC>=Sai "+LSFile

			OTHERWISE
			    LSmsg = STR(LNctr,3)+"-Aguarda NF  - <ESC>=Sai "+LSFile
		ENDCASE

		WAIT WINDOW LSmsg NOWAIT
		TECLA=INKEY(3)
		LNctr = LNctr + 1
		IF  LNctr > 60
			EXIT
		ENDIF
		IF TECLA = 27 OR LASTKEY() = 27
			IF fox_alert("Interrompe Espera NFe ? ")
				LSstatus = "ERRO ! Espera interrompida por usr"
				EXIT
			ENDIF
		ENDIF

	ENDDO

	DO CASE
		CASE LSstatus = "ERRO ! Espera interrompida por usr"
 		 	LSstatus = "ERRO ! Espera interrompida por usr"

		CASE !FILE(LSFile)
			LSstatus = "ERRO ! Nao houve retorno do comando"

		OTHERWISE		
			TECLA=INKEY(3)
			LNfile=FOPEN(LSFile)	
			IF LNfile > 0
				LSstatus=""
				DO WHILE !FEOF(LNfile)
					LSstatus = LSstatus + UPPER(fgets(LNfile,255)) + "|"
				ENDDO
				=FCLOSE(LNfile)
			ELSE
				LSstatus = "ERRO ! Nao houve retorno do comando"
			ENDIF

			LSnewFile = STRtran(LSFile,"."+PrmMod_Doc,"."+PrmMod_Doc+"K")

			IF FILE(LSnewFile)
		   		delete file &LSnewFile
			ENDIF
			RENAME &LSFile TO &LSnewFile


	ENDCASE


RETURN(LSstatus)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DF4W           DFRespostaNFe VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   39  
*        Variable:            DFRespostaNFe                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      31                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15df4w     &&  DFRespostaNFe VALID
#REGION 1
return
*---------------------------------------------------------------*
*		   PrmEsperaResposta,;
*		       && "ESPERA" ou "NAO ESPERA"
*
*---------------------------------------------------------------*

FUNCTION DFRespostaNFe
PARAMETERS ;
		   PrmEmpresa,;	
		   PrmMod_Doc,;
		   PrmNroDoc,;
		   PrmEsperaResposta,;
		   RtnStatus,;
		   RtnRecibo,;
		   RtnProtocolo,;
		   RtnChvNFe,;
		   RtnJstfCanc,;
		   RtnPrtcCanc
	*-------------------------------------------------------*
	PRIVATE LSstatus
	LSstatus = ""


	IF PrmEsperaResposta = "ESPERA"
		LSstatus=DFEsperaRspNFe(PrmEmpresa,PrmMod_Doc,PrmNroDoc)
	ELSE
		LSstatus=DFBuscaArqRspNFe(PrmEmpresa,PrmMod_Doc,PrmNroDoc)
	ENDIF


	*-------------------------------------------------------*


	DO CASE

		CASE LSstatus = "ERRO ! Nao houve retorno do comando"
				RtnStatus = LSstatus
		OTHERWISE
				RtnCodStatus = SUBS(LSstatus,1,AT("|",LSstatus,1)-1)
				RtnCodStatus = CHRTRAN(RtnCodStatus,"|","")



				*----------------------------------------*				
				RtnStatus   = SUBS(LSstatus,;
				 			   AT("|",LSstatus,1)+1,;
				               AT("|",LSstatus,2)-AT("|",LSstatus,1))
				RtnStatus = CHRTRAN(RtnStatus,"|","")

				*----------------------------------------*				
				RtnNota   = SUBS(LSstatus,;
				 			   AT("|",LSstatus,2)+1,;
				               AT("|",LSstatus,3)-AT("|",LSstatus,2))
				RtnNota = CHRTRAN(RtnNota,"|","")
				*----------------------------------------*				
				RtnRecibo = SUBS(LSstatus,;
				 			   AT("|",LSstatus,3)+1,;
				               AT("|",LSstatus,4)-AT("|",LSstatus,3))
				RtnRecibo = CHRTRAN(RtnRecibo,"|","")
				*----------------------------------------*				
				RtnProtocolo = SUBS(LSstatus,;
				 			   AT("|",LSstatus,4)+1,;
				               AT("|",LSstatus,5)-AT("|",LSstatus,4))
				RtnProtocolo = CHRTRAN(RtnProtocolo,"|","")
				*----------------------------------------*				
				RtnChvNFe    = SUBS(LSstatus,;
				 			   AT("|",LSstatus,5)+1,;
				               AT("|",LSstatus,6)-AT("|",LSstatus,5))
				RtnChvNFe = CHRTRAN(RtnChvNFe,"|","")

				*----------------------------------------*				
				RtnJstfCanc   = SUBS(LSstatus,;
				 			   AT("|",LSstatus,6)+1,;
				               AT("|",LSstatus,7)-AT("|",LSstatus,6))
				RtnJstfCanc = CHRTRAN(RtnJstfCanc,"|","")
				*----------------------------------------*				
				RtnPrtcCanc   = SUBS(LSstatus,;
				 			   AT("|",LSstatus,7)+1,;
				               AT("|",LSstatus,8)-AT("|",LSstatus,7))
				RtnPrtcCanc = CHRTRAN(RtnJstfCanc,"|","")
				*----------------------------------------*				
	
		ENDCASE

RETURN(LSstatus)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DF65           DFLimpaString VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   41  
*        Variable:            DFLimpaString                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      32                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15df65     &&  DFLimpaString VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFLimpaString
PARAMETERS PrmString
	*-------------------------------------------------------*
	PRIVATE LSstatus
	LSstatus = ""
	*-------------------------------------------------------*
	*PRMString = UPPER(PRMString)

	PRMString = chrtran(PRMString,"","C")       && 01
	PRMString = chrtran(PRMString,"","c")       && 02
	PRMString = chrtran(PRMString,"&","e")       && 03
	PRMString = chrtran(PRMString,"","-")       && 04
	PRMString = chrtran(PRMString,"","-")       && 05
	PRMString = chrtran(PRMString,"",'')        && 06
	PRMString = chrtran(PRMString,"",'')        && 07
	PRMString = chrtran(PRMString,"",'E')       && 08
	PRMString = chrtran(PRMString,"",'e')       && 09
	PRMString = chrtran(PRMString,"",'A')       && 10
	PRMString = chrtran(PRMString,"",'a')       && 11
	PRMString = chrtran(PRMString,"",'')        && 12
	PRMString = chrtran(PRMString,chr(0),'')     && 13
	PRMString = chrtran(PRMString,'"','')        && 14
	PRMString = chrtran(PRMString,'','A')        && 14
	PRMString = chrtran(PRMString,'>',' ')        && 14
	PRMString = chrtran(PRMString,'<',' ')        && 14


RETURN(PrmString)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DF66           DF_Fputs VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   42  
*        Variable:            DF_Fputs                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      33                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15df66     &&  DF_Fputs VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DF_Fputs
PARAMETERS ;
			PrmNroIDfileXML,;
			PrmString,;
			PrmLEN

	PRIVATE LFretorno

	PrmString = DF_FputsLimpa(PrmString)

	LFretorno =fPuts(PrmNroIDfileXML,PrmString,LEN(PrmString))

RETURN(LFretorno)

*----------------------------------------------------------*

FUNCTION DF_FputsLimpa
PARAMETERS PrmString

	PRMString = chrtran(PRMString,"","C")       && 01
	PRMString = chrtran(PRMString,"","c")       && 02
	PRMString = chrtran(PRMString,"&","e")       && 03
	PRMString = chrtran(PRMString,"","-")       && 04
	PRMString = chrtran(PRMString,"","-")       && 05
	PRMString = chrtran(PRMString,"",'')        && 06
	PRMString = chrtran(PRMString,"",'')        && 07
	PRMString = chrtran(PRMString,"",'E')       && 08
	PRMString = chrtran(PRMString,"",'e')       && 09
	PRMString = chrtran(PRMString,"",'A')       && 10
	PRMString = chrtran(PRMString,"",'a')       && 11
	PRMString = chrtran(PRMString,"",'')        && 12
	PRMString = chrtran(PRMString,chr(0),'')     && 13

** nao 	PRMString = chrtran(PRMString,'"','')        && 14

RETURN(PrmString)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DF8E           DFDefIDNFDocFiscal VALID           
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   43  
*        Variable:            DFDefIDNFDocFiscal                 
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      34                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15df8e     &&  DFDefIDNFDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFDefIDNFDocFiscal
PARAMETERS ;
	 PrmEmpresa,;
	 PrmNota,;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc,;
	 RtnDocEletro

    RtnNro_Doc    =   PrmNota
	DO CASE

		CASE PrmNota > 1000000 AND PrmNota < 2000000
		    RtnMOD_DOC    =   "2D"  && CUPOM
		    RtnNro_Doc    =   PrmNota - 1000000
			RtnDocEletro  =   "NAO"

		CASE PrmNota > 2000000 AND PrmNota < 3000000
		    RtnMOD_DOC    =   "03"  && NF SERVICO
		    RtnNro_Doc    =   PrmNota - 2000000
			RtnDocEletro  =   "NAO"

		CASE PrmNota > 3000000 AND PrmNota < 4000000
		    RtnMOD_DOC    =   "55"  && NFe
		    RtnNro_Doc    =   PrmNota - 3000000
			RtnDocEletro  =   "SIM"


		CASE PrmNota > 4000000 AND PrmNota < 5000000
		    RtnMOD_DOC    =   "03"  && NFSe
		    RtnNro_Doc    =   PrmNota - 4000000
			RtnDocEletro  =   "SIM"
		
		OTHERWISE			
			=W_DEFPROC("TIPOOPER.SPR")
			LFieldTmp    = ;
				TPGetFieldValue("S",  PrmTipo ,"Cod_Mod_Rf")
		    RtnMOD_DOC    = LFieldTmp
			RtnDocEletro  =   "NAO"

	ENDCASE
	

    RtnCOD_IDFORN  =   SPACE(14)
**    RtnNRO_DOC     =   PrmNota
    RtnSERIE_DOC   =   LEFT( PrmSerie +"   ",3)

	IF EMPTY(RtnSERIE_DOC)
	    RtnSERIE_DOC  =     LEFT( "01   ",3)
	endif

RETURN(.t.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DF9A           DFNmFileXMLDocFiscal VALID         
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   44  
*        Variable:            DFNmFileXMLDocFiscal               
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      35                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15df9a     &&  DFNmFileXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFNmFileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc


	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*




	LSnomeArqXml = "DFISCP"+;
				   PrmMod_Doc
	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")


   	LSfileXML	= LSnomeArqXml+".XML"
	
RETURN(LSfileXML)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DF9U           DFGravaXMLDocFiscal VALID          
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   45  
*        Variable:            DFGravaXMLDocFiscal                
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      36                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15df9u     &&  DFGravaXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFGravaXMLDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmFileXML,;
			PrmNroIDfileXML,;
			PrmObjetivo


	*---------------------------------------------------*
	PRIVATE LSprocesso

	=W_DEFPROC("DOCFISCA.SPR")
	LSprocesso = DFVersaoXML()

	PRIVATE LFRETORNO




	DO CASE
		CASE "VERSAO-1.1" $ LSprocesso

			LFRETORNO = DFv11GravaXMLDocFiscal( ;
				PrmEmp,;
				PrmMod_doc,;
				PrmCod_IDForn,;
				PrmNro_Doc,;
				PrmSerie_Doc,;
				PrmFileXML,;
				PrmNroIDfileXML,;
				PrmObjetivo)

		CASE "VERSAO-1.0" $ LSprocesso

			LFRETORNO = DFv10GravaXMLDocFiscal( ;
				PrmEmp,;
				PrmMod_doc,;
				PrmCod_IDForn,;
				PrmNro_Doc,;
				PrmSerie_Doc,;
				PrmFileXML,;
				PrmNroIDfileXML,;
				PrmObjetivo)

		OTHERWISE
			LFRETORNO = DFv01GravaXMLDocFiscal( ;
				PrmEmp,;
				PrmMod_doc,;
				PrmCod_IDForn,;
				PrmNro_Doc,;
				PrmSerie_Doc,;
				PrmFileXML,;
				PrmNroIDfileXML,;
				PrmObjetivo)

	ENDCASE
			

RETURN(LFRETORNO)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DF9Z           DFv01GravaXMLDocFiscal VALID       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   46  
*        Variable:            DFv01GravaXMLDocFiscal             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      37                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15df9z     &&  DFv01GravaXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFv01GravaXMLDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmFileXML,;
			PrmNroIDfileXML,;
			PrmObjetivo





	IF !DFLerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+PrmMOD_DOC+;
		      "FORN. : "+STR(PrmCOD_IDFORN,6)+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC
   	  return(.F.)
   ENDIF


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	*-------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	=EMLerRegistro(PrmEmp)

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("CGC")
	UNEM_CNPJ    =  STR(LFieldTmp,14)
	UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")




	SET POINT TO ","
	SET SEPARATOR  TO "."




	LSLinhaXML = ULtratalinha('<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*==========================================================*
	*  CAMPOS IDENTIFICADORES
	*==========================================================*

	=W_DEFPROC("EMPRESA.SPR")

	LSEmite_NFe = EMGetPropVT("EMITE_NFE")




	IF LSEmite_NFe $ "H"   && H=HOMOLOGACAO

		LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             "55" +;
	             '"')
                =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	ELSE
		LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             DFGetPropVT("MOD_DOC") +;
	             '"')
                =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	ENDIF

	
	*----------------------------------------------------------*

	LNNro_Doc  = DFGetPropVT("NRO_DOC")
	IF LNNro_Doc > 3000000
		LNNro_Doc = LNNro_Doc - 3000000
	ENDIF

	LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML = ULtratalinha('DFIS_OPCM_SIGLA="'+;
	             DFGetPropVT("TIPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IND_OPERACAO="'+;
	             DFGetPropVT("IND_OPER") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TP_MOVIMENTO="'+;
	             DFGetPropVT("TP_MOV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------*
	* SERIE UNICA => "0"
	*----------------------------------------------------*
	

	LSLinhaXML = DFGetPropVT("SERIE_DOC")
	IF "U" $ LSLinhaXML
		LSLinhaXML = "0"
	ENDIF

	LSLinhaXML = ULtratalinha('DFIS_SERIE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------*


	LSLinhaXML = ULtratalinha('DFIS_CPF="'+;
	             DFGetPropVT("CPF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CNPJ="'+;
	             DFGetPropVT("CNPJ") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IE="'+;
	             DFGetPropVT("IE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NAT_OPERACAO="'+;
	             DFGetPropVT("NAT_OPER") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IND_EMITENTE="'+;
	             DFGetPropVT("IND_EMITEN") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CDG_SITUACAO="'+;
	             DFGetPropVT("COD_SIT") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*------------------------------------------------------------*

	LSLinhaXML = DFGetPropVT("IND_FRETE")

	IF LSLinhaXML = "1"
	    LSLinhaXML    =   "0"
	else
	    LSLinhaXML    =   "1"
	ENDIF
	

	LSLinhaXML = ULtratalinha('DFIS_IND_FRETE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*------------------------------------------------------------*

	LSLinhaXML = ULtratalinha('DFIS_CHV_NFE="'+;
	             DFGetPropVT("NFE_CHV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DGT_CHV_NFE="'+;
	             DFGetPropVT("NFE_DGTCHV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DT_DOC="'+;
	             DTOC(DFGetPropVT("DT_DOC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DT_CANC="'+;
	             DTOC(DFGetPropVT("DT_CANC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_DOCUMENTO="'+;
	             STR(DFGetPropVT("VLR_DOC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TP_PGTO_CODIGO="'+;
	             DFGetPropVT("TP_PG") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_PGTO_DESCRICAO="'+;
	             DFGetPropVT("TP_PGDESCR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_DESCONTO="'+;
	             STR(DFGetPropVT("VLR_DESCON"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*==========================================================*

	LSLinhaXML = ULtratalinha('DFIS_VLR_ABATE_NT="'+;
	             STR(DFGetPropVT("VLRABAT_NT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_MERCADORIAS="'+;
	             STR(DFGetPropVT("VLR_MERCAD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_FRETE="'+;
	             STR(DFGetPropVT("VLR_FRETE"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_SEGURO="'+;
	             STR(DFGetPropVT("VLR_SEGURO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_DESPESAS="'+;
	             STR(DFGetPropVT("VLR_DESPES"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_OUTRAS_DESP_ACES="'+;
	             STR(DFGetPropVT("OUTDSPACES"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS="'+;
	             STR(DFGetPropVT("BC_ICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS="'+;
	             STR(DFGetPropVT("VLR_ICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS_RTD="'+;
	             STR(DFGetPropVT("BC_ICMSRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_RTD="'+;
	             STR(DFGetPropVT("VLRICMSRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_IPI="'+;
	             STR(DFGetPropVT("BC_IPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_IPI="'+;
	             STR(DFGetPropVT("VLR_IPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS="'+;
	             STR(DFGetPropVT("VLR_PIS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS="'+;
	             STR(DFGetPropVT("VLR_COFINS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_RTD="'+;
	             STR(DFGetPropVT("VLR_PISRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_RTD="'+;
	             STR(DFGetPropVT("VLR_COFRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_INF_COMPLEMENTARES="'+;
	             DFGetPropVT("INF_COMPLE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_PROC_CONCESSORIO="'+;
	             DFGetPropVT("NROPROCCON") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ORIGEM_PROC_CONCESSORIO="'+;
	             DFGetPropVT("ORGPROCCON") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
				
				
	LSLinhaXML = ULtratalinha('DFIS_TP_DOC_IMPORTACAO="'+;
	             DFGetPropVT("TPDOCIMPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
				
	LSLinhaXML = ULtratalinha('DFIS_NRO_DOC_IMPORTACAO="'+;
	             DFGetPropVT("NRODOCIMPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_IMPORTACAO="'+;
	             STR(DFGetPropVT("VLRPISIMPO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_IMPORTACAO="'+;
	             STR(DFGetPropVT("VLRCOFIMPO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_SERVICO_NT="'+;
	             STR(DFGetPropVT("VLRSRVCONT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISS="'+;
	             STR(DFGetPropVT("VLRBCISSQN"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ISS="'+;
	             STR(DFGetPropVT("VLR_ISSQN"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_IR="'+;
	             STR(DFGetPropVT("VLR_BCIRRF"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_IR="'+;
	             STR(DFGetPropVT("VLR_IRRF"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
				

	LSLinhaXML = ULtratalinha('DFIS_VLR_IR_RTD="'+;
	             STR(0,18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_PREVIDENCIA="'+;
	             STR(DFGetPropVT("VLR_BCPREV"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PREVIDENCIA="'+;
	             STR(DFGetPropVT("VLR_PREV"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_AUT_SEFAZ_COMBUSTIVEL="'+;
	             DFGetPropVT("AUTSEFAZCM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_PASSE_FISCAL="'+;
	             DFGetPropVT("NROPASSEFI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TEMPERATURA="'+;
	             STR(DFGetPropVT("TEMPERATUR"),6,1) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_UF="'+;
	             DFGetPropVT("UF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NOME="'+;
	             DFGetPropVT("NOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_RAZAO_SOCIAL="'+;
	             DFGetPropVT("RAZAOSOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_LOGADOURO="'+;
	             DFGetPropVT("TP_LOGRAD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_LOGRADOURO="'+;
	             DFGetPropVT("LOGRADOURO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_LOGRADOURO="'+;
	             DFGetPropVT("NRO_LOGRAD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_COMPL_LOGRADOURO="'+;
	             DFGetPropVT("COMPL_LOGR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CEP="'+;
	             DFGetPropVT("CEP") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ZONA="'+;
	             ("") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*---------------------------------------------------------*

	LSLinhaXML = ALLTRIM(DFGetPropVT("MUNI_IBGE"))
	IF LEN(LSLinhaXML) < 7
		LSLinhaXML = REPLICATE("0",7-LEN(LSLinhaXML))
	ENDIF

	*---------------------------------------------------------*

	LSLinhaXML = ULtratalinha('DFIS_MUNI_IBGE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MUNI_NOME="'+;
	             DFGetPropVT("MUNI_NOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_BAIRRO="'+;
	             DFGetPropVT("BAIRRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PAIS="'+;
	             DFGetPropVT("PAIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CODIGO_PAIS="'+;
	              "1058" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_FONE="'+;
	             DFGetPropVT("FONE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IE_SUB_TRIB="'+;
	             DFGetPropVT("IE_SUBTRIB") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_SUFRAMA="'+;
	             DFGetPropVT("SUFRAMA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------
	*LSLinhaXML = ULtratalinha('DFIS_REF_NRO_DOCUMENTO="'+;
	*             SUBS(STR(DFGetPropVT("REF_NRODOC"),7),2) +;
	*             '"')
	*			=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *----------


	LNNro_Doc  = DFGetPropVT("REF_NRODOC")
	IF LNNro_Doc > 3000000
		LNNro_Doc = LNNro_Doc - 3000000
	ENDIF



	LSLinhaXML = ULtratalinha('DFIS_REF_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_SERIE="'+;
	             DFGetPropVT("REF_SERIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_DT_DOC="'+;
	             DTOC(DFGetPropVT("REF_DT_DOC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_INDOPERACAO="'+;
	             DFGetPropVT("REF_INDOPE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_TP_MOVIMENTO="'+;
	             DFGetPropVT("REF_TP_MOV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_IND_EMITENTE="'+;
	             DFGetPropVT("REF_INDEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_MOD_DOCUMENTO="'+;
	             DFGetPropVT("REF_MODDOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_SERIAL_ECF="'+;
	             DFGetPropVT("NRO_SERECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_CAIXA_ECF="'+;
	             DFGetPropVT("NRO_CX_ECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_CUPOM_COO_ECF="'+;
	             DFGetPropVT("NRO_CPMECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_DT_ENT_OU_SAIDA="'+;
	             DTOC(DFGetPropVT("DT_ENTSAI")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_DDD="'+;
	             DFGetPropVT("DDD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_ESPECIE="'+;
	             DFGetPropVT("ESPECIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_HORA_DOC="'+;
	             DFGetPropVT("HORA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_HR_ENT_OU_SAIDA="'+;
	             DFGetPropVT("HR_ENTSAI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IND_OPER_VEICULO="'+;
	             DFGetPropVT("IND_OPVEIC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IND_USO_ARMA="'+;
	             DFGetPropVT("INDUSOARMA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MARCA="'+;
	             DFGetPropVT("MARCA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MODELO_ECF="'+;
	             DFGetPropVT("MODELO_ECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PESO_BRUTO="'+;
	             STR(DFGetPropVT("PESO_BRUTO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PESO_LIQUIDO="'+;
	             STR(DFGetPropVT("PESO_LIQ"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_QTDE_VOLUMES="'+;
	             STR(DFGetPropVT("QTDE_VOL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_CARGA="'+;
	             DFGetPropVT("TP_CARGA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*-------------------------------------------------------*



	LSLinhaXML = ULtratalinha('DFIS_TP_CREDITO="'+;
	             DFGetPropVT("TP_CREDITO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS_RTD="'+;
	             STR(DFGetPropVT("BCBRICMSRT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS="'+;
	             STR(DFGetPropVT("BCBRICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS_SO="'+;
	             STR(DFGetPropVT("BCBRICMSSO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("BCBRRTDENT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_COFINS="'+;
	             STR(DFGetPropVT("BC_COFINS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_CSLL="'+;
	             STR(DFGetPropVT("BC_CSLL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS_SO="'+;
	             STR(DFGetPropVT("BC_ICMS_SO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_SO="'+;
	             STR(DFGetPropVT("VLR_ICMSSO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISENTA_ICMS="'+;
	             STR(DFGetPropVT("BCISENICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISENTA_IPI="'+;
	             STR(DFGetPropVT("BCISENIPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_OUTR_ICMS="'+;
	             STR(DFGetPropVT("BCOUTRICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_PIS="'+;
	             STR(DFGetPropVT("BC_PIS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("BCRTDENTRA"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_CSLL="'+;
	             STR(DFGetPropVT("VLR_CSLL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_DESP_FINANCEIRA="'+;
	             STR(DFGetPropVT("DESPFINANC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("ICMSRTDENT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISS_RTD="'+;
	             STR(DFGetPropVT("BC_ISS_RTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_ISS_RTD="'+;
	             STR(DFGetPropVT("ISS_RTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_SERVICOS="'+;
	             STR(DFGetPropVT("VLR_SERVIC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PRODUTOS_SERVICOS="'+;
	             STR(DFGetPropVT("TTPRODSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_ALIQ_COFINS="'+;
	             STR(DFGetPropVT("VLRALQCOFI"),5,2) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_CHV_NFe="'+;
	             DFGetPropVT("REF_CHVNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_DGT_NFe="'+;
	             DFGetPropVT("REF_DGTNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_CODIGO_UF_EMITENTE="'+;
	             DFGetPropVT("REF_UF_CDG") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_FORMA_EMISSAO_NFe="'+;
	             DFGetPropVT("NFEFRMAEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_FINALIDADE_EMISSAO_NFe="'+;
	             DFGetPropVT("FNLDAD_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_FORMATO_DANF="'+;
	             DFGetPropVT("FRMTODANF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PROCESSO_EMISSAO_NFE="'+;
	             DFGetPropVT("PROCEMINFE") +;
	             '"')
	             =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VERSAO_NFE="'+;
	             DFGetPropVT("VERSAO_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IM_INSCRICAO_MUNICIPAL="'+;
	             DFGetPropVT("IM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MUNI_IBGE_FATO_GERADOR="'+;
	             DFGetPropVT("MUNIFATOGR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_DT_EMISSAO_NFE="'+;
	             DTOC(DFGetPropVT("REF_DTNFE")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_FORMATO_IMP_DANF="'+;
	             DFGetPropVT("REFFRDANF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_FORMA_EMISSAO_NFE="'+;
	             DFGetPropVT("REFTPEMIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_AMBIENTE_EMISSAO_NFE="'+;
	             DFGetPropVT("REFTPAMBIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_PROCESSO_EMISSAO_NFE="'+;
	             DFGetPropVT("REFPROCEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_VERSAO_NFE="'+;
	             DFGetPropVT("REFVERSAO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_FINALIDADE_EMISSAO_NFE="'+;
	             DFGetPropVT("REFFINALID") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_SERVICOS="'+;
	             STR(DFGetPropVT("VLRPISSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_SERVICOS="'+;
	             STR(DFGetPropVT("VLRCOFSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_AMBIENTE_EMISSAO_NFE="'+;
	             DFGetPropVT("AMBIENTNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CODIGO_PAIS_DESTINATARIO="'+;
	              "1058" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_DT_EMISSAO_NFE="'+;
	             DTOC(DFGetPropVT("DTEMINFE")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*-- TRANSPORTADORA  -------------------------------------*

	LSLinhaXML = ULtratalinha('DFTR_TEM_TRANSPORTADORA="'+;
	             DFGetPropVT("TRSTEM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_RNTC="'+;
	             DFGetPropVT("TRSRNTC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_PLACA_UF="'+;
	             DFGetPropVT("TRSPLACAUF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_PLACA_VEICULO="'+;
	             DFGetPropVT("TRSPLACA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_CPFCNPJ="'+;
	             DFGetPropVT("TRSCPFCNPJ") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_NOME="'+;
	             DFGetPropVT("TRSNOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_UF="'+;
	             DFGetPropVT("TRSUF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_IE="'+;
	             DFGetPropVT("TRSIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_TP_LOGRADOURO="'+;
	             ' ' +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_LOGRADOURO="'+;
	             DFGetPropVT("TRSLOGRA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_NRO="'+;
	             DFGetPropVT("TRSNRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COMPLEMENTO="'+;
	             DFGetPropVT("TRSCOMPLEM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_CEP="'+;
	             DFGetPropVT("TRSCEP") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_MUNI_IBGE="'+;
	             DFGetPropVT("TRSMUNIBGE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_MUNI_NOME="'+;
	             DFGetPropVT("TRSMUNNOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_BAIRRO="'+;
	             DFGetPropVT("TRSBAIRRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_PAIS="'+;
	             DFGetPropVT("TRSPAIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_FONE="'+;
	             DFGetPropVT("TRSFONE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*-------------------------------------------------------*
	LSLinhaXML = ULtratalinha('/>')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)


FUNCTION ULtratalinha
PARAMETERS LSLINHA

	LSLINHA = UPPER(LSLINHA)
	LSLINHA = RTRIM(LSLINHA)

RETURN(LSLINHA)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DFO3           DFVersaoXML VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   47  
*        Variable:            DFVersaoXML                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      38                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dfo3     &&  DFVersaoXML VALID
#REGION 1
RETURN

FUNCTION DFVersaoXML



	=DFModeloRefXML()  && VERIFICA ATUALIZACAO DO LAYOUT

	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDCFIS
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	LSLinhaXML = xmlDCFIS.XML_LINHA

*	locate for "VERSAO-PROCESSO" $ xml_linha
*
*
*	LSLinhaXML = ""
*	IF !EOF()
*		LSLinhaXML = xmlDCFIS.XML_LINHA
*	ENDIF
	SELE xmlDCFIS
	USE
		

RETURN(LSLinhaXML)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DFON           DFv11GravaXMLDocFiscal VALID       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISCA,     Record Number:   48  
*        Variable:            DFv11GravaXMLDocFiscal             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      39                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dfon     &&  DFv11GravaXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFv11GravaXMLDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmFileXML,;
			PrmNroIDfileXML,;
			PrmObjetivo






	IF TYPE("PrmObjetivo") <> "C" ;
	   OR !(PrmObjetivo $ "ESCRITURACAO/EMISSAO/CANCELAMENTO" )
		  PrmObjetivo = "ESCRITURACAO"
	ENDIF


	IF !DFLerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+PrmMOD_DOC+;
		      "FORN. : "+STR(PrmCOD_IDFORN,6)+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC
   	  return(.F.)
   ENDIF


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	*-------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	=EMLerRegistro(PrmEmp)

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("CGC")
	UNEM_CNPJ    =  STR(LFieldTmp,14)
	UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")


	SET POINT TO ","
	SET SEPARATOR  TO "."




	LSLinhaXML = ULtratalinha('<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('XML_OBJETIVO="'+;
	             PrmObjetivo +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*==========================================================*
	*  CAMPOS IDENTIFICADORES
	*==========================================================*

	=W_DEFPROC("EMPRESA.SPR")

	LSEmite_NFe = EMGetPropVT("EMITE_NFE")




	IF LSEmite_NFe $ "H"   && H=HOMOLOGACAO

		LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             "55" +;
	             '"')
                =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	ELSE
		LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             DFGetPropVT("MOD_DOC") +;
	             '"')
                =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	ENDIF

	LSLinhaXML = ULtratalinha('DFIS_IND_OPERACAO="'+;
	             DFGetPropVT("IND_OPER") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
	LSLinhaXML = ULtratalinha('DFIS_TP_MOVIMENTO="'+;
	             DFGetPropVT("TP_MOV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*

	LNNro_Doc  = DFGetPropVT("NRO_DOC")




	LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO_FISCAL="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*----------------------------------------------------*
	* SERIE UNICA => "0"
	*----------------------------------------------------*
	

	LSLinhaXML = DFGetPropVT("SERIE_DOC")
	IF "U" $ LSLinhaXML
		LSLinhaXML = "0"
	ENDIF

	LSLinhaXML = ULtratalinha('DFIS_SERIE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*

	LSLinhaXML = ULtratalinha('DFIS_TIPO_DOCUMENTO_CODIGO="'+;
	             '1' +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_STATUS="'+;
	             DFGetPropVT("DFISSTATUS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_IE_SUB_TRIB="'+;
	             DFGetPropVT("IE_SUBTRIB") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_MUNI_IBGE_FATO_GERADOR="'+;
	             DFGetPropVT("MUNIFATOGR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_NOME="'+;
	             DFGetPropVT("NOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_RAZAO_SOCIAL="'+;
	             DFGetPropVT("RAZAOSOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	IF  !EMPTY(DFGetPropVT("CPF"))
		LSLinhaXML = ULtratalinha('DFIS_CPFCNPJ="'+;
	             DFGetPropVT("CPF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	ELSE
		LSLinhaXML = ULtratalinha('DFIS_CPFCNPJ="'+;
	             DFGetPropVT("CNPJ") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	ENDIF



	LSLinhaXML = ULtratalinha('DFIS_CPF="'+;
	             DFGetPropVT("CPF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_CNPJ="'+;
	             DFGetPropVT("CNPJ") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IE="'+;
	             DFGetPropVT("IE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_SUFRAMA="'+;
	             DFGetPropVT("SUFRAMA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*--------------------------------------------------------*


	LSLinhaXML = ULtratalinha('DFIS_TOMADOR_RETEM_ICMS="'+;
	             "Nao" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TOMADOR_RETEM_IPI="'+;
	             "Nao" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TOMADOR_RETEM_ISS="'+;
	             "Nao" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TOMADOR_RETEM_PIS="'+;
	             "Nao" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TOMADOR_RETEM_COFINS="'+;
	             "Nao" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TOMADOR_RETEM_IR="'+;
	             "Nao" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*--------------------------------------------------------*


	LSLinhaXML = ULtratalinha('DFIS_E_MAIL="'+;
	             DFGetPropVT("E_MAIL_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_E_MAIL_NFE="'+;
	             DFGetPropVT("E_MAIL_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*	LSLinhaXML = ULtratalinha('DFIS_DDD="'+;
*	             DFGetPropVT("DDD") +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*
	LSLinhaXML = ULtratalinha('DFIS_DDD="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_FONE="'+;
	             DFGetPropVT("FONE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TP_LOGADOURO="'+;
	             DFGetPropVT("TP_LOGRAD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_LOGRADOURO="'+;
	             DFGetPropVT("LOGRADOURO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_LOGRADOURO="'+;
	             DFGetPropVT("NRO_LOGRAD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_COMPL_LOGRADOURO="'+;
	             DFGetPropVT("COMPL_LOGR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_BAIRRO="'+;
	             DFGetPropVT("BAIRRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ZONA="'+;
	             ("") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ALLTRIM(DFGetPropVT("MUNI_IBGE"))
	IF LEN(LSLinhaXML) < 7
		LSLinhaXML = REPLICATE("0",7-LEN(LSLinhaXML))
	ENDIF


	LSLinhaXML = ULtratalinha('DFIS_MUNI_IBGE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MUNI_NOME="'+;
	             DFGetPropVT("MUNI_NOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_UF="'+;
	             DFGetPropVT("UF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_CEP="'+;
	             DFGetPropVT("CEP") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_PAIS="'+;
	             DFGetPropVT("PAIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CODIGO_PAIS="'+;
	              "1058" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------*


	LSLinhaXML = ULtratalinha('DFIS_OPCM_SIGLA="'+;
	             DFGetPropVT("TIPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NATUREZA_OPERACAO="'+;
	             DFGetPropVT("NAT_OPER") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_IND_DOC_ELETRONICO="'+;
	             DFGetPropVT("DOC_ELETRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_IND_EMITENTE="'+;
	             DFGetPropVT("IND_EMITEN") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_SITUACAO_CODIGO="'+;
	             DFGetPropVT("COD_SIT") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = DFGetPropVT("IND_FRETE")
	IF LSLinhaXML = "1"
	    LSLinhaXML    =   "0"
	else
	    LSLinhaXML    =   "1"
	ENDIF
	LSLinhaXML = ULtratalinha('DFIS_IND_FRETE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DT_DOC="'+;
	             DTOC(DFGetPropVT("DT_DOC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_HORA_DOC="'+;
	             DFGetPropVT("HORA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*	LSLinhaXML = ULtratalinha('DFIS_DT_ENT_OU_SAIDA="'+;
*	             DTOC(DFGetPropVT("DT_ENTSAI")) +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*

	LSLinhaXML = ULtratalinha('DFIS_DT_ENT_OU_SAIDA="'+;
	             ;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*	LSLinhaXML = ULtratalinha('DFIS_HR_ENT_OU_SAIDA="'+;
*	             DFGetPropVT("HR_ENTSAI") +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*

	LSLinhaXML = ULtratalinha('DFIS_HR_ENT_OU_SAIDA="'+;
	             ;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DT_CANC="'+;
	             DTOC(DFGetPropVT("DT_CANC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_PGTO_CODIGO="'+;
	             DFGetPropVT("TP_PG") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_PGTO_DESCRICAO="'+;
	             DFGetPropVT("TP_PGDESCR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ESPECIE="'+;
	             DFGetPropVT("ESPECIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MARCA="'+;
	             DFGetPropVT("MARCA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IND_USO_ARMA="'+;
	             DFGetPropVT("INDUSOARMA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IND_OPER_VEICULO="'+;
	             DFGetPropVT("IND_OPVEIC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_AUT_SEFAZ_COMBUSTIVEL="'+;
	             DFGetPropVT("AUTSEFAZCM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_DOC_IMPORTACAO="'+;
	             DFGetPropVT("TPDOCIMPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
				
	LSLinhaXML = ULtratalinha('DFIS_NRO_DOC_IMPORTACAO="'+;
	             DFGetPropVT("NRODOCIMPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_NRO_PASSE_FISCAL="'+;
	             DFGetPropVT("NROPASSEFI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_PROC_CONCESSORIO="'+;
	             DFGetPropVT("NROPROCCON") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ORIGEM_PROC_CONCESSORIO="'+;
	             DFGetPropVT("ORGPROCCON") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_INF_COMPLEMENTARES="'+;
	             DFGetPropVT("INF_COMPLE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = "SIM"
	LSLinhaXML = ULtratalinha('DFIS_TRIBUTADA_MUNICIPIO="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

    *-------------------------------------------------------------*
   	LSLinhaXML = ULtratalinha('DFIS_PESO_BRUTO="'+;
	             STR(DFGetPropVT("PESO_BRUTO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PESO_LIQUIDO="'+;
	             STR(DFGetPropVT("PESO_LIQ"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_QTDE_VOLUMES="'+;
	             STR(DFGetPropVT("QTDE_VOL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_NUMERACAO_VOLUMES="'+;
	             "" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TP_CARGA="'+;
	             DFGetPropVT("TP_CARGA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TEMPERATURA="'+;
	             STR(DFGetPropVT("TEMPERATUR"),6,1) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_ECF_MODELO="'+;
	             DFGetPropVT("MODELO_ECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ECF_NUMERO_CAIXA="'+;
	             DFGetPropVT("NRO_CX_ECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ECF_NUMERO_CUPOM_COO="'+;
	             DFGetPropVT("NRO_CPMECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ECF_NUMERO_SERIE="'+;
	             DFGetPropVT("NRO_SERECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*------------------------------------------------------------*
	*----------
	*LSLinhaXML = ULtratalinha('DFIS_REF_NRO_DOCUMENTO="'+;
	*             SUBS(STR(DFGetPropVT("REF_NRODOC"),7),2) +;
	*             '"')
	*			=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *----------


	LNNro_Doc  = DFGetPropVT("REF_NRODOC")


	DO CASE
		CASE LNNro_Doc > 4000000
			LNNro_Doc = LNNro_Doc - 4000000
		CASE LNNro_Doc > 3000000
			LNNro_Doc = LNNro_Doc - 3000000
		CASE LNNro_Doc > 2000000
			LNNro_Doc = LNNro_Doc - 2000000
	ENDCASE



	LSLinhaXML = ULtratalinha('DFIS_REF_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_SERIE="'+;
	             DFGetPropVT("REF_SERIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	

	LSLinhaXML = ULtratalinha('DFIS_REF_DT_DOC="'+;
	             DTOC(DFGetPropVT("REF_DT_DOC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_IND_OPERACAO="'+;
	             DFGetPropVT("REF_INDOPE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_TP_MOVIMENTO="'+;
	             DFGetPropVT("REF_TP_MOV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_IND_EMITENTE="'+;
	             DFGetPropVT("REF_INDEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_MOD_DOCUMENTO="'+;
	             DFGetPropVT("REF_MODDOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_CHAVE_ACESSO="'+;
	             DFGetPropVT("REF_CHVNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

*	LSLinhaXML = ULtratalinha('DFIS_REF_DGT_NFe="'+;
*	             DFGetPropVT("REF_DGTNFE") +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_CODIGO_UF_EMITENTE="'+;
	             DFGetPropVT("REF_UF_CDG") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_DT_EMISSAO="'+;
	             DTOC(DFGetPropVT("REF_DTNFE")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_FORMATO_IMPRESSAO="'+;
	             DFGetPropVT("REFFRDANF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_FORMA_EMISSAO="'+;
	             DFGetPropVT("REFTPEMIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_AMBIENTE_EMISSAO="'+;
	             DFGetPropVT("REFTPAMBIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_PROCESSO_EMISSAO="'+;
	             DFGetPropVT("REFPROCEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_VERSAO_LAYOUT="'+;
	             DFGetPropVT("REFVERSAO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_FINALIDADE_EMISSAO_NFE="'+;
	             DFGetPropVT("REFFINALID") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*------------------------------------------------------------*
	LSLinhaXML = ULtratalinha('DFIS_CHAVE_ACESSO="'+;
	             DFGetPropVT("NFE_CHV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_AMBIENTE_EMISSAO="'+;
	             DFGetPropVT("AMBIENTNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DATA_EMISSAO="'+;
	             DTOC(DFGetPropVT("DTEMINFE")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_FINALIDADE_EMISSAO="'+;
	             DFGetPropVT("FNLDAD_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_FORMA_EMISSAO="'+;
	             DFGetPropVT("NFEFRMAEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_FORMATO_IMPRESSAO="'+;
	             DFGetPropVT("FRMTODANF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PROCESSO_EMISSAO="'+;
	             DFGetPropVT("PROCEMINFE") +;
	             '"')
	             =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_STATUS="'+;
	             DFGetPropVT("NFE_STATUS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_STATUS_DESCRICAO="'+;
	             "" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_NUMERO_RECIBO="'+;
	             DFGetPropVT("NFE_RECIBO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NUMERO_PROTOCOLO="'+;
	             DFGetPropVT("NFE_PROTOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_JUSTIFICATIVA="'+;
	             DFGetPropVT("NFEJSTFCAN") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PROTOCOLO_CANCELAMENTO="'+;
	             DFGetPropVT("NFEPRTCCAN") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VERSAO_LAYOUT="'+;
	             DFGetPropVT("VERSAO_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*-- TRANSPORTADORA  -------------------------------------*

    *--> PASSOU PARA XML INDEPENDENTE

	*--------------------------------------------------------*

	*----------------------------------------------------*

	LSLinhaXML = ULtratalinha('DFIS_VLR_DOCUMENTO="'+;
	             STR(DFGetPropVT("VLR_DOC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_SERVICOS="'+;
	             STR(DFGetPropVT("VLR_SERVIC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_FRETE="'+;
	             STR(DFGetPropVT("VLR_FRETE"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_DESCONTO="'+;
	             STR(DFGetPropVT("VLR_DESCON"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_SEGURO="'+;
	             STR(DFGetPropVT("VLR_SEGURO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_MERCADORIAS="'+;
	             STR(DFGetPropVT("VLR_MERCAD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ABATE_NT="'+;
	             STR(DFGetPropVT("VLRABAT_NT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_DESPESAS="'+;
	             STR(DFGetPropVT("VLR_DESPES"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_DESP_FINANCEIRA="'+;
	             STR(DFGetPropVT("DESPFINANC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_OUTRAS_DESP_ACES="'+;
	             STR(DFGetPropVT("OUTDSPACES"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	********************************************************************
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	********************************************************************
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	********************************************************************

	*----------------------------------------------------*
	*     Campos de Preenchimento Doc Fiscal Para EFD versao 1.0
	* (SERAO DESCARTADOS NA PROXIMA VERS홒 )-->
	* nao e necessario preencher para versoes NFe e EFD que se
	* baseiam na TABELA DFIS DOCUMENTOS FISCAIS
	*
	*----------------------------------------------------*

    * ----  FORAM DESCARTADOS e depois retomados para atender EFD com
    *  versao nao atualizada

	********************************************************************
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	********************************************************************

	*----------------------------------------------------*
	*     Campos de Preenchimento Doc Fiscal Para EFD versao 1.0
	* (SERAO DESCARTADOS NA PROXIMA VERS홒 )-->
	* nao e necessario preencher para versoes NFe e EFD que se
	* baseiam na TABELA DFIS DOCUMENTOS FISCAIS
	*
	*----------------------------------------------------*



	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS="'+;
	             STR(DFGetPropVT("BC_ICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS="'+;
	             STR(DFGetPropVT("VLR_ICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS_RTD="'+;
	             STR(DFGetPropVT("BC_ICMSRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_RTD="'+;
	             STR(DFGetPropVT("VLRICMSRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_IPI="'+;
	             STR(DFGetPropVT("BC_IPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_IPI="'+;
	             STR(DFGetPropVT("VLR_IPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS="'+;
	             STR(DFGetPropVT("VLR_PIS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS="'+;
	             STR(DFGetPropVT("VLR_COFINS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_RTD="'+;
	             STR(DFGetPropVT("VLR_PISRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_RTD="'+;
	             STR(DFGetPropVT("VLR_COFRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_IMPORTACAO="'+;
	             STR(DFGetPropVT("VLRPISIMPO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_IMPORTACAO="'+;
	             STR(DFGetPropVT("VLRCOFIMPO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_SERVICO_NT="'+;
	             STR(DFGetPropVT("VLRSRVCONT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISS="'+;
	             STR(DFGetPropVT("VLRBCISSQN"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ISS="'+;
	             STR(DFGetPropVT("VLR_ISSQN"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_IR="'+;
	             STR(DFGetPropVT("VLR_BCIRRF"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_IR="'+;
	             STR(DFGetPropVT("VLR_IRRF"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
				

	LSLinhaXML = ULtratalinha('DFIS_VLR_IR_RTD="'+;
	             STR(0,18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_PREVIDENCIA="'+;
	             STR(DFGetPropVT("VLR_BCPREV"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PREVIDENCIA="'+;
	             STR(DFGetPropVT("VLR_PREV"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*-------------------------------------------------------*


*
*	LSLinhaXML = ULtratalinha('DFIS_TP_CREDITO="'+;
*	             DFGetPropVT("TP_CREDITO") +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS_RTD="'+;
	             STR(DFGetPropVT("BCBRICMSRT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS="'+;
	             STR(DFGetPropVT("BCBRICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS_SO="'+;
	             STR(DFGetPropVT("BCBRICMSSO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("BCBRRTDENT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_COFINS="'+;
	             STR(DFGetPropVT("BC_COFINS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_CSLL="'+;
	             STR(DFGetPropVT("BC_CSLL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS_SO="'+;
	             STR(DFGetPropVT("BC_ICMS_SO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_SO="'+;
	             STR(DFGetPropVT("VLR_ICMSSO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISENTA_ICMS="'+;
	             STR(DFGetPropVT("BCISENICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISENTA_IPI="'+;
	             STR(DFGetPropVT("BCISENIPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_OUTR_ICMS="'+;
	             STR(DFGetPropVT("BCOUTRICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_PIS="'+;
	             STR(DFGetPropVT("BC_PIS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("BCRTDENTRA"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_CSLL="'+;
	             STR(DFGetPropVT("VLR_CSLL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("ICMSRTDENT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISS_RTD="'+;
	             STR(DFGetPropVT("BC_ISS_RTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_ISS_RTD="'+;
	             STR(DFGetPropVT("ISS_RTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_PRODUTOS_SERVICOS="'+;
	             STR(DFGetPropVT("TTPRODSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_ALIQ_COFINS="'+;
	             STR(DFGetPropVT("VLRALQCOFI"),5,2) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IM="'+;
	             DFGetPropVT("IM_TOMADOR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_SERVICOS="'+;
	             STR(DFGetPropVT("VLRPISSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_SERVICOS="'+;
	             STR(DFGetPropVT("VLRCOFSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_CODIGO_PAIS_DESTINATARIO="'+;
	              "1058" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*-------------------------------------------------------*
	LSLinhaXML = ULtratalinha('/>')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)

FUNCTION ULtratalinha
PARAMETERS LSLINHA

	LSLINHA = UPPER(LSLINHA)
	LSLINHA = RTRIM(LSLINHA)

RETURN(LSLINHA)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DG3F           DIVerifyInst VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:    2  
*        Variable:            DIVerifyInst                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      40                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dg3f     &&  DIVerifyInst VALID
#REGION 2
return
*---------------------------------------------------------------*



FUNCTION DIVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("DocFisIt")


	DO CASE

		CASE TYPE("PBDocFisItAlias") = "U" ;
		   		OR EMPTY(PBDocFisItAlias) ;
		   		OR !USED(PBDocFisItAlias)
			=DICreate()					

		CASE !("DOCFISIT.DBF" $ DBF(PBDocFisItAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBDocFisItAlias
			=DICreate()					


		CASE  !(LSPath $ DBF(PBDocFisItAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=DIDestroi()				
			=DICreate()					
	ENDCASE

	
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DG40           DICreate VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:    3  
*        Variable:            DICreate                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      41                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dg40     &&  DICreate VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DICreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBDocFisItAlias") <> "U" ;
	   		AND !EMPTY(PBDocFisItAlias) ;
	   		AND USED(PBDocFisItAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBDocFisItAlias

	IF USED("DocFisIt")
	     =NetArqAgain("DocFisIt")
	     PBDocFisItAlias     = Alias()
	ELSE
	     =NetArqAgain("DocFisIt")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("DocFisIt")
	     PBDocFisItAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBDocFisItAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTDocFisIt[LMaxDim]
    PUBLIC DIMENSION VDDocFisIt[2,3]			&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFDocFisIt[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFDocFisIt)

	*-----------------------------------------------------------*
	=DIReadProperty()
	=DISetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DG4W           DIDestroi VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:    4  
*        Variable:            DIDestroi                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      42                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dg4w     &&  DIDestroi VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION DIDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBDocFisItAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBDocFiscaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBDocFiscaAlias
	*  3- Se aplicar um FECHAMENTO a PBDocFiscaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBDocFiscaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBDocFisItAlias)) OR ;
	   !("DOCFISIT.DBF" $ DBF(PBDocFisItAlias))

		RELEASE PBDocFisItAlias
    	RELEASE VTDocFisIt
	    RELEASE VDDocFisIt
	    RELEASE VFDocFisIt
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBDocFisItAlias) AND USED(PBDocFisItAlias)
		SELECT &PBDocFisItAlias
		USE
	ENDIF	
	RELEASE PBDocFisItAlias
    RELEASE VTDocFisIt
    RELEASE VDDocFisIt
    RELEASE VFDocFisIt

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DG5M           DIReadProp VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:    5  
*        Variable:            DIReadProp                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      43                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dg5m     &&  DIReadProp VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=DIVerifyInst()

	SELE &PBDocFisItAlias
	SCATTER TO VTDocFisIt
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DG5N           DISetDerivadas VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:    6  
*        Variable:            DISetDerivadas                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      44                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dg5n     &&  DISetDerivadas VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DISetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

**	=DIVerifyInst()
	*--------------------------------------------------------------*
    VDDocFisIt(1,1) = "NAOINFORMADO"
   	VDDocFisIt(1,2) = 0
   	VDDocFisIt(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DG6G           DISetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:    7  
*        Variable:            DISetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      45                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dg6g     &&  DISetPropVT VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DISetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBDocFisItAlias,;
						    VTDocFisIt,;
							VDDocFisIt,;
							VFDocFisIt)

RETURN(Lvalue)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DG6Y           DIGetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:    8  
*        Variable:            DIGetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      46                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dg6y     &&  DIGetPropVT VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

**	=DIVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
					PBDocFisItAlias,;
					VTDocFisIt,;
					VDDocFisIt,;
					VFDocFisIt)

RETURN(Lvalue)





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DG7E           DIChk_Identidade VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:    9  
*        Variable:            DIChk_Identidade                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      47                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dg7e     &&  DIChk_Identidade VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIChk_Identidade
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item
			


	PRIVATE LFretorno
	LFretorno = .t.



	=DIVerifyInst()
    =DISetPropVT("EMPRESA",PrmEmp)
    =DISetPropVT("MOD_DOC",PrmMod_doc)
    =DISetPropVT("COD_IDFORN",PrmCod_IDForn)
    =DISetPropVT("SERIE_DOC",PrmSerie_Doc)
    =DISetPropVT("NRO_DOC",PrmNro_Doc)
    =DISetPropVT("NRO_ITEM",PrmNro_Item)


	LFretorno=DIFind()
RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DG82           DIFind VALID                       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   10  
*        Variable:            DIFind                             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      48                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dg82     &&  DIFind VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIFind

	PRIVATE LEmpresa,;
			LMod_doc,;
			LCod_IDForn,;
			LNro_Doc,;
			LSerie_Doc,;
			LNro_Item
			
	
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=DIVerifyInst()


	LEmpresa    = DIGetPropVT("Empresa")
	LMod_Doc    = DIGetPropVT("Mod_Doc")
	LCod_IdForn = DIGetPropVT("Cod_IdForn")
	LNro_Doc    = DIGetPropVT("Nro_Doc")
	LSerie_Doc  = DIGetPropVT("Serie_Doc")
	LNro_Item  = DIGetPropVT("Nro_Item")


	SELE &PBDocFisItAlias
	SET ORDER TO TAG item
	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+STR(LNro_Doc,7);
				+LSerie_Doc+STR(LNro_Item,5)

	IF FOUND()
		=DIReadProperty()
		=DISetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DG8W           DIGetFieldValue VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   11  
*        Variable:            DIGetFieldValue                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      49                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dg8w     &&  DIGetFieldValue VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIGetFieldValue
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmSerie_Doc,;
			PrmNro_Doc,;
			PrmNro_Item,;
			PrmField


	IF !DIChk_Identidade(PrmEmp,;
					  PrmMod_doc,;
					  PrmCod_IDForn,;
					  PrmNro_Doc,;
					  PrmSerie_Doc,;
					  PrmNro_Item)
				
					
		DO WHILE .T.
			=UPerrosys("Chamada GetFieldValue para Reg. Inexistente!")
		ENDDO
	ENDIF				


RETURN(DIGetPropVT(PrmField))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DG9O           DI_Refresh VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   12  
*        Variable:            DI_Refresh                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      50                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dg9o     &&  DI_Refresh VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DI_Refresh
PARAMETERS  PrmEmpresa,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmSerie_Doc,;
			PrmNro_Doc,;
			PrmNro_Item
			

	PRIVATE LFreturn

	=DIVerifyInst()


	= DISetPropVT("Empresa"   ,PrmEmpresa)
	= DISetPropVT("Mod_Doc"   ,PrmMod_doc)
	= DISetPropVT("Cod_IdForn",PrmCod_IDForn)
	= DISetPropVT("Nro_Doc"   ,PrmNro_Doc)
	= DIFSetPropVT("Serie_Doc" ,PrmSerie_Doc)
	= DISetPropVT("Nro_Item"   ,PrmNro_Item)

	*----------------------------------------------------------------*


	=DIFind()
	
RETURN(.t.)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DGAD           DILerRegistro VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   14  
*        Variable:            DILerRegistro                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      51                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dgad     &&  DILerRegistro VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DILerRegistro
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item


	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = DIChk_Identidade(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item)

			
RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DGB6           DIWriteProp VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   15  
*        Variable:            DIWriteProp                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      52                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dgb6     &&  DIWriteProp VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBDocFisItAlias
	=RLOCK()
	GATHER FROM  VTDocFisIt
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DGBQ           DISalvarRegistro VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   16  
*        Variable:            DISalvarRegistro                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      53                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dgbq     &&  DISalvarRegistro VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DISalvarRegistro


	PRIVATE LFretorno
	LFretorno = .t.

	IF !DIExiste()
		SELE &PBDocFisItAlias
		APPEND BLANK
		LFretorno=DIWriteProp()
	ELSE
		SELE &PBDocFisItAlias
		LFretorno=DIWriteProp()
	ENDIF

RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DGBR           DIExiste VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   17  
*        Variable:            DIExiste                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      54                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dgbr     &&  DIExiste VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIExiste

	PRIVATE LEmpresa,;
			LMod_doc,;
			LCod_IDForn,;
			LNro_Doc,;
			LSerie_Doc,;
			LNro_Item
			
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()


	LEmpresa    = DIGetPropVT("Empresa")
	LMod_Doc    = DIGetPropVT("Mod_Doc")
	LCod_IdForn = DIGetPropVT("Cod_IdForn")
	LNro_Doc    = DIGetPropVT("Nro_Doc")
	LSerie_Doc  = DIGetPropVT("Serie_Doc")
	LNro_Item   = DIGetPropVT("Nro_Item")


	SELE &PBDocFisItAlias
	SET ORDER TO TAG ITEM
	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	     STR(LNro_Doc,7)+LSerie_Doc+STR(LNro_Item,5)
	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DGD2           DIV10GravaXMLItensDocFiscal VALID  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   20  
*        Variable:            DIV10GravaXMLItensDocFiscal        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      55                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dgd2     &&  DIV10GravaXMLItensDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIV10GravaXMLItensDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item,;
			PrmFileXML,;
			PrmNroIDfileXML

	*---------------------------------------------------*

	IF !DILerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item)
	      wait "Nao foi localizado Item DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+MOD_DOC+;
		      "FORN. : "+PrmCOD_IDFORN+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC+;
		      "ITEM  : "+STR(PrmNro_Item,4)
    	  return(.F.)
	ENDIF


	IF DIGetPropVT("QTDE") = 0
    	  return(.t.)
	ENDIF		




	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFLerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado Capa DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+MOD_DOC+;
		      "FORN. : "+PrmCOD_IDFORN+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC
    	  return(.F.)
	ENDIF
	

	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	SET POINT TO ","
	SET SEPARATOR  TO "."


	*-------------------------------------------------------*


		=W_DEFPROC("EMPRESA.SPR")
		=EMLerRegistro(PrmEmp)

		=W_DEFPROC("EMPRESA.SPR")
		LFieldTmp    =  EMGetPropVT("CGC")
	    UNEM_CNPJ    =  STR(LFieldTmp,14)
		UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")


		LSLinhaXML = '<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	


		*==========================================================*
		*  CAMPOS IDENTIFICADORES
		*==========================================================*
	

		=W_DEFPROC("EMPRESA.SPR")
		LFieldTmp    =  EMGetPropVT("EMITE_NFE")

		IF LFieldTmp $ "H"   && H=HOMOLOGACAO

			=W_DEFPROC("DOCFISCA.SPR")
			LSLinhaXML = 'DFIS_MOD_DOCUMENTO="'+;
	    	         "55" +;
	        	     '"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		ELSE
			=W_DEFPROC("DOCFISCA.SPR")
			LSLinhaXML = 'DFIS_MOD_DOCUMENTO="'+;
	    	         DFGetPropVT("MOD_DOC") +;
	        	     '"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF



		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CLFS_SIGLA="'+;
	             DFGetPropVT("TIPO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_IND_OPERACAO="'+;
	             DFGetPropVT("IND_OPER") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_TP_MOVIMENTO="'+;
	             DFGetPropVT("TP_MOV") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		*----------------------------------------------------------*
		=W_DEFPROC("DOCFISCA.SPR")
		LNNro_Doc  = DFGetPropVT("NRO_DOC")
		IF LNNro_Doc > 4000000
			LNNro_Doc = LNNro_Doc - 4000000
		ENDIF

		IF LNNro_Doc > 3000000
			LNNro_Doc = LNNro_Doc - 3000000
		ENDIF

		IF LNNro_Doc > 2000000
			LNNro_Doc = LNNro_Doc - 2000000
		ENDIF




		LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		*----------------------------------------------------------*



		IF  !EMPTY(DFGetPropVT("CPF"))
			LSLinhaXML = ULtratalinha('DFIS_CPFCNPJ="'+;
	    	         DFGetPropVT("CPF") +;
	        	     '"')
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ELSE
			LSLinhaXML = ULtratalinha('DFIS_CPFCNPJ="'+;
	    	         DFGetPropVT("CNPJ") +;
	        	     '"')
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF




		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CPF="'+;
	             DFGetPropVT("CPF") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CNPJ="'+;
	             DFGetPropVT("CNPJ") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		*----------------------------------------------------*


		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_IE="'+;
	             DFGetPropVT("IE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		*----------------------------------------------------*
		* SERIE UNICA => "0"
		*----------------------------------------------------*
	

		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = DFGetPropVT("SERIE_DOC")
		IF "U" $ LSLinhaXML
			LSLinhaXML = "0"
		ENDIF
		LSLinhaXML = 'DFIS_SERIE="'+;
	             LSLinhaXML +;
	             '"'
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		*----------------------------------------------------*

		LSLinhaXML = 'ITDF_NRO_ITEM="'+;
	             STR(DIGetPropVT("NRO_ITEM"),5) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		*-------------------------------------------------------*

		LSLinhaXML = 'ITDF_PROD_CODIGO="'+;
	             DIGetPropVT("PRODCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_DESCRICAO="'+;
	             DIGetPropVT("PRODDESCR") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_DESCR_COMPL="'+;
	             DIGetPropVT("PRODCOMPLE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_PROD_INFO_ADICIONAIS="'+;
	             DIGetPropVT("INFO_COMPL") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_UNIDADE="'+;
	             DIGetPropVT("UNIDADE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_PRECO_TABELA="'+;
	             STR(DIGetPropVT("PRECO_TAB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_PRECO_MAX_TABELADO="'+;
	             STR(DIGetPropVT("PRECOMAXTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_PRECO_MIN_TABELADO="'+;
	             STR(DIGetPropVT("PRECOMINTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	

		LSLinhaXML = 'ITDF_QTDE="'+;
	             STR(DIGetPropVT("QTDE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_DESCONTO="'+;
	             STR(DIGetPropVT("VLR_DESCTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_VLR_DESP_FINANCEIRA="'+;
	             STR(DIGetPropVT("VLRDESPFIN"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_OUTRAS_DESP_ACES="'+;
	             STR(DIGetPropVT("VLRDESPOUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_FRETE="'+;
	             STR(DIGetPropVT("VLR_FRETE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SEGURO="'+;
	             STR(DIGetPropVT("VLR_SEGURO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_FINAL="'+;
	             STR(DIGetPropVT("VLR_FINAL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_MENSAGEM="'+;
	             SPACE(5) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_IND_MOVIMENTO_ESTQ="'+;
	             DIGetPropVT("IND_MOVEST") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_QTDE_ITENS="'+;
	             STR(DIGetPropVT("LT_QTITENS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
		LSLinhaXML = 'ITDF_LOTE_NRO="'+;
	             DIGetPropVT("LT_NRO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_FABRICACAO="'+;
	             DTOC(DIGetPropVT("LT_DT_FABR")) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_VALIDADE="'+;
	             DTOC(DIGetPropVT("LT_VALIDAD")) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_MEDIO_ATUAL="'+;
	             STR(DIGetPropVT("CUSTOMEDAT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
		LSLinhaXML = 'ITDF_SALDO_ANTERIOR="'+;
	             STR(DIGetPropVT("SALDO_ANT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_MEDIO_ANT="'+;
	             STR(DIGetPropVT("CUSTOMEDAN"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_NA_OPERACAO="'+;
	             STR(DIGetPropVT("CUSTONAOPE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_A_TRIBUTAR="'+;
	             STR(DIGetPropVT("VLRATRIBUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_SALDO_ATUAL="'+;
	             STR(DIGetPropVT("SALDO_ATU"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_CONTABIL="'+;
	             STR(DIGetPropVT("CUSTOCONTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_CFOP_FORNECEDOR="'+;
	             DIGetPropVT("CFOP") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_CFOP="'+;
	             DIGetPropVT("CFOP") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_CST_ICMS="'+;
	             DIGetPropVT("CST_ICMS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_IPI="'+;
	             DIGetPropVT("CST_IPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_ISS="'+;
	             DIGetPropVT("CST_ISS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_PIS="'+;
	             DIGetPropVT("CST_PIS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_COFINS="'+;
	             DIGetPropVT("CST_COFINS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_IR="'+;
	             DIGetPropVT("CST_IR") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS="'+;
	             STR(DIGetPropVT("BCBRUTAICM"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_REDUCAO="'+;
	             STR(DIGetPropVT("IND_REDUCA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS="'+;
	             STR(DIGetPropVT("BC_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_ORIGEM="'+;
	             STR(DIGetPropVT("ALQICMORIG"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_DESTINO="'+;
	             STR(DIGetPropVT("ALQICMDEST"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_DIFERENCIAL_ALIQUOTA="'+;
	             STR(DIGetPropVT("DIF_ALIQ"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS="'+;
	             STR(DIGetPropVT("ALIQ_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ICMS="'+;
	             STR(DIGetPropVT("VLR_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_REG_FISCAL_TRIB_ORIGEM="'+;
	             DIGetPropVT("RGTRIBORIG") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_REG_FISCAL_TRIB_DESTINO="'+;
	             DIGetPropVT("RGTRIBDEST") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISENTA_ICMS="'+;
	             STR(DIGetPropVT("BASE_ISENT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_OUTR_ICMS="'+;
	             STR(DIGetPropVT("BASE_OUTR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS_RTD="'+;
	             STR(DIGetPropVT("BCBRTRTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IVA="'+;
	             STR(DIGetPropVT("IVA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS_RTD="'+;
	             STR(DIGetPropVT("BC_RTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_ALIQ_ICMS_RTD="'+;
	             STR(DIGetPropVT("ALQICMRTDS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ICMS_RTD="'+;
	             STR(DIGetPropVT("ICM_RTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("BCBRTRTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_BC_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("BC_RTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ICMS_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("ICM_RTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_APURACAO_IPI="'+;
	             DIGetPropVT("INDAPURIPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_IPI="'+;
	             STR(DIGetPropVT("BC_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_IPI="'+;
	             STR(DIGetPropVT("ALIQ_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IPI="'+;
	             STR(DIGetPropVT("VLR_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISS="'+;
	             STR(DIGetPropVT("BC_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ISS="'+;
	             STR(DIGetPropVT("ALIQ_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ISS="'+;
	             STR(DIGetPropVT("VLR_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISS_RTD="'+;
	             STR(DIGetPropVT("BC_ISS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ISS_RTD="'+;
	             STR(DIGetPropVT("ALIQ_ISSRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ISS_RTD="'+;
	             STR(DIGetPropVT("VLR_ISSRTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_PIS="'+;
	             STR(DIGetPropVT("BC_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_PIS="'+;
	             STR(DIGetPropVT("ALIQ_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_PIS="'+;
	             STR(DIGetPropVT("QTDBASEPIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS="'+;
	             STR(DIGetPropVT("VLR_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS_RTD="'+;
	             STR(DIGetPropVT("PIS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_COFINS="'+;
	             STR(DIGetPropVT("BC_COFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_COFINS="'+;
	             STR(DIGetPropVT("ALIQCOFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_COFINS="'+;
	             STR(DIGetPropVT("QTDBASECOF"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_COFINS="'+;
	             STR(DIGetPropVT("VLR_COFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_COFINS_RTD="'+;
	             STR(DIGetPropVT("COFINS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_IR="'+;
	             STR(DIGetPropVT("BC_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_IR="'+;
	             STR(DIGetPropVT("ALIQ_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IR="'+;
	             STR(DIGetPropVT("VLR_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IR_RTD="'+;
	             STR(DIGetPropVT("IR_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_CSLL="'+;
	             STR(DIGetPropVT("BC_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_CSLL="'+;
	             STR(DIGetPropVT("ALIQ_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_CSLL="'+;
	             STR(DIGetPropVT("VLR_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ADIANTAMENTO_CSLL="'+;
	             STR(DIGetPropVT("ADNTA_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LANC_AUTOMATICO="'+;
	             DIGetPropVT("LANC_AUTO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_SERV_TELECOM="'+;
	             DIGetPropVT("CLSCOMNC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_GAS="'+;
	             DIGetPropVT("CLSGAS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_AGUA="'+;
	             DIGetPropVT("CLSAGUA") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_ENERGIA_ELETR="'+;
	             DIGetPropVT("CLSENRG") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_SO="'+;
	             STR(DIGetPropVT("ALIQICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_MOD_BC_ICMS="'+;
	             DIGetPropVT("MOD_BCICMS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PERCENTUAL_ACRESCIMO="'+;
	             STR(DIGetPropVT("PRC_ACRESC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PERCENTUAL_DESCONTO="'+;
	             STR(DIGetPropVT("PRC_DESCON"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_VENDA_UNITARIO="'+;
	             STR(DIGetPropVT("PRECOVENDA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ABATE_NT="'+;
	             STR(DIGetPropVT("VLRABATENT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ACRESCIMO="'+;
	             STR(DIGetPropVT("VLRACRESC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS_SO="'+;
	             STR(DIGetPropVT("BCBRICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS_SO="'+;
	             STR(DIGetPropVT("BCICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISENTA_IPI="'+;
	             STR(DIGetPropVT("BCISENTIPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_COFINS_IMPORTACAO="'+;
	             STR(DIGetPropVT("VLRCOFIMPO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_DESPESAS="'+;
	             STR(DIGetPropVT("VLR_DESPES"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ICMS_SO="'+;
	             STR(DIGetPropVT("VLR_ICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS_IMPORTACAO="'+;
	             STR(DIGetPropVT("VLRPISIMPO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PRODUTOS="'+;
	             STR(DIGetPropVT("VLRPRODUTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SERVICO_NT="'+;
	             STR(DIGetPropVT("VLRSRVC_NT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SERVICOS="'+;
	             STR(DIGetPropVT("VLRSERVICO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_TRIBUTOS="'+;
	             STR(DIGetPropVT("VLRTRIBUTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ORIGEM_MERCADORIA="'+;
	             DIGetPropVT("ORIGEMMRCD") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = DIGetPropVT("ITEMSERVIC")
		IF LSLinhaXML = "S"
			LSLinhaXML = 'ITDF_O_ITEM_E_SERVICO="'+;
	             "SIM" +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ELSE
			LSLinhaXML = 'ITDF_O_ITEM_E_SERVICO="'+;
	             "NAO" +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF


		LSLinhaXML = 'ITDF_VLR_PRODUTOS_SERVICOS="'+;
	             STR(DIGetPropVT("TTPRODSRVC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_GTIM="'+;
	             DIGetPropVT("GTIMCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_NCM="'+;
	             DIGetPropVT("NCMCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_EX_TIPI="'+;
	             DIGetPropVT("EXTIPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_GENERO="'+;
	             DIGetPropVT("GENEROPROD") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_GTIM_UNIDADE_TRIBUTAVEL="'+;
	             DIGetPropVT("GTIMUNTRIB") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_UNIDADE_TRIBUTAVEL="'+;
	             DIGetPropVT("UNIDTRIBUT") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_UNIDADE_TRIBUTAVEL="'+;
	             STR(DIGetPropVT("VLRUNTRIBU"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_UNIDADE_TRIBUTAVEL="'+;
	             STR(DIGetPropVT("QTDTRIBUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLS_CODIGO_LISTA_SERVICO="'+;
	             DIGetPropVT("CDGLSTSRVC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_MOD_BC_ICMS_RTD="'+;
	             DIGetPropVT("MODBCICMRT") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_COFINS_RTD="'+;
	             STR(DIGetPropVT("QTDBCCOFRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_INSS="'+;
	             STR(0,15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_VLR_ALIQ_COFINS_RTD="'+;
	             STR(DIGetPropVT("VLRALQCFRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_IND_MED_BC_ICMS_RTD="'+;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))






		*-------------------------------------------------------*
		LSLinhaXML = '/>'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	
		SET POINT TO
		SET SEPARATOR to

RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHW8           DIGetAlias VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   21  
*        Variable:            DIGetAlias                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      56                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhw8     &&  DIGetAlias VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIGetAlias

	=DIVerifyInst()

RETURN(PBDocFisItAlias)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHWC           DICFOPS VALID                      
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   22  
*        Variable:            DICFOPS                            
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      57                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhwc     &&  DICFOPS VALID
#REGION 2
RETURN

*-------------------------------------------------------*
*-----> DEFINECFOP PARA SERVICO
*-------------------------------------------------------*

FUNCTION DICFOPS
PARAMETERS PrmUFOrgn, PrmMuniOrgn,PrmUFDstn, PrmMuniDstn,PrmTp_mercad,;
           PrmOperacao

	PRIVATE LScfps


	=W_DEFPROC("TRIBUTAR.SPR")
    LScfps = TRCFOPServico(PrmUFOrgn, PrmMuniOrgn,PrmUFDstn,;
    					   PrmMuniDstn,PrmTp_mercad,PrmOperacao)
RETURN(LScfps)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHWD           DICST_IPI VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   23  
*        Variable:            DICST_IPI                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      58                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhwd     &&  DICST_IPI VALID
#REGION 2
RETURN

FUNCTION DICST_IPI
PARAMETERS PrmVlrIPI,PrmOperacao
	PRIVATE LScstIPI



	=W_DEFPROC("TRIBUTAR.SPR")
    LScstIPI = TRCST_IPI(PrmVlrIPI,PrmOperacao)

RETURN(LScstIPI)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHWE           DICST_ISS VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   24  
*        Variable:            DICST_ISS                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      59                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhwe     &&  DICST_ISS VALID
#REGION 2
RETURN

FUNCTION DICST_ISS
PARAMETERS PrmVlrISS,PrmOperacao
	PRIVATE LScstISS


	=W_DEFPROC("TRIBUTAR.SPR")
    LScstISS = TRCST_ISS(PrmVlrISS,PrmOperacao)
RETURN(LScstISS)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHWF           DIGenero VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   25  
*        Variable:            DIGenero                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      60                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhwf     &&  DIGenero VALID
#REGION 2
RETURN

FUNCTION DIGenero
PARAMETERS PrmTp_mercad,PrmClassifica,PrmOperacao
	PRIVATE LSgenero

	=W_DEFPROC("TRIBUTAR.SPR")
    LSgenero = TRGenero(PrmTp_mercad,PrmClassifica,PrmOperacao)

RETURN(LSgenero)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHWG           DICST_Entrada VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   26  
*        Variable:            DICST_Entrada                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      61                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*



FUNCTION _31z15dhwg     &&  DICST_Entrada VALID
#REGION 2
RETURN


FUNCTION DICST_Entrada
PARAMETERS PrmCstInfo,PrmOrigem,PrmTp_Mercad,Prmbase_calc,PrmVlrvenda,;
		Prmicms_subs, PrmCodigo


	PRIVATE LScst

	=W_DEFPROC("TRIBUTAR.SPR")
	LScst = TRCST_Entrada(PrmCstInfo, PrmOrigem, ;
						  PrmTp_Mercad, Prmbase_calc, PrmVlrvenda,;
					  	  Prmicms_subs, PrmCodigo)
RETURN(LScst)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHWH           DICST_ICMS VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   27  
*        Variable:            DICST_ICMS                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      62                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhwh     &&  DICST_ICMS VALID
#REGION 2
RETURN

FUNCTION DICST_ICMS
PARAMETERS Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto

	PRIVATE LScstICMS

	=W_DEFPROC("TRIBUTAR.SPR")
    LScstICMS = TRCST_ICMS(Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto)

RETURN(LScstICMS)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHWI           DICST_PIS VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   28  
*        Variable:            DICST_PIS                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      63                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhwi     &&  DICST_PIS VALID
#REGION 2
RETURN

FUNCTION DICST_PIS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	=W_DEFPROC("TRIBUTAR.SPR")
    LScst = TRCST_PIS(PrmVlr,PrmOperacao)
RETURN(LScst)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHXP           DICST_COFINS VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   29  
*        Variable:            DICST_COFINS                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      64                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhxp     &&  DICST_COFINS VALID
#REGION 2
RETURN

FUNCTION DICST_COFINS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	=W_DEFPROC("TRIBUTAR.SPR")
    LScst = TRCST_COFINS(PrmVlr,PrmOperacao)
RETURN(LScst)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHXV           DICST_IR VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   30  
*        Variable:            DICST_IR                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      65                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhxv     &&  DICST_IR VALID
#REGION 2
RETURN

FUNCTION DICST_IR
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	=W_DEFPROC("TRIBUTAR.SPR")
    LScst = TRCST_IR(PrmVlr,PrmOperacao)
RETURN(LScst)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHY1           DIGerXMLPeriodoDocFiscal VALID     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   32  
*        Variable:            DIGerXMLPeriodoDocFiscal           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      66                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhy1     &&  DIGerXMLPeriodoDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIGerXMLPeriodoDocFiscal
PARAMETER PrmEmpresa,PrmDtIni,PrmDtFim




	PRIVATE LSalias
	
	PRIVATE PrmAlsDI

	PRIVATE LNItDocFiscaCtrRegistro	



	=DIVerifyInst()
	

	LSalias = ALIAS()
	PrmAlsDI = DIGetAlias()




	*-------------------------------------------------------*




   	PRIVATE LSfileXML,LNroIDfileXML, LSnomeArqXml

	LSnomeArqXml = STR(PrmEmpresa,2)+;
				   "IT"+;
				   STR(MONTH(PrmDtFim),2)+;
				   STR(DAY(PrmDtFim),2)

	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")

   	LSfileXML	= "\SCGC\EFD\"+LSnomeArqXml+".XML"






  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria눯o arquivo tempor쟲io '+LSfileXML+'- <ENTER> ' window
      return
   	endif

	*---------------------------------------------------*

	SELE &PrmAlsDI
	SET ORDER TO TAG DATA_DOC
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+DTOS(PrmDtIni)
	SET NEAR OFF

	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNItDocFiscaCtrRegistro = RECNO()

	COUNT  WHILE !EOF() ;
	        AND PrmEmpresa =  &PrmAlsDI .empresa;
	        AND PrmDtIni   <= &PrmAlsDI .DT_ENTSAI ;
	        AND PrmDtFim   >= &PrmAlsDI .DT_ENTSAI ;
         TO LNimpressao
	GO LNItDocFiscaCtrRegistro
	LNimpressos = 0
	*----------------------------------------------------*

	=DIInicioXML(LSfileXML,LNroIDfileXML)

	SELE &PrmAlsDI

	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa =  &PrmAlsDI .empresa;
	        AND PrmDtIni   <= &PrmAlsDI .DT_ENTSAI ;
	        AND PrmDtFim   >= &PrmAlsDI .DT_ENTSAI

		=UPtermo()


		=DIGravaXMLItensDocFiscal(;
				&PrmAlsDI .Empresa,;
				&PrmAlsDI .Mod_doc,;
				&PrmAlsDI .Cod_IDForn,;
				&PrmAlsDI .Nro_Doc,;
				&PrmAlsDI .Serie_Doc,;
				&PrmAlsDI .Nro_Item,;
				LSfileXML,;
				LNroIDfileXML)

		SELE &PrmAlsDI
		SET ORDER TO TAG DATA_DOC


		SET ORDER TO TAG DATA_DOC
		*-----------------------*
		GO LNItDocFiscaCtrRegistro
	
		SKIP
	
		LNItDocFiscaCtrRegistro = RECNO()
	ENDDO
	=DIFinalXML(LSfileXML,LNroIDfileXML)

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHY2           DIModeloRefXML VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   33  
*        Variable:            DIModeloRefXML                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      67                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhy2     &&  DIModeloRefXML VALID
#REGION 2
RETURN

FUNCTION DIModeloRefXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\DOCFISIT.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\xmlDIFIS EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE xmlDIFIS


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF
		

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHY3           DIInicioXML VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   34  
*        Variable:            DIInicioXML                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      68                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhy3     &&  DIInicioXML VALID
#REGION 2
RETURN

FUNCTION DIInicioXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML




   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDIFIS EXCL
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND xmlDIFIS.XML_ORDEM < 9999999999901
	
		LSLinhaXML = xmlDIFIS.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE xmlDIFIS
	USE
		

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHZE           DIFinalXML VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   35  
*        Variable:            DIFinalXML                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      69                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhze     &&  DIFinalXML VALID
#REGION 2
RETURN

FUNCTION DIFinalXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDIFIS EXCL
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF xmlDIFIS.XML_ORDEM > 9999999999900
			LSLinhaXML = xmlDIFIS.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE xmlDIFIS
	USE
		

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DHZF           DIConvrtNFDocFiscal VALID          
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   37  
*        Variable:            DIConvrtNFDocFiscal                
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      70                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dhzf     &&  DIConvrtNFDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIConvrtNFDocFiscal
PARAMETERS PrmEmpresa,PrmNota,PrmOrientacao

	PRIVATE PrmAlsNF,PrmAlsIT
	PRIVATE LFLAG_COPIA
	PRIVATE LFLAG_DEVOLUCAO
	PRIVATE LNNroDacComItens
	PRIVATE LNNroWhileNF


	*--------------------------------------------------*
	PRIVATE LNCod_Mod_Rf,LaliqOrg
	
	PRIVATE LOperacao

	PRIVATE LUFDstn

	PRIVATE LMunDstn

	PRIVATE LUFOrig
	PRIVATE LMunOrig
	PRIVATE LTab_Cst

	PRIVATE LNAliq_icms

	*--------------------------------------------------*

	PRIVATE  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc


	*--------------------------------------------------*
	

	=W_DEFPROC("NOTA.SPR")
	PrmAlsNF = NFGetAlias()


	=W_DEFPROC("ITEMMOV.SPR")
	PrmAlsIT = IMGetAlias()


	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)
		WAIT WINDOW "NFs nao localizada  <ENTER> " NOWAIT
		RETURN(.F.)
	ENDIF




	=W_DEFPROC("EMPRESA.SPR")
	LTab_Cst  	= EMGet_TabCst(  &PrmAlsNF .EMPRESA )




	*---------------------------------------------------*

	LFLAG_COPIA = "NAO"
	LNNroDacComItens = 0

	IF &PrmAlsNF .referencia <> &PrmAlsNF .orcamento ;
	  AND ( &PrmAlsNF .referencia > 1000000 AND ;
	        &PrmAlsNF .referencia < 2000000)

								* ==> TRATA-SE DE UMA NOTA COPIA DE CUPOM

		LFLAG_COPIA    = "SIM"
		LNNroDacComItens =  &PrmAlsNF .referencia  && LER ITENS DO CUPOM
		                                           && ORIGEM DA COPIA

	ELSE
		LNNroDacComItens =  PrmNota				   && LER ITENS DA PROPRIA
		                                           && NOTA
	
	ENDIF
	


	*---------------------------------------------------*
	LFLAG_DEVOLUCAO = "NAO"
	IF &PrmAlsNF .TIPO = "ENT"
		LFLAG_DEVOLUCAO = "SIM"
	ENDIF

	*---------------------------------------------------*


	SET NEAR ON

	SELE &PrmAlsIT

	SET ORDER TO TAG NOTA

	IF LFLAG_DEVOLUCAO = "SIM"
		SEEK STR(PrmEmpresa,3)+"E"+STR(LNNroDacComItens,7)
	ELSE
		SEEK STR(PrmEmpresa,3)+"S"+STR(LNNroDacComItens,7)
	ENDIF

	*---------------------------------------------------*

	IF  PrmEmpresa           <> &PrmAlsIT .empresa ;
		OR  LNNroDacComItens <> &PrmAlsIT .nota

		WAIT WINDOW ;
		   "Nao foi possivel exportar itens-REENVIE <ENTER> " NOWAIT
		RETURN(.F.)
	ENDIF


	IF LEFT(  &PrmAlsIT .operacao,1 ) = "S"
		LOperacao = "SAIDA"
	ELSE
		LOperacao = "ENTRADA"
	ENDIF	


	IF LEFT(  &PrmAlsIT .operacao,1 ) = "S"

		=W_DEFPROC("EMPRESA.SPR")
		LUFOrig   = EMGet_UF(  &PrmAlsNF .EMPRESA )

		=W_DEFPROC("EMPRESA.SPR")
		LMunOrig  = EMGet_Municipio(  &PrmAlsNF .EMPRESA )

		LUFDstn   = &PrmAlsNF .UF
		LMunDstn  = &PrmAlsNF .CIDADE
	ELSE
		=W_DEFPROC("EMPRESA.SPR")
		LUFDstn   = EMGet_UF(  &PrmAlsNF .EMPRESA )

		=W_DEFPROC("EMPRESA.SPR")
		LMunDstn  = EMGet_Municipio(  &PrmAlsNF .EMPRESA )

		LUFOrig  = &PrmAlsNF .UF
		LMunOrig = &PrmAlsNF .CIDADE
	ENDIF	

	=W_DEFPROC("TRIBUTAR.SPR")
	LaliqOrg = TRAlqIcmOuUF(LUFOrig)  && ALIQ. EXTERNA DA UF ORIGEM

	=W_DEFPROC("TRIBUTAR.SPR")
	LaliqDst = TRAlqIcmInUF(LUFDstn)  && ALIQ. Interna DA UF DESTINO

	SET NEAR OFF


	*---------------------------------------------------*




	PrmSerie   		= &PrmAlsNF .Serie
	PrmTipo    		= &PrmAlsNF .tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""
	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


    m.EMPRESA    =   PrmEmpresa
    m.TIPO    	 =   PrmTipo
    m.MOD_DOC    =   RtnMod_Doc
    m.COD_IDFORN =   RtnCOD_IDFORN
    m.NRO_DOC    =   RtnNro_Doc
    m.SERIE_DOC  =   RtnSerie_Doc



	*---------------------------------------------------*

	=DIDelItensDocFiscal(;
			PrmEmpresa,;
		 	RtnMod_Doc,;
		  	RtnCOD_IDFORN,;
  	  	    RtnNro_Doc ,;
		  	RtnSerie_Doc)

	*---------------------------------------------------*


	DO WHILE !EOF() ;
		   AND PrmEmpresa        = &PrmAlsIT .empresa ;
		   AND LNNroDacComItens  = &PrmAlsIT .nota
	

		IF LFLAG_DEVOLUCAO = "NAO"	 ;
		   AND LEFT( &PrmAlsIT .OPERACAO ,1) <> "S"
		   EXIT
		ENDIF


		IF     LFLAG_DEVOLUCAO = "SIM"	 ;
		   AND LEFT( &PrmAlsIT .OPERACAO ,1) <> "E"
		   EXIT

		ENDIF


		*-------------------------------------------------*
		* PrmOrientacao = "PRODUTO/SERVICO" => nao filtra
		*-------------------------------------------------*

		DO CASE
			CASE PrmOrientacao = "PRODUTO"
				IF &PrmAlsIT .tp_mercad = 7  && SERVICO
					SKIP
					LOOP
				ENDIF
		        STORE .T. TO LFGerNF   && SINALIZA QUE FOI GERADA
		                               && NOTA SERIE UNICA
			CASE PrmOrientacao = "SERVICO"
				IF &PrmAlsIT .tp_mercad <> 7 && NAO SERVICO
					SKIP
					LOOP
				ENDIF
		ENDCASE






	    m.DT_DOC    	= &PrmAlsNF .data
    	m.DT_ENTSAI    	= &PrmAlsNF .data




		*----------------------------------------------------*
		*  DADOS GERAIS DO ITEM NO REGISTRO
		*----------------------------------------------------*


	    m.NRO_ITEM   = &PrmAlsIT .Ordem
    	m.PRODCODIGO = &PrmAlsIT .Codigo

		=W_DEFPROC("GRUPO.SPR")
		M.PRODDESCR = GRGetFieldValue( &PrmAlsIT .CODIGO,"DESCRICAO")

	    M.PRODDESCR = DFLimpaString(M.PRODDESCR)

	    M.PRODCOMPLE= DFLimpaString( &PrmAlsIT .DescrCompl )

	    M.INFO_COMPL= DFLimpaString( &PrmAlsIT .Info_compl )

		=W_DEFPROC("GRUPO.SPR")
		M.UNIDADE = GRGetFieldValue( &PrmAlsIT .CODIGO,"UNIDADE")
		m.UNIDTRIBUT = M.UNIDADE

		IF EMPTY(M.UNIDADE)
			M.UNIDADE = "UN"
			m.UNIDTRIBUT = "UN"
		ENDIF

    	m.PRECO_TAB  = &PrmAlsIT .Preco
    	m.PRECOMAXTB    =    0
	    m.PRECOMINTB    =    0

		IF &PrmAlsIT .Qtde > 0
		    m.PRECOVENDA    =    &PrmAlsIT .VLRVENDA /  &PrmAlsIT .Qtde
		    m.VLR_UNIDAD    =    &PrmAlsIT .VLRVENDA /  &PrmAlsIT .Qtde
			m.VLRUNTRIBU    =    &PrmAlsIT .VLRVENDA /  &PrmAlsIT .Qtde
		ELSE
			m.PRECOVENDA    =    0
		    m.VLR_UNIDAD    =    0
			m.VLRUNTRIBU    =    0

		ENDIF

	    m.QTDE    		=    &PrmAlsIT .Qtde

		M.QTDTRIBUT	    =    &PrmAlsIT .Qtde
	    m.VLR_DESCTO    =    0
	    m.PRC_DESCTO    =    0
    	m.VLRDESPFIN    =    0
	    m.VLRDESPOUT    =    0
    	m.VLR_FRETE     =    0
	    m.VLR_SEGURO    =    0
    	M.VLR_FINAL    =    &PrmAlsIT .VlrVenda +;
					    	&PrmAlsIT .vlripi+;
					    	&PrmAlsIT .ICMS_SUBS





		IF &PrmAlsIT .MovEstq = "N"  OR LFLAG_COPIA = "SIM"
		    m.IND_MOVEST    =     "NAO"
		ELSE
		    m.IND_MOVEST    =     "SIM"
		ENDIF


    	m.LT_QTITENS    =    0
	    m.LT_NRO   		=    ""
    	m.LT_DT_FABR    =    {}
	    m.LT_VALIDAD    =    {}
	    m.CLSCOMNC    	=    "00"
    	m.CLSGAS    	=    "00"
	    m.CLSAGUA    	=    "00"
    	m.CLSENRG    	=    "00"


		*----------------------------------------------------*
		*  DADOS TRIBUTARIOS DO REGISTRO
		*----------------------------------------------------*
		
	    m.VLRATRIBUT    =     &PrmAlsIT .VlrVenda
    	m.CUSTONAOPE    =     0
	    m.CUSTOMEDAN    =     0

    	IF  &PrmAlsIT .MovEstq = "S"
		    IF  LEFT( &PrmAlsIT .Operacao,1) = "S"
			    m.SALDO_ANT  =  ;
		               &PrmAlsIT .Sld_estq +  &PrmAlsIT .Qtde
			ELSE
			    m.SALDO_ANT  =  ;
	               &PrmAlsIT .Sld_estq -  &PrmAlsIT .Qtde

			ENDIF
		ELSE
		    m.SALDO_ANT   =  &PrmAlsIT .Sld_estq
    	ENDIF



	    IF  &PrmAlsIT .Sld_estq > 0
		    m.CUSTOMEDAT  = ;
	               &PrmAlsIT .Vlr_estq  /  &PrmAlsIT .Sld_estq

		ELSE
		    m.CUSTOMEDAT  =  &PrmAlsIT .Vlr_estq
	    ENDIF

	    m.SALDO_ATU     =  &PrmAlsIT .Sld_estq
	

	    m.CUSTOCONTB =  0



		LTp_mercad = &PrmAlsIT .tp_mercad
    	IF &PrmAlsIT .tp_mercad = 7   && SERVICO

			LScfop =DICFOPS(LUFOrig, ;
					          LMunOrig,;
					          LUFDstn,;
					          LMunDstn,;
					          LTp_mercad,;
					          LOperacao)
		    m.CFOP = LScfop
		ELSE
		    m.CFOP = &PrmAlsIT .CFO
		ENDIF

	    m.CFOP = ALLTRIM(CHRTRAN(m.CFOP,".",""))

		*-----------------------------------------*

		IF	LFLAG_COPIA    = "SIM"
			* m.CFOP	= LEFT(m.CFOP,1)+"929"  && 5929 ou 6929 COPIA CUPOM
			m.CFOP	= "5929"  && 5929    ==> 6929 nao e aceito efd

		ENDIF



		IF	RtnMod_Doc    =   "2D"   && cupom
			m.CFOP	= "5"+SUBS(m.CFOP,2)

		ENDIF

		IF  m.CFOP	= "5404"
			 m.CFOP	= "5403"
		ENDIF

		IF 	m.CFOP	= "5108"
			 m.CFOP	= "5102"
		ENDIF		

		*-----------------------------------------*


		m.origemmrcd = chrtran(str( &PrmAlsIT .origem ,1)," ","0")


		LTipo       = &PrmAlsIT .Tipo
		LProduto 	= &PrmAlsIT .codigo
		LTp_mercad  = &PrmAlsIT .tp_mercad


		LSCst 		= DICST_ICMS(LTab_cst,LTipo,Ltp_mercad,LProduto)
   		m.CST_ICMS  = LSCst


		LSCst 		= DICST_IPI(  &PrmAlsIT .VlrIPI, LOperacao)
    	m.CST_IPI   = LSCst

	    IF &PrmAlsIT .tp_mercad = 7   && SERVICO
			LSCst 	= DICST_ISS(  &PrmAlsIT .VlrVenda, LOperacao)
		ELSE
			LSCst 	= DICST_ISS(  0, LOperacao)
		ENDIF
    	m.CST_ISS	= LSCst

		LSCst		= DICST_PIS(  0, LOperacao)
    	m.CST_PIS   =    LSCst


		LSCst = DICST_IR(  0, LOperacao)
    	m.CST_IR    = LSCst



		=W_DEFPROC("TRIBUTAR.SPR")
		LRgmTrb = TRDef_RgTrbMercad(LUFOrig, ;
						 &PrmAlsIT .Codigo,;
						 'RETORNAR STRING' )
	    m.RGTRIBORIG    =   LRgmTrb



		=W_DEFPROC("TRIBUTAR.SPR")
		LRgmTrb = TRDef_RgTrbMercad(LUFDstn,;
		                          &PrmAlsIT .Codigo,;
						 'RETORNAR STRING' )
	    m.RGTRIBDEST    =   LRgmTrb



	    m.ALQICMORIG    =   LaliqOrg
	    m.ALQICMDEST    =   LaliqDst

	    m.BASE_ISENT    =   &PrmAlsIT .Base_Isent
    	m.BASE_OUTR    	=   &PrmAlsIT .Base_Outr



	    m.BCBRTRTD_S    =   &PrmAlsIT .Base_sbbrt
    	m.IVA    		=   &PrmAlsIT .Iva
	    m.BC_RTD_S    	=   &PrmAlsIT .Base_subs
	    m.ALQICMRTDS    =   m.ALQICMDEST - m.ALQICMORIG

	    IF m.ALQICMRTDS < 0
		    m.ALQICMRTDS = 0
		ENDIF




	    m.BCBRUTAICM =   &PrmAlsIT .BsBr_Icms
    	m.IND_REDUCA =   &PrmAlsIT .aliq_rdu
	    m.BC_ICMS    =   &PrmAlsIT .base_calc
		Laliq  = ABS(LaliqOrg - LaliqDst)

    	m.DIF_ALIQ     =   Laliq
		IF m.BC_ICMS =  0
	    	m.VLR_ICMS     =   0
		ELSE
	    	m.VLR_ICMS     =   &PrmAlsIT .Vlr_Icms
		ENDIF


    	m.ICM_RTD_S    	=   &PrmAlsIT .ICMS_Subs


		DO CASE

			CASE LFLAG_COPIA    = "SIM"
				m.CST_ICMS = m.origemmrcd+"90"

	    	CASE &PrmAlsIT .tp_mercad = 7   && SERVICO
				m.CST_ICMS = m.origemmrcd+"90"
	

			*-------------------------------------------*
			* FOI ALTERADO PARA NAO AFETAR O CST NFe
			*-------------------------------------------*
			*CASE m.BC_ICMS =  0 and m.ICM_RTD_S = 0
			*	m.CST_ICMS = m.origemmrcd+"40"

		ENDCASE




	    m.ALIQ_ICMS    =   &PrmAlsIT .Aliq_Icms

		IF SUBS(m.CST_ICMS,2,2) $ "00/10/20/70"
		    m.ALIQ_ICMS    =   &PrmAlsIT .Aliq_Icms
		endif	


		IF SUBS(m.CST_ICMS,2,2) $ "30/40/41/50/60"
		    m.ALIQ_ICMS    =   0
		endif	

		IF SUBS(m.CST_ICMS,2,2) $ "90"
	    	IF &PrmAlsIT .tp_mercad = 7   && SERVICO
			    m.ALIQ_ICMS    =   0
			ENDIF
		endif	




	    m.BCBRTRTD_E    =   0
    	m.BC_RTD_E    	=   0
	    m.ICM_RTD_E    	=   0

	    m.INDAPURIPI    =   "1"

	    m.BC_IPI    	=   &PrmAlsIT .base_ipi
    	m.ALIQ_IPI    	=   &PrmAlsIT .aliq_ipi
	    m.VLR_IPI    	=   &PrmAlsIT .vlripi


	    m.BC_ISS    	=   &PrmAlsIT .base_iss
	    m.ALIQ_ISS    	=   &PrmAlsIT .aliq_iss
    	m.VLR_ISS    	=   &PrmAlsIT .vlr_iss



	    IF &PrmAlsIT .vlr_issrtd > 0
	    	m.BC_ISS_RTD    =   &PrmAlsIT .base_iss
		    m.ALIQ_ISSRT    =   &PrmAlsIT .aliq_iss
		    m.VLR_ISSRTD    =   &PrmAlsIT .vlr_issrtd


		ELSE
	    	m.BC_ISS_RTD    =   0
		    m.ALIQ_ISSRT    =   0
		    m.VLR_ISSRTD    =   0
		ENDIF



	    m.BC_PIS    	=   &PrmAlsIT .base_iss
    	m.ALIQ_PIS    	=   1.65
	    m.QTDBASEPIS    =   &PrmAlsIT .qtde
    	m.VLR_PIS    	=   ROUND( &PrmAlsIT .base_iss *  1.65 /100,2)


	    m.PIS_RTD    	=   0

    	m.BC_COFINS    	=   &PrmAlsIT .base_iss
	    m.ALIQCOFINS    =   7.6
    	m.QTDBASECOF    =   &PrmAlsIT .qtde
	    m.VLR_COFINS    =   ROUND( &PrmAlsIT .base_iss *  7.6 /100 ,2)


		LSCst = DICST_COFINS(  m.VLR_COFINS, LOperacao)
    	m.CST_COFINS=    LSCst



    	m.COFINS_RTD    =   0




		*----------------------------------------------------*
		*  na cgb estava destacando PIS e COFINS NA NOTA DE
		* SERVICO E FOI PEDIDO PELO CELIO PARA ZERAR ESTES CAMPOS
		*------------------------------------------------------*


	    m.BC_PIS    	=   0
    	m.ALIQ_PIS    	=   0
	    m.QTDBASEPIS    =   0
    	m.VLR_PIS    	=   0


	    m.PIS_RTD    	=   0

    	m.BC_COFINS    	=   0
	    m.ALIQCOFINS    =   0
    	m.QTDBASECOF    =   0
	    m.VLR_COFINS    =   0


		LSCst = DICST_COFINS(  m.VLR_COFINS, LOperacao)
    	m.CST_COFINS=    LSCst

    	m.COFINS_RTD    =   0

		
		*-----------------------------------------------------*





	    m.BC_IR    		=   0
	    m.ALIQ_IR    	=   0
	    m.VLR_IR    	=   0
    	m.IR_RTD    	=   0
	    m.BC_CSLL    	=   0
    	m.ALIQ_CSLL    	=   0
	    m.VLR_CSLL    	=   0
    	m.ADNTA_CSLL    =   0
	    m.LANC_AUTO    	=   "SIM"



	    m.VLRCOFIMPO  	=   0
	    m.VLR_DESPES  	=   0
	    m.VLR_ICMSSO  	=   0
	    m.VLRpisimpo  	=   0

	    m.VLRSRVC_NT   	=   &PrmAlsIT .base_iss

    	M.VLRSERVICO = 0
   	    M.VLRPRODUTO = 0
   	
    	IF &PrmAlsIT .tp_mercad = 7   && SERVICO
    	   M.VLRSERVICO = &PrmAlsIT .VLRVENDA
    	ELSE
    	   M.VLRPRODUTO = &PrmAlsIT .VLRVENDA
    	ENDIF

		M.TTPRODSRVC = M.VLRSERVICO + M.VLRPRODUTO



		M.MODBCICMRT = "0"
		M.MOD_BCICMS = "3"




		=W_DEFPROC("GRUPO.SPR")
		M.GTIMCODIGO = GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_GTIM")
		

		=W_DEFPROC("GRUPO.SPR")
		M.NCMCODIGO = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_NCM"))
		M.NCMCODIGO = CHRTRAN(M.NCMCODIGO,".","")

		=W_DEFPROC("GRUPO.SPR")
		M.EXTIPI = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"EX_TIPI"))


		=W_DEFPROC("GRUPO.SPR")
		M.GENEROPROD = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_GENERO"))



    	IF &PrmAlsIT .tp_mercad = 7   && SERVICO
    	   M.ITEMSERVIC = "S"
    	ELSE
    	   M.ITEMSERVIC = "N"
    	ENDIF



		=W_DEFPROC("GRUPO.SPR")
		M.CDGLSTSRVC = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_LSTSRV"))


		LEmpresa    = m.Empresa
		LMod_Doc    = m.Mod_Doc
		LCod_IdForn = m.Cod_IdForn
		LNro_Doc    = m.Nro_Doc
		LSerie_Doc  = m.Serie_Doc
		LNro_Item   = m.Nro_Item


		SELE &PBDocFisItAlias
		SET ORDER TO TAG ITEM
		SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	      STR(LNro_Doc,7)+LSerie_Doc+STR(LNro_Item,5)



	
		IF !found()
			APPEND BLANK
		ENDIF
		=RLOCK()
		GATHER MEMVAR
		UNLOCK


		SELE &PrmAlsIT
		SKIP
	ENDDO
	*---------------------------------------------------*
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DI23           DIGerXMLDocFiscal VALID            
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   41  
*        Variable:            DIGerXMLDocFiscal                  
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      71                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15di23     &&  DIGerXMLDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIGerXMLDocFiscal
PARAMETER PrmEmpresa,;
		  PrmMod_Doc,;
		  PrmCOD_IDFORN,;
		  PrmNro_Doc,;
		  PrmSerie_Doc





	PRIVATE LSalias
	
	PRIVATE PrmAlsDI
	=DIVerifyInst()
	

	LSalias = ALIAS()
	PrmAlsDI = DIGetAlias()


	*-------------------------------------------------------*

	=DIModeloRefXML()

	*-------------------------------------------------------*

   	PRIVATE LSfileXML,LNroIDfileXML
   	
   	LSfileXML	= DINmFileXMLDocFiscal(PrmEmpresa,PrmMod_doc,PrmNro_Doc)
   	LSfileXML	= "\SCGC\EFD\"+LSfileXML



  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria눯o arquivo tempor쟲io '+LSfileXML+'- <ENTER> ' window
      return(.F.)
   	endif

	*---------------------------------------------------*

	GO BOTT
	GO TOP

	SELE &PrmAlsDI
	SET ORDER TO TAG ITEM
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmMOD_DOC+;
	     PrmCOD_IDFORN+STR(PrmNro_Doc,7)+PrmSERIE_DOC
	SET NEAR OFF



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() ;
	        AND PrmEmpresa    = &PrmAlsDI .empresa;
	        AND PrmMod_Doc    = &PrmAlsDI .MOD_DOC ;
	        AND PrmCOD_IDFORN = &PrmAlsDI .COD_IDFORN ;
	        AND PrmNro_Doc       = &PrmAlsDI .NRO_DOC ;
	        AND PrmSERIE_DOC  = &PrmAlsDI .SERIE_DOC ;
         TO LNimpressao

	IF LNimpressao = 0
      DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
      =fclose(LNroIDfileXML)
      wait 'Nao foram encontrados itens em DOCFISIT '+;
           'para gerar XML- <ENTER> ' window
      return(.F.)

   	endif




	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

	=DIInicioXML(LSfileXML,LNroIDfileXML)

	SET POINT TO ','

	SELE &PrmAlsDI

	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa    = &PrmAlsDI .empresa;
	        AND PrmMod_Doc    = &PrmAlsDI .MOD_DOC ;
	        AND PrmCOD_IDFORN = &PrmAlsDI .COD_IDFORN ;
	        AND PrmNro_Doc    = &PrmAlsDI .NRO_DOC ;
	        AND PrmSERIE_DOC  = &PrmAlsDI .SERIE_DOC

		=UPtermo()



		=DIGravaXMLItensDocFiscal(;
				&PrmAlsDI .Empresa,;
				&PrmAlsDI .Mod_doc,;
				&PrmAlsDI .Cod_IDForn,;
				&PrmAlsDI .Nro_Doc,;
				&PrmAlsDI .Serie_Doc,;
				&PrmAlsDI .Nro_Item,;
				LSfileXML,;
				LNroIDfileXML)

		SELE &PrmAlsDI
		SET ORDER TO TAG ITEM
		SKIP
	ENDDO
	=DIFinalXML(LSfileXML,LNroIDfileXML)

	SET POINT TO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DI2V           DIFind VALID                       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   42  
*        Variable:            DIFind                             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      72                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15di2v     &&  DIFind VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DISQLS

	USE X:\SCGC\CENTRAL\DOCFISIT
	SELECT CFOP, ;
	       SUM(VLR_FINAL) AS TOTAL ;
	FROM DOCFISIT ;
	GROUP BY CFOP


RETURN(LFreturn)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DI31           DIApuraICMS VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   44  
*        Variable:            DIApuraICMS                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      73                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _31z15di31     &&  DIApuraICMS VALID
#REGION 2
  SET STEP ON	
  SET DATE GERMAN
  SET CENTU ON	
  DO DIApuraIcms WITH 4, {01.01.2009},{31.01.2009}

return

PROCEDURE DIApuraICMS
PARAMETERS ;
		PrmEmpresa,;
		PrmDtInicio,;
		PrmDtFinal

	PRIVATE LSAlias

	=DIVerifyInst()


	LSAlias = 	DIGetAlias()
	
	*--------------------------------------*
	* SELECAO GERAL DO ITENS CONFORME CRITERIO
	* DE EMPRESA E DATAS
	* ---> NAO CONTABILIZA COPIA DE CUPOM
	*--------------------------------------*

	SELECT ;
		   CFOP, ;
	       VLR_FINAL, ;
		   bc_icms,;
		   vlr_icms,;
		   base_isent,;
		   base_outr,;
		   bc_iss,;
		   vlr_ipi,;	
		   icm_rtd_s;
	FROM &LSAlias ;
	WHERE ;
		     &LSAlias .empresa = PrmEmpresa ;
		 AND &LSAlias .dt_EntSai  >= PrmDtInicio ;
		 AND &LSAlias .dt_EntSai  <= PrmDtFinal ;
		 AND !(ALLTRIM( &LSAlias .CFOP )	$ "5929/6929") ;
    into cursor SEL_itens

	*--------------------------------------*

	SELECT ;
		   "RG001"         AS TP_REG,;	
		   CFOP            AS CFOP_AP, ;
	       SUM(VLR_FINAL)  AS VLR_CONTB, ;
		   SUM(bc_icms)    AS BASE_ICMS,;
		   SUM(vlr_icms)   AS VLR_ICMS,;
		   SUM(base_isent) AS VLR_ISENT,;
		   SUM(base_outr+bc_iss+VLR_IPI)  AS OUTRAS,;
		   SUM(icm_rtd_s)  AS ICMS_RTD;
	FROM SEL_itens ;
	GROUP BY CFOP_AP ;
	UNION ;
	SELECT ;
		   "RG002"  AS TP_REG,;	
		   (LEFT(CFOP,1)+"--->") AS CFOP_AP, ;
	       SUM(VLR_FINAL) AS VLR_CONTB,  ;
		   SUM(bc_icms)    AS BASE_ICMS,;
		   SUM(vlr_icms)   AS VLR_ICMS,;
		   SUM(base_isent) AS VLR_ISENT,;
		   SUM(base_outr+bc_iss+VLR_IPI)  AS OUTRAS,;
		   SUM(icm_rtd_s)  AS ICMS_RTD;
	FROM SEL_itens ;
	GROUP BY CFOP_AP;
	UNION ;
	SELECT ;
		   "RG003"         AS TP_REG,;	
		  "TEnt="          AS CFOP_AP, ;
	       SUM(VLR_FINAL)  AS VLR_CONTB,  ;
		   SUM(bc_icms)    AS BASE_ICMS,;
		   SUM(vlr_icms)   AS VLR_ICMS,;
		   SUM(base_isent) AS VLR_ISENT,;
		   SUM(base_outr+bc_iss+VLR_IPI)  AS OUTRAS,;
		   SUM(icm_rtd_s)  AS ICMS_RTD;
	FROM SEL_itens ;
	WHERE CFOP < "5000" ;
	GROUP BY CFOP_AP;
	UNION ;
	SELECT ;
		   "RG003"         AS TP_REG,;	
		  "TSai="          AS CFOP_AP, ;
	       SUM(VLR_FINAL)  AS VLR_CONTB,  ;
		   SUM(bc_icms)    AS BASE_ICMS,;
		   SUM(vlr_icms)   AS VLR_ICMS,;
		   SUM(base_isent) AS VLR_ISENT,;
		   SUM(base_outr+bc_iss+VLR_IPI)  AS OUTRAS,;
		   SUM(icm_rtd_s)  AS ICMS_RTD;
	FROM SEL_itens;
	WHERE CFOP >= "5000" ;
	GROUP BY CFOP_AP;
	order by TP_REG,CFOP_AP;
	into cursor APUracao

	SELECT ;
		  CFOP_AP AS CFOP, ;
	      VLR_CONTB,  ;
		  BASE_ICMS,;
		  VLR_ICMS,;
		  VLR_ISENT,;
		  OUTRAS,;
		  ICMS_RTD;
	FROM APUracao ;
	into cursor APUFinal
	


	=W_DEFPROC("rotinas.spr")
	DO loc_dlog WITH  .t.,.F.,.F.,.F.,.F.,.t.

	SELE APURACAO
	USE
	SELE SEL_itens
	use
	
	SELE APUFinal
	use

	

RETURN	

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DI6J           DIConvrtNEDocFiscal VALID          
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   45  
*        Variable:            DIConvrtNEDocFiscal                
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      74                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15di6j     &&  DIConvrtNEDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIConvrtNEDocFiscal
PARAMETERS PrmEmpresa,PrmNota,PrmFornCod,PrmVT_Acm

	PRIVATE PrmAlsNE,PrmAlsIT

	*--------------------------------------------------*
	PRIVATE LNCod_Mod_Rf,LaliqOrg
	
	PRIVATE LOperacao

	PRIVATE LUFDstn

	PRIVATE LMunDstn


	PRIVATE LNTotalNE
	
	
	PRIVATE LAcmTotItem,;
	        LAcmVicmsItem

	PRIVATE LUFOrig
	PRIVATE LMunOrig
	PRIVATE LTab_Cst

	*--------------------------------------------------*

	PRIVATE ;
    	 PrmSerie,;
		 PrmTipo,;
    	 RtnNro_Doc,;
		 RtnMod_Doc,;
		 RtnCOD_IDFORN,;
		 RtnSerie_Doc

	*--------------------------------------------------*


	=W_DEFPROC("NOTAENT.SPR")
	PrmAlsNE = NEGetAlias()


	=W_DEFPROC("NOTAITE.SPR")
	PrmAlsIT = IEGetAlias()



	=W_DEFPROC("NOTAENT.SPR")
	IF !NELerRegistro(PrmEmpresa,PrmNota,PrmFornCod)
		WAIT WINDOW "NFs nao localizada  <ENTER> " NOWAIT
		RETURN(.F.)
	ENDIF



	
	=W_DEFPROC("notaent.spr")
	LNTotalNE = ;
		 NEGetFieldValue(PrmEmpresa,PrmNota,PrmFornCod,"TOTAL_NOTA")

	LAcmTotItem = 0



	=W_DEFPROC("TIPOOPER.SPR")
	LNCod_Mod_Rf  	= TPGetFieldValue("E",  &PrmAlsNE .tipo ,"Cod_Mod_Rf")



	LOperacao = "ENTRADA"

	=W_DEFPROC("EMPRESA.SPR")
	LTab_Cst  = EMGet_TabCst(  &PrmAlsNE .EMPRESA )

	=W_DEFPROC("EMPRESA.SPR")
	LUFDstn   = EMGet_UF(  &PrmAlsNE .EMPRESA )

	=W_DEFPROC("EMPRESA.SPR")
	LMunDstn  = EMGet_Municipio(  &PrmAlsNE .EMPRESA )

	LUFOrig  = &PrmAlsNE .UF
	LMunOrig = &PrmAlsNE .CIDADE


	=W_DEFPROC("TRIBUTAR.SPR")
	LaliqOrg = TRAlqIcmOuUF(LUFOrig)  && ALIQ. EXTERNA DA UF ORIGEM


	=W_DEFPROC("TRIBUTAR.SPR")
	LaliqDst = TRAlqIcmInUF(LUFDstn)  && ALIQ. Interna DA UF DESTINO

	*---------------------------------------------------*

	SELE &PrmAlsIT
	SET ORDER TO TAG ITEMNOTA
	SET NEAR ON
	SEEK STR( &PrmAlsNE .Empresa,3)+;
		LEFT( &PrmAlsNE .TIPO ,1)+;
		STR(  &PrmAlsNE .CODFORN ,5)+;
		STR(  &PrmAlsNE .NOTA ,6)
	SET NEAR OFF


	PrmVT_Acm[1] = 0
	PrmVT_Acm[2] = 0
	PrmVT_Acm[3] = 0

	*--------------------------------------------------*

	STORE 0 TO  ;
    	 PrmSerie,;
		 PrmTipo,;
    	 RtnNro_Doc,;
		 RtnMod_Doc,;
		 RtnCOD_IDFORN,;
		 RtnSerie_Doc



	PrmSerie = &PrmAlsNE .serie
	PrmTipo  = &PrmAlsNE .tipo

	=W_DEFPROC("NOTAENT.SPR")
	=NEDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmFornCod,;
						PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						RtnSerie_Doc)





    M.COD_IDFORN   	=  RtnCOD_IDFORN

    M.EMPRESA   	=  PrmEmpresa
    M.TIPO   		=  PrmTipo
    M.NRO_DOC   	=  RtnNro_Doc
    M.SERIE_DOC 	=  RtnSerie_Doc
    m.MOD_DOC   =   RtnMod_Doc


	*---------------------------------------------------*

	*---------------------------------------------------*

	=DIDelItensDocFiscal(;
			PrmEmpresa,;
		 	RtnMod_Doc,;
		  	RtnCOD_IDFORN,;
  	  	    RtnNro_Doc ,;
		  	RtnSerie_Doc)

	*---------------------------------------------------*



	DO WHILE !EOF() ;
	        AND PrmEmpresa     = &PrmAlsIT .empresa;
	        AND &PrmAlsNE .favorecido = &PrmAlsIT .Favorecido;
	        AND PrmNota    	   = &PrmAlsIT .nota

	    IF  &PrmAlsNE .TIPO <> &PrmAlsIT .tipo
			SKIP
			LOOP
		
		ENDIF


		IF  LEFT( &PrmAlsIT .SITUACAO,1) <> "C"
			SKIP
			LOOP
		
		ENDIF


		IF  &PrmAlsIT .qtde = 0
			SKIP
			LOOP
		
		ENDIF



		set decimals to 2
		

	
		=W_DEFPROC("NOTAENT.SPR")
		LNVlrICMS =  NEClcICMS( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , &PrmAlsIT .vlrvenda)


	
		=W_DEFPROC("NOTAENT.SPR")
		LNBCIcmsOper =  NEBCIcmsOper( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , &PrmAlsIT .vlrvenda)




		=W_DEFPROC("NOTAENT.SPR")
		LNVlrICMSSO =  NEIcmsOper( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , &PrmAlsIT .vlrvenda)



		
		=W_DEFPROC("NOTAENT.SPR")
		LNBsBrRetido =  NEBsBrRetido( ;
		        PrmEmpresa,;
		        PrmNota,;
		        PrmFornCod, ;
		        &PrmAlsIT .codigo , ;
		        &PrmAlsIT .vlrvenda ,;
   		        &PrmAlsIT .vlripi )



		=W_DEFPROC("NOTAENT.SPR")
		LNBsRetido =  NEBsRetido( ;
		        PrmEmpresa,;
		        PrmNota,;
		        PrmFornCod, ;
		        &PrmAlsIT .codigo , ;
   		        LNBsBrRetido )





		=W_DEFPROC("NOTAENT.SPR")
		LNRetido =  NEClcRetido(;
		        PrmEmpresa, ;
		        PrmNota,;
		        PrmFornCod,;
		        &PrmAlsIT .codigo , ;
		        LNVlrICMS , ;
   		        LNBsRetido,;
   		        LNVlrICMSSO)


		*----------------------------------------------------*


		


	    M.DT_DOC   	=  &PrmAlsNE .data_EMI
    	M.DT_ENTSAI =  &PrmAlsNE .Data

		*----------------------------------------------------*
		*  DADOS GERAIS DO ITEM NO REGISTRO
		*----------------------------------------------------*





	    M.NRO_ITEM 	= &PrmAlsIT .Ordem
    	M.PRODCODIGO= &PrmAlsIT .Codigo

		=W_DEFPROC("GRUPO.SPR")
		M.PRODDESCR = GRGetFieldValue( &PrmAlsIT .CODIGO,"DESCRICAO")

		M.PRODDESCR   = DFLimpaString( M.PRODDESCR)

	    M.PRODCOMPLE  = DFLimpaString( &PrmAlsIT .DESCRCOMPL )

	    M.INFO_COMPL  = DFLimpaString( &PrmAlsIT .INFO_COMPL )




		=W_DEFPROC("GRUPO.SPR")
		M.UNIDADE = GRGetFieldValue( &PrmAlsIT .CODIGO,"UNIDADE")
		m.UNIDTRIBUT = M.UNIDADE



		IF EMPTY(M.UNIDADE)
			M.UNIDADE = "UN"
			m.UNIDTRIBUT = "UN"
		ENDIF

    	M.PRECO_TAB    =    &PrmAlsIT .Preco
    	M.PRECOMAXTB   =    0
	    M.PRECOMINTB   =    0


		IF &PrmAlsIT .Qtde > 0
		    m.PRECOVENDA    =    &PrmAlsIT .VLRVENDA /  &PrmAlsIT .Qtde
		    m.VLR_UNIDAD    =    &PrmAlsIT .VLRVENDA /  &PrmAlsIT .Qtde
			m.VLRUNTRIBU    =    &PrmAlsIT .VLRVENDA /  &PrmAlsIT .Qtde
		ELSE
			m.PRECOVENDA    =    0
		    m.VLR_UNIDAD    =    0
			m.VLRUNTRIBU    =    0

		ENDIF


	    M.PRECO_UNIT   =    &PrmAlsIT .Preco
	    M.QTDE   	   =    &PrmAlsIT .Qtde

		M.QTDTRIBUT	    =    &PrmAlsIT .Qtde

	    M.VLR_DESCTO   =    0
	    M.PRC_DESCTO   =    0
    	M.VLRDESPFIN   =    0
	    M.VLRDESPOUT   =    0
    	M.VLR_FRETE    =    0
	    M.VLR_SEGURO   =    0
	
    	M.VLR_FINAL    =    &PrmAlsIT .VlrVenda +;
					    	&PrmAlsIT .vlripi+;
					    	LNRetido
    	
    	*M.VLR_FINAL    =    (INT(M.VLR_FINAL*100)/100)


		LAcmTotItem    =    LAcmTotItem + M.VLR_FINAL






    	
    	
		IF &PrmAlsIT .MovEstq = "S"
		    M.IND_MOVEST   =     "SIM"
		ELSE
		    M.IND_MOVEST   =     "NAO"
		ENDIF
    	M.LT_QTITENS   =    0
	    M.LT_NRO   	   =    ""
    	M.LT_DT_FABR   =    {}
	    M.LT_VALIDAD   =    {}
	    M.CLSCOMNC     =    "00"
    	M.CLSGAS       =    "00"
	    M.CLSAGUA      =    "00"
    	M.CLSENRG      =    "00"


		*----------------------------------------------------*
		*  DADOS TRIBUTARIOS DO REGISTRO
		*----------------------------------------------------*
		
	    M.VLRATRIBUT   =     &PrmAlsIT .VlrVenda
    	M.CUSTONAOPE   =     0
	    M.CUSTOMEDAN   =     0


	*--------
	    M.SALDO_ATU   =    0
	    M.CUSTOMEDAT   =    0

	*----------
	    M.SALDO_ANT    =   0
	    M.CUSTOCONTB   =   0




		LTipo       = &PrmAlsIT .Tipo
		LProduto    = &PrmAlsIT .codigo
		LTp_mercad  = &PrmAlsIT .tp_mercad



*---------

		=W_DEFPROC("TRIBUTAR.SPR")
		M.CFOP = TRCFO(&PrmAlsIT .Empresa, ;
		              &PrmAlsIT .Tipo,;
		              &PrmAlsIT .tp_mercad,;
		              "ENTRADA")

*--------


	    m.CFOP = ALLTRIM(CHRTRAN(m.CFOP,".",""))


		m.origemmrcd = chrtran(str( &PrmAlsIT .origem ,1)," ","0")



		LSCst = DICST_IPI(  &PrmAlsIT .VlrIPI, LOperacao)
    	M.CST_IPI   =   LSCst

	    IF &PrmAlsIT .tp_mercad = 7   && SERVICO
			LSCst = DICST_ISS(  &PrmAlsIT .VlrVenda, LOperacao)
		ELSE
			LSCst = DICST_ISS(  0, LOperacao)
		ENDIF
    	M.CST_ISS   =   LSCst

		LSCst = DICST_PIS(  0, LOperacao)
    	M.CST_PIS   =   LSCst

		LSCst = DICST_COFINS(  0, LOperacao)
    	M.CST_COFINS   =   LSCst

		LSCst = DICST_IR(  0, LOperacao)
    	M.CST_IR   =   LSCst



	    M.ALQICMORIG   =   LaliqOrg
	    M.ALQICMDEST   =   LaliqDst



IF 1=1
		=W_DEFPROC("TRIBUTAR.SPR")
		M.CST_ICMS  =  TRCST_Entrada(;
				 &PrmAlsIT .cst,;
				 &PrmAlsIT .origem, ;
				 &PrmAlsIT .tp_mercad,;
				 &PrmAlsIT .base_calc,;
		  		 &PrmAlsIT .vlrvenda,;
		  		 &PrmAlsIT .icms_subs, ;
		  		 &PrmAlsIT .codigo, ;
		  		 &PrmAlsNE .tipo)

		*-------------   ICMS ----------------


   		M.BC_ICMS         =   &PrmAlsIT .base_calc

	    IF &PrmAlsIT .BsBr_Icms >= &PrmAlsIT .base_calc  	
		      M.BCBRUTAICM   =   &PrmAlsIT .BsBr_Icms
	    ELSE
	    	  M.BCBRUTAICM   =   &PrmAlsIT .base_calc
   		ENDIF
   		M.VLR_ICMS   =   &PrmAlsIT .Vlr_Icms


	    M.BCBRTRTD_S   =   LNBsBrRetido
	    M.BC_RTD_S     =   LNBsRetido
	   	M.ALQICMRTDS   =   &PrmAlsIT .Aliq_Icms
	   	M.ICM_RTD_S    =   LNRetido

		M.IND_REDUCA   =   &PrmAlsIT .Aliq_rdu










ELSE

		DO CASE
			CASE;
			 &PrmAlsNE .tipo $ ;
 			 "CLG/CLH/CFG/CFH/CFM/CID/CLC/CLD/CFC/CFD/CIB/CLE/CLF/CFS/CFE/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "CFF/CIC/CLJ/CFL/ASC/CEE/ASI/CFJ/CFK/TAB/TBB/TAC/TBC/TAD/TBD/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "RBV/RBU/RBF/RBH/RBJ/RBM/RBN/RBG/RBI/RBL/RBO/RAC/RBC/RIB/RAA/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "RBR/RAE/RBE/RID/RBP/RBQ/RCA/RDA/DAF/DBF/DAC/DBC/DBD/DAE/DBE/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "DAG/DBG/"
	   		    M.CST_ICMS     =   m.origemmrcd+"90"

		   		M.BC_ICMS         = &PrmAlsIT .base_calc
			    IF &PrmAlsIT .BsBr_Icms >= &PrmAlsIT .base_calc  	
  			      M.BCBRUTAICM    =   &PrmAlsIT .BsBr_Icms
			    ELSE
  		    	  M.BCBRUTAICM    =   &PrmAlsIT .base_calc
		   		ENDIF
      	   		M.VLR_ICMS   	  =   &PrmAlsIT .Vlr_Icms

			    M.BCBRTRTD_S   =   0
			    M.BC_RTD_S     =   0
		    	M.ALQICMRTDS   =   0
		    	M.ICM_RTD_S    =    0




			CASE    LNBsRetido = 0 ;
				AND &PrmAlsIT .vlr_icms = 0 ;
				AND &PrmAlsIT .tp_mercad = 2


	   		    M.CST_ICMS     =   m.origemmrcd+"60"
			    M.BCBRUTAICM   =   0
    			M.IND_REDUCA   =   0
		    	M.BC_ICMS      =   0
    	  		M.VLR_ICMS     =   0

			    M.BCBRTRTD_S   =   LNBsBrRetido
			    M.BC_RTD_S     =   LNBsRetido
		    	M.ALQICMRTDS   =   &PrmAlsIT .Aliq_Icms
		    	M.ICM_RTD_S    =   LNRetido


			
			CASE    LNBsRetido > 0 AND LNVlrICMSSO > 0

				*--------------------------------
				*--> atende nota entrada 257849 bgs
				*--------------------------------

				M.BC_ICMS    =   0
      	 		M.VLR_ICMS   =   0
	   		    M.CST_ICMS   =   m.origemmrcd+"10"
			    M.BCBRUTAICM =   0

				*------------------------------------*

			    M.BCBRTRTD_S   =   LNBsBrRetido
			    M.BC_RTD_S     =   LNBsRetido
		    	M.ALQICMRTDS   =   &PrmAlsIT .Aliq_Icms
		    	M.ICM_RTD_S    =   LNRetido

			CASE    LNBsRetido > 0  ;
				     AND  &PrmAlsIT .vlr_icms > 0

				*--------------------------------
				*--> atende nota entrada 2135/.36/.37/.38 bgs
				*--------------------------------



				M.BC_ICMS    =   0
      	 		M.VLR_ICMS   =   0
	   		    M.CST_ICMS   =   m.origemmrcd+"10"
			    M.BCBRUTAICM =   0



			    M.BCBRTRTD_S   =   LNBsBrRetido
			    M.BC_RTD_S     =   LNBsRetido
		    	M.ALQICMRTDS   =   &PrmAlsIT .Aliq_Icms
		    	M.ICM_RTD_S    =   LNRetido


    	  	OTHERWISE
	  		    M.CST_ICMS        = m.origemmrcd+ &PrmAlsIT .cst + "0"
		   		M.BC_ICMS         =   &PrmAlsIT .base_calc

			    IF &PrmAlsIT .BsBr_Icms >= &PrmAlsIT .base_calc  	
  			      M.BCBRUTAICM   =   &PrmAlsIT .BsBr_Icms
			    ELSE
  		    	  M.BCBRUTAICM   =   &PrmAlsIT .base_calc
		   		ENDIF
      	   		M.VLR_ICMS   =   &PrmAlsIT .Vlr_Icms

			    M.BCBRTRTD_S   =   0
			    M.BC_RTD_S     =   0
		    	M.ALQICMRTDS   =   0
		    	M.ICM_RTD_S   =    0

      	ENDCASE

ENDIF
		=W_DEFPROC("TRIBUTAR.spr")
		M.IVA= TRGet_IVA( LUFOrig, ;
		                  &PrmAlsIT .codigo ,;
		                  LUFDstn,;
		                  M.DT_DOC )



		****** M.IVA          =   &PrmAlsIT .Iva
		

		IF 	M.VLR_ICMS  =  0
	    	M.BC_ICMS      =   0
   	  		M.VLR_ICMS     =   0
		ENDIF




		IF LUFDstn = LUFOrig
		    M.ALIQ_ICMS  =   LaliqDst
		ELSE
		    M.ALIQ_ICMS  =   LaliqOrg  && ---> &PrmAlsIT .Aliq_Icms
		ENDIF



		IF SUBS(M.CST_ICMS,2,2) $ "30/40/41/50/60"

			M.BCBRICMSSO   = M.BC_ICMS
			M.BCICMSSO     = M.BC_ICMS
			M.ALIQICMSSO   = M.ALIQ_ICMS
			M.VLR_ICMSSO   = M.VLR_ICMS
			
			
	    	M.BC_ICMS      =   0
		    M.ALIQ_ICMS    =   0
   	  		M.VLR_ICMS     =   0

		ENDIF

		IF SUBS(M.CST_ICMS,2,2) $ "90"
		    M.BCBRTRTD_S   =   0
		    M.BC_RTD_S     =   0
	    	M.ALQICMRTDS   =   0
	    	M.ICM_RTD_S    =    0
		ENDIF






		Laliq  = ABS(LaliqOrg - LaliqDst)
    	M.DIF_ALIQ   =   Laliq



		=W_DEFPROC("TRIBUTAR.SPR")
		LRgmTrb = TRDef_RgTrbMercad(LUFOrig,;
		                           &PrmAlsIT .Codigo,;
						 'RETORNAR STRING' )

	    M.RGTRIBORIG   =   LRgmTrb

		=W_DEFPROC("TRIBUTAR.SPR")
		LRgmTrb = TRDef_RgTrbMercad(LUFDstn,;
					  &PrmAlsIT .Codigo,;
						 'RETORNAR STRING' )

	    m.RGTRIBDEST   =   LRgmTrb

	  	IF &PrmAlsNE .BASE_ISENT = 0
		    M.BASE_ISENT   =   0
		ELSE
		    M.BASE_ISENT   =   ;
		    				M.VLR_FINAL ;
						    - ( &PrmAlsIT .vlripi;
					    	+   LNRetido)
		ENDIF
		
		
		




	    M.BCBRTRTD_E   =   0
    	M.BC_RTD_E   =   0
	    M.ICM_RTD_E   =   0

	    M.INDAPURIPI   =   "1"


	    M.BC_IPI    =   &PrmAlsIT .vlrvenda
    	M.ALIQ_IPI  =   &PrmAlsIT .aliq_ipi
	    M.VLR_IPI   =   &PrmAlsIT .vlripi


	    M.BC_ISS   =   &PrmAlsIT .base_iss
	    M.ALIQ_ISS   =   &PrmAlsIT .aliq_iss
    	M.VLR_ISS   =   &PrmAlsIT .vlr_iss



	    M.BASE_OUTR   =   M.VLR_FINAL;
	                     - M.BASE_ISENT ;
	                     - ( &PrmAlsIT .vlripi;
					    	+ LNRetido)


		*--------  AJUSTES FINAIS


    	M.VLRSERVICO = 0
   	    M.VLRPRODUTO = 0
   	
    	IF &PrmAlsIT .tp_mercad = 7   && SERVICO
    	   M.VLRSERVICO = &PrmAlsIT .VLRVENDA
    	ELSE
    	   M.VLRPRODUTO = &PrmAlsIT .VLRVENDA
    	ENDIF

		M.TTPRODSRVC = M.VLRSERVICO + M.VLRPRODUTO


		M.MODBCICMRT = "0"
		M.MOD_BCICMS = "3"




		=W_DEFPROC("GRUPO.SPR")
		M.GTIMCODIGO = GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_GTIM")


		=W_DEFPROC("GRUPO.SPR")
		M.NCMCODIGO = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_NCM"))
		M.NCMCODIGO = CHRTRAN(M.NCMCODIGO,".","")


		=W_DEFPROC("GRUPO.SPR")
		M.EXTIPI = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"EX_TIPI"))


		=W_DEFPROC("GRUPO.SPR")
		M.GENEROPROD = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_GENERO"))



    	IF &PrmAlsIT .tp_mercad = 7   && SERVICO
    	   M.ITEMSERVIC = "S"
    	ELSE
    	   M.ITEMSERVIC = "N"
    	ENDIF


		=W_DEFPROC("GRUPO.SPR")
		M.CDGLSTSRVC = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_LSTSRV"))

		*-----------------------------------------*
		* AS ENTRADA ESTAO GERANDO SALDO CREDOR INDEVIDO
		* SENDO ASSIM PASSAMOS O CST = 060 PARA 030
		* E ZERAMOS CAMPOS DE SUBSTITUICAO
		*-----------------------------------------*

		IF LNRetido > 0
   		    M.CST_ICMS     =   m.origemmrcd+"30"

	    	M.BC_ICMS      =   0
		    M.ALIQ_ICMS    =   0
   	  		M.VLR_ICMS     =   0



	   		** M.ALQICMRTDS   =   0


		    M.BCBRTRTD_E   =   M.BCBRTRTD_S
	    	M.BC_RTD_E     =   M.BC_RTD_S
	    	M.ICM_RTD_E    =   M.ICM_RTD_S


		    M.BCBRTRTD_S   =   0
		    M.BC_RTD_S     =   0
		   	M.ICM_RTD_S    =   0
		ENDIF





    	M.BC_ISS_RTD   =   0
	    M.ALIQ_ISSRT   =   0
	    M.VLR_ISSRTD   =   0

	    M.BC_PIS   	 =   0
    	M.ALIQ_PIS   =   0
	    M.QTDBASEPIS =   0
    	M.VLR_PIS    =   0
	    M.PIS_RTD    =   0
    	M.BC_COFINS  =   0
	    M.ALIQCOFINS =   0
    	M.QTDBASECOF =   0
	    M.VLR_COFINS =   0
    	M.COFINS_RTD =   0
    	M.VLRALQCFRT =   0
	    M.BC_IR   	 =   0
	    M.ALIQ_IR    =   0
	    M.VLR_IR     =   0
    	M.IR_RTD     =   0
	    M.BC_CSLL    =   0
    	M.ALIQ_CSLL  =   0
	    M.VLR_CSLL   =   0
    	M.ADNTA_CSLL =   0
	    M.LANC_AUTO  =   "SIM"


*------------------------------------------------
		PrmVT_Acm[1] = PrmVT_Acm[1] + M.VLR_ICMS
		PrmVT_Acm[2] = PrmVT_Acm[2] + M.BC_ICMS
		PrmVT_Acm[3] = PrmVT_Acm[3] + M.VLR_IPI


*------------------------------------------------



***		=DISalvarRegistro()


		LEmpresa    = m.Empresa
		LMod_Doc    = RtnMod_Doc
		LCod_IdForn = RtnCOD_IDFORN
		LNro_Doc    = RtnNro_Doc
		LSerie_Doc  = RtnSerie_Doc
		LNro_Item   = m.Nro_Item


		SELE &PBDocFisItAlias
		SET ORDER TO TAG ITEM
		SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	      STR(LNro_Doc,7)+LSerie_Doc+STR(LNro_Item,5)
	
		IF !found()
			APPEND BLANK
		ENDIF
		=RLOCK()
		GATHER MEMVAR
		UNLOCK

		SELE &PrmAlsIT
		SKIP
	ENDDO


*	IF PRMNOTA = 1892
*      SET STEP ON
*	ENDIF

	LNdifTotal = LNTotalNE - LAcmTotItem

	PrmVT_Acm[4] = LAcmTotItem






*	IF ABS(LNdifTotal) > 0
*		=DIAjustaVlr()
*	ENDIF


	*---------------------------------------------------*
RETURN(.t.)

FUNCTION DIAjustaVlr

	PRIVATE  LNICM_RTD_S
	PRIVATE  LNVLR_FINAL

	SET NEAR ON

	SELE &PBDocFisItAlias
	SET ORDER TO TAG ITEM
	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	      STR(LNro_Doc,7)+LSerie_Doc+STR(0,5)
	
	SET NEAR OFF
	
	DO WHILE !EOF() ;
	   AND  &PBDocFisItAlias .EMPRESA = Lempresa ;
	   AND  &PBDocFisItAlias .MOD_DOC = Lmod_Doc ;
	   AND  &PBDocFisItAlias .COD_IDFORN = LCod_IdForn ;
	   AND  &PBDocFisItAlias .NRO_DOC    = LNro_Doc ;
	   AND  &PBDocFisItAlias .SERIE_DOC  = LSerie_Doc
	
	   LNICM_RTD_S = &PBDocFisItAlias .ICM_RTD_S
	   LNVLR_FINAL = &PBDocFisItAlias .VLR_FINAL


	   IF LNICM_RTD_S > 0
	   	  REPLACE  &PBDocFisItAlias .ICM_RTD_S ;
	   	    WITH   LNICM_RTD_S + LNdifTotal

	   	  REPLACE  &PBDocFisItAlias .VLR_FINAL ;
	   	    WITH   LNVLR_FINAL + LNdifTotal

		  EXIT
	   ENDIF
	   SKIP	
	
	ENDDO	

	

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DID0           DINmFileXMLDocFiscal VALID         
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   46  
*        Variable:            DINmFileXMLDocFiscal               
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      75                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15did0     &&  DINmFileXMLDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DINmFileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc


	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*


	LSnomeArqXml = "DFISIT"+;
				   PrmMod_Doc
	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")


   	LSfileXML	= LSnomeArqXml+".XML"
	
RETURN(LSfileXML)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DID9           DIDelItensDocFiscal VALID          
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   47  
*        Variable:            DIDelItensDocFiscal                
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      76                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15did9     &&  DIDelItensDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIDelItensDocFiscal
PARAMETER PrmEmpresa,;
		  PrmMod_Doc,;
		  PrmCOD_IDFORN,;
		  PrmNro_Doc,;
		  PrmSerie_Doc




	
	PRIVATE LSalias
	
	PRIVATE PrmAlsDI
	=DIVerifyInst()
	

	LSalias = ALIAS()
	PrmAlsDI = DIGetAlias()



	*-------------------------------------------------------*

	SELE &PrmAlsDI
	SET ORDER TO TAG ITEM
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmMOD_DOC+;
	     PrmCOD_IDFORN+STR(PrmNro_Doc,7)+PrmSERIE_DOC
	SET NEAR OFF

	*----------------------------------------------------*

	SELE &PrmAlsDI

	DO WHILE !EOF() ;
	        AND PrmEmpresa    = &PrmAlsDI .empresa;
	        AND PrmMod_Doc    = &PrmAlsDI .MOD_DOC ;
	        AND PrmCOD_IDFORN = &PrmAlsDI .COD_IDFORN ;
	        AND PrmNro_doc    = &PrmAlsDI .NRO_DOC ;
	        AND PrmSERIE_DOC  = &PrmAlsDI .SERIE_DOC

		=RLOCK()
		DELETE
		SKIP
	ENDDO
	*-----------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIET           DIV01GravaXMLItensDocFiscal VALID  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   49  
*        Variable:            DIV01GravaXMLItensDocFiscal        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      77                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15diet     &&  DIV01GravaXMLItensDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIV01GravaXMLItensDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item,;
			PrmFileXML,;
			PrmNroIDfileXML

	*---------------------------------------------------*

	IF !DILerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item)
	      wait "Nao foi localizado Item DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+MOD_DOC+;
		      "FORN. : "+PrmCOD_IDFORN+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC+;
		      "ITEM  : "+STR(PrmNro_Item,4)
    	  return(.F.)
	ENDIF


	IF DIGetPropVT("QTDE") = 0
    	  return(.t.)
	ENDIF		




	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFLerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado Capa DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+MOD_DOC+;
		      "FORN. : "+PrmCOD_IDFORN+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC
    	  return(.F.)
	ENDIF
	

	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	SET POINT TO ","
	SET SEPARATOR  TO "."


	*-------------------------------------------------------*


		=W_DEFPROC("EMPRESA.SPR")
		=EMLerRegistro(PrmEmp)

		=W_DEFPROC("EMPRESA.SPR")
		LFieldTmp    =  EMGetPropVT("CGC")
	    UNEM_CNPJ    =  STR(LFieldTmp,14)
		UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")


		LSLinhaXML = '<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	


		*==========================================================*
		*  CAMPOS IDENTIFICADORES
		*==========================================================*
	

		=W_DEFPROC("EMPRESA.SPR")
		LFieldTmp    =  EMGetPropVT("EMITE_NFE")

		IF LFieldTmp $ "H"   && H=HOMOLOGACAO

			=W_DEFPROC("DOCFISCA.SPR")
			LSLinhaXML = 'DFIS_MOD_DOCUMENTO="'+;
	    	         "55" +;
	        	     '"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		ELSE
			=W_DEFPROC("DOCFISCA.SPR")
			LSLinhaXML = 'DFIS_MOD_DOCUMENTO="'+;
	    	         DFGetPropVT("MOD_DOC") +;
	        	     '"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF



		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CLFS_SIGLA="'+;
	             DFGetPropVT("TIPO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_IND_OPERACAO="'+;
	             DFGetPropVT("IND_OPER") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_TP_MOVIMENTO="'+;
	             DFGetPropVT("TP_MOV") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		*----------------------------------------------------------*
		=W_DEFPROC("DOCFISCA.SPR")
		LNNro_Doc  = DFGetPropVT("NRO_DOC")
		IF LNNro_Doc > 3000000
			LNNro_Doc = LNNro_Doc - 3000000
		ENDIF

		LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		*----------------------------------------------------------*



		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CPF="'+;
	             DFGetPropVT("CPF") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_IE="'+;
	             DFGetPropVT("IE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		*----------------------------------------------------*
		* SERIE UNICA => "0"
		*----------------------------------------------------*
	

		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = DFGetPropVT("SERIE_DOC")
		IF "U" $ LSLinhaXML
			LSLinhaXML = "0"
		ENDIF
		LSLinhaXML = 'DFIS_SERIE="'+;
	             LSLinhaXML +;
	             '"'
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		*----------------------------------------------------*

		LSLinhaXML = 'ITDF_NRO_ITEM="'+;
	             STR(DIGetPropVT("NRO_ITEM"),5) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		*-------------------------------------------------------*

		LSLinhaXML = 'ITDF_PROD_CODIGO="'+;
	             DIGetPropVT("PRODCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_DESCRICAO="'+;
	             DIGetPropVT("PRODDESCR") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_DESCR_COMPL="'+;
	             DIGetPropVT("PRODCOMPLE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_PROD_INFO_ADICIONAIS="'+;
	             DIGetPropVT("INFO_COMPL") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_UNIDADE="'+;
	             DIGetPropVT("UNIDADE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_PRECO_TABELA="'+;
	             STR(DIGetPropVT("PRECO_TAB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_PRECO_MAX_TABELADO="'+;
	             STR(DIGetPropVT("PRECOMAXTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_PRECO_MIN_TABELADO="'+;
	             STR(DIGetPropVT("PRECOMINTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	

		LSLinhaXML = 'ITDF_QTDE="'+;
	             STR(DIGetPropVT("QTDE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_DESCONTO="'+;
	             STR(DIGetPropVT("VLR_DESCTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_VLR_DESP_FINANCEIRA="'+;
	             STR(DIGetPropVT("VLRDESPFIN"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_OUTRAS_DESP_ACES="'+;
	             STR(DIGetPropVT("VLRDESPOUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_FRETE="'+;
	             STR(DIGetPropVT("VLR_FRETE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SEGURO="'+;
	             STR(DIGetPropVT("VLR_SEGURO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_FINAL="'+;
	             STR(DIGetPropVT("VLR_FINAL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_MENSAGEM="'+;
	             SPACE(5) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_IND_MOVIMENTO_ESTQ="'+;
	             DIGetPropVT("IND_MOVEST") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_QTDE_ITENS="'+;
	             STR(DIGetPropVT("LT_QTITENS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
		LSLinhaXML = 'ITDF_LOTE_NRO="'+;
	             DIGetPropVT("LT_NRO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_FABRICACAO="'+;
	             DTOC(DIGetPropVT("LT_DT_FABR")) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_VALIDADE="'+;
	             DTOC(DIGetPropVT("LT_VALIDAD")) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_MEDIO_ATUAL="'+;
	             STR(DIGetPropVT("CUSTOMEDAT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
		LSLinhaXML = 'ITDF_SALDO_ANTERIOR="'+;
	             STR(DIGetPropVT("SALDO_ANT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_MEDIO_ANT="'+;
	             STR(DIGetPropVT("CUSTOMEDAN"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_NA_OPERACAO="'+;
	             STR(DIGetPropVT("CUSTONAOPE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_A_TRIBUTAR="'+;
	             STR(DIGetPropVT("VLRATRIBUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_SALDO_ATUAL="'+;
	             STR(DIGetPropVT("SALDO_ATU"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_CONTABIL="'+;
	             STR(DIGetPropVT("CUSTOCONTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CFOP="'+;
	             DIGetPropVT("CFOP") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_CST_ICMS="'+;
	             DIGetPropVT("CST_ICMS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_IPI="'+;
	             DIGetPropVT("CST_IPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_ISS="'+;
	             DIGetPropVT("CST_ISS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_PIS="'+;
	             DIGetPropVT("CST_PIS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_COFINS="'+;
	             DIGetPropVT("CST_COFINS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_IR="'+;
	             DIGetPropVT("CST_IR") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS="'+;
	             STR(DIGetPropVT("BCBRUTAICM"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_REDUCAO="'+;
	             STR(DIGetPropVT("IND_REDUCA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS="'+;
	             STR(DIGetPropVT("BC_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_ORIGEM="'+;
	             STR(DIGetPropVT("ALQICMORIG"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_DESTINO="'+;
	             STR(DIGetPropVT("ALQICMDEST"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_DIF_ALIQUOTA="'+;
	             STR(DIGetPropVT("DIF_ALIQ"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS="'+;
	             STR(DIGetPropVT("ALIQ_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ICMS="'+;
	             STR(DIGetPropVT("VLR_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_REG_FISCAL_TRIB_ORIGEM="'+;
	             DIGetPropVT("RGTRIBORIG") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_REG_FISCAL_TRIB_DESTINO="'+;
	             DIGetPropVT("RGTRIBDEST") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISENTA_ICMS="'+;
	             STR(DIGetPropVT("BASE_ISENT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_OUTR_ICMS="'+;
	             STR(DIGetPropVT("BASE_OUTR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS_RTD="'+;
	             STR(DIGetPropVT("BCBRTRTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IVA="'+;
	             STR(DIGetPropVT("IVA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS_RTD="'+;
	             STR(DIGetPropVT("BC_RTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_ALIQ_ICMS_RTD="'+;
	             STR(DIGetPropVT("ALQICMRTDS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ICMS_RTD="'+;
	             STR(DIGetPropVT("ICM_RTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("BCBRTRTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_BC_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("BC_RTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ICMS_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("ICM_RTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_APURACAO_IPI="'+;
	             DIGetPropVT("INDAPURIPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_IPI="'+;
	             STR(DIGetPropVT("BC_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_IPI="'+;
	             STR(DIGetPropVT("ALIQ_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IPI="'+;
	             STR(DIGetPropVT("VLR_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISS="'+;
	             STR(DIGetPropVT("BC_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ISS="'+;
	             STR(DIGetPropVT("ALIQ_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ISS="'+;
	             STR(DIGetPropVT("VLR_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISS_RTD="'+;
	             STR(DIGetPropVT("BC_ISS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ISS_RTD="'+;
	             STR(DIGetPropVT("ALIQ_ISSRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ISS_RTD="'+;
	             STR(DIGetPropVT("VLR_ISSRTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_PIS="'+;
	             STR(DIGetPropVT("BC_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_PIS="'+;
	             STR(DIGetPropVT("ALIQ_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_PIS="'+;
	             STR(DIGetPropVT("QTDBASEPIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS="'+;
	             STR(DIGetPropVT("VLR_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS_RTD="'+;
	             STR(DIGetPropVT("PIS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_COFINS="'+;
	             STR(DIGetPropVT("BC_COFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_COFINS="'+;
	             STR(DIGetPropVT("ALIQCOFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_COFINS="'+;
	             STR(DIGetPropVT("QTDBASECOF"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_COFINS="'+;
	             STR(DIGetPropVT("VLR_COFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_COFINS_RTD="'+;
	             STR(DIGetPropVT("COFINS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_IR="'+;
	             STR(DIGetPropVT("BC_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_IR="'+;
	             STR(DIGetPropVT("ALIQ_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IR="'+;
	             STR(DIGetPropVT("VLR_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IR_RTD="'+;
	             STR(DIGetPropVT("IR_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_CSLL="'+;
	             STR(DIGetPropVT("BC_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_CSLL="'+;
	             STR(DIGetPropVT("ALIQ_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_CSLL="'+;
	             STR(DIGetPropVT("VLR_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ADIANTAMENTO_CSLL="'+;
	             STR(DIGetPropVT("ADNTA_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LANC_AUTOMATICO="'+;
	             DIGetPropVT("LANC_AUTO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_SERV_TELECOM="'+;
	             DIGetPropVT("CLSCOMNC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_GAS="'+;
	             DIGetPropVT("CLSGAS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_AGUA="'+;
	             DIGetPropVT("CLSAGUA") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_ENERGIA_ELETR="'+;
	             DIGetPropVT("CLSENRG") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_SO="'+;
	             STR(DIGetPropVT("ALIQICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_MOD_BC_ICMS="'+;
	             DIGetPropVT("MOD_BCICMS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PERCENTUAL_ACRESCIMO="'+;
	             STR(DIGetPropVT("PRC_ACRESC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PERCENTUAL_DESCONTO="'+;
	             STR(DIGetPropVT("PRC_DESCON"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PRECO_VENDA_UNITARIO="'+;
	             STR(DIGetPropVT("PRECOVENDA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ABATE_NT="'+;
	             STR(DIGetPropVT("VLRABATENT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ACRESCIMO="'+;
	             STR(DIGetPropVT("VLRACRESC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS_SO="'+;
	             STR(DIGetPropVT("BCBRICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS_SO="'+;
	             STR(DIGetPropVT("BCICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISENTA_IPI="'+;
	             STR(DIGetPropVT("BCISENTIPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_COFINS_IMPORTACAO="'+;
	             STR(DIGetPropVT("VLRCOFIMPO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_DESPESAS="'+;
	             STR(DIGetPropVT("VLR_DESPES"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ICMS_SO="'+;
	             STR(DIGetPropVT("VLR_ICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS_IMPORTACAO="'+;
	             STR(DIGetPropVT("VLRPISIMPO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PRODUTOS="'+;
	             STR(DIGetPropVT("VLRPRODUTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SERVICO_NT="'+;
	             STR(DIGetPropVT("VLRSRVC_NT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SERVICOS="'+;
	             STR(DIGetPropVT("VLRSERVICO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_TRIBUTOS="'+;
	             STR(DIGetPropVT("VLRTRIBUTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ORIGEM_MERCADORIA="'+;
	             DIGetPropVT("ORIGEMMRCD") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_O_ITEM_E_SERVICO="'+;
	             DIGetPropVT("ITEMSERVIC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PRODUTOS_SERVICOS="'+;
	             STR(DIGetPropVT("TTPRODSRVC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_GTIM="'+;
	             DIGetPropVT("GTIMCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_NCM="'+;
	             DIGetPropVT("NCMCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_EX_TIPI="'+;
	             DIGetPropVT("EXTIPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_GENERO="'+;
	             DIGetPropVT("GENEROPROD") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_GTIM_UNIDADE_TRIBUTAVEL="'+;
	             DIGetPropVT("GTIMUNTRIB") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_UNIDADE_TRIBUTAVEL="'+;
	             DIGetPropVT("UNIDTRIBUT") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_UNIDADE_TRIBUTAVEL="'+;
	             STR(DIGetPropVT("VLRUNTRIBU"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_UNIDADE_TRIBUTAVEL="'+;
	             STR(DIGetPropVT("QTDTRIBUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLS_CODIGO_LISTA_SERVICO="'+;
	             DIGetPropVT("CDGLSTSRVC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_MOD_BC_ICMS_RTD="'+;
	             DIGetPropVT("MODBCICMRT") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_COFINS_RTD="'+;
	             STR(DIGetPropVT("QTDBCCOFRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ALIQ_COFINS_RTD="'+;
	             STR(DIGetPropVT("VLRALQCFRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_IND_MED_BC_ICMS_RTD="'+;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))






		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CNPJ="'+;
	             DFGetPropVT("CNPJ") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		*-------------------------------------------------------*
		LSLinhaXML = '/>'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	
		SET POINT TO
		SET SEPARATOR to

RETURN(.t.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIJ7           DIGravaXMLItensDocFiscal VALID     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   50  
*        Variable:            DIGravaXMLItensDocFiscal           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      78                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dij7     &&  DIGravaXMLItensDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIGravaXMLItensDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item,;
			PrmFileXML,;
			PrmNroIDfileXML


	*---------------------------------------------------*
	PRIVATE LSprocesso

	=W_DEFPROC("DOCFISCA.SPR")
	LSprocesso = DFVersaoXML()

	PRIVATE LFRETORNO

	DO CASE

		CASE "VERSAO-1.1" $ LSprocesso
			LFRETORNO = DIV10GravaXMLItensDocFiscal( ;
				PrmEmp,;
				PrmMod_doc,;
				PrmCod_IDForn,;
				PrmNro_Doc,;
				PrmSerie_Doc,;
				PrmNro_Item,;
				PrmFileXML,;
				PrmNroIDfileXML)

		CASE "VERSAO-1.0" $ LSprocesso
			LFRETORNO = DIV10GravaXMLItensDocFiscal( ;
				PrmEmp,;
				PrmMod_doc,;
				PrmCod_IDForn,;
				PrmNro_Doc,;
				PrmSerie_Doc,;
				PrmNro_Item,;
				PrmFileXML,;
				PrmNroIDfileXML)

		OTHERWISE
			LFRETORNO = DIV01GravaXMLItensDocFiscal( ;
				PrmEmp,;
				PrmMod_doc,;
				PrmCod_IDForn,;
				PrmNro_Doc,;
				PrmSerie_Doc,;
				PrmNro_Item,;
				PrmFileXML,;
				PrmNroIDfileXML)

	ENDCASE


RETURN(LFRETORNO)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIME           DIERV01GravaXMLItensDocFiscal VALID
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         DOCFISIT,     Record Number:   51  
*        Variable:            DIERV01GravaXMLItensDocFiscal      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      79                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dime     &&  DIERV01GravaXMLItensDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIERV01GravaXMLItensDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item,;
			PrmFileXML,;
			PrmNroIDfileXML

	*---------------------------------------------------*

	IF !DILerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item)
	      wait "Nao foi localizado Item DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+MOD_DOC+;
		      "FORN. : "+PrmCOD_IDFORN+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC+;
		      "ITEM  : "+STR(PrmNro_Item,4)
    	  return(.F.)
	ENDIF


	IF DIGetPropVT("QTDE") = 0
    	  return(.t.)
	ENDIF		


	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFLerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado Capa DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+MOD_DOC+;
		      "FORN. : "+PrmCOD_IDFORN+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC
    	  return(.F.)
	ENDIF
	

	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	SET POINT TO ","
	SET SEPARATOR  TO "."


	*-------------------------------------------------------*


		=W_DEFPROC("EMPRESA.SPR")
		=EMLerRegistro(PrmEmp)

		=W_DEFPROC("EMPRESA.SPR")
		LFieldTmp    =  EMGetPropVT("CGC")
	    UNEM_CNPJ    =  STR(LFieldTmp,14)
		UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")


		LSLinhaXML = '<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	


		*==========================================================*
		*  CAMPOS IDENTIFICADORES
		*==========================================================*
	

		=W_DEFPROC("EMPRESA.SPR")
		LFieldTmp    =  EMGetPropVT("EMITE_NFE")

		IF LFieldTmp $ "H"   && H=HOMOLOGACAO

			=W_DEFPROC("DOCFISCA.SPR")
			LSLinhaXML = 'DFIS_MOD_DOCUMENTO="'+;
	    	         "55" +;
	        	     '"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		ELSE
			=W_DEFPROC("DOCFISCA.SPR")
			LSLinhaXML = 'DFIS_MOD_DOCUMENTO="'+;
	    	         DFGetPropVT("MOD_DOC") +;
	        	     '"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF

		*----------------------------------------------------------------*







		*----------------------------------------------------------------*




		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_IND_OPERACAO="'+;
	             DFGetPropVT("IND_OPER") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_TP_MOVIMENTO="'+;
	             DFGetPropVT("TP_MOV") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		*----------------------------------------------------------*
		=W_DEFPROC("DOCFISCA.SPR")
		LNNro_Doc  = DFGetPropVT("NRO_DOC")
		IF LNNro_Doc > 3000000
			LNNro_Doc = LNNro_Doc - 3000000
		ENDIF

		LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		*----------------------------------------------------*
		* SERIE UNICA => "0"
		*----------------------------------------------------*
	

		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = DFGetPropVT("SERIE_DOC")
		IF "U" $ LSLinhaXML
			LSLinhaXML = "0"
		ENDIF
		LSLinhaXML = 'DFIS_SERIE="'+;
	             LSLinhaXML +;
	             '"'
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		*----------------------------------------------------------*









		*----------------------------------------------------------*

		*----------------------------------------------------------*

        LSLinhaXML = DFGetPropVT("CPF")
        IF EMPTY(LSLinhaXML)
	        LSLinhaXML = DFGetPropVT("CNPJ")
		ENDIF
		

		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CPFCNPJ="'+;
	             LSLinhaXML +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_IE="'+;
	             DFGetPropVT("IE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		*----------------------------------------------------*

		LSLinhaXML = 'ITDF_NRO_ITEM="'+;
	             STR(DIGetPropVT("NRO_ITEM"),5) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		*-------------------------------------------------------*

		LSLinhaXML = 'ITDF_PROD_CODIGO="'+;
	             DIGetPropVT("PRODCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_DESCRICAO="'+;
	             DIGetPropVT("PRODDESCR") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_DESCR_COMPL="'+;
	             DIGetPropVT("PRODCOMPLE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))





		LSLinhaXML = 'ITDF_UNIDADE="'+;
	             DIGetPropVT("UNIDADE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_PRECO_TABELA="'+;
	             STR(DIGetPropVT("PRECO_TAB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_PRECO_MAX_TABELADO="'+;
	             STR(DIGetPropVT("PRECOMAXTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_PRECO_MIN_TABELADO="'+;
	             STR(DIGetPropVT("PRECOMINTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	

		LSLinhaXML = 'ITDF_QTDE="'+;
	             STR(DIGetPropVT("QTDE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_DESCONTO="'+;
	             STR(DIGetPropVT("VLR_DESCTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))







		LSLinhaXML = 'ITDF_VLR_DESP_FINANCEIRA="'+;
	             STR(DIGetPropVT("VLRDESPFIN"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_OUTRAS_DESP_ACES="'+;
	             STR(DIGetPropVT("VLRDESPOUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_FRETE="'+;
	             STR(DIGetPropVT("VLR_FRETE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SEGURO="'+;
	             STR(DIGetPropVT("VLR_SEGURO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_FINAL="'+;
	             STR(DIGetPropVT("VLR_FINAL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_MENSAGEM="'+;
	             SPACE(5) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_IND_MOVIMENTO_ESTQ="'+;
	             DIGetPropVT("IND_MOVEST") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_QTDE_ITENS="'+;
	             STR(DIGetPropVT("LT_QTITENS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
		LSLinhaXML = 'ITDF_LOTE_NRO="'+;
	             DIGetPropVT("LT_NRO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_FABRICACAO="'+;
	             DTOC(DIGetPropVT("LT_DT_FABR")) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_VALIDADE="'+;
	             DTOC(DIGetPropVT("LT_VALIDAD")) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_MEDIO_ATUAL="'+;
	             STR(DIGetPropVT("CUSTOMEDAT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
		LSLinhaXML = 'ITDF_SALDO_ANTERIOR="'+;
	             STR(DIGetPropVT("SALDO_ANT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_MEDIO_ANT="'+;
	             STR(DIGetPropVT("CUSTOMEDAN"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_NA_OPERACAO="'+;
	             STR(DIGetPropVT("CUSTONAOPE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_A_TRIBUTAR="'+;
	             STR(DIGetPropVT("VLRATRIBUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_SALDO_ATUAL="'+;
	             STR(DIGetPropVT("SALDO_ATU"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_CONTABIL="'+;
	             STR(DIGetPropVT("CUSTOCONTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CFOP="'+;
	             DIGetPropVT("CFOP") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_CST_ICMS="'+;
	             DIGetPropVT("CST_ICMS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_IPI="'+;
	             DIGetPropVT("CST_IPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_ISS="'+;
	             DIGetPropVT("CST_ISS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_PIS="'+;
	             DIGetPropVT("CST_PIS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_COFINS="'+;
	             DIGetPropVT("CST_COFINS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_IR="'+;
	             DIGetPropVT("CST_IR") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS="'+;
	             STR(DIGetPropVT("BCBRUTAICM"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_REDUCAO="'+;
	             STR(DIGetPropVT("IND_REDUCA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS="'+;
	             STR(DIGetPropVT("BC_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_ORIGEM="'+;
	             STR(DIGetPropVT("ALQICMORIG"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_DESTINO="'+;
	             STR(DIGetPropVT("ALQICMDEST"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_DIF_ALIQUOTA="'+;
	             STR(DIGetPropVT("DIF_ALIQ"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS="'+;
	             STR(DIGetPropVT("ALIQ_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ICMS="'+;
	             STR(DIGetPropVT("VLR_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_REG_FISCAL_TRIB_ORIGEM="'+;
	             DIGetPropVT("RGTRIBORIG") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_REG_FISCAL_TRIB_DESTINO="'+;
	             DIGetPropVT("RGTRIBDEST") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISENTA_ICMS="'+;
	             STR(DIGetPropVT("BASE_ISENT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_OUTR_ICMS="'+;
	             STR(DIGetPropVT("BASE_OUTR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS_RTD="'+;
	             STR(DIGetPropVT("BCBRTRTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IVA="'+;
	             STR(DIGetPropVT("IVA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS_RTD="'+;
	             STR(DIGetPropVT("BC_RTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_ALIQ_ICMS_RTD="'+;
	             STR(DIGetPropVT("ALQICMRTDS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ICMS_RTD="'+;
	             STR(DIGetPropVT("ICM_RTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("BCBRTRTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_BC_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("BC_RTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ICMS_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("ICM_RTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_APURACAO_IPI="'+;
	             DIGetPropVT("INDAPURIPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_IPI="'+;
	             STR(DIGetPropVT("BC_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_IPI="'+;
	             STR(DIGetPropVT("ALIQ_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IPI="'+;
	             STR(DIGetPropVT("VLR_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISS="'+;
	             STR(DIGetPropVT("BC_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ISS="'+;
	             STR(DIGetPropVT("ALIQ_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ISS="'+;
	             STR(DIGetPropVT("VLR_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISS_RTD="'+;
	             STR(DIGetPropVT("BC_ISS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ISS_RTD="'+;
	             STR(DIGetPropVT("ALIQ_ISSRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ISS_RTD="'+;
	             STR(DIGetPropVT("VLR_ISSRTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_PIS="'+;
	             STR(DIGetPropVT("BC_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_PIS="'+;
	             STR(DIGetPropVT("ALIQ_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_PIS="'+;
	             STR(DIGetPropVT("QTDBASEPIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS="'+;
	             STR(DIGetPropVT("VLR_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS_RTD="'+;
	             STR(DIGetPropVT("PIS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_COFINS="'+;
	             STR(DIGetPropVT("BC_COFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_COFINS="'+;
	             STR(DIGetPropVT("ALIQCOFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_COFINS="'+;
	             STR(DIGetPropVT("QTDBASECOF"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_COFINS="'+;
	             STR(DIGetPropVT("VLR_COFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_COFINS_RTD="'+;
	             STR(DIGetPropVT("COFINS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_IR="'+;
	             STR(DIGetPropVT("BC_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_IR="'+;
	             STR(DIGetPropVT("ALIQ_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IR="'+;
	             STR(DIGetPropVT("VLR_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IR_RTD="'+;
	             STR(DIGetPropVT("IR_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_CSLL="'+;
	             STR(DIGetPropVT("BC_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_CSLL="'+;
	             STR(DIGetPropVT("ALIQ_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_CSLL="'+;
	             STR(DIGetPropVT("VLR_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ADIANTAMENTO_CSLL="'+;
	             STR(DIGetPropVT("ADNTA_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LANC_AUTOMATICO="'+;
	             DIGetPropVT("LANC_AUTO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_SERV_TELECOM="'+;
	             DIGetPropVT("CLSCOMNC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_GAS="'+;
	             DIGetPropVT("CLSGAS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_AGUA="'+;
	             DIGetPropVT("CLSAGUA") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_ENERGIA_ELETR="'+;
	             DIGetPropVT("CLSENRG") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_SO="'+;
	             STR(DIGetPropVT("ALIQICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_MOD_BC_ICMS="'+;
	             DIGetPropVT("MOD_BCICMS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PERCENTUAL_ACRESCIMO="'+;
	             STR(DIGetPropVT("PRC_ACRESC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PERCENTUAL_DESCONTO="'+;
	             STR(DIGetPropVT("PRC_DESCON"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_VENDA_UNITARIO="'+;
	             STR(DIGetPropVT("PRECOVENDA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ABATE_NT="'+;
	             STR(DIGetPropVT("VLRABATENT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ACRESCIMO="'+;
	             STR(DIGetPropVT("VLRACRESC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS_SO="'+;
	             STR(DIGetPropVT("BCBRICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS_SO="'+;
	             STR(DIGetPropVT("BCICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISENTA_IPI="'+;
	             STR(DIGetPropVT("BCISENTIPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_COFINS_IMPORTACAO="'+;
	             STR(DIGetPropVT("VLRCOFIMPO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_DESPESAS="'+;
	             STR(DIGetPropVT("VLR_DESPES"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ICMS_SO="'+;
	             STR(DIGetPropVT("VLR_ICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS_IMPORTACAO="'+;
	             STR(DIGetPropVT("VLRPISIMPO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PRODUTOS="'+;
	             STR(DIGetPropVT("VLRPRODUTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SERVICO_NT="'+;
	             STR(DIGetPropVT("VLRSRVC_NT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SERVICOS="'+;
	             STR(DIGetPropVT("VLRSERVICO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_TRIBUTOS="'+;
	             STR(DIGetPropVT("VLRTRIBUTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ORIGEM_MERCADORIA="'+;
	             DIGetPropVT("ORIGEMMRCD") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_O_ITEM_E_SERVICO="'+;
	             DIGetPropVT("ITEMSERVIC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PRODUTOS_SERVICOS="'+;
	             STR(DIGetPropVT("TTPRODSRVC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_GTIM="'+;
	             DIGetPropVT("GTIMCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_NCM="'+;
	             DIGetPropVT("NCMCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_EX_TIPI="'+;
	             DIGetPropVT("EXTIPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_GENERO="'+;
	             DIGetPropVT("GENEROPROD") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_GTIM_UNIDADE_TRIBUTAVEL="'+;
	             DIGetPropVT("GTIMUNTRIB") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_UNIDADE_TRIBUTAVEL="'+;
	             DIGetPropVT("UNIDTRIBUT") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_UNIDADE_TRIBUTAVEL="'+;
	             STR(DIGetPropVT("VLRUNTRIBU"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_UNIDADE_TRIBUTAVEL="'+;
	             STR(DIGetPropVT("QTDTRIBUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLS_CODIGO_LISTA_SERVICO="'+;
	             DIGetPropVT("CDGLSTSRVC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_MOD_BC_ICMS_RTD="'+;
	             DIGetPropVT("MODBCICMRT") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_COFINS_RTD="'+;
	             STR(DIGetPropVT("QTDBCCOFRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ALIQ_COFINS_RTD="'+;
	             STR(DIGetPropVT("VLRALQCFRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_IND_MED_BC_ICMS_RTD="'+;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))






		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CNPJ="'+;
	             DFGetPropVT("CNPJ") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		*-------------------------------------------------------*
		LSLinhaXML = '/>'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	
		SET POINT TO
		SET SEPARATOR to

RETURN(.t.)

PROCEDURE V01SOBRA

		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CLFS_SIGLA="'+;
	             DFGetPropVT("TIPO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_INFO_ADICIONAIS="'+;
	             DIGetPropVT("INFO_COMPL") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


RETURN

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIRY           NFVerifyInst VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:    3      
*        Variable:            NFVerifyInst                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      80                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15diry     &&  NFVerifyInst VALID
#REGION 3
return
*---------------------------------------------------------------*



FUNCTION NFVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Nota")


	DO CASE

		CASE TYPE("PBNotaAlias") = "U" ;
		   		OR EMPTY(PBNotaAlias) ;
		   		OR !USED(PBNotaAlias)
			=NFCreate()					

		CASE !("NOTA.DBF" $ DBF(PBNotaAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBNotaAlias
			=NFCreate()					


		CASE  !(LSPath $ DBF(PBNotaAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=NFDestroi()				
			=NFCreate()					
	ENDCASE

	
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DISA           NFCreate VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:    4      
*        Variable:            NFCreate                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      81                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15disa     &&  NFCreate VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBNotaAlias") <> "U" ;
	   		AND !EMPTY(PBNotaAlias) ;
	   		AND USED(PBNotaAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBNotaAlias

	IF USED("Nota")
	     =NetArqAgain("Nota")
	     PBNotaAlias     = Alias()
	ELSE
	     =NetArqAgain("Nota")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Nota")
	     PBNotaAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBNotaAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTNota[LMaxDim]
    PUBLIC DIMENSION VDNota[2,3]			&& VETOR PARA PROPRIEDADES
	*-----------------------------------------------------------*
	=NFReadProperty()
	=NFSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DISR           NFDestroi VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:    5      
*        Variable:            NFDestroi                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      82                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15disr     &&  NFDestroi VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBNotaAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBNotaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBNotaAlias
	*  3- Se aplicar um FECHAMENTO a PBNotaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBNotaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBNotaAlias)) OR ;
	   !("NOTA.DBF" $ DBF(PBNotaAlias))

		RELEASE PBNotaAlias
    	RELEASE VTNota
	    RELEASE VDNota
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBNotaAlias) AND USED(PBNotaAlias)
		SELECT &PBNotaAlias
		USE
	ENDIF	
	RELEASE PBNotaAlias
    RELEASE VTNota
    RELEASE VDNota

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIT4           NFReadProp VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:    6      
*        Variable:            NFReadProp                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      83                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dit4     &&  NFReadProp VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=NFVerifyInst()

	SELE &PBNotaAlias
	SCATTER TO VTNota
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DITB           NFSetDerivadas VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:    7      
*        Variable:            NFSetDerivadas                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      84                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ditb     &&  NFSetDerivadas VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

**	=NFVerifyInst()
	*--------------------------------------------------------------*
    VDNota(1,1) = "NAOINFORMADO"
   	VDNota(1,2) = 0
   	VDNota(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DITJ           NFSetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:    8      
*        Variable:            NFSetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      85                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ditj     &&  NFSetPropVT VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

**	=NFVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,PrmValue,;
						    PBNotaAlias,VTNota,VDNota)

RETURN(Lvalue)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DITR           NFGetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:    9      
*        Variable:            NFGetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      86                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ditr     &&  NFGetPropVT VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

**	=NFVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,PBNotaAlias,VTNota,VDNota)

RETURN(Lvalue)





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DITZ           NFChk_Identidade VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:   10      
*        Variable:            NFChk_Identidade                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      87                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15ditz     &&  NFChk_Identidade VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFChk_Identidade
PARAMETERS  ;
			PrmEmp,;
			PrmNota


	PRIVATE LFretorno
	LFretorno = .t.



	=NFVerifyInst()
    =NFSetPropVT("EMPRESA",PrmEmp)
    =NFSetPropVT("NOTA",PrmNota)


	LFretorno=NFFind()
RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIUA           NFFind VALID                       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:   11      
*        Variable:            NFFind                             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      88                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15diua     &&  NFFind VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFFind

	PRIVATE LEmpresa,;
			LNota
			
	
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NFVerifyInst()


	LEmpresa    = NFGetPropVT("Empresa")
	LNota       = NFGetPropVT("Nota")


	SELE &PBNotaAlias
	SET ORDER TO TAG NOTA
	SEEK STR(Lempresa,3)+STR(LNota,7)
	
	IF FOUND()
		=NFReadProperty()
		=NFSetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIUN           NFGetFieldValue VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:   12      
*        Variable:            NFGetFieldValue                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      89                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15diun     &&  NFGetFieldValue VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFGetFieldValue
PARAMETERS  PrmEmp,;
			PrmNota,;
			PrmField			

	=NFChk_Identidade(PrmEmp,;
					  PrmNota)

RETURN(NFGetPropVT(PrmField))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIUV           NF_Refresh VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:   13      
*        Variable:            NF_Refresh                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      90                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15diuv     &&  NF_Refresh VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NF_Refresh
PARAMETERS  PrmEmpresa,;
			PrmNota
			
	
	


	PRIVATE LFreturn

	=NFVerifyInst()


	= NFSetPropVT("Empresa" ,PrmEmpresa)
	= NFSetPropVT("Nota"    ,PrmNota)

	*----------------------------------------------------------------*


	=NFFind()
	
RETURN(.t.)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIV4           NFWriteProp VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:   14      
*        Variable:            NFWriteProp                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      91                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15div4     &&  NFWriteProp VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=NFVerifyInst()

	SELE &PBNotaAlias
	GATHER FROM  VTNota
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIVC           NFLerRegistro VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:   16      
*        Variable:            NFLerRegistro                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      92                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15divc     &&  NFLerRegistro VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFLerRegistro
PARAMETERS  PrmEmp,;
			PrmNota

	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = NFChk_Identidade(PrmEmp,;
			PrmNota)
RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIVL           NFSalvarRegistro VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:   17      
*        Variable:            NFSalvarRegistro                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      93                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15divl     &&  NFSalvarRegistro VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFSalvarRegistro

	=NFVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !NFExiste()
		SELE &PBNotaAlias
		APPEND BLANK
		LFretorno=NFWriteProp()
	ELSE
		SELE &PBNotaAlias
		LFretorno=NFWriteProp()
	ENDIF

RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIVS           NFExiste VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:   18      
*        Variable:            NFExiste                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      94                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15divs     &&  NFExiste VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFExiste

	PRIVATE LEmpresa,;
			LNota
			

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NFVerifyInst()

	LEmpresa    = NFGetPropVT("Empresa")
	LNota	    = NFGetPropVT("NOTA")


	SELE &PBNotaAlias
	SET ORDER TO TAG NOTA
	SEEK STR(Lempresa,3)+STR(LNota,7)
	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIW5           NFGetAlias VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:   20      
*        Variable:            NFGetAlias                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      95                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15diw5     &&  NFGetAlias VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFGetAlias

	=NFVerifyInst()

RETURN(PBNotaAlias)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIWA           NFFaxinaDados VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA,     Record Number:   21      
*        Variable:            NFFaxinaDados                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      96                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15diwa     &&  NFFaxinaDados VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFFaxinaDados

	PRIVATE LSAlias, TOTAL, CTR
	=NFVerifyInst()

	LSAlias = NFGetAlias()
	
	SELE &LSAlias





	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*





	COUNT TO TOTAL
	CTR = 0

	GO TOP
	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;

		=UPtermo()


		=RLOCK()


		CTR = 	CTR + 1
		MSG = STR(CTR,7)+" DE "+STR(TOTAL,7)
		WAIT WINDOW MSG NOWAIT


		REPLACE NOME WITH UPLimpaString(NOME)
		REPLACE ENDERECO WITH UPLimpaString(ENDERECO)


		=W_DEFPROC("CLIENTES.SPR")
		IF !CLVld_CPF_CNPJ( &LSAlias .FAVORECIDO )
			REPLACE CPFCNPJVLD  WITH "E"  && CPF/CNPJ ERRADO
		ENDIF

		SKIP
	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
	


RETURN(.t.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIWR           NFRgAvisoCaixa VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:    3    
*        Variable:            NFRgAvisoCaixa                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      97                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _31z15diwr     &&  NFRgAvisoCaixa VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFRgAvisoCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa
	*------------------------------------------------------------*
    PRIVATE LFreturn
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()
	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !FOUND()
	    =up_fecha("&ALS_Nota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*

   	IF &ALS_Nota .ch_condi = "1"   &&  A VISTA
		LFreturn = NFRgAvistaCaixa(PrmEmpresa,PrmNota)
   	ELSE
		LFreturn = NFRgAprazoCaixa(PrmEmpresa,PrmNota)
   	ENDIF

	*---------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIWS           NFRgAvistaCaixa VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:    4    
*        Variable:            NFRgAvistaCaixa                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      98                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _31z15diws     &&  NFRgAvistaCaixa VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFRgAvistaCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa de NF A VISTA
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_LancaCx,ALS_LancaCx
    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_OrPgt,ALS_OrPgt

	PRIVATE LNseqDup
	
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    ARQ_OrPgt  = NetArqAgain("ORCA_PGT")
    ALS_OrPgt  = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()

	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND() OR &ALS_Nota .ch_condi <> "1"   && NO  A VISTA
	    =up_fecha("&ALS_Nota")
    	=up_fecha("&ALS_OrPgt")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
    * So gera controle para notas :
    *    - Operacao de Venda (ch_opera = "1")
    *    - A para notas a prazo com entrada  	
	*----------------------------------------------------------*
	SELE &ALS_OrPgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(&ALS_Nota .referencia,6)
	SET NEAR OFF
	*-------------------------------------------------------------*
	DO WHILE !EOF() ;
			AND &ALS_OrPgt .empresa = PrmEmpresa ;
			AND &ALS_OrPgt .orcamento = &ALS_Nota .referencia
	   	m.EMPRESA 	= PrmEmpresa
	   	m.PORTADOR  = 0            && Defini Caixa
		m.NOME      = &ALS_Nota .nome
 		m.data      = &ALS_Nota .data
 		m.dt_VENC   = &ALS_Nota .data
		*--------------------------------------------------------------*
		*=> Pgto Entrada em Diheiro(1) ou Cheque(2) => La놹r para CAIXA
		*--------------------------------------------------------------*
		IF &ALS_OrPgt .modo_pgto = 1  AND ;
		    ( &ALS_OrPgt .moeda = 1 OR &ALS_OrPgt .moeda = 2 )
			
		    m.TIPO_DOC  = 1            && Codigo Tabela Padrao para NF
		    m.NUM_DOC   = STR(PrmNota,15)
	    	m.valor     = &ALS_OrPgt .vlr_pgto
			IF &ALS_OrPgt .moeda = 1
				m.MOEDA = "DINHEIRO"
			ELSE
				m.MOEDA = "CHEQUE"
			ENDIF			

		    m.JUROS        = 0
		    m.DESCONTOS    = 0
		    m.PROCESSADO   = "N"
		    m.OPERACAO     = "LANCAR"
		    m.LOG_LANCA    = "Lanc. Automatico Faturamento."

		    sele &ALS_LancaCx
		    =edithand('SAVE')
		    IF m.MOEDA = "CHEQUE"
			    m.TIPO_DOC  = 3         && REGISTRO PARA CONTROLE DE CHQ
			    sele &ALS_LancaCx
			    =edithand('SAVE')
		    ENDIF
		ENDIF
		SELE &ALS_OrPgt
		SKIP
	ENDDO
	*-------------------------------------------------------------*
	*---------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
   	=up_fecha("&ALS_OrPgt")
   	=up_fecha("&ALS_LancaCx")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIXZ           NFRgAprazoCaixa VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:    5    
*        Variable:            NFRgAprazoCaixa                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      99                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _31z15dixz     &&  NFRgAprazoCaixa VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFRgAprazoCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    PRIVATE ARQ_LancaCx,ALS_LancaCx
    PRIVATE ARQ_Duplicat,ALS_Duplicat

	PRIVATE LNseqDup
	
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()

    ARQ_Duplicat  = NetArqAgain("DUPLICAT")
    ALS_Duplicat  = Alias()


	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !FOUND() OR &ALS_Nota .ch_condi = "1"  &&  A VISTA
	    =up_fecha("&ALS_Nota")
    	=up_fecha("&ALS_LancaCx")
    	=up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
	*----------------------------------------------------------*

	=W_DEFPROC("duplicat.spr")
    LNnroDup = CRNroIDdupl(PrmEmpresa,PrmNota,1)


    SELE &ALS_Duplicat
  	SET ORDER TO TAG doc
	SET NEAR ON
    SEEK STR(PrmEmpresa,3)+STR(LNnroDup,9)
    SET NEAR OFF
	*-------------------------------------------------------------*
	DO WHILE !EOF() ;
			AND &ALS_Duplicat .empresa = PrmEmpresa ;
			AND &ALS_Duplicat .nota = PrmNota
	   	m.EMPRESA 	= PrmEmpresa
	   	m.PORTADOR  = 0            && Defini Caixa
		m.NOME      = &ALS_Nota .nome
 		m.data      = &ALS_Nota .data
 		m.dt_VENC   =  &ALS_Duplicat .dt_venc
		*--------------------------------------------------------------*
		*=> Pgto Entrada em Diheiro(1) ou Cheque(2) => La놹r para CAIXA
		*--------------------------------------------------------------*
		IF  ( &ALS_Duplicat .moeda = 1 OR &ALS_Duplicat .moeda = 2 )
			
			IF &ALS_Duplicat .moeda = 1
				m.MOEDA = "DINHEIRO"
			ELSE
				m.MOEDA = "CHEQUE"
			ENDIF			

	        m.NUM_DOC   = STR( &ALS_Duplicat .duplicata ,15)
    		m.valor     = &ALS_Duplicat .vlr_doc

		    m.JUROS        = 0
		    m.DESCONTOS    = 0
		    m.PROCESSADO   = "N"
		    m.OPERACAO     = "LANCAR"
		    m.LOG_LANCA    = "Lanc. Automatico Faturamento."

			IF &ALS_Duplicat .portador = 993  && Entrada para CAIXA
	       		m.TIPO_DOC  = 2            && Codigo Tabela Padrao para dupl
			    sele &ALS_LancaCx
			    =edithand('SAVE')
			ENDIF
			
		    IF m.MOEDA = "CHEQUE"
			    m.TIPO_DOC  = 3         && REGISTRO PARA CONTROLE DE CHQ
			    sele &ALS_LancaCx
			    =edithand('SAVE')
		    ENDIF
		ENDIF
		SELE &ALS_Duplicat
		SKIP
	ENDDO
	*-------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
   	=up_fecha("&ALS_LancaCx")
   	=up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIY0           NFCnAvisoCaixa VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:    6    
*        Variable:            NFCnAvisoCaixa                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      100                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _31z15diy0     &&  NFCnAvisoCaixa VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFCnAvisoCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Cancelamento
	*             de Lancamento no Sistema de Caixa
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

    PRIVATE LFretorno
    PRIVATE LSalias

    PRIVATE ARQ_Nota,ALS_Nota

    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !FOUND()
	    =up_fecha("&ALS_Nota")
	    =up_fecha("&ALS_Orcamento")
    	=up_fecha("&ALS_LancaCx")
    	=up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF


	*---------------------------------------------------------------*

   	IF &ALS_Nota .ch_condi = "1"   &&  A VISTA
		LFreturn = NFCnAvstaCaixa(PrmEmpresa,PrmNota)
   	ELSE
		LFreturn = NFCnAprzoCaixa(PrmEmpresa,PrmNota)
   	ENDIF

	*---------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIZ1           NFCnAvstaCaixa VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:    7    
*        Variable:            NFCnAvstaCaixa                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      101                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _31z15diz1     &&  NFCnAvstaCaixa VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFCnAvstaCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Cancelamento lara Lancamento
	*              no Sistema de Caixa de NF A VISTA
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_LancaCx,ALS_LancaCx
    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_OrPgt,ALS_OrPgt

	PRIVATE LNseqDup
	
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    ARQ_OrPgt  = NetArqAgain("ORCA_PGT")
    ALS_OrPgt  = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()

	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND() OR &ALS_Nota .ch_condi <> "1"   && NO  A VISTA
	    =up_fecha("&ALS_Nota")
    	=up_fecha("&ALS_OrPgt")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
    * So gera controle para notas :
    *    - Operacao de Venda (ch_opera = "1")
    *    - A para notas a prazo com entrada  	
	*----------------------------------------------------------*
	SELE &ALS_OrPgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(&ALS_Nota .referencia,6)
	SET NEAR OFF
	*-------------------------------------------------------------*
	DO WHILE !EOF() ;
			AND &ALS_OrPgt .empresa = PrmEmpresa ;
			AND &ALS_OrPgt .orcamento = &ALS_Nota .referencia
	   	m.EMPRESA 	= PrmEmpresa
	   	m.PORTADOR  = 0            && Defini Caixa
		m.NOME      = &ALS_Nota .nome
 		m.data      = &ALS_Nota .data
 		m.dt_VENC   = &ALS_Nota .data
		*--------------------------------------------------------------*
		*=> Pgto Entrada em Diheiro(1) ou Cheque(2) => La놹r para CAIXA
		*--------------------------------------------------------------*
		IF &ALS_OrPgt .modo_pgto = 1  AND ;
		    ( &ALS_OrPgt .moeda = 1 OR &ALS_OrPgt .moeda = 2 )
			
		    m.TIPO_DOC  = 1            && Codigo Tabela Padrao para NF
		    m.NUM_DOC   = STR(PrmNota,15)
	    	m.valor     = &ALS_OrPgt .vlr_pgto
			IF &ALS_OrPgt .moeda = 1
				m.MOEDA = "DINHEIRO"
			ELSE
				m.MOEDA = "CHEQUE"
			ENDIF			

		    m.JUROS        = 0
		    m.DESCONTOS    = 0
		    m.PROCESSADO   = "N"
		    m.OPERACAO     = "CANCELAR"
		    m.LOG_LANCA    = "** Cancelamento Lanc.Faturamento."

		    sele &ALS_LancaCx
		    =edithand('SAVE')
		    IF m.MOEDA = "CHEQUE"
			    m.TIPO_DOC  = 3         && REGISTRO PARA CONTROLE DE CHQ
			    sele &ALS_LancaCx
			    =edithand('SAVE')
		    ENDIF
		ENDIF
		SELE &ALS_OrPgt
		SKIP
	ENDDO
	*-------------------------------------------------------------*
	*---------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
   	=up_fecha("&ALS_OrPgt")
   	=up_fecha("&ALS_LancaCx")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DIZQ           NFCnAprzoCaixa VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:    8    
*        Variable:            NFCnAprzoCaixa                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      102                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _31z15dizq     &&  NFCnAprzoCaixa VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFCnAprzoCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    PRIVATE ARQ_LancaCx,ALS_LancaCx
    PRIVATE ARQ_Duplicat,ALS_Duplicat

	PRIVATE LNseqDup
	
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()

    ARQ_Duplicat  = NetArqAgain("DUPLICAT")
    ALS_Duplicat  = Alias()


	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !FOUND() OR &ALS_Nota .ch_condi = "1"  &&  A VISTA
	    =up_fecha("&ALS_Nota")
    	=up_fecha("&ALS_LancaCx")
    	=up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
	*----------------------------------------------------------*

	=W_DEFPROC("duplicat.spr")
    LNnroDup = CRNroIDdupl(PrmEmpresa,PrmNota,1)


    SELE &ALS_Duplicat
  	SET ORDER TO TAG doc
	SET NEAR ON
    SEEK STR(PrmEmpresa,3)+STR(LNnroDup,9)
    SET NEAR OFF
	*-------------------------------------------------------------*
	DO WHILE !EOF() ;
			AND &ALS_Duplicat .empresa = PrmEmpresa ;
			AND &ALS_Duplicat .nota = PrmNota
	   	m.EMPRESA 	= PrmEmpresa
	   	m.PORTADOR  = 0            && Defini Caixa
		m.NOME      = &ALS_Nota .nome
 		m.data      = &ALS_Nota .data
 		m.dt_VENC   =  &ALS_Duplicat .dt_venc
		*--------------------------------------------------------------*
		*=> Pgto Entrada em Diheiro(1) ou Cheque(2) => La놹r para CAIXA
		*--------------------------------------------------------------*
		IF  ( &ALS_Duplicat .moeda = 1 OR &ALS_Duplicat .moeda = 2 )
			
			IF &ALS_Duplicat .moeda = 1
				m.MOEDA = "DINHEIRO"
			ELSE
				m.MOEDA = "CHEQUE"
			ENDIF			

	        m.NUM_DOC   = STR( &ALS_Duplicat .duplicata ,15)
    		m.valor     = &ALS_Duplicat .vlr_doc

		    m.JUROS        = 0
		    m.DESCONTOS    = 0
		    m.PROCESSADO   = "N"
		    m.OPERACAO     = "CANCELAR"
		    m.LOG_LANCA    = "** Cancelamento Lanc.Faturamento."


			IF &ALS_Duplicat .portador = 993  && Entrada para CAIXA
	       		m.TIPO_DOC  = 2            && Codigo Tabela Padrao para dupl
			    sele &ALS_LancaCx
			    =edithand('SAVE')
			ENDIF
			
		    IF m.MOEDA = "CHEQUE"
			    m.TIPO_DOC  = 3         && REGISTRO PARA CONTROLE DE CHQ
			    sele &ALS_LancaCx
			    =edithand('SAVE')
		    ENDIF
		ENDIF
		SELE &ALS_Duplicat
		SKIP
	ENDDO
	*-------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
   	=up_fecha("&ALS_LancaCx")
   	=up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ0G           NFNroNFServico VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:    9    
*        Variable:            NFNroNFServico                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      103                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj0g     &&  NFNroNFServico VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFNroNfServico
PARAMETERS LNemp,LStp_process,LNnota,LNcupom
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Definir o numero da nota ou cumpo conforme a
	*		empresa e o processo determinado
	*------------------------------------------------------------*
	* COMENTARIO..: O padrao  retornar o numero da ultima nota
	*				faturada
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LStp_process...: Processo definido em NFDefProcess
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNnota.........: Numero definido para Nota
	*		LNcupom........: Numero Cupom relacionado a nota
	*						(Quando processo de RECUPERACAO)
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	DO  CASE

		CASE LStp_proces = "REC.NOTA/CUPOM"
			DO OBJ_2FAT.SPR WITH LNcupom,0,LNnota,"SERVICO"
			IF LNnota > 0				&& CONFIRMOU OS DADOS
				LNnota     = LNnota - 1 && O USUARIO VAI DIGITAR O NUMERO
										&& REAL DA NOTA O SISTEMA TRATA COMO
										&& O ULTIMO NUMERO ,POR ISSO
										&& SUBTRAIR O 1 						 				
				IF LNnota < 2000000
					LNnota = LNnota + 2000000
				ENDIF
			ENDIF
		OTHERWISE
			LNnota     = empresa.ult_nfsrvc
			IF LNnota < 2000000
				LNnota = LNnota + 2000000
			ENDIF

	ENDCASE
	*--------------------------------------------------------------*
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota+1,7)  && VER SE PROXIMO NUMERO JA GRAVADO
	IF FOUND()
	   	WAIT WINDOW "No. Nota ja emitido. "+STR(LNnota+1,7)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ0Y           NFNroCtrlCupom VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   10    
*        Variable:            NFNroCtrlCupom                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      104                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj0y     &&  NFNroCtrlCupom VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFNroCtrlCupom
PARAMETERS LNemp,LStp_process,LNcupom
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Definir o numero de Controle Interno de Cupom
	*------------------------------------------------------------*
	* COMENTARIO..: O padrao  retornar o numero do ultimo
	*              Controle Interno de Cupom Faturado
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LStp_process...: Processo definido em NFDefProcess
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNcupom........: Numero Cupom relacionado a nota
	*						(Quando processo de RECUPERACAO)
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LNnumeroDoc
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*------------------------------------------------------------*
	DO  CASE
		CASE LStp_proces = "CUPOM"
			LNnumeroDoc     = empresa.ult_cupom 						 				
			IF LNnumeroDoc < 1000000
				LNnumeroDoc = LNnumeroDoc + 1000000
			ENDIF
		CASE LStp_proces = "REC.CUPOM"
			DO OBJ_2FAT.SPR WITH LNcupom,LNnumeroDoc,0,(LStp_proces)
			IF LNnumeroDoc > 0		&& CONFIRMOU OS DADOS
				LNnumeroDoc = LNnumeroDoc - 1
										&& O USUARIO VAI DIGITAR O NUMERO
										&& REAL DA NOTA O SISTEMA TRATA COMO
										&& O ULTIMO NUMERO ,POR ISSO
										&& SUBTRAIR O 1 						 				
				IF LNnumeroDoc < 1000000
					LNnumeroDoc = LNnumeroDoc + 1000000
				ENDIF
			ENDIF
	ENDCASE
	*--------------------------------------------------------------*
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnumeroDoc+1,7)
								  && VER SE PROXIMO NUMERO JA GRAVADO
	IF FOUND()
	   	WAIT WINDOW "No. Nota ja emitido. "+STR(LNnumeroDoc+1,7)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNnumeroDoc)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ1F           NFDelItensNf VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   11    
*        Variable:            NFDelItensNf                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      105                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj1f     &&  NFDelItensNf VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFDelItensNf
PARAMETERS LNemp,LNnota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Eliminar Itens Referentes a Nota No Movimento*	
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNnota.........: Nro da Nota para eliminar itens
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LNcodigo
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
    SELECT itemmov
    SET ORDER TO TAG itensnota
	SET NEAR ON
    SEEK STR(LNemp,3)+"S"+STR(LNnota,7)
	SET NEAR OFF
	DO WHILE !EOF() AND LNemp = itemmov.empresa ;
					AND LEFT(itemmov.operacao,1) = "S" ;
					AND LNnota    = itemmov.nota

			IF itemmov.tipo <> nota.tipo
				SKIP
				LOOP
			ENDIF

		    LNcodigo = itemmov.codigo
			SELE itmanexo
			SET ORDER TO TAG movanexo
			SEEK STR(itemmov.empresa,3)+itemmov.codigo+;
				 DTOS(itemmov.data)+itemmov.hora+itemmov.tipo+;
			 	STR(itemmov.nota,7)+STR(itemmov.ordem,3)
			if found()
				=REGLOCK(.T.)
				=edithand('APAGA')
			ENDIF
			UNLOCK
			SELE itemmov
		   	=W_DEFPROC("moviment.spr")
			=MVCancelMvto(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e
			SELE itemmov
		    SET ORDER TO TAG movimento
			SKIP
    ENDDO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ1X           NFdefNatureza VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   12    
*        Variable:            NFdefNatureza                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      106                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj1x     &&  NFdefNatureza VALID
#REGION 4
return
*---------------------------------------------------------------*
FUNCTION NFdefNatureza
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Informar a menssagem adequada para o
	*                campo natureza a ser impresso em RELNFS2
	*------------------------------------------------------------*
	* COMENTARIO..:     Esta funcao foi implementada em funcao
	*              de se querer informa a natureza VENDA CARTAO
	*              que nao e uma natureza expecificada em funcao
	*              do tipo como as demais
	*				   O rgistro da nota ja esta posicionado pelo
	*   			relatorio
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*		
	*------------------------------------------------------------*
	* EXEMPLO : RELNFS2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	IF nota.ch_opera = "1" AND (nota.tp_parcela = 4 OR nota.tp_parcela = 5)
		RETURN("VENDA CARTAO")
	ENDIF
	IF nota.ch_opera = "1" AND (nota.tp_parcela = 6)
		RETURN("VENDA VENDOR")
	ENDIF
	
RETURN(nota.natureza)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ27           NFpede_cancelamento VALID          
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   13    
*        Variable:            NFpede_cancelamento                
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      107                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj27     &&  NFpede_cancelamento VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFpede_cancelamento



	PRIVATE LSstatus
	LSstatus = ""

	PRIVATE LSemiteNFe

	PRIVATE LSdbant,VLleitura,VLlerfim,VLcompara,VLchvlimi, LNregvolta
	PRIVATE LStipo,LNnf
	PRIVATE LNEmpSelec, LNNotaSelec
	******>>>> INICIO CONTROLE ARQUIVOS
	*>> parametros repassados a btn_val
	VLleitura = "STR(wp_empresa,3)"
                         * repassa chave de leitura p/ btn_val
	VLlerfim  = "STR(wp_empresa+1,3)"
           * repassa chave de leitura p/ btn_val (POSICAO FINAL + 1 REG)

	VLcompara = "nota.empresa = wp_empresa "
                         * repassa chave de comparacao p/ btn_val
	VLchvlimi = "STR(wp_empresa,3)"
	*-----------------------------------------------------------------*
	LSdbant = ALIAS()
	SELE nota
	SET ORDER TO TAG ORDEM_EMI
	SET NEAR ON
	SEEK VLlerfim
	ON KEY LABEL ESCAPE
	DO loc_dlog WITH .T.,Vlcompara, VLchvlimi,.F.,.F., .F.
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	SET NEAR OFF

	IF LASTKEY() = 27
		SELE orcament
	    RETURN .F.
	ENDIF


	LNnota = nota.nota

	IF LNnota = 0
	   SELE orcament
	   RETURN
	ENDIF
    LScp1 = STR(LNnota,7)

	wp_msg = "Confirma Solicitacao de Cancelamento p/ "+LScp1
	IF !fox_alert(wp_msg)
	   SELE orcament
	   RETURN
	ENDIF
	wp_msg = 'Informe Seu Codigo e sua Senha p/ CANCELAR..'
	LNusuario = nUsr
	BTMP   =  'usuario.usuario = LNusuario '
	LNusr_ret = 0
	DO obj_prmt.SPR WITH   wp_msg , Btmp
	IF LNusr_ret =  0
	   WAIT WINDOW "Cancelamento nao Efetuado.....<ENTER>"
	   SELE orcament
	   RETURN
	ENDIF




	=W_DEFPROC("EMPRESA.SPR")
	LSemiteNFe = EMGetFieldValue(wp_empresa,"EMITE_NFE")





	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(wp_empresa,3)+STR(LNnota,7)
	IF !FOUND()
	   WAIT WINDOW ;
	   "Cancelamento no iniciado. Nao Localizou Reg. no Sistema .<ENTER>"
	   SELE orcament
	   RETURN
	ENDIF
	
	LNEmpSelec  = nota.empresa
	LNNotaSelec = nota.nota



	DO CASE



		CASE   (nota.cupom > 0 AND nota.tipo <> "CPM" ) ;
			AND (nota.tp_parcela = 4 or nota.tp_parcela = 5)
			&& ==> SOLICITOU CANCELAMENTO DE UM TEF
			=NFCancTEF(LNEmpSelec,LNNotaSelec)
		

		CASE   (nota.nota <= 999999 AND nota.cupom = 0 )

			&& ==> SOLICITOU CANCELAMENTO DE UMA NOTA
			=NFCancNota(LNEmpSelec,LNNotaSelec)


		CASE   (    nota.nota > 1000000 ;
		        AND nota.nota < 2000000)

			&& ==> SOLICITOU CANCELAMENTO DE UM CUPO

			IF NFCanCopias(LNEmpSelec,LNNotaSelec)
				=NFCancCupom(LNEmpSelec,LNNotaSelec)
			ENDIF

 		CASE   (    nota.nota > 2000000 ;
		        AND nota.nota < 3000000 ;
		        AND nota.cupom = 0 )
			&& ==> SOLICITOU CANCELAMENTO DE UMA NOTA DE SERVICO
			=NFCancNfSrv(LNEmpSelec,LNNotaSelec)


		CASE   (    nota.nota > 3000000 ;
		        AND nota.nota < 4000000 ;
		        AND nota.cupom = 0 )
			&& ==> SOLICITOU CANCELAMENTO DE UMA NFe
			=NFCancNota(LNEmpSelec,LNNotaSelec)


 		CASE   (    nota.nota > 4000000 ;
		        AND nota.nota < 5000000 ;
		        AND nota.cupom = 0 )
			&& ==> SOLICITOU CANCELAMENTO DE UMA NFSe
			=NFCancNfSrv(LNEmpSelec,LNNotaSelec)


		CASE   (nota.cupom > 0 AND nota.tipo <> "CPM" )
			&& ==> SOLICITOU CANCELAMENTO DE UM CUPO

			IF NFCanCopias(LNEmpSelec,LNNotaSelec)
				=NFCancCupom(LNEmpSelec,LNNotaSelec)
			ENDIF


		CASE   nota.tipo = "CPM" AND LSemiteNFe = "S"

			&& ==> SOLICITOU CANCELAMENTO DE UMA COPIA
			=NFCanNFCopia(LNEmpSelec,LNNotaSelec)


		CASE   nota.tipo = "CPM"
			&& ==> SOLICITOU CANCELAMENTO DE TODAS Copias
			=NFCanCopias(LNEmpSelec,LNNotaSelec)

		OTHERWISE
			&& ==> SOLICITOU CANCELAMENTO DE UMA NOTA
			=NFCancNota(LNEmpSelec,LNNotaSelec)
			
	ENDCASE

    SELE orcament

RETURN

***



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ35           NFCancNota VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   14    
*        Variable:            NFCancNota                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      108                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj35     &&  NFCancNota VALID
#REGION 4
return
*---------------------------------------------------------------*

********************
FUNCTION NFCancNota
PARAMETERS PrmEmpresa,PrmNota
	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF
		
		***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF nota.data <> wp_dtoper
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
		   "      A Nota Fiscal informada para cancelamento "+;
		   "nao pertence a data de hoje. Esta operacao so "+;
		   " e permitida em caso de intervencao do suporte."
			wp_msg = 'Usuario Suporte...'
		BTMP   =  'usuario.retroacao = "S"'
		LNusr_ret = 0
		DO obj_prmt.SPR WITH   wp_msg , Btmp
		IF LNusr_ret =  0
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF	
	SCATTER MEMVAR


	*----------------------------------------------------------------*
	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa,PrmNota)
	IF LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			

	*-----------------------------------------------------------*

	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*
	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
	REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************

	IF LSobjetivo = "ESCRITURACAO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	UNLOCK ALL
    SELE orcament
RETURN(.t.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ3N           NFCancCupom VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   15    
*        Variable:            NFCancCupom                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      109                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj3n     &&  NFCancCupom VALID
#REGION 4
return
*---------------------------------------------------------------*


FUNCTION NFCancCupom
PARAMETERS PrmEmpresa,PrmNota
	PRIVATE  Flg_aceita,LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr
	STORE 0  TO  LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr

	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.F.)
	ENDIF

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
		
	***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***

	=W_DEFPROC("ECF.spr")
	LNcupom = INT(ECFnrocupom())
	IF LNcupom = 0
   		DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+chr(13)+;
		   "  A ECF esta Retornando Numero de CUPOM = ZERO." +;
		   "Verifique <STATUS>. Verifique <Numero do Cupom>. "+;
		   "Verifique <RESET>. Se Persistir Contacte SUPORTE."
	    SELE orcament
		RETURN(.F.)
	ENDIF

	SELE nota

    IF nota.cupom   = LNcupom
		  Flg_aceita = .T.
    ELSE
		  Flg_aceita = .F.
	ENDIF
							
	IF !Flg_aceita
	   LScp1 = STR(PrmNota,7)
	   LScp2 = STR(nota.cupom,7)
	   LScp3 = STR(LNcupom,7)
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				   "      O numero de DOCUMENTO ["+LScp1+;
				   "] informado p/ cancelamento "+;
				    "esta relacionado ao CUPOM ["+LScp2+;
				    " ] sendo que o ultimo CUPOM localizado pelo "+;
				    "sistema e  ["+LScp3+"]"+;
				    chr(13)+"   Verifique os dados e tente novamente."
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Reg. Cupom Nao Pode ser Bloqueado Para Cancelamento.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	*-----------------------  CACELANDO ECF--------------------------*	

	LNCartaoVlr = 0
	=W_DEFPROC("ECF.spr")
	LSstatus=ECFcanccpm(nota.cupom,LNCartaoVlr)

	IF SUBS(LSstatus,7,1) = "E"
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
		   "      A impressora fiscal nao acatou o cancelamento."+;
		   "Repita o processo e se persistir a negacao entre "+;
		   " em contato com suporte informando o menssagem : "+;
		    LSstatus
	   SELE orcament
	   RETURN(.f.)
	ENDIF			




	CLEAR TYPEAHEAD


	SELE  NOTA
	SCATTER MEMVAR
	*-----------------------------------------------------------*
	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*





	*----------------------------------------------------------------*

	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa,PrmNota)
	IF LSobjetivo = "ESCRITURACAO" or LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	*----------------------------------------------------------------*


	***********   LIBERAR STATUS DE PROCESSO EM EMPRESA *******
	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
	REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************
	UNLOCK ALL
    LScp1 = STR(PrmNota,7)
    DO OBJ_MENS.SPR WITH ;
    	   "    OK !! " + CHR(13)+CHR(13)+;
		   "    Cumpom cancelado na ECF e no REGISTRO "+chr(13)+;
		   " [ "+LScp1+" ]"
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ4D           NFCancTEF VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   16    
*        Variable:            NFCancTEF                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      110                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj4d     &&  NFCancTEF VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFCancTEF
PARAMETERS PrmEmpresa,PrmNota
	PRIVATE  Flg_aceita,LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr
	STORE 0  TO  LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr

	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF
		
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***

	=W_DEFPROC("ECF.spr")
	LNcupom = INT(ECFnrocupom())
	IF LNcupom = 0
   		DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+chr(13)+;
		   "  A ECF esta Retornando Numero de CUPOM = ZERO." +;
		   "Verifique <STATUS>. Verifique <Numero do Cupom>. "+;
		   "Verifique <RESET>. Se Persistir Contacte SUPORTE."
	    SELE orcament
		RETURN(.F.)
	ENDIF

	SELE nota


  	IF (nota.cupom+1) = LNcupom OR;
	   (nota.cupom)   = LNcupom
		  Flg_aceita = .T.
 	ELSE
		  Flg_aceita = .F.
	ENDIF

							
	IF !Flg_aceita
	   LScp1 = STR(PrmNota,7)
	   LScp2 = STR(nota.cupom,7)
	   LScp3 = STR(LNcupom,7)
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				   "      O numero de DOCUMENTO ["+LScp1+;
				   "] informado p/ cancelamento "+;
				    "esta relacionado ao CUPOM ["+LScp2+;
				    " ] sendo que o ultimo CUPOM localizado pelo "+;
				    "sistema e  ["+LScp3+"]"+;
				    chr(13)+"   Verifique os dados e tente novamente."
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	=W_DEFPROC("ORCAMENT.SPR")
	=ORVlr_e_FormPgto(nota.Empresa,;
				  nota.Referencia,;
				  LNCheque1Vlr,;
				  LNDinheiroVlr,;
				  LNCartaoVlr)

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Reg. Cupom Nao Pode ser Bloqueado Para Cancelamento.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	************************************************	
	LSstatus=ECFcanccpm(nota.cupom,LNCartaoVlr)

	IF SUBS(LSstatus,7,1) = "E"
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
		   "      A impressora fiscal nao acatou o cancelamento."+;
		   "Repita o processo e se persistir a negacao entre "+;
		   " em contato com suporte informando o menssagem : "+;
		    LSstatus
	   SELE orcament
	   RETURN(.f.)
	ENDIF			







	CLEAR TYPEAHEAD
	SELE  NOTA
	SCATTER MEMVAR

	*-----------------------------------------------------------*
	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*


	*----------------------------------------------------------------*

	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa,PrmNota)
	IF LSobjetivo = "ESCRITURACAO" or LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	*----------------------------------------------------------------*





	***********   LIBERAR STATUS DE PROCESSO EM EMPRESA *******
	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
	REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************
	UNLOCK ALL
    LScp1 = STR(PrmNota,7)
    DO OBJ_MENS.SPR WITH ;
    	   "    OK !! " + CHR(13)+CHR(13)+;
		   "    Cumpom cancelado na ECF e no REGISTRO "+chr(13)+;
		   " [ "+LScp1+" ]"
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ58           NFCancNCN VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   17    
*        Variable:            NFCancNCN                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      111                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj58     &&  NFCancNCN VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFCancNCN
PARAMETERS PrmEmpresa,PrmNota
	PRIVATE  Flg_aceita,LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr
	STORE 0  TO  LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr

	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF
		
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***

	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Reg. Cupom Nao Pode ser Bloqueado Para Cancelamento.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	*-----------------------------------------------------------*

	LSstatus=ECFcanccpm(nota.cupom,0)

	*-----------------------------------------------------------*

	CLEAR TYPEAHEAD
	SELE  NOTA
	SCATTER MEMVAR
	*-----------------------------------------------------------*
	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*




	*----------------------------------------------------------------*

	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa,PrmNota)
	IF LSobjetivo = "ESCRITURACAO" or LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	*----------------------------------------------------------------*



	***********   LIBERAR STATUS DE PROCESSO EM EMPRESA *******
	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
	REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************
	UNLOCK ALL
    LScp1 = STR(PrmNota,7)
    DO OBJ_MENS.SPR WITH ;
    	   "    OK !! " + CHR(13)+CHR(13)+;
		   "    Cumpom cancelado na ECF e no REGISTRO "+chr(13)+;
		   " [ "+LScp1+" ]"
RETURN(.t.)

****************************************************************************

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ5P           NFCanCopias VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   18    
*        Variable:            NFCanCopias                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      112                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj5p     &&  NFCanCopias VALID
#REGION 4
return
*---------------------------------------------------------------*


FUNCTION NFCanCopias
PARAMETER PrmEmpresa, PrmNota

	PRIVATE LNnroReferencia

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND()
		RETURN(.F.)
	ENDIF

	IF nota.tipo = "CPM"
		LNnroReferencia = nota.referencia	
	ELSE
		LNnroReferencia = nota.nota	
	ENDIF



	LFretorno = .T.

	SET ORDER TO TAG referencia
	SEEK STR(PrmEmpresa,3)+STR(LNnroReferencia,7)
	DO WHILE !EOF() AND PrmEmpresa   = nota.empresa ;
	                AND LNnroReferencia =  nota.referencia
			IF nota.tipo <> "CPM"
				SKIP
				LOOP
			ENDIF

			*-------------------------------------------------------*

			PRIVATE LSobjetivo
			LSobjetivo = NFDefCancDFis(PrmEmpresa, nota.nota)
			IF LSobjetivo = "CANCELAMENTO"
				IF !(NF_CancDFis(PrmEmpresa, nota.nota, LSobjetivo ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+;
				   CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao acatou"+;
					" o cancelamento."+;
			        " Repita o processo e se persistir a negacao entre "+;
				    " em contato com suporte"

					LFretorno = .F.
					EXIT

					*SELE NOTA
					*SKIP
					*LOOP
				ENDIF
			ENDIF


			*------------------------------------------------------------*
	



		    m.status = 2
			=RLOCK()
			***************************
			SELE nota
			SET FIELDS TO dtregis, hregis, usrregis,deletado
		    SET FIELDS TO status
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
			***************************

			*-------------------------------------------------------*

			IF LSobjetivo = "ESCRITURACAO"
				IF !(NF_CancDFis(PrmEmpresa, nota.nota, LSobjetivo ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao acatou"+;
					" o cancelamento."+;
				     " Repita o processo e se persistir a negacao entre "+;
				     " em contato com suporte"

					LFretorno = .F.
					EXIT

					*SELE NOTA
					*SKIP
					*LOOP
				ENDIF
			ENDIF


			*------------------------------------------------------------*


			SELE NOTA
			SKIP
	ENDDO
	***************************
	UNLOCK ALL
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ5Q           NFCancNfSrv VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   19    
*        Variable:            NFCancNfSrv                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      113                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj5q     &&  NFCancNfSrv VALID
#REGION 4
return
*---------------------------------------------------------------*

********************
FUNCTION NFCancNfSrv
PARAMETERS PrmEmpresa,PrmNota
	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF
		
		***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF nota.data <> wp_dtoper
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
		   "      A Nota Fiscal informada para cancelamento "+;
		   "nao pertence a data de hoje. Esta operacao so "+;
		   " e permitida em caso de intervencao do suporte."
			wp_msg = 'Usuario Suporte...'
		BTMP   =  'usuario.retroacao = "S"'
		LNusr_ret = 0
		DO obj_prmt.SPR WITH   wp_msg , Btmp
		IF LNusr_ret =  0
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF	
	SCATTER MEMVAR

	*----     CACELANDO DOCUMENTO FISCAL        -------*	

	*-------------------------------------------------------*
	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa, PrmNota)
	IF LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa, PrmNota, LSobjetivo ))
			   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
  	   	   RETURN(.f.)
		ENDIF
	ENDIF			
    *---------------------------------------------------------*

	*-----------------------------------------------------------*
	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*

	*-------------------------------------------------------*
	IF LSobjetivo = "ESCRITURACAO"
		IF !(NF_CancDFis(PrmEmpresa, PrmNota, LSobjetivo ))
			   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
  	   	   RETURN(.f.)
		ENDIF
	ENDIF			
    *---------------------------------------------------------*



	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPSRV 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************
	UNLOCK ALL
    SELE orcament
RETURN(.t.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ6R           NFCtrlCancFatura VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   20    
*        Variable:            NFCtrlCancFatura                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      114                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj6r     &&  NFCtrlCancFatura VALID
#REGION 4
return
*---------------------------------------------------------------*
FUNCTION NFCtrlCancFatura
PARAMETERS 	LNemp, LNnota, LStp_proc
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Controlar o Cancelamento de NF/Cupons Vinculados
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNnota.........: Nro da Nota para Cancelar
	*		LStp_proc......: "NORMAL"
	*	     				 "AUTOMATICO"
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .F. ou .T.
	*		
	*------------------------------------------------------------*
	* EXEMPLO : SCGC004
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE TmpRefOsi
	PRIVATE LNMarcaRegNota


	IF TYPE("LStp_proc") <> "C"
		LStp_proc = "NORMAL"
	ENDIF


	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota,7)

	IF !FOUND()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Nao Localizado "+;
	   		"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF


	*------------------------------------------------------------*
	*   Verificar se as duplicatas estao em condicao de cancelamento
	*------------------------------------------------------------*
	=W_DEFPROC("DUPLICAT.spr")
	IF !CRAtrzcancdupl((LNemp),(nota.orcamento))
		   WAIT WINDOW ;
		   "Duplicata com Vlr. Pago nao permitem cancelamento <ENTER>"
	   RETURN(.f.)
	ENDIF
	
	*------------------------------------------------------------*
	* Inicio cancelamento copias vinculadas
	*------------------------------------------------------------*

	LNnroRegCupom  = 0
	SELE nota
*	=NFCanCopias(LNemp,LNnota)


	* Qdo um cupom for cancelado suas copias tambem devem ser canceladas
	*------------------------------------------------------------*
	* Inicio cancelamento normal
	*------------------------------------------------------------*
	

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota,7)

	IF !FOUND()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Nao Localizado "+;
	   		"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF


	IF !REGLOCK()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Esta Aberto Para Outro Usuario. "+;
   			"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF

	TmpRefOsi = nota.referencia
	
	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(TmpRefOsi,6)
	IF FOUND()
		IF !REGLOCK()
			IF LStp_proc =  "NORMAL"
				WAIT WINDOW ;
					"O Orc.Ref. a Nota Esta Aberto Para Outro Usuario. "+;
				   	"Tente Novamente <ENTER>"
			ENDIF
			RETURN(.f.)
		ENDIF
	ENDIF

	*-------------------------------------------------------------------
	* POR DESCARACTERZAR A NOTA O PROCESSO (IF) SEGUINTE E TIDO COMO
	*-------------------------------------------------------------------
	* UM PROCESSO COMPLEMENTAR DE CANCELAMENTO A SER EXECUTADO SOMENTE QDO.
	* O CANCELAMENTO NORMAL JA FOI EXECUTADO
	*-------------------------------------------------------------------
	
	SELE NOTA	
	IF  nota.tipo = "ENT"
	    m.status = 2
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado,status
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
		UNLOCK ALL
		RETURN(.t.)
	ENDIF

	DO WHILE !BOF() AND LNemp   = nota.empresa ;
	                AND TmpRefOsi =  nota.referencia
		SELE NOTA
		SKIP -1
	ENDDO

	IF !BOF()
		SKIP
	ENDIF
	
	DO WHILE !EOF() AND LNemp   = nota.empresa ;
	                AND TmpRefOsi =  nota.referencia

		LNMarcaRegNota = RECNO()
		=NFCancFatura(LNemp, nota.nota, LStp_proc)
		SELE nota
		SET ORDER TO TAG nota
		GO LNMarcaRegNota
		SKIP
	ENDDO


	*********************************
	* REABILITAR ORCAMENTO
	*********************************

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota,7)

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(nota.referencia,6)
	
	IF FOUND()
		=REGLOCK(.T.)
		SELE orcament
		m.situacao = orcament.situacao
		DO CASE
			CASE orcament.situacao = "OC"
									&& Fat. direto pelo faturista
    			m.situacao = 'A '&& Orcamento aberto estado inicial
			OTHERWISE
		    	m.situacao = 'o '    && Volta a osi para caixa

		ENDCASE
		REPLACE situacao WITH m.situacao
	ENDIF
	*********************************************************************
	SELE nota
	CLEAR FIELDS
	SET FIELDS OFF
	UNLOCK ALL
RETURN(.t.)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ7S           NFCancFatura VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   21    
*        Variable:            NFCancFatura                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      115                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj7s     &&  NFCancFatura VALID
#REGION 4
return
*---------------------------------------------------------------*
FUNCTION NFcancFatura
PARAMETERS 	LNemp, LNnota, LStp_proc
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Cancelar Nota Fiscal
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNnota.........: Nro da Nota para Cancelar
	*		LStp_proc......: "NORMAL"
	*	     				 "AUTOMATICO"
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .F. ou .T.
	*		
	*------------------------------------------------------------*
	* EXEMPLO : SCGC004
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LNosiNfReferencia

	IF TYPE("LStp_proc") <> "C"
		LStp_proc = "NORMAL"
	ENDIF

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota,7)

	IF !FOUND()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Nao Localizado "+;
	   		"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF

	IF !REGLOCK()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Esta Aberto Para Outro Usuario. "+;
   			"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF

	LNosiNfReferencia = nota.referencia

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNosiNfReferencia,6)
	IF FOUND()
		IF !REGLOCK()
			IF LStp_proc =  "NORMAL"
				WAIT WINDOW ;
					"O Orc.Ref. a Nota Esta Aberto Para Outro Usuario. "+;
				   	"Tente Novamente <ENTER>"
			ENDIF
			RETURN(.f.)
		ENDIF
	ENDIF
	*----- POR DESCARACTERZAR A NOTA O PROCESSO (IF) SEGUINTE E TIDO COMO
	* UM PROCESSO COMPLEMENTAR DE CANCELAMENTO A SER EXECUTADO SOMENTE QDO.
	* O CANCELAMENTO NORMAL JA FOI EXECUTADO
	*-------------------------------------------------------------------
	SELE nota
	IF  nota.tipo = "ENT"
	    m.status = 2
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
	    SET FIELDS TO status
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
		UNLOCK ALL
		RETURN(.t.)
	ENDIF
	SELECT  itemmov
	SET ORDER TO TAG itensnota
	SET NEAR ON
	SEEK STR(LNemp,3)+"S"+STR(LNnota,7)
	SET NEAR OFF
	************************************
	LFretorno = .t.  && SE .F. => TRANSACAO DEVE SER ABORTADA
	DO WHILE !eof() AND nota.nota     = itemmov.nota ;
					AND nota.empresa  = itemmov.empresa
			*---------------------------------------------------*
			*   Registros de SCA podem se misturar a ordem dos
			* registros de saidas comercias quando coincidirem
			* os numeros da SCA e da NFS. Pois as duas operacoes
			* sao de saida.
			*	A condicao abaixo evita que registro de tipos
			* distintos sejam confundidos.
			*---------------------------------------------------*
			IF nota.tipo  <> itemmov.tipo
				SKIP
				LOOP
			ENDIF
		    SKIP					&& PASSA PARA REGISTRAR O PROXIMO
			IF !EOF()
		   	   LNproximo  = RECNO()  && POR CAUSA DA DELECAO
			ELSE
			   LNproximo  = 0
			ENDIF
	        SKIP - 1				&&  VOLTA AO REG. DEVIDO
			IF !REGLOCK()
			   LFretorno = .f.
			   EXIT
			ENDIF
			IF !UNFbaixa_saldo()
			   LFretorno = .f.
			   EXIT
			ENDIF

			DO UNFdesfatura

	    	SELECT itemmov
			SET ORDER TO TAG itensnota
			IF LNproximo  > 0
				GO LNproximo && DEVIDO A DELECAO E PROCESS DE ATU_CMD
			ELSE
				EXIT
			ENDIF
	ENDDO
	SELE nota
	IF !LFretorno   && OPERACAO NAO FOI CONCLUIDA COM SUCESSO
		RETURN(.f.)
	ENDIF			
	********************************
	LNnota	= nota.nota

				
    *------------------------------------------------*
	* NOTIFICAR CANCELAMENTO AO SISTEMA DE CAIXA
    *   Quando um orcamento gerar mais de uma nota
    * o sistema so notificara o caixa quando a ultima
    * nota for cancelada
    *------------------------------------------------*
	=NFCnAvisoCaixa((LnEmp), (LNnota))
    *------------------------------------------------*

	*------------------------------------------*
	=W_DEFPROC("DUPLICAT.spr")
	=CRcancdupl((LNemp),(LNnota))
	*------------------------------------------*
	*----------------------------------------------------------------*
**	DO  NFCancBonus WITH (LNemp),(nota.referencia)
	*----------------------------------------------------------------*



	*********************************
	* REABILITAR ORCAMENTO
	*********************************
	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNosiNfReferencia,6)
	
	IF FOUND()
		=REGLOCK(.T.)
		IF !(orcament.qtdnfgerad - 1) < 1
			IF nota.status <> 2
				REPLACE qtdnfgerad WITH orcament.qtdnfgerad - 1
			ENDIF
		ENDIF

		IF nota.status <> 2
			SELE orcament
			REPLACE qtdnfgerad WITH orcament.qtdnfgerad - 1
			m.situacao = orcament.situacao
			IF orcament.qtdnfgerad < 1		&& ULTIMA NOTA DO ORCAMENTO
				DO CASE
					CASE orcament.situacao = "OC"
											&& Fat. direto pelo faturista
		    			m.situacao = 'A '&& Orcamento aberto estado inicial
					CASE (WP_ECF $ "SRIQ") ;
						AND LEFT(orcament.situacao,1) = "O"
						&&  ESTA USANDO ECF
				    	m.situacao = 'o '    && Volta a osi para caixa
					CASE LEFT(orcament.situacao,1) = "O" && Faturado
				    	m.situacao = 'M '  && Volta a osi impressa integral
				ENDCASE
				REPLACE situacao WITH m.situacao
			ENDIF
		ENDIF
	ENDIF
	*********************************************************************
	SELE nota
	m.status = 2
	***************************
	SET FIELDS TO dtregis, hregis, usrregis,deletado
	SET FIELDS TO status
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF

	IF orcament.qtdnfgerad > 0 AND nota.status = 2
		IF LStp_proc =  "NORMAL"
		    DO OBJ_ALER.SPR WITH ;
			   "O Orcamento Gerou Mais de Uma nota. Cancele Todas......"+;
			   CHR(13)+;
			   "So assim o Orcamento Sera Disponibilizado."
		ENDIF
	ENDIF
	UNLOCK ALL
RETURN(.t.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ8V           UNFbaixa_saldo VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   22    
*        Variable:            UNFbaixa_saldo                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      116                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj8v     &&  UNFbaixa_saldo VALID
#REGION 4
return
*---------------------------------------------------------------*
*********************************
PROCEDURE UNFbaixa_saldo  && VERIFICA POSSIBILIDADE DE  BAIXA  NO ESTOQUE
   IF itemmov.tp_mercad = 7  && SERVICO NAO NECESSITA SALDO
      RETURN .T.
   ENDIF
   IF LEFT(itemmov.codigo,4) = "9999"  && COMENTARIO NAO NECESSITA SALDO
      RETURN .T.
   ENDIF

   SELECT saldo
   SET ORDER TO TAG clas_saldo
   SEEK STR(LNemp,3)+itemmov.classifica+;
        STR(YEAR(nota.data),4)+;
        STR(MONTH(nota.data),2)
   IF !FOUND()
      WAIT WINDOW RTRIM(transform(itemmov.codigo,'@R &masc_codi'))+;
                   " nao foi aberto para movimentacao. Solicite abertura."
      RETURN .F.
   ENDIF
RETURN .T.



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ93           UNFdesfatura VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   23    
*        Variable:            UNFdesfatura                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      117                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj93     &&  UNFdesfatura VALID
#REGION 4
return
*---------------------------------------------------------------*
PROCEDURE UNFdesfatura
* se nao for localiza em orcatmp deve ser apagado em itemmov

   SELECT itemmov
   SET ORDER TO TAG movimento
   SELE itmanexo
   SET ORDER TO TAG movanexo
   SEEK STR(itemmov.empresa,3)+itemmov.codigo+;
			 DTOS(itemmov.data)+itemmov.hora+itemmov.tipo+;
			 STR(itemmov.nota,7)+STR(itemmov.ordem,3)
   IF FOUND()
		=REGLOCK(.T.)
		=edithand('APAGA')
   ENDIF
   SELE itemmov
   =REGLOCK(.T.)
   *-------------------------------------------------------------*
   *    Desfaturao  item em orcatmp
   *-------------------------------------------------------------*

   =ULatvitem(nota.empresa,nota.referencia,itemmov.ordem)

   m.codigo = itemmov.codigo
   *-------------------------------------------------------------*
   IF itemmov.qtde  = 0 				OR ;
   	  itemmov.tp_mercad = 7 			OR ;
      itemmov.situacao = "OC"  			OR ;
      !FOUND("ORCATMP")					&& (OC) Fat. direto sem reserva
      									&& SE NA ROTINA ULATVITEM NAO
      									&& TIVER ENCONTRADO ORCATMP
      									&& EXCLUI DO MOVIMENTO
			SELE itemmov
		   	=W_DEFPROC("moviment.spr")
			=MVCancelMvto(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e

   ELSE
		   **************** REABILITA RESERVA ANTERIOR AO FATURAMENTO *****
		   	SELE itemmov
		   	m.situacao = "M "
	   	   	m.operacao = 'RVPS'   && RESERVA/VENDA/PROCESSADA/
									  && APROVEITA O MOV. P/ RESERVA
	   	   	m.nota     = 0
		  	***************************
		   	SET FIELDS TO dtregis, hregis, usrregis,deletado
		   	SET FIELDS TO situacao,operacao,nota
		   	=edithand('REGRAVA')
		   	CLEAR FIELDS
		   	SET FIELDS OFF
		   	***************************
			SELE itemmov
		   	=W_DEFPROC("moviment.spr")
			=MVatu_cmd(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e
   ENDIF


RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ9J           ULatvitem VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   24    
*        Variable:            ULatvitem                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      118                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj9j     &&  ULatvitem VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION ULatvitem
	PARAMETERS LNemp,LNreferencia,LNordem

		*---------------------------------------------------------*
		*  Reativa o item de orcatmp vinculado ao item da nota
		* itemmov cancelado
		*---------------------------------------------------------*
		PRIVATE LSalias
		LSalias = ALIAS()

		SELECT  orcatmp
		SET ORDER TO TAG orcamento
		SEEK STR(LNemp,3)+STR(LNreferencia,6)+STR(LNordem,2)
		************************************
		IF FOUND()
	    	SELECT orcatmp
			DO CASE
				CASE orcatmp.situacao = "OC" && Fat direto pelo faturista
		    		m.situacao = 'A '        && OSI aberto estado inicial
				OTHERWISE
			    	m.situacao = 'o '    && Volta a osi para caixa
			ENDCASE


	*		DO CASE
	*			CASE orcatmp.situacao = "OC" && Fat direto pelo faturista
	*	    		m.situacao = 'A '        && OSI aberto estado inicial
	*			CASE (WP_ECF $ "SRIQ") AND LEFT(orcatmp.situacao,1) = "O"
	*				&&  ESTA USANDO ECF
	*		    	m.situacao = 'o '    && Volta a osi para caixa
	*			CASE LEFT(orcatmp.situacao,1) = "O" && Faturado
	*		    	m.situacao = 'M '    && Volta a osi impressa integral
	*		ENDCASE
*


			=REGLOCK(.T.)
			REPLACE situacao WITH m.situacao				
		ENDIF
		SELE &LSalias
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJ9V           NFEcfInforme VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   25    
*        Variable:            NFEcfInforme                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      119                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15dj9v     &&  NFEcfInforme VALID
#REGION 4
return
*---------------------------------------------------------------*
FUNCTION NFEcfInforme
PARAMETERS 	LNemp, LDdtini, LDdtFim, LNnroIni,LNnroFim,LNvalorTot,;
			LNicmsTot
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:   Colher informacoes referentes saidas regis-
	*			tradas em ECF
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LDdtini........: Data Inicial
	*		LDdtfim........: Data Final
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNnroIni.......: Numero do 1 Cupom Emitido
	*		LNnroFim.......: Numero do Ultimo Cupom Emitido
	*		LNvalorTot.....: Valor das Saidas Registradas em ECF
	*		LNicmsTot......: Valor do ICMS Registrado
	*------------------------------------------------------------*
	* EXEMPLO : SCGC220
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	LSalias = ALIAS()
	PRIVATE LSmsg
	PRIVATE LNicmCalc
	*------------------------------------------------------------*
	LNnroIni		= 	99999999
	LNnroFim		= 	0
	LNvalorTot		=	0
	LNicmsTot		=	0
	LNicmCalc		=	0


	SELE nota
	SET ORDER TO TAG data
	SET NEAR ON
	SEEK STR(LNemp,3)+DTOS(LDdtIni)
	SET NEAR OFF
	DO WHILE !EOF() AND LNemp = nota.empresa AND nota.data <= LDdtFim
		LSmsg = "Informacoes do ECF ... Data : "+DTOC(nota.data)+;
				" Nota : "+STR(nota.nota,7)
		WAIT WINDOW LSmsg NOWAIT				

		IF nota.cupom = 0 OR nota.tipo = "CPM"
			SKIP
			LOOP
		ENDIF

		IF nota.cupom > LNnroFim
			LNnroFim = nota.cupom
		ENDIF
		IF nota.cupom < LNnroIni
			LNnroIni = nota.cupom
		ENDIF
		IF nota.status <> 2 && NOTA CANCELADA
			LNvalorTot	=	LNvalorTot 	+ 	nota.total_nota
			*--------------------------------------------------------*
			*   O campo nota.vlr_icms nao era calculado ate o mes 7/2000
			* por isso adota-se o calculo do icms na linha abaixo
			* esse problema pode ser sanado calculando-se o VLR_ICMS para
			* todas as notas emitidas
			*--------------------------------------------------------*
	******	LNicmsTot	=	LNicmsTot	+	nota.vlr_icms		
			IF nota.base_icms > 0 ;
				AND nota.aliq_icms > 0 ;
				AND nota.vlr_icms = 0
					LNicmCalc = ROUND(nota.base_icms*nota.aliq_icms / 100,2)
			ELSE
					LNicmCalc 	=	nota.vlr_icms
			ENDIF
			LNicmsTot	=	LNicmsTot	+	LNicmCalc
		ENDIF
		SKIP
	ENDDO
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJAE           NFtot_nfs VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   26    
*        Variable:            NFtot_nfs                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      120                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djae     &&  NFtot_nfs VALID
#REGION 4
RETURN

FUNCTION NFtot_nfs
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Retornar o Valor Totadas das Nota emitidas
	*			em um periodo especifico
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Filial em que se deve apurar o valor
	*		LDt_ini........: Data inicial que se deve apurar o valor
	*		LDt_fim........: Data inicial que se deve apurar o valor
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o VALOR DAS NOTAS VALIDAS
	*------------------------------------------------------------*
	*  EXEMPLO.....:
	*------------------------------------------------------------*

PARAMETERS  LNemp, LDt_ini, LDt_fim
	PRIVATE LNtotal, LSalias
	PRIVATE LFnota
	LSalias			= ALIAS()
		
	=W_DEFPROC("rotinas.spr")
	LFnota	= NetArq("nota")
	IF (LFnota) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("nota" ,LFnota)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*---------------------------------------------------------------*	
	*	Valor total das notas nao canceladas
	*---------------------------------------------------------------*	
	LNtotal  = 0
	sele nota
	SET ORDER TO TAG data
	SET NEAR ON
	SEEK STR(LNemp,3)+DTOS(LDt_ini)
	SET NEAR OFF
	DO WHILE !EOF() AND nota.data  <= LDt_fim ;
					AND nota.empresa  = LNemp
			LNtotal 	=  LNtotal + nota.total_nota
			SKIP
	ENDDO

	=UP_fecha("nota" ,LFnota)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNtotal)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJAR           NFgeraBonus VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   27    
*        Variable:            NFgeraBonus                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      121                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _31z15djar     &&  NFgeraBonus VALID
#REGION 4
RETURN
*********************************************************************
*  NFgeraBonus.....: Gera Bonus
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Bonus
*                   Empresa
*                   Orcament
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

PROCEDURE NFGeraBonus
	
	PARAMETERS LNEmp,LNOrcamento
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE LFbonus,LForcamento,LFclienc,LFempresa,LForcatmp
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFbonus 	= NetArq("bonus")
	LForcamento = NetArq("Orcament")
	LFclienc    = NetArq("clienc")
	LFempresa   = NetArq("empresa")
	LForcatmp   = NetArq("orcatmp")
	IF (LFbonus+LFempresa+LForcamento+LFclienc+LForcatmp) > 100000
		=UP_fecha("bonus"  		,LFbonus )
		=UP_fecha("orcamento" 	,LForcamento )
		=UP_fecha("clienc" 		,LFclienc )
		=UP_fecha("empresa" 	,LFempresa)
		=UP_fecha("orcatmp" 	,LForcatmp)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF

    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

	*------------------------------------------------------------*
	*   O bonus so e gerado para varejo , Pessoa Fisica e que
	* Tenha o CPF informado e seja faturado apos  {31.12.2000}
	*------------------------------------------------------------*
	IF clienc.natu_cli <> 0  ;
		OR clienc.tp_pessoa <> 1 ;
		OR clienc.cliente = 0 ;
		OR orcament.dt_fat < {01.10.2000}
		
		=UP_fecha("bonus"  		,LFbonus )
		=UP_fecha("orcamento" 	,LForcamento )
		=UP_fecha("clienc" 		,LFclienc )
		=UP_fecha("empresa" 	,LFempresa)
		=UP_fecha("orcatmp" 	,LForcatmp)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF
	*----------------------------------------------------------------*
	wp_msg = "Gerando Bonus OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*

	m.empresa 	=	LNemp
	m.osi_origem=	LNorcamento
	m.cliente	=	clienc.cliente
	m.nf_origem	=	orcament.nota
	m.dt_emissao=	orcament.dt_fat
	m.valor		=   orcament.valor * empresa.Tx_Bonus / 100
	m.osi_aplica= 	0
	m.vlr_sldbns=   0
	*---------------------------------------------------------------*
	*   Em caso de ser utilizado bonus no orcamento sera feito um
	* levantamento do valor nao utilizado e este saldo e acrecentado
	* ao valor do novo bonus uma vez que o bonus utilizado e baixado
	* pelo fato de ter sido vinculado ao orcamento e nao pelo uso ou
	* nao do seu valor integral. Este Procedimento evita a criacao de
	* controle de conta corrente para saldo de bonus
	*---------------------------------------------------------------*
	IF orcament.bonus_serv > 0
		LNvlrBonusConsumido = 0
		SELE orcatmp
		SET ORDER TO TAG orcamento
		SET NEAR ON
		SEEK STR(LNemp,3)+STR(LNorcamento,6)
		SET NEAR OFF
		DO WHILE !EOF() AND LNemp = orcatmp.empresa ;
						AND LNorcamento = orcatmp.orcamento
			IF orcatmp.tp_mercad = 7 AND LEFT(orcatmp.situacao,1) = "O"
				LNvlrBonusConsumido = ;
							LNvlrBonusConsumido + orcatmp.desc_adici
			ENDIF
			SKIP
		ENDDO
		LNsldBonus	= orcament.bonus_serv - LNvlrBonusConsumido
		m.valor		= m.valor + LNsldBonus
		m.vlr_sldbns= LNsldBonus
	ENDIF
	
	IF m.valor > 0
		SELE bonus
		SET ORDER TO TAG osi_origem
		SEEK STR(LNemp,3)+STR(LNorcamento,6)
		IF !FOUND()
			=edithand('SAVE')
		ELSE
			=edithand('REGRAVA')
		ENDIF
	ENDIF
	*----------------------------------------------------------*
	=UP_fecha("bonus"  		,LFbonus )
	=UP_fecha("orcamento" 	,LForcamento )
	=UP_fecha("clienc" 		,LFclienc )
	=UP_fecha("empresa" 	,LFempresa)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
********************************************************************


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJBK           NFCancBonus VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   28    
*        Variable:            NFCancBonus                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      122                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _31z15djbk     &&  NFCancBonus VALID
#REGION 4
RETURN
*********************************************************************
*  NFCancBonus.....: Cancela Bonus
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Bonus
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

PROCEDURE NFCancBonus
	
	PARAMETERS LNEmp,LNOrcamento
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE LFbonus
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFbonus		= NetArq("bonus")
	IF (LFbonus) > 100000
		=UP_fecha("bonus"  ,LFbonus)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF

	*----------------------------------------------------------------*
	wp_msg = "Cancelando Bonus OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*
	SELE bonus
	SET ORDER TO TAG osi_origem
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	IF FOUND()
		=edithand('APAGA')
	ENDIF
	*----------------------------------------------------------*
	=UP_fecha("bonus"  ,LFbonus)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
********************************************************************


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJBY           NFVldPortFatura VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   29    
*        Variable:            NFVldPortFatura                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      123                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djby     &&  NFVldPortFatura VALID
#REGION 4
RETURN

*********************************************************************
*  NFVldPortFatura
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [****]
*---------------------------------------------------------------
*  OBJETIVO.......:  Validar o faturamento em uma determinada
*               forma de pagamento considerendo as combinacoes
*               entre Prmtp_parcela,PrmModo_pgto,PrmMoeda,PrmBanco
*---------------------------------------------------------------
*  COMENTARIO.....:  A empresa estabelece as regras para faturamento
*               atraves de combinacoes autorizadas entre :
*				Prmtp_parcela,PrmModo_pgto,PrmMoeda,PrmBanco
*
*---------------------------------------------------------------
*  PARAMETROS.....:
*             PrmTp_parcela:  01- A Vista
*                             02- Cheque Parcelado
*                             03- Duplicata Parcelada
*                             04- Cartao Parcelado
*                             05- Cartao a Vista
*                             06- Vendor Vista
*
*
*             PrmModo_Pgto    01- Entrada
*							  02- Restante
*
*		      PrmMoeda        00- Indiferente
*							  01- Dinheiro
*						      02- Cheque
*							  03- Duplicata
*                             04- Chq.Eletronico
*                             05- Cartao
*                             06- Vendor
*
*             PrmBanco     (Codigo do Portador)
*
*
*     Pela Combinacao dos parametros e possivel verificar se a
*   configuracao da fatura e aceita para determinado portador
*
*---------------------------------------------------------------
* RETORNO.........: .t.  ou .f.
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

FUNCTION NFVldPortFatura
PARAMETERS Prmtp_parcela,PrmModo_pgto,PrmMoeda,PrmBanco

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias, LFretorno
	LSalias = ALIAS()
	LFretorno  = .t.
	SELE pg_prmtd
	SET ORDER TO TAG pg_prmtd
	SEEK STR(PrmTP_PARCELA,1)+STR(PrmMODO_PGTO,1)+;
				STR(PrmMOEDA,2)+STR(PrmBANCO,3)
	IF !FOUND()
		LFretorno  = .f.
	ENDIF
	SELE &LSalias

RETURN(LFretorno)

********************************************************************


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJCD           NFConjNfRef VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   30    
*        Variable:            NFConjNfRef                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      124                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _31z15djcd     &&  NFConjNfRef VALID
#REGION 4
RETURN

FUNCTION NFConjNfRef
PARAMETERS PrmEmpresa,PrmReferencia


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PRIVATE LSAlias
	PRIVATE ARQ_Nota,ALS_Nota

	PRIVATE ARQ_Tmp1,ALS_Tmp1
	store "" to ARQ_tmp1,ALS_tmp1

	PRIVATE ARQ_Tmp2,ALS_Tmp2
	store "" to ARQ_tmp2,ALS_tmp2



	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*

	LSbase = wp_dirdat

	LSAlias = Alias()


    ARQ_Nota     = NetArqAgain(LSbase+"NOTA")
    ALS_Nota     = Alias()

	ARQ_tmp1=UPnometmp("EX1")
	ARQ_tmp2=UPnometmp("EX2")

	DO CASE
		CASE PrmReferencia < 1000000  && REFERENCIA  UMA OSI
			SELE &ALS_nota
			SET ORDER TO TAG REFERENCIA

			SET NEAR ON
			SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
			SET NEAR OFF

			IF PrmEmpresa <> empresa OR PrmReferencia <> referencia
				SKIP -1
			ENDIF

			WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

			COPY TO &ARQ_tmp1 WITH CDX ;
				WHILE EMPRESA = PrmEmpresa ;
				      AND REFERENCIA = PrmReferencia
			SELE 0
			USE &ARQ_tmp1
			ALS_tmp1 = ALIAS()
			SELECT  data, hora, status,nota,cupom,referencia,;
				tipo,total_nota,nome;
				FROM &ALS_tmp1 ;
				ORDER BY DATA,HORA ;
				INTO CURSOR EXTR_1

			*--------------------------------------------*
		    * Busca das copias de cupom
			*--------------------------------------------*
			SELE &als_tmp1

		    DO WHILE !EOF()
			  IF nota >= 1000000 AND nota <= 2000000
				PrmReferencia = nota
				SELE &ALS_nota
				SET ORDER TO TAG REFERENCIA

				SET NEAR ON
				SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
				SET NEAR OFF

				IF PrmEmpresa <> empresa OR PrmReferencia <> referencia
					SKIP -1
				ENDIF

				WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

			    =up_fecha("&ALS_Tmp2")
				COPY TO &ARQ_tmp2 WITH CDX ;
				WHILE EMPRESA = PrmEmpresa ;
				      AND REFERENCIA = PrmReferencia
				SELE 0
				USE &ARQ_tmp2
				ALS_tmp2 = ALIAS()
		
				SELECT * FROM EXTR_1;
					UNION;			
				SELECT  data, hora, status,nota,cupom,referencia,;
					tipo,total_nota,nome;
					FROM &ALS_tmp2 ;
					INTO CURSOR EXTR_1
		      ENDIF
			  SELE &ALS_TMP1
			  SKIP
		    ENDDO

		OTHERWISE
		*------------------------------------------------------------*	
		*CASE PrmReferencia >= 1000000 AND PrmReferencia <= 2000000
		*	                                && REFERENCIA  UM CUPOM
		*------------------------------------------------------------*	
			SELE &ALS_nota
			SET ORDER TO TAG REFERENCIA

			SET NEAR ON
			SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
			SET NEAR OFF

			IF PrmEmpresa <> empresa OR PrmReferencia <> referencia
				SKIP -1
			ENDIF

			WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

			COPY TO &ARQ_tmp1 WITH CDX ;
				WHILE EMPRESA = PrmEmpresa ;
				      AND REFERENCIA = PrmReferencia
			SELE 0
			USE &ARQ_tmp1
			ALS_tmp1 = ALIAS()
			SELECT  data, hora, status,nota,cupom,referencia,;
				tipo,total_nota,nome;
				FROM &ALS_tmp1 ;
				INTO CURSOR EXTR_1

			*--------------------------------------------*
		    * Busca das OUTRAS NOTAS
			*--------------------------------------------*
			SELE &als_tmp1

		    DO WHILE !EOF()
			  IF nota < 1000000 OR  nota > 2000000


				PrmReferencia = referencia
				SELE &ALS_nota
				SET ORDER TO TAG NOTA
				
				SET NEAR ON
				SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
				SET NEAR OFF

				IF PrmEmpresa <> empresa OR PrmReferencia <> nota
					SKIP -1
				ENDIF

				IF PrmEmpresa <> empresa OR PrmReferencia <> nota
					exit
				endif

				PrmReferencia = referencia
				SELE &ALS_nota
				SET ORDER TO TAG REFERENCIA

				SET NEAR ON
				SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
				SET NEAR OFF

				IF PrmEmpresa <> empresa OR PrmReferencia <> referencia
					SKIP -1
				ENDIF


				WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

			    =up_fecha("&ALS_Tmp2")
				COPY TO &ARQ_tmp2 WITH CDX ;
				WHILE EMPRESA = PrmEmpresa ;
				      AND REFERENCIA = PrmReferencia
				SELE 0
				USE &ARQ_tmp2
				ALS_tmp2 = ALIAS()
		
				SELECT * FROM EXTR_1;
					UNION;			
				SELECT  data, hora, status,nota,cupom,referencia,;
					tipo,total_nota,nome;
					FROM &ALS_tmp2 ;
					INTO CURSOR EXTR_1
		      ENDIF
			  SELE &ALS_TMP1
			  SKIP
		    ENDDO

	ENDCASE

	SELECT * FROM EXTR_1;
			ORDER BY DATA,HORA ;
			INTO CURSOR EXTR_1

    SELE EXTR_1

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ REFERENCIAS EQUIVALENTES PARA NF ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF

	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			STATUS,;
			NOTA		:H="DOC Fiscal" :R,;
			TIPO,;
			CUPOM,;
			REFERENCIA,;
			TOTAL_NOTA 	:H="VALOR"	:P="@r #######9.99" :R,;
			NOME  ;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_nota")
    =up_fecha("EXTR_1")
    =up_fecha("EXTR_2")
    =up_fecha("&ALS_Tmp1")
    =up_fecha("&ALS_Tmp2")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJDT           NFDMSVer20 VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   31    
*        Variable:            NFDMSVer20                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      125                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djdt     &&  NFDMSVer20 VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFDMSVer20
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")

    PRIVATE LSalias
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Nota,ALS_Nota

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_nota  = NetArqAgain("NOTA")
    ALS_nota  = Alias()


	SELE &ALS_Nota
	SET ORDER TO TAG DATA

	SELE &ALS_Empresa
	SET ORDER TO TAG EMPRESA

	SELE 0
   	USE Q:\SCGC\COMUM\DMS  EXCL

	SELE DMS
    ZAP
	PACK

	SELE &ALS_Empresa
	seek PrmEmpresa


	LNempresa   = PrmEmpresa
    LDataInicio = PrmDataInicio
   	LDataFinal  = PrmDataFinal
   	LSPeriodo   = STR(YEAR(LDataFinal),4)+Str(Month(LDataFinal),2)
	LSPeriodo   = STRTRAN(LSPeriodo," ", "0")
   	LSExtensao  = SUBS(LSPeriodo,3,2)+".D"+SUBS(LSPeriodo,5,2)


    LNinscr_Muni = STRTRAN( &ALS_Empresa .insc_munic,".","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni," ","0")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"-","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"/","")
    LNinscr_Muni = Left(LNinscr_Muni,7)
   	LNAIDF    = &ALS_Empresa .AIDF
	LNANOAIDF = &ALS_Empresa .ANOAIDF
    LNMODISS  = &ALS_Empresa .MODISS
    LScidade  = &ALS_Empresa .cidade
	LSarqDst  = "Q:\SCGC\DMS\"+;
	            LEFT(LNinscr_Muni,6)+LSExtensao  && INSC+AA+.D MM



    LsTipo       = "H"

	sele dms

    LsEmpresa    = LEFT( &ALS_Empresa .nome + SPACE(50),50)
   	LsCNPJ       = strtran(str( &ALS_Empresa .cgc,14)," ","0")
    LsDMSNegativa= "N"
	LsEspaco     = space(83)
	LsData       = DTOS(DATE())
	LsEmail      = LEFT("deptofiscal@pneulandia.com.br"+space(35),35)
   	LsVersao     = "V.2.0"
	LsEspaco2     = space(35)

   	LScabecalho =   LsTipo+LNinscr_Muni+LSPeriodo+LsEmpresa+;
    		 LsCNPJ+ LsDMSNegativa+LsEspaco+LsData+LsEmail+;
    		 LsVersao+LsEspaco2
	APPEND BLANK
	REPLACE dms with  LScabecalho

*-------------------------------------------------------------*


	SET TALK ON

	=W_DEFPROC("nota.spr")
	TmpCrs = NFSqlDMS(LNEmpresa, LDataInicio, LDataFinal)

    SELECT * FROM &TmpCrs ;
    INTO CURSOR TMPNOTA ;
	ORDER BY EMPRESA,DATA,NOTA




   	SELECT "D" AS identif,SPACE(4) AS espaco1,;
       strtran(str(nota,10)," ","0") AS NOTA,;
       strtran(str(LNAIDF,7)," ","0") AS AIDF,;
        strtran(str(LNANOAIDF,4)," ","0") AS ANOAIDF,;
        strtran(str(YEAR(data),4)," ","0")  AS ANONF,;
        strtran(str(MONTH(data),2)," ","0") AS MESNF,;
        strtran(str(DAY(data),2)," ","0") AS DIANF,;
       strtran(str(LNMODISS,1)," ","0") AS MODISS,;
		   IIF(status = 2  ,"1","0") AS sitnf,;
		   LEFT(nome+space(50),50) AS nome,;
		   IIF(tp_pessoa = 1,"F","J") AS tp_pess,;
		   strtran(str(Favorecido,14)," ","0") AS favo,;		   	
		   IIF(cidade = LScidade,"1","0") AS CIDADE,;
		   LEFT(cidade+space(25),25)	AS cidtomad,;
 	       strtran(str(INT(base_iss*100),13)," ","0") AS baseiss,;
 	       strtran(str(INT(totSERVICO*100),13)," ","0") AS vlrnf,;
 	       strtran(str(INT(aliq_iss*100),4)," ","0") AS aliqiss,;
 	       strtran(str(INT(vlr_iss*100),13)," ","0") AS vlriss,;
 	       SPACE(88)  AS espaco2;
	 	from &TmpCrs ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_B1


	SELECT * FROM DMS_B1 ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_D


	SET TALK OFF

 	SELE DMS_D
   	COPY TO  L:\TMP\DMS_D  TYPE SDF
 	
    SELECT DMS
	APPEND FROM L:\TMP\DMS_D.TXT TYPE SDF

	 *-----------------------------------------------------------*

	count to LsQtde
	LsQtde = LsQtde - 1
	GO TOP
	
    LsTipo  = "T"
   	LsQtde  =  strtran(str(LsQtde,4)," ","0")
   	LSEspaco= space(240)

    LStotal =   LsTipo+LsQtde+Lsespaco
	APPEND BLANK
	REPLACE dms with  LStotal
	
	GO TOP
	COPY TO &LSarqDst TYPE SDF
	USE
	
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	SET TALK OFF
RETURN(.T.)
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJEO           NFSqlDMS VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   32    
*        Variable:            NFSqlDMS                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      126                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djeo     &&  NFSqlDMS VALID
#REGION 4
return
*---------------------------------------------------------------*
*  Esta rotina gera um CURSOR com dados de prestacao de servico
* que sera utilizado na emissao do RELATORIO DE PRESTACAO DE SER-
* VICO  e NA GERACAO DO ARQUIVO DMS para municipio
*---------------------------------------------------------------*
FUNCTION NFSqlDMS
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")

    PRIVATE LSalias
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Nota,ALS_Nota

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_nota  = NetArqAgain("NOTA")
    ALS_nota  = Alias()


	SELE &ALS_Nota
	SET ORDER TO TAG DATA


    SELECT * FROM &ALS_Nota NOTA ;
   	WHERE (nota.empresa = PrmEmpresa ;
   		AND nota.data >= m.PrmDataInicio ;
   		AND nota.data <= m.PrmDataFinal) ;
   		AND nota.ch_produ $ "1/5" ;
 	 		AND ((nota.base_iss > 0 AND nota.aliq_iss > 0 );
                OR (nota.status <> 1 AND nota.empresa = 10)) ;
    INTO CURSOR TMPNOTA ;
	ORDER BY EMPRESA,DATA,NOTA




	SELE &ALS_Empresa
	SET ORDER TO TAG EMPRESA
	seek PrmEmpresa


	*---------------------------------------------------------*
	*    Copias de cupons com servio. Serao utilizadas para
	*  atribuir o numero da NF Copia (CPM) ao cupom emitido
	*  pois para o municipio o doc. fiscal e a nf e nao o
	*  cupom. Como os dados de ISS estao no cupom sera feito
	*  um select entre CUPONS e NF copia relacionada onde o
	* numero do documento sera o da NF.copia
	*---------------------------------------------------------*

	SET TALK ON

   	SELECT STR(EMPRESA,3)+STR(REFERENCIA,7) AS NRO_CUPOM,;
   		empresa,nota,referencia,status, ;
        base_iss,;
 	    total_nota,;
		totservico,;
		totproduto,;
 	    aliq_iss,;
 	    vlr_iss;
	 	from TMPNOTA where empresa = PrmEmpresa;
 	       and tipo = "CPM";
 	       and data <=  PrmDataFinal ;
 	       and data >= PrmDataInicio ;
 	       and vlr_iss > 0;
 	    order by empresa,nota,referencia into cursor DMS_CPMs


	*---------------------------------------------------------*
	*    Seleciona todas notas que nao estao vinculadas a cupons
	*  em que constem servio.
	*  DOCUMENTO FISCAL = NOTA
	*  ==> A) NF COM SERVICO NAO VINCULADAS A CUPONS
	*---------------------------------------------------------*

   	SELECT ;
	   empresa,;
	   operacao,;
   	   nota,;
	   cupom,;
       data,;
   	   status,;
	   nome,;
	   tp_pessoa,;
	   Favorecido,;		   	
	   cidade,;
	   NFmunidms(uf,cidade) AS MUNI_DMS,;
       base_iss,;
 	   total_nota,;
	   totservico,;
	   totproduto,;
 	   aliq_iss,;
 	   vlr_iss;
 	from TMPNOTA where empresa = PrmEmpresa;
       and tipo <> "CPM" ;
       and (nota < 1000000 or nota >= 2000000);
       and data <=  PrmDataFinal ;
       and data >= PrmDataInicio and vlr_iss > 0;
    into cursor DMS_A1

	*---------------------------------------------------------*
	*    Nos cupons para os quais foram emitidas copias
	*  o numero do documento assume o numero da NF copia
	*  DOCUMENTO FISCAL = COPIA
	*  ==> B) COPIAS DE CUPONS COM SERVICO
	*---------------------------------------------------------*
   	SELECT ;
		NF.empresa,;
	    NF.operacao,;
   		CPM.nota,;
		NF.cupom,;
   	    NF.data,;
   	    CPM.status,;
	    NF.nome,;
	    NF.tp_pessoa,;
	    NF.Favorecido,;		   	
	    NF.cidade,;
	    NFmunidms(NF.uf,NF.cidade) AS MUNI_DMS,;
        CPM.base_iss,;
 	    CPM.total_nota,;
		CPM.totservico,;
		CPM.totproduto,;
 	    CPM.aliq_iss,;
 	    CPM.vlr_iss;
 	from TMPNOTA NF, DMS_CPMs CPM ;
	 	where NF.empresa = PrmEmpresa;
 	       and NF.tipo <> "CPM" ;
 	       and NF.empresa= CPM.empresa ;
 	       and NF.nota   = CPM.referencia ;
 	       and NF.nota > 1000000 ;
		   and NF.nota < 2000000 ;
 	       and NF.data <=  PrmDataFinal ;
 	       and NF.data >= PrmDataInicio ;
 	       and NF.vlr_iss > 0;
    into cursor DMS_A2

	*---------------------------------------------------------*
	*---------------------------------------------------------*
	*    Seleciona todos cupons que nao estao vinculadas a
	*  copias em NF  e  que constem servio.
	*  DOCUMENTO FISCAL = CUPOM
	*  ==> C) CUPONS NAO VINCULADOS A COPIAS EM NF
	*---------------------------------------------------------*

   	SELECT ;
	   empresa,;
	   operacao,;
   	   nota,;
	   cupom,;
       data,;
   	   status,;
	   nome,;
	   tp_pessoa,;
	   Favorecido,;		   	
	   cidade,;
	   NFmunidms(uf,cidade) AS MUNI_DMS,;
       base_iss,;
 	   total_nota,;
	   totservico,;
	   totproduto,;
 	   aliq_iss,;
 	   vlr_iss;
 	from TMPNOTA where empresa = PrmEmpresa;
       and nota > 1000000 ;
	   and nota < 2000000 ;
       and data <=  PrmDataFinal ;
       and data >= PrmDataInicio and vlr_iss > 0;
       and STR(EMPRESA,3)+STR(NOTA,7) ;
           not in (SELECT NRO_CUPOM from DMS_CPMs);
    into cursor DMS_A3



    SELECT * FROM  DMS_A1 ;
    UNION ;
    SELECT * FROM  DMS_A2 ;
    into cursor DMS_A4


    SELECT * FROM  DMS_A3 ;
    UNION ;
    SELECT * FROM  DMS_A4 ;
    into cursor DMS_A5


    SELECT * FROM  DMS_A5 ;
 	    order by NOTA into cursor DMS_A1

	SET TALK OFF
    *-----------------------------------------------------------*
	
	sele TMPNOTA
	USE

	sele DMS_A2
	USE

	sele DMS_A3
	USE

	sele DMS_A4
	USE

	sele DMS_A5
	USE

	
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	SET TALK OFF
RETURN("DMS_A1")
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJFX           NFView VALID                       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   33    
*        Variable:            NFView                             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      127                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djfx     &&  NFView VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFView
PARAMETER PrmFiltro

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	0
	*------------------------------------------------------------*
	PRIVATE VLleitura,VLlerfim,VLcompara,VLchvlimi, LNregvolta
	PRIVATE LStipo,LNnf, LNnroNF
	******>>>> INICIO CONTROLE ARQUIVOS
	*>> parametros repassados a btn_val
	VLleitura = "STR(wp_empresa,3)"
                         * repassa chave de leitura p/ btn_val
	VLlerfim  = "STR(wp_empresa+1,3)"
           * repassa chave de leitura p/ btn_val (POSICAO FINAL + 1 REG)

	IF TYPE("PrmFiltro") <> "C"
		PrmFiltro = ""
	ENDIF

	VLcompara = ;
	  "nota.empresa = wp_empresa "+PrmFiltro
                         * repassa chave de comparacao p/ btn_val
	VLchvlimi = "STR(wp_empresa,3)"
	*-----------------------------------------------------------------*
	SELE nota
	SET ORDER TO TAG ORDEM_EMI
	SET NEAR ON
	SEEK VLlerfim
	ON KEY LABEL ESCAPE
	DO loc_dlog WITH .T.,Vlcompara, VLchvlimi,.F.,.F., .F.
	LFretorno = 0
	IF lastkey() = 23
		LFretorno = RECNO()
	ENDIF
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	SET NEAR OFF
	

	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJGB           NF_aviso VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   34    
*        Variable:            NF_aviso                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      128                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djgb     &&  NF_aviso VALID
#REGION 4
return
*---------------------------------------------------------------*
FUNCTION NF_aviso
PARAMETERS PrmEmp,PrmNfinicio,PrmCtrlCpmIni,PrmSolicitante,PrmTp_Process

	private lndoc	
	LNDOC = 0

	IF PrmSolicitante <> "IMPORTACAO"
		DO CASE
    		CASE "CUPOM" $ PrmTp_Process
				LNDOC = PRMCtrlCpmIni
	    	CASE "NOTA" $ PrmTp_Process
				LNDOC = PRMnfinicio
		ENDCASE
	ENDIF

	*-------------------------------------------------*
	*  DEFINIR MENSAGEM AO OPERADOR
	*-------------------------------------------------*
	SELE nota
	SET ORDER TO TAG NOTA
	SEEK STR(PrmEmp,3)+STR(LNDoc,7)
    LSdef_msg  = ""
	do case
		case PrmSolicitante = "IMPORTACAO"
		   LSdef_msg  = ""
		case  nota.ch_opera $ "12" AND ;
			nota.ch_desti = "2"  AND ;
				EMPTY(ALLTRIM(nota.inscsubst)) AND ;
				nota.icms_subs > 0
			   LSdef_msg  = ;
				   	"Recolher Imposto N.F. "+STR(LNDOC,7)
		case  nota.ch_opera $ "2" AND ;
			  nota.ch_desti = "2"  AND ;
			  nota.uf = "TO" AND ;
			  nota.cfo = "6.152 "
			   LSdef_msg = "Recolher Imposto N.F. "+STR(LNDOC,7)
	ENDCASE
	IF LSdef_msg <> ""
	   wp_msg  = LSdef_msg
	   DO OBJ_ALER.SPR WITH  wp_msg
	ENDIF
	*----------------------------------------------------------------*
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJGN           NFDMSVer30 VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   35    
*        Variable:            NFDMSVer30                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      129                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djgn     &&  NFDMSVer30 VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFDMSVer30
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")

    PRIVATE LSalias
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Nota,ALS_Nota

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_nota  = NetArqAgain("NOTA")
    ALS_nota  = Alias()


	SELE &ALS_Nota
	SET ORDER TO TAG DATA

	SELE &ALS_Empresa
	SET ORDER TO TAG EMPRESA

	SELE 0
   	USE Q:\SCGC\COMUM\DMS  EXCL

	SELE DMS
    ZAP
	PACK

	SELE &ALS_Empresa
	seek PrmEmpresa


	LNempresa   = PrmEmpresa
    LDataInicio = PrmDataInicio
   	LDataFinal  = PrmDataFinal
   	LSPeriodo   = STR(YEAR(LDataFinal),4)+Str(Month(LDataFinal),2)
	LSPeriodo   = STRTRAN(LSPeriodo," ", "0")
   	LSExtensao  = SUBS(LSPeriodo,3,2)+".D"+SUBS(LSPeriodo,5,2)


    LNinscr_Muni = STRTRAN( &ALS_Empresa .insc_munic,".","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni," ","0")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"-","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"/","")
    LNinscr_Muni = Left(LNinscr_Muni,7)

   	LNAIDF    = &ALS_Empresa .AIDF
	LNANOAIDF = &ALS_Empresa .ANOAIDF
    LNMODISS  = &ALS_Empresa .MODISS
    LScidade  = &ALS_Empresa .cidade
	LSarqDst  = "Q:\SCGC\DMS\"+;
	            LEFT(LNinscr_Muni,6)+LSExtensao  && INSC+AA+.D MM



    LsTipo       = "H"

	sele dms

    LsEmpresa    = LEFT( &ALS_Empresa .nome + SPACE(50),50)

   	LsCNPJ       = strtran(str( &ALS_Empresa .cgc,14)," ","0")
    LsDMSNegativa= "N"
	LsEspaco     = space(83)
	LsData       = DTOS(DATE())
	LsEmail      = LEFT("deptofiscal@pneulandia.com.br"+space(35),35)
   	LsVersao     = "V.3.0"
   	LsTpDoc      = "NF   "
   	LsUltForm    = space(7)
	LsEspaco2    = space(23)

   	LScabecalho =   LsTipo+LNinscr_Muni+LSPeriodo+LsEmpresa+;
    		 LsCNPJ+ LsDMSNegativa+LsEspaco+LsData+LsEmail+;
    		 LsVersao+;
    		 LsTpDoc+;
    		 LsUltForm+;		
    		 LsEspaco2
	APPEND BLANK
	REPLACE dms with  LScabecalho

*-------------------------------------------------------------*


	SET TALK ON

	=W_DEFPROC("nota.spr")
	TmpCrs = NFSqlDMS(LNEmpresa, LDataInicio, LDataFinal)

    SELECT * FROM &TmpCrs ;
    INTO CURSOR TMPNOTA ;
	ORDER BY EMPRESA,DATA,NOTA




   	SELECT     "D" AS identif,;
        SPACE(4) AS espaco1,;
        strtran(str(nota,10)," ","0") AS NOTA,;
        strtran(str(LNAIDF,7)," ","0") AS AIDF,;
        strtran(str(LNANOAIDF,4)," ","0") AS ANOAIDF,;
        strtran(str(YEAR(data),4)," ","0")  AS ANONF,;
        strtran(str(MONTH(data),2)," ","0") AS MESNF,;
        strtran(str(DAY(data),2)," ","0") AS DIANF,;
        strtran(str(LNMODISS,1)," ","0") AS MODISS,;
	    IIF(status = 2  ,"1","0") AS sitnf,;
		LEFT(nome+space(50),50) AS nome,;
		IIF(tp_pessoa = 1,"F","J") AS tp_pess,;
		strtran(str(Favorecido,14)," ","0") AS favo,;		   	
		IIF(cidade = LScidade,"1","0") AS CIDADE,;
		LEFT(cidade+space(25),25)	AS cidtomad,;
 	    strtran(str(INT(base_iss*100),13)," ","0") AS baseiss,;
 	    strtran(str(INT(totSERVICO*100),13)," ","0") AS vlrnf,;
 	    strtran(str(INT(aliq_iss*100),4)," ","0") AS aliqiss,;
 	    "00"     AS atvddiss,;
 	    SPACE(86)  AS espaco2;
	 	from &TmpCrs ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_B1


	SELECT * FROM DMS_B1 ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_D


	SET TALK OFF

 	SELE DMS_D
   	COPY TO  L:\TMP\DMS_D  TYPE SDF
 	
    SELECT DMS
	APPEND FROM L:\TMP\DMS_D.TXT TYPE SDF

	 *-----------------------------------------------------------*

	count to LsQtde
	LsQtde = LsQtde - 1
	GO TOP
	
    LsTipo  = "T"
   	LsQtde  =  strtran(str(LsQtde,4)," ","0")
   	LSEspaco= space(240)

    LStotal =   LsTipo+LsQtde+Lsespaco
	APPEND BLANK
	REPLACE dms with  LStotal
	
	GO TOP
	COPY TO &LSarqDst TYPE SDF
	USE
	
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	SET TALK OFF
RETURN(.T.)
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJHJ           NFDMS VALID                        
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   36    
*        Variable:            NFDMS                              
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      130                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djhj     &&  NFDMS VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFDMS
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")



	DO CASE
		CASE PrmDataInicio < {01.08.2009}
			=NFDMSVer30(PrmEmpresa, PrmDataInicio, PrmDataFinal)
		OTHERWISE
			=NFDMSVer40(PrmEmpresa, PrmDataInicio, PrmDataFinal)
	ENDCASE

RETURN(.T.)
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJHS           NFDMSVer40 VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   37    
*        Variable:            NFDMSVer40                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      131                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djhs     &&  NFDMSVer40 VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFDMSVer40
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")

    PRIVATE LSalias
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Nota,ALS_Nota

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_nota  = NetArqAgain("NOTA")
    ALS_nota  = Alias()


	SELE &ALS_Nota
	SET ORDER TO TAG DATA

	SELE &ALS_Empresa
	SET ORDER TO TAG EMPRESA

	SELE 0
   	USE Q:\SCGC\COMUM\DMS  EXCL

	SELE DMS
    ZAP
	PACK

	SELE &ALS_Empresa
	seek PrmEmpresa


	LNempresa   = PrmEmpresa
    LDataInicio = PrmDataInicio
   	LDataFinal  = PrmDataFinal
   	LSPeriodo   = STR(YEAR(LDataFinal),4)+Str(Month(LDataFinal),2)
	LSPeriodo   = STRTRAN(LSPeriodo," ", "0")
   	LSExtensao  = SUBS(LSPeriodo,3,2)+".D"+SUBS(LSPeriodo,5,2)


    LNinscr_Muni = STRTRAN( &ALS_Empresa .insc_munic,".","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni," ","0")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"-","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"/","")
    LNinscr_Muni = Left(LNinscr_Muni,7)

   	LNAIDF    = &ALS_Empresa .AIDF
	LNANOAIDF = &ALS_Empresa .ANOAIDF
    LNMODISS  = &ALS_Empresa .MODISS
    LScidade  = &ALS_Empresa .cidade
	LSarqDst  = "Q:\SCGC\DMS\"+;
	            LEFT(LNinscr_Muni,6)+LSExtensao  && INSC+AA+.D MM



    LsTipo       = "H"

	sele dms

    LsEmpresa    = LEFT( &ALS_Empresa .nome + SPACE(50),50)

   	LsCNPJ       = strtran(str( &ALS_Empresa .cgc,14)," ","0")
    LsDMSNegativa= "N"
	LsEspaco     = space(83)
	LsData       = DTOS(DATE())
	LsEmail      = LEFT("deptofiscal@pneulandia.com.br"+space(35),35)
   	LsVersao     = "V.4.0"
   	LsTpDoc      = "NF   "
   	LsUltForm    = space(7)
	LsEspaco2    = space(23)

   	LScabecalho =   LsTipo+LNinscr_Muni+LSPeriodo+LsEmpresa+;
    		 LsCNPJ+ LsDMSNegativa+LsEspaco+LsData+LsEmail+;
    		 LsVersao+;
    		 LsTpDoc+;
    		 LsUltForm+;		
    		 LsEspaco2
	APPEND BLANK
	REPLACE dms with  LScabecalho

*-------------------------------------------------------------*


	SET TALK ON

	=W_DEFPROC("nota.spr")
	TmpCrs = NFSqlDMS(LNEmpresa, LDataInicio, LDataFinal)

    SELECT * FROM &TmpCrs ;
    INTO CURSOR TMPNOTA ;
	ORDER BY EMPRESA,DATA,NOTA




   	SELECT     "D" AS identif,;
        SPACE(4) AS espaco1,;
        strtran(str(nota,10)," ","0") AS NOTA,;
        strtran(str(LNAIDF,7)," ","0") AS AIDF,;
        strtran(str(LNANOAIDF,4)," ","0") AS ANOAIDF,;
        strtran(str(YEAR(data),4)," ","0")  AS ANONF,;
        strtran(str(MONTH(data),2)," ","0") AS MESNF,;
        strtran(str(DAY(data),2)," ","0") AS DIANF,;
        strtran(str(LNMODISS,1)," ","0") AS MODISS,;
	    IIF(status = 2  ,"1","0") AS sitnf,;
		LEFT(nome+space(50),50) AS nome,;
		IIF(tp_pessoa = 1,"F","J") AS tp_pess,;
		strtran(str(Favorecido,14)," ","0") AS favo,;		   	
        SPACE(26) AS espaco2,;
 	    strtran(str(INT(base_iss*100),13)," ","0") AS baseiss,;
 	    strtran(str(INT(totSERVICO*100),13)," ","0") AS vlrnf,;
 	    strtran(str(INT(aliq_iss*100),4)," ","0") AS aliqiss,;
 	    "00"     AS atvddiss,;
	    strtran(str(MUNI_DMS,6)," ","0") AS MUNI_DMS,;
 	    SPACE(80)  AS espaco3;
	 	from &TmpCrs ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_B1



	SELECT * FROM DMS_B1 ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_D


	SET TALK OFF

 	SELE DMS_D
   	COPY TO  L:\TMP\DMS_D  TYPE SDF
 	
    SELECT DMS
	APPEND FROM L:\TMP\DMS_D.TXT TYPE SDF

	 *-----------------------------------------------------------*

	count to LsQtde
	LsQtde = LsQtde - 1
	GO TOP
	
    LsTipo  = "T"
   	LsQtde  =  strtran(str(LsQtde,4)," ","0")
   	LSEspaco= space(240)

    LStotal =   LsTipo+LsQtde+Lsespaco
	APPEND BLANK
	REPLACE dms with  LStotal
	
	GO TOP
	COPY TO &LSarqDst TYPE SDF
	USE
	
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	SET TALK OFF
RETURN(.T.)
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJIW           NFmunidms VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   38    
*        Variable:            NFmunidms                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      132                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djiw     &&  NFmunidms VALID
#REGION 4
return
*---------------------------------------------------------------*
FUNCTION NFmunidms
PARAMETERS PrmUf, PrmCidade
PRIVATE LNretorno

    WAIT WINDOW PrmUf + "-" +PrmCidade NOWAIT

	=W_DEFPROC("DMSMUNI.spr")
    LNretorno=DMNGet_MUNIDMS(PrmUf, PrmCidade)



RETURN(LNretorno)
	






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJJS           NFCanNFCopia VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_A,     Record Number:   39    
*        Variable:            NFCanNFCopia                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      133                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djjs     &&  NFCanNFCopia VALID
#REGION 4
return
*---------------------------------------------------------------*


FUNCTION NFCanNFCopia
PARAMETER PrmEmpresa, PrmNota

	PRIVATE LNnroReferencia

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND() or nota.tipo <> "CPM"
		RETURN(.F.)
	ENDIF

	LFretorno = .T.
	DO WHILE !EOF() AND PrmEmpresa   = nota.empresa ;
	                AND PrmNota      = nota.nota
			IF nota.tipo <> "CPM"
				SKIP
				LOOP
			ENDIF
			*-------------------------------------------------------*
			PRIVATE LSobjetivo
			LSobjetivo = NFDefCancDFis(PrmEmpresa, PrmNota)
			IF LSobjetivo = "CANCELAMENTO"
				IF !(NF_CancDFis(PrmEmpresa, PrmNota, LSobjetivo ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!";
				    +CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao "+;
					"acatou o cancelamento."+;
				     " Repita o processo e se persistir a negacao entre "+;
				     " em contato com suporte"
						SELE NOTA
					
					LFretorno = .F.
					EXIT


					*SKIP
					*LOOP

				ENDIF
			ENDIF
			*-------------------------------------------------------*

		    m.status = 2
			=RLOCK()
			***************************
			SET FIELDS TO dtregis, hregis, usrregis,deletado
		    SET FIELDS TO status
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
			***************************


			*-------------------------------------------------------*
			IF LSobjetivo = "ESCRITURACAO"
				IF !(NF_CancDFis(PrmEmpresa, PrmNota, LSobjetivo ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!";
				    +CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao "+;
					"acatou o cancelamento."+;
				     " Repita o processo e se persistir a negacao entre "+;
				     " em contato com suporte"
						SELE NOTA

					LFretorno = .F.
					EXIT


					*SKIP
					*LOOP
				ENDIF
			ENDIF
			*-------------------------------------------------------*

			SELE NOTA
			SKIP
	ENDDO
	***************************
	UNLOCK ALL
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJKB           NFRot_Fat VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_B,     Record Number:    2    
*        Variable:            NFRot_Fat                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      134                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djkb     &&  NFRot_Fat VALID
#REGION 5
return

*---------------------------------------------------------------*

FUNCTION  NFrot_fat
	PARAMETERS  LSsolicitante,LSemcaminhar
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Controla o processo de Faturamento
	*				Esta e a primeira instancia de rotinas para
	*				FATURAMENTO/PREPARACAO
	*------------------------------------------------------------*
	* COMENTARIO..: A rotina serve a dois objetivos
	*				1- Preparacao para  Faturamento
	*				2- Preparacao e  Faturamento
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS AMBIENTAIS..:
	*					LNecf.......: Nro da Conexao aberta com
	*							ECF no programa OBJ_ECF.SPR
	*						OBS: Quando o Sistema nao esta usando
	*							ECF esta variavel nao e inicializada
	*							portanto ela e inicializada com
	*							valor = 0 nesta rotina
	*  PARAMETROS..:
	*		LSsolicitante..: Identifica os Pontos em que esta
	*				 rotina pode ser chamada
	*			   		LSsolicitante = "VENDEDOR"
	*					LSsolicitante = "CAIXA"
	*					LSsolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					LSsolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					LSsolicitante = "IMPORTACAO"		&& SCGC008
	*                   LSsolicitante = "RECUPERACAO"
	*
	*		LSemcaminhar....: Orienta o processo para :
	*					LSemcaminhar	  = "PREPARAR FATURAMENTO"
	*					LSemcaminhar	  = "EFETIVAR FATURAMENTO"			
	*		LFretorno.......:
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()

	PRIVATE LStp_proces		&& = "CUPOM", "NOTA", "NOTA/CUPOM",
							&&   "RECUP.CUPOM", "RECUP.NOTA",
							&&			 "RECUP.NOTA/CUPOM"
	PRIVATE LFservico		&&   INDICA SE EXISTE SERVICO P/ FATURAR
	PRIVATE LFflagtrans		&&   INDICA SITUACAO DE CONCLUSAO DO PROCESSO
	PRIVATE LSsitRequerida  &&   Armazena a SITUACAO requrida para
							&& a operacao e repassa a ORloc_orc

	PRIVATE LForcament,LFclienc,LFclientes,LFliberacao
	PRIVATE LSalias

	*------------------------------------------------------------*
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFclientes		= NetArq("clientes")
	LFliberacao		= NetArq("liberaco")
	*--------------------------------------------------------

    IF (LForcament+LFclienc+LFclientes) > 100000  && HOUVE FALHA ABERT
		DO FCHrot_fat
		RETURN(.f.)
	ENDIF



	*****************************************************************
	* 				Inicio Verificacao de Requisitos				*
	*****************************************************************
	IF TYPE("LNecf") = "U"
		LNecf	=	0
	ENDIF
	LSsitRequerida = ""
	DO CASE
		CASE LSsolicitante = "CAIXA"				&& OBJ_ECF
			LSsitRequerida =  "o"
		CASE LSsolicitante = "RECUPERACAO"			&& OBJ_ECF
			LSsitRequerida =  "AIMo"
		CASE LSsolicitante = "IMPORTACAO"			&& SCGC008
								&& REGISTRO JA E PASSADO PASICIONADO
	ENDCASE
	CLEAR TYPEAHEAD

	SELE orcament
	
	CLEAR TYPEAHEAD

	LNregvolta = RECNO()



	IF orcament.valor = 0
		IF !fox_alert("Orcamento com VALOR = 0. [ Continua ? ]")
			DO FCHrot_fat
			RETURN(.f.)
		ENDIF
	ENDIF




	*----------------------------------------------------------------*
	IF LSsolicitante <> "IMPORTACAO"
		IF !NFverClasOSI(orcament.empresa,orcament.orcamento)
			DO FCHrot_fat
			RETURN(.F.)
		ENDIF
	ENDIF

	*----------------------------------------------------------------*

	IF LSsolicitante <> "IMPORTACAO"
		IF !NFchqLiberCred(orcament.empresa,orcament.orcamento)
			DO FCHrot_fat
			RETURN(.F.)
		ENDIF
	ENDIF

	*----------------------------------------------------------------*


	SELE orcament

	*****************************************************************
	* 				Fim Informacoes Complementares
	*****************************************************************
	LFretorno = .t.




	IF LSsolicitante <> "IMPORTACAO"
		DO SVD0205.spr with;
			 orcament.empresa,orcament.orcamento,LFretorno

	ENDIF

	IF LFretorno
		LFretorno = NFProcessFat(orcament.empresa,;
					 orcament.orcamento,LSsolicitante)
	ENDIF


	DO FCHrot_fat
	UNLOCK ALL
RETURN(LFretorno)






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJL9           NFregEnvioFat VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_B,     Record Number:    3    
*        Variable:            NFregEnvioFat                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      135                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djl9     &&  NFregEnvioFat VALID
#REGION 5
return
*---------------------------------------------------------------*
FUNCTION  NFregEnvioFat
PARAMETERS LNemp,LNorcamento
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Alterar o STATUS do orcamento e dos itens
	*			para "o" que equivale a enviado para faturamento
	*
	*------------------------------------------------------------*
	* COMENTARIO..: O status "o"  verificado com requisito no
	*    processo que efetiva o faturamento				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LNorcamento:
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	************************************
	=UPtransacao("INICIAR")
	************************************
	LFflgtrans = .t.

	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcamento,6)

	IF orcament.flgtransac = .f.
		DO OBJ_MENS.SPR WITH " O orcamento Selecionado Sofreu" +;
		" Alteracoes que Afetam Valores e Nao Foi Recalculado." +;
		CHR(13)+;
		" Reedite os Itens e Grave para Forcar o Calculo."
		RETURN(.f.)
	ENDIF

	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+orcament.tipo
	IF !FOUND()
		SEEK 's'+orcament.tipo
	ENDIF
	IF !found()
		SELECT orcament
		RETURN(.f.)
	ENDIF
	
	SELECT  orcatmp
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	SET NEAR OFF

	LFflgtrans = .F.  && Se nenhum item for processado no laco
					  && o processo deve ser rejeitado

	DO WHILE !EOF() AND LNemp 		= orcatmp.empresa ;
					AND LNorcamento = orcatmp.orcamento
		***  NAO PROCESSAR ITENS CANCELADOS
		IF LEFT(orcatmp.situacao,1) $ "YykeZ"
			SKIP
			LOOP
		ENDIF
		LFflgtrans = .T.

		***** SO SERA PROCESSADO QDO TODOS OS ITENS SE ENCONTRAREM EM
		***** SITUACAO DE CANCELAMENTO OU PRONTOS P/ FATURAR
		IF !(LEFT(orcatmp.situacao,1) $ "Mo") && OSI e FECHADO
			LFflgtrans = .F.
			EXIT
		ENDIF
		*----------------------------------------------------------*
		IF tipooper.movestq = "S"
	    	SELECT orcatmp
			IF REGLOCK()
			   REPLACE situacao WITH "o"+RIGHT(orcatmp.situacao,1)
			ELSE
				LFflgtrans = .F.
				EXIT
			ENDIF
			SELECT  orcatmp
		ELSE
	    	SELECT orcatmp
			IF REGLOCK()
			   REPLACE situacao WITH "o"+RIGHT(orcatmp.situacao,1)
			ELSE
				LFflgtrans = .F.
				EXIT
			ENDIF
		ENDIF
		SELE orcatmp
		SKIP
	ENDDO
	IF !LFflgtrans
		SELECT orcament
		RETURN(.f.)
	ENDIF			
	SELECT orcament
	REPLACE situacao WITH "o"+RIGHT(situacao,1)
	************************************
	=UPtransacao("TERMINAR")
	************************************
RETURN(.t.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _31Z15DJMN           NF_DefFat VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTA_B,     Record Number:    4    
*        Variable:            NF_DefFat                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      136                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _31z15djmn     &&  NF_DefFat VALID
#REGION 5
return
*---------------------------------------------------------------*
*  Define numero para faturamento nomal, ou seja, Nota Fiscal serie
* Unica e Cupom
*---------------------------------------------------------------*
FUNCTION NF_DefFat
PARAMETERS PrmSolicitante

	=W_DEFPROC("NOTA.SPR")


	*---------------------------------------------------------*

	IF PrmSolicitante <> "IMPORTACAO"
		m.datanf =	wp_dtoper    && REGISTRA A DATA DA GERACAO DA NF
	ELSE
		m.datanf = orcament.dt_fat    && REG. DATA DA GERACAO DA NF
	ENDIF


	*--------------------------------------------------------*
	

	DO CASE
		CASE orcament.empresa = 6 and (orcament.orcamento = 49275 or ;
		                               orcament.orcamento = 49546)
			IF !NF_02DefProcess((orcament.empresa),(orcament.tipo),;
					(LFproduto),(LFservico),(LFipi),(m.datanf),;
					LStp_process,clienc.tp_pessoa,clienc.tp_inscr,;
					clienc.inscricao,PrmSolicitante)
	  				SELE orcament
				RETURN(.F.)
			ENDIF

		CASE m.datanf < {30.09.2006}
			IF !NF_01DefProcess((orcament.empresa),(orcament.tipo),;
					(LFproduto),(LFservico),;
					LStp_process,PrmSolicitante)
	  				SELE orcament
				RETURN(.F.)
			ENDIF
		OTHERWISE
			IF !NF_02DefProcess((orcament.empresa),(orcament.tipo),;
					(LFproduto),(LFservico),(LFipi),(m.datanf),;
					LStp_process,clienc.tp_pessoa,clienc.tp_inscr,;
					clienc.inscricao,PrmSolicitante)
	  				SELE orcament
				RETURN(.F.)
			ENDIF
	ENDCASE



	IF PrmSolicitante <> "IMPORTACAO"
		*---------------------------------------------------------*
		STORE 0  TO LNnroNF, LNNfServico, LNCtrlCpm
		STORE 0  TO LNNFCop, LNnfSrvCop,LNcupom
		*---------------------------------------------------------*

		=W_DEFPROC("NOTA.SPR")
		IF !NF_02NroNota((orcament.empresa),(LStp_process),;
				LNnroNF, LNNfServico, LNCtrlCpm,;		
				LNNFCop, LNnfSrvCop,LNcupom)
		    WAIT 