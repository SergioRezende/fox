DO DF
SET DATE GERMAN
SET CENTU ON
SET DELE ON


SET STEP ON
CLOSE DATA




CREATE TABLE X:\TMP\ER_SALDO ;
	(empresa N(3), CODIGO C(11), DESCRICAO C(35), SLD_ATU N(10,2), SLD_ESTQ N(10,2) )

CLOSE DATA

SELE 0
USE X:\TMP\ER_SALDO EXCL


SELE 0
USE Q:\SCGC\COMUM\GRUPO
SET ORDER TO TAG CODIGO 




SELE 0
USE Q:\SCGC\LOJA\ITEMMOV
SET ORDER TO TAG MOVSIMPLES 



SELE 0
USE Q:\SCGC\LOJA\SALDO
SET ORDER TO TAG SALDO 



SELE 0
USE Q:\SCGC\LOJA\EMPRESA
SET ORDER TO TAG EMPRESA
GO TOP

M.DTABERT = {01.11.2014}

DO WHILE !EOF()
	SELE SALDO
	SET NEAR ON
	
	SEEK ;
	     STR(EMPRESA.EMPRESA,3);
	    +STR(YEAR(M.DTABERT),4);
	    +STR(MONTH(M.DTABERT),2)
    DO WHILE !EOF() ;
	     AND SALDO.EMPRESA = EMPRESA.EMPRESA;
	     AND YEAR(M.DTABERT) = YEAR(SALDO.DTABERT) ;
	     AND MONTH(M.DTABERT) = MONTH(SALDO.DTABERT) 
     
         SELE GRUPO
         SEEK SALDO.CODIGO
         IF !FOUND() OR GRUPO.TP_MERCAD = 7
			SELE SALDO
            SKIP
            LOOP
         ENDIF


         SELE ITEMMOV
		 SET NEAR ON
         SEEK STR(EMPRESA.EMPRESA,3)+SALDO.CODIGO+DTOS(M.DTABERT)     

    	 M.ULT_SALDO = -99999 


  		 DO WHILE !EOF() ;
		     AND ITEMMOV.EMPRESA = EMPRESA.EMPRESA;
		     AND YEAR(ITEMMOV.DATA) = YEAR(SALDO.DTABERT) ;
	    	 AND MONTH(ITEMMOV.DATA) = MONTH(SALDO.DTABERT) ;
	    	 AND ITEMMOV.CODIGO = SALDO.CODIGO
	    	 
	    	 M.ULT_SALDO = ITEMMOV.SLD_ESTQ 
  			SELE ITEMMOV
  			SKIP	    
  		 ENDDO
       
		 IF  M.ULT_SALDO <> -99999 

	    	 IF M.ULT_SALDO <> SALDO.SLD_ATU
                SELE SALDO
                SCATTER MEMVAR

                M.SLD_ESTQ = M.ULT_SALDO 
                M.DESCRICAO = GRUPO.DESCRICAO

                SELE ER_SALDO
                APPEND BLANK
                GATHER MEMVAR

  			 ENDIF     
		 ENDIF
		 SELE SALDO
		 SKIP   

	ENDDO
	SELE EMPRESA
	SKIP   
ENDDO


