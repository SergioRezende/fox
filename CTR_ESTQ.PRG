
DO DF

SET EXCL OFF
SET DATE GERMAN
SET CENTU ON
SET DELE ON


SET STEP ON
CLOSE DATA




CREATE TABLE X:\TMP\ER_SALDO ;
	(empresa N(3), CODIGO C(11), DESCRICAO C(35), ;
	LNSLD_ANT N(10,2), ;
	LNITMV_ENT N(10,2), ;
	LNITMV_SAI N(10,2), ;
	LNSLD_MOV  N(10,2), ;
	LNSLD_ATU  N(10,2), ;
	LNSLD_DIF  N(10,2) )

CLOSE DATA

SELE 0
USE X:\TMP\ER_SALDO EXCL


SELE 0
USE Q:\SCGC\COMUM\GRUPO
SET ORDER TO TAG CODIGO 




SELE 0
USE Q:\SCGC\LOJA\ITEMMOV
SET ORDER TO TAG MOVSIMPLES 



SELE 0
USE Q:\SCGC\LOJA\SALDO
SET ORDER TO TAG SALDO 



SELE 0
USE Q:\SCGC\LOJA\EMPRESA
SET ORDER TO TAG EMPRESA

M.DT_INI   = {01.12.2014}

M.DT_FINAL = {30.12.2014}


SELE EMPRESA
SET FILTER TO EMPRESA = 1

GO TOP

DO WHILE !EOF()

     SELE GRUPO
     GO TOP
     DO WHILE !EOF()
         IF  GRUPO.TP_MERCAD = 7
			SELE GRUPO
            SKIP
            LOOP
         ENDIF


 *----> PEGRAR SALDO INICIAL
		SELE SALDO
	
		SEEK ;
		     STR(EMPRESA.EMPRESA,3);
		    +STR(YEAR(M.DT_INI),4);
		    +STR(MONTH(M.DT_INI),2);
			+GRUPO.CODIGO
		IF FOUND()
			LNSLD_ANT    = SALDO.SLD_ANTE
		ELSE
			LNSLD_ANT    = 0
		ENDIF
		
 *----> PEGRAR SALDO FINAL
		SELE SALDO
	
		SEEK ;
		     STR(EMPRESA.EMPRESA,3);
		    +STR(YEAR(M.DT_FINAL),4);
		    +STR(MONTH(M.DT_FINAL),2);
			+GRUPO.CODIGO
		IF FOUND()
			LNSLD_ATU    = SALDO.SLD_ATU
		ELSE
			LNSLD_ATU    = 0
		ENDIF			
					
 *----> PEGRAR movimento


         SELE ITEMMOV
		 SET NEAR ON
         SEEK STR(EMPRESA.EMPRESA,3)+GRUPO.CODIGO+DTOS(M.DT_INI)     
    	 M.ULT_SALDO = -99999 

		 LNITMV_ENT = 0
		 LNITMV_SAI = 0


  		 DO WHILE !EOF() ;
		     AND ITEMMOV.EMPRESA = EMPRESA.EMPRESA;
		     AND ITEMMOV.DATA   <= M.DT_FINAL ;
	    	 AND ITEMMOV.CODIGO = GRUPO.CODIGO

             IF ITEMMOV.MOVESTQ = "S"
				IF LEFT(ITEMMOV.OPERACAO,1) = "E"
					 LNITMV_ENT = LNITMV_ENT + ITEMMOV.QTDE
				ENDIF
				IF LEFT(ITEMMOV.OPERACAO,1) = "S"
					 LNITMV_SAI = LNITMV_SAI + ITEMMOV.QTDE
				ENDIF			
             ENDIF
   			 SELE ITEMMOV
  			 SKIP	    
  		 ENDDO

	
		 LNSLD_MOV  = ABS((M.LNSLD_ANT;
				     +M.LNITMV_ENT;
				     - M.LNITMV_SAI)) 
	
		 LNSLD_DIF = ABS((M.LNSLD_ANT;
				     +M.LNITMV_ENT;
				     - M.LNITMV_SAI) - M.LNSLD_ATU)

                M.EMPRESA = EMPRESA.EMPRESA
                M.CODIGO = GRUPO.CODIGO
                M.DESCRICAO = GRUPO.DESCRICAO
                SELE ER_SALDO
                APPEND BLANK
                GATHER MEMVAR


	 	 SELE GRUPO
		 SKIP
	 ENDDO
	 SELE EMPRESA 
	 SKIP
	 
ENDDO


