*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º 04/19/10            DOCFISCA.SPR               17:46:26 º
*       º                                                         º
*       ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶
*       º                                                         º
*       º Author's Name                                           º
*       º                                                         º
*       º Copyright (c) 2010 Company Name                         º
*       º Address                                                 º
*       º City,     Zip                                           º
*       º                                                         º
*       º Description:                                            º
*       º This program was automatically generated by GENSCRN.    º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º                MS-DOS Window definitions                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º           NOTA/MS-DOS Setup Code - SECTION 2            º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 3
return

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º          NOTA_A/MS-DOS Setup Code - SECTION 2           º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 4
return

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º          NOTA_B/MS-DOS Setup Code - SECTION 2           º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 5
return

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º           CUPOM/MS-DOS Setup Code - SECTION 2           º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 9
return

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º         TIPOOPER/MS-DOS Setup Code - SECTION 2          º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 13
return

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              DOCFISCA/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 1
@ 2,7 GET DFVerifyInst ;
	PICTURE "@*HN DFVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123g18()
@ 3,10 GET DFCreate ;
	PICTURE "@*HN DFCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _2wz123g1e()
@ 14,10 GET DFDestroi ;
	PICTURE "@*HN DFDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _2wz123g1k()
@ 5,13 GET DFReadProp ;
	PICTURE "@*HN DFReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123g1p()
@ 6,13 GET DFSetDerivadas ;
	PICTURE "@*HN DFSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123g1w()
@ 9,15 GET DFSetPropVT ;
	PICTURE "@*HN DFSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123g21()
@ 10,15 GET DFGetPropVT ;
	PICTURE "@*HN DFGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123g26()
@ 1,2 GET DFChk_Identidade ;
	PICTURE "@*HN DFChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _2wz123g29()
@ 0,2 GET DFFind ;
	PICTURE "@*HN DFFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123g2e()
@ 16,2 GET DFGetFieldValue ;
	PICTURE "@*HN DFGetFieldValue -Rtrn vlr Campo p/ reg.existente-(erro se chave n existir)" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _2wz123g2l()
@ 15,2 GET DF_Refresh ;
	PICTURE "@*HN DF_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123g2r()
@ 18,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 20,2 GET DFLerRegistro ;
	PICTURE "@*HN DFLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123g2x()
@ 13,13 GET DFWriteProp ;
	PICTURE "@*HN DFWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123g32()
@ 21,2 GET DFSalvarRegistro ;
	PICTURE "@*HN DFSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123g37()
@ 19,2 GET DFExiste ;
	PICTURE "@*HN DFExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123g3b()
@ 27,3 GET DFGerNFDocFiscal ;
	PICTURE "@*HN DFGerNFDocFiscal - Converte uma NOTA em DOCFISCA Por Empresa/Periodo" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _2wz123g3i()
@ 22,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 42,11 GET DFv10GravaXMLDocFiscal ;
	PICTURE "@*HN DFv10GravaXMLDocFiscal - Converte uma Doc Fiscal em XML" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _2wz123g3q()
@ 17,2 GET DFGetAlias ;
	PICTURE "@*HN DFGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123g5x()
@ 36,2 GET DFGerXMLPeriodoDocFiscal ;
	PICTURE "@*HN DFGerXMLPeriodoDocFiscal-Gera XML DocFiscal Por Empresa/Periodo" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _2wz123g60()
@ 49,11 GET DFModeloRefXML ;
	PICTURE "@*HN DFModeloRefXML-MODELO P/MONTAR REF XML Doc Fiscal-xmlDCFIS" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123g6c()
@ 48,9 GET DFInicioXML ;
	PICTURE "@*HN DFInicioXML-Monta Cabecalho XML com base no modelo-xmlDCFIS" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123g6g()
@ 50,9 GET DFFinalXML ;
	PICTURE "@*HN DFFinalXML-Monta Cabecalho XML com base no modelo-xmlDCFIS" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123g6l()
@ 31,2 GET DFGerNEDocFiscal ;
	PICTURE "@*HN DFGerNEDocFiscal - Converte uma NOTA em DOCFISCA Por Empresa/Periodo" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _2wz123g6o()
@ 7,13 GET DFSetConfig ;
	PICTURE "@*HN DFSetConfig - Carga Propriedades de Configuracao/Parametros" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _2wz123g6v()
@ 28,6 GET DFConvrtNFDocFiscal ;
	PICTURE "@*HN DFConvrtNFDocFiscal - Converte uma NOTA SAIDA em DOCFISCA" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _2wz123g6z()
@ 33,5 GET DFConvrtNEDocFiscal ;
	PICTURE "@*HN DFConvrtNEDocFiscal - Converte uma NOTA ENTRADA em DOCFISCA" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _2wz123g9b()
@ 37,2 GET DFGerXMLDocFiscal ;
	PICTURE "@*HN DFGerXMLDocFiscal-Gera XML DocFiscal Por Doc Fiscal informado" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _2wz123g9w()
@ 35,0 SAY "XML=>" ;
	SIZE 1,5, 0
@ 26,1 SAY "NOTA => DOCFISCA" ;
	SIZE 1,16, 0
@ 30,0 SAY "NOTAENT => DOCFISCA" ;
	SIZE 1,19, 0
@ 52,0 GET DFEnviaNFeXML ;
	PICTURE "@*HN DFEnviaNFeXML - Envia  XML DOCFIS?? da pasta \exporta\ => \NFe ou \NFSe" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _2wz123ga5()
@ 55,2 GET DFEsperaRspNFe ;
	PICTURE "@*HN DFEsperaRspNFe - Executa DFBuscaRspNFe Enquanto nao houver resposta" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _2wz123gaa()
@ 51,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 57,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 56,5 GET DFBuscaRspNFe ;
	PICTURE "@*HN DFBuscaRspNFe-Busca Arq e Lˆ conteudo Resposta NFe" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _2wz123gaf()
@ 54,0 GET DFRespostaNFe ;
	PICTURE "@*HN DFRespostaNFe - Le e Def. Tratamento para  resposta NFe" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _2wz123gal()
@ 53,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 45,16 GET DFLimpaString ;
	PICTURE "@*HN DFLimpaString - Elimina Caracteres especiais de string" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _2wz123gar()
@ 44,16 GET DF_Fputs ;
	PICTURE "@*HN DF_Fputs - Elimina caracteres especiais da string XML" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123gaw()
@ 24,0 GET DFDefIDNFDocFiscal ;
	PICTURE "@*HN DFDefIDNFDocFiscal - Gera ID DocFiscal Refente a NOTA informada" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _2wz123gb0()
@ 39,4 GET DFNmFileXMLDocFiscal ;
	PICTURE "@*HN DFNmFileXMLDocFiscal-Define Path+File do XML DOC FISCAL (\SCGC\EFD\)" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _2wz123gb5()
@ 40,6 GET DFGravaXMLDocFiscal ;
	PICTURE "@*HN DFGravaXMLDocFiscal - Converte uma Doc Fiscal em XML" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123gb9()
@ 43,11 GET DFv01GravaXMLDocFiscal ;
	PICTURE "@*HN DFv01GravaXMLDocFiscal - Converte uma Doc Fiscal em XML" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _2wz123gbf()
@ 41,8 GET DFVersaoXML ;
	PICTURE "@*HN DFVersaoXML-Define a Versao e para o  processo grava xml" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123gd1()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              DOCFISIT/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 2
@ 6,6 GET DIVerifyInst ;
	PICTURE "@*HN DIVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123gd6()
@ 7,9 GET DICreate ;
	PICTURE "@*HN DICreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _2wz123gd9()
@ 15,9 GET DIDestroi ;
	PICTURE "@*HN DIDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _2wz123gde()
@ 8,12 GET DIReadProp ;
	PICTURE "@*HN DIReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123gdi()
@ 12,15 GET DISetDerivadas ;
	PICTURE "@*HN DISetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123gdm()
@ 9,12 GET DISetPropVT ;
	PICTURE "@*HN DISetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123gdo()
@ 11,15 GET DIGetPropVT ;
	PICTURE "@*HN DIGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123gds()
@ 5,1 GET DIChk_Identidade ;
	PICTURE "@*HN DIChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _2wz123gdv()
@ 4,1 GET DIFind ;
	PICTURE "@*HN DIFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123gdz()
@ 17,2 GET DIGetFieldValue ;
	PICTURE "@*HN DIGetFieldValue -Rtrn vlr Campo p/ reg.existente-(erro se chave n existir)" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _2wz123ge3()
@ 16,2 GET DI_Refresh ;
	PICTURE "@*HN DI_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123ge7()
@ 19,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 21,2 GET DILerRegistro ;
	PICTURE "@*HN DILerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123geb()
@ 13,12 GET DIWriteProp ;
	PICTURE "@*HN DIWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123gef()
@ 22,2 GET DISalvarRegistro ;
	PICTURE "@*HN DISalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123gei()
@ 20,2 GET DIExiste ;
	PICTURE "@*HN DIExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123gem()
@ 23,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 2,1 SAY "====> DOCFISIT => Itens do Documento Fiscal DOCFISA.DBF" ;
	SIZE 1,55, 0
@ 38,8 GET DIV10GravaXMLItensDocFiscal ;
	PICTURE "@*HN DIV10GravaXMLItensDocFiscal - Converte Itens Doc Fiscal em XML" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _2wz123geq()
@ 18,2 GET DIGetAlias ;
	PICTURE "@*HN DIGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123gg1()
@ 46,3 GET DICFOPS ;
	PICTURE "@*HN DICFOPS  - CFOP Servico" ;
	SIZE 1,25,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123gg3()
@ 48,3 GET DICST_IPI ;
	PICTURE "@*HN DICST_IPI" ;
	SIZE 1,11,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123gg7()
@ 49,3 GET DICST_ISS ;
	PICTURE "@*HN DICST_ISS" ;
	SIZE 1,11,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123gga()
@ 50,3 GET DIGenero ;
	PICTURE "@*HN DIGenero" ;
	SIZE 1,10,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123ggd()
@ 51,3 GET DICST_Entrada ;
	PICTURE "@*HN DICST_Entrada" ;
	SIZE 1,15,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123ggf()
@ 47,3 GET DICST_ICMS ;
	PICTURE "@*HN DICST_ICMS" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123ggj()
@ 52,3 GET DICST_PIS ;
	PICTURE "@*HN DICST_PIS - Desenvolver" ;
	SIZE 1,25,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123ggm() ;
	DISABLE
@ 53,5 GET DICST_COFINS ;
	PICTURE "@*HN DICST_COFINS - Desenvolver" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123ggp() ;
	DISABLE
@ 54,3 GET DICST_IR ;
	PICTURE "@*HN DICST_IR - Desenvolver" ;
	SIZE 1,24,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123ggs() ;
	DISABLE
@ 45,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 34,2 GET DIGerXMLPeriodoDocFiscal ;
	PICTURE "@*HN DIGerXMLPeriodoDocFiscal-Gera XML ITEM DocFiscal Por Empresa/Periodo" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _2wz123ggv()
@ 43,11 GET DIModeloRefXML ;
	PICTURE "@*HN DIModeloRefXML-MODELO P/MONTAR REF XML Itens Doc Fiscal-xmlDIFIS" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123gh2()
@ 42,9 GET DIInicioXML ;
	PICTURE "@*HN DIInicioXML-Monta Cabecalho XML com base no modelo-xmlDCFIS" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123gh6()
@ 44,9 GET DIFinalXML ;
	PICTURE "@*HN DIFinalXML-Monta Cabecalho XML com base no modelo-xmlDCFIS" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123gh9()
@ 24,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 26,3 GET DIConvrtNFDocFiscal ;
	PICTURE "@*HN DIConvrtNFDocFiscal - Converte um item de NOTA em item de DOCFISCA" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _2wz123ghd()
@ 33,0 SAY "XML=>" ;
	SIZE 1,5, 0
@ 25,1 SAY "NOTA => DOCFISCA" ;
	SIZE 1,16, 0
@ 28,1 SAY "NOTAENT => DOCFISCA" ;
	SIZE 1,19, 0
@ 35,2 GET DIGerXMLDocFiscal ;
	PICTURE "@*HN DIGerXMLDocFiscal-Gera XML ITEM DocFiscal Por Doc Fiscal" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _2wz123gia()
@ 1,1 GET DIFind ;
	PICTURE "@*HN DIsqls - Biblioteca de consultas sql temporarias" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123gih()
@ 55,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 56,3 GET DIApuraICMS ;
	PICTURE "@*HN DIApuraICMS-SQL-consulta Apluracao ICMS com base no item Doc Fiscal" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123gik()
@ 29,3 GET DIConvrtNEDocFiscal ;
	PICTURE "@*HN DIConvrtNEDocFiscal - Converte um item de NOTA Ent. em item de DOCFISCA" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _2wz123gio()
@ 36,5 GET DINmFileXMLDocFiscal ;
	PICTURE "@*HN DINmFileXMLDocFiscal-Define Path+File do XML ITEM DOC FISCAL" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123gjw()
@ 32,8 GET DIDelItensDocFiscal ;
	PICTURE "@*HN DIDelItensDocFiscal- Deleta Itens do Doc fisc(EX:Antes Reimportar)" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _2wz123gjz()
@ 31,6 SAY "EXCLUI ITENS DOC FISACAL" ;
	SIZE 1,24, 0
@ 39,8 GET DIV01GravaXMLItensDocFiscal ;
	PICTURE "@*HN DIV01GravaXMLItensDocFiscal - Converte Itens Doc Fiscal em XML" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _2wz123gk5()
@ 37,6 GET DIGravaXMLItensDocFiscal ;
	PICTURE "@*HN DIGravaXMLItensDocFiscal - Converte Itens Doc Fiscal em XML" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _2wz123glf()
@ 40,10 GET DIERV01GravaXMLItensDocFiscal ;
	PICTURE "@*HN DIVER01GravaXMLItensDocFiscal - Converte Itens Doc Fiscal em XML" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _2wz123gll() ;
	DISABLE




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º                NOTA/MS-DOS Screen Layout                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 3
@ 1,0 SAY "====> Com Uso de pseudo OO" ;
	SIZE 1,26, 0
@ 5,5 GET NFVerifyInst ;
	PICTURE "@*HN NFVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123gmx()
@ 6,8 GET NFCreate ;
	PICTURE "@*HN NFCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _2wz123gn1()
@ 14,8 GET NFDestroi ;
	PICTURE "@*HN NFDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _2wz123gn5()
@ 8,11 GET NFReadProp ;
	PICTURE "@*HN NFReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123gn9()
@ 11,14 GET NFSetDerivadas ;
	PICTURE "@*HN NFSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123gnc()
@ 9,14 GET NFSetPropVT ;
	PICTURE "@*HN NFSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123gnf()
@ 10,14 GET NFGetPropVT ;
	PICTURE "@*HN NFGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123gnj()
@ 4,0 GET NFChk_Identidade ;
	PICTURE "@*HN NFChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _2wz123gnl()
@ 3,0 GET NFFind ;
	PICTURE "@*HN NFFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123gp8()
@ 16,0 GET NFGetFieldValue ;
	PICTURE "@*HN NFGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123gpc()
@ 15,0 GET NF_Refresh ;
	PICTURE "@*HN NF_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123gpf()
@ 12,11 GET NFWriteProp ;
	PICTURE "@*HN NFWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123gpj()
@ 19,0 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 21,0 GET NFLerRegistro ;
	PICTURE "@*HN NFLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123gpm()
@ 22,0 GET NFSalvarRegistro ;
	PICTURE "@*HN NFSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123gpp()
@ 20,0 GET NFExiste ;
	PICTURE "@*HN NFExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123gps()
@ 23,0 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 17,0 GET NFGetAlias ;
	PICTURE "@*HN NFGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123gpw()
@ 24,0 GET NFFaxinaDados ;
	PICTURE "@*HN NFFaxinaDados-Retira char invalidor e outras validacoes" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _2wz123gpx()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º               NOTA_A/MS-DOS Screen Layout               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 4
@ 36,1 TO 36,78
@ 3,1 GET NFRgAvisoCaixa ;
	PICTURE "@*HN 10-NFRgAvisoCaixa - Gera Registro de Lancamento para Sistema de Caixa" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _2wz123gpy()
@ 4,4 GET NFRgAvistaCaixa ;
	PICTURE "@*HN 10A-NFRgAvistaCaixa-Gera Reg.NF.A Vista Lancamento para Sistema de Caixa" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _2wz123gpz()
@ 5,4 GET NFRgAprazoCaixa ;
	PICTURE "@*HN 10B-NFRgAprazoCaixa-Gera Reg.NF.A Prazo Lancamento para Sistema de Caixa" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _2wz123gq0()
@ 6,1 GET NFCnAvisoCaixa ;
	PICTURE "@*HN 11-NFCnAvisoCaixa - Gera Registro Cancelamento de Lanc. para Sistema de Caixa" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _2wz123gq1()
@ 7,4 GET NFCnAvstaCaixa ;
	PICTURE "@*HN 11A-NFCnAvstaCaixa-Gera Reg.NF.A Vista Lancamento para Sistema de Caixa" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _2wz123gqr()
@ 8,4 GET NFCnAprzoCaixa ;
	PICTURE "@*HN 11B-NFCnAprzoCaixa-Gera Reg.NF.A Prazo Lancamento para Sistema de Caixa" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _2wz123gqy()
@ 9,1 GET NFNroNFServico ;
	PICTURE "@*HN 12-NFNroNFServico - Numero da Ultima NF. Servico" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123gr5()
@ 10,1 GET NFNroCtrlCupom ;
	PICTURE "@*HN 12-NFNroCtrlCupom  - Numero do Ultimo Cupom" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _2wz123grb() ;
	DISABLE
@ 11,1 GET NFDelItensNf ;
	PICTURE "@*HN 14-NFDelItensNf- Apaga Itens de Nota no Arq. Movimento" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _2wz123grh()
@ 12,1 GET NFdefNatureza ;
	PICTURE "@*HN 15-NFdefNatureza - Define a Menssagem do Campo Natureza em RELNFS2" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _2wz123gri()
@ 13,1 GET NFpede_cancelamento ;
	PICTURE "@*HN 16-NFpede_cancelamento-Seleciona Doc Fiscal Para Cancelamento" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _2wz123grj()
@ 14,3 GET NFCancNota ;
	PICTURE "@*HN 16.1-NFCancNota-" ;
	SIZE 1,18,1 ;
	DEFAULT 1 ;
	VALID _2wz123grk()
@ 15,3 GET NFCancCupom ;
	PICTURE "@*HN 16.2-NFCancCupom" ;
	SIZE 1,18,1 ;
	DEFAULT 1 ;
	VALID _2wz123grl()
@ 16,3 GET NFCancTEF ;
	PICTURE "@*HN 16.3-NFCancTEF" ;
	SIZE 1,16,1 ;
	DEFAULT 1 ;
	VALID _2wz123gsb()
@ 17,3 GET NFCancNCN ;
	PICTURE "@*HN 16.4-NFCancNCN" ;
	SIZE 1,16,1 ;
	DEFAULT 1 ;
	VALID _2wz123gsi()
@ 18,3 GET NFCanCopias ;
	PICTURE "@*HN 16.5-NFCanCopias" ;
	SIZE 1,18,1 ;
	DEFAULT 1 ;
	VALID _2wz123gsn()
@ 20,3 GET NFCancNfSrv ;
	PICTURE "@*HN 16.6-NFCancNfSrv-" ;
	SIZE 1,19,1 ;
	DEFAULT 1 ;
	VALID _2wz123gst()
@ 27,3 GET NFCtrlCancFatura ;
	PICTURE "@*HN 16-NFCtrlCancFatura - Controla o Cancelamento de Notas Fiscais/Cupons Visnculados" ;
	SIZE 1,83,1 ;
	DEFAULT 1 ;
	VALID _2wz123gsu()
@ 28,7 GET NFCancFatura ;
	PICTURE "@*HN 16-NFCancFatura / UNFdesfatura - Cancela Nota Fiscal" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123gsv()
@ 29,11 GET UNFbaixa_saldo ;
	PICTURE "@*HN 16.1-UNFbaixa_saldo" ;
	SIZE 1,21,1 ;
	DEFAULT 1 ;
	VALID _2wz123gts()
@ 30,11 GET UNFdesfatura ;
	PICTURE "@*HN 16.2-UNFdesfatura " ;
	SIZE 1,20,1 ;
	DEFAULT 1 ;
	VALID _2wz123gtw()
@ 31,11 GET ULatvitem ;
	PICTURE "@*HN 16.3-ULatvitem" ;
	SIZE 1,16,1 ;
	DEFAULT 1 ;
	VALID _2wz123gu0()
@ 37,1 GET NFEcfInforme ;
	PICTURE "@*HN 17-NFEcfInforme - Informa o 1o e Ultimo Cupom do Periodo, Vlr.Registrado e Vlr.ICMS" ;
	SIZE 1,85,1 ;
	DEFAULT 1 ;
	VALID _2wz123gu5()
@ 38,1 GET NFtot_nfs ;
	PICTURE "@*HN 18-NFtot_nfs  - Totaliza notas Fiscais de Saida do Periodo - Apoio Importacao" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _2wz123guc()
@ 39,1 GET NFgeraBonus ;
	PICTURE "@*HN 19-NFgeraBonus - Gera Bonus para Uso em Servico" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _2wz123guj()
@ 40,1 GET NFCancBonus ;
	PICTURE "@*HN 20-NFCancBonus - Cancela Bonus para Uso em Servico" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _2wz123guk()
@ 41,1 GET NFVldPortFatura ;
	PICTURE "@*HN 21-NFVldPortFatura - Valida Faturamento Para Portador XXX" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _2wz123gul()
@ 42,1 GET NFConjNfRef ;
	PICTURE "@*HN 22-NFConjNfRef - Consulta Nf com a mesma referencia" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _2wz123gum()
@ 45,4 GET NFDMSVer20 ;
	PICTURE "@*HN 25-NFDMSVer20 - Gera DMS por Parametros apos mudanaca que desvincula CUPOM e NOTA" ;
	SIZE 1,83,1 ;
	DEFAULT 1 ;
	VALID _2wz123gvn()
@ 49,5 GET NFSqlDMS ;
	PICTURE "@*HN 25-NFSqlDMS-Gera CURSOR com NF Servico pra base de Rel.Prest.Serv e DMS" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _2wz123gvx()
@ 1,1 GET NFView ;
	PICTURE "@*HN NFView - Browse das Notas " ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _2wz123gvy()
@ 2,1 GET NF_aviso ;
	PICTURE "@*HN NF_aviso - Trata avisos ao operador" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _2wz123gvz() ;
	COLOR SCHEME 14
@ 46,4 GET NFDMSVer30 ;
	PICTURE "@*HN 25-NFDMSVer30 - Gera DMS por Parametros apos mudanaca que desvincula CUPOM e NOTA" ;
	SIZE 1,83,1 ;
	DEFAULT 1 ;
	VALID _2wz123gw0()
@ 44,1 GET NFDMS ;
	PICTURE "@*HN NFDMS - Gera DMS por Parametros apos mudanaca que desvincula CUPOM e NOTA" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _2wz123gwv()
@ 47,4 GET NFDMSVer40 ;
	PICTURE "@*HN 25-NFDMSVer40 - Gera DMS por Parametros apos mudanaca que desvincula CUPOM e NOTA" ;
	SIZE 1,83,1 ;
	DEFAULT 1 ;
	VALID _2wz123gx0()
@ 50,8 GET NFmunidms ;
	PICTURE "@*HN NFmunidms - retorna o codimo municipi conforme tab DMS GYN" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _2wz123gxc()
@ 19,6 GET NFCanNFCopia ;
	PICTURE "@*HN 16.5-NFCanNFCopia" ;
	SIZE 1,19,1 ;
	DEFAULT 1 ;
	VALID _2wz123gxi()
@ 22,5 GET NAONFDefCancDFis ;
	PICTURE "@*HN NAONFDefCancDFis - Define Objetivo Canc DFis (ESCRITURACAO/CANCELAMENTO)" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _2wz123gxj() ;
	DISABLE
@ 23,5 GET NAONFDefEnvDFis ;
	PICTURE "@*HN NAONFDefEnvDFis - Define Objetivo Envio DFis (ESCRITURACAO/CANCELAMENTO)" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _2wz123gxk() ;
	DISABLE




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º               NOTA_B/MS-DOS Screen Layout               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 5
@ 4,1 GET NFRot_Fat ;
	PICTURE "@*HN NFRot_Fat- Rotina GERAL de Faturamento " ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _2wz123gxl()
@ 2,5 GET NFregEnvioFat ;
	PICTURE "@*HN NFregEnvioFat- Prepara Enviop para Processo de Faturamento" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _2wz123gye()
@ 8,0 GET antNFProcessFat ;
	PICTURE "@*HN antNFProcessFat- Efetiva Processo Faturamento  apos 15/03/2006" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _2wz123gyl() ;
	DISABLE
@ 15,5 GET NF_DefFat ;
	PICTURE "@*HN NF_DefFat-Controla Def Dt,Nro p/ NF,Cupom,NFservc,NFe Apos 15/03/2006" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _2wz123gym()
@ 12,5 GET NFchq_Final ;
	PICTURE "@*HN NFchq_Final- Checagem de Dados OSI/ITENS para Liberar Processo de Faturamento" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _2wz123gyn()
@ 16,8 GET NF_01DefProcess ;
	PICTURE "@*HN NF_01DefProcess-Def Processo DocFiscal CUPOM,NF,... ate 30/09/2006" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _2wz123gyo() ;
	DISABLE
@ 17,8 GET ANTNF_02DefProcess ;
	PICTURE "@*HN ANTNF_02DefProcess-Def Processo DocFiscal CUPOM,NF,...apos 15/03/2006" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _2wz123h01() ;
	DISABLE
@ 19,8 GET NF_02NroNota ;
	PICTURE "@*HN NF_02NroNota-Obtem o Numero para proximo NF,NFe,NFServico ou Cupom " ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _2wz123h0d()
@ 44,4 GET NFFatura ;
	PICTURE "@*HN NFFatura-Controla Fat. Conjunto Produto e Servico mesma NF" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _2wz123h0l()
@ 46,7 GET NFAbreNota ;
	PICTURE "@*HN NFAbreNota  - Abre Registro de Nota/Cupom (Com dados Basicos)" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _2wz123h1k()
@ 47,10 GET NFFat_Item ;
	PICTURE "@*HN NFFat_Item- Fatura um Item (Orcatmp ==> Itemmov )" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123h1t()
@ 49,1 GET antNF_02ImpFatura ;
	PICTURE "@*HN antNF_02ImpFatura  - Controla Impressao de NOTA/CUPOM apos 15/03" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _2wz123h1u() ;
	DISABLE
@ 65,7 GET NFinfo_Nf ;
	PICTURE "@*HN NFinfo_Cobr - Funcoes P/Fornecer Info. Adicionais p/ Imp.NF/CUPOM" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _2wz123h3a()
@ 66,7 GET NFinfoCbrSrv ;
	PICTURE "@*HN NFinfoCbrSrv - Funcoes P/Fornecer Info. Adicionais p/ Imp.NF.Servico" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _2wz123h3b()
@ 67,7 GET NFinfoSrvCbr ;
	PICTURE "@*HN NFinfoSrvCbr - Idem NFinfoCbrSrv - adaptada para layout menor de 01/05/2006" ;
	SIZE 1,77,1 ;
	DEFAULT 1 ;
	VALID _2wz123h3c()
@ 81,2 GET UNFmarcanf ;
	PICTURE "@*HN ESP - UNFmarcanf - Set Status de Processo no Registro NF" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _2wz123h3d()
@ 82,2 GET UNFEmpMarcanf ;
	PICTURE "@*HN ESP - UNFEmpMarcanf - Set Status de Processo no Registro NF" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _2wz123h3e()
@ 83,2 GET ULbaixa_Saldo ;
	PICTURE "@*HN ESP - ULbaixa_Saldo - Solicita Baixa de Saldo Para Faturamento" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _2wz123h4j()
@ 29,7 GET NFNfSrvExstCop ;
	PICTURE "@*HN NFNfSrvExstCop - Verifica se Existe Copia Ativa NF SERVICO" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _2wz123h4r()
@ 30,7 GET NFNfN1ExstCop ;
	PICTURE "@*HN NFNfN1ExstCop - Verifica se Existe Copia Ativa NF N1" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _2wz123h4x()
@ 28,3 GET NFProcessCopia ;
	PICTURE "@*HN NFProcessCopia-Controla Geracao Copia de Cupon em NF e NF.Servico" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _2wz123h56()
@ 31,7 GET NFGerCopia ;
	PICTURE "@*HN NFGerCopia - Gera Copia de Cupom Fiscal em NF(Produto e Servico)" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _2wz123h57()
@ 5,6 GET NFverClasOSI ;
	PICTURE "@*HN NFverClasOSI- Verifica Consistencia da Classificacao da Operacao OSI" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _2wz123h6f()
@ 6,6 GET NFchqLiberCred ;
	PICTURE "@*HN NFchqLiberCred- Verifica se houve Liberacao e Credito para Venda" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _2wz123h6o()
@ 7,6 GET NFinfoCompl ;
	PICTURE "@*HN NFinfoCompl- Info Complementares do Vendedor" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _2wz123h6p()
@ 23,1 GET FCHrot_fat ;
	PICTURE "@*HN FCHrot_fat" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _2wz123h6q()
@ 1,1 GET NFEnvioParaFat ;
	PICTURE "@*HN NFEnvioParaFat- Prepara Enviop para Processo de Faturamento" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _2wz123h6r()
@ 20,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 22,1 GET NFRecuperaFat ;
	PICTURE "@*HN NFRecuperaFat- Rotina Recuperacao de NF" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _2wz123h6s()
@ 34,2 GET ULGerCupom ;
	PICTURE "@*HN ULGerCupom" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _2wz123h7l()
@ 35,2 GET ULGerNFSU ;
	PICTURE "@*HN ULGerNFSU  NF ou NFe" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _2wz123h7p()
@ 36,2 GET ULGerServicoNf ;
	PICTURE "@*HN ULGerServicoNf NFS ou NFSe" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _2wz123h7t()
@ 13,5 GET NFBloqEmpresa ;
	PICTURE "@*HN NFBloqEmpresa - Bloq de Empresa para uso como SEMAFORO" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _2wz123h7y()
@ 43,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 33,1 GET ANTNFGeraDocFiscais ;
	PICTURE "@*HN ANTNFGeraDocFiscais" ;
	SIZE 1,21,1 ;
	DEFAULT 1 ;
	VALID _2wz123h84() ;
	DISABLE
@ 68,2 GET NFatlzOrcament ;
	PICTURE "@*HN NFatlzOrcament" ;
	SIZE 1,16,1 ;
	DEFAULT 1 ;
	VALID _2wz123h87()
@ 80,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 25,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 3,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 26,1 GET NF_02ImpCopia ;
	PICTURE "@*HN NF_02ImpCopia - Solicita Copia Cupom em NF e Imprime apos 15/03/2006" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _2wz123h88()
@ 63,4 GET NFAjustTmpItens ;
	PICTURE "@*HN NFAjustTmpItens - Preenche o TMP com reg em branco e linha de impressao para novo LAYOUT" ;
	SIZE 1,90,1 ;
	DEFAULT 1 ;
	VALID _2wz123h89()
@ 50,1 GET antNF_03ImpFatura ;
	PICTURE "@*HN antNF_03ImpFatura- Imp NFS com Grides separadas de Prod e Servicos" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _2wz123h8a() ;
	DISABLE
@ 64,4 GET NFLinhaProd ;
	PICTURE "@*HN NFLinhaProd - Formata String para Linha na grid de Produtos do Formulario NFs" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _2wz123h8o()
@ 32,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 69,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 70,2 GET NFGeraXML_NOTA ;
	PICTURE "@*HN NFGeraXML_NOTA-Gera XML do DocFiscal ref a NF informada " ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _2wz123h8w()
@ 71,2 GET NFEnviaNfe_NOTA ;
	PICTURE "@*HN NFEnviaNfe_NOTA-Envia XML do DocFiscal para NFe ref a NF informada " ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _2wz123haj()
@ 72,2 GET NFRtrnoNfe_NOTA ;
	PICTURE "@*HN NFRtrnoNfe_NOTA-Busca retorno NFe do DocFiscal ref a NF informada " ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _2wz123hao()
@ 51,1 GET antNF_03ImpDocFiscal ;
	PICTURE "@*HN antNF_03ImpDocFiscal -  Impressao do Documento Fiscal Principar - CUPOM / NF / NFSrv" ;
	SIZE 1,86,1 ;
	DEFAULT 1 ;
	VALID _2wz123haw() ;
	DISABLE
@ 52,1 GET antNF_ImpCopDocFiscal ;
	PICTURE "@*HN antNF_ImpCopDocFiscal -  Impressao de Copi de Documento Fiscal Principar - CUPOM / NF / NFSrv" ;
	SIZE 1,95,1 ;
	DEFAULT 1 ;
	VALID _2wz123hax() ;
	DISABLE
@ 9,0 GET antNFProcessFat ;
	PICTURE "@*HN antNFProcessFat- Efetiva Processo Faturamento  apos 15/03/2006" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _2wz123hcg() ;
	DISABLE
@ 27,3 GET antNFProcessCopia ;
	PICTURE "@*HN antNFProcessCopia-Controla Geracao Copia de Cupon em NF e NF.Servico" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _2wz123hch() ;
	DISABLE
@ 10,0 GET NFProcessFat ;
	PICTURE "@*HN NFProcessFat- Efetiva Processo Faturamento  apos 15/03/2006" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _2wz123hci()
@ 53,1 GET NF_ImpCupomFiscal ;
	PICTURE "@*HN NF_ImpCupomFiscal -  Impressao do Cupom Fiscal" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123hdz()
@ 54,1 GET NF_ImpNFFiscal ;
	PICTURE "@*HN NF_ImpNFFiscal - Impressao da Nota Fiscal" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123he0()
@ 55,1 GET NF_ImpNFSrvico ;
	PICTURE "@*HN NF_ImpNFSrvico -  Impressao da NF de Servico" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _2wz123he1()
@ 58,1 GET ANTNF_ImpNFe ;
	PICTURE "@*HN ANTNF_ImpNFe - Impressao da Nota Fiscal Eletronica" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _2wz123hfb() ;
	DISABLE
@ 56,1 GET NF_CopNF_Imprime ;
	PICTURE "@*HN NF_CopNF_Imprime -  Impressao de Copia de cupom em NF convencional" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _2wz123hfq()
@ 60,1 GET ANTNF_CopNFe_Imprime ;
	PICTURE "@*HN ANTNF_CopNFe_Imprime -  Impressao de Copia de cupom em NFe" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _2wz123hfr() ;
	DISABLE
@ 57,1 GET NF_CopNFSrvImprime ;
	PICTURE "@*HN NF_CopNFSrvImprime -  Impressao de Copia do cupom em NF Servico" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _2wz123hgl()
@ 77,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 78,2 GET NFAtlzDadosNFe ;
	PICTURE "@*HN NFAtlzDadosNFe -Atlz retorno NFe no Orcamento, Nota e Doc Fiscal/Emp/ Periodo" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _2wz123hh2()
@ 79,2 GET NFVrfSeqNroNotas ;
	PICTURE "@*HN NFVrfSeqNroNotas-Verifica a seq nro nota gera arq. log em loc informado" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _2wz123hh7()
@ 18,8 GET NF_02DefProcess ;
	PICTURE "@*HN NF_02DefProcess-Def Processo DocFiscal CUPOM,NF,NFe,NFS,NFSe 15/03/2010" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _2wz123hh8()
@ 59,1 GET ANTNF_ImpNFSe ;
	PICTURE "@*HN ANTNF_ImpNFSe - Impressao da Nota Fiscal Servico Eletronica" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _2wz123hh9() ;
	DISABLE
@ 61,1 GET ANTNF_CopNFSe_Imprime ;
	PICTURE "@*HN ANTNF_CopNFSe_Imprime -  Impressao de Copia de cupom em NFe" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _2wz123hib() ;
	DISABLE
@ 45,6 GET NFSerie ;
	PICTURE "@*HN NFSerie" ;
	SIZE 1,9,1 ;
	DEFAULT 1 ;
	VALID _2wz123hip()
@ 37,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 62,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 42,4 GET NF_CancDFis ;
	PICTURE "@*HN NF_CancDFis - Cancela Documento Fiscal (NF/NFS/NFe/NFSe/CUPOM)" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _2wz123hiu()
@ 41,4 GET NF_GeraDFis ;
	PICTURE "@*HN NF_GeraDFis - Gera Documento Fiscal(NF/NFS/NFe/NFSe/CUPOM)" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _2wz123hiv()
@ 48,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 38,4 GET NFDefCancDFis ;
	PICTURE "@*HN NFDefCancDFis - Define Objetivo Canc DFis (ESCRITURACAO/CANCELAMENTO)" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _2wz123hiw()
@ 39,4 GET NFDefEnvDFis ;
	PICTURE "@*HN NFDefEnvDFis - Define Objetivo Envio DFis (ESCRITURACAO/CANCELAMENTO)" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _2wz123hix()
@ 75,2 GET NFReenvNFe ;
	PICTURE "@*HN NFReenvNFe - Renvia- NFe ->NF->DOC->XML->NFe" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123hjs()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              NOTAENT/MS-DOS Screen Layout               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 6
@ 23,2 GET NEGetFieldValue ;
	PICTURE "@*HN NEGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123hjy()
@ 25,2 GET NEGetUFOrigem ;
	PICTURE "@*HN NEGetUFOrigem - Retorna UFs (Origem da NFE)" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _2wz123hk1()
@ 26,2 GET NEGetUFDestino ;
	PICTURE "@*HN NEGetUFDestino - Retorna UFs (Destino da NFE)" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _2wz123hk3()
@ 27,2 GET NEGetRetidoDestacado ;
	PICTURE "@*HN NEGetRetidoDestacado - Retido Destacado na NFE" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123hk7()
@ 4,7 GET NEVerifyInst ;
	PICTURE "@*HN NEVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123hk9()
@ 5,10 GET NECreate ;
	PICTURE "@*HN NECreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _2wz123hkd()
@ 13,10 GET NEDestroi ;
	PICTURE "@*HN NEDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _2wz123hke()
@ 7,13 GET NEReadProp ;
	PICTURE "@*HN NEReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123hkf()
@ 10,15 GET NESetDerivadas ;
	PICTURE "@*HN NESetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123hkg()
@ 8,15 GET NESetPropVT ;
	PICTURE "@*HN NESetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123hkh()
@ 9,15 GET NEGetPropVT ;
	PICTURE "@*HN NEGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123hki()
@ 3,2 GET NEChk_Identidade ;
	PICTURE "@*HN NEChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _2wz123hl9()
@ 2,2 GET NEFind ;
	PICTURE "@*HN NEFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123hlc()
@ 15,2 GET NEGetFieldValue ;
	PICTURE "@*HN NEGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123hlg()
@ 14,2 GET NE_Refresh ;
	PICTURE "@*HN NE_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123hlk()
@ 17,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 19,2 GET NELerRegistro ;
	PICTURE "@*HN NELerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123hlr()
@ 11,13 GET NEWriteProp ;
	PICTURE "@*HN NEWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123hlw()
@ 20,2 GET NESalvarRegistro ;
	PICTURE "@*HN NESalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123hlx()
@ 18,2 GET NEExiste ;
	PICTURE "@*HN NEExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123hly()
@ 21,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 16,2 GET NEGetAlias ;
	PICTURE "@*HN NEGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123hlz()
@ 1,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              FORNECED/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 7
@ 23,4 GET FRGet_UF ;
	PICTURE "@*HN 01-FRGet_UF - Obter UF do Fornecedor" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _2wz123hm0()
@ 24,4 GET FRrgm_Fisc ;
	PICTURE "@*HN 01-FRrgm_Fisc - Obter o Regime Fiscal (Normal ou Simples)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _2wz123hm1()
@ 3,9 GET FRVerifyInst ;
	PICTURE "@*HN FRVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123hms()
@ 4,12 GET FRCreate ;
	PICTURE "@*HN FRCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _2wz123hmy()
@ 12,12 GET FRDestroi ;
	PICTURE "@*HN FRDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _2wz123hn6()
@ 6,15 GET FRReadProp ;
	PICTURE "@*HN FRReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123hnb()
@ 9,17 GET FRSetDerivadas ;
	PICTURE "@*HN FRSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123hnf()
@ 7,17 GET FRSetPropVT ;
	PICTURE "@*HN FRSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123hng()
@ 8,17 GET FRGetPropVT ;
	PICTURE "@*HN FRGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123hnh()
@ 2,4 GET FRChk_Identidade ;
	PICTURE "@*HN FRChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _2wz123hni()
@ 1,4 GET FRFind ;
	PICTURE "@*HN FRFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123hnj()
@ 14,4 GET FRGetFieldValue ;
	PICTURE "@*HN FRGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123hnk()
@ 13,4 GET FR_Refresh ;
	PICTURE "@*HN FR_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123hnl()
@ 16,4 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 18,4 GET FRLerRegistro ;
	PICTURE "@*HN FRLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123hnm()
@ 10,15 GET FRWriteProp ;
	PICTURE "@*HN FRWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123hnn()
@ 19,4 GET FRSalvarRegistro ;
	PICTURE "@*HN FRSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123ho9()
@ 17,4 GET FRExiste ;
	PICTURE "@*HN FRExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123hod()
@ 20,4 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 15,4 GET FRGetAlias ;
	PICTURE "@*HN FRGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123hog()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              EMPRESA/MS-DOS Screen Layout               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 8
@ 21,2 GET EMGet_UF ;
	PICTURE "@*HN EMGet_UF - Obter UF da Loja" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _2wz123hok()
@ 23,2 GET EMGet_Juro ;
	PICTURE "@*HN EMGet_Juro - Obter Juro Mes da Loja" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _2wz123hom()
@ 28,2 GET verif ;
	PICTURE "@*HN Verificar Codigo de Empresa" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _2wz123hoq()
@ 29,2 GET EMrodanroNF ;
	PICTURE "@*HN EMrodanroNF - Roda Numeracao de Nota " ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123hou()
@ 24,2 GET EMGet_Mora ;
	PICTURE "@*HN EMGet_Mora - Obter Mora diaria" ;
	SIZE 1,32,1 ;
	DEFAULT 1 ;
	VALID _2wz123hoy()
@ 25,2 GET EMGet_Sigla ;
	PICTURE "@*HN EMGet_Sigla - Obter Sigla da empresa" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123hp1()
@ 26,2 GET EMGet_ECFSerie ;
	PICTURE "@*HN EMGet_ECFSerie - Obter Nro Serie Ecf" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _2wz123hp2()
@ 22,2 GET EMGet_Municipio ;
	PICTURE "@*HN EMGet_Municipio - Obter UF da Loja" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	VALID _2wz123hp3()
@ 27,2 GET EMGet_TabCst ;
	PICTURE "@*HN EMGet_TabCst - Obter Tab_CST" ;
	SIZE 1,30,1 ;
	DEFAULT 1 ;
	VALID _2wz123hp4()
@ 17,2 GET EMLerRegistro ;
	PICTURE "@*HN EMLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123hp5()
@ 18,2 GET EMSalvarRegistro ;
	PICTURE "@*HN EMSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123hp6()
@ 16,2 GET EMExiste ;
	PICTURE "@*HN EMExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123hp7()
@ 2,7 GET EMVerifyInst ;
	PICTURE "@*HN EMVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123hp8()
@ 3,10 GET EMCreate ;
	PICTURE "@*HN EMCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _2wz123hp9()
@ 11,10 GET EMDestroi ;
	PICTURE "@*HN EMDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _2wz123hpv()
@ 5,13 GET EMReadProp ;
	PICTURE "@*HN EMReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123hq0()
@ 8,15 GET EMSetDerivadas ;
	PICTURE "@*HN EMSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123hq3()
@ 6,15 GET EMSetPropVT ;
	PICTURE "@*HN EMSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123hq6()
@ 7,15 GET EMGetPropVT ;
	PICTURE "@*HN EMGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123hq9()
@ 1,2 GET EMChk_Identidade ;
	PICTURE "@*HN EMChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _2wz123hqc()
@ 0,2 GET EMFind ;
	PICTURE "@*HN EMFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123hqf()
@ 13,2 GET EMGetFieldValue ;
	PICTURE "@*HN EMGetFieldValue -Rtrn vlr Campo p/ reg.existente-(erro se chave n existir)" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _2wz123hqj()
@ 12,2 GET EM_Refresh ;
	PICTURE "@*HN EM_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123hqk()
@ 15,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 9,13 GET EMWriteProp ;
	PICTURE "@*HN EMWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123hql()
@ 19,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 14,2 GET EMGetAlias ;
	PICTURE "@*HN EMGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123hqm()
@ 30,1 SAY "*-----------------------------------------------------------*" ;
	SIZE 1,61, 0
@ 31,2 GET EMMarcaFlgNF ;
	PICTURE "@*HN EMMarcaFlgNF - Marca flag de controle etapa faturamento NF" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _2wz123hqn()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º               CUPOM/MS-DOS Screen Layout                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 9
@ 1,0 SAY "====> Com Uso de pseudo OO" ;
	SIZE 1,26, 0
@ 5,5 GET CPVerifyInst ;
	PICTURE "@*HN CPVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123hqo()
@ 6,8 GET CPCreate ;
	PICTURE "@*HN CPCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _2wz123hqp()
@ 14,8 GET CPDestroi ;
	PICTURE "@*HN CPDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _2wz123hqq()
@ 8,11 GET CPReadProp ;
	PICTURE "@*HN CPReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123hrd()
@ 11,14 GET CPSetDerivadas ;
	PICTURE "@*HN CPSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123hrg()
@ 9,14 GET CPSetPropVT ;
	PICTURE "@*HN CPSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123hrj()
@ 10,14 GET CPGetPropVT ;
	PICTURE "@*HN CPGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123hrm()
@ 4,0 GET CPChk_Identidade ;
	PICTURE "@*HN CPChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _2wz123hrq()
@ 3,0 GET CPFind ;
	PICTURE "@*HN CPFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123hrt()
@ 16,0 GET CPGetFieldValue ;
	PICTURE "@*HN CPGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123hrx()
@ 15,0 GET CP_Refresh ;
	PICTURE "@*HN CP_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123hs0()
@ 12,11 GET CPWriteProp ;
	PICTURE "@*HN CPWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123hs1()
@ 19,0 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 21,0 GET CPLerRegistro ;
	PICTURE "@*HN CPLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123hs2()
@ 22,0 GET CPSalvarRegistro ;
	PICTURE "@*HN CPSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123hs3()
@ 20,0 GET CPExiste ;
	PICTURE "@*HN CPExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123hs4()
@ 23,0 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 17,0 GET CPGetAlias ;
	PICTURE "@*HN CPGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123hs5()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              TRIBUTAR/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 10
@ 27,0 SAY "ROTINAS AINDA VINCULADAS AO ORCAMENTO (AINDA DEPEDEM DO NRO ORCAMENTO)" ;
	SIZE 1,70, 0
@ 3,0 SAY "ROTINAS GERAIS - COM PARAMETROS MAIS INDEPENDENTES E ESPECIFICOS" ;
	SIZE 1,64, 0
@ 5,3 GET TRGet_IPIProd ;
	PICTURE "@*HN TRGet_IPIProd - Obtem a Aliquota de IPI do Produto" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _2wz123hs6()
@ 6,3 GET TRGet_ISSAlq ;
	PICTURE "@*HN TRGet_ISSAlq - Obtem Aliquota de ISS" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _2wz123hs7()
@ 8,3 GET TRdefcst ;
	PICTURE "@*HN TRdefcst - Define CST para Item do Orcamento" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _2wz123hs8()
@ 14,3 GET TRAlqIcmInUF ;
	PICTURE "@*HN TRAlqIcmInUF - Obetem Aliquota Interna de ICMS na UF informada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _2wz123hsv()
@ 15,3 GET TRAlqIcmOuUF ;
	PICTURE "@*HN TRAlqIcmOuUF - Obetem Aliquota Externa de ICMS na UF informada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _2wz123hsz()
@ 11,3 GET TRCFO ;
	PICTURE "@*HN TRCFO  - Obtem CFO Pela OPERACAO E TIPO MERCADORIA" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _2wz123ht4()
@ 28,0 GET ANTTRpct_trib ;
	PICTURE "@*HN ANTTRpct_trib - SUBSTITUIDA EM 10/06/2009" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123hta() ;
	DISABLE
@ 32,6 GET TRGet_IPIAlq ;
	PICTURE "@*HN 02-TRGet_IPIAlq - Obtem a Aliquota de IPI do produto para o orcamento" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _2wz123htm()
@ 33,6 GET TRGet_cst ;
	PICTURE "@*HN 03-TRGet_cst - Obtem CST para o produto no orcamento" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123htn()
@ 17,3 GET TRDef_tpMercad ;
	PICTURE "@*HN TRDef_tpMercad- DESVIO COMPATIBILIZA COM TRDef_RgTrbMercad (DESCARTAR FUTURO)" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _2wz123hto()
@ 35,6 GET TRGet_rduIcms ;
	PICTURE "@*HN 06-TRGet_rduIcms - Obtem Aliquota de Reducao do ICMS" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123htp()
@ 36,6 GET TRGet_IcmsAlq ;
	PICTURE "@*HN 07-TRGet_IcmsAlq - Obtem Aliquota de ICMS para Orcamento" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _2wz123htq()
@ 37,6 GET TRGet_CFO ;
	PICTURE "@*HN 08-TRGet_CFO  - Obtem CFO" ;
	SIZE 1,27,1 ;
	DEFAULT 1 ;
	VALID _2wz123hug()
@ 30,2 GET TRcalc_tribu ;
	PICTURE "@*HN TRcalc_tribu- Calcula Valores Tributarios Fiscais" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123hum()
@ 42,3 GET CSTENT ;
	PICTURE "@*HN ?? - Define CST NF Entrada" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _2wz123hv5()
@ 43,4 GET TRRtdoSaida ;
	PICTURE "@*HN 15-TRRtdoSaida - Ret.Vlr.ICM Retido na Saida" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _2wz123hv6()
@ 44,4 GET TRRtdoEntrada ;
	PICTURE "@*HN 16-TRRtdoEntrada - Ret.Vlr.ICM Retido na Entrada" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123hv7()
@ 45,4 GET TRicmNormal ;
	PICTURE "@*HN 17-TRicmNormal - Ret.Vlr.ICM Normal" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _2wz123hv8()
@ 46,4 GET TREnbsicmNormal ;
	PICTURE "@*HN 18-TREnbsicmNormal - Ret.Base ICMS Norma Entrada" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123hv9()
@ 47,4 GET TREbsRtdoCIVA ;
	PICTURE "@*HN 19-TREbsRtdoCIVA - Ret.Base ICMS Retido Entrada (Com IVA)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _2wz123hvu()
@ 48,4 GET TREbsRtdoSIVA ;
	PICTURE "@*HN 20-TREbsRtdoSIVA - Ret.Base ICMS Retido Entrada (Sem IVA)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _2wz123hvz()
@ 1,6 GET TRgrupoALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,17 GET TRgrfiscalALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,28 GET TRtab_IvaALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,39 GET TRtipooperALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 31,4 GET TRcalc_Difer ;
	PICTURE "@*HN 11-TRcalc_Difer- Ajusta Diferanca geradas nos tributo percentuais" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _2wz123hw5()
@ 38,0 SAY "ROTINAS PARA NOVA PLANILHA TRIBUTARIA (OPERCMRC e CLASFISC)" ;
	SIZE 1,59, 0
@ 39,4 GET TRVincTipo ;
	PICTURE "@*HN 16-TRVincTipo - Vincula TIPOOPER a OPERCMRC e A CLASFISC" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _2wz123hw9()
@ 4,3 GET TRGet_IVA ;
	PICTURE "@*HN TRGet_IVA - Obtem o IVA Ajustada proprio do produto (Pecas)" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _2wz123hwg()
@ 41,1 SAY "ROTINAS PARA ENTRADA JA USADAS EM SCGC245 (CONTAB NOTAS ENTRADA)" ;
	SIZE 1,64, 0
@ 12,3 GET TRCFOPServico ;
	PICTURE "@*HN TRCFOPServico - Define CFOP para Servico" ;
	SIZE 1,42,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123hwh()
@ 20,3 GET TRCST_IPI ;
	PICTURE "@*HN TRCST_IPI - Codigo de Situacao Tributaria para IPI" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123hwi()
@ 21,3 GET TRCST_ISS ;
	PICTURE "@*HN TRCST_ISS - Codigo Sit Tributaria ISS" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123hwj()
@ 25,3 GET TRGenero ;
	PICTURE "@*HN TRGenero - Define Genero do Produto" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123hwk()
@ 26,3 GET TRCST_Entrada ;
	PICTURE "@*HN TRCST_Entrada" ;
	SIZE 1,15,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123hwl()
@ 9,7 GET TRcst_Icms ;
	PICTURE "@*HN TRcst_Icms - Define CST completo com 3 digitos" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123hwm()
@ 22,3 GET TRCST_PIS ;
	PICTURE "@*HN TRCST_PIS - Desenvolver" ;
	SIZE 1,25,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123hxf() ;
	DISABLE
@ 23,3 GET TRCST_COFINS ;
	PICTURE "@*HN TRCST_COFINS - Desenvolver" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123hxi() ;
	DISABLE
@ 24,3 GET TRCST_IR ;
	PICTURE "@*HN TRCST_IR - Desenvolver" ;
	SIZE 1,24,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _2wz123hxl() ;
	DISABLE
@ 0,0 SAY "ALIASES" ;
	SIZE 1,7, 0
@ 18,5 GET TRDef_RgTrbMercad ;
	PICTURE "@*HN TRDef_RgTrbMercad - Retorna o Regime Tributario da Merc. na UF" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _2wz123hxo()
@ 29,0 GET TRpct_trib ;
	PICTURE "@*HN TRpct_trib - (01 a 09) em Pacote de Tributos - Acelera processo" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _2wz123hxu()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              ITEMMOV/MS-DOS Screen Layout               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 11
@ 23,1 SAY "Metodos de Acesso aos Valores das Propriedades" ;
	SIZE 1,46, 0
@ 24,3 GET IMGetSaldo ;
	PICTURE "@*HN IMGetSaldo - Retorna Saldo Com Base em um Instante no Movimento " ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _2wz123hy7()
@ 25,3 GET IMGetReserva ;
	PICTURE "@*HN IMGetReserva - Retorna Saldo Reserva Com Base em um Instante no Movimento " ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _2wz123hy8()
@ 28,3 GET IMgiroSimplesLJ ;
	PICTURE "@*HN IMgiroSimplesLJ - Venda / Total de Dias" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _2wz123hy9()
@ 29,3 GET IMgiroRealLJ ;
	PICTURE "@*HN IMgiroRealLJ - Venda / Total de Dias Com Disponibilidade de Estoque" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _2wz123hya()
@ 30,3 GET IMgiroTendenciaLJ ;
	PICTURE "@*HN IMgiroTendenciaLJ - Giro Real Ponderando o Faixas dentro do Periodo" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _2wz123hyb()
@ 31,8 GET IMDadosGiro ;
	PICTURE "@*HN IMDadosGiro - Rotina de Apoio Comum Para Calculo de Giro Diefernciados" ;
	SIZE 1,72,1 ;
	DEFAULT 1 ;
	VALID _2wz123hyx()
@ 33,1 SAY "Consultas SQL" ;
	SIZE 1,13, 0
@ 34,3 GET IMGiroControle ;
	PICTURE "@*HN IMGiroControle - SQL para Montar Giro de Estoque e Duracao" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _2wz123hz6()
@ 26,3 GET IMGetVlrEstq ;
	PICTURE "@*HN IMGetVlrEstq-Ret.Vlr/Custo Estq.Com em um Instante no Movimento " ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _2wz123hzc()
@ 32,11 GET IMPosicItemmov ;
	PICTURE "@*HN IMPosicItemmov-Posiciona itemmov no ultimo registo de uma data" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _2wz123hzg()
@ 0,0 SAY "====> Com Uso de pseudo OO" ;
	SIZE 1,26, 0
@ 3,6 GET IMVerifyInst ;
	PICTURE "@*HN IMVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123hzj()
@ 4,9 GET IMCreate ;
	PICTURE "@*HN IMCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _2wz123hzn()
@ 12,9 GET IMDestroi ;
	PICTURE "@*HN IMDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _2wz123hzo()
@ 6,12 GET IMReadProp ;
	PICTURE "@*HN IMReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123hzp()
@ 9,14 GET IMSetDerivadas ;
	PICTURE "@*HN IMSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123hzq()
@ 7,14 GET IMSetPropVT ;
	PICTURE "@*HN IMSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123hzr()
@ 8,14 GET IMGetPropVT ;
	PICTURE "@*HN IMGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123hzs()
@ 2,1 GET IMChk_Identidade ;
	PICTURE "@*HN IMChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _2wz123hzt()
@ 1,1 GET IMFind ;
	PICTURE "@*HN IMFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123hzu()
@ 14,1 GET IMGetFieldValue ;
	PICTURE "@*HN IMGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123i0f()
@ 13,1 GET IM_Refresh ;
	PICTURE "@*HN IM_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123i0j()
@ 16,1 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 18,1 GET IMLerRegistro ;
	PICTURE "@*HN IMLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123i0o()
@ 10,12 GET IMWriteProp ;
	PICTURE "@*HN IMWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123i0r()
@ 19,1 GET IMSalvarRegistro ;
	PICTURE "@*HN IMSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123i0v()
@ 17,1 GET IMExiste ;
	PICTURE "@*HN IMExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123i0y()
@ 20,1 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 15,1 GET IMGetAlias ;
	PICTURE "@*HN IMGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123i12()
@ 21,1 GET IMFaxinaDados ;
	PICTURE "@*HN IMFaxinaDados-Retira char invalidor e outras validacoes" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _2wz123i15()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º               GRUPO/MS-DOS Screen Layout                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 12
@ 27,0 GET GRGetClassifica ;
	PICTURE "@*HN GRGetClassifica - Retorna Classificacao do Produto" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _2wz123i19()
@ 28,0 GET GRGetPeso ;
	PICTURE "@*HN GRGetPeso - Retorna Peso" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _2wz123i1a()
@ 29,0 GET ver_Prod ;
	PICTURE "@*HN GRLoc_Prod - Loc/Posicionar Reg Codigo de Produto" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123i1b()
@ 30,0 GET GRGetOrigem ;
	PICTURE "@*HN GRGetOrigem - Retorna Origem do Produto" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _2wz123i1c()
@ 0,0 SAY "====> Com Uso de pseudo OO" ;
	SIZE 1,26, 0
@ 6,6 GET GRVerifyInst ;
	PICTURE "@*HN GRVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123i1d()
@ 7,9 GET GRCreate ;
	PICTURE "@*HN GRCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _2wz123i1e()
@ 16,8 GET GRDestroi ;
	PICTURE "@*HN GRDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _2wz123i1f()
@ 8,11 GET GRReadProp ;
	PICTURE "@*HN GRReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123i21()
@ 9,11 GET GRSetDerivadas ;
	PICTURE "@*HN GRSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123i24()
@ 12,11 GET GRSetPropVT ;
	PICTURE "@*HN GRSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123i27()
@ 13,11 GET GRGetPropVT ;
	PICTURE "@*HN GRGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2b()
@ 3,1 GET GRChk_Identidade ;
	PICTURE "@*HN GRChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2e()
@ 2,1 GET GRFind ;
	PICTURE "@*HN GRFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2i()
@ 18,0 GET GRGetFieldValue ;
	PICTURE "@*HN GRGetFieldValue -Rtrn vlr Campo p/ reg.existente-(erro se chave n existir)" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2l()
@ 17,0 GET GR_Refresh ;
	PICTURE "@*HN GR_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2o()
@ 20,0 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 22,0 GET GRLerRegistro ;
	PICTURE "@*HN GRLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2r()
@ 15,11 GET GRWriteProp ;
	PICTURE "@*HN GRWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2s()
@ 23,0 GET GRSalvarRegistro ;
	PICTURE "@*HN GRSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2t()
@ 21,0 GET GRExiste ;
	PICTURE "@*HN GRExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2u()
@ 24,0 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 19,0 GET GRGetAlias ;
	PICTURE "@*HN GRGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2v()
@ 4,3 GET GRTrtChave ;
	PICTURE "@*HN GRTrtChave - Trata Acesso por Chave " ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2w()
@ 10,11 GET GRSetConfig ;
	PICTURE "@*HN GRSetConfig - Carga Propriedades de Configuracao/Parametros" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2x()
@ 31,0 GET GRGetNomeFab ;
	PICTURE "@*HN GRGetNomeFab - Retorna Nome do Fabricante do Produto" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123i2y()
@ 33,0 GET GRGetCodPrdNoFab ;
	PICTURE "@*HN GRGetCodPrdNoFab-Ret Cod Prod no Fabricante-Indicado no Cad" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _2wz123i3j()
@ 25,0 GET GRFaxinaDados ;
	PICTURE "@*HN GRFaxinaDados-Retira char invalidor e outras validacoes" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _2wz123i3l()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              TIPOOPER/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 13
@ 33,0 SAY "*---------------------------------------------------------------------------*" ;
	SIZE 1,77, 0
@ 6,4 GET TPVerifyInst ;
	PICTURE "@*HN TPVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123i3p()
@ 7,7 GET TPCreate ;
	PICTURE "@*HN TPCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _2wz123i3t()
@ 16,7 GET TPDestroi ;
	PICTURE "@*HN TPDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _2wz123i3y()
@ 8,9 GET TPReadProp ;
	PICTURE "@*HN TPReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123i42()
@ 9,9 GET TPSetDerivadas ;
	PICTURE "@*HN TPSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123i45()
@ 12,9 GET TPSetPropVT ;
	PICTURE "@*HN TPSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123i48()
@ 13,9 GET TPGetPropVT ;
	PICTURE "@*HN TPGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123i49()
@ 3,1 GET TPChk_Identidade ;
	PICTURE "@*HN TPChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _2wz123i4a()
@ 2,1 GET TPFind ;
	PICTURE "@*HN TPFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123i4b()
@ 19,1 GET TPGetFieldValue ;
	PICTURE "@*HN TPGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123i4c()
@ 18,1 GET TP_Refresh ;
	PICTURE "@*HN TP_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123i4d()
@ 23,1 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 25,1 GET TPLerRegistro ;
	PICTURE "@*HN TPLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123i4e()
@ 15,9 GET TPWriteProp ;
	PICTURE "@*HN TPWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123i4f()
@ 26,1 GET TPSalvarRegistro ;
	PICTURE "@*HN TPSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123i50()
@ 24,1 GET TPExiste ;
	PICTURE "@*HN TPExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123i54()
@ 20,1 GET TPGetAlias ;
	PICTURE "@*HN TPGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123i58()
@ 10,9 GET TPSetConfig ;
	PICTURE "@*HN TPSetConfig - Carga Propriedades de Configuracao/Parametros" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _2wz123i5b()
@ 29,1 GET TPBtnVal ;
	PICTURE "@*HN TPBtnVal - Trata Comandos de navegacao" ;
	SIZE 1,40,1 ;
	DEFAULT 1 ;
	VALID _2wz123i5f()
@ 4,4 GET TPTrtChv ;
	PICTURE "@*HN TPTrtChv - Trata Acesso por Chave" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123i5k()
@ 17,1 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 21,1 GET TPScatter ;
	PICTURE "@*HN TPScatter - Carrega Var de Memoria" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	VALID _2wz123i5n()
@ 30,1 GET TPView ;
	PICTURE "@*HN TPView - Visualisa BROWSE" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _2wz123i5q()
@ 31,3 GET TPLOCATE ;
	PICTURE "@*HN TPLOCATE - Apoio a CLView - Visualisa BROWSE" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _2wz123i5r()
@ 0,2 SAY "CLAS:V-1.0 => IMPLEMENTA NAVEGACAO E MANUTENCAO COMPLETA (BASE=CLIENTES)" ;
	SIZE 1,72, 0
@ 1,0 SAY "*---------------------------------------------------------------------*" ;
	SIZE 1,71, 0




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              GRFISCAL/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 14
@ 23,0 SAY "Metodos de Acesso aos Valores das Propriedades" ;
	SIZE 1,46, 0
@ 24,1 GET GFGetTp_Mercadoria ;
	PICTURE "@*HN GFGetTp_Mercadoria - Retorna Tipo Fiscal do Produto na UF" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _2wz123i5s()
@ 3,6 GET GFVerifyInst ;
	PICTURE "@*HN GFVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123i5t()
@ 4,9 GET GFCreate ;
	PICTURE "@*HN GFCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _2wz123i5u()
@ 12,9 GET GFDestroi ;
	PICTURE "@*HN GFDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _2wz123i5v()
@ 6,12 GET GFReadProp ;
	PICTURE "@*HN GFReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _2wz123i5w()
@ 9,14 GET GFSetDerivadas ;
	PICTURE "@*HN GFSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _2wz123i6k()
@ 7,14 GET GFSetPropVT ;
	PICTURE "@*HN GFSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123i6n()
@ 8,14 GET GFGetPropVT ;
	PICTURE "@*HN GFGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _2wz123i6q()
@ 2,1 GET GFChk_Identidade ;
	PICTURE "@*HN GFChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _2wz123i6t()
@ 1,1 GET GFFind ;
	PICTURE "@*HN GFFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123i6w()
@ 14,1 GET GFGetFieldValue ;
	PICTURE "@*HN GFGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _2wz123i71()
@ 13,1 GET GF_Refresh ;
	PICTURE "@*HN GF_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _2wz123i73()
@ 16,1 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 18,1 GET GFLerRegistro ;
	PICTURE "@*HN GFLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _2wz123i77()
@ 10,12 GET GFWriteProp ;
	PICTURE "@*HN GFWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _2wz123i7b()
@ 19,1 GET GFSalvarRegistro ;
	PICTURE "@*HN GFSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _2wz123i7c()
@ 17,1 GET GFExiste ;
	PICTURE "@*HN GFExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123i7d()
@ 20,1 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 15,1 GET GFGetAlias ;
	PICTURE "@*HN GFGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _2wz123i7e()



READ


#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G18           DFVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:    2  º
*       º Variable:            DFVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      1                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g18     &&  DFVerifyInst VALID
#REGION 1
return
*---------------------------------------------------------------*



FUNCTION DFVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("DocFisca")


	DO CASE

		CASE TYPE("PBDocFiscaAlias") = "U" ;
		   		OR EMPTY(PBDocFiscaAlias) ;
		   		OR !USED(PBDocFiscaAlias)
			=DFCreate()					

		CASE !("DOCFISCA.DBF" $ DBF(PBDocFiscaAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBDocFiscaAlias
			=DFCreate()					


		CASE  !(LSPath $ DBF(PBDocFiscaAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=DFDestroi()				
			=DFCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G1E           DFCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:    3  º
*       º Variable:            DFCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      2                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g1e     &&  DFCreate VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBDocFiscaAlias") <> "U" ;
	   		AND !EMPTY(PBDocFiscaAlias) ;
	   		AND USED(PBDocFiscaAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBDocFiscaAlias

	IF USED("DocFisca")
	     =NetArqAgain("DocFisca")
	     PBDocFiscaAlias     = Alias()
	ELSE
	     =NetArqAgain("DocFisca")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("DocFisca")
	     PBDocFiscaAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBDocFiscaAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTDocFisca[LMaxDim]
    PUBLIC DIMENSION VDDocFisca[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFDocFisca[1]      && VETOR CABECALHO DOS CAMPOS
    PUBLIC DIMENSION VCDocFisca[2,3]	&& VETOR PARA CONFIGURACOES
	=AFIELDS(VFDocFisca)



	*-----------------------------------------------------------*
	=DFReadProperty()
	=DFSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G1K           DFDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:    4  º
*       º Variable:            DFDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      3                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g1k     &&  DFDestroi VALID
#REGION 1
return
*---------------------------------------------------------------*


FUNCTION DFDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBDocFiscaAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBDocFiscaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBDocFiscaAlias
	*  3- Se aplicar um FECHAMENTO a PBDocFiscaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBDocFiscaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBDocFiscaAlias)) OR ;
	   !("DOCFISCA.DBF" $ DBF(PBDocFiscaAlias))

		RELEASE PBDocFiscaAlias
    	RELEASE VTDocFisca
	    RELEASE VDDocFisca
		RELEASE VFDocFisca
		RELEASE VCDocFisca
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBDocFiscaAlias) AND USED(PBDocFiscaAlias)
		SELECT &PBDocFiscaAlias
		USE
	ENDIF	
	RELEASE PBDocFiscaAlias
    RELEASE VTDocFisca
    RELEASE VDDocFisca
	RELEASE VFDocFisca
	RELEASE VCDocFisca

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G1P           DFReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:    5  º
*       º Variable:            DFReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      4                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g1p     &&  DFReadProp VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=DFVerifyInst()

	SELE &PBDocFiscaAlias
	SCATTER TO VTDocFisca
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G1W           DFSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:    6  º
*       º Variable:            DFSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      5                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g1w     &&  DFSetDerivadas VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

**	=DFVerifyInst()
	*--------------------------------------------------------------*
    VDDocFisca(1,1) = "NAOINFORMADO"
   	VDDocFisca(1,2) = 0
   	VDDocFisca(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G21           DFSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:    7  º
*       º Variable:            DFSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      6                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g21     &&  DFSetPropVT VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue


	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
						PrmValue,;
						    PBDocFiscaAlias,;
						    VTDocFisca,;
						    VDDocFisca,;
						    VFDocFisca,;
						    VCDocFisca)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G26           DFGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:    8  º
*       º Variable:            DFGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      7                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g26     &&  DFGetPropVT VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBDocFiscaAlias,;
	            VTDocFisca,;
	            VDDocFisca,;
			    VFDocFisca,;
			    VCDocFisca)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G29           DFChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:    9  º
*       º Variable:            DFChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      8                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g29     &&  DFChk_Identidade VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFChk_Identidade
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc



	PRIVATE LFretorno
	LFretorno = .t.



	=DFVerifyInst()
    =DFSetPropVT("EMPRESA",PrmEmp)
    =DFSetPropVT("MOD_DOC",PrmMod_doc)
    =DFSetPropVT("COD_IDFORN",PrmCod_IDForn)
    =DFSetPropVT("NRO_DOC",PrmNro_Doc)
    =DFSetPropVT("SERIE_DOC",PrmSerie_Doc)


	LFretorno=DFFind()
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G2E           DFFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   10  º
*       º Variable:            DFFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      9                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g2e     &&  DFFind VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFFind

	PRIVATE LEmpresa,;
			LMod_doc,;
			LCod_IDForn,;
			LNro_Doc,;
			LSerie_Doc
			
	
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=DFVerifyInst()


	LEmpresa    = DFGetPropVT("Empresa")
	LMod_Doc    = DFGetPropVT("Mod_Doc")
	LCod_IdForn = DFGetPropVT("Cod_IdForn")
	LNro_Doc    = DFGetPropVT("Nro_Doc")
	LSerie_Doc  = DFGetPropVT("Serie_Doc")


	SELE &PBDocFiscaAlias
	SET ORDER TO TAG DOCFISCAL

	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	     STR(LNro_Doc,7)+LSerie_Doc


	
	IF FOUND()
		=DFReadProperty()
		=DFSetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G2L           DFGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   11  º
*       º Variable:            DFGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      10                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g2l     &&  DFGetFieldValue VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFGetFieldValue
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmField

	IF !DFChk_Identidade(PrmEmp,;
					  PrmMod_doc,;
					  PrmCod_IDForn,;
					  PrmNro_Doc,PrmSerie_Doc)
					
		DO WHILE .T.
			=UPerrosys("Chamada GetFieldValue para Reg. Inexistente!")
		ENDDO
	ENDIF				



RETURN(DFGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G2R           DF_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   12  º
*       º Variable:            DF_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      11                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g2r     &&  DF_Refresh VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DF_Refresh
PARAMETERS  PrmEmpresa,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc
			
	
	


	PRIVATE LFreturn

	=DFVerifyInst()


	= DFSetPropVT("Empresa"   ,PrmEmpresa)
	= DFSetPropVT("Mod_Doc"   ,PrmMod_doc)
	= DFSetPropVT("Cod_IdForn",PrmCod_IDForn)
	= DFSetPropVT("Nro_Doc"   ,PrmNro_Doc)
	= DFSetPropVT("Serie_Doc" ,PrmSerie_Doc)

	*----------------------------------------------------------------*


	=DFFind()
	
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G2X           DFLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   14  º
*       º Variable:            DFLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      12                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g2x     &&  DFLerRegistro VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFLerRegistro
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = DFChk_Identidade(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,PrmSerie_Doc)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G32           DFWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   15  º
*       º Variable:            DFWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      13                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g32     &&  DFWriteProp VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=DFVerifyInst()

	SELE &PBDocFiscaAlias
	=RLOCK()
	GATHER FROM  VTDocFisca
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G37           DFSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   16  º
*       º Variable:            DFSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      14                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g37     &&  DFSalvarRegistro VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFSalvarRegistro


	PRIVATE LFretorno
	LFretorno = .t.

	IF !DFExiste()
		SELE &PBDocFiscaAlias
		APPEND BLANK
		LFretorno=DFWriteProp()
	ELSE
		SELE &PBDocFiscaAlias
		LFretorno=DFWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G3B           DFExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   17  º
*       º Variable:            DFExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      15                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g3b     &&  DFExiste VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFExiste

	PRIVATE LEmpresa,;
			LMod_doc,;
			LCod_IDForn,;
			LNro_Doc,;
			LSerie_Doc
			
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()


	LEmpresa    = DFGetPropVT("Empresa")
	LMod_Doc    = DFGetPropVT("Mod_Doc")
	LCod_IdForn = DFGetPropVT("Cod_IdForn")
	LNro_Doc    = DFGetPropVT("Nro_Doc")
	LSerie_Doc  = DFGetPropVT("Serie_Doc")


	SELE &PBDocFiscaAlias
	SET ORDER TO TAG DOCFISCAL
	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	     STR(LNro_Doc,7)+LSerie_Doc

	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G3I           DFGerNFDocFiscal VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   18  º
*       º Variable:            DFGerNFDocFiscal                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      16                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g3i     &&  DFGerNFDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFGerNFDocFiscal
PARAMETER PrmEmp,PrmDtIni,PrmDtFim




    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTA")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=DFVerifyInst()



	SELE &ALSNota
	SET ORDER TO TAG DATA
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() AND &ALSNota .empresa = PrmEmp ;
				AND &ALSNota .data >= PrmDtIni ;
    	        AND &ALSNota .data <= PrmDtFim ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

	DO WHILE !EOF() ;
					AND	LFsegue = .t. ;
					AND &ALSNota .empresa = PrmEmp ;
					AND &ALSNota .data >= PrmDtIni ;
	                AND &ALSNota .data <= PrmDtFim
		
		=UPtermo()


		DO CASE
			CASE &ALSNota .Nota > 2000000 AND  &ALSNota .Nota < 3000000
				LsOrientacao = "SERVICO"

			CASE &ALSNota .Nota > 4000000 AND  &ALSNota .Nota < 5000000
				LsOrientacao = "SERVICO"

			CASE  &ALSNota .totservico > 0 AND &ALSNota .totproduto > 0
				LsOrientacao = "PRODUTO/SERVICO"

			CASE  &ALSNota .totservico > 0
				LsOrientacao = "SERVICO"

			CASE   &ALSNota .totproduto > 0
				LsOrientacao = "PRODUTO"
			OTHERWISE
				LsOrientacao = "PRODUTO/SERVICO"

			
		ENDCASE
		
		




		=DFConvrtNFDocFiscal(PrmEmp, &ALSNota .Nota,LsOrientacao)

		HFIM =TIME()
		MSG  = "NF Saida:"+ STR( &ALSNota .nota ,7);
                   +" de "+ DTOC( &ALSNota .data );
		 	   +"Geradas:"+ STR(CTR,6);
		 	   +    " de "+ HINI ;
		 	   +      "->"+ HFIM
		WAIT WINDOW MSG NOWAIT

		SELE  &ALSNota
		SKIP
		CTR = 	CTR + 1
	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G3Q           DFv10GravaXMLDocFiscal VALID       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   20  º
*       º Variable:            DFv10GravaXMLDocFiscal             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      17                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g3q     &&  DFv10GravaXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFv10GravaXMLDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmFileXML,;
			PrmNroIDfileXML,;
			PrmObjetivo





	IF TYPE("PrmObjetivo") <> "C" ;
	   OR !(PrmObjetivo $ "ESCRITURACAO/EMISSAO/CANCELAMENTO" )
		  PrmObjetivo = "ESCRITURACAO"
	ENDIF


	IF !DFLerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+PrmMOD_DOC+;
		      "FORN. : "+STR(PrmCOD_IDFORN,6)+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC
   	  return(.F.)
   ENDIF


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	*-------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	=EMLerRegistro(PrmEmp)

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("CGC")
	UNEM_CNPJ    =  STR(LFieldTmp,14)
	UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")


	SET POINT TO ","
	SET SEPARATOR  TO "."




	LSLinhaXML = ULtratalinha('<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('XML_OBJETIVO="'+;
	             PrmObjetivo +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*==========================================================*
	*  CAMPOS IDENTIFICADORES
	*==========================================================*

	=W_DEFPROC("EMPRESA.SPR")

	LSEmite_NFe = EMGetPropVT("EMITE_NFE")




	IF LSEmite_NFe $ "H"   && H=HOMOLOGACAO

		LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             "55" +;
	             '"')
                =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	ELSE
		LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             DFGetPropVT("MOD_DOC") +;
	             '"')
                =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	ENDIF

	LSLinhaXML = ULtratalinha('DFIS_IND_OPERACAO="'+;
	             DFGetPropVT("IND_OPER") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
	LSLinhaXML = ULtratalinha('DFIS_TP_MOVIMENTO="'+;
	             DFGetPropVT("TP_MOV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*

	LNNro_Doc  = DFGetPropVT("NRO_DOC")
	IF LNNro_Doc > 3000000
		LNNro_Doc = LNNro_Doc - 3000000
	ENDIF



	LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO_FISCAL="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*----------------------------------------------------*
	* SERIE UNICA => "0"
	*----------------------------------------------------*
	

	LSLinhaXML = DFGetPropVT("SERIE_DOC")
	IF "U" $ LSLinhaXML
		LSLinhaXML = "0"
	ENDIF

	LSLinhaXML = ULtratalinha('DFIS_SERIE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*
	LSLinhaXML = ULtratalinha('DFIS_STATUS="'+;
	             DFGetPropVT("DFISSTATUS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_IE_SUB_TRIB="'+;
	             DFGetPropVT("IE_SUBTRIB") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_MUNI_IBGE_FATO_GERADOR="'+;
	             DFGetPropVT("MUNIFATOGR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_NOME="'+;
	             DFGetPropVT("NOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_RAZAO_SOCIAL="'+;
	             DFGetPropVT("RAZAOSOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CPF="'+;
	             DFGetPropVT("CPF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CNPJ="'+;
	             DFGetPropVT("CNPJ") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IE="'+;
	             DFGetPropVT("IE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_SUFRAMA="'+;
	             DFGetPropVT("SUFRAMA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_DDD="'+;
	             DFGetPropVT("DDD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_E_MAIL="'+;
	             "" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_FONE="'+;
	             DFGetPropVT("FONE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TP_LOGADOURO="'+;
	             DFGetPropVT("TP_LOGRAD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_LOGRADOURO="'+;
	             DFGetPropVT("LOGRADOURO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_LOGRADOURO="'+;
	             DFGetPropVT("NRO_LOGRAD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_COMPL_LOGRADOURO="'+;
	             DFGetPropVT("COMPL_LOGR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_BAIRRO="'+;
	             DFGetPropVT("BAIRRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ZONA="'+;
	             ("") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ALLTRIM(DFGetPropVT("MUNI_IBGE"))
	IF LEN(LSLinhaXML) < 7
		LSLinhaXML = REPLICATE("0",7-LEN(LSLinhaXML))
	ENDIF


	LSLinhaXML = ULtratalinha('DFIS_MUNI_IBGE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MUNI_NOME="'+;
	             DFGetPropVT("MUNI_NOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_UF="'+;
	             DFGetPropVT("UF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_CEP="'+;
	             DFGetPropVT("CEP") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_PAIS="'+;
	             DFGetPropVT("PAIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CODIGO_PAIS="'+;
	              "1058" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------*


	LSLinhaXML = ULtratalinha('DFIS_OPCM_SIGLA="'+;
	             DFGetPropVT("TIPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NATUREZA_OPERACAO="'+;
	             DFGetPropVT("NAT_OPER") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IND_EMITENTE="'+;
	             DFGetPropVT("IND_EMITEN") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_SITUACAO_CODIGO="'+;
	             DFGetPropVT("COD_SIT") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = DFGetPropVT("IND_FRETE")
	IF LSLinhaXML = "1"
	    LSLinhaXML    =   "0"
	else
	    LSLinhaXML    =   "1"
	ENDIF
	LSLinhaXML = ULtratalinha('DFIS_IND_FRETE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DT_DOC="'+;
	             DTOC(DFGetPropVT("DT_DOC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_HORA_DOC="'+;
	             DFGetPropVT("HORA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*	LSLinhaXML = ULtratalinha('DFIS_DT_ENT_OU_SAIDA="'+;
*	             DTOC(DFGetPropVT("DT_ENTSAI")) +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*

	LSLinhaXML = ULtratalinha('DFIS_DT_ENT_OU_SAIDA="'+;
	             ;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*	LSLinhaXML = ULtratalinha('DFIS_HR_ENT_OU_SAIDA="'+;
*	             DFGetPropVT("HR_ENTSAI") +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*

	LSLinhaXML = ULtratalinha('DFIS_HR_ENT_OU_SAIDA="'+;
	             ;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DT_CANC="'+;
	             DTOC(DFGetPropVT("DT_CANC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_PGTO_CODIGO="'+;
	             DFGetPropVT("TP_PG") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_PGTO_DESCRICAO="'+;
	             DFGetPropVT("TP_PGDESCR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ESPECIE="'+;
	             DFGetPropVT("ESPECIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MARCA="'+;
	             DFGetPropVT("MARCA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IND_USO_ARMA="'+;
	             DFGetPropVT("INDUSOARMA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IND_OPER_VEICULO="'+;
	             DFGetPropVT("IND_OPVEIC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_AUT_SEFAZ_COMBUSTIVEL="'+;
	             DFGetPropVT("AUTSEFAZCM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_DOC_IMPORTACAO="'+;
	             DFGetPropVT("TPDOCIMPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
				
	LSLinhaXML = ULtratalinha('DFIS_NRO_DOC_IMPORTACAO="'+;
	             DFGetPropVT("NRODOCIMPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_NRO_PASSE_FISCAL="'+;
	             DFGetPropVT("NROPASSEFI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_PROC_CONCESSORIO="'+;
	             DFGetPropVT("NROPROCCON") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ORIGEM_PROC_CONCESSORIO="'+;
	             DFGetPropVT("ORGPROCCON") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_INF_COMPLEMENTARES="'+;
	             DFGetPropVT("INF_COMPLE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = "SIM"
	LSLinhaXML = ULtratalinha('DFIS_TRIBUTADA_MUNICIPIO="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

    *-------------------------------------------------------------*
   	LSLinhaXML = ULtratalinha('DFIS_PESO_BRUTO="'+;
	             STR(DFGetPropVT("PESO_BRUTO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PESO_LIQUIDO="'+;
	             STR(DFGetPropVT("PESO_LIQ"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_QTDE_VOLUMES="'+;
	             STR(DFGetPropVT("QTDE_VOL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_NUMERACAO_VOLUMES="'+;
	             "" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TP_CARGA="'+;
	             DFGetPropVT("TP_CARGA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TEMPERATURA="'+;
	             STR(DFGetPropVT("TEMPERATUR"),6,1) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_ECF_MODELO="'+;
	             DFGetPropVT("MODELO_ECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ECF_NUMERO_CAIXA="'+;
	             DFGetPropVT("NRO_CX_ECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ECF_NUMERO_CUPOM_COO="'+;
	             DFGetPropVT("NRO_CPMECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ECF_NUMERO_SERIE="'+;
	             DFGetPropVT("NRO_SERECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*------------------------------------------------------------*
	*----------
	*LSLinhaXML = ULtratalinha('DFIS_REF_NRO_DOCUMENTO="'+;
	*             SUBS(STR(DFGetPropVT("REF_NRODOC"),7),2) +;
	*             '"')
	*			=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *----------


	LNNro_Doc  = DFGetPropVT("REF_NRODOC")
	IF LNNro_Doc > 3000000
		LNNro_Doc = LNNro_Doc - 3000000
	ENDIF



	LSLinhaXML = ULtratalinha('DFIS_REF_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_SERIE="'+;
	             DFGetPropVT("REF_SERIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	

	LSLinhaXML = ULtratalinha('DFIS_REF_DT_DOC="'+;
	             DTOC(DFGetPropVT("REF_DT_DOC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_INDOPERACAO="'+;
	             DFGetPropVT("REF_INDOPE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_TP_MOVIMENTO="'+;
	             DFGetPropVT("REF_TP_MOV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_IND_EMITENTE="'+;
	             DFGetPropVT("REF_INDEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_MOD_DOCUMENTO="'+;
	             DFGetPropVT("REF_MODDOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_CHV_NFe="'+;
	             DFGetPropVT("REF_CHVNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_DGT_NFe="'+;
	             DFGetPropVT("REF_DGTNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_CODIGO_UF_EMITENTE="'+;
	             DFGetPropVT("REF_UF_CDG") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_DT_EMISSAO_NFE="'+;
	             DTOC(DFGetPropVT("REF_DTNFE")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_FORMATO_IMP_DANF="'+;
	             DFGetPropVT("REFFRDANF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_FORMA_EMISSAO_NFE="'+;
	             DFGetPropVT("REFTPEMIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_AMBIENTE_EMISSAO_NFE="'+;
	             DFGetPropVT("REFTPAMBIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_PROCESSO_EMISSAO_NFE="'+;
	             DFGetPropVT("REFPROCEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_VERSAO_NFE="'+;
	             DFGetPropVT("REFVERSAO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_FINALIDADE_EMISSAO_NFE="'+;
	             DFGetPropVT("REFFINALID") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*------------------------------------------------------------*
	LSLinhaXML = ULtratalinha('NFE_CHAVE_NFE="'+;
	             DFGetPropVT("NFE_CHV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_AMBIENTE_EMISSAO="'+;
	             DFGetPropVT("AMBIENTNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_DATA_EMISSAO="'+;
	             DTOC(DFGetPropVT("DTEMINFE")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('NFE_FINALIDADE_EMISSAO="'+;
	             DFGetPropVT("FNLDAD_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('NFE_FORMA_EMISSAO="'+;
	             DFGetPropVT("NFEFRMAEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_FORMATO_IMPRESSAO_DANF="'+;
	             DFGetPropVT("FRMTODANF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_PROCESSO_EMISSAO="'+;
	             DFGetPropVT("PROCEMINFE") +;
	             '"')
	             =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('NFE_STATUS="'+;
	             DFGetPropVT("NFE_STATUS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_STATUS_DESCRICAO="'+;
	             "" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('NFE_NUMERO_RECIBO="'+;
	             DFGetPropVT("NFE_RECIBO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_NUMERO_PROTOCOLO="'+;
	             DFGetPropVT("NFE_PROTOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('NFE_JUSTIFICATIVA="'+;
	             DFGetPropVT("NFEJSTFCAN") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('NFE_PROTOCOLO_CANCELAMENTO="'+;
	             DFGetPropVT("NFEPRTCCAN") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VERSAO_NFE="'+;
	             DFGetPropVT("VERSAO_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*-- TRANSPORTADORA  -------------------------------------*


	LSLinhaXML = ULtratalinha('DFTR_TEM_TRANSPORTADORA="'+;
	             DFGetPropVT("TRSTEM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_RNTC="'+;
	             DFGetPropVT("TRSRNTC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_PLACA_UF="'+;
	             DFGetPropVT("TRSPLACAUF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_PLACA_VEICULO="'+;
	             DFGetPropVT("TRSPLACA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_CPFCNPJ="'+;
	             DFGetPropVT("TRSCPFCNPJ") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_NOME="'+;
	             DFGetPropVT("TRSNOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_UF="'+;
	             DFGetPropVT("TRSUF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_IE="'+;
	             DFGetPropVT("TRSIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_TP_LOGRADOURO="'+;
	             DFGetPropVT("TRSLOGRA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_LOGRADOURO="'+;
	             DFGetPropVT("TRSLOGRA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_NRO="'+;
	             DFGetPropVT("TRSNRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COMPLEMENTO="'+;
	             DFGetPropVT("TRSCOMPLEM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_CEP="'+;
	             DFGetPropVT("TRSCEP") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_MUNI_IBGE="'+;
	             DFGetPropVT("TRSMUNIBGE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_MUNI_NOME="'+;
	             DFGetPropVT("TRSMUNNOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_BAIRRO="'+;
	             DFGetPropVT("TRSBAIRRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_PAIS="'+;
	             DFGetPropVT("TRSPAIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_FONE="'+;
	             DFGetPropVT("TRSFONE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*--------------------------------------------------------------*
	LSLinhaXML = ULtratalinha('DFTR_COLETA_CPFCNPJ="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COLETA_IE="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COLETA_NOME="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_COLETA_MUNI_IBGE="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COLETA_ENDERECO="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*--------------------------------------------------------------*
	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_CPFCNPJ="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_IE="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_NOME="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_MUNI_IBGE="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_ENDERECO="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*----------------------------------------------------*

	*----------------------------------------------------*

	LSLinhaXML = ULtratalinha('DFIS_VLR_DOCUMENTO="'+;
	             STR(DFGetPropVT("VLR_DOC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_SERVICOS="'+;
	             STR(DFGetPropVT("VLR_SERVIC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_FRETE="'+;
	             STR(DFGetPropVT("VLR_FRETE"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_DESCONTO="'+;
	             STR(DFGetPropVT("VLR_DESCON"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_SEGURO="'+;
	             STR(DFGetPropVT("VLR_SEGURO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_MERCADORIAS="'+;
	             STR(DFGetPropVT("VLR_MERCAD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ABATE_NT="'+;
	             STR(DFGetPropVT("VLRABAT_NT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_DESPESAS="'+;
	             STR(DFGetPropVT("VLR_DESPES"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_DESP_FINANCEIRA="'+;
	             STR(DFGetPropVT("DESPFINANC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_OUTRAS_DESP_ACES="'+;
	             STR(DFGetPropVT("OUTDSPACES"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	********************************************************************
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	********************************************************************
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	********************************************************************

	*----------------------------------------------------*
	*     Campos de Preenchimento Doc Fiscal Para EFD versao 1.0
	* (SERAO DESCARTADOS NA PROXIMA VERSÃO )-->
	* nao e necessario preencher para versoes NFe e EFD que se
	* baseiam na TABELA DFIS DOCUMENTOS FISCAIS
	*
	*----------------------------------------------------*



	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS="'+;
	             STR(DFGetPropVT("BC_ICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS="'+;
	             STR(DFGetPropVT("VLR_ICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS_RTD="'+;
	             STR(DFGetPropVT("BC_ICMSRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_RTD="'+;
	             STR(DFGetPropVT("VLRICMSRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_IPI="'+;
	             STR(DFGetPropVT("BC_IPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_IPI="'+;
	             STR(DFGetPropVT("VLR_IPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS="'+;
	             STR(DFGetPropVT("VLR_PIS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS="'+;
	             STR(DFGetPropVT("VLR_COFINS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_RTD="'+;
	             STR(DFGetPropVT("VLR_PISRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_RTD="'+;
	             STR(DFGetPropVT("VLR_COFRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_IMPORTACAO="'+;
	             STR(DFGetPropVT("VLRPISIMPO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_IMPORTACAO="'+;
	             STR(DFGetPropVT("VLRCOFIMPO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_SERVICO_NT="'+;
	             STR(DFGetPropVT("VLRSRVCONT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISS="'+;
	             STR(DFGetPropVT("VLRBCISSQN"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ISS="'+;
	             STR(DFGetPropVT("VLR_ISSQN"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_IR="'+;
	             STR(DFGetPropVT("VLR_BCIRRF"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_IR="'+;
	             STR(DFGetPropVT("VLR_IRRF"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
				

	LSLinhaXML = ULtratalinha('DFIS_VLR_IR_RTD="'+;
	             STR(0,18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_PREVIDENCIA="'+;
	             STR(DFGetPropVT("VLR_BCPREV"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PREVIDENCIA="'+;
	             STR(DFGetPropVT("VLR_PREV"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*-------------------------------------------------------*


*
*	LSLinhaXML = ULtratalinha('DFIS_TP_CREDITO="'+;
*	             DFGetPropVT("TP_CREDITO") +;
*	             '"')
*				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS_RTD="'+;
	             STR(DFGetPropVT("BCBRICMSRT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS="'+;
	             STR(DFGetPropVT("BCBRICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS_SO="'+;
	             STR(DFGetPropVT("BCBRICMSSO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("BCBRRTDENT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_COFINS="'+;
	             STR(DFGetPropVT("BC_COFINS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_CSLL="'+;
	             STR(DFGetPropVT("BC_CSLL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS_SO="'+;
	             STR(DFGetPropVT("BC_ICMS_SO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_SO="'+;
	             STR(DFGetPropVT("VLR_ICMSSO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISENTA_ICMS="'+;
	             STR(DFGetPropVT("BCISENICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISENTA_IPI="'+;
	             STR(DFGetPropVT("BCISENIPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_OUTR_ICMS="'+;
	             STR(DFGetPropVT("BCOUTRICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_PIS="'+;
	             STR(DFGetPropVT("BC_PIS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("BCRTDENTRA"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_CSLL="'+;
	             STR(DFGetPropVT("VLR_CSLL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("ICMSRTDENT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISS_RTD="'+;
	             STR(DFGetPropVT("BC_ISS_RTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_ISS_RTD="'+;
	             STR(DFGetPropVT("ISS_RTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_PRODUTOS_SERVICOS="'+;
	             STR(DFGetPropVT("TTPRODSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_ALIQ_COFINS="'+;
	             STR(DFGetPropVT("VLRALQCOFI"),5,2) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IM_INSCRICAO_MUNICIPAL="'+;
	             DFGetPropVT("IM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_SERVICOS="'+;
	             STR(DFGetPropVT("VLRPISSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_SERVICOS="'+;
	             STR(DFGetPropVT("VLRCOFSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_CODIGO_PAIS_DESTINATARIO="'+;
	              "1058" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*-------------------------------------------------------*
	LSLinhaXML = ULtratalinha('/>')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)

FUNCTION ULtratalinha
PARAMETERS LSLINHA

	LSLINHA = UPPER(LSLINHA)
	LSLINHA = RTRIM(LSLINHA)

RETURN(LSLINHA)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G5X           DFGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   21  º
*       º Variable:            DFGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      18                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g5x     &&  DFGetAlias VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFGetAlias

	=DFVerifyInst()

RETURN(PBDocFiscaAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G60           DFGerXMLPeriodoDocFiscal VALID     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   22  º
*       º Variable:            DFGerXMLPeriodoDocFiscal           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      19                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g60     &&  DFGerXMLPeriodoDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFGerXMLPeriodoDocFiscal
PARAMETER PrmEmpresa,PrmDtIni,PrmDtFim





	PRIVATE	 PrmObjetivo
		
		
		
	*-----------------------------------------------------*
	* PrmObjetivo => indica o objetivo da gera‡Æo do xml pode ser:
	*
	*      "EMISSAO"      => Para EMISSOA - NFe/NFSe/CUPOM
	*      "ESCRITURACAO" => Para registro do documento
	*      "CANCELAMENTO" => Para Cancelar o Documento
	*-----------------------------------------------------*

    PrmObjetivo = "ESCRITURACAO"


	*-----------------------------------------------------*

	PRIVATE LSalias
	
	PRIVATE PrmAlsDF

	PRIVATE LNDocFiscaCtrRegistro	

	LSalias = ALIAS()
	PrmAlsDF = DFGetAlias()




	*-------------------------------------------------------*


   	PRIVATE LSfileXML,LNroIDfileXML, LSnomeArqXml

	LSnomeArqXml = STR(PrmEmpresa,2)+;
				   "DC"+;
				   STR(MONTH(PrmDtFim),2)+;
				   STR(DAY(PrmDtFim),2)

	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")

   	LSfileXML	= "\SCGC\EFD\"+LSnomeArqXml+".XML"

  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return
   	endif


	*---------------------------------------------------*

	SELE &PrmAlsDF
	SET ORDER TO TAG DATA_DOC
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+DTOS(PrmDtIni)
	SET NEAR OFF

	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNDocFiscaCtrRegistro = RECNO()

	COUNT  WHILE !EOF() ;
	        AND PrmEmpresa =  &PrmAlsDF .empresa;
	        AND PrmDtIni   <= &PrmAlsDF .DT_ENTSAI ;
	        AND PrmDtFim   >= &PrmAlsDF .DT_ENTSAI ;
         TO LNimpressao
	GO LNDocFiscaCtrRegistro
	LNimpressos = 0
	*----------------------------------------------------*



	=DFInicioXML(LSfileXML,LNroIDfileXML)

	SELE &PrmAlsDF
	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa =  &PrmAlsDF .empresa;
	        AND PrmDtIni   <= &PrmAlsDF .DT_ENTSAI ;
	        AND PrmDtFim   >= &PrmAlsDF .DT_ENTSAI

		=UPtermo()



		=DFGravaXMLDocFiscal(;
				&PrmAlsDF .Empresa,;
				&PrmAlsDF .Mod_doc,;
				&PrmAlsDF .Cod_IDForn,;
				&PrmAlsDF .Nro_Doc,;
				&PrmAlsDF .Serie_Doc,;
				LSfileXML,;
				LNroIDfileXML,;
				PrmObjetivo)



		SELE &PrmAlsDF
		SET ORDER TO TAG DATA_DOC
		*-----------------------*
		GO LNDocFiscaCtrRegistro
	
		SKIP
	
		LNDocFiscaCtrRegistro = RECNO()

	ENDDO

	=DFFinalXML(LSfileXML,LNroIDfileXML)

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G6C           DFModeloRefXML VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   23  º
*       º Variable:            DFModeloRefXML                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      20                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g6c     &&  DFModeloRefXML VALID
#REGION 1
RETURN

FUNCTION DFModeloRefXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\DOCFISCA.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\xmlDCFIS EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE xmlDCFIS


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G6G           DFInicioXML VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   24  º
*       º Variable:            DFInicioXML                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      21                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g6g     &&  DFInicioXML VALID
#REGION 1
RETURN

FUNCTION DFInicioXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML



	=DFModeloRefXML()  && VERIFICA ATUALIZACAO DO LAYOUT

	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDCFIS EXCL
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND xmlDCFIS.XML_ORDEM < 9999999999901
	
		LSLinhaXML = xmlDCFIS.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE xmlDCFIS
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G6L           DFFinalXML VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   25  º
*       º Variable:            DFFinalXML                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      22                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g6l     &&  DFFinalXML VALID
#REGION 1
RETURN

FUNCTION DFFinalXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDCFIS EXCL
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF xmlDCFIS.XML_ORDEM > 9999999999900
			LSLinhaXML = xmlDCFIS.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE xmlDCFIS
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G6O           DFGerNEDocFiscal VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   26  º
*       º Variable:            DFGerNEDocFiscal                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      23                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g6o     &&  DFGerNEDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFGerNEDocFiscal
PARAMETER PrmEmp,PrmDtIni,PrmDtFim




    PRIVATE ARQNotaEnt,ALSNotaEnt
	LSalias = ALIAS()

    ARQNotaEnt     = NetArqAgain("NotaEnt")
    ALSNotaEnt     = Alias()

	IF ( ARQNotaEnt) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNotaEnt")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=DFVerifyInst()


	SELE &ALSNotaEnt
	SET ORDER TO TAG DATA_FAT
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() AND &ALSNotaEnt .empresa = PrmEmp ;
				AND &ALSNotaEnt .data >= PrmDtIni ;
    	        AND &ALSNotaEnt .data <= PrmDtFim ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

	DO WHILE !EOF() ;
					AND	LFsegue = .t. ;
					AND &ALSNotaEnt .empresa = PrmEmp ;
					AND &ALSNotaEnt .data >= PrmDtIni ;
	                AND &ALSNotaEnt .data <= PrmDtFim
	

		=UPtermo()
		
		IF &ALSNotaEnt .TIPO $ "QLA/SCA"
			SKIP
			LOOP
		ENDIF

		IF   &ALSNotaEnt .ch_opera $"56" ;
		  OR LEFT( &ALSNotaEnt .situacao,1) <> "C"
			SKIP
			LOOP
		ENDIF



		HFIM =TIME()
		MSG  = "GERANDO NF ENTRADA:" +HINI+ "  " +STR(CTR,3)+ "  " + HFIM


		MSG  = "NF Entrada:"+ STR( &ALSNotaEnt .Nota ,7);
                   +" de "+ DTOC( &ALSNotaEnt .data );
		 	   +"Geradas:"+ STR(CTR,6);
		 	   +    " de "+ HINI ;
		 	   +      "->"+ HFIM

		WAIT WINDOW MSG NOWAIT


		=DFConvrtNEDocFiscal(PrmEmp, ;
		                     &ALSNotaEnt .Nota,;
							 &ALSNotaEnt .CodForn)


		SELE  &ALSNotaEnt
		SKIP
		CTR = 	CTR + 1
	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =up_fecha("&ALSNotaEnt")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G6V           DFSetConfig VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   27  º
*       º Variable:            DFSetConfig                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      24                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g6v     &&  DFSetConfig VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFSetConfig
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VCDocFisca(1,1) = "NAOINFORMADO"
   	VCDocFisca(1,2) = 0
   	VCDocFisca(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G6Z           DFConvrtNFDocFiscal VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   28  º
*       º Variable:            DFConvrtNFDocFiscal                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      25                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g6z     &&  DFConvrtNFDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

* PRECISO DEFINIR :
*---------------------------------------------------------------*
*           PrmEmpresa :  - a empresa
*           PrmNota....:  - Nro da nota a converte
*
*
*           LNComBaseNaNota  -Se for converter uma Copia de Copom
*                                -> tenho que tomar por base os dados
*                                do cupom que gerou a c¢pia pq o cupom
*                                nao gera registro fisico de seus itens
*
*                             -Se for uma nota direta (nÆo copia
*                                de cupom) sera gerado com base na
*                                 propria nota
*
*---------------------------------------------------------------*


FUNCTION DFConvrtNFDocFiscal
PARAMETERS PrmEmpresa,PrmNota,PrmOrientacao

	PRIVATE PrmAlias
	PRIVATE LCupomAlias
	PRIVATE LOrc_AnexAlias



	PRIVATE  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc




	=DFVerifyInst()


	=W_DEFPROC("NOTA.SPR")
	PrmAlias = NFGetAlias()

	=W_DEFPROC("CUPOM.SPR")
	LCupomAlias = CPGetAlias()


	=W_DEFPROC("ORC_ANEX.SPR")
	LOrc_AnexAlias = OAGetAlias()



	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NFs nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"


		WAIT MSG NOWAIT
		RETURN(.F.)
	ENDIF





    IF   &PrmAlias .tipo ="ENT"   && NAO CONSIDERA "ENT"
		RETURN(.T.)
	ENDIF    	






	*---------------------------------------------------*
	* CONVERSAO DOS ITENS
	*---------------------------------------------------*

	=W_DEFPROC("DOCFISIT.SPR")
	=DIVerifyInst()




	=W_DEFPROC("DOCFISIT.SPR")
	IF !DIConvrtNFDocFiscal(PrmEmpresa,PrmNota,PrmOrientacao)
		WAIT WINDOW ;
		 "Nao foi possiver gerar itens do Doc Fiscal<ENTER> " NOWAIT
		RETURN(.F.)
	ENDIF



	*---------------------------------------------------*

	PRIVATE  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc



	PrmSerie   		= &PrmAlias .Serie
	PrmTipo    		= &PrmAlias .tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""
	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


    m.EMPRESA    =   &PrmAlias .Empresa
    m.TIPO    	 =   &PrmAlias .tipo
    m.MOD_DOC    =   RtnMod_Doc
    m.COD_IDFORN  =   RtnCOD_IDFORN
    m.NRO_DOC     =   RtnNro_Doc
    m.SERIE_DOC   =   RtnSerie_Doc



	m.nro_nota  =  &PrmAlias .Nota
	m.nro_isi   =  &PrmAlias .orcamento


	*---------------------------------------------------*


    m.NAT_OPER    =   &PrmAlias .natureza

    IF EMPTY(m.nat_oper)
    	=W_DEFPROC("TIPOOPER.SPR")
		LFieldTmp    = TPGetFieldValue("S",  &PrmAlias .tipo ,"DESCNATU")
    	m.NAT_OPER   =   LFieldTmp
    ENDIF




	IF LEFT( &PrmAlias .tipo,2) = "ET"   && ENTRADAS DEVOLUCAO
	    m.IND_OPER    =   "0"    && 0-ENTRADA  1-SAIDA
    	m.TP_MOV      =   "ENTRADA" 	&& ENTRADA  // SAIDA
	ELSE	
	    m.IND_OPER    =   "1"    && 0-ENTRADA  1-SAIDA
    	m.TP_MOV      =   "SAIDA" 	&& ENTRADA  // SAIDA
	ENDIF


    m.IND_EMITEN  =   "0"  && 0-EMISSAO PROPRIA // 1-TERCEIROS

	&& 00-DOC REGULAR // 02-DOC CANCELADO
	DO CASE

		CASE  &PrmAlias .Status = 2   && CANCELADO
			LFieldTmp    = "02"

		CASE  &PrmAlias .TIPO = "CPM"   && COPIA DE CUPOM
			LFieldTmp    = "00"     && CUPOM


		OTHERWISE
			LFieldTmp    = "00"     && DOC REGULAR
	ENDCASE	

    m.COD_SIT    = LFieldTmp
    m.MOD_NOTA   = ""		&& NAO INFORMADO
    m.DT_DOC     = &PrmAlias .data
    m.HORA    	 = &PrmAlias .HORA

	IF EMPTY(M.HORA)
	  M.HORA = "08:00:00"
	ENDIF


    m.NFE_STATUS = &PrmAlias .NFE_STATUS
    m.NFE_CHV  	 = &PrmAlias .NFE_CHV
    m.NFE_RECIBO = &PrmAlias .NFE_RECIBO
    m.NFEJSTFCAN = &PrmAlias .NFEJSTFCAN
    m.NFEPRTCCAN = &PrmAlias .NFEPRTCCAN



	&& 00-DOC REGULAR // 02-DOC CANCELADO
	DO CASE
		CASE &PrmAlias .Status = 2   && CANCELADO
			LFieldTmp    = &PrmAlias .Data  && DATA CANCELAMENTO

		OTHERWISE
			LFieldTmp    = {}
	ENDCASE	
    m.DT_CANC    =  LFieldTmp
    m.VLR_DOC    =  &PrmAlias .Total_nota

*-> NFe ==>  0-A VISTA   1-A PRAZO   2-OUTROS SEM PGTO
*-> efd ==>  0-A VISTA   1-A PRAZO   9-OUTROS SEM PGTO

	IF &PrmAlias .Ch_Opera= "1"  && 1-VENDA
		IF &PrmAlias .Tp_pgto = 1
			LFieldTmp    = "0"
		ELSE
			LFieldTmp    = "1"
		ENDIF
	ELSE
		LFieldTmp    = "0"
	ENDIF
    m.TP_PG    =   LFieldTmp

	IF &PrmAlias .Ch_Opera= "1"  && 1-VENDA
		IF &PrmAlias .Tp_pgto = 1
			LFieldTmp    = "A VISTA"
		ELSE
			LFieldTmp    = "A PRAZO"
		ENDIF
	ELSE
		LFieldTmp    = "SEM PGTO"
	ENDIF
    m.TP_PGDESCR    =   LFieldTmp

    m.VLR_DESCON    =   0
    m.VLRABAT_NT    =   0
    m.VLR_SERVIC    =   &PrmAlias .TotServico
    m.VLR_MERCAD    =   &PrmAlias .TotProduto
	IF &PrmAlias .pgto_frete = 1
	    m.IND_FRETE    =   "1"
	else
	    m.IND_FRETE    =   "2"
	ENDIF	
    m.VLR_FRETE    =   &PrmAlias .VlrFrete
    m.VLR_SEGURO   =   &PrmAlias .VlrSeguro
    m.VLR_DESPES   =   &PrmAlias .VlrDespes
    m.OUTDSPACES   =   0
    m.BC_ICMS      =   &PrmAlias .Base_Icms
    m.VLR_ICMS     =   &PrmAlias .Vlr_Icms
    m.BC_ICMSRTD   =   &PrmAlias .Base_subs
    m.VLRICMSRTD   =   &PrmAlias .ICms_Subs
    m.BC_IPI   	   =   &PrmAlias .Base_IPI
    m.VLR_IPI      =   &PrmAlias .Vlr_ipi

    m.VLR_PIS      =   0   && NAO INFORMADO
    m.VLR_COFINS   =   0   && NAO INFORMADO
    m.VLR_PISRTD   =   0   && NAO INFORMADO
    m.VLR_COFRTD   =   0   && NAO INFORMADO

    m.INF_COMPLE   =  DFLimpaString(  &PrmAlias .citacao3 )

	IF  &PrmAlias .cupom > 0
		 m.INF_COMPLE = "COPIA DO CUPOM FISCAL N§ ";
		 				+ STR( &PrmAlias .cupom,6)
	ENDIF


    m.NROPROCCON   =   ""    && NAO INFORMADO
    m.ORGPROCCON   =   "0"   && NAO INFORMADO
    m.TPDOCIMPO    =   "0"   && NAO INFORMADO
    m.NRODOCIMPO   =   "0"   && NAO INFORMADO
    m.VLRPISIMPO   =   0     && NAO INFORMADO
    m.VLRCOFIMPO   =   0     && NAO INFORMADO

    m.VLRSRVCONT   =   &PrmAlias .Base_iss
    m.VLRBCISSQN   =   &PrmAlias .Base_iss
    m.VLR_ISSQN    =   &PrmAlias .Vlr_iss

    m.VLR_BCIRRF   =   0     && NAO INFORMADO
    m.VLR_IRRF     =   0     && NAO INFORMADO
    m.VLR_BCPREV   =   0     && NAO INFORMADO
    m.VLR_PREV     =   0     && NAO INFORMADO
    m.AUTSEFAZCM   =   ""    && NAO INFORMADO
    m.NROPASSEFI   =   ""    && NAO INFORMADO
    m.TEMPERATUR   =   0     && NAO INFORMADO


	
	=W_DEFPROC("CLIENTES.SPR")
	m.tp_pessoa =  CLDef_TipoPessoa( &PrmAlias .Favorecido)
	
	IF  m.tp_pessoa = 1
		LFieldTmp = CHRTRAN(STR(  &PrmAlias .Favorecido,11)," ","0")
	    m.CPF    =   LFieldTmp
	    m.CNPJ   =  ""

	ELSE
		LFieldTmp = CHRTRAN(STR(  &PrmAlias .Favorecido,14)," ","0")
	    m.CNPJ    =   LFieldTmp
	    m.CPF    =   ""
	ENDIF

    m.UF    	 =    &PrmAlias .UF

    m.UF_CODIGO  =    "" && NAO INFORMADO


    m.IE    	 =    &PrmAlias .Inscricao

	IF "ISENTO" $ m.IE
		m.IE = "ISENTO              " && ALGUNS CASOS ESTVA "IISENTO"
	ENDIF
		


    m.NOME          =   DFLimpaString( &PrmAlias .Nome )
    m.RAZAOSOC      =   DFLimpaString( &PrmAlias .Nome )


    m.TP_LOGRAD     =   "" && NAO INFORMADO
    m.LOGRADOURO    =   DFLimpaString(  &PrmAlias .Endereco )
    m.NRO_LOGRAD    =   "S/N"

	LFieldTmp 	    = CHRTRAN(STR(  &PrmAlias .CEP,8)," ","0")
    m.CEP           =   LFieldTmp

	LFieldTmp    =  &PrmAlias .Muni_IBGE
	LFieldTmp    =  CHRTRAN(STR(LFieldTmp,7)," ","0")
    m.MUNI_IBGE  =  LFieldTmp
    m.MUNI_NOME  =    &PrmAlias .Cidade

    m.BAIRRO     =   DFLimpaString(  &PrmAlias .Bairro)
    m.PAIS    	 =   "BRASIL"
    m.FONE    	 =  LEFT( ALLTRIM( &PrmAlias .Fone) ,10)

    m.IE_SUBTRIB =  &PrmAlias .InscSubst
    m.SUFRAMA    =  ""

	*---------------------------------------------------*




	*---------------------------------------------------*

	IF &PrmAlias .referencia <> &PrmAlias .orcamento
		=W_DEFPROC("CUPOM.SPR")
		IF CPLerRegistro(PrmEmpresa,  &PrmAlias .referencia )
			LCupomAlias = CPGetAlias()
		    m.REF_NRODOC    =   &PrmAlias .referencia
		    m.REF_SERIE     =    LEFT( &LCupomAlias .Serie +"   ",3)


			IF EMPTY(m.REF_SERIE)
	    		m.REF_SERIE  =     LEFT( "01   ",3)
			endif

	    	m.REF_DT_DOC    =   &LCupomAlias .data
		    m.REF_INDOPER   =   "1"    && 0-ENTRADA  1-SAIDA
		    m.REF_TP_MOV    =   "SAIDA" 	&& ENTRADA  // SAIDA
	    	m.REF_INDEMI    =   "0" && 0-EMIS. PROPRIA // 1-TERCEIROS

			DO CASE

				CASE &LCupomAlias .Nota > 1000000 ;
				    AND &LCupomAlias .Nota < 2000000
			    		m.REF_MODDOC    =   "2D"

				CASE &LCupomAlias .Nota > 3000000 ;
				    AND &LCupomAlias .Nota < 4000000
			    		m.REF_MODDOC    =   "55"
				OTHERWISE
					=W_DEFPROC("TIPOOPER.SPR")
					LFieldTmp    = ;
					 TPGetFieldValue("S",  &LCupomAlias .tipo ,"Cod_Mod_Rf")
				    m.REF_MODDOC    =   LFieldTmp
			ENDCASE
		ELSE
		    m.REF_NRODOC    =   0
		    m.REF_SERIE    =    "   "
	    	m.REF_DT_DOC    =   {}
		    m.REF_INDOPER   =   " "    && 0-ENTRADA  1-SAIDA
		    m.REF_TP_MOV    =   "" 	&& ENTRADA  // SAIDA
	    	m.REF_INDEMI    =   "" && 0-EMIS. PROPRIA // 1-TERCEIROS
    		m.REF_MODDOC    =   ""
		ENDIF

	ELSE
		    m.REF_NRODOC    =   0
		    m.REF_SERIE     =    "   "
	    	m.REF_DT_DOC    =   {}
		    m.REF_INDOPER   =   " "    && 0-ENTRADA  1-SAIDA
		    m.REF_TP_MOV    =   "" 	&& ENTRADA  // SAIDA
	    	m.REF_INDEMI    =   "" && 0-EMIS. PROPRIA // 1-TERCEIROS
    		m.REF_MODDOC    =   ""
	ENDIF

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp       =   EMGet_ECFSerie(PrmEmpresa)
    m.NRO_SERECF    =   LFieldTmp
    m.NRO_CX_ECF    =   "01"

	LFieldTmp    =  &PrmAlias .Cupom
	LFieldTmp    = CHRTRAN(STR(LFieldTmp,6)," ","0")
    m.NRO_CPMECF =   LFieldTmp



	=W_DEFPROC("EMPRESA.SPR")
	M.MUNIFATOGR  =   EMGetFieldValue(PrmEmpresa,"MUNI_IBGE")

	*----------------------------------------------------*
	m.TP_CARGA    =   "0"
    m.QTDE_VOL    =    &PrmAlias .qtde_vol
    m.ESPECIE     =    ""
    m.MARCA       =    &PrmAlias .marca
    m.PESO_BRUTO  =    &PrmAlias .pes_brt
    m.PESO_LIQ    =    &PrmAlias .pes_liq


	M.TRSTEM  		= "NAO"
	STORE "" TO M.TRSRNTC,M.TRSPLACAUF,M.TRSPLACA,M.TRSCPFCNPJ,;
				M.TRSNOME,M.TRSUF,M.TRSIE,M.TRSLOGRA,;
				M.TRSMUNIBGE,M.TRSMUNNOME,M.TRSBAIRRO




	=W_DEFPROC("ORC_ANEX.SPR")

	IF OALerRegistro(PrmEmpresa, &PrmAlias .ORCAMENTO)
		=W_DEFPROC("ORC_ANEX.SPR")
		LOrc_AnexAlias = OAGetAlias()

		IF !EMPTY( &LOrc_AnexAlias .CPFCNPJTRN)
			M.TRSTEM  		= "SIM"
			M.TRSRNTC 		= &LOrc_AnexAlias .ANTT_TRANS
			M.TRSPLACAUF	= &LOrc_AnexAlias .PLACA_UFTR
			M.TRSPLACA 		= &LOrc_AnexAlias .PLACA_TRAN
			M.TRSCPFCNPJ	= STR( &LOrc_AnexAlias .CPFCNPJTRN,14)
			M.TRSNOME		= &LOrc_AnexAlias .TRANSPORTE
			
			M.TRSUF			= &LOrc_AnexAlias .UF_TRANS
			M.TRSIE			= &LOrc_AnexAlias .IE_TRANS
			M.TRSLOGRA		= &LOrc_AnexAlias .ENDE_TRANS

			M.TRSTPLOGRA 	= LEFT(M.TRSLOGRA,AT(" ",M.TRSLOGRA,1))
			M.TRSTPLOGRA 	= LEFT(M.TRSTPLOGRA,3)
			M.TRSNRO      	= "S.N"
  			M.TRSCOMPLEM  	= ""
  			
			M.TRSCEP        = &LOrc_AnexAlias .CEP_TRANS

			M.TRSMUNIBGE	= STR ( &LOrc_AnexAlias .IBGE_TRANS,10)
			M.TRSMUNNOME	= &LOrc_AnexAlias .MUNI_TRANS
			M.TRSBAIRRO		= &LOrc_AnexAlias .BAIR_TRANS
  			M.TRSPAIS       = "BRASIL"
			M.TRSFONE       = ""
		ENDIF			
	ENDIF


    m.DT_ENTSAI   =    &PrmAlias .data
    m.HR_ENTSAI   =    &PrmAlias .HORA
	IF EMPTY(m.HR_ENTSAI)
	  m.HR_ENTSAI = "08:00:00"
	ENDIF



	*---------------------------------------------------*

	LFieldTmp    =  &PrmAlias .REGIAO
	LFieldTmp    =  STR(LFieldTmp,8)
    m.ZONA    	 =  LFieldTmp


	*---------------------------------------------------*
    m.TTPRODSRVC  =  &PrmAlias .TotServico + &PrmAlias .TotProduto

	*---------------------------------------------------*
	M.FNLDAD_NFE = "1"

	
	LEmpresa    = M.Empresa
	LMod_Doc    = M.Mod_Doc
	LCod_IdForn = M.Cod_IdForn
	LNro_Doc    = M.Nro_Doc
	LSerie_Doc  = M.Serie_Doc


	SELE &PBDocFiscaAlias
	SET ORDER TO TAG DOCFISCAL
	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	     STR(LNro_Doc,7)+LSerie_Doc

	
	IF !FOUND()
		APPEND BLANK
	ENDIF
	
	
	=RLOCK()
	GATHER MEMVAR
	UNLOCK
	

RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G9B           DFConvrtNEDocFiscal VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   29  º
*       º Variable:            DFConvrtNEDocFiscal                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      26                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g9b     &&  DFConvrtNEDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFConvrtNEDocFiscal
PARAMETERS PrmEmp,PrmNota,PrmFornCOD

	PRIVATE PrmAlias
	PRIVATE LFornAlias

	PRIVATE LCupomAlias





	*--------------------------------------------------*

	PRIVATE ;
    	 PrmSerie,;
		 PrmTipo,;
    	 RtnNro_Doc,;
		 RtnMod_Doc,;
		 RtnCOD_IDFORN,;
		 RtnSerie_Doc

	*--------------------------------------------------*



	=DFVerifyInst()



	=W_DEFPROC("NOTAENT.SPR")
	PrmAlias = NEGetAlias()

	=W_DEFPROC("NOTA.SPR")
	LNFSaidaAlias = NFGetAlias()


	=W_DEFPROC("NOTAENT.SPR")
	IF !NELerRegistro(PrmEmp,PrmNota,PrmFornCOD)
		MSG = "NEnt nao localizada ";
		     +str(PrmNota,7);
		     +"Forn:"+str(PrmFornCOD,14);
		     +" <ENTER>"
		WAIT MSG NOWAIT
		RETURN(.F.)
	ENDIF




	=W_DEFPROC("FORNECED.SPR")
	IF !FRLerRegistro( &PrmAlias .codforn)
		WAIT WINDOW "NFs nao localizada  <ENTER> "
		MSG = "FORNECEDOR nao localizado ";
		     +str(PrmNota,7);
		     +"Forn:"+str(PrmFornCOD,14);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF





	IF  LEFT( &PrmAlias .SITUACAO,1) <> "C"

		* NAO PROCESSAR ENTRADAS NAO EFETIVADAS
		
		RETURN(.T.)
	ENDIF





	=W_DEFPROC("DOCFISIT.SPR")
	=DIVerifyInst()



    DIMENSION LVT_AcmItens[4]  && RETORNA COM ACUMULADO DOS ITENS
	STORE 0 to     LVT_AcmItens

		*-----------------------------------*
		* [1] - VLR_ICMS
		* [2] - BC_ICMS
		* [3] - VLR_IPI
		* [4] - VLR_TOTAL
		*-----------------------------------*
				
					




	=W_DEFPROC("DOCFISIT.SPR")
	IF !DIConvrtNEDocFiscal(PrmEmp,PrmNota,PrmFornCOD,LVT_AcmItens)
		WAIT WINDOW "Itens NF Entrada nao localizados  <ENTER> "
		RETURN(.F.)
	ENDIF


	=W_DEFPROC("FORNECED.SPR")
	IF !FRLerRegistro( &PrmAlias .codforn)
		WAIT WINDOW "NFs nao localizada  <ENTER> "
		MSG = "FORNECEDOR nao localizado ";
		     +str(PrmNota,7);
		     +"Forn:"+str(PrmFornCOD,14);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	*---------------------------------------------------*

	STORE 0 TO  ;
    	 PrmSerie,;
		 PrmTipo,;
    	 RtnNro_Doc,;
		 RtnMod_Doc,;
		 RtnCOD_IDFORN,;
		 RtnSerie_Doc



	PrmSerie = &PrmAlias .serie
	PrmTipo  = &PrmAlias .tipo


	=W_DEFPROC("NOTAENT.SPR")
	=NEDefIDNFDocFiscal(PrmEmp,PrmNota,PrmFornCod,;
						PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						RtnSerie_Doc)



    M.COD_IDFORN   	=  RtnCOD_IDFORN

    M.EMPRESA   	=  PrmEmp
    M.TIPO   		=  PrmTipo
    M.NRO_DOC   	=  RtnNro_Doc
    M.SERIE_DOC 	=  RtnSerie_Doc


    m.MOD_DOC   =   RtnMod_Doc

	*---------------------------------------------------*

    m.EMPRESA   =    &PrmAlias .Empresa



    m.IND_OPER   =   "0"   && 0-ENTRADA  1-SAIDA
    m.TP_MOV     =   "ENTRADA" 	&& ENTRADA  // SAIDA

    m.MOD_NOTA   =   "1"
	

	
	=W_DEFPROC("CLIENTES.SPR")
	m.tp_pessoa =  CLDef_TipoPessoa( &PrmAlias .Favorecido)
	
	IF  m.tp_pessoa = 1
		LFieldTmp = CHRTRAN(STR(  &PrmAlias .Favorecido,11)," ","0")
	ELSE
		LFieldTmp = CHRTRAN(STR(  &PrmAlias .Favorecido,14)," ","0")
	ENDIF




	=W_DEFPROC("CLIENTES.SPR")
	m.tp_pessoa =  CLDef_TipoPessoa( &PrmAlias .Favorecido)
	
	IF  m.tp_pessoa = 1
		LFieldTmp = CHRTRAN(STR(  &PrmAlias .Favorecido,11)," ","0")
	    m.CPF    =   LFieldTmp
	    m.CNPJ   =  ""

	ELSE
		LFieldTmp = CHRTRAN(STR(  &PrmAlias .Favorecido,14)," ","0")
	    m.CNPJ    =   LFieldTmp
	    m.CPF    =   ""
	ENDIF

    m.UF    	 =    &PrmAlias .UF

    m.UF_CODIGO  =    "" && NAO INFORMADO


    m.IE        	=     &PrmAlias .Inscricao

	IF "ISENTO" $ m.IE
		m.IE = "ISENTO              " && ALGUNS CASOS ESTVA "IISENTO"
	ENDIF

	*---------------------------------------------------*
	*---------------------------------------------------*


    m.TIPO   		=     &PrmAlias .tipo

    m.NAT_OPER   	=     &PrmAlias .natureza

    IF EMPTY(m.nat_oper)
    	=W_DEFPROC("TIPOOPER.SPR")
		LFieldTmp    = TPGetFieldValue("E",  &PrmAlias .tipo ,"DESCNATU")
    	m.NAT_OPER   =   LFieldTmp
    ENDIF



    m.IND_EMITEN   	=   "1"  && 0-EMISSAO PROPRIA // 1-TERCEIROS

	&& 00-DOC REGULAR // 02-DOC CANCELADO


	LFieldTmp    	=	 "00"     && DOC REGULAR
    m.COD_SIT   	=   		LFieldTmp
    m.DT_DOC   		=    		&PrmAlias .data_emi
    m.HORA   		=    		&PrmAlias .HORA
	IF EMPTY(M.HORA)
	  M.HORA = "08:00:00"
	ENDIF



    m.DT_ENTSAI   	=    	&PrmAlias .Data	

	LFieldTmp    	= {}
    m.DT_CANC   	=   		LFieldTmp




*-> && 0-A VISTA   1-A PRAZO   9-SEM PGTO
	IF &PrmAlias .Ch_Opera= "1"  && 1-VENDA
		IF &PrmAlias .Tp_pgto = 1
			LFieldTmp    = "0"
		ELSE
			LFieldTmp    = "1"
		ENDIF
	ELSE
		LFieldTmp    = "9"
	ENDIF
    m.TP_PG   =   LFieldTmp

	IF &PrmAlias .Ch_Opera= "1"  && 1-VENDA
		IF &PrmAlias .Tp_pgto = 1
			LFieldTmp    = "A VISTA"
		ELSE
			LFieldTmp    = "A PRAZO"
		ENDIF
	ELSE
		LFieldTmp    = "SEM PGTO"
	ENDIF

    m.TP_PGDESCR   =   LFieldTmp
    m.VLR_DESCON   =    0
    m.VLRABAT_NT   =    0
    m.VLR_SERVIC   =    &PrmAlias .TotServico
    m.VLR_MERCAD   =    &PrmAlias .TotProduto


	IF &PrmAlias .pgto_frete = 1
	    m.IND_FRETE   =    "1"
	else
	    m.IND_FRETE   =    "2"
	ENDIF	

    m.VLR_FRETE   =    &PrmAlias .VlrFrete
    m.VLR_SEGURO   =    &PrmAlias .VlrSeguro
    m.VLR_DESPES   =    &PrmAlias .VlrDespes
    m.OUTDSPACES   =    0

    m.VLR_ICMS     =    LVT_AcmItens[1] &&  &PrmAlias .Vlr_Icms

    m.BC_ICMS      =    LVT_AcmItens[2] &&  &PrmAlias .Base_Icms

    m.VLR_IPI      =    LVT_AcmItens[3] && &PrmAlias .Vlr_ipi

    IF ABS(	&PrmAlias .Total_nota - LVT_AcmItens[4]) < 0.03

	    m.VLR_DOC     =    LVT_AcmItens[4]

	ELSE

	    m.VLR_DOC     =    &PrmAlias .Total_nota
	
	ENDIF



	*-----------------------------------------*
	* AS ENTRADA ESTAO GERANDO SALDO CREDOR INDEVIDO
	* SENDO ASSIM PASSAMOS O CST = 060 PARA 030
	* E ZERAMOS CAMPOS DE SUBSTITUICAO
	*-----------------------------------------*
    m.BC_ICMSRTD   =    &PrmAlias .Base_subs
    m.VLRICMSRTD   =    &PrmAlias .ICms_Subs

	IF &PrmAlias .ICms_Subs > 0
	    m.BC_ICMSRTD   =    0
    	m.VLRICMSRTD   =    0
	ENDIF



    m.BC_IPI       =    &PrmAlias .Base_IPI
    m.VLR_PIS      =    0
    m.VLR_COFINS   =   0
    m.VLR_PISRTD   =   0
    m.VLR_COFRTD   =   0
    m.INF_COMPLE   =   ""
    m.NROPROCCON   =   ""
    m.ORGPROCCON   =   "0"
    m.TPDOCIMPO   =   "0"
    m.NRODOCIMPO   =   "0"
    m.VLRPISIMPO   =   0
    m.VLRSRVCONT   =   0
    m.VLRBCISSQN   =     &PrmAlias .Base_iss
    m.VLR_ISSQN   =    &PrmAlias .Base_iss * &PrmAlias .aliq_iss
    m.VLR_BCIRRF   =   0
    m.VLR_IRRF   =   0
    m.VLR_BCPREV   =   0
    m.VLR_PREV   =   0
    m.AUTSEFAZCM   =   ""
    m.NROPASSEFI   =   ""
    m.TEMPERATUR   =   0

	=W_DEFPROC("FORNECED.SPR")
	LFornAlias = FRGetAlias()


    m.NOME   =     	 DFLimpaString( &LFornAlias .Nome )
    m.RAZAOSOC   =   DFLimpaString( &LFornAlias .Nome )

    m.TP_LOGRAD   =   ""
    m.LOGRADOURO   =  DFLimpaString(   &LFornAlias .Endereco )
    m.NRO_LOGRAD    =   "S/N"



	LFieldTmp = CHRTRAN(STR( 	&LFornAlias .CEP,8)," ","0")
    m.CEP   =   LFieldTmp
	

	LFieldTmp    =  &LFornAlias .Muni_IBGE
	LFieldTmp    = CHRTRAN(STR(LFieldTmp,7)," ","0")
    m.MUNI_IBGE   =   LFieldTmp
    m.MUNI_NOME   =     &LFornAlias .Cidade
    m.BAIRRO   =   DFLimpaString(   &LFornAlias .Bairro)
    m.PAIS   =    &LFornAlias .Pais
    m.FONE    	 =  LEFT( ALLTRIM( &LFornAlias .Fone ) ,10)
	*---------------------------------------------------*

	IF &PrmAlias .NFDEVOLVE > 0
		=W_DEFPROC("NOTA.SPR")
		IF NFLerRegistro(PrmEmp,  &PrmAlias .NFDEVOLVE )
			LNFSaidaAlias = NFGetAlias()
		    m.REF_NRODOC   =    &PrmAlias .NFDEVOLVE
		    m.REF_SERIE   =   LEFT( &LNFSaidaAlias .Serie +"   ",3)

			IF EMPTY(m.REF_SERIE)
	    		m.REF_SERIE  =     LEFT( "01   ",3)
			endif


	    	m.REF_DT_DOC  =	&LNFSaidaAlias .data
		    m.REF_INDOPER   =   "1"    && 0-ENTRADA  1-SAIDA
		    m.REF_TP_MOV   =   "SAIDA" 	&& ENTRADA  // SAIDA
	    	m.REF_INDEMI   =   "0" && 0-EMIS. PROPRIA // 1-TERCEIROS

			IF &LNFSaidaAlias .Nota > 1000000 AND;
			   &LNFSaidaAlias .Nota < 2000000
			
	    		m.REF_MODDOC   =   "2D"
			ELSE
				=W_DEFPROC("TIPOOPER.SPR")
				LFieldTmp    = ;
					TPGetFieldValue("S", ;
					  &LNFSaidaAlias .tipo ,"Cod_Mod_Rf")
			    m.REF_MODDOC   =   LFieldTmp
			ENDIF
		ELSE
		    m.REF_NRODOC   =    0
		    m.REF_SERIE   =     "   "
	    	m.REF_DT_DOC   = {}
		    m.REF_INDOPER   =   " "    && 0-ENTRADA  1-SAIDA
		    m.REF_TP_MOV   =   "" 	&& ENTRADA  // SAIDA
	    	m.REF_INDEMI   =   "" && 0-EMIS. PROPRIA // 1-TERCEIROS
    		m.REF_MODDOC   =   ""
		ENDIF

	ELSE
		    m.REF_NRODOC   =    0
		    m.REF_SERIE   =     "   "
	    	m.REF_DT_DOC  = {}
		    m.REF_INDOPER   =   " "    && 0-ENTRADA  1-SAIDA
		    m.REF_TP_MOV   =   "" 	&& ENTRADA  // SAIDA
	    	m.REF_INDEMI   =   "" && 0-EMIS. PROPRIA // 1-TERCEIROS
    		m.REF_MODDOC   =   ""
	ENDIF
	*----------------------------------------------------*
	m.TP_CARGA   =   "0"
    m.QTDE_VOL   =     &PrmAlias .qtde_vol
    m.ESPECIE   =     &PrmAlias .espec_vol
    m.MARCA   =     &PrmAlias .marca
    m.PESO_BRUTO   =     &PrmAlias .pes_brt
    m.PESO_LIQ   =     &PrmAlias .pes_liq
    m.DT_ENTSAI   =    		&PrmAlias .data
    m.HR_ENTSAI   =    		&PrmAlias .HORA

	IF EMPTY(M.HR_ENTSAI)
	  M.HR_ENTSAI = "08:00:00"
	ENDIF

	*---------------------------------------------------*

	LFieldTmp    = 0
	LFieldTmp    = STR(LFieldTmp,8)
    m.ZONA   =   LFieldTmp
    m.IE_SUBTRIB   =     &LFornAlias . InscSubs
    m.SUFRAMA   =     &LFornAlias .SUFRAMA

    m.NRO_SERECF   =   ""
    m.NRO_CX_ECF   =   ""

    m.NRO_CPMECF   =   "0"
	*---------------------------------------------------*

	*---------------------------------------------------*
	M.FNLDAD_NFE = "1"

	
	LEmpresa    = M.Empresa
	LMod_Doc    = M.Mod_Doc
	LCod_IdForn = M.Cod_IdForn
	LNro_Doc    = M.Nro_Doc
	LSerie_Doc  = M.Serie_Doc


	SELE &PBDocFiscaAlias
	SET ORDER TO TAG DOCFISCAL
	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	     STR(LNro_Doc,7)+LSerie_Doc

	
	IF !FOUND()
		APPEND BLANK
	ENDIF
	
	
	=RLOCK()
	GATHER MEMVAR
	UNLOCK
	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123G9W           DFGerXMLDocFiscal VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   30  º
*       º Variable:            DFGerXMLDocFiscal                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      27                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123g9w     &&  DFGerXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFGerXMLDocFiscal
PARAMETER PrmEmpresa,;
		  PrmMod_Doc,;
		  PrmCOD_IDFORN,;
		  PrmNro_Doc,;
		  PrmSerie_Doc,;
		  PrmObjetivo
		
		
		
	*-----------------------------------------------------*
	* PrmObjetivo => indica o objetivo da gera‡Æo do xml pode ser:
	*
	*      "EMISSAO"      => Para EMISSOA - NFe/NFSe/CUPOM
	*      "ESCRITURACAO" => Para registro do documento
	*      "CANCELAMENTO" => Para Cancelar o Documento
	*-----------------------------------------------------*


	IF TYPE("PrmObjetivo") <> "C" ;
	   OR !(PrmObjetivo $ "ESCRITURACAO/EMISSAO/CANCELAMENTO" )
		  PrmObjetivo = "ESCRITURACAO"
	ENDIF
	



	PRIVATE LSalias
	
	PRIVATE PrmAlsDF
	

	LSalias = ALIAS()
	PrmAlsDF = DFGetAlias()




	*-------------------------------------------------------*

   	PRIVATE LSfileXML,LNroIDfileXML


   	LSfileXML	= DFNmFileXMLDocFiscal(PrmEmpresa,PrmMod_doc,PrmNro_Doc)

   	LSfileXML	= "\SCGC\EFD\"+LSfileXML


  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return(.F.)
   	endif





	*---------------------------------------------------*

	SELE &PrmAlsDF
	SET ORDER TO TAG DOCFISCAL
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmMOD_DOC+;
	     PrmCOD_IDFORN+STR(PrmNro_Doc,7)+PrmSERIE_DOC
	
	SET NEAR OFF

	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() ;
	        AND PrmEmpresa    = &PrmAlsDF .empresa;
	        AND PrmMod_Doc    = &PrmAlsDF .MOD_DOC ;
	        AND PrmCOD_IDFORN = &PrmAlsDF .COD_IDFORN ;
	        AND PrmNro_Doc       = &PrmAlsDF .NRO_DOC ;
	        AND PrmSERIE_DOC  = &PrmAlsDF .SERIE_DOC;
         TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*


	=DFInicioXML(LSfileXML,LNroIDfileXML)

	SET POINT TO ','


	SELE &PrmAlsDF
	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa    = &PrmAlsDF .empresa;
	        AND PrmMod_Doc    = &PrmAlsDF .MOD_DOC ;
	        AND PrmCOD_IDFORN = &PrmAlsDF .COD_IDFORN ;
	        AND PrmNro_Doc    = &PrmAlsDF .NRO_DOC ;
	        AND PrmSERIE_DOC  = &PrmAlsDF .SERIE_DOC

		=UPtermo()


		=W_DEFPROC("DUPLICAT.SPR")
		=CRGerXMLDpDocFiscal(;
				&PrmAlsDF .Empresa,;
				&PrmAlsDF .NRO_NOTA,;
				&PrmAlsDF .NRO_DOC,;
				&PrmAlsDF .Mod_doc,;
				&PrmAlsDF .Serie_Doc)



		=DIGerXMLDocFiscal(;
				&PrmAlsDF .Empresa,;
				&PrmAlsDF .Mod_doc,;
				&PrmAlsDF .Cod_IDForn,;
				&PrmAlsDF .Nro_Doc,;
				&PrmAlsDF .Serie_Doc)


		=DFGravaXMLDocFiscal(;
				&PrmAlsDF .Empresa,;
				&PrmAlsDF .Mod_doc,;
				&PrmAlsDF .Cod_IDForn,;
				&PrmAlsDF .Nro_Doc,;
				&PrmAlsDF .Serie_Doc,;
				LSfileXML,;
				LNroIDfileXML,;
				PrmObjetivo)

		SELE &PrmAlsDF



		SKIP
	ENDDO

	=DFFinalXML(LSfileXML,LNroIDfileXML)


	SET POINT TO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GA5           DFEnviaNFeXML VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   34  º
*       º Variable:            DFEnviaNFeXML                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      28                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123ga5     &&  DFEnviaNFeXML VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFEnviaNFeXML
PARAMETERS PrmEmpresa,PrmMod_Doc,PrmNro_Doc
	


   	PRIVATE LSFDocXML,LSFItemXML,LSCobrXML
   	LSFDocXML	= DFNmFileXMLDocFiscal(PrmEmpresa,PrmMod_Doc,PrmNro_Doc)


	IF !FILE("\SCGC\EFD\"+LSFDocXML)
	   RETURN(.F.)
	ENDIF


   	LSFItemXML	= DINmFileXMLDocFiscal(PrmEmpresa,PrmMod_Doc,PrmNro_Doc)

	IF !FILE("\SCGC\EFD\"+LSFItemXML)
	   RETURN(.F.)
	ENDIF


	=W_DEFPROC("DUPLICAT.SPR")
   	LSCobrXML	= CRNmFileXMLDocFiscal(PrmEmpresa,PrmMod_Doc,PrmNro_Doc)

	IF !FILE("\SCGC\EFD\"+LSCobrXML)
	   RETURN(.F.)
	ENDIF


	*--------------------------------------------------*
	LSFileOrigem     = "\SCGC\EFD\"+LSFDocXML
	LSFileDestino    = "C:\NFE\"+LSFDocXML
			
	COPY FILE &LSFileOrigem TO &LSFileDestino


	IF FILE(LSFileOrigem)
		DELETE FILE &LSFileOrigem
	ENDIF

	*--------------------------------------------------*

	LSFileOrigem     = "\SCGC\EFD\"+LSFItemXML
	LSFileDestino    = "C:\NFE\"+LSFItemXML
			
	COPY FILE &LSFileOrigem TO &LSFileDestino


	IF FILE(LSFileOrigem)
		DELETE FILE &LSFileOrigem
	ENDIF
	*--------------------------------------------------*

	LSFileOrigem     = "\SCGC\EFD\"+LSCobrXML
	LSFileDestino    = "C:\NFE\"+LSCobrXML
			
	COPY FILE &LSFileOrigem TO &LSFileDestino


	IF FILE(LSFileOrigem)
		DELETE FILE &LSFileOrigem
	ENDIF


	
	*--------------------------------------------------*



RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GAA           DFEsperaRspNFe VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   35  º
*       º Variable:            DFEsperaRspNFe                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      29                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gaa     &&  DFEsperaRspNFe VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFEsperaRspNFe
PARAMETERS PrmEmpresa, PrmMod_Doc, PrmNroDoc


	*-------------------------------------------------------*
	PRIVATE LSstatus
	PRIVATE CtrAguarda

	LSstatus = ""

    CtrAguarda = 0
	LFlgEspera = .t.

	DO WHILE LFlgEspera


		LSstatus=DFBuscaArqRspNFe(PrmEmpresa, PrmMod_Doc,PrmNroDoc)

		DO CASE
 		 	CASE LSstatus = "ERRO ! Espera interrompida por usr"
				LFlgEspera = .F.
		
			CASE LSstatus = "ERRO ! Nao houve retorno do comando"
				LFlgEspera = .T.

			CASE "ASSINADA" $ LSstatus
				LFlgEspera = .T.

			CASE "VALIDADA" $ LSstatus
				LFlgEspera = .T.

			CASE "TRANSMITIDA" $ LSstatus

				IF CtrAguarda > 5		&& Dµ UM TEMPO PARA RETORNO
					LFlgEspera = .F.    && PROCESSADO
				ELSE
					CtrAguarda = CtrAguarda + 1
					=INKEY(4)
				ENDIF

			CASE "GRAVADA" $ LSstatus AND PrmMod_Doc = "77"
				LSstatus =  STRTRAN(LSstatus,"GRAVADA","PROCESSADA")
				LFlgEspera = .F.

			CASE "PROCESSADA" $ LSstatus
				LFlgEspera = .F.

			CASE "CANCELADA" $ LSstatus
				LFlgEspera = .F.

			CASE "ERRO EMISSAO" $ LSstatus
				LFlgEspera = .F.

		ENDCASE
	ENDDO

RETURN(LSstatus)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GAF           DFBuscaRspNFe VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   38  º
*       º Variable:            DFBuscaRspNFe                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      30                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gaf     &&  DFBuscaRspNFe VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFBuscaArqRspNFe
PARAMETERS PrmEmpresa,PrmMod_doc,PrmNro_Doc

	*-------------------------------------------------------*

	PRIVATE LSnroDoc
	PRIVATE LNfile
	PRIVATE LSstatus,LSFile,LNctr,TECLA




	*-------------------------------------------------------*
	*  obter o MOD_DOC
	*-------------------------------------------------------*



	*----------------------------------------------------------*

	LSstatus = ""
	LNfile = 0



	LSnroDoc  = CHRTRAN(STR(PrmNro_Doc,8)," ","0")


	LSFile    = "C:\NFe\"+LSnroDoc+"."+PrmMod_Doc



	LNctr = 0

	CLEAR TYPEAHEAD


	DO WHILE !(FILE(LSFile))

		DO CASE

			CASE PrmMod_Doc = "2D"
			    LSmsg = STR(LNctr,3)+"-Aguarda Cupom - <ESC>=Sai "+LSFile

			CASE PrmMod_Doc = "55"
			    LSmsg = STR(LNctr,3)+"-Aguarda NFe  - <ESC>=Sai "+LSFile

			CASE PrmMod_Doc = "77"
			    LSmsg = STR(LNctr,3)+"-Aguarda NFSe  - <ESC>=Sai "+LSFile

			OTHERWISE
			    LSmsg = STR(LNctr,3)+"-Aguarda NF  - <ESC>=Sai "+LSFile
		ENDCASE

		WAIT WINDOW LSmsg NOWAIT
		TECLA=INKEY(3)
		LNctr = LNctr + 1
		IF  LNctr > 60
			EXIT
		ENDIF
		IF TECLA = 27 OR LASTKEY() = 27
			IF fox_alert("Interrompe Espera NFe ? ")
				LSstatus = "ERRO ! Espera interrompida por usr"
				EXIT
			ENDIF
		ENDIF

	ENDDO

	DO CASE
		CASE LSstatus = "ERRO ! Espera interrompida por usr"
 		 	LSstatus = "ERRO ! Espera interrompida por usr"

		CASE !FILE(LSFile)
			LSstatus = "ERRO ! Nao houve retorno do comando"

		OTHERWISE		
			TECLA=INKEY(3)
			LNfile=FOPEN(LSFile)	
			IF LNfile > 0
				LSstatus=""
				DO WHILE !FEOF(LNfile)
					LSstatus = LSstatus + UPPER(fgets(LNfile,255)) + "|"
				ENDDO
				=FCLOSE(LNfile)
			ELSE
				LSstatus = "ERRO ! Nao houve retorno do comando"
			ENDIF

			LSnewFile = STRtran(LSFile,"."+PrmMod_Doc,"."+PrmMod_Doc+"K")

			IF FILE(LSnewFile)
		   		delete file &LSnewFile
			ENDIF
			RENAME &LSFile TO &LSnewFile


	ENDCASE


RETURN(LSstatus)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GAL           DFRespostaNFe VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   39  º
*       º Variable:            DFRespostaNFe                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      31                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gal     &&  DFRespostaNFe VALID
#REGION 1
return
*---------------------------------------------------------------*
*		   PrmEsperaResposta,;
*		       && "ESPERA" ou "NAO ESPERA"
*
*---------------------------------------------------------------*

FUNCTION DFRespostaNFe
PARAMETERS ;
		   PrmEmpresa,;	
		   PrmMod_Doc,;
		   PrmNroDoc,;
		   PrmEsperaResposta,;
		   RtnStatus,;
		   RtnRecibo,;
		   RtnProtocolo,;
		   RtnChvNFe,;
		   RtnJstfCanc,;
		   RtnPrtcCanc
	*-------------------------------------------------------*
	PRIVATE LSstatus
	LSstatus = ""


	IF PrmEsperaResposta = "ESPERA"
		LSstatus=DFEsperaRspNFe(PrmEmpresa,PrmMod_Doc,PrmNroDoc)
	ELSE
		LSstatus=DFBuscaArqRspNFe(PrmEmpresa,PrmMod_Doc,PrmNroDoc)
	ENDIF


	*-------------------------------------------------------*


	DO CASE

		CASE LSstatus = "ERRO ! Nao houve retorno do comando"
				RtnStatus = LSstatus
		OTHERWISE
				RtnCodStatus = SUBS(LSstatus,1,AT("|",LSstatus,1)-1)
				RtnCodStatus = CHRTRAN(RtnCodStatus,"|","")



				*----------------------------------------*				
				RtnStatus   = SUBS(LSstatus,;
				 			   AT("|",LSstatus,1)+1,;
				               AT("|",LSstatus,2)-AT("|",LSstatus,1))
				RtnStatus = CHRTRAN(RtnStatus,"|","")

				*----------------------------------------*				
				RtnNota   = SUBS(LSstatus,;
				 			   AT("|",LSstatus,2)+1,;
				               AT("|",LSstatus,3)-AT("|",LSstatus,2))
				RtnNota = CHRTRAN(RtnNota,"|","")
				*----------------------------------------*				
				RtnRecibo = SUBS(LSstatus,;
				 			   AT("|",LSstatus,3)+1,;
				               AT("|",LSstatus,4)-AT("|",LSstatus,3))
				RtnRecibo = CHRTRAN(RtnRecibo,"|","")
				*----------------------------------------*				
				RtnProtocolo = SUBS(LSstatus,;
				 			   AT("|",LSstatus,4)+1,;
				               AT("|",LSstatus,5)-AT("|",LSstatus,4))
				RtnProtocolo = CHRTRAN(RtnProtocolo,"|","")
				*----------------------------------------*				
				RtnChvNFe    = SUBS(LSstatus,;
				 			   AT("|",LSstatus,5)+1,;
				               AT("|",LSstatus,6)-AT("|",LSstatus,5))
				RtnChvNFe = CHRTRAN(RtnChvNFe,"|","")

				*----------------------------------------*				
				RtnJstfCanc   = SUBS(LSstatus,;
				 			   AT("|",LSstatus,6)+1,;
				               AT("|",LSstatus,7)-AT("|",LSstatus,6))
				RtnJstfCanc = CHRTRAN(RtnJstfCanc,"|","")
				*----------------------------------------*				
				RtnPrtcCanc   = SUBS(LSstatus,;
				 			   AT("|",LSstatus,7)+1,;
				               AT("|",LSstatus,8)-AT("|",LSstatus,7))
				RtnPrtcCanc = CHRTRAN(RtnJstfCanc,"|","")
				*----------------------------------------*				
	
		ENDCASE

RETURN(LSstatus)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GAR           DFLimpaString VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   41  º
*       º Variable:            DFLimpaString                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      32                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gar     &&  DFLimpaString VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DFLimpaString
PARAMETERS PrmString
	*-------------------------------------------------------*
	PRIVATE LSstatus
	LSstatus = ""
	*-------------------------------------------------------*
	*PRMString = UPPER(PRMString)

	PRMString = chrtran(PRMString,"€","C")       && 01
	PRMString = chrtran(PRMString,"‡","c")       && 02
	PRMString = chrtran(PRMString,"&","e")       && 03
	PRMString = chrtran(PRMString,"¦","-")       && 04
	PRMString = chrtran(PRMString,"§","-")       && 05
	PRMString = chrtran(PRMString,"°",'')        && 06
	PRMString = chrtran(PRMString,"º",'')        && 07
	PRMString = chrtran(PRMString,"",'E')       && 08
	PRMString = chrtran(PRMString,"‚",'e')       && 09
	PRMString = chrtran(PRMString,"Ç",'A')       && 10
	PRMString = chrtran(PRMString,"Æ",'a')       && 11
	PRMString = chrtran(PRMString,"ø",'')        && 12
	PRMString = chrtran(PRMString,chr(0),'')     && 13
	PRMString = chrtran(PRMString,'"','')        && 14
	PRMString = chrtran(PRMString,'Ã','A')        && 14
	PRMString = chrtran(PRMString,'>',' ')        && 14
	PRMString = chrtran(PRMString,'<',' ')        && 14


RETURN(PrmString)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GAW           DF_Fputs VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   42  º
*       º Variable:            DF_Fputs                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      33                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gaw     &&  DF_Fputs VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION DF_Fputs
PARAMETERS ;
			PrmNroIDfileXML,;
			PrmString,;
			PrmLEN

	PRIVATE LFretorno

	PrmString = DF_FputsLimpa(PrmString)

	LFretorno =fPuts(PrmNroIDfileXML,PrmString,LEN(PrmString))

RETURN(LFretorno)

*----------------------------------------------------------*

FUNCTION DF_FputsLimpa
PARAMETERS PrmString

	PRMString = chrtran(PRMString,"€","C")       && 01
	PRMString = chrtran(PRMString,"‡","c")       && 02
	PRMString = chrtran(PRMString,"&","e")       && 03
	PRMString = chrtran(PRMString,"¦","-")       && 04
	PRMString = chrtran(PRMString,"§","-")       && 05
	PRMString = chrtran(PRMString,"°",'')        && 06
	PRMString = chrtran(PRMString,"º",'')        && 07
	PRMString = chrtran(PRMString,"",'E')       && 08
	PRMString = chrtran(PRMString,"‚",'e')       && 09
	PRMString = chrtran(PRMString,"Ç",'A')       && 10
	PRMString = chrtran(PRMString,"Æ",'a')       && 11
	PRMString = chrtran(PRMString,"ø",'')        && 12
	PRMString = chrtran(PRMString,chr(0),'')     && 13

** nao 	PRMString = chrtran(PRMString,'"','')        && 14

RETURN(PrmString)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GB0           DFDefIDNFDocFiscal VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   43  º
*       º Variable:            DFDefIDNFDocFiscal                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      34                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gb0     &&  DFDefIDNFDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFDefIDNFDocFiscal
PARAMETERS ;
	 PrmEmpresa,;
	 PrmNota,;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc

    RtnNro_Doc    =   PrmNota
	DO CASE

		CASE PrmNota > 1000000 AND PrmNota < 2000000
		    RtnMOD_DOC    =   "2D"  && CUPOM
		    RtnNro_Doc    =   PrmNota - 1000000

		CASE PrmNota > 2000000 AND PrmNota < 3000000
		    RtnMOD_DOC    =   "03"  && NF SERVICO
		    RtnNro_Doc    =   PrmNota - 2000000

		CASE PrmNota > 3000000 AND PrmNota < 4000000
		    RtnMOD_DOC    =   "55"  && NFe
		    RtnNro_Doc    =   PrmNota - 3000000


		CASE PrmNota > 4000000 AND PrmNota < 5000000
		    RtnMOD_DOC    =   "77"  && NFSe
		    RtnNro_Doc    =   PrmNota - 4000000
		
		OTHERWISE			
			=W_DEFPROC("TIPOOPER.SPR")
			LFieldTmp    = ;
				TPGetFieldValue("S",  PrmTipo ,"Cod_Mod_Rf")
		    RtnMOD_DOC    = LFieldTmp
	ENDCASE
	

    RtnCOD_IDFORN  =   SPACE(14)
**    RtnNRO_DOC     =   PrmNota
    RtnSERIE_DOC   =   LEFT( PrmSerie +"   ",3)

	IF EMPTY(RtnSERIE_DOC)
	    RtnSERIE_DOC  =     LEFT( "01   ",3)
	endif

RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GB5           DFNmFileXMLDocFiscal VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   44  º
*       º Variable:            DFNmFileXMLDocFiscal               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      35                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gb5     &&  DFNmFileXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFNmFileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc


	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*




	LSnomeArqXml = "DFISCP"+;
				   PrmMod_Doc
	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")


   	LSfileXML	= LSnomeArqXml+".XML"
	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GB9           DFGravaXMLDocFiscal VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   45  º
*       º Variable:            DFGravaXMLDocFiscal                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      36                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gb9     &&  DFGravaXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFGravaXMLDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmFileXML,;
			PrmNroIDfileXML,;
			PrmObjetivo


	*---------------------------------------------------*
	PRIVATE LSprocesso

	=W_DEFPROC("DOCFISCA.SPR")
	LSprocesso = DFVersaoXML()

	PRIVATE LFRETORNO


	IF "VERSAO-PROCESSO-DFIS" $ LSprocesso

		LFRETORNO = DFv10GravaXMLDocFiscal( ;
				PrmEmp,;
				PrmMod_doc,;
				PrmCod_IDForn,;
				PrmNro_Doc,;
				PrmSerie_Doc,;
				PrmFileXML,;
				PrmNroIDfileXML,;
				PrmObjetivo)
	ELSE
		LFRETORNO = DFv01GravaXMLDocFiscal( ;
				PrmEmp,;
				PrmMod_doc,;
				PrmCod_IDForn,;
				PrmNro_Doc,;
				PrmSerie_Doc,;
				PrmFileXML,;
				PrmNroIDfileXML,;
				PrmObjetivo)

	ENDIF
			

RETURN(LFRETORNO)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GBF           DFv01GravaXMLDocFiscal VALID       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   46  º
*       º Variable:            DFv01GravaXMLDocFiscal             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      37                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gbf     &&  DFv01GravaXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DFv01GravaXMLDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmFileXML,;
			PrmNroIDfileXML,;
			PrmObjetivo





	IF !DFLerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+PrmMOD_DOC+;
		      "FORN. : "+STR(PrmCOD_IDFORN,6)+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC
   	  return(.F.)
   ENDIF


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	*-------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	=EMLerRegistro(PrmEmp)

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("CGC")
	UNEM_CNPJ    =  STR(LFieldTmp,14)
	UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")




	SET POINT TO ","
	SET SEPARATOR  TO "."




	LSLinhaXML = ULtratalinha('<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*==========================================================*
	*  CAMPOS IDENTIFICADORES
	*==========================================================*

	=W_DEFPROC("EMPRESA.SPR")

	LSEmite_NFe = EMGetPropVT("EMITE_NFE")




	IF LSEmite_NFe $ "H"   && H=HOMOLOGACAO

		LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             "55" +;
	             '"')
                =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	ELSE
		LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             DFGetPropVT("MOD_DOC") +;
	             '"')
                =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	ENDIF

	
	*----------------------------------------------------------*

	LNNro_Doc  = DFGetPropVT("NRO_DOC")
	IF LNNro_Doc > 3000000
		LNNro_Doc = LNNro_Doc - 3000000
	ENDIF

	LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML = ULtratalinha('DFIS_OPCM_SIGLA="'+;
	             DFGetPropVT("TIPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IND_OPERACAO="'+;
	             DFGetPropVT("IND_OPER") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TP_MOVIMENTO="'+;
	             DFGetPropVT("TP_MOV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------*
	* SERIE UNICA => "0"
	*----------------------------------------------------*
	

	LSLinhaXML = DFGetPropVT("SERIE_DOC")
	IF "U" $ LSLinhaXML
		LSLinhaXML = "0"
	ENDIF

	LSLinhaXML = ULtratalinha('DFIS_SERIE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------*


	LSLinhaXML = ULtratalinha('DFIS_CPF="'+;
	             DFGetPropVT("CPF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CNPJ="'+;
	             DFGetPropVT("CNPJ") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IE="'+;
	             DFGetPropVT("IE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NAT_OPERACAO="'+;
	             DFGetPropVT("NAT_OPER") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IND_EMITENTE="'+;
	             DFGetPropVT("IND_EMITEN") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CDG_SITUACAO="'+;
	             DFGetPropVT("COD_SIT") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*------------------------------------------------------------*

	LSLinhaXML = DFGetPropVT("IND_FRETE")

	IF LSLinhaXML = "1"
	    LSLinhaXML    =   "0"
	else
	    LSLinhaXML    =   "1"
	ENDIF
	

	LSLinhaXML = ULtratalinha('DFIS_IND_FRETE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*------------------------------------------------------------*

	LSLinhaXML = ULtratalinha('DFIS_CHV_NFE="'+;
	             DFGetPropVT("NFE_CHV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DGT_CHV_NFE="'+;
	             DFGetPropVT("NFE_DGTCHV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DT_DOC="'+;
	             DTOC(DFGetPropVT("DT_DOC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_DT_CANC="'+;
	             DTOC(DFGetPropVT("DT_CANC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_DOCUMENTO="'+;
	             STR(DFGetPropVT("VLR_DOC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TP_PGTO_CODIGO="'+;
	             DFGetPropVT("TP_PG") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_PGTO_DESCRICAO="'+;
	             DFGetPropVT("TP_PGDESCR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_DESCONTO="'+;
	             STR(DFGetPropVT("VLR_DESCON"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*==========================================================*

	LSLinhaXML = ULtratalinha('DFIS_VLR_ABATE_NT="'+;
	             STR(DFGetPropVT("VLRABAT_NT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_MERCADORIAS="'+;
	             STR(DFGetPropVT("VLR_MERCAD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_FRETE="'+;
	             STR(DFGetPropVT("VLR_FRETE"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_SEGURO="'+;
	             STR(DFGetPropVT("VLR_SEGURO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_DESPESAS="'+;
	             STR(DFGetPropVT("VLR_DESPES"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_OUTRAS_DESP_ACES="'+;
	             STR(DFGetPropVT("OUTDSPACES"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS="'+;
	             STR(DFGetPropVT("BC_ICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS="'+;
	             STR(DFGetPropVT("VLR_ICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS_RTD="'+;
	             STR(DFGetPropVT("BC_ICMSRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_RTD="'+;
	             STR(DFGetPropVT("VLRICMSRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_IPI="'+;
	             STR(DFGetPropVT("BC_IPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_IPI="'+;
	             STR(DFGetPropVT("VLR_IPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS="'+;
	             STR(DFGetPropVT("VLR_PIS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS="'+;
	             STR(DFGetPropVT("VLR_COFINS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_RTD="'+;
	             STR(DFGetPropVT("VLR_PISRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_RTD="'+;
	             STR(DFGetPropVT("VLR_COFRTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_INF_COMPLEMENTARES="'+;
	             DFGetPropVT("INF_COMPLE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_PROC_CONCESSORIO="'+;
	             DFGetPropVT("NROPROCCON") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ORIGEM_PROC_CONCESSORIO="'+;
	             DFGetPropVT("ORGPROCCON") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
				
				
	LSLinhaXML = ULtratalinha('DFIS_TP_DOC_IMPORTACAO="'+;
	             DFGetPropVT("TPDOCIMPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
				
	LSLinhaXML = ULtratalinha('DFIS_NRO_DOC_IMPORTACAO="'+;
	             DFGetPropVT("NRODOCIMPO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_IMPORTACAO="'+;
	             STR(DFGetPropVT("VLRPISIMPO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_IMPORTACAO="'+;
	             STR(DFGetPropVT("VLRCOFIMPO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_SERVICO_NT="'+;
	             STR(DFGetPropVT("VLRSRVCONT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISS="'+;
	             STR(DFGetPropVT("VLRBCISSQN"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_ISS="'+;
	             STR(DFGetPropVT("VLR_ISSQN"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_IR="'+;
	             STR(DFGetPropVT("VLR_BCIRRF"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_IR="'+;
	             STR(DFGetPropVT("VLR_IRRF"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
				

	LSLinhaXML = ULtratalinha('DFIS_VLR_IR_RTD="'+;
	             STR(0,18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_PREVIDENCIA="'+;
	             STR(DFGetPropVT("VLR_BCPREV"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PREVIDENCIA="'+;
	             STR(DFGetPropVT("VLR_PREV"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_AUT_SEFAZ_COMBUSTIVEL="'+;
	             DFGetPropVT("AUTSEFAZCM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_PASSE_FISCAL="'+;
	             DFGetPropVT("NROPASSEFI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_TEMPERATURA="'+;
	             STR(DFGetPropVT("TEMPERATUR"),6,1) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_UF="'+;
	             DFGetPropVT("UF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NOME="'+;
	             DFGetPropVT("NOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_RAZAO_SOCIAL="'+;
	             DFGetPropVT("RAZAOSOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_LOGADOURO="'+;
	             DFGetPropVT("TP_LOGRAD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_LOGRADOURO="'+;
	             DFGetPropVT("LOGRADOURO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_LOGRADOURO="'+;
	             DFGetPropVT("NRO_LOGRAD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_COMPL_LOGRADOURO="'+;
	             DFGetPropVT("COMPL_LOGR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CEP="'+;
	             DFGetPropVT("CEP") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_ZONA="'+;
	             ("") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*---------------------------------------------------------*

	LSLinhaXML = ALLTRIM(DFGetPropVT("MUNI_IBGE"))
	IF LEN(LSLinhaXML) < 7
		LSLinhaXML = REPLICATE("0",7-LEN(LSLinhaXML))
	ENDIF

	*---------------------------------------------------------*

	LSLinhaXML = ULtratalinha('DFIS_MUNI_IBGE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MUNI_NOME="'+;
	             DFGetPropVT("MUNI_NOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_BAIRRO="'+;
	             DFGetPropVT("BAIRRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PAIS="'+;
	             DFGetPropVT("PAIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CODIGO_PAIS="'+;
	              "1058" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_FONE="'+;
	             DFGetPropVT("FONE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IE_SUB_TRIB="'+;
	             DFGetPropVT("IE_SUBTRIB") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_SUFRAMA="'+;
	             DFGetPropVT("SUFRAMA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------
	*LSLinhaXML = ULtratalinha('DFIS_REF_NRO_DOCUMENTO="'+;
	*             SUBS(STR(DFGetPropVT("REF_NRODOC"),7),2) +;
	*             '"')
	*			=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *----------


	LNNro_Doc  = DFGetPropVT("REF_NRODOC")
	IF LNNro_Doc > 3000000
		LNNro_Doc = LNNro_Doc - 3000000
	ENDIF



	LSLinhaXML = ULtratalinha('DFIS_REF_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_SERIE="'+;
	             DFGetPropVT("REF_SERIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_DT_DOC="'+;
	             DTOC(DFGetPropVT("REF_DT_DOC")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_INDOPERACAO="'+;
	             DFGetPropVT("REF_INDOPE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_TP_MOVIMENTO="'+;
	             DFGetPropVT("REF_TP_MOV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_IND_EMITENTE="'+;
	             DFGetPropVT("REF_INDEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_MOD_DOCUMENTO="'+;
	             DFGetPropVT("REF_MODDOC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_SERIAL_ECF="'+;
	             DFGetPropVT("NRO_SERECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_CAIXA_ECF="'+;
	             DFGetPropVT("NRO_CX_ECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_NRO_CUPOM_COO_ECF="'+;
	             DFGetPropVT("NRO_CPMECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_DT_ENT_OU_SAIDA="'+;
	             DTOC(DFGetPropVT("DT_ENTSAI")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_DDD="'+;
	             DFGetPropVT("DDD") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_ESPECIE="'+;
	             DFGetPropVT("ESPECIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_HORA_DOC="'+;
	             DFGetPropVT("HORA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_HR_ENT_OU_SAIDA="'+;
	             DFGetPropVT("HR_ENTSAI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IND_OPER_VEICULO="'+;
	             DFGetPropVT("IND_OPVEIC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_IND_USO_ARMA="'+;
	             DFGetPropVT("INDUSOARMA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MARCA="'+;
	             DFGetPropVT("MARCA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MODELO_ECF="'+;
	             DFGetPropVT("MODELO_ECF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PESO_BRUTO="'+;
	             STR(DFGetPropVT("PESO_BRUTO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PESO_LIQUIDO="'+;
	             STR(DFGetPropVT("PESO_LIQ"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_QTDE_VOLUMES="'+;
	             STR(DFGetPropVT("QTDE_VOL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_TP_CARGA="'+;
	             DFGetPropVT("TP_CARGA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*-------------------------------------------------------*



	LSLinhaXML = ULtratalinha('DFIS_TP_CREDITO="'+;
	             DFGetPropVT("TP_CREDITO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS_RTD="'+;
	             STR(DFGetPropVT("BCBRICMSRT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS="'+;
	             STR(DFGetPropVT("BCBRICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_ICMS_SO="'+;
	             STR(DFGetPropVT("BCBRICMSSO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_BRUTA_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("BCBRRTDENT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_COFINS="'+;
	             STR(DFGetPropVT("BC_COFINS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_CSLL="'+;
	             STR(DFGetPropVT("BC_CSLL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ICMS_SO="'+;
	             STR(DFGetPropVT("BC_ICMS_SO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_SO="'+;
	             STR(DFGetPropVT("VLR_ICMSSO"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISENTA_ICMS="'+;
	             STR(DFGetPropVT("BCISENICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISENTA_IPI="'+;
	             STR(DFGetPropVT("BCISENIPI"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_OUTR_ICMS="'+;
	             STR(DFGetPropVT("BCOUTRICMS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_PIS="'+;
	             STR(DFGetPropVT("BC_PIS"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("BCRTDENTRA"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_CSLL="'+;
	             STR(DFGetPropVT("VLR_CSLL"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_DESP_FINANCEIRA="'+;
	             STR(DFGetPropVT("DESPFINANC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_ICMS_RTD_ENTRADA="'+;
	             STR(DFGetPropVT("ICMSRTDENT"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_BC_ISS_RTD="'+;
	             STR(DFGetPropVT("BC_ISS_RTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFIS_VLR_ISS_RTD="'+;
	             STR(DFGetPropVT("ISS_RTD"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_SERVICOS="'+;
	             STR(DFGetPropVT("VLR_SERVIC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VLR_PRODUTOS_SERVICOS="'+;
	             STR(DFGetPropVT("TTPRODSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_ALIQ_COFINS="'+;
	             STR(DFGetPropVT("VLRALQCOFI"),5,2) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_CHV_NFe="'+;
	             DFGetPropVT("REF_CHVNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_DGT_NFe="'+;
	             DFGetPropVT("REF_DGTNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_CODIGO_UF_EMITENTE="'+;
	             DFGetPropVT("REF_UF_CDG") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_FORMA_EMISSAO_NFe="'+;
	             DFGetPropVT("NFEFRMAEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_FINALIDADE_EMISSAO_NFe="'+;
	             DFGetPropVT("FNLDAD_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_FORMATO_DANF="'+;
	             DFGetPropVT("FRMTODANF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_PROCESSO_EMISSAO_NFE="'+;
	             DFGetPropVT("PROCEMINFE") +;
	             '"')
	             =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_VERSAO_NFE="'+;
	             DFGetPropVT("VERSAO_NFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_IM_INSCRICAO_MUNICIPAL="'+;
	             DFGetPropVT("IM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_MUNI_IBGE_FATO_GERADOR="'+;
	             DFGetPropVT("MUNIFATOGR") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_DT_EMISSAO_NFE="'+;
	             DTOC(DFGetPropVT("REF_DTNFE")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_FORMATO_IMP_DANF="'+;
	             DFGetPropVT("REFFRDANF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_REF_FORMA_EMISSAO_NFE="'+;
	             DFGetPropVT("REFTPEMIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_AMBIENTE_EMISSAO_NFE="'+;
	             DFGetPropVT("REFTPAMBIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_PROCESSO_EMISSAO_NFE="'+;
	             DFGetPropVT("REFPROCEMI") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_VERSAO_NFE="'+;
	             DFGetPropVT("REFVERSAO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_REF_FINALIDADE_EMISSAO_NFE="'+;
	             DFGetPropVT("REFFINALID") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_PIS_SERVICOS="'+;
	             STR(DFGetPropVT("VLRPISSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_VLR_COFINS_SERVICOS="'+;
	             STR(DFGetPropVT("VLRCOFSRVC"),18,4) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_AMBIENTE_EMISSAO_NFE="'+;
	             DFGetPropVT("AMBIENTNFE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFIS_CODIGO_PAIS_DESTINATARIO="'+;
	              "1058" +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFIS_DT_EMISSAO_NFE="'+;
	             DTOC(DFGetPropVT("DTEMINFE")) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*-- TRANSPORTADORA  -------------------------------------*

	LSLinhaXML = ULtratalinha('DFTR_TEM_TRANSPORTADORA="'+;
	             DFGetPropVT("TRSTEM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_RNTC="'+;
	             DFGetPropVT("TRSRNTC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_PLACA_UF="'+;
	             DFGetPropVT("TRSPLACAUF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_PLACA_VEICULO="'+;
	             DFGetPropVT("TRSPLACA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_CPFCNPJ="'+;
	             DFGetPropVT("TRSCPFCNPJ") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_NOME="'+;
	             DFGetPropVT("TRSNOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_UF="'+;
	             DFGetPropVT("TRSUF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_IE="'+;
	             DFGetPropVT("TRSIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_TP_LOGRADOURO="'+;
	             ' ' +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_LOGRADOURO="'+;
	             DFGetPropVT("TRSLOGRA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_NRO="'+;
	             DFGetPropVT("TRSNRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COMPLEMENTO="'+;
	             DFGetPropVT("TRSCOMPLEM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_CEP="'+;
	             DFGetPropVT("TRSCEP") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_MUNI_IBGE="'+;
	             DFGetPropVT("TRSMUNIBGE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_MUNI_NOME="'+;
	             DFGetPropVT("TRSMUNNOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_BAIRRO="'+;
	             DFGetPropVT("TRSBAIRRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_PAIS="'+;
	             DFGetPropVT("TRSPAIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_FONE="'+;
	             DFGetPropVT("TRSFONE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*-------------------------------------------------------*
	LSLinhaXML = ULtratalinha('/>')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)


FUNCTION ULtratalinha
PARAMETERS LSLINHA

	LSLINHA = UPPER(LSLINHA)
	LSLINHA = RTRIM(LSLINHA)

RETURN(LSLINHA)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GD1           DFVersaoXML VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISCA,     Record Number:   47  º
*       º Variable:            DFVersaoXML                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      38                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gd1     &&  DFVersaoXML VALID
#REGION 1
RETURN

FUNCTION DFVersaoXML



	=DFModeloRefXML()  && VERIFICA ATUALIZACAO DO LAYOUT

	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDCFIS EXCL
	SET ORDER TO TAG XML_ORDEM
	GO TOP

	locate for "VERSAO-PROCESSO" $ xml_linha


	LSLinhaXML = ""

	
	IF !EOF()
		LSLinhaXML = xmlDCFIS.XML_LINHA
	ENDIF
	SELE xmlDCFIS
	USE
		

RETURN(LSLinhaXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GD6           DIVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:    2  º
*       º Variable:            DIVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      39                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gd6     &&  DIVerifyInst VALID
#REGION 2
return
*---------------------------------------------------------------*



FUNCTION DIVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("DocFisIt")


	DO CASE

		CASE TYPE("PBDocFisItAlias") = "U" ;
		   		OR EMPTY(PBDocFisItAlias) ;
		   		OR !USED(PBDocFisItAlias)
			=DICreate()					

		CASE !("DOCFISIT.DBF" $ DBF(PBDocFisItAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBDocFisItAlias
			=DICreate()					


		CASE  !(LSPath $ DBF(PBDocFisItAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=DIDestroi()				
			=DICreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GD9           DICreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:    3  º
*       º Variable:            DICreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      40                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gd9     &&  DICreate VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DICreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBDocFisItAlias") <> "U" ;
	   		AND !EMPTY(PBDocFisItAlias) ;
	   		AND USED(PBDocFisItAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBDocFisItAlias

	IF USED("DocFisIt")
	     =NetArqAgain("DocFisIt")
	     PBDocFisItAlias     = Alias()
	ELSE
	     =NetArqAgain("DocFisIt")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("DocFisIt")
	     PBDocFisItAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBDocFisItAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTDocFisIt[LMaxDim]
    PUBLIC DIMENSION VDDocFisIt[2,3]			&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFDocFisIt[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFDocFisIt)

	*-----------------------------------------------------------*
	=DIReadProperty()
	=DISetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GDE           DIDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:    4  º
*       º Variable:            DIDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      41                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gde     &&  DIDestroi VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION DIDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBDocFisItAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBDocFiscaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBDocFiscaAlias
	*  3- Se aplicar um FECHAMENTO a PBDocFiscaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBDocFiscaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBDocFisItAlias)) OR ;
	   !("DOCFISIT.DBF" $ DBF(PBDocFisItAlias))

		RELEASE PBDocFisItAlias
    	RELEASE VTDocFisIt
	    RELEASE VDDocFisIt
	    RELEASE VFDocFisIt
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBDocFisItAlias) AND USED(PBDocFisItAlias)
		SELECT &PBDocFisItAlias
		USE
	ENDIF	
	RELEASE PBDocFisItAlias
    RELEASE VTDocFisIt
    RELEASE VDDocFisIt
    RELEASE VFDocFisIt

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GDI           DIReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:    5  º
*       º Variable:            DIReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      42                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gdi     &&  DIReadProp VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=DIVerifyInst()

	SELE &PBDocFisItAlias
	SCATTER TO VTDocFisIt
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GDM           DISetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:    6  º
*       º Variable:            DISetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      43                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gdm     &&  DISetDerivadas VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DISetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

**	=DIVerifyInst()
	*--------------------------------------------------------------*
    VDDocFisIt(1,1) = "NAOINFORMADO"
   	VDDocFisIt(1,2) = 0
   	VDDocFisIt(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GDO           DISetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:    7  º
*       º Variable:            DISetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      44                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gdo     &&  DISetPropVT VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DISetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBDocFisItAlias,;
						    VTDocFisIt,;
							VDDocFisIt,;
							VFDocFisIt)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GDS           DIGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:    8  º
*       º Variable:            DIGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      45                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gds     &&  DIGetPropVT VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

**	=DIVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
					PBDocFisItAlias,;
					VTDocFisIt,;
					VDDocFisIt,;
					VFDocFisIt)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GDV           DIChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:    9  º
*       º Variable:            DIChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      46                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gdv     &&  DIChk_Identidade VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIChk_Identidade
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item
			


	PRIVATE LFretorno
	LFretorno = .t.



	=DIVerifyInst()
    =DISetPropVT("EMPRESA",PrmEmp)
    =DISetPropVT("MOD_DOC",PrmMod_doc)
    =DISetPropVT("COD_IDFORN",PrmCod_IDForn)
    =DISetPropVT("SERIE_DOC",PrmSerie_Doc)
    =DISetPropVT("NRO_DOC",PrmNro_Doc)
    =DISetPropVT("NRO_ITEM",PrmNro_Item)


	LFretorno=DIFind()
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GDZ           DIFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   10  º
*       º Variable:            DIFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      47                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gdz     &&  DIFind VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIFind

	PRIVATE LEmpresa,;
			LMod_doc,;
			LCod_IDForn,;
			LNro_Doc,;
			LSerie_Doc,;
			LNro_Item
			
	
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=DIVerifyInst()


	LEmpresa    = DIGetPropVT("Empresa")
	LMod_Doc    = DIGetPropVT("Mod_Doc")
	LCod_IdForn = DIGetPropVT("Cod_IdForn")
	LNro_Doc    = DIGetPropVT("Nro_Doc")
	LSerie_Doc  = DIGetPropVT("Serie_Doc")
	LNro_Item  = DIGetPropVT("Nro_Item")


	SELE &PBDocFisItAlias
	SET ORDER TO TAG item
	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+STR(LNro_Doc,7);
				+LSerie_Doc+STR(LNro_Item,5)

	IF FOUND()
		=DIReadProperty()
		=DISetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GE3           DIGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   11  º
*       º Variable:            DIGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      48                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123ge3     &&  DIGetFieldValue VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIGetFieldValue
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmSerie_Doc,;
			PrmNro_Doc,;
			PrmNro_Item,;
			PrmField


	IF !DIChk_Identidade(PrmEmp,;
					  PrmMod_doc,;
					  PrmCod_IDForn,;
					  PrmNro_Doc,;
					  PrmSerie_Doc,;
					  PrmNro_Item)
				
					
		DO WHILE .T.
			=UPerrosys("Chamada GetFieldValue para Reg. Inexistente!")
		ENDDO
	ENDIF				


RETURN(DIGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GE7           DI_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   12  º
*       º Variable:            DI_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      49                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123ge7     &&  DI_Refresh VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DI_Refresh
PARAMETERS  PrmEmpresa,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmSerie_Doc,;
			PrmNro_Doc,;
			PrmNro_Item
			

	PRIVATE LFreturn

	=DIVerifyInst()


	= DISetPropVT("Empresa"   ,PrmEmpresa)
	= DISetPropVT("Mod_Doc"   ,PrmMod_doc)
	= DISetPropVT("Cod_IdForn",PrmCod_IDForn)
	= DISetPropVT("Nro_Doc"   ,PrmNro_Doc)
	= DIFSetPropVT("Serie_Doc" ,PrmSerie_Doc)
	= DISetPropVT("Nro_Item"   ,PrmNro_Item)

	*----------------------------------------------------------------*


	=DIFind()
	
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GEB           DILerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   14  º
*       º Variable:            DILerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      50                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123geb     &&  DILerRegistro VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DILerRegistro
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item


	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = DIChk_Identidade(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item)

			
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GEF           DIWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   15  º
*       º Variable:            DIWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      51                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gef     &&  DIWriteProp VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBDocFisItAlias
	=RLOCK()
	GATHER FROM  VTDocFisIt
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GEI           DISalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   16  º
*       º Variable:            DISalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      52                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gei     &&  DISalvarRegistro VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DISalvarRegistro


	PRIVATE LFretorno
	LFretorno = .t.

	IF !DIExiste()
		SELE &PBDocFisItAlias
		APPEND BLANK
		LFretorno=DIWriteProp()
	ELSE
		SELE &PBDocFisItAlias
		LFretorno=DIWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GEM           DIExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   17  º
*       º Variable:            DIExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      53                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gem     &&  DIExiste VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIExiste

	PRIVATE LEmpresa,;
			LMod_doc,;
			LCod_IDForn,;
			LNro_Doc,;
			LSerie_Doc,;
			LNro_Item
			
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()


	LEmpresa    = DIGetPropVT("Empresa")
	LMod_Doc    = DIGetPropVT("Mod_Doc")
	LCod_IdForn = DIGetPropVT("Cod_IdForn")
	LNro_Doc    = DIGetPropVT("Nro_Doc")
	LSerie_Doc  = DIGetPropVT("Serie_Doc")
	LNro_Item   = DIGetPropVT("Nro_Item")


	SELE &PBDocFisItAlias
	SET ORDER TO TAG ITEM
	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	     STR(LNro_Doc,7)+LSerie_Doc+STR(LNro_Item,5)
	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GEQ           DIV10GravaXMLItensDocFiscal VALID  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   20  º
*       º Variable:            DIV10GravaXMLItensDocFiscal        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      54                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123geq     &&  DIV10GravaXMLItensDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIV10GravaXMLItensDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item,;
			PrmFileXML,;
			PrmNroIDfileXML

	*---------------------------------------------------*

	IF !DILerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item)
	      wait "Nao foi localizado Item DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+MOD_DOC+;
		      "FORN. : "+PrmCOD_IDFORN+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC+;
		      "ITEM  : "+STR(PrmNro_Item,4)
    	  return(.F.)
	ENDIF


	IF DIGetPropVT("QTDE") = 0
    	  return(.t.)
	ENDIF		




	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFLerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado Capa DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+MOD_DOC+;
		      "FORN. : "+PrmCOD_IDFORN+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC
    	  return(.F.)
	ENDIF
	

	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	SET POINT TO ","
	SET SEPARATOR  TO "."


	*-------------------------------------------------------*


		=W_DEFPROC("EMPRESA.SPR")
		=EMLerRegistro(PrmEmp)

		=W_DEFPROC("EMPRESA.SPR")
		LFieldTmp    =  EMGetPropVT("CGC")
	    UNEM_CNPJ    =  STR(LFieldTmp,14)
		UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")


		LSLinhaXML = '<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	


		*==========================================================*
		*  CAMPOS IDENTIFICADORES
		*==========================================================*
	

		=W_DEFPROC("EMPRESA.SPR")
		LFieldTmp    =  EMGetPropVT("EMITE_NFE")

		IF LFieldTmp $ "H"   && H=HOMOLOGACAO

			=W_DEFPROC("DOCFISCA.SPR")
			LSLinhaXML = 'DFIS_MOD_DOCUMENTO="'+;
	    	         "55" +;
	        	     '"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		ELSE
			=W_DEFPROC("DOCFISCA.SPR")
			LSLinhaXML = 'DFIS_MOD_DOCUMENTO="'+;
	    	         DFGetPropVT("MOD_DOC") +;
	        	     '"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF



		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CLFS_SIGLA="'+;
	             DFGetPropVT("TIPO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_IND_OPERACAO="'+;
	             DFGetPropVT("IND_OPER") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_TP_MOVIMENTO="'+;
	             DFGetPropVT("TP_MOV") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		*----------------------------------------------------------*
		=W_DEFPROC("DOCFISCA.SPR")
		LNNro_Doc  = DFGetPropVT("NRO_DOC")
		IF LNNro_Doc > 3000000
			LNNro_Doc = LNNro_Doc - 3000000
		ENDIF

		LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		*----------------------------------------------------------*



		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CPF="'+;
	             DFGetPropVT("CPF") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_IE="'+;
	             DFGetPropVT("IE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		*----------------------------------------------------*
		* SERIE UNICA => "0"
		*----------------------------------------------------*
	

		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = DFGetPropVT("SERIE_DOC")
		IF "U" $ LSLinhaXML
			LSLinhaXML = "0"
		ENDIF
		LSLinhaXML = 'DFIS_SERIE="'+;
	             LSLinhaXML +;
	             '"'
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		*----------------------------------------------------*

		LSLinhaXML = 'ITDF_NRO_ITEM="'+;
	             STR(DIGetPropVT("NRO_ITEM"),5) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		*-------------------------------------------------------*

		LSLinhaXML = 'ITDF_PROD_CODIGO="'+;
	             DIGetPropVT("PRODCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_DESCRICAO="'+;
	             DIGetPropVT("PRODDESCR") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_DESCR_COMPL="'+;
	             DIGetPropVT("PRODCOMPLE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_PROD_INFO_ADICIONAIS="'+;
	             DIGetPropVT("INFO_COMPL") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_UNIDADE="'+;
	             DIGetPropVT("UNIDADE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_PRECO_TABELA="'+;
	             STR(DIGetPropVT("PRECO_TAB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_PRECO_MAX_TABELADO="'+;
	             STR(DIGetPropVT("PRECOMAXTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_PRECO_MIN_TABELADO="'+;
	             STR(DIGetPropVT("PRECOMINTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	

		LSLinhaXML = 'ITDF_QTDE="'+;
	             STR(DIGetPropVT("QTDE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_DESCONTO="'+;
	             STR(DIGetPropVT("VLR_DESCTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_VLR_DESP_FINANCEIRA="'+;
	             STR(DIGetPropVT("VLRDESPFIN"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_OUTRAS_DESP_ACES="'+;
	             STR(DIGetPropVT("VLRDESPOUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_FRETE="'+;
	             STR(DIGetPropVT("VLR_FRETE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SEGURO="'+;
	             STR(DIGetPropVT("VLR_SEGURO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_FINAL="'+;
	             STR(DIGetPropVT("VLR_FINAL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_MENSAGEM="'+;
	             SPACE(5) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_IND_MOVIMENTO_ESTQ="'+;
	             DIGetPropVT("IND_MOVEST") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_QTDE_ITENS="'+;
	             STR(DIGetPropVT("LT_QTITENS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
		LSLinhaXML = 'ITDF_LOTE_NRO="'+;
	             DIGetPropVT("LT_NRO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_FABRICACAO="'+;
	             DTOC(DIGetPropVT("LT_DT_FABR")) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_VALIDADE="'+;
	             DTOC(DIGetPropVT("LT_VALIDAD")) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_MEDIO_ATUAL="'+;
	             STR(DIGetPropVT("CUSTOMEDAT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
		LSLinhaXML = 'ITDF_SALDO_ANTERIOR="'+;
	             STR(DIGetPropVT("SALDO_ANT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_MEDIO_ANT="'+;
	             STR(DIGetPropVT("CUSTOMEDAN"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_NA_OPERACAO="'+;
	             STR(DIGetPropVT("CUSTONAOPE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_A_TRIBUTAR="'+;
	             STR(DIGetPropVT("VLRATRIBUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_SALDO_ATUAL="'+;
	             STR(DIGetPropVT("SALDO_ATU"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_CONTABIL="'+;
	             STR(DIGetPropVT("CUSTOCONTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CFOP="'+;
	             DIGetPropVT("CFOP") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_CST_ICMS="'+;
	             DIGetPropVT("CST_ICMS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_IPI="'+;
	             DIGetPropVT("CST_IPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_ISS="'+;
	             DIGetPropVT("CST_ISS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_PIS="'+;
	             DIGetPropVT("CST_PIS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_COFINS="'+;
	             DIGetPropVT("CST_COFINS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_IR="'+;
	             DIGetPropVT("CST_IR") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS="'+;
	             STR(DIGetPropVT("BCBRUTAICM"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_REDUCAO="'+;
	             STR(DIGetPropVT("IND_REDUCA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS="'+;
	             STR(DIGetPropVT("BC_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_ORIGEM="'+;
	             STR(DIGetPropVT("ALQICMORIG"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_DESTINO="'+;
	             STR(DIGetPropVT("ALQICMDEST"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_DIF_ALIQUOTA="'+;
	             STR(DIGetPropVT("DIF_ALIQ"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS="'+;
	             STR(DIGetPropVT("ALIQ_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ICMS="'+;
	             STR(DIGetPropVT("VLR_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_REG_FISCAL_TRIB_ORIGEM="'+;
	             DIGetPropVT("RGTRIBORIG") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_REG_FISCAL_TRIB_DESTINO="'+;
	             DIGetPropVT("RGTRIBDEST") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISENTA_ICMS="'+;
	             STR(DIGetPropVT("BASE_ISENT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_OUTR_ICMS="'+;
	             STR(DIGetPropVT("BASE_OUTR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS_RTD="'+;
	             STR(DIGetPropVT("BCBRTRTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IVA="'+;
	             STR(DIGetPropVT("IVA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS_RTD="'+;
	             STR(DIGetPropVT("BC_RTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_ALIQ_ICMS_RTD="'+;
	             STR(DIGetPropVT("ALQICMRTDS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ICMS_RTD="'+;
	             STR(DIGetPropVT("ICM_RTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("BCBRTRTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_BC_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("BC_RTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ICMS_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("ICM_RTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_APURACAO_IPI="'+;
	             DIGetPropVT("INDAPURIPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_IPI="'+;
	             STR(DIGetPropVT("BC_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_IPI="'+;
	             STR(DIGetPropVT("ALIQ_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IPI="'+;
	             STR(DIGetPropVT("VLR_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISS="'+;
	             STR(DIGetPropVT("BC_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ISS="'+;
	             STR(DIGetPropVT("ALIQ_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ISS="'+;
	             STR(DIGetPropVT("VLR_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISS_RTD="'+;
	             STR(DIGetPropVT("BC_ISS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ISS_RTD="'+;
	             STR(DIGetPropVT("ALIQ_ISSRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ISS_RTD="'+;
	             STR(DIGetPropVT("VLR_ISSRTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_PIS="'+;
	             STR(DIGetPropVT("BC_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_PIS="'+;
	             STR(DIGetPropVT("ALIQ_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_PIS="'+;
	             STR(DIGetPropVT("QTDBASEPIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS="'+;
	             STR(DIGetPropVT("VLR_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS_RTD="'+;
	             STR(DIGetPropVT("PIS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_COFINS="'+;
	             STR(DIGetPropVT("BC_COFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_COFINS="'+;
	             STR(DIGetPropVT("ALIQCOFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_COFINS="'+;
	             STR(DIGetPropVT("QTDBASECOF"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_COFINS="'+;
	             STR(DIGetPropVT("VLR_COFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_COFINS_RTD="'+;
	             STR(DIGetPropVT("COFINS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_IR="'+;
	             STR(DIGetPropVT("BC_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_IR="'+;
	             STR(DIGetPropVT("ALIQ_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IR="'+;
	             STR(DIGetPropVT("VLR_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IR_RTD="'+;
	             STR(DIGetPropVT("IR_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_CSLL="'+;
	             STR(DIGetPropVT("BC_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_CSLL="'+;
	             STR(DIGetPropVT("ALIQ_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_CSLL="'+;
	             STR(DIGetPropVT("VLR_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ADIANTAMENTO_CSLL="'+;
	             STR(DIGetPropVT("ADNTA_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LANC_AUTOMATICO="'+;
	             DIGetPropVT("LANC_AUTO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_SERV_TELECOM="'+;
	             DIGetPropVT("CLSCOMNC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_GAS="'+;
	             DIGetPropVT("CLSGAS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_AGUA="'+;
	             DIGetPropVT("CLSAGUA") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_ENERGIA_ELETR="'+;
	             DIGetPropVT("CLSENRG") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_SO="'+;
	             STR(DIGetPropVT("ALIQICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_MOD_BC_ICMS="'+;
	             DIGetPropVT("MOD_BCICMS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PERCENTUAL_ACRESCIMO="'+;
	             STR(DIGetPropVT("PRC_ACRESC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PERCENTUAL_DESCONTO="'+;
	             STR(DIGetPropVT("PRC_DESCON"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_VENDA_UNITARIO="'+;
	             STR(DIGetPropVT("PRECOVENDA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ABATE_NT="'+;
	             STR(DIGetPropVT("VLRABATENT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ACRESCIMO="'+;
	             STR(DIGetPropVT("VLRACRESC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS_SO="'+;
	             STR(DIGetPropVT("BCBRICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS_SO="'+;
	             STR(DIGetPropVT("BCICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISENTA_IPI="'+;
	             STR(DIGetPropVT("BCISENTIPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_COFINS_IMPORTACAO="'+;
	             STR(DIGetPropVT("VLRCOFIMPO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_DESPESAS="'+;
	             STR(DIGetPropVT("VLR_DESPES"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ICMS_SO="'+;
	             STR(DIGetPropVT("VLR_ICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS_IMPORTACAO="'+;
	             STR(DIGetPropVT("VLRPISIMPO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PRODUTOS="'+;
	             STR(DIGetPropVT("VLRPRODUTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SERVICO_NT="'+;
	             STR(DIGetPropVT("VLRSRVC_NT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SERVICOS="'+;
	             STR(DIGetPropVT("VLRSERVICO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_TRIBUTOS="'+;
	             STR(DIGetPropVT("VLRTRIBUTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ORIGEM_MERCADORIA="'+;
	             DIGetPropVT("ORIGEMMRCD") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = DIGetPropVT("ITEMSERVIC")
		IF LSLinhaXML = "S"
			LSLinhaXML = 'ITDF_O_ITEM_E_SERVICO="'+;
	             "SIM" +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ELSE
			LSLinhaXML = 'ITDF_O_ITEM_E_SERVICO="'+;
	             "NAO" +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF


		LSLinhaXML = 'ITDF_VLR_PRODUTOS_SERVICOS="'+;
	             STR(DIGetPropVT("TTPRODSRVC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_GTIM="'+;
	             DIGetPropVT("GTIMCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_NCM="'+;
	             DIGetPropVT("NCMCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_EX_TIPI="'+;
	             DIGetPropVT("EXTIPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_GENERO="'+;
	             DIGetPropVT("GENEROPROD") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_GTIM_UNIDADE_TRIBUTAVEL="'+;
	             DIGetPropVT("GTIMUNTRIB") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_UNIDADE_TRIBUTAVEL="'+;
	             DIGetPropVT("UNIDTRIBUT") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_UNIDADE_TRIBUTAVEL="'+;
	             STR(DIGetPropVT("VLRUNTRIBU"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_UNIDADE_TRIBUTAVEL="'+;
	             STR(DIGetPropVT("QTDTRIBUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLS_CODIGO_LISTA_SERVICO="'+;
	             DIGetPropVT("CDGLSTSRVC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_MOD_BC_ICMS_RTD="'+;
	             DIGetPropVT("MODBCICMRT") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_COFINS_RTD="'+;
	             STR(DIGetPropVT("QTDBCCOFRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_INSS="'+;
	             STR(0,15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_VLR_ALIQ_COFINS_RTD="'+;
	             STR(DIGetPropVT("VLRALQCFRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_IND_MED_BC_ICMS_RTD="'+;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))






		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CNPJ="'+;
	             DFGetPropVT("CNPJ") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		*-------------------------------------------------------*
		LSLinhaXML = '/>'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	
		SET POINT TO
		SET SEPARATOR to

RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GG1           DIGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   21  º
*       º Variable:            DIGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      55                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gg1     &&  DIGetAlias VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DIGetAlias

	=DIVerifyInst()

RETURN(PBDocFisItAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GG3           DICFOPS VALID                      º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   22  º
*       º Variable:            DICFOPS                            º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      56                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gg3     &&  DICFOPS VALID
#REGION 2
RETURN

*-------------------------------------------------------*
*-----> DEFINECFOP PARA SERVICO
*-------------------------------------------------------*

FUNCTION DICFOPS
PARAMETERS PrmUFOrgn, PrmMuniOrgn,PrmUFDstn, PrmMuniDstn,PrmTp_mercad,;
           PrmOperacao

	PRIVATE LScfps


	=W_DEFPROC("TRIBUTAR.SPR")
    LScfps = TRCFOPServico(PrmUFOrgn, PrmMuniOrgn,PrmUFDstn,;
    					   PrmMuniDstn,PrmTp_mercad,PrmOperacao)
RETURN(LScfps)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GG7           DICST_IPI VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   23  º
*       º Variable:            DICST_IPI                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      57                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gg7     &&  DICST_IPI VALID
#REGION 2
RETURN

FUNCTION DICST_IPI
PARAMETERS PrmVlrIPI,PrmOperacao
	PRIVATE LScstIPI



	=W_DEFPROC("TRIBUTAR.SPR")
    LScstIPI = TRCST_IPI(PrmVlrIPI,PrmOperacao)

RETURN(LScstIPI)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GGA           DICST_ISS VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   24  º
*       º Variable:            DICST_ISS                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      58                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gga     &&  DICST_ISS VALID
#REGION 2
RETURN

FUNCTION DICST_ISS
PARAMETERS PrmVlrISS,PrmOperacao
	PRIVATE LScstISS


	=W_DEFPROC("TRIBUTAR.SPR")
    LScstISS = TRCST_ISS(PrmVlrISS,PrmOperacao)
RETURN(LScstISS)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GGD           DIGenero VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   25  º
*       º Variable:            DIGenero                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      59                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123ggd     &&  DIGenero VALID
#REGION 2
RETURN

FUNCTION DIGenero
PARAMETERS PrmTp_mercad,PrmClassifica,PrmOperacao
	PRIVATE LSgenero

	=W_DEFPROC("TRIBUTAR.SPR")
    LSgenero = TRGenero(PrmTp_mercad,PrmClassifica,PrmOperacao)

RETURN(LSgenero)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GGF           DICST_Entrada VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   26  º
*       º Variable:            DICST_Entrada                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      60                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*



FUNCTION _2wz123ggf     &&  DICST_Entrada VALID
#REGION 2
RETURN


FUNCTION DICST_Entrada
PARAMETERS PrmCstInfo,PrmOrigem,PrmTp_Mercad,Prmbase_calc,PrmVlrvenda,;
		Prmicms_subs, PrmCodigo


	PRIVATE LScst

	=W_DEFPROC("TRIBUTAR.SPR")
	LScst = TRCST_Entrada(PrmCstInfo, PrmOrigem, ;
						  PrmTp_Mercad, Prmbase_calc, PrmVlrvenda,;
					  	  Prmicms_subs, PrmCodigo)
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GGJ           DICST_ICMS VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   27  º
*       º Variable:            DICST_ICMS                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      61                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123ggj     &&  DICST_ICMS VALID
#REGION 2
RETURN

FUNCTION DICST_ICMS
PARAMETERS Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto

	PRIVATE LScstICMS

	=W_DEFPROC("TRIBUTAR.SPR")
    LScstICMS = TRCST_ICMS(Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto)

RETURN(LScstICMS)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GGM           DICST_PIS VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   28  º
*       º Variable:            DICST_PIS                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      62                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123ggm     &&  DICST_PIS VALID
#REGION 2
RETURN

FUNCTION DICST_PIS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	=W_DEFPROC("TRIBUTAR.SPR")
    LScst = TRCST_PIS(PrmVlr,PrmOperacao)
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GGP           DICST_COFINS VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   29  º
*       º Variable:            DICST_COFINS                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      63                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123ggp     &&  DICST_COFINS VALID
#REGION 2
RETURN

FUNCTION DICST_COFINS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	=W_DEFPROC("TRIBUTAR.SPR")
    LScst = TRCST_COFINS(PrmVlr,PrmOperacao)
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GGS           DICST_IR VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   30  º
*       º Variable:            DICST_IR                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      64                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123ggs     &&  DICST_IR VALID
#REGION 2
RETURN

FUNCTION DICST_IR
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	=W_DEFPROC("TRIBUTAR.SPR")
    LScst = TRCST_IR(PrmVlr,PrmOperacao)
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GGV           DIGerXMLPeriodoDocFiscal VALID     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   32  º
*       º Variable:            DIGerXMLPeriodoDocFiscal           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      65                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123ggv     &&  DIGerXMLPeriodoDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIGerXMLPeriodoDocFiscal
PARAMETER PrmEmpresa,PrmDtIni,PrmDtFim




	PRIVATE LSalias
	
	PRIVATE PrmAlsDI

	PRIVATE LNItDocFiscaCtrRegistro	



	=DIVerifyInst()
	

	LSalias = ALIAS()
	PrmAlsDI = DIGetAlias()




	*-------------------------------------------------------*




   	PRIVATE LSfileXML,LNroIDfileXML, LSnomeArqXml

	LSnomeArqXml = STR(PrmEmpresa,2)+;
				   "IT"+;
				   STR(MONTH(PrmDtFim),2)+;
				   STR(DAY(PrmDtFim),2)

	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")

   	LSfileXML	= "\SCGC\EFD\"+LSnomeArqXml+".XML"






  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return
   	endif

	*---------------------------------------------------*

	SELE &PrmAlsDI
	SET ORDER TO TAG DATA_DOC
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+DTOS(PrmDtIni)
	SET NEAR OFF

	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNItDocFiscaCtrRegistro = RECNO()

	COUNT  WHILE !EOF() ;
	        AND PrmEmpresa =  &PrmAlsDI .empresa;
	        AND PrmDtIni   <= &PrmAlsDI .DT_ENTSAI ;
	        AND PrmDtFim   >= &PrmAlsDI .DT_ENTSAI ;
         TO LNimpressao
	GO LNItDocFiscaCtrRegistro
	LNimpressos = 0
	*----------------------------------------------------*

	=DIInicioXML(LSfileXML,LNroIDfileXML)

	SELE &PrmAlsDI

	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa =  &PrmAlsDI .empresa;
	        AND PrmDtIni   <= &PrmAlsDI .DT_ENTSAI ;
	        AND PrmDtFim   >= &PrmAlsDI .DT_ENTSAI

		=UPtermo()


		=DIGravaXMLItensDocFiscal(;
				&PrmAlsDI .Empresa,;
				&PrmAlsDI .Mod_doc,;
				&PrmAlsDI .Cod_IDForn,;
				&PrmAlsDI .Nro_Doc,;
				&PrmAlsDI .Serie_Doc,;
				&PrmAlsDI .Nro_Item,;
				LSfileXML,;
				LNroIDfileXML)

		SELE &PrmAlsDI
		SET ORDER TO TAG DATA_DOC


		SET ORDER TO TAG DATA_DOC
		*-----------------------*
		GO LNItDocFiscaCtrRegistro
	
		SKIP
	
		LNItDocFiscaCtrRegistro = RECNO()
	ENDDO
	=DIFinalXML(LSfileXML,LNroIDfileXML)

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GH2           DIModeloRefXML VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   33  º
*       º Variable:            DIModeloRefXML                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      66                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gh2     &&  DIModeloRefXML VALID
#REGION 2
RETURN

FUNCTION DIModeloRefXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\DOCFISIT.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\xmlDIFIS EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE xmlDIFIS


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GH6           DIInicioXML VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   34  º
*       º Variable:            DIInicioXML                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      67                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gh6     &&  DIInicioXML VALID
#REGION 2
RETURN

FUNCTION DIInicioXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML



	=DIModeloRefXML()

	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDIFIS EXCL
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND xmlDIFIS.XML_ORDEM < 9999999999901
	
		LSLinhaXML = xmlDIFIS.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE xmlDIFIS
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GH9           DIFinalXML VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   35  º
*       º Variable:            DIFinalXML                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      68                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gh9     &&  DIFinalXML VALID
#REGION 2
RETURN

FUNCTION DIFinalXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDIFIS EXCL
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF xmlDIFIS.XML_ORDEM > 9999999999900
			LSLinhaXML = xmlDIFIS.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE xmlDIFIS
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GHD           DIConvrtNFDocFiscal VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   37  º
*       º Variable:            DIConvrtNFDocFiscal                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      69                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123ghd     &&  DIConvrtNFDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIConvrtNFDocFiscal
PARAMETERS PrmEmpresa,PrmNota,PrmOrientacao

	PRIVATE PrmAlsNF,PrmAlsIT
	PRIVATE LFLAG_COPIA
	PRIVATE LFLAG_DEVOLUCAO
	PRIVATE LNNroDacComItens
	PRIVATE LNNroWhileNF


	*--------------------------------------------------*
	PRIVATE LNCod_Mod_Rf,LaliqOrg
	
	PRIVATE LOperacao

	PRIVATE LUFDstn

	PRIVATE LMunDstn

	PRIVATE LUFOrig
	PRIVATE LMunOrig
	PRIVATE LTab_Cst

	PRIVATE LNAliq_icms

	*--------------------------------------------------*

	PRIVATE  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc


	*--------------------------------------------------*
	

	=W_DEFPROC("NOTA.SPR")
	PrmAlsNF = NFGetAlias()


	=W_DEFPROC("ITEMMOV.SPR")
	PrmAlsIT = IMGetAlias()


	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)
		WAIT WINDOW "NFs nao localizada  <ENTER> " NOWAIT
		RETURN(.F.)
	ENDIF




	=W_DEFPROC("EMPRESA.SPR")
	LTab_Cst  	= EMGet_TabCst(  &PrmAlsNF .EMPRESA )




	*---------------------------------------------------*

	LFLAG_COPIA = "NAO"
	LNNroDacComItens = 0

	IF &PrmAlsNF .referencia <> &PrmAlsNF .orcamento ;
	  AND ( &PrmAlsNF .referencia > 1000000 AND ;
	        &PrmAlsNF .referencia < 2000000)

								* ==> TRATA-SE DE UMA NOTA COPIA DE CUPOM

		LFLAG_COPIA    = "SIM"
		LNNroDacComItens =  &PrmAlsNF .referencia  && LER ITENS DO CUPOM
		                                           && ORIGEM DA COPIA

	ELSE
		LNNroDacComItens =  PrmNota				   && LER ITENS DA PROPRIA
		                                           && NOTA
	
	ENDIF
	


	*---------------------------------------------------*
	LFLAG_DEVOLUCAO = "NAO"
	IF &PrmAlsNF .TIPO = "ENT"
		LFLAG_DEVOLUCAO = "SIM"
	ENDIF

	*---------------------------------------------------*


	SET NEAR ON

	SELE &PrmAlsIT

	SET ORDER TO TAG NOTA

	IF LFLAG_DEVOLUCAO = "SIM"
		SEEK STR(PrmEmpresa,3)+"E"+STR(LNNroDacComItens,7)
	ELSE
		SEEK STR(PrmEmpresa,3)+"S"+STR(LNNroDacComItens,7)
	ENDIF

	*---------------------------------------------------*

	IF  PrmEmpresa           <> &PrmAlsIT .empresa ;
		OR  LNNroDacComItens <> &PrmAlsIT .nota

		WAIT WINDOW ;
		   "Nao foi possivel exportar itens-REENVIE <ENTER> " NOWAIT
		RETURN(.F.)
	ENDIF


	IF LEFT(  &PrmAlsIT .operacao,1 ) = "S"
		LOperacao = "SAIDA"
	ELSE
		LOperacao = "ENTRADA"
	ENDIF	


	IF LEFT(  &PrmAlsIT .operacao,1 ) = "S"

		=W_DEFPROC("EMPRESA.SPR")
		LUFOrig   = EMGet_UF(  &PrmAlsNF .EMPRESA )

		=W_DEFPROC("EMPRESA.SPR")
		LMunOrig  = EMGet_Municipio(  &PrmAlsNF .EMPRESA )

		LUFDstn   = &PrmAlsNF .UF
		LMunDstn  = &PrmAlsNF .CIDADE
	ELSE
		=W_DEFPROC("EMPRESA.SPR")
		LUFDstn   = EMGet_UF(  &PrmAlsNF .EMPRESA )

		=W_DEFPROC("EMPRESA.SPR")
		LMunDstn  = EMGet_Municipio(  &PrmAlsNF .EMPRESA )

		LUFOrig  = &PrmAlsNF .UF
		LMunOrig = &PrmAlsNF .CIDADE
	ENDIF	

	=W_DEFPROC("TRIBUTAR.SPR")
	LaliqOrg = TRAlqIcmOuUF(LUFOrig)  && ALIQ. EXTERNA DA UF ORIGEM

	=W_DEFPROC("TRIBUTAR.SPR")
	LaliqDst = TRAlqIcmInUF(LUFDstn)  && ALIQ. Interna DA UF DESTINO

	SET NEAR OFF


	*---------------------------------------------------*




	PrmSerie   		= &PrmAlsNF .Serie
	PrmTipo    		= &PrmAlsNF .tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""
	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


    m.EMPRESA    =   PrmEmpresa
    m.TIPO    	 =   PrmTipo
    m.MOD_DOC    =   RtnMod_Doc
    m.COD_IDFORN =   RtnCOD_IDFORN
    m.NRO_DOC    =   RtnNro_Doc
    m.SERIE_DOC  =   RtnSerie_Doc



	*---------------------------------------------------*

	=DIDelItensDocFiscal(;
			PrmEmpresa,;
		 	RtnMod_Doc,;
		  	RtnCOD_IDFORN,;
  	  	    RtnNro_Doc ,;
		  	RtnSerie_Doc)

	*---------------------------------------------------*


	DO WHILE !EOF() ;
		   AND PrmEmpresa        = &PrmAlsIT .empresa ;
		   AND LNNroDacComItens  = &PrmAlsIT .nota
	

		IF LFLAG_DEVOLUCAO = "NAO"	 ;
		   AND LEFT( &PrmAlsIT .OPERACAO ,1) <> "S"
		   EXIT
		ENDIF


		IF     LFLAG_DEVOLUCAO = "SIM"	 ;
		   AND LEFT( &PrmAlsIT .OPERACAO ,1) <> "E"
		   EXIT

		ENDIF


		*-------------------------------------------------*
		* PrmOrientacao = "PRODUTO/SERVICO" => nao filtra
		*-------------------------------------------------*

		DO CASE
			CASE PrmOrientacao = "PRODUTO"
				IF &PrmAlsIT .tp_mercad = 7  && SERVICO
					SKIP
					LOOP
				ENDIF
		        STORE .T. TO LFGerNF   && SINALIZA QUE FOI GERADA
		                               && NOTA SERIE UNICA
			CASE PrmOrientacao = "SERVICO"
				IF &PrmAlsIT .tp_mercad <> 7 && NAO SERVICO
					SKIP
					LOOP
				ENDIF
		ENDCASE






	    m.DT_DOC    	= &PrmAlsNF .data
    	m.DT_ENTSAI    	= &PrmAlsNF .data




		*----------------------------------------------------*
		*  DADOS GERAIS DO ITEM NO REGISTRO
		*----------------------------------------------------*


	    m.NRO_ITEM   = &PrmAlsIT .Ordem
    	m.PRODCODIGO = &PrmAlsIT .Codigo

		=W_DEFPROC("GRUPO.SPR")
		M.PRODDESCR = GRGetFieldValue( &PrmAlsIT .CODIGO,"DESCRICAO")

	    M.PRODDESCR = DFLimpaString(M.PRODDESCR)

	    M.PRODCOMPLE= DFLimpaString( &PrmAlsIT .DescrCompl )

	    M.INFO_COMPL= DFLimpaString( &PrmAlsIT .Info_compl )

		=W_DEFPROC("GRUPO.SPR")
		M.UNIDADE = GRGetFieldValue( &PrmAlsIT .CODIGO,"UNIDADE")
		m.UNIDTRIBUT = M.UNIDADE

		IF EMPTY(M.UNIDADE)
			M.UNIDADE = "UN"
			m.UNIDTRIBUT = "UN"
		ENDIF

    	m.PRECO_TAB  = &PrmAlsIT .Preco
    	m.PRECOMAXTB    =    0
	    m.PRECOMINTB    =    0

		IF &PrmAlsIT .Qtde > 0
		    m.PRECOVENDA    =    &PrmAlsIT .VLRVENDA /  &PrmAlsIT .Qtde
		    m.VLR_UNIDAD    =    &PrmAlsIT .VLRVENDA /  &PrmAlsIT .Qtde
			m.VLRUNTRIBU    =    &PrmAlsIT .VLRVENDA /  &PrmAlsIT .Qtde
		ELSE
			m.PRECOVENDA    =    0
		    m.VLR_UNIDAD    =    0
			m.VLRUNTRIBU    =    0

		ENDIF

	    m.QTDE    		=    &PrmAlsIT .Qtde

		M.QTDTRIBUT	    =    &PrmAlsIT .Qtde
	    m.VLR_DESCTO    =    0
	    m.PRC_DESCTO    =    0
    	m.VLRDESPFIN    =    0
	    m.VLRDESPOUT    =    0
    	m.VLR_FRETE     =    0
	    m.VLR_SEGURO    =    0
    	M.VLR_FINAL    =    &PrmAlsIT .VlrVenda +;
					    	&PrmAlsIT .vlripi+;
					    	&PrmAlsIT .ICMS_SUBS





		IF &PrmAlsIT .MovEstq = "N"  OR LFLAG_COPIA = "SIM"
		    m.IND_MOVEST    =     "NAO"
		ELSE
		    m.IND_MOVEST    =     "SIM"
		ENDIF


    	m.LT_QTITENS    =    0
	    m.LT_NRO   		=    ""
    	m.LT_DT_FABR    =    {}
	    m.LT_VALIDAD    =    {}
	    m.CLSCOMNC    	=    "00"
    	m.CLSGAS    	=    "00"
	    m.CLSAGUA    	=    "00"
    	m.CLSENRG    	=    "00"


		*----------------------------------------------------*
		*  DADOS TRIBUTARIOS DO REGISTRO
		*----------------------------------------------------*
		
	    m.VLRATRIBUT    =     &PrmAlsIT .VlrVenda
    	m.CUSTONAOPE    =     0
	    m.CUSTOMEDAN    =     0

    	IF  &PrmAlsIT .MovEstq = "S"
		    IF  LEFT( &PrmAlsIT .Operacao,1) = "S"
			    m.SALDO_ANT  =  ;
		               &PrmAlsIT .Sld_estq +  &PrmAlsIT .Qtde
			ELSE
			    m.SALDO_ANT  =  ;
	               &PrmAlsIT .Sld_estq -  &PrmAlsIT .Qtde

			ENDIF
		ELSE
		    m.SALDO_ANT   =  &PrmAlsIT .Sld_estq
    	ENDIF



	    IF  &PrmAlsIT .Sld_estq > 0
		    m.CUSTOMEDAT  = ;
	               &PrmAlsIT .Vlr_estq  /  &PrmAlsIT .Sld_estq

		ELSE
		    m.CUSTOMEDAT  =  &PrmAlsIT .Vlr_estq
	    ENDIF

	    m.SALDO_ATU     =  &PrmAlsIT .Sld_estq
	

	    m.CUSTOCONTB =  0



		LTp_mercad = &PrmAlsIT .tp_mercad
    	IF &PrmAlsIT .tp_mercad = 7   && SERVICO

			LScfop =DICFOPS(LUFOrig, ;
					          LMunOrig,;
					          LUFDstn,;
					          LMunDstn,;
					          LTp_mercad,;
					          LOperacao)
		    m.CFOP = LScfop
		ELSE
		    m.CFOP = &PrmAlsIT .CFO
		ENDIF

	    m.CFOP = ALLTRIM(CHRTRAN(m.CFOP,".",""))

		*-----------------------------------------*

		IF	LFLAG_COPIA    = "SIM"
			* m.CFOP	= LEFT(m.CFOP,1)+"929"  && 5929 ou 6929 COPIA CUPOM
			m.CFOP	= "5929"  && 5929    ==> 6929 nao e aceito efd

		ENDIF



		IF	RtnMod_Doc    =   "2D"   && cupom
			m.CFOP	= "5"+SUBS(m.CFOP,2)

		ENDIF

		IF  m.CFOP	= "5404"
			 m.CFOP	= "5403"
		ENDIF

		IF 	m.CFOP	= "5108"
			 m.CFOP	= "5102"
		ENDIF		

		*-----------------------------------------*


		m.origemmrcd = chrtran(str( &PrmAlsIT .origem ,1)," ","0")


		LTipo       = &PrmAlsIT .Tipo
		LProduto 	= &PrmAlsIT .codigo
		LTp_mercad  = &PrmAlsIT .tp_mercad


		LSCst 		= DICST_ICMS(LTab_cst,LTipo,Ltp_mercad,LProduto)
   		m.CST_ICMS  = LSCst


		LSCst 		= DICST_IPI(  &PrmAlsIT .VlrIPI, LOperacao)
    	m.CST_IPI   = LSCst

	    IF &PrmAlsIT .tp_mercad = 7   && SERVICO
			LSCst 	= DICST_ISS(  &PrmAlsIT .VlrVenda, LOperacao)
		ELSE
			LSCst 	= DICST_ISS(  0, LOperacao)
		ENDIF
    	m.CST_ISS	= LSCst

		LSCst		= DICST_PIS(  0, LOperacao)
    	m.CST_PIS   =    LSCst


		LSCst = DICST_IR(  0, LOperacao)
    	m.CST_IR    = LSCst



		=W_DEFPROC("TRIBUTAR.SPR")
		LRgmTrb = TRDef_RgTrbMercad(LUFOrig, ;
						 &PrmAlsIT .Codigo,;
						 'RETORNAR STRING' )
	    m.RGTRIBORIG    =   LRgmTrb



		=W_DEFPROC("TRIBUTAR.SPR")
		LRgmTrb = TRDef_RgTrbMercad(LUFDstn,;
		                          &PrmAlsIT .Codigo,;
						 'RETORNAR STRING' )
	    m.RGTRIBDEST    =   LRgmTrb



	    m.ALQICMORIG    =   LaliqOrg
	    m.ALQICMDEST    =   LaliqDst

	    m.BASE_ISENT    =   &PrmAlsIT .Base_Isent
    	m.BASE_OUTR    	=   &PrmAlsIT .Base_Outr



	    m.BCBRTRTD_S    =   &PrmAlsIT .Base_sbbrt
    	m.IVA    		=   &PrmAlsIT .Iva
	    m.BC_RTD_S    	=   &PrmAlsIT .Base_subs
	    m.ALQICMRTDS    =   m.ALQICMDEST - m.ALQICMORIG

	    IF m.ALQICMRTDS < 0
		    m.ALQICMRTDS = 0
		ENDIF




	    m.BCBRUTAICM =   &PrmAlsIT .BsBr_Icms
    	m.IND_REDUCA =   &PrmAlsIT .aliq_rdu
	    m.BC_ICMS    =   &PrmAlsIT .base_calc
		Laliq  = ABS(LaliqOrg - LaliqDst)

    	m.DIF_ALIQ     =   Laliq
		IF m.BC_ICMS =  0
	    	m.VLR_ICMS     =   0
		ELSE
	    	m.VLR_ICMS     =   &PrmAlsIT .Vlr_Icms
		ENDIF


    	m.ICM_RTD_S    	=   &PrmAlsIT .ICMS_Subs


		DO CASE

			CASE LFLAG_COPIA    = "SIM"
				m.CST_ICMS = m.origemmrcd+"90"

	    	CASE &PrmAlsIT .tp_mercad = 7   && SERVICO
				m.CST_ICMS = m.origemmrcd+"90"
	

			*-------------------------------------------*
			* FOI ALTERADO PARA NAO AFETAR O CST NFe
			*-------------------------------------------*
			*CASE m.BC_ICMS =  0 and m.ICM_RTD_S = 0
			*	m.CST_ICMS = m.origemmrcd+"40"

		ENDCASE




	    m.ALIQ_ICMS    =   &PrmAlsIT .Aliq_Icms

		IF SUBS(m.CST_ICMS,2,2) $ "00/10/20/70"
		    m.ALIQ_ICMS    =   &PrmAlsIT .Aliq_Icms
		endif	


		IF SUBS(m.CST_ICMS,2,2) $ "30/40/41/50/60"
		    m.ALIQ_ICMS    =   0
		endif	

		IF SUBS(m.CST_ICMS,2,2) $ "90"
	    	IF &PrmAlsIT .tp_mercad = 7   && SERVICO
			    m.ALIQ_ICMS    =   0
			ENDIF
		endif	




	    m.BCBRTRTD_E    =   0
    	m.BC_RTD_E    	=   0
	    m.ICM_RTD_E    	=   0

	    m.INDAPURIPI    =   "1"

	    m.BC_IPI    	=   &PrmAlsIT .base_ipi
    	m.ALIQ_IPI    	=   &PrmAlsIT .aliq_ipi
	    m.VLR_IPI    	=   &PrmAlsIT .vlripi


	    m.BC_ISS    	=   &PrmAlsIT .base_iss
	    m.ALIQ_ISS    	=   &PrmAlsIT .aliq_iss
    	m.VLR_ISS    	=   &PrmAlsIT .vlr_iss



	    IF &PrmAlsIT .vlr_issrtd > 0
	    	m.BC_ISS_RTD    =   &PrmAlsIT .base_iss
		    m.ALIQ_ISSRT    =   &PrmAlsIT .aliq_iss
		    m.VLR_ISSRTD    =   &PrmAlsIT .vlr_issrtd


		ELSE
	    	m.BC_ISS_RTD    =   0
		    m.ALIQ_ISSRT    =   0
		    m.VLR_ISSRTD    =   0
		ENDIF

	    m.BC_PIS    	=   &PrmAlsIT .base_iss
    	m.ALIQ_PIS    	=   1.65
	    m.QTDBASEPIS    =   &PrmAlsIT .qtde
    	m.VLR_PIS    	=   ROUND( &PrmAlsIT .base_iss *  1.65 /100,2)


	    m.PIS_RTD    	=   0

    	m.BC_COFINS    	=   &PrmAlsIT .base_iss
	    m.ALIQCOFINS    =   7.6
    	m.QTDBASECOF    =   &PrmAlsIT .qtde
	    m.VLR_COFINS    =   ROUND( &PrmAlsIT .base_iss *  7.6 /100 ,2)


		LSCst = DICST_COFINS(  m.VLR_COFINS, LOperacao)
    	m.CST_COFINS=    LSCst






    	m.COFINS_RTD    =   0

	    m.BC_IR    		=   0
	    m.ALIQ_IR    	=   0
	    m.VLR_IR    	=   0
    	m.IR_RTD    	=   0
	    m.BC_CSLL    	=   0
    	m.ALIQ_CSLL    	=   0
	    m.VLR_CSLL    	=   0
    	m.ADNTA_CSLL    =   0
	    m.LANC_AUTO    	=   "SIM"



	    m.VLRCOFIMPO  	=   0
	    m.VLR_DESPES  	=   0
	    m.VLR_ICMSSO  	=   0
	    m.VLRpisimpo  	=   0

	    m.VLRSRVC_NT   	=   &PrmAlsIT .base_iss

    	M.VLRSERVICO = 0
   	    M.VLRPRODUTO = 0
   	
    	IF &PrmAlsIT .tp_mercad = 7   && SERVICO
    	   M.VLRSERVICO = &PrmAlsIT .VLRVENDA
    	ELSE
    	   M.VLRPRODUTO = &PrmAlsIT .VLRVENDA
    	ENDIF

		M.TTPRODSRVC = M.VLRSERVICO + M.VLRPRODUTO



		M.MODBCICMRT = "0"
		M.MOD_BCICMS = "3"




		=W_DEFPROC("GRUPO.SPR")
		M.GTIMCODIGO = GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_GTIM")
		

		=W_DEFPROC("GRUPO.SPR")
		M.NCMCODIGO = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_NCM"))
		M.NCMCODIGO = CHRTRAN(M.NCMCODIGO,".","")

		=W_DEFPROC("GRUPO.SPR")
		M.EXTIPI = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"EX_TIPI"))


		=W_DEFPROC("GRUPO.SPR")
		M.GENEROPROD = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_GENERO"))



    	IF &PrmAlsIT .tp_mercad = 7   && SERVICO
    	   M.ITEMSERVIC = "S"
    	ELSE
    	   M.ITEMSERVIC = "N"
    	ENDIF



		=W_DEFPROC("GRUPO.SPR")
		M.CDGLSTSRVC = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_LSTSRV"))


		LEmpresa    = m.Empresa
		LMod_Doc    = m.Mod_Doc
		LCod_IdForn = m.Cod_IdForn
		LNro_Doc    = m.Nro_Doc
		LSerie_Doc  = m.Serie_Doc
		LNro_Item   = m.Nro_Item


		SELE &PBDocFisItAlias
		SET ORDER TO TAG ITEM
		SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	      STR(LNro_Doc,7)+LSerie_Doc+STR(LNro_Item,5)



	
		IF !found()
			APPEND BLANK
		ENDIF
		=RLOCK()
		GATHER MEMVAR
		UNLOCK


		SELE &PrmAlsIT
		SKIP
	ENDDO
	*---------------------------------------------------*
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GIA           DIGerXMLDocFiscal VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   41  º
*       º Variable:            DIGerXMLDocFiscal                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      70                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gia     &&  DIGerXMLDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIGerXMLDocFiscal
PARAMETER PrmEmpresa,;
		  PrmMod_Doc,;
		  PrmCOD_IDFORN,;
		  PrmNro_Doc,;
		  PrmSerie_Doc





	PRIVATE LSalias
	
	PRIVATE PrmAlsDI
	=DIVerifyInst()
	

	LSalias = ALIAS()
	PrmAlsDI = DIGetAlias()




	*-------------------------------------------------------*

   	PRIVATE LSfileXML,LNroIDfileXML
   	
   	LSfileXML	= DINmFileXMLDocFiscal(PrmEmpresa,PrmMod_doc,PrmNro_Doc)
   	LSfileXML	= "\SCGC\EFD\"+LSfileXML



  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return(.F.)
   	endif

	*---------------------------------------------------*

	SELE &PrmAlsDI
	SET ORDER TO TAG ITEM
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmMOD_DOC+;
	     PrmCOD_IDFORN+STR(PrmNro_Doc,7)+PrmSERIE_DOC
	SET NEAR OFF

	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() ;
	        AND PrmEmpresa    = &PrmAlsDI .empresa;
	        AND PrmMod_Doc    = &PrmAlsDI .MOD_DOC ;
	        AND PrmCOD_IDFORN = &PrmAlsDI .COD_IDFORN ;
	        AND PrmNro_Doc       = &PrmAlsDI .NRO_DOC ;
	        AND PrmSERIE_DOC  = &PrmAlsDI .SERIE_DOC ;
         TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

	=DIInicioXML(LSfileXML,LNroIDfileXML)

	SET POINT TO ','

	SELE &PrmAlsDI

	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa    = &PrmAlsDI .empresa;
	        AND PrmMod_Doc    = &PrmAlsDI .MOD_DOC ;
	        AND PrmCOD_IDFORN = &PrmAlsDI .COD_IDFORN ;
	        AND PrmNro_Doc    = &PrmAlsDI .NRO_DOC ;
	        AND PrmSERIE_DOC  = &PrmAlsDI .SERIE_DOC

		=UPtermo()



		=DIGravaXMLItensDocFiscal(;
				&PrmAlsDI .Empresa,;
				&PrmAlsDI .Mod_doc,;
				&PrmAlsDI .Cod_IDForn,;
				&PrmAlsDI .Nro_Doc,;
				&PrmAlsDI .Serie_Doc,;
				&PrmAlsDI .Nro_Item,;
				LSfileXML,;
				LNroIDfileXML)

		SELE &PrmAlsDI
		SET ORDER TO TAG ITEM
		SKIP
	ENDDO
	=DIFinalXML(LSfileXML,LNroIDfileXML)

	SET POINT TO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GIH           DIFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   42  º
*       º Variable:            DIFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      71                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gih     &&  DIFind VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION DISQLS

	USE X:\SCGC\CENTRAL\DOCFISIT
	SELECT CFOP, ;
	       SUM(VLR_FINAL) AS TOTAL ;
	FROM DOCFISIT ;
	GROUP BY CFOP


RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GIK           DIApuraICMS VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   44  º
*       º Variable:            DIApuraICMS                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      72                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123gik     &&  DIApuraICMS VALID
#REGION 2
  SET STEP ON	
  SET DATE GERMAN
  SET CENTU ON	
  DO DIApuraIcms WITH 4, {01.01.2009},{31.01.2009}

return

PROCEDURE DIApuraICMS
PARAMETERS ;
		PrmEmpresa,;
		PrmDtInicio,;
		PrmDtFinal

	PRIVATE LSAlias

	=DIVerifyInst()


	LSAlias = 	DIGetAlias()
	
	*--------------------------------------*
	* SELECAO GERAL DO ITENS CONFORME CRITERIO
	* DE EMPRESA E DATAS
	* ---> NAO CONTABILIZA COPIA DE CUPOM
	*--------------------------------------*

	SELECT ;
		   CFOP, ;
	       VLR_FINAL, ;
		   bc_icms,;
		   vlr_icms,;
		   base_isent,;
		   base_outr,;
		   bc_iss,;
		   vlr_ipi,;	
		   icm_rtd_s;
	FROM &LSAlias ;
	WHERE ;
		     &LSAlias .empresa = PrmEmpresa ;
		 AND &LSAlias .dt_EntSai  >= PrmDtInicio ;
		 AND &LSAlias .dt_EntSai  <= PrmDtFinal ;
		 AND !(ALLTRIM( &LSAlias .CFOP )	$ "5929/6929") ;
    into cursor SEL_itens

	*--------------------------------------*

	SELECT ;
		   "RG001"         AS TP_REG,;	
		   CFOP            AS CFOP_AP, ;
	       SUM(VLR_FINAL)  AS VLR_CONTB, ;
		   SUM(bc_icms)    AS BASE_ICMS,;
		   SUM(vlr_icms)   AS VLR_ICMS,;
		   SUM(base_isent) AS VLR_ISENT,;
		   SUM(base_outr+bc_iss+VLR_IPI)  AS OUTRAS,;
		   SUM(icm_rtd_s)  AS ICMS_RTD;
	FROM SEL_itens ;
	GROUP BY CFOP_AP ;
	UNION ;
	SELECT ;
		   "RG002"  AS TP_REG,;	
		   (LEFT(CFOP,1)+"--->") AS CFOP_AP, ;
	       SUM(VLR_FINAL) AS VLR_CONTB,  ;
		   SUM(bc_icms)    AS BASE_ICMS,;
		   SUM(vlr_icms)   AS VLR_ICMS,;
		   SUM(base_isent) AS VLR_ISENT,;
		   SUM(base_outr+bc_iss+VLR_IPI)  AS OUTRAS,;
		   SUM(icm_rtd_s)  AS ICMS_RTD;
	FROM SEL_itens ;
	GROUP BY CFOP_AP;
	UNION ;
	SELECT ;
		   "RG003"         AS TP_REG,;	
		  "TEnt="          AS CFOP_AP, ;
	       SUM(VLR_FINAL)  AS VLR_CONTB,  ;
		   SUM(bc_icms)    AS BASE_ICMS,;
		   SUM(vlr_icms)   AS VLR_ICMS,;
		   SUM(base_isent) AS VLR_ISENT,;
		   SUM(base_outr+bc_iss+VLR_IPI)  AS OUTRAS,;
		   SUM(icm_rtd_s)  AS ICMS_RTD;
	FROM SEL_itens ;
	WHERE CFOP < "5000" ;
	GROUP BY CFOP_AP;
	UNION ;
	SELECT ;
		   "RG003"         AS TP_REG,;	
		  "TSai="          AS CFOP_AP, ;
	       SUM(VLR_FINAL)  AS VLR_CONTB,  ;
		   SUM(bc_icms)    AS BASE_ICMS,;
		   SUM(vlr_icms)   AS VLR_ICMS,;
		   SUM(base_isent) AS VLR_ISENT,;
		   SUM(base_outr+bc_iss+VLR_IPI)  AS OUTRAS,;
		   SUM(icm_rtd_s)  AS ICMS_RTD;
	FROM SEL_itens;
	WHERE CFOP >= "5000" ;
	GROUP BY CFOP_AP;
	order by TP_REG,CFOP_AP;
	into cursor APUracao

	SELECT ;
		  CFOP_AP AS CFOP, ;
	      VLR_CONTB,  ;
		  BASE_ICMS,;
		  VLR_ICMS,;
		  VLR_ISENT,;
		  OUTRAS,;
		  ICMS_RTD;
	FROM APUracao ;
	into cursor APUFinal
	


	=W_DEFPROC("rotinas.spr")
	DO loc_dlog WITH  .t.,.F.,.F.,.F.,.F.,.t.

	SELE APURACAO
	USE
	SELE SEL_itens
	use
	
	SELE APUFinal
	use

	

RETURN	

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GIO           DIConvrtNEDocFiscal VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   45  º
*       º Variable:            DIConvrtNEDocFiscal                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      73                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gio     &&  DIConvrtNEDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIConvrtNEDocFiscal
PARAMETERS PrmEmpresa,PrmNota,PrmFornCod,PrmVT_Acm

	PRIVATE PrmAlsNE,PrmAlsIT

	*--------------------------------------------------*
	PRIVATE LNCod_Mod_Rf,LaliqOrg
	
	PRIVATE LOperacao

	PRIVATE LUFDstn

	PRIVATE LMunDstn


	PRIVATE LNTotalNE
	
	
	PRIVATE LAcmTotItem,;
	        LAcmVicmsItem

	PRIVATE LUFOrig
	PRIVATE LMunOrig
	PRIVATE LTab_Cst

	*--------------------------------------------------*

	PRIVATE ;
    	 PrmSerie,;
		 PrmTipo,;
    	 RtnNro_Doc,;
		 RtnMod_Doc,;
		 RtnCOD_IDFORN,;
		 RtnSerie_Doc

	*--------------------------------------------------*


	=W_DEFPROC("NOTAENT.SPR")
	PrmAlsNE = NEGetAlias()


	=W_DEFPROC("NOTAITE.SPR")
	PrmAlsIT = IEGetAlias()



	=W_DEFPROC("NOTAENT.SPR")
	IF !NELerRegistro(PrmEmpresa,PrmNota,PrmFornCod)
		WAIT WINDOW "NFs nao localizada  <ENTER> " NOWAIT
		RETURN(.F.)
	ENDIF



	
	=W_DEFPROC("notaent.spr")
	LNTotalNE = ;
		 NEGetFieldValue(PrmEmpresa,PrmNota,PrmFornCod,"TOTAL_NOTA")

	LAcmTotItem = 0



	=W_DEFPROC("TIPOOPER.SPR")
	LNCod_Mod_Rf  	= TPGetFieldValue("E",  &PrmAlsNE .tipo ,"Cod_Mod_Rf")



	LOperacao = "ENTRADA"

	=W_DEFPROC("EMPRESA.SPR")
	LTab_Cst  = EMGet_TabCst(  &PrmAlsNE .EMPRESA )

	=W_DEFPROC("EMPRESA.SPR")
	LUFDstn   = EMGet_UF(  &PrmAlsNE .EMPRESA )

	=W_DEFPROC("EMPRESA.SPR")
	LMunDstn  = EMGet_Municipio(  &PrmAlsNE .EMPRESA )

	LUFOrig  = &PrmAlsNE .UF
	LMunOrig = &PrmAlsNE .CIDADE


	=W_DEFPROC("TRIBUTAR.SPR")
	LaliqOrg = TRAlqIcmOuUF(LUFOrig)  && ALIQ. EXTERNA DA UF ORIGEM


	=W_DEFPROC("TRIBUTAR.SPR")
	LaliqDst = TRAlqIcmInUF(LUFDstn)  && ALIQ. Interna DA UF DESTINO

	*---------------------------------------------------*

	SELE &PrmAlsIT
	SET ORDER TO TAG ITEMNOTA
	SET NEAR ON
	SEEK STR( &PrmAlsNE .Empresa,3)+;
		LEFT( &PrmAlsNE .TIPO ,1)+;
		STR(  &PrmAlsNE .CODFORN ,5)+;
		STR(  &PrmAlsNE .NOTA ,6)
	SET NEAR OFF


	PrmVT_Acm[1] = 0
	PrmVT_Acm[2] = 0
	PrmVT_Acm[3] = 0

	*--------------------------------------------------*

	STORE 0 TO  ;
    	 PrmSerie,;
		 PrmTipo,;
    	 RtnNro_Doc,;
		 RtnMod_Doc,;
		 RtnCOD_IDFORN,;
		 RtnSerie_Doc



	PrmSerie = &PrmAlsNE .serie
	PrmTipo  = &PrmAlsNE .tipo

	=W_DEFPROC("NOTAENT.SPR")
	=NEDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmFornCod,;
						PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						RtnSerie_Doc)





    M.COD_IDFORN   	=  RtnCOD_IDFORN

    M.EMPRESA   	=  PrmEmpresa
    M.TIPO   		=  PrmTipo
    M.NRO_DOC   	=  RtnNro_Doc
    M.SERIE_DOC 	=  RtnSerie_Doc
    m.MOD_DOC   =   RtnMod_Doc


	*---------------------------------------------------*

	*---------------------------------------------------*

	=DIDelItensDocFiscal(;
			PrmEmpresa,;
		 	RtnMod_Doc,;
		  	RtnCOD_IDFORN,;
  	  	    RtnNro_Doc ,;
		  	RtnSerie_Doc)

	*---------------------------------------------------*



	DO WHILE !EOF() ;
	        AND PrmEmpresa     = &PrmAlsIT .empresa;
	        AND &PrmAlsNE .favorecido = &PrmAlsIT .Favorecido;
	        AND PrmNota    	   = &PrmAlsIT .nota

	    IF  &PrmAlsNE .TIPO <> &PrmAlsIT .tipo
			SKIP
			LOOP
		
		ENDIF


		IF  LEFT( &PrmAlsIT .SITUACAO,1) <> "C"
			SKIP
			LOOP
		
		ENDIF


		IF  &PrmAlsIT .qtde = 0
			SKIP
			LOOP
		
		ENDIF



		set decimals to 2
		

	
		=W_DEFPROC("NOTAENT.SPR")
		LNVlrICMS =  NEClcICMS( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , &PrmAlsIT .vlrvenda)


	
		=W_DEFPROC("NOTAENT.SPR")
		LNBCIcmsOper =  NEBCIcmsOper( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , &PrmAlsIT .vlrvenda)




		=W_DEFPROC("NOTAENT.SPR")
		LNVlrICMSSO =  NEIcmsOper( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , &PrmAlsIT .vlrvenda)



		
		=W_DEFPROC("NOTAENT.SPR")
		LNBsBrRetido =  NEBsBrRetido( ;
		        PrmEmpresa,;
		        PrmNota,;
		        PrmFornCod, ;
		        &PrmAlsIT .codigo , ;
		        &PrmAlsIT .vlrvenda ,;
   		        &PrmAlsIT .vlripi )



		=W_DEFPROC("NOTAENT.SPR")
		LNBsRetido =  NEBsRetido( ;
		        PrmEmpresa,;
		        PrmNota,;
		        PrmFornCod, ;
		        &PrmAlsIT .codigo , ;
   		        LNBsBrRetido )





		=W_DEFPROC("NOTAENT.SPR")
		LNRetido =  NEClcRetido(;
		        PrmEmpresa, ;
		        PrmNota,;
		        PrmFornCod,;
		        &PrmAlsIT .codigo , ;
		        LNVlrICMS , ;
   		        LNBsRetido,;
   		        LNVlrICMSSO)


		*----------------------------------------------------*


		


	    M.DT_DOC   	=  &PrmAlsNE .data_EMI
    	M.DT_ENTSAI =  &PrmAlsNE .Data

		*----------------------------------------------------*
		*  DADOS GERAIS DO ITEM NO REGISTRO
		*----------------------------------------------------*





	    M.NRO_ITEM 	= &PrmAlsIT .Ordem
    	M.PRODCODIGO= &PrmAlsIT .Codigo

		=W_DEFPROC("GRUPO.SPR")
		M.PRODDESCR = GRGetFieldValue( &PrmAlsIT .CODIGO,"DESCRICAO")

		M.PRODDESCR   = DFLimpaString( M.PRODDESCR)

	    M.PRODCOMPLE  = DFLimpaString( &PrmAlsIT .DESCRCOMPL )

	    M.INFO_COMPL  = DFLimpaString( &PrmAlsIT .INFO_COMPL )




		=W_DEFPROC("GRUPO.SPR")
		M.UNIDADE = GRGetFieldValue( &PrmAlsIT .CODIGO,"UNIDADE")
		m.UNIDTRIBUT = M.UNIDADE



		IF EMPTY(M.UNIDADE)
			M.UNIDADE = "UN"
			m.UNIDTRIBUT = "UN"
		ENDIF

    	M.PRECO_TAB    =    &PrmAlsIT .Preco
    	M.PRECOMAXTB   =    0
	    M.PRECOMINTB   =    0


		IF &PrmAlsIT .Qtde > 0
		    m.PRECOVENDA    =    &PrmAlsIT .VLRVENDA /  &PrmAlsIT .Qtde
		    m.VLR_UNIDAD    =    &PrmAlsIT .VLRVENDA /  &PrmAlsIT .Qtde
			m.VLRUNTRIBU    =    &PrmAlsIT .VLRVENDA /  &PrmAlsIT .Qtde
		ELSE
			m.PRECOVENDA    =    0
		    m.VLR_UNIDAD    =    0
			m.VLRUNTRIBU    =    0

		ENDIF


	    M.PRECO_UNIT   =    &PrmAlsIT .Preco
	    M.QTDE   	   =    &PrmAlsIT .Qtde

		M.QTDTRIBUT	    =    &PrmAlsIT .Qtde

	    M.VLR_DESCTO   =    0
	    M.PRC_DESCTO   =    0
    	M.VLRDESPFIN   =    0
	    M.VLRDESPOUT   =    0
    	M.VLR_FRETE    =    0
	    M.VLR_SEGURO   =    0
	
    	M.VLR_FINAL    =    &PrmAlsIT .VlrVenda +;
					    	&PrmAlsIT .vlripi+;
					    	LNRetido
    	
    	*M.VLR_FINAL    =    (INT(M.VLR_FINAL*100)/100)


		LAcmTotItem    =    LAcmTotItem + M.VLR_FINAL






    	
    	
		IF &PrmAlsIT .MovEstq = "S"
		    M.IND_MOVEST   =     "SIM"
		ELSE
		    M.IND_MOVEST   =     "NAO"
		ENDIF
    	M.LT_QTITENS   =    0
	    M.LT_NRO   	   =    ""
    	M.LT_DT_FABR   =    {}
	    M.LT_VALIDAD   =    {}
	    M.CLSCOMNC     =    "00"
    	M.CLSGAS       =    "00"
	    M.CLSAGUA      =    "00"
    	M.CLSENRG      =    "00"


		*----------------------------------------------------*
		*  DADOS TRIBUTARIOS DO REGISTRO
		*----------------------------------------------------*
		
	    M.VLRATRIBUT   =     &PrmAlsIT .VlrVenda
    	M.CUSTONAOPE   =     0
	    M.CUSTOMEDAN   =     0


	*--------
	    M.SALDO_ATU   =    0
	    M.CUSTOMEDAT   =    0

	*----------
	    M.SALDO_ANT    =   0
	    M.CUSTOCONTB   =   0




		LTipo       = &PrmAlsIT .Tipo
		LProduto    = &PrmAlsIT .codigo
		LTp_mercad  = &PrmAlsIT .tp_mercad



*---------

		=W_DEFPROC("TRIBUTAR.SPR")
		M.CFOP = TRCFO(&PrmAlsIT .Empresa, ;
		              &PrmAlsIT .Tipo,;
		              &PrmAlsIT .tp_mercad,;
		              "ENTRADA")

*--------


	    m.CFOP = ALLTRIM(CHRTRAN(m.CFOP,".",""))


		m.origemmrcd = chrtran(str( &PrmAlsIT .origem ,1)," ","0")



		LSCst = DICST_IPI(  &PrmAlsIT .VlrIPI, LOperacao)
    	M.CST_IPI   =   LSCst

	    IF &PrmAlsIT .tp_mercad = 7   && SERVICO
			LSCst = DICST_ISS(  &PrmAlsIT .VlrVenda, LOperacao)
		ELSE
			LSCst = DICST_ISS(  0, LOperacao)
		ENDIF
    	M.CST_ISS   =   LSCst

		LSCst = DICST_PIS(  0, LOperacao)
    	M.CST_PIS   =   LSCst

		LSCst = DICST_COFINS(  0, LOperacao)
    	M.CST_COFINS   =   LSCst

		LSCst = DICST_IR(  0, LOperacao)
    	M.CST_IR   =   LSCst



	    M.ALQICMORIG   =   LaliqOrg
	    M.ALQICMDEST   =   LaliqDst



IF 1=1
		=W_DEFPROC("TRIBUTAR.SPR")
		M.CST_ICMS  =  TRCST_Entrada(;
				 &PrmAlsIT .cst,;
				 &PrmAlsIT .origem, ;
				 &PrmAlsIT .tp_mercad,;
				 &PrmAlsIT .base_calc,;
		  		 &PrmAlsIT .vlrvenda,;
		  		 &PrmAlsIT .icms_subs, ;
		  		 &PrmAlsIT .codigo, ;
		  		 &PrmAlsNE .tipo)

		*-------------   ICMS ----------------


   		M.BC_ICMS         =   &PrmAlsIT .base_calc

	    IF &PrmAlsIT .BsBr_Icms >= &PrmAlsIT .base_calc  	
		      M.BCBRUTAICM   =   &PrmAlsIT .BsBr_Icms
	    ELSE
	    	  M.BCBRUTAICM   =   &PrmAlsIT .base_calc
   		ENDIF
   		M.VLR_ICMS   =   &PrmAlsIT .Vlr_Icms


	    M.BCBRTRTD_S   =   LNBsBrRetido
	    M.BC_RTD_S     =   LNBsRetido
	   	M.ALQICMRTDS   =   &PrmAlsIT .Aliq_Icms
	   	M.ICM_RTD_S    =   LNRetido

		M.IND_REDUCA   =   &PrmAlsIT .Aliq_rdu










ELSE

		DO CASE
			CASE;
			 &PrmAlsNE .tipo $ ;
 			 "CLG/CLH/CFG/CFH/CFM/CID/CLC/CLD/CFC/CFD/CIB/CLE/CLF/CFS/CFE/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "CFF/CIC/CLJ/CFL/ASC/CEE/ASI/CFJ/CFK/TAB/TBB/TAC/TBC/TAD/TBD/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "RBV/RBU/RBF/RBH/RBJ/RBM/RBN/RBG/RBI/RBL/RBO/RAC/RBC/RIB/RAA/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "RBR/RAE/RBE/RID/RBP/RBQ/RCA/RDA/DAF/DBF/DAC/DBC/DBD/DAE/DBE/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "DAG/DBG/"
	   		    M.CST_ICMS     =   m.origemmrcd+"90"

		   		M.BC_ICMS         = &PrmAlsIT .base_calc
			    IF &PrmAlsIT .BsBr_Icms >= &PrmAlsIT .base_calc  	
  			      M.BCBRUTAICM    =   &PrmAlsIT .BsBr_Icms
			    ELSE
  		    	  M.BCBRUTAICM    =   &PrmAlsIT .base_calc
		   		ENDIF
      	   		M.VLR_ICMS   	  =   &PrmAlsIT .Vlr_Icms

			    M.BCBRTRTD_S   =   0
			    M.BC_RTD_S     =   0
		    	M.ALQICMRTDS   =   0
		    	M.ICM_RTD_S    =    0




			CASE    LNBsRetido = 0 ;
				AND &PrmAlsIT .vlr_icms = 0 ;
				AND &PrmAlsIT .tp_mercad = 2


	   		    M.CST_ICMS     =   m.origemmrcd+"60"
			    M.BCBRUTAICM   =   0
    			M.IND_REDUCA   =   0
		    	M.BC_ICMS      =   0
    	  		M.VLR_ICMS     =   0

			    M.BCBRTRTD_S   =   LNBsBrRetido
			    M.BC_RTD_S     =   LNBsRetido
		    	M.ALQICMRTDS   =   &PrmAlsIT .Aliq_Icms
		    	M.ICM_RTD_S    =   LNRetido


			
			CASE    LNBsRetido > 0 AND LNVlrICMSSO > 0

				*--------------------------------
				*--> atende nota entrada 257849 bgs
				*--------------------------------

				M.BC_ICMS    =   0
      	 		M.VLR_ICMS   =   0
	   		    M.CST_ICMS   =   m.origemmrcd+"10"
			    M.BCBRUTAICM =   0

				*------------------------------------*

			    M.BCBRTRTD_S   =   LNBsBrRetido
			    M.BC_RTD_S     =   LNBsRetido
		    	M.ALQICMRTDS   =   &PrmAlsIT .Aliq_Icms
		    	M.ICM_RTD_S    =   LNRetido

			CASE    LNBsRetido > 0  ;
				     AND  &PrmAlsIT .vlr_icms > 0

				*--------------------------------
				*--> atende nota entrada 2135/.36/.37/.38 bgs
				*--------------------------------



				M.BC_ICMS    =   0
      	 		M.VLR_ICMS   =   0
	   		    M.CST_ICMS   =   m.origemmrcd+"10"
			    M.BCBRUTAICM =   0



			    M.BCBRTRTD_S   =   LNBsBrRetido
			    M.BC_RTD_S     =   LNBsRetido
		    	M.ALQICMRTDS   =   &PrmAlsIT .Aliq_Icms
		    	M.ICM_RTD_S    =   LNRetido


    	  	OTHERWISE
	  		    M.CST_ICMS        = m.origemmrcd+ &PrmAlsIT .cst + "0"
		   		M.BC_ICMS         =   &PrmAlsIT .base_calc

			    IF &PrmAlsIT .BsBr_Icms >= &PrmAlsIT .base_calc  	
  			      M.BCBRUTAICM   =   &PrmAlsIT .BsBr_Icms
			    ELSE
  		    	  M.BCBRUTAICM   =   &PrmAlsIT .base_calc
		   		ENDIF
      	   		M.VLR_ICMS   =   &PrmAlsIT .Vlr_Icms

			    M.BCBRTRTD_S   =   0
			    M.BC_RTD_S     =   0
		    	M.ALQICMRTDS   =   0
		    	M.ICM_RTD_S   =    0

      	ENDCASE

ENDIF
		=W_DEFPROC("TRIBUTAR.spr")
		M.IVA= TRGet_IVA( LUFOrig, ;
		                  &PrmAlsIT .codigo ,;
		                  LUFDstn,;
		                  M.DT_DOC )



		****** M.IVA          =   &PrmAlsIT .Iva
		

		IF 	M.VLR_ICMS  =  0
	    	M.BC_ICMS      =   0
   	  		M.VLR_ICMS     =   0
		ENDIF




		IF LUFDstn = LUFOrig
		    M.ALIQ_ICMS  =   LaliqDst
		ELSE
		    M.ALIQ_ICMS  =   LaliqOrg  && ---> &PrmAlsIT .Aliq_Icms
		ENDIF



		IF SUBS(M.CST_ICMS,2,2) $ "30/40/41/50/60"

			M.BCBRICMSSO   = M.BC_ICMS
			M.BCICMSSO     = M.BC_ICMS
			M.ALIQICMSSO   = M.ALIQ_ICMS
			M.VLR_ICMSSO   = M.VLR_ICMS
			
			
	    	M.BC_ICMS      =   0
		    M.ALIQ_ICMS    =   0
   	  		M.VLR_ICMS     =   0

		ENDIF

		IF SUBS(M.CST_ICMS,2,2) $ "90"
		    M.BCBRTRTD_S   =   0
		    M.BC_RTD_S     =   0
	    	M.ALQICMRTDS   =   0
	    	M.ICM_RTD_S    =    0
		ENDIF






		Laliq  = ABS(LaliqOrg - LaliqDst)
    	M.DIF_ALIQ   =   Laliq



		=W_DEFPROC("TRIBUTAR.SPR")
		LRgmTrb = TRDef_RgTrbMercad(LUFOrig,;
		                           &PrmAlsIT .Codigo,;
						 'RETORNAR STRING' )

	    M.RGTRIBORIG   =   LRgmTrb

		=W_DEFPROC("TRIBUTAR.SPR")
		LRgmTrb = TRDef_RgTrbMercad(LUFDstn,;
					  &PrmAlsIT .Codigo,;
						 'RETORNAR STRING' )

	    m.RGTRIBDEST   =   LRgmTrb

	  	IF &PrmAlsNE .BASE_ISENT = 0
		    M.BASE_ISENT   =   0
		ELSE
		    M.BASE_ISENT   =   ;
		    				M.VLR_FINAL ;
						    - ( &PrmAlsIT .vlripi;
					    	+   LNRetido)
		ENDIF
		
		
		




	    M.BCBRTRTD_E   =   0
    	M.BC_RTD_E   =   0
	    M.ICM_RTD_E   =   0

	    M.INDAPURIPI   =   "1"


	    M.BC_IPI    =   &PrmAlsIT .vlrvenda
    	M.ALIQ_IPI  =   &PrmAlsIT .aliq_ipi
	    M.VLR_IPI   =   &PrmAlsIT .vlripi


	    M.BC_ISS   =   &PrmAlsIT .base_iss
	    M.ALIQ_ISS   =   &PrmAlsIT .aliq_iss
    	M.VLR_ISS   =   &PrmAlsIT .vlr_iss



	    M.BASE_OUTR   =   M.VLR_FINAL;
	                     - M.BASE_ISENT ;
	                     - ( &PrmAlsIT .vlripi;
					    	+ LNRetido)


		*--------  AJUSTES FINAIS


    	M.VLRSERVICO = 0
   	    M.VLRPRODUTO = 0
   	
    	IF &PrmAlsIT .tp_mercad = 7   && SERVICO
    	   M.VLRSERVICO = &PrmAlsIT .VLRVENDA
    	ELSE
    	   M.VLRPRODUTO = &PrmAlsIT .VLRVENDA
    	ENDIF

		M.TTPRODSRVC = M.VLRSERVICO + M.VLRPRODUTO


		M.MODBCICMRT = "0"
		M.MOD_BCICMS = "3"




		=W_DEFPROC("GRUPO.SPR")
		M.GTIMCODIGO = GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_GTIM")


		=W_DEFPROC("GRUPO.SPR")
		M.NCMCODIGO = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_NCM"))
		M.NCMCODIGO = CHRTRAN(M.NCMCODIGO,".","")


		=W_DEFPROC("GRUPO.SPR")
		M.EXTIPI = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"EX_TIPI"))


		=W_DEFPROC("GRUPO.SPR")
		M.GENEROPROD = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_GENERO"))



    	IF &PrmAlsIT .tp_mercad = 7   && SERVICO
    	   M.ITEMSERVIC = "S"
    	ELSE
    	   M.ITEMSERVIC = "N"
    	ENDIF


		=W_DEFPROC("GRUPO.SPR")
		M.CDGLSTSRVC = ;
		   ALLTRIM(GRGetFieldValue( &PrmAlsIT .CODIGO,"COD_LSTSRV"))

		*-----------------------------------------*
		* AS ENTRADA ESTAO GERANDO SALDO CREDOR INDEVIDO
		* SENDO ASSIM PASSAMOS O CST = 060 PARA 030
		* E ZERAMOS CAMPOS DE SUBSTITUICAO
		*-----------------------------------------*

		IF LNRetido > 0
   		    M.CST_ICMS     =   m.origemmrcd+"30"

	    	M.BC_ICMS      =   0
		    M.ALIQ_ICMS    =   0
   	  		M.VLR_ICMS     =   0



	   		** M.ALQICMRTDS   =   0


		    M.BCBRTRTD_E   =   M.BCBRTRTD_S
	    	M.BC_RTD_E     =   M.BC_RTD_S
	    	M.ICM_RTD_E    =   M.ICM_RTD_S


		    M.BCBRTRTD_S   =   0
		    M.BC_RTD_S     =   0
		   	M.ICM_RTD_S    =   0
		ENDIF





    	M.BC_ISS_RTD   =   0
	    M.ALIQ_ISSRT   =   0
	    M.VLR_ISSRTD   =   0

	    M.BC_PIS   	 =   0
    	M.ALIQ_PIS   =   0
	    M.QTDBASEPIS =   0
    	M.VLR_PIS    =   0
	    M.PIS_RTD    =   0
    	M.BC_COFINS  =   0
	    M.ALIQCOFINS =   0
    	M.QTDBASECOF =   0
	    M.VLR_COFINS =   0
    	M.COFINS_RTD =   0
    	M.VLRALQCFRT =   0
	    M.BC_IR   	 =   0
	    M.ALIQ_IR    =   0
	    M.VLR_IR     =   0
    	M.IR_RTD     =   0
	    M.BC_CSLL    =   0
    	M.ALIQ_CSLL  =   0
	    M.VLR_CSLL   =   0
    	M.ADNTA_CSLL =   0
	    M.LANC_AUTO  =   "SIM"


*------------------------------------------------
		PrmVT_Acm[1] = PrmVT_Acm[1] + M.VLR_ICMS
		PrmVT_Acm[2] = PrmVT_Acm[2] + M.BC_ICMS
		PrmVT_Acm[3] = PrmVT_Acm[3] + M.VLR_IPI


*------------------------------------------------



***		=DISalvarRegistro()


		LEmpresa    = m.Empresa
		LMod_Doc    = RtnMod_Doc
		LCod_IdForn = RtnCOD_IDFORN
		LNro_Doc    = RtnNro_Doc
		LSerie_Doc  = RtnSerie_Doc
		LNro_Item   = m.Nro_Item


		SELE &PBDocFisItAlias
		SET ORDER TO TAG ITEM
		SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	      STR(LNro_Doc,7)+LSerie_Doc+STR(LNro_Item,5)
	
		IF !found()
			APPEND BLANK
		ENDIF
		=RLOCK()
		GATHER MEMVAR
		UNLOCK

		SELE &PrmAlsIT
		SKIP
	ENDDO


*	IF PRMNOTA = 1892
*      SET STEP ON
*	ENDIF

	LNdifTotal = LNTotalNE - LAcmTotItem

	PrmVT_Acm[4] = LAcmTotItem






*	IF ABS(LNdifTotal) > 0
*		=DIAjustaVlr()
*	ENDIF


	*---------------------------------------------------*
RETURN(.t.)

FUNCTION DIAjustaVlr

	PRIVATE  LNICM_RTD_S
	PRIVATE  LNVLR_FINAL

	SET NEAR ON

	SELE &PBDocFisItAlias
	SET ORDER TO TAG ITEM
	SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	      STR(LNro_Doc,7)+LSerie_Doc+STR(0,5)
	
	SET NEAR OFF
	
	DO WHILE !EOF() ;
	   AND  &PBDocFisItAlias .EMPRESA = Lempresa ;
	   AND  &PBDocFisItAlias .MOD_DOC = Lmod_Doc ;
	   AND  &PBDocFisItAlias .COD_IDFORN = LCod_IdForn ;
	   AND  &PBDocFisItAlias .NRO_DOC    = LNro_Doc ;
	   AND  &PBDocFisItAlias .SERIE_DOC  = LSerie_Doc
	
	   LNICM_RTD_S = &PBDocFisItAlias .ICM_RTD_S
	   LNVLR_FINAL = &PBDocFisItAlias .VLR_FINAL


	   IF LNICM_RTD_S > 0
	   	  REPLACE  &PBDocFisItAlias .ICM_RTD_S ;
	   	    WITH   LNICM_RTD_S + LNdifTotal

	   	  REPLACE  &PBDocFisItAlias .VLR_FINAL ;
	   	    WITH   LNVLR_FINAL + LNdifTotal

		  EXIT
	   ENDIF
	   SKIP	
	
	ENDDO	

	

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GJW           DINmFileXMLDocFiscal VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   46  º
*       º Variable:            DINmFileXMLDocFiscal               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      74                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gjw     &&  DINmFileXMLDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DINmFileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc


	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*


	LSnomeArqXml = "DFISIT"+;
				   PrmMod_Doc
	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")


   	LSfileXML	= LSnomeArqXml+".XML"
	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GJZ           DIDelItensDocFiscal VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   47  º
*       º Variable:            DIDelItensDocFiscal                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      75                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gjz     &&  DIDelItensDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIDelItensDocFiscal
PARAMETER PrmEmpresa,;
		  PrmMod_Doc,;
		  PrmCOD_IDFORN,;
		  PrmNro_Doc,;
		  PrmSerie_Doc




	
	PRIVATE LSalias
	
	PRIVATE PrmAlsDI
	=DIVerifyInst()
	

	LSalias = ALIAS()
	PrmAlsDI = DIGetAlias()



	*-------------------------------------------------------*

	SELE &PrmAlsDI
	SET ORDER TO TAG ITEM
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmMOD_DOC+;
	     PrmCOD_IDFORN+STR(PrmNro_Doc,7)+PrmSERIE_DOC
	SET NEAR OFF

	*----------------------------------------------------*

	SELE &PrmAlsDI

	DO WHILE !EOF() ;
	        AND PrmEmpresa    = &PrmAlsDI .empresa;
	        AND PrmMod_Doc    = &PrmAlsDI .MOD_DOC ;
	        AND PrmCOD_IDFORN = &PrmAlsDI .COD_IDFORN ;
	        AND PrmNro_doc    = &PrmAlsDI .NRO_DOC ;
	        AND PrmSERIE_DOC  = &PrmAlsDI .SERIE_DOC

		=RLOCK()
		DELETE
		SKIP
	ENDDO
	*-----------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GK5           DIV01GravaXMLItensDocFiscal VALID  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   49  º
*       º Variable:            DIV01GravaXMLItensDocFiscal        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      76                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gk5     &&  DIV01GravaXMLItensDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIV01GravaXMLItensDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item,;
			PrmFileXML,;
			PrmNroIDfileXML

	*---------------------------------------------------*

	IF !DILerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item)
	      wait "Nao foi localizado Item DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+MOD_DOC+;
		      "FORN. : "+PrmCOD_IDFORN+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC+;
		      "ITEM  : "+STR(PrmNro_Item,4)
    	  return(.F.)
	ENDIF


	IF DIGetPropVT("QTDE") = 0
    	  return(.t.)
	ENDIF		




	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFLerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado Capa DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+MOD_DOC+;
		      "FORN. : "+PrmCOD_IDFORN+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC
    	  return(.F.)
	ENDIF
	

	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	SET POINT TO ","
	SET SEPARATOR  TO "."


	*-------------------------------------------------------*


		=W_DEFPROC("EMPRESA.SPR")
		=EMLerRegistro(PrmEmp)

		=W_DEFPROC("EMPRESA.SPR")
		LFieldTmp    =  EMGetPropVT("CGC")
	    UNEM_CNPJ    =  STR(LFieldTmp,14)
		UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")


		LSLinhaXML = '<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	


		*==========================================================*
		*  CAMPOS IDENTIFICADORES
		*==========================================================*
	

		=W_DEFPROC("EMPRESA.SPR")
		LFieldTmp    =  EMGetPropVT("EMITE_NFE")

		IF LFieldTmp $ "H"   && H=HOMOLOGACAO

			=W_DEFPROC("DOCFISCA.SPR")
			LSLinhaXML = 'DFIS_MOD_DOCUMENTO="'+;
	    	         "55" +;
	        	     '"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		ELSE
			=W_DEFPROC("DOCFISCA.SPR")
			LSLinhaXML = 'DFIS_MOD_DOCUMENTO="'+;
	    	         DFGetPropVT("MOD_DOC") +;
	        	     '"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF



		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CLFS_SIGLA="'+;
	             DFGetPropVT("TIPO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_IND_OPERACAO="'+;
	             DFGetPropVT("IND_OPER") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_TP_MOVIMENTO="'+;
	             DFGetPropVT("TP_MOV") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		*----------------------------------------------------------*
		=W_DEFPROC("DOCFISCA.SPR")
		LNNro_Doc  = DFGetPropVT("NRO_DOC")
		IF LNNro_Doc > 3000000
			LNNro_Doc = LNNro_Doc - 3000000
		ENDIF

		LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		*----------------------------------------------------------*



		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CPF="'+;
	             DFGetPropVT("CPF") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_IE="'+;
	             DFGetPropVT("IE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		*----------------------------------------------------*
		* SERIE UNICA => "0"
		*----------------------------------------------------*
	

		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = DFGetPropVT("SERIE_DOC")
		IF "U" $ LSLinhaXML
			LSLinhaXML = "0"
		ENDIF
		LSLinhaXML = 'DFIS_SERIE="'+;
	             LSLinhaXML +;
	             '"'
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		*----------------------------------------------------*

		LSLinhaXML = 'ITDF_NRO_ITEM="'+;
	             STR(DIGetPropVT("NRO_ITEM"),5) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		*-------------------------------------------------------*

		LSLinhaXML = 'ITDF_PROD_CODIGO="'+;
	             DIGetPropVT("PRODCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_DESCRICAO="'+;
	             DIGetPropVT("PRODDESCR") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_DESCR_COMPL="'+;
	             DIGetPropVT("PRODCOMPLE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_PROD_INFO_ADICIONAIS="'+;
	             DIGetPropVT("INFO_COMPL") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_UNIDADE="'+;
	             DIGetPropVT("UNIDADE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_PRECO_TABELA="'+;
	             STR(DIGetPropVT("PRECO_TAB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_PRECO_MAX_TABELADO="'+;
	             STR(DIGetPropVT("PRECOMAXTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_PRECO_MIN_TABELADO="'+;
	             STR(DIGetPropVT("PRECOMINTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	

		LSLinhaXML = 'ITDF_QTDE="'+;
	             STR(DIGetPropVT("QTDE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_DESCONTO="'+;
	             STR(DIGetPropVT("VLR_DESCTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_VLR_DESP_FINANCEIRA="'+;
	             STR(DIGetPropVT("VLRDESPFIN"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_OUTRAS_DESP_ACES="'+;
	             STR(DIGetPropVT("VLRDESPOUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_FRETE="'+;
	             STR(DIGetPropVT("VLR_FRETE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SEGURO="'+;
	             STR(DIGetPropVT("VLR_SEGURO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_FINAL="'+;
	             STR(DIGetPropVT("VLR_FINAL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_MENSAGEM="'+;
	             SPACE(5) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_IND_MOVIMENTO_ESTQ="'+;
	             DIGetPropVT("IND_MOVEST") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_QTDE_ITENS="'+;
	             STR(DIGetPropVT("LT_QTITENS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
		LSLinhaXML = 'ITDF_LOTE_NRO="'+;
	             DIGetPropVT("LT_NRO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_FABRICACAO="'+;
	             DTOC(DIGetPropVT("LT_DT_FABR")) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_VALIDADE="'+;
	             DTOC(DIGetPropVT("LT_VALIDAD")) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_MEDIO_ATUAL="'+;
	             STR(DIGetPropVT("CUSTOMEDAT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
		LSLinhaXML = 'ITDF_SALDO_ANTERIOR="'+;
	             STR(DIGetPropVT("SALDO_ANT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_MEDIO_ANT="'+;
	             STR(DIGetPropVT("CUSTOMEDAN"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_NA_OPERACAO="'+;
	             STR(DIGetPropVT("CUSTONAOPE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_A_TRIBUTAR="'+;
	             STR(DIGetPropVT("VLRATRIBUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_SALDO_ATUAL="'+;
	             STR(DIGetPropVT("SALDO_ATU"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_CONTABIL="'+;
	             STR(DIGetPropVT("CUSTOCONTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CFOP="'+;
	             DIGetPropVT("CFOP") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_CST_ICMS="'+;
	             DIGetPropVT("CST_ICMS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_IPI="'+;
	             DIGetPropVT("CST_IPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_ISS="'+;
	             DIGetPropVT("CST_ISS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_PIS="'+;
	             DIGetPropVT("CST_PIS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_COFINS="'+;
	             DIGetPropVT("CST_COFINS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_IR="'+;
	             DIGetPropVT("CST_IR") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS="'+;
	             STR(DIGetPropVT("BCBRUTAICM"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_REDUCAO="'+;
	             STR(DIGetPropVT("IND_REDUCA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS="'+;
	             STR(DIGetPropVT("BC_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_ORIGEM="'+;
	             STR(DIGetPropVT("ALQICMORIG"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_DESTINO="'+;
	             STR(DIGetPropVT("ALQICMDEST"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_DIF_ALIQUOTA="'+;
	             STR(DIGetPropVT("DIF_ALIQ"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS="'+;
	             STR(DIGetPropVT("ALIQ_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ICMS="'+;
	             STR(DIGetPropVT("VLR_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_REG_FISCAL_TRIB_ORIGEM="'+;
	             DIGetPropVT("RGTRIBORIG") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_REG_FISCAL_TRIB_DESTINO="'+;
	             DIGetPropVT("RGTRIBDEST") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISENTA_ICMS="'+;
	             STR(DIGetPropVT("BASE_ISENT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_OUTR_ICMS="'+;
	             STR(DIGetPropVT("BASE_OUTR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS_RTD="'+;
	             STR(DIGetPropVT("BCBRTRTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IVA="'+;
	             STR(DIGetPropVT("IVA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS_RTD="'+;
	             STR(DIGetPropVT("BC_RTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_ALIQ_ICMS_RTD="'+;
	             STR(DIGetPropVT("ALQICMRTDS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ICMS_RTD="'+;
	             STR(DIGetPropVT("ICM_RTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("BCBRTRTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_BC_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("BC_RTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ICMS_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("ICM_RTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_APURACAO_IPI="'+;
	             DIGetPropVT("INDAPURIPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_IPI="'+;
	             STR(DIGetPropVT("BC_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_IPI="'+;
	             STR(DIGetPropVT("ALIQ_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IPI="'+;
	             STR(DIGetPropVT("VLR_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISS="'+;
	             STR(DIGetPropVT("BC_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ISS="'+;
	             STR(DIGetPropVT("ALIQ_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ISS="'+;
	             STR(DIGetPropVT("VLR_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISS_RTD="'+;
	             STR(DIGetPropVT("BC_ISS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ISS_RTD="'+;
	             STR(DIGetPropVT("ALIQ_ISSRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ISS_RTD="'+;
	             STR(DIGetPropVT("VLR_ISSRTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_PIS="'+;
	             STR(DIGetPropVT("BC_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_PIS="'+;
	             STR(DIGetPropVT("ALIQ_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_PIS="'+;
	             STR(DIGetPropVT("QTDBASEPIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS="'+;
	             STR(DIGetPropVT("VLR_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS_RTD="'+;
	             STR(DIGetPropVT("PIS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_COFINS="'+;
	             STR(DIGetPropVT("BC_COFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_COFINS="'+;
	             STR(DIGetPropVT("ALIQCOFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_COFINS="'+;
	             STR(DIGetPropVT("QTDBASECOF"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_COFINS="'+;
	             STR(DIGetPropVT("VLR_COFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_COFINS_RTD="'+;
	             STR(DIGetPropVT("COFINS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_IR="'+;
	             STR(DIGetPropVT("BC_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_IR="'+;
	             STR(DIGetPropVT("ALIQ_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IR="'+;
	             STR(DIGetPropVT("VLR_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IR_RTD="'+;
	             STR(DIGetPropVT("IR_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_CSLL="'+;
	             STR(DIGetPropVT("BC_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_CSLL="'+;
	             STR(DIGetPropVT("ALIQ_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_CSLL="'+;
	             STR(DIGetPropVT("VLR_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ADIANTAMENTO_CSLL="'+;
	             STR(DIGetPropVT("ADNTA_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LANC_AUTOMATICO="'+;
	             DIGetPropVT("LANC_AUTO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_SERV_TELECOM="'+;
	             DIGetPropVT("CLSCOMNC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_GAS="'+;
	             DIGetPropVT("CLSGAS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_AGUA="'+;
	             DIGetPropVT("CLSAGUA") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_ENERGIA_ELETR="'+;
	             DIGetPropVT("CLSENRG") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_SO="'+;
	             STR(DIGetPropVT("ALIQICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_MOD_BC_ICMS="'+;
	             DIGetPropVT("MOD_BCICMS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PERCENTUAL_ACRESCIMO="'+;
	             STR(DIGetPropVT("PRC_ACRESC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PERCENTUAL_DESCONTO="'+;
	             STR(DIGetPropVT("PRC_DESCON"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PRECO_VENDA_UNITARIO="'+;
	             STR(DIGetPropVT("PRECOVENDA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ABATE_NT="'+;
	             STR(DIGetPropVT("VLRABATENT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ACRESCIMO="'+;
	             STR(DIGetPropVT("VLRACRESC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS_SO="'+;
	             STR(DIGetPropVT("BCBRICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS_SO="'+;
	             STR(DIGetPropVT("BCICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISENTA_IPI="'+;
	             STR(DIGetPropVT("BCISENTIPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_COFINS_IMPORTACAO="'+;
	             STR(DIGetPropVT("VLRCOFIMPO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_DESPESAS="'+;
	             STR(DIGetPropVT("VLR_DESPES"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ICMS_SO="'+;
	             STR(DIGetPropVT("VLR_ICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS_IMPORTACAO="'+;
	             STR(DIGetPropVT("VLRPISIMPO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PRODUTOS="'+;
	             STR(DIGetPropVT("VLRPRODUTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SERVICO_NT="'+;
	             STR(DIGetPropVT("VLRSRVC_NT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SERVICOS="'+;
	             STR(DIGetPropVT("VLRSERVICO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_TRIBUTOS="'+;
	             STR(DIGetPropVT("VLRTRIBUTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ORIGEM_MERCADORIA="'+;
	             DIGetPropVT("ORIGEMMRCD") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_O_ITEM_E_SERVICO="'+;
	             DIGetPropVT("ITEMSERVIC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PRODUTOS_SERVICOS="'+;
	             STR(DIGetPropVT("TTPRODSRVC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_GTIM="'+;
	             DIGetPropVT("GTIMCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_NCM="'+;
	             DIGetPropVT("NCMCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_EX_TIPI="'+;
	             DIGetPropVT("EXTIPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_GENERO="'+;
	             DIGetPropVT("GENEROPROD") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_GTIM_UNIDADE_TRIBUTAVEL="'+;
	             DIGetPropVT("GTIMUNTRIB") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_UNIDADE_TRIBUTAVEL="'+;
	             DIGetPropVT("UNIDTRIBUT") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_UNIDADE_TRIBUTAVEL="'+;
	             STR(DIGetPropVT("VLRUNTRIBU"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_UNIDADE_TRIBUTAVEL="'+;
	             STR(DIGetPropVT("QTDTRIBUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLS_CODIGO_LISTA_SERVICO="'+;
	             DIGetPropVT("CDGLSTSRVC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_MOD_BC_ICMS_RTD="'+;
	             DIGetPropVT("MODBCICMRT") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_COFINS_RTD="'+;
	             STR(DIGetPropVT("QTDBCCOFRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ALIQ_COFINS_RTD="'+;
	             STR(DIGetPropVT("VLRALQCFRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_IND_MED_BC_ICMS_RTD="'+;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))






		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CNPJ="'+;
	             DFGetPropVT("CNPJ") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		*-------------------------------------------------------*
		LSLinhaXML = '/>'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	
		SET POINT TO
		SET SEPARATOR to

RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GLF           DIGravaXMLItensDocFiscal VALID     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   50  º
*       º Variable:            DIGravaXMLItensDocFiscal           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      77                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123glf     &&  DIGravaXMLItensDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIGravaXMLItensDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item,;
			PrmFileXML,;
			PrmNroIDfileXML


	*---------------------------------------------------*
	PRIVATE LSprocesso

	=W_DEFPROC("DOCFISCA.SPR")
	LSprocesso = DFVersaoXML()

	PRIVATE LFRETORNO


	IF "VERSAO-PROCESSO-DFIS" $ LSprocesso
		LFRETORNO = DIV10GravaXMLItensDocFiscal( ;
			PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item,;
			PrmFileXML,;
			PrmNroIDfileXML)
	ELSE
		LFRETORNO = DIV01GravaXMLItensDocFiscal( ;
			PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item,;
			PrmFileXML,;
			PrmNroIDfileXML)

	ENDIF		


RETURN(LFRETORNO)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GLL           DIERV01GravaXMLItensDocFiscal VALIDº
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DOCFISIT,     Record Number:   51  º
*       º Variable:            DIERV01GravaXMLItensDocFiscal      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      78                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gll     &&  DIERV01GravaXMLItensDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION DIERV01GravaXMLItensDocFiscal
PARAMETERS  PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item,;
			PrmFileXML,;
			PrmNroIDfileXML

	*---------------------------------------------------*

	IF !DILerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc,;
			PrmNro_Item)
	      wait "Nao foi localizado Item DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+MOD_DOC+;
		      "FORN. : "+PrmCOD_IDFORN+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC+;
		      "ITEM  : "+STR(PrmNro_Item,4)
    	  return(.F.)
	ENDIF


	IF DIGetPropVT("QTDE") = 0
    	  return(.t.)
	ENDIF		


	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFLerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado Capa DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+MOD_DOC+;
		      "FORN. : "+PrmCOD_IDFORN+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC
    	  return(.F.)
	ENDIF
	

	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	SET POINT TO ","
	SET SEPARATOR  TO "."


	*-------------------------------------------------------*


		=W_DEFPROC("EMPRESA.SPR")
		=EMLerRegistro(PrmEmp)

		=W_DEFPROC("EMPRESA.SPR")
		LFieldTmp    =  EMGetPropVT("CGC")
	    UNEM_CNPJ    =  STR(LFieldTmp,14)
		UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")


		LSLinhaXML = '<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	


		*==========================================================*
		*  CAMPOS IDENTIFICADORES
		*==========================================================*
	

		=W_DEFPROC("EMPRESA.SPR")
		LFieldTmp    =  EMGetPropVT("EMITE_NFE")

		IF LFieldTmp $ "H"   && H=HOMOLOGACAO

			=W_DEFPROC("DOCFISCA.SPR")
			LSLinhaXML = 'DFIS_MOD_DOCUMENTO="'+;
	    	         "55" +;
	        	     '"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		ELSE
			=W_DEFPROC("DOCFISCA.SPR")
			LSLinhaXML = 'DFIS_MOD_DOCUMENTO="'+;
	    	         DFGetPropVT("MOD_DOC") +;
	        	     '"'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF

		*----------------------------------------------------------------*







		*----------------------------------------------------------------*




		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_IND_OPERACAO="'+;
	             DFGetPropVT("IND_OPER") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_TP_MOVIMENTO="'+;
	             DFGetPropVT("TP_MOV") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		*----------------------------------------------------------*
		=W_DEFPROC("DOCFISCA.SPR")
		LNNro_Doc  = DFGetPropVT("NRO_DOC")
		IF LNNro_Doc > 3000000
			LNNro_Doc = LNNro_Doc - 3000000
		ENDIF

		LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		*----------------------------------------------------*
		* SERIE UNICA => "0"
		*----------------------------------------------------*
	

		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = DFGetPropVT("SERIE_DOC")
		IF "U" $ LSLinhaXML
			LSLinhaXML = "0"
		ENDIF
		LSLinhaXML = 'DFIS_SERIE="'+;
	             LSLinhaXML +;
	             '"'
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		*----------------------------------------------------------*









		*----------------------------------------------------------*

		*----------------------------------------------------------*

        LSLinhaXML = DFGetPropVT("CPF")
        IF EMPTY(LSLinhaXML)
	        LSLinhaXML = DFGetPropVT("CNPJ")
		ENDIF
		

		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CPFCNPJ="'+;
	             LSLinhaXML +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_IE="'+;
	             DFGetPropVT("IE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		*----------------------------------------------------*

		LSLinhaXML = 'ITDF_NRO_ITEM="'+;
	             STR(DIGetPropVT("NRO_ITEM"),5) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		*-------------------------------------------------------*

		LSLinhaXML = 'ITDF_PROD_CODIGO="'+;
	             DIGetPropVT("PRODCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_DESCRICAO="'+;
	             DIGetPropVT("PRODDESCR") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_DESCR_COMPL="'+;
	             DIGetPropVT("PRODCOMPLE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))





		LSLinhaXML = 'ITDF_UNIDADE="'+;
	             DIGetPropVT("UNIDADE") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_PRECO_TABELA="'+;
	             STR(DIGetPropVT("PRECO_TAB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_PRECO_MAX_TABELADO="'+;
	             STR(DIGetPropVT("PRECOMAXTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_PRECO_MIN_TABELADO="'+;
	             STR(DIGetPropVT("PRECOMINTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	

		LSLinhaXML = 'ITDF_QTDE="'+;
	             STR(DIGetPropVT("QTDE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_DESCONTO="'+;
	             STR(DIGetPropVT("VLR_DESCTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))







		LSLinhaXML = 'ITDF_VLR_DESP_FINANCEIRA="'+;
	             STR(DIGetPropVT("VLRDESPFIN"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_OUTRAS_DESP_ACES="'+;
	             STR(DIGetPropVT("VLRDESPOUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_FRETE="'+;
	             STR(DIGetPropVT("VLR_FRETE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SEGURO="'+;
	             STR(DIGetPropVT("VLR_SEGURO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_FINAL="'+;
	             STR(DIGetPropVT("VLR_FINAL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_MENSAGEM="'+;
	             SPACE(5) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_IND_MOVIMENTO_ESTQ="'+;
	             DIGetPropVT("IND_MOVEST") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_QTDE_ITENS="'+;
	             STR(DIGetPropVT("LT_QTITENS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
		LSLinhaXML = 'ITDF_LOTE_NRO="'+;
	             DIGetPropVT("LT_NRO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_FABRICACAO="'+;
	             DTOC(DIGetPropVT("LT_DT_FABR")) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LOTE_VALIDADE="'+;
	             DTOC(DIGetPropVT("LT_VALIDAD")) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_MEDIO_ATUAL="'+;
	             STR(DIGetPropVT("CUSTOMEDAT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
		LSLinhaXML = 'ITDF_SALDO_ANTERIOR="'+;
	             STR(DIGetPropVT("SALDO_ANT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_MEDIO_ANT="'+;
	             STR(DIGetPropVT("CUSTOMEDAN"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_NA_OPERACAO="'+;
	             STR(DIGetPropVT("CUSTONAOPE"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_A_TRIBUTAR="'+;
	             STR(DIGetPropVT("VLRATRIBUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_SALDO_ATUAL="'+;
	             STR(DIGetPropVT("SALDO_ATU"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CUSTO_CONTABIL="'+;
	             STR(DIGetPropVT("CUSTOCONTB"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CFOP="'+;
	             DIGetPropVT("CFOP") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



		LSLinhaXML = 'ITDF_CST_ICMS="'+;
	             DIGetPropVT("CST_ICMS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_IPI="'+;
	             DIGetPropVT("CST_IPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_ISS="'+;
	             DIGetPropVT("CST_ISS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_PIS="'+;
	             DIGetPropVT("CST_PIS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_COFINS="'+;
	             DIGetPropVT("CST_COFINS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CST_IR="'+;
	             DIGetPropVT("CST_IR") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS="'+;
	             STR(DIGetPropVT("BCBRUTAICM"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_REDUCAO="'+;
	             STR(DIGetPropVT("IND_REDUCA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS="'+;
	             STR(DIGetPropVT("BC_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_ORIGEM="'+;
	             STR(DIGetPropVT("ALQICMORIG"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_DESTINO="'+;
	             STR(DIGetPropVT("ALQICMDEST"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_DIF_ALIQUOTA="'+;
	             STR(DIGetPropVT("DIF_ALIQ"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS="'+;
	             STR(DIGetPropVT("ALIQ_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ICMS="'+;
	             STR(DIGetPropVT("VLR_ICMS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_REG_FISCAL_TRIB_ORIGEM="'+;
	             DIGetPropVT("RGTRIBORIG") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_REG_FISCAL_TRIB_DESTINO="'+;
	             DIGetPropVT("RGTRIBDEST") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISENTA_ICMS="'+;
	             STR(DIGetPropVT("BASE_ISENT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_OUTR_ICMS="'+;
	             STR(DIGetPropVT("BASE_OUTR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS_RTD="'+;
	             STR(DIGetPropVT("BCBRTRTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IVA="'+;
	             STR(DIGetPropVT("IVA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS_RTD="'+;
	             STR(DIGetPropVT("BC_RTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_ALIQ_ICMS_RTD="'+;
	             STR(DIGetPropVT("ALQICMRTDS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ICMS_RTD="'+;
	             STR(DIGetPropVT("ICM_RTD_S"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("BCBRTRTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_BC_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("BC_RTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ICMS_RTD_ENTRADA="'+;
	             STR(DIGetPropVT("ICM_RTD_E"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_APURACAO_IPI="'+;
	             DIGetPropVT("INDAPURIPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_IPI="'+;
	             STR(DIGetPropVT("BC_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_IPI="'+;
	             STR(DIGetPropVT("ALIQ_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IPI="'+;
	             STR(DIGetPropVT("VLR_IPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISS="'+;
	             STR(DIGetPropVT("BC_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ISS="'+;
	             STR(DIGetPropVT("ALIQ_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ISS="'+;
	             STR(DIGetPropVT("VLR_ISS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISS_RTD="'+;
	             STR(DIGetPropVT("BC_ISS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ISS_RTD="'+;
	             STR(DIGetPropVT("ALIQ_ISSRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ISS_RTD="'+;
	             STR(DIGetPropVT("VLR_ISSRTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_PIS="'+;
	             STR(DIGetPropVT("BC_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_PIS="'+;
	             STR(DIGetPropVT("ALIQ_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_PIS="'+;
	             STR(DIGetPropVT("QTDBASEPIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS="'+;
	             STR(DIGetPropVT("VLR_PIS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS_RTD="'+;
	             STR(DIGetPropVT("PIS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_COFINS="'+;
	             STR(DIGetPropVT("BC_COFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_COFINS="'+;
	             STR(DIGetPropVT("ALIQCOFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_COFINS="'+;
	             STR(DIGetPropVT("QTDBASECOF"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_COFINS="'+;
	             STR(DIGetPropVT("VLR_COFINS"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_COFINS_RTD="'+;
	             STR(DIGetPropVT("COFINS_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_IR="'+;
	             STR(DIGetPropVT("BC_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_IR="'+;
	             STR(DIGetPropVT("ALIQ_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IR="'+;
	             STR(DIGetPropVT("VLR_IR"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_IR_RTD="'+;
	             STR(DIGetPropVT("IR_RTD"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_CSLL="'+;
	             STR(DIGetPropVT("BC_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_CSLL="'+;
	             STR(DIGetPropVT("ALIQ_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_CSLL="'+;
	             STR(DIGetPropVT("VLR_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ADIANTAMENTO_CSLL="'+;
	             STR(DIGetPropVT("ADNTA_CSLL"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_LANC_AUTOMATICO="'+;
	             DIGetPropVT("LANC_AUTO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_SERV_TELECOM="'+;
	             DIGetPropVT("CLSCOMNC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_GAS="'+;
	             DIGetPropVT("CLSGAS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_AGUA="'+;
	             DIGetPropVT("CLSAGUA") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLAS_CONS_ENERGIA_ELETR="'+;
	             DIGetPropVT("CLSENRG") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ALIQ_ICMS_SO="'+;
	             STR(DIGetPropVT("ALIQICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_MOD_BC_ICMS="'+;
	             DIGetPropVT("MOD_BCICMS") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PERCENTUAL_ACRESCIMO="'+;
	             STR(DIGetPropVT("PRC_ACRESC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PERCENTUAL_DESCONTO="'+;
	             STR(DIGetPropVT("PRC_DESCON"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_VENDA_UNITARIO="'+;
	             STR(DIGetPropVT("PRECOVENDA"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ABATE_NT="'+;
	             STR(DIGetPropVT("VLRABATENT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_ACRESCIMO="'+;
	             STR(DIGetPropVT("VLRACRESC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_BRUTA_ICMS_SO="'+;
	             STR(DIGetPropVT("BCBRICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ICMS_SO="'+;
	             STR(DIGetPropVT("BCICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_BC_ISENTA_IPI="'+;
	             STR(DIGetPropVT("BCISENTIPI"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_COFINS_IMPORTACAO="'+;
	             STR(DIGetPropVT("VLRCOFIMPO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_DESPESAS="'+;
	             STR(DIGetPropVT("VLR_DESPES"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ICMS_SO="'+;
	             STR(DIGetPropVT("VLR_ICMSSO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PIS_IMPORTACAO="'+;
	             STR(DIGetPropVT("VLRPISIMPO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PRODUTOS="'+;
	             STR(DIGetPropVT("VLRPRODUTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SERVICO_NT="'+;
	             STR(DIGetPropVT("VLRSRVC_NT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_SERVICOS="'+;
	             STR(DIGetPropVT("VLRSERVICO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_TRIBUTOS="'+;
	             STR(DIGetPropVT("VLRTRIBUTO"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_ORIGEM_MERCADORIA="'+;
	             DIGetPropVT("ORIGEMMRCD") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_O_ITEM_E_SERVICO="'+;
	             DIGetPropVT("ITEMSERVIC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_PRODUTOS_SERVICOS="'+;
	             STR(DIGetPropVT("TTPRODSRVC"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_GTIM="'+;
	             DIGetPropVT("GTIMCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_NCM="'+;
	             DIGetPropVT("NCMCODIGO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_EX_TIPI="'+;
	             DIGetPropVT("EXTIPI") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_GENERO="'+;
	             DIGetPropVT("GENEROPROD") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_GTIM_UNIDADE_TRIBUTAVEL="'+;
	             DIGetPropVT("GTIMUNTRIB") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_UNIDADE_TRIBUTAVEL="'+;
	             DIGetPropVT("UNIDTRIBUT") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_VLR_UNIDADE_TRIBUTAVEL="'+;
	             STR(DIGetPropVT("VLRUNTRIBU"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_UNIDADE_TRIBUTAVEL="'+;
	             STR(DIGetPropVT("QTDTRIBUT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_CLS_CODIGO_LISTA_SERVICO="'+;
	             DIGetPropVT("CDGLSTSRVC") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_IND_MOD_BC_ICMS_RTD="'+;
	             DIGetPropVT("MODBCICMRT") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_QTDE_BC_COFINS_RTD="'+;
	             STR(DIGetPropVT("QTDBCCOFRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_VLR_ALIQ_COFINS_RTD="'+;
	             STR(DIGetPropVT("VLRALQCFRT"),15,4) +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


		LSLinhaXML = 'ITDF_IND_MED_BC_ICMS_RTD="'+;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))






		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CNPJ="'+;
	             DFGetPropVT("CNPJ") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		*-------------------------------------------------------*
		LSLinhaXML = '/>'
					=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	
		SET POINT TO
		SET SEPARATOR to

RETURN(.t.)

PROCEDURE V01SOBRA

		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = 'DFIS_CLFS_SIGLA="'+;
	             DFGetPropVT("TIPO") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

		LSLinhaXML = 'ITDF_PROD_INFO_ADICIONAIS="'+;
	             DIGetPropVT("INFO_COMPL") +;
	             '"'
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GMX           NFVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    3      º
*       º Variable:            NFVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      79                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gmx     &&  NFVerifyInst VALID
#REGION 3
return
*---------------------------------------------------------------*



FUNCTION NFVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Nota")


	DO CASE

		CASE TYPE("PBNotaAlias") = "U" ;
		   		OR EMPTY(PBNotaAlias) ;
		   		OR !USED(PBNotaAlias)
			=NFCreate()					

		CASE !("NOTA.DBF" $ DBF(PBNotaAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBNotaAlias
			=NFCreate()					


		CASE  !(LSPath $ DBF(PBNotaAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=NFDestroi()				
			=NFCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GN1           NFCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    4      º
*       º Variable:            NFCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      80                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gn1     &&  NFCreate VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBNotaAlias") <> "U" ;
	   		AND !EMPTY(PBNotaAlias) ;
	   		AND USED(PBNotaAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBNotaAlias

	IF USED("Nota")
	     =NetArqAgain("Nota")
	     PBNotaAlias     = Alias()
	ELSE
	     =NetArqAgain("Nota")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Nota")
	     PBNotaAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBNotaAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTNota[LMaxDim]
    PUBLIC DIMENSION VDNota[2,3]			&& VETOR PARA PROPRIEDADES
	*-----------------------------------------------------------*
	=NFReadProperty()
	=NFSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GN5           NFDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    5      º
*       º Variable:            NFDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      81                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gn5     &&  NFDestroi VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBNotaAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBNotaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBNotaAlias
	*  3- Se aplicar um FECHAMENTO a PBNotaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBNotaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBNotaAlias)) OR ;
	   !("NOTA.DBF" $ DBF(PBNotaAlias))

		RELEASE PBNotaAlias
    	RELEASE VTNota
	    RELEASE VDNota
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBNotaAlias) AND USED(PBNotaAlias)
		SELECT &PBNotaAlias
		USE
	ENDIF	
	RELEASE PBNotaAlias
    RELEASE VTNota
    RELEASE VDNota

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GN9           NFReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    6      º
*       º Variable:            NFReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      82                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gn9     &&  NFReadProp VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=NFVerifyInst()

	SELE &PBNotaAlias
	SCATTER TO VTNota
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GNC           NFSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    7      º
*       º Variable:            NFSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      83                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gnc     &&  NFSetDerivadas VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

**	=NFVerifyInst()
	*--------------------------------------------------------------*
    VDNota(1,1) = "NAOINFORMADO"
   	VDNota(1,2) = 0
   	VDNota(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GNF           NFSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    8      º
*       º Variable:            NFSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      84                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gnf     &&  NFSetPropVT VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

**	=NFVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,PrmValue,;
						    PBNotaAlias,VTNota,VDNota)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GNJ           NFGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    9      º
*       º Variable:            NFGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      85                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gnj     &&  NFGetPropVT VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

**	=NFVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,PBNotaAlias,VTNota,VDNota)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GNL           NFChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   10      º
*       º Variable:            NFChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      86                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gnl     &&  NFChk_Identidade VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFChk_Identidade
PARAMETERS  ;
			PrmEmp,;
			PrmNota


	PRIVATE LFretorno
	LFretorno = .t.



	=NFVerifyInst()
    =NFSetPropVT("EMPRESA",PrmEmp)
    =NFSetPropVT("NOTA",PrmNota)


	LFretorno=NFFind()
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GP8           NFFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   11      º
*       º Variable:            NFFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      87                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gp8     &&  NFFind VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFFind

	PRIVATE LEmpresa,;
			LNota
			
	
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NFVerifyInst()


	LEmpresa    = NFGetPropVT("Empresa")
	LNota       = NFGetPropVT("Nota")


	SELE &PBNotaAlias
	SET ORDER TO TAG NOTA
	SEEK STR(Lempresa,3)+STR(LNota,7)
	
	IF FOUND()
		=NFReadProperty()
		=NFSetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GPC           NFGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   12      º
*       º Variable:            NFGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      88                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gpc     &&  NFGetFieldValue VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFGetFieldValue
PARAMETERS  PrmEmp,;
			PrmNota,;
			PrmField			

	=NFChk_Identidade(PrmEmp,;
					  PrmNota)

RETURN(NFGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GPF           NF_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   13      º
*       º Variable:            NF_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      89                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gpf     &&  NF_Refresh VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NF_Refresh
PARAMETERS  PrmEmpresa,;
			PrmNota
			
	
	


	PRIVATE LFreturn

	=NFVerifyInst()


	= NFSetPropVT("Empresa" ,PrmEmpresa)
	= NFSetPropVT("Nota"    ,PrmNota)

	*----------------------------------------------------------------*


	=NFFind()
	
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GPJ           NFWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   14      º
*       º Variable:            NFWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      90                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gpj     &&  NFWriteProp VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=NFVerifyInst()

	SELE &PBNotaAlias
	GATHER FROM  VTNota
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GPM           NFLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   16      º
*       º Variable:            NFLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      91                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gpm     &&  NFLerRegistro VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFLerRegistro
PARAMETERS  PrmEmp,;
			PrmNota

	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = NFChk_Identidade(PrmEmp,;
			PrmNota)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GPP           NFSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   17      º
*       º Variable:            NFSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      92                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gpp     &&  NFSalvarRegistro VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFSalvarRegistro

	=NFVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !NFExiste()
		SELE &PBNotaAlias
		APPEND BLANK
		LFretorno=NFWriteProp()
	ELSE
		SELE &PBNotaAlias
		LFretorno=NFWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GPS           NFExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   18      º
*       º Variable:            NFExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      93                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gps     &&  NFExiste VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFExiste

	PRIVATE LEmpresa,;
			LNota
			

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NFVerifyInst()

	LEmpresa    = NFGetPropVT("Empresa")
	LNota	    = NFGetPropVT("NOTA")


	SELE &PBNotaAlias
	SET ORDER TO TAG NOTA
	SEEK STR(Lempresa,3)+STR(LNota,7)
	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GPW           NFGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   20      º
*       º Variable:            NFGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      94                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gpw     &&  NFGetAlias VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFGetAlias

	=NFVerifyInst()

RETURN(PBNotaAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GPX           NFFaxinaDados VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   21      º
*       º Variable:            NFFaxinaDados                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      95                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gpx     &&  NFFaxinaDados VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFFaxinaDados

	PRIVATE LSAlias, TOTAL, CTR
	=NFVerifyInst()

	LSAlias = NFGetAlias()
	
	SELE &LSAlias





	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*





	COUNT TO TOTAL
	CTR = 0

	GO TOP
	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;

		=UPtermo()


		=RLOCK()


		CTR = 	CTR + 1
		MSG = STR(CTR,7)+" DE "+STR(TOTAL,7)
		WAIT WINDOW MSG NOWAIT


		REPLACE NOME WITH UPLimpaString(NOME)
		REPLACE ENDERECO WITH UPLimpaString(ENDERECO)


		=W_DEFPROC("CLIENTES.SPR")
		IF !CLVld_CPF_CNPJ( &LSAlias .FAVORECIDO )
			REPLACE CPFCNPJVLD  WITH "E"  && CPF/CNPJ ERRADO
		ENDIF

		SKIP
	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
	


RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GPY           NFRgAvisoCaixa VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    3    º
*       º Variable:            NFRgAvisoCaixa                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      96                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123gpy     &&  NFRgAvisoCaixa VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFRgAvisoCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa
	*------------------------------------------------------------*
    PRIVATE LFreturn
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()
	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !FOUND()
	    =up_fecha("&ALS_Nota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*

   	IF &ALS_Nota .ch_condi = "1"   &&  A VISTA
		LFreturn = NFRgAvistaCaixa(PrmEmpresa,PrmNota)
   	ELSE
		LFreturn = NFRgAprazoCaixa(PrmEmpresa,PrmNota)
   	ENDIF

	*---------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GPZ           NFRgAvistaCaixa VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    4    º
*       º Variable:            NFRgAvistaCaixa                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      97                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123gpz     &&  NFRgAvistaCaixa VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFRgAvistaCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa de NF A VISTA
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_LancaCx,ALS_LancaCx
    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_OrPgt,ALS_OrPgt

	PRIVATE LNseqDup
	
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    ARQ_OrPgt  = NetArqAgain("ORCA_PGT")
    ALS_OrPgt  = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()

	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND() OR &ALS_Nota .ch_condi <> "1"   && NÇO  A VISTA
	    =up_fecha("&ALS_Nota")
    	=up_fecha("&ALS_OrPgt")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
    * So gera controle para notas :
    *    - Operacao de Venda (ch_opera = "1")
    *    - A para notas a prazo com entrada  	
	*----------------------------------------------------------*
	SELE &ALS_OrPgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(&ALS_Nota .referencia,6)
	SET NEAR OFF
	*-------------------------------------------------------------*
	DO WHILE !EOF() ;
			AND &ALS_OrPgt .empresa = PrmEmpresa ;
			AND &ALS_OrPgt .orcamento = &ALS_Nota .referencia
	   	m.EMPRESA 	= PrmEmpresa
	   	m.PORTADOR  = 0            && Defini Caixa
		m.NOME      = &ALS_Nota .nome
 		m.data      = &ALS_Nota .data
 		m.dt_VENC   = &ALS_Nota .data
		*--------------------------------------------------------------*
		*=> Pgto Entrada em Diheiro(1) ou Cheque(2) => La‡ar para CAIXA
		*--------------------------------------------------------------*
		IF &ALS_OrPgt .modo_pgto = 1  AND ;
		    ( &ALS_OrPgt .moeda = 1 OR &ALS_OrPgt .moeda = 2 )
			
		    m.TIPO_DOC  = 1            && Codigo Tabela Padrao para NF
		    m.NUM_DOC   = STR(PrmNota,15)
	    	m.valor     = &ALS_OrPgt .vlr_pgto
			IF &ALS_OrPgt .moeda = 1
				m.MOEDA = "DINHEIRO"
			ELSE
				m.MOEDA = "CHEQUE"
			ENDIF			

		    m.JUROS        = 0
		    m.DESCONTOS    = 0
		    m.PROCESSADO   = "N"
		    m.OPERACAO     = "LANCAR"
		    m.LOG_LANCA    = "Lanc. Automatico Faturamento."

		    sele &ALS_LancaCx
		    =edithand('SAVE')
		    IF m.MOEDA = "CHEQUE"
			    m.TIPO_DOC  = 3         && REGISTRO PARA CONTROLE DE CHQ
			    sele &ALS_LancaCx
			    =edithand('SAVE')
		    ENDIF
		ENDIF
		SELE &ALS_OrPgt
		SKIP
	ENDDO
	*-------------------------------------------------------------*
	*---------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
   	=up_fecha("&ALS_OrPgt")
   	=up_fecha("&ALS_LancaCx")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GQ0           NFRgAprazoCaixa VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    5    º
*       º Variable:            NFRgAprazoCaixa                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      98                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123gq0     &&  NFRgAprazoCaixa VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFRgAprazoCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    PRIVATE ARQ_LancaCx,ALS_LancaCx
    PRIVATE ARQ_Duplicat,ALS_Duplicat

	PRIVATE LNseqDup
	
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()

    ARQ_Duplicat  = NetArqAgain("DUPLICAT")
    ALS_Duplicat  = Alias()


	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !FOUND() OR &ALS_Nota .ch_condi = "1"  &&  A VISTA
	    =up_fecha("&ALS_Nota")
    	=up_fecha("&ALS_LancaCx")
    	=up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
	*----------------------------------------------------------*

	=W_DEFPROC("duplicat.spr")
    LNnroDup = CRNroIDdupl(PrmEmpresa,PrmNota,1)


    SELE &ALS_Duplicat
  	SET ORDER TO TAG doc
	SET NEAR ON
    SEEK STR(PrmEmpresa,3)+STR(LNnroDup,9)
    SET NEAR OFF
	*-------------------------------------------------------------*
	DO WHILE !EOF() ;
			AND &ALS_Duplicat .empresa = PrmEmpresa ;
			AND &ALS_Duplicat .nota = PrmNota
	   	m.EMPRESA 	= PrmEmpresa
	   	m.PORTADOR  = 0            && Defini Caixa
		m.NOME      = &ALS_Nota .nome
 		m.data      = &ALS_Nota .data
 		m.dt_VENC   =  &ALS_Duplicat .dt_venc
		*--------------------------------------------------------------*
		*=> Pgto Entrada em Diheiro(1) ou Cheque(2) => La‡ar para CAIXA
		*--------------------------------------------------------------*
		IF  ( &ALS_Duplicat .moeda = 1 OR &ALS_Duplicat .moeda = 2 )
			
			IF &ALS_Duplicat .moeda = 1
				m.MOEDA = "DINHEIRO"
			ELSE
				m.MOEDA = "CHEQUE"
			ENDIF			

	        m.NUM_DOC   = STR( &ALS_Duplicat .duplicata ,15)
    		m.valor     = &ALS_Duplicat .vlr_doc

		    m.JUROS        = 0
		    m.DESCONTOS    = 0
		    m.PROCESSADO   = "N"
		    m.OPERACAO     = "LANCAR"
		    m.LOG_LANCA    = "Lanc. Automatico Faturamento."

			IF &ALS_Duplicat .portador = 993  && Entrada para CAIXA
	       		m.TIPO_DOC  = 2            && Codigo Tabela Padrao para dupl
			    sele &ALS_LancaCx
			    =edithand('SAVE')
			ENDIF
			
		    IF m.MOEDA = "CHEQUE"
			    m.TIPO_DOC  = 3         && REGISTRO PARA CONTROLE DE CHQ
			    sele &ALS_LancaCx
			    =edithand('SAVE')
		    ENDIF
		ENDIF
		SELE &ALS_Duplicat
		SKIP
	ENDDO
	*-------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
   	=up_fecha("&ALS_LancaCx")
   	=up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GQ1           NFCnAvisoCaixa VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    6    º
*       º Variable:            NFCnAvisoCaixa                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      99                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123gq1     &&  NFCnAvisoCaixa VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFCnAvisoCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Cancelamento
	*             de Lancamento no Sistema de Caixa
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

    PRIVATE LFretorno
    PRIVATE LSalias

    PRIVATE ARQ_Nota,ALS_Nota

    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !FOUND()
	    =up_fecha("&ALS_Nota")
	    =up_fecha("&ALS_Orcamento")
    	=up_fecha("&ALS_LancaCx")
    	=up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF


	*---------------------------------------------------------------*

   	IF &ALS_Nota .ch_condi = "1"   &&  A VISTA
		LFreturn = NFCnAvstaCaixa(PrmEmpresa,PrmNota)
   	ELSE
		LFreturn = NFCnAprzoCaixa(PrmEmpresa,PrmNota)
   	ENDIF

	*---------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GQR           NFCnAvstaCaixa VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    7    º
*       º Variable:            NFCnAvstaCaixa                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      100                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123gqr     &&  NFCnAvstaCaixa VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFCnAvstaCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Cancelamento lara Lancamento
	*              no Sistema de Caixa de NF A VISTA
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_LancaCx,ALS_LancaCx
    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_OrPgt,ALS_OrPgt

	PRIVATE LNseqDup
	
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    ARQ_OrPgt  = NetArqAgain("ORCA_PGT")
    ALS_OrPgt  = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()

	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND() OR &ALS_Nota .ch_condi <> "1"   && NÇO  A VISTA
	    =up_fecha("&ALS_Nota")
    	=up_fecha("&ALS_OrPgt")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
    * So gera controle para notas :
    *    - Operacao de Venda (ch_opera = "1")
    *    - A para notas a prazo com entrada  	
	*----------------------------------------------------------*
	SELE &ALS_OrPgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(&ALS_Nota .referencia,6)
	SET NEAR OFF
	*-------------------------------------------------------------*
	DO WHILE !EOF() ;
			AND &ALS_OrPgt .empresa = PrmEmpresa ;
			AND &ALS_OrPgt .orcamento = &ALS_Nota .referencia
	   	m.EMPRESA 	= PrmEmpresa
	   	m.PORTADOR  = 0            && Defini Caixa
		m.NOME      = &ALS_Nota .nome
 		m.data      = &ALS_Nota .data
 		m.dt_VENC   = &ALS_Nota .data
		*--------------------------------------------------------------*
		*=> Pgto Entrada em Diheiro(1) ou Cheque(2) => La‡ar para CAIXA
		*--------------------------------------------------------------*
		IF &ALS_OrPgt .modo_pgto = 1  AND ;
		    ( &ALS_OrPgt .moeda = 1 OR &ALS_OrPgt .moeda = 2 )
			
		    m.TIPO_DOC  = 1            && Codigo Tabela Padrao para NF
		    m.NUM_DOC   = STR(PrmNota,15)
	    	m.valor     = &ALS_OrPgt .vlr_pgto
			IF &ALS_OrPgt .moeda = 1
				m.MOEDA = "DINHEIRO"
			ELSE
				m.MOEDA = "CHEQUE"
			ENDIF			

		    m.JUROS        = 0
		    m.DESCONTOS    = 0
		    m.PROCESSADO   = "N"
		    m.OPERACAO     = "CANCELAR"
		    m.LOG_LANCA    = "** Cancelamento Lanc.Faturamento."

		    sele &ALS_LancaCx
		    =edithand('SAVE')
		    IF m.MOEDA = "CHEQUE"
			    m.TIPO_DOC  = 3         && REGISTRO PARA CONTROLE DE CHQ
			    sele &ALS_LancaCx
			    =edithand('SAVE')
		    ENDIF
		ENDIF
		SELE &ALS_OrPgt
		SKIP
	ENDDO
	*-------------------------------------------------------------*
	*---------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
   	=up_fecha("&ALS_OrPgt")
   	=up_fecha("&ALS_LancaCx")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GQY           NFCnAprzoCaixa VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    8    º
*       º Variable:            NFCnAprzoCaixa                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      101                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123gqy     &&  NFCnAprzoCaixa VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFCnAprzoCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    PRIVATE ARQ_LancaCx,ALS_LancaCx
    PRIVATE ARQ_Duplicat,ALS_Duplicat

	PRIVATE LNseqDup
	
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()

    ARQ_Duplicat  = NetArqAgain("DUPLICAT")
    ALS_Duplicat  = Alias()


	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !FOUND() OR &ALS_Nota .ch_condi = "1"  &&  A VISTA
	    =up_fecha("&ALS_Nota")
    	=up_fecha("&ALS_LancaCx")
    	=up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
	*----------------------------------------------------------*

	=W_DEFPROC("duplicat.spr")
    LNnroDup = CRNroIDdupl(PrmEmpresa,PrmNota,1)


    SELE &ALS_Duplicat
  	SET ORDER TO TAG doc
	SET NEAR ON
    SEEK STR(PrmEmpresa,3)+STR(LNnroDup,9)
    SET NEAR OFF
	*-------------------------------------------------------------*
	DO WHILE !EOF() ;
			AND &ALS_Duplicat .empresa = PrmEmpresa ;
			AND &ALS_Duplicat .nota = PrmNota
	   	m.EMPRESA 	= PrmEmpresa
	   	m.PORTADOR  = 0            && Defini Caixa
		m.NOME      = &ALS_Nota .nome
 		m.data      = &ALS_Nota .data
 		m.dt_VENC   =  &ALS_Duplicat .dt_venc
		*--------------------------------------------------------------*
		*=> Pgto Entrada em Diheiro(1) ou Cheque(2) => La‡ar para CAIXA
		*--------------------------------------------------------------*
		IF  ( &ALS_Duplicat .moeda = 1 OR &ALS_Duplicat .moeda = 2 )
			
			IF &ALS_Duplicat .moeda = 1
				m.MOEDA = "DINHEIRO"
			ELSE
				m.MOEDA = "CHEQUE"
			ENDIF			

	        m.NUM_DOC   = STR( &ALS_Duplicat .duplicata ,15)
    		m.valor     = &ALS_Duplicat .vlr_doc

		    m.JUROS        = 0
		    m.DESCONTOS    = 0
		    m.PROCESSADO   = "N"
		    m.OPERACAO     = "CANCELAR"
		    m.LOG_LANCA    = "** Cancelamento Lanc.Faturamento."


			IF &ALS_Duplicat .portador = 993  && Entrada para CAIXA
	       		m.TIPO_DOC  = 2            && Codigo Tabela Padrao para dupl
			    sele &ALS_LancaCx
			    =edithand('SAVE')
			ENDIF
			
		    IF m.MOEDA = "CHEQUE"
			    m.TIPO_DOC  = 3         && REGISTRO PARA CONTROLE DE CHQ
			    sele &ALS_LancaCx
			    =edithand('SAVE')
		    ENDIF
		ENDIF
		SELE &ALS_Duplicat
		SKIP
	ENDDO
	*-------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
   	=up_fecha("&ALS_LancaCx")
   	=up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GR5           NFNroNFServico VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    9    º
*       º Variable:            NFNroNFServico                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      102                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gr5     &&  NFNroNFServico VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFNroNfServico
PARAMETERS LNemp,LStp_process,LNnota,LNcupom
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Definir o numero da nota ou cumpo conforme a
	*		empresa e o processo determinado
	*------------------------------------------------------------*
	* COMENTARIO..: O padrao ‚ retornar o numero da ultima nota
	*				faturada
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LStp_process...: Processo definido em NFDefProcess
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNnota.........: Numero definido para Nota
	*		LNcupom........: Numero Cupom relacionado a nota
	*						(Quando processo de RECUPERACAO)
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	DO  CASE

		CASE LStp_proces = "REC.NOTA/CUPOM"
			DO OBJ_2FAT.SPR WITH LNcupom,0,LNnota,"SERVICO"
			IF LNnota > 0				&& CONFIRMOU OS DADOS
				LNnota     = LNnota - 1 && O USUARIO VAI DIGITAR O NUMERO
										&& REAL DA NOTA O SISTEMA TRATA COMO
										&& O ULTIMO NUMERO ,POR ISSO
										&& SUBTRAIR O 1 						 				
				IF LNnota < 2000000
					LNnota = LNnota + 2000000
				ENDIF
			ENDIF
		OTHERWISE
			LNnota     = empresa.ult_nfsrvc
			IF LNnota < 2000000
				LNnota = LNnota + 2000000
			ENDIF

	ENDCASE
	*--------------------------------------------------------------*
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota+1,7)  && VER SE PROXIMO NUMERO JA GRAVADO
	IF FOUND()
	   	WAIT WINDOW "No. Nota ja emitido. "+STR(LNnota+1,7)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GRB           NFNroCtrlCupom VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   10    º
*       º Variable:            NFNroCtrlCupom                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      103                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123grb     &&  NFNroCtrlCupom VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFNroCtrlCupom
PARAMETERS LNemp,LStp_process,LNcupom
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Definir o numero de Controle Interno de Cupom
	*------------------------------------------------------------*
	* COMENTARIO..: O padrao ‚ retornar o numero do ultimo
	*              Controle Interno de Cupom Faturado
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LStp_process...: Processo definido em NFDefProcess
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNcupom........: Numero Cupom relacionado a nota
	*						(Quando processo de RECUPERACAO)
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LNnumeroDoc
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*------------------------------------------------------------*
	DO  CASE
		CASE LStp_proces = "CUPOM"
			LNnumeroDoc     = empresa.ult_cupom 						 				
			IF LNnumeroDoc < 1000000
				LNnumeroDoc = LNnumeroDoc + 1000000
			ENDIF
		CASE LStp_proces = "REC.CUPOM"
			DO OBJ_2FAT.SPR WITH LNcupom,LNnumeroDoc,0,(LStp_proces)
			IF LNnumeroDoc > 0		&& CONFIRMOU OS DADOS
				LNnumeroDoc = LNnumeroDoc - 1
										&& O USUARIO VAI DIGITAR O NUMERO
										&& REAL DA NOTA O SISTEMA TRATA COMO
										&& O ULTIMO NUMERO ,POR ISSO
										&& SUBTRAIR O 1 						 				
				IF LNnumeroDoc < 1000000
					LNnumeroDoc = LNnumeroDoc + 1000000
				ENDIF
			ENDIF
	ENDCASE
	*--------------------------------------------------------------*
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnumeroDoc+1,7)
								  && VER SE PROXIMO NUMERO JA GRAVADO
	IF FOUND()
	   	WAIT WINDOW "No. Nota ja emitido. "+STR(LNnumeroDoc+1,7)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNnumeroDoc)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GRH           NFDelItensNf VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   11    º
*       º Variable:            NFDelItensNf                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      104                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123grh     &&  NFDelItensNf VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFDelItensNf
PARAMETERS LNemp,LNnota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Eliminar Itens Referentes a Nota No Movimento*	
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNnota.........: Nro da Nota para eliminar itens
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LNcodigo
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
    SELECT itemmov
    SET ORDER TO TAG itensnota
	SET NEAR ON
    SEEK STR(LNemp,3)+"S"+STR(LNnota,7)
	SET NEAR OFF
	DO WHILE !EOF() AND LNemp = itemmov.empresa ;
					AND LEFT(itemmov.operacao,1) = "S" ;
					AND LNnota    = itemmov.nota

			IF itemmov.tipo <> nota.tipo
				SKIP
				LOOP
			ENDIF

		    LNcodigo = itemmov.codigo
			SELE itmanexo
			SET ORDER TO TAG movanexo
			SEEK STR(itemmov.empresa,3)+itemmov.codigo+;
				 DTOS(itemmov.data)+itemmov.hora+itemmov.tipo+;
			 	STR(itemmov.nota,7)+STR(itemmov.ordem,3)
			if found()
				=REGLOCK(.T.)
				=edithand('APAGA')
			ENDIF
			UNLOCK
			SELE itemmov
		   	=W_DEFPROC("moviment.spr")
			=MVCancelMvto(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e
			SELE itemmov
		    SET ORDER TO TAG movimento
			SKIP
    ENDDO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GRI           NFdefNatureza VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   12    º
*       º Variable:            NFdefNatureza                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      105                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gri     &&  NFdefNatureza VALID
#REGION 4
return
*---------------------------------------------------------------*
FUNCTION NFdefNatureza
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Informar a menssagem adequada para o
	*                campo natureza a ser impresso em RELNFS2
	*------------------------------------------------------------*
	* COMENTARIO..:     Esta funcao foi implementada em funcao
	*              de se querer informa a natureza VENDA CARTAO
	*              que nao e uma natureza expecificada em funcao
	*              do tipo como as demais
	*				   O rgistro da nota ja esta posicionado pelo
	*   			relatorio
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*		
	*------------------------------------------------------------*
	* EXEMPLO : RELNFS2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	IF nota.ch_opera = "1" AND (nota.tp_parcela = 4 OR nota.tp_parcela = 5)
		RETURN("VENDA CARTAO")
	ENDIF
	IF nota.ch_opera = "1" AND (nota.tp_parcela = 6)
		RETURN("VENDA VENDOR")
	ENDIF
	
RETURN(nota.natureza)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GRJ           NFpede_cancelamento VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   13    º
*       º Variable:            NFpede_cancelamento                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      106                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123grj     &&  NFpede_cancelamento VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFpede_cancelamento



	PRIVATE LSstatus
	LSstatus = ""

	PRIVATE LSemiteNFe

	PRIVATE LSdbant,VLleitura,VLlerfim,VLcompara,VLchvlimi, LNregvolta
	PRIVATE LStipo,LNnf
	PRIVATE LNEmpSelec, LNNotaSelec
	******>>>> INICIO CONTROLE ARQUIVOS
	*>> parametros repassados a btn_val
	VLleitura = "STR(wp_empresa,3)"
                         * repassa chave de leitura p/ btn_val
	VLlerfim  = "STR(wp_empresa+1,3)"
           * repassa chave de leitura p/ btn_val (POSICAO FINAL + 1 REG)

	VLcompara = "nota.empresa = wp_empresa "
                         * repassa chave de comparacao p/ btn_val
	VLchvlimi = "STR(wp_empresa,3)"
	*-----------------------------------------------------------------*
	LSdbant = ALIAS()
	SELE nota
	SET ORDER TO TAG ORDEM_EMI
	SET NEAR ON
	SEEK VLlerfim
	ON KEY LABEL ESCAPE
	DO loc_dlog WITH .T.,Vlcompara, VLchvlimi,.F.,.F., .F.
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	SET NEAR OFF

	IF LASTKEY() = 27
		SELE orcament
	    RETURN .F.
	ENDIF


	LNnota = nota.nota

	IF LNnota = 0
	   SELE orcament
	   RETURN
	ENDIF
    LScp1 = STR(LNnota,7)

	wp_msg = "Confirma Solicitacao de Cancelamento p/ "+LScp1
	IF !fox_alert(wp_msg)
	   SELE orcament
	   RETURN
	ENDIF
	wp_msg = 'Informe Seu Codigo e sua Senha p/ CANCELAR..'
	LNusuario = nUsr
	BTMP   =  'usuario.usuario = LNusuario '
	LNusr_ret = 0
	DO obj_prmt.SPR WITH   wp_msg , Btmp
	IF LNusr_ret =  0
	   WAIT WINDOW "Cancelamento nao Efetuado.....<ENTER>"
	   SELE orcament
	   RETURN
	ENDIF




	=W_DEFPROC("EMPRESA.SPR")
	LSemiteNFe = EMGetFieldValue(wp_empresa,"EMITE_NFE")





	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(wp_empresa,3)+STR(LNnota,7)
	IF !FOUND()
	   WAIT WINDOW ;
	   "Cancelamento no iniciado. Nao Localizou Reg. no Sistema .<ENTER>"
	   SELE orcament
	   RETURN
	ENDIF
	
	LNEmpSelec  = nota.empresa
	LNNotaSelec = nota.nota



	DO CASE
		CASE   (nota.nota <= 999999 AND nota.cupom = 0 )
			&& ==> SOLICITOU CANCELAMENTO DE UMA NOTA
			=NFCancNota(LNEmpSelec,LNNotaSelec)


		CASE   (    nota.nota > 1000000 ;
		        AND nota.nota < 2000000)

			&& ==> SOLICITOU CANCELAMENTO DE UM CUPO

			IF NFCanCopias(LNEmpSelec,LNNotaSelec)
				=NFCancCupom(LNEmpSelec,LNNotaSelec)
			ENDIF

 		CASE   (    nota.nota > 2000000 ;
		        AND nota.nota < 3000000 ;
		        AND nota.cupom = 0 )
			&& ==> SOLICITOU CANCELAMENTO DE UMA NOTA DE SERVICO
			=NFCancNfSrv(LNEmpSelec,LNNotaSelec)


		CASE   (    nota.nota > 3000000 ;
		        AND nota.nota < 4000000 ;
		        AND nota.cupom = 0 )
			&& ==> SOLICITOU CANCELAMENTO DE UMA NFe
			=NFCancNota(LNEmpSelec,LNNotaSelec)


 		CASE   (    nota.nota > 4000000 ;
		        AND nota.nota < 5000000 ;
		        AND nota.cupom = 0 )
			&& ==> SOLICITOU CANCELAMENTO DE UMA NFSe
			=NFCancNfSrv(LNEmpSelec,LNNotaSelec)



		CASE   (nota.cupom > 0 AND nota.tipo <> "CPM" ) ;
			AND (nota.tp_parcela = 4 or nota.tp_parcela = 5)
			&& ==> SOLICITOU CANCELAMENTO DE UM TEF
			=NFCancTEF(LNEmpSelec,LNNotaSelec)
		
		CASE   (nota.cupom > 0 AND nota.tipo <> "CPM" )
			&& ==> SOLICITOU CANCELAMENTO DE UM CUPO

			IF NFCanCopias(LNEmpSelec,LNNotaSelec)
				=NFCancCupom(LNEmpSelec,LNNotaSelec)
			ENDIF


		CASE   nota.tipo = "CPM" AND LSemiteNFe = "S"

			&& ==> SOLICITOU CANCELAMENTO DE UMA COPIA
			=NFCanNFCopia(LNEmpSelec,LNNotaSelec)


		CASE   nota.tipo = "CPM"
			&& ==> SOLICITOU CANCELAMENTO DE TODAS Copias
			=NFCanCopias(LNEmpSelec,LNNotaSelec)

		OTHERWISE
			&& ==> SOLICITOU CANCELAMENTO DE UMA NOTA
			=NFCancNota(LNEmpSelec,LNNotaSelec)
			
	ENDCASE

    SELE orcament

RETURN

***



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GRK           NFCancNota VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   14    º
*       º Variable:            NFCancNota                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      107                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123grk     &&  NFCancNota VALID
#REGION 4
return
*---------------------------------------------------------------*

********************
FUNCTION NFCancNota
PARAMETERS PrmEmpresa,PrmNota
	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF
		
		***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF nota.data <> wp_dtoper
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
		   "      A Nota Fiscal informada para cancelamento "+;
		   "nao pertence a data de hoje. Esta operacao so "+;
		   " e permitida em caso de intervencao do suporte."
			wp_msg = 'Usuario Suporte...'
		BTMP   =  'usuario.retroacao = "S"'
		LNusr_ret = 0
		DO obj_prmt.SPR WITH   wp_msg , Btmp
		IF LNusr_ret =  0
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF	
	SCATTER MEMVAR


	*----------------------------------------------------------------*
	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa,PrmNota)
	IF LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			

	*-----------------------------------------------------------*

	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*
	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
	REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************

	IF LSobjetivo = "ESCRITURACAO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	UNLOCK ALL
    SELE orcament
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GRL           NFCancCupom VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   15    º
*       º Variable:            NFCancCupom                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      108                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123grl     &&  NFCancCupom VALID
#REGION 4
return
*---------------------------------------------------------------*


FUNCTION NFCancCupom
PARAMETERS PrmEmpresa,PrmNota
	PRIVATE  Flg_aceita,LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr
	STORE 0  TO  LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr

	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.F.)
	ENDIF

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
		
	***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***

	LNcupom = INT(ECFnrocupom())
	IF LNcupom = 0
   		DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+chr(13)+;
		   "  A ECF esta Retornando Numero de CUPOM = ZERO." +;
		   "Verifique <STATUS>. Verifique <Numero do Cupom>. "+;
		   "Verifique <RESET>. Se Persistir Contacte SUPORTE."
	    SELE orcament
		RETURN(.F.)
	ENDIF

	SELE nota

    IF nota.cupom   = LNcupom
		  Flg_aceita = .T.
    ELSE
		  Flg_aceita = .F.
	ENDIF
							
	IF !Flg_aceita
	   LScp1 = STR(PrmNota,7)
	   LScp2 = STR(nota.cupom,7)
	   LScp3 = STR(LNcupom,7)
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				   "      O numero de DOCUMENTO ["+LScp1+;
				   "] informado p/ cancelamento "+;
				    "esta relacionado ao CUPOM ["+LScp2+;
				    " ] sendo que o ultimo CUPOM localizado pelo "+;
				    "sistema e  ["+LScp3+"]"+;
				    chr(13)+"   Verifique os dados e tente novamente."
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Reg. Cupom Nao Pode ser Bloqueado Para Cancelamento.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	*-----------------------  CACELANDO ECF--------------------------*	
	LNCartaoVlr = 0
	LSstatus=ECFcanccpm(nota.cupom,LNCartaoVlr)

	IF SUBS(LSstatus,7,1) = "E"
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
		   "      A impressora fiscal nao acatou o cancelamento."+;
		   "Repita o processo e se persistir a negacao entre "+;
		   " em contato com suporte informando o menssagem : "+;
		    LSstatus
	   SELE orcament
	   RETURN(.f.)
	ENDIF			




	CLEAR TYPEAHEAD


	SELE  NOTA
	SCATTER MEMVAR
	*-----------------------------------------------------------*
	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*





	*----------------------------------------------------------------*

	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa,PrmNota)
	IF LSobjetivo = "ESCRITURACAO" or LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	*----------------------------------------------------------------*


	***********   LIBERAR STATUS DE PROCESSO EM EMPRESA *******
	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
	REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************
	UNLOCK ALL
    LScp1 = STR(PrmNota,7)
    DO OBJ_MENS.SPR WITH ;
    	   "    OK !! " + CHR(13)+CHR(13)+;
		   "    Cumpom cancelado na ECF e no REGISTRO "+chr(13)+;
		   " [ "+LScp1+" ]"
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GSB           NFCancTEF VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   16    º
*       º Variable:            NFCancTEF                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      109                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gsb     &&  NFCancTEF VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFCancTEF
PARAMETERS PrmEmpresa,PrmNota
	PRIVATE  Flg_aceita,LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr
	STORE 0  TO  LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr

	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF
		
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***

	LNcupom = INT(ECFnrocupom())
	IF LNcupom = 0
   		DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+chr(13)+;
		   "  A ECF esta Retornando Numero de CUPOM = ZERO." +;
		   "Verifique <STATUS>. Verifique <Numero do Cupom>. "+;
		   "Verifique <RESET>. Se Persistir Contacte SUPORTE."
	    SELE orcament
		RETURN(.F.)
	ENDIF

	SELE nota


  	IF (nota.cupom+1) = LNcupom OR;
	   (nota.cupom)   = LNcupom
		  Flg_aceita = .T.
 	ELSE
		  Flg_aceita = .F.
	ENDIF

							
	IF !Flg_aceita
	   LScp1 = STR(PrmNota,7)
	   LScp2 = STR(nota.cupom,7)
	   LScp3 = STR(LNcupom,7)
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				   "      O numero de DOCUMENTO ["+LScp1+;
				   "] informado p/ cancelamento "+;
				    "esta relacionado ao CUPOM ["+LScp2+;
				    " ] sendo que o ultimo CUPOM localizado pelo "+;
				    "sistema e  ["+LScp3+"]"+;
				    chr(13)+"   Verifique os dados e tente novamente."
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	=W_DEFPROC("ORCAMENT.SPR")
	=ORVlr_e_FormPgto(nota.Empresa,;
				  nota.Referencia,;
				  LNCheque1Vlr,;
				  LNDinheiroVlr,;
				  LNCartaoVlr)

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Reg. Cupom Nao Pode ser Bloqueado Para Cancelamento.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	************************************************	
	LSstatus=ECFcanccpm(nota.cupom,LNCartaoVlr)

	IF SUBS(LSstatus,7,1) = "E"
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
		   "      A impressora fiscal nao acatou o cancelamento."+;
		   "Repita o processo e se persistir a negacao entre "+;
		   " em contato com suporte informando o menssagem : "+;
		    LSstatus
	   SELE orcament
	   RETURN(.f.)
	ENDIF			







	CLEAR TYPEAHEAD
	SELE  NOTA
	SCATTER MEMVAR

	*-----------------------------------------------------------*
	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*


	*----------------------------------------------------------------*

	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa,PrmNota)
	IF LSobjetivo = "ESCRITURACAO" or LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	*----------------------------------------------------------------*





	***********   LIBERAR STATUS DE PROCESSO EM EMPRESA *******
	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
	REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************
	UNLOCK ALL
    LScp1 = STR(PrmNota,7)
    DO OBJ_MENS.SPR WITH ;
    	   "    OK !! " + CHR(13)+CHR(13)+;
		   "    Cumpom cancelado na ECF e no REGISTRO "+chr(13)+;
		   " [ "+LScp1+" ]"
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GSI           NFCancNCN VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   17    º
*       º Variable:            NFCancNCN                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      110                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gsi     &&  NFCancNCN VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFCancNCN
PARAMETERS PrmEmpresa,PrmNota
	PRIVATE  Flg_aceita,LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr
	STORE 0  TO  LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr

	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF
		
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***

	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Reg. Cupom Nao Pode ser Bloqueado Para Cancelamento.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	*-----------------------------------------------------------*

	LSstatus=ECFcanccpm(nota.cupom,0)

	*-----------------------------------------------------------*

	CLEAR TYPEAHEAD
	SELE  NOTA
	SCATTER MEMVAR
	*-----------------------------------------------------------*
	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*




	*----------------------------------------------------------------*

	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa,PrmNota)
	IF LSobjetivo = "ESCRITURACAO" or LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	*----------------------------------------------------------------*



	***********   LIBERAR STATUS DE PROCESSO EM EMPRESA *******
	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
	REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************
	UNLOCK ALL
    LScp1 = STR(PrmNota,7)
    DO OBJ_MENS.SPR WITH ;
    	   "    OK !! " + CHR(13)+CHR(13)+;
		   "    Cumpom cancelado na ECF e no REGISTRO "+chr(13)+;
		   " [ "+LScp1+" ]"
RETURN(.t.)

****************************************************************************

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GSN           NFCanCopias VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   18    º
*       º Variable:            NFCanCopias                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      111                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gsn     &&  NFCanCopias VALID
#REGION 4
return
*---------------------------------------------------------------*


FUNCTION NFCanCopias
PARAMETER PrmEmpresa, PrmNota

	PRIVATE LNnroReferencia

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND()
		RETURN(.F.)
	ENDIF

	IF nota.tipo = "CPM"
		LNnroReferencia = nota.referencia	
	ELSE
		LNnroReferencia = nota.nota	
	ENDIF



	LFretorno = .T.

	SET ORDER TO TAG referencia
	SEEK STR(PrmEmpresa,3)+STR(LNnroReferencia,7)
	DO WHILE !EOF() AND PrmEmpresa   = nota.empresa ;
	                AND LNnroReferencia =  nota.referencia
			IF nota.tipo <> "CPM"
				SKIP
				LOOP
			ENDIF

			*-------------------------------------------------------*

			PRIVATE LSobjetivo
			LSobjetivo = NFDefCancDFis(PrmEmpresa, nota.nota)
			IF LSobjetivo = "CANCELAMENTO"
				IF !(NF_CancDFis(PrmEmpresa, nota.nota, LSobjetivo ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+;
				   CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao acatou"+;
					" o cancelamento."+;
			        " Repita o processo e se persistir a negacao entre "+;
				    " em contato com suporte"

					LFretorno = .F.
					EXIT

					*SELE NOTA
					*SKIP
					*LOOP
				ENDIF
			ENDIF


			*------------------------------------------------------------*
	



		    m.status = 2
			=RLOCK()
			***************************
			SELE nota
			SET FIELDS TO dtregis, hregis, usrregis,deletado
		    SET FIELDS TO status
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
			***************************

			*-------------------------------------------------------*

			IF LSobjetivo = "ESCRITURACAO"
				IF !(NF_CancDFis(PrmEmpresa, nota.nota, LSobjetivo ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao acatou"+;
					" o cancelamento."+;
				     " Repita o processo e se persistir a negacao entre "+;
				     " em contato com suporte"

					LFretorno = .F.
					EXIT

					*SELE NOTA
					*SKIP
					*LOOP
				ENDIF
			ENDIF


			*------------------------------------------------------------*


			SELE NOTA
			SKIP
	ENDDO
	***************************
	UNLOCK ALL
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GST           NFCancNfSrv VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   19    º
*       º Variable:            NFCancNfSrv                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      112                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gst     &&  NFCancNfSrv VALID
#REGION 4
return
*---------------------------------------------------------------*

********************
FUNCTION NFCancNfSrv
PARAMETERS PrmEmpresa,PrmNota
	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF
		
		***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF nota.data <> wp_dtoper
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
		   "      A Nota Fiscal informada para cancelamento "+;
		   "nao pertence a data de hoje. Esta operacao so "+;
		   " e permitida em caso de intervencao do suporte."
			wp_msg = 'Usuario Suporte...'
		BTMP   =  'usuario.retroacao = "S"'
		LNusr_ret = 0
		DO obj_prmt.SPR WITH   wp_msg , Btmp
		IF LNusr_ret =  0
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF	
	SCATTER MEMVAR

	*----     CACELANDO DOCUMENTO FISCAL        -------*	

	*-------------------------------------------------------*
	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa, PrmNota)
	IF LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa, PrmNota, LSobjetivo ))
			   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
  	   	   RETURN(.f.)
		ENDIF
	ENDIF			
    *---------------------------------------------------------*

	*-----------------------------------------------------------*
	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*

	*-------------------------------------------------------*
	IF LSobjetivo = "ESCRITURACAO"
		IF !(NF_CancDFis(PrmEmpresa, PrmNota, LSobjetivo ))
			   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
  	   	   RETURN(.f.)
		ENDIF
	ENDIF			
    *---------------------------------------------------------*



	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPSRV 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************
	UNLOCK ALL
    SELE orcament
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GSU           NFCtrlCancFatura VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   20    º
*       º Variable:            NFCtrlCancFatura                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      113                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gsu     &&  NFCtrlCancFatura VALID
#REGION 4
return
*---------------------------------------------------------------*
FUNCTION NFCtrlCancFatura
PARAMETERS 	LNemp, LNnota, LStp_proc
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Controlar o Cancelamento de NF/Cupons Vinculados
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNnota.........: Nro da Nota para Cancelar
	*		LStp_proc......: "NORMAL"
	*	     				 "AUTOMATICO"
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .F. ou .T.
	*		
	*------------------------------------------------------------*
	* EXEMPLO : SCGC004
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE TmpRefOsi
	PRIVATE LNMarcaRegNota


	IF TYPE("LStp_proc") <> "C"
		LStp_proc = "NORMAL"
	ENDIF


	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota,7)

	IF !FOUND()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Nao Localizado "+;
	   		"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF


	*------------------------------------------------------------*
	*   Verificar se as duplicatas estao em condicao de cancelamento
	*------------------------------------------------------------*
	=W_DEFPROC("DUPLICAT.spr")
	IF !CRAtrzcancdupl((LNemp),(nota.orcamento))
		   WAIT WINDOW ;
		   "Duplicata com Vlr. Pago nao permitem cancelamento <ENTER>"
	   RETURN(.f.)
	ENDIF
	
	*------------------------------------------------------------*
	* Inicio cancelamento copias vinculadas
	*------------------------------------------------------------*

	LNnroRegCupom  = 0
	SELE nota
*	=NFCanCopias(LNemp,LNnota)


	* Qdo um cupom for cancelado suas copias tambem devem ser canceladas
	*------------------------------------------------------------*
	* Inicio cancelamento normal
	*------------------------------------------------------------*
	

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota,7)

	IF !FOUND()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Nao Localizado "+;
	   		"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF


	IF !REGLOCK()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Esta Aberto Para Outro Usuario. "+;
   			"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF

	TmpRefOsi = nota.referencia
	
	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(TmpRefOsi,6)
	IF FOUND()
		IF !REGLOCK()
			IF LStp_proc =  "NORMAL"
				WAIT WINDOW ;
					"O Orc.Ref. a Nota Esta Aberto Para Outro Usuario. "+;
				   	"Tente Novamente <ENTER>"
			ENDIF
			RETURN(.f.)
		ENDIF
	ENDIF

	*-------------------------------------------------------------------
	* POR DESCARACTERZAR A NOTA O PROCESSO (IF) SEGUINTE E TIDO COMO
	*-------------------------------------------------------------------
	* UM PROCESSO COMPLEMENTAR DE CANCELAMENTO A SER EXECUTADO SOMENTE QDO.
	* O CANCELAMENTO NORMAL JA FOI EXECUTADO
	*-------------------------------------------------------------------
	
	SELE NOTA	
	IF  nota.tipo = "ENT"
	    m.status = 2
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado,status
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
		UNLOCK ALL
		RETURN(.t.)
	ENDIF

	DO WHILE !BOF() AND LNemp   = nota.empresa ;
	                AND TmpRefOsi =  nota.referencia
		SELE NOTA
		SKIP -1
	ENDDO

	IF !BOF()
		SKIP
	ENDIF
	
	DO WHILE !EOF() AND LNemp   = nota.empresa ;
	                AND TmpRefOsi =  nota.referencia

		LNMarcaRegNota = RECNO()
		=NFCancFatura(LNemp, nota.nota, LStp_proc)
		SELE nota
		SET ORDER TO TAG nota
		GO LNMarcaRegNota
		SKIP
	ENDDO


	*********************************
	* REABILITAR ORCAMENTO
	*********************************

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota,7)

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(nota.referencia,6)
	
	IF FOUND()
		=REGLOCK(.T.)
		SELE orcament
		m.situacao = orcament.situacao
		DO CASE
			CASE orcament.situacao = "OC"
									&& Fat. direto pelo faturista
    			m.situacao = 'A '&& Orcamento aberto estado inicial
			OTHERWISE
		    	m.situacao = 'o '    && Volta a osi para caixa

		ENDCASE
		REPLACE situacao WITH m.situacao
	ENDIF
	*********************************************************************
	SELE nota
	CLEAR FIELDS
	SET FIELDS OFF
	UNLOCK ALL
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GSV           NFCancFatura VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   21    º
*       º Variable:            NFCancFatura                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      114                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gsv     &&  NFCancFatura VALID
#REGION 4
return
*---------------------------------------------------------------*
FUNCTION NFcancFatura
PARAMETERS 	LNemp, LNnota, LStp_proc
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Cancelar Nota Fiscal
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNnota.........: Nro da Nota para Cancelar
	*		LStp_proc......: "NORMAL"
	*	     				 "AUTOMATICO"
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .F. ou .T.
	*		
	*------------------------------------------------------------*
	* EXEMPLO : SCGC004
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LNosiNfReferencia

	IF TYPE("LStp_proc") <> "C"
		LStp_proc = "NORMAL"
	ENDIF

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota,7)

	IF !FOUND()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Nao Localizado "+;
	   		"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF

	IF !REGLOCK()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Esta Aberto Para Outro Usuario. "+;
   			"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF

	LNosiNfReferencia = nota.referencia

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNosiNfReferencia,6)
	IF FOUND()
		IF !REGLOCK()
			IF LStp_proc =  "NORMAL"
				WAIT WINDOW ;
					"O Orc.Ref. a Nota Esta Aberto Para Outro Usuario. "+;
				   	"Tente Novamente <ENTER>"
			ENDIF
			RETURN(.f.)
		ENDIF
	ENDIF
	*----- POR DESCARACTERZAR A NOTA O PROCESSO (IF) SEGUINTE E TIDO COMO
	* UM PROCESSO COMPLEMENTAR DE CANCELAMENTO A SER EXECUTADO SOMENTE QDO.
	* O CANCELAMENTO NORMAL JA FOI EXECUTADO
	*-------------------------------------------------------------------
	SELE nota
	IF  nota.tipo = "ENT"
	    m.status = 2
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
	    SET FIELDS TO status
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
		UNLOCK ALL
		RETURN(.t.)
	ENDIF
	SELECT  itemmov
	SET ORDER TO TAG itensnota
	SET NEAR ON
	SEEK STR(LNemp,3)+"S"+STR(LNnota,7)
	SET NEAR OFF
	************************************
	LFretorno = .t.  && SE .F. => TRANSACAO DEVE SER ABORTADA
	DO WHILE !eof() AND nota.nota     = itemmov.nota ;
					AND nota.empresa  = itemmov.empresa
			*---------------------------------------------------*
			*   Registros de SCA podem se misturar a ordem dos
			* registros de saidas comercias quando coincidirem
			* os numeros da SCA e da NFS. Pois as duas operacoes
			* sao de saida.
			*	A condicao abaixo evita que registro de tipos
			* distintos sejam confundidos.
			*---------------------------------------------------*
			IF nota.tipo  <> itemmov.tipo
				SKIP
				LOOP
			ENDIF
		    SKIP					&& PASSA PARA REGISTRAR O PROXIMO
			IF !EOF()
		   	   LNproximo  = RECNO()  && POR CAUSA DA DELECAO
			ELSE
			   LNproximo  = 0
			ENDIF
	        SKIP - 1				&&  VOLTA AO REG. DEVIDO
			IF !REGLOCK()
			   LFretorno = .f.
			   EXIT
			ENDIF
			IF !UNFbaixa_saldo()
			   LFretorno = .f.
			   EXIT
			ENDIF

			DO UNFdesfatura

	    	SELECT itemmov
			SET ORDER TO TAG itensnota
			IF LNproximo  > 0
				GO LNproximo && DEVIDO A DELECAO E PROCESS DE ATU_CMD
			ELSE
				EXIT
			ENDIF
	ENDDO
	SELE nota
	IF !LFretorno   && OPERACAO NAO FOI CONCLUIDA COM SUCESSO
		RETURN(.f.)
	ENDIF			
	********************************
	LNnota	= nota.nota

				
    *------------------------------------------------*
	* NOTIFICAR CANCELAMENTO AO SISTEMA DE CAIXA
    *   Quando um orcamento gerar mais de uma nota
    * o sistema so notificara o caixa quando a ultima
    * nota for cancelada
    *------------------------------------------------*
	=NFCnAvisoCaixa((LnEmp), (LNnota))
    *------------------------------------------------*

	*------------------------------------------*
	=W_DEFPROC("DUPLICAT.spr")
	=CRcancdupl((LNemp),(LNnota))
	*------------------------------------------*
	*----------------------------------------------------------------*
**	DO  NFCancBonus WITH (LNemp),(nota.referencia)
	*----------------------------------------------------------------*



	*********************************
	* REABILITAR ORCAMENTO
	*********************************
	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNosiNfReferencia,6)
	
	IF FOUND()
		=REGLOCK(.T.)
		IF !(orcament.qtdnfgerad - 1) < 1
			IF nota.status <> 2
				REPLACE qtdnfgerad WITH orcament.qtdnfgerad - 1
			ENDIF
		ENDIF

		IF nota.status <> 2
			SELE orcament
			REPLACE qtdnfgerad WITH orcament.qtdnfgerad - 1
			m.situacao = orcament.situacao
			IF orcament.qtdnfgerad < 1		&& ULTIMA NOTA DO ORCAMENTO
				DO CASE
					CASE orcament.situacao = "OC"
											&& Fat. direto pelo faturista
		    			m.situacao = 'A '&& Orcamento aberto estado inicial
					CASE (WP_ECF $ "SRIQ") ;
						AND LEFT(orcament.situacao,1) = "O"
						&&  ESTA USANDO ECF
				    	m.situacao = 'o '    && Volta a osi para caixa
					CASE LEFT(orcament.situacao,1) = "O" && Faturado
				    	m.situacao = 'M '  && Volta a osi impressa integral
				ENDCASE
				REPLACE situacao WITH m.situacao
			ENDIF
		ENDIF
	ENDIF
	*********************************************************************
	SELE nota
	m.status = 2
	***************************
	SET FIELDS TO dtregis, hregis, usrregis,deletado
	SET FIELDS TO status
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF

	IF orcament.qtdnfgerad > 0 AND nota.status = 2
		IF LStp_proc =  "NORMAL"
		    DO OBJ_ALER.SPR WITH ;
			   "O Orcamento Gerou Mais de Uma nota. Cancele Todas......"+;
			   CHR(13)+;
			   "So assim o Orcamento Sera Disponibilizado."
		ENDIF
	ENDIF
	UNLOCK ALL
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GTS           UNFbaixa_saldo VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   22    º
*       º Variable:            UNFbaixa_saldo                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      115                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gts     &&  UNFbaixa_saldo VALID
#REGION 4
return
*---------------------------------------------------------------*
*********************************
PROCEDURE UNFbaixa_saldo  && VERIFICA POSSIBILIDADE DE  BAIXA  NO ESTOQUE
   IF itemmov.tp_mercad = 7  && SERVICO NAO NECESSITA SALDO
      RETURN .T.
   ENDIF
   IF LEFT(itemmov.codigo,4) = "9999"  && COMENTARIO NAO NECESSITA SALDO
      RETURN .T.
   ENDIF

   SELECT saldo
   SET ORDER TO TAG clas_saldo
   SEEK STR(LNemp,3)+itemmov.classifica+;
        STR(YEAR(nota.data),4)+;
        STR(MONTH(nota.data),2)
   IF !FOUND()
      WAIT WINDOW RTRIM(transform(itemmov.codigo,'@R &masc_codi'))+;
                   " nao foi aberto para movimentacao. Solicite abertura."
      RETURN .F.
   ENDIF
RETURN .T.



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GTW           UNFdesfatura VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   23    º
*       º Variable:            UNFdesfatura                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      116                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gtw     &&  UNFdesfatura VALID
#REGION 4
return
*---------------------------------------------------------------*
PROCEDURE UNFdesfatura
* se nao for localiza em orcatmp deve ser apagado em itemmov

   SELECT itemmov
   SET ORDER TO TAG movimento
   SELE itmanexo
   SET ORDER TO TAG movanexo
   SEEK STR(itemmov.empresa,3)+itemmov.codigo+;
			 DTOS(itemmov.data)+itemmov.hora+itemmov.tipo+;
			 STR(itemmov.nota,7)+STR(itemmov.ordem,3)
   IF FOUND()
		=REGLOCK(.T.)
		=edithand('APAGA')
   ENDIF
   SELE itemmov
   =REGLOCK(.T.)
   *-------------------------------------------------------------*
   *    Desfaturao  item em orcatmp
   *-------------------------------------------------------------*

   =ULatvitem(nota.empresa,nota.referencia,itemmov.ordem)

   m.codigo = itemmov.codigo
   *-------------------------------------------------------------*
   IF itemmov.qtde  = 0 				OR ;
   	  itemmov.tp_mercad = 7 			OR ;
      itemmov.situacao = "OC"  			OR ;
      !FOUND("ORCATMP")					&& (OC) Fat. direto sem reserva
      									&& SE NA ROTINA ULATVITEM NAO
      									&& TIVER ENCONTRADO ORCATMP
      									&& EXCLUI DO MOVIMENTO
			SELE itemmov
		   	=W_DEFPROC("moviment.spr")
			=MVCancelMvto(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e

   ELSE
		   **************** REABILITA RESERVA ANTERIOR AO FATURAMENTO *****
		   	SELE itemmov
		   	m.situacao = "M "
	   	   	m.operacao = 'RVPS'   && RESERVA/VENDA/PROCESSADA/
									  && APROVEITA O MOV. P/ RESERVA
	   	   	m.nota     = 0
		  	***************************
		   	SET FIELDS TO dtregis, hregis, usrregis,deletado
		   	SET FIELDS TO situacao,operacao,nota
		   	=edithand('REGRAVA')
		   	CLEAR FIELDS
		   	SET FIELDS OFF
		   	***************************
			SELE itemmov
		   	=W_DEFPROC("moviment.spr")
			=MVatu_cmd(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e
   ENDIF


RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GU0           ULatvitem VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   24    º
*       º Variable:            ULatvitem                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      117                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gu0     &&  ULatvitem VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION ULatvitem
	PARAMETERS LNemp,LNreferencia,LNordem

		*---------------------------------------------------------*
		*  Reativa o item de orcatmp vinculado ao item da nota
		* itemmov cancelado
		*---------------------------------------------------------*
		PRIVATE LSalias
		LSalias = ALIAS()

		SELECT  orcatmp
		SET ORDER TO TAG orcamento
		SEEK STR(LNemp,3)+STR(LNreferencia,6)+STR(LNordem,2)
		************************************
		IF FOUND()
	    	SELECT orcatmp
			DO CASE
				CASE orcatmp.situacao = "OC" && Fat direto pelo faturista
		    		m.situacao = 'A '        && OSI aberto estado inicial
				OTHERWISE
			    	m.situacao = 'o '    && Volta a osi para caixa
			ENDCASE


	*		DO CASE
	*			CASE orcatmp.situacao = "OC" && Fat direto pelo faturista
	*	    		m.situacao = 'A '        && OSI aberto estado inicial
	*			CASE (WP_ECF $ "SRIQ") AND LEFT(orcatmp.situacao,1) = "O"
	*				&&  ESTA USANDO ECF
	*		    	m.situacao = 'o '    && Volta a osi para caixa
	*			CASE LEFT(orcatmp.situacao,1) = "O" && Faturado
	*		    	m.situacao = 'M '    && Volta a osi impressa integral
	*		ENDCASE
*


			=REGLOCK(.T.)
			REPLACE situacao WITH m.situacao				
		ENDIF
		SELE &LSalias
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GU5           NFEcfInforme VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   25    º
*       º Variable:            NFEcfInforme                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      118                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gu5     &&  NFEcfInforme VALID
#REGION 4
return
*---------------------------------------------------------------*
FUNCTION NFEcfInforme
PARAMETERS 	LNemp, LDdtini, LDdtFim, LNnroIni,LNnroFim,LNvalorTot,;
			LNicmsTot
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:   Colher informacoes referentes saidas regis-
	*			tradas em ECF
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LDdtini........: Data Inicial
	*		LDdtfim........: Data Final
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNnroIni.......: Numero do 1 Cupom Emitido
	*		LNnroFim.......: Numero do Ultimo Cupom Emitido
	*		LNvalorTot.....: Valor das Saidas Registradas em ECF
	*		LNicmsTot......: Valor do ICMS Registrado
	*------------------------------------------------------------*
	* EXEMPLO : SCGC220
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	LSalias = ALIAS()
	PRIVATE LSmsg
	PRIVATE LNicmCalc
	*------------------------------------------------------------*
	LNnroIni		= 	99999999
	LNnroFim		= 	0
	LNvalorTot		=	0
	LNicmsTot		=	0
	LNicmCalc		=	0


	SELE nota
	SET ORDER TO TAG data
	SET NEAR ON
	SEEK STR(LNemp,3)+DTOS(LDdtIni)
	SET NEAR OFF
	DO WHILE !EOF() AND LNemp = nota.empresa AND nota.data <= LDdtFim
		LSmsg = "Informacoes do ECF ... Data : "+DTOC(nota.data)+;
				" Nota : "+STR(nota.nota,7)
		WAIT WINDOW LSmsg NOWAIT				

		IF nota.cupom = 0 OR nota.tipo = "CPM"
			SKIP
			LOOP
		ENDIF

		IF nota.cupom > LNnroFim
			LNnroFim = nota.cupom
		ENDIF
		IF nota.cupom < LNnroIni
			LNnroIni = nota.cupom
		ENDIF
		IF nota.status <> 2 && NOTA CANCELADA
			LNvalorTot	=	LNvalorTot 	+ 	nota.total_nota
			*--------------------------------------------------------*
			*   O campo nota.vlr_icms nao era calculado ate o mes 7/2000
			* por isso adota-se o calculo do icms na linha abaixo
			* esse problema pode ser sanado calculando-se o VLR_ICMS para
			* todas as notas emitidas
			*--------------------------------------------------------*
	******	LNicmsTot	=	LNicmsTot	+	nota.vlr_icms		
			IF nota.base_icms > 0 ;
				AND nota.aliq_icms > 0 ;
				AND nota.vlr_icms = 0
					LNicmCalc = ROUND(nota.base_icms*nota.aliq_icms / 100,2)
			ELSE
					LNicmCalc 	=	nota.vlr_icms
			ENDIF
			LNicmsTot	=	LNicmsTot	+	LNicmCalc
		ENDIF
		SKIP
	ENDDO
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GUC           NFtot_nfs VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   26    º
*       º Variable:            NFtot_nfs                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      119                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123guc     &&  NFtot_nfs VALID
#REGION 4
RETURN

FUNCTION NFtot_nfs
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Retornar o Valor Totadas das Nota emitidas
	*			em um periodo especifico
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Filial em que se deve apurar o valor
	*		LDt_ini........: Data inicial que se deve apurar o valor
	*		LDt_fim........: Data inicial que se deve apurar o valor
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o VALOR DAS NOTAS VALIDAS
	*------------------------------------------------------------*
	*  EXEMPLO.....:
	*------------------------------------------------------------*

PARAMETERS  LNemp, LDt_ini, LDt_fim
	PRIVATE LNtotal, LSalias
	PRIVATE LFnota
	LSalias			= ALIAS()
		
	=W_DEFPROC("rotinas.spr")
	LFnota	= NetArq("nota")
	IF (LFnota) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("nota" ,LFnota)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*---------------------------------------------------------------*	
	*	Valor total das notas nao canceladas
	*---------------------------------------------------------------*	
	LNtotal  = 0
	sele nota
	SET ORDER TO TAG data
	SET NEAR ON
	SEEK STR(LNemp,3)+DTOS(LDt_ini)
	SET NEAR OFF
	DO WHILE !EOF() AND nota.data  <= LDt_fim ;
					AND nota.empresa  = LNemp
			LNtotal 	=  LNtotal + nota.total_nota
			SKIP
	ENDDO

	=UP_fecha("nota" ,LFnota)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNtotal)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GUJ           NFgeraBonus VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   27    º
*       º Variable:            NFgeraBonus                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      120                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123guj     &&  NFgeraBonus VALID
#REGION 4
RETURN
*********************************************************************
*  NFgeraBonus.....: Gera Bonus
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Bonus
*                   Empresa
*                   Orcament
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

PROCEDURE NFGeraBonus
	
	PARAMETERS LNEmp,LNOrcamento
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE LFbonus,LForcamento,LFclienc,LFempresa,LForcatmp
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFbonus 	= NetArq("bonus")
	LForcamento = NetArq("Orcament")
	LFclienc    = NetArq("clienc")
	LFempresa   = NetArq("empresa")
	LForcatmp   = NetArq("orcatmp")
	IF (LFbonus+LFempresa+LForcamento+LFclienc+LForcatmp) > 100000
		=UP_fecha("bonus"  		,LFbonus )
		=UP_fecha("orcamento" 	,LForcamento )
		=UP_fecha("clienc" 		,LFclienc )
		=UP_fecha("empresa" 	,LFempresa)
		=UP_fecha("orcatmp" 	,LForcatmp)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF

    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

	*------------------------------------------------------------*
	*   O bonus so e gerado para varejo , Pessoa Fisica e que
	* Tenha o CPF informado e seja faturado apos  {31.12.2000}
	*------------------------------------------------------------*
	IF clienc.natu_cli <> 0  ;
		OR clienc.tp_pessoa <> 1 ;
		OR clienc.cliente = 0 ;
		OR orcament.dt_fat < {01.10.2000}
		
		=UP_fecha("bonus"  		,LFbonus )
		=UP_fecha("orcamento" 	,LForcamento )
		=UP_fecha("clienc" 		,LFclienc )
		=UP_fecha("empresa" 	,LFempresa)
		=UP_fecha("orcatmp" 	,LForcatmp)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF
	*----------------------------------------------------------------*
	wp_msg = "Gerando Bonus OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*

	m.empresa 	=	LNemp
	m.osi_origem=	LNorcamento
	m.cliente	=	clienc.cliente
	m.nf_origem	=	orcament.nota
	m.dt_emissao=	orcament.dt_fat
	m.valor		=   orcament.valor * empresa.Tx_Bonus / 100
	m.osi_aplica= 	0
	m.vlr_sldbns=   0
	*---------------------------------------------------------------*
	*   Em caso de ser utilizado bonus no orcamento sera feito um
	* levantamento do valor nao utilizado e este saldo e acrecentado
	* ao valor do novo bonus uma vez que o bonus utilizado e baixado
	* pelo fato de ter sido vinculado ao orcamento e nao pelo uso ou
	* nao do seu valor integral. Este Procedimento evita a criacao de
	* controle de conta corrente para saldo de bonus
	*---------------------------------------------------------------*
	IF orcament.bonus_serv > 0
		LNvlrBonusConsumido = 0
		SELE orcatmp
		SET ORDER TO TAG orcamento
		SET NEAR ON
		SEEK STR(LNemp,3)+STR(LNorcamento,6)
		SET NEAR OFF
		DO WHILE !EOF() AND LNemp = orcatmp.empresa ;
						AND LNorcamento = orcatmp.orcamento
			IF orcatmp.tp_mercad = 7 AND LEFT(orcatmp.situacao,1) = "O"
				LNvlrBonusConsumido = ;
							LNvlrBonusConsumido + orcatmp.desc_adici
			ENDIF
			SKIP
		ENDDO
		LNsldBonus	= orcament.bonus_serv - LNvlrBonusConsumido
		m.valor		= m.valor + LNsldBonus
		m.vlr_sldbns= LNsldBonus
	ENDIF
	
	IF m.valor > 0
		SELE bonus
		SET ORDER TO TAG osi_origem
		SEEK STR(LNemp,3)+STR(LNorcamento,6)
		IF !FOUND()
			=edithand('SAVE')
		ELSE
			=edithand('REGRAVA')
		ENDIF
	ENDIF
	*----------------------------------------------------------*
	=UP_fecha("bonus"  		,LFbonus )
	=UP_fecha("orcamento" 	,LForcamento )
	=UP_fecha("clienc" 		,LFclienc )
	=UP_fecha("empresa" 	,LFempresa)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GUK           NFCancBonus VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   28    º
*       º Variable:            NFCancBonus                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      121                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123guk     &&  NFCancBonus VALID
#REGION 4
RETURN
*********************************************************************
*  NFCancBonus.....: Cancela Bonus
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Bonus
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

PROCEDURE NFCancBonus
	
	PARAMETERS LNEmp,LNOrcamento
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE LFbonus
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFbonus		= NetArq("bonus")
	IF (LFbonus) > 100000
		=UP_fecha("bonus"  ,LFbonus)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF

	*----------------------------------------------------------------*
	wp_msg = "Cancelando Bonus OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*
	SELE bonus
	SET ORDER TO TAG osi_origem
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	IF FOUND()
		=edithand('APAGA')
	ENDIF
	*----------------------------------------------------------*
	=UP_fecha("bonus"  ,LFbonus)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GUL           NFVldPortFatura VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   29    º
*       º Variable:            NFVldPortFatura                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      122                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gul     &&  NFVldPortFatura VALID
#REGION 4
RETURN

*********************************************************************
*  NFVldPortFatura
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [****]
*---------------------------------------------------------------
*  OBJETIVO.......:  Validar o faturamento em uma determinada
*               forma de pagamento considerendo as combinacoes
*               entre Prmtp_parcela,PrmModo_pgto,PrmMoeda,PrmBanco
*---------------------------------------------------------------
*  COMENTARIO.....:  A empresa estabelece as regras para faturamento
*               atraves de combinacoes autorizadas entre :
*				Prmtp_parcela,PrmModo_pgto,PrmMoeda,PrmBanco
*
*---------------------------------------------------------------
*  PARAMETROS.....:
*             PrmTp_parcela:  01- A Vista
*                             02- Cheque Parcelado
*                             03- Duplicata Parcelada
*                             04- Cartao Parcelado
*                             05- Cartao a Vista
*                             06- Vendor Vista
*
*
*             PrmModo_Pgto    01- Entrada
*							  02- Restante
*
*		      PrmMoeda        00- Indiferente
*							  01- Dinheiro
*						      02- Cheque
*							  03- Duplicata
*                             04- Chq.Eletronico
*                             05- Cartao
*                             06- Vendor
*
*             PrmBanco     (Codigo do Portador)
*
*
*     Pela Combinacao dos parametros e possivel verificar se a
*   configuracao da fatura e aceita para determinado portador
*
*---------------------------------------------------------------
* RETORNO.........: .t.  ou .f.
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

FUNCTION NFVldPortFatura
PARAMETERS Prmtp_parcela,PrmModo_pgto,PrmMoeda,PrmBanco

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias, LFretorno
	LSalias = ALIAS()
	LFretorno  = .t.
	SELE pg_prmtd
	SET ORDER TO TAG pg_prmtd
	SEEK STR(PrmTP_PARCELA,1)+STR(PrmMODO_PGTO,1)+;
				STR(PrmMOEDA,2)+STR(PrmBANCO,3)
	IF !FOUND()
		LFretorno  = .f.
	ENDIF
	SELE &LSalias

RETURN(LFretorno)

********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GUM           NFConjNfRef VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   30    º
*       º Variable:            NFConjNfRef                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      123                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123gum     &&  NFConjNfRef VALID
#REGION 4
RETURN

FUNCTION NFConjNfRef
PARAMETERS PrmEmpresa,PrmReferencia


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PRIVATE LSAlias
	PRIVATE ARQ_Nota,ALS_Nota

	PRIVATE ARQ_Tmp1,ALS_Tmp1
	store "" to ARQ_tmp1,ALS_tmp1

	PRIVATE ARQ_Tmp2,ALS_Tmp2
	store "" to ARQ_tmp2,ALS_tmp2



	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*

	LSbase = wp_dirdat

	LSAlias = Alias()


    ARQ_Nota     = NetArqAgain(LSbase+"NOTA")
    ALS_Nota     = Alias()

	ARQ_tmp1=UPnometmp("EX1")
	ARQ_tmp2=UPnometmp("EX2")

	DO CASE
		CASE PrmReferencia < 1000000  && REFERENCIA  UMA OSI
			SELE &ALS_nota
			SET ORDER TO TAG REFERENCIA

			SET NEAR ON
			SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
			SET NEAR OFF

			IF PrmEmpresa <> empresa OR PrmReferencia <> referencia
				SKIP -1
			ENDIF

			WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

			COPY TO &ARQ_tmp1 WITH CDX ;
				WHILE EMPRESA = PrmEmpresa ;
				      AND REFERENCIA = PrmReferencia
			SELE 0
			USE &ARQ_tmp1
			ALS_tmp1 = ALIAS()
			SELECT  data, hora, status,nota,cupom,referencia,;
				tipo,total_nota,nome;
				FROM &ALS_tmp1 ;
				ORDER BY DATA,HORA ;
				INTO CURSOR EXTR_1

			*--------------------------------------------*
		    * Busca das copias de cupom
			*--------------------------------------------*
			SELE &als_tmp1

		    DO WHILE !EOF()
			  IF nota >= 1000000 AND nota <= 2000000
				PrmReferencia = nota
				SELE &ALS_nota
				SET ORDER TO TAG REFERENCIA

				SET NEAR ON
				SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
				SET NEAR OFF

				IF PrmEmpresa <> empresa OR PrmReferencia <> referencia
					SKIP -1
				ENDIF

				WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

			    =up_fecha("&ALS_Tmp2")
				COPY TO &ARQ_tmp2 WITH CDX ;
				WHILE EMPRESA = PrmEmpresa ;
				      AND REFERENCIA = PrmReferencia
				SELE 0
				USE &ARQ_tmp2
				ALS_tmp2 = ALIAS()
		
				SELECT * FROM EXTR_1;
					UNION;			
				SELECT  data, hora, status,nota,cupom,referencia,;
					tipo,total_nota,nome;
					FROM &ALS_tmp2 ;
					INTO CURSOR EXTR_1
		      ENDIF
			  SELE &ALS_TMP1
			  SKIP
		    ENDDO

		OTHERWISE
		*------------------------------------------------------------*	
		*CASE PrmReferencia >= 1000000 AND PrmReferencia <= 2000000
		*	                                && REFERENCIA  UM CUPOM
		*------------------------------------------------------------*	
			SELE &ALS_nota
			SET ORDER TO TAG REFERENCIA

			SET NEAR ON
			SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
			SET NEAR OFF

			IF PrmEmpresa <> empresa OR PrmReferencia <> referencia
				SKIP -1
			ENDIF

			WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

			COPY TO &ARQ_tmp1 WITH CDX ;
				WHILE EMPRESA = PrmEmpresa ;
				      AND REFERENCIA = PrmReferencia
			SELE 0
			USE &ARQ_tmp1
			ALS_tmp1 = ALIAS()
			SELECT  data, hora, status,nota,cupom,referencia,;
				tipo,total_nota,nome;
				FROM &ALS_tmp1 ;
				INTO CURSOR EXTR_1

			*--------------------------------------------*
		    * Busca das OUTRAS NOTAS
			*--------------------------------------------*
			SELE &als_tmp1

		    DO WHILE !EOF()
			  IF nota < 1000000 OR  nota > 2000000


				PrmReferencia = referencia
				SELE &ALS_nota
				SET ORDER TO TAG NOTA
				
				SET NEAR ON
				SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
				SET NEAR OFF

				IF PrmEmpresa <> empresa OR PrmReferencia <> nota
					SKIP -1
				ENDIF

				IF PrmEmpresa <> empresa OR PrmReferencia <> nota
					exit
				endif

				PrmReferencia = referencia
				SELE &ALS_nota
				SET ORDER TO TAG REFERENCIA

				SET NEAR ON
				SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
				SET NEAR OFF

				IF PrmEmpresa <> empresa OR PrmReferencia <> referencia
					SKIP -1
				ENDIF


				WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

			    =up_fecha("&ALS_Tmp2")
				COPY TO &ARQ_tmp2 WITH CDX ;
				WHILE EMPRESA = PrmEmpresa ;
				      AND REFERENCIA = PrmReferencia
				SELE 0
				USE &ARQ_tmp2
				ALS_tmp2 = ALIAS()
		
				SELECT * FROM EXTR_1;
					UNION;			
				SELECT  data, hora, status,nota,cupom,referencia,;
					tipo,total_nota,nome;
					FROM &ALS_tmp2 ;
					INTO CURSOR EXTR_1
		      ENDIF
			  SELE &ALS_TMP1
			  SKIP
		    ENDDO

	ENDCASE

	SELECT * FROM EXTR_1;
			ORDER BY DATA,HORA ;
			INTO CURSOR EXTR_1

    SELE EXTR_1

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ REFERENCIAS EQUIVALENTES PARA NF ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF

	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			STATUS,;
			NOTA		:H="DOC Fiscal" :R,;
			TIPO,;
			CUPOM,;
			REFERENCIA,;
			TOTAL_NOTA 	:H="VALOR"	:P="@r #######9.99" :R,;
			NOME  ;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_nota")
    =up_fecha("EXTR_1")
    =up_fecha("EXTR_2")
    =up_fecha("&ALS_Tmp1")
    =up_fecha("&ALS_Tmp2")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GVN           NFDMSVer20 VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   31    º
*       º Variable:            NFDMSVer20                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      124                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gvn     &&  NFDMSVer20 VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFDMSVer20
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")

    PRIVATE LSalias
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Nota,ALS_Nota

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_nota  = NetArqAgain("NOTA")
    ALS_nota  = Alias()


	SELE &ALS_Nota
	SET ORDER TO TAG DATA

	SELE &ALS_Empresa
	SET ORDER TO TAG EMPRESA

	SELE 0
   	USE Q:\SCGC\COMUM\DMS  EXCL

	SELE DMS
    ZAP
	PACK

	SELE &ALS_Empresa
	seek PrmEmpresa


	LNempresa   = PrmEmpresa
    LDataInicio = PrmDataInicio
   	LDataFinal  = PrmDataFinal
   	LSPeriodo   = STR(YEAR(LDataFinal),4)+Str(Month(LDataFinal),2)
	LSPeriodo   = STRTRAN(LSPeriodo," ", "0")
   	LSExtensao  = SUBS(LSPeriodo,3,2)+".D"+SUBS(LSPeriodo,5,2)


    LNinscr_Muni = STRTRAN( &ALS_Empresa .insc_munic,".","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni," ","0")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"-","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"/","")
    LNinscr_Muni = Left(LNinscr_Muni,7)
   	LNAIDF    = &ALS_Empresa .AIDF
	LNANOAIDF = &ALS_Empresa .ANOAIDF
    LNMODISS  = &ALS_Empresa .MODISS
    LScidade  = &ALS_Empresa .cidade
	LSarqDst  = "Q:\SCGC\DMS\"+;
	            LEFT(LNinscr_Muni,6)+LSExtensao  && INSC+AA+.D MM



    LsTipo       = "H"

	sele dms

    LsEmpresa    = LEFT( &ALS_Empresa .nome + SPACE(50),50)
   	LsCNPJ       = strtran(str( &ALS_Empresa .cgc,14)," ","0")
    LsDMSNegativa= "N"
	LsEspaco     = space(83)
	LsData       = DTOS(DATE())
	LsEmail      = LEFT("deptofiscal@pneulandia.com.br"+space(35),35)
   	LsVersao     = "V.2.0"
	LsEspaco2     = space(35)

   	LScabecalho =   LsTipo+LNinscr_Muni+LSPeriodo+LsEmpresa+;
    		 LsCNPJ+ LsDMSNegativa+LsEspaco+LsData+LsEmail+;
    		 LsVersao+LsEspaco2
	APPEND BLANK
	REPLACE dms with  LScabecalho

*-------------------------------------------------------------*


	SET TALK ON

	=W_DEFPROC("nota.spr")
	TmpCrs = NFSqlDMS(LNEmpresa, LDataInicio, LDataFinal)

    SELECT * FROM &TmpCrs ;
    INTO CURSOR TMPNOTA ;
	ORDER BY EMPRESA,DATA,NOTA




   	SELECT "D" AS identif,SPACE(4) AS espaco1,;
       strtran(str(nota,10)," ","0") AS NOTA,;
       strtran(str(LNAIDF,7)," ","0") AS AIDF,;
        strtran(str(LNANOAIDF,4)," ","0") AS ANOAIDF,;
        strtran(str(YEAR(data),4)," ","0")  AS ANONF,;
        strtran(str(MONTH(data),2)," ","0") AS MESNF,;
        strtran(str(DAY(data),2)," ","0") AS DIANF,;
       strtran(str(LNMODISS,1)," ","0") AS MODISS,;
		   IIF(status = 2  ,"1","0") AS sitnf,;
		   LEFT(nome+space(50),50) AS nome,;
		   IIF(tp_pessoa = 1,"F","J") AS tp_pess,;
		   strtran(str(Favorecido,14)," ","0") AS favo,;		   	
		   IIF(cidade = LScidade,"1","0") AS CIDADE,;
		   LEFT(cidade+space(25),25)	AS cidtomad,;
 	       strtran(str(INT(base_iss*100),13)," ","0") AS baseiss,;
 	       strtran(str(INT(totSERVICO*100),13)," ","0") AS vlrnf,;
 	       strtran(str(INT(aliq_iss*100),4)," ","0") AS aliqiss,;
 	       strtran(str(INT(vlr_iss*100),13)," ","0") AS vlriss,;
 	       SPACE(88)  AS espaco2;
	 	from &TmpCrs ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_B1


	SELECT * FROM DMS_B1 ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_D


	SET TALK OFF

 	SELE DMS_D
   	COPY TO  L:\TMP\DMS_D  TYPE SDF
 	
    SELECT DMS
	APPEND FROM L:\TMP\DMS_D.TXT TYPE SDF

	 *-----------------------------------------------------------*

	count to LsQtde
	LsQtde = LsQtde - 1
	GO TOP
	
    LsTipo  = "T"
   	LsQtde  =  strtran(str(LsQtde,4)," ","0")
   	LSEspaco= space(240)

    LStotal =   LsTipo+LsQtde+Lsespaco
	APPEND BLANK
	REPLACE dms with  LStotal
	
	GO TOP
	COPY TO &LSarqDst TYPE SDF
	USE
	
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	SET TALK OFF
RETURN(.T.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GVX           NFSqlDMS VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   32    º
*       º Variable:            NFSqlDMS                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      125                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gvx     &&  NFSqlDMS VALID
#REGION 4
return
*---------------------------------------------------------------*
*  Esta rotina gera um CURSOR com dados de prestacao de servico
* que sera utilizado na emissao do RELATORIO DE PRESTACAO DE SER-
* VICO  e NA GERACAO DO ARQUIVO DMS para municipio
*---------------------------------------------------------------*
FUNCTION NFSqlDMS
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")

    PRIVATE LSalias
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Nota,ALS_Nota

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_nota  = NetArqAgain("NOTA")
    ALS_nota  = Alias()


	SELE &ALS_Nota
	SET ORDER TO TAG DATA


    SELECT * FROM &ALS_Nota NOTA ;
   	WHERE (nota.empresa = PrmEmpresa ;
   		AND nota.data >= m.PrmDataInicio ;
   		AND nota.data <= m.PrmDataFinal) ;
   		AND nota.ch_produ $ "1/5" ;
 	 		AND ((nota.base_iss > 0 AND nota.aliq_iss > 0 );
                OR (nota.status <> 1 AND nota.empresa = 10)) ;
    INTO CURSOR TMPNOTA ;
	ORDER BY EMPRESA,DATA,NOTA




	SELE &ALS_Empresa
	SET ORDER TO TAG EMPRESA
	seek PrmEmpresa


	*---------------------------------------------------------*
	*    Copias de cupons com servio. Serao utilizadas para
	*  atribuir o numero da NF Copia (CPM) ao cupom emitido
	*  pois para o municipio o doc. fiscal e a nf e nao o
	*  cupom. Como os dados de ISS estao no cupom sera feito
	*  um select entre CUPONS e NF copia relacionada onde o
	* numero do documento sera o da NF.copia
	*---------------------------------------------------------*

	SET TALK ON

   	SELECT STR(EMPRESA,3)+STR(REFERENCIA,7) AS NRO_CUPOM,;
   		empresa,nota,referencia,status, ;
        base_iss,;
 	    total_nota,;
		totservico,;
		totproduto,;
 	    aliq_iss,;
 	    vlr_iss;
	 	from TMPNOTA where empresa = PrmEmpresa;
 	       and tipo = "CPM";
 	       and data <=  PrmDataFinal ;
 	       and data >= PrmDataInicio ;
 	       and vlr_iss > 0;
 	    order by empresa,nota,referencia into cursor DMS_CPMs


	*---------------------------------------------------------*
	*    Seleciona todas notas que nao estao vinculadas a cupons
	*  em que constem servio.
	*  DOCUMENTO FISCAL = NOTA
	*  ==> A) NF COM SERVICO NAO VINCULADAS A CUPONS
	*---------------------------------------------------------*

   	SELECT ;
	   empresa,;
	   operacao,;
   	   nota,;
	   cupom,;
       data,;
   	   status,;
	   nome,;
	   tp_pessoa,;
	   Favorecido,;		   	
	   cidade,;
	   NFmunidms(uf,cidade) AS MUNI_DMS,;
       base_iss,;
 	   total_nota,;
	   totservico,;
	   totproduto,;
 	   aliq_iss,;
 	   vlr_iss;
 	from TMPNOTA where empresa = PrmEmpresa;
       and tipo <> "CPM" ;
       and (nota < 1000000 or nota >= 2000000);
       and data <=  PrmDataFinal ;
       and data >= PrmDataInicio and vlr_iss > 0;
    into cursor DMS_A1

	*---------------------------------------------------------*
	*    Nos cupons para os quais foram emitidas copias
	*  o numero do documento assume o numero da NF copia
	*  DOCUMENTO FISCAL = COPIA
	*  ==> B) COPIAS DE CUPONS COM SERVICO
	*---------------------------------------------------------*
   	SELECT ;
		NF.empresa,;
	    NF.operacao,;
   		CPM.nota,;
		NF.cupom,;
   	    NF.data,;
   	    CPM.status,;
	    NF.nome,;
	    NF.tp_pessoa,;
	    NF.Favorecido,;		   	
	    NF.cidade,;
	    NFmunidms(NF.uf,NF.cidade) AS MUNI_DMS,;
        CPM.base_iss,;
 	    CPM.total_nota,;
		CPM.totservico,;
		CPM.totproduto,;
 	    CPM.aliq_iss,;
 	    CPM.vlr_iss;
 	from TMPNOTA NF, DMS_CPMs CPM ;
	 	where NF.empresa = PrmEmpresa;
 	       and NF.tipo <> "CPM" ;
 	       and NF.empresa= CPM.empresa ;
 	       and NF.nota   = CPM.referencia ;
 	       and NF.nota > 1000000 ;
		   and NF.nota < 2000000 ;
 	       and NF.data <=  PrmDataFinal ;
 	       and NF.data >= PrmDataInicio ;
 	       and NF.vlr_iss > 0;
    into cursor DMS_A2

	*---------------------------------------------------------*
	*---------------------------------------------------------*
	*    Seleciona todos cupons que nao estao vinculadas a
	*  copias em NF  e  que constem servio.
	*  DOCUMENTO FISCAL = CUPOM
	*  ==> C) CUPONS NAO VINCULADOS A COPIAS EM NF
	*---------------------------------------------------------*

   	SELECT ;
	   empresa,;
	   operacao,;
   	   nota,;
	   cupom,;
       data,;
   	   status,;
	   nome,;
	   tp_pessoa,;
	   Favorecido,;		   	
	   cidade,;
	   NFmunidms(uf,cidade) AS MUNI_DMS,;
       base_iss,;
 	   total_nota,;
	   totservico,;
	   totproduto,;
 	   aliq_iss,;
 	   vlr_iss;
 	from TMPNOTA where empresa = PrmEmpresa;
       and nota > 1000000 ;
	   and nota < 2000000 ;
       and data <=  PrmDataFinal ;
       and data >= PrmDataInicio and vlr_iss > 0;
       and STR(EMPRESA,3)+STR(NOTA,7) ;
           not in (SELECT NRO_CUPOM from DMS_CPMs);
    into cursor DMS_A3



    SELECT * FROM  DMS_A1 ;
    UNION ;
    SELECT * FROM  DMS_A2 ;
    into cursor DMS_A4


    SELECT * FROM  DMS_A3 ;
    UNION ;
    SELECT * FROM  DMS_A4 ;
    into cursor DMS_A5


    SELECT * FROM  DMS_A5 ;
 	    order by NOTA into cursor DMS_A1

	SET TALK OFF
    *-----------------------------------------------------------*
	
	sele TMPNOTA
	USE

	sele DMS_A2
	USE

	sele DMS_A3
	USE

	sele DMS_A4
	USE

	sele DMS_A5
	USE

	
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	SET TALK OFF
RETURN("DMS_A1")
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GVY           NFView VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   33    º
*       º Variable:            NFView                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      126                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gvy     &&  NFView VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFView
PARAMETER PrmFiltro

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	0
	*------------------------------------------------------------*
	PRIVATE VLleitura,VLlerfim,VLcompara,VLchvlimi, LNregvolta
	PRIVATE LStipo,LNnf, LNnroNF
	******>>>> INICIO CONTROLE ARQUIVOS
	*>> parametros repassados a btn_val
	VLleitura = "STR(wp_empresa,3)"
                         * repassa chave de leitura p/ btn_val
	VLlerfim  = "STR(wp_empresa+1,3)"
           * repassa chave de leitura p/ btn_val (POSICAO FINAL + 1 REG)

	IF TYPE("PrmFiltro") <> "C"
		PrmFiltro = ""
	ENDIF

	VLcompara = ;
	  "nota.empresa = wp_empresa "+PrmFiltro
                         * repassa chave de comparacao p/ btn_val
	VLchvlimi = "STR(wp_empresa,3)"
	*-----------------------------------------------------------------*
	SELE nota
	SET ORDER TO TAG ORDEM_EMI
	SET NEAR ON
	SEEK VLlerfim
	ON KEY LABEL ESCAPE
	DO loc_dlog WITH .T.,Vlcompara, VLchvlimi,.F.,.F., .F.
	LFretorno = 0
	IF lastkey() = 23
		LFretorno = RECNO()
	ENDIF
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	SET NEAR OFF
	

	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GVZ           NF_aviso VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   34    º
*       º Variable:            NF_aviso                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      127                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gvz     &&  NF_aviso VALID
#REGION 4
return
*---------------------------------------------------------------*
FUNCTION NF_aviso
PARAMETERS PrmEmp,PrmNfinicio,PrmCtrlCpmIni,PrmSolicitante,PrmTp_Process

	private lndoc	
	LNDOC = 0

	IF PrmSolicitante <> "IMPORTACAO"
		DO CASE
    		CASE "CUPOM" $ PrmTp_Process
				LNDOC = PRMCtrlCpmIni
	    	CASE "NOTA" $ PrmTp_Process
				LNDOC = PRMnfinicio
		ENDCASE
	ENDIF

	*-------------------------------------------------*
	*  DEFINIR MENSAGEM AO OPERADOR
	*-------------------------------------------------*
	SELE nota
	SET ORDER TO TAG NOTA
	SEEK STR(PrmEmp,3)+STR(LNDoc,7)
    LSdef_msg  = ""
	do case
		case PrmSolicitante = "IMPORTACAO"
		   LSdef_msg  = ""
		case  nota.ch_opera $ "12" AND ;
			nota.ch_desti = "2"  AND ;
				EMPTY(ALLTRIM(nota.inscsubst)) AND ;
				nota.icms_subs > 0
			   LSdef_msg  = ;
				   	"Recolher Imposto N.F. "+STR(LNDOC,7)
		case  nota.ch_opera $ "2" AND ;
			  nota.ch_desti = "2"  AND ;
			  nota.uf = "TO" AND ;
			  nota.cfo = "6.152 "
			   LSdef_msg = "Recolher Imposto N.F. "+STR(LNDOC,7)
	ENDCASE
	IF LSdef_msg <> ""
	   wp_msg  = LSdef_msg
	   DO OBJ_ALER.SPR WITH  wp_msg
	ENDIF
	*----------------------------------------------------------------*
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GW0           NFDMSVer30 VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   35    º
*       º Variable:            NFDMSVer30                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      128                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gw0     &&  NFDMSVer30 VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFDMSVer30
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")

    PRIVATE LSalias
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Nota,ALS_Nota

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_nota  = NetArqAgain("NOTA")
    ALS_nota  = Alias()


	SELE &ALS_Nota
	SET ORDER TO TAG DATA

	SELE &ALS_Empresa
	SET ORDER TO TAG EMPRESA

	SELE 0
   	USE Q:\SCGC\COMUM\DMS  EXCL

	SELE DMS
    ZAP
	PACK

	SELE &ALS_Empresa
	seek PrmEmpresa


	LNempresa   = PrmEmpresa
    LDataInicio = PrmDataInicio
   	LDataFinal  = PrmDataFinal
   	LSPeriodo   = STR(YEAR(LDataFinal),4)+Str(Month(LDataFinal),2)
	LSPeriodo   = STRTRAN(LSPeriodo," ", "0")
   	LSExtensao  = SUBS(LSPeriodo,3,2)+".D"+SUBS(LSPeriodo,5,2)


    LNinscr_Muni = STRTRAN( &ALS_Empresa .insc_munic,".","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni," ","0")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"-","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"/","")
    LNinscr_Muni = Left(LNinscr_Muni,7)

   	LNAIDF    = &ALS_Empresa .AIDF
	LNANOAIDF = &ALS_Empresa .ANOAIDF
    LNMODISS  = &ALS_Empresa .MODISS
    LScidade  = &ALS_Empresa .cidade
	LSarqDst  = "Q:\SCGC\DMS\"+;
	            LEFT(LNinscr_Muni,6)+LSExtensao  && INSC+AA+.D MM



    LsTipo       = "H"

	sele dms

    LsEmpresa    = LEFT( &ALS_Empresa .nome + SPACE(50),50)

   	LsCNPJ       = strtran(str( &ALS_Empresa .cgc,14)," ","0")
    LsDMSNegativa= "N"
	LsEspaco     = space(83)
	LsData       = DTOS(DATE())
	LsEmail      = LEFT("deptofiscal@pneulandia.com.br"+space(35),35)
   	LsVersao     = "V.3.0"
   	LsTpDoc      = "NF   "
   	LsUltForm    = space(7)
	LsEspaco2    = space(23)

   	LScabecalho =   LsTipo+LNinscr_Muni+LSPeriodo+LsEmpresa+;
    		 LsCNPJ+ LsDMSNegativa+LsEspaco+LsData+LsEmail+;
    		 LsVersao+;
    		 LsTpDoc+;
    		 LsUltForm+;		
    		 LsEspaco2
	APPEND BLANK
	REPLACE dms with  LScabecalho

*-------------------------------------------------------------*


	SET TALK ON

	=W_DEFPROC("nota.spr")
	TmpCrs = NFSqlDMS(LNEmpresa, LDataInicio, LDataFinal)

    SELECT * FROM &TmpCrs ;
    INTO CURSOR TMPNOTA ;
	ORDER BY EMPRESA,DATA,NOTA




   	SELECT     "D" AS identif,;
        SPACE(4) AS espaco1,;
        strtran(str(nota,10)," ","0") AS NOTA,;
        strtran(str(LNAIDF,7)," ","0") AS AIDF,;
        strtran(str(LNANOAIDF,4)," ","0") AS ANOAIDF,;
        strtran(str(YEAR(data),4)," ","0")  AS ANONF,;
        strtran(str(MONTH(data),2)," ","0") AS MESNF,;
        strtran(str(DAY(data),2)," ","0") AS DIANF,;
        strtran(str(LNMODISS,1)," ","0") AS MODISS,;
	    IIF(status = 2  ,"1","0") AS sitnf,;
		LEFT(nome+space(50),50) AS nome,;
		IIF(tp_pessoa = 1,"F","J") AS tp_pess,;
		strtran(str(Favorecido,14)," ","0") AS favo,;		   	
		IIF(cidade = LScidade,"1","0") AS CIDADE,;
		LEFT(cidade+space(25),25)	AS cidtomad,;
 	    strtran(str(INT(base_iss*100),13)," ","0") AS baseiss,;
 	    strtran(str(INT(totSERVICO*100),13)," ","0") AS vlrnf,;
 	    strtran(str(INT(aliq_iss*100),4)," ","0") AS aliqiss,;
 	    "00"     AS atvddiss,;
 	    SPACE(86)  AS espaco2;
	 	from &TmpCrs ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_B1


	SELECT * FROM DMS_B1 ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_D


	SET TALK OFF

 	SELE DMS_D
   	COPY TO  L:\TMP\DMS_D  TYPE SDF
 	
    SELECT DMS
	APPEND FROM L:\TMP\DMS_D.TXT TYPE SDF

	 *-----------------------------------------------------------*

	count to LsQtde
	LsQtde = LsQtde - 1
	GO TOP
	
    LsTipo  = "T"
   	LsQtde  =  strtran(str(LsQtde,4)," ","0")
   	LSEspaco= space(240)

    LStotal =   LsTipo+LsQtde+Lsespaco
	APPEND BLANK
	REPLACE dms with  LStotal
	
	GO TOP
	COPY TO &LSarqDst TYPE SDF
	USE
	
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	SET TALK OFF
RETURN(.T.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GWV           NFDMS VALID                        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   36    º
*       º Variable:            NFDMS                              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      129                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gwv     &&  NFDMS VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFDMS
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")



	DO CASE
		CASE PrmDataInicio < {01.08.2009}
			=NFDMSVer30(PrmEmpresa, PrmDataInicio, PrmDataFinal)
		OTHERWISE
			=NFDMSVer40(PrmEmpresa, PrmDataInicio, PrmDataFinal)
	ENDCASE

RETURN(.T.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GX0           NFDMSVer40 VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   37    º
*       º Variable:            NFDMSVer40                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      130                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gx0     &&  NFDMSVer40 VALID
#REGION 4
return
*---------------------------------------------------------------*

FUNCTION NFDMSVer40
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")

    PRIVATE LSalias
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Nota,ALS_Nota

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_nota  = NetArqAgain("NOTA")
    ALS_nota  = Alias()


	SELE &ALS_Nota
	SET ORDER TO TAG DATA

	SELE &ALS_Empresa
	SET ORDER TO TAG EMPRESA

	SELE 0
   	USE Q:\SCGC\COMUM\DMS  EXCL

	SELE DMS
    ZAP
	PACK

	SELE &ALS_Empresa
	seek PrmEmpresa


	LNempresa   = PrmEmpresa
    LDataInicio = PrmDataInicio
   	LDataFinal  = PrmDataFinal
   	LSPeriodo   = STR(YEAR(LDataFinal),4)+Str(Month(LDataFinal),2)
	LSPeriodo   = STRTRAN(LSPeriodo," ", "0")
   	LSExtensao  = SUBS(LSPeriodo,3,2)+".D"+SUBS(LSPeriodo,5,2)


    LNinscr_Muni = STRTRAN( &ALS_Empresa .insc_munic,".","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni," ","0")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"-","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"/","")
    LNinscr_Muni = Left(LNinscr_Muni,7)

   	LNAIDF    = &ALS_Empresa .AIDF
	LNANOAIDF = &ALS_Empresa .ANOAIDF
    LNMODISS  = &ALS_Empresa .MODISS
    LScidade  = &ALS_Empresa .cidade
	LSarqDst  = "Q:\SCGC\DMS\"+;
	            LEFT(LNinscr_Muni,6)+LSExtensao  && INSC+AA+.D MM



    LsTipo       = "H"

	sele dms

    LsEmpresa    = LEFT( &ALS_Empresa .nome + SPACE(50),50)

   	LsCNPJ       = strtran(str( &ALS_Empresa .cgc,14)," ","0")
    LsDMSNegativa= "N"
	LsEspaco     = space(83)
	LsData       = DTOS(DATE())
	LsEmail      = LEFT("deptofiscal@pneulandia.com.br"+space(35),35)
   	LsVersao     = "V.4.0"
   	LsTpDoc      = "NF   "
   	LsUltForm    = space(7)
	LsEspaco2    = space(23)

   	LScabecalho =   LsTipo+LNinscr_Muni+LSPeriodo+LsEmpresa+;
    		 LsCNPJ+ LsDMSNegativa+LsEspaco+LsData+LsEmail+;
    		 LsVersao+;
    		 LsTpDoc+;
    		 LsUltForm+;		
    		 LsEspaco2
	APPEND BLANK
	REPLACE dms with  LScabecalho

*-------------------------------------------------------------*


	SET TALK ON

	=W_DEFPROC("nota.spr")
	TmpCrs = NFSqlDMS(LNEmpresa, LDataInicio, LDataFinal)

    SELECT * FROM &TmpCrs ;
    INTO CURSOR TMPNOTA ;
	ORDER BY EMPRESA,DATA,NOTA




   	SELECT     "D" AS identif,;
        SPACE(4) AS espaco1,;
        strtran(str(nota,10)," ","0") AS NOTA,;
        strtran(str(LNAIDF,7)," ","0") AS AIDF,;
        strtran(str(LNANOAIDF,4)," ","0") AS ANOAIDF,;
        strtran(str(YEAR(data),4)," ","0")  AS ANONF,;
        strtran(str(MONTH(data),2)," ","0") AS MESNF,;
        strtran(str(DAY(data),2)," ","0") AS DIANF,;
        strtran(str(LNMODISS,1)," ","0") AS MODISS,;
	    IIF(status = 2  ,"1","0") AS sitnf,;
		LEFT(nome+space(50),50) AS nome,;
		IIF(tp_pessoa = 1,"F","J") AS tp_pess,;
		strtran(str(Favorecido,14)," ","0") AS favo,;		   	
        SPACE(26) AS espaco2,;
 	    strtran(str(INT(base_iss*100),13)," ","0") AS baseiss,;
 	    strtran(str(INT(totSERVICO*100),13)," ","0") AS vlrnf,;
 	    strtran(str(INT(aliq_iss*100),4)," ","0") AS aliqiss,;
 	    "00"     AS atvddiss,;
	    strtran(str(MUNI_DMS,6)," ","0") AS MUNI_DMS,;
 	    SPACE(80)  AS espaco3;
	 	from &TmpCrs ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_B1



	SELECT * FROM DMS_B1 ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_D


	SET TALK OFF

 	SELE DMS_D
   	COPY TO  L:\TMP\DMS_D  TYPE SDF
 	
    SELECT DMS
	APPEND FROM L:\TMP\DMS_D.TXT TYPE SDF

	 *-----------------------------------------------------------*

	count to LsQtde
	LsQtde = LsQtde - 1
	GO TOP
	
    LsTipo  = "T"
   	LsQtde  =  strtran(str(LsQtde,4)," ","0")
   	LSEspaco= space(240)

    LStotal =   LsTipo+LsQtde+Lsespaco
	APPEND BLANK
	REPLACE dms with  LStotal
	
	GO TOP
	COPY TO &LSarqDst TYPE SDF
	USE
	
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	SET TALK OFF
RETURN(.T.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GXC           NFmunidms VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   38    º
*       º Variable:            NFmunidms                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      131                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gxc     &&  NFmunidms VALID
#REGION 4
return
*---------------------------------------------------------------*
FUNCTION NFmunidms
PARAMETERS PrmUf, PrmCidade
PRIVATE LNretorno

    WAIT WINDOW PrmUf + "-" +PrmCidade NOWAIT

	=W_DEFPROC("DMSMUNI.spr")
    LNretorno=DMNGet_MUNIDMS(PrmUf, PrmCidade)



RETURN(LNretorno)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GXI           NFCanNFCopia VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   39    º
*       º Variable:            NFCanNFCopia                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      132                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gxi     &&  NFCanNFCopia VALID
#REGION 4
return
*---------------------------------------------------------------*


FUNCTION NFCanNFCopia
PARAMETER PrmEmpresa, PrmNota

	PRIVATE LNnroReferencia

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND() or nota.tipo <> "CPM"
		RETURN(.F.)
	ENDIF

	LFretorno = .T.
	DO WHILE !EOF() AND PrmEmpresa   = nota.empresa ;
	                AND PrmNota      = nota.nota
			IF nota.tipo <> "CPM"
				SKIP
				LOOP
			ENDIF
			*-------------------------------------------------------*
			PRIVATE LSobjetivo
			LSobjetivo = NFDefCancDFis(PrmEmpresa, PrmNota)
			IF LSobjetivo = "CANCELAMENTO"
				IF !(NF_CancDFis(PrmEmpresa, PrmNota, LSobjetivo ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!";
				    +CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao "+;
					"acatou o cancelamento."+;
				     " Repita o processo e se persistir a negacao entre "+;
				     " em contato com suporte"
						SELE NOTA
					
					LFretorno = .F.
					EXIT


					*SKIP
					*LOOP

				ENDIF
			ENDIF
			*-------------------------------------------------------*

		    m.status = 2
			=RLOCK()
			***************************
			SET FIELDS TO dtregis, hregis, usrregis,deletado
		    SET FIELDS TO status
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
			***************************


			*-------------------------------------------------------*
			IF LSobjetivo = "ESCRITURACAO"
				IF !(NF_CancDFis(PrmEmpresa, PrmNota, LSobjetivo ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!";
				    +CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao "+;
					"acatou o cancelamento."+;
				     " Repita o processo e se persistir a negacao entre "+;
				     " em contato com suporte"
						SELE NOTA

					LFretorno = .F.
					EXIT


					*SKIP
					*LOOP
				ENDIF
			ENDIF
			*-------------------------------------------------------*

			SELE NOTA
			SKIP
	ENDDO
	***************************
	UNLOCK ALL
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GXJ           NAONFDefCancDFis VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   40    º
*       º Variable:            NAONFDefCancDFis                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      133                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gxj     &&  NAONFDefCancDFis VALID
#REGION 4
return
*---------------------------------------------------------------*

********************
FUNCTION NAONFDefCancDFis
PARAMETERS PrmEmpresa,PrmNota


	*-->>>>>>>>>>>>>     PARA ENVIO NFE

	return(.t.)

	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= ""
	PrmTipo    		= ""
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*



	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	*----------------------------------------------------*


	*-----------------------------------------------------------*
	PRIVATE LSemi_NF,LSemi_NFe,LSemi_NFS,LSemi_NFSe,LSemi_ECF
	PRIVATE LSscr_NF,LSscr_NFe,LSscr_NFS,LSscr_NFSe,LSscr_ECF

	*------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NF = EMGetFieldValue(PrmEmpresa,"EMITE_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFe = EMGetFieldValue(PrmEmpresa,"EMITE_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFS = EMGetFieldValue(PrmEmpresa,"EMITE_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFSe = EMGetFieldValue(PrmEmpresa,"EMITE_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_ecf = EMGetFieldValue(PrmEmpresa,"EMITE_ECF")

	*------------------------------------------------------------*

	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NF = EMGetFieldValue(PrmEmpresa,"ESCRT_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFS = EMGetFieldValue(PrmEmpresa,"ESCRT_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFSe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ecf = EMGetFieldValue(PrmEmpresa,"ESCRT_ECF")


	*------------------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "NAO INTEGRAR"



	DO CASE
	
		CASE  RtnMOD_DOC    =   "2D"  && CUPOM

			DO CASE
				CASE LSemi_ECF = "S"
	 				PrmObjetivo = "CANCELAMENTO"

				CASE LSscr_ECF = "S"
	 				PrmObjetivo = "ESCRITURACAO"

				OTHERWISE
					PrmObjetivo = "NAO INTEGRAR"
			ENDCASE

		CASE  RtnMOD_DOC    $   "03/77"  && NF SERVICO
				DO CASE
					CASE LSemi_NFS = "S" OR LSemi_NFSe = "S" 				
		 				PrmObjetivo = "CANCELAMENTO"

					CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE

		CASE  RtnMOD_DOC    =   "01/55"  && NF/NFe
				DO CASE
					CASE LSemi_NF = "S" OR LSemi_NFe = "S" 				
		 				PrmObjetivo = "EMISSAO"

					CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE

		OTHERWISE			
				PrmObjetivo = "NAO INTEGRAR"

		ENDCASE
RETURN(PrmObjetivo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GXK           NAONFDefEnvDFis VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   41    º
*       º Variable:            NAONFDefEnvDFis                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      134                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gxk     &&  NAONFDefEnvDFis VALID
#REGION 4
return
*---------------------------------------------------------------*

********************
FUNCTION NAoNFDefEnvDFis
PARAMETERS PrmEmpresa,PrmNota


	*-->>>>>>>>>>>>>     PARA ENVIO NFE
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= ""
	PrmTipo    		= ""
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*



	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	*----------------------------------------------------*


	*-----------------------------------------------------------*
	PRIVATE LSemi_NF,LSemi_NFe,LSemi_NFS,LSemi_NFSe,LSemi_ECF
	PRIVATE LSscr_NF,LSscr_NFe,LSscr_NFS,LSscr_NFSe,LSscr_ECF

	*------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NF = EMGetFieldValue(PrmEmpresa,"EMITE_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFe = EMGetFieldValue(PrmEmpresa,"EMITE_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFS = EMGetFieldValue(PrmEmpresa,"EMITE_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFSe = EMGetFieldValue(PrmEmpresa,"EMITE_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_ecf = EMGetFieldValue(PrmEmpresa,"EMITE_ECF")

	*------------------------------------------------------------*

	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NF = EMGetFieldValue(PrmEmpresa,"ESCRT_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFS = EMGetFieldValue(PrmEmpresa,"ESCRT_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFSe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ecf = EMGetFieldValue(PrmEmpresa,"ESCRT_ECF")


	*------------------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "NAO INTEGRAR"



	DO CASE
	
		CASE  RtnMOD_DOC    =   "2D"  && CUPOM

			DO CASE
				CASE LSemi_ECF = "S"
	 				PrmObjetivo = "EMISSAO"

				CASE LSscr_ECF = "S"
	 				PrmObjetivo = "ESCRITURACAO"

				OTHERWISE
					PrmObjetivo = "NAO INTEGRAR"
			ENDCASE

		CASE  RtnMOD_DOC    $   "03/77"  && NF SERVICO
				DO CASE
					CASE LSemi_NFS = "S" OR LSemi_NFSe = "S" 				
		 				PrmObjetivo = "EMISSAO"

					CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE

		CASE  RtnMOD_DOC    =   "01/55"  && NF/NFe
				DO CASE
					CASE LSemi_NF = "S" OR LSemi_NFe = "S" 				
		 				PrmObjetivo = "EMISSAO"

					CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE

		OTHERWISE			
				PrmObjetivo = "NAO INTEGRAR"

		ENDCASE
RETURN(PrmObjetivo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GXL           NFRot_Fat VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    2    º
*       º Variable:            NFRot_Fat                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      135                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gxl     &&  NFRot_Fat VALID
#REGION 5
return

*---------------------------------------------------------------*

FUNCTION  NFrot_fat
	PARAMETERS  LSsolicitante,LSemcaminhar
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Controla o processo de Faturamento
	*				Esta e a primeira instancia de rotinas para
	*				FATURAMENTO/PREPARACAO
	*------------------------------------------------------------*
	* COMENTARIO..: A rotina serve a dois objetivos
	*				1- Preparacao para  Faturamento
	*				2- Preparacao e  Faturamento
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS AMBIENTAIS..:
	*					LNecf.......: Nro da Conexao aberta com
	*							ECF no programa OBJ_ECF.SPR
	*						OBS: Quando o Sistema nao esta usando
	*							ECF esta variavel nao e inicializada
	*							portanto ela e inicializada com
	*							valor = 0 nesta rotina
	*  PARAMETROS..:
	*		LSsolicitante..: Identifica os Pontos em que esta
	*				 rotina pode ser chamada
	*			   		LSsolicitante = "VENDEDOR"
	*					LSsolicitante = "CAIXA"
	*					LSsolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					LSsolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					LSsolicitante = "IMPORTACAO"		&& SCGC008
	*                   LSsolicitante = "RECUPERACAO"
	*
	*		LSemcaminhar....: Orienta o processo para :
	*					LSemcaminhar	  = "PREPARAR FATURAMENTO"
	*					LSemcaminhar	  = "EFETIVAR FATURAMENTO"			
	*		LFretorno.......:
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()

	PRIVATE LStp_proces		&& = "CUPOM", "NOTA", "NOTA/CUPOM",
							&&   "RECUP.CUPOM", "RECUP.NOTA",
							&&			 "RECUP.NOTA/CUPOM"
	PRIVATE LFservico		&&   INDICA SE EXISTE SERVICO P/ FATURAR
	PRIVATE LFflagtrans		&&   INDICA SITUACAO DE CONCLUSAO DO PROCESSO
	PRIVATE LSsitRequerida  &&   Armazena a SITUACAO requrida para
							&& a operacao e repassa a ORloc_orc

	PRIVATE LForcament,LFclienc,LFclientes,LFliberacao
	PRIVATE LSalias

	*------------------------------------------------------------*
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFclientes		= NetArq("clientes")
	LFliberacao		= NetArq("liberaco")
	*--------------------------------------------------------

    IF (LForcament+LFclienc+LFclientes) > 100000  && HOUVE FALHA ABERT
		DO FCHrot_fat
		RETURN(.f.)
	ENDIF



	*****************************************************************
	* 				Inicio Verificacao de Requisitos				*
	*****************************************************************
	IF TYPE("LNecf") = "U"
		LNecf	=	0
	ENDIF
	LSsitRequerida = ""
	DO CASE
		CASE LSsolicitante = "CAIXA"				&& OBJ_ECF
			LSsitRequerida =  "o"
		CASE LSsolicitante = "RECUPERACAO"			&& OBJ_ECF
			LSsitRequerida =  "AIMo"
		CASE LSsolicitante = "IMPORTACAO"			&& SCGC008
								&& REGISTRO JA E PASSADO PASICIONADO
	ENDCASE
	CLEAR TYPEAHEAD

	SELE orcament
	
	CLEAR TYPEAHEAD

	LNregvolta = RECNO()



	IF orcament.valor = 0
		IF !fox_alert("Orcamento com VALOR = 0. [ Continua ? ]")
			DO FCHrot_fat
			RETURN(.f.)
		ENDIF
	ENDIF




	*----------------------------------------------------------------*
	IF LSsolicitante <> "IMPORTACAO"
		IF !NFverClasOSI(orcament.empresa,orcament.orcamento)
			DO FCHrot_fat
			RETURN(.F.)
		ENDIF
	ENDIF

	*----------------------------------------------------------------*

	IF LSsolicitante <> "IMPORTACAO"
		IF !NFchqLiberCred(orcament.empresa,orcament.orcamento)
			DO FCHrot_fat
			RETURN(.F.)
		ENDIF
	ENDIF

	*----------------------------------------------------------------*


	SELE orcament

	*****************************************************************
	* 				Fim Informacoes Complementares
	*****************************************************************
	LFretorno = .t.




	IF LSsolicitante <> "IMPORTACAO"
		DO SVD0205.spr with;
			 orcament.empresa,orcament.orcamento,LFretorno

	ENDIF

	IF LFretorno
		LFretorno = NFProcessFat(orcament.empresa,;
					 orcament.orcamento,LSsolicitante)
	ENDIF


	DO FCHrot_fat
	UNLOCK ALL
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GYE           NFregEnvioFat VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    3    º
*       º Variable:            NFregEnvioFat                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      136                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gye     &&  NFregEnvioFat VALID
#REGION 5
return
*---------------------------------------------------------------*
FUNCTION  NFregEnvioFat
PARAMETERS LNemp,LNorcamento
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Alterar o STATUS do orcamento e dos itens
	*			para "o" que equivale a enviado para faturamento
	*
	*------------------------------------------------------------*
	* COMENTARIO..: O status "o" ‚ verificado com requisito no
	*    processo que efetiva o faturamento				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LNorcamento:
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	************************************
	=UPtransacao("INICIAR")
	************************************
	LFflgtrans = .t.

	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcamento,6)

	IF orcament.flgtransac = .f.
		DO OBJ_MENS.SPR WITH " O orcamento Selecionado Sofreu" +;
		" Alteracoes que Afetam Valores e Nao Foi Recalculado." +;
		CHR(13)+;
		" Reedite os Itens e Grave para Forcar o Calculo."
		RETURN(.f.)
	ENDIF

	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+orcament.tipo
	IF !FOUND()
		SEEK 's'+orcament.tipo
	ENDIF
	IF !found()
		SELECT orcament
		RETURN(.f.)
	ENDIF
	
	SELECT  orcatmp
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	SET NEAR OFF

	LFflgtrans = .F.  && Se nenhum item for processado no laco
					  && o processo deve ser rejeitado

	DO WHILE !EOF() AND LNemp 		= orcatmp.empresa ;
					AND LNorcamento = orcatmp.orcamento
		***  NAO PROCESSAR ITENS CANCELADOS
		IF LEFT(orcatmp.situacao,1) $ "YykeZ"
			SKIP
			LOOP
		ENDIF
		LFflgtrans = .T.

		***** SO SERA PROCESSADO QDO TODOS OS ITENS SE ENCONTRAREM EM
		***** SITUACAO DE CANCELAMENTO OU PRONTOS P/ FATURAR
		IF !(LEFT(orcatmp.situacao,1) $ "Mo") && OSI e FECHADO
			LFflgtrans = .F.
			EXIT
		ENDIF
		*----------------------------------------------------------*
		IF tipooper.movestq = "S"
	    	SELECT orcatmp
			IF REGLOCK()
			   REPLACE situacao WITH "o"+RIGHT(orcatmp.situacao,1)
			ELSE
				LFflgtrans = .F.
				EXIT
			ENDIF
			SELECT  orcatmp
		ELSE
	    	SELECT orcatmp
			IF REGLOCK()
			   REPLACE situacao WITH "o"+RIGHT(orcatmp.situacao,1)
			ELSE
				LFflgtrans = .F.
				EXIT
			ENDIF
		ENDIF
		SELE orcatmp
		SKIP
	ENDDO
	IF !LFflgtrans
		SELECT orcament
		RETURN(.f.)
	ENDIF			
	SELECT orcament
	REPLACE situacao WITH "o"+RIGHT(situacao,1)
	************************************
	=UPtransacao("TERMINAR")
	************************************
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GYL           antNFProcessFat VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    4    º
*       º Variable:            antNFProcessFat                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      137                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gyl     &&  antNFProcessFat VALID
#REGION 5
return
*---------------------------------------------------------------*
FUNCTION antNFProcessFat
PARAMETERS LNemp,LNorcamento,PrmSolicitante
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Controle o Processo de Faturamento
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LNorcamento:
	*		PrmSolicitante..: Identifica os Pontos em que esta
	*				 rotina pode ser chamada
	*			   		PrmSolicitante = "VENDEDOR"
	*					PrmSolicitante = "CAIXA"
	*					PrmSolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					PrmSolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					PrmSolicitante = "IMPORTACAO"		&& SCGC008
	* 					PrmSolicitante = "RECUPERACAO"
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	*********************************************************
	*---->   (Preparacao para controle de SATUS DO PROCESSO
	*********************************************************	

	PRIVATE FlgImpFatura

	PRIVATE LNnfinicio    , LNnffim
	PRIVATE LNnfsrvIni    , LNnfsrvFim
	PRIVATE LNCtrlCpmIni, LNCtrlCpmFim
	PRIVATE LNnfCopInicio , LNnfCopFim
	PRIVATE LNSrvCopIni , LNSrvCopFim


	PRIVATE LNnroNF, LNNfServico, LNCtrlCpm
	PRIVATE LNNFCop, LNnfSrvCop

    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO
	PRIVATE LNcupom
	PRIVATE LStp_process
	PRIVATE datanf,horanf,LsOrientacao
	PRIVATE LFabrecupom				&& FLAG PARA MANDAR ABIR CUPOM
	PRIVATE LFservico				&& CASO EXISTA SERVICO (TP_MERCAD = 7)
	PRIVATE LFproduto 				&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
	PRIVATE LFipi    				&& CASO EXISTA IPI > 0

	*********************************************************	
	PRIVATE LFretorno
	LFretorno = .T.

	STORE 0  TO LNnfinicio ,LNnffim
	STORE 0  TO LNnfsrvIni ,LNnfsrvFim
	STORE 0  TO LNCtrlCpmIni, LNCtrlCpmFim
	STORE 0  TO LNnfCopInicio , LNnfCopFim
	STORE 0  TO LNSrvCopIni , LNSrvCopFim
	STORE 0  TO LNnroNF, LNNfServico, LNCtrlCpm
	STORE 0  TO LNNFCop, LNnfSrvCop
	

	STORE 0  TO LNcupom
	STORE "" TO LStp_process
	STORE {} TO datanf
	STORE "" TO horanf,LsOrientacao
    STORE .F. TO LFGerNF,LFGerNFS


	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcamento,6)

	IF orcament.flgtransac = .f.
		DO OBJ_MENS.SPR WITH " O orcamento Selecionado Sofreu" +;
		" Alteracoes que Afetam Valores e Nao Foi Recalculado." +;
		CHR(13)+;
		" Reedite os Itens e Grave para Forcar o Calculo."
		RETURN(.f.)
	ENDIF
	*----------------------------------------------------------------*
	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+orcament.tipo
	IF !FOUND()
		SEEK 's'+orcament.tipo
	ENDIF
	IF !found()
		SELECT orcament
		RETURN(.f.)
	ENDIF
	*---------------------------------------------------------*
	*   (Fim Preparacao para controle de SATUS DO PROCESSO
	*---------------------------------------------------------*



	LFservico	= .F.		&& CASO EXISTA SERVICO (TP_MERCAD = 7)
	LFproduto 	= .F.		&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
	LFIPI    	= .F.		&& CASO EXISTA IPI > 0
	*---------------------------------------------------------*

	=W_DEFPROC("NOTA.SPR")
	IF !NFchq_Final((orcament.empresa),(orcament.orcamento),;
				(PrmSolicitante),LFservico,LFproduto)
	    SELE orcament
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*
	* 				Inicio  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*

	
	IF !NFBlocEmpresa(orcament.empresa,PrmSolicitante)
	    SELE orcament
		RETURN(.F.)
	ENDIF


	*---------------------------------------------------------------*

	LFflgtrans 		= .t.
	m.LNalqicms 	= 0		&& aliquota de icms
	m.tot_fatura 	= 0		&& acumula valore de varias notas pra duplicatas


	m.nota   = 0   && utilizados para atualizar Orcamento
	m.cupom  = 0   && utilizados para atualizar Orcamento

	*---------------------------------------------------------------*
	* 		No trecho seguinte sao definidor DATA,HORA,NUMERO DE NOTA
	*	E NUMERO DE CUPOM sendo que estes dados ja vem definido no
	*	registro do orcamento quando esta IMPORTANDO ja no processo
	*	operacional normal rotinas sao ativadas para atribuir valores
	*	a estes dados
	*---------------------------------------------------------------*
	

		
	IF !NF_DefFat(PrmSolicitante)
   		SELE orcament
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*
	*  ESTA CHAMADA ESTA PROVOCANDO ESTOURO DE PILHA DE PROCESSOS
	* ATE SEGUNDA ORDEM EVITA-SE O ANIHAMENTO EXESSIVO TROCANDO A
	* CHAMADA PELO CODIGO DIRETO
	*--------------------------------------------------------------*

*	IF !NFGeraDocFiscais(orcament.empresa)
*   		SELE orcament
*		RETURN(.F.)
*	ENDIF

*FUNCTION NFGeraDocFiscais
*PARAMETERS PrmEmpresa

	DO CASE
		CASE orcament.empresa = 6

			IF  "CUPOM" $ LStp_proces
				LsOrientacao = "PRODUTO/SERVICO"
				*--------------------------------------------*

				IF !ULGerCupom()
					RETURN(.F.)
				ENDIF
			ENDIF


			IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
				LsOrientacao = "SERVICO"
				*--------------------------------------------*
				IF !ULGerServicoNf()
					RETURN(.F.)
				ENDIF
			ENDIF


			IF  "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
				LsOrientacao = "PRODUTO/SERVICO"
				IF  "NF SERVICO" $ LStp_proces
					LsOrientacao = "PRODUTO"
				ENDIF
				*--------------------------------------------*
				IF !ULGerNFSU()
					RETURN(.F.)
				ENDIF
			ENDIF





		CASE orcament.empresa <> 6
			IF  "CUPOM" $ LStp_proces
				LsOrientacao = "PRODUTO/SERVICO"
				*--------------------------------------------*
				IF !ULGerCupom()
					RETURN(.F.)
				ENDIF
			ENDIF

			IF  "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
				LsOrientacao = "PRODUTO/SERVICO"
				*--------------------------------------------*
				IF !ULGerNFSU()
					RETURN(.F.)
				ENDIF
			ENDIF
	ENDCASE


*RETURN(.T.)







	*---------------------------------------------------------------*
	* 				Fim  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*


	=NFatlzOrcament()


	*----------------------------------------------------------------*
	*     O ajuste no sistema para registrar duplicatas para opera‡äes
	*  A VISTA e Para CARTåES.
	*    Como a Implanta‡Æo da VersÆo nas Filiais ocorre de maneira
	*  gradativa ‚ necess rio direcionar para rotina adequada a situa‡Æo
	*  da filial sendo:
	*    FILIAL ATUALIZADA   => CRgeradupl
	*    FILIAL N.ATUALIZADA => CRnrmgeradupl
	*----------------------------------------------------------------*


 	=W_DEFPROC("DUPLICAT.spr")

	DO CASE

		CASE  orcament.empresa = 10
			IF  dt_fat < {26.03.2008}
				DO  CRidlate26geradupl WITH;
					 (orcament.empresa),(orcament.orcamento)
			ELSE
			
				DO  CRIDLApos26geradupl WITH ;
				    (orcament.empresa),(orcament.orcamento)
			ENDIF

		CASE dt_fat >= {12.03.2008}
				DO  CRgeraDE12MAR08 WITH ;
				    (orcament.empresa),(orcament.orcamento)

		CASE dt_fat >= {10.03.2008} AND ;
			(orcament.empresa = 01 or orcament.empresa = 02)		
				DO  CRgeraDE12MAR08 WITH ;
				    (orcament.empresa),(orcament.orcamento)
		otherwise
			DO  CRgeraATE10MAR08 WITH ;
			     (orcament.empresa),(orcament.orcamento)
	ENDCASE



	*----------------------------------------------------------------*
    *     Registrar Comando para sistema de Caixa
	*----------------------------------------------------------------*

	IF !(PrmSolicitante $ "IMPORTACAO/RECUPERACAO")
		DO CASE
    		CASE "CUPOM" $ LStp_process
				=NFRgAvisoCaixa((LNemp), (LNCtrlCpmIni))
	    	CASE "NOTA" $ LStp_process
				=NFRgAvisoCaixa((LNemp), (LNnfinicio))
	    	CASE "NF SERVICO" $ LStp_process
				=NFRgAvisoCaixa((LNemp), (LNnfsrvIni))
		ENDCASE
	ENDIF


	*----------------------------------------------------------------*

	SELECT orcament
	IF wp_dtsys = wp_dtoper
		IF 	!UPtransacao("TERMINAR")
			WAIT WINDOW "TRANSACAO PERMANECEU ABERTA. VER SUPORTE."
		ENDIF			
	ENDIF
	*---------------------------------------------------------------*
	* 				Fim  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*

	*---------------------------------------------------------------*
	* 				Inicio ---- Impressao  ----
	*---------------------------------------------------------------*



	LFretorno = .T.






	IF  PrmSolicitante = "IMPORTACAO"

		=UNFempmarca(4,LStp_proces,LSOrientacao)

		wp_msg = "Faturamento Concluido "
		WAIT WINDOW wp_msg NOWAIT
	    RETURN(.T.)
	ENDIF



	IF  PrmSolicitante = "RECUPERACAO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		IF  "COPIA" $ LStp_proces
	       LFretorno = ;
		    	NFProcessCopia(orcament.empresa,LNCtrlCpmIni,;
		    	    PrmSolicitante,"ROTINA FATURAMENTO",.T.,.T.)
		ENDIF

	    RETURN(LFretorno)

	ENDIF


	IF LStp_proces $ "NOTA-CUPOM-NF SERVICO-NOTA/NF SERVICO";
	    OR "COPIA" $ LStp_proces


		*----------------------------------------------------------------*
		wp_msg = "Imprimindo NOTA/CUPOM Refrente OSI: "+;
							 STR(orcament.orcamento,6)
		WAIT WINDOW wp_msg NOWAIT
		*----------------------------------------------------------------*

		=W_DEFPROC("NOTA.SPR")

		*---------------------------------------------------------*
		*  DESVIO PARA NOVO LAYOUT DE NOTA DE 2009
		*---------------------------------------------------------*

		FlgImpFatura =  NF_03ImpFatura(;
				(orcament.empresa),(orcament.orcamento),(LStp_process),;
				(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
				(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			


		=W_DEFPROC("rotinas.spr")

		IF FlgImpFatura



			*-------------------------------------------------*
			*  DEFINIR SOLICITACAO DE COPIA
			*-------------------------------------------------*

			IF  "COPIA" $ LStp_proces

 		        * LFretorno = ;
		    	*NFProcessCopia(orcament.empresa,LNCtrlCpmIni,;
		    	*    PrmSolicitante,"ROTINA FATURAMENTO",.T.,.T.)


 		      LFretorno = ;
		    	NF_02ImpCopia(PrmSolicitante,LNCtrlCpmIni)

			ELSE
				=NF_aviso(orcament.Empresa,LNNfinicio,LNCtrlCpmIni,;
						PrmSolicitante,LStp_proces)
		
			ENDIF

		ELSE

	    	WAIT WINDOW "Houve Falha no Impressao do Doc.Fiscal!!!!"
			LFretorno = .F.

		ENDIF
	ENDIF


	*----------------------------------------------------------------*
	wp_msg = "Faturamento Concluido "
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*

RETURN(LFretorno)







*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GYM           NF_DefFat VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    5    º
*       º Variable:            NF_DefFat                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      138                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gym     &&  NF_DefFat VALID
#REGION 5
return
*---------------------------------------------------------------*
*  Define numero para faturamento nomal, ou seja, Nota Fiscal serie
* Unica e Cupom
*---------------------------------------------------------------*
FUNCTION NF_DefFat
PARAMETERS PrmSolicitante

	=W_DEFPROC("NOTA.SPR")


	*---------------------------------------------------------*

	IF PrmSolicitante <> "IMPORTACAO"
		m.datanf =	wp_dtoper    && REGISTRA A DATA DA GERACAO DA NF
	ELSE
		m.datanf = orcament.dt_fat    && REG. DATA DA GERACAO DA NF
	ENDIF


	*--------------------------------------------------------*
	

	DO CASE
		CASE orcament.empresa = 6 and (orcament.orcamento = 49275 or ;
		                               orcament.orcamento = 49546)
			IF !NF_02DefProcess((orcament.empresa),(orcament.tipo),;
					(LFproduto),(LFservico),(LFipi),(m.datanf),;
					LStp_process,clienc.tp_pessoa,clienc.tp_inscr,;
					clienc.inscricao,PrmSolicitante)
	  				SELE orcament
				RETURN(.F.)
			ENDIF

		CASE m.datanf < {30.09.2006}
			IF !NF_01DefProcess((orcament.empresa),(orcament.tipo),;
					(LFproduto),(LFservico),;
					LStp_process,PrmSolicitante)
	  				SELE orcament
				RETURN(.F.)
			ENDIF
		OTHERWISE
			IF !NF_02DefProcess((orcament.empresa),(orcament.tipo),;
					(LFproduto),(LFservico),(LFipi),(m.datanf),;
					LStp_process,clienc.tp_pessoa,clienc.tp_inscr,;
					clienc.inscricao,PrmSolicitante)
	  				SELE orcament
				RETURN(.F.)
			ENDIF
	ENDCASE



	IF PrmSolicitante <> "IMPORTACAO"
		*---------------------------------------------------------*
		STORE 0  TO LNnroNF, LNNfServico, LNCtrlCpm
		STORE 0  TO LNNFCop, LNnfSrvCop,LNcupom
		*---------------------------------------------------------*

		=W_DEFPROC("NOTA.SPR")
		IF !NF_02NroNota((orcament.empresa),(LStp_process),;
				LNnroNF, LNNfServico, LNCtrlCpm,;		
				LNNFCop, LNnfSrvCop,LNcupom)
		    WAIT WINDOW ;
		    	"Nao foram atribuidos NUMEROS AO REGISTRO DE NOTA/CUPOM"
    		SELE orcament
			RETURN(.F.)
		ENDIF
		m.datanf		=	wp_dtoper    && REGISTRA A DATA DA GERACAO DA NF
		m.horanf		=	time()		 && REGISTRA A HORA

	ELSE
		STORE 0  TO LNnroNF, LNNfServico, LNCtrlCpm
		STORE 0  TO LNNFCop, LNnfSrvCop,LNcupom

		m.datanf	   = orcament.dt_fat    && REG. DATA DA GERACAO DA NF
		m.horanf	   = orcament.hora_fat  && REG. HORA - nao inf. impor

		LNnroNF		   = orcament.nota - 1
		LNCtrlCpm = orcament.nota - 1
		LNNfServico = orcament.NFSERVICO - 1
		LNcupom		   = orcament.cupom
		LNNFCop     = 0
		LNnfSrvCop  = 0
	ENDIF



	*---------------------------------------------------------*

	STORE LNnroNF        +1 TO LNnfinicio
	STORE LNNfServico    +1	TO LNnfsrvIni
	STORE LNCtrlCpm      +1 TO LNCtrlCpmIni

	STORE LNnroNF  		TO LNnffim
	STORE LNNfServico	TO LNnfsrvFim
	STORE LNCtrlCpm  	TO LNCtrlCpmFim


	STORE LNNFCop     TO LNnfCopInicio , LNnfCopFim
	STORE LNnfSrvCop  TO LNSrvCopIni  , LNSrvCopFim

	*---------------------------------------------------------*

	IF LNnroNF+LNNfServico+LNCtrlCpm+;
		 LNNFCop+LNnfSrvCop+LNcupom = 0
		   WAIT WINDOW ;
		   	"Nao foram atribidos NUMEROS AO REGISTRO DE NOTA/CUPOM"
	   		SELE orcament
			RETURN(.F.)
	ENDIF
	*---------------------------------------------------------*
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GYN           NFchq_Final VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    6    º
*       º Variable:            NFchq_Final                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      139                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gyn     &&  NFchq_Final VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NFchq_Final
PARAMETERS LNemp,LNorcamento,LSsolicitante,LFservico,LFproduto
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Consite a OSI/ITENS de Controlar o Faturamento
	*------------------------------------------------------------*
	* COMENTARIO..: 	Antes de Liberar para Faturamento pode
	*				ser feita  a consistencia dos dados da osi
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcamento....: Nro do Orcamento para Consistir
	*		LSsolicitante..: Informacao ultizada para orientar
	*						a Baixa de saldo indicando se
	*						deve ser cancelada reservas e......
	*			   		LSsolicitante = "VENDEDOR"
	*					LSsolicitante = "CAIXA"
	*					LSsolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					LSsolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					LSsolicitante = "IMPORTACAO"	&& SCGC201A
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE FCHvlr,FCHqtde
	PRIVATE	LSret1_cita, LSret2_cita
	
	
*	IF	LSsolicitante = "IMPORTACAO"
*		RETURN(.T.)
*	ENDIF


	*-----------------------------------------------------------*
	*  Esta chamada a EMGet_UF nao tem efeito logico e sim
	* estrutural forcando o instanciamento de EMPRESA evitando
	* que este estaciamento ocorra em um nivel mais profundo do
	* aninhamento de rotinas o que estava provocando o erro
	* (DO nesting too deep). Se forcamos a criacao nesti nivel
	* evitamos o erro
	*-----------------------------------------------------------*

	=W_DEFPROC("empresa.spr")
	=EMVerifyInst()

	=W_DEFPROC("grfiscal.spr")
	=GFVerifyInst()

	=W_DEFPROC("notaite.spr")
	=IEVerifyInst()

	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	STORE "" TO LSret1_cita, LSret2_cita
	*------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "Nao Foi Possivel Localizar Orcamento."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE tipooper
	SET ORDER TO TAG tipo
	SEEK 's'+orcament.tipo
	IF !FOUND()
		SEEK 'S'+orcament.tipo
	ENDIF
	IF !FOUND()
		DO OBJ_MENS.SPR WITH ;
	   		"Nao foi possivel classificar a OPERACAO. PROCURE SUPORTE..."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------------*
	*	Reposiciona clienc
	*------------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcamentoi,6)
	IF !FOUND()
		WAIT WINDOW "Dados do Cliente Referente Orcamento ";
				+STR(LNorcamento,6)+" Nao Estao Disponiveis."	
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF



	=W_DEFPROC("CLIENTES.SPR")
	IF !CLVld_CPF_CNPJ( clienc.cliente )
		WAIT WINDOW "CPF/CNPJ Invalido <ENTER>"
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF


	*------------------------------------------------------------------*
	*     Vendas em CHEQUE A PRAZO (3) OU DUPLICATA (4) o cliente deve
	* ser cadasatrado
	*------------------------------------------------------------------*
	SELE clientes
	SET ORDER TO TAG cliente
	SEEK clienc.cliente

	*--------------------------------------------------------------*
	*  Vendas Parceladas no Cartao Sao Liberadas Sem Cadastro      *
	*			 orcament.tp_parcela <> 4						   *
	*--------------------------------------------------------------*
	IF !FOUND()
		IF orcament.tp_parcela > 1 and orcament.tp_parcela <> 4 and ;
								   orcament.tp_parcela <> 5
			WAIT WINDOW "Cliente deve ser Cadastrado . Execute <Cad> "
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.F.)
		ENDIF
	ENDIF


*-----------------------------------*

	IF orcament.tp_parcela = 6 && VENDOR


		IF LSsolicitante = "IMPORTACAO"	
			m.dt_emi = orcament.dt_fat
		ELSE
			m.dt_emi = wp_dtoper
		ENDIF

		=W_DEFPROC("duplicat.spr")
		IF !CRVerifTxsVendor(orcament.Empresa,;
							 m.Dt_Emi,;
							 orcament.Prazo)
			WAIT WINDOW ;
				"Taxas de Vendor nao Cadastradas <ENTER>  "
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.F.)
		ENDIF
	ENDIF



	IF FOUND()
		IF clientes.cliente = 0
			WAIT WINDOW ";
			  Existe Cadastro Cliente com CPF = 0.<Tente Novamente!>  "
	
			=REGLOCK(.T.)
			=edithand('APAGA')
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.F.)
		ENDIF
	ENDIF



	SELE orcatmp
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	SET NEAR OFF
	IF orcament.empresa <> orcatmp.empresa ;
		OR orcament.orcamento <> orcatmp.orcamento
		DO OBJ_MENS.SPR WITH ;
	   		"Nao foi possivel Localizar Itens para Faturar.."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*********************************************************	
	m.FCHvlr     = 0		&& P/ CONFERIR FECHAMENTO
	m.FCHqtde    = 0        && P/ CONFERIR FECHAMENTO
	LFservico	= .F.		&& CASO EXISTA SERVICO (TP_MERCAD = 7)
	LFproduto 	= .F.		&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
	LFIPI    	= .F.		&& CASO EXISTA IPI
    LSchq_CFO   = ""        && Se os Itens nao Apresentarem variacao
                            && de CFO => este e transportado para
                            && campo padrao
	m.Vlr_Subst = 0        && Verifica Destaque de ICMS substituicao FECHAMENTO

	*********************************************************


	DO WHILE !eof() AND LNorcamento = orcatmp.orcamento ;
					AND LNemp 		= orcatmp.empresa

        LSchq_CFO   = orcatmp.cfo


		***  VERIFICA SE CANCELAMENTO FOI INCLUIDO NA DESCRICAO

		IF LEFT(orcatmp.situacao,1) $ "Yy" ;
           and  !("CANCELA" $ UPPER(orcatmp.descricao))

		    DO OBJ_ALER.SPR WITH ;
			   "Existem itens com cancelamento incompleto. Verifique" +;
			   CHR(13)+" <ENTER>  "
			LFretorno	=	.F.

			EXIT
		ENDIF



		***  NAO PROCESSAR ITENS CANCELADOS, ALEM DO FECHAMENTO

		IF LEFT(orcatmp.situacao,1) $ "YykeZ"
			SKIP
			LOOP
		ENDIF

		***** SO SERA PROCESSADO QDO TODOS OS ITENS SE ENCONTRAREM EM
		***** SITUACAO DE CANCELAMENTO OU PRONTOS P/ FATURAR
		Ltmpst = LEFT(orcatmp.situacao,1)

		IF (LSsolicitante = "FATURISTA RESERVA" AND !(Ltmpst $ "I")) OR ;
		   (LSsolicitante = "FATURISTA SIMPLES" AND !(Ltmpst $ "A")) OR ;
		   (LSsolicitante = "VENDEDOR" 			AND !(Ltmpst $ "M")) OR ;
		   (LSsolicitante = "CAIXA" 			AND !(Ltmpst $ "o")) OR ;
		   (LSsolicitante = "IMPORTACAO"		AND !(Ltmpst $ "A"))
			LFretorno	=	.F.
			EXIT
		ENDIF
		m.FCHvlr  = m.FCHvlr  + orcatmp.precofinal
		m.FCHqtde = m.FCHqtde + orcatmp.qtde
		IF orcatmp.tp_mercad = 7		&& EXISTE SERVICO
			LFservico	= .T.		&& CASO EXISTA SERVICO (TP_MERCAD = 7)
		ELSE
			LFproduto	= .T.		&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
		ENDIF
		IF orcatmp.vlripi > 0
			LFipi = .t.
		ENDIF
		********************************************************


		IF EMPTY(ALLTRIM(orcatmp.cst))
		    DO OBJ_ALER.SPR WITH ;
			   "Existem itens sem CST (Codigo de Situacao Tributaria.)" +;
			   CHR(13)+;
			   "Verificar Tabela de Situacao Tributaria <ENTER>  "
			LFretorno	=	.F.
			EXIT
		ENDIF

		IF "CANCELA" $ UPPER(orcatmp.descricao)
		    DO OBJ_ALER.SPR WITH ;
			   "Existem itens com cancelamento incompleto. Verifique" +;
			   CHR(13)+" <ENTER>  "
			LFretorno	=	.F.
			EXIT
		ENDIF

		*----------------------------------------------------------*
		*  		A situacao "O" indica que o item ja foi faturado
		*  A permissao de reprocessar visa corrigir problemas por
		*  interrupcao de faturamento anterior (TRANSACAO)
		*----------------------------------------------------------*
	    IF !ULbaixa_Saldo(LSsolicitante) ;
	    	AND !(LEFT(orcatmp.situacao,1) $ "O")
			LFretorno	=	.F.
			EXIT
		ENDIF


		SELE orcatmp
		SKIP
	ENDDO

  	SELECT orcament
	=REGLOCK(.T.)
	REPLACE orcament.cfo with LSchq_CFO



	m.LNfch  = m.FCHvlr + (m.FCHqtde / 100)

	DO CASE
		CASE !LFretorno
		   	WAIT WINDOW "Os itens apresentam irregularidades. "
		CASE  LNfch <> orcament.fecha
	   		WAIT WINDOW ;
	   				"Os itens nao batem com valor de fechamento.  <ENTER> "
			LFretorno	=	.F.
	ENDCASE
	*--------------------------------------------------------------*


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123GYO           NF_01DefProcess VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    7    º
*       º Variable:            NF_01DefProcess                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      140                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123gyo     &&  NF_01DefProcess VALID
#REGION 5
return
*---------------------------------------------------------------*



FUNCTION NF_01DefProcess
PARAMETERS PrmEmpresa,LStipo,LFproduto,LFservico,LStp_process,;
     PrmSolicitante


	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Definir o processo que orienta o faturamento
	*		em relacao a NOTA e ou ECF
	*------------------------------------------------------------*
	* COMENTARIO..: Exitem diferencas de tratamento do ECF/NOTA
	*			entre as filiais que implicam na emissao ou nao
	*			de CUPOM ou NOTA
	*		LStp_process...: Processo definido em NF_02DefProcess
	*				LStp_proces	= "CUPOM"
	*				LStp_proces	= "CUPOM/COPIA EM NOTA"
	*				LStp_proces	= "CUPOM/COPIA EM NF SERVICO"
	*				LStp_proces	= "CUPOM/COPIA EM NOTA/COPIA EM NF SERVICO"
    *
	*				LStp_proces	= "NOTA"
	*
	*				LStp_proces	= "NF SERVICO"
	*
	*				LStp_proces	= "NOTA/NF SERVICO"
    *
	*				LStp_proces	= "REC.CUPOM"
	*				LStp_proces	= "REC.NOTA"
	*				LStp_proces	= "REC.NF SERVICO"
	*				LStp_proces	= "REC.NOTA/REC.NF SERVICO"
	*   Existem dois pocessos extras definidos na rotina que solicita
	*  copia de cupom.
	*					LStp_proces	= "COPIA CUPOM EM NOTA"
	*					LStp_proces	= "COPIA CUPOM EM NF SERVICO"
	**********************************************************************
	*  INICIO DESCRICAO DE PASSOS
	*	WP_ECF = [S]	= ECF CONECTADO EM PROCESSO NORMAL
	*			 [R]	= ECF CONECTADO EM PROCESSO DE RECUPERACAO DE DADOS	
	*
	*			 [I]	= ECF CONECTADO SEM AUTORIZACAO P/ SERVICO
	*			 [Q]	= ECF CONECTADO SEM AUTORIZACAO P/ SERVICO EM
	*						 RECUPERACAO DADOS
	*
	*			 [N]	= ECF NAO CONECTADO
	*			 [E]	= ECF NAO CONECTADO EM PROCESSO DE RECUPERACAO DADOS
	*	
	* 		Se for imprimir CUPOM (FOR (VENDA INTERNA A CONTRIBUITE
	*				ESTADUAL(1) OU INSCRITO(2) OU NAO INSCRITO(3))  OU VENDA
	*				EXTERNA PARA CONTRIBUINTE NAO INSCRITO(3))
	*	=> LER NUMERO DO CUPOM ; LER ULTIMO REGISTRO DE CUPOM (EMPRESA) ;
	*	   	DIFERENCIAR NRO. REGISTRO DO CUPOM DO NRO DE NF . COM + 100000
	**********************************************************************
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNtipo.........: Tipo da Operacao
	*		LFproduto......: Flag indicando existencia de produto
	*		LFservico......: Flag indicando existencia de servico
	*						para faturar
	*						.T. => Sera faturado servico
	*						.F. => Nao Sera faturado servico
	*------------------------------------------------------------*
	*  RETORNO.....:
	*			LStp_process : Identificacao do processo
	*
	*					FUNCAO RETORNA .T. ou .F.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSecf
	PRIVATE LSmarca

	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	SELE parametr
	GO TOP
	LSecf		= parametr.usa_ecf

	LSmarca		= parametr.tipo_ecf

	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 's'+LStipo
	IF !FOUND()
		SEEK 'S'+LStipo  	
	ENDIF
	IF !FOUND()
		DO OBJ_MENS.SPR WITH ;
	   		"Nao foi possivel Localizar Tipo de Operacao (TIPOOPER)."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	*<<<<<<<<<<<<<<< DEFININDO MODELO DO PROCESSO FATURAMENTO >>>>>>>>>>>>>
	DO CASE
		CASE LSecf $ "I/Q/S/R"	
			DO CASE
				CASE tipooper.ch_opera <> "1"
					LStp_proces	= "NOTA"
			    CASE orcament.tp_parcela = 4 or orcament.tp_parcela = 5
					LStp_proces	= "CUPOM"
				CASE tipooper.ch_contr $ "13"
					LStp_proces	= "CUPOM"
				CASE tipooper.ch_contr $ "4"    && REVENDEDOR
					LStp_proces	= "NOTA"
				CASE tipooper.ch_desti = "2" AND tipooper.ch_contr $ "2"
					LStp_proces	= "NOTA"
				OTHERWISE
					LStp_proces	= "NOTA"
			ENDCASE			
		CASE LSecf $ "N"	
			LStp_proces	= "NOTA"
		OTHERWISE
			DO OBJ_MENS.SPR WITH " Nao esta definido Parametro para " +;
				"Forma de tratamento do ECF/FATURAMENTO"
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
			
	ENDCASE

	*--------------------------------------------------------------*
	DO CASE
		CASE LStp_proces	= "CUPOM"
			IF PrmEmpresa = 6
				DO CASE
					CASE LFservico = .T. AND LFproduto = .T.
						LStp_proces	= ;
						   "CUPOM/COPIA EM NOTA/COPIA EM NF SERVICO"
					CASE LFservico = .T. AND LFproduto = .F.
						LStp_proces	= "CUPOM/COPIA EM NF SERVICO"
				ENDCASE
			ELSE
				DO CASE
					CASE LSecf $ "I/Q"	AND LFservico = .T.
						LStp_proces	= "CUPOM/COPIA EM NOTA"
					CASE tipooper.ch_contr $ "4"    && REVENDEDOR
						LStp_proces	= "CUPOM/COPIA EM NOTA"
					CASE tipooper.ch_desti = "2" AND tipooper.ch_contr $ "2"
						LStp_proces	= "CUPOM/COPIA EM NOTA"
				ENDCASE
			ENDIF
		CASE LStp_proces	= "NOTA"
			IF PrmEmpresa = 6
				DO CASE
					CASE LFservico = .T. AND LFproduto = .T.
						LStp_proces	= "NOTA/NF SERVICO"
					CASE LFservico = .T. AND LFproduto = .F.
						LStp_proces	= "NF SERVICO"
				ENDCASE
			ENDIF

	ENDCASE
	*--------------------------------------------------------------*
	IF LSecf $ "Q/R/E"	OR 	PrmSolicitante = "IMPORTACAO"
		LStp_proces	= "REC."+LStp_proces
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H01           ANTNF_02DefProcess VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    8    º
*       º Variable:            ANTNF_02DefProcess                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      141                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h01     &&  ANTNF_02DefProcess VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION ANTNF_02DefProcess
PARAMETERS PrmEmpresa,LStipo,LFproduto,LFservico,LFipi,;
		LDdatanf,LStp_process,PrmTpPessoa,PrmTpInscr,PrmInscricao,;
	     PrmSolicitante


	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Definir o processo que orienta o faturamento
	*		em relacao a NOTA e ou ECF
	*------------------------------------------------------------*
	* COMENTARIO..: Exitem diferencas de tratamento do ECF/NOTA
	*			entre as filiais que implicam na emissao ou nao
	*			de CUPOM ou NOTA
	*		LStp_process...: Processo definido em NF_02DefProcess
	*				LStp_proces	= "CUPOM"
	*				LStp_proces	= "CUPOM/COPIA EM NOTA"
	*				LStp_proces	= "CUPOM/COPIA EM NF SERVICO"
	*				LStp_proces	= "CUPOM/COPIA EM NOTA/COPIA EM NF SERVICO"
    *
	*				LStp_proces	= "NOTA"
	*
	*				LStp_proces	= "NF SERVICO"
	*
	*				LStp_proces	= "NOTA/NF SERVICO"
    *
	*				LStp_proces	= "REC.CUPOM"
	*				LStp_proces	= "REC.NOTA"
	*				LStp_proces	= "REC.NF SERVICO"
	*				LStp_proces	= "REC.NOTA/REC.NF SERVICO"
	*   Existem dois pocessos extras definidos na rotina que solicita
	*  copia de cupom.
	*					LStp_proces	= "COPIA CUPOM EM NOTA"
	*					LStp_proces	= "COPIA CUPOM EM NF SERVICO"
	**********************************************************************
	*  INICIO DESCRICAO DE PASSOS
	*	WP_ECF = [S]	= ECF CONECTADO EM PROCESSO NORMAL
	*			 [R]	= ECF CONECTADO EM PROCESSO DE RECUPERACAO DE DADOS	
	*
	*			 [I]	= ECF CONECTADO SEM AUTORIZACAO P/ SERVICO
	*			 [Q]	= ECF CONECTADO SEM AUTORIZACAO P/ SERVICO EM
	*						 RECUPERACAO DADOS
	*
	*			 [N]	= ECF NAO CONECTADO
	*			 [E]	= ECF NAO CONECTADO EM PROCESSO DE RECUPERACAO DADOS
	*	
	* 		Se for imprimir CUPOM (FOR (VENDA INTERNA A CONTRIBUITE
	*				ESTADUAL(1) OU INSCRITO(2) OU NAO INSCRITO(3))  OU VENDA
	*				EXTERNA PARA CONTRIBUINTE NAO INSCRITO(3))
	*	=> LER NUMERO DO CUPOM ; LER ULTIMO REGISTRO DE CUPOM (EMPRESA) ;
	*	   	DIFERENCIAR NRO. REGISTRO DO CUPOM DO NRO DE NF . COM + 100000
	**********************************************************************
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNtipo.........: Tipo da Operacao
	*		LFproduto......: Flag indicando existencia de produto
	*		LFservico......: Flag indicando existencia de servico
	*						para faturar
	*						.T. => Sera faturado servico
	*						.F. => Nao Sera faturado servico
	*------------------------------------------------------------*
	*  RETORNO.....:
	*			LStp_process : Identificacao do processo
	*
	*					FUNCAO RETORNA .T. ou .F.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSecf
	PRIVATE LSmarca

	*-----------------------------------------------------------*
	PRIVATE  LNCheque1Vlr,LNCheque2Vlr,LNCheque3Vlr,;
				 LNDinheiroVlr, LNCartaoVlr,LNTicketVlr,LNDuplicatVlr
	STORE 0 TO   LNCheque1Vlr,LNCheque2Vlr,LNCheque3Vlr,;
				 LNDinheiroVlr, LNCartaoVlr,LNTicketVlr,LNDuplicatVlr

	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	SELE parametr
	SET ORDER TO TAG EMPRESA
	SEEK PrmEmpresa
	IF !FOUND()
		GO TOP
	ENDIF
	LSecf		= parametr.usa_ecf
	LSmarca		= parametr.tipo_ecf

	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 's'+LStipo
	IF !FOUND()
		SEEK 'S'+LStipo  	
	ENDIF
	IF !FOUND()
		DO OBJ_MENS.SPR WITH ;
	   		"Nao foi possivel Localizar Tipo de Operacao (TIPOOPER)."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	*<<<<<<<<<<<<<<< DEFININDO MODELO DO PROCESSO FATURAMENTO >>>>>>>>>>>>>
	*-----------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	=ORVlr_e_FormPgto(PrmEmpresa,;
		  orcament.orcamento,;
		  LNCheque1Vlr,;
		  LNDinheiroVlr,;
		  LNCartaoVlr,;
		  LNDuplicatVlr)
	*-----------------------------------------------------------*
    * 1-DEFININE DOCUMENTO FISCAL PRINCIPAL
	*-----------------------------------------------------------*
	DO CASE
		CASE LSecf $ "I/Q/S/R"	
			DO CASE
				CASE LNCartaoVlr > 0
					LStp_proces	= "CUPOM"
				CASE tipooper.ch_opera <> "1"
					LStp_proces	= "NOTA"
				CASE PrmTpPessoa = 2	&& JURIDICA
					LStp_proces	= "NOTA"
				CASE PrmTpInscr  = 1   && ESTADUAL
					LStp_proces	= "NOTA"
				CASE tipooper.ch_contr $ "13"
					LStp_proces	= "CUPOM"
				CASE tipooper.ch_contr $ "4"    && REVENDEDOR
					LStp_proces	= "NOTA"
				CASE tipooper.ch_desti = "2" AND tipooper.ch_contr $ "2"
					LStp_proces	= "NOTA"
				OTHERWISE
					LStp_proces	= "NOTA"
			ENDCASE			
		CASE LSecf $ "N"	
			LStp_proces	= "NOTA"
		OTHERWISE
			DO OBJ_MENS.SPR WITH " Nao esta definido Parametro para " +;
				"Forma de tratamento do ECF/FATURAMENTO"
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
			
	ENDCASE

	*-----------------------------------------------------------*
    * 2-DEFININE DOCUMENTOS AUXILIARES (COPIA) / NF.SERVICO
	*-----------------------------------------------------------*
	*---------------------------------------------------------*
	* AS CAPAS DAS COPIAS SAO IMPORTADAS JUNTO COM AS CAPAS
	* DAS NOTAS CANCELADAS. SENDO ASSIM NA IMPORTACAO NAO SERA
	* FEITA GERACAO DE COPIAS PELA RORINA FATURAMENTO
	*---------------------------------------------------------*
	DO CASE
			CASE LStp_proces	= "CUPOM"


				IF PrmSolicitante <> "IMPORTACAO"

					IF PrmEmpresa <>  6
						*-----------------------------------------------*
						* COM USO DE ECF TERMICA DEFINIU-SE QUE SEMPRE
						* SERA EMITIDA COPIA PARA OS CUPOSN
						*-----------------------------------------------*
						LStp_proces	= LStp_proces+"/COPIA EM NOTA"

					ELSE
						*---------------------------------------------*
						* EM 28/03 ADOTOU-SE IMPRESSORA TERMICA
						* COM 1 SO VIA ENTAO PASSOU-SE A IMPRIMIR
						* NOTAS PARA TODAS OPERACOES
						*---------------------------------------------*
						IF  LDdatanf >= {28.03.2007} AND ;
							(LFipi= .T. OR LFproduto = .T.)
								LStp_proces	= LStp_proces+"/COPIA EM NOTA"

						ENDIF


						IF LFservico = .T.
							LStp_proces	= LStp_proces+"/COPIA EM NF SERVICO"
						ENDIF
	
					ENDIF
				ENDIF

			CASE LStp_proces	= "NOTA"

				IF PrmEmpresa = 6
					DO CASE
						CASE LFservico = .T. AND LFproduto = .T.
							LStp_proces	= LStp_proces+"/NF SERVICO"
						CASE LFservico = .T. AND LFproduto = .F.
							LStp_proces	= "NF SERVICO"
					ENDCASE
				ENDIF
	ENDCASE
	*--------------------------------------------------------------*
	IF LSecf $ "Q/R/E"	OR 	PrmSolicitante $ "RECUPERACAO"
		LStp_proces	= "REC."+LStp_proces
	ENDIF



	*---------------------------------------------------------------*
	*  NA IMPORTACAO NAO HA COMO SABER A SITUACAO DOS PARAMETROS
	* NO MOMENTO DO FATURAMENTO,SENDO ASSIM A DEFINICAO DO PROCESSO
	* E FEITA CONFORME O TIPO DE DOCUMENTO GERADO NO FATURAMENTO
	*---------------------------------------------------------------*
	* NO CASO DE COPIA ELAS SAO IMPORTAS JUNTO COM AS NOTAS CANCELADAS
	* E SOMENTE AS CAPAS
	*---------------------------------------------------------------*
	

	IF PrmSolicitante $ "IMPORTACAO"

		DO CASE
			CASE  orcament.nota >= 3000000 ;
			  AND orcament.nota <= 3999999
					LStp_proces	= "NOTA"

					IF   orcament.NFSERVICO >= 2000000 ;
					 AND orcament.NFSERVICO <  3000000
					   LStp_proces	= LStp_proces+"/NF SERVICO"
					ENDIF

			CASE  orcament.nota < 1000000  && 0 ---> 999999
					LStp_proces	= "NOTA"

					IF   orcament.NFSERVICO >= 2000000 ;
					 AND orcament.NFSERVICO <  3000000
					   LStp_proces	= LStp_proces+"/NF SERVICO"
					ENDIF

			CASE  orcament.nota < 2000000  && 1000000 ---> 2000000
					LStp_proces	= "CUPOM"

			OTHERWISE
					LStp_proces	= "NF SERVICO"
		ENDCASE
		LStp_proces	= "REC."+LStp_proces
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H0D           NF_02NroNota VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    9    º
*       º Variable:            NF_02NroNota                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      142                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h0d     &&  NF_02NroNota VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NF_02NroNota
PARAMETERS LNemp,LStp_process,LNnroNF, LNNfServico,;
			 LNCtrlCupom,LNNFCop, LNnfSrvCop, LNcupom

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LNnotaAnterior
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	DO  CASE
		CASE !("REC." $ LStp_proces)

			LNnroNF         = empresa.nota

			IF UPPER(empresa.emite_NFe) = "S"
				LNnroNF = LNnroNF + 3000000
			ENDIF



			LNNfServico  = empresa.ult_nfsrvc
			IF UPPER(empresa.emite_NFSe) = "S"
				LNNfServico = LNNfServico + 4000000

			ELSE
				IF LNNfServico < 2000000
					LNNfServico = LNNfServico + 2000000
				ENDIF
			ENDIF

			LNCtrlCupom = empresa.ult_cupom
			IF LNCtrlCupom < 1000000
				LNCtrlCupom = LNCtrlCupom + 1000000
			ENDIF

			LNcupom = 0
		OTHERWISE
			DO OBJ_3FAT.SPR WITH LNnroNF,LNNfServico,;
				LNCtrlCupom,LNNFCop,LNnfSrvCop,LNcupom,LStp_proces

			IF "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
				LNnroNF = LNnroNF - 1
			ENDIF
			IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
				LNNfServico = LNNfServico - 1
			ENDIF
			IF "CUPOM" $ LStp_proces
				LNCtrlCupom = LNCtrlCupom - 1
			ENDIF
	ENDCASE
	*--------------------------------------------------------------*


	IF "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
		SELE nota
		SET ORDER TO TAG nota
		SEEK STR(LNemp,3)+STR(LNnroNF+1,7)  && VER SE PROXIMO NUM JA GRAVADO
		IF FOUND()
		   	WAIT WINDOW "No. Nota ja emitida. "+STR(LNnroNF+1,7)
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
		ENDIF


		IF (LNnroNF > 1 AND LNnroNF <= 999999);
		   OR  ;
		   (LNnroNF > 3000001 AND LNnroNF <= 3999999)

			LNnotaAnterior = VAL(SUBS(STR(LNnroNF-1,7),2))
			SEEK STR(LNemp,3)+STR(LNnroNF-1,7) &&VER SE ULT NRO JA GRAVADO
			IF (LNnotaAnterior > 0) AND !FOUND()
			   	WAIT WINDOW "No. Nota anterior nao gravada. ";
							+STR(LNnroNF-1,7)
				IF !EMPTY(LSalias) AND USED(LSalias)
					SELECT &LSalias
				ENDIF
				RETURN(.f.)
			ENDIF
		ENDIF

	ENDIF
	IF "NF SERVISO" $ LStp_proces AND !("COPIA" $ LStp_proces)
		SELE nota
		SET ORDER TO TAG nota
		SEEK STR(LNemp,3)+STR(LNNfServico+1,7)
		IF FOUND()
		   	WAIT WINDOW "No.NF Servico ja emitida. "+STR(LNNfServico+1,7)
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
		ENDIF

		IF (LNNfServico > 2000001 AND LNNfServico <= 2999999) ;
		  OR ;
		   (LNNfServico > 4000001 AND LNNfServico <= 4999999)
			LNnotaAnterior = VAL(SUBS(STR(LNNfServico-1,7),2))
			SEEK STR(LNemp,3)+STR(LNNfServico-1,7)
			IF (LNnotaAnterior) > 0 AND !FOUND()
		   		WAIT WINDOW "No.Anterior NF Servico nao gravado. "+;
								STR(LNNfServico-1,7)
				IF !EMPTY(LSalias) AND USED(LSalias)
					SELECT &LSalias
				ENDIF
				RETURN(.f.)
			ENDIF
		ENDIF
	ENDIF
	IF "CUPOM" $ LStp_proces
		SELE nota
		SET ORDER TO TAG nota
		SEEK STR(LNemp,3)+STR(LNCtrlCupom+1,7)
		IF FOUND()
		   	WAIT WINDOW "No. Cupom ja emitido. "+STR(LNCtrlCupom+1,7)
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
		ENDIF
		
		IF (LNCtrlCupom > 1000001 AND LNCtrlCupom <= 1999999)
			LNnotaAnterior = VAL(SUBS(STR(LNCtrlCupom-1,7),2))
			SEEK STR(LNemp,3)+STR(LNCtrlCupom-1,7)
			IF (LNnotaAnterior) >0 AND !FOUND()
			   	WAIT WINDOW "No.Anterior Cupom nao gravado emitido. "+;
					STR(LNCtrlCupom-1,7)
				IF !EMPTY(LSalias) AND USED(LSalias)
					SELECT &LSalias
				ENDIF
				RETURN(.f.)
			ENDIF
		ENDIF
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H0L           NFFatura VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   10    º
*       º Variable:            NFFatura                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      143                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h0l     &&  NFFatura VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NFFatura
PARAMETERS 	LNemp,;
  			LNosi,;
  			LNnroNF,;
  			LNcupom,;
  			LStp_proces,;
  			LDdtnf,;
  			LShoranf,;
			LSsolicitante,;
			LNnffim,;
			PrmOrientacao
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar o Faturamento
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNosi..........: Nro da OSI para Faturar
	*		LNnroNF........: Numero  Inicial para Nota Fiscal
	*		LNcupom........: Numero do Cupo Relacionado a Nota
	*						No caso recuperacao ja vem informado
	*						caso contrario e determinado na
	*						abertura da nota
	*		LStp_process...: Processo definido em NFDefProcess
	*
	*              Antes de 15/03/2006
	*					LStp_proces	= "NOTA/CUPOM"
	*					LStp_proces	= "CUPOM"
	*					LStp_proces	= "NOTA"
	*					LStp_proces	= "REC.NOTA/CUPOM"
	*					LStp_proces	= "REC.CUPOM"
	*					LStp_proces	= "REC.NOTA"
	*              apos 15/03/2006
	*					LStp_proces	= "CUPOM"
	*					LStp_proces	= "CUPOM/COPIA EM NOTA"
	*					LStp_proces	= "CUPOM/COPIA EM NF SERVICO"
	*					LStp_proces	= "CUPOM/COPIA EM NOTA/NF SERVICO"
	*					LStp_proces	= "NOTA"
	*					LStp_proces	= "NF SERVICO"
	*					LStp_proces	= "NOTA/NF SERVICO"
	*					LStp_proces	= "REC.CUPOM"
	*					LStp_proces	= "REC.NOTA"
	*					LStp_proces	= "REC.NF SERVICO"
	*					LStp_proces	= "REC.NOTA/NF SERVICO"
	*					LStp_proces	= "COPIA CUPOM EM NOTA"
	*					LStp_proces	= "COPIA CUPOM EM NF SERVICO"
	*
	*		LDdtnf.........: Data para Registrar a Nota
	*		LShoranf.......: Hora para Registrar a Nota
	*		LSsolicitante..: Informacao ultizada para orientar
	*						a Baixa de saldo indicando se
	*						deve ser cancelada reservas e......
	*			   		LSsolicitante = "VENDEDOR"
	*					LSsolicitante = "CAIXA"
	*					LSsolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					LSsolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					LSsolicitante = "IMPORTACAO"		&& SCGC201A
	*			OBS: ("IMPORTACAO" tem comportamento igual a
	*				"FATURISTA SIMPLES", como a passagem de
	*				parametro ‚ por valor LSsolicitante pode
	*				ser alterado para  "FATURISTA SIMPLES" para
	*				evitar mudancas em subrotinas para tratar
	*				"IMPORTACAO"
	*	    	PrmOrientacao..: Devido a exigencia de prefeituras como a de
	*                Varzea Grande para emitir sevico em formulario proprio
	*                este processo passou a ter tres orientacoes
	*               "PRODUTO/SERVICO" => Fatura todos itens sem filtro
	*               "PRODUTO"         => Fatura so itens ref a produtos
	*               "SERVICO"         => Fatura so itens ref a servicos
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNnffim........: Numero da Ultima Nota
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LNctritens
	PRIVATE LFretorno		
	PRIVATE LNsoma_vlr,;
			LNbs_iss,LNvl_iss,LNvl_issrtd,LNbs_icms,LNvl_icms,LNbs_sbbrt,;
			LNbs_subs,LNvl_subs,LNbs_isent,LNbs_outr,LNbs_isipi,;
			LNbs_isipi,LNbs_ipi,LNvl_ipi
	PRIVATE LNpneus,LNcamaras,LNrodas,LNacessorios,LNmatborrach,;
			LNrecauchuta,LNalinhament,LNbalanceame,LNconserto,LNoutras

	PRIVATE LNpeso
	PRIVATE LNvlr_item

	IF TYPE ("LNecf") = "U"
		private LNecf
		LNecf = 0	&& NO CASO DE IMPORTACAO LNecf nao existe
	ENDIF
	*-----------------------------------------------------------*

	IF LSsolicitante = "IMPORTACAO"
		LSsolicitante = "FATURISTA SIMPLES"	&& SCGC201A		
	ENDIF
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*------------------------------------------------------------*
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
   		WAIT WINDOW "Empresa Localizada."+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE orcament

	*--------*  FORCA DESLOCAMENTO DA PAGINACAO DE INDICE
	
	GO BOTT
	GO TOP
	
	*-------*

	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
   		WAIT WINDOW "Orcamento Nao Localizado."+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	IF !REGLOCK()
   		WAIT WINDOW "Orcamento em uso em outro ponto. Tente novamente."+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	*--------*  FORCA DESLOCAMENTO DA PAGINACAO DE INDICE
	
	GO BOTT
	GO TOP
	
	*-------*
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
   		WAIT WINDOW "Anexo de Orcamento Nao Localizado."+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
	ENDIF


	SELE clienc
	*--------*  FORCA DESLOCAMENTO DA PAGINACAO DE INDICE
	
	GO BOTT
	GO TOP
	
	*-------*
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
   		WAIT WINDOW "Dados do Cliente  Nao Localizado  (CLIENC). "+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------*

	=W_DEFPROC("clientes.spr")
	=CLSetUltAtendimento(Clienc.Cliente,Clienc.Inscricao, LDdtnf)

	*---------------------------------------------------------*

	SELE orcatmp
	*--------*  FORCA DESLOCAMENTO DA PAGINACAO DE INDICE
	
	GO BOTT
	GO TOP
	
	*-------*
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNosi,6)
	SET NEAR OFF
	IF orcament.empresa <> orcatmp.empresa ;
		OR orcament.orcamento <> orcatmp.orcamento
   		WAIT WINDOW "Itens do Orcamento Nao Localizados."+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELECT tipooper
	*--------*  FORCA DESLOCAMENTO DA PAGINACAO DE INDICE
	
	GO BOTT
	GO TOP
	
	*-------*
	SET ORDER TO TAG tipo
	SEEK 's'+orcament.tipo
	IF !FOUND()
		SEEK 'S'+orcament.tipo
	ENDIF
	IF !FOUND()
   		WAIT WINDOW "Tipo de Operacao  Nao Localizado."+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*

	SELE orcatmp

    *--------------------------------------------------------------*
    *   SUBTRAI 1 EM LNnroNF PARA COMPENSAR A SOMA NO INICIO DO
    * COMANDO (DO WHILE)  A SEGUIR
    *--------------------------------------------------------------*

	m.vlrfrete  = orcament.vlrfrete
	m.vlrseguro = orcament.vlrseguro





	LNnroNF  = LNnroNF 	- 1       &&

	DO WHILE !eof() AND LNosi = orcatmp.orcamento ;
					AND LNemp = orcatmp.empresa

		IF LEFT(orcatmp.situacao,1) $ "YykeZO"
			***  NAO PROCESSAR ITENS CANCELADOS
			SKIP
			LOOP
		ENDIF

		DO CASE
			CASE PrmOrientacao = "PRODUTO/SERVICO"
		        STORE .T. TO LFGerNF   && SINALIZA QUE FOI GERADA
		                               && NOTA SERIE UNICA
			CASE PrmOrientacao = "PRODUTO"
				IF orcatmp.tp_mercad = 7 && SERVICO
					SKIP
					LOOP
				ENDIF
		        STORE .T. TO LFGerNF   && SINALIZA QUE FOI GERADA
		                               && NOTA SERIE UNICA
			CASE PrmOrientacao = "SERVICO"
				IF orcatmp.tp_mercad <> 7 && NAO SERVICO
					SKIP
					LOOP
				ENDIF
		        STORE .T. TO LFGerNFS   && SINALIZA QUE FOI GERADA
		                                && NOTA FISCAL DE SERVICO
		ENDCASE

		LNnroNF  = LNnroNF 	+ 1

		*-----------------<<<<<<<<<<    >>>>>>>>>--------------------*

		
		m.serie 	=	"U"

		m.serie 	=	NFSerie(empresa.empresa,;
		                        empresa.muni_ibge,;
		                        LNnroNF)




		m.referencia = 	orcament.orcamento
		m.cgc_emit	= 	empresa.cgc
		LTmp        =   "empresa.insc_"+empresa.estado
		m.insc_emit	= 	&LTmp
		m.insc_muni =	empresa.insc_munic
		m.uf		=	clienc.estado
		m.favorecido=	clienc.cliente
		***********************************************
		m.inscsubst		= 	empresa.insc_&uf
		m.aliq_iss		= 	empresa.aliq_iss

		IF tipooper.ch_opera = "1" ;
			AND (orcament.tp_parcela = 4 OR orcament.tp_parcela = 5)
			m.natureza		=	"VENDA CARTAO"
		ELSE
			m.natureza		=	tipooper.descricao
		ENDIF

		IF  PrmOrientacao = "SERVICO"
			m.natureza		=	"PRESTACAO DE SERVICO"
		ENDIF
		



		m.cod_cita		=	tipooper.citacao
		IF 	!EMPTY(ALLTRIM(orc_anex.mens1)) ;
			AND !EMPTY(ALLTRIM(orc_anex.mens2))
			m.citacao 	= LEFT(ALLTRIM(orc_anex.mens1)+";";
						      +ALLTRIM(orc_anex.mens2),64)
			m.citacao1 	= SUBS(ALLTRIM(orc_anex.mens1)+";";
							  +ALLTRIM(orc_anex.mens2),65)
		ELSE
			m.citacao 	= 	" "
			m.citacao1 	= 	" "
		ENDIF
		m.citacao3 	= orc_anex.mens3

		*-----> BUSCA NUMERO DA NOTA FISCAL


		**** LNnroNF  = LNnroNF 	+ 1

		m.nota   = LNnroNF 	
		m.cupom  = LNcupom
		m.operacao = "S"		&& NOTA FISCAL DE SAIDA
		m.data = LDdtnf
		m.hora = LShoranf
		m.dtorcament = orcament.data
		m.hrorcament = orcament.hora		
		m.orcamento  = orcament.orcamento
		m.status = 1
		*---------------------------------------------------------*
		=W_DEFPROC("NOTA.SPR")
		IF !NFAbreNota(orcament.empresa,LFabrecupom,(LStp_process),;
					m.nota,m.cupom,m.operacao,;
					m.data,m.hora,m.status,wp_tipoecf,LNecf)
	   		WAIT WINDOW "Comando para Abertura do Reg. Nota nao foi " +;
	   			" Acatado."
			LFretorno = .F.
			EXIT
		ENDIF
		LNcupom = m.cupom	
		*---------------------------------------------------------*
		M.FLAGPROCES	=	1	&& GRAVACAO DA CAPA DA NOTA
		******************************************************
		*	ATENCAO : FIM  DE FASE CRITICA
		*				A- O CUPOM ABERTO
		*				B- JA EXISTE REGISTRO EQUIVALENTE NO SISTEMA
		*					P/ ORIENTAR UM POSSIVEL CANCELAMENTO CASO
		*				    O SISTEMA CAIA APARTIR DESTE PONTO
		******************************************************
		*---------------------------------------------------------*

		IF  LSsolicitante <> "IMPORTACAO" AND !("REC." $ LStp_proces)
			SELECT empresa
			SET ORDER TO tag empresa
			=REGLOCK(.T.)
			DO CASE
				CASE PrmOrientacao = "SERVICO"
					REPLACE empresa.Ult_NFsrvc WITH empresa.Ult_NFsrvc + 1
					REPLACE FLAGIMPSRV 	WITH 1
				CASE "NOTA" = LStp_proces ;
					AND PrmOrientacao = "PRODUTO/SERVICO"
						REPLACE empresa.nota WITH empresa.nota + 1
						REPLACE FLAGIMPNF 	WITH 1
				CASE "NOTA/CUPOM" = LStp_proces
						REPLACE empresa.nota WITH empresa.nota + 1
						REPLACE FLAGIMPNF 	WITH 1
				CASE "NOTA" = LStp_proces AND PrmOrientacao = "PRODUTO"
					REPLACE empresa.nota WITH empresa.nota + 1
					REPLACE FLAGIMPNF 	WITH 1
				CASE "NOTA/NF SERVICO" = LStp_proces ;
				   AND PrmOrientacao = "PRODUTO"
					REPLACE empresa.nota WITH empresa.nota + 1
					REPLACE FLAGIMPNF 	WITH 1
				CASE "NOTA/NF SERVICO" = LStp_proces ;
				   AND PrmOrientacao = "SERVICO"
					REPLACE empresa.Ult_NFsrvc WITH empresa.Ult_NFsrvc + 1
					REPLACE FLAGIMPSRV 	WITH 1
				CASE "NF SERVICO" = LStp_proces
					REPLACE empresa.Ult_NFsrvc WITH empresa.Ult_NFsrvc + 1
					REPLACE FLAGIMPSRV 	WITH 1
				CASE "CUPOM" $ LStp_proces
					REPLACE empresa.ult_cupom  WITH empresa.ult_cupom + 1
					REPLACE FLAGIMPCPM 	WITH 1
			ENDCASE
		ENDIF
		*---------------------------------------------------------*
		* 		  Processo para evitar duplicacoes de itens provocada por
    	* 	falha durante possivel faturamento anterior
		*   Processo adotado para compensar a transacao
		*---------------------------------------------------------*
		=W_DEFPROC("NOTA.SPR")
		=NFDelItensNf(orcament.empresa,(m.nota))
		*---------------------------------------------------------*
		=UNFmarcanf(2) 	&& CAPA GRAVADA E ITENS VERIFICADOS
		=UNFempmarca(2,LStp_proces,PrmOrientacao)
		*---------------------------------------------------------*


		SELE NOTA
		STORE 0 TO LNsoma_vlr,;
			LNbs_iss,LNvl_iss,LNvl_issrtd,LNbs_icms,LNvl_icms,LNbs_sbbrt,;
			LNbs_subs,LNvl_subs,LNbs_isent,LNbs_outr,LNbs_isipi,;
			LNbs_isipi,LNbs_ipi,LNvl_ipi

		STORE 0 TO LNsoma_vlr,;
			LNpneus,LNcamaras,LNrodas,LNacessorios,LNmatborrach,;
			LNrecauchuta,LNalinhament,LNbalanceame,LNconserto,LNoutras
		STORE 0 TO LNpeso
		*---------------------------------------------------------*


		LNctritens = 0
		SELECT  orcatmp
	    DO WHILE !eof() AND LNosi = orcatmp.orcamento ;
    				AND LNemp = orcatmp. empresa



			*---------------------------------------------------*
			*  A PARTIR DE 10/09/2008 SE O NUMERO DE ITENS OCUPAR
			* MAIS DE UM FORMULARIO SERAMANTIDO O MESMO NUMERO DE
			* NF E A TATALIZACAO DAIMPRESSAO OCORRERA NA ULTIMA NF
			*------> REQUISICAO ? JOAO NUNES CONTADOR
			*---------------------------------------------------*
			IF LDdtnf < {28.09.2008}
				IF  LNnroNF < 1000000 OR  LNnroNF > 2000000
					IF  LNctritens >= 11
						EXIT
					ENDIF
				ENDIF
			ENDIF


			***  NAO PROCESSAR ITENS CANCELADOS

			IF LEFT(orcatmp.situacao,1) $ "YykeZO"
				SKIP
				LOOP
			ENDIF
			DO CASE
				CASE PrmOrientacao = "PRODUTO"
					IF orcatmp.tp_mercad = 7 && SERVICO
						SKIP
						LOOP
					ENDIF
				CASE PrmOrientacao = "SERVICO"
					IF orcatmp.tp_mercad <> 7 && NAO SERVICO
						SKIP
						LOOP
					ENDIF
			ENDCASE
			*-----------------------------------------------------*
			wp_msg = "Faturando OSI: "+STR(LNosi,6)+" - Item : "+;
					STR(orcatmp.ordem,2)+" - "+orcatmp.codigo
			WAIT WINDOW wp_msg NOWAIT
			*-----------------------------------------------------*
		    IF ULbaixa_Saldo(LSsolicitante)
		    	SELECT orcatmp
				IF REGLOCK()
					*--------------------------------------------------*
					=W_DEFPROC("NOTA.SPR")
					=NFFat_Item(orcament.empresa,(m.nota),(LDdtnf),;
										(LShoranf))
					*--------------------------------------------------*


			    	SELECT orcatmp
					IF tipooper.ch_opera $ "4/2" && devolucao / transf
				        LNvlr_item = (orcatmp.vlrvenda)
					ELSE
				        LNvlr_item = (orcatmp.vlrvenda - orcatmp.vlripi)
					ENDIF


			        LNsoma_vlr = LNsoma_vlr + LNvlr_item


					=W_DEFPROC("grupo.spr")
					LNpeso      = LNpeso + ;
					     GRGetPeso(orcatmp.codigo) * orcatmp.qtde

					LNbs_iss	= 	LNbs_iss	+	orcatmp.base_iss
					LNvl_iss	= 	LNvl_iss	+	orcatmp.vlr_iss
					LNvl_issrtd =   LNvl_issrtd +   orcatmp.vlr_issrtd
					LNbs_icms	= 	LNbs_icms	+	orcatmp.base_calc
					LNvl_icms	=	LNvl_icms	+	orcatmp.vlr_icms
					LNbs_sbbrt	=	LNbs_sbbrt	+	orcatmp.base_sbbrt					
					LNbs_subs 	=	LNbs_subs 	+	orcatmp.base_subs 					
					LNvl_subs 	=	LNvl_subs 	+	orcatmp.icms_subs 					
					LNbs_isent	=	LNbs_isent	+	orcatmp.base_isent					
					LNbs_outr 	=	LNbs_outr 	+	orcatmp.base_outr 					
					LNbs_isipi	=	LNbs_isipi	+	orcatmp.base_isipi					
					LNbs_ipi  	=	LNbs_ipi  	+	orcatmp.base_ipi  					
					LNvl_ipi  	=	LNvl_ipi  	+	orcatmp.vlripi   					
					*--------------------------------------------------*
					IF tipooper.ch_opera = "1"
						SELE grupo
						SET ORDER TO TAG codigo
						SEEK orcatmp.codigo
						SELE orcatmp

						*-----> APURA VALORES P/ RESUMO ANEXO SO PARA VENDAS
						DO CASE
							CASE LEFT(grupo.classifica,2) = "00"
								LNpneus		= 	LNpneus + LNvlr_item
							CASE LEFT(grupo.classifica,2) = "01"
								LNcamaras	=	LNcamaras + LNvlr_item
							CASE LEFT(grupo.classifica,2) = "02"
								LNrodas   	= 	LNrodas  + LNvlr_item
							CASE LEFT(grupo.classifica,2) = "04"
								LNacessorios= LNacessorios+ LNvlr_item
							CASE LEFT(grupo.classifica,2) = "05"
								LNmatborrach= LNmatborrach+ LNvlr_item
							CASE LEFT(grupo.classifica,5) = "09094"
								LNrecauchuta= LNrecauchuta+ LNvlr_item
							CASE LEFT(grupo.classifica,5) = "09091"
								LNalinhament= LNalinhament+ LNvlr_item
							CASE LEFT(grupo.classifica,5) = "09092"
								LNbalanceame= LNbalanceame+ LNvlr_item
							CASE LEFT(grupo.classifica,5) = "09093"
								LNconserto  = LNconserto + LNvlr_item
							OTHERWISE
								LNoutras	= LNoutras   + LNvlr_item
						ENDCASE
				    	SELECT orcatmp
					ENDIF
				ELSE
			   		WAIT WINDOW ;
			   			"Registro de Item do Orcamento Esta Bloqueado"
					LFretorno = .F.
					EXIT
				ENDIF
			ELSE
		   		WAIT WINDOW  "Foi Negada a Baixa no Estoque."
				LFretorno = .F.
				EXIT
			ENDIF
			SELECT  orcatmp
			SKIP
			LNctritens = LNctritens + 1
		ENDDO
		IF LNctritens = 0
	   		WAIT WINDOW  "Nenhum Item Faturado."
			LFretorno = .F.
			EXIT
		ENDIF
		IF !LFretorno
			EXIT
		ENDIF			

		SELE orcament
		SCATTER MEMVAR FIELDS banco,agencia


		m.nome		=	clienc.nome
		m.endereco	=	clienc.endereco
		m.bairro	=	clienc.bairro
		m.cidade	=	clienc.cidade
		m.MUNI_IBGE	=	clienc.MUNI_IBGE
		m.uf		=	clienc.estado
		m.cep		=	clienc.cep
		m.fone		=	clienc.fone
		m.regiao 	= 	clienc.regiao
		m.revendedor=	clienc.revendedor
		m.natu_cli	=	clienc.natu_cli
		m.tp_pessoa	=	clienc.tp_pessoa
		m.tp_inscr	=	clienc.tp_inscr
		m.inscricao	=	clienc.inscricao

		SELE tipooper
		SCATTER MEMVAR FIELDS ch_opera,ch_produ, ;
						ch_motiv,ch_desti,ch_contr,ch_condi
		SELE nota
		m.operacao = "S"		&& NOTA FISCAL DE SAIDA
		m.data = LDdtnf
		m.hora = LShoranf
		m.orcamento = orcament.orcamento
		m.status = 1
		*-------------------------------------------------------------*
		m.serv_1     = orcament.operador

		STORE 0 TO   serv_2,serv_3,serv_4,serv_5,serv_6,;
				 serv_7,serv_8,serv_9,serv_10,serv_11,;
				 serv_12
		STORE "" TO  mens1,mens2

		SELE orc_anex
		SET ORDER TO TAG orcamento
		SEEK STR(orcament.EMPRESA,3)+STR(orcament.ORCAMENTO,6)
		IF FOUND()
			SCATTER MEMVAR FIELDS mens1,mens2,;
								  serv_2,serv_3,serv_4,serv_5,serv_6,;
								  serv_7,serv_8,serv_9,serv_10,serv_11,;
								  serv_12
		ENDIF
		*-------------------------------------------------------------*
		SELE nota
		m.negociacao = orcament.negociacao

		*-----------------------------------------------*


		IF orcament.tp_parcela = 1
			m.tp_pgto   =   1   && A Vista
		ELSE
			m.tp_pgto   =   3 	&& Parcelado
		ENDIF



		m.pes_brt   =   LNpeso
		m.pes_liq   =   LNpeso
		
	 	m.base_iss	=	LNbs_iss
		m.aliq_iss	=	empresa.aliq_iss
		m.vlr_iss	=	ROUND(m.base_iss * ROUND(m.aliq_iss  / 100,4),2)


        m.vlr_issrtd = 	LNvl_issrtd

		m.totservico=	LNbs_iss

		m.base_icms	=	LNbs_icms
		m.aliq_icms	= 	ORCAMENT.aliq_icms
		m.vlr_icms	=	m.base_icms * m.aliq_icms / 100

		m.base_sbbrt= 	LNbs_sbbrt
		m.base_subs	=	LNbs_subs
		m.icms_subs	=	LNvl_subs

		m.base_isipi=	LNbs_isipi
		m.base_ipi	=	LNbs_ipi
		m.vlr_ipi	=	LNvl_ipi


		m.base_isent=	LNbs_isent
		m.base_outr	=	LNbs_outr

		m.totservico =	LNbs_iss
		m.totproduto =  LNsoma_vlr - m.totservico
		m.total_nota =	LNsoma_vlr + m.icms_subs + ;
						m.vlrfrete + m.vlrseguro + ;
						m.vlr_ipi
		m.status = 1
		M.FLAGPROCES	=	3	&& NOTA E ITENS FATURADOS NORMALMENTE
							&& FALTANDO A IMPRESSAO

		SELE nota
		=edithand('REGRAVA')
		*************  RODANDO A NUMERACAO E MARCANDO O FLAG  **************
		=UNFempmarca(3,LStp_proces,PrmOrientacao)
		***************************************************************	**
		SELE nf_anexo
		m.pneus			= LNpneus
		m.camaras		= LNcamaras
		m.rodas			= LNrodas
		m.acessorios    = LNacessorios
		m.matborrach	= LNmatborrach
		m.recauchuta	= LNrecauchuta
		m.alinhament	= LNalinhament
		m.balanceame	= LNbalanceame
		m.conserto		= LNconserto
	    =edithand('SAVE')
		SELE orcatmp
		m.vlrfrete = 0    && valor apenas na primeira nota
		m.vlrseguro =0    && valor apenas na primeira nota

	    IF eof() OR orcament.orcamento <> orcatmp.orcamento ;
    		OR LNemp <> orcatmp. empresa
			EXIT
		ENDIF
	ENDDO
	*-----------------------------------------------------*
	wp_msg = "Fechado Faturamento Itens OSI: "+STR(LNosi,6)
	WAIT WINDOW wp_msg NOWAIT
	*-----------------------------------------------------*
	m.LNnffim      = LNnroNF 	
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H1K           NFAbreNota VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   11    º
*       º Variable:            NFAbreNota                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      144                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123h1k     &&  NFAbreNota VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NFAbreNota
PARAMETERS LNemp,LFabrecupom,LStp_process,m.nota,m.cupom,m.operacao,;
			m.data,m.hora,m.status,wp_tipoecf,LNecf

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Abrir o Registro de Nota no Arquivo com os
	*		dados Basicos
	*	
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LFabrecupom....: Indica Necessidade de Abrir Cupom ECF
	*		LStp_process...: Processo definido em NFDefProcess
	*		m.nota,m.cupom,m.operacao,m.data,m.hora,m.status
	*						,wp_tipoecf,LNecf  DADOS PARA GRAVACAO
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSstatus
	PRIVATE LSnronf,LSnrocp,LNnrocpAnt
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	LNnrocpAnt = 0
	IF LFabrecupom
		LFabrecupom = .F. 		&& NAO TENTAR ABRIR DE NOVO
		******************************************************
		*	ATENCAO : INICIO DE FASE CRITICA
		*				A- O CUPOM SERA ABERTO
		*				B- NAO EXISTE REGISTRO EQUIVALENTE NO SISTEMA
		*					P/ ORIENTAR UM POSSIVEL CANCELAMENTO CASO
		*				    O SISTEMA CAIA ANTES DA GRAVACAO DA CAPA
		*					NO REGISTRO DE NOTAS
		******************************************************

		IF "CUPOM" $ LStp_proces
			IF !("REC." $ LStp_proces)
				=W_DEFPROC("ECF.SPR")
				LNnrocpAnt = INT(ECFnrocupom())
			ENDIF
		ELSE
				LNnrocpAnt = 0
		ENDIF


		=W_DEFPROC("ECF.SPR")
		LSstatus = ECFabrecupom()

		IF SUBS(LSstatus,7,1) = "E"
			LSnronf    = empresa.ult_cupom 						 				
			IF LSnronf < 1000000
				LSnronf = LSnronf + 1000000
			ENDIF
			=W_DEFPROC("ECF.SPR")
			LSnrocp = STR(INT(ECFnrocupom()),7)
			LSnronf = STR(LSnronf,7)
			DO OBJ_MENS.SPR WITH "   ATENCAO !!! " +CHR(13)+CHR(13)+;
				" Nao Foi Possivel Abrir CUPOM FISCAL. Faturamento Nao "+;
				"Iniciado. "+CHR(13)+;
				" CUPOM ANTERIOR [ REGISTRO nro: "+LSnronf+;
				" CUPOM nro : "+LSnrocp +"]  CONTINUA ABERTO."+;
				" Cancele Este Registro."
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.F.)
		ENDIF			

		*------ aguarda atualizacao do nro cupom pela ecf ------*

		IF "CUPOM" $ LStp_proces
			IF !("REC." $ LStp_proces)
			    LFcotinua = .T.
				DO WHILE LFcotinua

		 		    =W_DEFPROC("ECF.SPR")
					LSmarca = ECFGetPropVT("TIPOECF")
					IF  LSmarca = "TESTE"
						EXIT
					ENDIF

		 		    =W_DEFPROC("ECF.SPR")
					LSstatus=ECFsituacao()
					IF ("CUPOM ABERTO" $ UPPER(LSstatus))
						=W_DEFPROC("ECF.SPR")
						m.cupom = INT(ECFnrocupom())

						
						IF  m.cupom <> LNnrocpAnt  AND m.cupom <> 0
							EXIT
						ENDIF
					ENDIF

					WAIT WINDOW ;
					"Aguardando Atualizacao do Nro do Cupom na ECF" nowait
					=INKEY(1)
					IF LASTKEY() = 27
					   LFcotinua = .f.
					ENDIF
				ENDDO
			    IF LFcotinua = .f.
					DO OBJ_MENS.SPR WITH "  ATENCAO !!! " +CHR(13)+CHR(13)+;
						" Nao Foi Possivel Obter Numero do CUPOM FISCAL."
					IF !EMPTY(LSalias) AND USED(LSalias)
						SELECT &LSalias
					ENDIF
					RETURN(.F.)
				ENDIF
			ENDIF
		ELSE
			m.cupom = 0
		ENDIF
	ENDIF
	SELE nota
	m.empresa = LNemp
	=edithand('SAVE')
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
	    SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H1T           NFFat_Item VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   12    º
*       º Variable:            NFFat_Item                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      145                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h1t     &&  NFFat_Item VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NFFat_Item
PARAMETERS LNemp,LNnota,LDdtfat,LShorafat
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Realiza todo circuito para Fturar um item
	*				CANCELAR RESERVA/REGISTRAR MOV/ATULIZAR SALDO
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNnota.........: Nro da Nota para eliminar itens
	*		LDdtfat........: Data de Faturamento
	*		LShorafat......: Hora do Faturamento
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE  LFfoundres   && f=> NAO ENCONTROU REGISTRO DE RESERVA
   	PRIVATE LNfatreg
	*------------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT orcatmp

	SELE grupo
	SET ORDER TO TAG codigo
	SEEK orcatmp.codigo
	

	*-----------------  CANCELAR AS RESERVAS --------------------*
    LFfoundres = .f.   && f=> NAO ENCONTROU REGISTRO DE RESERVA
	*------------------------------------------------------------*

   	SELECT itemmov
   	SET ORDER TO TAG itensosi
   	SEEK STR(LNemp,3)+"R"+STR(orcatmp.orcamento,7)+;
					   			orcatmp.codigo+STR(orcatmp.ordem,3)

   	IF FOUND()
	    LFfoundres = .T.   && f=> ENCONTROU REGISTRO DE RESERVA
	    SET ORDER TO TAG movimento
		=REGLOCK(.T.)
		REPLACE operacao WITH "****"   && faz o reg ser ignorado no saldo
									   && anulando seu efeito
		***********************************************************
		SELE itemmov
		LNregmov = RECNO()

		SELE itemmov
	   	=W_DEFPROC("moviment.spr")
		=MVatu_cmd(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e

		SELE itemmov
		GO LNregmov
		***********************************************************
	    SET ORDER TO TAG movimento
		=REGLOCK(.T.)
   	ENDIF
	******************** FIM CNCELAR AS RESERVAS ************************

   	SELECT orcatmp
	*-------------------------------------------------------------*
	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(orcatmp.EMPRESA,3)+STR(orcatmp.ORCAMENTO,6)
   	m.negociacao = orc_anex.negociacao  && RECUPERA O VALOR DO CAMPO
   									    && ALTERADO PELO SCATTER
	*-------------------------------------------------------------*
   	DO CASE
		CASE FOUND("GRUPO") AND grupo.TP_CONTROL = 9
	    	  m.operacao = 'SINF'   && MERA INFORMACAO SEM EFEITO ESTOQUE
		CASE tipooper.movestq = "N"
	    	  m.operacao = 'SINF'   && MERA INFORMACAO SEM EFEITO ESTOQUE
		CASE orcament.natu_oper = 1
		   IF LEFT(orcatmp.situacao,1) $ 'I'  && BAIXA REZERVA E SALDO
	    	  m.operacao = 'SVPS'   && SAIDA/VENDA/PROCESSADA/COM RESERVA
		   ELSE
    		  m.operacao = 'SVPN'   && SAIDA/VENDA/PROCESSADA/SEM RESERVA
		   ENDIF
		CASE orcament.natu_oper = 2
		   IF LEFT(orcatmp.situacao,1) $ 'I'  && BAIXA REZERVA E SALDO
		      m.operacao = 'STPS'   && SAIDA/COMERCIAL/PROC/COM RESERVA
		   ELSE
		      m.operacao = 'STPN'   && SAIDA/COMERCIAL/PROCE/SEM RESERVA
		   ENDIF
		CASE orcament.natu_oper = 3
		   IF LEFT(orcatmp.situacao,1) $ 'I'  && BAIXA REZERVA E SALDO
		      m.operacao = 'SRPS'   && SAIDA/REMESSA/PROCESSADA/COM RESERVA
		   ELSE                                && BAIXA SALDO SEM REZERVA
		      m.operacao = 'SRPN'   && SAIDA/REMESSA/PROCESSADA/SEM RESERVA
		   ENDIF
 		CASE orcament.natu_oper = 4
		   IF LEFT(orcatmp.situacao,1) $ 'I'  && BAIXA REZERVA E SALDO
		      m.operacao = 'SDPS'   && SAIDA/COMERCIAL/PROC/COM RESERVA
		   ELSE
		      m.operacao = 'SDPN'   && SAIDA/COMERCIAL/PROCE/COM RESERVA
		   ENDIF
 		CASE orcament.natu_oper = 7
	       m.operacao = 'SOPS'   && SAIDA/COMERCIAL/PROC/COM RESERVA

   	ENDCASE
	*---------------------------------------------------------------*
	* 	LSprograma ‚ uma variavel publica recebida como parametro em
	* SVD2 e que identifica a forma de operacao do sistema de
	* faturamento
	*	 	LSprograma = "VENDA"
	*		LSprograma = "BALCAO"
	*		LSprograma = "BALCAO-2"
	*---------------------------------------------------------------*
	*		LSsolicitante..: Identifica os Pontos em que esta
	*				 rotina pode ser chamada
	*			   		LSsolicitante = "VENDEDOR"
	*					LSsolicitante = "CAIXA"
	*					LSsolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					LSsolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					LSsolicitante = "IMPORTACAO"		&& SCGC008
	IF  LSsolicitante $  "VENDEDOR/CAIXA"
		m.situacao 	= "O"+RIGHT(orcatmp.situacao,1)
   	ELSE
		m.situacao 	= "OC" && FAT. PELO FAT.RISTA SEM OSI
   	ENDIF
   	m.nota 		= LNnota
   	m.dtfat 	= LDdtfat
   	SELECT orcatmp
	*------------------------------------------------------------*
	SET FIELDS TO dtregis, hregis, usrregis,deletado
    SET FIELDS TO situacao
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------*
   	SELECT itemmov
   	m.sld_estq = 0
   	m.vlr_estq = 0

	m.empresa 	=	orcatmp.empresa
	m.serie 	=	"UN"
   	m.dtfat 	= 	LDdtfat
  	m.data     	= 	LDdtfat
   	m.hora     	= 	LShorafat
	m.orcamento	=	orcatmp.orcamento
	m.operador	=	orcament.operador
	m.motivo	=	orcament.motivo

	SELE TIPOOPER
	SCATTER MEMVAR FIELDS;
		 CH_OPERA,CH_PRODU,CH_MOTIV,CH_DESTI,CH_CONTR,CH_CONDI,TIPO

	m.FAVORECIDO  =    clienc.cliente
	m.NATU_CLI    =    clienc.NATU_CLI
	m.CODFORN     =    0
	m.PRAZOMEDIO  =    orcament.PRAZOMEDIO
	m.TP_parcela  =    orcament.TP_parcela
	m.TAXA        =    orcament.TAXA
	m.DESCONTO    =    orcatmp.DESCONTO
	m.DESC_ALT    =    orcatmp.DESC_ALT
	m.USR_DALT    =    orcatmp.USR_DALT
	m.NEGOCIACAO  =    orcament.NEGOCIACAO

	IF FOUND("GRUPO") AND grupo.TP_CONTROL = 9
		m.MOVESTQ     =    "N"
	ELSE
		m.MOVESTQ     =    tipooper.MOVESTQ
	ENDIF
	m.MOVVALOR    =    tipooper.MOVVALOR
	m.MOVCUSTO    =    tipooper.MOVCUSTO
	m.INFO_VLR    =    tipooper.INFO_VLR
	m.INFO_ICMS   =    tipooper.INFO_ICMS
	m.INFO_BASE   =    tipooper.INFO_BASE


	m.ORDEM       =    orcatmp.ORDEM
	m.CODIGO      =    orcatmp.CODIGO
	m.CLASSIFICA  =    grupo.CLASSIFICA
	m.UNIDADE     =    orcatmp.UNIDADE
	m.DESCRICAO   =    orcatmp.DESCRICAO
	m.DESCRCOMPL  =    orcatmp.DESCRCOMPL
	m.INFO_COMPL  =    orcatmp.INFO_COMPL

	m.TP_MERCAD   =    orcatmp.TP_MERCAD

	=W_DEFPROC("GRUPO.SPR")
	m.peso = GRGetPeso(orcatmp.codigo)

*************************************
*  m.PESO        =    orcatmp.PESO  *
*************************************

	m.IVA         =    orcatmp.IVA
	m.CLAS_CMS    =    orcatmp.CLAS_CMS
	m.CFO         =    orcatmp.CFO
	m.ORIGEM      =    orcatmp.ORIGEM
	m.CST         =    orcatmp.CST
	m.BASE_ISS    =    orcatmp.BASE_ISS
	m.ALIQ_ISS    =    orcatmp.ALIQ_ISS
	m.VLR_ISS     =    orcatmp.VLR_ISS
	m.VLR_ISSRTD  =    orcatmp.VLR_ISSRTD
	m.BSBR_ICMS   =    orcatmp.BSBR_ICMS
	m.ALIQ_RDU    =    orcatmp.ALIQ_RDU
	m.BASE_CALC   =    orcatmp.BASE_CALC
	m.ALIQ_ICMS   =    orcatmp.ALIQ_ICMS
	m.VLR_ICMS    =    orcatmp.VLR_ICMS
	m.BASE_SBBRT  =    orcatmp.BASE_SBBRT
	m.BASE_SUBS   =    orcatmp.BASE_SUBS
	m.ICMS_SUBS   =    orcatmp.ICMS_SUBS
	m.BASE_ISENT  =    orcatmp.BASE_ISENT
	m.BASE_OUTR   =    orcatmp.BASE_OUTR
	m.BASE_ISIPI  =    orcatmp.BASE_ISIPI
	m.BASE_IPI    =    orcatmp.BASE_IPI
	m.ALIQ_IPI    =    orcatmp.ALIQ_IPI
	m.VLRIPI      =    orcatmp.VLRIPI
	m.PRECO       =    orcatmp.PRECO
	m.PRECOFINAL  =    orcatmp.PRECOFINAL
	m.QTDE        =    orcatmp.QTDE


	IF tipooper.ch_opera $ "4/2" && devolucao / transf
        LNvlr_item = (orcatmp.vlrvenda)
	ELSE
        LNvlr_item = (orcatmp.vlrvenda - orcatmp.vlripi)
	ENDIF


	m.VLRVENDA    =    LNvlr_item


	m.DESC_ADICI  =	   orcatmp.DESC_ADICI

	m.SLD_ESTQ    =    0
	m.VLR_ESTQ    =    0
	m.SLD_RESE    =    0

	
   	SELECT itemmov
	IF !(LFfoundres)
	   	=edithand('SAVE')
	ELSE
        =REGLOCK(.T.)
	   	=edithand('REGRAVA')
	ENDIF
	SET ORDER TO TAG movimento

   	=W_DEFPROC("moviment.spr")
	=MVatu_cmd(itemmov.empresa,;
				itemmov.codigo,;
				itemmov.classifica,;
				itemmov.data,;
				itemmov.hora,;
				itemmov.tipo,;
				itemmov.nota,;
				itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H1U           antNF_02ImpFatura VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   13    º
*       º Variable:            antNF_02ImpFatura                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      146                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h1u     &&  antNF_02ImpFatura VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION antNF_02ImpFatura
PARAMETERS LNemp,LNorcament,LStp_process,;
			wp_TipoEcf,LNecf,;
			LNCtrlCupomIni, LNCtrlCupomFim,;
			LNnfinicio    , LNnffim,;
			LNnfsrvIni    , LNnfsrvFim,;
			LNnfCopInicio , LNnfCopFim,;
			LNSrvCopIni , LNSrvCopFim
			

	*---------------------------------------------------------*



	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*

	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************


	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------

	IF  "CUPOM" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNCtrlCupomIni,7)

		SELE itemmov
		SET ORDER TO TAG itensnota
		SET NEAR ON
		SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
		SET NEAR OFF			
		*------------------------------------------------------------*
		*  INICIA GERACAO DE ARQUIVO TEMPORARIO
		*------------------------------------------------------------*
		LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
		LSaliastmp 	= "TMP" 		&&     TMP001
		LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
		IF EMPTY(LSaliastmp)
			WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
			LOOP
	 	ENDIF		

	   	=up_fecha("ITNFSTMP")
		WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
		SELE itemmov
		COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND itemmov.nota	<= LNCtrlCupomFim


		SELE 0
		USE  &LSarqtmp  ALIAS ITNFSTMP EXCL
		INDEX ON nota   TAG nota ADDITIVE
		go top
		*----------------------------------------------------------*
		SELE nota

		SET RELATION TO  operador INTO usuario
		***************************************************

		=W_DEFPROC("ECF.SPR")
		LSstatus=ECFctrlimpcupom((LNCtrlCupomIni),;
		       (LNCtrlCupomFim),(LNvalor), nota.total_nota)

		*-----------------------------------------------------------*
		*   Se nao houve erro "E" e o processo emite so "CUPOM"
		* faz a marca (4) fechando o faturamento
		*-----------------------------------------------------------*


		IF SUBS(LSstatus,7,1) = "E"
		   	=up_fecha("ITNFSTMP")
		  	SELECT &LSalias
			*--------------------------------------------------*
			DO CASE
				CASE "NCN - EXECUTADO" $ UPPER(LSstatus)
					IF !NFCancNCN(LNemp,LNCtrlCupomIni)
						wp_msg = "Cupom "+STR(LNCtrlCupomIni,7)+;
						 " nao foi cacelado. Comande Cancelamento < ENTER >"
						WAIT WINDOWS wp_msg
					   	RETURN(.f.)
					ELSE
						=UNFempmarca(4,LStp_proces,LSOrientacao)
					   	RETURN(.f.)
					ENDIF
				OTHERWISE
					IF !NFCancCupom(LNemp,LNCtrlCupomIni)
						wp_msg = "Cupom "+STR(LNCtrlCupomIni,7)+;
						 " nao foi cacelado. Comande Cancelamento < ENTER >"
						WAIT WINDOWS wp_msg
					   	RETURN(.f.)
					ELSE
						=UNFempmarca(4,LStp_proces,LSOrientacao)
					   	RETURN(.f.)
					ENDIF
					*--------------------------------------------------*
			ENDCASE
		  	SELECT &LSalias
		   	RETURN(.F.)
		ENDIF

		=UNFempmarca(4,LStp_proces,LSOrientacao)
	   	=up_fecha("ITNFSTMP")
	ENDIF


	IF  "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF

		DO WHILE LNnfinicio  <= LNnffim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfinicio,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itensnota
			SET NEAR ON
			SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

		   	=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
					WHILE nota.empresa = itemmov.empresa ;
						  AND nota.nota	= itemmov.nota
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nota   TAG nota ADDITIVE

			LNimpressao = RECCOUNT()
			go top

			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP
			DO CASE
				CASE  (nota.empresa = 5 ;
					OR nota.empresa = 1 OR nota.empresa = 9;
			        OR nota.empresa = 7 OR nota.empresa = 10;
			        OR nota.empresa = 11);
			        and nota.data >= {26.09.2002}

				=W_DEFPROC("duplicat.spr")
				IF CRQtdeParcelas(orcament.prazo) > 5
					REPORT FORM relnfs3C ;
						WHILE nota.nota = LNnfinicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
				ELSE
					REPORT FORM relnfs3 ;
						WHILE nota.nota = LNnfinicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
	 			ENDIF
				CASE  (nota.empresa = 14)

				=W_DEFPROC("duplicat.spr")
				IF CRQtdeParcelas(orcament.prazo) > 5
					REPORT FORM relnfs5C ;
						WHILE nota.nota = LNnfinicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
				ELSE
					REPORT FORM relnfs5 ;
						WHILE nota.nota = LNnfinicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
	 			ENDIF
			OTHERWISE

				=W_DEFPROC("duplicat.spr")
				IF CRQtdeParcelas(orcament.prazo) > 5
					REPORT FORM relnfs2C ;
						WHILE nota.nota = LNnfinicio AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
	 			ELSE
					REPORT FORM relnfs2 ;
						WHILE nota.nota = LNnfinicio AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
	 			ENDIF
	 						
			ENDCASE
			=UNFempmarca(4,LStp_proces,LSOrientacao)
		   	=up_fecha("ITNFSTMP")

			LNnfinicio	= LNnfinicio + 1

		ENDDO
	ENDIF

	IF  "COPIA EM NOTA" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF

		DO WHILE LNnfCopInicio  <= LNnfCopFim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfCopInicio,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itenscopia
			SET NEAR ON
			SEEK STR(nota.empresa,3)+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		


		   	=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp FOR LEFT(itemmov.operacao,1) = "S" ;
					WHILE nota.empresa = itemmov.empresa ;
						  AND nota.nota	= itemmov.nf_copia
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nf_copia   TAG nota ADDITIVE


			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP
            DO CASE
            CASE (nota.empresa = 5 OR nota.empresa = 1 OR nota.empresa = 9;
			       OR nota.empresa = 7 OR nota.empresa = 10);
			    and nota.data >= {26.09.2002}

				=W_DEFPROC("duplicat.spr")
				IF CRQtdeParcelas(orcament.prazo) > 5
					REPORT FORM relnfs3C ;
						WHILE nota.nota = LNnfCopInicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
				ELSE
					REPORT FORM relnfs3 ;
						WHILE nota.nota = LNnfCopInicio AND;
		  				nota.empresa = LNemp AND UNFmarcanf(4) ;
		 					NOCONSOLE TO PRINTER
				ENDIF
            CASE (nota.empresa = 14)
				=W_DEFPROC("duplicat.spr")
				IF CRQtdeParcelas(orcament.prazo) > 5
					REPORT FORM relnfs5C ;
						WHILE nota.nota = LNnfCopInicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
				ELSE
					REPORT FORM relnfs5 ;
						WHILE nota.nota = LNnfCopInicio AND;
		  				nota.empresa = LNemp AND UNFmarcanf(4) ;
		 					NOCONSOLE TO PRINTER
				ENDIF
			OTHERWISE
				=W_DEFPROC("duplicat.spr")
				IF CRQtdeParcelas(orcament.prazo) > 5
					REPORT FORM relnfs2C ;
						WHILE nota.nota = LNnfCopInicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
	 			ELSE
					REPORT FORM relnfs2 ;
						WHILE nota.nota = LNnfCopInicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
	 			ENDIF
 			ENDCASE
			=UNFempmarca(4,LStp_proces,LSOrientacao)
		   	=up_fecha("ITNFSTMP")

			LNnfCopInicio  = LNnfCopInicio + 1

		ENDDO
	ENDIF

	*---------- IMPRESSAO DE NOTA FISCAL DE SERVICO ------------*
	*****************************************************************
	*--> Redireciona impressora de NOTA FISCAL DE SERVICO
	* APROVEITA CAMPO WP_IMPORC que nao teve  aplicacao no sistema
	*****************************************************************

	IF  "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
		LsOrientacao = "SERVICO"
		IF !(EMPTY(ALLTRIM(wp_imporc)))
			LNmtmp =UPnometmp("tmp",2)
			DELETE FILE &LNmtmp
			RUN &wp_imporc > &LNmtmp
		ELSE
			SET PRINTER TO &wp_prtorc
		ENDIF
		*************************************************************
		*--------------------------------------------------
		DO WHILE LNnfSrvIni  <= LNnfSrvFim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfsrvIni,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itensnota
			SET NEAR ON
			SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

			=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND nota.nota	= itemmov.nota





			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nota   TAG nota ADDITIVE

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP

	
			IF wp_dtoper < {01.05.2006}
				REPORT FORM relnfsrv ;
					WHILE nota.nota = LNnfsrvIni AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
						NOCONSOLE TO PRINTER
			ELSE
				REPORT FORM relsrv02 ;
					WHILE nota.nota = LNnfsrvIni AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 					NOCONSOLE TO PRINTER
			ENDIF
	
	
	
			=UNFempmarca(4,LStp_proces,LSOrientacao)
		   	=up_fecha("ITNFSTMP")

			LNnfsrvIni	= LNnfsrvIni + 1
			
		ENDDO
	ENDIF




	IF  "COPIA EM NF SERVICO" $ LStp_proces
		LsOrientacao = "SERVICO"
		IF !(EMPTY(ALLTRIM(wp_imporc)))
			LNmtmp =UPnometmp("tmp",2)
			DELETE FILE &LNmtmp
			RUN &wp_imporc > &LNmtmp
		ELSE
			SET PRINTER TO &wp_prtorc
		ENDIF
		*************************************************************
		*--------------------------------------------------
		DO WHILE LNSrvCopIni  <= LNSrvCopFim

			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNSrvCopIni,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itenscopia
			SET NEAR ON
			SEEK STR(nota.empresa,3)+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*

			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

	   		=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp FOR LEFT(itemmov.operacao,1) = "S" ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND nota.nota	= itemmov.nf_copia
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nf_copia   TAG nota ADDITIVE

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP

	
			IF wp_dtoper < {01.05.2006}
				REPORT FORM relnfsrv ;
					WHILE nota.nota = LNSrvCopIni AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 					NOCONSOLE TO PRINTER
			ELSE
				REPORT FORM relsrv02 ;
					WHILE nota.nota = LNSrvCopIni  AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 					NOCONSOLE TO PRINTER
			ENDIF

			=UNFempmarca(4,LStp_proces,LSOrientacao)
		   	=up_fecha("ITNFSTMP")

			LNSrvCopIni	= LNSrvCopIni + 1
		ENDDO
	ENDIF


	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H3A           NFinfo_Nf VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   14    º
*       º Variable:            NFinfo_Nf                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      147                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h3a     &&  NFinfo_Nf VALID
#REGION 5
return
*---------------------------------------------------------------*


FUNCTION NFinfo_Cobr
PARAMETERS  LNemp,LNnronota,LNserie
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Fornece Numero,DataVenc. e Valor de Duplicata
	*			Formatados para RELNFS
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNnronota......: Nro da Nata p/ busca de dados
	*		LNserie........: Ordem do Doc. a ser Buscado (1,2,3..)
	*------------------------------------------------------------*
	*  RETORNO.....:   NUMERODUP+ DT.VENC + VLR.DUP
	*					99999-99 dd.mm.aa  999999,99
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA RELNFS
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSretorno
	PRIVATE LNNroDup
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LSretorno	=	REPLICATE("-",44)
	*------------------------------------------------------------*
*	IF LNemp <> 10
*		LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
*								  CHRTRAN(STR(LNserie,1)," ","0")+;
*								  STR(LNemp,1)))   && 1 => DUPLICATA
*	ELSE
*		LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
*								  CHRTRAN(STR(LNserie,1)," ","0")+;
*								  "0"))   && 1 => DUPLICATA
*	ENDIF

	LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA

	SELE duplicat
	SET ORDER TO TAG doc
	SEEK STR(LNemp,3)+STR(LNNroDup,9)


	*--------------------------------------------------------------------*
	*    Serao retornados dados para doc com :
	*			Forma de Pagamento =  3  (CHEQUE EM GARANTIA)
	*			Forma de Pagamento =  4  (DUPLICATA)
	*
	*--------------------------------------------------------------------*
	IF FOUND() AND (duplicat.tp_parcela = 2 OR duplicat.tp_parcela = 3 )

		LSretorno = TRANSF(duplicat.duplicata,"@r 999999999")
		LSretorno = LSretorno + " "+;
			   	    TRANSF(duplicat.vlr_doc,"@r 99,999.99");
				   +SPACE(1)


		IF (duplicat.dt_venc - duplicat.dt_emi) < 8
			LSretorno = LSretorno + "C/APRES."	
		ELSE



			LStmp = ;
			    STR(DAY(duplicat.dt_venc),2);
			    +"/";
			    +RIGHT(STR(MONTH(duplicat.dt_venc),2),2) ;
			    +"/";
			    +STR(YEAR(duplicat.dt_venc),4)


			LStmp =	CHRTRAN(LStmp," ","0")			

			LSretorno = LSretorno + LSTmp
			
			
		ENDIF
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H3B           NFinfoCbrSrv VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   15    º
*       º Variable:            NFinfoCbrSrv                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      148                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h3b     &&  NFinfoCbrSrv VALID
#REGION 5
return
*---------------------------------------------------------------*


FUNCTION NFinfoCbrSrv
PARAMETERS  LNemp,LNnronota,LNserie
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Fornece Numero,DataVenc. e Valor de Duplicata
	*			Formatados para RELNFS
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNnronota......: Nro da Nata p/ busca de dados
	*		LNserie........: Ordem do Doc. a ser Buscado (1,2,3..)
	*------------------------------------------------------------*
	*  RETORNO.....:   NUMERODUP+ DT.VENC + VLR.DUP
	*					99999-99 dd.mm.aa  999999,99
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA RELNFS
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSretorno
	PRIVATE LNNroDup
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LSretorno	=	REPLICATE("-",44)
	*------------------------------------------------------------*
	IF LNemp <> 10
		LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  STR(LNemp,1)))   && 1 => DUPLICATA
	ELSE
		LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  "0"))   && 1 => DUPLICATA
	ENDIF
	SELE duplicat
	SET ORDER TO TAG doc
	SEEK STR(LNemp,3)+STR(LNNroDup,9)
	*--------------------------------------------------------------------*
	*    Serao retornados dados para doc com :
	*			Forma de Pagamento =  3  (CHEQUE EM GARANTIA)
	*			Forma de Pagamento =  4  (DUPLICATA)
	*
	*--------------------------------------------------------------------*
	IF FOUND() AND (duplicat.tp_parcela = 2 OR duplicat.tp_parcela = 3 )
		LSretorno = TRANSF(duplicat.duplicata,"@r 999999999")+SPACE(1)
		IF (duplicat.dt_venc - duplicat.dt_emi) < 8
			LSretorno = LSretorno + "C/APRES."+SPACE(4)
		ELSE
			LSretorno = LSretorno + DTOC(duplicat.dt_venc)+SPACE(4)
		ENDIF

		LSretorno = LSretorno + ;
				TRANSF(duplicat.vlr_doc,"@r 999,999.99")
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H3C           NFinfoSrvCbr VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   16    º
*       º Variable:            NFinfoSrvCbr                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      149                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h3c     &&  NFinfoSrvCbr VALID
#REGION 5
return
*---------------------------------------------------------------*


FUNCTION NFinfoSrvCbr
PARAMETERS  LNemp,LNnronota,LNserie
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Fornece Numero,DataVenc. e Valor de Duplicata
	*			Formatados para RELNFS
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNnronota......: Nro da Nata p/ busca de dados
	*		LNserie........: Ordem do Doc. a ser Buscado (1,2,3..)
	*------------------------------------------------------------*
	*  RETORNO.....:   NUMERODUP+ DT.VENC + VLR.DUP
	*					99999-99 dd.mm.aa  999999,99
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA RELNFS
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSretorno
	PRIVATE LNNroDup
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LSretorno	=	REPLICATE("-",44)
	*------------------------------------------------------------*
	IF LNemp <> 10
		LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  STR(LNemp,1)))   && 1 => DUPLICATA
	ELSE
		LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  "0"))   && 1 => DUPLICATA
	ENDIF
	SELE duplicat
	SET ORDER TO TAG doc
	SEEK STR(LNemp,3)+STR(LNNroDup,9)
	*--------------------------------------------------------------------*
	*    Serao retornados dados para doc com :
	*			Forma de Pagamento =  3  (CHEQUE EM GARANTIA)
	*			Forma de Pagamento =  4  (DUPLICATA)
	*
	*--------------------------------------------------------------------*
	IF FOUND() AND (duplicat.tp_parcela = 2 OR duplicat.tp_parcela = 3 )
		LSretorno = TRANSF(duplicat.duplicata,"@r 999999999")+SPACE(1)
		IF (duplicat.dt_venc - duplicat.dt_emi) < 8
			LSretorno = LSretorno + "C/APRES."+SPACE(9)
		ELSE
			LSretorno = LSretorno + DTOC(duplicat.dt_venc)+SPACE(9)
		ENDIF

		LSretorno = LSretorno + ;
				TRANSF(duplicat.vlr_doc,"@r 999,999.99")
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H3D           UNFmarcanf VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   17    º
*       º Variable:            UNFmarcanf                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      150                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123h3d     &&  UNFmarcanf VALID
#REGION 5
RETURN

FUNCTION UNFmarcanf
	PARAMETERS LNflag
	SELE nota
	=REGLOCK(.T.)
	REPLACE FLAGPROCES	WITH 	LNflag	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H3E           UNFEmpMarcanf VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   18    º
*       º Variable:            UNFEmpMarcanf                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      151                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123h3e     &&  UNFEmpMarcanf VALID
#REGION 5
RETURN

FUNCTION UNFempmarca
	PARAMETERS PrmFlag,PrmTp_Process,PrmOrientacao
	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)
	
	DO CASE

		* CASES ANTIGOS ==> ANTES 15/03/2006

		CASE PrmOrientacao  = "SERVICO"
			REPLACE FLAGIMPSRV 	WITH PrmFlag	

		CASE PrmTp_Process = "NOTA" OR PrmTp_Process = "NOTA/CUPOM"
			REPLACE FLAGIMPNF 	WITH PrmFlag	

		CASE PrmTp_Process = "CUPOM"
			REPLACE FLAGIMPCPM 	WITH PrmFlag	


		* CASE NOVOS ==> APOS 15/03/2006


		CASE "CUPOM" $ Prmtp_proces
			REPLACE FLAGIMPCPM 	WITH PrmFlag	

		CASE "NOTA" = Prmtp_proces ;
			AND PrmOrientacao = "PRODUTO/SERVICO"
			REPLACE FLAGIMPNF 	WITH PrmFlag	

		CASE "NOTA" = Prmtp_proces AND PrmOrientacao = "PRODUTO"
			REPLACE FLAGIMPNF 	WITH PrmFlag	

		CASE "NOTA/NF SERVICO" = Prmtp_proces ;
		   AND PrmOrientacao = "PRODUTO"
			REPLACE FLAGIMPNF 	WITH PrmFlag	

		CASE "NOTA/NF SERVICO" = Prmtp_proces ;
		   AND PrmOrientacao = "SERVICO"
			REPLACE FLAGIMPSRV 	WITH PrmFlag	

		CASE "NF SERVICO" = Prmtp_proces
			REPLACE FLAGIMPSRV 	WITH PrmFlag	


		CASE "COPIA EM NOTA" $ Prmtp_proces
			REPLACE FLAGIMPNF 	WITH PrmFlag	


		CASE "COPIA EM NF SERVICO" = Prmtp_proces
			REPLACE FLAGIMPSRV 	WITH PrmFlag	




	ENDCASE
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H4J           ULbaixa_Saldo VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   19    º
*       º Variable:            ULbaixa_Saldo                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      152                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123h4j     &&  ULbaixa_Saldo VALID
#REGION 5
RETURN

PROCEDURE ULbaixa_saldo  && VERIFICA POSSIBILIDADE DE  BAIXA  NO ESTOQUE
PARAMETERS LSsolicitante
	*----------------------------------------------------------*
   	PRIVATE LFlockReg
	PRIVATE LFabreAuto
   	LFlockReg	= .t.	&& BLOQUEAR REGISTRO
    LFabreAuto	= .f. 	&& NAO ABRIR CONTROLE AUTOMATICAMENTE
	=W_DEFPROC("ESTOQUE.SPR")
	IF !ESversaldo(orcatmp.empresa,orcatmp.codigo ,;
					wp_dtoper,orcatmp.qtde,orcatmp.qtderes,LFabreAuto,;
					LFlockReg,"SAIDA",orcament.hora_fat,tipooper.movestq)
     	RETURN .F.
   	ENDIF
	*----------------------------------------------------------*
RETURN .T.



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H4R           NFNfSrvExstCop VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   20    º
*       º Variable:            NFNfSrvExstCop                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      153                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h4r     &&  NFNfSrvExstCop VALID
#REGION 5
return
*---------------------------------------------------------------*


FUNCTION NFNfSrvExstCop
PARAMETER PrmEmpresa,PrmNota

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*-----------------------------------------------------------*
	PRIVATE LStipo,LNnf, LNcopiaNF
    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO
	PRIVATE LNemp,LNosi


	SET NEAR ON
	SELE nota
	SET ORDER TO TAG referencia
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	SET NEAR OFF

	DO WHILE !EOF() AND nota.referencia = PrmNota
		IF nota.nota > 2000000 and nota.nota < 3000000
			IF nota.STATUS <> 2
				IF !EMPTY(LSalias) AND USED(LSalias)
					SELECT &LSalias
				ENDIF
				RETURN(.T.)
			ENDIF
		ENDIF
		SKIP
	ENDDO
	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.F.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H4X           NFNfN1ExstCop VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   21    º
*       º Variable:            NFNfN1ExstCop                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      154                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h4x     &&  NFNfN1ExstCop VALID
#REGION 5
return
*---------------------------------------------------------------*


FUNCTION NFNfN1ExstCop
PARAMETER PrmEmpresa,PrmNota

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*-----------------------------------------------------------*
	PRIVATE LStipo,LNnf, LNcopiaNF
    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO
	PRIVATE LNemp,LNosi


	SET NEAR ON
	SELE nota
	SET ORDER TO TAG referencia
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	SET NEAR OFF

	DO WHILE !EOF() AND nota.referencia = PrmNota
		IF nota.nota < 1000000 ;
		  OR (nota.nota > 3000000 and nota.nota < 4000000)
			IF nota.STATUS <> 2
				IF !EMPTY(LSalias) AND USED(LSalias)
					SELECT &LSalias
				ENDIF
				RETURN(.T.)
			ENDIF
		ENDIF
		SKIP
	ENDDO
	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.F.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H56           NFProcessCopia VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   22    º
*       º Variable:            NFProcessCopia                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      155                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h56     &&  NFProcessCopia VALID
#REGION 5
return
*---------------------------------------------------------------*


FUNCTION NFProcessCopia
PARAMETER ;
	PrmEmpresa,;
	PrmNota,;
	PrmSolicitante,;
	PrmChamadoPor,;
	PrmCopySrvAutoriza,;
	PrmCopyN1Autoriza



	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*-----------------------------------------------------------*

	PRIVATE FlgImpFatura


	PRIVATE LStipo,LNnf, LNcopiaNF
    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO
	PRIVATE LNemp,LNosi

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND() OR nota.nota < 1000000 && < 1000000 nao e cupom
	   WAIT WINDOW ;
   		" Item selecionado nao e um Cumpom <ENTER>"
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SCATTER MEMVAR
	*-------------------------------------------------------------------*
	LNCtrlCupomIni = m.nota
	LNCtrlCupomFim = m.nota


	IF TYPE("LStp_proces") = "U" OR !("REC." $ LStp_proces)
	    LNnfInicio     = 0
	    LNnfFim        = 0
	    LNnfsrvIni     = 0
	    LNnfsrvFim     = 0
		LNnfCopInicio  = 0
		LNnfCopFim	   = 0
		LNSrvCopIni  = 0
		LNSrvCopFim  = 0
	ENDIF

	LNemp        = m.empresa
	LNosi        = m.referencia
	*-------------------------------------------------------------------*
	*----------  				INICIA COPIA DO CUPOM			--------*
	*-------------------------------------------------------------------*



	LFipi = .f.
	LFproduto = .f.
	LFservico = .f.
	IF nota.totproduto > 0
		LFproduto = .T.
	ENDIF
	IF nota.totservico >0
		LFservico = .T.
	ENDIF
	IF nota.vlr_ipi > 0
		LFipi = .T.
	ENDIF


	*-----------------------------------------------------------------*
	*  DefProcessCopia - Define Processao para  emissao da copia
	*-----------------------------------------------------------------*
	*-----------------------------------------------------------*
	PRIVATE LSemi_NF,LSemi_NFe,LSemi_NFS,LSemi_NFSe,LSemi_ECF
	PRIVATE LSscr_NF,LSscr_NFe,LSscr_NFS,LSscr_NFSe,LSscr_ECF

	*------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NF = EMGetFieldValue(PrmEmpresa,"EMITE_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFe = EMGetFieldValue(PrmEmpresa,"EMITE_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFS = EMGetFieldValue(PrmEmpresa,"EMITE_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFSe = EMGetFieldValue(PrmEmpresa,"EMITE_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_ecf = EMGetFieldValue(PrmEmpresa,"EMITE_ECF")

	*------------------------------------------------------------*

	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NF = EMGetFieldValue(PrmEmpresa,"ESCRT_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFS = EMGetFieldValue(PrmEmpresa,"ESCRT_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFSe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ecf = EMGetFieldValue(PrmEmpresa,"ESCRT_ECF")


	*------------------------------------------------------------*

	*------------------------------------------------------------*

	LStp_process = ""


 	*----------------------------------------*
 	**  SE HOUVER COPIA EM NOTA N1
 	*----------------------------------------*
	IF PrmCopyN1Autoriza
		DO CASE		&& DEFINE SE HAVERA COPIA EM NOTA

			CASE  LFipi= .T.
				LStp_proces	= LStp_proces+"/COPIA EM NOTA"

			CASE  LFproduto = .T.
				LStp_proces	= LStp_proces+"/COPIA EM NOTA"

			CASE  LFservico = .T. ;
				  AND (LSemi_NFS = "N" AND LSemi_NFSe = "N")
				LStp_proces	= LStp_proces+"/COPIA EM NOTA"

		ENDCASE
	ENDIF


 	*----------------------------------------*
 	**  SE HOUVER COPIA EM NOTA SERVICO
 	*----------------------------------------*
	IF LSemi_NFS = "S" OR  LSemi_NFSe = "S"
		IF	PrmCopySrvAutoriza
			IF LFservico = .T.
					LStp_proces	= LStp_proces+"/COPIA EM NF SERVICO"
			ENDIF
		ENDIF
		*-----------------------------------------
	ENDIF


	*-----------------------------------------------------------*
	

	PrmObjetivo = "NAO INTEGRAR"

	
	DO CASE
		CASE (PrmSolicitante $ "IMPORTACAO/RECUPERACAO")


			IF "COPIA EM NF SERVICO" $ LStp_proces
				DO CASE
					CASE LSemi_NFS = "S" OR LSemi_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE
			ENDIF


			IF  "COPIA EM NOTA" $ LStp_proces
				DO CASE
					CASE LSemi_NF = "S" OR LSemi_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE

			ENDIF



		CASE (PrmSolicitante $ "RECUPERACAO")

			IF "COPIA EM NF SERVICO" $ LStp_proces
				DO CASE
					CASE LSemi_NFS = "S" OR LSemi_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE
			ENDIF


			IF  "COPIA EM NOTA" $ LStp_proces
				DO CASE
					CASE LSemi_NF = "S" OR LSemi_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE
	
			ENDIF

		OTHERWISE

			IF "COPIA EM NF SERVICO" $ LStp_proces
				DO CASE
					CASE LSemi_NFS = "S" OR LSemi_NFSe = "S" 				
		 				PrmObjetivo = "EMISSAO"

					CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE
			ENDIF


			IF  "COPIA EM NOTA" $ LStp_proces
				DO CASE
					CASE LSemi_NF = "S" OR LSemi_NFe = "S" 				
		 				PrmObjetivo = "EMISSAO"

					CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE

			ENDIF
		

	ENDCASE


	*--------------------------------------------------------------*

	*--------------------------------------------------------------*

	*-----------------------------------------------------------------*
	*  GeraDocCopia - Gera Documento Fiscal de Copia
	*-----------------------------------------------------------------*


	IF  "COPIA EM NOTA" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"

		IF  "NF SERVICO" $ LStp_proces OR nota.empresa = 6
			LsOrientacao = "PRODUTO"
		ENDIF
		*--------------------------------------------*
		IF !NFGerCopia(nota.empresa,LNCtrlCupomIni,;
  	     "NOTA",LNnfCopInicio,LNnfCopFim,LSOrientacao,;
  	     (PrmSolicitante),LStp_proces)
			SELE orcament
			RETURN(.F.)
		ENDIF	

	ENDIF
		
		

	IF "COPIA EM NF SERVICO" $ LStp_proces
		LsOrientacao = "SERVICO"
		*--------------------------------------------*
		IF !NFGerCopia(nota.empresa,LNCtrlCupomIni,;
		 "NF SERVICO",LNSrvCopIni,LNSrvCopFim,LSOrientacao,;
			(PrmSolicitante),LStp_proces)
			SELE orcament
			RETURN(.F.)
		ENDIF	
	ENDIF

	*---------------------------------------------------------------*
	* PARA NFe GERAR DOCFISCA E DOCFISIT
	*---------------------------------------------------------------*



	*---------------------------------------------------------------*
	* PARA IMPORTACAO E RECUPERACAO NAO FAZER IMPRESSAO NEM XML NFe
	*---------------------------------------------------------------*
	=W_DEFPROC("NOTA.SPR")
	IF  PrmSolicitante $ "IMPORTACAO - RECUPERACAO"
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		=UNFempmarca(4,"COPIA EM NOTA","")
		=UNFempmarca(4,"COPIA EM NF SERVICO","")
		wp_msg = "Faturamento Concluido "
		WAIT WINDOW wp_msg NOWAIT
	    RETURN(.T.)
	ENDIF


    WAIT WINDOW "Aguarde a Impressao." NOWAIT

	*---------------------------------------------------------------*
	* PARA NFe GERAR XML OU IMPRIMIR QUANDO FOR NOTA NORMAL
	*---------------------------------------------------------------*

	FlgImpFatura =  NF_CopNFSrvImprime(;
			(LNemp),(LNosi),(LStp_process),;
			(wp_TipoEcf),(LNecf),(LNCtrlCupomIni), (LNCtrlCupomFim),;
			(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
			(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))


	IF FlgImpFatura  = .T.
		FlgImpFatura =  NF_CopNF_Imprime(;
			(LNemp),(LNosi),(LStp_process),;
			(wp_TipoEcf),(LNecf),(LNCtrlCupomIni), (LNCtrlCupomFim),;
			(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
			(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))
	ENDIF




*	IF FlgImpFatura  = .T.
*		FlgImpFatura =  NF_CopNFe_Imprime(;
*			(LNemp),(LNosi),(LStp_process),;
*			(wp_TipoEcf),(LNecf),(LNCtrlCupomIni), (LNCtrlCupomFim),;
*			(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
*			(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))
*	ENDIF

*	IF FlgImpFatura  = .T.
*		FlgImpFatura =  NF_CopNFSe_Imprime(;
*			(LNemp),(LNosi),(LStp_process),;
*			(wp_TipoEcf),(LNecf),(LNCtrlCupomIni), (LNCtrlCupomFim),;
*			(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
*			(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))
*	ENDIF
*

	=W_DEFPROC("rotinas.spr")

	*---------------------------------------------------------------*
	IF !FlgImpFatura
			
	    	WAIT WINDOW "Houve Falha no Impressao do Doc.Fiscal!!!!"
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
	ELSE
			=NF_aviso(LNEMP,LNnfCopInicio,LNCtrlCupomIni,;
						PrmSolicitante,LStp_proces)

	ENDIF
	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H57           NFGerCopia VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   23    º
*       º Variable:            NFGerCopia                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      156                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h57     &&  NFGerCopia VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NFGerCopia
PARAMETERS PrmEmpresa,PrmCupom,PrmTpCopia,PrmCopInicio,PrmCopFim,;
           PrmOrientacao,PrmSolicitante,Prmtp_proces
*	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno

	PRIVATE LNnotaAnterior
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*------------------------------------------------------------*
	PRIVATE LStipo,LNnf, LNcopiaNF
    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO

	**********************************************************************
	LFIMPDESCT = .F.

	******>>>> INICIO CONTROLE ARQUIVOS

	
	IF  PrmSolicitante = "IMPORTACAO"
		SELE &LSalias
	    RETURN(.T.)
	ENDIF

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmCupom,7)

	IF !FOUND() OR  nota.nota < 1000000 && < 1000000 nao e cupom
	   WAIT WINDOW ;
   		" Item selecionado nao e um Cumpom <ENTER>"
		SELE &LSalias
	    RETURN(.F.)
	ENDIF
	IF nota.status = 2
	   WAIT WINDOW ;
   		" Cupom selecionado esta Cancelado <ENTER>"
		SELE &LSalias
	    RETURN(.F.)
	ENDIF
	SCATTER MEMVAR
	*-------------------------------------------------------------------*
	*-------				INICIA COPIA DO CUPOM				--------*
	*-------------------------------------------------------------------*
	SELECT empresa
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK m.empresa				&& EMPRESA OPERADORA DO SISTEMA

	IF !FOUND()
	   WAIT WINDOW ;
   		" Recadastrar a Empresa Gereciadora do Sistema <Suporte Sistema>"
		SELE orcament
		RETURN(.f.)
	ENDIF
	IF !REGLOCK()
	   	WAIT WINDOW "Nao foi possivel bloquear reg. Empresa p/ parametros"
	   	SELE orcament
		RETURN(.f.)
	ENDIF
	SELE empresa
	m.datanf		= wp_dtoper      && REGISTRA A DATA DA GERACAO DA NF
	m.horanf		= time()		 && REGISTRA A HORA
	*------------
	m.dtfat		   = m.datanf
	m.data		   = m.datanf
	m.hora 		   = m.horanf
	*------------


	DO CASE
		CASE PrmTpCopia = "NF SERVICO"
			IF PrmCopInicio > 0
				m.nota          = PrmCopInicio
			ELSE
				m.nota          = empresa.ult_nfsrvc + 1
			ENDIF

			IF UPPER(empresa.emite_NFSe) = "S"
				m.nota   = m.nota  + 4000000
			ENDIF

			IF m.nota < 2000000
				m.nota = m.nota + 2000000
			ENDIF
			PrmCopInicio   	= m.nota
			PrmCopFim    	= m.nota
		CASE PrmTpCopia = "NOTA"
			IF PrmCopInicio > 0
				m.nota          = PrmCopInicio
			ELSE
				m.nota     		= empresa.nota + 1

				IF UPPER(empresa.emite_NFe) = "S"
					m.nota   = m.nota  + 3000000
				ENDIF

			ENDIF


			PrmCopInicio   	= m.nota
			PrmCopFim    	= m.nota

	ENDCASE
	m.doc_cobr 		= doc_cobr
	m.referencia	= nota.nota		&& O cupom e a referencia da nota



	DO CASE
		CASE PrmTpCopia = "NF SERVICO"
			IF (m.nota > 2000001 AND m.nota <= 2999999) ;
			   OR  ;
			   (m.nota > 4000001 AND m.nota <= 5999999)
				LNnotaAnterior = VAL(SUBS(STR(m.nota - 1,7),2))
				SELE nota
				SEEK STR(m.empresa,3)+STR(m.nota - 1,7)
				IF !FOUND()
			       WAIT WINDOW ;
			        "Nro Anterior Doc Indicado"+;
			           " para Copia nao emitido. "+STR(m.nota-1,7)
				   SELE orcament
				   RETURN(.f.)
				ENDIF
		    ENDIF




		CASE PrmTpCopia = "NOTA"

			IF (m.nota > 1 AND m.nota <= 999999);
			   OR  ;
			   (m.nota > 3000001 AND m.nota <= 3999999)
				LNnotaAnterior = VAL(SUBS(STR(m.nota - 1,7),2))
				SELE nota
				SEEK STR(m.empresa,3)+STR(m.nota - 1,7)
				IF !FOUND()
			       WAIT WINDOW ;
			        "Nro Anterior Doc Indicado"+;
			           " para Copia nao emitido. "+STR(m.nota-1,7)
				   SELE orcament
			       RETURN(.f.)
			    ENDIF
		    ENDIF

	ENDCASE





	SELE nota
	SEEK STR(m.empresa,3)+STR(m.nota,7)
	IF FOUND()
       WAIT WINDOW "Nro Doc Indicado para Copia ja emitido. "+STR(m.nota,7)
	   SELE orcament
	   RETURN(.f.)
	ENDIF



	LFflgtrans = .t.


	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmCupom,7)

	SELE itemmov
	SET ORDER TO TAG NOTA
	SEEK STR(PrmEmpresa,3)+LEFT(m.operacao,1)+STR(PrmCupom,7)	
    ******************************************************************
   	DO WHILE !eof() AND PrmEmpresa    = itemmov.empresa ;
    				AND PrmCupom      = itemmov.nota ;
    				AND nota.operacao = LEFT(itemmov.operacao,1)
		LNctritens = 0

  		STORE 0 TO	LNsoma_vlr,LNbs_iss,LNvl_iss,LNbs_icms,;
  				LNvl_icms,LNbs_sbbrt,LNbs_subs,LNvl_subs,;
  				LNbs_isent,LNbs_outr,LNbs_isipi,LNbs_ipi,;
  				LNvl_ipi

		SELECT  itemmov



		*---------------------------------------------------*
		*  A PARTIR DE 10/09/2008 SE O NUMERO DE ITENS OCUPAR
		* MAIS DE UM FORMULARIO SERAMANTIDO O MESMO NUMERO DE
		* NF E A TATALIZACAO DAIMPRESSAO OCORRERA NA ULTIMA NF
		*------> REQUISICAO ? JOAO NUNES CONTADOR
		*---------------------------------------------------*
	
    	DO WHILE !eof() AND PrmEmpresa    = itemmov.empresa ;
    				AND PrmCupom          = itemmov.nota ;
    				AND nota.operacao = LEFT(itemmov.operacao,1)



			*---------------------------------------------------*
			*  A PARTIR DE 10/09/2008 SE O NUMERO DE ITENS OCUPAR
			* MAIS DE UM FORMULARIO SERAMANTIDO O MESMO NUMERO DE
			* NF E A TATALIZACAO DAIMPRESSAO OCORRERA NA ULTIMA NF
			*------> REQUISICAO ? JOAO NUNES CONTADOR
			*---------------------------------------------------*
			IF m.dtfat < {28.09.2008}
				IF  LNctritens >= 11
					EXIT
				ENDIF
			ENDIF
			*---------------------------------------------------*

			IF !(LEFT(itemmov.situacao,1) $ "O")
				SKIP
				LOOP
			ENDIF
			DO CASE
				CASE PrmOrientacao = "PRODUTO"
					IF itemmov.tp_mercad = 7 && SERVICO
						SKIP
						LOOP
					ENDIF
				CASE PrmOrientacao = "SERVICO"
					IF itemmov.tp_mercad <> 7 && NAO SERVICO
						SKIP
						LOOP
					ENDIF
			ENDCASE
			*-----------------------------------------------------*
			=RLOCK()
			replace  itemmov.NF_COPIA with m.nota
			*-----------------------------------------------------*
			
    		
*	        LNsoma_vlr = LNsoma_vlr + (vlrvenda - vlripi)

	        LNsoma_vlr = LNsoma_vlr + vlrvenda



    		
			LNbs_iss	= 	LNbs_iss	+	itemmov.base_iss
			LNvl_iss	= 	LNvl_iss	+	itemmov.vlr_iss
			LNbs_icms	= 	LNbs_icms	+	itemmov.base_calc
			LNvl_icms	=	LNvl_icms	+	itemmov.vlr_icms
			LNbs_sbbrt	=	LNbs_sbbrt	+	itemmov.base_sbbrt					
			LNbs_subs 	=	LNbs_subs 	+	itemmov.base_subs 					
			LNvl_subs 	=	LNvl_subs 	+	itemmov.icms_subs 					
			LNbs_isent	=	LNbs_isent	+	itemmov.base_isent					
			LNbs_outr 	=	LNbs_outr 	+	itemmov.base_outr 					
			LNbs_isipi	=	LNbs_isipi	+	itemmov.base_isipi					
			LNbs_ipi  	=	LNbs_ipi  	+	itemmov.base_ipi  					
			LNvl_ipi  	=	LNvl_ipi  	+	itemmov.vlripi   					
			*--------------------------------------------------*
			SELECT  itemmov
			SKIP
			LNctritens = LNctritens + 1
		ENDDO
		******************************************************************
		
	 	m.base_iss	=	LNbs_iss
		m.aliq_iss	=	empresa.aliq_iss
		m.vlr_iss	=	ROUND(m.base_iss * ROUND(m.aliq_iss  / 100,4),2)
		m.totservico=	LNbs_iss

		m.base_icms	=	LNbs_icms
		m.aliq_icms	= 	ORCAMENT.aliq_icms
		m.vlr_icms	=	m.base_icms * m.aliq_icms / 100

		m.base_sbbrt= 	LNbs_sbbrt
		m.base_subs	=	LNbs_subs
		m.icms_subs	=	LNvl_subs

		m.base_isipi=	LNbs_isipi
		m.base_ipi	=	LNbs_ipi
		m.vlr_ipi	=	LNvl_ipi


		m.base_isent=	LNbs_isent
		m.base_outr	=	LNbs_outr

		m.totservico =	LNbs_iss
		m.totproduto =  LNsoma_vlr - m.totservico
		m.total_nota =	LNsoma_vlr + m.icms_subs + ;
						m.vlrfrete + m.vlrseguro + ;
						m.vlr_ipi

		******************************************************************





		m.tipo  		= "CPM"   		&& COPIA DE CUPOM
		m.status 		= 1
		m.operacao 		= "C"			&& COPIA
		SELE nota
		m.orcamento = NOTA.orcamento

		=edithand('SAVE')
		SELE nota
		SET ORDER TO TAG nota
		SEEK STR(PrmEmpresa,3)+STR(PrmCupom,7)

		SELECT  itemmov

		STORE 0 TO 	m.vlrfrete, m.vlrseguro
		m.nota  		= m.nota + 1

	ENDDO
	m.nota  		= m.nota - 1

	*--------------------------------------------------------*
	* AJUSTA DUPLICATAS PARA REFERNCIAREM A NF COPIA DO CUPOM
	*--------------------------------------------------------*
	IF  PrmTpCopia = "NOTA"
		=W_DEFPROC("DUPLICAT.SPR")
		=CRAlteraFatura((m.empresa),(m.referencia),(m.nota))
	ENDIF


	*----------------------------------------------------------------*
	PRIVATE LSobjetivo
	LSobjetivo = NFDefEnvDFis((m.empresa),(m.nota))

	IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"
		IF !(NF_GeraDFis((m.empresa),(m.nota),LSobjetivo,PrmOrientacao ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou Emissao."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	*--------------------------------------------------------*


	SELE empresa					&& altera parametros em empresa

	DO CASE
		CASE PrmSolicitante = "IMPORTACAO"
			m.nota          = PrmCopInicio
			PrmCopFim    	= m.nota

		CASE PrmTpCopia = "NF SERVICO"
			IF !("REC." $ Prmtp_proces)
				*---------------------------------------------------------*
				=UNFempmarca(3,"COPIA EM NF SERVICO","")
				*---------------------------------------------------------*
				DO CASE

					CASE m.nota > 2000000 and m.nota < 3000000
						REPLACE empresa.ult_nfsrvc WITH m.nota - 2000000

					CASE m.nota > 4000000 and m.nota < 5000000
						REPLACE empresa.ult_nfsrvc WITH m.nota - 4000000
				ENDCASE
			ENDIF

		CASE PrmTpCopia = "NOTA"
			IF !("REC." $ Prmtp_proces)
				*---------------------------------------------------------*
				=UNFempmarca(3,"COPIA EM NOTA","")
				*---------------------------------------------------------*
				REPLACE empresa.nota WITH empresa.nota + 1
			ENDIF

	ENDCASE





	PrmCopFim    	= m.nota
	*******************************************************
	*LNcopiaNF		= m.nota		&& INDICA NRO P/ RELNFS
	*******************************************************
	*---------------------------------------------------------------*
	* 				Fim  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H6F           NFverClasOSI VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   24    º
*       º Variable:            NFverClasOSI                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      157                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h6f     &&  NFverClasOSI VALID
#REGION 5
return

*---------------------------------------------------------------*


FUNCTION NFverClasOSI
PARAMETERS PrmEmpresa,PrmOrcamento

	*---------------------------------------------------------*
	*=================>>>  VERIFICA CLASSIFICACAO
	*=================>>>  SE O CLIENTES TIVER SIDO ALTERADO
	*---------------------------------------------------------*

	PRIVATE  LFretorno
	LFretorno = .t.


	LStpantnfrot = orcament.tipo   && A Rotina de Atualizcao
								   && pode alterar o tipo
								
	=W_DEFPROC("ORCAMENT.SPR")
	=ORAtlz_Clie(PrmEmpresa,PrmOrcamento)

	*---------------------------------------------------------*
	*  EM IMPORTACAO NAO RECALCULA ITENS
	*---------------------------------------------------------*
	IF LStpantnfrot <> orcament.tipo
  			wp_msg = "Atencao!!! "+CHR(13)+;
   			"  Devido a Alteracoes do Cadasto do Cliente a Operacao "+;
  				chr(13)+;
 				"Foi Reclassificada Para "+orcament.tipo+chr(13)+chr(13)+;
  				" Podendo Afetar o Valor. Verrifique e Repita a Operacao."
		=UPbeeps(.f.,wp_msg)
		SELE ORCAMENT

		*---------------------------------------------------------*
		=W_DEFPROC("ORCAMENT.SPR")
		=ORrecalc_OSI((PrmEmpresa),(PrmOrcamento))
		*---------------------------------------------------------*
		RETURN(.F.)
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H6O           NFchqLiberCred VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   25    º
*       º Variable:            NFchqLiberCred                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      158                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h6o     &&  NFchqLiberCred VALID
#REGION 5
return

*---------------------------------------------------------------*


FUNCTION NFchqLiberCred
PARAMETERS PrmEmpresa,PrmOrcamento


		*---------------------------------------------------*

		LSl = LEFT(orcament.situacao,1)
		LSr = RIGHT(orcament.situacao,1)



		IF  LSr $ "Do" AND (orcament.tp_parcela > 1)
			WAIT WINDOW ;
			"O orcamento aguarda Liberacao. Execute <Lib.Credito> "
			RETURN(.F.)
		ENDIF

		IF  LSr $ "F"
			WAIT WINDOW ;
				"O orcamento Com Credito Bloqueado. Execute <Lib.Credito> "
			RETURN(.F.)
		ENDIF

		IF LSr $ "D"
			WAIT WINDOW "OSI. Aguardando Liberacao de Credito. "
			RETURN(.F.)
		ENDIF

		*---------------------------------------------------*

	    SELE liberaco
		SET ORDER TO TAG liberacao
		SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
		IF !FOUND() OR liberaco.situacao <> "LIBE"
			WAIT WINDOW ;
				"NÆo Consta Libera‡Æo de Credito Para OSI"
			RETURN(.F.)
		ENDIF
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H6P           NFinfoCompl VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   26    º
*       º Variable:            NFinfoCompl                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      159                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h6p     &&  NFinfoCompl VALID
#REGION 5
return

*---------------------------------------------------------------*

FUNCTION NFinfoCompl
PARAMETERS PrmEmpresa,PrmOrcamento

	*****************************************************************
	* 				Inicio Informacoes Complementares
	*****************************************************************
	*------------------------------------------------------------------*
	LFretorno = .t.  		&& CASO SEJA CANCELADO VOLTA .F.
	HIDE WINDOW ALL
	*---------------------------------------------------------------*

	DO OBJFATU2.SPR WITH PrmEmpresa,PrmOrcamento,LFretorno

	*---------------------------------------------------------------*

RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H6Q           FCHrot_fat VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   27    º
*       º Variable:            FCHrot_fat                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      160                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h6q     &&  FCHrot_fat VALID
#REGION 5
return

*---------------------------------------------------------------*

PROCEDURE FCHrot_fat
	=UP_fecha("orcament" ,LForcament)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("clientes" ,LFclientes)
	=UP_fecha("liberaco" ,LFliberacao)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	POP KEY 			&& reabilita teclas de atalho def. anteriormente
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H6R           NFEnvioParaFat VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   28    º
*       º Variable:            NFEnvioParaFat                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      161                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h6r     &&  NFEnvioParaFat VALID
#REGION 5
return

*---------------------------------------------------------------*

FUNCTION  NFEnvioParaFat
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()

	PRIVATE LSsitRequerida  &&   Armazena a SITUACAO requrida para
							&& a operacao e repassa a ORloc_orc

	PRIVATE LForcament,LFclienc,LFclientes,LFliberacao
	PRIVATE LSalias

	*------------------------------------------------------------*
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFclientes		= NetArq("clientes")
	LFliberacao		= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFclienc+LFclientes) > 100000  && HOUVE FALHA ABERT
		DO FCHrot_fat
		RETURN(.f.)
	ENDIF



	*****************************************************************
	* 				Inicio Verificacao de Requisitos				*
	*****************************************************************
	IF TYPE("LNecf") = "U"
		LNecf	=	0
	ENDIF

	LSsitRequerida =  "M"

	CLEAR TYPEAHEAD

	SELE orcament
	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH LSsitRequerida
	*------------------------------------------------------------*
	IF  LASTKEY() = 27
		DO FCHrot_fat
		RETURN(.f.)
	ENDIF
	CLEAR TYPEAHEAD




	LNregvolta = RECNO()


	IF orcament.valor = 0
		IF !fox_alert("Orcamento com VALOR = 0. [ Continua ? ]")
			DO FCHrot_fat
			RETURN(.f.)
		ENDIF
	ENDIF

	*----------------------------------------------------------------*
	IF !NFverClasOSI(orcament.empresa,orcament.orcamento)
		DO FCHrot_fat
		RETURN(.F.)
	ENDIF
	*----------------------------------------------------------------*

	IF !NFchqLiberCred(orcament.empresa,orcament.orcamento)
		DO FCHrot_fat
		RETURN(.F.)
	ENDIF

	*----------------------------------------------------------------*


	IF !NFinfoCompl(orcament.empresa,orcament.orcamento)
		DO FCHrot_fat
		RETURN(.F.)
	ENDIF



	SELE orcament

	*****************************************************************
	LFretorno = .t.
	LFretorno = NFregEnvioFat(orcament.empresa, orcament.orcamento)

	DO FCHrot_fat
	UNLOCK ALL

RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H6S           NFRecuperaFat VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   30    º
*       º Variable:            NFRecuperaFat                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      162                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h6s     &&  NFRecuperaFat VALID
#REGION 5
return

*---------------------------------------------------------------*

FUNCTION  NFRecuperaFat
	PARAMETERS  LSsolicitante,LSemcaminhar
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()

	PRIVATE LStp_proces		&& = "CUPOM", "NOTA", "NOTA/CUPOM",
							&&   "RECUP.CUPOM", "RECUP.NOTA",
							&&			 "RECUP.NOTA/CUPOM"
	PRIVATE LFservico		&&   INDICA SE EXISTE SERVICO P/ FATURAR
	PRIVATE LFflagtrans		&&   INDICA SITUACAO DE CONCLUSAO DO PROCESSO
	PRIVATE LSsitRequerida  &&   Armazena a SITUACAO requrida para
							&& a operacao e repassa a ORloc_orc

	PRIVATE LForcament,LFclienc,LFclientes,LFliberacao
	PRIVATE LSalias

	*------------------------------------------------------------*
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFclientes		= NetArq("clientes")
	LFliberacao		= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFclienc+LFclientes) > 100000  && HOUVE FALHA ABERT
		DO FCHrot_fat
		RETURN(.f.)
	ENDIF



	*****************************************************************
	* 				Inicio Verificacao de Requisitos				*
	*****************************************************************
	IF TYPE("LNecf") = "U"
		LNecf	=	0
	ENDIF
	LSsitRequerida = ""

	LSsitRequerida =  "AIMo"


	CLEAR TYPEAHEAD

	SELE orcament
	IF !EMPTY(LSsitRequerida)
		*------------------------------------------------------------*
		=W_DEFPROC("ORCAMENT.SPR")
		DO ORloc_orc WITH LSsitRequerida
		*------------------------------------------------------------*
		IF  LASTKEY() = 27
			DO FCHrot_fat
			RETURN(.f.)
		ENDIF
	ENDIF
	CLEAR TYPEAHEAD

	LNregvolta = RECNO()



	IF orcament.valor = 0
		IF !fox_alert("Orcamento com VALOR = 0. [ Continua ? ]")
			DO FCHrot_fat
			RETURN(.f.)
		ENDIF
	ENDIF




	*----------------------------------------------------------------*
	IF !NFverClasOSI(orcament.empresa,orcament.orcamento)
		DO FCHrot_fat
		RETURN(.F.)
	ENDIF

	*----------------------------------------------------------------*


	*----------------------------------------------------------------*


	SELE orcament

	*****************************************************************
	* 				Fim Informacoes Complementares
	*****************************************************************
	LFretorno = .t.




	DO SVD0205.spr with;
			 orcament.empresa,orcament.orcamento,LFretorno


	IF LFretorno
		LFretorno = NFProcessFat(orcament.empresa,;
					 orcament.orcamento,LSsolicitante)
	ENDIF


	DO FCHrot_fat
	UNLOCK ALL
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H7L           ULGerCupom VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   31    º
*       º Variable:            ULGerCupom                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      163                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h7l     &&  ULGerCupom VALID
#REGION 5
return
*---------------------------------------------------------------*
FUNCTION ULGerCupom
PARAMETERS LsOrientacao

	LNCtrlCpmIni = LNCtrlCpmIni

	IF !("REC." $ LStp_proces)
		LFabrecupom = .T. 					
	ELSE
		LFabrecupom = .F. 					
	ENDIF

	=W_DEFPROC("NOTA.SPR")
	IF !NFFatura(orcament.empresa,;
		orcament.orcamento,(LNCtrlCpmIni),(LNcupom),;
			(LStp_proces),(m.datanf),;
			(m.horanf),(PrmSolicitante),LNCtrlCpmFim,;
			(LsOrientacao))
		********************************************
		SELE nota
		********************************************
		IF wp_dtsys = wp_dtoper
			IF 	!UPtransacao("ABORTAR")
				WAIT WINDOW ;
					"TRANSACAO NAO PODE SER DESFEITA"+;
					". VER SUPORTE."
			ENDIF			
		ENDIF
		SELE orcament
		RETURN(.F.)
	ENDIF

	*----------------------------------------------------------------*
	PRIVATE LSobjetivo
	LSobjetivo = NFDefEnvDFis(PrmEmpresa,LNCtrlCpmIni)

	IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"
		IF !(NF_GeraDFis(PrmEmpresa,LNCtrlCpmIni,LSobjetivo,(LsOrientacao)))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o Emissao."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			

	*-----------------------------------------------------------*



	LNCtrlCpmFim = LNCtrlCpmIni

RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H7P           ULGerNFSU VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   32    º
*       º Variable:            ULGerNFSU                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      164                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h7p     &&  ULGerNFSU VALID
#REGION 5
return
*---------------------------------------------------------------*
FUNCTION ULGerNFSU
PARAMETERS LsOrientacao

	PRIVATE LNNroDocFiscal


	LNnfinicio 	   = LNnfinicio
	LNNroDocFiscal = LNnfinicio

	LFabrecupom = .F. 					
	=W_DEFPROC("NOTA.SPR")
	IF !NFFatura(orcament.empresa,;
		orcament.orcamento,(LNnfinicio),(LNcupom),;
			(LStp_proces),(m.datanf),;
			(m.horanf),(PrmSolicitante),LNnffim,;
			(LsOrientacao))
		********************************************
		SELE nota
		********************************************
		IF wp_dtsys = wp_dtoper
			IF 	!UPtransacao("ABORTAR")
				WAIT WINDOW ;
					"TRANSACAO NAO PODE SER DESFEITA"+;
					". VER SUPORTE."
			ENDIF			
		ENDIF
		SELE orcament
		RETURN(.F.)
	ENDIF


	*----------------------------------------------------------------*
	PRIVATE LSobjetivo
	LSobjetivo = NFDefEnvDFis(PrmEmpresa,LNnffim)

	IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"
		IF !(NF_GeraDFis(PrmEmpresa,LNnffim,LSobjetivo,(LsOrientacao)))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou Emissao."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	*-----------------------------------------------------------*

	*-----------------------------------------------------------*


	LNnffim       = LNnffim
	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H7T           ULGerServicoNf VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   33    º
*       º Variable:            ULGerServicoNf                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      165                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h7t     &&  ULGerServicoNf VALID
#REGION 5
return
*---------------------------------------------------------------*
FUNCTION ULGerServicoNf
PARAMETERS LsOrientacao

	LsOrientacao = "SERVICO"

	LNnfsrvIni = LNnfsrvIni
	LFabrecupom = .F. 					
	*----------------------------------------------*
	=W_DEFPROC("NOTA.SPR")
	IF !NFFatura(orcament.empresa,orcament.orcamento,;
		(LNnfsrvIni),(LNcupom),(LStp_proces),(m.datanf),;
		(m.horanf),(PrmSolicitante),LNnfsrvFim,;
		LsOrientacao)
		***************************************
		SELE nota
		****************************************
		IF wp_dtsys = wp_dtoper
			IF 	!UPtransacao("ABORTAR")
				WAIT WINDOW ;
					"TRANSACAO NAO PODE SER"+;
					" DESFEITA. VER SUPORTE."
			ENDIF			
		ENDIF
		SELE orcament
		RETURN(.F.)
	ENDIF
	*----------------------------------------------------------------*
	PRIVATE LSobjetivo
	LSobjetivo = NFDefEnvDFis(PrmEmpresa,LNnfsrvFim)

	IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"

		IF !(NF_GeraDFis(PrmEmpresa,LNnfsrvFim,LSobjetivo,LsOrientacao ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou Emissao."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			

	*-----------------------------------------------------------*


	LNnfsrvFim = LNnfsrvFim
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H7Y           NFBloqEmpresa VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   34    º
*       º Variable:            NFBloqEmpresa                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      166                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h7y     &&  NFBloqEmpresa VALID
#REGION 5
return
*---------------------------------------------------------------*
FUNCTION NFBlocEmpresa
PARAMETERS PrmEmpresa,PrmSolicitante
	SELE empresa
	SET ORDER TO TAG empresa

	*********** SINALEIRO PARA NUMERO DA NOTA FISCAL
	*===============>>>>>  funciona como um sinaleiro
	SELECT empresa
	SET ORDER TO TAG empresa
	SEEK orcament.empresa				&& EMPRESA OPERADORA DO SISTEMA
	IF !FOUND()
	   WAIT WINDOW ;
	   	" Recadastrar a Empresa Gereciadora do Sistema <Suporte Sistema>"
	    SELE orcament
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*
	*		Importacao nao controla numero de nota pelo registro
	*	de EMPRESA portanto nao e necessario fazer bloqueio
	*---------------------------------------------------------------*



	IF PrmSolicitante <> "IMPORTACAO"
		IF !REGLOCK()
		   WAIT WINDOW ;
		   			"Nao foi possivel bloquear reg. Empresa p/ parametros"
		    SELE orcament
			RETURN(.F.)
		ENDIF
		IF empresa.FLAGIMPNF <> 4 OR empresa.FLAGIMPCPM <> 4 ;
		   empresa.FLAGIMPSRV <> 4

			DO CASE
				CASE empresa.FLAGIMPNF <> 4
					LSnronf = STR(empresa.nota,6)
					DO OBJ_MENS.SPR WITH ;
					"   ATENCAO !!! " +CHR(13)+CHR(13)+;
					" O Faturamento Anterior Gerou a Capa da NF. "+LSnronf+;
					" mas nao Concluiu com a impressao. CANCELE A"+;
					" NF."+LSnronf+;
					" e CANCELE O FORMULARIO P/ MANTER SEQUENCIA NUMERACAO"
				CASE empresa.FLAGIMPCPM <> 4
					LSnronf    = empresa.ult_cupom 						 				
					IF LSnronf < 1000000
						LSnronf = LSnronf + 1000000
					ENDIF
					LSnronf = STR(LSnronf,6)
					DO OBJ_MENS.SPR WITH ;
						"   ATENCAO !!! " +CHR(13)+CHR(13)+;
					" O Faturamento Anterior Gerou a Capa do REGISTRO "+;
							"DE CUPOM "+;
							" [NF.] Numero "+LSnronf+;
							" mas nao Concluiu com a impressao. CANCELE "+;
							"O REGISTRO"+LSnronf+" Para Proceguir."
				CASE empresa.FLAGIMPSRV <> 4
					LSnronf    = empresa.ult_nfsrvc 						 				
					IF LSnronf < 2000000
						LSnronf = LSnronf + 2000000
					ENDIF
					LSnronf = STR(LSnronf,6)
					DO OBJ_MENS.SPR WITH ;
						"   ATENCAO !!! " +CHR(13)+CHR(13)+;
					" O Faturamento Anterior Gerou a Capa do REGISTRO "+;
							"DE NF. SERVICO "+;
							" [NF.] Numero "+LSnronf+;
							" mas nao Concluiu com a impressao. CANCELE "+;
							"O REGISTRO"+LSnronf+" Para Proceguir."
			ENDCASE
    		SELE orcament
			RETURN(.F.)
		ENDIF
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H84           ANTNFGeraDocFiscais VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   36    º
*       º Variable:            ANTNFGeraDocFiscais                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      167                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h84     &&  ANTNFGeraDocFiscais VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION ANTNFGeraDocFiscais
PARAMETERS PrmEmpresa


	IF  "CUPOM" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		*--------------------------------------------*

		IF !ULGerCupom()
			RETURN(.F.)
		ENDIF
	ENDIF




	IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
		LsOrientacao = "SERVICO"
		*--------------------------------------------*
		IF !ULGerServicoNf()
			RETURN(.F.)
		ENDIF
	ENDIF


	IF  "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF
		*--------------------------------------------*
		IF !ULGerNFSU()
			RETURN(.F.)
		ENDIF
	ENDIF

RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H87           NFatlzOrcament VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   37    º
*       º Variable:            NFatlzOrcament                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      168                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h87     &&  NFatlzOrcament VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NFatlzOrcament

	SELECT orcament
	=REGLOCK(.T.)

	IF PrmSolicitante = "VENDEDOR" OR PrmSolicitante = "CAIXA"
		m.situacao 	= "O"+RIGHT(orcament.situacao,1)
	ELSE
		m.situacao 	= "OC"
	ENDIF



	DO CASE
    	CASE "CUPOM" $ LStp_process
			REPLACE nota     	WITH LNCtrlCpmIni
			IF "NF SERVICO" $ LStp_process
				REPLACE nfservico  	WITH LNnfsrvIni
			ELSE
				REPLACE nfservico  	WITH 0
			ENDIF
    	CASE "NOTA" $ LStp_process
			REPLACE nota     	WITH LNnfinicio
			IF "NF SERVICO" $ LStp_process
				REPLACE nfservico  	WITH LNnfsrvIni
			ELSE
				REPLACE nfservico  	WITH 0
			ENDIF
    	CASE "NF SERVICO" $ LStp_process
			REPLACE nota     	WITH LNnfsrvIni
			REPLACE nfservico  	WITH LNnfsrvIni
	ENDCASE
	
	REPLACE cupom 		WITH m.cupom
	REPLACE dt_fat 		WITH m.datanf
	REPLACE	hora_fat 	WITH m.horanf
	REPLACE qtdnfgerad 	WITH LNnffim - LNnfinicio + 1 && Nro. de NF GERADAS
	***************************
	SET FIELDS TO situacao,dtregis, hregis, usrregis,deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF

RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H88           NF_02ImpCopia VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   41    º
*       º Variable:            NF_02ImpCopia                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      169                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h88     &&  NF_02ImpCopia VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NF_02ImpCopia
PARAMETER PrmSolicitante, PrmCupomCopiar
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNregMarca
	PRIVATE LFcopySrvAutoriza
	PRIVATE LFcopyN1Autoriza
	PRIVATE LNEmpSelec,LNNotaSelec

	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*------------------------------------------------------------*
	PRIVATE LSdbant, LNregvolta

	*------------------------------------------------------------*
	LFIMPDESCT = .F.


	LSdbant = ALIAS()

	LNregMarca = 0
	IF TYPE("PrmCupomCopiar") <> "N"
		PrmCupomCopiar = 0
	ENDIF

	
	IF PrmCupomCopiar = 0
		LNregMarca = NFView(" and (nota > 1000000 AND nota < 2000000)")
	ENDIF


	IF LNregMarca  > 0 or PrmCupomCopiar > 0   && SELECIONOU UMA NOTA

		SELE nota
		IF PrmCupomCopiar = 0        && selecionou no browse
			LNregMarca = recno()
			LNEmpSelec = nota.empresa
			LNNotaSelec = nota.Nota

		ELSE
			LNEmpSelec  = wp_empresa
			LNNotaSelec = PrmCupomCopiar
			
		ENDIF


	
		LFcopySrvAutoriza= !NFNfSrvExstCop(LNEmpSelec,LNNotaSelec)
		LFcopyN1Autoriza = !NFNfN1ExstCop(LNEmpSelec,LNNotaSelec)

*        IF wp_empresa =  6 OR ;
*			(LFcopySrvAutoriza OR LFcopyN1Autoriza)

			


        IF (LFcopySrvAutoriza OR LFcopyN1Autoriza)
			    LFretorno = ;
		    	 NFProcessCopia(LNEmpSelec,LNNotaSelec, PrmSolicitante,;
		        	"ROTINA DE COPIA",LFcopySrvAutoriza, LFcopyN1Autoriza)
		ELSE
				WAIT WINDOW "Existem Copias Ativas. <ENTER>"
		ENDIF

	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H89           NFAjustTmpItens VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   42    º
*       º Variable:            NFAjustTmpItens                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      170                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h89     &&  NFAjustTmpItens VALID
#REGION 5
return
*---------------------------------------------------------------*


FUNCTION NFAjustTmpItens
PARAMETERS  PrmArqTmp,PrmEmpresa,PrmNota

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSretorno
	PRIVATE LNNroDup
	PRIVATE LMaxDim
	PRIVATE CtrLinhas
	PRIVATE CtrOrdem
	
	LSalias		= 	ALIAS()
	*-----------------------------------------------------------*



	SELE  &PrmArqTmp
	LMaxDim = Fcount()
    PRIVATE DIMENSION VTItem[LMaxDim]
*	INDEX ON nota,tp_mercad,ordem   TAG nota ADDITIVE
	go top

	COPY TO L:\TMP\TMITProd FOR tp_mercad <> 7

	COPY TO L:\TMP\TMITServ FOR tp_mercad = 7

	SELE 0
	USE L:\TMP\TMITProd alias TMITProd
	

	SELE 0
	USE L:\TMP\TMITServ alias TMITServ
	
	SELE  &PrmArqTmp
	zap
	pack
	
		
	*--------------------------------------------------------------*
	CtrOrdem = 1
	CtrLinhas = 0

	DO WHILE !EOF("TMITProd") OR !EOF("TMITServ")



		*-----------------------------------------
		*--> PREENCHE 21 LINHAS PARA PRODUTO
		*-----------------------------------------
		SELE TMITProd
		CtrLinhas = 0


		DO WHILE !EOF() AND CtrLinhas < 15
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1

			SCATTER TO VTItem
			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem

			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem
			REPLACE CENTROCUST   WITH "PRODUT"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas
			SELE TMITProd
			skip
		ENDDO

		SELE TMITProd
		SCATTER TO VTItem BLANK

		DO WHILE CtrLinhas  < 15
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1
			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem

			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem
			REPLACE CENTROCUST   WITH "PRODUT"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas

		
		ENDDO




		*-----------------------------------------
		*--> PREENCHE 3 LINHAS PARA Menssagem
		*-----------------------------------------
		
		SELE  &PrmArqTmp
		x=1

		FOR X = 1 TO 3
			APPEND BLANK
			GATHER FROM  VTItem

			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem

			DO CASE
				CASE X= 1
					REPLACE CENTROCUST   WITH "MSG-01"
				CASE X= 2
					REPLACE CENTROCUST   WITH "MSG-02"
				CASE X= 3
					REPLACE CENTROCUST   WITH "MSG-03"
			ENDCASE
			REPLACE Cst         WITH "*"    && linha de espaco
			CtrOrdem = CtrOrdem + 1
		NEXT
		
		
		
		*-----------------------------------------
		*--> PREENCHE 3 LINHAS PARA intervalo
		*-----------------------------------------


		SELE  &PrmArqTmp
		x=1

		FOR X = 1 TO 3
			APPEND BLANK
			GATHER FROM  VTItem

			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem
			REPLACE CENTROCUST   WITH "ESPACO"    && linha de espaco

			REPLACE Cst         WITH "*"    && linha de espaco

	
			CtrOrdem = CtrOrdem + 1
		NEXT

		*-----------------------------------------
		*--> PREENCHE 12 LINHAS PARA SERVICO
		*-----------------------------------------
		SELE TMITServ
		CtrLinhas = 0

		DO WHILE !EOF() AND CtrLinhas < 11
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1

			SCATTER TO VTItem
			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem


			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem
			REPLACE CENTROCUST   WITH "SERVIC"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas

			SELE TMITServ
			skip
		ENDDO


		SELE TMITServ
		SCATTER TO VTItem BLANK

		DO WHILE CtrLinhas  < 11
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1

			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem

			REPLACE empresa  WITH PrmEmpresa
			REPLACE nota     WITH PrmNota
			REPLACE nf_copia WITH PrmNota
			REPLACE ordem    WITH CtrOrdem
			REPLACE CENTROCUST   WITH "SERVIC"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas

		ENDDO
	ENDDO

	SELE TMITProd
	use
	SELE TMITServ
	use


	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H8A           antNF_03ImpFatura VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   43    º
*       º Variable:            antNF_03ImpFatura                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      171                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h8a     &&  antNF_03ImpFatura VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION antNF_03ImpFatura
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe


	SET STEP ON

	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------

	IF  "CUPOM" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNCtrlCupomIni,7)

		SELE itemmov
		SET ORDER TO TAG itensnota
		SET NEAR ON
		SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
		SET NEAR OFF			
		*------------------------------------------------------------*
		*  INICIA GERACAO DE ARQUIVO TEMPORARIO
		*------------------------------------------------------------*
		LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
		LSaliastmp 	= "TMP" 		&&     TMP001
		LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
		IF EMPTY(LSaliastmp)
			WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
			LOOP
	 	ENDIF		

	   	=up_fecha("ITNFSTMP")
		WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
		SELE itemmov
		COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND itemmov.nota	<= LNCtrlCupomFim


		SELE 0
		USE  &LSarqtmp  ALIAS ITNFSTMP EXCL
		INDEX ON nota   TAG nota ADDITIVE
		go top
		*----------------------------------------------------------*
		SELE nota

		SET RELATION TO  operador INTO usuario
		***************************************************

		=W_DEFPROC("ECF.SPR")
		LSstatus=ECFctrlimpcupom((LNCtrlCupomIni),;
		       (LNCtrlCupomFim),(LNvalor), nota.total_nota)

		*-----------------------------------------------------------*
		*   Se nao houve erro "E" e o processo emite so "CUPOM"
		* faz a marca (4) fechando o faturamento
		*-----------------------------------------------------------*


		IF SUBS(LSstatus,7,1) = "E"
		   	=up_fecha("ITNFSTMP")
		  	SELECT &LSalias
			*--------------------------------------------------*
			DO CASE
				CASE "NCN - EXECUTADO" $ UPPER(LSstatus)
					IF !NFCancNCN(LNemp,LNCtrlCupomIni)
						wp_msg = "Cupom "+STR(LNCtrlCupomIni,7)+;
						 " nao foi cacelado. Comande Cancelamento < ENTER >"
						WAIT WINDOWS wp_msg
					   	RETURN(.f.)
					ELSE
						=UNFempmarca(4,LStp_proces,LSOrientacao)
					   	RETURN(.f.)
					ENDIF
				OTHERWISE
					IF !NFCancCupom(LNemp,LNCtrlCupomIni)
						wp_msg = "Cupom "+STR(LNCtrlCupomIni,7)+;
						 " nao foi cacelado. Comande Cancelamento < ENTER >"
						WAIT WINDOWS wp_msg
					   	RETURN(.f.)
					ELSE
						=UNFempmarca(4,LStp_proces,LSOrientacao)
					   	RETURN(.f.)
					ENDIF
					*--------------------------------------------------*
			ENDCASE
		  	SELECT &LSalias
		   	RETURN(.F.)
		ENDIF

		*----------------------------------------------------*
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		*----------------------------------------------------*

	   	=up_fecha("ITNFSTMP")
	ENDIF




	*--------------------------------------------------------*
	*  IMPRESSAO DE NOTA CONVENCIONAL  (NAO NFe)
	*--------------------------------------------------------*
    *----------------------------------------------------------*
    * Se houver impressao hibrida da
    *   (NF Convencional e NFe)
    *    LNnfInicio  deve ser restaurado apos a
    *   impressao convencional
    *----------------------------------------------------------*
	LNBkpnfInicio  = LNnfInicio


	*--> N=NAO H=HOMOLOGACAO
	IF      EMPRESA.EMITE_NFE $ "NH" ;
	    AND "NOTA" $ LStp_proces ;
	    AND !("COPIA" $ LStp_proces) ;
	
	
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF

		DO WHILE LNnfinicio  <= LNnffim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfinicio,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itensnota
			SET NEAR ON
			SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

		   	=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
					WHILE nota.empresa = itemmov.empresa ;
						  AND nota.nota	= itemmov.nota
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nota   TAG nota ADDITIVE


			*-------------------------------------------------*
			*>>>   NOVO LAYOUT COM GRID PARA PRODUTO E OUTRA PARA SERV
			*-------------------------------------------------*
			=NFAjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

			*-------------------------------------------------*

			LNimpressao = RECCOUNT()
			go top

			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP
			DO CASE
				CASE   nota.empresa = 2 ;
					OR nota.empresa = 3 ;
					OR nota.empresa = 4 ;
			        OR nota.empresa = 6

					REPORT FORM relnfs6A ;
							WHILE nota.nota = LNnfinicio AND;
	  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

				OTHERWISE
					REPORT FORM relnfs6 ;
							WHILE nota.nota = LNnfinicio AND;
	  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 							NOCONSOLE TO PRINTER
			ENDCASE

			IF      EMPRESA.EMITE_NFE $ "N"
				*----------------------------------------------------*
				=UNFempmarca(4,LStp_proces,LSOrientacao)
				*----------------------------------------------------*

			ENDIF
		   	=up_fecha("ITNFSTMP")

			LNnfinicio	= LNnfinicio + 1

		ENDDO
	ENDIF


    *----------------------------------------------------------*
	LNnfInicio  = LNBkpnfInicio


	*--------------------------------------------------------*
	*  IMPRESSAO(XML) DE NFe
	*--------------------------------------------------------*

	*--> S=SIM H=HOMOLOGACAO
	IF      EMPRESA.EMITE_NFE $ "SH" ;
	    AND "NOTA" $ LStp_proces ;
	    AND !("COPIA" $ LStp_proces)



		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNnfinicio,7)
	    m.EMPRESA    =   nota.Empresa
	

		DO CASE
			CASE LNnfinicio > 3000000 AND LNnfinicio < 4000000
			    m.MOD_DOC    =   "55"  && NFe
		
			OTHERWISE			
				=W_DEFPROC("TIPOOPER.SPR")
				LFieldTmp    = ;
					TPGetFieldValue("S",  nota.tipo ,"Cod_Mod_Rf")
			    m.MOD_DOC    = LFieldTmp
		ENDCASE


	    m.COD_IDFORN  =   SPACE(14)
    	m.NRO_DOC     =   nota.nota
	    m.SERIE_DOC   =   LEFT( nota.Serie +"   ",3)

        PRIVATE LFerroNFe
		LFerroNFe = .F.

		=W_DEFPROC("DOCFISCA.SPR")
		LFerroNFe = DFConvrtNFDocFiscal(NOTA.EMPRESA,NOTA.NOTA)

		IF !LFerroNFe
			=W_DEFPROC("DOCFISCA.SPR")
			LFerroNFe =(DFGerXMLDocFiscal(LNemp,m.Mod_Doc,m.COD_IDFORN,;
			  m.NRO_DOC,m.Serie_Doc ))
		ENDIF

		=W_DEFPROC("DOCFISCA.SPR")
		IF !LFerroNFe
		   LFerroNFe = (DFEnviaNFeXML(LNemp,m.Nro_Doc))
		ENDIF

		=W_DEFPROC("DOCFISCA.SPR")
		IF !LFerroNFe
			LSstatus = (DFRespostaNFe;
			      (;
				     m.NRO_DOC,;
				     "ESPERA",;
					  RtnStatus,;
					  RtnRecibo,;
				      RtnProtocolo,;
			          RtnChvNFe,;
			          RtnJstfCanc,;
			          RtnPrtcCanc;
				  );
				)
		ENDIF


		IF !LFerroNFe
			=W_DEFPROC("ORCAMENT.SPR")
			IF ORLerRegistro(LNemp,nota.referencia)
  	    	
	  	    	=ORSetPropVT("NFE_STATUS",RtnStatus)
				=ORSetPropVT("NFE_RECIBO",RtnRecibo)
				=ORSetPropVT("NFE_PROTOC",RtnProtocolo)
				=ORSetPropVT("NFE_CHV",RtnChvNFe)
				=ORSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=ORSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=ORSalvarRegistro()
			ENDIF
		ENDIF

		IF !LFerroNFe
			=W_DEFPROC("NOTA.SPR")
			IF NFLerRegistro(LNemp,LNnfinicio)
	  	    	=NFSetPropVT("NFE_STATUS",RtnStatus)
				=NFSetPropVT("NFE_RECIBO",RtnRecibo)
				=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=NFSetPropVT("NFE_CHV",RtnChvNFe)
				=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=NFSalvarRegistro()
			ENDIF
		ENDIF

		IF !LFerroNFe
			=W_DEFPROC("DOCFISCA.SPR")
			IF (DFLerRegistro(LNemp,m.Mod_Doc,m.COD_IDFORN,;
				  m.NRO_DOC,m.Serie_Doc ))
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
			ENDIF
		ENDIF
		IF !LFerroNFe
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		ENDIF

	ENDIF



	*--------------------------------------------------------*
	*  IMPRESSAO CONVENCIONAL DE COPIA DE CUPOM (NAO NFe)
	*--------------------------------------------------------*


    *----------------------------------------------------------*
    * Se houver impressao hibrida sda copia
    *   (NF Convencional e NFe)
    *    LNnfCopInicio  deve ser restaurado apos a
    *   impressao convencional
    *----------------------------------------------------------*
	LNBkpnfCopInicio  = LNnfCopInicio


 	*--> N=NAO H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFE $ "NH" ;
		AND "COPIA EM NOTA" $ LStp_proces
		
		
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF

		DO WHILE LNnfCopInicio  <= LNnfCopFim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfCopInicio,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itenscopia
			SET NEAR ON
			SEEK STR(nota.empresa,3)+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		


		   	=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp FOR LEFT(itemmov.operacao,1) = "S" ;
					WHILE nota.empresa = itemmov.empresa ;
						  AND nota.nota	= itemmov.nf_copia
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nf_copia   TAG nota ADDITIVE

			*-------------------------------------------------*
			*>>>   NOVO LAYOUT COM GRID PARA PRODUTO E OUTRA PARA SERV
			*-------------------------------------------------*
			=NFAjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

			*-------------------------------------------------*

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP

			DO CASE
				CASE   nota.empresa = 2 ;
					OR nota.empresa = 3 ;
					OR nota.empresa = 4 ;
			        OR nota.empresa = 6

					REPORT FORM relnfs6A ;
						WHILE nota.nota = LNnfCopInicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

				OTHERWISE
					REPORT FORM relnfs6 ;
						WHILE nota.nota = LNnfCopInicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
			ENDCASE


			IF      EMPRESA.EMITE_NFE $ "N"
				*----------------------------------------------------*
				=UNFempmarca(4,LStp_proces,LSOrientacao)
				*----------------------------------------------------*

			ENDIF

		   	=up_fecha("ITNFSTMP")

			LNnfCopInicio  = LNnfCopInicio + 1

		ENDDO
	ENDIF

    *----------------------------------------------------------*
    LNnfCopInicio  = LNBkpnfCopInicio

	*--------------------------------------------------------*
	*  IMPRESSAO(XML) DE COPIA DE CUPOM EM NFe
	*--------------------------------------------------------*


 	*-->S=SIM H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFE $ "SH" ;
		AND "COPIA EM NOTA" $ LStp_proces


		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNnfCopInicio,7)
	    m.EMPRESA    =   nota.Empresa
	
		DO CASE
			CASE LNnfCopInicio > 3000000 AND LNnfCopInicio < 4000000
			    m.MOD_DOC    =   "55"  && NFe
		
			OTHERWISE			
				=W_DEFPROC("TIPOOPER.SPR")
				LFieldTmp    = ;
					TPGetFieldValue("S",  nota.tipo ,"Cod_Mod_Rf")
			    m.MOD_DOC    = LFieldTmp
		ENDCASE

	    m.COD_IDFORN  =   SPACE(14)
    	m.NRO_DOC     =   nota.nota
	    m.SERIE_DOC   =   LEFT( nota.Serie +"   ",3)


        PRIVATE LFerroNFe
		LFerroNFe = .F.

		=W_DEFPROC("DOCFISCA.SPR")
		LFerroNFe = DFConvrtNFDocFiscal(NOTA.EMPRESA,NOTA.NOTA)

		IF !LFerroNFe
			=W_DEFPROC("DOCFISCA.SPR")
			LFerroNFe = (DFGerXMLDocFiscal(LNemp,m.Mod_Doc,m.COD_IDFORN,;
			  m.NRO_DOC,m.Serie_Doc ))
		ENDIF

		IF !LFerroNFe
			=W_DEFPROC("DOCFISCA.SPR")
			LFerroNFe = (DFEnviaNFeXML(LNemp,m.Nro_Doc))
		ENDIF

		IF !LFerroNFe
			=W_DEFPROC("DOCFISCA.SPR")
			LSstatus = (DFRespostaNFe;
			      (;
				     m.NRO_DOC,;
				     "ESPERA",;
					  RtnStatus,;
					  RtnRecibo,;
				      RtnProtocolo,;
			          RtnChvNFe,;
			          RtnJstfCanc,;
			          RtnPrtcCanc;
				  );
				)
		ENDIF

		IF !LFerroNFe
			IF NFLerRegistro(LNemp,LNnfinicio)
  		    	=NFSetPropVT("NFE_STATUS",RtnStatus)
				=NFSetPropVT("NFE_RECIBO",RtnRecibo)
				=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=NFSetPropVT("NFE_CHV",RtnChvNFe)
					=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=NFSalvarRegistro()
			ENDIF
		ENDIF

		IF !LFerroNFe
			=W_DEFPROC("DOCFISCA.SPR")
			IF (DFLerRegistro(LNemp,m.Mod_Doc,m.COD_IDFORN,;
				  m.NRO_DOC,m.Serie_Doc ))
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
			ENDIF
		ENDIF
		IF !LFerroNFe
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		ENDIF
	ENDIF


	*---------- IMPRESSAO DE NOTA FISCAL DE SERVICO ------------*
	*****************************************************************
	*--> Redireciona impressora de NOTA FISCAL DE SERVICO
	* APROVEITA CAMPO WP_IMPORC que nao teve  aplicacao no sistema
	*****************************************************************

	IF  "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
		LsOrientacao = "SERVICO"
		IF !(EMPTY(ALLTRIM(wp_imporc)))
			LNmtmp =UPnometmp("tmp",2)
			DELETE FILE &LNmtmp
			RUN &wp_imporc > &LNmtmp
		ELSE
			SET PRINTER TO &wp_prtorc
		ENDIF
		*************************************************************
		*--------------------------------------------------
		DO WHILE LNnfSrvIni  <= LNnfSrvFim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfsrvIni,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itensnota
			SET NEAR ON
			SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

			=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND nota.nota	= itemmov.nota





			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nota   TAG nota ADDITIVE

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP

	
			IF wp_dtoper < {01.05.2006}
				REPORT FORM relnfsrv ;
					WHILE nota.nota = LNnfsrvIni AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
						NOCONSOLE TO PRINTER
			ELSE
				REPORT FORM relsrv02 ;
					WHILE nota.nota = LNnfsrvIni AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 					NOCONSOLE TO PRINTER
			ENDIF
	
	
	
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*

		   	=up_fecha("ITNFSTMP")
			LNnfsrvIni	= LNnfsrvIni + 1
			
		ENDDO
	ENDIF




	IF  "COPIA EM NF SERVICO" $ LStp_proces
		LsOrientacao = "SERVICO"
		IF !(EMPTY(ALLTRIM(wp_imporc)))
			LNmtmp =UPnometmp("tmp",2)
			DELETE FILE &LNmtmp
			RUN &wp_imporc > &LNmtmp
		ELSE
			SET PRINTER TO &wp_prtorc
		ENDIF
		*************************************************************
		*--------------------------------------------------
		DO WHILE LNSrvCopIni  <= LNSrvCopFim

			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNSrvCopIni,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itenscopia
			SET NEAR ON
			SEEK STR(nota.empresa,3)+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*

			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

	   		=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp FOR LEFT(itemmov.operacao,1) = "S" ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND nota.nota	= itemmov.nf_copia
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nf_copia   TAG nota ADDITIVE

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP

	
			IF wp_dtoper < {01.05.2006}
				REPORT FORM relnfsrv ;
					WHILE nota.nota = LNSrvCopIni AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 					NOCONSOLE TO PRINTER
			ELSE
				REPORT FORM relsrv02 ;
					WHILE nota.nota = LNSrvCopIni  AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 					NOCONSOLE TO PRINTER
			ENDIF

			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		   	=up_fecha("ITNFSTMP")

			LNSrvCopIni	= LNSrvCopIni + 1
		ENDDO
	ENDIF

	=W_DEFPROC("rotinas.spr")




	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H8O           NFLinhaProd VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   44    º
*       º Variable:            NFLinhaProd                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      172                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h8o     &&  NFLinhaProd VALID
#REGION 5
return
*---------------------------------------------------------------*


FUNCTION NFLinhaProd
PARAMETERS PrmLinha



PRIVATE Linha,LScodigo,LsDescricao,LNQtde,LNvlrUnit,LNAlqIPI


LScodigo    = IIF(LEFT(itnfstmp.codigo,5)="99999",;
              SPACE(8), LEFT(itnfstmp.codigo,8))


IF !EMPTY(itnfstmp.descrcompl)

	LsDescricao = (UPClasNbm((wp_empresa),(itnfstmp.codigo), ;
		 	  (itnfstmp.origem) ,;
		 	  (RTRIM(itnfstmp.descrcompl));
		 	  ))
ELSE

	LsDescricao = (UPClasNbm((wp_empresa),(itnfstmp.codigo), ;
		 	  (itnfstmp.origem) ,;
		 	  (RTRIM(itnfstmp.descricao)+RTRIM(itnfstmp.descrcompl));
		 	  ))
ENDIF

LsDescricao = LEFT(LsDescricao+SPACE(31),31)

LNQtde      = IIF(tipooper.ch_opera = "1" AND ;
              tipooper.ch_motiv = "3" ,0,itnfstmp.qtde)

IF itnfstmp.qtde = 0
	LNvlrUnit   = 0
ELSE
	LNvlrUnit   = itnfstmp.vlrvenda/ itnfstmp.qtde
	LNvlrUnit   = INT(LNvlrUnit * 100)/100
ENDIF


LNAlqICMS   = IIF(itnfstmp.cst $ "012",INT(itnfstmp.aliq_icms),0)
LNAlqIPI    = IIF(itnfstmp.vlripi > 0,INT(itnfstmp.aliq_ipi),0)



LSCst = IIF(EMPTY(itnfstmp.cst),"   ","0"+CHRTRAN(itnfstmp.cst," ","0")+"0")



DO CASE

	CASE itnfstmp.CENTROCUST  = "PRODUT" && LINHA DA GRID  DE PRODUTO
		Linha = ;
			LScodigo;
		   +space(1);
		   +LsDescricao;
		   +space(1);
		   +itnfstmp.cfo;
		   +space(3);
		   +LSCst;
		   +space(2);
		   +itnfstmp.unidade;
		   +space(6);
		   +TRANSFORM(LNqtde,"@Z 99999") ;
		   +space(2);
		   +TRANSFORM(LNvlrUnit,"@Z 99,999.99") ;
		   +space(5);
		   +TRANSFORM(itnfstmp.vlrvenda,"@Z 999,999.99")
		
		Linha = Linha ;
		   +space(1);
		   +TRANSFORM(LNAlqICMS,"@Z 99") ;
		   +space(4);
		   +TRANSFORM(LNAlqIPI,"@Z 99")

	CASE itnfstmp.CENTROCUST  = "MSG-01"
		Linha = ;
			orc_anex.mens3
	CASE itnfstmp.CENTROCUST  = "MSG-02"
		Linha = ;
			orc_anex.mens1
	CASE itnfstmp.CENTROCUST  = "MSG-03"
		Linha = ;
			orc_anex.mens2
	CASE itnfstmp.CENTROCUST  = "SERVIC" && LINHA DA GRID  DESERVICO
	
		Linha = ;
			LScodigo;
		   +space(1);
		   +LsDescricao;
		   +space(15);
		   +itnfstmp.cfo;
		   +space(2);
		   +LSCst;
		   +space(3);
		   +itnfstmp.unidade;
		   +space(3);
		   +TRANSFORM(LNqtde,"@Z 99999") ;
		   +space(2);
		   +TRANSFORM(LNvlrUnit,"@Z 99,999.99")

		Linha = Linha ;
		   +space(3);
		   +TRANSFORM(itnfstmp.vlrvenda,"@Z 999,999.99")

	OTHERWISE
		LINHA = " "
ENDCASE


RETURN(Linha)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123H8W           NFGeraXML_NOTA VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   47    º
*       º Variable:            NFGeraXML_NOTA                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      173                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123h8w     &&  NFGeraXML_NOTA VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NFGeraXML_NOTA
PARAMETERS PrmEmpresa, PrmNota

	PRIVATE NFAlias

	PRIVATE  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc



	=W_DEFPROC("NOTA.SPR")
	NFAlias = NFGetAlias()


	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NF nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	PrmSerie   		= &NFAlias .Serie
	PrmTipo    		= &NFAlias .Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""
	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,RtnNro_Doc,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFGerXMLDocFiscal(PrmEmpresa,RtnMod_Doc,RtnCOD_IDFORN,;
		  PrmNota,RtnSerie_Doc )

	  	WAIT WINDOW "Nao foi possivel gerar XML EFD. <ENTER>"
		RETURN(.f.)
	ENDIF

RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HAJ           NFEnviaNfe_NOTA VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   48    º
*       º Variable:            NFEnviaNfe_NOTA                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      174                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123haj     &&  NFEnviaNfe_NOTA VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NFEnviaNfe_NOTA
PARAMETERS PrmEmpresa, PrmNota

	PRIVATE NFAlias

	PRIVATE  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc



	=W_DEFPROC("NOTA.SPR")
	NFAlias = NFGetAlias()


	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NF nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	PrmSerie   		= &NFAlias .Serie
	PrmTipo    		= &NFAlias .Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""
	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFGerXMLDocFiscal(PrmEmpresa,RtnMod_Doc,RtnCOD_IDFORN,;
		  RtnNro_Doc,RtnSerie_Doc )

	  	WAIT WINDOW "Nao foi possivel gerar XML EFD. <ENTER>"
		RETURN(.f.)
	ENDIF




	=W_DEFPROC("DOCFISCA.SPR")
	IF !(DFEnviaNFeXML(PrmEmpresa,RtnMod_Doc,RtnNro_Doc))
	  	WAIT WINDOW "Nao foi possivel copiar XML para NFe. <ENTER>"
		RETURN(.f.)
	ENDIF


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HAO           NFRtrnoNfe_NOTA VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   49    º
*       º Variable:            NFRtrnoNfe_NOTA                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      175                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hao     &&  NFRtrnoNfe_NOTA VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NFRtrnoNfe_NOTA
PARAMETERS PrmEmpresa, PrmNota, PrmEspera

	PRIVATE NFAlias

	PRIVATE  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc


	PRIVATE  ;
     PrmOrcamento

	IF TYPE("PrmEspera") <> "C" OR EMPTY(PrmEspera)
		PrmEspera = "ESPERA"
	ENDIF


	=W_DEFPROC("NOTA.SPR")
	NFAlias = NFGetAlias()


	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NF nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	PrmSerie   		= &NFAlias .Serie
	PrmTipo    		= &NFAlias .Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

    PrmOrcamento	= &NFAlias .referencia
	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	*-------------------------------------------------------------*

	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc




	=W_DEFPROC("DOCFISCA.SPR")

		LSstatus = (DFRespostaNFe;
		      (;
				PrmEmpresa,;
	   			RtnMod_Doc,;
	   			RtnNro_Doc,;
			     PrmEspera,;
				  RtnStatus,;
				  RtnRecibo,;
			      RtnProtocolo,;
		          RtnChvNFe,;
		          RtnJstfCanc,;
		          RtnPrtcCanc;
			  );
			)




	IF  "ERRO" $ LSstatus
		WAIT WINDOW LSstatus  NOWAIT
	ENDIF

	IF PrmTipo <> "CPM"

		=W_DEFPROC("ORCAMENT.SPR")
		IF ORLerRegistro(PrmEmpresa, PrmOrcamento)
	  	    	
    		=ORSetPropVT("NFE_STATUS",RtnStatus)
			=ORSetPropVT("NFE_RECIBO",RtnRecibo)
			=ORSetPropVT("NFE_PROTOC",RtnProtocolo)
			=ORSetPropVT("NFE_CHV",RtnChvNFe)
			=ORSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=ORSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
			=ORSalvarRegistro()
		ENDIF

	ENDIF


	IF NFLerRegistro(PrmEmpresa,PrmNota)
  	    	
	    	=NFSetPropVT("NFE_STATUS",RtnStatus)
			=NFSetPropVT("NFE_RECIBO",RtnRecibo)
			=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
			=NFSetPropVT("NFE_CHV",RtnChvNFe)
			=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)

			=NFSalvarRegistro()
	ENDIF



	=W_DEFPROC("DOCFISCA.SPR")
	IF (DFLerRegistro(PrmEmpresa,RtnMod_Doc,RtnCOD_IDFORN,;
			  RtnNRO_DOC,RtnSerie_Doc ))

 	    	=DFSetPropVT("DFISSTATUS",RtnStatus)
 	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
			=DFSetPropVT("NFE_RECIBO",RtnRecibo)
			=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
			=DFSetPropVT("NFE_CHV",RtnChvNFe)
			=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)

			=DFSalvarRegistro()
	ENDIF

RETURN






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HAW           antNF_03ImpDocFiscal VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   50    º
*       º Variable:            antNF_03ImpDocFiscal               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      176                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123haw     &&  antNF_03ImpDocFiscal VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION antNF_03ImpDocFiscal
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe


	SET STEP ON

	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------

	IF  "CUPOM" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNCtrlCupomIni,7)

		SELE itemmov
		SET ORDER TO TAG itensnota
		SET NEAR ON
		SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
		SET NEAR OFF			
		*------------------------------------------------------------*
		*  INICIA GERACAO DE ARQUIVO TEMPORARIO
		*------------------------------------------------------------*
		LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
		LSaliastmp 	= "TMP" 		&&     TMP001
		LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
		IF EMPTY(LSaliastmp)
			WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
			LOOP
	 	ENDIF		

	   	=up_fecha("ITNFSTMP")
		WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
		SELE itemmov
		COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND itemmov.nota	<= LNCtrlCupomFim


		SELE 0
		USE  &LSarqtmp  ALIAS ITNFSTMP EXCL
		INDEX ON nota   TAG nota ADDITIVE
		go top
		*----------------------------------------------------------*
		SELE nota

		SET RELATION TO  operador INTO usuario
		***************************************************

		=W_DEFPROC("ECF.SPR")
		LSstatus=ECFctrlimpcupom((LNCtrlCupomIni),;
		       (LNCtrlCupomFim),(LNvalor), nota.total_nota)

		*-----------------------------------------------------------*
		*   Se nao houve erro "E" e o processo emite so "CUPOM"
		* faz a marca (4) fechando o faturamento
		*-----------------------------------------------------------*


		IF SUBS(LSstatus,7,1) = "E"
		   	=up_fecha("ITNFSTMP")
		  	SELECT &LSalias
			*--------------------------------------------------*
			DO CASE
				CASE "NCN - EXECUTADO" $ UPPER(LSstatus)
					IF !NFCancNCN(LNemp,LNCtrlCupomIni)
						wp_msg = "Cupom "+STR(LNCtrlCupomIni,7)+;
						 " nao foi cacelado. Comande Cancelamento < ENTER >"
						WAIT WINDOWS wp_msg
					   	RETURN(.f.)
					ELSE
						=UNFempmarca(4,LStp_proces,LSOrientacao)
					   	RETURN(.f.)
					ENDIF
				OTHERWISE
					IF !NFCancCupom(LNemp,LNCtrlCupomIni)
						wp_msg = "Cupom "+STR(LNCtrlCupomIni,7)+;
						 " nao foi cacelado. Comande Cancelamento < ENTER >"
						WAIT WINDOWS wp_msg
					   	RETURN(.f.)
					ELSE
						=UNFempmarca(4,LStp_proces,LSOrientacao)
					   	RETURN(.f.)
					ENDIF
					*--------------------------------------------------*
			ENDCASE
		  	SELECT &LSalias
		   	RETURN(.F.)
		ENDIF

		*----------------------------------------------------*
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		*----------------------------------------------------*

	   	=up_fecha("ITNFSTMP")
	ENDIF




	*--------------------------------------------------------*
	*  IMPRESSAO DE NOTA CONVENCIONAL  (NAO NFe)
	*--------------------------------------------------------*
    *----------------------------------------------------------*
    * Se houver impressao hibrida da
    *   (NF Convencional e NFe)
    *    LNnfInicio  deve ser restaurado apos a
    *   impressao convencional
    *----------------------------------------------------------*
	LNBkpnfInicio  = LNnfInicio


	*--> N=NAO H=HOMOLOGACAO
	IF      EMPRESA.EMITE_NFE $ "NH" ;
	    AND "NOTA" $ LStp_proces ;
	    AND !("COPIA" $ LStp_proces) ;
	
	
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF

		DO WHILE LNnfinicio  <= LNnffim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfinicio,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itensnota
			SET NEAR ON
			SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

		   	=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
					WHILE nota.empresa = itemmov.empresa ;
						  AND nota.nota	= itemmov.nota
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nota   TAG nota ADDITIVE


			*-------------------------------------------------*
			*>>>   NOVO LAYOUT COM GRID PARA PRODUTO E OUTRA PARA SERV
			*-------------------------------------------------*
			=NFAjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

			*-------------------------------------------------*

			LNimpressao = RECCOUNT()
			go top

			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP
			DO CASE
				CASE   nota.empresa = 2 ;
					OR nota.empresa = 3 ;
					OR nota.empresa = 4 ;
			        OR nota.empresa = 6

					REPORT FORM relnfs6A ;
							WHILE nota.nota = LNnfinicio AND;
	  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

				OTHERWISE
					REPORT FORM relnfs6 ;
							WHILE nota.nota = LNnfinicio AND;
	  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 							NOCONSOLE TO PRINTER
			ENDCASE

			IF      EMPRESA.EMITE_NFE $ "N"
				*----------------------------------------------------*
				=UNFempmarca(4,LStp_proces,LSOrientacao)
				*----------------------------------------------------*

			ENDIF
		   	=up_fecha("ITNFSTMP")

			LNnfinicio	= LNnfinicio + 1

		ENDDO
	ENDIF


    *----------------------------------------------------------*
	LNnfInicio  = LNBkpnfInicio


	*--------------------------------------------------------*
	*  IMPRESSAO(XML) DE NFe
	*--------------------------------------------------------*

	*--> S=SIM H=HOMOLOGACAO
	IF      EMPRESA.EMITE_NFE $ "SH" ;
	    AND "NOTA" $ LStp_proces ;
	    AND !("COPIA" $ LStp_proces)



		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNnfinicio,7)
	    m.EMPRESA    =   nota.Empresa
	

		DO CASE
			CASE LNnfinicio > 3000000 AND LNnfinicio < 4000000
			    m.MOD_DOC    =   "55"  && NFe
		
			OTHERWISE			
				=W_DEFPROC("TIPOOPER.SPR")
				LFieldTmp    = ;
					TPGetFieldValue("S",  nota.tipo ,"Cod_Mod_Rf")
			    m.MOD_DOC    = LFieldTmp
		ENDCASE


	    m.COD_IDFORN  =   SPACE(14)
    	m.NRO_DOC     =   nota.nota
	    m.SERIE_DOC   =   LEFT( nota.Serie +"   ",3)

        PRIVATE LFerroNFe
		LFerroNFe = .F.

		=W_DEFPROC("DOCFISCA.SPR")
		LFerroNFe = DFConvrtNFDocFiscal(NOTA.EMPRESA,NOTA.NOTA)

		IF !LFerroNFe
			=W_DEFPROC("DOCFISCA.SPR")
			LFerroNFe =(DFGerXMLDocFiscal(LNemp,m.Mod_Doc,m.COD_IDFORN,;
			  m.NRO_DOC,m.Serie_Doc ))
		ENDIF

		=W_DEFPROC("DOCFISCA.SPR")
		IF !LFerroNFe
		   LFerroNFe = (DFEnviaNFeXML(LNemp,m.Nro_Doc))
		ENDIF

		=W_DEFPROC("DOCFISCA.SPR")
		IF !LFerroNFe
			LSstatus = (DFRespostaNFe;
			      (;
				     m.NRO_DOC,;
				     "ESPERA",;
					  RtnStatus,;
					  RtnRecibo,;
				      RtnProtocolo,;
			          RtnChvNFe,;
			          RtnJstfCanc,;
			          RtnPrtcCanc;
				  );
				)
		ENDIF


		IF !LFerroNFe
			=W_DEFPROC("ORCAMENT.SPR")
			IF ORLerRegistro(LNemp,nota.referencia)
  	    	
	  	    	=ORSetPropVT("NFE_STATUS",RtnStatus)
				=ORSetPropVT("NFE_RECIBO",RtnRecibo)
				=ORSetPropVT("NFE_PROTOC",RtnProtocolo)
				=ORSetPropVT("NFE_CHV",RtnChvNFe)
				=ORSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=ORSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=ORSalvarRegistro()
			ENDIF
		ENDIF

		IF !LFerroNFe
			=W_DEFPROC("NOTA.SPR")
			IF NFLerRegistro(LNemp,LNnfinicio)
	  	    	=NFSetPropVT("NFE_STATUS",RtnStatus)
				=NFSetPropVT("NFE_RECIBO",RtnRecibo)
				=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=NFSetPropVT("NFE_CHV",RtnChvNFe)
				=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=NFSalvarRegistro()
			ENDIF
		ENDIF

		IF !LFerroNFe
			=W_DEFPROC("DOCFISCA.SPR")
			IF (DFLerRegistro(LNemp,m.Mod_Doc,m.COD_IDFORN,;
				  m.NRO_DOC,m.Serie_Doc ))
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
			ENDIF
		ENDIF
		IF !LFerroNFe
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		ENDIF

	ENDIF


	*---------- IMPRESSAO DE NOTA FISCAL DE SERVICO ------------*
	*****************************************************************
	*--> Redireciona impressora de NOTA FISCAL DE SERVICO
	* APROVEITA CAMPO WP_IMPORC que nao teve  aplicacao no sistema
	*****************************************************************

	IF  "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
		LsOrientacao = "SERVICO"
		IF !(EMPTY(ALLTRIM(wp_imporc)))
			LNmtmp =UPnometmp("tmp",2)
			DELETE FILE &LNmtmp
			RUN &wp_imporc > &LNmtmp
		ELSE
			SET PRINTER TO &wp_prtorc
		ENDIF
		*************************************************************
		*--------------------------------------------------
		DO WHILE LNnfSrvIni  <= LNnfSrvFim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfsrvIni,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itensnota
			SET NEAR ON
			SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

			=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND nota.nota	= itemmov.nota


			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nota   TAG nota ADDITIVE

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP

	
			IF wp_dtoper < {01.05.2006}
				REPORT FORM relnfsrv ;
					WHILE nota.nota = LNnfsrvIni AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
						NOCONSOLE TO PRINTER
			ELSE
				REPORT FORM relsrv02 ;
					WHILE nota.nota = LNnfsrvIni AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 					NOCONSOLE TO PRINTER
			ENDIF
	
	
	
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*

		   	=up_fecha("ITNFSTMP")
			LNnfsrvIni	= LNnfsrvIni + 1
			
		ENDDO
	ENDIF



	=W_DEFPROC("rotinas.spr")



	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HAX           antNF_ImpCopDocFiscal VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   51    º
*       º Variable:            antNF_ImpCopDocFiscal              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      177                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hax     &&  antNF_ImpCopDocFiscal VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION antNF_ImpCopDocFiscal
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------


	*--------------------------------------------------------*
	*  IMPRESSAO CONVENCIONAL DE COPIA DE CUPOM (NAO NFe)
	*--------------------------------------------------------*


    *----------------------------------------------------------*
    * Se houver impressao hibrida sda copia
    *   (NF Convencional e NFe)
    *    LNnfCopInicio  deve ser restaurado apos a
    *   impressao convencional
    *----------------------------------------------------------*
	LNBkpnfCopInicio  = LNnfCopInicio


 	*--> N=NAO H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFE $ "NH" ;
		AND "COPIA EM NOTA" $ LStp_proces
		
		
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF

		DO WHILE LNnfCopInicio  <= LNnfCopFim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfCopInicio,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itenscopia
			SET NEAR ON
			SEEK STR(nota.empresa,3)+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		


		   	=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp FOR LEFT(itemmov.operacao,1) = "S" ;
					WHILE nota.empresa = itemmov.empresa ;
						  AND nota.nota	= itemmov.nf_copia
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nf_copia   TAG nota ADDITIVE

			*-------------------------------------------------*
			*>>>   NOVO LAYOUT COM GRID PARA PRODUTO E OUTRA PARA SERV
			*-------------------------------------------------*
			=NFAjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

			*-------------------------------------------------*

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP

			DO CASE
				CASE   nota.empresa = 2 ;
					OR nota.empresa = 3 ;
					OR nota.empresa = 4 ;
			        OR nota.empresa = 6

					REPORT FORM relnfs6A ;
						WHILE nota.nota = LNnfCopInicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

				OTHERWISE
					REPORT FORM relnfs6 ;
						WHILE nota.nota = LNnfCopInicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
			ENDCASE


			IF      EMPRESA.EMITE_NFE $ "N"
				*----------------------------------------------------*
				=UNFempmarca(4,LStp_proces,LSOrientacao)
				*----------------------------------------------------*

			ENDIF

		   	=up_fecha("ITNFSTMP")

			LNnfCopInicio  = LNnfCopInicio + 1

		ENDDO
	ENDIF

    *----------------------------------------------------------*
    LNnfCopInicio  = LNBkpnfCopInicio

	*--------------------------------------------------------*
	*  IMPRESSAO(XML) DE COPIA DE CUPOM EM NFe
	*--------------------------------------------------------*


 	*-->S=SIM H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFE $ "SH" ;
		AND "COPIA EM NOTA" $ LStp_proces


		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNnfCopInicio,7)
	    m.EMPRESA    =   nota.Empresa
	
		DO CASE
			CASE LNnfCopInicio > 3000000 AND LNnfCopInicio < 4000000
			    m.MOD_DOC    =   "55"  && NFe
		
			OTHERWISE			
				=W_DEFPROC("TIPOOPER.SPR")
				LFieldTmp    = ;
					TPGetFieldValue("S",  nota.tipo ,"Cod_Mod_Rf")
			    m.MOD_DOC    = LFieldTmp
		ENDCASE

	    m.COD_IDFORN  =   SPACE(14)
    	m.NRO_DOC     =   nota.nota
	    m.SERIE_DOC   =   LEFT( nota.Serie +"   ",3)


        PRIVATE LFerroNFe
		LFerroNFe = .F.

		=W_DEFPROC("DOCFISCA.SPR")
		LFerroNFe = DFConvrtNFDocFiscal(NOTA.EMPRESA,NOTA.NOTA)

		IF !LFerroNFe
			=W_DEFPROC("DOCFISCA.SPR")
			LFerroNFe = (DFGerXMLDocFiscal(LNemp,m.Mod_Doc,m.COD_IDFORN,;
			  m.NRO_DOC,m.Serie_Doc ))
		ENDIF

		IF !LFerroNFe
			=W_DEFPROC("DOCFISCA.SPR")
			LFerroNFe = (DFEnviaNFeXML(LNemp,m.Nro_Doc))
		ENDIF

		IF !LFerroNFe
			=W_DEFPROC("DOCFISCA.SPR")
			LSstatus = (DFRespostaNFe;
			      (;
				     m.NRO_DOC,;
				     "ESPERA",;
					  RtnStatus,;
					  RtnRecibo,;
				      RtnProtocolo,;
			          RtnChvNFe,;
			          RtnJstfCanc,;
			          RtnPrtcCanc;
				  );
				)
		ENDIF

		IF !LFerroNFe
			IF NFLerRegistro(LNemp,LNnfinicio)
  		    	=NFSetPropVT("NFE_STATUS",RtnStatus)
				=NFSetPropVT("NFE_RECIBO",RtnRecibo)
				=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=NFSetPropVT("NFE_CHV",RtnChvNFe)
					=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=NFSalvarRegistro()
			ENDIF
		ENDIF

		IF !LFerroNFe
			=W_DEFPROC("DOCFISCA.SPR")
			IF (DFLerRegistro(LNemp,m.Mod_Doc,m.COD_IDFORN,;
				  m.NRO_DOC,m.Serie_Doc ))
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
			ENDIF
		ENDIF
		IF !LFerroNFe
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		ENDIF
	ENDIF


	IF  "COPIA EM NF SERVICO" $ LStp_proces
		LsOrientacao = "SERVICO"
		IF !(EMPTY(ALLTRIM(wp_imporc)))
			LNmtmp =UPnometmp("tmp",2)
			DELETE FILE &LNmtmp
			RUN &wp_imporc > &LNmtmp
		ELSE
			SET PRINTER TO &wp_prtorc
		ENDIF
		*************************************************************
		*--------------------------------------------------
		DO WHILE LNSrvCopIni  <= LNSrvCopFim

			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNSrvCopIni,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itenscopia
			SET NEAR ON
			SEEK STR(nota.empresa,3)+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*

			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

	   		=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp FOR LEFT(itemmov.operacao,1) = "S" ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND nota.nota	= itemmov.nf_copia
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nf_copia   TAG nota ADDITIVE

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP

	
			IF wp_dtoper < {01.05.2006}
				REPORT FORM relnfsrv ;
					WHILE nota.nota = LNSrvCopIni AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 					NOCONSOLE TO PRINTER
			ELSE
				REPORT FORM relsrv02 ;
					WHILE nota.nota = LNSrvCopIni  AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 					NOCONSOLE TO PRINTER
			ENDIF

			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		   	=up_fecha("ITNFSTMP")

			LNSrvCopIni	= LNSrvCopIni + 1
		ENDDO
	ENDIF

	=W_DEFPROC("rotinas.spr")




	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HCG           antNFProcessFat VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   52    º
*       º Variable:            antNFProcessFat                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      178                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hcg     &&  antNFProcessFat VALID
#REGION 5
return
*---------------------------------------------------------------*
FUNCTION antNFProcessFat
PARAMETERS LNemp,LNorcamento,PrmSolicitante
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Controle o Processo de Faturamento
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LNorcamento:
	*		PrmSolicitante..: Identifica os Pontos em que esta
	*				 rotina pode ser chamada
	*			   		PrmSolicitante = "VENDEDOR"
	*					PrmSolicitante = "CAIXA"
	*					PrmSolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					PrmSolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					PrmSolicitante = "IMPORTACAO"		&& SCGC008
	* 					PrmSolicitante = "RECUPERACAO"
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	*********************************************************
	*---->   (Preparacao para controle de SATUS DO PROCESSO
	*********************************************************	

	PRIVATE FlgImpFatura

	PRIVATE LNnfinicio    , LNnffim
	PRIVATE LNnfsrvIni    , LNnfsrvFim
	PRIVATE LNCtrlCpmIni, LNCtrlCpmFim
	PRIVATE LNnfCopInicio , LNnfCopFim
	PRIVATE LNSrvCopIni , LNSrvCopFim


	PRIVATE LNnroNF, LNNfServico, LNCtrlCpm
	PRIVATE LNNFCop, LNnfSrvCop

    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO
	PRIVATE LNcupom
	PRIVATE LStp_process
	PRIVATE datanf,horanf,LsOrientacao
	PRIVATE LFabrecupom				&& FLAG PARA MANDAR ABIR CUPOM
	PRIVATE LFservico				&& CASO EXISTA SERVICO (TP_MERCAD = 7)
	PRIVATE LFproduto 				&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
	PRIVATE LFipi    				&& CASO EXISTA IPI > 0

	*********************************************************	
	PRIVATE LFretorno
	LFretorno = .T.

	STORE 0  TO LNnfinicio ,LNnffim
	STORE 0  TO LNnfsrvIni ,LNnfsrvFim
	STORE 0  TO LNCtrlCpmIni, LNCtrlCpmFim
	STORE 0  TO LNnfCopInicio , LNnfCopFim
	STORE 0  TO LNSrvCopIni , LNSrvCopFim
	STORE 0  TO LNnroNF, LNNfServico, LNCtrlCpm
	STORE 0  TO LNNFCop, LNnfSrvCop
	

	STORE 0  TO LNcupom
	STORE "" TO LStp_process
	STORE {} TO datanf
	STORE "" TO horanf,LsOrientacao
    STORE .F. TO LFGerNF,LFGerNFS


	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcamento,6)

	IF orcament.flgtransac = .f.
		DO OBJ_MENS.SPR WITH " O orcamento Selecionado Sofreu" +;
		" Alteracoes que Afetam Valores e Nao Foi Recalculado." +;
		CHR(13)+;
		" Reedite os Itens e Grave para Forcar o Calculo."
		RETURN(.f.)
	ENDIF
	*----------------------------------------------------------------*
	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+orcament.tipo
	IF !FOUND()
		SEEK 's'+orcament.tipo
	ENDIF
	IF !found()
		SELECT orcament
		RETURN(.f.)
	ENDIF
	*---------------------------------------------------------*
	*   (Fim Preparacao para controle de SATUS DO PROCESSO
	*---------------------------------------------------------*



	LFservico	= .F.		&& CASO EXISTA SERVICO (TP_MERCAD = 7)
	LFproduto 	= .F.		&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
	LFIPI    	= .F.		&& CASO EXISTA IPI > 0
	*---------------------------------------------------------*

	=W_DEFPROC("NOTA.SPR")
	IF !NFchq_Final((orcament.empresa),(orcament.orcamento),;
				(PrmSolicitante),LFservico,LFproduto)
	    SELE orcament
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*
	* 				Inicio  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*

	
	IF !NFBlocEmpresa(orcament.empresa,PrmSolicitante)
	    SELE orcament
		RETURN(.F.)
	ENDIF


	*---------------------------------------------------------------*

	LFflgtrans 		= .t.
	m.LNalqicms 	= 0		&& aliquota de icms
	m.tot_fatura 	= 0		&& acumula valore de varias notas pra duplicatas


	m.nota   = 0   && utilizados para atualizar Orcamento
	m.cupom  = 0   && utilizados para atualizar Orcamento

	*---------------------------------------------------------------*
	* 		No trecho seguinte sao definidor DATA,HORA,NUMERO DE NOTA
	*	E NUMERO DE CUPOM sendo que estes dados ja vem definido no
	*	registro do orcamento quando esta IMPORTANDO ja no processo
	*	operacional normal rotinas sao ativadas para atribuir valores
	*	a estes dados
	*---------------------------------------------------------------*
	

		
	IF !NF_DefFat(PrmSolicitante)
   		SELE orcament
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*
	*  ESTA CHAMADA ESTA PROVOCANDO ESTOURO DE PILHA DE PROCESSOS
	* ATE SEGUNDA ORDEM EVITA-SE O ANIHAMENTO EXESSIVO TROCANDO A
	* CHAMADA PELO CODIGO DIRETO
	*--------------------------------------------------------------*

*	IF !NFGeraDocFiscais(orcament.empresa)
*   		SELE orcament
*		RETURN(.F.)
*	ENDIF

*FUNCTION NFGeraDocFiscais
*PARAMETERS PrmEmpresa



	DO CASE
		CASE orcament.empresa = 6

			IF  "CUPOM" $ LStp_proces
				LsOrientacao = "PRODUTO/SERVICO"
				*--------------------------------------------*

				IF !ULGerCupom()
					RETURN(.F.)
				ENDIF
			ENDIF


			IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
				LsOrientacao = "SERVICO"
				*--------------------------------------------*
				IF !ULGerServicoNf()
					RETURN(.F.)
				ENDIF
			ENDIF


			IF  "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
				LsOrientacao = "PRODUTO/SERVICO"
				IF  "NF SERVICO" $ LStp_proces
					LsOrientacao = "PRODUTO"
				ENDIF
				*--------------------------------------------*
				IF !ULGerNFSU()
					RETURN(.F.)
				ENDIF
			ENDIF





		CASE orcament.empresa <> 6
			IF  "CUPOM" $ LStp_proces
				LsOrientacao = "PRODUTO/SERVICO"
				*--------------------------------------------*
				IF !ULGerCupom()
					RETURN(.F.)
				ENDIF
			ENDIF

			IF  "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
				LsOrientacao = "PRODUTO/SERVICO"
				*--------------------------------------------*
				IF !ULGerNFSU()
					RETURN(.F.)
				ENDIF
			ENDIF
	ENDCASE


*RETURN(.T.)







	*---------------------------------------------------------------*
	* 				Fim  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*


	=NFatlzOrcament()


	*----------------------------------------------------------------*
	*     O ajuste no sistema para registrar duplicatas para opera‡äes
	*  A VISTA e Para CARTåES.
	*    Como a Implanta‡Æo da VersÆo nas Filiais ocorre de maneira
	*  gradativa ‚ necess rio direcionar para rotina adequada a situa‡Æo
	*  da filial sendo:
	*    FILIAL ATUALIZADA   => CRgeradupl
	*    FILIAL N.ATUALIZADA => CRnrmgeradupl
	*----------------------------------------------------------------*


 	=W_DEFPROC("DUPLICAT.spr")

	DO CASE

		CASE  orcament.empresa = 10
			IF  dt_fat < {26.03.2008}
				DO  CRidlate26geradupl WITH;
					 (orcament.empresa),(orcament.orcamento)
			ELSE
			
				DO  CRIDLApos26geradupl WITH ;
				    (orcament.empresa),(orcament.orcamento)
			ENDIF

		CASE dt_fat >= {12.03.2008}
				DO  CRgeraDE12MAR08 WITH ;
				    (orcament.empresa),(orcament.orcamento)

		CASE dt_fat >= {10.03.2008} AND ;
			(orcament.empresa = 01 or orcament.empresa = 02)		
				DO  CRgeraDE12MAR08 WITH ;
				    (orcament.empresa),(orcament.orcamento)
		otherwise
			DO  CRgeraATE10MAR08 WITH ;
			     (orcament.empresa),(orcament.orcamento)
	ENDCASE



	*----------------------------------------------------------------*
    *     Registrar Comando para sistema de Caixa
	*----------------------------------------------------------------*

	IF !(PrmSolicitante $ "IMPORTACAO/RECUPERACAO")
		DO CASE
    		CASE "CUPOM" $ LStp_process
				=NFRgAvisoCaixa((LNemp), (LNCtrlCpmIni))
	    	CASE "NOTA" $ LStp_process
				=NFRgAvisoCaixa((LNemp), (LNnfinicio))
	    	CASE "NF SERVICO" $ LStp_process
				=NFRgAvisoCaixa((LNemp), (LNnfsrvIni))
		ENDCASE
	ENDIF


	*----------------------------------------------------------------*

	SELECT orcament
	IF wp_dtsys = wp_dtoper
		IF 	!UPtransacao("TERMINAR")
			WAIT WINDOW "TRANSACAO PERMANECEU ABERTA. VER SUPORTE."
		ENDIF			
	ENDIF
	*---------------------------------------------------------------*
	* 				Fim  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*

	*---------------------------------------------------------------*
	* 				Inicio ---- Impressao  ----
	*---------------------------------------------------------------*



	LFretorno = .T.






	IF  PrmSolicitante = "IMPORTACAO"

		=UNFempmarca(4,LStp_proces,LSOrientacao)

		wp_msg = "Faturamento Concluido "
		WAIT WINDOW wp_msg NOWAIT
	    RETURN(.T.)
	ENDIF



	IF  PrmSolicitante = "RECUPERACAO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		IF  "COPIA" $ LStp_proces
	       LFretorno = ;
		    	NFProcessCopia(orcament.empresa,LNCtrlCpmIni,;
		    	    PrmSolicitante,"ROTINA FATURAMENTO",.T.,.T.)
		ENDIF

	    RETURN(LFretorno)

	ENDIF


	*IF LStp_proces $ "NOTA-CUPOM-NF SERVICO-NOTA/NF SERVICO";
	*    OR "COPIA" $ LStp_proces


	IF LStp_proces $ "NOTA-CUPOM-NF SERVICO-NOTA/NF SERVICO"


		*----------------------------------------------------------------*
		wp_msg = "Imprimindo NOTA/CUPOM Refrente OSI: "+;
							 STR(orcament.orcamento,6)
		WAIT WINDOW wp_msg NOWAIT
		*----------------------------------------------------------------*

		=W_DEFPROC("NOTA.SPR")

		*---------------------------------------------------------*
		*  DESVIO PARA NOVO LAYOUT DE NOTA DE 2009
		*---------------------------------------------------------*



    *
	*	FlgImpFatura =  NF_03ImpFatura(;
	*			(orcament.empresa),(orcament.orcamento),(LStp_process),;
	*			(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
	*			(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
	*			(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			
    *
		FlgImpFatura =  NF_03ImpCopDocFiscal(;
				(orcament.empresa),(orcament.orcamento),(LStp_process),;
				(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
				(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			


		=W_DEFPROC("rotinas.spr")

		IF FlgImpFatura



			*-------------------------------------------------*
			*  DEFINIR SOLICITACAO DE COPIA
			*-------------------------------------------------*

			IF  "COPIA" $ LStp_proces

 		      LFretorno = ;
		    	NF_02ImpCopia(PrmSolicitante,LNCtrlCpmIni)

			ELSE
				=NF_aviso(orcament.Empresa,LNNfinicio,LNCtrlCpmIni,;
						PrmSolicitante,LStp_proces)
		
			ENDIF

		ELSE

	    	WAIT WINDOW "Houve Falha no Impressao do Doc.Fiscal!!!!"
			LFretorno = .F.

		ENDIF
	ENDIF


	*----------------------------------------------------------------*
	wp_msg = "Faturamento Concluido "
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*

RETURN(LFretorno)







*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HCH           antNFProcessCopia VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   53    º
*       º Variable:            antNFProcessCopia                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      179                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hch     &&  antNFProcessCopia VALID
#REGION 5
return
*---------------------------------------------------------------*


FUNCTION antNFProcessCopia
PARAMETER ;
	PrmEmpresa,;
	PrmNota,;
	PrmSolicitante,;
	PrmChamadoPor,;
	PrmCopySrvAutoriza,;
	PrmCopyN1Autoriza



	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*-----------------------------------------------------------*

	PRIVATE FlgImpFatura


	PRIVATE LStipo,LNnf, LNcopiaNF
    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO
	PRIVATE LNemp,LNosi

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND() OR nota.nota < 1000000 && < 1000000 nao e cupom
	   WAIT WINDOW ;
   		" Item selecionado nao e um Cumpom <ENTER>"
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SCATTER MEMVAR
	*-------------------------------------------------------------------*
	LNCtrlCupomIni = m.nota
	LNCtrlCupomFim = m.nota


	IF TYPE("LStp_proces") = "U" OR !("REC." $ LStp_proces)
	    LNnfInicio     = 0
	    LNnfFim        = 0
	    LNnfsrvIni     = 0
	    LNnfsrvFim     = 0
		LNnfCopInicio  = 0
		LNnfCopFim	   = 0
		LNSrvCopIni  = 0
		LNSrvCopFim  = 0
	ENDIF

	LNemp        = m.empresa
	LNosi        = m.referencia
	*-------------------------------------------------------------------*
	*----------  				INICIA COPIA DO CUPOM			--------*
	*-------------------------------------------------------------------*



	LFipi = .f.
	LFproduto = .f.
	LFservico = .f.
	IF nota.totproduto > 0
		LFproduto = .T.
	ENDIF
	IF nota.totservico >0
		LFservico = .T.
	ENDIF
	IF nota.vlr_ipi > 0
		LFipi = .T.
	ENDIF


	*-----------------------------------------------------------------*
	*  DefProcessCopia - Define Processao para  emissao da copia
	*-----------------------------------------------------------------*
	

	LStp_process = ""

	IF nota.empresa = 6

	 	*----------------------------------------*
	 	**  SE HOUVER COPIA EM NOTA N1
	 	*----------------------------------------*
		IF PrmCopyN1Autoriza
			DO CASE		&& DEFINE SE HAVERA COPIA EM NOTA
				CASE LFipi= .T.
					LStp_proces	= LStp_proces+"/COPIA EM NOTA"

				CASE LFproduto = .T. AND PrmChamadoPor = "ROTINA DE COPIA"
					LStp_proces	= LStp_proces+"/COPIA EM NOTA"

				CASE LFservico = .T. AND LFproduto = .T.
					IF NOTA.DATA < {15.11.2006}
						LStp_proces	= LStp_proces+"/COPIA EM NOTA"
					ENDIF
			ENDCASE
		ENDIF

	 	*----------------------------------------*
	 	**  SE HOUVER COPIA EM NOTA SERVICO NAO AUTORIZAR
	 	*----------------------------------------*

		IF	PrmCopySrvAutoriza
			IF LFservico = .T.
					LStp_proces	= LStp_proces+"/COPIA EM NF SERVICO"
			ENDIF
		ENDIF
		*-----------------------------------------
	ELSE
		LStp_proces	= "COPIA EM NOTA"
	ENDIF


	*-----------------------------------------------------------------*
	*  GeraDocCopia - Gera Documento Fiscal de Copia
	*-----------------------------------------------------------------*


	IF  "COPIA EM NOTA" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"

		IF  "NF SERVICO" $ LStp_proces OR nota.empresa = 6
			LsOrientacao = "PRODUTO"
		ENDIF
		*--------------------------------------------*
		IF !NFGerCopia(nota.empresa,LNCtrlCupomIni,;
  	     "NOTA",LNnfCopInicio,LNnfCopFim,LSOrientacao,;
  	     (PrmSolicitante),LStp_proces)
			SELE orcament
			RETURN(.F.)
		ENDIF	
	ENDIF


	IF "COPIA EM NF SERVICO" $ LStp_proces
		LsOrientacao = "SERVICO"
		*--------------------------------------------*
		IF !NFGerCopia(nota.empresa,LNCtrlCupomIni,;
		 "NF SERVICO",LNSrvCopIni,LNSrvCopFim,LSOrientacao,;
			(PrmSolicitante),LStp_proces)
			SELE orcament
			RETURN(.F.)
		ENDIF	
	ENDIF

	*---------------------------------------------------------------*
	* PARA NFe GERAR DOCFISCA E DOCFISIT
	*---------------------------------------------------------------*



	*---------------------------------------------------------------*
	* PARA IMPORTACAO E RECUPERACAO NAO FAZER IMPRESSAO NEM XML NFe
	*---------------------------------------------------------------*
	=W_DEFPROC("NOTA.SPR")
	IF  PrmSolicitante $ "IMPORTACAO - RECUPERACAO"
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		=UNFempmarca(4,"COPIA EM NOTA","")
		=UNFempmarca(4,"COPIA EM NF SERVICO","")
		wp_msg = "Faturamento Concluido "
		WAIT WINDOW wp_msg NOWAIT
	    RETURN(.T.)
	ENDIF


    WAIT WINDOW "Aguarde a Impressao." NOWAIT

	*---------------------------------------------------------------*
	* PARA NFe GERAR XML OU IMPRIMIR QUANDO FOR NOTA NORMAL
	*---------------------------------------------------------------*


	FlgImpFatura =  NF_03ImpFatura(;
			(LNemp),(LNosi),(LStp_process),;
			(wp_TipoEcf),(LNecf),(LNCtrlCupomIni), (LNCtrlCupomFim),;
			(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
			(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))






	=W_DEFPROC("rotinas.spr")

	*---------------------------------------------------------------*
	IF !FlgImpFatura
			
	    	WAIT WINDOW "Houve Falha no Impressao do Doc.Fiscal!!!!"
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
	ELSE
			=NF_aviso(LNEMP,LNnfCopInicio,LNCtrlCupomIni,;
						PrmSolicitante,LStp_proces)

	ENDIF
	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HCI           NFProcessFat VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   54    º
*       º Variable:            NFProcessFat                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      180                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hci     &&  NFProcessFat VALID
#REGION 5
return
*---------------------------------------------------------------*
FUNCTION NFProcessFat
PARAMETERS PrmEmpresa,LNorcamento,PrmSolicitante
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Controle o Processo de Faturamento
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		PrmEmpresa......:
	*		LNorcamento:
	*		PrmSolicitante..: Identifica os Pontos em que esta
	*				 rotina pode ser chamada
	*			   		PrmSolicitante = "VENDEDOR"
	*					PrmSolicitante = "CAIXA"
	*					PrmSolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					PrmSolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					PrmSolicitante = "IMPORTACAO"		&& SCGC008
	* 					PrmSolicitante = "RECUPERACAO"
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	*********************************************************
	*---->   (Preparacao para controle de SATUS DO PROCESSO
	*********************************************************	

	PRIVATE FlgImpFatura

	PRIVATE LNnfinicio    , LNnffim
	PRIVATE LNnfsrvIni    , LNnfsrvFim
	PRIVATE LNCtrlCpmIni, LNCtrlCpmFim
	PRIVATE LNnfCopInicio , LNnfCopFim
	PRIVATE LNSrvCopIni , LNSrvCopFim


	PRIVATE LNnroNF, LNNfServico, LNCtrlCpm
	PRIVATE LNNFCop, LNnfSrvCop

    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO
	PRIVATE LNcupom
	PRIVATE LStp_process
	PRIVATE datanf,horanf,LsOrientacao
	PRIVATE LFabrecupom				&& FLAG PARA MANDAR ABIR CUPOM
	PRIVATE LFservico				&& CASO EXISTA SERVICO (TP_MERCAD = 7)
	PRIVATE LFproduto 				&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
	PRIVATE LFipi    				&& CASO EXISTA IPI > 0

	*********************************************************	
	PRIVATE LFretorno
	LFretorno = .T.

	STORE 0  TO LNnfinicio ,LNnffim
	STORE 0  TO LNnfsrvIni ,LNnfsrvFim
	STORE 0  TO LNCtrlCpmIni, LNCtrlCpmFim
	STORE 0  TO LNnfCopInicio , LNnfCopFim
	STORE 0  TO LNSrvCopIni , LNSrvCopFim
	STORE 0  TO LNnroNF, LNNfServico, LNCtrlCpm
	STORE 0  TO LNNFCop, LNnfSrvCop
	

	STORE 0  TO LNcupom
	STORE "" TO LStp_process
	STORE {} TO datanf
	STORE "" TO horanf,LsOrientacao
    STORE .F. TO LFGerNF,LFGerNFS


	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(PrmEmpresa,3)+STR(LNorcamento,6)

	IF orcament.flgtransac = .f.
		DO OBJ_MENS.SPR WITH " O orcamento Selecionado Sofreu" +;
		" Alteracoes que Afetam Valores e Nao Foi Recalculado." +;
		CHR(13)+;
		" Reedite os Itens e Grave para Forcar o Calculo."
		RETURN(.f.)
	ENDIF
	*----------------------------------------------------------------*
	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+orcament.tipo
	IF !FOUND()
		SEEK 's'+orcament.tipo
	ENDIF
	IF !found()
		SELECT orcament
		RETURN(.f.)
	ENDIF
	*---------------------------------------------------------*
	*   (Fim Preparacao para controle de SATUS DO PROCESSO
	*---------------------------------------------------------*



	LFservico	= .F.		&& CASO EXISTA SERVICO (TP_MERCAD = 7)
	LFproduto 	= .F.		&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
	LFIPI    	= .F.		&& CASO EXISTA IPI > 0
	*---------------------------------------------------------*

	=W_DEFPROC("NOTA.SPR")
	IF !NFchq_Final((orcament.empresa),(orcament.orcamento),;
				(PrmSolicitante),LFservico,LFproduto)
	    SELE orcament
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*
	* 				Inicio  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*

	
	IF !NFBlocEmpresa(orcament.empresa,PrmSolicitante)
	    SELE orcament
		RETURN(.F.)
	ENDIF


	*---------------------------------------------------------------*

	LFflgtrans 		= .t.
	m.LNalqicms 	= 0		&& aliquota de icms
	m.tot_fatura 	= 0		&& acumula valore de varias notas pra duplicatas


	m.nota   = 0   && utilizados para atualizar Orcamento
	m.cupom  = 0   && utilizados para atualizar Orcamento

	*---------------------------------------------------------------*
	* 		No trecho seguinte sao definidor DATA,HORA,NUMERO DE NOTA
	*	E NUMERO DE CUPOM sendo que estes dados ja vem definido no
	*	registro do orcamento quando esta IMPORTANDO ja no processo
	*	operacional normal rotinas sao ativadas para atribuir valores
	*	a estes dados
	*---------------------------------------------------------------*
	

		
	IF !NF_DefFat(PrmSolicitante)
   		SELE orcament
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*
	*  ESTA CHAMADA ESTA PROVOCANDO ESTOURO DE PILHA DE PROCESSOS
	* ATE SEGUNDA ORDEM EVITA-SE O ANIHAMENTO EXESSIVO TROCANDO A
	* CHAMADA PELO CODIGO DIRETO
	*--------------------------------------------------------------*

*	IF !NFGeraDocFiscais(orcament.empresa)
*   		SELE orcament
*		RETURN(.F.)
*	ENDIF

*FUNCTION NFGeraDocFiscais
*PARAMETERS PrmEmpresa


	*-----------------------------------------------------------*

	*-----------------------------------------------------------------*



	*--------------------------------------------------------------*

	IF  "CUPOM" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		*--------------------------------------------*
		IF !ULGerCupom(LsOrientacao)
			RETURN(.F.)
		ENDIF

	ENDIF



	IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
		LsOrientacao = "SERVICO"
		*--------------------------------------------*
		IF !ULGerServicoNf(LsOrientacao)
			RETURN(.F.)
		ENDIF


	ENDIF


	IF  "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF
		*--------------------------------------------*
		IF !ULGerNFSU(LsOrientacao)
			RETURN(.F.)
		ENDIF

	ENDIF

*RETURN(.T.)






	*---------------------------------------------------------------*
	* 				Fim  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*


	=NFatlzOrcament()


	*----------------------------------------------------------------*
	*     O ajuste no sistema para registrar duplicatas para opera‡äes
	*  A VISTA e Para CARTåES.
	*    Como a Implanta‡Æo da VersÆo nas Filiais ocorre de maneira
	*  gradativa ‚ necess rio direcionar para rotina adequada a situa‡Æo
	*  da filial sendo:
	*    FILIAL ATUALIZADA   => CRgeradupl
	*    FILIAL N.ATUALIZADA => CRnrmgeradupl
	*----------------------------------------------------------------*


 	=W_DEFPROC("DUPLICAT.spr")

	DO CASE

		CASE  orcament.empresa = 10
			IF  dt_fat < {26.03.2008}
				DO  CRidlate26geradupl WITH;
					 (orcament.empresa),(orcament.orcamento)
			ELSE
			
				DO  CRIDLApos26geradupl WITH ;
				    (orcament.empresa),(orcament.orcamento)
			ENDIF

		CASE dt_fat >= {12.03.2008}
				DO  CRgeraDE12MAR08 WITH ;
				    (orcament.empresa),(orcament.orcamento)

		CASE dt_fat >= {10.03.2008} AND ;
			(orcament.empresa = 01 or orcament.empresa = 02)		
				DO  CRgeraDE12MAR08 WITH ;
				    (orcament.empresa),(orcament.orcamento)
		otherwise
			DO  CRgeraATE10MAR08 WITH ;
			     (orcament.empresa),(orcament.orcamento)
	ENDCASE



	*----------------------------------------------------------------*
    *     Registrar Comando para sistema de Caixa
	*----------------------------------------------------------------*

	IF !(PrmSolicitante $ "IMPORTACAO/RECUPERACAO")
		DO CASE
    		CASE "CUPOM" $ LStp_process
				=NFRgAvisoCaixa((PrmEmpresa), (LNCtrlCpmIni))
	    	CASE "NOTA" $ LStp_process
				=NFRgAvisoCaixa((PrmEmpresa), (LNnfinicio))
	    	CASE "NF SERVICO" $ LStp_process
				=NFRgAvisoCaixa((PrmEmpresa), (LNnfsrvIni))
		ENDCASE
	ENDIF


	*----------------------------------------------------------------*

	SELECT orcament
	IF wp_dtsys = wp_dtoper
		IF 	!UPtransacao("TERMINAR")
			WAIT WINDOW "TRANSACAO PERMANECEU ABERTA. VER SUPORTE."
		ENDIF			
	ENDIF
	*---------------------------------------------------------------*
	* 				Fim  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*

	*---------------------------------------------------------------*
	* 				Inicio ---- Impressao  ----
	*---------------------------------------------------------------*



	LFretorno = .T.






	IF  PrmSolicitante = "IMPORTACAO"

		=UNFempmarca(4,LStp_proces,LSOrientacao)

		wp_msg = "Faturamento Concluido "
		WAIT WINDOW wp_msg NOWAIT
	    RETURN(.T.)
	ENDIF



	IF  PrmSolicitante = "RECUPERACAO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		IF  "COPIA" $ LStp_proces
	       LFretorno = ;
		    	NFProcessCopia(orcament.empresa,LNCtrlCpmIni,;
		    	    PrmSolicitante,"ROTINA FATURAMENTO",.T.,.T.)
		ENDIF

	    RETURN(LFretorno)

	ENDIF



	*----------------------------------------------------------------*
	wp_msg = "Imprimindo Doc Fiscal Refrente OSI: "+;
							 STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*


	FlgImpFatura = .t.   &&


	*-------------------------------------------------------------*

	IF "CUPOM" $ LStp_proces

		FlgImpFatura =  NF_ImpCupomFiscal(;
				(orcament.empresa),(orcament.orcamento),(LStp_process),;
				(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
				(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			

	ENDIF

	*-------------------------------------------------------------*


	IF FlgImpFatura
		IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)

			FlgImpFatura =  NF_ImpNFSrvico(;
				(orcament.empresa),(orcament.orcamento),(LStp_process),;
				(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
				(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			

		ENDIF
	ENDIF

	*-------------------------------------------------------------*

	IF FlgImpFatura
		IF "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)

			FlgImpFatura =  NF_ImpNFFiscal(;
				(orcament.empresa),(orcament.orcamento),(LStp_process),;
				(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
				(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			
		ENDIF
	ENDIF


	*-------------------------------------------------------------*

*
*	IF FlgImpFatura
*		IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
*
*			FlgImpFatura =  NF_ImpNFSe(;
*				(orcament.empresa),(orcament.orcamento),(LStp_process),;
*				(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
*				(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
*				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			
*
*		ENDIF
*	ENDIF
*
	*-------------------------------------------------------------*
*	IF FlgImpFatura
*		IF "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
*
*			FlgImpFatura =  NF_ImpNFe(;
*				(orcament.empresa),(orcament.orcamento),(LStp_process),;
*				(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
*				(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
*				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			
*		ENDIF
*
*	ENDIF
*

	*-------------------------------------------------------------*




	=W_DEFPROC("rotinas.spr")

	IF FlgImpFatura

		*-------------------------------------------------*
		*  DEFINIR SOLICITACAO DE COPIA
		*-------------------------------------------------*

		IF  "COPIA" $ LStp_proces

	      LFretorno = ;
	    	NF_02ImpCopia(PrmSolicitante,LNCtrlCpmIni)

		ELSE
			=NF_aviso(orcament.Empresa,LNNfinicio,LNCtrlCpmIni,;
						PrmSolicitante,LStp_proces)
		
		ENDIF

	ELSE

    	WAIT WINDOW "Houve Falha no Impressao do Doc.Fiscal!!!!"
		LFretorno = .F.

	ENDIF


	*----------------------------------------------------------------*
	wp_msg = "Faturamento Concluido "
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*

RETURN(LFretorno)







*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HDZ           NF_ImpCupomFiscal VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   55    º
*       º Variable:            NF_ImpCupomFiscal                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      181                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hdz     &&  NF_ImpCupomFiscal VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NF_ImpCupomFiscal
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------

	IF  "CUPOM" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNCtrlCupomIni,7)

		SELE itemmov
		SET ORDER TO TAG itensnota
		SET NEAR ON
		SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
		SET NEAR OFF			
		*------------------------------------------------------------*
		*  INICIA GERACAO DE ARQUIVO TEMPORARIO
		*------------------------------------------------------------*
		LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
		LSaliastmp 	= "TMP" 		&&     TMP001
		LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
		IF EMPTY(LSaliastmp)
			WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
			LOOP
	 	ENDIF		

	   	=up_fecha("ITNFSTMP")
		WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
		SELE itemmov
		COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND itemmov.nota	<= LNCtrlCupomFim


		SELE 0
		USE  &LSarqtmp  ALIAS ITNFSTMP EXCL
		INDEX ON nota   TAG nota ADDITIVE
		go top
		*----------------------------------------------------------*
		SELE nota

		SET RELATION TO  operador INTO usuario
		***************************************************

		=W_DEFPROC("ECF.SPR")
		LSstatus =ECFctrlimpcupom((LNCtrlCupomIni),;
		       (LNCtrlCupomFim),(LNvalor), nota.total_nota)


		*-----------------------------------------------------------*
		*   Se nao houve erro "E" e o processo emite so "CUPOM"
		* faz a marca (4) fechando o faturamento
		*-----------------------------------------------------------*

		IF SUBS(LSstatus,7,1) = "E"

		   	=up_fecha("ITNFSTMP")
		  	SELECT &LSalias
			*--------------------------------------------------*
			DO CASE
				CASE "NCN - EXECUTADO" $ UPPER(LSstatus)
					IF !NFCancNCN(LNemp,LNCtrlCupomIni)
						wp_msg = "Cupom "+STR(LNCtrlCupomIni,7)+;
						 " nao foi cacelado. Comande Cancelamento < ENTER >"
						WAIT WINDOWS wp_msg
					   	RETURN(.f.)
					ELSE
						=UNFempmarca(4,LStp_proces,LSOrientacao)
					   	RETURN(.f.)
					ENDIF
				OTHERWISE
					IF !NFCancCupom(LNemp,LNCtrlCupomIni)
						wp_msg = "Cupom "+STR(LNCtrlCupomIni,7)+;
						 " nao foi cacelado. Comande Cancelamento < ENTER >"
						WAIT WINDOWS wp_msg
					   	RETURN(.f.)
					ELSE
						=UNFempmarca(4,LStp_proces,LSOrientacao)
					   	RETURN(.f.)
					ENDIF
					*--------------------------------------------------*
			ENDCASE
		  	SELECT &LSalias
		   	RETURN(.F.)
		ENDIF



		*----------------------------------------------------*
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		*----------------------------------------------------*

	   	=up_fecha("ITNFSTMP")
	ENDIF




	=W_DEFPROC("rotinas.spr")



	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HE0           NF_ImpNFFiscal VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   56    º
*       º Variable:            NF_ImpNFFiscal                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      182                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123he0     &&  NF_ImpNFFiscal VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NF_ImpNFFiscal
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------

	*--------------------------------------------------------*
	*  IMPRESSAO DE NOTA CONVENCIONAL  (NAO NFe)
	*--------------------------------------------------------*
    *----------------------------------------------------------*
    * Se houver impressao hibrida da
    *   (NF Convencional e NFe)
    *    LNnfInicio  deve ser restaurado apos a
    *   impressao convencional
    *----------------------------------------------------------*
	LNBkpnfInicio  = LNnfInicio


	*--> N=NAO H=HOMOLOGACAO
	IF      EMPRESA.EMITE_NFE $ "NH" ;
	    AND "NOTA" $ LStp_proces ;
	    AND !("COPIA" $ LStp_proces) ;
	
	
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF

		DO WHILE LNnfinicio  <= LNnffim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfinicio,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itensnota
			SET NEAR ON
			SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

		   	=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
					WHILE nota.empresa = itemmov.empresa ;
						  AND nota.nota	= itemmov.nota
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nota   TAG nota ADDITIVE


			*-------------------------------------------------*
			*>>>   NOVO LAYOUT COM GRID PARA PRODUTO E OUTRA PARA SERV
			*-------------------------------------------------*
			=NFAjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

			*-------------------------------------------------*

			LNimpressao = RECCOUNT()
			go top

			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP
			DO CASE
				CASE   nota.empresa = 2 ;
					OR nota.empresa = 3 ;
					OR nota.empresa = 4 ;
			        OR nota.empresa = 6

					REPORT FORM relnfs6A ;
							WHILE nota.nota = LNnfinicio AND;
	  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

				OTHERWISE
					REPORT FORM relnfs6 ;
							WHILE nota.nota = LNnfinicio AND;
	  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 							NOCONSOLE TO PRINTER
			ENDCASE

			IF      EMPRESA.EMITE_NFE $ "N"
				*----------------------------------------------------*
				=UNFempmarca(4,LStp_proces,LSOrientacao)
				*----------------------------------------------------*

			ENDIF
		   	=up_fecha("ITNFSTMP")

			LNnfinicio	= LNnfinicio + 1

		ENDDO
	ENDIF

 	*--> N=NAO H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFE $ "S"
		*----------------------------------------------------*
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		*----------------------------------------------------*
	ENDIF
    *----------------------------------------------------------*

    *----------------------------------------------------------*
	LNnfInicio  = LNBkpnfInicio



	=W_DEFPROC("rotinas.spr")



	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HE1           NF_ImpNFSrvico VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   57    º
*       º Variable:            NF_ImpNFSrvico                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      183                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123he1     &&  NF_ImpNFSrvico VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NF_ImpNFSrvico
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------


	*---------- IMPRESSAO DE NOTA FISCAL DE SERVICO ------------*
	*****************************************************************
	*--> Redireciona impressora de NOTA FISCAL DE SERVICO
	* APROVEITA CAMPO WP_IMPORC que nao teve  aplicacao no sistema
	*****************************************************************


	LNBkpnfInicio  = LNnfSrvIni

	*--> N=NAO H=HOMOLOGACAO
	IF      (EMPRESA.EMITE_NFS = "S" or EMPRESA.PRINT_NFS = "S");
	    AND "NF SERVICO" $ LStp_proces ;
	    AND !("COPIA" $ LStp_proces)
		LsOrientacao = "SERVICO"
		IF !(EMPTY(ALLTRIM(wp_imporc)))
			LNmtmp =UPnometmp("tmp",2)
			DELETE FILE &LNmtmp
			RUN &wp_imporc > &LNmtmp
		ELSE
			SET PRINTER TO &wp_prtorc
		ENDIF
		*************************************************************
		*--------------------------------------------------
		DO WHILE LNnfSrvIni  <= LNnfSrvFim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfsrvIni,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itensnota
			SET NEAR ON
			SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

			=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND nota.nota	= itemmov.nota


			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nota   TAG nota ADDITIVE

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP



			DO CASE
			
				CASE wp_dtoper < {01.05.2006}

					REPORT FORM relnfsrv ;
						WHILE nota.nota = LNnfsrvIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
							NOCONSOLE TO PRINTER
				

				CASE nota.empresa <> 6
				
					REPORT FORM relnfs6 ;
						WHILE nota.nota = LNnfsrvIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

			

				OTHERWISE

					REPORT FORM relsrv02 ;
						WHILE nota.nota = LNnfsrvIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

			ENDCASE
	
	
	
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*

		   	=up_fecha("ITNFSTMP")
			LNnfsrvIni	= LNnfsrvIni + 1
			
		ENDDO
	ENDIF


	 LNnfSrvIni = LNBkpnfInicio

 	IF      EMPRESA.EMITE_NFSE $ "S" ;
		*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
		*----------------------------------------------------*
	ENDIF



	=W_DEFPROC("rotinas.spr")



	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HFB           ANTNF_ImpNFe VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   58    º
*       º Variable:            ANTNF_ImpNFe                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      184                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hfb     &&  ANTNF_ImpNFe VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION ANTNF_ImpNFe
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------


	*--------------------------------------------------------*
	*  IMPRESSAO(XML) DE NFe
	*--------------------------------------------------------*

	*--> S=SIM H=HOMOLOGACAO
	IF      EMPRESA.EMITE_NFE $ "SH" ;
	    AND "NOTA" $ LStp_proces ;
	    AND !("COPIA" $ LStp_proces)



		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNnfinicio,7)
	    m.EMPRESA    =   nota.Empresa
	

		DO CASE
			CASE LNnfinicio > 3000000 AND LNnfinicio < 4000000
			    m.MOD_DOC    =   "55"  && NFe
		
			OTHERWISE			
				=W_DEFPROC("TIPOOPER.SPR")
				LFieldTmp    = ;
					TPGetFieldValue("S",  nota.tipo ,"Cod_Mod_Rf")
			    m.MOD_DOC    = LFieldTmp
		ENDCASE


	    m.COD_IDFORN  =   SPACE(14)
    	m.NRO_DOC     =   nota.nota
	    m.SERIE_DOC   =   LEFT( nota.Serie +"   ",3)

        PRIVATE LFOk_NFe

		LFOk_NFe = .T.

		=W_DEFPROC("DOCFISCA.SPR")
		LFOk_NFe = DFConvrtNFDocFiscal(NOTA.EMPRESA,NOTA.NOTA)



		PRIVATE LSXMLObjetivo

		LSXMLObjetivo = "EMISSAO"

		IF LFOk_NFe
			=W_DEFPROC("DOCFISCA.SPR")
			LFOk_NFe =(DFGerXMLDocFiscal(LNemp,m.Mod_Doc,m.COD_IDFORN,;
			  m.NRO_DOC,m.Serie_Doc,LSXMLObjetivo ))
		ENDIF


		=W_DEFPROC("DOCFISCA.SPR")
		IF LFOk_NFe
		   LFOk_NFe = (DFEnviaNFeXML(LNemp,m.Nro_Doc))
		ENDIF

		=W_DEFPROC("DOCFISCA.SPR")
		IF LFOk_NFe
			LSstatus = (DFRespostaNFe;
			      (;
				     LNemp,;
				     m.NRO_DOC,;
				     "ESPERA",;
					  RtnStatus,;
					  RtnRecibo,;
				      RtnProtocolo,;
			          RtnChvNFe,;
			          RtnJstfCanc,;
			          RtnPrtcCanc;
				  );
				)
		ENDIF


		IF LFOk_NFe
			=W_DEFPROC("ORCAMENT.SPR")
			IF ORLerRegistro(LNemp,nota.referencia)
  	    	
	  	    	=ORSetPropVT("NFE_STATUS",RtnStatus)
				=ORSetPropVT("NFE_RECIBO",RtnRecibo)
				=ORSetPropVT("NFE_PROTOC",RtnProtocolo)
				=ORSetPropVT("NFE_CHV",RtnChvNFe)
				=ORSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=ORSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=ORSalvarRegistro()
			ENDIF
		ENDIF

		IF LFOk_NFe
			=W_DEFPROC("NOTA.SPR")
			IF NFLerRegistro(LNemp,LNnfinicio)
	  	    	=NFSetPropVT("NFE_STATUS",RtnStatus)
				=NFSetPropVT("NFE_RECIBO",RtnRecibo)
				=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=NFSetPropVT("NFE_CHV",RtnChvNFe)
				=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=NFSalvarRegistro()
			ENDIF
		ENDIF

		IF LFOk_NFe
			=W_DEFPROC("DOCFISCA.SPR")
			IF (DFLerRegistro(LNemp,m.Mod_Doc,m.COD_IDFORN,;
				  m.NRO_DOC,m.Serie_Doc ))
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
			ENDIF
		ENDIF
		IF LFOk_NFe
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		ENDIF

	ENDIF



	=W_DEFPROC("rotinas.spr")



	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HFQ           NF_CopNF_Imprime VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   59    º
*       º Variable:            NF_CopNF_Imprime                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      185                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hfq     &&  NF_CopNF_Imprime VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NF_CopNF_Imprime
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*



	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF






	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------


	*--------------------------------------------------------*
	*  IMPRESSAO CONVENCIONAL DE COPIA DE CUPOM (NAO NFe)
	*--------------------------------------------------------*


    *----------------------------------------------------------*
    * Se houver impressao hibrida sda copia
    *   (NF Convencional e NFe)
    *    LNnfCopInicio  deve ser restaurado apos a
    *   impressao convencional
    *----------------------------------------------------------*
	LNBkpnfCopInicio  = LNnfCopInicio



 	*--> N=NAO H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFE $ "NH" ;
		AND "COPIA EM NOTA" $ LStp_proces
		
		
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF

		DO WHILE LNnfCopInicio  <= LNnfCopFim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfCopInicio,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itenscopia
			SET NEAR ON
			SEEK STR(nota.empresa,3)+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		


		   	=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp FOR LEFT(itemmov.operacao,1) = "S" ;
					WHILE nota.empresa = itemmov.empresa ;
						  AND nota.nota	= itemmov.nf_copia
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nf_copia   TAG nota ADDITIVE

			*-------------------------------------------------*
			*>>>   NOVO LAYOUT COM GRID PARA PRODUTO E OUTRA PARA SERV
			*-------------------------------------------------*
			=NFAjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

			*-------------------------------------------------*

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP

			DO CASE
				CASE   nota.empresa = 2 ;
					OR nota.empresa = 3 ;
					OR nota.empresa = 4 ;
			        OR nota.empresa = 6

					REPORT FORM relnfs6A ;
						WHILE nota.nota = LNnfCopInicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

				OTHERWISE
					REPORT FORM relnfs6 ;
						WHILE nota.nota = LNnfCopInicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
			ENDCASE


			IF      EMPRESA.EMITE_NFE $ "N"
				*----------------------------------------------------*
				=UNFempmarca(4,LStp_proces,LSOrientacao)
				*----------------------------------------------------*

			ENDIF

		   	=up_fecha("ITNFSTMP")

			LNnfCopInicio  = LNnfCopInicio + 1

		ENDDO
	ENDIF


 	*--> N=NAO H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFE $ "S" ;
		=UNFempmarca(4,"COPIA EM NOTA","")
	ENDIF
    *----------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")


	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HFR           ANTNF_CopNFe_Imprime VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   60    º
*       º Variable:            ANTNF_CopNFe_Imprime               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      186                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hfr     &&  ANTNF_CopNFe_Imprime VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION ANTNF_CopNFe_Imprime
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------

	*--------------------------------------------------------*
	*  IMPRESSAO(XML) DE COPIA DE CUPOM EM NFe
	*--------------------------------------------------------*

 	*-->S=SIM H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFE $ "SH" ;
		AND "COPIA EM NOTA" $ LStp_proces


		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNnfCopInicio,7)
	    m.EMPRESA    =   nota.Empresa
	
		DO CASE
			CASE LNnfCopInicio > 3000000 AND LNnfCopInicio < 4000000
			    m.MOD_DOC    =   "55"  && NFe
		
			OTHERWISE			
				=W_DEFPROC("TIPOOPER.SPR")
				LFieldTmp    = ;
					TPGetFieldValue("S",  nota.tipo ,"Cod_Mod_Rf")
			    m.MOD_DOC    = LFieldTmp
		ENDCASE

	    m.COD_IDFORN  =   SPACE(14)
    	m.NRO_DOC     =   nota.nota
	    m.SERIE_DOC   =   LEFT( nota.Serie +"   ",3)


        PRIVATE LFOk_NFe

		LFOk_NFe = .T.

		=W_DEFPROC("DOCFISCA.SPR")
		LFOk_NFe = DFConvrtNFDocFiscal(NOTA.EMPRESA,NOTA.NOTA)



		PRIVATE LSXMLObjetivo

		LSXMLObjetivo = "EMISSAO"

		IF LFOk_NFe
			=W_DEFPROC("DOCFISCA.SPR")
			LFOk_NFe =(DFGerXMLDocFiscal(LNemp,m.Mod_Doc,m.COD_IDFORN,;
			  m.NRO_DOC,m.Serie_Doc,LSXMLObjetivo ))
		ENDIF




		IF LFOk_NFe
			=W_DEFPROC("DOCFISCA.SPR")
			LFOk_NFe = (DFEnviaNFeXML(LNemp,m.Nro_Doc))
		ENDIF

		IF LFOk_NFe

			=W_DEFPROC("DOCFISCA.SPR")
			LSstatus = (DFRespostaNFe;
			      (;
				     LNemp,;
				     m.NRO_DOC,;
				     "ESPERA",;
					  RtnStatus,;
					  RtnRecibo,;
				      RtnProtocolo,;
			          RtnChvNFe,;
			          RtnJstfCanc,;
			          RtnPrtcCanc;
				  );
				)
		ENDIF

		IF LFOk_NFe
			IF NFLerRegistro(LNemp,LNnfCopInicio)
  		    	=NFSetPropVT("NFE_STATUS",RtnStatus)
				=NFSetPropVT("NFE_RECIBO",RtnRecibo)
				=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=NFSetPropVT("NFE_CHV",RtnChvNFe)
				=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=NFSalvarRegistro()
			ENDIF
		ENDIF

		IF LFOk_NFe
			=W_DEFPROC("DOCFISCA.SPR")
			IF (DFLerRegistro(LNemp,m.Mod_Doc,m.COD_IDFORN,;
				  m.NRO_DOC,m.Serie_Doc ))
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
			ENDIF
		ENDIF
		IF LFOk_NFe
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		ENDIF
	ENDIF



	=W_DEFPROC("rotinas.spr")




	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HGL           NF_CopNFSrvImprime VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   61    º
*       º Variable:            NF_CopNFSrvImprime                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      187                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hgl     &&  NF_CopNFSrvImprime VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NF_CopNFSrvImprime
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------

	LNBkpnfCopInicio  = LNSrvCopIni



 	*--> N=NAO H=HOMOLOGACAO
	IF      (EMPRESA.EMITE_NFS = "S" or EMPRESA.PRINT_NFS = "S");
		AND "COPIA EM NF SERVICO" $ LStp_proces

		LsOrientacao = "SERVICO"
		IF !(EMPTY(ALLTRIM(wp_imporc)))
			LNmtmp =UPnometmp("tmp",2)
			DELETE FILE &LNmtmp
			RUN &wp_imporc > &LNmtmp
		ELSE
			SET PRINTER TO &wp_prtorc
		ENDIF
		*************************************************************
		*--------------------------------------------------
		DO WHILE LNSrvCopIni  <= LNSrvCopFim

			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNSrvCopIni,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itenscopia
			SET NEAR ON
			SEEK STR(nota.empresa,3)+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*

			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

	   		=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp FOR LEFT(itemmov.operacao,1) = "S" ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND nota.nota	= itemmov.nf_copia
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nf_copia   TAG nota ADDITIVE

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP

	
			IF wp_dtoper < {01.05.2006}
				REPORT FORM relnfsrv ;
					WHILE nota.nota = LNSrvCopIni AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 					NOCONSOLE TO PRINTER
			ELSE
				REPORT FORM relsrv02 ;
					WHILE nota.nota = LNSrvCopIni  AND;
  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 					NOCONSOLE TO PRINTER
			ENDIF






			DO CASE
			
				CASE wp_dtoper < {01.05.2006}

					REPORT FORM relnfsrv ;
						WHILE nota.nota = LNSrvCopIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
				

				CASE nota.empresa <> 6
				
					REPORT FORM relnfs6 ;
						WHILE nota.nota = LNSrvCopIni  AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
			

				OTHERWISE

					REPORT FORM relsrv02 ;
						WHILE nota.nota = LNSrvCopIni  AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

			ENDCASE
	







			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		   	=up_fecha("ITNFSTMP")

			LNSrvCopIni	= LNSrvCopIni + 1
		ENDDO
	ENDIF



 	*--> N=NAO H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFSE $ "S" ;
		=UNFempmarca(4,"COPIA EM NF SERVICO","")
	ENDIF


	LNSrvCopIni = LNBkpnfCopInicio
	
	=W_DEFPROC("rotinas.spr")




	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HH2           NFAtlzDadosNFe VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   63    º
*       º Variable:            NFAtlzDadosNFe                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      188                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hh2     &&  NFAtlzDadosNFe VALID
#REGION 5
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFAtlzDadosNFe
PARAMETER PrmEmp,PrmDtIni,PrmDtFim




    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTA")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	=DFVerifyInst()



	SELE &ALSNota
	SET ORDER TO TAG DATA
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() AND &ALSNota .empresa = PrmEmp ;
				AND &ALSNota .data >= PrmDtIni ;
    	        AND &ALSNota .data <= PrmDtFim ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

	DO WHILE !EOF() ;
					AND	LFsegue = .t. ;
					AND &ALSNota .empresa = PrmEmp ;
					AND &ALSNota .data >= PrmDtIni ;
	                AND &ALSNota .data <= PrmDtFim
		
		=UPtermo()

		LPrmNota = &ALSNota .Nota


		if LPrmNota >= 3000000 and LPrmNota <= 3000000
			=W_DEFPROC("DOCFISCA.SPR")
			=DFConvrtNFDocFiscal(PrmEmp, LPrmNota)
			
			=NFRtrnoNfe_NOTA(PrmEmp,  LPrmNota, "NAO ESPERA")

		ENDIF


		SELE  &ALSNota
		SKIP
		CTR = 	CTR + 1
	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HH7           NFVrfSeqNroNotas VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   64    º
*       º Variable:            NFVrfSeqNroNotas                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      189                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hh7     &&  NFVrfSeqNroNotas VALID
#REGION 5
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFVrfSeqNroNotas
PARAMETER PrmEmp,PrmDtIni,PrmDtFim, PrmArquivoLog




    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTA")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	=DFVerifyInst()



	SELE &ALSNota
	SET ORDER TO TAG DATA
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI



	SET TALK ON
	SELECT NF.NOTA,NF.DATA ;
	FROM &ALSNota NF;
	WHERE   NF.empresa = PrmEmp ;
		AND NF.data >= PrmDtIni ;
    	AND NF.data <= PrmDtFim ;
    INTO CURSOR NFselec;
    ORDER BY NF.NOTA
	SET TALK OFF




	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	GO TOP
	LNregistro = RECNO()

	SELE NFselec

	COUNT  TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*


   	PRIVATE LSfileXML,LNroIDfileXML, LSnomeArqXml

	IF TYPE("PrmArquivoLog") = "U" OR EMPTY(PrmArquivoLog)
		LSnomeArqXml = "\TMP\SEQ_NOTA.TXT"
	ELSE
		LSnomeArqXml = PrmArquivoLog
	ENDIF
   	LSfileXML	= LSnomeArqXml



  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return
   	endif


	*---------------------------------------------------*
	PRIVATE LctrSeq, LString
	LctrSeq = NFselec.nota

	LString = "Inicio Verificacao"

	=fPuts(LNroIDfileXML,LString,LEN(LString))


	SELE NFselec
	DO WHILE !EOF() AND	LFsegue = .t.
		
		=UPtermo()

		IF 	LctrSeq <> NFselec.nota

			LString = "      "
			=fPuts(LNroIDfileXML,LString,LEN(LString))

			LString = "       -Faltam nro entre: "+;
			          STR(LctrSeq,7) +;
					  " e "+;	
			          STR( NFselec.nota ,7) +;
					  " de "+;	
			          DTOC( NFselec.data )
			
			
			=fPuts(LNroIDfileXML,LString,LEN(LString))

			LString = "      "
			=fPuts(LNroIDfileXML,LString,LEN(LString))

			LctrSeq = NFselec.nota

		ELSE

			LString = STR(LctrSeq,7) +;
					  " OK "+;
					  " de "+;	
			          DTOC( NFselec.data )

			=fPuts(LNroIDfileXML,LString,LEN(LString))
		ENDIF


		SELE  NFselec
		SKIP

		LctrSeq  = LctrSeq + 1

	ENDDO

	SELE NFselec
	USE

	LString = "Final Verificacao"

	=fPuts(LNroIDfileXML,LString,LEN(LString))

    =fclose(LNroIDfileXML)

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF






	*****************************************
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
						_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"

	******************************************

	KEYBOARD "{CTRL-F10}"
	MODIF COMM &LSnomeArqXml   NOEDIT

	*****************************************
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	HIDE MENU _MSYSMENU
	*****************************************


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HH8           NF_02DefProcess VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   65    º
*       º Variable:            NF_02DefProcess                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      190                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hh8     &&  NF_02DefProcess VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NF_02DefProcess
PARAMETERS PrmEmpresa,LStipo,LFproduto,LFservico,LFipi,;
		LDdatanf,LStp_process,PrmTpPessoa,PrmTpInscr,PrmInscricao,;
	     PrmSolicitante


	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Definir o processo que orienta o faturamento
	*		em relacao a NOTA e ou ECF
	*------------------------------------------------------------*
	* COMENTARIO..: Exitem diferencas de tratamento do ECF/NOTA
	*			entre as filiais que implicam na emissao ou nao
	*			de CUPOM ou NOTA
	*		LStp_process...: Processo definido em NF_02DefProcess
	*				LStp_proces	= "CUPOM"
	*				LStp_proces	= "CUPOM/COPIA EM NOTA"
	*				LStp_proces	= "CUPOM/COPIA EM NF SERVICO"
	*				LStp_proces	= "CUPOM/COPIA EM NOTA/COPIA EM NF SERVICO"
    *
	*				LStp_proces	= "NOTA"
	*
	*				LStp_proces	= "NF SERVICO"
	*
	*				LStp_proces	= "NOTA/NF SERVICO"
    *
	*				LStp_proces	= "REC.CUPOM"
	*				LStp_proces	= "REC.NOTA"
	*				LStp_proces	= "REC.NF SERVICO"
	*				LStp_proces	= "REC.NOTA/REC.NF SERVICO"
	*   Existem dois pocessos extras definidos na rotina que solicita
	*  copia de cupom.
	*					LStp_proces	= "COPIA CUPOM EM NOTA"
	*					LStp_proces	= "COPIA CUPOM EM NF SERVICO"
	**********************************************************************
	*  INICIO DESCRICAO DE PASSOS
	*	WP_ECF = [S]	= ECF CONECTADO EM PROCESSO NORMAL
	*			 [R]	= ECF CONECTADO EM PROCESSO DE RECUPERACAO DE DADOS	
	*
	*			 [I]	= ECF CONECTADO SEM AUTORIZACAO P/ SERVICO
	*			 [Q]	= ECF CONECTADO SEM AUTORIZACAO P/ SERVICO EM
	*						 RECUPERACAO DADOS
	*
	*			 [N]	= ECF NAO CONECTADO
	*			 [E]	= ECF NAO CONECTADO EM PROCESSO DE RECUPERACAO DADOS
	*	
	* 		Se for imprimir CUPOM (FOR (VENDA INTERNA A CONTRIBUITE
	*				ESTADUAL(1) OU INSCRITO(2) OU NAO INSCRITO(3))  OU VENDA
	*				EXTERNA PARA CONTRIBUINTE NAO INSCRITO(3))
	*	=> LER NUMERO DO CUPOM ; LER ULTIMO REGISTRO DE CUPOM (EMPRESA) ;
	*	   	DIFERENCIAR NRO. REGISTRO DO CUPOM DO NRO DE NF . COM + 100000
	**********************************************************************
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNtipo.........: Tipo da Operacao
	*		LFproduto......: Flag indicando existencia de produto
	*		LFservico......: Flag indicando existencia de servico
	*						para faturar
	*						.T. => Sera faturado servico
	*						.F. => Nao Sera faturado servico
	*------------------------------------------------------------*
	*  RETORNO.....:
	*			LStp_process : Identificacao do processo
	*
	*					FUNCAO RETORNA .T. ou .F.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSecf
	PRIVATE LSmarca

	*-----------------------------------------------------------*
	PRIVATE  LNCheque1Vlr,LNCheque2Vlr,LNCheque3Vlr,;
				 LNDinheiroVlr, LNCartaoVlr,LNTicketVlr,LNDuplicatVlr
	STORE 0 TO   LNCheque1Vlr,LNCheque2Vlr,LNCheque3Vlr,;
				 LNDinheiroVlr, LNCartaoVlr,LNTicketVlr,LNDuplicatVlr

	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	SELE parametr
	SET ORDER TO TAG EMPRESA
	SEEK PrmEmpresa
	IF !FOUND()
		GO TOP
	ENDIF
	LSecf		= parametr.usa_ecf
	LSmarca		= parametr.tipo_ecf

	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 's'+LStipo
	IF !FOUND()
		SEEK 'S'+LStipo  	
	ENDIF
	IF !FOUND()
		DO OBJ_MENS.SPR WITH ;
	   		"Nao foi possivel Localizar Tipo de Operacao (TIPOOPER)."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	*<<<<<<<<<<<<<<< DEFININDO MODELO DO PROCESSO FATURAMENTO >>>>>>>>>>>>>
	*-----------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	=ORVlr_e_FormPgto(PrmEmpresa,;
		  orcament.orcamento,;
		  LNCheque1Vlr,;
		  LNDinheiroVlr,;
		  LNCartaoVlr,;
		  LNDuplicatVlr)
	*-----------------------------------------------------------*
    * 1-DEFININE DOCUMENTO FISCAL PRINCIPAL
	*-----------------------------------------------------------*
	DO CASE
		CASE LSecf $ "I/Q/S/R"	
			DO CASE
				CASE LNCartaoVlr > 0
					LStp_proces	= "CUPOM"
				CASE tipooper.ch_opera <> "1"
					LStp_proces	= "NOTA"
				CASE PrmTpPessoa = 2	&& JURIDICA
					LStp_proces	= "NOTA"
				CASE PrmTpInscr  = 1   && ESTADUAL
					LStp_proces	= "NOTA"
				CASE tipooper.ch_contr $ "13"
					LStp_proces	= "CUPOM"
				CASE tipooper.ch_contr $ "4"    && REVENDEDOR
					LStp_proces	= "NOTA"
				CASE tipooper.ch_desti = "2" AND tipooper.ch_contr $ "2"
					LStp_proces	= "NOTA"
				OTHERWISE
					LStp_proces	= "NOTA"
			ENDCASE			
		CASE LSecf $ "N"	
			LStp_proces	= "NOTA"
		OTHERWISE
			DO OBJ_MENS.SPR WITH " Nao esta definido Parametro para " +;
				"Forma de tratamento do ECF/FATURAMENTO"
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
			
	ENDCASE

	*-----------------------------------------------------------*
    * 2-DEFININE DOCUMENTOS AUXILIARES (COPIA) / NF.SERVICO
	*-----------------------------------------------------------*
	*---------------------------------------------------------*
	* AS CAPAS DAS COPIAS SAO IMPORTADAS JUNTO COM AS CAPAS
	* DAS NOTAS CANCELADAS. SENDO ASSIM NA IMPORTACAO NAO SERA
	* FEITA GERACAO DE COPIAS PELA RORINA FATURAMENTO
	*---------------------------------------------------------*
	*-----------------------------------------------------------*
	PRIVATE LSemi_NFe,LSemi_NFS,LSemi_NFSe
	
	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFe = EMGetFieldValue(PrmEmpresa,"EMITE_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFS = EMGetFieldValue(PrmEmpresa,"EMITE_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFSe = EMGetFieldValue(PrmEmpresa,"EMITE_NFSE")

	*------------------------------------------------------------*


	DO CASE
			CASE LStp_proces	= "CUPOM"


				IF PrmSolicitante <> "IMPORTACAO"

					IF  LFipi= .T. OR LFproduto = .T.
						LStp_proces	= LStp_proces+"/COPIA EM NOTA"
					ENDIF


					IF  LFservico .T. ;
					  AND (LSemi_NFS = "S" OR  LSemi_NFSe = "S")
					      LStp_proces = LStp_proces+"/COPIA EM NF SERVICO"
					ENDIF


				ENDIF

			CASE LStp_proces	= "NOTA"

				IF LSemi_NFS = "S" OR LSemi_NFSe = "S"
					DO CASE

						CASE LFservico = .T. AND LFproduto = .T.
							LStp_proces	= LStp_proces+"/NF SERVICO"

						CASE LFservico = .T. AND LFproduto = .F.
							LStp_proces	= "NF SERVICO"

					ENDCASE
				ENDIF
	ENDCASE
	*--------------------------------------------------------------*
	IF LSecf $ "Q/R/E"	OR 	PrmSolicitante $ "RECUPERACAO"
		LStp_proces	= "REC."+LStp_proces
	ENDIF



	*---------------------------------------------------------------*
	*  NA IMPORTACAO NAO HA COMO SABER A SITUACAO DOS PARAMETROS
	* NO MOMENTO DO FATURAMENTO,SENDO ASSIM A DEFINICAO DO PROCESSO
	* E FEITA CONFORME O TIPO DE DOCUMENTO GERADO NO FATURAMENTO
	*---------------------------------------------------------------*
	* NO CASO DE COPIA ELAS SAO IMPORTAS JUNTO COM AS NOTAS CANCELADAS
	* E SOMENTE AS CAPAS
	*---------------------------------------------------------------*
	

	IF PrmSolicitante $ "IMPORTACAO"

		DO CASE
			CASE  orcament.nota >= 3000000 ;
			  AND orcament.nota <= 3999999
					LStp_proces	= "NOTA"

					IF   orcament.NFSERVICO >= 2000000 ;
					 AND orcament.NFSERVICO <  3000000
					   LStp_proces	= LStp_proces+"/NF SERVICO"
					ENDIF

					IF   orcament.NFSERVICO >= 4000000 ;
					 AND orcament.NFSERVICO <  5000000
					   LStp_proces	= LStp_proces+"/NF SERVICO"
					ENDIF




			CASE  orcament.nota < 1000000  && 0 ---> 999999
					LStp_proces	= "NOTA"

					IF   orcament.NFSERVICO >= 2000000 ;
					 AND orcament.NFSERVICO <  3000000
					   LStp_proces	= LStp_proces+"/NF SERVICO"
					ENDIF

					IF   orcament.NFSERVICO >= 4000000 ;
					 AND orcament.NFSERVICO <  5000000
					   LStp_proces	= LStp_proces+"/NF SERVICO"
					ENDIF


			CASE  orcament.nota < 2000000  && 1000000 ---> 2000000
					LStp_proces	= "CUPOM"

			OTHERWISE
					LStp_proces	= "NF SERVICO"
		ENDCASE
		LStp_proces	= "REC."+LStp_proces
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HH9           ANTNF_ImpNFSe VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   66    º
*       º Variable:            ANTNF_ImpNFSe                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      191                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hh9     &&  ANTNF_ImpNFSe VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION ANTNF_ImpNFSe
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------


	*--------------------------------------------------------*
	*  IMPRESSAO(XML) DE NFe
	*--------------------------------------------------------*


	*--> S=SIM H=HOMOLOGACAO
	IF      EMPRESA.EMITE_NFSE $ "SH" ;
	    AND "NF SERVICO" $ LStp_proces ;
	    AND !("COPIA" $ LStp_proces)



		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNnfSrvIni,7)
	    m.EMPRESA    =   nota.Empresa
	

		DO CASE
			CASE LNnfSrvIni > 4000000 AND LNnfSrvIni < 5000000
			    m.MOD_DOC    =   "77"  && NFe
		
			OTHERWISE			
				=W_DEFPROC("TIPOOPER.SPR")
				LFieldTmp    = ;
					TPGetFieldValue("S",  nota.tipo ,"Cod_Mod_Rf")
			    m.MOD_DOC    = LFieldTmp
		ENDCASE


	    m.COD_IDFORN  =   SPACE(14)
    	m.NRO_DOC     =   nota.nota
	    m.SERIE_DOC   =   LEFT( nota.Serie +"   ",3)

        PRIVATE LFOk_NFe

		LFOk_NFe = .T.

		=W_DEFPROC("DOCFISCA.SPR")
		LFOk_NFe = DFConvrtNFDocFiscal(NOTA.EMPRESA,NOTA.NOTA)



		PRIVATE LSXMLObjetivo

		LSXMLObjetivo = "ESCRITURACAO"

		IF LFOk_NFe
			=W_DEFPROC("DOCFISCA.SPR")
			LFOk_NFe =(DFGerXMLDocFiscal(LNemp,m.Mod_Doc,m.COD_IDFORN,;
			  m.NRO_DOC,m.Serie_Doc,LSXMLObjetivo ))
		ENDIF




		=W_DEFPROC("DOCFISCA.SPR")
		IF LFOk_NFe
		   LFOk_NFe = (DFEnviaNFeXML(LNemp,m.Nro_Doc))
		ENDIF

		=W_DEFPROC("DOCFISCA.SPR")
		IF LFOk_NFe
			LSstatus = (DFRespostaNFe;
			      (;
				     LNemp,;
				     m.NRO_DOC,;
				     "ESPERA",;
					  RtnStatus,;
					  RtnRecibo,;
				      RtnProtocolo,;
			          RtnChvNFe,;
			          RtnJstfCanc,;
			          RtnPrtcCanc;
				  );
				)
		ENDIF


		IF LFOk_NFe
			=W_DEFPROC("ORCAMENT.SPR")
			IF ORLerRegistro(LNemp,nota.referencia)
  	    	
	  	    	=ORSetPropVT("NFE_STATUS",RtnStatus)
				=ORSetPropVT("NFE_RECIBO",RtnRecibo)
				=ORSetPropVT("NFE_PROTOC",RtnProtocolo)
				=ORSetPropVT("NFE_CHV",RtnChvNFe)
				=ORSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=ORSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=ORSalvarRegistro()
			ENDIF
		ENDIF

		IF LFOk_NFe
			=W_DEFPROC("NOTA.SPR")
			IF NFLerRegistro(LNemp,LNnfinicio)
	  	    	=NFSetPropVT("NFE_STATUS",RtnStatus)
				=NFSetPropVT("NFE_RECIBO",RtnRecibo)
				=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=NFSetPropVT("NFE_CHV",RtnChvNFe)
				=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=NFSalvarRegistro()
			ENDIF
		ENDIF

		IF LFOk_NFe
			=W_DEFPROC("DOCFISCA.SPR")
			IF (DFLerRegistro(LNemp,m.Mod_Doc,m.COD_IDFORN,;
				  m.NRO_DOC,m.Serie_Doc ))
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
			ENDIF
		ENDIF
		IF LFOk_NFe
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		ENDIF

	ENDIF



	=W_DEFPROC("rotinas.spr")



	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HIB           ANTNF_CopNFSe_Imprime VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   67    º
*       º Variable:            ANTNF_CopNFSe_Imprime              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      192                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hib     &&  ANTNF_CopNFSe_Imprime VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION ANTNF_CopNFSe_Imprime
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------

	*--------------------------------------------------------*
	*  IMPRESSAO(XML) DE COPIA DE CUPOM EM NFe
	*--------------------------------------------------------*


 	*-->S=SIM H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFSE $ "SH" ;
		AND "COPIA EM NF SERVICO" $ LStp_proces


		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNSrvCopIni,7)
	    m.EMPRESA    =   nota.Empresa
	
		DO CASE
			CASE LNSrvCopIni > 4000000 AND LNSrvCopIni < 5000000
			    m.MOD_DOC    =   "77"  && NFSe
		
			OTHERWISE			
				=W_DEFPROC("TIPOOPER.SPR")
				LFieldTmp    = ;
					TPGetFieldValue("S",  nota.tipo ,"Cod_Mod_Rf")
			    m.MOD_DOC    = LFieldTmp
		ENDCASE

	    m.COD_IDFORN  =   SPACE(14)
    	m.NRO_DOC     =   nota.nota
	    m.SERIE_DOC   =   LEFT( nota.Serie +"   ",3)


        PRIVATE LFOk_NFe

		LFOk_NFe = .T.

		=W_DEFPROC("DOCFISCA.SPR")
		LFOk_NFe = DFConvrtNFDocFiscal(NOTA.EMPRESA,NOTA.NOTA)



		PRIVATE LSXMLObjetivo

		LSXMLObjetivo = "ESCRITURACAO"

		IF LFOk_NFe
			=W_DEFPROC("DOCFISCA.SPR")
			LFOk_NFe =(DFGerXMLDocFiscal(LNemp,m.Mod_Doc,m.COD_IDFORN,;
			  m.NRO_DOC,m.Serie_Doc,LSXMLObjetivo ))
		ENDIF


		IF LFOk_NFe
			=W_DEFPROC("DOCFISCA.SPR")
			LFOk_NFe = (DFEnviaNFeXML(LNemp,m.Nro_Doc))
		ENDIF

		IF LFOk_NFe

			=W_DEFPROC("DOCFISCA.SPR")
			LSstatus = (DFRespostaNFe;
			      (;
				     LNemp,;
				     m.NRO_DOC,;
				     "ESPERA",;
					  RtnStatus,;
					  RtnRecibo,;
				      RtnProtocolo,;
			          RtnChvNFe,;
			          RtnJstfCanc,;
			          RtnPrtcCanc;
				  );
				)
		ENDIF

		IF LFOk_NFe
			IF NFLerRegistro(LNemp,LNnfCopInicio)
  		    	=NFSetPropVT("NFE_STATUS",RtnStatus)
				=NFSetPropVT("NFE_RECIBO",RtnRecibo)
				=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=NFSetPropVT("NFE_CHV",RtnChvNFe)
				=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=NFSalvarRegistro()
			ENDIF
		ENDIF

		IF LFOk_NFe
			=W_DEFPROC("DOCFISCA.SPR")
			IF (DFLerRegistro(LNemp,m.Mod_Doc,m.COD_IDFORN,;
				  m.NRO_DOC,m.Serie_Doc ))
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
			ENDIF
		ENDIF
		IF LFOk_NFe
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		ENDIF
	ENDIF



	=W_DEFPROC("rotinas.spr")




	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HIP           NFSerie VALID                      º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   68    º
*       º Variable:            NFSerie                            º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      193                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hip     &&  NFSerie VALID
#REGION 5
return

*---------------------------------------------------------------*
FUNCTION NFSerie
PARAMETER PrmEmpresa,PrmMuni_ibge,PrmNroNF

PRIVATE LSSerie





	DO CASE

		CASE PrmNroNF <=  999999   && NOTAS
		   LSserie = "U"
		
		   =W_DEFPROC("EMPRESA.SPR")
		   LSserie = EMGetFieldValue(PrmEmpresa,"SERIE_NF")

		CASE PrmNroNF <= 1999999   && CUPONS
		   LSserie = "U"

		CASE PrmNroNF <= 2999999   && NF SERVICO
		   LSserie = "U"

		
		   =W_DEFPROC("EMPRESA.SPR")
		   LSserie = EMGetFieldValue(PrmEmpresa,"SERIE_NFS")


		CASE PrmNroNF <= 3999999   && NFe
		   LSserie = "1"

		
		   =W_DEFPROC("EMPRESA.SPR")
		   LSserie = EMGetFieldValue(PrmEmpresa,"SERIE_NFE")


		CASE PrmNroNF <= 4999999 && and PrmEmpresa = 6  && NFSe CGB VARZEA
		
		   LSserie = "8"

		   =W_DEFPROC("EMPRESA.SPR")
		   LSserie = EMGetFieldValue(PrmEmpresa,"SERIE_NFSE")


		OTHERWISE

		   LSserie = "1"
	ENDCASE

RETURN(LSserie)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HIU           NF_CancDFis VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   71    º
*       º Variable:            NF_CancDFis                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      194                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hiu     &&  NF_CancDFis VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NF_CancDFis
PARAMETERS PrmEmpresa, PrmNota, PrmObjetivo




	PRIVATE NFAlias


	PRIVATE LSAlias
	LSalias		= 	ALIAS()


	=W_DEFPROC("NOTA.SPR")
	NFAlias = NFGetAlias()



	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NF nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	*-->>>>>>>>>>>>>     PARA ENVIO NFE
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= &NFAlias .Serie
	PrmTipo    		= &NFAlias .Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*

	*-->>>>>>>>>>>       PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc
	*----------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)





	IF  RtnMOD_DOC    <>   "55"
		RETURN(.T.)
	ENDIF

	RETURN(.T.)


    PRIVATE LFOk_NFe

	LFOk_NFe = .T.
*
*	=W_DEFPROC("DOCFISCA.SPR")
*	LFOk_NFe = DFConvrtNFDocFiscal(PrmEmpresa,PrmNota)
*


	PRIVATE LSXMLObjetivo

	LSXMLObjetivo = "CANCELAMENTO"

	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		LFOk_NFe =(DFGerXMLDocFiscal(PrmEmpresa,;
									RtnMod_Doc,;
 						            RtnCOD_IDFORN,;
		 							RtnNro_Doc,;
		 							RtnSerie_Doc,;
		 							LSXMLObjetivo ))
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe
	   LFOk_NFe = (DFEnviaNFeXML(;
	   					PrmEmpresa,;
	   					RtnMod_Doc,;
	   					RtnNro_Doc))
	ENDIF

	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe
		LSstatus = (DFRespostaNFe;
		      (;
				PrmEmpresa,;
				RtnMod_Doc,;
	   			RtnNro_Doc,;
			     "ESPERA",;
				  RtnStatus,;
				  RtnRecibo,;
			      RtnProtocolo,;
		          RtnChvNFe,;
		          RtnJstfCanc,;
		          RtnPrtcCanc;
			  );
			)
		IF "ERRO" $ LSstatus
			 LFOk_NFe = .F.
		ENDIF
		IF !("CANCELADA" $ LSstatus)
			 LFOk_NFe = .F.
		ENDIF

	ENDIF


	IF LFOk_NFe
		=W_DEFPROC("NOTA.SPR")
		IF NFLerRegistro(PrmEmpresa, PrmNota)
  	    	=NFSetPropVT("NFE_STATUS",RtnStatus)
			=NFSetPropVT("NFE_RECIBO",RtnRecibo)
			=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
			=NFSetPropVT("NFE_CHV",RtnChvNFe)
			=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
			=NFSalvarRegistro()
		ENDIF
	ENDIF

	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		IF (DFLerRegistro(PrmEmpresa,RtnMod_Doc,;
		      RtnCOD_IDFORN,;
			  RtnNro_Doc,RtnSerie_Doc ))
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
		ENDIF
	ENDIF


	=W_DEFPROC("rotinas.spr")


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	*--------------------------------------------------------------*
RETURN(LFOk_NFe)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HIV           NF_GeraDFis VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   72    º
*       º Variable:            NF_GeraDFis                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      195                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hiv     &&  NF_GeraDFis VALID
#REGION 5
return
*---------------------------------------------------------------*

FUNCTION NF_GeraDFis
PARAMETERS PrmEmpresa, PrmNota,PrmObjetivo,PrmOrientacao



	IF !(PrmObjetivo $ "ESCRITURACAO/EMISSAO/CANCELAMENTO")
	    RETURN(.T.)
	ENDIF


	PRIVATE NFAlias

	PRIVATE LSAlias
	LSalias		= 	ALIAS()




	=W_DEFPROC("NOTA.SPR")
	NFAlias = NFGetAlias()


	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NF nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"
		WAIT MSG


	   *-----<<<< CONSIDERA A NFe MESMO COM ERRO >>>>*------						
	   RETURN(.T.)
	   *----------------------------------------------------

		RETURN(.F.)
	ENDIF


	*-->>>>>>>>>>>>>     PARA ENVIO NFE
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= &NFAlias .Serie
	PrmTipo    		= &NFAlias .Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*

	*-->>>>>>>>>>>       PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc
	*----------------------------------------------------*

	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)







    PRIVATE LFOk_NFe

	LFOk_NFe = .T.

	=W_DEFPROC("DOCFISCA.SPR")
	LFOk_NFe = DFConvrtNFDocFiscal(PrmEmpresa,PrmNota,PrmOrientacao)



	PRIVATE LSXMLObjetivo

	LSXMLObjetivo = PrmObjetivo

	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		LFOk_NFe =(DFGerXMLDocFiscal(PrmEmpresa,;
									RtnMod_Doc,;
 						            RtnCOD_IDFORN,;
		 							RtnNro_Doc,;
		 							RtnSerie_Doc,;
		 							LSXMLObjetivo ))
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe
	   LFOk_NFe = (DFEnviaNFeXML(;
	   					PrmEmpresa,;
	   					RtnMod_Doc,;
	   					RtnNro_Doc))
	ENDIF

	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe
		LSstatus = (DFRespostaNFe;
		      (;
				PrmEmpresa,;
				RtnMod_Doc,;
	   			RtnNro_Doc,;
			     "ESPERA",;
				  RtnStatus,;
				  RtnRecibo,;
			      RtnProtocolo,;
		          RtnChvNFe,;
		          RtnJstfCanc,;
		          RtnPrtcCanc;
			  );
			)
		IF "ERRO" $ LSstatus
			 LFOk_NFe = .F.
		ENDIF

	ENDIF


	IF LFOk_NFe
		=W_DEFPROC("NOTA.SPR")
		IF NFLerRegistro(PrmEmpresa, PrmNota)
  	    	=NFSetPropVT("NFE_STATUS",RtnStatus)
			=NFSetPropVT("NFE_RECIBO",RtnRecibo)
			=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
			=NFSetPropVT("NFE_CHV",RtnChvNFe)
			=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
			=NFSalvarRegistro()
		ENDIF
	ENDIF


	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		IF (DFLerRegistro(PrmEmpresa,RtnMod_Doc,;
		      RtnCOD_IDFORN,;
			  RtnNro_Doc,RtnSerie_Doc ))
	  	
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
		ENDIF
	ENDIF


	=W_DEFPROC("rotinas.spr")


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF


   *-----<<<< CONSIDERA A NFe MESMO COM ERRO >>>>*------						
   RETURN(.T.)
   *----------------------------------------------------


	*--------------------------------------------------------------*
RETURN(LFOk_NFe)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HIW           NFDefCancDFis VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   74    º
*       º Variable:            NFDefCancDFis                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      196                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hiw     &&  NFDefCancDFis VALID
#REGION 5
return
*---------------------------------------------------------------*

********************
FUNCTION NFDefCancDFis
PARAMETERS PrmEmpresa,PrmNota


	*-->>>>>>>>>>>>>     PARA ENVIO NFE
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= ""
	PrmTipo    		= ""
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*



	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	*----------------------------------------------------*


	RETURN("NAO INTEGRAR")
	




	*-----------------------------------------------------------*
	PRIVATE LSemi_NF,LSemi_NFe,LSemi_NFS,LSemi_NFSe,LSemi_ECF
	PRIVATE LSscr_NF,LSscr_NFe,LSscr_NFS,LSscr_NFSe,LSscr_ECF

	*------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NF = EMGetFieldValue(PrmEmpresa,"EMITE_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFe = EMGetFieldValue(PrmEmpresa,"EMITE_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFS = EMGetFieldValue(PrmEmpresa,"EMITE_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFSe = EMGetFieldValue(PrmEmpresa,"EMITE_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_ecf = EMGetFieldValue(PrmEmpresa,"EMITE_ECF")

	*------------------------------------------------------------*

	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NF = EMGetFieldValue(PrmEmpresa,"ESCRT_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFS = EMGetFieldValue(PrmEmpresa,"ESCRT_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFSe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ecf = EMGetFieldValue(PrmEmpresa,"ESCRT_ECF")


	*------------------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "NAO INTEGRAR"



	DO CASE
	
		CASE  RtnMOD_DOC    =   "2D"  && CUPOM

			DO CASE
				CASE LSemi_ECF = "S"
	 				PrmObjetivo = "CANCELAMENTO"

				CASE LSscr_ECF = "S"
	 				PrmObjetivo = "ESCRITURACAO"

				OTHERWISE
					PrmObjetivo = "NAO INTEGRAR"
			ENDCASE

		CASE  RtnMOD_DOC    $   "03/77"  && NF SERVICO
				DO CASE
					CASE LSemi_NFS = "S" OR LSemi_NFSe = "S" 				
		 				PrmObjetivo = "CANCELAMENTO"

					CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE

		CASE  RtnMOD_DOC    $   "01/55"  && NF/NFe
				DO CASE
					CASE LSemi_NF = "S" OR LSemi_NFe = "S" 				
		 				PrmObjetivo = "CANCELAMENTO"

					CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE

		OTHERWISE			
				PrmObjetivo = "NAO INTEGRAR"

		ENDCASE
RETURN(PrmObjetivo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HIX           NFDefEnvDFis VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   75    º
*       º Variable:            NFDefEnvDFis                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      197                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hix     &&  NFDefEnvDFis VALID
#REGION 5
return
*---------------------------------------------------------------*

********************
FUNCTION NFDefEnvDFis
PARAMETERS PrmEmpresa,PrmNota


	*-->>>>>>>>>>>>>     PARA ENVIO NFE
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= ""
	PrmTipo    		= ""
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*



	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	*----------------------------------------------------*

	*-----------------------------------------------------------*
	PRIVATE LSemi_NF,LSemi_NFe,LSemi_NFS,LSemi_NFSe,LSemi_ECF
	PRIVATE LSscr_NF,LSscr_NFe,LSscr_NFS,LSscr_NFSe,LSscr_ECF

	*------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NF = EMGetFieldValue(PrmEmpresa,"EMITE_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFe = EMGetFieldValue(PrmEmpresa,"EMITE_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFS = EMGetFieldValue(PrmEmpresa,"EMITE_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFSe = EMGetFieldValue(PrmEmpresa,"EMITE_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_ecf = EMGetFieldValue(PrmEmpresa,"EMITE_ECF")

	*------------------------------------------------------------*

	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NF = EMGetFieldValue(PrmEmpresa,"ESCRT_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFS = EMGetFieldValue(PrmEmpresa,"ESCRT_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFSe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ecf = EMGetFieldValue(PrmEmpresa,"ESCRT_ECF")


	*------------------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "NAO INTEGRAR"



	DO CASE
	
		CASE  RtnMOD_DOC    =   "2D"  && CUPOM

			DO CASE
				CASE LSscr_ECF = "S"
	 				PrmObjetivo = "EMISSAO"

				OTHERWISE
					PrmObjetivo = "NAO INTEGRAR"
			ENDCASE

		CASE  RtnMOD_DOC    $   "03/77"  && NF SERVICO
			DO CASE
				CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
	 				PrmObjetivo = "EMISSAO"

				OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
			ENDCASE

		CASE  RtnMOD_DOC    $   "01/55"  && NF/NFe
			DO CASE
				CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
	 				PrmObjetivo = "EMISSAO"

				OTHERWISE
					PrmObjetivo = "NAO INTEGRAR"
			ENDCASE

		OTHERWISE			
				PrmObjetivo = "NAO INTEGRAR"

		ENDCASE





RETURN(PrmObjetivo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HJS           NFReenvNFe VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   76    º
*       º Variable:            NFReenvNFe                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      198                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123hjs     &&  NFReenvNFe VALID
#REGION 5
RETURN

FUNCTION NFReenvNFe
PARAMETERS PrmNFFiltro

* PrmNFFiltro => EX:" and (nota < 1000000 or nota > 3000000)"

	=W_DEFPROC("NOTA.SPR")
	LNregistro = NFView(PrmNFFiltro)

	IF LNregistro > 0
	   sele nota
	   go lnregistro


		*----------------------------------------------------------------*
		DO CASE
			CASE Nota.Nota > 2000000 AND  Nota.Nota < 3000000
				LsOrientacao = "SERVICO"

			CASE Nota.Nota > 4000000 AND  Nota.Nota < 5000000
				LsOrientacao = "SERVICO"

			CASE  Nota.totservico > 0 AND Nota.totproduto > 0
				LsOrientacao = "PRODUTO/SERVICO"

			CASE  Nota.totservico > 0
				LsOrientacao = "SERVICO"

			CASE   Nota.totproduto > 0
				LsOrientacao = "PRODUTO"
			OTHERWISE
				LsOrientacao = "PRODUTO/SERVICO"

			
		ENDCASE



		*----------------------------------------------------------------*
		PRIVATE LSobjetivo
		LSobjetivo = NFDefEnvDFis(nota.empresa,nota.nota)

		IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"
			IF !(NF_GeraDFis(nota.empresa,nota.nota,LSobjetivo,;
			      LsOrientacao ))
			   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				"  O Emissor de Documentos Fiscais nao acatou o Emissao."+;
			     " Repita o processo e se persistir a negacao entre "+;
			     " em contato com suporte"
			ENDIF
		ENDIF			


	ENDIF
	=W_DEFPROC("rotinas.SPR")
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HJY           NEGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    2   º
*       º Variable:            NEGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      199                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hjy     &&  NEGetFieldValue VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NEGetFieldValue
PARAMETERS PrmEmp,PrmBoletim,PrmForn,PrmField

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HK1           NEGetUFOrigem VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    3   º
*       º Variable:            NEGetUFOrigem                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      200                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hk1     &&  NEGetUFOrigem VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NEGetUFOrigem
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT("UF"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HK3           NEGetUFDestino VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    4   º
*       º Variable:            NEGetUFDestino                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      201                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hk3     &&  NEGetUFDestino VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NEGetUFDestino
PARAMETERS PrmEmp,PrmBoletim,PrmForn
	PRIVATE Lvalue


	=W_DEFPROC("empresa.spr")
	Lvalue = EMGet_UF(PrmEmp)

RETURN(Lvalue)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HK7           NEGetRetidoDestacado VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    5   º
*       º Variable:            NEGetRetidoDestacado               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      202                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hk7     &&  NEGetRetidoDestacado VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NEGetRetidoDestacado
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT("ICMS_SUBS"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HK9           NEVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    6   º
*       º Variable:            NEVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      203                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hk9     &&  NEVerifyInst VALID
#REGION 6
return
*---------------------------------------------------------------*



FUNCTION NEVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("NOTAENT")


	DO CASE

		CASE TYPE("PBNotaEntAlias") = "U" ;
		   		OR EMPTY(PBNotaEntAlias) ;
		   		OR !USED(PBNotaEntAlias)
			=NECreate()					

		CASE !("NOTAENT.DBF" $ DBF(PBNotaEntAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBNotaEntAlias
			=NECreate()					


		CASE  !(LSPath $ DBF(PBNotaEntAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=NEDestroi()				
			=NECreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HKD           NECreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    7   º
*       º Variable:            NECreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      204                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hkd     &&  NECreate VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NECreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBNotaEntAlias") <> "U" ;
	   		AND !EMPTY(PBNotaEntAlias) ;
	   		AND USED(PBNotaEntAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBNotaEntAlias

	IF USED("NotaEnt")
	     =NetArqAgain("NotaEnt")
	     PBNotaEntAlias     = Alias()
	ELSE
	     =NetArqAgain("NotaEnt")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("NotaEnt")
	     PBNotaEntAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBNotaEntAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTNotaEnt[LMaxDim]
    PUBLIC DIMENSION VDNotaEnt[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFNotaEnt[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFNotaEnt)



	*-----------------------------------------------------------*
	=NEReadProperty()
	=NESetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HKE           NEDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    8   º
*       º Variable:            NEDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      205                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hke     &&  NEDestroi VALID
#REGION 6
return
*---------------------------------------------------------------*


FUNCTION NEDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBNotaEntAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBNotaEntAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBNotaEntAlias
	*  3- Se aplicar um FECHAMENTO a PBNotaEntAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBNotaEntAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBNotaEntAlias)) OR ;
	   !("NOTAENT.DBF" $ DBF(PBNotaEntAlias))

		RELEASE PBNotaEntAlias
    	RELEASE VTNotaEnt
	    RELEASE VDNotaEnt
		RELEASE VFNotaEnt
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBNotaEntAlias) AND USED(PBNotaEntAlias)
		SELECT &PBNotaEntAlias
		USE
	ENDIF	
	RELEASE PBNotaEntAlias
    RELEASE VTNotaEnt
    RELEASE VDNotaEnt
	RELEASE VFNotaEnt

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HKF           NEReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    9   º
*       º Variable:            NEReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      206                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hkf     &&  NEReadProp VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NEReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBNotaEntAlias
	SCATTER TO VTNotaEnt
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HKG           NESetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   10   º
*       º Variable:            NESetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      207                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hkg     &&  NESetDerivadas VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NESetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDNotaEnt(1,1) = "UF DESTINO"
   	VDNotaEnt(1,2) = 0
   	VDNotaEnt(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HKH           NESetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   11   º
*       º Variable:            NESetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      208                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hkh     &&  NESetPropVT VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NESetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBNotaEntAlias,;
						    VTNotaEnt,;
						    VDNotaEnt,;
						    VFNotaEnt)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HKI           NEGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   12   º
*       º Variable:            NEGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      209                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hki     &&  NEGetPropVT VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NEGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBNotaEntAlias,;
	            VTNotaEnt,;
	            VDNotaEnt,;
	            VFNotaEnt)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HL9           NEChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   13   º
*       º Variable:            NEChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      210                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hl9     &&  NEChk_Identidade VALID
#REGION 6
return
*---------------------------------------------------------------*


FUNCTION NEChk_Identidade
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	PRIVATE LFretorno
	LFretorno = .t.

	=NEVerifyInst()

    =NESetPropVT("EMPRESA",PrmEmp)
    =NESetPropVT("REFERENCIA",PrmBoletim)
    =NESetPropVT("CODFORN",PrmForn)

	LFretorno=NEFind()
RETURN(LFretorno)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HLC           NEFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   14   º
*       º Variable:            NEFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      211                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hlc     &&  NEFind VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NEFind

	PRIVATE LEmpresa, LReferencia, LCodForn
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NEVerifyInst()


	LEmpresa    = NEGetPropVT("Empresa")
	LReferencia = NEGetPropVT("Referencia")
	LCodForn    = NEGetPropVT("CodForn")


	SELE &PBNotaentAlias
	SET ORDER TO TAG BOLETIM
	SEEK STR(LEmpresa,3)+STR(LReferencia,6)+STR(LCodForn,5)
	IF FOUND()
		=NEReadProperty()
		=NESetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HLG           NEGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   15   º
*       º Variable:            NEGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      212                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hlg     &&  NEGetFieldValue VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NEGetFieldValue
PARAMETERS PrmEmp,PrmBoletim,PrmForn,PrmField

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT(PrmField))



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HLK           NE_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   16   º
*       º Variable:            NE_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      213                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hlk     &&  NE_Refresh VALID
#REGION 6
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
FUNCTION NE_Refresh
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	PRIVATE LFreturn
	
	=NEVerifyInst()
	*----------------------------------------------------------------*
	
    =NESetPropVT("EMPRESA",PrmEmp)
    =NESetPropVT("REFERENCIA",PrmBoletim)
    =NESetPropVT("CODFORN",PrmForn)
	=NEFind()
	
RETURN(.t.)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HLR           NELerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   18   º
*       º Variable:            NELerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      214                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hlr     &&  NELerRegistro VALID
#REGION 6
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NELerRegistro
PARAMETERS PrmEmp,PrmBoletim,PrmForn



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HLW           NEWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   19   º
*       º Variable:            NEWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      215                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hlw     &&  NEWriteProp VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NEWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBNotaEntAlias
	=RLOCK()
	GATHER FROM  VTNotaEnt
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HLX           NESalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   20   º
*       º Variable:            NESalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      216                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hlx     &&  NESalvarRegistro VALID
#REGION 6
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NESalvarRegistro

	=NEVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !NEExiste()
		SELE &PBNotaEntAlias
		APPEND BLANK
		LFretorno=NEWriteProp()
	ELSE
		SELE &PBNotaEntAlias
		LFretorno=NEWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HLY           NEExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   21   º
*       º Variable:            NEExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      217                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hly     &&  NEExiste VALID
#REGION 6
return
*---------------------------------------------------------------*
FUNCTION NEExiste

	PRIVATE LEmpresa, LReferencia, LCodForn
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NEVerifyInst()


	LEmpresa    = NEGetPropVT("Empresa")
	LReferencia = NEGetPropVT("Referencia")
	LCodForn    = NEGetPropVT("CodForn")


	SELE &PBNotaentAlias
	SET ORDER TO TAG BOLETIM
	SEEK STR(LEmpresa,3)+STR(LReferencia,6)+STR(LCodForn,5)
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HLZ           NEGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   23   º
*       º Variable:            NEGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      218                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hlz     &&  NEGetAlias VALID
#REGION 6
return
*---------------------------------------------------------------*

FUNCTION NEGetAlias

	=NEVerifyInst()

RETURN(PBNotaEntAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HM0           FRGet_UF VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    2  º
*       º Variable:            FRGet_UF                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      219                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hm0     &&  FRGet_UF VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRGet_UF
PARAMETERS Prmfornece
	=FRChk_Identidade(Prmfornece)
RETURN(FRGetPropVT("ESTADO"))




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HM1           FRrgm_Fisc VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    3  º
*       º Variable:            FRrgm_Fisc                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      220                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hm1     &&  FRrgm_Fisc VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRrgm_Fisc
PARAMETERS Prmfornece

	=FRChk_Identidade(Prmfornece)

RETURN(FRGetPropVT("RGMEFISCAL"))
	



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HMS           FRVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    4  º
*       º Variable:            FRVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      221                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hms     &&  FRVerifyInst VALID
#REGION 7
return
*---------------------------------------------------------------*



FUNCTION FRVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Fornece")


	DO CASE

		CASE TYPE("PBForneceAlias") = "U" ;
		   		OR EMPTY(PBForneceAlias) ;
		   		OR !USED(PBForneceAlias)
			=FRCreate()					

		CASE !("FORNECE.DBF" $ DBF(PBForneceAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBForneceAlias
			=FRCreate()					


		CASE  !(LSPath $ DBF(PBForneceAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=FRDestroi()				
			=FRCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HMY           FRCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    5  º
*       º Variable:            FRCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      222                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hmy     &&  FRCreate VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBForneceAlias") <> "U" ;
	   		AND !EMPTY(PBForneceAlias) ;
	   		AND USED(PBForneceAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBForneceAlias

	IF USED("Fornece")
	     =NetArqAgain("Fornece")
	     PBForneceAlias     = Alias()
	ELSE
	     =NetArqAgain("Fornece")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Fornece")
	     PBForneceAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBForneceAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTFornece[LMaxDim]
    PUBLIC DIMENSION VDFornece[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFFornece[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFFornece)



	*-----------------------------------------------------------*
	=FRReadProperty()
	=FRSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HN6           FRDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    6  º
*       º Variable:            FRDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      223                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hn6     &&  FRDestroi VALID
#REGION 7
return
*---------------------------------------------------------------*


FUNCTION FRDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBForneceAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBForneceAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBForneceAlias
	*  3- Se aplicar um FECHAMENTO a PBForneceAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBForneceAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBForneceAlias)) OR ;
	   !("FORNECE.DBF" $ DBF(PBForneceAlias))

		RELEASE PBForneceAlias
    	RELEASE VTFornece
	    RELEASE VDFornece
		RELEASE VFFornece
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBForneceAlias) AND USED(PBForneceAlias)
		SELECT &PBForneceAlias
		USE
	ENDIF	
	RELEASE PBForneceAlias
    RELEASE VTFornece
    RELEASE VDFornece
	RELEASE VFFornece

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HNB           FRReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    7  º
*       º Variable:            FRReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      224                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hnb     &&  FRReadProp VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBForneceAlias
	SCATTER TO VTFornece
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HNF           FRSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    8  º
*       º Variable:            FRSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      225                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hnf     &&  FRSetDerivadas VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDFornece(1,1) = "NAOINFORMADO"
   	VDFornece(1,2) = 0
   	VDFornece(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HNG           FRSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    9  º
*       º Variable:            FRSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      226                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hng     &&  FRSetPropVT VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBForneceAlias,;
						    VTFornece,;
						    VDFornece,;
						    VFFornece)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HNH           FRGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   10  º
*       º Variable:            FRGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      227                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hnh     &&  FRGetPropVT VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBForneceAlias,;
	            VTFornece,;
	            VDFornece,;
	            VFFornece)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HNI           FRChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   11  º
*       º Variable:            FRChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      228                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hni     &&  FRChk_Identidade VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRChk_Identidade
PARAMETERS Prmfornece

	PRIVATE LFretorno
	LFretorno = .t.

	=FRVerifyInst()
	=FRSetPropVT("CODIGO",Prmfornece)

	LFretorno=FRFind()
RETURN(LFretorno)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HNJ           FRFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   12  º
*       º Variable:            FRFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      229                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hnj     &&  FRFind VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRFind

	PRIVATE Lcodigo
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=FRVerifyInst()

	Lcodigo   = FRGetPropVT("CODIGO")

	SELE &PBForneceAlias
	SET ORDER TO TAG CODIGO
	SEEK Lcodigo

	IF FOUND()
		=FRReadProperty()
		=FRSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HNK           FRGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   13  º
*       º Variable:            FRGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      230                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hnk     &&  FRGetFieldValue VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRGetFieldValue
PARAMETERS Prmfornece,PrmField

	=FRChk_Identidade(Prmfornece)

RETURN(FRGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HNL           FR_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   14  º
*       º Variable:            FR_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      231                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hnl     &&  FR_Refresh VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FR_Refresh
PARAMETERS Prmfornece
			
	
	


	PRIVATE LFretorno


	=FRVerifyInst()
	=FRSetPropVT("CODIGO",Prmfornece)

	LFretorno=FRFind()
RETURN(LFretorno)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HNM           FRLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   16  º
*       º Variable:            FRLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      232                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hnm     &&  FRLerRegistro VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRLerRegistro
PARAMETERS Prmfornece



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = FRChk_Identidade(Prmfornece)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HNN           FRWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   17  º
*       º Variable:            FRWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      233                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hnn     &&  FRWriteProp VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBForneceAlias
	=RLOCK()
	GATHER FROM  VTFornece
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HO9           FRSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   18  º
*       º Variable:            FRSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      234                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123ho9     &&  FRSalvarRegistro VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRSalvarRegistro

	=FRVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !FRExiste()
		SELE &PBForneceAlias
		APPEND BLANK
		LFretorno=FRWriteProp()
	ELSE
		SELE &PBForneceAlias
		LFretorno=FRWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HOD           FRExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   19  º
*       º Variable:            FRExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      235                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hod     &&  FRExiste VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRExiste

	PRIVATE Lcodigo

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=FRVerifyInst()

	Lcodigo   = FRGetPropVT("CODIGO")

	SELE &PBForneceAlias
	SET ORDER TO TAG CODIGO
	SEEK Lcodigo

	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HOG           FRGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   21  º
*       º Variable:            FRGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      236                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hog     &&  FRGetAlias VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRGetAlias

	=FRVerifyInst()

RETURN(PBForneceAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HOK           EMGet_UF VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    2   º
*       º Variable:            EMGet_UF                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      237                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hok     &&  EMGet_UF VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_UF
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("ESTADO"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HOM           EMGet_Juro VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    3   º
*       º Variable:            EMGet_Juro                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      238                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hom     &&  EMGet_Juro VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Juro
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("JUROMES"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HOQ           verif VALID                        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    4   º
*       º Variable:            verif                              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      239                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hoq     &&  verif VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION UVerifEmp
PARAMETERS LNemp,LSnome,LNkey
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFempresa
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	LFempresa		= NetArq("empresa")
	IF (LFempresa) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("empresa" ,LFempresa)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	SELECT empresa
	SET ORDER TO TAG empresa
	IF LNkey = 9
	   ON KEY LABEL ESCAPE
	   DO loc_dlog WITH .F.
	   ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	   LNemp	  = empresa.empresa
	ENDIF

	SET NEAR ON
	SEEK LNemp
   	IF LASTKEY() = 27 OR !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LFretorno = .F.
	ELSE
		LSnome  = empresa.sigla
		LFretorno = .T.
	ENDIF
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	=UP_fecha("empresa" ,LFempresa)
RETURN(LFretorno)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HOU           EMrodanroNF VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    5   º
*       º Variable:            EMrodanroNF                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      240                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hou     &&  EMrodanroNF VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMrodanroNF
PARAMETERS LNemp,LStp_process
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Incrementar Numeracao de Nota/Cupom
	*	
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LStp_process...: Processo definido em NFDefProcess
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	=REGLOCK(.T.)
	DO CASE
		CASE LStp_proces = "NOTA" OR LStp_proces = "NOTA/CUPOM"
			REPLACE empresa.nota WITH empresa.nota + 1 && ULTIMA NOTA GERADA
			REPLACE FLAGIMPNF 	WITH 1
		CASE LStp_proces = "CUPOM"
			REPLACE empresa.ult_cupom  WITH ult_cupom + 1
			REPLACE FLAGIMPCPM 	WITH 1
		CASE LStp_proces = "NF.SERVICO"
			REPLACE empresa.Ult_NFsrvc WITH empresa.Ult_NFsrvc + 1
			REPLACE FLAGIMPSRV 	WITH 1

	ENDCASE
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HOY           EMGet_Mora VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    6   º
*       º Variable:            EMGet_Mora                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      241                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hoy     &&  EMGet_Mora VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Mora
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("MORA"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HP1           EMGet_Sigla VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    7   º
*       º Variable:            EMGet_Sigla                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      242                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hp1     &&  EMGet_Sigla VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Sigla
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("SIGLA"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HP2           EMGet_ECFSerie VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    8   º
*       º Variable:            EMGet_ECFSerie                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      243                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hp2     &&  EMGet_ECFSerie VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_ECFSerie
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("ECF_SERIE"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HP3           EMGet_Municipio VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    9   º
*       º Variable:            EMGet_Municipio                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      244                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hp3     &&  EMGet_Municipio VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Municipio
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("CIDADE"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HP4           EMGet_TabCst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   10   º
*       º Variable:            EMGet_TabCst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      245                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hp4     &&  EMGet_TabCst VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_TabCst
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("TAB_CST"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HP5           EMLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   11   º
*       º Variable:            EMLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      246                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hp5     &&  EMLerRegistro VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMLerRegistro
PARAMETERS  PrmEmp



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = EMChk_Identidade(PrmEmp)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HP6           EMSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   12   º
*       º Variable:            EMSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      247                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hp6     &&  EMSalvarRegistro VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMSalvarRegistro

	=EMVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !EMExiste()
		SELE &PBEmpresaAlias
		APPEND BLANK
		LFretorno=EMWriteProp()
	ELSE
		SELE &PBEmpresaAlias
		LFretorno=EMWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HP7           EMExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   13   º
*       º Variable:            EMExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      248                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hp7     &&  EMExiste VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMExiste
	PRIVATE LEmpresa

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=EMVerifyInst()

	LEmpresa    = EMGetPropVT("Empresa")


	SELE &PBEmpresaAlias
	SET ORDER TO TAG empresa
	SEEK Lempresa

	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HP8           EMVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   14   º
*       º Variable:            EMVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      249                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hp8     &&  EMVerifyInst VALID
#REGION 8
return
*---------------------------------------------------------------*



FUNCTION EMVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Empresa")


	DO CASE

		CASE TYPE("PBEmpresalias") = "U" ;
		   		OR EMPTY(PBEmpresaAlias) ;
		   		OR !USED(PBEmpresaAlias)
			=EMCreate()					

		CASE !("EMPRESA.DBF" $ DBF(PBEmpresaAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBEmpresaAlias
			=EMCreate()					


		CASE  !(LSPath $ DBF(PBEmpresaAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=EMDestroi()				
			=EMCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HP9           EMCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   15   º
*       º Variable:            EMCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      250                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hp9     &&  EMCreate VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBEmpresaAlias") <> "U" ;
	   		AND !EMPTY(PBEmpresaAlias) ;
	   		AND USED(PBEmpresaAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBEmpresaAlias

	IF USED("Empresa")
	     =NetArqAgain("Empresa")
	     PBEmpresaAlias     = Alias()
	ELSE
	     =NetArqAgain("Empresa")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Empresa")
	     PBEmpresaAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBEmpresaAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTEmpresa[LMaxDim]
    PUBLIC DIMENSION VDEmpresa[2,3]			&& VETOR PARA PROPRIEDADES
	*-----------------------------------------------------------*
	=EMReadProperty()
	=EMSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HPV           EMDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   16   º
*       º Variable:            EMDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      251                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hpv     &&  EMDestroi VALID
#REGION 8
return
*---------------------------------------------------------------*


FUNCTION EMDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBEmpresaAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBDocFiscaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBDocFiscaAlias
	*  3- Se aplicar um FECHAMENTO a PBDocFiscaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBDocFiscaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBEmpresaAlias)) OR ;
	   !("EMPRESA.DBF" $ DBF(PBEmpresaAlias))

		RELEASE PBEmpresaAlias
    	RELEASE VTEmpresa
	    RELEASE VDEmpresa
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBEmpresaAlias) AND USED(PBEmpresaAlias)
		SELECT &PBEmpresaAlias
		USE
	ENDIF	
	RELEASE PBEmpresaAlias
    RELEASE VTEmpresa
    RELEASE VDEmpresa

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQ0           EMReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   17   º
*       º Variable:            EMReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      252                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hq0     &&  EMReadProp VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=EMVerifyInst()

	SELE &PBEmpresaAlias
	SCATTER TO VTEmpresa
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQ3           EMSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   18   º
*       º Variable:            EMSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      253                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hq3     &&  EMSetDerivadas VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

**	=EMVerifyInst()
	*--------------------------------------------------------------*
    VDEmpresa(1,1) = "NAOINFORMADO"
   	VDEmpresa(1,2) = 0
   	VDEmpresa(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQ6           EMSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   19   º
*       º Variable:            EMSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      254                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hq6     &&  EMSetPropVT VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

**	=EMVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,PrmValue,;
						    PBEmpresaAlias,VTEmpresa,VDEmpresa)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQ9           EMGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   20   º
*       º Variable:            EMGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      255                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hq9     &&  EMGetPropVT VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

**	=DFVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,PBEmpresaAlias,VTEmpresa,VDEmpresa)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQC           EMChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   21   º
*       º Variable:            EMChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      256                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hqc     &&  EMChk_Identidade VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMChk_Identidade
PARAMETERS  PrmEmp


	PRIVATE LFretorno
	LFretorno = .t.



	=EMVerifyInst()

    =EMSetPropVT("EMPRESA",PrmEmp)
	LFretorno=EMFind()

RETURN(LFretorno)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQF           EMFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   22   º
*       º Variable:            EMFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      257                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hqf     &&  EMFind VALID
#REGION 8
return
*---------------------------------------------------------------*
FUNCTION EMFind

	PRIVATE Lcodigo
	PRIVATE LFreturn

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=EMVerifyInst()

	Lcodigo   = EMGetPropVT("EMPRESA")

	SELE &PBEmpresaAlias
	SET ORDER TO TAG empresa
	SEEK Lcodigo

	IF FOUND()
		=EMReadProperty()
		=EMSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQJ           EMGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   23   º
*       º Variable:            EMGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      258                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hqj     &&  EMGetFieldValue VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMGetFieldValue
PARAMETERS  PrmEmp,PrmField			


	IF !EMChk_Identidade(PrmEmp)
		DO WHILE .T.
			=UPerrosys("Chamada GetFieldValue para Reg. Inexistente!")
		ENDDO
	ENDIF				

RETURN(EMGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQK           EM_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   24   º
*       º Variable:            EM_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      259                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hqk     &&  EM_Refresh VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EM_Refresh
PARAMETERS  PrmEmpresa
	

	PRIVATE LFreturn

	=EMVerifyInst()


	= EMSetPropVT("Empresa"   ,PrmEmpresa)

	*----------------------------------------------------------------*


	=EMFind()
	
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQL           EMWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   26   º
*       º Variable:            EMWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      260                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hql     &&  EMWriteProp VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=EMVerifyInst()

	SELE &PBEmpresaAlias
	=RLOCK()
	GATHER FROM  VTEmpresa
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQM           EMGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   28   º
*       º Variable:            EMGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      261                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hqm     &&  EMGetAlias VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMGetAlias

	=EMVerifyInst()

RETURN(PBEmpresaAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQN           EMMarcaFlgNF VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   30   º
*       º Variable:            EMMarcaFlgNF                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      262                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hqn     &&  EMMarcaFlgNF VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMMarcaFlgNF
PARAMETERS LNemp,PrmNivelProcesso
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Incrementar Flag Nota/Cupom
	*	
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	=REGLOCK(.T.)

	REPLACE FLAGIMPNF 	WITH PrmNivelProcesso

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQO           CPVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:    3     º
*       º Variable:            CPVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      263                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hqo     &&  CPVerifyInst VALID
#REGION 9
return
*---------------------------------------------------------------*



FUNCTION CPVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Nota")


	DO CASE

		CASE TYPE("PBCupomAlias") = "U" ;
		   		OR EMPTY(PBCupomAlias) ;
		   		OR !USED(PBCupomAlias)
			=CPCreate()					

		CASE !("NOTA.DBF" $ DBF(PBCupomAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBCupomAlias
			=CPCreate()					


		CASE  !(LSPath $ DBF(PBCupomAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=CPDestroi()				
			=CPCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQP           CPCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:    4     º
*       º Variable:            CPCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      264                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hqp     &&  CPCreate VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CPCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBCupomAlias") <> "U" ;
	   		AND !EMPTY(PBCupomAlias) ;
	   		AND USED(PBCupomAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBCupomAlias

	IF USED("Nota")
	     =NetArqAgain("Nota")
	     PBCupomAlias     = Alias()
	ELSE
	     =NetArqAgain("Nota")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Nota")
	     PBCupomAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBCupomAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTCupom[LMaxDim]
    PUBLIC DIMENSION VDCupom[2,3]			&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFCupom[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFCupom)
	*-----------------------------------------------------------*
	=CPReadProperty()
	=CPSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HQQ           CPDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:    5     º
*       º Variable:            CPDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      265                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hqq     &&  CPDestroi VALID
#REGION 9
return
*---------------------------------------------------------------*


FUNCTION CPDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBCupomAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBCupomAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBCupomAlias
	*  3- Se aplicar um FECHAMENTO a PBCupomAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBCupomAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBCupomAlias)) OR ;
	   !("NOTA.DBF" $ DBF(PBCupomAlias))

		RELEASE PBCupomAlias
    	RELEASE VTCupom
	    RELEASE VDCupom
	    RELEASE VFCupom
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBCupomAlias) AND USED(PBCupomAlias)
		SELECT &PBCupomAlias
		USE
	ENDIF	
	RELEASE PBCupomAlias
    RELEASE VTCupom
    RELEASE VDCupom
    RELEASE VFCupom

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HRD           CPReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:    6     º
*       º Variable:            CPReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      266                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hrd     &&  CPReadProp VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CPReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBCupomAlias
	SCATTER TO VTCupom
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HRG           CPSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:    7     º
*       º Variable:            CPSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      267                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hrg     &&  CPSetDerivadas VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CPSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDCupom(1,1) = "NAOINFORMADO"
   	VDCupom(1,2) = 0
   	VDCupom(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HRJ           CPSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:    8     º
*       º Variable:            CPSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      268                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hrj     &&  CPSetPropVT VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CPSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,PrmValue,;
						    PBCupomAlias,VTCupom,VDCupom,VFCupom)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HRM           CPGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:    9     º
*       º Variable:            CPGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      269                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hrm     &&  CPGetPropVT VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CPGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
					PBCupomAlias,;
					VTCupom,;
					VDCupom,;
					VFCupom)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HRQ           CPChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:   10     º
*       º Variable:            CPChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      270                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hrq     &&  CPChk_Identidade VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CPChk_Identidade
PARAMETERS  ;
			PrmEmp,;
			PrmNota


	PRIVATE LFretorno
	LFretorno = .t.



	=CPVerifyInst()
    =CPSetPropVT("EMPRESA",PrmEmp)
    =CPSetPropVT("NOTA",PrmNota)


	LFretorno=CPFind()
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HRT           CPFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:   11     º
*       º Variable:            CPFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      271                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hrt     &&  CPFind VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CPFind

	PRIVATE LEmpresa,;
			LNota
			
	
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=CPVerifyInst()


	LEmpresa    = CPGetPropVT("Empresa")
	LNota       = CPGetPropVT("Nota")


	SELE &PBCupomAlias
	SET ORDER TO TAG NOTA
	SEEK STR(Lempresa,3)+STR(LNota,7)
	
	IF FOUND()
		=CPReadProperty()
		=CPSetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HRX           CPGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:   12     º
*       º Variable:            CPGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      272                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hrx     &&  CPGetFieldValue VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CPGetFieldValue
PARAMETERS  PrmEmp,;
			PrmNota,;
			PrmField			

	=CPChk_Identidade(PrmEmp,;
					  PrmNota)

RETURN(CPGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HS0           CP_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:   13     º
*       º Variable:            CP_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      273                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hs0     &&  CP_Refresh VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CP_Refresh
PARAMETERS  PrmEmpresa,;
			PrmNota
			
	
	


	PRIVATE LFreturn

	=CPVerifyInst()


	= CPSetPropVT("Empresa" ,PrmEmpresa)
	= CPSetPropVT("Nota"    ,PrmNota)

	*----------------------------------------------------------------*


	=CPFind()
	
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HS1           CPWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:   14     º
*       º Variable:            CPWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      274                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hs1     &&  CPWriteProp VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CPWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBCupomAlias
	GATHER FROM  VTCupom
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HS2           CPLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:   16     º
*       º Variable:            CPLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      275                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hs2     &&  CPLerRegistro VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CPLerRegistro
PARAMETERS  PrmEmp,;
			PrmNota

	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = CPChk_Identidade(PrmEmp,;
			PrmNota)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HS3           CPSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:   17     º
*       º Variable:            CPSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      276                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hs3     &&  CPSalvarRegistro VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CPSalvarRegistro

	=CPVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !CPExiste()
		SELE &PBCupomAlias
		APPEND BLANK
		LFretorno=CPWriteProp()
	ELSE
		SELE &PBCupomAlias
		LFretorno=CPWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HS4           CPExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:   18     º
*       º Variable:            CPExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      277                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hs4     &&  CPExiste VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CPExiste

	PRIVATE LEmpresa,;
			LNota
			

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=CPVerifyInst()

	LEmpresa    = CPGetPropVT("Empresa")
	LNota	    = CPGetPropVT("NOTA")


	SELE &PBNotaAlias
	SET ORDER TO TAG NOTA
	SEEK STR(Lempresa,3)+STR(LNota,7)
	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HS5           CPGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         CUPOM,     Record Number:   20     º
*       º Variable:            CPGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      278                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hs5     &&  CPGetAlias VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CPGetAlias

	=CPVerifyInst()

RETURN(PBCupomAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HS6           TRGet_IPIProd VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    4  º
*       º Variable:            TRGet_IPIProd                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      279                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hs6     &&  TRGet_IPIProd VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IPIProd
PARAMETERS PrmProduto

    PRIVATE LNipialq

	=W_DEFPROC("GRUPO.SPR")
	LNipialq =GRGetFieldValue(PrmProduto,"ALIQ_IPI")

RETURN(LNipialq)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HS7           TRGet_ISSAlq VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    5  º
*       º Variable:            TRGet_ISSAlq                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      280                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hs7     &&  TRGet_ISSAlq VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_ISSAlq
PARAMETERS PrmEmpresa


    PRIVATE LNaliq_iss

	=W_DEFPROC("EMPRESA.SPR")
	LNaliq_iss =EMGetFieldValue(PrmEmpresa,"ALIQ_ISS")

RETURN(LNaliq_iss)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HS8           TRdefcst VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    6  º
*       º Variable:            TRdefcst                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      281                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _2wz123hs8     &&  TRdefcst VALID
#REGION 10
RETURN

FUNCTION TRdefcst
	PARAMETERS Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto

	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_tab_cst,ALS_tab_cst
	LSalias = ALIAS()

    ARQ_Tab_Cst     = NetArqAgain("TAB_CST")
    ALS_Tab_Cst     = Alias()

	IF ( ARQ_Tab_Cst) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALS_Tab_cst")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = " "
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*


	LScst = " "
	SELECT &Als_tab_cst
	SET ORDER TO TAG cst
	SEEK STR(Prmtab_cst,2)+PrmTipo+STR(Prmtp_mercad,1)
	IF !FOUND()
		IF tipooper.ch_opera = "3"
			LScst =  "4"
		ENDIF
	ELSE
		LScst =  RIGHT( &Als_tab_cst .cst,1)
	ENDIF

	*------------------------------------------------------------*
    =up_fecha("&ALS_Tab_cst")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HSV           TRAlqIcmInUF VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    7  º
*       º Variable:            TRAlqIcmInUF                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      282                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hsv     &&  TRAlqIcmInUF VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRAlqIcmInUF
PARAMETERS PrmUF

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    LSAlias      = Alias()
    LNaliq_icms = 0
	*--------------------------------------------------------*
	DO CASE
		CASE PrmUF $ "MG/RJ/SP"
		    LNaliq_icms = 18
		OTHERWISE
		    LNaliq_icms = 17
	ENDCASE
	*--------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HSZ           TRAlqIcmOuUF VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    8  º
*       º Variable:            TRAlqIcmOuUF                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      283                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hsz     &&  TRAlqIcmOuUF VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRAlqIcmOuUF
PARAMETERS PrmUF

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    LSAlias      = Alias()
    LNaliq_icms = 0
	*--------------------------------------------------------*
	DO CASE
		CASE PrmUF $ "MG/RJ/SP/PR"
		    LNaliq_icms = 7
		OTHERWISE
		    LNaliq_icms = 12
	ENDCASE
	*--------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HT4           TRCFO VALID                        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    9  º
*       º Variable:            TRCFO                              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      284                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123ht4     &&  TRCFO VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRCFO
PARAMETERS PrmEmpresa, PrmTipo, PrmTp_mercad,PrmOperacao

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*

	*------------------------------------------------------------*

    PRIVATE LScfo
    PRIVATE LSalias
    PRIVATE PrmTp_mercad

    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()


	STORE 0 TO ARQ_Tipooper
	*--------------------------------------------------------
	IF TYPE("TRtipooperALIAS") = "U" OR !USED(TRtipooperALIAS)
		PUBLIC TRtipooperALIAS
	    ARQ_Tipooper     = NetArqAgain("TIPOOPER")
	    TRtipooperALIAS  = Alias()
	ENDIF
    ALS_Tipooper     = TRtipooperALIAS


    LScfo = SPACE(5)
	*--------------------------------------------------------*

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	IF UPPER(PrmOperacao) = "SAIDA"
		SEEK 'S'+ PrmTipo
		IF !FOUND()
			SEEK 's'+  PrmTipo
		ENDIF
	ELSE
		SEEK 'E'+ PrmTipo
		IF !FOUND()
			SEEK 'e'+  PrmTipo
		ENDIF
	ENDIF

	*--------------------------------------------------------*

	IF !FOUND()
   		*=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF

		IF  PrmTipo = "CPM"
		   LScfo = "5.929"
		ENDIF
		
        RETURN(LScfo)
	ENDIF


	*------------------------------------------------------*

	DO CASE


		CASE  PrmTipo = "CPM"
		   LScfo = "5.929"


		CASE PrmTp_mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs


		CASE     PrmTp_mercad = 7 ;
		  	 AND UPPER(PrmOperacao) = "SAIDA" ;
			 AND &Als_tipooper .ch_opera = "1"  && Venda/Compra SERVICO


		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO

		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE

	LScfo = LEFT(ALLTRIM(LScfo)+"   ",5)

	*------------------------------------------------------------*
	*=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LScfo)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HTA           ANTTRpct_trib VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   10  º
*       º Variable:            ANTTRpct_trib                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      285                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123hta     &&  ANTTRpct_trib VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ANTTRpct_trib
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto, ;
    LNiva, LNipialq, LNtp_mercad, LScst, ;
    LNaliq_iss, LNaliq_rdu, LNaliq_icms, LScfo


	=W_DEFPROC("rotinas.spr")


 	 PRIVATE LNtab_cst

    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_GrFiscal,ALS_GrFiscal
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper
	PRIVATE LSUForigem, LSUFdestino

    LSAlias      = Alias()

	
    LNiva = 0
    LNipialq = 0
	LNtp_mercad	= 99999   && INVALIDO
	LScst		= " "		&& ASSUME 0
    LNaliq_iss = 0
    LNaliq_rdu = 0
    LNaliq_icms = 0
    LScfo = ""


    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_GrFiscal  = NetArqAgain("GRFISCAL")
    ALS_GrFiscal  = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()


    LNiva = 0
	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto

	*---------------------------------------------------------------*

	SELE &Als_GRfiscal
	SET ORDER TO trb_classe
	SEEK &Als_empresa .estado + LEFT( &Als_grupo .classifica,5)
	IF !FOUND()
		SET ORDER TO trb_sbgrpo
		SEEK &Als_empresa .estado + LEFT( &Als_grupo .classifica,8)
	ENDIF

	*---------------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF


	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    *=========>>>>>>>   OBTER IVA    <<<<<<



	=W_DEFPROC("CLIENC.SPR")
	LSUFdestino = CNGetUFDestino(PrmEmpresa,;
								PrmOrcamento)




	=W_DEFPROC("EMPRESA.SPR")
	LSUForigem = EMGet_UF(PrmEmpresa)


	=W_DEFPROC("TRIBUTAR.SPR")
	LNiva = TRGet_IVA( LSUForigem,;
			            PrmProduto,;
			            LSUFdestino ,;
			            &ALS_Orcament .data )




    *=========>>>>>>>   OBTER ALIQ IPI    <<<<<<

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA
	DO CASE
		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA
		CASE &Als_Grupo .origem = 1
			LNipialq   =  &Als_Grupo .aliq_ipi

		OTHERWISE
			LNipialq   =	0
	ENDCASE


    *=========>>>>>>>   OBTER TP_MERCAD    <<<<<<
	*--------------------------------------------------------
	*	IF &Als_Orcamento .data < {01.03.2000}
	*		LNtp_mercad	= 	&Als_grupo .tp_mercad
	*	ELSE
	*		LNtp_mercad	= 	&Als_grfiscal .tp_mercad
	*	ENDIF
	*--------------------------------------------------------


    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)


	*----------------------------------------------------------------*
	*		Identificar mercadorias em regime de substituicao ESTADUAL
	*	em caso de operacao ITERESTADUAIS com consumidor INSCRITO(2)/
	*	REVENDA(4) ou DEVOLUCOES passa mercadoria para regime tributado
	*----------------------------------------------------------------*
	IF LNtp_mercad = 2	AND &Als_tipooper .ch_desti = "2"
		IF     &Als_grfiscal .subgrupo > "02000" ;
		   AND &Als_grfiscal .subgrupo < "99999" ;
		   AND &Als_grfiscal .subgrupo <> "04042"
			DO CASE
				*----------------------------------------------------*
				* TODAS OPERACOES DIFERENTES DE VENDAS
				*----------------------------------------------------*
				CASE &Als_tipooper .ch_opera <> "1" && TODAS OPER DIFERE
				                                    && DE VENDA
					LNtp_mercad	= 	1
				*----------------------------------------------------*
				* TODAS VENDAS Q NAO FOREM PARA 1-CONSSUMIDOR  OU
				*                               3-CONTR NAO ISCRITO
				*----------------------------------------------------
				CASE !( &Als_tipooper .ch_contr $ "3/1" )
					LNtp_mercad	= 	1
			ENDCASE
		ENDIF
	ENDIF
    *=========>>>>>>>   OBTER CST    <<<<<<





	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

	LNtab_cst = &ALS_empresa .tab_cst

	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
	*---------------------------------------------------------------*

	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto)


    *=========>>>>>>>   OBTER ALIQ ISS    <<<<<<
	LNaliq_iss   =	&Als_empresa .aliq_iss
    *=========>>>>>>>   OBTER ALIQ reducao icms   <<<<<<

	LNaliq_rdu    =  0
	IF &Als_empresa .REDUZ_BASE = 0
		LNaliq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNaliq_rdu   = &Als_empresa .REDUZ_BASE  && USAR ALIQUOTA
			                                        && INFORMADA
		endif
	ENDIF

    *=========>>>>>>>   OBTER ALIQ icms   <<<<<<
	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms = &Als_orcament .aliq_icms && USAR ALIQUOTA
											   && INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA
												     && INFORMADA
	ENDIF
    *=========>>>>>>>   OBTER CFO   <<<<<<


	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE LNTp_Mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE




	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
    do TRFcht_Fecha

RETURN

PROCEDURE TRFcht_Fecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_GrFiscal")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HTM           TRGet_IPIAlq VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   11  º
*       º Variable:            TRGet_IPIAlq                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      286                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123htm     &&  TRGet_IPIAlq VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IpiAlq
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto

	=W_DEFPROC("rotinas.spr")

    PRIVATE LNipialq
    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNipialq = 0
	*--------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA

	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
		RETURN(LNipialq)
	ENDIF


    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF
	*------------------------------------------------------------*

	DO CASE
		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA
		CASE &Als_Grupo .origem = 1

			LNipialq   =  TRGet_IPIProd(PrmProduto)

		OTHERWISE
			LNipialq   =	0
	ENDCASE

	*------------------------------------------------------------*

    DO TRFch_IPIAlqFecha

RETURN(LNipialq)

PROCEDURE TRFch_IPIAlqFecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HTN           TRGet_cst VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   12  º
*       º Variable:            TRGet_cst                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      287                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123htn     &&  TRGet_cst VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_cst
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto,PrmCST

	=W_DEFPROC("rotinas.spr")

    PRIVATE LScst
    PRIVATE LSalias

    PRIVATE LNtab_cst
    PRIVATE LNtp_mercad

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Orcamento,ALS_Orcamento

    LSAlias      = Alias()

    *----------------------------------------------------*
	LScst		= " "		&& ASSUME 0

    *----------------------------------------------------*

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()


    LScst  = " "

	LNtab_cst = 0

	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF

	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

 	LNtab_cst = &ALS_empresa .tab_cst

	*--------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF

	*------------------------------------------------------------*


    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)
	*---------------------------------------------------------------*
	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto)


	*------------------------------------------------------------*

    DO TRFch_CSTFecha

RETURN(LScst)

PROCEDURE TRFch_CSTFecha
	IF LScst = " "
		WP_MSG = "ATENCAO :  Nao foi Encontrada TABELA de C.S.T p/ "+;
			"[ Tab:"+STR(LNtab_cst,2)+;
			" Tipo:"+ &ALS_orcamento .tipo +" Mercad"+;
			STR(LNtp_mercad,1)+chr(13)+;
			"SOLICITE CADASTRO URGENTE !!!!!!."
			DO OBJ_ALER.SPR WITH WP_MSG
	ENDIF

    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Orcamento")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HTO           TRDef_tpMercad VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   13  º
*       º Variable:            TRDef_tpMercad                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      288                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hto     &&  TRDef_tpMercad VALID
#REGION 10
RETURN


*--------------------------------------------------------------------*
* ESTA ROTINA ESTA VINCULADA AO ITEM DO ORCAMENTO E DEVE SER DESATIVADA
* EM (TRIBUTAR) QDO FOR MIGRADA PARA ITEM DE (ORCAMENTO OU ITEMMOV)
* COMENTARIO EM 14/05/2009
*---------------------------------------------------------------------*



FUNCTION TRDef_TpMercad
	PARAMETER PrmEmpresa,PrmOrcamento,PrmProduto


	=W_DEFPROC("rotinas.spr")

	PRIVATE LUFEmpresa
	PRIVATE	LNtp_mercad

	=W_DEFPROC("EMPRESA.SPR")
	LUFEmpresa = EMGetFieldValue(PrmEmpresa,"ESTADO")


	*--------------------------------------------------------


	LNtp_mercad	= 99999   && INVALIDO


	LNtp_mercad=;
		TRDef_RgTrbMercad( LUFEmpresa ,PrmProduto)

	*--------------------------------------------------------


RETURN(LNtp_mercad)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HTP           TRGet_rduIcms VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   14  º
*       º Variable:            TRGet_rduIcms                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      289                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123htp     &&  TRGet_rduIcms VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_rduIcms
PARAMETERS PrmEmpresa, PrmOrcamento

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
    *     Definir melhor as regras de reducao de base de ICMS
    * Por enquanto :
    *   FILIAL ARG => Usa reducao informada no registro da empresa
    *   Outras situacaoes ocorrem conforme a operacao e o indice
    *   deve ser informado no tipooper e atribuido ao orcamento
	*------------------------------------------------------------*

    PRIVATE LNaliq_rdu
    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNaliq_rdu = 0
	*--------------------------------------------------------*


    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF


	*------------------------------------------------------------*

	LNalq_rdu    =  0
	IF &Als_empresa .REDUZ_BASE = 0
		LNalq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNalq_rdu = &Als_empresa .REDUZ_BASE
		ELSE
			LNalq_rdu = &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA

		endif
	ENDIF

	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_rdu)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HTQ           TRGet_IcmsAlq VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   15  º
*       º Variable:            TRGet_IcmsAlq                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      290                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123htq     &&  TRGet_IcmsAlq VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IcmsAlq
PARAMETERS PrmEmpresa, PrmOrcamento

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    PRIVATE ARQ_Empresa   , ALS_Empresa
    PRIVATE ARQ_Orcamento , ALS_Orcamento
    PRIVATE ARQ_Tipooper  , ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNaliq_icms = 0
	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF


	*------------------------------------------------------------*

	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms  =  &Als_orcament .aliq_icms && USAR ALIQUOTA INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA INFORMADA
	ENDIF

	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HUG           TRGet_CFO VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   16  º
*       º Variable:            TRGet_CFO                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      291                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hug     &&  TRGet_CFO VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_CFO
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*

	*------------------------------------------------------------*

    PRIVATE LScfo
    PRIVATE LSalias
    PRIVATE LNtp_mercad

    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()


    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LScfo = ""
	*--------------------------------------------------------*



	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LScfo)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LScfo)
	ENDIF


	*------------------------------------------------------*


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)

	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE PrmTp_mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE


	*------------------------------------------------------------*
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LScfo)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HUM           TRcalc_tribu VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   17  º
*       º Variable:            TRcalc_tribu                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      292                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hum     &&  TRcalc_tribu VALID
#REGION 10
RETURN

FUNCTION TRcalc_tribu
	PARAMETERS LNemp,LStipo,LScst,LNvlrvenda,LNtp_mercad;
				LNalq_iss,LNalq_icms,LNalq_ipi,LNalq_rdu,;
				LNiva,;
				LDdata,;
				LSufdesti,;
				LNqtde,;
				LScodprd,;
				LNbsIss,LNvlrIss,;
				LNbsIcms,LNvlrIcms,LNbsIsent,;
				LNbsSbBrt,LNbsSubs,LNicmSub,LNbsOutr,;
		        vTParam

	LNbsIpi      = vTParam[01]
	LNvlrIpi     = vTParam[02]
	LNbsIsIpi    = vTParam[03]
	LNbsbrIcms   = vTParam[04]
    PrmSeg       = vTParam[05]
    LNissrtd     = vTParam[06]
    PrmSbstISS   = vTParam[07]


	*----------------------------------------------------------*
    *    O Numero maximo de parametros passados a uma UDF e 24
    * o vTParam aplia essa condicao (mas por questoes de facilidade o
    * vetor so e utilizado para completar os parametros excedentes)
	*----------------------------------------------------------*


	*------------------------------------------------------------*
	*  CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	*  OBJETIVO.......: Calcular Valores TRIBUTARIAS E FISCAIS
	*------------------------------------------------------------*
	*  COMENTARIO.....:
	*------------------------------------------------------------*
	*  OBS............:
	*------------------------------------------------------------*
	*  TABELAS.......:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LStipo.....:
	*		LScst......: Codigo Situacao Tributaria
	*		LNvlrvenda.: Valor da Venda (Movimentacao)
	*		LNtp_mercad:
	*		LNalq_iss..:
	*		LNalq_icms.:
	*		LNalq_ipi..:
	*		LNalq_rdu..:
	*		LNiva......:
	*		LDdata.....:
	*		LSufdesti..:
	*		LNqtde.....: Para atendeder necessidade no calc base IPI
	*					 da transferencia
	*		LScodprd...: As Rotinas Novas > 22/08/2000 passam o
	*                  Codigo do Produto LEN(LScodprd) = 11 e as
	*                  antigas , que devem ser substituidas usam
	*                  a Classifica‡Æo LEN(LScodprd) > 11
	*                  => Quando Vier o Codigo => Ler Grupo e Achar a
	*                  Classifica‡Æo para uso interno desta Rotina
	*
	*	Para atendeder necessidade no calc base IPI
	*					 da transferencia
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNbsIss....:
	*		LNvlrIss...:
	*		LNbsIcms...:
	*		LNvlrIcms..:
	*		LNbsIsent..:
	*		LNbsSbBrt..:
	*		LNbsSubs...:
	*		LNbsOutr...:
	*		LNbsIpi....:
	*		LNvlrIpi...:
	*		LNbsIsIpi..:
	*		LNbsbrIcms.:
	*------------------------------------------------------------*
	* CHAMADAS : OBJ_ITOR.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LNbs_TRIBUTAR		&& BASE PARA TIBUTAR
	PRIVATE LDdtpesq			&& PARA PESQUISA DE BASE IPI TRANSD
	PRIVATE LSclasprd


    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_Saldo,ALS_Saldo

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Saldo  = NetArqAgain("SALDO")
    ALS_Saldo  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

	*------------------------------------------------------------*
	IF LEN(LScodprd) > 11
		LSclasprd = LScodprd
	ELSE
		SELE &ALS_grupo
		SET ORDER TO TAG codigo
		SEEK LScodprd
		IF !FOUND()
			LSclasprd = ""
		ELSE	
			LSclasprd = &ALS_grupo .classifica
		ENDIF
	ENDIF
	*------------------------------------------------------------*
	SELECT &ALS_tipooper
	SET ORDER TO tag tipo
	SEEK "S"+LStipo
	IF !FOUND()
		SEEK "s"+LStipo
		IF !FOUND()
		    DO TRcalc_Fecha
			RETURN(.f.)
		ENDIF
	ENDIF
	*------------------------------------------------------------*
	SELECT &ALS_empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
	    DO TRcalc_Fecha
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	STORE 0 TO LNbsIss,LNvlrIss,LNbsIcms,LNvlrIcms,LNbsIsent,;
			LNbsSbBrt,LNbsSubs,LNbsOutr,LNbsIpi,LNvlrIpi,LNbsIsIpi
			
	STORE 0 TO LNissrtd
	
	*------------------------------------------------------------*
	*		TRIBUTOS INDEPENDENTES DA SITUACAO TRIBUTARIA
	*------------------------------------------------------------*
	*	Calculo envolvendo ISS
	*		-tp_mercad= 7 => SERVICO
	*------------------------------------------------------------*
	LNbsIss		=	0
	LNvlrIss	=	0
	IF LNtp_mercad = 7
		LNbsIss	 =	LNvlrvenda
		LNvlrIss =  ROUND(LNbsIss * ROUND(LNalq_iss  / 100,4),2)
	ENDIF
	
	*------------------------------------------------------------*
	*	Calculo envolvendo ISS RETIDO
	*------------------------------------------------------------*
	LNIssRtd	=	0
	IF PrmSbstISS = 1  && se = 1 segumento retem iss
		LNIssRtd = LNvlrIss
	ENDIF
	
	*------------------------------------------------------------*
	*	Calculo envolvendo IPI
	*		-Devolucao:		A base do IPI e o proprio vlrvenda
	*		-Outras   : 	O IPI ja esta embutido no valor de
	*				de venda. Por isso e necessario retira-lo
	*				para determinar a base Original
	*------------------------------------------------------------*
	LNbsIpi 	= 	0
	LNvlripi 	= 	0
	LNbsIsIp	=	LNvlrvenda
	IF LNalq_Ipi > 0
		DO CASE
			CASE &ALS_tipooper .ch_opera = "4" 	&& DEVOLUCAO
				LNbsIpi  = LNvlrvenda
			CASE &ALS_tipooper .ch_opera = "2" 	&& TRANSFERENCIA
				*----------------------------------------------------*
				*  CASO DAS IMPORTACOES INICIADAS EM 2006
				*----------------------------------------------------*
				LNbsIpi  = LNvlrvenda
			CASE &ALS_tipooper .ch_opera = "2" 	&& TRANSFERENCIA
				*----------------------------------------------------*
				*  CASO ANTIGO QDO AS IMPORTACOES FORAM TRATADAS
				* DE FORMA ERRADA
				*----------------------------------------------------*
				*    	Determina o Ultimo dia do mes Anterior para
				*   data de pesquisa E MES ANTERIOR P/ O REGISTRO DO
				*   SALDO
				*     MOTIVO : A base do ipi nas transferencias
				*			e a media do valor de venda nos meses
				*			anteriores
				*----------------------------------------------------*
				LDdtpesq   = LDdata - DAY(LDdata)
				SELE &ALS_SALDO
				SEEK STR(LNemp,3)+LSclasprd+;
							STR(YEAR(LDdata),4)+;
						 	 STR(MONTH(LDdata),2)
				*----------------------------------------------------*
				*    Caso nao seja possivel determinar a media
				*  sera considerado o custo medio ANTERIOR OU ATUAL
				*	(ULTIMO CASO)
				*----------------------------------------------------*
				DO CASE
					CASE FOUND() AND &ALS_saldo .sld_ante > 0
					   LNbsipi = &ALS_saldo .vlr_ante / &ALI_saldo .sld_ante
					CASE FOUND() AND &ALS_saldo .sld_atu  > 0
					   LNbsipi = &ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
				ENDCASE					
				*----------------------------------------------------*
				DO WHILE LDdtpesq > {31.12.1994}
					SEEK STR(LNemp,3)+LSclasprd+;
							STR(YEAR(LDdtpesq),4)+;
						 	 STR(MONTH(LDdtpesq),2)
					IF !FOUND() OR &ALS_SALDO .qtd_venda = 0
	   					LDdtpesq   = GOMONTH(LDdtpesq,-1)
						LOOP
					ENDIF					
					LNbsipi = &ALS_SALDO .ven_enc / &ALS_SALDO .qtd_venda
					IF LDdata <= {24.06.1998}
						LNbsipi	= LNbsipi * 0.70
					ELSE
						LNbsipi	= LNbsipi * 0.90
					ENDIF						
					EXIT
				ENDDO			
				LNbsipi = LNbsipi * LNqtde
			OTHERWISE
				LNbsIpi  = ROUND(LNvlrvenda/(1+LNalq_ipi/100),2)
		ENDCASE
		LNvlripi 	= ROUND(LNbsIpi * ROUND(LNalq_ipi  / 100,4),2)
		LNbsIsIp	= 0
	ENDIF
	LNvlripi = TRcalc_Difer(LNvlripi,LNqtde,2)
	
	*------------------------------------------------------------*
	*		TRIBUTOS PELA SITUACAO TRIBUTARIA
	*------------------------------------------------------------*
	*  BASE DE INCIDENCIA DE TRIBUTOS
	*    - EM DEVOLUCOES O IPI COMPOE A BASE DE TRIBUTACAO
	*    - NAS OUTRAS OPERACOES O IPI E RETIRADO PARA COMPOR A
	*     BASE
	*------------------------------------------------------------*
	IF &ALS_tipooper .ch_opera $ "4/2" 	&& DEVOLUCAO/TRANSF
		LNbs_TRIBUTAR	= LNvlrvenda
	ELSE
		IF LDdata > {01.01.2000}
			*-----------------------------------------------------*
			&&    O IPI so passou a ser calculado nas saidas a partir
			&& de 01.01.2000 e mesmo assim conssideramos o ipi
			&& como sendo imbutido no valor particado
			&& por isso ele ‚ retirado para compor a tributacao
			&&    Uma checagem mais detalhada indicara uma diferenca
			&& nas notas anteriores a esta data pois o ipi foi calculado
			&& apos a emissÆo das notas(Contador PEDRO) e nao foi
			&& considerado para tributa‡Æo
			*----------------------------------------------------*
			LNbs_TRIBUTAR	= LNvlrvenda - LNvlrIpi
		ELSE
			LNbs_TRIBUTAR	= LNvlrvenda
		ENDIF
	ENDIF										
	*------------------------------------------------------------*
	*------>>> BASE BRUTA DE ICMS SEM CONSIDERAR REDUCOES
	DO CASE
		CASE LScst $ "0/1/2/7"		&& ENVOLVE MERCAD TRIBUTADA NORMAL
			LNbsbrIcms	= LNbs_TRIBUTAR
        OTHERWISE
   			LNbsbrIcms	= 0
	ENDCASE

	*------>>> BASE LIQUIDA  DE ICMS CONSIDERANDO  REDUCOES----*
    *    As reducoes podem ser em funcao da operacao = "0/1"
    *  ou em funcao da empresa CST = "2/7"
	*  OBS: As reducoes em funcao da operacao foram introduzidas
	*     apos mudancas no recolhimento de PIS/COFINS em que as NF
	*  da firestone vinham com reducao na base do icms e que em caso
	*  de devolucoes deveriam operar com reducao da base.....
    *----------------------------------------------------------*
	DO CASE
		CASE LScst $ "0/1"		&& ENVOLVE MERCAD TRIBUTADA NORMAL
			LNbsIcms	= LNbsbrIcms - ;
		             ROUND(LNbsbrIcms * LNalq_rdu/100,2)
		CASE LScst $ "2/7"		&& REDUZIR BASE DO ICMS
			LNbsIcms	= LNbsbrIcms - ;
		             ROUND(LNbsbrIcms * LNalq_rdu/100,2)
	ENDCASE

	*------------------------------------------------------------*
	*----------------->>> BASE SUBSTITUICAO <<<------------------*
	*------------------------------------------------------------*
	IF LScst $ "1/3/7/"		
		LNbsSbBrt	= LNbs_TRIBUTAR + LNvlrIpi
		*----> INTERESTADUAL  e CONSUMIDOR INSCRITO
		
		DO CASE
			CASE &ALS_tipooper .ch_desti = "2" ;
			     AND &ALS_tipooper .ch_contr = "2"
				LNbssubs = LNbs_TRIBUTAR + LNvlrIpi

			CASE LScst $ "1/7" AND LDdata < CTOD("01.01.97")
				LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi) *  1.45)

			CASE LScst $ "3" AND &ALS_tipooper .ch_desti = "1"
				LNbssubs = ((LNbs_TRIBUTAR+LNvlrIpi)   *  1.225)
				*  qualquer situacao de retencao interna sera
				*	 entendida como reem bolso 1.225
				*	 (DEFINIDO COM PEDRO EM 17/04/97)

			CASE LScst $ "3" AND LDdata < CTOD("01.01.97")
				LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi) *  1.225)
			CASE &ALS_tipooper .ch_opera = "4"
				*----------------------------------------------*
				* Oliveira 21/09/2004 => Em fun‡Æo da altera‡Æo
				* do convenio 10/03 a redu‡Æo (PIS/COFINS) passa
				* a insidir sobre a base de substitui‡Æo
				*----------------------------------------------*

				IF LDdata < {05.03.2007}
				    LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
				    LNbssubs	= LNbssubs - ;
			             ROUND(LNbssubs * LNalq_rdu/100,2)
				ELSE
				    LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
				    LNbssubs	= LNbssubs - ;
			             ROUND((LNbs_TRIBUTAR*LNiva) * LNalq_rdu/100,2)

				ENDIF
			OTHERWISE
			    LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
		ENDCASE
	ENDIF
	*------------------------------------------------------------*
	*--------------------->>> OUTRAS <<<-------------------------*
	*------------------------------------------------------------*
	DO CASE
		CASE LScst = "0"		&& COM REDUCAO BASE CALCULO ICMS
		                        && atribuido apos mudanca pis cofins
			LNbsisent 	= LNbsbrIcms - LNbsicms
		CASE LScst = "1"		&& COM REDUCAO BASE CALCULO ICMS
		                        && BASICAMENT EM DEVOLUCOE
		                        && TRIBUTADA E COM SUBSTITUICAO
			LNbsisent 	= LNbsbrIcms - LNbsicms
		CASE LScst = "2"		&& COM REDUCAO BASE CALCULO ICMS
			LNbsisent 	= LNbs_TRIBUTAR - LNbsicms
		CASE LScst = "3"		&& ISENT. OU N. TRIB. E COM SUBST. TRIB
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "4"		&& ISENT. OU N. TRIB. E COM SUBST. TRIB
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "5"		&& COM SUSPENSAO OU DIFERIMENTO
			LNbsoutr 	= LNbs_TRIBUTAR
		CASE LScst = "6"		&& ICMS CABRADO ANTES POR SUBSTITUICAO
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "7"		&& COM REDUCAO BASE CALCULO ICMS POR SUBS
			LNbsisent 	= LNbs_TRIBUTAR - LNbsicms
	ENDCASE
	*---------------------- CALCULANDO VALORES ------------------*
	LNvlricms 	= LNbsicms * LNalq_icms / 100

	IF LNbssubs > 0
		IF LSufdesti $ "MG/SP/RJ" AND &ALS_tipooper .ch_opera <> "4"			
			*------ ALIQUOTA INTERNA 18 % ----*
			LNicmSub = ;
			 ((LNbssubs) * 0.18) - (LNbsIcms * LNalq_icms / 100)
		ELSE
        	LNicmSub = ;
        	 ((LNbssubs) * 0.17) - (LNbsIcms * LNalq_icms / 100)
		ENDIF
	ENDIF
	*------------------------------------------------------------*
    DO TRcalc_Fecha

	*------------------------------------------------------------*

	vTParam[01] = LNbsIpi
	vTParam[02] = LNvlrIpi
	vTParam[03] = LNbsIsIpi
	vTParam[04] = LNbsbrIcms
    vTParam[06] = LNissrtd


	*------------------------------------------------------------*
RETURN(.T.)


PROCEDURE TRcalc_Fecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Saldo")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HV5           CSTENT VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   18  º
*       º Variable:            CSTENT                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      293                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hv5     &&  CSTENT VALID
#REGION 10
RETURN

PROCEDURE TXMP


           * A ROTINA A SER DESENVOLVIDA DEVE SUBSTITUIR TRECHO DE
           * PROGRAMA ESCRITO EM SCT0310 QUE GERA O SINTEGRA E CORRIGE
           * O CST


			*---------------------------------------------------*			
			*  ATENCAO : Definir Regra para Informar corretamente
			*           CST em NOTAS DE ENTRADA
			*---------------------------------------------------*			

			IF itemmov.cst <> " "
				LScst   = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
					  LIVROENT.cst+ "0"
			ELSE
				DO CASE
					CASE LIVROENT.tp_mercad = 1 ;
					    and LIVROENT.base_calc > 0 ;
					    and LIVROENT.base_calc <> LIVROENT.vlrvenda
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
					CASE LIVROENT.tp_mercad = 1 and LIVROENT.base_calc > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "0"  + "0"
					CASE LIVROENT.tp_mercad = 1 and LIVROENT.base_calc = 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
					CASE   LIVROENT.tp_mercad = 2 ;
					   and LIVROENT.icms_subs > 0 ;
					   and LIVROENT.base_calc > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "1"  + "0"
					CASE LIVROENT.tp_mercad = 2 and LIVROENT.icms_subs > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "6"  + "0"
					CASE LEFT(LIVROENT.codigo,5) = "99999"
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "9"  + "0"
					OTHERWISE
						LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
				ENDCASE
			ENDIF
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HV6           TRRtdoSaida VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   19  º
*       º Variable:            TRRtdoSaida                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      294                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hv6     &&  TRRtdoSaida VALID
#REGION 10
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser 
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido ‚ calculado conforme a f¢rmula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda nÆo trata de forma parametrizada
	*					 a aliquota interna e at‚ que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa‡Æo atual
	*					 em termos de Pneulƒndia
	*------------------------------------------------------------------*						

FUNCTION TRRtdoSaida
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNicms,LNbase_Icms,LNbase_Rtdo

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNicmsOrigem       && Aliquota Externa no Estado Origem
	PRIVATE LNicmsDestino      && Aliquota Interna no Estado Destino
 	
    LSAlias      = Alias()

	LNicms = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) &&
	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmInUF(LSufDestino) &&

	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNbase_Rtdo = TREbsRtdoCIVA(LSproduto,;
							LSufOrigem,;
							LSufDestino,;
							LNvlrMercadoria,;
							LNvlrIPI,;
							LNcdg_Forn)


	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2

  		   LNicms =  (LNbase_Rtdo * LNicmsDestino/100)-;
   	    	         (LNbase_Icms  * LNicmsOrigem/100)

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNicms)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HV7           TRRtdoEntrada VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   20  º
*       º Variable:            TRRtdoEntrada                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      295                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hv7     &&  TRRtdoEntrada VALID
#REGION 10
RETURN

FUNCTION TRRtdoEntrada
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn

	=W_DEFPROC("rotinas.spr")
				
	PRIVATE LSalias,LNicms,LNbase_Icms,LNbase_Rtdo

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNicmsOrigem       && Aliquota Externa no Estado Origem
	PRIVATE LNicmsDestino      && Aliquota Interna no Estado Destino
	PRIVATE LNiva			   &&
 	
	LNicms = 0.00
    LSAlias      = Alias()

	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) &&
	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmInUF(LSufDestino) &&
	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNbase_Rtdo = TREbsRtdoCIVA(LSproduto,;
							LSufOrigem,;
							LSufDestino,;
							LNvlrMercadoria,;
							LNvlrIPI,;
							LNcdg_Forn)



	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*


	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 1 and LNRgTrbDestino = 2

  		   LNicms =  (LNbase_Rtdo * LNicmsDestino/100)-;
   	    	         (LNbase_Icms  * LNicmsOrigem/100)


	    ENDIF
	ENDIF


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNicms)

*--------------   descartado em 6/10/2003
*  		   LNicms =  ((LNvlrMercadoria + LNvlrIPI);
*	   			 * LNiva * LNicmsDestino/100)-;
*	             (LNbase_Icms  * LNicmsOrigem/100)
*----------------

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HV8           TRicmNormal VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   21  º
*       º Variable:            TRicmNormal                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      296                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hv8     &&  TRicmNormal VALID
#REGION 10
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION UITicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula o ICMS NORMAL no Item de Entrada :
	*				-Sera Calculado para TP_MERCAD = 1
	*					(Mercadoria Tributada)
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*-------------------------------------------------------------------*						

FUNCTION TRicmNormal
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
				
	=W_DEFPROC("rotinas.spr")


	PRIVATE LSalias,LNicms,LNbase_Icms
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples

	LNicms = 0.00
    LSAlias      = Alias()

	
	*--------------------------------------------------------*
	=W_DEFPROC("forneced.spr")
	LNRgFiscFornecedor = FRrgm_Fisc(LNcdg_Forn)

    IF 	LSufOrigem = LSufDestino
		=W_DEFPROC("tributar.spr")
		LNicmsOrigem    =	TRAlqIcmInUF(LSufOrigem) && Aliquota Interna
	ELSE
		=W_DEFPROC("tributar.spr")
		LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) && Aliquota Externa
	ENDIF


	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)


	**** IF LNRgTrbOrigem = 1  AND LNRgTrbDestino = 1

	IF LNRgTrbDestino = 1 AND LNRgFiscFornecedor = 0
	    LNicms =  LNbase_Icms * LNicmsOrigem/100
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNicms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HV9           TREnbsicmNormal VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   22  º
*       º Variable:            TREnbsicmNormal                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      297                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hv9     &&  TREnbsicmNormal VALID
#REGION 10
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION Ubsicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula a Base ICMS NORMAL no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION TREnbsicmNormal
	PARAMETERS 	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
				
	=W_DEFPROC("rotinas.spr")


	PRIVATE LSalias,LNbase_Icms

    LSAlias      = Alias()

	LNbase_Icms = 0.00

	*--------------------------------------------------------*

    IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 	LNbase_Icms = LNvlrMercadoria - (LNvlrMercadoria * (4.9/100))
	ELSE
	 	LNbase_Icms = LNvlrMercadoria
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNbase_Icms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HVU           TREbsRtdoCIVA VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   23  º
*       º Variable:            TREbsRtdoCIVA                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      298                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hvu     &&  TREbsRtdoCIVA VALID
#REGION 10
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser 
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido ‚ calculado conforme a f¢rmula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda nÆo trata de forma parametrizada
	*					 a aliquota interna e at‚ que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa‡Æo atual
	*					 em termos de Pneulƒndia
	*------------------------------------------------------------------*						

FUNCTION TREbsRtdoCIVA
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNbase_Retido

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNiva			   &&
 	
    LSAlias      = Alias()

	LNbase_Retido = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")

	LNiva = TRGet_IVA( LSufOrigem,;
			            LSproduto,;
			            LSUFdestino ,;
			            wp_dtoper )

	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2
  	
  		  LNbase_Retido =  (LNvlrMercadoria + LNvlrIPI)

		  IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (4.9/100))
		  ENDIF

		  IF LNcdg_Forn = 2
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (5.19/100))
		  ENDIF

          LNbase_Retido = LNbase_Retido *  LNiva

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNbase_Retido)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HVZ           TREbsRtdoSIVA VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   24  º
*       º Variable:            TREbsRtdoSIVA                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      299                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hvz     &&  TREbsRtdoSIVA VALID
#REGION 10
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser 
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido ‚ calculado conforme a f¢rmula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda nÆo trata de forma parametrizada
	*					 a aliquota interna e at‚ que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa‡Æo atual
	*					 em termos de Pneulƒndia
	*------------------------------------------------------------------*						

FUNCTION TREbsRtdoSIVA
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNbase_Retido

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
 	
    LSAlias      = Alias()

	LNbase_Retido = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2
  	
  		  LNbase_Retido =  (LNvlrMercadoria + LNvlrIPI)

		  IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (4.9/100))
		  ENDIF

		  IF LNcdg_Forn = 2
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (5.19/100))
		  ENDIF

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNbase_Retido)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HW5           TRcalc_Difer VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   29  º
*       º Variable:            TRcalc_Difer                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      300                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hw5     &&  TRcalc_Difer VALID
#REGION 10
RETURN

FUNCTION TRcalc_Difer
	PARAMETERS LNValorTotal,LNqtde,Lncasas
	*------------------------------------------------------------*
	PRIVATE LNajuste
	LNajuste = ROUND(LNValorTotal/LNqtde,Lncasas)*LNqtde
RETURN(LNajuste)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HW9           TRVincTipo VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   31  º
*       º Variable:            TRVincTipo                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      301                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _2wz123hw9     &&  TRVincTipo VALID
#REGION 10
RETURN

FUNCTION TRVincTipo
	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_TipoOper,ALS_TipoOper
    PRIVATE ARQ_ClasFisc,ALS_ClasFisc
	LSalias = ALIAS()

    ARQ_TipoOper     = NetArqAgain("TIPOOPER")
    ALS_TipoOper     = Alias()

    ARQ_ClasFisc     = NetArqAgain("CLASFISC")
    ALS_ClasFisc     = Alias()

	IF ( ARQ_TipoOper + ARQ_ClasFisc) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&Als_TipoOper")
        =up_fecha("&Als_ClasFisc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = " "
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*


	*-----------------------------------------------*
	*CRIAR CODIGO DA CLASSIFICACAO <CODCLASSIF>
	*-----------------------------------------------*



	SELE &ALS_ClasFisc
	SET ORDER TO TAG CFOP
	GO TOP

	CTRCFOP = 1
	QBRCFOP = CFOP
	DO WHILE !EOF()
		m.CODCLASSIF = INT(VAL(CHRTRAN(CFOP,".","")))*10+CTRCFOP
		=RLOCK()
		REPLACE CODCLASSIF WITH m.CODCLASSIF
		QBRCFOP = CFOP
		SKIP

		IF QBRCFOP = CFOP
			CTRCFOP = CTRCFOP + 1
		ELSE
			CTRCFOP = 1
		ENDIF
	
	ENDDO



	*-----------------------------------------------*
	*ATRIBUIR CODIGO DA CLASSIFICACAO A TABELA TIPOOPER (FOX)
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFO


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODOPERA   WITH &ALS_ClasFisc .CODOPERA
		REPLACE &Als_TipoOper .CODCLASSIF WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO
		


	*-----------------------------------------------*
	*  OPERACOE VICULADAS A CFO SUBSTITUICAO
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFOSUBS


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODCLSSUBS WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO
		

	*-----------------------------------------------*
	*  OPERACOE VICULADAS A CFO SERVICO
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFOSERVICO


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODCLSERVC WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO


	*-----------------------------------------------*
	*  ATRIBUICAO CST
	*-----------------------------------------------*





	*------------------------------------------------------------*
    =up_fecha("&Als_TipoOper")
    =up_fecha("&Als_ClasFisc")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)

*BROWS FIELDS CL.CODOPERA,CL.CODCLASSIF,CL.CFOP,;
*         TP.CFO,TP.CFOSUBS,TP.CFOSERVICO,TP.TIPO,TP.CODOPERA,;
*         TP.CODCLASSIF,TP.CODCLSSUBS,TP.CODCLSERVC


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HWG           TRGet_IVA VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   32  º
*       º Variable:            TRGet_IVA                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      302                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hwg     &&  TRGet_IVA VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TRGet_IVA
PARAMETERS 	PrmUFOrigem,;
			PrmProduto, ;
			PrmUFDestino,;
			PrmData,;
    		PrmAlsNF,;
    		PrmAlsIT
    		


	=W_DEFPROC("rotinas.spr")


	IF TYPE("PrmUFDestino") <> "C"
	    DO OBJ_ALER.SPR WITH ;
		   "ERRO -> CHAMADA DA FUNCAO TRget_IVA NAO FOI ADAPTADA ";
		         +CHR(13)+CHR(13)+;
			   "   <ENTER>  "
				SET STEP ON
	ENDIF

    PRIVATE LNiva
    PRIVATE LSalias
	PRIVATE LSuf

	PRIVATE LNalq_externaUForg, LNalq_internaUFDst


    PRIVATE ALS_Grupo
    PRIVATE ARQ_tab_iva,ALS_tab_iva

    LSAlias      = Alias()


	STORE 0 TO ARQ_Grupo, ARQ_tab_iva
	*--------------------------------------------------------

	=W_DEFPROC("GRUPO.SPR")
    ALS_Grupo    = GRGetAlias()

	*--------------------------------------------------------


	IF TYPE("TRtab_IvaALIAS") = "U" OR !USED(TRtab_IvaALIAS)
		PUBLIC TRtab_IvaALIAS
	    ARQ_tab_iva     = NetArqAgain("TAB_IVA")
	    TRtab_IvaALIAS  = Alias()
	ENDIF

    ALS_tab_iva  = TRtab_IvaALIAS

    LNiva = 0
	*--------------------------------------------------------*

	
	LSuf = PrmUFDestino

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
        DO TRFcht_IVAFecha
        RETURN(LNiva)
	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para Produto  especifico
	*------------------------------------------------------------*

	SELE &ALS_tab_iva
	SET ORDER TO TAG subgrupo
	SEEK LSuf + LEFT( &Als_Grupo .classifica,5)+PrmProduto
    IF !FOUND()
		SEEK "BR"+ LEFT( &Als_Grupo .classifica,5)+PrmProduto
	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para SubGrupo do Produto
	*------------------------------------------------------------*

	IF FOUND()
	    LNiva		= 	&Als_tab_iva .iva
	ELSE
		SELE &ALS_tab_iva
		SEEK LSuf + LEFT( &Als_Grupo .classifica,5)+""
    	IF !FOUND()
			SEEK "BR" + LEFT( &Als_Grupo .classifica,5)+""
		ENDIF

		IF FOUND()
		    LNiva		= 	&Als_tab_iva .iva
		ENDIF
	ENDIF


	*------------------------------------------------------------*
	* IVA TERMO DE ACORDO TOCANTINS
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra para termo de acordo
    *   revenda pecas TO
    *   => PECAS
    *      => TO
	*------------------------------------------------------------*
    IF 	PrmUFOrigem $ "TO" AND PrmUFDestino  $ "TO"

			*--------------------------------------------*
			* PECAS E ACESSORIOS
			*--------------------------------------------*
	 		IF LEFT( &Als_Grupo .classifica,2) = "04"
				LNiva = 1.265				
		 	ENDIF

	ENDIF

	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PECAS
    *      => MT e DF
	*------------------------------------------------------------*
    IF 		(PrmUFOrigem $ "MT/DF" OR PrmUFDestino  $ "MT/DF");
    	and PrmUFOrigem <> PrmUFDestino ;
    	and PrmData >= {01.06.2008}

		LFajustaIVA = .f.

	 	DO CASE
			*--------------------------------------------*
			* PECAS E ACESSORIOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "04"
	 		   IF LEFT( &Als_Grupo .classifica,5)  $ "04041/04042/04043"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF

			*--------------------------------------------*
			* PESOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) = "07075"
	 		   IF SUBS( &Als_Grupo .classifica,6,3)  $ "599/699/799/899/999"
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
			*--------------------------------------------*
			* MATERIAL BORRACHARIA
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "05"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
 	
	 	ENDCASE

		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)


			do case
				case LNiva = 1.265				
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.417				
								case LNalq_internaUFDst = 18
									LNiva = 1.435				
								case LNalq_internaUFDst = 19
									LNiva = 1.452			
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.341				
								case LNalq_internaUFDst = 18
									LNiva = 1.358			
								case LNalq_internaUFDst = 19
									LNiva = 1.374			
		                    endcase
					endcase
				case LNiva = 1.400				
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.569				
								case LNalq_internaUFDst = 18
									LNiva = 1.588				
								case LNalq_internaUFDst = 19
									LNiva = 1.607				
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.484				
								case LNalq_internaUFDst = 18
									LNiva = 1.502				
								case LNalq_internaUFDst = 19
									LNiva = 1.521			
		                    endcase
					endcase
			endcase
		ENDIF


    ENDIF

	*------------------------------------------------------------*

    DO TRFcht_IVAFecha

RETURN(LNiva)

PROCEDURE TRFcht_IVAFecha
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HWH           TRCFOPServico VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   34  º
*       º Variable:            TRCFOPServico                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      303                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hwh     &&  TRCFOPServico VALID
#REGION 10
RETURN

*-------------------------------------------------------*
*-----> DEFINECFOP PARA SERVICO
*-------------------------------------------------------*

FUNCTION TRCFOPServico
PARAMETERS PrmUFOrgn, ;
           PrmMuniOrgn,;
           PrmUFDstn,;
           PrmMuniDstn,;
           PrmTp_mercad,;
           PrmOperacao

PRIVATE LScfps

	DO CASE
		CASE PrmTp_mercad <> 7   && nao e servico
			LScfps  = "0000"		
		CASE PrmUFOrgn = PrmUFDstn
			LScfps  = "5933"		
		CASE PrmUFOrgn <> PrmUFDstn
			LScfps  = "6933"		
		OTHERWISE
			LScfps  = "0000"		


    *-------------------------------------------------------------*
    *----> lembrar porque foram colocador os codigos abaixo
    *--> este codegos estava dando erro na NFr
    *-------------------------------------------------------------*
    *
  	*	CASE PrmUFOrgn = PrmUFDstn AND PrmMuniOrgn = PrmMuniDstn
	*		LScfps  = "9101"		
	*	CASE PrmUFOrgn = PrmUFDstn AND PrmMuniOrgn <> PrmMuniDstn
	*		LScfps  = "9102"		
	*	CASE PrmUFOrgn <> PrmUFDstn
	*		LScfps  = "9103"		
	*	OTHERWISE
	*		LScfps  = "0000"		
	ENDCASE
RETURN(LScfps)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HWI           TRCST_IPI VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   35  º
*       º Variable:            TRCST_IPI                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      304                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hwi     &&  TRCST_IPI VALID
#REGION 10
RETURN

FUNCTION TRCST_IPI
PARAMETERS PrmVlrIPI,PrmOperacao
	PRIVATE LScstIPI

	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlrIPI > 0
			LScstIPI  = "50"		
		CASE PrmOperacao = "SAIDA" AND PrmVlrIPI = 0
			LScstIPI  = "53"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlrIPI > 0
			LScstIPI  = "50"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlrIPI = 0
			LScstIPI  = "53"		
		OTHERWISE
			LScstIPI  = "53"		
	ENDCASE
RETURN(LScstIPI)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HWJ           TRCST_ISS VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   36  º
*       º Variable:            TRCST_ISS                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      305                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hwj     &&  TRCST_ISS VALID
#REGION 10
RETURN

FUNCTION TRCST_ISS
PARAMETERS PrmVlrISS,PrmOperacao
PRIVATE LScstISS

	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlrISS > 0   &&  servico
			LScstISS  = "00"		
		CASE PrmOperacao = "SAIDA" AND PrmVlrISS = 0   && nao e servico
			LScstISS  = "07"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlrISS > 0   &&  servico
			LScstISS  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlrISS = 0   && nao e servico
			LScstISS  = "07"		
		OTHERWISE
			LScstISS  = "07"		
	ENDCASE
RETURN(LScstISS)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HWK           TRGenero VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   37  º
*       º Variable:            TRGenero                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      306                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hwk     &&  TRGenero VALID
#REGION 10
RETURN

FUNCTION TRGenero
PARAMETERS PrmTp_mercad,PrmClassifica,PrmOperacao
PRIVATE LSgenero

	DO CASE
		CASE PrmTp_mercad = 7
			LSgenero  = "00"		
		CASE LefT(Prmclassifica,2) $ "00/01"
			LSgenero  = "40"		
		OTHERWISE
			LSgenero  = "87"		
	ENDCASE
RETURN(LSgenero)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HWL           TRCST_Entrada VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   38  º
*       º Variable:            TRCST_Entrada                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      307                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
*
*(ILIVROENT.cst, ILIVROENT.origem, ILIVROENT.tp_mercad,
*		ILIVROENT.base_calc, ILIVROENT.vlrvenda,
*		ILIVROENT.icms_subs, ILIVROENT.codigo
*
*(PrmCstInfo   , PrmOrigem       ,PrmTp_Mercad        ,
*		Prmbase_calc, PrmVlrvenda,;
*		Prmicms_subs, PrmCodigo

FUNCTION _2wz123hwl     &&  TRCST_Entrada VALID
#REGION 10
RETURN


FUNCTION TRCST_Entrada
PARAMETERS PrmCstInfo,PrmOrigem,PrmTp_Mercad,Prmbase_calc,PrmVlrvenda,;
		Prmicms_subs, PrmCodigo, Prmtipo

PRIVATE LScst


			*---------------------------------------------------*			
			*  ATENCAO : Definir Regra para Informar corretamente
			*           CST em NOTAS DE ENTRADA
			*---------------------------------------------------*			

		DO CASE
			CASE;
			 Prmtipo $ ;
 			 "CLG/CLH/CFG/CFH/CFM/CID/CLC/CLD/CFC/CFD/CIB/CLE/CLF/CFS/CFE/";
 			 OR ;
			 Prmtipo $ ;
 			 "CFF/CIC/CLJ/CFL/ASC/CEE/ASI/CFJ/CFK/TAB/TBB/TAC/TBC/TAD/TBD/";
 			 OR ;
			 Prmtipo $ ;
 			 "RBV/RBU/RBF/RBH/RBJ/RBM/RBN/RBG/RBI/RBL/RBO/RAC/RBC/RIB/RAA/";
 			 OR ;
			 Prmtipo $ ;
 			 "RBR/RAE/RBE/RID/RBP/RBQ/RCA/RDA/DAF/DBF/DAC/DBC/DBD/DAE/DBE/";
 			 OR ;
			 Prmtipo $ ;
 			 "DAG/DBG/"

			  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "9"  + "0"


			*CASE PrmCstInfo <> " "
			*	LScst   = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
			*		  PrmCstInfo+ "0"


			CASE PrmTp_Mercad = 7
			  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "9"  + "0"

			CASE PrmTp_Mercad = 1
			  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "0"  + "0"


			CASE PrmTp_Mercad = 2
			  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"

			OTHERWISE
				DO CASE
					CASE PrmTp_Mercad = 1 ;
					    and Prmbase_calc > 0 ;
					    and Prmbase_calc <> PrmVlrvenda
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"


					CASE PrmTp_Mercad = 1 and Prmbase_calc > 0
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "0"  + "0"
					CASE PrmTp_Mercad = 1 and Prmbase_calc = 0
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"
					CASE   PrmTp_Mercad = 2 ;
					   and Prmicms_subs > 0 ;
					   and Prmbase_calc > 0
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
					CASE PrmTp_Mercad = 2 and Prmicms_subs > 0
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"
					CASE LEFT(PrmCodigo,5) = "99999"
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "9"  + "0"
					OTHERWISE
						LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"
				ENDCASE
		ENDCASE
		

RETURN(LScst)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HWM           TRcst_Icms VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   39  º
*       º Variable:            TRcst_Icms                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      308                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _2wz123hwm     &&  TRcst_Icms VALID
#REGION 10
RETURN

FUNCTION TRcst_Icms
	PARAMETERS Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto


	PRIVATE Lcst
	

	=W_DEFPROC("GRUPO.SPR")
	LSCst =  GRGetOrigem(PrmProduto)

	LSCst =  STR( LSCst,1)
	
	
	LSCst =  LScst + ;
			 TRdefcst(Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto) + ;
			 "0"
	LSCst = CHRTRAN(LSCst," ","0")

RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HXF           TRCST_PIS VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   40  º
*       º Variable:            TRCST_PIS                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      309                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hxf     &&  TRCST_PIS VALID
#REGION 10
RETURN

FUNCTION TRCST_PIS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "07"		
	ENDCASE
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HXI           TRCST_COFINS VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   41  º
*       º Variable:            TRCST_COFINS                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      310                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hxi     &&  TRCST_COFINS VALID
#REGION 10
RETURN

FUNCTION TRCST_COFINS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "01"	   && ANTES "00"	
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "04"      && ANTES "00"
	ENDCASE
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HXL           TRCST_IR VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   42  º
*       º Variable:            TRCST_IR                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      311                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hxl     &&  TRCST_IR VALID
#REGION 10
RETURN

FUNCTION TRCST_IR
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "07"		
	ENDCASE
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HXO           TRDef_RgTrbMercad VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   44  º
*       º Variable:            TRDef_RgTrbMercad                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      312                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hxo     &&  TRDef_RgTrbMercad VALID
#REGION 10
RETURN

FUNCTION TRDef_RgTrbMercad
	PARAMETER PrmUF,PrmProduto,PrmFormaRetorno
	
	
	
	*-----------------------------------------------------------------*	
	*--> PrmFormaRetorno = 'RETORNAR STRING'
	*   RETORNAR EM FORMATO STRIG (USADO EM DOC FISCAL - EFD E NFe )
	*-----------------------------------------------------------------*	
	




	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE	LSClassifica
	PRIVATE	LNtp_mercad
	LNtp_mercad	= 99999   && INVALIDO
	
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*--------------------------------------------------------

	=W_DEFPROC("GRUPO.spr")
	LSClassifica=GRGetFieldValue(PrmProduto,"CLASSIFICA")


	=W_DEFPROC("GRFISCAL.spr")
	LNtp_mercad	= GFGetTp_Mercadoria(PrmUF, LSClassifica)

	*-------------------------------------------------------------*

	IF TYPE('PrmFormaRetorno') = "C" ;
	   AND  PrmFormaRetorno = 'RETORNAR STRING'
	
		DO CASE

			CASE LNtp_mercad = 7
				LNtp_mercad	= "SERVICO"		

			CASE LNtp_mercad = 2
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			CASE LNtp_mercad = 8
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			OTHERWISE
				LNtp_mercad	= "ICMS NORMAL"		

		ENDCASE


	ENDIF





	*-------------------------------------------------------------*


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNtp_mercad)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HXU           TRpct_trib VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   45  º
*       º Variable:            TRpct_trib                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      313                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123hxu     &&  TRpct_trib VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRpct_trib
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto, ;
    LNiva, LNipialq, LNtp_mercad, LScst, ;
    LNaliq_iss, LNaliq_rdu, LNaliq_icms, LScfo


	=W_DEFPROC("rotinas.spr")


	PRIVATE LSEmpEstado
	PRIVATE LSClassifica
	PRIVATE LSProdOrigem
	PRIVATE LNtab_cst
	PRIVATE LNEmpReduzBase



    PRIVATE LSalias

    PRIVATE ARQ_GrFiscal,ALS_GrFiscal
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper
	PRIVATE LSUForigem, LSUFdestino

    LSAlias      = Alias()

	
    LNiva = 0
    LNipialq = 0
	LNtp_mercad	= 99999   && INVALIDO
	LScst		= " "		&& ASSUME 0
    LNaliq_iss = 0
    LNaliq_rdu = 0
    LNaliq_icms = 0
    LScfo = ""




    ARQ_GrFiscal  = NetArqAgain("GRFISCAL")
    ALS_GrFiscal  = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()


    LNiva = 0
	*--------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	IF !EMLerRegistro(PrmEmpresa)
	    do TRFcht_Fecha
		RETURN
	ENDIF


	=W_DEFPROC("GRUPO.SPR")
	IF !GRLerRegistro(PrmProduto)
	    do TRFcht_Fecha
		RETURN
	ENDIF




	*---------------------------------------------------------------*


	=W_DEFPROC("EMPRESA.SPR")
	LSEmpEstado = EMGet_UF(PrmEmpresa)

	=W_DEFPROC("GRUPO.SPR")
	LSClassifica = GRGetClassifica(PrmProduto)


	=W_DEFPROC("GRUPO.SPR")
	LSProdOrigem = GRGetOrigem(PrmProduto)




	SELE &Als_GRfiscal
	SET ORDER TO trb_classe
	SEEK LSEmpEstado + LEFT( LSClassifica,5)
	IF !FOUND()
		SET ORDER TO trb_sbgrpo
		SEEK LSEmpEstado + LEFT( LSClassifica,8)
	ENDIF

	*---------------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF


	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    *=========>>>>>>>   OBTER IVA    <<<<<<



	=W_DEFPROC("CLIENC.SPR")
	LSUFdestino = CNGetUFDestino(PrmEmpresa,PrmOrcamento)


	=W_DEFPROC("EMPRESA.SPR")
	LSUForigem = EMGet_UF(PrmEmpresa)


	=W_DEFPROC("TRIBUTAR.SPR")
	LNiva = TRGet_IVA( LSUForigem,;
			            PrmProduto,;
			            LSUFdestino ,;
			            &ALS_Orcament .data )




    *=========>>>>>>>   OBTER ALIQ IPI    <<<<<<

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA
	DO CASE

		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA

		CASE LSProdOrigem = 1
			=W_DEFPROC("GRUPO.SPR")
			LNipialq   =  GRGetFieldValue(PrmProduto,"ALIQ_IPI")

		OTHERWISE
			LNipialq   =	0
	ENDCASE


    *=========>>>>>>>   OBTER TP_MERCAD    <<<<<<

    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)


	*----------------------------------------------------------------*
	*		Identificar mercadorias em regime de substituicao ESTADUAL
	*	em caso de operacao ITERESTADUAIS com consumidor INSCRITO(2)/
	*	REVENDA(4) ou DEVOLUCOES passa mercadoria para regime tributado
	*----------------------------------------------------------------*
	IF LNtp_mercad = 2	AND &Als_tipooper .ch_desti = "2"
		IF     &Als_grfiscal .subgrupo > "02000" ;
		   AND &Als_grfiscal .subgrupo < "99999" ;
		   AND &Als_grfiscal .subgrupo <> "04042"
			DO CASE
				*----------------------------------------------------*
				* TODAS OPERACOES DIFERENTES DE VENDAS
				*----------------------------------------------------*
				CASE &Als_tipooper .ch_opera <> "1" && TODAS OPER DIFERE
				                                    && DE VENDA
					LNtp_mercad	= 	1
				*----------------------------------------------------*
				* TODAS VENDAS Q NAO FOREM PARA 1-CONSSUMIDOR  OU
				*                               3-CONTR NAO ISCRITO
				*----------------------------------------------------
				CASE !( &Als_tipooper .ch_contr $ "3/1" )
					LNtp_mercad	= 	1
			ENDCASE
		ENDIF
	ENDIF
    *=========>>>>>>>   OBTER CST    <<<<<<


	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LNtab_cst = EMGet_TabCst(PrmEmpresa)


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
	*---------------------------------------------------------------*

	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto)

    *=========>>>>>>>   OBTER ALIQ ISS    <<<<<<


	=W_DEFPROC("EMPRESA.SPR")
	LNaliq_iss = EMGetFieldValue(PrmEmpresa,"ALIQ_ISS")


    *=========>>>>>>>   OBTER ALIQ reducao icms   <<<<<<
	=W_DEFPROC("EMPRESA.SPR")
	LNEmpReduzBase = EMGetFieldValue(PrmEmpresa,"REDUZ_BASE")


	LNaliq_rdu    =  0


	IF LNEmpReduzBase = 0
		LNaliq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNaliq_rdu   = LNEmpReduzBase  && USAR ALIQUOTA
			                                        && INFORMADA
		endif
	ENDIF

    *=========>>>>>>>   OBTER ALIQ icms   <<<<<<
	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms = &Als_orcament .aliq_icms && USAR ALIQUOTA
											   && INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA
												     && INFORMADA
	ENDIF
    *=========>>>>>>>   OBTER CFO   <<<<<<


	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE LNTp_Mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE




	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
    do TRFcht_Fecha

RETURN

PROCEDURE TRFcht_Fecha
   	=up_fecha("&ALS_GrFiscal")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HY7           IMGetSaldo VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:    3   º
*       º Variable:            IMGetSaldo                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      314                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hy7     &&  IMGetSaldo VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMGetSaldo
PARAMETERS PrmEmp, PrmCodigo, PrmData, PrmHora

	=W_DEFPROC("ROTINAS.SPR")

	PRIVATE LNSaldo
	PRIVATE LSalias
	LSalias		= 	ALIAS()
	IF TYPE("PrmHora") <> "C"
	    PrmHora = "99:99:99"
	ENDIF

	=IMVerifyInst()
	*----------------------------------------------------------------*
	SELE &PBItemmovAlias
	SET ORDER TO TAG movimento
	SET NEAR ON
	SEEK STR(PrmEmp,3)+PrmCodigo+dtos(PrmData)+PrmHora
										&& POSICIONA A FRENTE PARA
										&& VOLTAR E PEGAR SALDO DE
										&& FECHAMENTO OU ATUAL DO DIA
	SET NEAR OFF
	IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
		=W_DEFPROC("SALDO.SPR")
		LNSaldo = SLGetSaldo(PrmEmp, PrmData, PrmCodigo)
	ELSE
		SKIP -1
		IF BOF() OR PrmCodigo <> &PBItemmovAlias .codigo ;
			 	 OR PrmEmp    <> &PBItemmovAlias .empresa
			=W_DEFPROC("SALDO.SPR")
			LNSaldo = SLGetSaldo(PrmEmp, PrmData, PrmCodigo)
		ELSE
			LNSaldo =  &PBItemmovAlias .sld_estq
		ENDIF
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNSaldo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HY8           IMGetReserva VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:    4   º
*       º Variable:            IMGetReserva                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      315                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hy8     &&  IMGetReserva VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMGetReserva
PARAMETERS PrmEmp, PrmCodigo, PrmData, PrmHora

	=W_DEFPROC("ROTINAS.SPR")

	PRIVATE LNSaldo
	PRIVATE LSalias
	LSalias		= 	ALIAS()
	=IMVerifyInst()
	IF TYPE("PrmHora") <> "C"
	    PrmHora = "99:99:99"
	ENDIF
	*----------------------------------------------------------------*
	SELE &PBItemmovAlias
	SET ORDER TO TAG movimento
	SET NEAR ON
	SEEK STR(PrmEmp,3)+PrmCodigo+dtos(PrmData)+PrmHora
										&& POSICIONA A FRENTE PARA
										&& VOLTAR E PEGAR SALDO DE
										&& FECHAMENTO OU ATUAL DO DIA
	SET NEAR OFF
	IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
		=W_DEFPROC("SALDO.SPR")
		LNSaldo = SLGetReserva(PrmEmp, PrmData, PrmCodigo)
	ELSE
		SKIP -1
		IF BOF() OR PrmCodigo <> &PBItemmovAlias .codigo ;
			 	 OR PrmEmp    <> &PBItemmovAlias .empresa
			=W_DEFPROC("SALDO.SPR")
			LNSaldo = SLGetReserva(PrmEmp, PrmData, PrmCodigo)
		ELSE
			LNSaldo =  &PBItemmovAlias .sld_rese
		ENDIF
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNSaldo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HY9           IMgiroSimplesLJ VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:    5   º
*       º Variable:            IMgiroSimplesLJ                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      316                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123hy9     &&  IMgiroSimplesLJ VALID
#REGION 11
RETURN

**********************************************************************
* exemplo chamada
* 		set procedure to ITEMMOV.spr
*		IMgiroSimplesLJ(1,"13011014   ",date()-100,date())

*******************************************************************

FUNCTION IMgiroSimplesLJ
	PARAMETERS PrmLoja,PrmCodigo,PrmDt_Inicial,PrmDt_Final
	
	=W_DEFPROC("rotinas.spr")
    PRIVATE LNgiro
    PRIVATE LNqtdDias, LNidxDia, LNidxData, LNindice
	PRIVATE LNqtvenda, LNsoma

	PRIVATE LSalias
	LSalias			= ALIAS()

	=IMVerifyInst()

    LNqtdDias = PrmDt_Final - PrmDt_Inicial
    DIMENSION Vdata[ LNqtdDias + 1 ]
    DIMENSION Vvendas[ LNqtdDias + 1]
    DIMENSION VSaldo[ LNqtdDias + 1]
    store 0 to Vvendas
    store 0 to VSaldo

	*------------------------------------------------------------------*

	=IMDadosGiro()

	*--------------------- GIRO SIMPLES -------------------------------*

    LNDiasReal = 1		&& Dias considerados para giro
    LNidxDia = 1
	LNsoma = 0

	*---------------------------------------------------------------
	
	DO WHILE LNidxDia <= LNqtdDias
		LNsoma =  LNsoma + Vvendas[ LNidxDia ]
		LNidxDia  = LNidxDia + 1
		LNDiasReal = LNDiasReal + 1
	ENDDO

	LNgiro	= LNsoma / LNDiasReal
	*------------------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNgiro)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HYA           IMgiroRealLJ VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:    6   º
*       º Variable:            IMgiroRealLJ                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      317                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123hya     &&  IMgiroRealLJ VALID
#REGION 11
RETURN

**********************************************************************
* exemplo chamada
* 		set procedure to estoque.spr
*		?ESgiroLJ(1,"13011014   ",date()-100,date(), "FAIXA")

*******************************************************************

FUNCTION IMgiroRealLJ
	PARAMETERS PrmLoja,PrmCodigo,PrmDt_Inicial,PrmDt_Final
	
	=W_DEFPROC("rotinas.spr")
    PRIVATE LNgiro
    PRIVATE LNqtdDias, LNidxDia, LNidxData, LNindice
	PRIVATE LNqtvenda, LNsoma

	PRIVATE LSalias
	LSalias			= ALIAS()
	*---------------------------------------------------------------*
	=IMVerifyInst()
	*---------------------------------------------------------------*
    LNqtdDias = PrmDt_Final - PrmDt_Inicial

    DIMENSION Vdata[ LNqtdDias + 1 ]
    DIMENSION Vvendas[ LNqtdDias + 1]
    DIMENSION VSaldo[ LNqtdDias + 1]
    store 0 to Vvendas
    store 0 to VSaldo
	*---------------------------------------------------------------*
	
	=IMDadosGiro()

	*---------------------------------------------------------------*
	DO WHILE LNidxDia <= LNqtdDias
		IF Vvendas[ LNidxDia ] + Vsaldo[ LNidxDia ] > 0
			LNsoma =  LNsoma + Vvendas[ LNidxDia ]
			LNDiasReal = LNDiasReal + 1
		ENDIF
		LNidxDia  = LNidxDia + 1
	ENDDO
	LNgiro	= LNsoma / LNDiasReal
	*------------------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNgiro)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HYB           IMgiroTendenciaLJ VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:    7   º
*       º Variable:            IMgiroTendenciaLJ                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      318                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123hyb     &&  IMgiroTendenciaLJ VALID
#REGION 11
RETURN

**********************************************************************
* exemplo chamada
* 		set procedure to itemmov.spr
*		?IMgiroLJ(1,"13011014   ",date()-100,date())

*******************************************************************

FUNCTION IMgiroTendenciaLJ
	PARAMETERS PrmLoja,PrmCodigo,PrmDt_Inicial,PrmDt_Final
	
	=W_DEFPROC("rotinas.spr")
    PRIVATE LNgiro
    PRIVATE LNqtdDias, LNidxDia, LNidxData, LNindice
	PRIVATE LNqtvenda, LNsoma

	PRIVATE LSalias
	LSalias			= ALIAS()
	*---------------------------------------------------------------*
	=IMVerifyInst()
	*---------------------------------------------------------------*
    LNqtdDias = PrmDt_Final - PrmDt_Inicial

    DIMENSION Vdata[ LNqtdDias + 2 ]
    DIMENSION Vvendas[ LNqtdDias + 2]
    DIMENSION VSaldo[ LNqtdDias + 2]
    store 0 to Vvendas
    store 0 to VSaldo
	*---------------------------------------------------------------*
	
	=IMDadosGiro()

	*---------------------------------------------------------------*

	*------------------------------------------------*
	&& 1§ - Faixa Completa = Giro total
	*------------------------------------------------*


    LNDiasReal = 0		&& Dias considerados para giro
    LNidxDia = 1
	LNsoma = 0

	DO WHILE LNidxDia <= LNqtdDias
		IF Vvendas[ LNidxDia ] + Vsaldo[ LNidxDia ] > 0
			LNsoma =  LNsoma + Vvendas[ LNidxDia ]
			LNDiasReal = LNDiasReal + 1
		ENDIF
		LNidxDia  = LNidxDia + 1
	ENDDO

    IF LNDiasReal < (LNqtdDias * 0.7) 	
		LNDiasReal = LNqtdDias
	ENDIF

    IF LNDiasReal > 0 	
		LNgiro100 = LNsoma / LNDiasReal
	ELSE
		LNgiro100 = -99
	ENDIF

	*------------------------------------------------*
	&& 2§ - Ultima metade do Periodo 50 %
	*------------------------------------------------*
    LNDiasReal = 1		&& Dias considerados para giro
	LNidxDia = LNqtdDias - INT(LNqtdDias / 2)
	LNsoma = 0

	DO WHILE LNidxDia <= LNqtdDias
		IF Vvendas[ LNidxDia ] + Vsaldo[ LNidxDia ] > 0
			LNsoma =  LNsoma + Vvendas[ LNidxDia ]
			LNDiasReal = LNDiasReal + 1
		ENDIF
		LNidxDia  = LNidxDia + 1
	ENDDO

    IF LNDiasReal < (INT(LNqtdDias / 2) * 0.7) 	
		LNDiasReal = INT(LNqtdDias / 2)
	ENDIF

    IF LNDiasReal > 0		&& Dias considerados para giro
		LNgiro50 = LNsoma / LNDiasReal
	ELSE
		LNgiro50 = -99
	ENDIF

	*------------------------------------------------*
	&& 3§ - Ultima Quarto do Periodo 25 %
	*------------------------------------------------*
    LNDiasReal = 1		&& Dias considerados para giro
	LNidxDia = LNqtdDias - INT(LNqtdDias / 4)
	LNsoma = 0

	DO WHILE LNidxDia <= LNqtdDias
		IF Vvendas[ LNidxDia ] + Vsaldo[ LNidxDia ] > 0
			LNsoma =  LNsoma + Vvendas[ LNidxDia ]
			LNDiasReal = LNDiasReal + 1
		ENDIF
		LNidxDia  = LNidxDia + 1
	ENDDO

    IF LNDiasReal < (INT(LNqtdDias / 4) * 0.7) 	
		LNDiasReal = INT(LNqtdDias / 4)
	ENDIF

    IF LNDiasReal > 0		&& Dias considerados para giro
		LNgiro25 = LNsoma / LNDiasReal
	ELSE
		LNgiro25 = -99
	ENDIF


	DO CASE
			CASE LNgiro100 >= 0 AND LNgiro50 >= 0 AND LNgiro25 >=0
				LNgiro	= (LNgiro100 * 1 + ;
						  LNgiro50 * 1 + ;
						  LNgiro25 * 1) /  3

			CASE LNgiro100 < 0			&& nenhum dia com estoque
				LNgiro  = -1
			OTHERWISE
				LNgiro  = LNgiro100
	ENDCASE


	IF LNgiro = -1 AND Vsaldo[ LNqtdDias  ] = 0	&& NEM GIRO NEM SALDO
		LNgiro = 0
	ENDIF


	*------------------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNgiro)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HYX           IMDadosGiro VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:    8   º
*       º Variable:            IMDadosGiro                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      319                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123hyx     &&  IMDadosGiro VALID
#REGION 11
RETURN

**********************************************************************
*******************************************************************

FUNCTION IMDadosGiro

	LNidxDia = 1
	LNidxData = PrmDt_Inicial
	
	
	DO WHILE LNidxData <= PrmDt_final && VETOR MONTADO EM ORDEM CRESCENTE
									  && DE DATA
	    Vdata[ LNidxDia ] =  LNidxData		
	    VSaldo[ LNidxDia ] =  - 1
		LNidxDia  = LNidxDia + 1
		LNidxData = LNidxData + 1
	ENDDO
	*------------- preenchimento do vetor de saldos  -----------------*

	LNidxDia = 1
	LNidxData = PrmDt_Inicial

	*------------------------------------------------------------------*
	SELE &PBItemmovAlias
	SET ORDER TO  TAG movimento
	=IMPosicItemmov(PrmLoja,PrmCodigo,PrmDt_Inicial)


	DO WHILE &PBItemmovAlias .data < PrmDt_Final AND ;
			 &PBItemmovAlias .empresa = PrmLoja AND ;
			 &PBItemmovAlias .codigo  = PrmCodigo && DESCONSIDERA DATA BASE

		LNidxData  = &PBItemmovAlias .data
		*-------------------------------------------------------------*
		IF LEFT( &PBItemmovAlias .operacao,1) = "S"
			IF  &PBItemmovAlias .movestq = "S"
			    LNsaldo = &PBItemmovAlias .qtde + &PBItemmovAlias .sld_estq
			ELSE
			    LNsaldo = &PBItemmovAlias .sld_estq
			ENDIF			
		ELSE
			IF  &PBItemmovAlias .movestq = "S"
			    LNsaldo = &PBItemmovAlias .sld_estq - &PBItemmovAlias .qtde
			ELSE
			    LNsaldo = &PBItemmovAlias .sld_estq
			ENDIF			
		ENDIF
		*---------------------------------------------------------*

		LNindice = ASCAN(Vdata,LNidxData)
    	VSaldo[ LNindice ]  = LNsaldo
		LNidxData = LNidxData + 1

		*---------------------------------------------------------*
		SELE &PBItemmovAlias
		SET ORDER TO  TAG movimento
		=IMPosicItemmov(PrmLoja,PrmCodigo,LNidxData)
	ENDDO
	*-----------------------------------------------------------------*

	LNidxDia = 1
	LNidxData = PrmDt_Inicial

	*------------------------------------------------------------------*
	SELE &PBItemmovAlias
	SET ORDER TO  TAG movimento
	SET NEAR ON
	SEEK STR(PrmLoja,3)+PrmCodigo+DTOS(PrmDt_Inicial)
	SET NEAR OFF

	DO WHILE &PBItemmovAlias .data < PrmDt_Final AND ;
			 &PBItemmovAlias .empresa = PrmLoja AND ;
			 &PBItemmovAlias .codigo  = PrmCodigo && DESCONSIDERA DATA BASE
		***********************************************************
		*  DESPREZANDO VENDAS P/ CLIENTES => VENDA CASADA
		*          NAO PODEM AFETAR O GIRO
		***********************************************************
		**  QUEBRA POR DATA

	 	LNqtvenda  = 0
		LNqtvdrev  = 0
		LDqbrData  = &PBItemmovAlias .data

		DO WHILE &PBItemmovAlias .data    = LDqbrData AND ;
			     &PBItemmovAlias .empresa = PrmLoja AND ;
			     &PBItemmovAlias .codigo  = PrmCodigo
			     						&& DESCONSIDERA DATA BASE

			IF LEFT( &PBItemmovAlias .operacao,1) = 'S' AND ;
				&PBItemmovAlias .ch_opera = "1" 	  AND ;
				&PBItemmovAlias .negociacao = 2			&& VENDA CASADA
				SELE &PBItemmovAlias
				SKIP
				LOOP
			ENDIF
			***********************************************************
			*  EXISTEM TRATAMENTOS DIFERENCIADOS PARA IDL E AS OUTRAS
			***********************************************************
			DO CASE
				CASE &PBItemmovAlias .empresa = 10
					******************************************************
					*  PARA DETERMINAR QTDE VENDA  E ATEND. P/ NAO REV  *
					*****************************************************
					IF LEFT( &PBItemmovAlias .operacao,1) = 'S'
						IF &PBItemmovAlias .movestq = "S"
						 	LNqtvenda  = LNqtvenda  + &PBItemmovAlias .qtde
						ENDIF
					ENDIF
				OTHERWISE
					******************************************************
					* PARA DETERMINAR QTDE VENDIDA						  *
					******************************************************
					IF LEFT( &PBItemmovAlias .operacao,1) = 'S' AND ;
							 &PBItemmovAlias .ch_opera    = "1"
						IF &PBItemmovAlias .movestq = "S"
						 	LNqtvenda  = LNqtvenda  + &PBItemmovAlias .qtde
						ENDIF
					ENDIF
			ENDCASE

			***********************************************************
			*  ABATENDO DEVOLUCOES
			***********************************************************
			IF LEFT( &PBItemmovAlias .operacao,1) = 'E'  AND ;
					 &PBItemmovAlias .ch_opera    = "4"  AND ;
					 &PBItemmovAlias .movestq     = "S"

		 		LNqtvenda  = LNqtvenda  - &PBItemmovAlias .qtde
			    IF LNqtvenda < 0
	 				LNqtvenda = 0
	 			ENDIF
			ENDIF
			skip
		ENDDO
		LNindice = ASCAN(Vdata,LDqbrData)
    	Vvendas[ LNindice ]  = LNqtvenda

	ENDDO

*-------------------------------------------------------------------*
*----- DISTRIBUICAO DO ESTOQUE  P DIAS Q NA TIVERAM MOVIMENTO -----*
*-------------------------------------------------------------------*
   LNidxDia   = LNqtdDias
   LNsaldoDia=IMGetSaldo(PrmLoja,PrmCodigo,Vdata[ LNidxDia ])


	DO WHILE LNidxDia >= 1
		IF  VSaldo[ LNidxDia ]  = -1
			VSaldo[ LNidxDia ]  = LNsaldoDia
		ENDIF
	   	LNsaldoDia = VSaldo[ LNidxDia ]
		LNidxDia  = LNidxDia - 1
	ENDDO
*-------------------------------------------------------------------*


RETURN




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HZ6           IMGiroControle VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   10   º
*       º Variable:            IMGiroControle                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      320                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123hz6     &&  IMGiroControle VALID
#REGION 11
RETURN

**********************************************************************

FUNCTION IMGiroControle
PARAMETERS PrmOrdIni, PrmOrdFim, PrmControl


	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	LSalias			= ALIAS()
	*------------------------------------------------------------------*
	SET TALK ON
	SELECT GRP.ORDEM,GRP.CODIGO ,GRP.CLASSIFICA,GRP.DESCRICAO,;
	1.000*IMgiroTendenciaLJ(1,GRP.CODIGO, DATE()-100,DATE()) AS GRO_GYN,;
		IMGetSaldo(1,GRP.Codigo, DATE())  AS SLD_GYN, ;
	1.000*IMgiroTendenciaLJ(2,GRP.CODIGO, DATE()-100,DATE()) AS GRO_SIA,;
		IMGetSaldo(2,GRP.Codigo, DATE())   AS SLD_SIA, ;
	1.000*IMgiroTendenciaLJ(3,GRP.CODIGO,DATE()-100,DATE()) AS GRO_W3,;
		IMGetSaldo(3,GRP.Codigo, DATE())   AS SLD_W3, ;
	1.000*IMgiroTendenciaLJ(4,GRP.CODIGO,DATE()-100,DATE()) AS GRO_BGS,;
		IMGetSaldo(4,GRP.Codigo, DATE())   AS SLD_BGS, ;
	1.000*IMgiroTendenciaLJ(5,GRP.CODIGO,DATE()-100,DATE()) AS GRO_IPG,;
		IMGetSaldo(5,GRP.Codigo, DATE())   AS SLD_IPG, ;
	1.000*IMgiroTendenciaLJ(6,GRP.CODIGO,DATE()-100,DATE()) AS GRO_CGB,;
		IMGetSaldo(6,GRP.Codigo, DATE())   AS SLD_CGB, ;
	1.000*IMgiroTendenciaLJ(7,GRP.CODIGO,DATE()-100,DATE()) AS GRO_T63,;
		IMGetSaldo(7,GRP.Codigo, DATE())   AS SLD_T63, ;
	1.000*IMgiroTendenciaLJ(8,GRP.CODIGO,DATE()-100,DATE()) AS GRO_ARG,;
		IMGetSaldo(8,GRP.Codigo, DATE())   AS SLD_ARG, ;
	1.000*IMgiroTendenciaLJ(9,GRP.CODIGO,DATE()-100,DATE()) AS GRO_IDP,;
		IMGetSaldo(9,GRP.Codigo, DATE())   AS SLD_IDP, ;
	1.000*IMgiroTendenciaLJ(11,GRP.CODIGO,DATE()-100,DATE()) AS GRO_DPO,;
		IMGetSaldo(11,GRP.Codigo, DATE())   AS SLD_DPO, ;
	1.000*IMgiroTendenciaLJ(14,GRP.CODIGO,DATE()-100,DATE()) AS GRO_ANP,;
		IMGetSaldo(14,GRP.Codigo, DATE())   AS SLD_ANP, ;
	1.000*IMgiroTendenciaLJ(10,GRP.CODIGO,DATE()-100,DATE()) AS GRO_IDL, ;
		IMGetSaldo(10,GRP.Codigo, DATE())   AS SLD_IDL ;
    FROM Q:\SCGC\COMUM\GRUPO GRP;
   	WHERE GRP.ORDEM >= PrmOrdIni AND GRP.ORDEM <= PrmOrdFim  ;
			 AND STR(GRP.tp_control,1) $ PrmControl ;
			 AND GRP.cdg_tipo  = 4 ;
			 AND ;
			 	  (;
			 	  	(!(LEFT(GRP.classifica,02) $ "00/01") AND ;
	             	 !(LEFT(GRP.classifica,05) $ "04042") ;
	              	);
				  OR ;			
			 	    ( (LEFT(GRP.classifica,02) $ "00/01" OR ;
	             	 LEFT(GRP.classifica,05) $ "04042") AND ;
	              	 GRP.codforn = 1;
	              	);
	              );
   	INTO CURSOR TMPGRO1 ;
   	ORDER BY ORDEM

	SELECT TMPGRO1.*, ;
		IMDura((sld_gyn+sld_DPO),gro_gyn)  AS dura_gyn,;
		IMDura(sld_sia,gro_sia)  AS dura_sia,;
		IMDura(sld_w3 ,gro_w3 )  AS dura_w3 ,;
		IMDura(sld_bgs,gro_bgs)  AS dura_bgs,;
		IMDura(sld_ipg,gro_ipg)  AS dura_ipg,;
		IMDura(sld_cgb,gro_cgb)  AS dura_cgb,;
		IMDura(sld_arg,gro_arg)  AS dura_arg,;
		IMDura(sld_anp,gro_anp)  AS dura_anp,;
		IMDura(sld_idp,gro_idp)  AS dura_idp,;
		IMDura(sld_T63,gro_T63)  AS dura_T63,;
		IMDura(0,0)        AS dura_DPO,;
		IMDura(sld_idl,gro_idl)  AS dura_idl;
	FROM TMPGRO1 ;
   	INTO CURSOR TMPGRO2 ;
    ORDER BY ORDEM
	SET TALK OFF
	

RETURN("TMPGRO2")


FUNCTION IMDura
PARAMETERS PrmSaldo,PrmGiro
Private LNDura
	DO CASE
		CASE PrmGiro = 0
			IF PrmSaldo > 0
				LNDura   = 999
			ELSE
				LNDura   = 0
			ENDIF		
		OTHERWISE
			IF PrmSaldo > 0
				LNDura   = PrmSaldo / PrmGiro
				IF LNDura > 999
					LNDura   = 999
				ENDIF				
			ELSE
				LNDura   = 0
			ENDIF
	ENDCASE
RETURN(LNDura)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HZC           IMGetVlrEstq VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   11   º
*       º Variable:            IMGetVlrEstq                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      321                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hzc     &&  IMGetVlrEstq VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMGetVlrEstq
PARAMETERS PrmEmp, PrmCodigo, PrmData, PrmHora

	=W_DEFPROC("ROTINAS.SPR")

	PRIVATE LNVlrEstq
	PRIVATE LSalias
	LSalias		= 	ALIAS()
	IF TYPE("PrmHora") <> "C"
	    PrmHora = "99:99:99"
	ENDIF

	=IMVerifyInst()
	*----------------------------------------------------------------*
	SELE &PBItemmovAlias
	SET ORDER TO TAG movimento
	SET NEAR ON
	SEEK STR(PrmEmp,3)+PrmCodigo+dtos(PrmData)+PrmHora
										&& POSICIONA A FRENTE PARA
										&& VOLTAR E PEGAR SALDO DE
										&& FECHAMENTO OU ATUAL DO DIA
	SET NEAR OFF
	IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
		=W_DEFPROC("SALDO.SPR")
		LNVlrEstq = SLGetVlrEstq(PrmEmp, PrmData, PrmCodigo)
	ELSE
		SKIP -1
		IF BOF() OR PrmCodigo <> &PBItemmovAlias .codigo ;
			 	 OR PrmEmp    <> &PBItemmovAlias .empresa
			=W_DEFPROC("SALDO.SPR")
			LNVlrEstq = SLGetVlrEstq(PrmEmp, PrmData, PrmCodigo)
		ELSE
	    	IF &PBItemmovAlias .sld_estq = 0
	    		LNVlrEstq   = 0
	    	ELSE
				LNVlrEstq   =	&PBItemmovAlias .vlr_estq
			ENDIF
		ENDIF
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNVlrEstq)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HZG           IMPosicItemmov VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   12   º
*       º Variable:            IMPosicItemmov                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      322                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _2wz123hzg     &&  IMPosicItemmov VALID
#REGION 11
RETURN

**********************************************************************
*******************************************************************

FUNCTION IMPosicItemmov
PARAMETERS PrmLoja,PrmCodigo,PrmData

	*------------------------------------------------------------------*
	SELE &PBItemmovAlias
	SET ORDER TO  TAG movimento
	SET NEAR ON
	SEEK STR(PrmLoja,3)+PrmCodigo+DTOS(PrmData+1)
	SET NEAR OFF

	IF  &PBItemmovAlias .data <> PrmDt_Final OR  ;
	    &PBItemmovAlias .empresa <> PrmLoja OR ;
		&PBItemmovAlias .codigo  <> PrmCodigo
		skip -1
	endif
	IF  &PBItemmovAlias .data < PrmData
		skip
	endif
	
RETURN




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HZJ           IMVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   14   º
*       º Variable:            IMVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      323                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hzj     &&  IMVerifyInst VALID
#REGION 11
return
*---------------------------------------------------------------*



FUNCTION IMVerifyInst
PRIVATE LSpath

	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("ITEMMOV")


	DO CASE

		CASE TYPE("PBItemMovAlias") = "U" ;
		   		OR EMPTY(PBItemMovAlias) ;
		   		OR !USED(PBItemMovAlias)
			=IMCreate()					

		CASE !("ITEMMOV.DBF" $ DBF(PBItemMovAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBItemMovAlias
			=IMCreate()					


		CASE  !(LSPath $ DBF(PBItemMovAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=IMDestroi()				
			=IMCreate()					
	ENDCASE
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HZN           IMCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   15   º
*       º Variable:            IMCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      324                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hzn     &&  IMCreate VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBItemMovAlias") <> "U" ;
	   		AND !EMPTY(PBItemMovAlias) ;
	   		AND USED(PBItemMovAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBItemMovAlias

	IF USED("ItemMov")
	     =NetArqAgain("ItemMov")
	     PBItemMovAlias     = Alias()
	ELSE
	     =NetArqAgain("ItemMov")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("ItemMov")
	     PBItemMovAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBItemMovAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTItemMov[LMaxDim]
    PUBLIC DIMENSION VDItemMov[2,3]			&& VETOR PARA PROPRIEDADES
	*-----------------------------------------------------------*
	=IMReadProperty()
	=IMSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HZO           IMDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   16   º
*       º Variable:            IMDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      325                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hzo     &&  IMDestroi VALID
#REGION 11
return
*---------------------------------------------------------------*


FUNCTION IMDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBItemMovAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBDocFiscaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBDocFiscaAlias
	*  3- Se aplicar um FECHAMENTO a PBDocFiscaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBDocFiscaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBItemMovAlias)) OR ;
	   !("ITEMMOV.DBF" $ DBF(PBItemMovAlias))

		RELEASE PBItemMovAlias
    	RELEASE VTItemMov
	    RELEASE VDItemMov
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBItemMovAlias) AND USED(PBItemMovAlias)
		SELECT &PBItemMovAlias
		USE
	ENDIF	
	RELEASE PBItemMovAlias
    RELEASE VTItemMov
    RELEASE VDItemMov

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HZP           IMReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   17   º
*       º Variable:            IMReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      326                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hzp     &&  IMReadProp VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=IMVerifyInst()

	SELE &PBItemMovAlias
	SCATTER TO VTItemMov
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HZQ           IMSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   18   º
*       º Variable:            IMSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      327                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hzq     &&  IMSetDerivadas VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	=IMVerifyInst()
	*--------------------------------------------------------------*
    VDItemMov(1,1) = "NAOINFORMADO"
   	VDItemMov(1,2) = 0
   	VDItemMov(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HZR           IMSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   19   º
*       º Variable:            IMSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      328                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hzr     &&  IMSetPropVT VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=IMVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,PrmValue,;
						    PBItemMovAlias,VTItemMov,VDItemMov)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HZS           IMGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   20   º
*       º Variable:            IMGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      329                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hzs     &&  IMGetPropVT VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=IMVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,PBItemMovAlias,VTItemMov,VDItemMov)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HZT           IMChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   21   º
*       º Variable:            IMChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      330                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hzt     &&  IMChk_Identidade VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION IMChk_Identidade
PARAMETERS 	PrmEmp, ;
			PrmCodigo,;
			PrmData,;
			PrmHora,;
			PrmTipo,;
			PrmNota,;
			PrmOrdem

	PRIVATE LFretorno
	LFretorno = .t.

	=IMVerifyInst()
	*----------------------------------------------------------------*

    =IMSetPropVT("EMPRESA",PrmEmp)
    =IMSetPropVT("CODIGO",PrmCodigo)
    =IMSetPropVT("DATA",PrmData)
    =IMSetPropVT("HORA",PrmHora)
    =IMSetPropVT("TIPO",PrmTipo)
    =IMSetPropVT("NOTA",PrmNota)
    =IMSetPropVT("ORDEM",PrmOrdem)
	LFretorno=IMFind()
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123HZU           IMFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   22   º
*       º Variable:            IMFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      331                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123hzu     &&  IMFind VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMFind
	PRIVATE LEmp, LCodigo,LData,LHora,LTipo,LNota,;
			LOrdem
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=IMVerifyInst()

	LEmp 		 = IMGetPropVT("EMPRESA")
	LCodigo	 	 = IMGetPropVT("CODIGO")
	LData  	 	 = IMGetPropVT("DATA")
	LHora  	 	 = IMGetPropVT("HORA")
	LTipo   	 = IMGetPropVT("TIPO")
	LNota        = IMGetPropVT("NOTA")
	LOrdem       = IMGetPropVT("ORDEM")

	SELE &PBItemmovAlias
	SET ORDER TO TAG MOVIMENTO
	SEEK STR(LEmp,3)+Lcodigo+DTOS(Ldata)+;
			Lhora+Ltipo+STR(Lnota,7)+STR(Lordem,3)
	IF FOUND()
		=IMReadProperty()
		=IMSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I0F           IMGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   23   º
*       º Variable:            IMGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      332                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i0f     &&  IMGetFieldValue VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMGetFieldValue
PARAMETERS 	PrmEmp, ;
			PrmCodigo,;
			PrmData,;
			PrmHora,;
			PrmTipo,;
			PrmNota,;
			PrmOrdem,;
			PrmField

	=IMChk_Identidade(;
			PrmEmp, ;
			PrmCodigo,;
			PrmData,;
			PrmHora,;
			PrmTipo,;
			PrmNota,;
			PrmOrdem)

RETURN(IMGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I0J           IM_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   24   º
*       º Variable:            IM_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      333                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i0j     &&  IM_Refresh VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION IMChk_Identidade
PARAMETERS 	PrmEmp, ;
			PrmCodigo,;
			PrmData,;
			PrmHora,;
			PrmTipo,;
			PrmNota,;
			PrmOrdem

	PRIVATE LFretorno
	LFretorno = .t.

	=IMVerifyInst()
	*----------------------------------------------------------------*

    =IMSetPropVT("EMPRESA",PrmEmp)
    =IMSetPropVT("CODIGO",PrmCodigo)
    =IMSetPropVT("DATA",PrmData)
    =IMSetPropVT("HORA",PrmHora)
    =IMSetPropVT("TIPO",PrmTipo)
    =IMSetPropVT("NOTA",PrmNota)
    =IMSetPropVT("ORDEM",PrmOrdem)
	LFretorno=IMFind()
RETURN(LFretorno)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I0O           IMLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   26   º
*       º Variable:            IMLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      334                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i0o     &&  IMLerRegistro VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION IMLerRegistro
PARAMETERS 	PrmEmp, ;
			PrmCodigo,;
			PrmData,;
			PrmHora,;
			PrmTipo,;
			PrmNota,;
			PrmOrdem



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = IMChk_Identidade(;
	 		PrmEmp, ;
			PrmCodigo,;
			PrmData,;
			PrmHora,;
			PrmTipo,;
			PrmNota,;
			PrmOrdem)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I0R           IMWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   27   º
*       º Variable:            IMWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      335                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i0r     &&  IMWriteProp VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=IMVerifyInst()

	SELE &PBItemMovAlias
	=RLOCK()
	GATHER FROM  VTItemMov
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I0V           IMSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   28   º
*       º Variable:            IMSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      336                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i0v     &&  IMSalvarRegistro VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION IMSalvarRegistro

	=IMVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !IMExiste()
		SELE &PBItemMovAlias
		APPEND BLANK
		LFretorno=IMWriteProp()
	ELSE
		SELE &PBItemMovAlias
		LFretorno=IMWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I0Y           IMExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   29   º
*       º Variable:            IMExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      337                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i0y     &&  IMExiste VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMExiste


	PRIVATE LEmp, ;
			LCodigo,;
			LData,;
			LHora,;
			LTipo,;
			LNota,;
			LOrdem
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=IMVerifyInst()

	LEmp        = IMGetPropVT("Empresa")
	LCodigo     = IMGetPropVT("Codigo")
	LData       = IMGetPropVT("Data")
	LHora       = IMGetPropVT("Hora")
	LTipo       = IMGetPropVT("Tipo")
	LNota       = IMGetPropVT("Nota")
	LOrdem      = IMGetPropVT("Ordem")


	SELE &PBItemmovAlias
	SET ORDER TO TAG MOVIMENTO
	SEEK STR(LEmp,3)+Lcodigo+DTOS(Ldata)+;
			Lhora+Ltipo+STR(Lnota,7)+STR(Lordem,3)

	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I12           IMGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   31   º
*       º Variable:            IMGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      338                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i12     &&  IMGetAlias VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMGetAlias

	=IMVerifyInst()

RETURN(PBItemMovAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I15           IMFaxinaDados VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ITEMMOV,     Record Number:   32   º
*       º Variable:            IMFaxinaDados                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      339                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i15     &&  IMFaxinaDados VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION IMFaxinaDados

	PRIVATE LSAlias, TOTAL, CTR
	=IMVerifyInst()

	LSAlias = IMGetAlias()
	
	SELE &LSAlias

	COUNT TO TOTAL
	CTR = 0

	GO TOP
	DO WHILE !EOF()
		=RLOCK()


		CTR = 	CTR + 1
		MSG = STR(CTR,7)+" DE "+STR(TOTAL,7)
		WAIT WINDOW MSG NOWAIT


		REPLACE DESCRICAO  WITH UPLimpaString(DESCRICAO)


		SKIP
	ENDDO
	


RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I19           GRGetClassifica VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:    2     º
*       º Variable:            GRGetClassifica                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      340                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i19     &&  GRGetClassifica VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRGetClassifica
PARAMETERS PrmCodigo

	=GRChk_Identidade(PrmCodigo)

RETURN(GRGetPropVT("CLASSIFICA"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I1A           GRGetPeso VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:    3     º
*       º Variable:            GRGetPeso                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      341                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i1a     &&  GRGetPeso VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRGetPeso
PARAMETERS PrmCodigo

	=GRChk_Identidade(PrmCodigo)

RETURN(GRGetPropVT("PESO"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I1B           ver_Prod VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:    4     º
*       º Variable:            ver_Prod                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      342                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i1b     &&  ver_Prod VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*


FUNCTION GRLoc_Prod
PARAMETERS LScod,LNkey,LScondBrow
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Localizar um codigo
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite localizar um codigo informado
	*			ou fazer localizacao em tabela BROWSE conform
	*			condicao browse repassada e retornar .f. ou .t.
	*			e o registro posicionado do arq. GRUPO para ser
	*			tratado na rotina camadora
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LScod..........: Codigo do Produto que se quer localizar
	*		LNkey..........: Tecla de encerramento no campo de chamada
	*						EXEMPLO <TAB> = 9
	*		LScondBrow.....: Condicao de filtragem do browse (parametro
	*						 repassado para LOC_DLOG
	*------------------------------------------------------------*
	*  RETORNO.....:- REGISTRO DO PRODUTO POSICIONADO para
	*					ser tratado na rotina
	*				- .F. Para codigo nao localizado
	*				- .T. Para codigo Localizado
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC407.SCR
	*
	*	=W_DEFPROC("grupo.spr")
	*	LNkey 	= LASTKEY()
	*	LScond_Brows = ".T."
	*	wl_tmp =  STRTRAN(STR(wp_empresa,3),' ','0')
	*	LScond_Brows	= ".T.,  '&wl_tmp'  $  empresas"
	*	IF !GRLoc_Prod(m.codigo,LNkey, LScond_Brows )
	*	    ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	*	    RETURN .F.
	*	ENDIF
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFgrupo
	PRIVATE LFretorno

	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	LFgrupo		= NetArq("grupo")
	IF (LFgrupo) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("grupo" ,LFgrupo)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	*-----------------------------------------------------------*
	SELECT grupo
	SET ORDER TO TAG codigo
	IF LNkey = 9
	   	DO loc_dlog WITH &LScondBrow
	   	LScod	  = grupo.codigo
	   	IF LASTKEY() <> 27
			LScod = grupo.codigo
		ENDIF	
	ENDIF
	*-----------------------------------------------------------*
   	IF LASTKEY() <> 27
		SET NEAR ON
		SEEK LScod
		SET NEAR OFF
	ENDIF
   	IF LASTKEY() = 27 OR !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LFretorno = .F.
	ELSE
		LFretorno = .T.
	ENDIF
	=UP_fecha("grupo" ,LFgrupo)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	*--------------------------------------------------------------*
	POP KEY 	&& reabilita teclas de atalho def. anteriormente
RETURN(LFretorno)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I1C           GRGetOrigem VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:    5     º
*       º Variable:            GRGetOrigem                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      343                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i1c     &&  GRGetOrigem VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRGetOrigem
PARAMETERS PrmCodigo

	=GRChk_Identidade(PrmCodigo)

RETURN(GRGetPropVT("ORIGEM"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I1D           GRVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:    7     º
*       º Variable:            GRVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      344                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i1d     &&  GRVerifyInst VALID
#REGION 12
return
*---------------------------------------------------------------*



FUNCTION GRVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("GRUPO")


	DO CASE

		CASE TYPE("PBGrupoAlias") = "U" ;
		   		OR EMPTY(PBGrupoAlias) ;
		   		OR !USED(PBGrupoAlias)
			=GRCreate()					

		CASE !("GRUPO.DBF" $ DBF(PBGrupoAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBGrupoAlias
			=GRCreate()					


		CASE  !(LSPath $ DBF(PBGrupoAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=GRDestroi()				
			=GRCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I1E           GRCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:    8     º
*       º Variable:            GRCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      345                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i1e     &&  GRCreate VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBGrupoAlias") <> "U" ;
	   		AND !EMPTY(PBGrupoAlias) ;
	   		AND USED(PBGrupoAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBGrupoAlias

	IF USED("Grupo")

	     =NetArqAgain("Grupo")
	     PBGrupoAlias     = Alias()

	ELSE

	     =NetArqAgain("Grupo")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Grupo")
	     PBGrupoAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF

	ENDIF	

    SELE &PBGrupoAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTGrupo[LMaxDim]
    PUBLIC DIMENSION VDGrupo[2,3]			&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFGrupo[1]      && VETOR CABECALHO DOS CAMPOS
    PUBLIC DIMENSION VCGrupo[8,3]	&& VETOR PARA CONFIGURACOES

	=AFIELDS(VFGrupo)

	*-----------------------------------------------------------*
	=GRReadProperty()
	=GRSetDerivadas()
	=GRSetConfig()
	*-----------------------------------------------------------*
	
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I1F           GRDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:    9     º
*       º Variable:            GRDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      346                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i1f     &&  GRDestroi VALID
#REGION 12
return
*---------------------------------------------------------------*


FUNCTION GRDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBGrupoAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBDocFiscaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBDocFiscaAlias
	*  3- Se aplicar um FECHAMENTO a PBDocFiscaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBDocFiscaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBGrupoAlias)) OR ;
	   !("GRUPO.DBF" $ DBF(PBGrupoAlias))

		RELEASE PBGrupoAlias
    	RELEASE VTGrupo
	    RELEASE VDGrupo
	    RELEASE VFGrupo
	    RELEASE VCGrupo
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBGrupoAlias) AND USED(PBGrupoAlias)
		SELECT &PBGrupoAlias
		USE
	ENDIF	
	RELEASE PBGrupoAlias
    RELEASE VTgrupo
    RELEASE VDGrupo
    RELEASE VFGrupo
    RELEASE VCGrupo

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I21           GRReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   10     º
*       º Variable:            GRReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      347                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i21     &&  GRReadProp VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBGrupoAlias
	SCATTER TO VTGrupo
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I24           GRSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   11     º
*       º Variable:            GRSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      348                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i24     &&  GRSetDerivadas VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRSetDerivadas
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=GRVerifyInst()
	*--------------------------------------------------------------*
    VDGrupo(1,1) = "NAOINFORMADO"
   	VDGrupo(1,2) = 0
   	VDGrupo(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I27           GRSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   12     º
*       º Variable:            GRSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      349                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i27     &&  GRSetPropVT VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBGrupoAlias,;
						    VTGrupo,;
						    VDGrupo,;
						    VFGrupo,;
						    VCGrupo)


RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2B           GRGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   13     º
*       º Variable:            GRGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      350                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2b     &&  GRGetPropVT VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")

	Lvalue = RTgetValueObj(PrmField,;
						    PBGrupoAlias,;
						    VTGrupo,;
						    VDGrupo,;
						    VFGrupo,;
						    VCGrupo)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2E           GRChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   14     º
*       º Variable:            GRChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      351                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2e     &&  GRChk_Identidade VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION GRChk_Identidade
PARAMETERS PrmCodigo

	PRIVATE LFretorno
	LFretorno = .t.


	=GRVerifyInst()
    =GRSetPropVT("CODIGO",PrmCodigo)
	LFretorno=GRFind()

RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2I           GRFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   15     º
*       º Variable:            GRFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      352                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2i     &&  GRFind VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRFind
	PRIVATE LCodigo
	PRIVATE LFreturn
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=GRVerifyInst()
	LCodigo     = GRGetPropVT("CODIGO")

	SELE &PBGrupoAlias
	SET ORDER TO TAG CODIGO
	SEEK LCodigo

	IF FOUND()
		=GRReadProperty()
		=GRSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE

	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2L           GRGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   16     º
*       º Variable:            GRGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      353                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2l     &&  GRGetFieldValue VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRGetFieldValue
PARAMETERS  PrmCodigo, PrmField


	IF !GRChk_Identidade(PrmCodigo)
		DO WHILE .T.
			=UPerrosys("Chamada GetFieldValue para Reg. Inexistente!")
		ENDDO
	ENDIF				


RETURN(GRGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2O           GR_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   17     º
*       º Variable:            GR_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      354                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2o     &&  GR_Refresh VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION GR_Refresh
PARAMETERS PrmCodigo
			
	
	


	PRIVATE LFreturn

	=GRVerifyInst()


	= GRSetPropVT("Codigo"   ,PrmCodigo)
	*----------------------------------------------------------------*


	=GRFind()
	
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2R           GRLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   19     º
*       º Variable:            GRLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      355                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2r     &&  GRLerRegistro VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION GRLerRegistro
PARAMETERS  PrmCodigo



	PRIVATE LFretorno
	LFretorno = .t.
	LFretorno = GRChk_Identidade(PrmCodigo)

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2S           GRWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   20     º
*       º Variable:            GRWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      356                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2s     &&  GRWriteProp VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=GRVerifyInst()

	SELE &PBGrupoAlias
	=RLOCK()
	GATHER FROM  VTGrupo
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2T           GRSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   21     º
*       º Variable:            GRSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      357                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2t     &&  GRSalvarRegistro VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION GRSalvarRegistro

	=GRVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !GRExiste()
		SELE &PBGrupoAlias
		APPEND BLANK
		LFretorno=GRWriteProp()
	ELSE
		SELE &PBGrupoAlias
		LFretorno=GRWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2U           GRExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   22     º
*       º Variable:            GRExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      358                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2u     &&  GRExiste VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRExiste

	PRIVATE LCodigo

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=GRVerifyInst()

	LCodigo    = GRGetPropVT("Codigo")


	SELE &PBGrupoAlias
	SET ORDER TO TAG codigo
	SEEK LCodigo

	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2V           GRGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   24     º
*       º Variable:            GRGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      359                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2v     &&  GRGetAlias VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRGetAlias

	=GRVerifyInst()

RETURN(PBGrupoAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2W           GRTrtChave VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   25     º
*       º Variable:            GRTrtChave                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      360                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2w     &&  GRTrtChave VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*


FUNCTION GRTrtChave
PARAMETERS PrmCodigo

	PRIVATE LFretorno
	LFretorno = .t.

	=MNVerifyInst()


	=GRVerifyInst()
    =GRSetPropVT("CODIGO",PrmCodigo)
	LFretorno=GRFind()
	*--------------------------------------------------------------*

	LFretorno=GRFind()

	SELE &PBGrupoAlias

RETURN(UPtratachv())





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2X           GRSetConfig VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   26     º
*       º Variable:            GRSetConfig                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      361                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2x     &&  GRSetConfig VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRSetConfig

	*--------------------------------------------------------------*
    VCGrupo(1,1) = "REG_STATE" && INSERT/EDICAO/BROWSER/
   	VCGrupo(1,2) = ""
   	VCGrupo(1,3) = .T.
	*--------------------------------------------------------------*
    VCGrupo(2,1) = "CHV_LER" && p/ leitura do ultimo reg + 1
   	VCGrupo(2,2) = ""
   	VCGrupo(2,3) = .T.
	*--------------------------------------------------------------*
    VCGrupo(3,1) = "CHV_COMPARA" && p/ leitura do ultimo reg + 1
   	VCGrupo(3,2) = ""
   	VCGrupo(3,3) = .T.
	*--------------------------------------------------------------*
    VCGrupo(4,1) = "CHV_BROW" && p/ leitura do ultimo reg + 1
   	VCGrupo(4,2) = ""
   	VCGrupo(4,3) = .T.
	*--------------------------------------------------------------*
    VCGrupo(5,1) = "ISEDITING" && p/ leitura do ultimo reg + 1
   	VCGrupo(5,2) = .F.
   	VCGrupo(5,3) = .T.
	*--------------------------------------------------------------*
    VCGrupo(6,1) = "ISADDING" && p/ leitura do ultimo reg + 1
   	VCGrupo(6,2) = .F.
   	VCGrupo(6,3) = .T.
	*--------------------------------------------------------------*
    VCGrupo(7,1) = "ISREADING" && p/ leitura do ultimo reg + 1
   	VCGrupo(7,2) = .F.
   	VCGrupo(7,3) = .T.
	*--------------------------------------------------------------*
    VCGrupo(8,1) = "CHAVE DE LEITURA" && TAG DO CHAVE USADA EM FIND
   	VCGrupo(8,2) = "CODIGO"
   	VCGrupo(8,3) = .T.
	*--------------------------------------------------------------*
	
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I2Y           GRGetNomeFab VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   27     º
*       º Variable:            GRGetNomeFab                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      362                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i2y     &&  GRGetNomeFab VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRGetNomeFab
PARAMETERS PrmCodigo

	=GRChk_Identidade(PrmCodigo)

RETURN("")


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I3J           GRGetCodPrdNoFab VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   28     º
*       º Variable:            GRGetCodPrdNoFab                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      363                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i3j     &&  GRGetCodPrdNoFab VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRGetCodPrdNoFab
PARAMETERS PrmCodigo

	=GRChk_Identidade(PrmCodigo)

RETURN("")


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I3L           GRFaxinaDados VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRUPO,     Record Number:   29     º
*       º Variable:            GRFaxinaDados                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      364                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i3l     &&  GRFaxinaDados VALID
#REGION 12
return
*---------------------------------------------------------------*

FUNCTION GRFaxinaDados

	PRIVATE LSAlias, TOTAL, CTR
	=GRVerifyInst()

	LSAlias = GRGetAlias()
	
	SELE &LSAlias

	COUNT TO TOTAL
	CTR = 0

	GO TOP
	DO WHILE !EOF()
		=RLOCK()


		CTR = 	CTR + 1
		MSG = STR(CTR,7)+" DE "+STR(TOTAL,7)
		WAIT WINDOW MSG NOWAIT


		REPLACE DESCRICAO WITH ;
		   UPLimpaString(DESCRICAO)

		IF EMPTY(UNIDADE)
			REPLACE UNIDADE  WITH "UN"
		ENDIF
		
		SKIP
	ENDDO
	


RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I3P           TPVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:    3  º
*       º Variable:            TPVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      365                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i3p     &&  TPVerifyInst VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION TPVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("TipoOper")


	DO CASE

		CASE TYPE("PBTipoOperAlias") = "U" ;
		   		OR EMPTY(PBTipoOperAlias) ;
		   		OR !USED(PBTipoOperAlias)
			=TPCreate()					

		CASE !("TIPOOPER.DBF" $ DBF(PBTipoOperAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBTipoOperAlias
			=TPCreate()					


		CASE  !(LSPath $ DBF(PBTipoOperAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=TPDestroi()				
			=TPCreate()					
	ENDCASE

	
RETURN(.t.)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I3T           TPCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:    4  º
*       º Variable:            TPCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      366                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i3t     &&  TPCreate VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION TPCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBTipoOperAlias") <> "U" ;
	   		AND !EMPTY(PBTipoOperAlias) ;
	   		AND USED(PBTipoOperAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBTipoOperAlias

	IF USED("TipoOper")
	     =NetArqAgain("TipoOper")
	     PBTipoOperAlias     = Alias()
	ELSE
	     =NetArqAgain("TipoOper")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("TipoOper")
	     PBTipoOperAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBTipoOperAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTTipoOper[LMaxDim]&& VETOR PARA CAMPOS DA TABELA
    PUBLIC DIMENSION VDTipoOper[2,3]	&& VETOR PARA CAMPOS DERIVADAS
    PUBLIC DIMENSION VFTipoOper[1]      && VETOR CABECALHO DOS CAMPOS
    PUBLIC DIMENSION VCTipoOper[8,3]	&& VETOR PARA CONFIGURACOES


	=AFIELDS(VFTipoOper)



	*-----------------------------------------------------------*
	=TPReadProperty()
	=TPSetDerivadas()
	=TPSetConfig()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I3Y           TPDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:    5  º
*       º Variable:            TPDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      367                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i3y     &&  TPDestroi VALID
#REGION 13
return
*---------------------------------------------------------------*


FUNCTION TPDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBTipoOperAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBTipoOperAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBTipoOperAlias
	*  3- Se aplicar um FECHAMENTO a PBTipoOperAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBTipoOperAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBTipoOperAlias)) OR ;
	   !("TIPOOPER.DBF" $ DBF(PBTipoOperAlias))

		RELEASE PBTipoOperAlias
    	RELEASE VTTipoOper
	    RELEASE VDTipoOper
		RELEASE VFTipoOper
		RELEASE VCTipoOper
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBTipoOperAlias) AND USED(PBTipoOperAlias)
		SELECT &PBTipoOperAlias
		USE
	ENDIF	
	RELEASE PBTipoOperAlias
    RELEASE VTTipoOper
    RELEASE VDTipoOper
	RELEASE VFTipoOper
	RELEASE VCTipoOper

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I42           TPReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:    6  º
*       º Variable:            TPReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      368                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i42     &&  TPReadProp VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION TPReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBTipoOperAlias
	SCATTER TO VTTipoOper
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I45           TPSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:    7  º
*       º Variable:            TPSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      369                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i45     &&  TPSetDerivadas VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION TPSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDTipoOper(1,1) = "NAOINFORMADO"	&& TITULO	
   	VDTipoOper(1,2) = 0					&& VALOR
   	VDTipoOper(1,3) = .F.				&& FLAG .T. => FOI CARREGADO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I48           TPSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:    8  º
*       º Variable:            TPSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      370                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i48     &&  TPSetPropVT VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION TPSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBTipoOperAlias,;
						    VTTipoOper,;
						    VDTipoOper,;
						    VFTipoOper,;
						    VCTipoOper)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I49           TPGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:    9  º
*       º Variable:            TPGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      371                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i49     &&  TPGetPropVT VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION TPGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBTipoOperAlias,;
	            VTTipoOper,;
	            VDTipoOper,;
			    VFTipoOper,;
			    VCTipoOper)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I4A           TPChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   10  º
*       º Variable:            TPChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      372                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i4a     &&  TPChk_Identidade VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TPChk_Identidade
PARAMETERS  ;
			PrmProcesso,;
			PrmTipo


	PRIVATE LFretorno
	LFretorno = .t.



	=TPVerifyInst()
    =TPSetPropVT("PROCESSO",PrmProcesso)
    =TPSetPropVT("TIPO",PrmTipo)


	LFretorno=TPFind()
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I4B           TPFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   11  º
*       º Variable:            TPFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      373                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i4b     &&  TPFind VALID
#REGION 13
return
*---------------------------------------------------------------*
FUNCTION TPFind

	PRIVATE LProcesso,;
			LTipo
	PRIVATE LSchaveAcesso
			

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=TPVerifyInst()



	SELE &PBTipoOperAlias
	LSchaveAcesso  =TPGetPropVT("CHAVE DE LEITURA")


	DO CASE
		CASE UPPER(LSchaveAcesso) = " OPCAO A IMPLEMENTAR QDO NECESSARIO"
			LSchaveAcesso = " OPCAO A IMPLEMENTAR QDO NECESSARIO"

		OTHERWISE
			LProcesso   = TPGetPropVT("Processo")
			LTipo       = TPGetPropVT("Tipo")

			SET ORDER TO TAG TIPO
			SEEK LProcesso+LTipo
	ENDCASE

	
	IF FOUND()
		=TPReadProperty()
		=TPSetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I4C           TPGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   12  º
*       º Variable:            TPGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      374                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i4c     &&  TPGetFieldValue VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION TPGetFieldValue
PARAMETERS  PrmProcesso,;
            PrmTipo,;
            PrmField

	=TPChk_Identidade(PrmProcesso,;
					  PrmTipo)

RETURN(TPGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I4D           TP_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   13  º
*       º Variable:            TP_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      375                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i4d     &&  TP_Refresh VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*




FUNCTION TP_Refresh
PARAMETERS  ;
			PrmProcesso,;
			PrmTipo

	PRIVATE LFretorno
	LFretorno = .t.



	=TPVerifyInst()
    =TPSetPropVT("PROCESSO",PrmProcesso)
    =TPSetPropVT("TIPO",PrmTipo)


	LFretorno=TPFind()
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I4E           TPLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   15  º
*       º Variable:            TPLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      376                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i4e     &&  TPLerRegistro VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*


FUNCTION TPLerRegistro
PARAMETERS  PrmProcesso,PrmTipo


	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = TPChk_Identidade(PrmProcesso,PrmTipo)
RETURN(LFretorno)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I4F           TPWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   16  º
*       º Variable:            TPWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      377                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i4f     &&  TPWriteProp VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION TPWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBTipoOperAlias
	=RLOCK()
	GATHER FROM  VTTipoOper
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I50           TPSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   17  º
*       º Variable:            TPSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      378                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i50     &&  TPSalvarRegistro VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TPSalvarRegistro

	=TPVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !TPExiste()
		SELE &PBTipoOperAlias
		APPEND BLANK
		LFretorno=TPWriteProp()
	ELSE
		SELE &PBTipoOperAlias
		LFretorno=TPWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I54           TPExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   18  º
*       º Variable:            TPExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      379                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i54     &&  TPExiste VALID
#REGION 13
return

*---------------------------------------------------------------*

FUNCTION TPExiste


	PRIVATE LProcesso,;
			LTipo
	PRIVATE LSchaveAcesso
			

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=TPVerifyInst()



	SELE &PBTipoOperAlias
	LSchaveAcesso  =TPGetPropVT("CHAVE DE LEITURA")


	DO CASE
		CASE UPPER(LSchaveAcesso) = " OPCAO A IMPLEMENTAR QDO NECESSARIO"
			LSchaveAcesso = " OPCAO A IMPLEMENTAR QDO NECESSARIO"

		OTHERWISE
			LProcesso   = TPGetPropVT("Processo")
			LTipo       = TPGetPropVT("Tipo")

			SET ORDER TO TAG TIPO
			SEEK LProcesso+LTipo
	ENDCASE

	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I58           TPGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   19  º
*       º Variable:            TPGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      380                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i58     &&  TPGetAlias VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION TPGetAlias

	=TPVerifyInst()

RETURN(PBTipoOperAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I5B           TPSetConfig VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   20  º
*       º Variable:            TPSetConfig                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      381                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i5b     &&  TPSetConfig VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION TPSetConfig

	*--------------------------------------------------------------*
    VCTipoOper(1,1) = "REG_STATE" && INSERT/EDICAO/BROWSER/
   	VCTipoOper(1,2) = ""
   	VCTipoOper(1,3) = .T.
	*--------------------------------------------------------------*
    VCTipoOper(2,1) = "CHV_LER" && p/ leitura do ultimo reg + 1
   	VCTipoOper(2,2) = ""
   	VCTipoOper(2,3) = .T.
	*--------------------------------------------------------------*
    VCTipoOper(3,1) = "CHV_COMPARA" && p/ leitura do ultimo reg + 1
   	VCTipoOper(3,2) = ""
   	VCTipoOper(3,3) = .T.
	*--------------------------------------------------------------*
    VCTipoOper(4,1) = "CHV_BROW" && p/ leitura do ultimo reg + 1
   	VCTipoOper(4,2) = ""
   	VCTipoOper(4,3) = .T.
	*--------------------------------------------------------------*
    VCTipoOper(5,1) = "ISEDITING" && p/ leitura do ultimo reg + 1
   	VCTipoOper(5,2) = .F.
   	VCTipoOper(5,3) = .T.
	*--------------------------------------------------------------*
    VCTipoOper(6,1) = "ISADDING" && p/ leitura do ultimo reg + 1
   	VCTipoOper(6,2) = .F.
   	VCTipoOper(6,3) = .T.
	*--------------------------------------------------------------*
    VCTipoOper(7,1) = "ISREADING" && p/ leitura do ultimo reg + 1
   	VCTipoOper(7,2) = .F.
   	VCTipoOper(7,3) = .T.
	*--------------------------------------------------------------*
    VCTipoOper(8,1) = "CHAVE DE LEITURA" && TAG DO CHAVE USADA EM FIND
   	VCTipoOper(8,2) = "TIPO"
   	VCTipoOper(8,3) = .T.
	*--------------------------------------------------------------*
	
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I5F           TPBtnVal VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   21  º
*       º Variable:            TPBtnVal                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      382                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i5f     &&  TPBtnVal VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TPBtnVal
PARAMETERS PrmTecla

PRIVATE Lchv_Ler
PRIVATE Lchv_Compara
PRIVATE Lchv_Brow
PRIVATE LTipo


	=TPVerifyInst()

	Lchv_ler    = TPGetPropVT("CHV_LER")
	Lchv_compara= TPGetPropVT("CHV_COMPARA")
	Lchv_brow    = TPGetPropVT("CHV_BROW")

	
	SELE &PBTipoOperAlias
	DO CASE
	
		CASE PrmTecla = "LOCATE"

			LTipo     = CNGetPropVT("TIPO")

			=TPView(LCliente)
			SELE &PBTipoOperAlias
			SCATTER MEMVAR MEMO

			
		OTHERWISE

		    DO btn_val with PrmTecla,;
	   			       Lchv_ler,;
	   			       Lchv_compara,;
	   			       Lchv_brow,;
	   			       .T.,;
	   			       .T.
	   			
	ENDCASE
	   			
	=TPSetPropVT("ISEDITING",ISEDITING)
	=TPSetPropVT("ISADDING",ISADDING)
	=TPSetPropVT("ISREADING",ISREADING)
	   			
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I5K           TPTrtChv VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   22  º
*       º Variable:            TPTrtChv                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      383                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i5k     &&  TPTrtChv VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TPTrtChv
PARAMETERS  ;
			PrmProcesso,;
			PrmTipo

	PRIVATE LFretorno
	LFretorno = .t.
	=TPVerifyInst()

    =TPSetPropVT("PROCESSO",PrmProcesso)
    =TPSetPropVT("TIPO",PrmTipo)

	LFretorno=TPFind()

	SELE &PBTipoOperAlias
RETURN(UPtratachv())







*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I5N           TPScatter VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   24  º
*       º Variable:            TPScatter                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      384                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i5n     &&  TPScatter VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TPScatter

	PRIVATE LFretorno
	LFretorno = .t.

	=TPVerifyInst()
	SELE &PBTipoOperAlias
	SCATTER MEMVAR MEMO
RETURN(.T.)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I5Q           TPView VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   25  º
*       º Variable:            TPView                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      385                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i5q     &&  TPView VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TPView
PARAMETER PrmTipo,PrmOrdem

	PRIVATE LerTipo
	LerTipo =""

	PRIVATE PrmVlrLocate && VARIAVEL USADA PARA LOCATE
	                     && E PRESERVADA PARA USO NO CONTINUE
	                     && ELA E PUBLICA PARA:
	                     && MNView, MNLOCATE e MNContinue

	PrmVlrLocate = ""


	=W_DEFPROC("rotinas.spr")
	PRIVATE Lretorno
	=TPVerifyInst()
	*--------------------------------------------------------------*
	IF TYPE("PrmTipo") <> "C"
		PrmCliente = ""
	ENDIF
	
	IF TYPE("PrmOrdem") <> "C" OR EMPTY(PrmOrdem)
		PrmOrdem = "TIPO"
	ENDIF

	SELE  &PBTipoOperAlias


	DO CASE
		CASE PrmOrdem = "NOME"
			SET ORDER TO TAG CLIENTE
		OTHERWISE
			SET ORDER TO TAG CLIENTE
	ENDCASE




	=UPLocDefWindow()

	ON KEY LABEL L DO CNLOCATE WITH "TIPO", LerTipo
	ON KEY LABEL l DO CNLOCATE WITH "TIPO", LerTipo
	ON KEY LABEL T DO CNLOCATE WITH "TIPO", LerTipo
	ON KEY LABEL T DO CNLOCATE WITH "TIPO", LerTipo

	ON KEY LABEL CTRL-G DO CNCONTINUE


	BROWSE  FIELDS;
			TIPO;
			:H="TIPO - (T)",;
			DESCRICAO,;
			CFO,;
			CFOSUBS,;
			REST ;
		WINDOW wzlocate ;
    		NOAPPEND NODELETE NOEDIT  ;
    			COLOR SCHEME 10



	=UPLocRelWindow()


	ON KEY LABEL CTRL-G
	ON KEY LABEL L
	ON KEY LABEL l
	ON KEY LABEL N
	ON KEY LABEL n
	ON KEY LABEL C
	ON KEY LABEL c



	Lretorno = &PBTipoOperAlias .TIPO


	=TP_Refresh(Lretorno)
		
	*--------------------------------------------------------------*
RETURN(Lretorno)


PROCEDURE  TPCONTINUE

	CONTINUE
	IF EOF()
		GO TOP
		CONTINUE
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I5R           TPLOCATE VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TIPOOPER,     Record Number:   26  º
*       º Variable:            TPLOCATE                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      386                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i5r     &&  TPLOCATE VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*


FUNCTION TPLOCATE
PARAMETERS PrmFields,PrmUltimaPesquisa


	DO LOC_BROW.SPR with PrmFields,PrmUltimaPesquisa



	PrmVlrLocate = PrmUltimaPesquisa
	
	PrmVlrLocate = ALLTRIM(PrmVlrLocate)
	PrmVlrLocate = UPPER(PrmVlrLocate)
	
	DO CASE
		CASE  PrmFields = "TIPO"
			LOCATE FOR ALLTRIM(PrmVlrLocate) $ TIPO
		OTHERWISE
			LOCATE FOR ALLTRIM(PrmVlrLocate) $ TIPO
	ENDCASE
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I5S           GFGetTp_Mercadoria VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    3  º
*       º Variable:            GFGetTp_Mercadoria                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      387                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i5s     &&  GFGetTp_Mercadoria VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFGetTp_Mercadoria
PARAMETERS PrmUF, PrmClassifica


	PRIVATE LFOUND
	PRIVATE LMsgErro


	LFOUND = GFChk_Identidade(PrmUF, LEFT( PrmClassifica,12))
	
	IF !LFOUND
	  LFOUND = GFChk_Identidade("BR", LEFT( PrmClassifica,12))
	ENDIF
	
	IF !LFOUND
	  LFOUND = GFChk_Identidade(PrmUF, LEFT(PrmClassifica,8)+SPACE(4))
	ENDIF
	
	IF !LFOUND
	  LFOUND = GFChk_Identidade("BR", LEFT(PrmClassifica,8)+SPACE(4))
	ENDIF
	
	IF !LFOUND
	  LFOUND = GFChk_Identidade(PrmUF, LEFT(PrmClassifica,5)+SPACE(7))
	ENDIF

	IF !LFOUND
	  LFOUND = GFChk_Identidade("BR", LEFT(PrmClassifica,5)+SPACE(7))
	ENDIF
	
	IF !LFOUND

		LMsgErro =   "Situacao Tributaria nao prevista para:";
						+ CHR(13);
						+ CHR(13);
					    + PrmUF;
						+ ': Produto:';
						+  PrmClassifica ;
						+ CHR(13);
						+ CHR(13);
						+ " <ENTER>  "

		=UPerrosys(LMsgErro)
	ENDIF



RETURN(GFGetPropVT("TP_MERCAD"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I5T           GFVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    4  º
*       º Variable:            GFVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      388                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i5t     &&  GFVerifyInst VALID
#REGION 14
return
*---------------------------------------------------------------*



FUNCTION GFVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("GRFiscal")


	DO CASE

		CASE TYPE("PBGRFiscalAlias") = "U" ;
		   		OR EMPTY(PBGRFiscalAlias) ;
		   		OR !USED(PBGRFiscalAlias)
			=GFCreate()					

		CASE !("GRFISCAL.DBF" $ DBF(PBGRFiscalAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBGRFiscalAlias
			=GFCreate()					


		CASE  !(LSPath $ DBF(PBGRFiscalAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=GFDestroi()				
			=GFCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I5U           GFCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    5  º
*       º Variable:            GFCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      389                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i5u     &&  GFCreate VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBGRFiscalAlias") <> "U" ;
	   		AND !EMPTY(PBGRFiscalAlias) ;
	   		AND USED(PBGRFiscalAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBGRFiscalAlias

	IF USED("GRFiscal")
	     =NetArqAgain("GRFiscal")
	     PBGRFiscalAlias     = Alias()
	ELSE
	     =NetArqAgain("GRFiscal")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("GRFiscal")
	     PBGRFiscalAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBGRFiscalAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTGRFiscal[LMaxDim]
    PUBLIC DIMENSION VDGRFiscal[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFGRFiscal[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFGRFiscal)



	*-----------------------------------------------------------*
	=GFReadProperty()
	=GFSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I5V           GFDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    6  º
*       º Variable:            GFDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      390                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i5v     &&  GFDestroi VALID
#REGION 14
return
*---------------------------------------------------------------*


FUNCTION GFDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBGRFiscalAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBGRFiscalAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBGRFiscalAlias
	*  3- Se aplicar um FECHAMENTO a PBGRFiscalAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBGRFiscalAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBGRFiscalAlias)) OR ;
	   !("GRFISCAL.DBF" $ DBF(PBGRFiscalAlias))

		RELEASE PBGRFiscalAlias
    	RELEASE VTGRFiscal
	    RELEASE VDGRFiscal
		RELEASE VFGRFiscal
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBGRFiscalAlias) AND USED(PBGRFiscalAlias)
		SELECT &PBGRFiscalAlias
		USE
	ENDIF	
	RELEASE PBGRFiscalAlias
    RELEASE VTGRFiscal
    RELEASE VDGRFiscal
	RELEASE VFGRFiscal

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I5W           GFReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    7  º
*       º Variable:            GFReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      391                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i5w     &&  GFReadProp VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBGRFiscalAlias
	SCATTER TO VTGRFiscal
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I6K           GFSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    8  º
*       º Variable:            GFSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      392                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i6k     &&  GFSetDerivadas VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDGRFiscal(1,1) = "NAOINFORMADO"
   	VDGRFiscal(1,2) = 0
   	VDGRFiscal(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I6N           GFSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    9  º
*       º Variable:            GFSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      393                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i6n     &&  GFSetPropVT VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBGRFiscalAlias,;
						    VTGRFiscal,;
						    VDGRFiscal,;
						    VFGRFiscal)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I6Q           GFGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   10  º
*       º Variable:            GFGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      394                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i6q     &&  GFGetPropVT VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBGRFiscalAlias,;
	            VTGRFiscal,;
	            VDGRFiscal,;
	            VFGRFiscal)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I6T           GFChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   11  º
*       º Variable:            GFChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      395                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i6t     &&  GFChk_Identidade VALID
#REGION 14
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
FUNCTION GFChk_Identidade
PARAMETERS PrmUF, PrmClassifica
	PRIVATE LFretorno
	LFretorno = .t.

	=GFVerifyInst()
    =GFSetPropVT("UF",PrmUF)
    =GFSetPropVT("SUBGRUPO",PrmClassifica)
	LFretorno=GFFind()
RETURN(LFretorno)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I6W           GFFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   12  º
*       º Variable:            GFFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      396                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i6w     &&  GFFind VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFFind
	PRIVATE LUF
	PRIVATE LSubGrupo  && SubGrupo da Classificacao do Produto

	PRIVATE LFreturn
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=GFVerifyInst()
	LUF           = GFGetPropVT("UF")
	LSubGrupo     = GFGetPropVT("SUBGRUPO")

	SELE &PBGrFiscalAlias
	SET ORDER TO TAG TRB_ITEM
	SEEK Luf+LSubGrupo

	IF FOUND()
		=GFReadProperty()
		=GFSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I71           GFGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   13  º
*       º Variable:            GFGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      397                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i71     &&  GFGetFieldValue VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFGetFieldValue
PARAMETERS PrmUF, PrmClassifica, PrmField


	=GFChk_Identidade(PrmUF, PrmClassifica)

RETURN(GFGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I73           GF_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   14  º
*       º Variable:            GF_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      398                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i73     &&  GF_Refresh VALID
#REGION 14
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION GF_Refresh
PARAMETERS PrmUF, PrmClassifica



	PRIVATE LFretorno
	LFretorno = .t.

	=GFVerifyInst()
    =GFSetPropVT("UF",PrmUF)
    =GFSetPropVT("SUBGRUPO",PrmClassifica)
	LFretorno=GFFind()
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I77           GFLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   16  º
*       º Variable:            GFLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      399                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i77     &&  GFLerRegistro VALID
#REGION 14
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION GFLerRegistro
PARAMETERS PrmUF, PrmClassifica



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = GFChk_Identidade(PrmUF, PrmClassifica)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I7B           GFWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   17  º
*       º Variable:            GFWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      400                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i7b     &&  GFWriteProp VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBGRFiscalAlias
	=RLOCK()
	GATHER FROM  VTGRFiscal
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I7C           GFSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   18  º
*       º Variable:            GFSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      401                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i7c     &&  GFSalvarRegistro VALID
#REGION 14
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION GFSalvarRegistro

	=GFVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !GFExiste()
		SELE &PBGRFiscalAlias
		APPEND BLANK
		LFretorno=GFWriteProp()
	ELSE
		SELE &PBGRFiscalAlias
		LFretorno=GFWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I7D           GFExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   19  º
*       º Variable:            GFExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      402                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i7d     &&  GFExiste VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFExiste

	PRIVATE LUF
	PRIVATE LSubGrupo  && SubGrupo da Classificacao do Produto

	PRIVATE LFreturn
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=GFVerifyInst()

	LUF           = GFGetPropVT("UF")
	LSubGrupo     = GFGetPropVT("SUBGRUPO")

	SELE &PBGrFiscalAlias
	SET ORDER TO TAG TRIBUTACAO
	SEEK Luf+LSubGrupo

	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _2WZ123I7E           GFGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   21  º
*       º Variable:            GFGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      403                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _2wz123i7e     &&  GFGetAlias VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFGetAlias

	=GFVerifyInst()

RETURN(PBGRFiscalAlias)
