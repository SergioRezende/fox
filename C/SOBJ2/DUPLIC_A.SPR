*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º 04/24/15            DUPLIC_A.SPR               10:53:19 º
*       º                                                         º
*       ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶
*       º                                                         º
*       º Author's Name                                           º
*       º                                                         º
*       º Copyright (c) 2015 Company Name                         º
*       º Address                                                 º
*       º City,     Zip                                           º
*       º                                                         º
*       º Description:                                            º
*       º This program was automatically generated by GENSCRN.    º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º                MS-DOS Window definitions                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º         DUPLIC_A/MS-DOS Setup Code - SECTION 2          º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 1
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º         DUPLICAT/MS-DOS Setup Code - SECTION 2          º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 2
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              DUPLIC_A/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 1
IF WVISIBLE("_4c30nc6hh")
	ACTIVATE WINDOW _4c30nc6hh SAME
ELSE
	ACTIVATE WINDOW _4c30nc6hh NOSHOW
ENDIF
@ 31,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 0,0 GET CRGetNome ;
	PICTURE "@*HN CRGetNome - Retorna Nome" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6ip()
@ 1,0 GET CRsld_dup ;
	PICTURE "@*HN 01-CRsld_dup  - Saldo financeiro da Duplicata" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6ix()
@ 2,0 GET CRdb_Cobr ;
	PICTURE "@*HN 02-CRdb_Cobr  - Informa Debito de Cobranca (Dup.Emitidas)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6jd()
@ 3,0 GET CRcr_Cobr ;
	PICTURE "@*HN 03-CRcr_Cobr  - Informa Credito o de Cobranca (Dup.Recebidas)" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6jj()
@ 4,0 GET CRsld_dup ;
	PICTURE "@*HN 04-CRsld_Cobr - Informa Saldo de Cobranca " ;
	SIZE 1,44,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6jt()
@ 5,12 GET CRidlate26geradupl ;
	PICTURE "@*HN 06-CRIDLate26geradupl - Gerar duplicatas - FILIAL IDL" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6k0() ;
	DISABLE
@ 13,5 GET CRNroIDdupl ;
	PICTURE "@*HN 08-CRNroIDdupl Gera o Numero de ID para Duplicata" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6kf()
@ 14,5 GET CRajustaVenc ;
	PICTURE "@*HN 08-CRajustaVenc  - Ajusta Data de Voncimento Considerando Sab,Dom e Feriado" ;
	SIZE 1,77,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6kg()
@ 15,5 GET CRAlteraFatura ;
	PICTURE "@*HN 09-CRAlteraFatura - Altera o Nro Fatura das Duplicatas" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6l0()
@ 17,0 GET CRcancdupl ;
	PICTURE "@*HN 10-CRcancdupl - Cancela Duplicatas Referentes a NF" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6l5()
@ 21,0 GET CRProcBaixa ;
	PICTURE "@*HN 11-CRProcBaixa-Processa Comandos de Baixa e Outros Relacionados a Duplicatas" ;
	SIZE 1,78,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6lb()
@ 25,0 GET CRCancProcBaixa ;
	PICTURE "@*HN 12-CRCancProcBaixa-Cancela Processamento Comandos de Baixa e Outros " ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6ls()
@ 26,0 GET CRRgAvisoCaixa ;
	PICTURE "@*HN 13-CRRgAvisoCaixa - Gera Registro de Lancamento para Sistema de Caixa" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6lt()
@ 27,0 GET CRCnAvisoCaixa ;
	PICTURE "@*HN 14-CRCnAvisoCaixa - Gera Registro Cancelamento de Lanc. para Sistema de Caixa" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6mh()
@ 29,0 GET CRRefinanciamento ;
	PICTURE "@*HN 19-CRRefinanciamento - Refinanciamento  simples de uma Duplicata" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6mr()
@ 30,0 GET CRUltSeqdupl ;
	PICTURE "@*HN 18-CRUltSeqdupl - Retorna Ultima Sequencia Gerada para Duplicatas" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6n7()
@ 32,0 GET CRChkp_FilDupl ;
	PICTURE "@*HN 15-CRChkp_FilDupl - Checkup pro Filial de Distorcoes em Vlr_pgto X Liq em RETORNMV" ;
	SIZE 1,84,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6ne()
@ 33,0 GET CRChkp_AllDupl ;
	PICTURE "@*HN 16-CRChkp_AllDupl - Checkup Geral de Distorcoes em Vlr_pgto X Liq em RETORNMV" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6nf()
@ 34,0 GET CRobtvlrpg ;
	PICTURE "@*HN 17-CRobtvlrpg - Obetem Valores Liquidados em RETORNMV" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6ng()
@ 35,0 GET CRgetNvVlrDup ;
	PICTURE "@*HN 18-CRgetNvVlrDup - Obtem Novo Principal para Reparcelamento" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6o0()
@ 36,0 GET CRNv_VlrDup ;
	PICTURE "@*HN 19-CRNv_VlrDup - Calc (Vlr Dupl)=X Onde  X+(Juros+Desp-Desc) = Vlr Informado" ;
	SIZE 1,78,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6o7()
@ 44,3 GET CR_001geraNssNro ;
	PICTURE "@*HN 21-CR_001geraNssNro - Gera o campo NossoNumero para Boleto Banco do Brasil" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6og()
@ 45,3 GET CR_237geraNssNro ;
	PICTURE "@*HN 22-CR_237geraNssNro - Gera o campo NossoNumero para Boleto Bradesco" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6os()
@ 22,8 GET CRProc237 ;
	PICTURE "@*HN 11A-CRProc237-Processa Ocorrencia Retorno Banco Bradesco - 237" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6p0()
@ 23,8 GET CRProc001 ;
	PICTURE "@*HN 11B-CRProc001-Processa Ocorrencia Retorno Banco Bradesco - 001" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6p1()
@ 24,8 GET CRProcantigo ;
	PICTURE "@*HN 11a-CRProcantigo - PRimeiro" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6pl()
@ 12,3 GET CRgeraVdor ;
	PICTURE "@*HN 07-CRgeraVdor - Gerar duplicatas com base no vendor" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6px()
@ 64,10 GET CRtxsVendor ;
	PICTURE "@*HN 26-CRtxsVendor - Taxas do Vendor" ;
	SIZE 1,34,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6q9()
@ 62,4 GET CRcalcVendor ;
	PICTURE "@*HN 25-CRcalcVendor - Calculo Valor Vendor" ;
	SIZE 1,40,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6qh()
@ 58,2 GET CRConfigParcelas ;
	PICTURE "@*HN 27-CRConfigParcelas - Monta Simulacao de Parcelamento" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6qi()
@ 59,4 GET CRQtdeParcelas ;
	PICTURE "@*HN 28-CRQtdeParcelas-Qtde Parec. basedo na String PRAZO 000/030/060.." ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6r7()
@ 61,6 GET CRDiasParcela ;
	PICTURE "@*HN 28-CRDiasParcela-Retorna o Prazo da Parcela com base em PRAZO 000/030/060.." ;
	SIZE 1,77,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6re()
@ 57,0 GET CRViewParcelas ;
	PICTURE "@*HN 23-CRViewParcelas-Visualisa e edita vencimentos" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6rj()
@ 60,6 GET CRDiaSemana ;
	PICTURE "@*HN 28-CRDiaSemana-Dia da Semana Para Data" ;
	SIZE 1,40,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6rr()
@ 63,6 GET CRVerifTxsVendor ;
	PICTURE "@*HN 27-CRVerifTxsVendor - Verifica se Taxas de Vendor estao Cadastradas" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6rx()
@ 6,3 GET CRgeraDE12MAR08 ;
	PICTURE "@*HN 07-CRgeraDE12MAR08 - Gerar duplicatas - A PARTIR 12 MAR 2008" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6ry()
@ 7,3 GET CRIDLApos26geradupl ;
	PICTURE "@*HN 06-CRIDLApos26geradupl - Gerar duplicatas - FILIAL IDL" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6te()
@ 16,0 GET CRAtrzcancdupl ;
	PICTURE "@*HN 10-CRAtrzcancdupl - Verifica se as Dupl Podem ser canceladas (Junto com Canc da nota)" ;
	SIZE 1,87,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6tf()
@ 10,6 GET CRdefcarteira ;
	PICTURE "@*HN 28-CRdefcarteira - Define Carteira e Variacao para cobranca" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6u0()
@ 39,0 GET CRDupgeraboleto ;
	PICTURE "@*HN 20a-CRDupgeraboleto - Gera Dados para Emissao de Boleto com base na Dup" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6u8()
@ 40,2 GET CRGrvBoleto ;
	PICTURE "@*HN 20b-CRGrvBoleto - Grava Registro de Boleto" ;
	SIZE 1,44,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6uq()
@ 38,0 GET CRgeraboleto ;
	PICTURE "@*HN 20-CRgeraboleto - Gera Dados para Emissao de Boleto -PARA NF INFORMADA" ;
	SIZE 1,72,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6vm()
@ 65,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 66,0 GET CRreplicaDupl ;
	PICTURE "@*HN CRreplicaDupl-Replica duplica em + x parcelas mensais" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6vw()
@ 41,6 GET ULmsgBoleto ;
	PICTURE "@*HN ULmsgBoleto - Area de mensagem boleto comercial" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6w3()
@ 42,6 GET ULmsgVendor ;
	PICTURE "@*HN ULmsgVendor - Area de mensagem boleto vendor" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6wa()
@ 43,6 GET ULmsgBltSPE ;
	PICTURE "@*HN ULmsgBltSPE - Area de mensagem boleto SPE" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6wh()
@ 67,0 GET CRAplicaINCC ;
	PICTURE "@*HN CRAplicaINCC - Aplica INCC para toda carteira de Cobranca" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6wr()
@ 69,0 GET CRAplicaIGPM ;
	PICTURE "@*HN CRAplicaIGPM - Aplica IGPM para toda carteira de Cobranca" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6x0()
@ 68,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 19,5 GET CRfatimporta ;
	PICTURE "@*HN CRfatimporta-Gera Retornbc (Aviso) de faturamento Banco 990 " ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6xa()
@ 18,0 GET CRGerfatPeriodo ;
	PICTURE "@*HN CRGerfatPeriodo-Gera Retornbc (Aviso) de faturamento Banco 990 por periodo" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6xi()
@ 8,0 GET CRgeraDE01JUL12 ;
	PICTURE "@*HN 07-CRgeraDE01JUL12 - Gerar duplicatas - A PARTIR 01 JUL 2012" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6xq()
@ 46,1 SAY "-------------------------------------------------------------------------" ;
	SIZE 1,73, 0
@ 37,1 SAY "-------------------------------------------------------------------------" ;
	SIZE 1,73, 0
@ 9,2 GET CRgr01nov14 ;
	PICTURE "@*HN 07b-CRgr01nov14 - Gerar duplicatas com 2 cartoes cred - A PARTIR 10 nov 2014" ;
	SIZE 1,78,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6yq() ;
	DISABLE
@ 11,2 GET CRqtd_parcelas ;
	PICTURE "@*HN CRqtd_parcelas - Identifica a qtde de parcelas com base em String prazo " ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _4c30nc6yr()
@ 47,0 GET CRBltTxtDevmedia ;
	PICTURE "@*HN CRBltTxtDevmedia - Gera Dados para Emissao de Boleto -PARA NF INFORMADA" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _4c30nc702()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              DUPLICAT/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 2
IF WVISIBLE("_4c30nc6hi")
	ACTIVATE WINDOW _4c30nc6hi SAME
ELSE
	ACTIVATE WINDOW _4c30nc6hi NOSHOW
ENDIF
@ 19,2 GET CRComandText ;
	PICTURE "@*HN CRComandText - Executa Comando em Parametro" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _4c30nc70l()
@ 2,7 GET CRVerifyInst ;
	PICTURE "@*HN CRVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _4c30nc70r()
@ 3,10 GET CRCreate ;
	PICTURE "@*HN CRCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _4c30nc70x()
@ 9,10 GET CRDestroi ;
	PICTURE "@*HN CRDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _4c30nc714()
@ 4,13 GET CRReadProp ;
	PICTURE "@*HN CRReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _4c30nc71a()
@ 7,15 GET CRSetDerivadas ;
	PICTURE "@*HN CRSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _4c30nc71b()
@ 5,15 GET CRSetPropVT ;
	PICTURE "@*HN CRSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4c30nc71m()
@ 6,15 GET CRGetPropVT ;
	PICTURE "@*HN CRGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4c30nc71s()
@ 1,2 GET CRChk_Identidade ;
	PICTURE "@*HN CRChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _4c30nc71z()
@ 0,2 GET CRFind ;
	PICTURE "@*HN CRFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4c30nc724()
@ 11,2 GET CRGetFieldValue ;
	PICTURE "@*HN CRGetFieldValue -Rtrn vlr Campo p/ reg.existente-(erro se chave n existir)" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _4c30nc72b()
@ 10,2 GET CR_Refresh ;
	PICTURE "@*HN CR_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _4c30nc72h()
@ 13,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 15,2 GET CRLerRegistro ;
	PICTURE "@*HN CRLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _4c30nc72n()
@ 8,13 GET CRWriteProp ;
	PICTURE "@*HN CRWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _4c30nc72s()
@ 16,2 GET CRSalvarRegistro ;
	PICTURE "@*HN CRSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _4c30nc72t()
@ 14,2 GET CRExiste ;
	PICTURE "@*HN CRExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4c30nc72u()
@ 17,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 12,2 GET CRGetAlias ;
	PICTURE "@*HN CRGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4c30nc73b()
@ 18,2 GET CRFaxinaDados ;
	PICTURE "@*HN CRFaxinaDados-Retira char invalidor e outras validacoes" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _4c30nc73g()
@ 23,1 GET CRGerXMLDpDocFiscal ;
	PICTURE "@*HN CRGerXMLDpDocFiscal-Gera XML Dp DFis Por Doc Fiscal informado - DOCCOBR" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _4c30nc73l()
@ 20,1 SAY "XML=>" ;
	SIZE 1,5, 0
@ 25,5 GET CRNmFileXMLDocFiscal ;
	PICTURE "@*HN CRNmFileXMLDocFiscal-Define Path+File do XML DOC FISCAL" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _4c30nc73v()
@ 26,11 GET CRInicioXML ;
	PICTURE "@*HN CRInicioXML-Monta Cabecalho XML com base no modelo-xmlDCCBR" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4c30nc740()
@ 28,11 GET CRFinalXML ;
	PICTURE "@*HN CRFinalXML-Monta Fechamento XML com base no modelo-xmlDCCBRS" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4c30nc747()
@ 27,15 GET CRGravaXMLDpDocFiscal ;
	PICTURE "@*HN CRGravaXMLDpDocFiscal - Converte uma Doc Fiscal em XML" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _4c30nc748()
@ 24,5 GET CRModeloRefXML ;
	PICTURE "@*HN CRModeloRefXML-MODELO P/MONTAR REF XML Doc Fiscal-xmlDCFIS" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4c30nc75m()
@ 82,10 GET CRExpCapaRetLegado ;
	PICTURE "@*HN CRExpCapaRetLegado - Exporta Capa Retonos Bancarios para XML" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4c30nc75u()
@ 78,1 GET CRAvsExpNro ;
	PICTURE "@*HN CRAvsExpNro-Processa Exportacao de Avisos de retorno" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4c30nc75v()
@ 80,6 GET CRAvsModeloXML ;
	PICTURE "@*HN CRAvsModeloXML-MODELO P/MONTAR REF XML Export Avisos Legado xmlDFin" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4c30nc76i()
@ 81,6 GET CRAvsIniXML ;
	PICTURE "@*HN CRAvsIniXML-Monta Cabecalho XML com base no modelo-xmlDFin" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4c30nc76o()
@ 87,7 GET CRAvsFinML ;
	PICTURE "@*HN CRAvsFinML-Monta Cabecalho XML com base no modelo-xmlDFin" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4c30nc76v()
@ 84,10 GET CRExpItemRetLegado ;
	PICTURE "@*HN CRExpItemRetLegado - Exporta Itens Retonos Bancarios para XML" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _4c30nc772()
@ 85,10 GET CRExpDuplRetLegado ;
	PICTURE "@*HN CRExpDuplRetLegado - Exporta Dados Duplicatas para XML" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _4c30nc773()
@ 79,6 GET CRAvsNmXMLExpt ;
	PICTURE "@*HN CRAvsNmXMLExpt-Define Path+File do XML DOC FINANCEIRO" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _4c30nc787()
@ 71,4 GET CRtratalinha ;
	PICTURE "@*HN CRtratalinha-Trata linha antes da gravacao XML" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _4c30nc78f()
@ 74,4 GET CRLimpaString ;
	PICTURE "@*HN CRLimpaString - Elimina Caracteres especiais de string" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _4c30nc78m()
@ 72,4 GET CR_Fputs ;
	PICTURE "@*HN CR_Fputs - Elimina caracteres especiais da string XML" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4c30nc78s()
@ 83,10 GET CRExpLccbrCapaRetLegado ;
	PICTURE "@*HN CRExpLccbrCapaRetLegado - Exporta Capa Retonos Bancarios para XML" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _4c30nc78y()
@ 86,10 GET CRExpClieDupLegado ;
	PICTURE "@*HN CRExpClieDupLegado - Exporta Dados Cliente da Dupl para XML" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _4c30nc79b()
@ 88,7 GET CRAvsEnviaXML ;
	PICTURE "@*HN CRAvsEnviaXML-Envia XMLDFIN" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _4c30nc79p()
@ 89,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 47,1 GET CRDuplNroExpDuplicata ;
	PICTURE "@*HN CRDuplNroExpDuplicata -Processa Exportacao de Duplicatas por nro duplicata" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _4c30nc79v()
@ 52,4 GET CRDuplModeloXML ;
	PICTURE "@*HN CRDuplModeloXML-MODELO P/MONTAR REF XML Export Duplicatas Legado xmlDupl" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4c30nc7a5()
@ 53,4 GET CRDuplIniXML ;
	PICTURE "@*HN CRDuplIniXML-Monta Cabecalho XML com base no modelo-xmlDupl" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4c30nc7ac()
@ 55,8 GET CRDuplIedentLegado ;
	PICTURE "@*HN CRDuplIedentLegado - Exporta Identificacao empresa" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7ah()
@ 56,8 GET CRDuplCedenteLegado ;
	PICTURE "@*HN CRDuplCedenteLegado - Exporta BANCO CEDENTE  para XML" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7ai()
@ 57,8 GET CRDuplPortadorLegado ;
	PICTURE "@*HN CRDuplPortadorLegado - Exporta BANCO PORTADOR  para XML" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7b3()
@ 58,8 GET CRDuplRecebedorLegado ;
	PICTURE "@*HN CRDuplRecebedorLegado - Exporta BANCO RECEBEDOR  para XML" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7bi()
@ 59,8 GET CRDuplLegado ;
	PICTURE "@*HN CRDuplLegado - Exporta Dados Duplicatas para XML" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7bz()
@ 60,8 GET CRDuplClieLegado ;
	PICTURE "@*HN CRDuplClieLegado - Exporta Dados Cliente da Dupl para XML" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7cn()
@ 61,4 GET CRDuplFinXML ;
	PICTURE "@*HN CRDuplFinXML-Monta Cabecalho XML com base no modelo-xmlDupl" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4c30nc7d1()
@ 66,4 GET CRDupEnviaXML ;
	PICTURE "@*HN CRDupEnviaXML-Envia XMLDupl" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7d6()
@ 51,4 GET CRNmDuplXMLExpt ;
	PICTURE "@*HN CRNmDuplXMLExpt-Define Path+File do XML DOC XMDUPL" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7de()
@ 48,1 GET CRDuplExpPeriodoDupl ;
	PICTURE "@*HN CRDuplExpPeriodoDupl-Processa Exportacao de Duplicatas por empresa e periodo" ;
	SIZE 1,78,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7dj()
@ 77,1 GET CRAvsExpPeriodo ;
	PICTURE "@*HN CRAvsExpPeriodo-Processa Exportacao de Periodo Avisos de retorno" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7dw()
@ 25,5 GET CRNmLongoFileXMLDocFiscal ;
	PICTURE "@*HN CRNmLongoFileXMLDocFiscal-Define Path+File do XML DOC FISCAL" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7ec()
@ 70,4 GET DFCopyLongo ;
	PICTURE "@*HN CRCopyLongo - Copia xml para nome longo Servidor Servicos" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7ek()
@ 49,1 GET CRDuplExpVencPeriodoDupl ;
	PICTURE "@*HN CRDuplExpVencPeriodoDupl- Exportar Duplicatas com vencimento no Periodo" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7ep()
@ 75,1 GET FCHExpDuplicata ;
	PICTURE "@*HN FCHExpDuplicata" ;
	SIZE 1,17,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7f0()
@ 45,1 GET CRDuplDFisExpDuplicata ;
	PICTURE "@*HN CRDuplDFisExpDuplicata -Proc Exp de Duplicatas por nro Doc.Fiscal (nota)" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7f1()
@ 68,6 GET CREsperaRspDup ;
	PICTURE "@*HN CREsperaRspDup - Executa CRBuscaRspDup Enquanto nao houver resposta" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7fo()
@ 69,8 GET CRBuscaRspDup ;
	PICTURE "@*HN CRBuscaRspDup-Busca Arq Resposta Dup" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7fx()
@ 67,4 GET CRRespostaDup ;
	PICTURE "@*HN CRRespostaDup - Le e Def. Tratamento para  resposta Dupl-" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7g4()
@ 54,8 GET CRDuplMotivoLegado ;
	PICTURE "@*HN CRDuplMotivoLegado - Motivo da Exporcao" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7gc()
@ 76,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 22,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 40,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 41,1 GET CRGer2XMLDpDocFiscal ;
	PICTURE "@*HN CRGer2XMLDpDocFiscal-Gera XML Dp DFis Por Doc Fiscal informado-XMLDUPL" ;
	SIZE 1,72,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7gj()
@ 62,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 46,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 50,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 42,4 GET CRNm2FileXMLDocFiscal ;
	PICTURE "@*HN CRNm2FileXMLDocFiscal-Define Path+File do XML DOC FISCAL" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7gz()
@ 43,4 GET CRNm2LongoFileXMLDocFiscal ;
	PICTURE "@*HN CRNm2LongoFileXMLDocFiscal-Define Path+File do XML DOC FISCAL" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7h5()
@ 21,2 GET CRDFis_Tem_Duplicata ;
	PICTURE "@*HN CRDFis_Tem_Duplicata-Verifica se o DFis possui Duplicata" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7hb()
@ 73,8 GET CR_Fputs ;
	PICTURE "@*HN CR_FputsLimpa - Elimina caracteres especiais da string XML" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7hj()
@ 39,1 GET CRMntaStrgInfoCobranca ;
	PICTURE "@*HN CRMntaStrgInfoCobranca-Nonta String com Inf Cobranca para Uso em XML DFis" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7ho()
@ 38,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 65,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 63,1 GET CRPthTmpDup ;
	PICTURE "@*HN CRPthTmpDup - Define Path p/ arquivo tmp exporta Financeiro" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7hy()
@ 64,1 GET CRPthDstnDupDIR_DEFIN ;
	PICTURE "@*HN CRPthDstnDupDIR_DEFIN - Define Path p/ arquivo final exporta Financeiro" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _4c30nc7hz()
@ 29,1 SAY "---------------------------------------------------------------------------" ;
	SIZE 1,75, 0

IF NOT WVISIBLE("_4c30nc6hi")
	ACTIVATE WINDOW _4c30nc6hi
ENDIF
IF NOT WVISIBLE("_4c30nc6hh")
	ACTIVATE WINDOW _4c30nc6hh
ENDIF


READ


#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              DUPLIC_A/MS-DOS Cleanup Code               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 1

RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              DUPLICAT/MS-DOS Cleanup Code               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 2

RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6IP           CRGetNome VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    3  º
*       º Variable:            CRGetNome                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      1                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6ip     &&  CRGetNome VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION CRGetNome
PARAMETERS PrmEmpresa, PrmDuplicata

	PRIVATE LFreturn
	PRIVATE LSNome

	*----------------------------------------------------------------*
	LFreturn = CRChk_Identidade(PrmEmpresa, PrmDuplicata)
	*----------------------------------------------------------------*
	LSNome = SPACE(45)
	IF LFreturn = .T.
		LSNome = CRGetPropVT("NOME")
	ENDIF

RETURN(LSNome)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6IX           CRsld_dup VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    4  º
*       º Variable:            CRsld_dup                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      2                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6ix     &&  CRsld_dup VALID
#REGION 1
RETURN

FUNCTION CRsld_dup
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Retornar o Saldo de uma Duplicata na Data
	*				Solicitada
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao utiliza-se da data e da movimentacao
	*				de duplicatas para recompor a saldo na  data
	*				solicitada
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNdup..........: Numero da Duplicata a ser verificada
	*		LDt_Refer......: Data em que se deve apurar o saldo
	*       LDt_emidp......: Data da emissao da duplicata
	*       LDt_BXdup......: Data da baixa da duplicata
	*					se esta data for menor que a data de LDt_Refer
	*					entao o saldo e (ZERO)
	*		LNvlrdup.......: Valor Total do Documento
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o saldo da duplicata
	*------------------------------------------------------------*
	*  EXEMPLO.....: SCGC518
	*
	*   =W_DEFPROC("DUPLICAT.SPR")
	*   LNvlr = CRsld_dup(&wl_arqtmp .DUPLICATA,m.dt_inicio,;
	* 		 &wl_arqtmp .dt_emi,&wl_arqtmp .DT_BAIXA, &wl_arqtmp .vlr_doc )
	*------------------------------------------------------------*

PARAMETERS  PrmEmpresa,LNdup, LDt_Refer, LDt_emidp ,LDt_BXdup, LNvlrdup
	PRIVATE LSalias
	PRIVATE LNsaldo
	PRIVATE LFretornmv

	LSalias			= ALIAS()
	=W_DEFPROC("rotinas.spr")

	IF LDt_emidp > LDt_Refer && DUP. EMIT APOS A DATA DE CONSULTA
		RETURN(0)
	ENDIF

	IF !EMPTY(LDt_BXdup) ;
		AND LDt_BXdup <= LDt_Refer && DUP. BAIXADA ANTES DA DATA DE CONSULTA
			RETURN(0)
	ENDIF


	LFretornmv		= NetArq("retornmv")
	IF (LFretornmv) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("retornmv" ,LFretornmv)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*-------------------------------------------------------------*
	LNsaldo  	=   LNvlrdup
	*-------------------------------------------------------------*
	* BAIXAR VALORES DE PGTO => (EFEITO = 2,3,4,5)
	*						2-PGTO TOTAL
	*						3-PGTO PARCIAL
	*						4-DEVOLUCAO
	*						5-INCOBRAVEL
	*-------------------------------------------------------------*
	SELE retornmv
	SET ORDER TO TAG doc_ocor
	SET NEAR ON
	SEEK str(PrmEmpresa,3)+STR(LNdup,9) 	
	SET NEAR OFF
	DO WHILE !EOF() AND LNdup = retornmv.duplicata ;
	                AND PrmEmpresa = retornmv.empresa
		IF  retornmv.efeito < 2 OR retornmv.status <> "PR"
			SKIP
			LOOP
		ENDIF
		************** JUROS EM PGTO PARCIAL ***************
		* NO CASO DE PGTO PARCIAL COM PARTE TRANSFORMADA EM
		* JUROS, ESTE JUROS NAO PODE SER ABATIDO DO SALDO DA
		* DUPLICATA => COMO JA HOUVE A SUBTRACAO DO JUROS
		* QUANDO  SUBTRAIU O PAGO PARCIAL QUE ESTA INCLUINDO
		* O JUROS E FEITA A COMPENSSACAO AGORA AO SOMAR O
		* JUROS
		***************************************************
		IF retornmv.dtprocesso <= LDt_Refer
			 LNsaldo = LNsaldo - retornmv.vlr_pgto+;
			 				retornmv.JUROS + retornmv.MORA			
		ENDIF
		SKIP
	ENDDO
	=UP_fecha("retornmv" ,LFretornmv)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNsaldo)
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6JD           CRdb_Cobr VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    5  º
*       º Variable:            CRdb_Cobr                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      3                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6jd     &&  CRdb_Cobr VALID
#REGION 1
RETURN

FUNCTION CRdb_Cobr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Retornar o Debito  da Cobranca
	*			em um periodo especifico
	*------------------------------------------------------------*
	* COMENTARIO..: DEBITO - Duplicatas emitidas no periodo
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Filial em que se deve apurar o debito
	*		LDt_ini........: Data inicial que se deve apurar o debito
	*		LDt_fim........: Data inicial que se deve apurar o debito
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o DEBITO da COBRANCA
	*------------------------------------------------------------*
	*  EXEMPLO.....:
	*------------------------------------------------------------*

PARAMETERS  LNemp, LDt_ini, LDt_fim
	PRIVATE LNdebito, LSalias
	PRIVATE LFduplicat
	LSalias			= ALIAS()
		
	=W_DEFPROC("rotinas.spr")
	LFduplicat	= NetArq("duplicat")
	IF (LFduplicat) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("duplicat" ,LFduplicat)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*---------------------------------------------------------------*	
	*	DEBITO  DE CARTEIRA	 = DUPLICATAS EMITIDAS NO DIA
	*---------------------------------------------------------------*	
	LNdebito  = 0
	sele duplicat
	SET ORDER TO TAG emissao
	SET NEAR ON
	SEEK STR(LNemp,3)+DTOS(LDt_ini)
	SET NEAR OFF
	DO WHILE !EOF() AND duplicat.dt_emi  <= LDt_fim ;
					AND duplicat.empresa  = LNemp

			LNdebito 	=  LNdebito + duplicat.vlr_doc
			SKIP
	ENDDO

	=UP_fecha("duplicat" ,LFduplicat)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNdebito)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6JJ           CRcr_Cobr VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    6  º
*       º Variable:            CRcr_Cobr                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      4                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6jj     &&  CRcr_Cobr VALID
#REGION 1
RETURN

FUNCTION CRcr_Cobr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Retornar o Credito  da Cobranca
	*			em um periodo especifico
	*------------------------------------------------------------*
	* COMENTARIO..: CREDITO - Duplicatas baixadas  no periodo
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Filial em que se deve apurar o credito
	*		LDt_ini........: Data inicial que se deve apurar o credito
	*		LDt_fim........: Data inicial que se deve apurar o credito
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o CREDITO da COBRANCA
	*------------------------------------------------------------*
	*  EXEMPLO.....:
	*------------------------------------------------------------*

PARAMETERS  LNemp, LDt_ini, LDt_fim
	PRIVATE LNcredito, LSalias
	PRIVATE LFretornmv
	LSalias			= ALIAS()

	=W_DEFPROC("rotinas.spr")
	LFretornmv	= NetArq("retornmv")
	IF (LFretornmv) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("retornmv" ,LFretornmv)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*---------------------------------------------------------------*	
	*	CREDITO DE CARTEIRA  = DUPLICATAS RECEBIDAS NO DIA
	*---------------------------------------------------------------*	
	LNcredito = 0
	SELE retornmv
	SET ORDER TO TAG dtprocesso
	SEEK	STR(LNemp,3)+DTOS(LDt_ini)  && PROCURAR BAIXAS

	DO WHILE !EOF() AND retornmv.dtprocesso <= LDt_fim ;
					AND retornmv.empresa	= LNemp

		IF  retornmv.status 	   <> "PR" 	&&  PROCESSADA
			SKIP
			LOOP
		ENDIF
		IF retornmv.ocorrencia = 6 OR ;
			   retornmv.ocorrencia = 7 OR ;
			   retornmv.ocorrencia = 15 OR ;
			   retornmv.ocorrencia = 17 OR ;
			   retornmv.ocorrencia = 81 OR ;
			   retornmv.ocorrencia = 80 OR ;
			   retornmv.ocorrencia = 84 OR ;
			   retornmv.ocorrencia = 86 OR ;
			   retornmv.ocorrencia = 83    && BAIXA PARCIAL PROCESSADA
			   LNcredito =  LNcredito + retornmv.vlr_pgto - ;
				 				retornmv.JUROS - retornmv.MORA			
		ENDIF
		SKIP
	ENDDO
	*------------------------------------------------------*
	=UP_fecha("retornmv" ,LFretornmv)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNcredito)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6JT           CRsld_dup VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    7  º
*       º Variable:            CRsld_dup                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      5                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6jt     &&  CRsld_dup VALID
#REGION 1
RETURN

FUNCTION CRsld_Cobr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Retornar o SALDO   da Cobranca
	*			em data especifico
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Filial em que se deve apurar o saldo
	*		LDt_REF........: Data que se deve apurar o saldo
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o SALDO da COBRANCA
	*------------------------------------------------------------*
	*  EXEMPLO.....:
	*------------------------------------------------------------*

PARAMETERS  LNemp, LDt_ref
	PRIVATE LNsaldo, LSalias
	PRIVATE LFduplicat
	
	LSalias			= ALIAS()
	=W_DEFPROC("rotinas.spr")

	LFDuplicat		= NetArq("duplicat")
	IF (LFduplicat) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("duplicat" ,LFduplicat)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*---------------------------------------------------------------*	
	*	SALDO DE CARTEIRA
	*---------------------------------------------------------------*	
	LNsaldo   = 0
	sele duplicat
	SET ORDER TO TAG r_dtbaixa
	SET NEAR ON
	SEEK STR(LNemp,3)+DTOS(LDt_ref+1)
	SET NEAR OFF
	LNDPANT =  duplicat.duplicata
	
	DO WHILE !EOF() AND (duplicat.dt_baixa > LDt_ref;
					OR  EMPTY(duplicat.dt_baixa))  ;
			 		AND duplicat.empresa = LNemp ;
			 		AND !UPinterrompe(.F.)
		WAIT WINDOW " Apurando Saldo Duplicat : "+STR(DUPLICATA,9) + ;
					" <ESC>-Interrompe " NOWAIT

		IF duplicat.dt_emi > LDt_ref
			SKIP
			IF DUPLICAT.DUPLICATA = 9998921
				SET STEP ON
			ENDIF
			LOOP
		ENDIF
		=W_DEFPROC("DUPLICAT.SPR")
		LNsaldo   	=  LNsaldo + ;
			CRsld_dup(LNemp,(duplicat.DUPLICATA),;
		       (LDt_ref),(duplicat.dt_emi),(duplicat.dt_baixa),;
					       (duplicat.vlr_doc))
		SELE duplicat
		LNDPANT =  duplicat.duplicata
		SKIP
			IF DUPLICAT.DUPLICATA = 9998921
				SET STEP ON
			ENDIF

	ENDDO

	KEYBOARD CHR(4)			&& APAGA MENSSAGEM WAIT
	=INKEY(0.1)
	*------------------------------------------------------*
	=UP_fecha("duplicat" ,LFduplicat)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNsaldo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6K0           CRidlate26geradupl VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    8  º
*       º Variable:            CRidlate26geradupl                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      6                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6k0     &&  CRidlate26geradupl VALID
#REGION 1
RETURN
*********************************************************************
*  CRgeradupl.....: Gera duplicatas Para filiais que ainda nao registram
*              duplicatas para operacoes a vista e nao tratam a TABELA
* 				ORCA_PGT (Implantados pela Reestrutura‡Æo em Jan/01)
*           Ap¢s a Atualiza‡Æo do Sistema Na Filial a Gera‡Æo de Duplicatas
*           Ser  Realizada Pela Rotina Homonima  CRgeradupl
*
*********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Duplicat
*                   Empresa
*                   Orcament
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.: do CRgeradupl with LNemp,LNorcamento
*---------------------------------------------------------------

PROCEDURE CRidlate26geradupl		&& USADA EM SCGC201, SCGCF201, SCGC201A
	
	PARAMETERS LNEmp,LNOrcamento
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE nota	&& O NUMERO DA NOTA DEVE SER O DA 1a NOTA CASO
					&& TENHAM SIDO GERADAS DUAS COM BASE NO MESMO ORCAMENTO
					&& PARA EVITAR INFLUENCIA NO AMBENTE NOTA E PRIVATE

	PRIVATE 	LNocorrenc, LNposic, LNinicio, LNnumpgt, LNdias, LNserie
	PRIVATE 	CVSTR1,CVSTR2,LNvlrdupl,LNdifere

	PRIVATE	empresa,duplicata,dt_emi,multa_prv,mora_prv,bonus_prv,;
			prem_pont,vlr_fatura,portador,tp_cobranc,;
			desconto,regiao,natu,nome,tp_cobranc

	PRIVATE dt_venc, dtproxproc
	PRIVATE LNtmp,banco

   	PRIVATE LNTp_Parcela,LNbanco,LNvlrent,LSprazo,LDdtemi,LNmulta,LNmora
  	PRIVATE LNbonus,LNPremPont,LNRegiao,LNnatureza,LSnome,LNvlrfatura	
    PRIVATE LNnronota	

	PRIVATE LFduplicata,LFempresa,LForcamento,LFclienc
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFduplicata	= NetArq("duplicat")
	LFempresa   = NetArq("Empresa" )
	LForcamento = NetArq("Orcament")
	LFclienc    = NetArq("clienc")
	IF (LFduplicata+LFempresa+LForcamento) > 100000
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)


	IF orcament.natu_oper <> 1		&& So Gerar Duplicatas para
									&& operacoes de Venda
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF

	*----------------------------------------------------------------*
	wp_msg = "Gerando Duplicatas OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	LNcliente	= clienc.cliente	
   	LNTp_parcela= orcament.tp_parcela
   	LNbanco		= orcament.banco
   	LNvlrent	= orcament.vlr_ent
   	LSprazo		= orcament.prazo
   	LDdtemi		= orcament.dt_fat
  	LNmulta		= empresa .multa
  	LNmora		= empresa .mora
  	LNbonus		= empresa .bonus
  	LNPremPont	= empresa .prem_pont
  	LNRegiao	= clienc.regiao
	LNnatureza	= clienc.natu_cli
	LSnome		= clienc.nome
	LNvlrfatura	= orcament.valor
	LNnronota	= orcament.nota
	SELECT &LSalias

*************

	*-----------------------------------------------------------*

	=CRcancdupl((LNemp),(LNnronota))
	
	*---------------------------------------------------------------*
	*    Venda a Vista ou Parcelada no Cartao nao geram duplicatas
	*---------------------------------------------------------------*

	IF LNtp_parcela = 1   && VENDA A VISTA
		RETURN
	ENDIF
*
	LNocorrenc 	= 1
    LNposic    	= 0
    LNinicio   	= 1
    LNnumpgt   	= 0
	LNdias	   	= 0
	LNserie	   	= 1
		
	DO WHILE .t.
        LNposic = AT("/",LSprazo, LNocorrenc)
        LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
******************************************************************
   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
			EXIT
		ENDIF
******************************************************************
		IF LNdias = 0 AND LNnumpgt > 0
	        LNnumpgt   = LNnumpgt
		ELSE			
	        LNnumpgt   = LNnumpgt + 1
		ENDIF
		LNocorrenc = LNocorrenc + 1
        LNinicio   = LNposic + 1
	ENDDO

	SET DECIMALS TO 6
	
	IF LNvlrent > 0 AND LNnumpgt > 1
	   CVSTR1    = STR((LNvlrfatura - LNvlrent) / (LNnumpgt - 1) ,25,11)
	   CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
	   LNdifere  = LNvlrfatura - (LNvlrdupl * (LNnumpgt - 1) + LNvlrent)
    ELSE
	   CVSTR1    = STR((LNvlrfatura) / (LNnumpgt) ,25,11)
	   CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
	   LNdifere  = LNvlrfatura - (LNvlrdupl * LNnumpgt)
	ENDIF

	**>>>>>

	m.empresa	= LNemp
	m.nota		= LNnronota						
	m.duplicata	= LNnronota
	m.cliente	= LNcliente
	m.dt_emi	= LDDtemi
	m.multa_prv	= LNmulta
	m.mora_prv	= LNmora
	m.bonus_prv	= LNbonus
	m.prem_pont	= LNPremPont
	m.vlr_fatura= LNvlrfatura
	m.vlr_pgto  =   0
	
	DO CASE
		CASE LNbanco = 898
			m.portador = 898
		CASE LNbanco >= 850 AND  LNbanco <= 857     &&CARTAO
			m.portador = LNbanco	
		OTHERWISE
			m.portador	= 0
	ENDCASE


    && A IDL NAO POSSUI CONTROLE DE FATURAMENTO COM INFORMACOES
    && SUFICIENTES PARA ORCAPGTO
		
	m.tp_parcela=  	3
	m.moeda 	=	3

	m.tp_cobranc= 01
	m.desconto  = 0
	m.regiao    = LNregiao
	m.natu      = LNnatureza
	m.nome      = LSnome
	m.tp_cobranc= 01 		  && COB. SIMPLES

	**>>>>>

	LNocorrenc = 1
    LNposic    = 0
    LNinicio   = 1
	LNdias		= 0

	DO WHILE .t.
        LNposic = AT("/",LSprazo, LNocorrenc)
        LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
		**************************************************

   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
			EXIT
		ENDIF

		**************************************************
		IF m.empresa <> 10
			m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  STR(m.empresa,1)))   && 1 => DUPLICATA
		else
			m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  "0"))   && 1 => DUPLICATA
		ENDIF
		IF LNvlrent > 0 AND LNnumpgt > 1
			m.vlr_doc 	 = LNvlrent
			LNvlrent = 0
		ELSE
			m.vlr_doc  = LNvlrdupl + LNdifere
			LNdifere   = 0
		ENDIF
		m.dt_venc  = m.dt_emi + LNdias
		m.dtproxproc  = m.dt_venc
		m.obs =""

		*---------------------------------------------------*		
		* 		EM COMPRAS A PRAZO COM A 1a DUPLICATA A
		* 	VISTA OU CONTA APRESENTACAO, ESTA 1a E
		* 	DIRECIONADA P/ A CARTEIRA E A DEMAIS
		* 	P/ O BANCO SOLICITADO. LNbanco GUARDO O
		* 	BANCO SOLICITADO P/ USO APOS GERAR A 1a
		*---------------------------------------------------*


		LNtmp  = m.dt_venc - m.dt_emi
	    if  LNtmp <= 7  AND LNbanco <> 900 AND LNbanco <> 898 ;
			 AND LNbanco <> 851 AND  LNbanco <> 852;
			 AND LNbanco <> 853 AND  LNbanco <> 854;
			 AND LNbanco <> 855 AND  LNbanco <> 856;
			 AND LNbanco <> 857 AND  LNbanco <> 858
	    						     && CONTA APRESENTACAO
			m.banco = 0			     && DIRECIONA P/ CARTEIRA
		ELSE
			m.banco = LNbanco   && DIRECIONA P/ BANCO SOLICITADO	
		ENDIF

		SELE  duplicat
		=edithand('SAVE')
		SELE orcament

		LNserie    = LNserie + 1
		LNocorrenc = LNocorrenc + 1
        LNinicio   = LNposic + 1
	ENDDO
	SET DECIMALS TO 2
	=UP_fecha("duplicat"  ,LFduplicata )
	=UP_fecha("empresa"   ,LFempresa   )
	=UP_fecha("orcamento" ,LForcamento )
	=UP_fecha("clienc" ,LFclienc )
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6KF           CRNroIDdupl VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    9  º
*       º Variable:            CRNroIDdupl                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      7                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6kf     &&  CRNroIDdupl VALID
#REGION 1
RETURN
*---------------------------------------------------------------
*  CRNroIDdupl.....: Montar nro para ID duplicatas
*---------------------------------------------------------------
*  CLASSIFICACAO..: [******]
*---------------------------------------------------------------
*  OBJETIVO.......:
*--------------------------------------------------------------*
*   Permite obter o numero de Identificacao para duplicatas do
* sistema com  base na Empresa, Nota e Ordem da Diplicata(1,2..n)
*
*---------------------------------------------------------------
*  COMENTARIO.....:
*  Obs: Existe uma convencao em relacao a ordem das duplicatas
*   em funcao de caracteristicas de controle do sistema. Sendo?
*
*       LNordemDup             Sequencia de Controle
*     Nro. Ordem Logica   <---> Nro.Ordem Real
*      Duplicata 1        <--->      0
*      Duplicata 2        <--->      1
*      Duplicata 3        <--->      2
*      Duplicata 4        <--->      3
*
*---------------------------------------------------------------
*  TABELAS........: NOTA
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNNota     = Numero do NFs
*---------------------------------------------------------------
* RETORNO.........: Numero ID para Duplicata
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

FUNCTION CRNroIDdupl		&& USADA EM SCGC201, SCGCF201, SCGC201A
	
	PARAMETERS LNEmp,LNnota,LNordemDup
    PRIVATE LNduplicata
    PRIVATE LSalias
	LSalias = alias()
	=W_DEFPROC("rotinas.spr")

	*-----------------------------------------------------------*
*    IF LNordemDup < 1
*    	LNordemDup = 0
*    ELSE
*		LNordemDup = LNordemDup - 1
*	ENDIF
*	*-----------------------------------------------------------*
*	=W_DEFPROC("rotinas.spr")
*
*	IF LNemp <> 10
*		LNduplicata	= INT( VAL(   CHRTRAN(STR(LNnota,7)," ","0")+;
*								  CHRTRAN(STR(LNordemDup,1)," ","0")+;
*								  STR(LNemp,1)))   && 1 => DUPLICATA
*	else
*		LNduplicata	= INT( VAL(   CHRTRAN(STR(LNnota,7)," ","0")+;
*								  CHRTRAN(STR(LNordemDup,1)," ","0")+;
*								  "0"))   && 1 => DUPLICATA
*	ENDIF

	LNduplicata	= INT( VAL(   CHRTRAN(STR(LNnota,7)," ","0")+;
								  CHRTRAN(STR(LNordemDup,2)," ","0");
								  ))   && 1 => DUPLICATA


	*-----------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNduplicata)
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6KG           CRajustaVenc VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   10  º
*       º Variable:            CRajustaVenc                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      8                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6kg     &&  CRajustaVenc VALID
#REGION 1
RETURN
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......: Ajustar uma data (de Vencimento) evitando Sabados,
*				 Domingos e Feriados
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........:
*---------------------------------------------------------------
*  PARAMETROS.....:
*				LDdata			= Data a Ser Ajustada
*				LStipoajuste	= "+" Preferencia por Prorrogar data
*								= "-" Preferencia por Antecipar data
*---------------------------------------------------------------
* RETORNO.........: LDdata ajustada
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

FUNCTION CRajustaVenc
	PARAMETERS LDdata, LStipoajuste
	=W_DEFPROC("rotinas.spr")
	
	DO While .t.
		IF DOW(LDdata) <> 1 AND DOW(LDdata) <> 7
			EXIT
		ENDIF
		IF LStipoajuste = "+"
			LDdata = LDdata + 1
		ELSE			
			LDdata = LDdata - 1
		ENDIF
	ENDDO
RETURN(LDdata)
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6L0           CRAlteraFatura VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   11  º
*       º Variable:            CRAlteraFatura                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      9                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6l0     &&  CRAlteraFatura VALID
#REGION 1
RETURN

FUNCTION  CRAlteraFatura
PARAMETERS PRemp,PRanteFatura,PRnovaFatura
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	EX:
	*				Quando um cupom e emitido as duplicatas
	*               levam como numero de fatura o nro do cupom.
	*				Porem, quando e feita uma NF copia do Cupom
	*				e necessario ajustar o nro da fatura para o
	*				numero da NF. COPIA DO CUPOM
	*
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNdup
	SELE duplicat
	SET ORDER TO TAG doc
	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
	LNdup	= PRanteFatura * 100		
	SET NEAR ON
	SEEK STR(PRemp,3)+STR(LNdup,9)
	SET NEAR OFF
	DO WHILE !EOF() AND PRanteFatura = duplicat.nota
		=REGLOCK(.T.)
		replace duplicat.nota with PRnovaFatura
		SKIP
	ENDDO
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6L5           CRcancdupl VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   12  º
*       º Variable:            CRcancdupl                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      10                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6l5     &&  CRcancdupl VALID
#REGION 1
RETURN

FUNCTION  CRcancdupl

PARAMETERS LNemp,LNnota
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNdup

	PRIVATE LSnota      && STRING COM NUMERO DA NOTA PARA COMPARACAO
	PRIVATE LSnotaDaDup && STRING COM NUMERO DA NOTA RETIRADO DO NUMERO
						&& DA DUPLICATA

	PRIVATE ARQ_CtrlRefn,ALS_CtrlRefn

    ARQ_CtrlRefn     = NetArqAgain("CtrlRefn")
    ALS_CtrlRefn     = Alias()

	SELE duplicat
	SET ORDER TO TAG doc
	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
	*  ALGORITIMO DE GERACAO DO NUMERO DE DUPLICATA - CRgeradupl
	*----------------------------------------------------------------*
	*
	*	IF LNemp <> 10
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  STR(m.empresa,1)))   && 1 => DUPLICATA
	*	else
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  "0"))   && 1 => DUPLICATA
	*	ENDIF
	*-------------------------------------------------------------------*


	LSnota  = STR(LNnota,7)

	LNdup	= LNnota * 100		
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNdup,9)
	SET NEAR OFF
	DO WHILE !EOF() AND LSnota = LEFT( STR(duplicat.duplicata,9) ,7)
		SELE &ALS_CtrlRefn
		SET ORDER TO TAG duplicatas
		SEEK STR(LNemp,3)+STR(duplicat.duplicata,9)
		DO WHILE !EOF() ;
		    AND duplicat.empresa = &ALS_CtrlRefn .empresa ;
		    AND duplicat.duplicata = &ALS_CtrlRefn .duplicata
			=REGLOCK(.T.)
			=edithand('APAGA')
			SKIP
		ENDDO		
		SELE duplicat
		=REGLOCK(.T.)
		=edithand('APAGA')
		SKIP
	ENDDO
    =up_fecha("&ALS_CtrlRefn")
	SELE DUPLICAT	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6LB           CRProcBaixa VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   13  º
*       º Variable:            CRProcBaixa                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      11                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6lb     &&  CRProcBaixa VALID
#REGION 1
RETURN

FUNCTION CRProcBaixa
	PARAMETERS LNemp,LNbanco,PrmCarteira,PrmVariacao,LNaviso,LDdtprocesso

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Processar Comandos de Carteira
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao processa os comandos de Carteira de
	*				cobranca para a empresa e aviso passado em
	*				parametro
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa de referencia do Aviso
	*		LNbanco .......: Banco de referencia do Aviso
	*       LNaviso........: Numero do Aviso
	*		LDdtprocesso...: Data para Lancamento do Processo
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o saldo da duplicata
	*------------------------------------------------------------*
	*  EXEMPLO.....: SCGC504  e SCGC008 , SCGC003A
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFmvretorn,LFbcretorn,LFduplicat

	LSalias = ALIAS()

	LFbcretorn		= NetArq("retornbc")
	LFmvretorn		= NetArq("retornmv")
	LFduplicat		= NetArq("duplicat")
	IF (LFmvretorn+LFbcretorn+LFduplicat) > 100000
		DO  FCHProcBaixa
		RETURN(.f.)
	ENDIF

	LNctrproc		= 0		&& CONTADOR DE INSTR. PROCESSADAS
	LNctrreje		= 0		&& CONTADOR DE INSTR. REJEITADAS
	LNctrdesc		= 0		&& CONTADOR DE INSTR. DESCARTADAS
	LFprocessa		= .f.	&& INDICA SE O REGISTRO FOI ACEITO NO PROCESSO
	m.dtprocesso 	= LDdtprocesso


	SELE retornbc
	SET ORDER TO TAG aviso
	SEEK STR(LNemp,3)+STR(LNbanco,3)+;
	   PrmCarteira+PrmVariacao+STR(LNaviso,8)
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Aviso : "+;
				STR(LNaviso,8)+" do Banco : "+ STR(LNbanco,3)
		DO  FCHProcBaixa
		RETURN(.F.)
	ENDIF

    IF empty(retornbc.dtaviso)
		DO OBJ_MENS.SPR WITH ;
			"    Data do Aviso Deve ser Preenchida "+;
				STR(LNaviso,8)+" do Banco : "+ STR(LNbanco,3)
		DO  FCHProcBaixa
		RETURN(.F.)
	ENDIF



	=REGLOCK(.T.)

	SELECT  retornmv
	SET ORDER TO TAG aviso
	SEEK STR(LNemp,3)+STR(LNbanco,3)+;
	     PrmCarteira+PrmVariacao+STR(LNaviso,8)
	DO WHILE  !EOF() AND ;
	    LNaviso = retornmv.aviso AND ;
		LNbanco = retornmv.banco AND ;
		PrmCarteira = retornmv.carteira AND ;
		PrmVariacao = retornmv.Variacao AND ;
		LNemp 	= retornmv.empresa
		
		
		IF retornmv.status $ "PR/RJ"     && EVITA PROCESSO REDUNDANTE
			IF retornmv.status $ "PR"
				LNctrproc = LNctrproc + 1
			ELSE
				LNctrreje = LNctrreje + 1
			ENDIF
			SELE retornmv
			SKIP
			LOOP
		ENDIF
		SELE duplicat
		SET ORDER TO TAG doc
		SEEK STR(LNemp,3)+STR(retornmv.duplicata,9)
		IF FOUND()
			=REGLOCK(.T.)
			SCATTER MEMVAR MEMO


			SELE retornmv
			=REGLOCK(.T.)

			************* TRATAMENTO DAS OCORRENCIAS ************
			* OBS: Melhor tratar ocorrencias por banco
			*      Consirerar para projeto novo
			*---------------------------------------------------*
			LFprocessa	=	.t.
		    m.efeito	 = 0		&&  NULO (indica efeto no Contas a Rec)

			=CRProcantigo()
			*DO CASE
			*	CASE LNbanco = 001
			*	   =CRProc001()
			*	CASE LNbanco = 237
			*	   =CRProc237()
			*	OTHERWISE
			*	   =CRProc237()
			*ENDCASE
			
			*---------------------------------------------------*
			* Motivos <> "00" => Justificativa para uma rejeicao
			*---------------------------------------------------*
			IF LEFT(retornmv.motivos,2) = "00" OR LFprocessa
				IF DATE() >= CTOD("12/09/00")
					IF retornmv.ocorrencia = 02
						m.dsp_cobr	= 	m.dsp_cobr + retornmv.dsp_cobr
					   ELSE
						m.out_desp	= 	m.out_desp + retornmv.out_desp + ;
								    retornmv.dsp_cobr
					ENDI
				   ELSE
						m.dsp_cobr	= 	m.dsp_cobr + retornmv.dsp_cobr
						m.out_desp	= 	m.out_desp + retornmv.out_desp
				ENDI
				m.iof  		= 	m.iof      + retornmv.iof
			ENDIF


			*---------------------------------------------------------*
			*  VERIFICACAO DA INTEGRIDATE VALORED DUPLICATA
			*---------------------------------------------------------*

			DO CASE
			
				CASE     duplicat.tp_cobranc = 06 ;
  			         AND retornmv.ocorrencia = 06
					*-----------------------------------------------*
					* Cobranca Vendor => Critica a serem implementadas
					*-----------------------------------------------*
					LFprocessa	=	LFprocessa  	

				CASE    retornmv.ocorrencia <> 81 ;
			        AND retornmv.ocorrencia <> 86 ;
			        AND retornmv.ocorrencia <> 50

					IF (;
						    (M.dt_pgto = {} ;
						           AND (M.vlr_pgto <> M.parc_pgto);
						    );
					    OR (;
							 (M.dt_pgto > {} ;
						   	AND abs(M.vlr_pgto - ;
						   	         (M.vlr_doc + M.mora + M.juros + ;
						   	             M.out_credt - M.devolucao - ;
						   	             M.abatimento - M.desconto   ;
  	      					   	     );
		      				   	   ) > 2;
					     	 );
			           	   );
		    	       )
	
						DO OBJ_MENS.SPR WITH ;
				   				" Verifique DUPLICATA : "+;
										STR(retornmv.duplicata,9)+CHR(13)+;
			   					"           BANCO     : "+;
			    						STR(LNbanco,3)+CHR(13)+;
			   					"           AVISO     : "+;
				   						STR(LNaviso,8)+CHR(13)+;
				   						+CHR(13)+CHR(13)+;
   				    		" VALORES INCONSISTENTES = > PROCESSO REJEITADO"

						LFprocessa	=	.F.  	&& rejeita processamento
					ENDIF
			ENDCASE

			
			SELE retornmv
*------------------------------------------------------------------*
***			IF LEFT(retornmv.motivos,2) = "00" OR LFprocessa
*------------------------------------------------------------------*
* condicao mudada pq almir disse q o sistema nao estava rejeitando
* qdo havia baixa duplicada
*alterada em 15/2/13
*------------------------------------------------------------------*
			IF LFprocessa

				SELE duplicat
				=edithand('REGRAVA')
				SELE retornmv
				REPLACE tp_cobranc WITH m.tp_cobranc
				REPLACE dtprocesso WITH m.dtprocesso
				REPLACE efeito 	   WITH m.efeito
  				REPLACE status 	   WITH "PR"  && PROCESSADO
				LNctrproc = LNctrproc + 1
			ELSE
				REPLACE tp_cobranc WITH m.tp_cobranc
  				REPLACE status 	   WITH "RJ"  && PROCESSADO
				LNctrreje = LNctrreje + 1
			ENDIF
			***************************
			SET FIELDS TO dtregis, hregis, usrregis,deletado
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
			***************************
		ELSE
			LNctrdesc = LNctrdesc + 1
		ENDIF
		*------------------------------------------------------*
		*  Registrar Movimento para sistema de Caixa
		*------------------------------------------------------*
		=CRRgAvisoCaixa(retornmv.Empresa,retornmv.Banco,;
		        retornmv.carteira,retornmv.variacao,;
				retornmv.Aviso,retornmv.Duplicata, retornmv.Ocorrencia)
		*------------------------------------------------------*
		SELE retornmv
		SKIP
	ENDDO
	SELE retornbc
	REPLACE status 	   WITH "PR"  && PROCESSADO
	REPLACE reg_proces WITH LNctrproc
	REPLACE reg_descar WITH LNctrdesc
	REPLACE reg_rejeit WITH LNctrreje
	REPLACE dtprocesso WITH m.dtprocesso	
	***************************
	SET FIELDS TO dtregis, hregis, usrregis,deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	***************************
	DO  FCHProcBaixa
	UNLOCK
RETURN(.T.)

PROCEDURE FCHProcBaixa
	=UP_fecha("retornmv" ,LFmvretorn)
	=UP_fecha("retornbc" ,LFbcretorn)
	=UP_fecha("duplicat" ,LFduplicat)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6LS           CRCancProcBaixa VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   14  º
*       º Variable:            CRCancProcBaixa                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      12                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6ls     &&  CRCancProcBaixa VALID
#REGION 1
RETURN

FUNCTION CRCancProcBaixa
	PARAMETERS LNemp,LNbanco,PrmCarteira,PrmVariacao,LNaviso

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Cancelar Processamento de Comandos de Carteira
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa de referencia do Aviso
	*		LNbanco .......: Banco de referencia do Aviso
	*       LNaviso........: Numero do Aviso
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o saldo da duplicata
	*------------------------------------------------------------*
	*  EXEMPLO.....: SCGC504  e SCGC008 , SCGC003A
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFmvretorn,LFbcretorn,LFduplicat

	LSalias = ALIAS()

	LFbcretorn		= NetArq("retornbc")
	LFmvretorn		= NetArq("retornmv")
	LFduplicat		= NetArq("duplicat")
	IF (LFmvretorn+LFbcretorn+LFduplicat) > 100000
		DO  FCHCancProcBaixa
		RETURN(.f.)
	ENDIF

	LNctrproc		= 0		&& CONTADOR DE INSTR. PROCESSADAS
	LNctrreje		= 0		&& CONTADOR DE INSTR. REJEITADAS
	LNctrdesc		= 0		&& CONTADOR DE INSTR. DESCARTADAS
	LFprocessa		= .f.	&& INDICA SE O REGISTRO FOI ACEITO NO PROCESSO


	SELE retornbc
	SET ORDER TO TAG aviso
	SEEK STR(LNemp,3)+STR(LNbanco,3)+;
	     PrmCarteira+PrmVariacao+STR(LNaviso,8)
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Aviso : "+;
				STR(LNaviso,8)+" do Banco : "+ STR(LNbanco,3)
		DO  FCHCancProcBaixa
		RETURN(.F.)
	ENDIF

	=REGLOCK(.T.)

	SELECT  retornmv
	SET ORDER TO TAG aviso
	SEEK STR(LNemp,3)+STR(LNbanco,3)+;
	     PrmCarteira+PrmVariacao+STR(LNaviso,8)
	DO WHILE !EOF() AND ;
	    LNaviso = retornmv.aviso AND ;
		LNbanco = retornmv.banco AND ;
		PrmCarteira = retornmv.carteira AND ;
		PrmVariacao = retornmv.variacao AND ;
		LNemp 	= retornmv.empresa
		
		IF retornmv.status $ "AP"     && EVITA PROCESSO REDUNDANTE
			SELE retornmv
			SKIP
			LOOP
		ENDIF
		SELE duplicat
		SET ORDER TO TAG doc
		SEEK STR(LNemp,3)+STR(retornmv.duplicata,9)
		IF FOUND()
			=REGLOCK(.T.)
			SCATTER MEMVAR MEMO
			SELE retornmv
			=REGLOCK(.T.)
			LFprocessa	=	.t.

 		    m.efeito	 = 0		&&  NULO (indica efeto no Contas a Rec)

			IF DATE() >= CTOD("12/09/00")
				IF retornmv.ocorrencia = 02
					m.dsp_cobr	= 	m.dsp_cobr - retornmv.dsp_cobr
				   ELSE
					m.out_desp	= 	m.out_desp - retornmv.out_desp - ;
								    retornmv.dsp_cobr
				ENDI
			   ELSE
				m.dsp_cobr	= 	m.dsp_cobr - retornmv.dsp_cobr
				m.out_desp	= 	m.out_desp - retornmv.out_desp
			ENDI
			m.iof  		= 	m.iof      - retornmv.iof

					   && processa ocor 02/06/07/09/10/12/13/14/17/19/
					  && 		  20/23/27/28/34/80/81/82/83/84/85/86
				      &&   E  03/24/27/30/32/   && REJEICOES

			DO CASE
				CASE retornmv.status $ "RJ"  && ANULA PROCERSSO
						LFprocessa	=	.F.
				CASE retornmv.ocorrencia = 02
					 if duplicat.moeda = 3 ;
					    AND m.ConfNroBco  = .f. ;
					    AND m.efeito <> 1
									&& SO DOCUMENTOS EM :
									&&     MOEDA =(3-DUPLICATA)
									&&  ( E  )
									&& QUE NAO TENHAM CONFIRMADA ENTRDA BCO
									&&    (ConfNroBco  = .T.)
									&&  ( E  )
									&& QUE NAO SEJAM REG DE FATURAMENTO
									&&    (EFEITO = 1)
                                    &&
									&& PODEM RETORNAR AO PORTADOR CARTEIRA
						 m.portador  = 0
   					     m.ConfNroBco  = .f.
					 ENDIF
					 m.agencia   = retornmv.agenc_cobr



				CASE duplicat.tp_cobranc = 06  AND ;
  					 retornmv.ocorrencia = 06
					 *----------------------------------------------*
					 *=> Pagamento de titulo VENDOR
					 *----------------------------------------------*

		  		     m.efeito	 = 2		  &&  PGTO TOTAL
					*******************   CRITICA *******************
					 IF EMPTY(m.dt_pgto)  && PROCESSO NAO INDICADO
						LFprocessa	=	.F.
					 ELSE
						 STORE 0 TO  juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto
						 m.vlr_pgto = m.vlr_pgto - duplicat.vlr_doc
						 m.dtocorrenc= CTOD(" .  .  ")
						 m.dt_pgto   = CTOD(" .  .  ")
						 m.dt_baixa  = CTOD(" .  .  ")
					 ENDIF


				CASE retornmv.ocorrencia = 06  OR ;
  					 retornmv.ocorrencia = 15  OR ;
  					 retornmv.ocorrencia = 83  OR ;
  					 retornmv.ocorrencia = 17  && LIQUIDACAO DO TITULO
		  		     m.efeito	 = 2		  &&  PGTO TOTAL
					*******************   CRITICA *******************
					 IF EMPTY(m.dt_pgto)  && PROCESSO NAO INDICADO
						LFprocessa	=	.F.
					 ELSE
						 STORE 0 TO  juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto
						 m.vlr_pgto = m.vlr_pgto - retornmv.vlr_pgto
						 m.dtocorrenc= CTOD(" .  .  ")
						 m.dt_pgto   = CTOD(" .  .  ")
						 m.dt_baixa  = CTOD(" .  .  ")
					 ENDIF
				CASE retornmv.ocorrencia = 07  && ESPECIFICO DO BFB
					*					LIQUIDACAO PARCIAL
		  		     m.efeito	 = 3		&&  PGTO PARCIAL
					 STORE 0 TO  juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto
					 m.vlr_pgto = m.vlr_pgto - retornmv.vlr_pgto
					 m.parc_pgto = m.parc_pgto - retornmv.vlr_pgto
					 m.dtocorrenc= CTOD(" .  .  ")
				CASE retornmv.ocorrencia = 09 OR ;
					 retornmv.ocorrencia = 10 && BAIXADOS
					 if duplicat.moeda <> 4 AND duplicat.moeda <> 5
									&& CARTAO E CHQ. ELETR NAO MUDA
					 				&& PORTADOR 4/5
						 m.portador	= retornbc.banco
					 ENDIF
					 m.agencia  = retornmv.agenc_cobr
				CASE retornmv.ocorrencia = 12 && ABATIMENTO CONCEDIDO
					m.abatimento= 	0
				CASE retornmv.ocorrencia = 13 && ABATIMENTO CANCELADO
					m.abatimento= 	retornmv.abatimento
				CASE retornmv.ocorrencia = 14 && VENCIMENTO ALTERADO
					m.dt_venc	=	retornmv.vencimento
				CASE retornmv.ocorrencia = 19 && INSTR. PROTESTO CONFIRMADO
					m.trf_cart 	=  	""
				CASE retornmv.ocorrencia = 20 && INSTR. PROTESTO CANCELADA
					m.trf_cart 	=  	""
				CASE retornmv.ocorrencia = 23 && ENTRADA CARTORIO
					m.tp_cobranc=   01    && COBRANCA EM CARTORIO
					m.trf_cart 	=  	retornmv.trf_cart
				CASE retornmv.ocorrencia = 34 && ENTRADA CARTORIO
					m.tp_cobranc=   88    && COBRANCA SIMPLES
					m.trf_cart 	=  	retornmv.trf_cart

				******** INSTRUCOES DE CARTEIRA

				CASE retornmv.ocorrencia = 85 && ALTERCACAO DE VLR DE DUPL.

					 m.vlr_doc =  retornmv.vlr_dup

				CASE   retornmv.ocorrencia = 80 ;
				    OR retornmv.ocorrencia = 84 ;
				    OR retornmv.ocorrencia = 50
			 		 m.efeito	 = 4		&&  DEVOLUCAO
					*******************   CRITICA *******************
					 && 80 = LIQUID. POR DEVOL.
					 && 50 = LIQUID. POR DEVOL. cancelamento contrato
					
					 IF retornmv.ocorrencia = 80 or retornmv.ocorrencia = 50

						*******************   CRITICA *******************

						 IF EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
							LFprocessa	=	.F.
						 ELSE
							 STORE 0 TO juros, iof,abatimento, desconto, ;
									mora, out_credt, form_pgto
							 m.dtocorrenc= CTOD(" .  .  ")
							 m.devolucao = m.devolucao - retornmv.vlr_pgto
							 m.dt_pgto  = CTOD(" .  .  ")
							 m.dt_baixa = CTOD(" .  .  ")
						 ENDIF
					 ELSE
							 m.devolucao = m.devolucao - retornmv.vlr_pgto
					 ENDIF
				&& 81 DUPLICATA INCOBRAVEL
				&& 86 SALDO DE DUPLICATA IMCOBRAVEL
				CASE retornmv.ocorrencia = 81  OR ;
  					 retornmv.ocorrencia = 86
			 		 m.efeito	 = 5		&&  INCOBRAVEL
					*******************   CRITICA *******************
					 IF EMPTY(m.dt_pgto)  && PROCESSO NAO INDICADO
						LFprocessa	=	.F.
					 ELSE
	 				 	 m.tp_cobranc=   1    && INCOBRAVEL
						 m.dt_pgto  = CTOD(" .  .  ")
						 m.dt_baixa = CTOD(" .  .  ")
						 m.status = "I"
					ENDIF
				CASE retornmv.ocorrencia = 82  && ALTERA DIRECIONA. COBRANCA
			 		 * m.banco      =  0
					 m.agencia    = retornmv.agenc_cobr
				OTHERWISE   && 03/24/27/30/32/   && REJEICOES
					LFprocessa	=	.F.
			ENDCASE			
			SELE duplicat
			=edithand('REGRAVA')
	 		* m.banco      =  retornmv.banco  &&

			*------------------------------------------------------*
			*  Registrar Movimento para sistema de Caixa
			*------------------------------------------------------*
			=CRCnAvisoCaixa(retornmv.Empresa,retornmv.Banco,;
		        retornmv.carteira,retornmv.variacao,;
				retornmv.Aviso,retornmv.Duplicata, retornmv.Ocorrencia)
			*-----------------------------------------------------*

			SELE retornmv
			REPLACE dtprocesso WITH CTOD(" .  .  ")
			REPLACE efeito 	   WITH m.efeito
			REPLACE status 	   WITH "AP"  && AGUARDA PROCESSO
			***************************
			SET FIELDS TO dtregis, hregis, usrregis,deletado
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
			***************************
		ENDIF
		SELE retornmv
		SKIP
	ENDDO
	SELE retornbc
	REPLACE status 	   WITH "AP"  && AGUARDA PROCESSADO
	REPLACE reg_proces WITH 0
	REPLACE reg_descar WITH 0
	REPLACE reg_rejeit WITH 0
	REPLACE dtprocesso WITH CTOD(" .  .  ")
	***************************
	SET FIELDS TO dtregis, hregis, usrregis,deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	***************************
	DO  FCHCancProcBaixa
	UNLOCK
RETURN(.T.)

PROCEDURE FCHCancProcBaixa
	=UP_fecha("retornmv" ,LFmvretorn)
	=UP_fecha("retornbc" ,LFbcretorn)
	=UP_fecha("duplicat" ,LFduplicat)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6LT           CRRgAvisoCaixa VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   15  º
*       º Variable:            CRRgAvisoCaixa                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      13                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6lt     &&  CRRgAvisoCaixa VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION CRRgAvisoCaixa
  PARAMETER PrmEmpresa,PrmBanco,;
                  PrmCarteira,PrmVariacao,;
                  PrmAviso,PrmDuplicata, PrmOcorrencia
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*      Qdo PrmBanco = 993 (Caixa ) o registro para caixa
	*   ja foi gerado no proprio faturamento nao podendo gerar
	*   novo registro quando a carteira registrar a baixa das
	*   ENTRADAS
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias

	PRIVATE ARQ_Retornmv,ALS_Retornmv
    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_LancaCx,ALS_LancaCx

    LSAlias      = Alias()


	IF PrmBanco = 993     && Entradas em Caixa
		RETURN(.T.)	
	endif

    ARQ_Retornmv = NetArqAgain("RETORNMV")
    ALS_Retornmv     = Alias()

    ARQ_Duplicat = NetArqAgain("DUPLICAT")
    ALS_Duplicat = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()


	* Captar Saldo Inicial do Mes

    SELE &ALS_Retornmv
  	SET ORDER TO TAG lancamento
    SEEK STR(PrmEmpresa,3)+STR(PrmBanco,3)+PrmCarteira+PrmVariacao+;
            STR(PrmAviso,8)+STR(PrmDuplicata,9)+STR(PrmOcorrencia,2)

	IF !FOUND()
	    =up_fecha("&ALS_Retornmv")
    	=up_fecha("&ALS_Duplicat")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	IF  &ALS_Retornmv .status = "RJ"
	    =up_fecha("&ALS_Retornmv")
    	=up_fecha("&ALS_Duplicat")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.T.)
	ENDIF

    SELE &ALS_Duplicat
  	SET ORDER TO TAG doc
    SEEK STR(PrmEmpresa,3)+STR(PrmDuplicata,9)

	IF !FOUND()
	    =up_fecha("&ALS_Retornmv")
    	=up_fecha("&ALS_Duplicat")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF



	DO CASE
		CASE &ALS_Retornmv .ocorrencia = 06  OR ;
				 &ALS_Retornmv .ocorrencia = 15  OR ;
				 &ALS_Retornmv .ocorrencia = 83  OR ;
				 &ALS_Retornmv .ocorrencia = 81  OR ;
				 &ALS_Retornmv .ocorrencia = 86  OR ;
				 &ALS_Retornmv .ocorrencia = 17  && LIQUIDACAO DO TITULO
	  		     m.efeito	 = 2		  &&  PGTO TOTAL
				*******************   CRITICA *******************
		CASE &ALS_Retornmv .ocorrencia = 07  && ESPECIFICO DO BFB
				*					LIQUIDACAO PARCIAL
	  		     m.efeito	 = 3		&&  PGTO PARCIAL
 		CASE retornmv.ocorrencia = 80 OR retornmv.ocorrencia = 84
				&& LIQ. POR DEVOLUCAO // DEVOL. PARCIAL
		 		 m.efeito	 = 4		&&  DEVOLUCAO

		OTHERWISE
		    =up_fecha("&ALS_Retornmv")
    		=up_fecha("&ALS_Duplicat")
    		=up_fecha("&ALS_LancaCx")
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
	        RETURN(.F.)
	ENDCASE


    m.EMPRESA 	= PrmEmpresa
    m.TIPO_DOC  = 2            && Codigo Tabela Padrao para DUPLICATA
    m.NUM_DOC   = STR(PrmDuplicata,15)


    m.PORTADOR  = PrmBanco
	m.NOME      = &ALS_Duplicat .nome
    m.data      = &ALS_Retornmv .dtprocesso
    m.valor     = &ALS_Retornmv .vlr_pgto - ;
                     ( &ALS_Retornmv .juros + &ALS_Retornmv .mora ) ;
                     + &ALS_Retornmv .desconto
    m.JUROS     = &ALS_Retornmv .juros + &ALS_Retornmv .mora
    m.DESCONTOS = &ALS_Retornmv .desconto
    m.PROCESSADO   = "N"
    m.OPERACAO     = "LANCAR"
    m.LOG_LANCA    = "Lanc. Aut.Rec.Carteira."

    sele &ALS_LancaCx
	SET ORDER TO TAG chave_pk
	SEEK 	STR(M.EMPRESA,3)+STR(M.TIPO_DOC,3)+M.NUM_DOC
	IF !FOUND()
	    =edithand('SAVE')
	ELSE
	    =edithand('REGRAVA')
	ENDIF
	*---------------------------------------------------------------*
    =up_fecha("&ALS_Retornmv")
    =up_fecha("&ALS_Duplicat")
   	=up_fecha("&ALS_LancaCx")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6MH           CRCnAvisoCaixa VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   16  º
*       º Variable:            CRCnAvisoCaixa                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      14                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6mh     &&  CRCnAvisoCaixa VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION CRCnAvisoCaixa
  PARAMETER PrmEmpresa,PrmBanco,PrmCarteira,PrmVariacao,;
           PrmAviso,PrmDuplicata, PrmOcorrencia
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Cancelar
	*			Lancamento no Sistema de Caixa
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias

    PRIVATE ARQ_Retornmv,ALS_Retornmv
    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_LancaCx,ALS_LancaCx

    LSAlias      = Alias()

	IF PrmBanco = 993     && Entradas em Caixa
		RETURN(.T.)	
	endif


    ARQ_Retornmv = NetArqAgain("RETORNMV")
    ALS_Retornmv     = Alias()

    ARQ_Duplicat = NetArqAgain("DUPLICAT")
    ALS_Duplicat = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()


	* Captar Saldo Inicial do Mes

    SELE &ALS_Retornmv
  	SET ORDER TO TAG lancamento
    SEEK STR(PrmEmpresa,3)+STR(PrmBanco,3)+;
         PrmCarteira+PrmVariacao+;
          STR(PrmAviso,8)+STR(PrmDuplicata,9)+STR(PrmOcorrencia,2)

	IF !FOUND()
	    =up_fecha("&ALS_Retornmv")
    	=up_fecha("&ALS_Duplicat")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	IF  &ALS_Retornmv .status = "RJ"
	    =up_fecha("&ALS_Retornmv")
    	=up_fecha("&ALS_Duplicat")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.T.)
	ENDIF

    SELE &ALS_Duplicat
  	SET ORDER TO TAG doc
    SEEK STR(PrmEmpresa,3)+STR(PrmDuplicata,9)

	IF !FOUND()
	    =up_fecha("&ALS_Retornmv")
    	=up_fecha("&ALS_Duplicat")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	DO CASE
		CASE &ALS_Retornmv .ocorrencia = 06  OR ;
				 &ALS_Retornmv .ocorrencia = 15  OR ;
				 &ALS_Retornmv .ocorrencia = 83  OR ;
				 &ALS_Retornmv .ocorrencia = 81  OR ;
				 &ALS_Retornmv .ocorrencia = 86  OR ;
				 &ALS_Retornmv .ocorrencia = 17  && LIQUIDACAO DO TITULO
	  		     m.efeito	 = 2		  &&  PGTO TOTAL
				*******************   CRITICA *******************
		CASE &ALS_Retornmv .ocorrencia = 07  && ESPECIFICO DO BFB
				*					LIQUIDACAO PARCIAL
	  		     m.efeito	 = 3		&&  PGTO PARCIAL
		OTHERWISE
		    =up_fecha("&ALS_Retornmv")
    		=up_fecha("&ALS_Duplicat")
    		=up_fecha("&ALS_LancaCx")
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
	        RETURN(.F.)
	ENDCASE


    m.EMPRESA 	= PrmEmpresa
    m.TIPO_DOC  = 2            && Codigo Tabela Padrao para DUPLICATA
    m.NUM_DOC   = STR(PrmDuplicata,15)


    m.PORTADOR  = PrmBanco
	m.NOME      = &ALS_Duplicat .nome
    m.data      = &ALS_Retornmv .dtprocesso
    m.valor     = &ALS_Retornmv .vlr_pgto - ;
                     ( &ALS_Retornmv .juros + &ALS_Retornmv .mora ) ;
                     + &ALS_Retornmv .desconto
    m.JUROS     = &ALS_Retornmv .juros + &ALS_Retornmv .mora

    m.DESCONTOS = &ALS_Retornmv .desconto
    m.PROCESSADO   = "N"
    m.OPERACAO     = "CANCELAR"
    m.LOG_LANCA    = "** Cancel. Lanc. Aut.Rec.Carteira."

    sele &ALS_LancaCx
	SET ORDER TO TAG chave_pk
	SEEK 	STR(M.EMPRESA,3)+STR(M.TIPO_DOC,3)+M.NUM_DOC
	IF FOUND()
	    =edithand('APAGA')
	ENDIF
	*---------------------------------------------------------------*
    =up_fecha("&ALS_Retornmv")
    =up_fecha("&ALS_Duplicat")
   	=up_fecha("&ALS_LancaCx")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6MR           CRRefinanciamento VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   17  º
*       º Variable:            CRRefinanciamento                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      15                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6mr     &&  CRRefinanciamento VALID
#REGION 1
RETURN

******************************************************************
*   O CRRefinanciamento - Refinanciamento  simples de uma Duplicata
* permite a alteracao do valor de uma duplicata para menor sondo
* o residuo refinanciado em uma nova duplicata
******************************************************************


FUNCTION  CRRefinanciamento

PARAMETERS LNemp, LNdup, LNNovo_Valor,LNAntigo_Valor
	=W_DEFPROC("rotinas.spr")

	*------------------------------------------*


	PRIVATE LNnvSequencia
	PRIVATE LNnfGeradora  && NF ou Cupom Geradora das Duplicatas
						  && esta contida no numero da duplicata
						  && sendo que qdo e emitida copia do cupom
						  && o campo nota da duplicata e alterado
						  && para o numero do nf copia do cupom
						  && entao o nf geradora incicial fica
						  && domento nas 7 primeiras posicoes
						  && do numero da duplicata
	PRIVATE LSmsg
    PRIVATE ARQ_CtrlRefn,ALS_CtrlRefn
    PRIVATE ARQ_Duplicat,ALS_Duplicat

    LSAlias      = Alias()

    ARQ_CtrlRefn     = NetArqAgain("CtrlRefn")
    ALS_CtrlRefn     = Alias()

    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()

	
	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(LNemp,3)+STR(LNdup,9)
	IF !FOUND()
		LSmsg = "Nao foi possivel realizar refinanciamento. " +;
				"Doc. "+STR(LNdup,9)+" Nao localizado. "
		=fox_alert(LSmsg,.t.)

	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)

	ENDIF
	IF &ALS_Duplicat .vlr_doc <= LNNovo_Valor
		LSmsg = "Nao foi possivel realizar refinanciamento. " +;
				"Novo Valor Deve ser Menor que o Valor Atual da Dupl"
		=fox_alert(LSmsg,.t.)

	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	IF &ALS_Duplicat .vlr_doc <> LNAntigo_Valor
		LSmsg = "Nao foi possivel realizar refinanciamento. " +;
				"Valor da Dupl Nao Corresponde ao Informado"
		=fox_alert(LSmsg,.t.)

	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF



	IF not empty ( &ALS_Duplicat .dt_pgto)
		LSmsg = "Nao se refinancia Duplicata Paga."
		=fox_alert(LSmsg,.t.)

	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*------------------------------------------------------------------*
	wp_msg = "Confirma Solicitacao de Reparcelamento  "
	IF !fox_alert(wp_msg)
	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	wp_msg = "Voce esta reparcelando a Dup.:"+;
	           str( &ALS_Duplicat .duplicata,9 )+"-"+;
	           &ALS_Duplicat .nome +"- de "+;
	           STR( &ALS_Duplicat .vlr_doc,12,2)+" Para "+;
	           STR( LNNovo_Valor,12,2)

	IF !fox_alert(wp_msg)
	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	LNusuario = nUsr
	BTMP   =  'usuario.usuario = LNusuario '
	LNusr_ret = 0

	DO obj_prmt.SPR WITH   wp_msg , Btmp

	IF LNusr_ret =  0
	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	*------------------------------------------------------------------*
	SCATTER MEMVAR
**	LNAntigo_Valor = &ALS_Duplicat .vlr_doc
	*------------------------------------------------------------------*
	LNnfGeradora = int(val(LEFT(str(LNdup,9),7)))


	=W_DEFPROC("duplicat.spr")

 	LNnvSequencia  =  CRUltSeqdupl(LNemp, LNnfGeradora )
    LNnvSequencia  = LNnvSequencia + 2

	=W_DEFPROC("duplicat.spr")
	LNnovadup  = CRNroIDdupl(LNemp, LNnfGeradora ,LNnvSequencia)


	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(LNemp,3)+STR(LNnovadup,9)
	IF FOUND()
		LSmsg = "Nao foi possivel realizar refinanciamento. " +;
				"Todas sequencias 0-9 ocupadas."
		=fox_alert(LSmsg,.t.)

	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*    PERSISTENCIA
	*--------------------------------------------------------------*
	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(LNemp,3)+STR(LNdup,9)

	=RLOCK()

    REPLACE obs WITH  "Dupl.reparcelada gerando Dupl:"+STR(LNnovadup,9)
	REPLACE vlr_doc with LNNovo_Valor
    REPLACE dtregis with date()

	m.duplicata = LNnovadup
    M.CODPARCELA = STR(LNnovadup,9)
	m.vlr_doc   = LNAntigo_Valor - LNNovo_Valor

	m.num_no_bco = ""
	m.banco     = 0
	m.portador  = 0
	m.out_desp  = 0
	m.dsp_cobr  = 0
	m.IOF       = 0
	m.devolucao = 0
	m.mora      = 0
	m.juros     = 0
	m.out_credt = 0
	m.abatimento= 0
	m.desconto  = 0
	m.parc_pgto = 0
	m.vlr_pgto  = 0
    m.flg_refin = .t.
    m.obs = "duplicata original reparcelada = "+ STR(LNdup,9)
	=edithand("SAVE")

    m.flg_refin = .f.
    m.obs = ""
	IF !("CENTRAL" $ UPPER(DBF()))
		select &ALS_CtrlRefn
	    m.empresa    = LNemp
	    m.data       = wp_dtoper
	    m.duplicata  = LNdup
		m.dupnova	 = LNnovadup
		m.antg_valor = LNAntigo_Valor
		m.novo_valor = LNNovo_Valor
		m.status     = "PR"
		=edithand("SAVE")
	ENDIF
	*------------------------------------------------------------------*
    =up_fecha("&ALS_CtrlRefn")
    =up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	LSmsg = "Refinanciamento Realizado com Sucesso."
	=fox_alert(LSmsg,.t.)

RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6N7           CRUltSeqdupl VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   18  º
*       º Variable:            CRUltSeqdupl                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      16                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6n7     &&  CRUltSeqdupl VALID
#REGION 1
RETURN

******************************************************************
*   Em casos de refinanciamento uma nova duplicata sera gerado
* e o numero de sequencia sera incrementado sendo necessario buscar
* a ultima sequencia gerada
******************************************************************


FUNCTION  CRUltSeqdupl

PARAMETERS LNemp,LNnota
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNseqDuplicat
	PRIVATE LNduplicata

    PRIVATE ARQ_Duplicat,ALS_Duplicat

    LSAlias      = Alias()

    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()


	SELE &ALS_Duplicat
	SET ORDER TO TAG doc

	=W_DEFPROC("duplicat.spr")

	LNduplicata = CRNroIDdupl(LNemp,LNnota,0)
	
	LNseqDuplicat = 0

	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNduplicata,9)
	SET NEAR OFF
	
	DO WHILE !EOF() AND ;
	       LNnota = INT(VAL(LEFT( STR( &ALS_Duplicat .duplicata,9) ,7)))
		LNseqDuplicat = ;
		   int(val(LEFT(RIGHT(str( &ALS_Duplicat .duplicata ),2),2)))
		SKIP
	ENDDO
    =up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNseqDuplicat)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6NE           CRChkp_FilDupl VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   19  º
*       º Variable:            CRChkp_FilDupl                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      17                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6ne     &&  CRChkp_FilDupl VALID
#REGION 1
RETURN

PROCEDURE  CRChkp_FilDupl

PARAMETERS LNemp, LDdt_emi

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE  ARQ_Duplicat, ALS_Duplicat, alias_ant

	ALIAS_ANT = ALIAS()


    ARQ_Duplicat  = NetArqAgain("DUPLICAT")
    ALS_Duplicat  = Alias()

	SELE &ALS_Duplicat
	SET ORDER TO TAG emissao
	*----------------------------------------------------------------*


	SELECT empresa,duplicata,dt_emi,dt_pgto,vlr_doc,vlr_pgto,;
	       ((vlr_pgto - (vlr_doc + mora + juros + out_credt ;
	      				- devolucao - abatimento - desconto))) as DIFERENCA,;
    	    mora,juros,out_credt, ;
       		devolucao,abatimento , desconto, nome ;
		FROM  &ALS_Duplicat ;
		WHERE  ;
				   dt_emi >= LDdt_emi AND empresa = LNemp ;
		       AND ;
		       (;
				    (dt_pgto = {} ;
				       AND (vlr_pgto <> parc_pgto);
				    );
			    OR (;
					 (dt_pgto > {} ;
					   AND abs(vlr_pgto - (vlr_doc + mora + juros + out_credt ;
	      				- devolucao - abatimento - desconto)) > 2;
				     );
		           );
		        );
		 ORDER BY empresa, dt_emi;
		INTO CURSOR DPL_BUG

	*----------------------------------------------------------------*
    SELE &ALS_Duplicat
	SET ORDER TO TAG DOC


	SELECT DPL_BUG
	GO TOP
	DO WHILE !EOF()
	    SELE &ALS_Duplicat
		SEEK STR(DPL_BUG.EMPRESA,3)+STR(DPL_BUG.DUPLICATA,9)
		IF FOUND()
			SET PROCEDURE TO DUPLICAT.SPR
			m.pago = CRobtvlrpg(DPL_BUG.EMPRESA,DPL_BUG.DUPLICATA)

		    SELE &ALS_Duplicat
			=rlock()
			REPLACE vlr_pgto WITH m.pago
		ENDIF		
		SELE DPL_BUG
		SKIP
	ENDDO

    =up_fecha("DPL_BUG")
    =up_fecha("&ALS_Duplicat")
    IF USED(ALIAS_ANT)
		SELE 	&ALIAS_ANT
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6NF           CRChkp_AllDupl VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   20  º
*       º Variable:            CRChkp_AllDupl                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      18                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6nf     &&  CRChkp_AllDupl VALID
#REGION 1
RETURN

PROCEDURE  CRChkp_AllDupl

PARAMETERS LDdt_emi

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE  ARQ_Duplicat, ALS_Duplicat, alias_ant

	ALIAS_ANT = ALIAS()


    ARQ_Duplicat  = NetArqAgain("DUPLICAT")
    ALS_Duplicat  = Alias()

	SELE &ALS_Duplicat
	SET ORDER TO TAG emissao
	*----------------------------------------------------------------*


	SELECT empresa,duplicata,dt_emi,dt_pgto,vlr_doc,vlr_pgto,;
	       ((vlr_pgto - (vlr_doc + mora + juros + out_credt ;
	      				- devolucao - abatimento - desconto))) as DIFERENCA,;
    	    mora,juros,out_credt, ;
       		devolucao,abatimento , desconto, nome ;
		FROM  &ALS_Duplicat ;
		WHERE  ;
			   dt_emi >= LDdt_emi;
		       AND ;
		       (;
				    (dt_pgto = {} ;
				       AND (vlr_pgto <> parc_pgto);
				    );
			    OR (;
					 (dt_pgto > {} ;
					   AND abs(vlr_pgto - (vlr_doc + mora + juros + out_credt ;
	      				- devolucao - abatimento - desconto)) > 2;
				     );
		           );
		        );
		 ORDER BY empresa, dt_emi;
		INTO CURSOR DPL_BUG

	*----------------------------------------------------------------*
    SELE &ALS_Duplicat
	SET ORDER TO TAG DOC


	SELECT DPL_BUG
	GO TOP
	DO WHILE !EOF()
	    SELE &ALS_Duplicat
		SEEK STR(DPL_BUG.EMPRESA,3)+STR(DPL_BUG.DUPLICATA,9)
		IF FOUND()
			SET PROCEDURE TO DUPLICAT.SPR
			m.pago = CRobtvlrpg(DPL_BUG.EMPRESA,DPL_BUG.DUPLICATA)

		    SELE &ALS_Duplicat
			=rlock()
			REPLACE vlr_pgto WITH m.pago
		ENDIF		
		SELE DPL_BUG
		SKIP
	ENDDO

    =up_fecha("DPL_BUG")
    =up_fecha("&ALS_Duplicat")
    IF USED(ALIAS_ANT)
		SELE 	&ALIAS_ANT
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6NG           CRobtvlrpg VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   21  º
*       º Variable:            CRobtvlrpg                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      19                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6ng     &&  CRobtvlrpg VALID
#REGION 1
RETURN

FUNCTION  CRobtvlrpg

PARAMETERS LNemp,LNduplicata

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE  ARQ_RetornMv, ALS_RetornMv, alias_ant
    PRIVATE  LNvlr_pago;

	ALIAS_ANT = ALIAS()

    ARQ_RetornMv  = NetArqAgain("RETORNMV")
    ALS_RetornMv  = Alias()

	SELE &ALS_RetornMv
	SET ORDER TO TAG doc_ocor
	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
    LNvlr_pago   = 0

	SET NEAR ON
*	SEEK STR(LNemp,3)+STR(LNduplicata,9)
	SEEK STR(LNduplicata,9)

	SET NEAR OFF

    LNvlr_pago   = 0
	DO WHILE !EOF() ;
				 AND LNemp       = &ALS_RetornMv .empresa ;
	             AND LNduplicata = &ALS_RetornMv .duplicata

		IF &ALS_RetornMv .dtprocesso <> {}
	        LNvlr_pago = LNvlr_pago + &ALS_RetornMv .vlr_pgto
		ENDIF
		SKIP
	ENDDO
    =up_fecha("&ALS_RetornMv")
    IF USED(ALIAS_ANT)
		SELE 	&ALIAS_ANT
	ENDIF

RETURN(LNvlr_pago)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6O0           CRgetNvVlrDup VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   22  º
*       º Variable:            CRgetNvVlrDup                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      20                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6o0     &&  CRgetNvVlrDup VALID
#REGION 1
RETURN

FUNCTION CRgetNvVlrDup

  PARAMETERS PRMempresa, PRMduplicata, PRMvalor

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSmsg
	PRIVATE LSalias
    PRIVATE ARQ_Duplicat,ALS_Duplicat
	PRIVATE LNDiasatr
	PRIVATE LNVlrmulta
	PRIVATE LNVlrjuros
	PRIVATE LNVlrDesp
	PRIVATE LNVlrReceb
	PRIVATE LNVlrLiq
    PRIVATE	LNnovoVlr


    LSAlias      = Alias()

    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()

	*------------------------------------------------------------*

	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(PrmDuplicata,9)
	IF !FOUND()
		LSmsg = "Nao foi possivel calcular valo parcela refinanciamento. ";
				 + "Doc. "+STR(LNdup,9)+" Nao localizado. "
		=fox_alert(LSmsg,.t.)

	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF


	LNDiasatr  = 0
	LNVlrmulta = 0
	LNVlrjuros = 0
	LNVlrDesp  = 0
	LNVlrReceb = 0
	LNVlrLiq   = 0
    LNnovoVlr  = 0

	SELE EMPRESA
	SET ORDER TO TAG EMPRESA
	SEEK duplicat.empresa

	SELE DUPLICAT
	LNMULTA    = empresa.multa
	LNJUROS    = empresa.mora

	DO ocr0001.spr WITH ;
			&ALS_Duplicat .duplicata,;
			&ALS_Duplicat .cliente,;
			&ALS_Duplicat .nome,;
			&ALS_Duplicat .dt_venc,;
			&ALS_Duplicat .dt_pgto,;
			&ALS_Duplicat .vlr_doc,;
			LNMulta,LNJuros,;
        	LNDiasatr,LNVlrmulta,LNVlrjuros,LNVlrDesp,LNVlrReceb,LNVlrLiq,;
          	&ALS_Duplicat .dsp_cobr,;
          	&ALS_Duplicat .out_desp,;
          	&ALS_Duplicat .abatimento,;
          	&ALS_Duplicat .desconto,;
          	&ALS_Duplicat .parc_pgto,;
          	LNnovoVlr

	*------------------------------------------------------------*

    =up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNnovoVlr)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6O7           CRNv_VlrDup VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   23  º
*       º Variable:            CRNv_VlrDup                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      21                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6o7     &&  CRNv_VlrDup VALID
#REGION 1
RETURN

FUNCTION CRNv_VlrDup

PARAMETERS PrmVlrDup,PrmTotalaPagar,PrmDtPgto, PrmDtVenc, PrmTaxaJuros,;
           PrmOutDespeas,PrmVlrDesconto, PrmVlrabat, PrmVlrdev,;
           PrmVlrpgparcial

	=W_DEFPROC("rotinas.spr")
	PRIVATE LNDiasatr
	PRIVATE	LNVlrParcela
	PRIVATE LNjuros
	PRIVATE LNVlrjuros
	PRIVATE LNvlrFinal

	*------------------------------------------*

	IF PrmTotalaPagar < PrmVlrpgparcial
		WAIT WINDOW ;
			"Total a Pagar deve ser Maior ou Igual ao Pg.Parcial <Enter>"
		RETURN
	ENDIF


	IF EMPT(PrmDtPgto) OR EMPT(PrmDtVenc)
	   LNDiasatr  = 0
	  ELSE
	   LNDiasatr  = PrmDtPgto - PrmDtVenc
	ENDI



	LNdespesas    =  PrmOutDespeas
*
*	LNdescontos   =  PrmVlrdev +  PrmVlrabat + PrmVlrDesconto +;
* 	                   PrmVlrpgparcial
*
*	LNvlrFinal = PrmTotalaPagar + LNdescontos - LNdespesas
*

	LNdescontos   =  PrmVlrdev +  PrmVlrabat + PrmVlrDesconto
  	

	LNvlrFinal = PrmTotalaPagar + LNdescontos - LNdespesas
	


	LNVlrParcela = 0
	LNjuros      = 0
	LNVlrjuros   = 0




	DO WHILE LNVlrParcela + LNVlrjuros + PrmVlrpgparcial <= ;
	           LNvlrFinal +  PrmVlrpgparcial
		LNVlrParcela = LNVlrParcela + 1
		IF LNVlrParcela > PrmVlrpgparcial
			LNVlrmulta=((LNVlrParcela - PrmVlrpgparcial) * PrmTaxaJuros)/100
		ENDIF
		LNjuros      = (LNVlrmulta/30)
		LNVlrjuros   = LNjuros * LNDiasatr
	ENDDO

	LNVlrParcela = LNVlrParcela - 1

	DO WHILE LNVlrParcela + LNVlrjuros + PrmVlrpgparcial  < ;
	           LNvlrFinal +  PrmVlrpgparcial
	
		LNVlrParcela = LNVlrParcela + 0.01
		IF LNVlrParcela > PrmVlrpgparcial
			LNVlrmulta=((LNVlrParcela - PrmVlrpgparcial) * PrmTaxaJuros)/100
		ENDIF
		LNjuros      = (LNVlrmulta/30)
		LNVlrjuros   = LNjuros * LNDiasatr
	ENDDO


RETURN(LNVlrParcela)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6OG           CR_001geraNssNro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   24  º
*       º Variable:            CR_001geraNssNro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      22                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6og     &&  CR_001geraNssNro VALID
#REGION 1
RETURN

FUNCTION  CR_001geraNssNro

PARAMETERS PrmEmpresa,PrmBanco,PrmCarteira,PrmVariacao
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*

	PRIVATE LSnossoNro
	PRIVATE LSalias
    PRIVATE ARQ_Cobranca,ALS_Cobranca
	

    LSAlias      = Alias()


    ARQ_Cobranca     = NetArqAgain("Cobranca")
    ALS_Cobranca     = Alias()

	SELE &ALS_Cobranca

	SET ORDER TO TAG operacao
	seek str(PrmEmpresa,3) + STR(PrmBanco,3) + "BOLETO EMPRESA"
		
	=RLOCK()

*----------------------------------------------------*
*REGRA SUBSTITUIDA EM 29/11/2011
*----------------------------------------------------*
*	IF LEN(ALLTRIM( &ALS_Cobranca .convenio )) = 7
*		LSnossoNro = ALLTRIM( &ALS_Cobranca .convenio )+ ;
*	           STRTRAN(STR( &ALS_Cobranca .BLT_SEQATU,4), " ","0")
*
*----------------------------------------------------*


	IF LEN(ALLTRIM( &ALS_Cobranca .convenio )) = 7
		LSnossoNro = ALLTRIM( &ALS_Cobranca .convenio )+ ;
	           STRTRAN(STR( &ALS_Cobranca .BLT_SEQATU,10), " ","0")




       *----------------------------------------------------------*
       *REGRA SUBSTITUIDA EM 08/05/2014 (VOLTANDO NSSO NRO SEM O DV)
       *----------------------------------------------------------*
   	   LSnossoNro = LSnossoNro+ CR_001_17DIGITO_NSSNRO(LSnossoNro)

   	   LSnossoNro = CHRTRAN(LSnossoNro,"X","0")



*      LSnossoNro = LSnossoNro


	ELSE

		LSnossoNro = ALLTRIM( &ALS_Cobranca .convenio )+ ;
	           STRTRAN(STR( &ALS_Cobranca .BLT_SEQATU,5), " ","0")

  	    LSnossoNro = LSnossoNro+ CR_001DIGITO_NSSNRO(LSnossoNro)

	ENDIF



	REPLACE  &ALS_Cobranca .BLT_SEQATU WITH ;
			  &ALS_Cobranca .BLT_SEQATU + 1
    =up_fecha("&ALS_Cobranca")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LSnossoNro)


FUNCTION CR_001DIGITO_NSSNRO
PARAMETERS PrmNumero

   PRIVATE LsNro_aux
   PRIVATE LnSoma
   PRIVATE Lnresto
   PRIVATE LnDigito_1
   PRIVATE LsDigito_1
   if type("PrmNumero") = "N"
	   LsNro_aux  = strtran(str(PrmNumero,11)," ","0")
   ELSE
	   LsNro_aux  = strtran(LEFT(PrmNumero,11)," ","0")
   ENDIF
   LnSoma  = 0
   Lnresto    = 0
   LnDigito_1 = 0
   LnPosicao     = 0
   LnPeso   = 7

   for LnPosicao = 1 to 11
       LnSoma = LnSoma + val(subs(LsNro_aux,LnPosicao,1))*LnPeso
       LnPeso = LnPeso + 1
       if LnPeso = 10
	       LnPeso = 2
	   endif
   next
   Lnresto = mod(LnSoma,11)

   DO CASE
		CASE Lnresto  < 10
			LsDigito_1 = STRTRAN(STR(LnResto,1)," ","0")
		CASE Lnresto  = 10
			LsDigito_1 = "X"
   ENDCASE

RETURN(LSdigito_1)

FUNCTION CR_001_17DIGITO_NSSNRO
PARAMETERS PrmNumero

   PRIVATE LsNro_aux
   PRIVATE LnSoma
   PRIVATE Lnresto
   PRIVATE LnDigito_1
   PRIVATE LsDigito_1
   if type("PrmNumero") = "N"
	   LsNro_aux  = strtran(str(PrmNumero,17)," ","0")
   ELSE
	   LsNro_aux  = strtran(LEFT(PrmNumero,17)," ","0")
   ENDIF
   LnSoma  = 0
   Lnresto    = 0
   LnDigito_1 = 0
   LnPosicao     = 0
   LnPeso   = 9

   for LnPosicao = 1 to 17
       LnSoma = LnSoma + val(subs(LsNro_aux,LnPosicao,1))*LnPeso
       LnPeso = LnPeso + 1
       if LnPeso = 10
	       LnPeso = 2
	   endif
   next
   Lnresto = mod(LnSoma,11)

   DO CASE
		CASE Lnresto  < 10
			LsDigito_1 = STRTRAN(STR(LnResto,1)," ","0")
		CASE Lnresto  = 10
			LsDigito_1 = "X"
   ENDCASE

RETURN(LSdigito_1)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6OS           CR_237geraNssNro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   25  º
*       º Variable:            CR_237geraNssNro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      23                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6os     &&  CR_237geraNssNro VALID
#REGION 1
RETURN

FUNCTION  CR_237geraNssNro

PARAMETERS PrmEmpresa,PrmBanco,PrmCarteira,PrmVariacao
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*

	PRIVATE LSnossoNro
	PRIVATE LSalias
    PRIVATE ARQ_Cobranca,ALS_Cobranca
	

    LSAlias      = Alias()


    ARQ_Cobranca     = NetArqAgain("Cobranca")
    ALS_Cobranca     = Alias()

	SELE &ALS_Cobranca

	SET ORDER TO TAG operacao
	seek str(PrmEmpresa,3) + STR(PrmBanco,3) + "BOLETO EMPRESA"
		
	=RLOCK()


	LSnossoNro =  ;
	           STRTRAN(STR( &ALS_Cobranca .BLT_SEQATU,11), " ","0")


	LSnossoNro = LSnossoNro+ ;
  	       CR_237DIGITO_NSSNRO( &ALS_Cobranca .carteira ,LSnossoNro)
  	



	REPLACE  &ALS_Cobranca .BLT_SEQATU WITH ;
			  &ALS_Cobranca .BLT_SEQATU + 1
    =up_fecha("&ALS_Cobranca")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LSnossoNro)


FUNCTION CR_237DIGITO_NSSNRO
PARAMETERS PrmCarteira , PrmNumero

   PRIVATE LsNro_aux
   PRIVATE LnSoma
   PRIVATE Lnresto
   PRIVATE LnDigito_1
   PRIVATE LsDigito_1
   if type("PrmNumero") = "N"
	   LsNro_aux  = strtran(str(PrmNumero,11)," ","0")
   ELSE
	   LsNro_aux  = strtran(LEFT(PrmNumero,11)," ","0")
   ENDIF
   LsNro_aux   = PrmCarteira + LsNro_aux


   LnSoma  = 0
   Lnresto    = 0
   LnDigito_1 = 0
   LnPosicao     = 0
   LnPeso   = 2

   for LnPosicao = 1 to 13
       LnSoma = LnSoma + val(subs(LsNro_aux,LnPosicao,1))*LnPeso
       LnPeso = LnPeso - 1
       if LnPeso = 1
	       LnPeso = 7
	   endif
   next
   Lnresto = mod(LnSoma,11)


   DO CASE
		CASE  Lnresto  > 1
			LsDigito_1 = STRTRAN(STR( 11 - LnResto ,1)," ","0")
		CASE  Lnresto = 1
			LsDigito_1 = "P"
		CASE  Lnresto = 0
			LsDigito_1 = "0"
   ENDCASE

RETURN(LSdigito_1)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6P0           CRProc237 VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   26  º
*       º Variable:            CRProc237                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      24                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6p0     &&  CRProc237 VALID
#REGION 1
RETURN

FUNCTION CRProc237

	DO CASE
	   CASE retornmv.ocorrencia = 02  && ENTRADA CONFIRMADA
		    m.portador    = retornbc.banco
		 	m.agencia     = retornmv.agenc_cobr
		 	m.num_no_bco  = retornmv.num_no_bco
			m.ConfNroBco  = .t.
	   CASE retornmv.ocorrencia = 03   && ENTRADA REJEITADA
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia = 06 && LIQUIDACAO DO NORMAL
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia = 09  && BAIXADO AUT. VIA ARQUIVO
			 m.portador	=	0      && inf. carteira CR e Cobranca
			 m.agencia  =   0
	   CASE retornmv.ocorrencia = 10 && BAIXADOS CONF INST AGENC
			 m.portador	=	0      && inf. carteira CR e Cobranca
			 m.agencia  =   0
		CASE retornmv.ocorrencia = 12 && ABATIMENTO CONCEDIDO
			m.abatimento= 	retornmv.abatimento
		CASE retornmv.ocorrencia = 13 && ABATIMENTO CANCELADO
			m.abatimento= 	0
		CASE retornmv.ocorrencia = 14 && VENCIMENTO ALTERADO
			m.dt_venc	=	retornmv.vencimento
	   CASE retornmv.ocorrencia = 15 && LIQUIDACAO EM CARTORIO
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia = 17 && LIQUIDACAO APOS BX OU TIT NAO REG
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia  = 19 && INSTR. PROTESTO CONFIRMADO
			m.trf_cart 	=  	retornmv.trf_cart
	   CASE retornmv.ocorrencia  = 20 && INSTR. PROTESTO CANCELADA
			m.trf_cart 	=  	retornmv.trf_cart
  	   CASE retornmv.ocorrencia = 23 && ENTRADA CARTORIO
			m.tp_cobranc=   88    && COBRANCA EM CARTORIO
			m.trf_cart 	=  	retornmv.trf_cart
	   CASE retornmv.ocorrencia  = 24   && REJ. CEP IRREGULAR
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia  = 27   && BAIXA REJ
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia  = 28 && Debito de Tarifas/Custas
			IF LEFT(retornmv.motivos,2) = "08" && CUSTAS DE PROTESTO
				m.tp_cobranc=   89    && PROTESTADA
			ENDIF			
			LFprocessa	=	.T.
	   CASE retornmv.ocorrencia  = 30   && REJ. ALT DE OUTROS DADOS
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia  = 32   && INSTRUCAO REJ.
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia = 33   && ENTRADA REJEITADA
			LFprocessa	=	.T.
       CASE retornmv.ocorrencia = 34 &&ALTERACAO DADOS CONF
			m.tp_cobranc=   1    && COBRANCA SIMPLES
			m.trf_cart 	=  	retornmv.trf_cart
	ENDCASE			
RETURN(.T.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6P1           CRProc001 VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   27  º
*       º Variable:            CRProc001                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      25                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6p1     &&  CRProc001 VALID
#REGION 1
RETURN

FUNCTION CRProc001

	LFprocessa	=	.t.
    m.efeito	 = 0		&&  NULO (indica efeto no Contas a Rec)
	DO CASE
	   CASE retornmv.ocorrencia = 02  && ENTRADA CONFIRMADA
		    m.portador    = retornbc.banco
		 	m.agencia     = retornmv.agenc_cobr
		 	m.num_no_bco  = retornmv.num_no_bco
			m.ConfNroBco  = .t.
	   CASE retornmv.ocorrencia = 03   && ENTRADA REJEITADA
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia = 05 && LIQUIDACAO sem registro
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia = 06 && LIQUIDACAO DO NORMAL
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF

	   CASE retornmv.ocorrencia = 07 && LIQUIDACAO por conta
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia = 08 && LIQUIDACAO por saldo
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia = 09  && BAIXADO AUT. VIA ARQUIVO
			 m.portador	=	0      && inf. carteira CR e Cobranca
			 m.agencia  =   0
	    CASE retornmv.ocorrencia = 10 && BAIXADOS CONF INST AGENC
			 m.portador	=	0      && inf. carteira CR e Cobranca
			 m.agencia  =   0
		CASE retornmv.ocorrencia = 12 && ABATIMENTO CONCEDIDO
			m.abatimento= 	retornmv.abatimento
		CASE retornmv.ocorrencia = 13 && ABATIMENTO CANCELADO
			m.abatimento= 	0
		CASE retornmv.ocorrencia = 14 && VENCIMENTO ALTERADO
			m.dt_venc	=	retornmv.vencimento
	    CASE retornmv.ocorrencia = 15 && LIQUIDACAO EM CARTORIO
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia  = 19 && INSTR. PROTESTO CONFIRMADO
			m.trf_cart 	=  	retornmv.trf_cart
  	   CASE retornmv.ocorrencia = 23 && ENTRADA CARTORIO
			m.tp_cobranc=   88    && COBRANCA EM CARTORIO
			m.trf_cart 	=  	retornmv.trf_cart
	   CASE retornmv.ocorrencia  = 27   && BAIXA REJ
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia  = 30   && REJ. ALT DE OUTROS DADOS
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia  = 32   && INSTRUCAO REJ.
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia  = 96 && Debito de Tarifas/Custas
			m.tp_cobranc=   89    && PROTESTADA
			LFprocessa	=	.T.

	ENDCASE			
RETURN(.T.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6PL           CRProcantigo VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   28  º
*       º Variable:            CRProcantigo                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      26                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6pl     &&  CRProcantigo VALID
#REGION 1
RETURN

FUNCTION CRProcantigo


			LFprocessa	=	.t.
 		    m.efeito	 = 0		&&  NULO (indica efeto no Contas a Rec)
			DO CASE   && processa ocor 02/06/07/09/10/12/13/14/17/19/
					  && 	   20/23/28/34/80/81/82/83/84/85/86/87/88
				      &&   E  03/24/27/30/32/   && REJEICOES
				CASE retornmv.ocorrencia = 02	&& ENTRADA EM COBRANCA

					*-----------------------------------------------*
					*   (ANTES)
					*    So Aceitar Registro de Entrada em Cobranca
					* Bancaria se o Portador for CARTEIRA(0)
					*-----------------------------------------------*
					*   09/08/20001
					*    Com implanta‡Æo do controle de cartäes
					* os erros dos operadores exigiam a mudan‡a do
					* portador conforme detectado na filial SIA
					* para evitar transtornos da conexÆo para altera‡Æo
					* de portador com pessoa do cpd liberamos a trava
					*--------------------------------------------------*
					
					IF EMPTY(duplicat.DT_PGTO)
					    m.portador    = retornbc.banco
					 	m.agencia     = retornmv.agenc_cobr
					ENDIF
				 	m.num_no_bco  = retornmv.num_no_bco
					m.ConfNroBco  = .t.
			 		 	***** m.banco      = retornmv.banco
					*-------------------------------------------------*
				CASE duplicat.tp_cobranc = 06  AND ;
  					 retornmv.ocorrencia = 06
					 *----------------------------------------------*
					 *=> Pagamento de titulo VENDOR
					 *----------------------------------------------*
	
		  		     m.efeito	 = 2		  &&  PGTO TOTAL
					*******************   CRITICA *******************
					 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
						LFprocessa	=	.F.
					 ELSE
						 SCATTER FIELDS juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto, ;
								dtocorrenc  MEMVAR
						 m.vlr_pgto = duplicat.vlr_doc
						 m.dt_pgto  = m.dtocorrenc
						 m.dt_baixa = m.dtprocesso
						 m.paga_em  = retornmv.banco
					ENDIF
				CASE retornmv.ocorrencia = 06  OR ;
  					 retornmv.ocorrencia = 05  OR ;
  					 retornmv.ocorrencia = 15  OR ;
  					 retornmv.ocorrencia = 83  OR ;
  					 retornmv.ocorrencia = 17  && LIQUIDACAO DO TITULO
		  		     m.efeito	 = 2		  &&  PGTO TOTAL
					*******************   CRITICA *******************
					 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
						LFprocessa	=	.F.
					 ELSE
						 SCATTER FIELDS juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto, ;
								dtocorrenc  MEMVAR
						 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
						 m.dt_pgto  = m.dtocorrenc
						 m.dt_baixa = m.dtprocesso
						 m.paga_em  =	 retornmv.banco
					ENDIF
				CASE retornmv.ocorrencia = 07  && ESPECIFICO DO BFB
					*			LIQUIDACAO PARCIAL
					***************************************************
					* VIZUALIZAR CRITICA
					*************************************************
		  		     m.efeito	 = 3		&&  PGTO PARCIAL
					 SCATTER FIELDS juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto, ;
								dtocorrenc  MEMVAR
					 *-------------------------------------------------*
					 * Ocorrencia 7 nao pode ser usada para saldar o valor
					 * da duplicata. Neste caso deve-se usar 83 (Liq.Saldo)
					 *-------------------------------------------------*
					 IF (m.vlr_pgto + retornmv.vlr_pgto) >= duplicat.vlr_doc
						LFprocessa	=	.F.
					 ELSE
						 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
						 m.parc_pgto = m.parc_pgto + retornmv.vlr_pgto
						 m.paga_em  =	 retornmv.banco
					ENDIF
				CASE retornmv.ocorrencia = 09 OR ;
					 retornmv.ocorrencia = 10 && BAIXADOS
					 m.portador	=	0      && inf. carteira CR e Cobranca
					 m.agencia  =   0
				CASE retornmv.ocorrencia = 12 && ABATIMENTO CONCEDIDO
					m.abatimento= 	retornmv.abatimento
				CASE retornmv.ocorrencia = 13 && ABATIMENTO CANCELADO
					m.abatimento= 	0
				CASE retornmv.ocorrencia = 14 && VENCIMENTO ALTERADO
					m.dt_venc	=	retornmv.vencimento
				CASE retornmv.ocorrencia = 19 && INSTR. PROTESTO CONFIRMADO
					m.trf_cart 	=  	retornmv.trf_cart
				CASE retornmv.ocorrencia = 20 && INSTR. PROTESTO CANCELADA
					m.trf_cart 	=  	retornmv.trf_cart
				CASE retornmv.ocorrencia = 23 && ENTRADA CARTORIO
					m.tp_cobranc=   88    && COBRANCA EM CARTORIO
					m.trf_cart 	=  	retornmv.trf_cart

				CASE retornmv.ocorrencia = 24 && Sust Prot
					LFprocessa	=	.T.


				CASE retornmv.ocorrencia = 28 && Debito de Tarifas/Custas
					 LFok = .T.
				CASE retornmv.ocorrencia = 34 && ENTRADA CARTORIO
					m.tp_cobranc=   1    && COBRANCA SIMPLES
					m.trf_cart 	=  	retornmv.trf_cart

				******** INSTRUCOES DE CARTEIRA

				CASE retornmv.ocorrencia = 85 && ALTERCACAO DE VLR DE DUPL.

					 m.vlr_doc =  retornmv.vlr_pgto

				CASE   retornmv.ocorrencia = 80 ;
				    OR retornmv.ocorrencia = 84 ;
				    OR retornmv.ocorrencia = 50

	*			CASE    retornmv.ocorrencia = 50
	
					&& LIQ. POR DEVOLUCAO // DEVOL. PARCIAL
			 		 m.efeito	 = 4		&&  DEVOLUCAO
					 SCATTER FIELDS juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto, ;
								dtocorrenc  MEMVAR
    				
    				 && 80 - LIQUID. POR DEVOL.
    				 && 50 - LIQUID. POR DEVOL. cancela contrato

					 IF retornmv.ocorrencia = 80 or retornmv.ocorrencia = 50
	
						*******************   CRITICA *******************
						 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
							LFprocessa	=	.F.
						 ELSE
							 m.devolucao = m.devolucao + retornmv.vlr_pgto
							 m.dt_pgto  = m.dtocorrenc
							 m.dt_baixa = m.dtprocesso
							 m.paga_em  = retornmv.banco
						 ENDIF
					 ELSE
							 m.devolucao = m.devolucao + retornmv.vlr_pgto
					 ENDIF

				&& 81 DUPLICATA INCOBRAVEL
				&& 86 SALDO DE DUPLICATA IMCOBRAVEL
				CASE retornmv.ocorrencia = 81  OR ;
  					 retornmv.ocorrencia = 86

					*******************   CRITICA *******************
					 SCATTER FIELDS juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto, ;
								dtocorrenc  MEMVAR

					 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
						LFprocessa	=	.F.
					 ELSE
				 		 m.efeito	 = 5		&&  INCOBRAVEL
 					 	 m.tp_cobranc=   99    && INCOBRAVEL
						 m.dt_pgto  = m.dtocorrenc
						 m.dt_baixa = m.dtprocesso
						 m.paga_em  =	 retornmv.banco
						 m.status = "I"
					 ENDIF
*				CASE retornmv.ocorrencia = 82  && ALTERA DIRECIONA. COBRANCA
*					IF EMPTY(duplicat.DT_PGTO)
*					    m.portador    = retornbc.banco
*					 	m.agencia     = retornmv.agenc_cobr
*					ENDIF
*

				CASE retornmv.ocorrencia = 87 && DESPESAS C/ VIAGENS
					 LFok = .T.
				CASE retornmv.ocorrencia = 88 && OUTRAS DESPESAS
					 LFok = .T.

				CASE retornmv.ocorrencia = 00 && Lanc em cc depositante
					LFprocessa	=	.T.

				CASE retornmv.ocorrencia = 96 && desp ped baixa prot
					LFprocessa	=	.T.

				CASE retornmv.ocorrencia = 97 && sust prot
					LFprocessa	=	.T.


				CASE retornmv.ocorrencia = 98 && custas cart
					LFprocessa	=	.T.

				OTHERWISE   && 03/24/27/30/32/   && REJEICOES
					LFprocessa	=	.F.
			ENDCASE			
RETURN(.T.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6PX           CRgeraVdor VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   29  º
*       º Variable:            CRgeraVdor                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      27                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6px     &&  CRgeraVdor VALID
#REGION 1
RETURN

PROCEDURE CRgeraVdor		&& USADA EM SCGC201, SCGCF201, SCGC201A
	PARAMETERS LNEmp,LNOrcamento
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE nota	&& O NUMERO DA NOTA DEVE SER O DA 1a NOTA CASO
					&& TENHAM SIDO GERADAS DUAS COM BASE NO MESMO ORCAMENTO
					&& PARA EVITAR INFLUENCIA NO AMBENTE NOTA E PRIVATE

	PRIVATE 	LNocorrenc, LNposic, LNinicio, LNnumpgt, LNdias, LNserie
	PRIVATE 	CVSTR1,CVSTR2,LNvlrdupl,LNdifere

	PRIVATE	empresa,duplicata,dt_emi,multa_prv,mora_prv,bonus_prv,;
			prem_pont,vlr_fatura,portador,tp_cobranc,;
			desconto,regiao,natu,nome,tp_cobranc

	PRIVATE dt_venc, dtproxproc
	PRIVATE LNtmp,banco

   	PRIVATE LNTp_parcela,LNbanco,LNvlrent,LSprazo,LDdtemi,LNmulta,LNmora
  	PRIVATE LNbonus,LNPremPont,LNRegiao,LNnatureza,LSnome,LNvlrfatura	
    PRIVATE LNnronota	

	PRIVATE LFduplicata,LFempresa,LForcamento,LFclienc,LFvendor
	PRIVATE LFclientes
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFduplicata	= NetArq("duplicat")
	LFempresa   = NetArq("Empresa" )
	LForcamento = NetArq("Orcament")
	LFvendor    = NetArq("Vendor")
	LFclienc    = NetArq("clienc")
	LFclientes  = NetArq("clientes")
	IF (LFduplicata+LFempresa+LForcamento+LFvendor) > 100000 OR ;
		(LFclientes+LFclienc) > 100000
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" 	  ,LFclienc )
		=UP_fecha("Vendor"  ,LFvendor )
		=UP_fecha("clientes"  ,LFclientes )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

	*----------------------------------------------------------------*
	wp_msg = "Gerando Vendor: "+STR(orcament.nota,7)
	WAIT WINDOW wp_msg NOWAIT



	*----------------------------------------------------------------*
	DO ULgeraDupl
	*----------------------------------------------------------------*
	*-----------------------------------------------------------*
	SET DECIMALS TO 2
	=UP_fecha("duplicat"  ,LFduplicata)
	=UP_fecha("empresa"   ,LFempresa)
	=UP_fecha("orcamento" ,LForcamento)
	=UP_fecha("clienc"    ,LFclienc)
	=UP_fecha("vendor"    ,LFvendor)
	=UP_fecha("clientes"  ,LFclientes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN




	*----------------------------------------------------------------*
PROCEDURE ULgeraDupl

	LNcliente	= clienc.cliente	
  	LNmulta		= empresa .multa
  	LNmora		= empresa .mora
  	LNbonus		= empresa .bonus
  	LNPremPont	= empresa .prem_pont
  	LNRegiao	= clienc.regiao
	LNnatureza	= clienc.natu_cli
	LSnome		= clienc.nome

	SELECT &LSalias
	*-----------------------------------------------------------*
	*   Garante a Elimina‡Æo de Registros de Duplicatas Deixados
	* por falha
	*-----------------------------------------------------------*
	SELE vendor
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

	=CRcancdupl((LNemp),(vendor.nota))
	*-----------------------------------------------------------*

	m.empresa	= LNemp
	m.nota		= vendor.nota
	m.duplicata	= vendor.nota
	m.cliente	= LNcliente
	m.multa_prv	= LNmulta
	m.mora_prv	= LNmora
	m.bonus_prv	= LNbonus
	m.prem_pont	= LNPremPont


	m.tp_cobranc= 01

	m.desconto  = 0
	m.regiao    = LNregiao
	m.natu      = LNnatureza
	m.nome      = LSnome
	m.tp_cobranc= 01 		  && COB. SIMPLES

	*-----------------------------------------------------------*
	*   Tratando os Registro Referentes a Entradas (MODO_PGTO = 1)
	*-----------------------------------------------------------*

	SELE vendor
	DO WHILE !EOF() AND LNemp       = vendor.empresa ;
					AND LNorcamento = vendor.orcamento

		m.duplicata =   vendor.duplicata
		m.tp_parcela=  	6
		m.moeda 	=	6
		m.dt_emi	= 	vendor.dt_emi
		m.vlr_fatura=   vendor.vlr_Compra
		m.vlr_encarg=   vendor.vlr_encarg
		m.vlr_ioffnc=   vendor.vlr_ioffnc
		m.portador 	=   vendor.banco
		m.tx_jurosvd=   vendor.tx_jurosvd
		m.tx_juroscp=   vendor.tx_juroscp
		m.iof_fin   =   vendor.iof_fin

		m.banco 	 =	vendor.banco
		m.vlr_doc	 =	vendor.vlr_doc
		m.vlr_pgto   =   0
		m.dt_venc	 =	vendor.dt_venc
		m.flg_vendor = .t.
		m.obs =""

		SELE  duplicat
		=edithand('SAVE')
		SELE vendor
		SKIP
	ENDDO

RETURN
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6Q9           CRtxsVendor VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   30  º
*       º Variable:            CRtxsVendor                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      28                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6q9     &&  CRtxsVendor VALID
#REGION 1
RETURN

FUNCTION CRtxsVendor
PARAMETERS PrmEmpresa,PrmData,PrmVenc,PrmTp_Pessoa,;
  		Rtn_AIA,;
  		Rtn_AIOF,;
  		Rtn_d,;
  		Rtn_iC_comprador,;
  		Rtn_iC_vendor


	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*

	PRIVATE LNprazo,LFretorno
    PRIVATE ARQ_DxVendor,ALS_TxVendor

    LSAlias      = Alias()

    ARQ_TxVendor  = NetArqAgain("TxVendor")
    ALS_TxVendor  = Alias()

	LNprazo = 	PrmVenc - PrmDaTa
	LFretorno = .f.

	SET NEAR ON
	SELE &ALS_TxVendor
	SET ORDER TO TAG data
	SEEK DTOS(PrmData)+STR(LNprazo,3)
	SET NEAR OFF

	*-------------------------------------------------*

	DO WHILE !BOF()
		DO CASE
			CASE &ALS_TxVendor .data < PrmData
				WAIT WINDOW ;
				  "Nao foram cadastradas Taxa para "+;
				    DTOC(PrmData)+"-"+STR(LNprazo,3)+" dias <ENTER>"
				EXIT
			CASE &ALS_TxVendor .data > PrmData
				SKIP -1
			CASE &ALS_TxVendor .de > LNprazo
				SKIP -1
			CASE &ALS_TxVendor .de <= LNprazo

				Rtn_AIA		= &ALS_TxVendor .AIA
				IF PrmTp_Pessoa = 1		
			    	Rtn_AIOF = &ALS_TxVendor .AIF
				ELSE
			    	Rtn_AIOF = &ALS_TxVendor .AIJ
				ENDIF

				Rtn_d = LNprazo
				IF Rtn_d > 365
					Rtn_d= 365
				ENDIF

			
				Rtn_iC_vendor 	= &ALS_TxVendor .Tx_Vendor

				**  Rtn_iC_comprador= &ALS_TxVendor .Tx_comprad


				** majoracao de 30% sobre a taxa do banco

				Rtn_iC_comprador= Rtn_iC_vendor * 1.30


				LFretorno = .t.

				EXIT
		ENDCASE				
	ENDDO	

    =up_fecha("&ALS_TxVendor")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6QH           CRcalcVendor VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   31  º
*       º Variable:            CRcalcVendor                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      29                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6qh     &&  CRcalcVendor VALID
#REGION 1
RETURN

FUNCTION  CRcalcVendor
PARAMETERS 	PrmEmpresa,;
			PrmVlrSolicitado,;
			PrmDtEmi,;
			PrmDtVenc,;
			PrmTp_Pessoa,;
        	PrmFlgEmbuteIOF,;
        	RtnEncargo,;
        	RtnIOF,;
        	RtnValor,;
        	RtnBcoEncargo
        	
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*



	PRIVATE LNdup

	PRIVATE LSnota      && STRING COM NUMERO DA NOTA PARA COMPARACAO
	PRIVATE LSnotaDaDup && STRING COM NUMERO DA NOTA RETIRADO DO NUMERO
						&& DA DUPLICATA


	PRIVATE LSmsg
	PRIVATE LSalias
    PRIVATE LNBol_ordem
	PRIVATE LScarteira
	PRIVATE LSvariacao


	PRIVATE AIA,AIOF,d,iC_comprador,iC_vendor
	STORE 0 TO  AIA,AIOF,d,iC_comprador,iC_vendor

	*-----------------  CALCULO ------------------------*

	set decimals to 5
	=CRtxsVendor(PrmEmpresa,PrmDtEmi,PrmDtVenc,PrmTp_Pessoa,;
  		AIA,;
  		AIOF,;
  		d,;
  		iC_comprador,;
  		iC_vendor)


*	iC =  iC_comprador


	*----------------------------------------------------*
	* 1) Calculo do IOF nao embutido
	*----------------------------------------------------*

	VS 		= PrmVlrSolicitado

	INE = VS * (AIA + (d * AIOF)/100)

	*----------------------------------------------------*
	* 2) Calculo do IOF  embutido
	*----------------------------------------------------*

	IOFE  = (VS * INE) / (VS - INE)



	*----------------------------------------------------*
	* 3) Calculo do Valor a ser Financiado
	*----------------------------------------------------*
	
	IF PrmFlgEmbuteIOF = .F.
		VF =  VS
	ELSE
		VF = VS + IOFE
	ENDIF
	

	*----------------------------------------------------*
	* 4) Calculo dos Encargos do Comprador
	*----------------------------------------------------*
	potencia = d/30

	JC = (VF * ((1+iC_comprador/100)**(potencia)-1))
	
	* TRUNCANDO O VALOR
	JC = INT(JC*100)/100
	

	*----------------------------------------------------*
	* 5) Calculo do valor de liquidacao do titulo no venc
	*    Com encargos do Comprador
	*----------------------------------------------------*

	VL = VF + JC






	*----------------------------------------------------*
	* 4.1) Calculo dos Encargos do BANCO
	*----------------------------------------------------*
	potencia = d/30

	JBco = (VF * ((1+iC_vendor/100)**(potencia)-1))
	
	* TRUNCANDO O VALOR
	JBco = INT(JBco*100)/100
	

	*----------------------------------------------------*
	* 5.1) Calculo do valor de liquidacao do titulo no venc
	*    Com encargos do BANCO
	*----------------------------------------------------*

	VLBco = VF + JBco

	*----------------------------------------------------*



   	RtnEncargo = JC
   	RtnValor = VL

    RtnBcoEncargo = JBco

	IF PrmFlgEmbuteIOF = .F.
		RtnIOF =  INE
	ELSE
	   	RtnIOF = IOFE
	ENDIF


	set decimals to 2

RETURN(VL)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6QI           CRConfigParcelas VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   32  º
*       º Variable:            CRConfigParcelas                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      30                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6qi     &&  CRConfigParcelas VALID
#REGION 1
RETURN

FUNCTION  CRConfigParcelas
*-----------------------------------*
*PARAMETERS ;
*		PrmEmpresa,;
*		PrmDtEmi,;
*		PrmPrazo,;
*		PrmVlrEnt,;
*		PrmValor
*-----------------------------------*


PARAMETERS PrmEmpresa,;
		PrmTp_Parcela,;
		PrmOrcamento,;
		PrmDtEmi,;
		PrmPrazo,;
		PrmVlrEnt,;
		PrmValorTotal,;
		PrmIof_fin,;
		PrmTp_Pessoa,;
		RtnTvlr_encarg, ;
    	RtnTvlr_ioffnc,;
    	RtnTvlr_Total



		*--------------------------------------------------*
		PRIVATE m.tx_jurosvd,m.tx_juroscp,;
    			m.dias

		PRIVATE AIA,AIOF,d,	m.TX_JUROSCP,m.TX_JUROSVD
		STORE 0 TO  AIA,AIOF,d,m.TX_JUROSCP,m.TX_JUROSVD

	    =W_DEFPROC("rotinas.spr")
       	RtnTvlr_encarg 	= 0
    	RtnTvlr_ioffnc	= 0
      	RtnTvlr_Total	= 0

		
	    M.EMPRESA  	= PrmEmpresa
		m.ORCAMENTO = PrmOrcamento
  		m.NOTA  	= 0
  		m.ORDEM 	= 0
    	m.DUPLICATA = PrmOrcamento*10
    	m.TP_PARCELA= PrmTp_Parcela
    	m.MOEDA		= 0
    	m.BANCO		= 0
  		m.DT_EMI	= PrmDtEmi
		m.dt_venc	= m.dt_emi
		
       	m.vlr_encarg= 0
    	m.vlr_ioffnc= 0
       	m.vlr_doc	= 0
		m.Iof_fin   = PrmIof_fin

		IF PrmIof_fin = 1
			FlgImbuteIOF = .T.
		ELSE
			FlgImbuteIOF = .F.
		ENDIF
		

		*--------------------------------------------------*
		
		PRIVATE LNqtdeParcelas,LNdias

    	PRIVATE ARQ_Parcelas,ALS_Parcelas
		PRIVATE LSalias

		PRIVATE m.parcela,m.dt_emi,m.dt_venc,m.dias,m.dia_semana,m.valor


    	LSAlias      = Alias()

    	ARQ_Parcelas  = NetArqAgain("VENDOR")
    	ALS_Parcelas  = Alias()
    	

	    =W_DEFPROC("rotinas.spr")
		ARQ_tmp=UPnometmp("EXT")


		SELE &ALS_parcelas
		COPY STRU TO  &ARQ_tmp
	    =up_fecha("&ALS_Parcelas")


		SELE 0
		USE &ARQ_tmp ALIAS TMPVD

		

		=W_DEFPROC("duplicat.spr")
		LNqtdeParcelas= CRQtdeParcelas(PrmPrazo)


		IF PrmTp_Parcela = 6
			=CRVendorGeraSimulacao()
		ELSE
			=CRParcelasGeraSimulacao()
		ENDIF
	
		ON ERROR
		ON KEY LABEL ENTER
		ON KEY
		


	    =up_fecha("&ALS_Parcelas")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		
RETURN("TMPVD")



FUNCTION CRParcelasGeraSimulacao

		FOR X = 1 TO LNqtdeParcelas
			m.parcela = X
			m.dt_emi  = PrmDtEmi

			=W_DEFPROC("duplicat.spr")
			LNdias= CRDiasParcela(X,PrmPrazo)

			m.dt_venc = m.dt_emi + LNdias
			m.dias = LNdias
			
			m.dia_semana = CRDiaSemana(m.dt_venc)

			m.vlr_doc =;
				 ULclcParcela(X,LNqtdeParcelas,PrmVlrEnt,PrmValortOTAL)


      		RtnTvlr_Total	= RtnTvlr_Total  + m.vlr_doc


	    	m.DUPLICATA = m.DUPLICATA + 1


			SELE TMPVD
		    =edithand('SAVE')
		NEXT
RETURN

FUNCTION ULclcParcela
PARAMETERS PrmParcela,PrmQtdeParcelas,PrmVlrEnt,PrmValorTotal

	PRIVATE RtnVlrParcela
	PRIVATE LNdiferenca,LNvlrSemEntrada,LnVlrParcelas,LNdiferenca
	

	DO CASE
		CASE PrmQtdeParcelas = 1
			RtnVlrParcela = PrmValorTotal
		
		CASE PrmParcela = 1 AND PrmVlrEnt > 0
			RtnVlrParcela = PrmVlrEnt
		
		CASE PrmParcela > 1 AND PrmVlrEnt > 0
			LNvlrSemEntrada = (PrmValorTotal - PrmVlrEnt)

			LnVlrParcelas	= LNvlrSemEntrada / (PrmQtdeParcelas-1)

			LnVlrParcelas	= (INT(LnVlrParcelas*100))/100

			LNdiferenca     =  LNvlrSemEntrada -;
								 LnVlrParcelas*(PrmQtdeParcelas-1)
			
			IF  PrmParcela = 2
				RtnVlrParcela = LnVlrParcelas + LNdiferenca
			ELSE
				RtnVlrParcela = LnVlrParcelas
			ENDIF
		OTHERWISE

			LnVlrParcelas	= PrmValorTotal / (PrmQtdeParcelas)

			LnVlrParcelas	= (INT(LnVlrParcelas*100))/100

			LNdiferenca     =  PrmValorTotal - ;
								 LnVlrParcelas*(PrmQtdeParcelas)
			
			IF  PrmParcela = 1
				RtnVlrParcela = LnVlrParcelas + LNdiferenca
			ELSE
				RtnVlrParcela = LnVlrParcelas
			ENDIF
	ENDCASE
RETURN(RtnVlrParcela)



FUNCTION CRVendorGeraSimulacao


		LNDiferenca = PrmValorTotal - ;
		              ROUND((PrmValorTotal / LNqtdeParcelas),2);
										   * LNqtdeParcelas

		FOR X = 1 TO LNqtdeParcelas
			

			=W_DEFPROC("duplicat.spr")
			m.dias= CRDiasParcela(X,PrmPrazo)

			m.dt_venc = m.dt_emi + m.dias 		
			=W_DEFPROC("duplicat.spr")
			m.dt_venc=CRajustaVenc(m.dt_venc,"+")


			=W_DEFPROC("duplicat.spr")
			IF !CRtxsVendor(PrmEmpresa,PrmDtEmi,m.dt_venc,PrmTp_Pessoa,;
			  		AIA,;
			  		AIOF,;
			  		d,;
			  		m.TX_JUROSCP,;
			  		m.TX_JUROSVD)

				STORE 0 TO 	AIA,AIOF,m.TX_JUROSCP,m.TX_JUROSVD
			ENDIF


 			m.VLR_COMPRA = PrmValorTotal

		*
 		*	m.VLR_DOC = ROUND((PrmValorTotal/LNqtdeParcelas),2);
 		*					+LNDiferenca
		*


			m.vlr_doc =;
				 ULclcParcela(X,LNqtdeParcelas,PrmVlrEnt,PrmValortOTAL)

			m.totvlvendr = 0
			
			=W_DEFPROC("duplicat.spr")
			=CRcalcVendor(m.Empresa,;
				m.VLR_DOC,;
				m.dt_emi,;
				m.dt_venc,;
				PrmTp_Pessoa,;
	   	    	m.FlgImbuteIOF,;
	        	m.vlr_encarg,;
    	    	m.vlr_ioffnc,;
	        	m.totvlvendr)

			RtnTvlr_encarg 	= RtnTvlr_encarg + m.vlr_encarg
    		RtnTvlr_ioffnc	= RtnTvlr_ioffnc + m.vlr_ioffnc
      		RtnTvlr_Total	= RtnTvlr_Total  + m.totvlvendr



	    	m.DUPLICATA = m.DUPLICATA + 1
			SELE TMPVD
		    =edithand('SAVE')
		NEXT
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6R7           CRQtdeParcelas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   33  º
*       º Variable:            CRQtdeParcelas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      31                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6r7     &&  CRQtdeParcelas VALID
#REGION 1
RETURN

FUNCTION  CRQtdeParcelas
PARAMETERS ;
		PrmPrazo
		PRIVATE LNQtdeParcelas
		LNQtdeParcelas = 1
		LSstring = ""
		*-----------------------------------------------------------*
		DO WHILE .t.

			LSdias = SUBS(PrmPrazo,LNQtdeParcelas*4+1,3)
			IF LSdias = "   "
				EXIT
			ENDIF
			LNQtdeParcelas=LNQtdeParcelas+1
		ENDDO
		
RETURN(LNQtdeParcelas)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6RE           CRDiasParcela VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   34  º
*       º Variable:            CRDiasParcela                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      32                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6re     &&  CRDiasParcela VALID
#REGION 1
RETURN

FUNCTION  CRDiasParcela
PARAMETERS PrmParcela,PrmPrazo

	PRIVATE LNPos,LNdias

		LNPos = ((PrmParcela-1) * 4) + 1

		LNdias = INT(VAL(SUBS(PrmPrazo,LNpos,3)))			

RETURN(LNdias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6RJ           CRViewParcelas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   35  º
*       º Variable:            CRViewParcelas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      33                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6rj     &&  CRViewParcelas VALID
#REGION 1
RETURN

FUNCTION  CRViewParcelas
PARAMETERS PtmTp_Parcela,PrmPrazo

	PRIVATE LSprazo

	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"

	ON KEY LABEL END KEYBOARD "{CTRL-W}"
	ON KEY LABEL ENTER KEYBOARD "{DNARROW}"
	ON KEY LABEL ESCAPE KEYBOARD "{UPARROW}"


	DEFINE WINDOW OUTPUT ;
		FROM 13, 0 ;
		TO 25,79 ;
		TITLE  "[ Configuracao Parcelas ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	ON KEY LABEL TAB
	ON KEY LABEL ESCAPE KEYBOARD "{UPARROW}"
	ON KEY LABEL ENTER  KEYBOARD "{DNARROW}"



	DO CASE
		CASE PtmTp_Parcela <> 6	   && NAO VENDOR
			BROWSE  FIELDS ;
				PARCELA		:H="Parc." :W=.F.,;
				DT_VENC		:H="Dt.Venc" :W=.F.,;
				DIAS	:H="Prazo" ;
					:V=ULVL_DATA();
					:F,;
				VLR_DOC	:H="Vlr.Parcela"	:P="@r ####9.99" :W=.F.,;
				DIA_SEMANA	:H="Dia" :W=.F., ;
				VLR_COMPRA	:H="Vlr.Compra"	:P="@r ####9.99" :W=.F.,;
				VLR_ENCARG	:H="Encargos"	:P="@r ####9.99" :W=.F.,;
				VLR_IOFFNC	:H="IOF"	:P="@r ####9.99" :W=.F.;
			TITLE "Informe novo Prazo para Cada Parcela // <END>=ENCERRA"  ;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL ;
		    WINDOW OUTPUT
		CASE PtmTp_Parcela = 6	   && VENDOR
			BROWSE  FIELDS ;
				PARCELA		:H="Parc." :W=.F.,;
				DT_VENC		:H="Dt.Venc" :W=.F.,;
				DIAS	:H="Prazo" ;
					:V=ULVL_DATA();
					:F,;
				TOTVLVENDR  :H="Vlr.Parcela"	:P="@r ####9.99" :W=.F.,;
				DIA_SEMANA	:H="Dia" :W=.F., ;
				VLR_DOC  	:H="Financiado"	:P="@r ####9.99" :W=.F.,;
				VLR_ENCARG	:H="Encargos"	:P="@r ####9.99" :W=.F.,;
				VLR_IOFFNC	:H="IOF"	:P="@r ####9.99" :W=.F.;
			TITLE "Informe novo Prazo para Cada Parcela // <END>=ENCERRA"  ;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL ;
		    WINDOW OUTPUT

	ENDCASE


	RELEASE WINDOW OUTPUT
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	ON KEY LABEL END DO ULsair

	*-------------------------------------------------*
	GO TOP
	PrmPrazo = ""

	DO WHILE !EOF()
		LSprazo = CHRTRAN(STR(dt_venc - Dt_emi,3)," ","0")
		PrmPrazo = PrmPrazo + LSprazo +"/"
		SKIP
	ENDDO

RETURN(PrmPrazo)

FUNCTION ULVL_DATA
		REPLACE DT_VENC WITH DT_EMI + DIAS
		
		REPLACE dia_semana WITH  CRDiaSemana(dt_venc)

RETURN(.T.)

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6RR           CRDiaSemana VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   36  º
*       º Variable:            CRDiaSemana                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      34                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6rr     &&  CRDiaSemana VALID
#REGION 1
RETURN

FUNCTION  CRDiaSemana
PARAMETERS ;
		PrmData
		PRIVATE LSdiaSemana

		DO CASE
			CASE DOW(PrmData) = 1
				LSdiaSemana	= "Domingo"
			CASE DOW(PrmData) = 2
				LSdiaSemana	= "Segunda"
			CASE DOW(PrmData) = 3
				LSdiaSemana	= "Terca"
			CASE DOW(PrmData) = 4
				LSdiaSemana	= "Quarta"
			CASE DOW(PrmData) = 5
				LSdiaSemana	= "Quinta"
			CASE DOW(PrmData) = 6
				LSdiaSemana	= "Sexta"
			CASE DOW(PrmData) = 7
				LSdiaSemana	= "Sabado"
		ENDCASE
RETURN(LSdiaSemana)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6RX           CRVerifTxsVendor VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   37  º
*       º Variable:            CRVerifTxsVendor                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      35                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6rx     &&  CRVerifTxsVendor VALID
#REGION 1
RETURN

FUNCTION  CRVerifTxsVendor
*-----------------------------------*
PARAMETERS PrmEmpresa,;
		   PrmDtEmi,;
		   PrmPrazo


	PRIVATE LFretorno
	PRIVATE m.dias
	PRIVATE m.dt_venc,m.Tp_Pessoa,m.AIA,m.AIOF,m.d,m.TX_JUROSCP,m.TX_JUROSVD
	
	m.dt_venc = {}
	m.Tp_Pessoa = 1
	m.AIA = 0
	m.AIOF= 0
	m.d   = 0
	m.TX_JUROSCP=0
	m.TX_JUROSVD=0
	LFretorno = .t.
	*--------------------------------------------------*

	=W_DEFPROC("duplicat.spr")
	LNqtdeParcelas= CRQtdeParcelas(PrmPrazo)

	*--------------------------------------------------*


	FOR X = 1 TO LNqtdeParcelas
			

		=W_DEFPROC("duplicat.spr")
		m.dias= CRDiasParcela(X,PrmPrazo)

		m.dt_venc = PrmDtEmi + m.dias 		
		=W_DEFPROC("duplicat.spr")
		m.dt_venc=CRajustaVenc(m.dt_venc,"+")


		=W_DEFPROC("duplicat.spr")
		IF !CRtxsVendor(PrmEmpresa,PrmDtEmi,m.dt_venc,m.Tp_Pessoa,;
		  		AIA,;
		  		AIOF,;
		  		d,;
		  		m.TX_JUROSCP,;
		  		m.TX_JUROSVD)

			LFretorno = .f.
		ENDIF
	NEXT

RETURN(LFretorno)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6RY           CRgeraDE12MAR08 VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   38  º
*       º Variable:            CRgeraDE12MAR08                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      36                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6ry     &&  CRgeraDE12MAR08 VALID
#REGION 1
RETURN
*********************************************************************
*  CRgeradupl.....: Gera duplicatas
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Duplicat
*                   Empresa
*                   Orcament
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.: do CRgeradupl with LNemp,LNorcamento
*---------------------------------------------------------------

PROCEDURE CRgeraDE12MAR08		&& USADA EM SCGC201, SCGCF201, SCGC201A
	
	PARAMETERS LNEmp,LNOrcamento, PrmImpBoleto
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE nota	&& O NUMERO DA NOTA DEVE SER O DA 1a NOTA CASO
					&& TENHAM SIDO GERADAS DUAS COM BASE NO MESMO ORCAMENTO
					&& PARA EVITAR INFLUENCIA NO AMBENTE NOTA E PRIVATE

	PRIVATE 	LNocorrenc, LNposic, LNinicio, LNnumpgt, LNdias, LNserie
	PRIVATE 	CVSTR1,CVSTR2,LNvlrdupl,LNdifere

	PRIVATE	empresa,duplicata,dt_emi,multa_prv,mora_prv,bonus_prv,;
			prem_pont,vlr_fatura,portador,tp_cobranc,;
			desconto,regiao,natu,nome,tp_cobranc

	PRIVATE dt_venc, dtproxproc
	PRIVATE LNtmp,banco

   	PRIVATE LNTp_parcela,LNbanco,LNvlrent,LSprazo,LDdtemi,LNmulta,LNmora
  	PRIVATE LNbonus,LNPremPont,LNRegiao,LNnatureza,LSnome,LNvlrfatura	
    PRIVATE LNnronota	

	PRIVATE LFduplicata,LFempresa,LForcamento,LFclienc,LForca_pgt
	PRIVATE LFclientes
	PRIVATE LSalias


	PRIVATE LNvl_issrtd
	*-----------------------------------------------------------*
	PRIVATE AIA,AIOF,d
	STORE 0 TO 	AIA,AIOF,D,m.TX_JUROSCP,m.TX_JUROSVD
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFduplicata	= NetArq("duplicat")
	LFempresa   = NetArq("Empresa" )
	LForcamento = NetArq("Orcament")
	LForca_pgt  = NetArq("orca_pgt")
	LFclienc    = NetArq("clienc")
	LFclientes  = NetArq("clientes")
	IF (LFduplicata+LFempresa+LForcamento+LForca_pgt) > 100000 OR ;
		(LFclientes+LFclienc) > 100000
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" 	  ,LFclienc )
		=UP_fecha("orca_pgt"  ,LForca_pgt )
		=UP_fecha("clientes"  ,LFclientes )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)


    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

	SELE orcament
*------------------------------------------------------------------*
* Condicao que evitava a geracao de duplicatas para vendas a vista
* retiradda em marco de 2012 pelo sergio para viabilizar a integracao
* dfis x dfin x paf e tabm facilitar a formacao do fluxo financeiro
* baseado nos titulos a receber e a pagar
*-------------------------------------------------------------------*
*	IF orcament.natu_oper <> 1  OR ;
*	   orcament.TP_PARCELA = 1 	&& So Gerar Duplicatas para
*								&& operacoes de Venda e Que
*								&&  Sejam a Prazo
 *
*-----------------------------------------------------------------*
	IF orcament.natu_oper <> 1
	   	&& So Gerar Duplicatas para
								&& operacoes de Venda

		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		=UP_fecha("orca_pgt"  ,LForca_pgt )
		=UP_fecha("clientes"  ,LFclientes )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF

	*----------------------------------------------------------------*
	wp_msg = "Gerando Duplicatas OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	LNcliente	= clienc.cliente	
   	LNTp_parcela= orcament.tp_parcela
   	LNbanco		= orcament.banco
   	LNvlrent	= orcament.vlr_ent
   	LSprazo		= orcament.prazo
   	LDdtemi		= orcament.dt_fat
  	LNmulta		= empresa.multa
  	LNmora		= empresa.mora
  	LNbonus		= empresa.bonus
  	LNPremPont	= empresa.prem_pont
  	LNRegiao	= clienc.regiao
	LNnatureza	= clienc.natu_cli
	m.tp_pessoa = clienc.tp_pessoa	
	m.FlgImbuteIOF = orcament.FlgImbuteI
	LSnome		= clienc.nome
	LNvlrfatura	= orcament.valor
	LNnronota	= orcament.nota


	LNvl_issrtd = orcament.vlr_issrtd



	SELECT &LSalias

	*-----------------------------------------------------------*
	*   Garante a Elimina‡Æo de Registros de Duplicatas Deixados
	* por falha
	*-----------------------------------------------------------*
	=CRcancdupl((LNemp),(LNnronota))
	*-----------------------------------------------------------*
	m.empresa	= LNemp
	m.nota		= LNnronota						
	m.duplicata	= LNnronota
	m.cliente	= LNcliente
	m.dt_emi	= LDDtemi
	m.multa_prv	= LNmulta
	m.mora_prv	= LNmora
	m.bonus_prv	= LNbonus
	m.prem_pont	= LNPremPont
	m.vlr_fatura= LNvlrfatura

	m.vlr_encarg = 0
	m.vlr_encbco = 0
    m.vlr_ioffnc = 0
	m.TotVlVendr = 0


	IF m.FlgImbuteIOF = .T.
		m.iof_fin = 1
	ELSE
		m.iof_fin = 1
	ENDIF


	DO CASE
		CASE LNTp_parcela = 6
			m.tp_cobranc	= 06	&& VENDOR
			m.flg_vendor    = 	.T.
		OTHERWISE
			m.tp_cobranc= 01	&& SIMPLES
			m.flg_vendor    = 	.F.
	ENDCASE


	m.desconto  = 0
	m.regiao    = LNregiao
	m.natu      = LNnatureza
	m.nome      = LSnome

	*-----------------------------------------------------------*
	*   Tratando os Registro Referentes a Entradas (MODO_PGTO = 1)
	*-----------------------------------------------------------*

	LNserie	   	= 1		&& Diferenciador do Numero da Duplicata
						&& 0 a 9
	SELE orca_pgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(LNEmp,3)+STR(LNOrcamento,6)
	SET NEAR OFF

	DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
					AND LNorcamento = orca_pgt.orcamento;
					AND orca_pgt.modo_pgto = 1

		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA


		IF LNemp = 10
		
		    && A IDL NAO POSSUI CONTROLE DE FATURAMENTO COM INFORMACOES
		    && SUFICIENTES PARA ORCAPGTO
		
			m.tp_parcela=  	3
			m.moeda 	=	3
		else
			m.tp_parcela=  	orca_pgt.tp_parcela
			m.moeda 	=	orca_pgt.moeda
		ENDIF

		IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
		               && Carteira e esta remete para
		               && Banco
			m.portador 	=  0   && CARTEIRA
		ELSE
			m.portador 	= orca_pgt.banco
		ENDIF

		m.banco 	=	orca_pgt.banco
		m.carteira  = ""
		m.variacao  = ""
		m.convenio  = ""
		m.conta     = ""
		m.conta_dv  = ""
		m.agencia   = 0
		
		
		*-----------------------------------------------*
        IF PrmImpBoleto = .F.
		    =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			   "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			     m.convenio,m.conta,m.conta_dv,;
			     m.agencia)
        ELSE
           =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			   "EMISSOR BOLETO", m.Carteira,m.Variacao,;
			     m.convenio,m.conta,m.conta_dv,;
			     m.agencia)
        ENDIF
		*-----------------------------------------------*

		
		m.vlr_doc	 =	orca_pgt.vlr_pgto - LNvl_issrtd
		m.vlr_issrtd =  LNvl_issrtd
		LNvl_issrtd  =  0
		m.dt_venc	=	m.dt_emi		
		m.obs =""


		m.vlr_pgto  =   0
   		m.dt_baixa  =   {}
   		m.dt_pgto   =   {}


		DO CASE
			CASE m.moeda = 4  &&	-Cheque Eletronico  : 	1 dia
				m.dt_venc	=	m.dt_emi + 1		
			CASE m.moeda = 5  &&	-CartÆo Rotativo 	:  31 dias	
				m.dt_venc	=	m.dt_emi + 31		
*------  a baixa sera feita no processo importacao caixa e processamento
*            OTHERWISE
*
 *         		m.vlr_pgto  =   m.vlr_doc
  *        		m.dt_baixa  =   m.dt_emi
   *       		m.dt_pgto   =   m.dt_emi
   *--------------------------------------------

		ENDCASE


		IF TYPE("orcament.AJSTFIMSEM") = "U"
			=CRajustaVenc(m.dt_venc,"+")
		ELSE
			IF orcament.AJSTFIMSEM <> "N"
				=CRajustaVenc(m.dt_venc,"+")
			ENDIF
		ENDIF

		

		SELE  duplicat
        SET ORDER TO TAG DOC
        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
        IF !FOUND()
			=edithand('SAVE')
		ENDIF

		
		
		LNserie    = LNserie + 1
		SELE orca_pgt
		SKIP
	ENDDO
	*-----------------------------------------------------------*
	*   Diferenciar Tratando das Parcelas de Acordo Com o Tipo de
	*  Parcelamento :
	*
	*		TP_PARCELA = 1 (A Vista)
	*			OBS: Neste Caso o Pgto com Cheque Eletronico ou
	*				CartÆo Rotativo SÆo Considerados A Prazo e
	*				Assumem Prazos Fixos Sendo:
	*					-Cheque Eletronico  : 	1 dia
	*					-CartÆo Rotativo 	:  31 dias	
	*
	*		TP_PARCELA <> 1 (Parcelados)		
	* 			OBS: Em Opera‡äes Realmente de Origem Parcelada os
	*               Registro Seguem o Prazo Que Estiver Estipulado
	*               no Campo Prazo da OSI e a Entrada (000/...) ‚
	*               Desconsiderada Por j  Ter Sido Tratada
	*					-Cheque          	:  ???/???/???/??? dias	
	*					-Duplicata          :  ???/???/???/??? dias	
	*					-CartÆo Parcelado	:  ???/???/???/??? dias	
	*
	*-----------------------------------------------------------*
	* Tratando os Registro Referentes a Parcelas (MODO_PGTO = 2)
	*-----------------------------------------------------------*
	* Determinando o Numero de Parcelas Especificadas (LNnumpgt)
	* Ex: "000/030/060/090/000/000 => 3 Parcelas (A Entrada ‚
	*                                              Desprezada)
	* Ex: "030/000/000/000/000/000 => 1 Parcela Sem Entrada
	*
	* Ex: "000/000/000/000/000/000 => 1 Parcela (Conta Apresenta‡Æo)
	*-----------------------------------------------------------*
	DO CASE
		CASE 	orcament.TP_PARCELA = 1 ;
			OR  orcament.TP_PARCELA = 5  && (A Vista / A Vista Com CartÆo)

			SELE orca_pgt
			SET ORDER TO TAG orca_pgto
			DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
					AND LNorcamento = orca_pgt.orcamento;
					AND orca_pgt.modo_pgto = 2

				m.duplicata	= ;
						INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
							  CHRTRAN(STR(LNserie,2)," ","0");
							  ))   && 1 => DUPLICATA

				m.tp_parcela=  	orca_pgt.tp_parcela
				m.moeda 	=	orca_pgt.moeda
				IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
				               && Carteira e esta remete para
				               && Banco
					m.portador 	=  0   && CARTEIRA
				ELSE
					m.portador 	= orca_pgt.banco
				ENDIF
				m.banco 	=	orca_pgt.banco

				m.vlr_doc	 =	orca_pgt.vlr_pgto - LNvl_issrtd
				m.vlr_issrtd =  LNvl_issrtd
				LNvl_issrtd  =  0



				m.vlr_pgto  =   0
				m.dt_venc	=	m.dt_emi		
				m.obs =""

				DO CASE
					CASE m.banco = 860  &&	Ticket CAR:prox 2F + 30dias
						Ctrdias = 0
						DO While dow(m.dt_emi+Ctrdias) <> 2
							Ctrdias = Ctrdias + 1
						ENDDO
						m.dt_venc	=	m.dt_emi + 30 + Ctrdias		
					CASE m.moeda = 4  &&	-Cheque Eletronico  : 	1 dia
						m.dt_venc	=	m.dt_emi + 1		
					CASE m.moeda = 5  &&	-CartÆo Rotativo 	:  31 dias	
						m.dt_venc	=	m.dt_emi + 31		
				ENDCASE

				IF TYPE("orcament.AJSTFIMSEM") = "U"
					=CRajustaVenc(m.dt_venc,"+")
				ELSE
					IF orcament.AJSTFIMSEM <> "N"
						=CRajustaVenc(m.dt_venc,"+")
					ENDIF
				ENDIF
				

				m.carteira  = ""
				m.variacao  = ""
				m.convenio  = ""
		        m.conta     = ""
		        m.conta_dv  = ""
		        m.agencia   = 0
				*-----------------------------------------------*

                IF PrmImpBoleto = .F.
		           =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			         "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			         m.convenio,m.conta,m.conta_dv,;
			         m.agencia)
                ELSE
                   =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
                     "EMISSOR BOLETO", m.Carteira,m.Variacao,;
			         m.convenio,m.conta,m.conta_dv,;
			         m.agencia)
                ENDIF

				*-----------------------------------------------*

				SELE  duplicat
		        SET ORDER TO TAG DOC
		        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
		        IF !FOUND()
					=edithand('SAVE')
				ENDIF


				LNserie    = LNserie + 1
				SELE orca_pgt
				SKIP
			ENDDO

		CASE	TP_PARCELA <> 1 		&& (Parcelados)		

			LNocorrenc 	= 1		&& 1¦,2¦,3¦... Ocorrencia do Char "/"
		    LNposic    	= 0     && Qual Posi‡Æo da Str Oocorre "/" 3,7,...
		    LNnumpgt   	= 0		&& Quantidade de Parcelas Fora Entrada
			LNdias	   	= 0		&& Dias de Prazo da Parcela
			LNproximodias	= 0  && Permite Diferenciar o
							 && Pgto com Entrada (000/031/000/000)
							 && do Pgto Conta Apresent‡Æo
							 && (000/000/000/...). No Primeiro Caso Quando
							 && LNdias = 0 (ou ser  a Entrada ou Invalido)
							 && e  nÆo ser  gerada Duplicatas. J  no
							 && Segundo Caso deve Ser Gerada Uma Dupl.
							 && Conta Apresenta‡Æo
		    LNinicio   	= 1
			*-----------------------------------------------------------*

			DO WHILE .t.
		        LNinicio   	= LNposic + 1
			    LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
				LNproximodias= INT(VAL(SUBS(LSprazo,LNinicio+4,3)))

	    		LNposic 	= AT("/",LSprazo, LNocorrenc)
				*-----------------------------------------------*
	  			IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
					EXIT
				ENDIF
				*-----------------------------------------------*
				*-----------------------------------------------*
				* LNdias = 0 AND LNproximodias => Conta Apresenta‡Æo
				*-----------------------------------------------*
				* 000/000/000/...  Conta Apresenta‡Æo
				*				LNnumpgt = 1
				*-----------------------------------------------*
				*-----------------------------------------------*
				IF LNdias = 0 AND LNproximodias > 0 && Descarte da
													&&  Entrada
					LNocorrenc 	= LNocorrenc + 1
				ELSE
					LNocorrenc 	= LNocorrenc + 1
			       	LNnumpgt   	= LNnumpgt + 1
				ENDIF
			ENDDO

			*-----------------------------------------------*
			SELE orca_pgt
			DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
							AND LNorcamento = orca_pgt.orcamento;
							AND orca_pgt.modo_pgto = 2
				SET DECIMALS TO 6
				*---------------------------------------------------*
				* Calculo de Diferenca Provocada na DivisÆo e Que ‚ Lan‡ada
				* na 1¦ Parcela
				*---------------------------------------------------*
			   	CVSTR1    = STR((orca_pgt.vlr_pgto) / (LNnumpgt) ,25,11)
			   	CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   			LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
			   	LNdifere  = orca_pgt.vlr_pgto - (LNvlrdupl * LNnumpgt)
				*---------------------------------------------------*
				LNocorrenc 		= 1
			    LNposic    		= 0
				LNdias			= 0
				LNproximodias	= 0  && Permite Diferenciar o
							 && Pgto com Entrada (000/031/000/000)
							 && do Pgto Conta Apresent‡Æo
							 && (000/000/000/...). No Primeiro Caso Quando
							 && LNdias = 0 (ou ser  a Entrada ou Invalido)
							 && e  nÆo ser  gerada Duplicatas. J  no
							 && Segundo Caso deve Ser Gerada Uma Dupl.
							 && Conta Apresenta‡Æo
			    LNinicio   	= 1

				DO WHILE .t.
					LNinicio = LNposic + 1										
			        LNdias       = INT(VAL(SUBS(LSprazo,LNinicio,3)))
					LNproximodias= INT(VAL(SUBS(LSprazo,LNinicio+4,3)))

			        LNposic = AT("/",LSprazo, LNocorrenc)  && PASSA PARA
			        									 && PROXIMA POSICAO
			        									 && DE INICIO DA
			        									 && DIA
					*-----------------------------------------------*
			   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
						EXIT
					ENDIF

					*-----------------------------------------------*
					* LNdias = 0 AND LNproximodias => Conta Apresenta‡Æo
					*-----------------------------------------------*
					IF LNdias = 0 AND LNproximodias > 0 && Descarte da
														&&  Entrada
						LNocorrenc = LNocorrenc + 1
						LOOP
					ENDIF
					**************************************************




					m.duplicata	= ;
					   INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
							  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA





					m.tp_parcela= orca_pgt.tp_parcela
					m.moeda 	= orca_pgt.moeda

					IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
					               && Carteira e esta remete para
					               && Banco
						m.portador 	=  0   && CARTEIRA
					ELSE
						m.portador 	= orca_pgt.banco
					ENDIF



					***m.vlr_doc  	= LNvlrdupl + LNdifere


					m.vlr_doc	 =	LNvlrdupl - LNvl_issrtd + LNdifere

					m.vlr_issrtd =  LNvl_issrtd
					LNvl_issrtd  =  0



					m.vlr_pgto  = 0
					LNdifere   	= 0			&& Proxima nÆo agrega Diferen‡a
					m.dt_venc  	= m.dt_emi + LNdias


					IF TYPE("orcament.AJSTFIMSEM") = "U"
						=CRajustaVenc(m.dt_venc,"+")
					ELSE
						IF orcament.AJSTFIMSEM <> "N"
							=CRajustaVenc(m.dt_venc,"+")
						ENDIF
					ENDIF

					*--------------------------------------------------*
					*CALCULO  VENDOR--*
					*--------------------------------------------------*
		 			m.VLR_COMPRA = orcament.valor

					m.vlr_encarg = 0
				    m.vlr_ioffnc = 0
					m.TotVlVendr = 0

					IF m.tp_parcela = 6   && VENDOR


						=W_DEFPROC("duplicat.spr")
						IF !CRtxsVendor(m.Empresa,m.Dt_Emi,;
								m.dt_venc,m.Tp_Pessoa,;
						  		AIA,;
						  		AIOF,;
						  		d,;
						  		m.TX_JUROSCP,;
						  		m.TX_JUROSVD)

							STORE 0 TO 	AIA,AIOF,m.TX_JUROSCP,m.TX_JUROSVD
						ENDIF


			 			
						=W_DEFPROC("duplicat.spr")
						=CRcalcVendor(m.Empresa,;
							m.vlr_doc,;
							m.dt_emi,;
							m.dt_venc,;
							m.Tp_Pessoa,;
	   			    		m.FlgImbuteIOF,;
			        		m.vlr_encarg,;
    			    		m.vlr_ioffnc,;
	        				m.TotVlVendr,;
	        				m.vlr_encbco)
					ENDIF

					*--------------------------------------------------*
					*--------------------------------------------------*
					*--------------------------------------------------*


					m.obs =""
					m.dtproxproc= m.dt_venc
					*---------------------------------------------------*		
					* EM COMPRAS A PRAZO COM A 1a DUPLICATA (TP_PARCELA = 3)
					*   COMO CONTA APRESENTACAO, ESTA 1a E
					* 	DIRECIONADA P/ A CARTEIRA E A DEMAIS
					* 	P/ O BANCO SOLICITADO. LNbanco GUARDO O
					* 	BANCO SOLICITADO P/ USO APOS GERAR A 1a
					*---------------------------------------------------*
					LNtmp  = m.dt_venc - m.dt_emi
				    IF  LNtmp <= 7  AND orca_pgt.tp_parcela = 3
	    						    && DUPLICATA CONTA APRESENTACAO
						m.banco = 0		 	&& DIRECIONA P/ CARTEIRA
					ELSE
						m.banco = orca_pgt.banco
										 && DIRECIONA P/ BANCO SOLICITADO	
					ENDIF

					m.carteira  = ""
					m.variacao  = ""
					m.convenio  = ""
		            m.conta     = ""
		            m.conta_dv  = ""
                    m.agencia   = 0
					*-----------------------------------------------*

                    IF PrmImpBoleto = .F.
	  	              =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			           "GERADOR DUPLICATA",;
			                m.Carteira,m.Variacao,;
			                m.convenio,m.conta,m.conta_dv,m.agencia)
                    ELSE
                      =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
                       "EMISSOR BOLETO", m.Carteira,m.Variacao,;
			                m.convenio,m.conta,m.conta_dv,m.agencia)
                    ENDIF

					*-----------------------------------------------*


					SELE  duplicat
			        SET ORDER TO TAG DOC
			        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
			        IF !FOUND()
						=edithand('SAVE')
					ENDIF

					LNserie    = LNserie + 1
					LNocorrenc = LNocorrenc + 1
				ENDDO
				SELE orca_pgt
				SKIP
			ENDDO

	ENDCASE

	*-----------------------------------------------------------*
	SET DECIMALS TO 2
	=UP_fecha("duplicat"  ,LFduplicata )
	=UP_fecha("empresa"   ,LFempresa   )
	=UP_fecha("orcamento" ,LForcamento )
	=UP_fecha("clienc" ,LFclienc )
	=UP_fecha("orca_pgt"  ,LForca_pgt )
	=UP_fecha("clientes"  ,LFclientes )
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6TE           CRIDLApos26geradupl VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   39  º
*       º Variable:            CRIDLApos26geradupl                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      37                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6te     &&  CRIDLApos26geradupl VALID
#REGION 1
RETURN
*********************************************************************
*  CRgeradupl.....: Gera duplicatas Para filiais que ainda nao registram
*              duplicatas para operacoes a vista e nao tratam a TABELA
* 				ORCA_PGT (Implantados pela Reestrutura‡Æo em Jan/01)
*           Ap¢s a Atualiza‡Æo do Sistema Na Filial a Gera‡Æo de Duplicatas
*           Ser  Realizada Pela Rotina Homonima  CRgeradupl
*
*********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Duplicat
*                   Empresa
*                   Orcament
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.: do CRgeradupl with LNemp,LNorcamento
*---------------------------------------------------------------

PROCEDURE CRIDLApos26geradupl		&& USADA EM SCGC201, SCGCF201, SCGC201A
	
	PARAMETERS LNEmp,LNOrcamento
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE nota	&& O NUMERO DA NOTA DEVE SER O DA 1a NOTA CASO
					&& TENHAM SIDO GERADAS DUAS COM BASE NO MESMO ORCAMENTO
					&& PARA EVITAR INFLUENCIA NO AMBENTE NOTA E PRIVATE

	PRIVATE 	LNocorrenc, LNposic, LNinicio, LNnumpgt, LNdias, LNserie
	PRIVATE 	CVSTR1,CVSTR2,LNvlrdupl,LNdifere

	PRIVATE	empresa,duplicata,dt_emi,multa_prv,mora_prv,bonus_prv,;
			prem_pont,vlr_fatura,portador,tp_cobranc,;
			desconto,regiao,natu,nome,tp_cobranc

	PRIVATE dt_venc, dtproxproc
	PRIVATE LNtmp,banco

   	PRIVATE LNTp_Parcela,LNbanco,LNvlrent,LSprazo,LDdtemi,LNmulta,LNmora
  	PRIVATE LNbonus,LNPremPont,LNRegiao,LNnatureza,LSnome,LNvlrfatura	
    PRIVATE LNnronota	

	PRIVATE LFduplicata,LFempresa,LForcamento,LFclienc
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFduplicata	= NetArq("duplicat")
	LFempresa   = NetArq("Empresa" )
	LForcamento = NetArq("Orcament")
	LFclienc    = NetArq("clienc")
	IF (LFduplicata+LFempresa+LForcamento) > 100000
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)


	IF orcament.natu_oper <> 1		&& So Gerar Duplicatas para
									&& operacoes de Venda
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF

	*----------------------------------------------------------------*
	wp_msg = "Gerando Duplicatas OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	LNcliente	= clienc.cliente	
   	LNTp_parcela= orcament.tp_parcela
   	LNbanco		= orcament.banco
   	LNvlrent	= orcament.vlr_ent
   	LSprazo		= orcament.prazo
   	LDdtemi		= orcament.dt_fat
  	LNmulta		= empresa .multa
  	LNmora		= empresa .mora
  	LNbonus		= empresa .bonus
  	LNPremPont	= empresa .prem_pont
  	LNRegiao	= clienc.regiao
	LNnatureza	= clienc.natu_cli
	LSnome		= clienc.nome
	LNvlrfatura	= orcament.valor
	LNnronota	= orcament.nota
	SELECT &LSalias

*************

	*-----------------------------------------------------------*

	=CRcancdupl((LNemp),(LNnronota))
	
	*---------------------------------------------------------------*
	*    Venda a Vista ou Parcelada no Cartao nao geram duplicatas
	*---------------------------------------------------------------*

	IF LNtp_parcela = 1   && VENDA A VISTA
		RETURN
	ENDIF
*
	LNocorrenc 	= 1
    LNposic    	= 0
    LNinicio   	= 1
    LNnumpgt   	= 0
	LNdias	   	= 0
	LNserie	   	= 1
		
	DO WHILE .t.
        LNposic = AT("/",LSprazo, LNocorrenc)
        LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
******************************************************************
   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
			EXIT
		ENDIF
******************************************************************
		IF LNdias = 0 AND LNnumpgt > 0
	        LNnumpgt   = LNnumpgt
		ELSE			
	        LNnumpgt   = LNnumpgt + 1
		ENDIF
		LNocorrenc = LNocorrenc + 1
        LNinicio   = LNposic + 1
	ENDDO

	SET DECIMALS TO 6
	
	IF LNvlrent > 0 AND LNnumpgt > 1
	   CVSTR1    = STR((LNvlrfatura - LNvlrent) / (LNnumpgt - 1) ,25,11)
	   CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
	   LNdifere  = LNvlrfatura - (LNvlrdupl * (LNnumpgt - 1) + LNvlrent)
    ELSE
	   CVSTR1    = STR((LNvlrfatura) / (LNnumpgt) ,25,11)
	   CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
	   LNdifere  = LNvlrfatura - (LNvlrdupl * LNnumpgt)
	ENDIF

	**>>>>>

	m.empresa	= LNemp
	m.nota		= LNnronota						
	m.duplicata	= LNnronota
	m.cliente	= LNcliente
	m.dt_emi	= LDDtemi
	m.multa_prv	= LNmulta
	m.mora_prv	= LNmora
	m.bonus_prv	= LNbonus
	m.prem_pont	= LNPremPont
	m.vlr_fatura= LNvlrfatura
	m.vlr_pgto  =   0
	
	DO CASE
		CASE LNbanco = 898
			m.portador = 898
		CASE LNbanco >= 850 AND  LNbanco <= 857     &&CARTAO
			m.portador = LNbanco	
		OTHERWISE
			m.portador	= 0
	ENDCASE


    && A IDL NAO POSSUI CONTROLE DE FATURAMENTO COM INFORMACOES
    && SUFICIENTES PARA ORCAPGTO
		
	m.tp_parcela=  	3
	m.moeda 	=	3

	m.tp_cobranc= 01
	m.desconto  = 0
	m.regiao    = LNregiao
	m.natu      = LNnatureza
	m.nome      = LSnome
	m.tp_cobranc= 01 		  && COB. SIMPLES

	**>>>>>

	LNocorrenc = 1
    LNposic    = 0
    LNinicio   = 1
	LNdias		= 0

	DO WHILE .t.
        LNposic = AT("/",LSprazo, LNocorrenc)
        LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
		**************************************************

   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
			EXIT
		ENDIF

		**************************************************
		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA
		IF LNvlrent > 0 AND LNnumpgt > 1
			m.vlr_doc 	 = LNvlrent
			LNvlrent = 0
		ELSE
			m.vlr_doc  = LNvlrdupl + LNdifere
			LNdifere   = 0
		ENDIF
		m.dt_venc  = m.dt_emi + LNdias
		m.dtproxproc  = m.dt_venc
		m.obs =""

		*---------------------------------------------------*		
		* 		EM COMPRAS A PRAZO COM A 1a DUPLICATA A
		* 	VISTA OU CONTA APRESENTACAO, ESTA 1a E
		* 	DIRECIONADA P/ A CARTEIRA E A DEMAIS
		* 	P/ O BANCO SOLICITADO. LNbanco GUARDO O
		* 	BANCO SOLICITADO P/ USO APOS GERAR A 1a
		*---------------------------------------------------*


		LNtmp  = m.dt_venc - m.dt_emi
	    if  LNtmp <= 7  AND LNbanco <> 900 AND LNbanco <> 898 ;
			 AND LNbanco <> 851 AND  LNbanco <> 852;
			 AND LNbanco <> 853 AND  LNbanco <> 854;
			 AND LNbanco <> 855 AND  LNbanco <> 856;
			 AND LNbanco <> 857 AND  LNbanco <> 858;
			 AND LNbanco <> 861 AND  LNbanco <> 862;
			 AND LNbanco <> 863 AND  LNbanco <> 865

	    						     && CONTA APRESENTACAO
			m.banco = 0			     && DIRECIONA P/ CARTEIRA
		ELSE
			m.banco = LNbanco   && DIRECIONA P/ BANCO SOLICITADO	
		ENDIF

		
		SELE  duplicat
        SET ORDER TO TAG DOC
        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
        IF !FOUND()
			=edithand('SAVE')
		ENDIF

		SELE orcament

		LNserie    = LNserie + 1
		LNocorrenc = LNocorrenc + 1
        LNinicio   = LNposic + 1
	ENDDO
	SET DECIMALS TO 2
	=UP_fecha("duplicat"  ,LFduplicata )
	=UP_fecha("empresa"   ,LFempresa   )
	=UP_fecha("orcamento" ,LForcamento )
	=UP_fecha("clienc" ,LFclienc )
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6TF           CRAtrzcancdupl VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   40  º
*       º Variable:            CRAtrzcancdupl                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      38                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6tf     &&  CRAtrzcancdupl VALID
#REGION 1
RETURN

FUNCTION  CRAtrzcancdupl

PARAMETERS LNemp,LNorcamento
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LFretorno


	PRIVATE ARQ_CtrlRefn,ALS_CtrlRefn

	LFretorno = .t.

	SELE duplicat

	SET ORDER TO REFR_ORCA
	SEEK STR(LNemp,3)+STR(LNorcamento,6)

	DO WHILE !EOF() AND LNorcamento = duplicat.orcamento

		IF not empty(duplicat.vlr_pgto)
			LFretorno = .F.
			EXIT
		ENDIF
		SELE duplicat
		SKIP
	ENDDO
	SELE DUPLICAT	
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6U0           CRdefcarteira VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   41  º
*       º Variable:            CRdefcarteira                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      39                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6u0     &&  CRdefcarteira VALID
#REGION 1
RETURN

FUNCTION  CRdefcarteira

PARAMETERS PrmEmpresa,PrmBanco,PrmTp_Parcela,PrmChamada,;
           RtnCarteira,RtnVariacao,RtnConvenio,;
           RtnConta,RtnConta_dv,RtnAgencia,RtnDv_Agencia

	*------------------------------------------*
	*  PrmChamada deve informar um dos valres
	* abaixo:
	*         "GERADOR DUPLICATA"
	*         "EMISSOR BOLETO"
	*------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSmsg
	PRIVATE LSalias


    PRIVATE ARQ_Cobranca,ALS_Cobranca
	
    LSAlias      = Alias()


    ARQ_Cobranca     = NetArqAgain("Cobranca")
    ALS_Cobranca     = Alias()

	*------------------------------------------------------------*
	DO CASE
		CASE PrmChamada = "GERADOR DUPLICATA"


			SELE &ALS_Cobranca
			SET ORDER TO TAG operacao
			IF  PrmTP_PARCELA = 6  && VENDOR
		
				IF PrmEMPRESA = 1
					seek str(PrmEmpresa,3) + STR(PrmBANCO,3) + ;
		        	"BOLETO BANCO  "
				ELSE
					seek str(PrmEmpresa,3) + STR( PrmBANCO,3) + ;
	        		"BOLETO VENDOR "
				ENDIF	
		
			ELSE
				seek str(PrmEmpresa,3) + STR(PrmBANCO,3) + ;
		        "BOLETO BANCO"
			ENDIF		


		OTHERWISE   && => PrmChamada = "EMISSOR BOLETO"

			SELE &ALS_Cobranca
			SET ORDER TO TAG operacao
			IF  PrmTP_PARCELA = 6  && VENDOR
		
				IF PrmEMPRESA = 1
					seek str(PrmEmpresa,3) + STR(PrmBANCO,3) + ;
		        	"BOLETO EMPRESA"
				ELSE
					seek str(PrmEmpresa,3) + STR( PrmBANCO,3) + ;
	        		"BOLETO VENDOR "
				ENDIF	
		
			ELSE
				seek str(PrmEmpresa,3) + STR(PrmBANCO,3) + ;
	        	"BOLETO EMPRESA"
			ENDIF		
	ENDCASE

    IF !FOUND()
	   SET ORDER TO TAG COBRANCA
	   seek str(PrmEmpresa,3) + STR(PrmBANCO,3)
    ENDIF

	if FOUND()
		RtnCarteira  = &ALS_Cobranca .carteira
		RtnVariacao  = &ALS_Cobranca .variacao
		RtnConvenio  = &ALS_Cobranca .convenio
        RtnConta     = &ALS_Cobranca .conta
        RtnConta_dv  = &ALS_Cobranca .conta_dg 		
        RtnAgencia   = ALLTRIM( &ALS_Cobranca .agencia)
        RtnAgencia   = int(val(RtnAgencia))

        RtnDv_Agencia= ALLTRIM( &ALS_Cobranca .agencia_dg)
	ELSE
		RtnCarteira  = ""
		RtnVariacao  = ""
		RtnConvenio  = ""
        RtnConta     = ""
        RtnConta_dv  = ""
        RtnAgencia   = 0

        RtnDv_Agencia= ""
    ENDIF

    =up_fecha("&ALS_Cobranca")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6U8           CRDupgeraboleto VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   42  º
*       º Variable:            CRDupgeraboleto                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      40                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6u8     &&  CRDupgeraboleto VALID
#REGION 1
RETURN

FUNCTION  CRDupgeraboleto
PARAMETERS PrmEmpresa,PrmDuplicata

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*



	PRIVATE LNBol_ordem

    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_Boleto  ,ALS_Boleto

    LSAlias      = Alias()

    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()


    ARQ_Boleto       = NetArqAgain("Boleto",.T.) && EXCLUSIVO
    ALS_Boleto       = Alias()


	*------------------------------------------------------------*
	SELE &ALS_Boleto
	DELETE ALL FOR BOL_ORDEM > 96 AND BOL_ORDEM < 9998
	PACK
	REINDEX
	*------------------------------------------------------------*
	

	LNBol_ordem = 97
	
	IF CRGrvBoleto(PrmEmpresa,PrmDuplicata,LNBol_ordem)
		SELE &ALS_Boleto
		COPY FIELDS bol_linha ;
	       TO "L:\TMP\PRTBOLET.XML" ;
		      TYPE SDF
	ENDIF



	*------------------------------------------------------------*

    =up_fecha("&ALS_Duplicat")
    =up_fecha("&ALS_boleto")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6UQ           CRGrvBoleto VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   43  º
*       º Variable:            CRGrvBoleto                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      41                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6uq     &&  CRGrvBoleto VALID
#REGION 1
RETURN

FUNCTION  CRGrvBoleto
PARAMETERS PrmEmpresa,PrmDuplicata, LNBol_ordem



	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNdup

	PRIVATE LSnota      && STRING COM NUMERO DA NOTA PARA COMPARACAO
	PRIVATE LSnotaDaDup && STRING COM NUMERO DA NOTA RETIRADO DO NUMERO
						&& DA DUPLICATA


	PRIVATE LSmsg
	PRIVATE LSalias
	PRIVATE LScarteira
	PRIVATE LSvariacao


    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Clientes,ALS_Clientes
    PRIVATE ARQ_Cobranca,ALS_Cobranca

***    PRIVATE ARQ_Boleto  ,ALS_Boleto  && VEM DA ROTINA CHAMADORA
	

    LSAlias      = Alias()


    ARQ_Empresa      = NetArqAgain("Empresa")
    ALS_Empresa      = Alias()

    ARQ_Clientes     = NetArqAgain("Clientes")
    ALS_Clientes     = Alias()

    ARQ_Cobranca     = NetArqAgain("Cobranca")
    ALS_Cobranca     = Alias()




	SELE &ALS_Empresa
	SET ORDER TO TAG empresa
	SEEK PrmEmpresa


	*------------------------------------------------------------*
	
	
	



	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(PrmDuplicata,9)
	IF FOUND()
		LFdados = .t.
		
		SELE &ALS_Clientes
		SET ORDER TO TAG cliente
		SEEK  &ALS_Duplicat .cliente


		SELE &ALS_Cobranca
		SET ORDER TO TAG operacao
		IF  &ALS_dUPLICAT .TP_PARCELA = 6  && VENDOR
		
			IF &ALS_dUPLICAT .EMPRESA = 1
				seek str(PrmEmpresa,3) + STR( &ALS_dUPLICAT .BANCO,3) + ;
		        	"BOLETO EMPRESA"
			ELSE
				seek str(PrmEmpresa,3) + STR( &ALS_dUPLICAT .BANCO,3) + ;
		        	"BOLETO VENDOR "
			ENDIF	
	
		ELSE
			seek str(PrmEmpresa,3) + STR( &ALS_dUPLICAT .BANCO,3) + ;
		        "BOLETO EMPRESA"
		ENDIF		
		


		if !FOUND() OR EMPTY( &ALS_Cobranca .DT_VIGOR) ;
		    OR wp_dtoper < &ALS_Cobranca .DT_VIGOR

           LSmsg = STR( &ALS_dUPLICAT .BANCO,3)
		   DO OBJ_ALER.SPR WITH ;
		   "EmissÆo de Boleto nao esta em vigor para banco "+ LSmsg
			SELE &ALS_Duplicat
			RETURN(.F.)
*			SKIP
*			LOOP
		ENDIF

		=RLOCK()




		*---------------------------------*
		* APLICACAO DE REAJUSTE INCC
		*---------------------------------*

		IF &ALS_Duplicat .tp_parcela =  7 && AJUSTE INCC

			PRIVATE RtnvlrCorrigido
			RtnvlrCorrigido = 0
			
			=W_DEFPROC("TABINCC.SPR")
			IF !NCAplicaINCC( &ALS_Duplicat .dt_emi,;
						   &ALS_Duplicat .dt_venc,;
	                       &ALS_Duplicat .vlrparcini,;
						   RtnvlrCorrigido)

			   DO OBJ_ALER.SPR WITH ;
			   "Falaha calculo INCC "
				RETURN(.F.)
*				SKIP
*				LOOP
			ENDIF

			REPLACE &ALS_Duplicat .VLR_DOC   WITH RtnvlrCorrigido
						
		ENDIF



		*---------------------------------------------------*

		LScarteira	= 	&ALS_cobranca .carteira
		LSvariacao  =	&ALS_cobranca .variacao

		*---------------------------------------------------*

		SELE &ALS_Boleto
		*------------------ preenchimento ------------------*

		m.bol_ordem = LNbol_ordem

		if empty(alltrim(&ALS_Duplicat .NUM_NO_BCO))

			DO CASE
				CASE &ALS_Duplicat .BANCO = 001
				 LSnossoNumero = ;
					 CR_001geraNssNro(PrmEmpresa, 001,LScarteira,LSvariacao)
				CASE &ALS_Duplicat .BANCO = 237
				  LSnossoNumero = ;
				     CR_237geraNssNro(PrmEmpresa, 237,LScarteira,LSvariacao)
			ENDCASE
		ELSE		
			LSnossoNumero = &ALS_Duplicat .NUM_NO_BCO
		ENDIF


		LSnossoNumero = CHRTRAN(LSnossoNumero," ","0")

		m.bol_linha = ;
		    '<ROW NossoNumero="'+LEFT(LSnossoNumero,11) +'"'+chr(13)

		SELE &ALS_Boleto

		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1

		*---------------------------------------------------*			
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' NumeroDocumento="'+;
		    STR( &ALS_Duplicat .duplicata,13)+'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' EspecieDocumento="edDuplicataMercantil"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' AceiteDocumento="adNao"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		m.bol_ordem = LNbol_ordem

		m.bol_linha = ;
			' Carteira="'+ ;
			&ALS_cobranca .carteira + ;
			&ALS_cobranca .variacao +   '"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1

		*------------------  CEDENTE -----------------------*			


		m.bol_ordem = LNbol_ordem
	
		DO CASE
				CASE &ALS_Duplicat .BANCO = 001
					m.bol_linha = ;
				    ' LocalPagamento=;
	        		 "PAGAVEL EM QUALQUER BANCO ATE O VENCIMENTO"'+chr(13)

				CASE &ALS_Duplicat .BANCO = 237
					m.bol_linha = ;
				    ' LocalPagamento=;
					"ATE O VENCIMENTO PREFERENCIALMENTE NO"+;
					" BRADESCO.VENCIDO, SOMENTE NO BRADESCO"'+chr(13)
		ENDCASE

		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem


		LScgc = TRANSFORM(STR(&ALS_empresa .CGC,14),"@R 99.999.999/9999.99")
		m.bol_linha = ;
	     ' Cdnt_Nome="'+ ALLTRIM( &ALS_empresa .nome );
					+'-'+ALLTRIM( &ALS_empresa .sigla );
					+'-'+LScgc;
		     +'"'+chr(13)


		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' CodigoCedente="'+  &ALS_cobranca .codcedente +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ' Cdnt_DigitoCodigoCedente="'+;
		          &ALS_cobranca .digcedente +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Cdnt_BancoCodigo="'+STR(  &ALS_cobranca .banco,3) +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Cdnt_CodigoAgencia="'+  &ALS_cobranca .agencia +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Cdnt_DigitoAgencia="'+  &ALS_cobranca .agencia_dg +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Cdnt_NumeroConta="'+  &ALS_cobranca .conta +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Cdnt_DigitoConta="'+  &ALS_cobranca .conta_dg +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.cpf_cgc = chrtran(str( &ALS_Clientes .cliente,14)," ","0")
		IF EMPTY(ALLTRIM( &ALS_Clientes .cbnome)) OR ;
		   EMPTY(ALLTRIM( &ALS_Clientes .cbendereco))
			m.nome	    =  &ALS_Clientes .nome
			m.endereco 	=  &ALS_Clientes .endereco
			m.bairro	=  &ALS_Clientes .bairro
			m.cidade	=  &ALS_Clientes .cidade
			m.estado	=  &ALS_Clientes .estado
			m.cep		=  &ALS_Clientes .cep
		ELSE
			m.nome	    =  &ALS_Clientes .CBnome
			m.endereco 	=  &ALS_Clientes .CBendereco
			m.bairro	=  &ALS_Clientes .CBbairro
			m.cidade	=  &ALS_Clientes .CBcidade
			m.estado	=  &ALS_Clientes .CBestado
			m.cep		=  &ALS_Clientes .CBcep
		ENDIF

		IF  &ALS_Clientes .tp_pessoa = 1
			LScgc = "-"+;
				TRANSFORM(STR( &ALS_Clientes .cliente ,14),;
							"@R 99.999.999/9999.99")
		ELSE
			LScgc = "-"+;
				TRANSFORM(STR( &ALS_Clientes .cliente ,14),;
							"@R 999.999.999.999-99")
		ENDIF

		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_Nome="'+m.nome+LScgc+'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_NumeroCPFCGC="'+m.cpf_cgc +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		IF &ALS_Clientes .tp_pessoa = 1
			m.bol_linha = ;
		    ' Scdo_TipoInscricao="tiPessoaFisica"'+chr(13)
		ELSE
			m.bol_linha = ;
			    ' Scdo_TipoInscricao="tiPessoaJuridica"'+chr(13)
		ENDIF


		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_Bairro="'+ m.bairro +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_CEP="'+ m.CEP +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_Cidade="'+ m.cidade +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_Complemento=" "'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_email= " "'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_Estado="'+ m.estado +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_Rua="'+ m.endereco +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*-------------------- datas ---------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' DataAbatimento="00000000"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

	*	m.bol_ordem = LNbol_ordem
	*	m.bol_linha = ;
	*	    ' DataAbatimento="00000000"'+chr(13)
	*	=edithand('SAVE')
	*	LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' DataDesconto="00000000"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem

		Ldata = CHRTRAN(DTOC( &ALS_Duplicat .DT_EMI),".","")
		Ldata = CHRTRAN(Ldata,"/","")

		m.bol_linha = ;
		    ' DataDocumento="'+Ldata+'"'+chr(13)


		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem


		Ldata = CHRTRAN(DTOC( &ALS_Duplicat .DT_VENC+1),".","")
		Ldata = CHRTRAN(Ldata,"/","")

		m.bol_linha = ;
		    ' DataMoraJuros="'+Ldata+'"'+chr(13)
		=edithand('SAVE')
		
		
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem


		LNdias = 0
		Ldata =  &ALS_Duplicat .DT_VENC
		DO WHILE LNdias < 5
		    Ldata =  Ldata + 1
			IF dow(Ldata) <> 1 AND dow(Ldata) <> 7
				LNdias = LNdias + 1
			ENDIF
		ENDDO

		Ldata = CHRTRAN(DTOC( Ldata ),".","")
		Ldata = CHRTRAN(Ldata,"/","")

		
		IF  &ALS_Duplicat .EMPRESA = 16 && SPE
			m.bol_linha = ;
			    ' DataProtesto="00000000"'+chr(13)
		ELSE

			m.bol_linha = ;
		    ' DataProtesto="'+Ldata+'"'+chr(13)
		ENDIF

		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem

		Ldata = CHRTRAN(DTOC( &ALS_Duplicat .DT_VENC),".","")
		Ldata = CHRTRAN(Ldata,"/","")

		m.bol_linha = ;
		    ' DataVencimento="'+Ldata+'"'+chr(13)

		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' ValorAbatimento= "'+;
		      CHRTRAN( STR( 0,13), " ","0")+'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' ValorDesconto="'+;
		      CHRTRAN(STR( 0,13)," ","0")+'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		
		
		IF &ALS_Duplicat .tp_parcela = 6   && VENDOR
			m.bol_linha = ;
			    ' ValorDocumento=" '+;
			      CHRTRAN(STR(  &ALS_Duplicat .totvlvendr *100,13)," ","0");
	      				+'"'+chr(13)
		ELSE
			m.bol_linha = ;
			    ' ValorDocumento=" '+;
			      CHRTRAN(STR(  &ALS_Duplicat .vlr_doc *100,13)," ","0");
	      				+'"'+chr(13)
		ENDIF
		=edithand('SAVE')
		
		
		
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		IF &ALS_Duplicat .tp_parcela = 6   && VENDOR

			m.moradiaria = ;
			    &ALS_Duplicat .totvlvendr * &ALS_empresa .mora / 100
		ELSE

			m.moradiaria = ;
			    &ALS_Duplicat .vlr_doc * &ALS_empresa .mora / 100

		ENDIF

		
		m.bol_ordem = LNbol_ordem

		m.bol_linha = ;
		    ' ValorMoraJuros="'+;
		      CHRTRAN(STR(  m.moradiaria *100,13)," ","0");
	      			+'"'+chr(13)



		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1

		*---------------------------------------------------*			
		
		DO CASE
			CASE &ALS_Duplicat .empresa = 16
				DO  ULmsgBltSPE

			CASE &ALS_Duplicat .tp_parcela <> 6
				DO  ULmsgBoleto
	
	
			OTHERWISE
				DO  ULmsgVendor
		ENDCASE

		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    '/>'+chr(13)

		=edithand('SAVE')
		*---------------------------------------------------*			
		SELE &ALS_Duplicat

		
     	m.ConfNroBco  = &ALS_Duplicat .ConfNroBco
		LSnossoNumero = CHRTRAN(LSnossoNumero," ","0")

		IF empty(alltrim(&ALS_Duplicat .NUM_NO_BCO))
			m.ConfNroBco = .f.
		ENDIF
        =RLOCK()
		LScarteira	= 	&ALS_cobranca .carteira
		LSvariacao  =	&ALS_cobranca .variacao

		REPLACE &ALS_Duplicat .carteira   WITH LScarteira
		REPLACE &ALS_Duplicat .variacao   WITH LSvariacao
		REPLACE &ALS_Duplicat .ConfNroBco WITH m.ConfNroBco
		REPLACE &ALS_Duplicat .NUM_NO_BCO WITH LSnossoNumero

	ENDIF

    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Clientes")
    =up_fecha("&ALS_Cobranca")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)


PROCEDURE ULmsgBoleto
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes1="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""

		IF  &ALS_duplicat .nota > 0

			LSmensagem="Boleto Ref. N.F. Nro - "+STR( &ALS_duplicat .nota,8)

		ENDIF

		LSmensagem = LEFT(LSmensagem + SPACE(40),40)

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes2="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		IF &ALS_duplicat .vlr_issrtd  > 0

			LSmensagem = "ISS Retido no valor de R$ "
			
			tmpvalor = ;
			   strtran(str(  &ALS_duplicat .vlr_issrtd ,10,2),".",",")
			tmpvalor = strtran(tmpvalor," ","")
			LSmensagem = LSmensagem + tmpvalor
		ELSE
			LSmensagem = ""
		ENDIF
		
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)


		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes3="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		IF  &ALS_Duplicat .tp_parcela = 7		
			LSmensagem = "PARC:"+;
			   ALLTRIM( &ALS_Duplicat .CODPARCELA)+;
			" - "+STR( &ALS_Duplicat .sequencia,3)+;
		   	" de "+STR( &ALS_Duplicat .qtparcelas,3)
		ELSE
			LSmensagem = ""
		ENDIF



		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes4="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes5="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes6="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes7="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes8="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
RETURN

PROCEDURE ULmsgVendor
		* "Boleto Ref. N.F. Nro - "+STR( &ALS_duplicat .nota,8)
		* "Titulo Negociado-BB Vendor.Apos vencido"
		* "cobrar comissao permanecia.            "
		* "Pgto antecipado proporcional so no BB. "
		* "Vlr.Compra  :"+TRANSF(duplicat.vlr_doc,"@Z *,***,**9.99")
		* "Vlr.Encargo :"+TRANSF(duplicat.vlr_encargo,"@Z *,***,**9.99")
		* "Vlr.Iof Financ: :"+TRANSF(duplicat.vlr_ioffnx,"@Z *,***,**9.99")

		*---------------------------------------------------*			
		LSmensagem = ""

		IF  &ALS_duplicat .nota > 0

			LSmensagem="Boleto Ref. N.F. Nro - "+STR( &ALS_duplicat .nota,8)

		ENDIF

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes1="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Titulo Negociado-BB Vendor.Apos vencido"
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes2="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			


		LSmensagem = "cobrar comissao permanecia.            "
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes3="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Pgto antecipado proporcional so no BB. "
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes4="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Vlr.Compra  :"+;
		               TRANSF(&ALS_Duplicat .vlr_doc,"@Z *,***,**9.99")
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes5="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Vlr.Encargo :"+;
						TRANSF(&ALS_Duplicat .vlr_encargo,"@Z *,***,**9.99")
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes6="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Vlr.Iof Financ: :"+;
						TRANSF(&ALS_Duplicat .vlr_ioffnc,"@Z *,***,**9.99")
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes7="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "PARC:"+;
		   ALLTRIM( &ALS_Duplicat .CODPARCELA)+;
		   STR( &ALS_Duplicat .sequencia,3)+;
		   "/"+;
		   STR( &ALS_Duplicat .qtparcelas,3)
		
		
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes8="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
RETURN(LFdados)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6VM           CRgeraboleto VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   44  º
*       º Variable:            CRgeraboleto                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      42                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6vm     &&  CRgeraboleto VALID
#REGION 1
RETURN

FUNCTION  CRGeraBoleto

PARAMETERS PrmEmpresa,PrmNota,PrmSistema
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNdup

	PRIVATE LNBol_ordem


    IF TYPE("PrmSistema") <> "C"
      PrmSistema = "FOX"
    ENDIF






	IF PrmSistema = "ORION"
		=CRBltTxtDevmedia(PrmEmpresa,PrmNota,PrmSistema)
	    RETURN(.T.)
    ENDIF




	PRIVATE LSnota      && STRING COM NUMERO DA NOTA PARA COMPARACAO
	PRIVATE LSnotaDaDup && STRING COM NUMERO DA NOTA RETIRADO DO NUMERO
						&& DA DUPLICATA



    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_Boleto  ,ALS_Boleto

    LSAlias      = Alias()

    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()


    ARQ_Boleto       = NetArqAgain("Boleto",.T.) && EXCLUSIVO
    ALS_Boleto       = Alias()



	*------------------------------------------------------------*
	SELE &ALS_Boleto
	DELETE ALL FOR BOL_ORDEM > 96 AND BOL_ORDEM < 9998
	PACK
	REINDEX
	
	
	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
	*  ALGORITIMO DE GERACAO DO NUMERO DE DUPLICATA - CRgeradupl
	*----------------------------------------------------------------*
	*
	*	IF LNemp <> 10
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  STR(m.empresa,1)))   && 1 => DUPLICATA
	*	else
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  "0"))   && 1 => DUPLICATA
	*	ENDIF
	*-------------------------------------------------------------------*

	LFdados = .f.

	LSnota  = STR(PrmNota,7)

	LNdup	= PrmNota * 100		



	LNBol_ordem = 97



	SET NEAR ON

	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(LNdup,9)

	SET NEAR OFF
	DO WHILE !EOF() AND LSnota = LEFT(STR( &ALS_Duplicat .duplicata,9) ,7)


	
		IF CRGrvBoleto(PrmEmpresa, ;
		             &ALS_Duplicat .duplicata,;
		             LNBol_ordem)
			LFdados = .t.
		ENDIF		
		*---------------------------------------------------*			
		SELE &ALS_Duplicat
		SKIP
	ENDDO


    IF TYPE("PrmSistema") <> "C"
      PrmSistema = "FOX"
    ENDIF


	if LFdados AND  PrmSistema = "FOX"

		SELE &ALS_Boleto
		COPY FIELDS bol_linha ;
	       TO "L:\TMP\PRTBOLET.XML" ;
		      TYPE SDF
	endif

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_Fncr = EMGetFieldValue(wp_empresa,"EMITE_FNCR")


    IF  LSemi_Fncr = "S"
		IF PrmSistema = "ORION"

			*---------------------------------------------------------*
			=W_DEFPROC("DUPLICAT.SPR")
			=CRDuplDFisExpDuplicata(PrmEmpresa,PrmNota,"IMPRIMIR")
			*---------------------------------------------------------*

	    ENDIF
	ENDIF
	
    =up_fecha("&ALS_Duplicat")
    =up_fecha("&ALS_boleto")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6VW           CRreplicaDupl VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   46  º
*       º Variable:            CRreplicaDupl                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      43                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6vw     &&  CRreplicaDupl VALID
#REGION 1
RETURN

FUNCTION  CRreplicaDupl
PARAMETERS PrmEmpresa,PrmDuplicata,PrmQtdReplicas

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNdup


    PRIVATE ARQ_Duplicat,ALS_Duplicat

    LSAlias      = Alias()

    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()

	*------------------------------------------------------------*
	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(PrmDuplicata,9)

	IF FOUND()

	   SCATTER MEMVAR	
	   FOR X = 1 TO PrmQtdReplicas


		  IF DAY(m.dt_venc) >= 28 AND MONTH(m.dt_venc) = 2
		      m.dt_venc = GOMONTH(m.dt_venc,2)
		      m.dt_venc = m.dt_venc - DAY(m.dt_venc)

		  ELSE
		      m.dt_venc = GOMONTH(m.dt_venc,1)
		  ENDIF

		  IF DAY(m.dt_venc) = 31
		      m.dt_venc = m.dt_venc - 1
		  ENDIF


	      APPEND BLANK
		  =RLOCK()

	      m.duplicata  = RECNO()
	      m.codparcela = ALLTRIM(STR(VAL(m.codparcela)+1,15))
	      m.sequencia  = m.sequencia + 1
		  GATHER MEMVAR		

	   NEXT 	
	ENDIF

    =up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6W3           ULmsgBoleto VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   47  º
*       º Variable:            ULmsgBoleto                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      44                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6w3     &&  ULmsgBoleto VALID
#REGION 1
RETURN



PROCEDURE ULmsgBoleto
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes1="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""

		IF  &ALS_duplicat .nota > 0

			LSmensagem="Boleto Ref. N.F. Nro - "+STR( &ALS_duplicat .nota,8)

		ENDIF

		LSmensagem = LEFT(LSmensagem + SPACE(40),40)

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes2="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		IF &ALS_duplicat .vlr_issrtd  > 0

			LSmensagem = "ISS Retido no valor de R$ "
			
			tmpvalor = ;
			   strtran(str(  &ALS_duplicat .vlr_issrtd ,10,2),".",",")
			tmpvalor = strtran(tmpvalor," ","")
			LSmensagem = LSmensagem + tmpvalor
		ELSE
			LSmensagem = ""
		ENDIF
		
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)


		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes3="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		IF  &ALS_Duplicat .tp_parcela = 7		
			LSmensagem = "PARC:"+;
			   ALLTRIM( &ALS_Duplicat .CODPARCELA)+;
			" - "+STR( &ALS_Duplicat .sequencia,3)+;
		   	" de "+STR( &ALS_Duplicat .qtparcelas,3)
		ELSE
			LSmensagem = ""
		ENDIF



		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes4="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes5="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes6="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes7="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes8="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6WA           ULmsgVendor VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   48  º
*       º Variable:            ULmsgVendor                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      45                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6wa     &&  ULmsgVendor VALID
#REGION 1
RETURN


PROCEDURE ULmsgVendor
		* "Boleto Ref. N.F. Nro - "+STR( &ALS_duplicat .nota,8)
		* "Titulo Negociado-BB Vendor.Apos vencido"
		* "cobrar comissao permanecia.            "
		* "Pgto antecipado proporcional so no BB. "
		* "Vlr.Compra  :"+TRANSF(duplicat.vlr_doc,"@Z *,***,**9.99")
		* "Vlr.Encargo :"+TRANSF(duplicat.vlr_encargo,"@Z *,***,**9.99")
		* "Vlr.Iof Financ: :"+TRANSF(duplicat.vlr_ioffnx,"@Z *,***,**9.99")

		*---------------------------------------------------*			
		LSmensagem = ""

		IF  &ALS_duplicat .nota > 0

			LSmensagem="Boleto Ref. N.F. Nro - "+STR( &ALS_duplicat .nota,8)

		ENDIF

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes1="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Titulo Negociado-BB Vendor.Apos vencido"
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes2="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			


		LSmensagem = "cobrar comissao permanecia.            "
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes3="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Pgto antecipado proporcional so no BB. "
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes4="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Vlr.Compra  :"+;
		               TRANSF(&ALS_Duplicat .vlr_doc,"@Z *,***,**9.99")
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes5="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Vlr.Encargo :"+;
						TRANSF(&ALS_Duplicat .vlr_encargo,"@Z *,***,**9.99")
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes6="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Vlr.Iof Financ: :"+;
						TRANSF(&ALS_Duplicat .vlr_ioffnc,"@Z *,***,**9.99")
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes7="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "PARC:"+;
		   ALLTRIM( &ALS_Duplicat .CODPARCELA)+;
		   STR( &ALS_Duplicat .sequencia,3)+;
		   "/"+;
		   STR( &ALS_Duplicat .qtparcelas,3)
		
		
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes8="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
RETURN(LFdados)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6WH           ULmsgBltSPE VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   49  º
*       º Variable:            ULmsgBltSPE                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      46                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6wh     &&  ULmsgBltSPE VALID
#REGION 1
RETURN



PROCEDURE ULmsgBltSPE
		*---------------------------------------------------*			
		LSmensagem = ""


		
		LSmensagem = CHRTRAN(LSmensagem,".",",")

		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes1="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""



		tmpvalor = &ALS_duplicat .vlr_doc * &ALS_empresa .multa / 100

   		Ldata = DTOC( &ALS_Duplicat .DT_VENC+1)
		Ldata = CHRTRAN(Ldata,".","/")

		LSmensagem = "Multa de R$ ";
				   + ALLTRIM(str( tmpvalor ,10,2))
	
		LSmensagem = CHRTRAN(LSmensagem,".",",")

		LSmensagem = LSmensagem+" apos " + Ldata

		LSmensagem = LEFT(LSmensagem + SPACE(40),40)

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes2="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		LSmensagem = ""
		


		LSmensagem = LEFT(LSmensagem + SPACE(40),40)


		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes3="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "CONTROLE:"+;
			   ALLTRIM( &ALS_Duplicat .CODPARCELA)

		LSmensagem = LEFT(LSmensagem + SPACE(40),40)

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes4="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes5="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""

		LSmensagem="FONE MALDI = (62)3240-5423"

		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes6="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes7="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes8="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6WR           CRAplicaINCC VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   50  º
*       º Variable:            CRAplicaINCC                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      47                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6wr     &&  CRAplicaINCC VALID
#REGION 1
RETURN

FUNCTION CRAplicaINCC
	*------------------------------------------------------------*

	PARAMETERS  LNemp

	PRIVATE LNdebito, LSalias
	PRIVATE LFduplicat
	LSalias			= ALIAS()
		
	=W_DEFPROC("rotinas.spr")
	LFduplicat	= NetArq("duplicat")
	IF (LFduplicat) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("duplicat" ,LFduplicat)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*---------------------------------------------------------------*	
	LNdebito  = 0
	sele duplicat
	SET ORDER TO TAG emissao
	SET NEAR ON
	SEEK STR(LNemp,3)
	SET NEAR OFF



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() ;
	        AND LNemp    = duplicat.empresa ;
         TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

    msg = ""

	DO WHILE !EOF();
			AND	LFsegue = .t. ;
			AND duplicat.empresa  = LNemp

		=UPtermo()
		WAIT WINDOW  msg NOWAIT

		*---------------------------------*
		* APLICACAO DE REAJUSTE INCC
		*---------------------------------*
		* tp_parcela =  7 && AJUSTE INCC
		*---------------------------------*
		
		IF Duplicat.tp_parcela =  7 and EMPTY(Duplicat.DT_PGTO)

			PRIVATE RtnvlrCorrigido
			RtnvlrCorrigido = 0
			=W_DEFPROC("TABINCC.SPR")
			IF !NCAplicaINCC(Duplicat.dt_emi,;
						  Duplicat.dt_venc,;
	                      Duplicat.vlrparcini,;
						   RtnvlrCorrigido)
			  msg = "Falha calculo INCC Dupl" + ;
				    STR(Duplicat.duplicata,9)
			ELSE
			  msg = "Ok - Calculado INCC Dupl" + ;
				    STR(Duplicat.duplicata,9)
				sele duplicat
				=rlock()		
				REPLACE Duplicat.VLR_DOC   WITH RtnvlrCorrigido
				unlock
			ENDIF
		else
			  msg = " Lida " + ;
				    STR(Duplicat.duplicata,9)
		ENDIF
		sele duplicat
		SET ORDER TO TAG emissao
	
		SKIP
	ENDDO
	
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO

	=UP_fecha("duplicat" ,LFduplicat)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6X0           CRAplicaIGPM VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   51  º
*       º Variable:            CRAplicaIGPM                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      48                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6x0     &&  CRAplicaIGPM VALID
#REGION 1
RETURN

FUNCTION CRAplicaIGPM
	*------------------------------------------------------------*

	PARAMETERS  LNemp

	PRIVATE LNdebito, LSalias
	PRIVATE LFduplicat
	LSalias			= ALIAS()
		
	=W_DEFPROC("rotinas.spr")
	LFduplicat	= NetArq("duplicat")
	IF (LFduplicat) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("duplicat" ,LFduplicat)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*---------------------------------------------------------------*	
	LNdebito  = 0
	sele duplicat
	SET ORDER TO TAG emissao
	SET NEAR ON
	SEEK STR(LNemp,3)
	SET NEAR OFF



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() ;
	        AND LNemp    = duplicat.empresa ;
         TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

    msg = ""

	DO WHILE !EOF();
			AND	LFsegue = .t. ;
			AND duplicat.empresa  = LNemp

		=UPtermo()
		WAIT WINDOW  msg NOWAIT

		*---------------------------------*
		* APLICACAO DE REAJUSTE IGPM
		*---------------------------------*
		* tp_parcela =  8 && AJUSTE IGPM
		*---------------------------------*
		
		IF Duplicat.tp_parcela =  8 and EMPTY(Duplicat.DT_PGTO)

			PRIVATE RtnvlrCorrigido
			RtnvlrCorrigido = 0
			=W_DEFPROC("TABIGPM.SPR")
			IF !IGAplicaIGPM(Duplicat.dt_emi,;
						  Duplicat.dt_venc,;
	                      Duplicat.vlrparcini,;
						   RtnvlrCorrigido)
			  msg = "Falha calculo IGPM Dupl" + ;
				    STR(Duplicat.duplicata,9)
			ELSE
			  msg = "Ok - Calculado IGPM Dupl" + ;
				    STR(Duplicat.duplicata,9)
				sele duplicat
				=rlock()		
				REPLACE Duplicat.VLR_DOC   WITH RtnvlrCorrigido
				unlock
			ENDIF
		else
			  msg = " Lida " + ;
				    STR(Duplicat.duplicata,9)
		ENDIF
		sele duplicat
		SET ORDER TO TAG emissao
	
		SKIP
	ENDDO
	
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO

	=UP_fecha("duplicat" ,LFduplicat)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6XA           CRfatimporta VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   53  º
*       º Variable:            CRfatimporta                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      49                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6xa     &&  CRfatimporta VALID
#REGION 1
RETURN

FUNCTION CRfatimporta      && REGISTRO DUP FATURADAS
PARAMETER PrmEmp,PrmNomeEmp,PrmData,PrmBanco


    m.empresa = PrmEmp
    m.dtaviso = PrmData
    LDdtinicio= PrmData
    m.banco   = PrmBanco
    m.carteira= ""
    m.variacao = ""

    *-----------------------------*
 	m.cod_empres = m.empresa
	m.dtaviso	 = UPValData(m.dtaviso)  && bug 2000
	m.aviso 	 = INT(VAL((DTOS(m.dtaviso))))
	m.nome_emp	 = PrmNomeEmp

	m.dtaviso  	 = LDdtinicio
	m.dtprocesso = LDdtinicio
	m.status 		= "PR"    && AGUARDANDO PROCESSAMENTO


	LNctrreg	= 0			&& TOTAL DE REGISTROS DE INSTRUCAO
	LNacmvlr	= 0			&& VALOR TOTAL DOS DOCUMENTOS
	LNacmpgt	= 0			&& VALOR TOTAL DOS PAGAMENTOS
    *-----------------------------*

	SELE retornbc
	SET ORDER TO TAG aviso



	IF SEEK(STR(m.empresa,3)+STR(m.banco,3)+;
	   m.carteira+m.variacao+STR(m.aviso,8))
 	   RETURN
	ENDIF
	=edithand('SAVE')
	=REGLOCK(.T.)

	SELE retornmv
	SET ORDER TO TAG lancamento
	SELE duplicat
	SET ORDER TO TAG emissao
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(m.dtaviso)
	SET NEAR OFF
	DO WHILE !EOF() AND PrmEmp = duplicat.empresa ;
					AND m.dtaviso  = duplicat.dt_emi

		m.duplicata	= duplicat.duplicata
		m.ocorrencia= 02	&&  REGISTRO CONFIRMADO
		m.efeito	= 1		&&  FATURAMENTO
		m.motivos   = ""
		m.vlr_dup	= duplicat.vlr_doc
		m.vlr_pgto  = 0
		LNctrreg	= LNctrreg + 1
		LNacmvlr	= LNacmvlr + m.vlr_dup
		LNacmpgt	= LNacmpgt + m.vlr_pgto

		SELE retornmv
		IF SEEK(STR(m.empresa,3)+STR(m.banco,3)+;
		    m.carteira+m.variacao+STR(m.aviso,8)+;
		 		STR(m.duplicata,9)+STR(m.ocorrencia,2))
			SELE duplicat
			SKIP
			LOOP
		ENDIF
		m.num_no_bco= " "
		m.vencimento= duplicat.dt_venc
		m.banco_cobr= duplicat.banco
		m.agenc_cobr= duplicat.agencia
		m.dsp_cobr  = 0
		m.out_desp  = 0
		m.juros     = 0
		m.iof       = 0
		m.abatimento= 0
		m.desconto  = 0
		m.mora      = 0
		m.out_credt = 0
		m.form_pgto = 0
		m.trf_cart  = " "
		m.dtocorrenc= m.dtaviso
		=edithand('SAVE')
		SELE duplicat
		SKIP
		LOOP

	ENDDO

    IF LNctrreg > 0
		SELE retornbc
		m.reg_total = LNctrreg
		m.reg_proces= 0
		m.reg_descar= 0
		m.tot_doc   = LNacmvlr
		m.tot_pgto  = LNacmpgt
	
		=edithand('REGRAVA')
		UNLOCK
	endif

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6XI           CRGerfatPeriodo VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   54  º
*       º Variable:            CRGerfatPeriodo                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      50                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6xi     &&  CRGerfatPeriodo VALID
#REGION 1
RETURN

FUNCTION CRGerfatPeriodo      && REGISTRO DUP FATURADAS BANCO 990
PARAMETER PrmEmp,PrmNomeEmp,PrmDtIni,PrmDtFinal,PrmBanco

	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca
	PRIVATE LNCtrItens

	LSalias = ALIAS()

	LFduplicat		= NetArq("duplicat")
	LFretornbc		= NetArq("retornbc")
	LFretornmv		= NetArq("retornmv")




	IF (LFduplicat+LFretornbc+LFretornmv) > 100000
		DO  FCHCRGerfatPeriodo
		RETURN(.f.)
	ENDIF


	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

    LNregistro = 0

    LNimpressao = PrmDtFinal - PrmDtIni

	LNimpressos = 0

    BKregistro  = LNregistro
    BKimpressos = LNimpressos
    BKimpressao = LNimpressao


	*----------------------------------------------------*


	DO WHILE PrmDtIni <= PrmDtFinal and LFsegue = .t.

		=UPtermo()

        =CRfatimporta(PrmEmp,PrmNomeEmp,PrmDtIni,PrmBanco)
		
        PrmDtIni = PrmDtIni + 1

	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*


	DO  FCHCRGerfatPeriodo


RETURN


PROCEDURE FCHCRGerfatPeriodo

	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("retornbc" ,LFretornbc)
	=UP_fecha("retornmv" ,LFretornmv)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6XQ           CRgeraDE01JUL12 VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   55  º
*       º Variable:            CRgeraDE01JUL12                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      51                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6xq     &&  CRgeraDE01JUL12 VALID
#REGION 1
RETURN
*********************************************************************
*  CRgeradupl.....: Gera duplicatas
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Duplicat
*                   Empresa
*                   Orcament
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.: do CRgeradupl with LNemp,LNorcamento
*---------------------------------------------------------------

PROCEDURE CRgeraDE01JUL12		&& USADA EM SCGC201, SCGCF201, SCGC201A
	
	PARAMETERS LNEmp,LNOrcamento, PrmImpBoleto
	



*    do CRgeraDE01nov12 with LNEmp,LNOrcamento, PrmImpBoleto
*
*
*RETURN



    *--------------------------------------------------------------
    *       PrmImpBoleto
	*                         = "EMITIR BOLETO"
	*                         = "SEM BOLETO" OU .F.
    *--------------------------------------------------------------

    IF TYPE("PrmImpBoleto") = "U"
         PrmImpBoleto = "SEM BOLETO"
    ENDIF




	
	=W_DEFPROC("rotinas.spr")

	PRIVATE nota	&& O NUMERO DA NOTA DEVE SER O DA 1a NOTA CASO
					&& TENHAM SIDO GERADAS DUAS COM BASE NO MESMO ORCAMENTO
					&& PARA EVITAR INFLUENCIA NO AMBENTE NOTA E PRIVATE

	PRIVATE 	LNocorrenc, LNposic, LNinicio, LNnumpgt, LNdias, LNserie
	PRIVATE 	CVSTR1,CVSTR2,LNvlrdupl,LNdifere

	PRIVATE	empresa,duplicata,dt_emi,multa_prv,mora_prv,bonus_prv,;
			prem_pont,vlr_fatura,portador,tp_cobranc,;
			desconto,regiao,natu,nome,tp_cobranc

	PRIVATE dt_venc, dtproxproc
	PRIVATE LNtmp,banco

   	PRIVATE LNTp_parcela,LNbanco,LNvlrent,LSprazo,LDdtemi,LNmulta,LNmora
  	PRIVATE LNbonus,LNPremPont,LNRegiao,LNnatureza,LSnome,LNvlrfatura	
    PRIVATE LNnronota	

	PRIVATE LFduplicata,LFempresa,LForcamento,LFclienc,LForca_pgt
	PRIVATE LFclientes
	PRIVATE LSalias


	PRIVATE LNvl_issrtd
	*-----------------------------------------------------------*
	PRIVATE AIA,AIOF,d
	STORE 0 TO 	AIA,AIOF,D,m.TX_JUROSCP,m.TX_JUROSVD
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFduplicata	= NetArq("duplicat")
	LFempresa   = NetArq("Empresa" )
	LForcamento = NetArq("Orcament")
	LForca_pgt  = NetArq("orca_pgt")
	LFclienc    = NetArq("clienc")
	LFclientes  = NetArq("clientes")
	IF (LFduplicata+LFempresa+LForcamento+LForca_pgt) > 100000 OR ;
		(LFclientes+LFclienc) > 100000
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" 	  ,LFclienc )
		=UP_fecha("orca_pgt"  ,LForca_pgt )
		=UP_fecha("clientes"  ,LFclientes )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)


    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

	SELE orcament
*------------------------------------------------------------------*
* Condicao que evitava a geracao de duplicatas para vendas a vista
* retiradda em marco de 2012 pelo sergio para viabilizar a integracao
* dfis x dfin x paf e tabm facilitar a formacao do fluxo financeiro
* baseado nos titulos a receber e a pagar
*-------------------------------------------------------------------*
*	IF orcament.natu_oper <> 1  OR ;
*	   orcament.TP_PARCELA = 1 	&& So Gerar Duplicatas para
*								&& operacoes de Venda e Que
*								&&  Sejam a Prazo
*
*-----------------------------------------------------------------*
	IF orcament.natu_oper <> 1
	   	&& So Gerar Duplicatas para
								&& operacoes de Venda

		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		=UP_fecha("orca_pgt"  ,LForca_pgt )
		=UP_fecha("clientes"  ,LFclientes )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF

	*----------------------------------------------------------------*
	wp_msg = "Gerando Duplicatas OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	LNcliente	= clienc.cliente	
   	LNTp_parcela= orcament.tp_parcela
   	LNbanco		= orcament.banco
   	LNvlrent	= orcament.vlr_ent
   	LSprazo		= orcament.prazo
   	LDdtemi		= orcament.dt_fat
  	LNmulta		= empresa.multa
  	LNmora		= empresa.mora
  	LNbonus		= empresa.bonus
  	LNPremPont	= empresa.prem_pont
  	LNRegiao	= clienc.regiao
	LNnatureza	= clienc.natu_cli
	m.tp_pessoa = clienc.tp_pessoa	
	m.FlgImbuteIOF = orcament.FlgImbuteI
	LSnome		= clienc.nome
	LNvlrfatura	= orcament.valor
	LNnronota	= orcament.nota


	LNvl_issrtd = orcament.vlr_issrtd



	SELECT &LSalias

	*-----------------------------------------------------------*
	*   Garante a Elimina‡Æo de Registros de Duplicatas Deixados
	* por falha
	*-----------------------------------------------------------*
	=CRcancdupl((LNemp),(LNnronota))
	*-----------------------------------------------------------*
	m.empresa	= LNemp
	m.nota		= LNnronota						
	m.duplicata	= LNnronota
	m.cliente	= LNcliente
	m.dt_emi	= LDDtemi
	m.multa_prv	= LNmulta
	m.mora_prv	= LNmora
	m.bonus_prv	= LNbonus
	m.prem_pont	= LNPremPont
	m.vlr_fatura= LNvlrfatura

	m.vlr_encarg = 0
	m.vlr_encbco = 0
    m.vlr_ioffnc = 0
	m.TotVlVendr = 0


	IF m.FlgImbuteIOF = .T.
		m.iof_fin = 1
	ELSE
		m.iof_fin = 1
	ENDIF


	DO CASE
		CASE LNTp_parcela = 6
			m.tp_cobranc	= 06	&& VENDOR
			m.flg_vendor    = 	.T.
		OTHERWISE
			m.tp_cobranc= 01	&& SIMPLES
			m.flg_vendor    = 	.F.
	ENDCASE


	m.desconto  = 0
	m.regiao    = LNregiao
	m.natu      = LNnatureza
	m.nome      = LSnome

	*-----------------------------------------------------------*
	*   Tratando os Registro Referentes a Entradas (MODO_PGTO = 1)
	*-----------------------------------------------------------*

	LNserie	   	= 1		&& Diferenciador do Numero da Duplicata
						&& 0 a 9
	SELE orca_pgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(LNEmp,3)+STR(LNOrcamento,6)
	SET NEAR OFF

	DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
					AND LNorcamento = orca_pgt.orcamento;
					AND orca_pgt.modo_pgto = 1

		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA


		IF LNemp = 10
		
		    && A IDL NAO POSSUI CONTROLE DE FATURAMENTO COM INFORMACOES
		    && SUFICIENTES PARA ORCAPGTO
		
			m.tp_parcela=  	3
			m.moeda 	=	3
		else
			m.tp_parcela=  	orca_pgt.tp_parcela
			m.moeda 	=	orca_pgt.moeda
		ENDIF

		IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
		               && Carteira e esta remete para
		               && Banco
			m.portador 	=  0   && CARTEIRA
		ELSE
			m.portador 	= orca_pgt.banco
		ENDIF

		m.banco 	=	orca_pgt.banco
		m.carteira  = ""
		m.variacao  = ""
		m.convenio  = ""
		m.conta     = ""
		m.conta_dv  = ""
		m.agencia   = 0
		m.agencia_dv= ""
		
		
		*-----------------------------------------------*
        *--------------------------------------------------------------
        *       PrmImpBoleto
     	*                         = "EMITIR BOLETO"
	    *                         = "SEM BOLETO" OU .F.
        *--------------------------------------------------------------
	    m.NUM_NO_BCO = ""
        IF PrmImpBoleto = "SEM BOLETO"
		    =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			   "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			     m.convenio,m.conta,m.conta_dv,;
			     m.agencia,m.agencia_dv)
        ELSE
           =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			   "EMISSOR BOLETO", m.Carteira,m.Variacao,;
			     m.convenio,m.conta,m.conta_dv,;
			     m.agencia,m.agencia_dv)
		   DO CASE
				CASE m.BANCO = 001
				 m.NUM_NO_BCO = ;
					 CR_001geraNssNro(m.Empresa, 001,m.carteira,m.variacao)
				CASE m.BANCO = 237
				  m.NUM_NO_BCO = ;
				     CR_237geraNssNro(m.Empresa, 237,m.carteira,m.variacao)
			ENDCASE
		    m.NUM_NO_BCO = CHRTRAN(m.NUM_NO_BCO," ","0")
		ENDIF

		*-----------------------------------------------*

		
		m.vlr_doc	 =	orca_pgt.vlr_pgto - LNvl_issrtd
		m.vlr_issrtd =  LNvl_issrtd
		LNvl_issrtd  =  0
		m.dt_venc	=	m.dt_emi		
		m.obs =""


		m.vlr_pgto  =   0
   		m.dt_baixa  =   {}
   		m.dt_pgto   =   {}


		DO CASE
			CASE m.moeda = 4  &&	-Cheque Eletronico  : 	1 dia
				m.dt_venc	=	m.dt_emi + 1		


			CASE m.moeda = 5 and m.BANCO = 867 && BRASIL CARD 40 dias	
				m.dt_venc	=	m.dt_emi + 40		


			CASE m.moeda = 5  &&	-CartÆo Rotativo 	:  31 dias	
				m.dt_venc	=	m.dt_emi + 31		



*------  a baixa sera feita no processo importacao caixa e processamento
*            OTHERWISE
*
 *         		m.vlr_pgto  =   m.vlr_doc
  *        		m.dt_baixa  =   m.dt_emi
   *       		m.dt_pgto   =   m.dt_emi
   *--------------------------------------------

		ENDCASE


		IF TYPE("orcament.AJSTFIMSEM") = "U"
			=CRajustaVenc(m.dt_venc,"+")
		ELSE
			IF orcament.AJSTFIMSEM <> "N"
				=CRajustaVenc(m.dt_venc,"+")
			ENDIF
		ENDIF

        *--------------------------------------------------*		
        m.dt_p_desct = m.dt_venc
        m.dt_cbr_jrs = m.dt_venc

		LNdias = 0
		m.dt_protest =  m.dt_venc
		DO WHILE LNdias < 5
		    m.dt_protest =  m.dt_protest + 1
			IF dow(m.dt_protest) <> 1 AND dow(m.dt_protest) <> 7
				LNdias = LNdias + 1
			ENDIF
		ENDDO
		m.vlr_mora = m.vlr_doc * empresa.mora / 100
        m.vlr_juros = 0
        m.vlr_dsct  = 0
        *--------------------------------------------------*		
		SELE  duplicat
		
		
		SELE  duplicat
        SET ORDER TO TAG DOC
        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
        IF !FOUND()
			=edithand('SAVE')
		ENDIF
		
		LNserie    = LNserie + 1
		SELE orca_pgt
		SKIP
	ENDDO
	*-----------------------------------------------------------*
	*   Diferenciar Tratando das Parcelas de Acordo Com o Tipo de
	*  Parcelamento :
	*
	*		TP_PARCELA = 1 (A Vista)
	*			OBS: Neste Caso o Pgto com Cheque Eletronico ou
	*				CartÆo Rotativo SÆo Considerados A Prazo e
	*				Assumem Prazos Fixos Sendo:
	*					-Cheque Eletronico  : 	1 dia
	*					-CartÆo Rotativo 	:  31 dias	
	*
	*		TP_PARCELA <> 1 (Parcelados)		
	* 			OBS: Em Opera‡äes Realmente de Origem Parcelada os
	*               Registro Seguem o Prazo Que Estiver Estipulado
	*               no Campo Prazo da OSI e a Entrada (000/...) ‚
	*               Desconsiderada Por j  Ter Sido Tratada
	*					-Cheque          	:  ???/???/???/??? dias	
	*					-Duplicata          :  ???/???/???/??? dias	
	*					-CartÆo Parcelado	:  ???/???/???/??? dias	
	*
	*-----------------------------------------------------------*
	* Tratando os Registro Referentes a Parcelas (MODO_PGTO = 2)
	*-----------------------------------------------------------*
	* Determinando o Numero de Parcelas Especificadas (LNnumpgt)
	* Ex: "000/030/060/090/000/000 => 3 Parcelas (A Entrada ‚
	*                                              Desprezada)
	* Ex: "030/000/000/000/000/000 => 1 Parcela Sem Entrada
	*
	* Ex: "000/000/000/000/000/000 => 1 Parcela (Conta Apresenta‡Æo)
	*-----------------------------------------------------------*
	DO CASE
		CASE 	orcament.TP_PARCELA = 1 ;
			OR  orcament.TP_PARCELA = 5  && (A Vista / A Vista Com CartÆo)

			SELE orca_pgt
			SET ORDER TO TAG orca_pgto
			DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
					AND LNorcamento = orca_pgt.orcamento;
					AND orca_pgt.modo_pgto = 2

				m.duplicata	= ;
						INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
							  CHRTRAN(STR(LNserie,2)," ","0");
							  ))   && 1 => DUPLICATA

				m.tp_parcela=  	orca_pgt.tp_parcela
				m.moeda 	=	orca_pgt.moeda
				IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
				               && Carteira e esta remete para
				               && Banco
					m.portador 	=  0   && CARTEIRA
				ELSE
					m.portador 	= orca_pgt.banco
				ENDIF
				m.banco 	=	orca_pgt.banco

				m.vlr_doc	 =	orca_pgt.vlr_pgto - LNvl_issrtd
				m.vlr_issrtd =  LNvl_issrtd
				LNvl_issrtd  =  0



				m.vlr_pgto  =   0
				m.dt_venc	=	m.dt_emi		
				m.obs =""

				DO CASE
					CASE m.banco = 860  &&	Ticket CAR:prox 2F + 30dias
						Ctrdias = 0
						DO While dow(m.dt_emi+Ctrdias) <> 2
							Ctrdias = Ctrdias + 1
						ENDDO
						m.dt_venc	=	m.dt_emi + 30 + Ctrdias
						
						
					CASE m.banco = 867  &&	BRASIL CARD: + 40dias
						m.dt_venc	=	m.dt_emi + 40


								
					CASE m.moeda = 4  &&	-Cheque Eletronico  : 	1 dia
						m.dt_venc	=	m.dt_emi + 1		
					CASE m.moeda = 5  &&	-CartÆo Rotativo 	:  31 dias	
						m.dt_venc	=	m.dt_emi + 31		
				ENDCASE

				IF TYPE("orcament.AJSTFIMSEM") = "U"
					=CRajustaVenc(m.dt_venc,"+")
				ELSE
					IF orcament.AJSTFIMSEM <> "N"
						=CRajustaVenc(m.dt_venc,"+")
					ENDIF
				ENDIF
				

				m.carteira  = ""
				m.variacao  = ""
				m.convenio  = ""
		        m.conta     = ""
		        m.conta_dv  = ""
		        m.agencia   = 0
                m.agencia_dv= ""
				*-----------------------------------------------*


	    	    m.NUM_NO_BCO = ""
	            IF PrmImpBoleto = "SEM BOLETO"
			        =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    			   "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			    	     m.convenio,m.conta,m.conta_dv,;
			    	     m.agencia,m.agencia_dv)
	            ELSE
        	       =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    			   "EMISSOR BOLETO", m.Carteira,m.Variacao,;
			    	     m.convenio,m.conta,m.conta_dv,;
			    	     m.agencia,m.agencia_dv)
	    		   DO CASE
			    		CASE m.BANCO = 001
					     m.NUM_NO_BCO = ;
	    					 CR_001geraNssNro(m.Empresa,;
	    					  001,m.carteira,m.variacao)
	    				CASE m.BANCO = 237
			    		  m.NUM_NO_BCO = ;
					         CR_237geraNssNro(m.Empresa,;
					          237,m.carteira,m.variacao)
	    			ENDCASE
			        m.NUM_NO_BCO = CHRTRAN(m.NUM_NO_BCO," ","0")
	    		ENDIF
				*-----------------------------------------------*
                m.dt_p_desct = m.dt_venc
                m.dt_cbr_jrs = m.dt_venc

        		LNdias = 0
        		m.dt_protest =  m.dt_venc
        		DO WHILE LNdias < 5
        		    m.dt_protest =  m.dt_protest + 1
        			IF dow(m.dt_protest) <> 1 AND dow(m.dt_protest) <> 7
        				LNdias = LNdias + 1
        			ENDIF
        		ENDDO
        		m.vlr_mora = m.vlr_doc * empresa.mora / 100
                m.vlr_juros = 0
                m.vlr_dsct  = 0
				*-----------------------------------------------*

				SELE  duplicat


				SELE  duplicat
		        SET ORDER TO TAG DOC
		        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
		        IF !FOUND()
					=edithand('SAVE')
				ENDIF

				LNserie    = LNserie + 1
				SELE orca_pgt
				SKIP
			ENDDO

		CASE	TP_PARCELA <> 1 		&& (Parcelados)		

			LNocorrenc 	= 1		&& 1¦,2¦,3¦... Ocorrencia do Char "/"
		    LNposic    	= 0     && Qual Posi‡Æo da Str Oocorre "/" 3,7,...
		    LNnumpgt   	= 0		&& Quantidade de Parcelas Fora Entrada
			LNdias	   	= 0		&& Dias de Prazo da Parcela
			LNproximodias	= 0  && Permite Diferenciar o
							 && Pgto com Entrada (000/031/000/000)
							 && do Pgto Conta Apresent‡Æo
							 && (000/000/000/...). No Primeiro Caso Quando
							 && LNdias = 0 (ou ser  a Entrada ou Invalido)
							 && e  nÆo ser  gerada Duplicatas. J  no
							 && Segundo Caso deve Ser Gerada Uma Dupl.
							 && Conta Apresenta‡Æo
		    LNinicio   	= 1
			*-----------------------------------------------------------*

			DO WHILE .t.
		        LNinicio   	= LNposic + 1
			    LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
				LNproximodias= INT(VAL(SUBS(LSprazo,LNinicio+4,3)))

	    		LNposic 	= AT("/",LSprazo, LNocorrenc)
				*-----------------------------------------------*
	  			IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
					EXIT
				ENDIF
				*-----------------------------------------------*
				*-----------------------------------------------*
				* LNdias = 0 AND LNproximodias => Conta Apresenta‡Æo
				*-----------------------------------------------*
				* 000/000/000/...  Conta Apresenta‡Æo
				*				LNnumpgt = 1
				*-----------------------------------------------*
				*-----------------------------------------------*
				IF LNdias = 0 AND LNproximodias > 0 && Descarte da
													&&  Entrada
					LNocorrenc 	= LNocorrenc + 1
				ELSE
					LNocorrenc 	= LNocorrenc + 1
			       	LNnumpgt   	= LNnumpgt + 1
				ENDIF
			ENDDO

			*-----------------------------------------------*
			SELE orca_pgt
			DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
							AND LNorcamento = orca_pgt.orcamento;
							AND orca_pgt.modo_pgto = 2
				SET DECIMALS TO 6
				*---------------------------------------------------*
				* Calculo de Diferenca Provocada na DivisÆo e Que ‚ Lan‡ada
				* na 1¦ Parcela
				*---------------------------------------------------*
			   	CVSTR1    = STR((orca_pgt.vlr_pgto) / (LNnumpgt) ,25,11)
			   	CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   			LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
			   	LNdifere  = orca_pgt.vlr_pgto - (LNvlrdupl * LNnumpgt)
				*---------------------------------------------------*
				LNocorrenc 		= 1
			    LNposic    		= 0
				LNdias			= 0
				LNproximodias	= 0  && Permite Diferenciar o
							 && Pgto com Entrada (000/031/000/000)
							 && do Pgto Conta Apresent‡Æo
							 && (000/000/000/...). No Primeiro Caso Quando
							 && LNdias = 0 (ou ser  a Entrada ou Invalido)
							 && e  nÆo ser  gerada Duplicatas. J  no
							 && Segundo Caso deve Ser Gerada Uma Dupl.
							 && Conta Apresenta‡Æo
			    LNinicio   	= 1

				DO WHILE .t.
					LNinicio = LNposic + 1										
			        LNdias       = INT(VAL(SUBS(LSprazo,LNinicio,3)))
					LNproximodias= INT(VAL(SUBS(LSprazo,LNinicio+4,3)))

			        LNposic = AT("/",LSprazo, LNocorrenc)  && PASSA PARA
			        									 && PROXIMA POSICAO
			        									 && DE INICIO DA
			        									 && DIA
					*-----------------------------------------------*
			   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
						EXIT
					ENDIF

					*-----------------------------------------------*
					* LNdias = 0 AND LNproximodias => Conta Apresenta‡Æo
					*-----------------------------------------------*
					IF LNdias = 0 AND LNproximodias > 0 && Descarte da
														&&  Entrada
						LNocorrenc = LNocorrenc + 1
						LOOP
					ENDIF
					**************************************************




					m.duplicata	= ;
					   INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
							  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA





					m.tp_parcela= orca_pgt.tp_parcela
					m.moeda 	= orca_pgt.moeda

					IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
					               && Carteira e esta remete para
					               && Banco
						m.portador 	=  0   && CARTEIRA
					ELSE
						m.portador 	= orca_pgt.banco
					ENDIF



					***m.vlr_doc  	= LNvlrdupl + LNdifere


					m.vlr_doc	 =	LNvlrdupl - LNvl_issrtd + LNdifere

					m.vlr_issrtd =  LNvl_issrtd
					LNvl_issrtd  =  0



					m.vlr_pgto  = 0
					LNdifere   	= 0			&& Proxima nÆo agrega Diferen‡a
					m.dt_venc  	= m.dt_emi + LNdias


					IF TYPE("orcament.AJSTFIMSEM") = "U"
						=CRajustaVenc(m.dt_venc,"+")
					ELSE
						IF orcament.AJSTFIMSEM <> "N"
							=CRajustaVenc(m.dt_venc,"+")
						ENDIF
					ENDIF

					*--------------------------------------------------*
					*CALCULO  VENDOR--*
					*--------------------------------------------------*
		 			m.VLR_COMPRA = orcament.valor

					m.vlr_encarg = 0
				    m.vlr_ioffnc = 0
					m.TotVlVendr = 0

					IF m.tp_parcela = 6   && VENDOR


						=W_DEFPROC("duplicat.spr")
						IF !CRtxsVendor(m.Empresa,m.Dt_Emi,;
								m.dt_venc,m.Tp_Pessoa,;
						  		AIA,;
						  		AIOF,;
						  		d,;
						  		m.TX_JUROSCP,;
						  		m.TX_JUROSVD)

							STORE 0 TO 	AIA,AIOF,m.TX_JUROSCP,m.TX_JUROSVD
						ENDIF


			 			
						=W_DEFPROC("duplicat.spr")
						=CRcalcVendor(m.Empresa,;
							m.vlr_doc,;
							m.dt_emi,;
							m.dt_venc,;
							m.Tp_Pessoa,;
	   			    		m.FlgImbuteIOF,;
			        		m.vlr_encarg,;
    			    		m.vlr_ioffnc,;
	        				m.TotVlVendr,;
	        				m.vlr_encbco)
					ENDIF

					*--------------------------------------------------*
					*--------------------------------------------------*
					*--------------------------------------------------*


					m.obs =""
					m.dtproxproc= m.dt_venc
					*---------------------------------------------------*		
					* EM COMPRAS A PRAZO COM A 1a DUPLICATA (TP_PARCELA = 3)
					*   COMO CONTA APRESENTACAO, ESTA 1a E
					* 	DIRECIONADA P/ A CARTEIRA E A DEMAIS
					* 	P/ O BANCO SOLICITADO. LNbanco GUARDO O
					* 	BANCO SOLICITADO P/ USO APOS GERAR A 1a
					*---------------------------------------------------*
					LNtmp  = m.dt_venc - m.dt_emi
				    IF  LNtmp <= 7  AND orca_pgt.tp_parcela = 3
	    						    && DUPLICATA CONTA APRESENTACAO
						m.banco = 0		 	&& DIRECIONA P/ CARTEIRA
					ELSE
						m.banco = orca_pgt.banco
										 && DIRECIONA P/ BANCO SOLICITADO	
					ENDIF

					m.carteira  = ""
					m.variacao  = ""
					m.convenio  = ""
		            m.conta     = ""
		            m.conta_dv  = ""
                    m.agencia   = 0
                    m.agencia_dv= ""
					*-----------------------------------------------*


	 	    	    m.NUM_NO_BCO = ""
	     	        IF PrmImpBoleto = "SEM BOLETO"
			 	        =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    			 	   "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			    	 	     m.convenio,m.conta,m.conta_dv,;
			    	     	 m.agencia,m.agencia_dv)
	 	            ELSE
     	    	       =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    	 			   "EMISSOR BOLETO", m.Carteira,m.Variacao,;
	  			    	     m.convenio,m.conta,m.conta_dv,;
		 		    	     m.agencia,m.agencia_dv)
	 	    		   DO CASE
		 		    		CASE m.BANCO = 001
			 			     m.NUM_NO_BCO = ;
	    		 				 CR_001geraNssNro(m.Empresa,;
	    			 			  001,m.carteira,m.variacao)
	 	    				CASE m.BANCO = 237
		 		    		  m.NUM_NO_BCO = ;
			 			         CR_237geraNssNro(m.Empresa,;
				 		          237,m.carteira,m.variacao)
	 	    			ENDCASE
	 			        m.NUM_NO_BCO = CHRTRAN(m.NUM_NO_BCO," ","0")
	 	    		ENDIF
					*-----------------------------------------------*
  				    *-----------------------------------------------*
                    m.dt_p_desct = m.dt_venc
                    m.dt_cbr_jrs = m.dt_venc

        		    LNdias = 0
        		    m.dt_protest =  m.dt_venc
        		    DO WHILE LNdias < 5
        		        m.dt_protest =  m.dt_protest + 1
        			    IF dow(m.dt_protest) <> 1 AND dow(m.dt_protest) <> 7
        			    	LNdias = LNdias + 1
        			    ENDIF
        		    ENDDO
        		    m.vlr_mora = m.vlr_doc * empresa.mora / 100
                    m.vlr_juros = 0
                    m.vlr_dsct  = 0
				    *-----------------------------------------------*


					SELE  duplicat
			        SET ORDER TO TAG DOC
			        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
			        IF !FOUND()
						=edithand('SAVE')
					ENDIF



					LNserie    = LNserie + 1
					LNocorrenc = LNocorrenc + 1
				ENDDO
				SELE orca_pgt
				SKIP
			ENDDO

	ENDCASE

	*-----------------------------------------------------------*
	SET DECIMALS TO 2
	=UP_fecha("duplicat"  ,LFduplicata )
	=UP_fecha("empresa"   ,LFempresa   )
	=UP_fecha("orcamento" ,LForcamento )
	=UP_fecha("clienc" ,LFclienc )
	=UP_fecha("orca_pgt"  ,LForca_pgt )
	=UP_fecha("clientes"  ,LFclientes )
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6YQ           CRgr01nov14 VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   58  º
*       º Variable:            CRgr01nov14                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      52                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc6yq     &&  CRgr01nov14 VALID
#REGION 1
RETURN
*********************************************************************
*  CRgeradupl.....: Gera duplicatas
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Duplicat
*                   Empresa
*                   Orcament
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.: do CRgeradupl with LNemp,LNorcamento
*---------------------------------------------------------------

PROCEDURE CRgr01nov14		&& USADA EM SCGC201, SCGCF201, SCGC201A
	
	PARAMETERS LNEmp,LNOrcamento, PrmImpBoleto
	
    *--------------------------------------------------------------
    *       PrmImpBoleto
	*                         = "EMITIR BOLETO"
	*                         = "SEM BOLETO" OU .F.
    *--------------------------------------------------------------

    IF TYPE("PrmImpBoleto") = "U"
         PrmImpBoleto = "SEM BOLETO"
    ENDIF




	
	=W_DEFPROC("rotinas.spr")

	PRIVATE nota	&& O NUMERO DA NOTA DEVE SER O DA 1a NOTA CASO
					&& TENHAM SIDO GERADAS DUAS COM BASE NO MESMO ORCAMENTO
					&& PARA EVITAR INFLUENCIA NO AMBENTE NOTA E PRIVATE

	PRIVATE 	LNocorrenc, LNposic, LNinicio, LNnumpgt, LNdias, LNserie
	PRIVATE 	CVSTR1,CVSTR2,LNvlrdupl,LNdifere

	PRIVATE	empresa,duplicata,dt_emi,multa_prv,mora_prv,bonus_prv,;
			prem_pont,vlr_fatura,portador,tp_cobranc,;
			desconto,regiao,natu,nome,tp_cobranc

	PRIVATE dt_venc, dtproxproc
	PRIVATE LNtmp,banco

   	PRIVATE LNTp_parcela,LNbanco,LNvlrent,LSprazo,LDdtemi,LNmulta,LNmora
  	PRIVATE LNbonus,LNPremPont,LNRegiao,LNnatureza,LSnome,LNvlrfatura	
    PRIVATE LNnronota	

	PRIVATE LFduplicata,LFempresa,LForcamento,LFclienc,LForca_pgt
	PRIVATE LFclientes
	PRIVATE LSalias


	PRIVATE LNvl_issrtd
	*-----------------------------------------------------------*
	PRIVATE AIA,AIOF,d
	STORE 0 TO 	AIA,AIOF,D,m.TX_JUROSCP,m.TX_JUROSVD
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFduplicata	= NetArq("duplicat")
	LFempresa   = NetArq("Empresa" )
	LForcamento = NetArq("Orcament")
	LForca_pgt  = NetArq("orca_pgt")
	LFclienc    = NetArq("clienc")
	LFclientes  = NetArq("clientes")
	IF (LFduplicata+LFempresa+LForcamento+LForca_pgt) > 100000 OR ;
		(LFclientes+LFclienc) > 100000
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" 	  ,LFclienc )
		=UP_fecha("orca_pgt"  ,LForca_pgt )
		=UP_fecha("clientes"  ,LFclientes )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)


    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

	SELE orcament
*------------------------------------------------------------------*
* Condicao que evitava a geracao de duplicatas para vendas a vista
* retiradda em marco de 2012 pelo sergio para viabilizar a integracao
* dfis x dfin x paf e tabm facilitar a formacao do fluxo financeiro
* baseado nos titulos a receber e a pagar
*-------------------------------------------------------------------*
*	IF orcament.natu_oper <> 1  OR ;
*	   orcament.TP_PARCELA = 1 	&& So Gerar Duplicatas para
*								&& operacoes de Venda e Que
*								&&  Sejam a Prazo
*
*-----------------------------------------------------------------*
	IF orcament.natu_oper <> 1
	   	&& So Gerar Duplicatas para
								&& operacoes de Venda

		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		=UP_fecha("orca_pgt"  ,LForca_pgt )
		=UP_fecha("clientes"  ,LFclientes )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF

	*----------------------------------------------------------------*
	wp_msg = "Gerando Duplicatas OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	LNcliente	= clienc.cliente	
   	LNTp_parcela= orcament.tp_parcela
   	LNbanco		= orcament.banco
   	LNvlrent	= orcament.vlr_ent
   	LSprazo		= orcament.prazo
   	LDdtemi		= orcament.dt_fat
  	LNmulta		= empresa.multa
  	LNmora		= empresa.mora
  	LNbonus		= empresa.bonus
  	LNPremPont	= empresa.prem_pont
  	LNRegiao	= clienc.regiao
	LNnatureza	= clienc.natu_cli
	m.tp_pessoa = clienc.tp_pessoa	
	m.FlgImbuteIOF = orcament.FlgImbuteI
	LSnome		= clienc.nome
	LNvlrfatura	= orcament.valor
	LNnronota	= orcament.nota


	LNvl_issrtd = orcament.vlr_issrtd



	SELECT &LSalias

	*-----------------------------------------------------------*
	*   Garante a Elimina‡Æo de Registros de Duplicatas Deixados
	* por falha
	*-----------------------------------------------------------*
	=CRcancdupl((LNemp),(LNnronota))
	*-----------------------------------------------------------*
	m.empresa	= LNemp
	m.nota		= LNnronota						
	m.duplicata	= LNnronota
	m.cliente	= LNcliente
	m.dt_emi	= LDDtemi
	m.multa_prv	= LNmulta
	m.mora_prv	= LNmora
	m.bonus_prv	= LNbonus
	m.prem_pont	= LNPremPont
	m.vlr_fatura= LNvlrfatura

	m.vlr_encarg = 0
	m.vlr_encbco = 0
    m.vlr_ioffnc = 0
	m.TotVlVendr = 0


	IF m.FlgImbuteIOF = .T.
		m.iof_fin = 1
	ELSE
		m.iof_fin = 1
	ENDIF


	DO CASE
		CASE LNTp_parcela = 6
			m.tp_cobranc	= 06	&& VENDOR
			m.flg_vendor    = 	.T.
		OTHERWISE
			m.tp_cobranc= 01	&& SIMPLES
			m.flg_vendor    = 	.F.
	ENDCASE


	m.desconto  = 0
	m.regiao    = LNregiao
	m.natu      = LNnatureza
	m.nome      = LSnome

	*-----------------------------------------------------------*
	*   Tratando os Registro Referentes a Entradas (MODO_PGTO = 1)
	*-----------------------------------------------------------*

	LNserie	   	= 1		&& Diferenciador do Numero da Duplicata
						&& 0 a 9
	SELE orca_pgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(LNEmp,3)+STR(LNOrcamento,6)
	SET NEAR OFF

	DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
					AND LNorcamento = orca_pgt.orcamento;
					AND orca_pgt.modo_pgto = 1

		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA


		IF LNemp = 10
		
		    && A IDL NAO POSSUI CONTROLE DE FATURAMENTO COM INFORMACOES
		    && SUFICIENTES PARA ORCAPGTO
		
			m.tp_parcela=  	3
			m.moeda 	=	3
		else
			m.tp_parcela=  	orca_pgt.tp_parcela
			m.moeda 	=	orca_pgt.moeda
		ENDIF

		IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
		               && Carteira e esta remete para
		               && Banco
			m.portador 	=  0   && CARTEIRA
		ELSE
			m.portador 	= orca_pgt.banco
		ENDIF

		m.banco 	=	orca_pgt.banco
		m.carteira  = ""
		m.variacao  = ""
		m.convenio  = ""
		m.conta     = ""
		m.conta_dv  = ""
		m.agencia   = 0
		m.agencia_dv= ""
		
		
		*-----------------------------------------------*
        *--------------------------------------------------------------
        *       PrmImpBoleto
     	*                         = "EMITIR BOLETO"
	    *                         = "SEM BOLETO" OU .F.
        *--------------------------------------------------------------
	    m.NUM_NO_BCO = ""
        IF PrmImpBoleto = "SEM BOLETO"
		    =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			   "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			     m.convenio,m.conta,m.conta_dv,;
			     m.agencia,m.agencia_dv)
        ELSE
           =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			   "EMISSOR BOLETO", m.Carteira,m.Variacao,;
			     m.convenio,m.conta,m.conta_dv,;
			     m.agencia,m.agencia_dv)
		   DO CASE
				CASE m.BANCO = 001
				 m.NUM_NO_BCO = ;
					 CR_001geraNssNro(m.Empresa, 001,m.carteira,m.variacao)
				CASE m.BANCO = 237
				  m.NUM_NO_BCO = ;
				     CR_237geraNssNro(m.Empresa, 237,m.carteira,m.variacao)
			ENDCASE
		    m.NUM_NO_BCO = CHRTRAN(m.NUM_NO_BCO," ","0")
		ENDIF

		*-----------------------------------------------*

		
		m.vlr_doc	 =	orca_pgt.vlr_pgto - LNvl_issrtd
		m.vlr_issrtd =  LNvl_issrtd
		LNvl_issrtd  =  0
		m.dt_venc	=	m.dt_emi		
		m.obs =""


		m.vlr_pgto  =   0
   		m.dt_baixa  =   {}
   		m.dt_pgto   =   {}


		DO CASE
			CASE m.moeda = 4  &&	-Cheque Eletronico  : 	1 dia
				m.dt_venc	=	m.dt_emi + 1		


			CASE m.moeda = 5 and m.BANCO = 867 && BRASIL CARD 40 dias	
				m.dt_venc	=	m.dt_emi + 40		


			CASE m.moeda = 5  &&	-CartÆo Rotativo 	:  31 dias	
				m.dt_venc	=	m.dt_emi + 31		



*------  a baixa sera feita no processo importacao caixa e processamento
*            OTHERWISE
*
 *         		m.vlr_pgto  =   m.vlr_doc
  *        		m.dt_baixa  =   m.dt_emi
   *       		m.dt_pgto   =   m.dt_emi
   *--------------------------------------------

		ENDCASE


		IF TYPE("orcament.AJSTFIMSEM") = "U"
			=CRajustaVenc(m.dt_venc,"+")
		ELSE
			IF orcament.AJSTFIMSEM <> "N"
				=CRajustaVenc(m.dt_venc,"+")
			ENDIF
		ENDIF

        *--------------------------------------------------*		
        m.dt_p_desct = m.dt_venc
        m.dt_cbr_jrs = m.dt_venc

		LNdias = 0
		m.dt_protest =  m.dt_venc
		DO WHILE LNdias < 5
		    m.dt_protest =  m.dt_protest + 1
			IF dow(m.dt_protest) <> 1 AND dow(m.dt_protest) <> 7
				LNdias = LNdias + 1
			ENDIF
		ENDDO
		m.vlr_mora = m.vlr_doc * empresa.mora / 100
        m.vlr_juros = 0
        m.vlr_dsct  = 0
        *--------------------------------------------------*		
		SELE  duplicat
		
		
		SELE  duplicat
        SET ORDER TO TAG DOC
        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
        IF !FOUND()
			=edithand('SAVE')
		ENDIF
		
		LNserie    = LNserie + 1
		SELE orca_pgt
		SKIP
	ENDDO



	*-----------------------------------------------------------*
	*   Diferenciar Tratando das Parcelas de Acordo Com o Tipo de
	*  Parcelamento :
	*
	*		TP_PARCELA = 1 (A Vista)
	*			OBS: Neste Caso o Pgto com Cheque Eletronico ou
	*				CartÆo Rotativo SÆo Considerados A Prazo e
	*				Assumem Prazos Fixos Sendo:
	*					-Cheque Eletronico  : 	1 dia
	*					-CartÆo Rotativo 	:  31 dias	
	*
	*		TP_PARCELA <> 1 (Parcelados)		
	* 			OBS: Em Opera‡äes Realmente de Origem Parcelada os
	*               Registro Seguem o Prazo Que Estiver Estipulado
	*               no Campo Prazo da OSI e a Entrada (000/...) ‚
	*               Desconsiderada Por j  Ter Sido Tratada
	*					-Cheque          	:  ???/???/???/??? dias	
	*					-Duplicata          :  ???/???/???/??? dias	
	*					-CartÆo Parcelado	:  ???/???/???/??? dias	
	*
	*-----------------------------------------------------------*
	* Tratando os Registro Referentes a Parcelas (MODO_PGTO = 2)
	*-----------------------------------------------------------*
	* Determinando o Numero de Parcelas Especificadas (LNnumpgt)
	* Ex: "000/030/060/090/000/000 => 3 Parcelas (A Entrada ‚
	*                                              Desprezada)
	* Ex: "030/000/000/000/000/000 => 1 Parcela Sem Entrada
	*
	* Ex: "000/000/000/000/000/000 => 1 Parcela (Conta Apresenta‡Æo)
	*-----------------------------------------------------------*
	DO CASE
		CASE 	orcament.TP_PARCELA = 1 ;
			OR  orcament.TP_PARCELA = 5  && (A Vista / A Vista Com CartÆo)

			SELE orca_pgt
			SET ORDER TO TAG orca_pgto
			DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
					AND LNorcamento = orca_pgt.orcamento;
					AND orca_pgt.modo_pgto = 2

				m.duplicata	= ;
						INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
							  CHRTRAN(STR(LNserie,2)," ","0");
							  ))   && 1 => DUPLICATA

				m.tp_parcela=  	orca_pgt.tp_parcela
				m.moeda 	=	orca_pgt.moeda
				IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
				               && Carteira e esta remete para
				               && Banco
					m.portador 	=  0   && CARTEIRA
				ELSE
					m.portador 	= orca_pgt.banco
				ENDIF
				m.banco 	=	orca_pgt.banco

				m.vlr_doc	 =	orca_pgt.vlr_pgto - LNvl_issrtd
				m.vlr_issrtd =  LNvl_issrtd
				LNvl_issrtd  =  0



				m.vlr_pgto  =   0
				m.dt_venc	=	m.dt_emi		
				m.obs =""

				DO CASE
					CASE m.banco = 860  &&	Ticket CAR:prox 2F + 30dias
						Ctrdias = 0
						DO While dow(m.dt_emi+Ctrdias) <> 2
							Ctrdias = Ctrdias + 1
						ENDDO
						m.dt_venc	=	m.dt_emi + 30 + Ctrdias
						
						
					CASE m.banco = 867  &&	BRASIL CARD: + 40dias
						m.dt_venc	=	m.dt_emi + 40


								
					CASE m.moeda = 4  &&	-Cheque Eletronico  : 	1 dia
						m.dt_venc	=	m.dt_emi + 1		
					CASE m.moeda = 5  &&	-CartÆo Rotativo 	:  31 dias	
						m.dt_venc	=	m.dt_emi + 31		
				ENDCASE

				IF TYPE("orcament.AJSTFIMSEM") = "U"
					=CRajustaVenc(m.dt_venc,"+")
				ELSE
					IF orcament.AJSTFIMSEM <> "N"
						=CRajustaVenc(m.dt_venc,"+")
					ENDIF
				ENDIF
				

				m.carteira  = ""
				m.variacao  = ""
				m.convenio  = ""
		        m.conta     = ""
		        m.conta_dv  = ""
		        m.agencia   = 0
                m.agencia_dv= ""
				*-----------------------------------------------*


	    	    m.NUM_NO_BCO = ""
	            IF PrmImpBoleto = "SEM BOLETO"
			        =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    			   "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			    	     m.convenio,m.conta,m.conta_dv,;
			    	     m.agencia,m.agencia_dv)
	            ELSE
        	       =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    			   "EMISSOR BOLETO", m.Carteira,m.Variacao,;
			    	     m.convenio,m.conta,m.conta_dv,;
			    	     m.agencia,m.agencia_dv)
	    		   DO CASE
			    		CASE m.BANCO = 001
					     m.NUM_NO_BCO = ;
	    					 CR_001geraNssNro(m.Empresa,;
	    					  001,m.carteira,m.variacao)
	    				CASE m.BANCO = 237
			    		  m.NUM_NO_BCO = ;
					         CR_237geraNssNro(m.Empresa,;
					          237,m.carteira,m.variacao)
	    			ENDCASE
			        m.NUM_NO_BCO = CHRTRAN(m.NUM_NO_BCO," ","0")
	    		ENDIF
				*-----------------------------------------------*
                m.dt_p_desct = m.dt_venc
                m.dt_cbr_jrs = m.dt_venc

        		LNdias = 0
        		m.dt_protest =  m.dt_venc
        		DO WHILE LNdias < 5
        		    m.dt_protest =  m.dt_protest + 1
        			IF dow(m.dt_protest) <> 1 AND dow(m.dt_protest) <> 7
        				LNdias = LNdias + 1
        			ENDIF
        		ENDDO
        		m.vlr_mora = m.vlr_doc * empresa.mora / 100
                m.vlr_juros = 0
                m.vlr_dsct  = 0
				*-----------------------------------------------*

				SELE  duplicat


				SELE  duplicat
		        SET ORDER TO TAG DOC
		        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
		        IF !FOUND()
					=edithand('SAVE')
				ENDIF

				LNserie    = LNserie + 1
				SELE orca_pgt
				SKIP
			ENDDO

    ********************************************************************
    *   processo novo tratando parcelamento com cartao - SERGIO NOV/2014   ********************************************************************

		CASE orcament.TP_PARCELA  = 4 ;
  		     and orca_pgt.prcls_cart > 0   && (Cart Parcelados )	


			*-----------------------------------------------*
			SELE orca_pgt
			DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
							AND LNorcamento = orca_pgt.orcamento;
							AND orca_pgt.modo_pgto = 2
				SET DECIMALS TO 6


				LNocorrenc 	= 1		&& 1¦,2¦,3¦... Ocorrencia do Char "/"
	
		    	LNnumpgt   	= orca_pgt.prcls_cart
		


				*---------------------------------------------------*
				* Calculo de Diferenca Provocada na DivisÆo e Que ‚ Lan‡ada
				* na 1¦ Parcela
				*---------------------------------------------------*
			   	CVSTR1    = STR((orca_pgt.vlr_pgto) / (LNnumpgt) ,25,11)
			   	CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   			LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
			   	LNdifere  = orca_pgt.vlr_pgto - (LNvlrdupl * LNnumpgt)
				*---------------------------------------------------*


                LNdias  = 31

				DO WHILE LNocorrenc <= LNnumpgt

					**************************************************

					m.duplicata	= ;
					   INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
							  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA





					m.tp_parcela= orca_pgt.tp_parcela
					m.moeda 	= orca_pgt.moeda

					m.portador 	= orca_pgt.banco




					m.vlr_doc	 =	LNvlrdupl - LNvl_issrtd + LNdifere

					m.vlr_issrtd =  LNvl_issrtd
					LNvl_issrtd  =  0



					m.vlr_pgto  = 0
					LNdifere   	= 0			&& Proxima nÆo agrega Diferen‡a

					m.dt_venc  	= m.dt_emi + (LNdias * LNocorrenc)


					IF TYPE("orcament.AJSTFIMSEM") = "U"
						=CRajustaVenc(m.dt_venc,"+")
					ELSE
						IF orcament.AJSTFIMSEM <> "N"
							=CRajustaVenc(m.dt_venc,"+")
						ENDIF
					ENDIF

					*--------------------------------------------------*
					*CALCULO  VENDOR--*
					*--------------------------------------------------*
		 			m.VLR_COMPRA = orcament.valor

					m.vlr_encarg = 0
				    m.vlr_ioffnc = 0
					m.TotVlVendr = 0

					*--------------------------------------------------*


					m.obs =""
					m.dtproxproc= m.dt_venc
					*---------------------------------------------------*		

					m.banco = orca_pgt.banco

					m.carteira  = ""
					m.variacao  = ""
					m.convenio  = ""
		            m.conta     = ""
		            m.conta_dv  = ""
                    m.agencia   = 0
                    m.agencia_dv= ""
					*-----------------------------------------------*


	 	    	    m.NUM_NO_BCO = ""
	     	        IF PrmImpBoleto = "SEM BOLETO"
			 	        =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    			 	   "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			    	 	     m.convenio,m.conta,m.conta_dv,;
			    	     	 m.agencia,m.agencia_dv)
	 	            ELSE
     	    	       =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    	 			   "EMISSOR BOLETO", m.Carteira,m.Variacao,;
	  			    	     m.convenio,m.conta,m.conta_dv,;
		 		    	     m.agencia,m.agencia_dv)
	 	    		   DO CASE
		 		    		CASE m.BANCO = 001
			 			     m.NUM_NO_BCO = ;
	    		 				 CR_001geraNssNro(m.Empresa,;
	    			 			  001,m.carteira,m.variacao)
	 	    				CASE m.BANCO = 237
		 		    		  m.NUM_NO_BCO = ;
			 			         CR_237geraNssNro(m.Empresa,;
				 		          237,m.carteira,m.variacao)
	 	    			ENDCASE
	 			        m.NUM_NO_BCO = CHRTRAN(m.NUM_NO_BCO," ","0")
	 	    		ENDIF
					*-----------------------------------------------*
  				    *-----------------------------------------------*
                    m.dt_p_desct = m.dt_venc
                    m.dt_cbr_jrs = m.dt_venc

        		    m.dt_protest =  m.dt_venc + 5
        		    m.vlr_mora = m.vlr_doc * empresa.mora / 100
                    m.vlr_juros = 0
                    m.vlr_dsct  = 0
				    *-----------------------------------------------*


					SELE  duplicat
			        SET ORDER TO TAG DOC
			        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
			        IF !FOUND()
						=edithand('SAVE')
					ENDIF



					LNserie    = LNserie + 1
					LNocorrenc = LNocorrenc + 1
				ENDDO
				SELE orca_pgt
				SKIP
			ENDDO


    ********************************************************************
    *   processo preservado antigo
    ********************************************************************
		CASE	orcament.TP_PARCELA  <> 1 		&& (Parcelados)		

			LNocorrenc 	= 1		&& 1¦,2¦,3¦... Ocorrencia do Char "/"
		    LNposic    	= 0     && Qual Posi‡Æo da Str Oocorre "/" 3,7,...
		    LNnumpgt   	= 0		&& Quantidade de Parcelas Fora Entrada
			LNdias	   	= 0		&& Dias de Prazo da Parcela
			LNproximodias	= 0  && Permite Diferenciar o
							 && Pgto com Entrada (000/031/000/000)
							 && do Pgto Conta Apresent‡Æo
							 && (000/000/000/...). No Primeiro Caso Quando
							 && LNdias = 0 (ou ser  a Entrada ou Invalido)
							 && e  nÆo ser  gerada Duplicatas. J  no
							 && Segundo Caso deve Ser Gerada Uma Dupl.
							 && Conta Apresenta‡Æo
		    LNinicio   	= 1
			*-----------------------------------------------------------*

			DO WHILE .t.
		        LNinicio   	= LNposic + 1
			    LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
				LNproximodias= INT(VAL(SUBS(LSprazo,LNinicio+4,3)))

	    		LNposic 	= AT("/",LSprazo, LNocorrenc)
				*-----------------------------------------------*
	  			IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
					EXIT
				ENDIF
				*-----------------------------------------------*
				*-----------------------------------------------*
				* LNdias = 0 AND LNproximodias => Conta Apresenta‡Æo
				*-----------------------------------------------*
				* 000/000/000/...  Conta Apresenta‡Æo
				*				LNnumpgt = 1
				*-----------------------------------------------*
				*-----------------------------------------------*
				IF LNdias = 0 AND LNproximodias > 0 && Descarte da
													&&  Entrada
					LNocorrenc 	= LNocorrenc + 1
				ELSE
					LNocorrenc 	= LNocorrenc + 1
			       	LNnumpgt   	= LNnumpgt + 1
				ENDIF
			ENDDO

			*-----------------------------------------------*
			SELE orca_pgt
			DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
							AND LNorcamento = orca_pgt.orcamento;
							AND orca_pgt.modo_pgto = 2
				SET DECIMALS TO 6
				*---------------------------------------------------*
				* Calculo de Diferenca Provocada na DivisÆo e Que ‚ Lan‡ada
				* na 1¦ Parcela
				*---------------------------------------------------*
			   	CVSTR1    = STR((orca_pgt.vlr_pgto) / (LNnumpgt) ,25,11)
			   	CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   			LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
			   	LNdifere  = orca_pgt.vlr_pgto - (LNvlrdupl * LNnumpgt)
				*---------------------------------------------------*
				LNocorrenc 		= 1
			    LNposic    		= 0
				LNdias			= 0
				LNproximodias	= 0  && Permite Diferenciar o
							 && Pgto com Entrada (000/031/000/000)
							 && do Pgto Conta Apresent‡Æo
							 && (000/000/000/...). No Primeiro Caso Quando
							 && LNdias = 0 (ou ser  a Entrada ou Invalido)
							 && e  nÆo ser  gerada Duplicatas. J  no
							 && Segundo Caso deve Ser Gerada Uma Dupl.
							 && Conta Apresenta‡Æo
			    LNinicio   	= 1

				DO WHILE .t.
					LNinicio = LNposic + 1										
			        LNdias       = INT(VAL(SUBS(LSprazo,LNinicio,3)))
					LNproximodias= INT(VAL(SUBS(LSprazo,LNinicio+4,3)))

			        LNposic = AT("/",LSprazo, LNocorrenc)  && PASSA PARA
			        									 && PROXIMA POSICAO
			        									 && DE INICIO DA
			        									 && DIA
					*-----------------------------------------------*
			   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
						EXIT
					ENDIF

					*-----------------------------------------------*
					* LNdias = 0 AND LNproximodias => Conta Apresenta‡Æo
					*-----------------------------------------------*
					IF LNdias = 0 AND LNproximodias > 0 && Descarte da
														&&  Entrada
						LNocorrenc = LNocorrenc + 1
						LOOP
					ENDIF
					**************************************************




					m.duplicata	= ;
					   INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
							  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA





					m.tp_parcela= orca_pgt.tp_parcela
					m.moeda 	= orca_pgt.moeda

					IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
					               && Carteira e esta remete para
					               && Banco
						m.portador 	=  0   && CARTEIRA
					ELSE
						m.portador 	= orca_pgt.banco
					ENDIF



					***m.vlr_doc  	= LNvlrdupl + LNdifere


					m.vlr_doc	 =	LNvlrdupl - LNvl_issrtd + LNdifere

					m.vlr_issrtd =  LNvl_issrtd
					LNvl_issrtd  =  0



					m.vlr_pgto  = 0
					LNdifere   	= 0			&& Proxima nÆo agrega Diferen‡a
					m.dt_venc  	= m.dt_emi + LNdias


					IF TYPE("orcament.AJSTFIMSEM") = "U"
						=CRajustaVenc(m.dt_venc,"+")
					ELSE
						IF orcament.AJSTFIMSEM <> "N"
							=CRajustaVenc(m.dt_venc,"+")
						ENDIF
					ENDIF

					*--------------------------------------------------*
					*CALCULO  VENDOR--*
					*--------------------------------------------------*
		 			m.VLR_COMPRA = orcament.valor

					m.vlr_encarg = 0
				    m.vlr_ioffnc = 0
					m.TotVlVendr = 0

					IF m.tp_parcela = 6   && VENDOR


						=W_DEFPROC("duplicat.spr")
						IF !CRtxsVendor(m.Empresa,m.Dt_Emi,;
								m.dt_venc,m.Tp_Pessoa,;
						  		AIA,;
						  		AIOF,;
						  		d,;
						  		m.TX_JUROSCP,;
						  		m.TX_JUROSVD)

							STORE 0 TO 	AIA,AIOF,m.TX_JUROSCP,m.TX_JUROSVD
						ENDIF


			 			
						=W_DEFPROC("duplicat.spr")
						=CRcalcVendor(m.Empresa,;
							m.vlr_doc,;
							m.dt_emi,;
							m.dt_venc,;
							m.Tp_Pessoa,;
	   			    		m.FlgImbuteIOF,;
			        		m.vlr_encarg,;
    			    		m.vlr_ioffnc,;
	        				m.TotVlVendr,;
	        				m.vlr_encbco)
					ENDIF

					*--------------------------------------------------*
					*--------------------------------------------------*
					*--------------------------------------------------*


					m.obs =""
					m.dtproxproc= m.dt_venc
					*---------------------------------------------------*		
					* EM COMPRAS A PRAZO COM A 1a DUPLICATA (TP_PARCELA = 3)
					*   COMO CONTA APRESENTACAO, ESTA 1a E
					* 	DIRECIONADA P/ A CARTEIRA E A DEMAIS
					* 	P/ O BANCO SOLICITADO. LNbanco GUARDO O
					* 	BANCO SOLICITADO P/ USO APOS GERAR A 1a
					*---------------------------------------------------*
					LNtmp  = m.dt_venc - m.dt_emi
				    IF  LNtmp <= 7  AND orca_pgt.tp_parcela = 3
	    						    && DUPLICATA CONTA APRESENTACAO
						m.banco = 0		 	&& DIRECIONA P/ CARTEIRA
					ELSE
						m.banco = orca_pgt.banco
										 && DIRECIONA P/ BANCO SOLICITADO	
					ENDIF

					m.carteira  = ""
					m.variacao  = ""
					m.convenio  = ""
		            m.conta     = ""
		            m.conta_dv  = ""
                    m.agencia   = 0
                    m.agencia_dv= ""
					*-----------------------------------------------*


	 	    	    m.NUM_NO_BCO = ""
	     	        IF PrmImpBoleto = "SEM BOLETO"
			 	        =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    			 	   "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			    	 	     m.convenio,m.conta,m.conta_dv,;
			    	     	 m.agencia,m.agencia_dv)
	 	            ELSE
     	    	       =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    	 			   "EMISSOR BOLETO", m.Carteira,m.Variacao,;
	  			    	     m.convenio,m.conta,m.conta_dv,;
		 		    	     m.agencia,m.agencia_dv)
	 	    		   DO CASE
		 		    		CASE m.BANCO = 001
			 			     m.NUM_NO_BCO = ;
	    		 				 CR_001geraNssNro(m.Empresa,;
	    			 			  001,m.carteira,m.variacao)
	 	    				CASE m.BANCO = 237
		 		    		  m.NUM_NO_BCO = ;
			 			         CR_237geraNssNro(m.Empresa,;
				 		          237,m.carteira,m.variacao)
	 	    			ENDCASE
	 			        m.NUM_NO_BCO = CHRTRAN(m.NUM_NO_BCO," ","0")
	 	    		ENDIF
					*-----------------------------------------------*
  				    *-----------------------------------------------*
                    m.dt_p_desct = m.dt_venc
                    m.dt_cbr_jrs = m.dt_venc

        		    LNdias = 0
        		    m.dt_protest =  m.dt_venc
        		    DO WHILE LNdias < 5
        		        m.dt_protest =  m.dt_protest + 1
        			    IF dow(m.dt_protest) <> 1 AND dow(m.dt_protest) <> 7
        			    	LNdias = LNdias + 1
        			    ENDIF
        		    ENDDO
        		    m.vlr_mora = m.vlr_doc * empresa.mora / 100
                    m.vlr_juros = 0
                    m.vlr_dsct  = 0
				    *-----------------------------------------------*


					SELE  duplicat
			        SET ORDER TO TAG DOC
			        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
			        IF !FOUND()
						=edithand('SAVE')
					ENDIF



					LNserie    = LNserie + 1
					LNocorrenc = LNocorrenc + 1
				ENDDO
				SELE orca_pgt
				SKIP
			ENDDO


	ENDCASE

	*-----------------------------------------------------------*
	SET DECIMALS TO 2
	=UP_fecha("duplicat"  ,LFduplicata )
	=UP_fecha("empresa"   ,LFempresa   )
	=UP_fecha("orcamento" ,LForcamento )
	=UP_fecha("clienc" ,LFclienc )
	=UP_fecha("orca_pgt"  ,LForca_pgt )
	=UP_fecha("clientes"  ,LFclientes )
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC6YR           CRqtd_parcelas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   59  º
*       º Variable:            CRqtd_parcelas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      53                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc6yr     &&  CRqtd_parcelas VALID
#REGION 1
RETURN

FUNCTION CRqtd_parcelas
PARAMETERS LSPrazo



			LNocorrenc 	= 1		&& 1¦,2¦,3¦... Ocorrencia do Char "/"
		    LNposic    	= 0     && Qual Posi‡Æo da Str Oocorre "/" 3,7,...
		    LNnumpgt   	= 0		&& Quantidade de Parcelas Fora Entrada
			LNdias	   	= 0		&& Dias de Prazo da Parcela
			LNproximodias	= 0  && Permite Diferenciar o
							 && Pgto com Entrada (000/031/000/000)
							 && do Pgto Conta Apresent‡Æo
							 && (000/000/000/...). No Primeiro Caso Quando
							 && LNdias = 0 (ou ser  a Entrada ou Invalido)
							 && e  nÆo ser  gerada Duplicatas. J  no
							 && Segundo Caso deve Ser Gerada Uma Dupl.
							 && Conta Apresenta‡Æo
		    LNinicio   	= 1
			*-----------------------------------------------------------*



			DO WHILE .t.
		        LNinicio   	 = LNposic + 1
			    LNdias       = INT(VAL(SUBS(LSprazo,LNinicio,3)))
				LNproximodias= INT(VAL(SUBS(LSprazo,LNinicio+4,3)))

	    		LNposic 	 = AT("/",LSprazo, LNocorrenc)
				*-----------------------------------------------*
	  			IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
					EXIT
				ENDIF
				*-----------------------------------------------*
				*-----------------------------------------------*
				* LNdias = 0 AND LNproximodias => Conta Apresenta‡Æo
				*-----------------------------------------------*
				* 000/000/000/...  Conta Apresenta‡Æo
				*				LNnumpgt = 1
				*-----------------------------------------------*
				*-----------------------------------------------*
				IF LNdias = 0 AND LNproximodias > 0 && Descarte da
													&&  Entrada
					LNocorrenc 	= LNocorrenc + 1
				ELSE
					LNocorrenc 	= LNocorrenc + 1
			       	LNnumpgt   	= LNnumpgt + 1
				ENDIF
			ENDDO
RETURN(LNnumpgt)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC702           CRBltTxtDevmedia VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   60  º
*       º Variable:            CRBltTxtDevmedia                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      54                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc702     &&  CRBltTxtDevmedia VALID
#REGION 1
RETURN

FUNCTION  CRBltTxtDevmedia

PARAMETERS PrmEmpresa,PrmNota,PrmSistema
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNdup

	PRIVATE LNBol_ordem


    IF TYPE("PrmSistema") <> "C"
      PrmSistema = "FOX"
    ENDIF


	PRIVATE LSnota      && STRING COM NUMERO DA NOTA PARA COMPARACAO
	PRIVATE LSnotaDaDup && STRING COM NUMERO DA NOTA RETIRADO DO NUMERO
						&& DA DUPLICATA


    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Clientes,ALS_Clientes
    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_Cobranca  ,ALS_Cobranca

    LSAlias      = Alias()

    ARQ_Clientes     = NetArqAgain("Clientes")
    ALS_Clientes     = Alias()


    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_Cobranca     = NetArqAgain("Cobranca")
    ALS_Cobranca     = Alias()



    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()




	*------------------------------------------------------------*
	
	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
	*  ALGORITIMO DE GERACAO DO NUMERO DE DUPLICATA - CRgeradupl
	*----------------------------------------------------------------*
	*
	*	IF LNemp <> 10
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  STR(m.empresa,1)))   && 1 => DUPLICATA
	*	else
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  "0"))   && 1 => DUPLICATA
	*	ENDIF
	*-------------------------------------------------------------------*

  	PRIVATE LSfileXML,LNroIDfileXML, LSnomeArqXml
  	LSfileXML = ""
  	LNroIDfileXML = -1
  	LSnomeArqXml =""

    IF !CRGraBlt_01(LSfileXML,LNroIDfileXML, LSnomeArqXml)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      RETURN
    ENDIF




	LFdados = .f.

	LSnota  = STR(PrmNota,7)

	LNdup	= PrmNota * 100		




	SELE &ALS_Empresa
	SET ORDER TO TAG empresa
	SEEK PrmEmpresa



	SET NEAR ON

	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(LNdup,9)
	SET NEAR OFF
	DO WHILE !EOF() AND LSnota = LEFT(STR( &ALS_Duplicat .duplicata,9) ,7)


		
		SELE &ALS_Clientes
		SET ORDER TO TAG cliente
		SEEK  &ALS_Duplicat .cliente



		SELE &ALS_Cobranca
		SET ORDER TO TAG operacao
			seek str(PrmEmpresa,3) + STR( &ALS_dUPLICAT .BANCO,3) + ;
		        "BOLETO EMPRESA"

		if FOUND()
	   	    LFdados = .t.

			*---------------------------------------------------*

			LScarteira	= 	&ALS_cobranca .carteira
			LSvariacao  =	&ALS_cobranca .variacao
			if empty(alltrim(&ALS_Duplicat .NUM_NO_BCO))

				DO CASE
					CASE &ALS_Duplicat .BANCO = 001
					 LSnossoNumero = ;
						 CR_001geraNssNro;
						  (PrmEmpresa,001,LScarteira,LSvariacao)
				CASE &ALS_Duplicat .BANCO = 237
					  LSnossoNumero = ;
				     	 CR_237geraNssNro;
				     	  (PrmEmpresa, 237,LScarteira,LSvariacao)
				ENDCASE
			ELSE		
				LSnossoNumero = &ALS_Duplicat .NUM_NO_BCO
			ENDIF

            *------------------------------------------------------*

			SELE &ALS_Duplicat

			
    	 	m.ConfNroBco  = &ALS_Duplicat .ConfNroBco
			LSnossoNumero = CHRTRAN(LSnossoNumero," ","0")

			IF empty(alltrim(&ALS_Duplicat .NUM_NO_BCO))
				m.ConfNroBco = .f.
			ENDIF
    	    =RLOCK()
			LScarteira	= 	&ALS_cobranca .carteira
			LSvariacao  =	&ALS_cobranca .variacao

			REPLACE &ALS_Duplicat .carteira   WITH LScarteira
			REPLACE &ALS_Duplicat .variacao   WITH LSvariacao
			REPLACE &ALS_Duplicat .ConfNroBco WITH m.ConfNroBco
			REPLACE &ALS_Duplicat .NUM_NO_BCO WITH LSnossoNumero

            *------------------------------------------------------*

	   	
		    LSVlr = ALLTRIM(str( &ALS_Duplicat .vlr_doc,12,2))
		    LSVlr = STRTRAN(LSVlr,".",",")	   	


  			LSendereco 	=  ;
  			       RTRIM( &ALS_empresa .endereco) +"-"+;
  			       RTRIM( &ALS_empresa .bairro)  +"-"+;
  			       RTRIM( &ALS_empresa .estado)  +"- CEP: "+;
  			       RTRIM( &ALS_empresa .CEP)
			*---------------------------------------------------*			
  			LSemissor 	=  ;
  			       ""
			LScarteira	= 	&ALS_cobranca .carteira
  			

            LSsac_av   = ""  			
            LSdocsac_av   = ""  			
            LSNrodoc   = alltrim(str( &ALS_Duplicat .duplicata ))


		*---------------------------------------------------*			



			LNdias = 0
			Ldata =  &ALS_Duplicat .DT_VENC
			DO WHILE LNdias < 5
			    Ldata =  Ldata + 1
				IF dow(Ldata) <> 1 AND dow(Ldata) <> 7
					LNdias = LNdias + 1
				ENDIF
			ENDDO
	
			Ldata = DTOC( Ldata )

			
			IF  &ALS_Duplicat .EMPRESA = 16 && SPE
				m.bol_linha = ""
			ELSE
				m.bol_linha = "PROTESTO EM : "+Ldata
			ENDIF

			LSprotesto = m.bol_linha


            *-------------------------------------------------*

			LNmoradiaria = ;
			    &ALS_Duplicat .vlr_doc * &ALS_empresa .mora / 100



		    LSmoradiaria = ;
		      "Cobrar juros de R$" + STR(LNmoradiaria,9,2) +;
		      " por dia de atraso para pagamento a partir de "+;
		      DTOC( &ALS_Duplicat .DT_VENC )

            *-------------------------------------------------*

			IF EMPTY(ALLTRIM( &ALS_Clientes .cbnome)) OR ;
			   EMPTY(ALLTRIM( &ALS_Clientes .cbendereco))
				m.nome	    =  &ALS_Clientes .nome
				m.endereco 	=  &ALS_Clientes .endereco
				m.bairro	=  &ALS_Clientes .bairro
				m.cidade	=  &ALS_Clientes .cidade
				m.estado	=  &ALS_Clientes .estado
				m.cep		=  &ALS_Clientes .cep
			ELSE
				m.nome	    =  &ALS_Clientes .CBnome
				m.endereco 	=  &ALS_Clientes .CBendereco
				m.bairro	=  &ALS_Clientes .CBbairro
				m.cidade	=  &ALS_Clientes .CBcidade
				m.estado	=  &ALS_Clientes .CBestado
				m.cep		=  &ALS_Clientes .CBcep
			ENDIF





  			LSendsac	=  ;
  			       RTRIM( m.endereco) +"-"+;
  			       RTRIM( m.bairro)  +"-"+;
  			       RTRIM( m.cidade)  +"-"+;
  			       RTRIM( m.estado)  +"- CEP: "+;
  			       RTRIM( m.CEP)

			*---------------------------------------------------*			
            LSinst_01   = LEFT(LSprotesto,100)
              			
            LSinst_02   = LEFT(LSmoradiaria,100)
            LSinst_03   = LEFT(LSendsac,100) 			

			*---------------------------------------------------*			
			LString =	;
			 	 "HVZ2A7XXIT"+";"+;
			 	 "bb"+";"+;
		          LSVlr+";"+;
	              ALLTRIM(LSnossoNumero)+";"+;
		          ALLTRIM(&ALS_cobranca .agencia)+";"+;
	              ALLTRIM(&ALS_cobranca .conta)+";"+;
    	          ALLTRIM(&ALS_cobranca .convenio)+";"+;
	             DTOC( &ALS_Duplicat .dt_venc)+";"+;
    	         &ALS_Empresa .nome+";"+;
		         LSendereco+";"+;
		         ALLTRIM(str( &ALS_Empresa .cgc,14))+";"+;
    	         &ALS_Duplicat .nome+";"+;
		         ALLTRIM( str( &ALS_Duplicat .cliente,14))+";"+;
                 LSemissor+";"+;
                 LScarteira+";"+;
				 LSinst_01+";"+;
				 LSinst_02+";"+;
				 LSinst_03+";"+;
                 LSsac_av+";"+;
                 LSdocsac_av+";"+;
                 LSNrodoc+";"+;
                 LSendsac+";"
		
			=fPuts(LNroIDfileXML,LString,LEN(LString))
		ENDIF
		*---------------------------------------------------*			
		SELE &ALS_Duplicat
		SKIP
	ENDDO

    =fclose(LNroIDfileXML)


	if LFdados
*        PrmArqOrigem  = "l:\tmp\boleto.txt"
*
*       PrmArqDestino  = "w:\bbboleto\boleto.txt"
*    ! Xcopy  &PrmArqOrigem &PrmArqDestino


        !copy l:\tmp\BOLETO.TXT w:\bbboleto\BOLETO.TXT


	endif
    =up_fecha("&ALS_Duplicat")
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Clientes")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)

FUNCTION CRGraBlt_01
PARAMETERS  LSfileXML,LNroIDfileXML, LSnomeArqXml

	IF TYPE("PrmArquivoLog") = "U" OR EMPTY(PrmArquivoLog)
		LSnomeArqXml = "l:\tmp\boleto.txt"
	ELSE
		LSnomeArqXml = PrmArquivoLog
	ENDIF
   	LSfileXML	= LSnomeArqXml



  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      return(.f.)
   	endif
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC70L           CRComandText VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    2  º
*       º Variable:            CRComandText                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      55                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc70l     &&  CRComandText VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRComandText
PARAMETER PrmCommand

	PRIVATE LSalias
	LSalias		= 	ALIAS()
	=CRVerifyInst()
	*--------------------------------------------------------------*
	
	&PrmCommand

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC70R           CRVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    3  º
*       º Variable:            CRVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      56                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc70r     &&  CRVerifyInst VALID
#REGION 2
return
*---------------------------------------------------------------*



FUNCTION CRVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Duplicat")


	DO CASE

		CASE TYPE("PBDuplicatAlias") = "U" ;
		   		OR EMPTY(PBDuplicatAlias) ;
		   		OR !USED(PBDuplicatAlias)
			=CRCreate()					

		CASE !("DUPLICAT.DBF" $ DBF(PBDuplicatAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBDuplicatAlias
			=CRCreate()					


		CASE  !(LSPath $ DBF(PBDuplicatAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=CRDestroi()				
			=CRCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC70X           CRCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    4  º
*       º Variable:            CRCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      57                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc70x     &&  CRCreate VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBDuplicatAlias") <> "U" ;
	   		AND !EMPTY(PBDuplicatAlias) ;
	   		AND USED(PBDuplicatAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBDuplicatAlias

	IF USED("Duplicat")
	     =NetArqAgain("Duplicat")
	     PBDuplicatAlias     = Alias()
	ELSE
	     =NetArqAgain("Duplicat")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Duplicat")
	     PBDuplicatAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBDuplicatAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTDuplicat[LMaxDim]
    PUBLIC DIMENSION VDDuplicat[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFDuplicat[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFDuplicat)



	*-----------------------------------------------------------*
	=CRReadProperty()
	=CRSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC714           CRDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    5  º
*       º Variable:            CRDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      58                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc714     &&  CRDestroi VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION CRDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBDuplicatAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBDuplicatAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBDuplicatAlias
	*  3- Se aplicar um FECHAMENTO a PBDuplicatAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBDuplicatAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBDuplicatAlias)) OR ;
	   !("DUPLICAT.DBF" $ DBF(PBDuplicatAlias))

		RELEASE PBDuplicatAlias
    	RELEASE VTDuplicat
	    RELEASE VDDuplicat
		RELEASE VFDuplicat
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBDuplicatAlias) AND USED(PBDuplicatAlias)
		SELECT &PBDuplicatAlias
		USE
	ENDIF	
	RELEASE PBDuplicatAlias
    RELEASE VTDuplicat
    RELEASE VDDuplicat
	RELEASE VFDuplicat

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC71A           CRReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    6  º
*       º Variable:            CRReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      59                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc71a     &&  CRReadProp VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBDuplicatAlias
	SCATTER TO VTDuplicat
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC71B           CRSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    7  º
*       º Variable:            CRSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      60                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc71b     &&  CRSetDerivadas VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDDuplicat(1,1) = "NAOINFORMADO"
   	VDDuplicat(1,2) = 0
   	VDDuplicat(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC71M           CRSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    8  º
*       º Variable:            CRSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      61                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc71m     &&  CRSetPropVT VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBDuplicatAlias,;
						    VTDuplicat,;
						    VDDuplicat,;
						    VFDuplicat)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC71S           CRGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    9  º
*       º Variable:            CRGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      62                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc71s     &&  CRGetPropVT VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBDuplicatAlias,;
	            VTDuplicat,;
	            VDDuplicat,;
	            VFDuplicat)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC71Z           CRChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   10  º
*       º Variable:            CRChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      63                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc71z     &&  CRChk_Identidade VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRChk_Identidade
PARAMETERS PrmEmpresa, PrmDuplicata
	PRIVATE LFreturn
	=CRVerifyInst()
	*----------------------------------------------------------------*
	LFreturn = .T.
	
    =CRSetPropVT("EMPRESA",PrmEmpresa)
    =CRSetPropVT("DUPLICATA",PrmDuplicata)
	LFreturn=CRFind()
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC724           CRFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   11  º
*       º Variable:            CRFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      64                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc724     &&  CRFind VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRFind
	PRIVATE Lempresa, Lduplicata
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=CRVerifyInst()

	Lempresa    = CRGetPropVT("EMPRESA")
	Lduplicata  = CRGetPropVT("DUPLICATA")
	

	SELE &PBDuplicatAlias
	SET ORDER TO TAG doc
	SEEK STR(Lempresa,3)+STR(Lduplicata,9)

	IF FOUND()
		=CRReadProperty()
		=CRSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC72B           CRGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   12  º
*       º Variable:            CRGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      65                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc72b     &&  CRGetFieldValue VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRGetFieldValue
PARAMETERS PrmEmpresa, PrmDuplicata,PrmField			


	IF !CRChk_Identidade(PrmEmpresa, PrmDuplicata)
					
		DO WHILE .T.
			=UPerrosys("Chamada GetFieldValue para Reg. Inexistente!")
		ENDDO
	ENDIF				


RETURN(CRGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC72H           CR_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   13  º
*       º Variable:            CR_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      66                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc72h     &&  CR_Refresh VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*




FUNCTION CR_Refresh
PARAMETERS PrmEmpresa, PrmDuplicata


	PRIVATE LFreturn

	=CRVerifyInst()


    =CRSetPropVT("EMPRESA",PrmEmpresa)
    =CRSetPropVT("DUPLICATA",PrmDuplicata)
	LFreturn=CRFind()
RETURN(LFreturn)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC72N           CRLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   15  º
*       º Variable:            CRLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      67                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc72n     &&  CRLerRegistro VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRLerRegistro
PARAMETERS PrmEmpresa, PrmDuplicata



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = CRChk_Identidade(PrmEmpresa, PrmDuplicata)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC72S           CRWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   16  º
*       º Variable:            CRWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      68                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc72s     &&  CRWriteProp VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBDuplicatAlias
	=RLOCK()
	GATHER FROM  VTDuplicat
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC72T           CRSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   17  º
*       º Variable:            CRSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      69                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc72t     &&  CRSalvarRegistro VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRSalvarRegistro

	=CRVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !CRExiste()
		SELE &PBDuplicatAlias
		APPEND BLANK
		LFretorno=CRWriteProp()
	ELSE
		SELE &PBDuplicatAlias
		LFretorno=CRWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC72U           CRExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   18  º
*       º Variable:            CRExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      70                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc72u     &&  CRExiste VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRExiste
	PRIVATE Lempresa, Lduplicata
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=CRVerifyInst()

	Lempresa    = CRGetPropVT("EMPRESA")
	Lduplicata  = CRGetPropVT("DUPLICATA")
	

	SELE &PBDuplicatAlias
	SET ORDER TO TAG doc
	SEEK STR(Lempresa,3)+STR(Lduplicata,9)

	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC73B           CRGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   20  º
*       º Variable:            CRGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      71                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc73b     &&  CRGetAlias VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRGetAlias

	=CRVerifyInst()

RETURN(PBDuplicatAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC73G           CRFaxinaDados VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   21  º
*       º Variable:            CRFaxinaDados                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      72                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc73g     &&  CRFaxinaDados VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRFaxinaDados

	PRIVATE LSAlias, TOTAL, CTR

	=CRVerifyInst()

	LSAlias = CRGetAlias()
	
	SELE &LSAlias

	COUNT TO TOTAL
	CTR = 0

	GO TOP
	DO WHILE !EOF()
		=RLOCK()


		CTR = 	CTR + 1
		MSG = STR(CTR,7)+" DE "+STR(TOTAL,7)
		WAIT WINDOW MSG NOWAIT


		REPLACE NOME WITH UPLimpaString(NOME)


		SKIP
	ENDDO
	


RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC73L           CRGerXMLDpDocFiscal VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   22  º
*       º Variable:            CRGerXMLDpDocFiscal                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      73                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc73l     &&  CRGerXMLDpDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRGerXMLDpDocFiscal
PARAMETER PrmEmpresa,;
		  PrmNro_Orca,;
		  PrmNro_Doc,;
		  PrmMod_doc,;
		  PrmSerie_Doc,;
		  PrmTP_Mov


	PRIVATE LSalias
	
	PRIVATE PrmAlsCR
	PRIVATE LNrecDupl
	
	PRIVATE LNosiReferencia   && relaciona as duplicatas pelo
	                          && orcamento de referencia

	

	LSalias  = ALIAS()
	PrmAlsCR = CRGetAlias()



	*-------------------------------------------------------*
	=CRModeloRefXML()

	*-------------------------------------------------------*

   	PRIVATE LSfileXML,LNroIDfileXML


   	LSfileXML	= CRNmFileXMLDocFiscal(PrmEmpresa,PrmMod_doc,PrmNro_Doc)
   	LSfileXML	= "C:\NFE\TMP\"+LSfileXML


  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return
   	endif





	*---------------------------------------------------*

	SELE &PrmAlsCR
	SET ORDER TO TAG REFR_ORCA
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmNro_Orca,6)
	SET NEAR OFF



	go bott
	go top
	

	SELE &PrmAlsCR
	SET ORDER TO TAG REFR_ORCA
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmNro_Orca,6)
	SET NEAR OFF




	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.


    IF !EOF()
		LNregistro = RECNO()

		COUNT  WHILE !EOF() ;
			AND PrmEmpresa    = &PrmAlsCR .empresa;
	        AND PrmNro_Orca   = &PrmAlsCR .orcamento ;
         TO LNimpressao
		GO LNregistro
	
	ENDIF
	
	LNimpressos = 0
	*----------------------------------------------------*


	=CRInicioXML(LSfileXML,LNroIDfileXML)


	SET POINT TO ','


	SELE &PrmAlsCR
	DO WHILE !EOF() ;
			AND PrmTP_Mov = "SAIDA" ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa       = &PrmAlsCR .empresa;
	        AND PrmNro_Orca       = &PrmAlsCR .orcamento

		=UPtermo()

		IF PrmMod_doc $ "77/03"
		   SKIP
		   LOOP
		ENDIF


		LNrecDupl = RECNO()



		=CRGravaXMLDpDocFiscal(;
 				PrmEmpresa,;
		  		PrmNro_Doc,;
			 	PrmMod_doc,;
			  	PrmSerie_Doc,;
				&PrmAlsCR .Duplicata,;
				LSfileXML,;
				LNroIDfileXML;
				)


		SELE &PrmAlsCR
		SET ORDER TO TAG refr_orca

		GO LNrecDupl
		SKIP
	ENDDO

	=CRFinalXML(LSfileXML,LNroIDfileXML)


	SET POINT TO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC73V           CRNmFileXMLDocFiscal VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   24  º
*       º Variable:            CRNmFileXMLDocFiscal               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      74                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc73v     &&  CRNmFileXMLDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRNmFileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*



	LSnomeArqXml = "DFISCB"+;
				   PrmMod_Doc
	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")


   	LSfileXML	= LSnomeArqXml+".XML"
	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC740           CRInicioXML VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   25  º
*       º Variable:            CRInicioXML                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      75                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc740     &&  CRInicioXML VALID
#REGION 2
RETURN

FUNCTION CRInicioXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML



   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDCCBR
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND xmlDCCBR.XML_ORDEM < 9999999999901
	
		LSLinhaXML = xmlDCCBR.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE xmlDCCBR
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC747           CRFinalXML VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   26  º
*       º Variable:            CRFinalXML                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      76                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc747     &&  CRFinalXML VALID
#REGION 2
RETURN

FUNCTION CRFinalXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDCCBR
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF xmlDCCBR.XML_ORDEM > 9999999999900
			LSLinhaXML = xmlDCCBR.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE xmlDCCBR
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC748           CRGravaXMLDpDocFiscal VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   27  º
*       º Variable:            CRGravaXMLDpDocFiscal              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      77                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc748     &&  CRGravaXMLDpDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRGravaXMLDpDocFiscal
PARAMETERS  	PrmEmpresa,;
		  		PrmNro_Doc,;
			 	PrmMod_doc,;
			  	PrmSerie_Doc,;
				PrmDuplicata,;
				PrmFileXML,;
				PrmNroIDfileXML

	PRIVATE LSAlsCR   && DUPLICATAS
	PRIVATE LSAlsCL   && CLIENTES
	PRIVATE LSAlsCL   && CLIENC
    PRIVATE LSalsNF   && NOTA
	

	LSAlsCR = CRGetAlias()

	=W_DEFPROC("CLIENTES.SPR")
	LSAlsCL = CLGetAlias()

	=W_DEFPROC("CLIENC.SPR")
	LSAlsCN = CNGetAlias()


	IF !CRLerRegistro(PrmEmpresa,;
			PrmDuplicata)
	      wait "Nao foi localizado Duplicata :"+;
		      "FILIAL: "+STR(PrmEmpresa,3)+;
		      "NRO.  : "+STR(PrmDuplicata,9)
   	  return(.F.)
    ENDIF



	=W_DEFPROC("NOTA.SPR")
    LSalsNF = NFGetAlias()

	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*

	=W_DEFPROC("EMPRESA.SPR")
	=EMLerRegistro(PrmEmpresa)

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("CGC")
	UNEM_CNPJ    =  STR(LFieldTmp,14)
	UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")

	SET POINT TO ","
	SET SEPARATOR  TO "."

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"')

		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("INSCRICAO")

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('UNEM_IE="'+LFieldTmp+'"')

		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*==========================================================*
	*  IDENTIFICACAO DO DFIS
	*==========================================================*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             DFGetPropVT("MOD_DOC") +;
	             '"')

		=W_DEFPROC("DOCFISCA.SPR")
        =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
	*----------------------------------------------------------*

	IF PrmNro_Doc > 3000000 AND PrmNro_Doc < 4000000

		PrmNro_Doc = PrmNro_Doc - 3000000

	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(PrmNro_Doc,7) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFIS_SERIE="'+;
	             PrmSerie_Doc +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFIS_CPF="'+;
	             "" +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFIS_CNPJ="'+;
	             "" +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TIPO_COBRANCA="'+;
	             "00" +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




*----------------------------------------------------------------------*

	DO CASE
			CASE     &LSAlsCR .moeda = 2 ;
			      OR &LSAlsCR .banco = 857 ;
				  OR &LSAlsCR .banco = 858

				LScodigo    = "02"
				LSdescricao = "cheque"

			CASE     &LSAlsCR .moeda = 3 ;
			      OR &LSAlsCR .banco = 859 ;
				  OR &LSAlsCR .banco = 860
			
				LScodigo    = "07"
				LSdescricao = "outra"

			CASE  &LSAlsCR .moeda = 4

				LScodigo    = "06"
				LSdescricao = "Cartao Debito"

			CASE  &LSAlsCR .moeda = 5
			
				LScodigo    = "05"
				LSdescricao = "Cartao Credito"

			OTHERWISE

				LScodigo    = "01"
				LSdescricao = "Dinheiro"

	ENDCASE


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_FORMA_PGTO_CODIGO="'+;
	        		     LScodigo +;
				             '"')
	=W_DEFPROC("DOCFISCA.SPR")
	=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_FORMA_PGTO_DESCRICAO="'+;
	        		     LSdescricao +;
				             '"')
	=W_DEFPROC("DOCFISCA.SPR")
	=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

*----------------------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DESCRICAO="'+;
	             "DUPLICATA" +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_NUMERO="'+;
	             ALLTRIM(STR(PrmDuplicata,9)) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_VLR_COBRANCA="'+;
	             STR( &LSAlsCR .VLR_DOC,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*-------------------------------------------------------*
	*-------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_CAIXA="'+;
	             '001' +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*-------------------------------------------------------*
    * AVISO BANCARIO - IDENTIFICACAO DO BANCO PORTADOR INICIAL DA COBRANCA
	*-------------------------------------------------------*

    m.Carteira = ""
    m.Variacao = ""
    m.convenio = ""
    m.conta    = ""
    m.conta_dv = ""
    m.agencia  = 0
    m.agencia_dv= ""

    =CRdefcarteira( &LSAlsCR .Empresa,;
                    &LSAlsCR .PORTADOR,;
                    &LSAlsCR .Tp_Parcela,;
                    "GERADOR DUPLICATA", ;
                    m.Carteira,;
                    m.Variacao,;
			        m.convenio,;
			        m.conta,;
			        m.conta_dv,;
			        m.agencia,;
			        m.agencia_dv)



	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_PORTADOR_BANCO="'+;
	             STR( &LSAlsCR .PORTADOR,3) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")

	LSLinhaXML =  CHRTRAN(STR( m.agencia,4)," ","0") +;
	  	            + ALLTRIM(m.agencia_dv)
	LSLinhaXML =  ALLTRIM( LSLinhaXML)

	LSLinhaXML = ULtratalinha('DFCB_PORTADOR_AGENCIA="'+;
	             LSLinhaXML +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

    *----> DEFINIR ??????

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_PORTADOR_CONTA_CORRENTE="'+;
	             ALLTRIM( m.conta )+;
	             ALLTRIM( m.conta_dv)+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_PORTADOR_CARTEIRA="'+;
	              m.Carteira +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_PORTADOR_VARIACAO="'+;
	              m.Variacao +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_PORTADOR_CONVENIO="'+;
	              m.convenio +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*-------------------------------------------------------*
    * AVISO BANCARIO - IDENTIFICACAO DO BANCO DESTINO DA COBRANCA
	*-------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DESTINO_BANCO="'+;
	             STR( &LSAlsCR .BANCO,3) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML =  CHRTRAN(STR( &LSAlsCR .AGENCIA ,4)," ","0") +;
	  	            + ALLTRIM( &LSAlsCR .agencia_dv)
	LSLinhaXML =  ALLTRIM( LSLinhaXML)

	LSLinhaXML = ULtratalinha('DFCB_DESTINO_AGENCIA="'+;
	             LSLinhaXML +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DESTINO_CONTA_CORRENTE="'+;
	             ALLTRIM( &LSAlsCR .conta)+;
	             ALLTRIM( &LSAlsCR .conta_dv)+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DESTINO_CARTEIRA="'+;
	              &LSAlsCR .CARTEIRA +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DESTINO_VARIACAO="'+;
	              ALLTRIM( &LSAlsCR .VARIACAO) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DESTINO_CONVENIO="'+;
	              ALLTRIM( &LSAlsCR .CONVENIO) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*-------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TIPO_AVISO="'+;
	             'VENDAS DO DIA' +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

    LNnroAviso =  chrtran(STR(YEAR(  &LSAlsCR .DT_EMI),4), " ","0");
                + chrtran(STR(MONTH( &LSAlsCR .DT_EMI),2), " ","0");
                + chrtran(STR(DAY( &LSAlsCR .DT_EMI),2), " ","0")

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_NUMERO_AVISO="'+;
	             LNnroAviso +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DT_AVISO="'+;
	             DTOC( &LSAlsCR .DT_EMI) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*-------------------------------------------------------*
    * ITENS  DO DOCUMENTO FINANCEIRO - IDENTIFICACAO DO TITULO
	*-------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TITULO_NUMERO="'+;
	             ALLTRIM(STR(PrmDuplicata,9)) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TITULO_NOSSO_NUMERO="'+;
	              &LSAlsCR .NUM_NO_BCO +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TITULO_CODIGO="'+;
	              &LSAlsCR .CODPARCELA +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_SEQUENCIA_TITULO="'+;
	              STR( &LSAlsCR .SEQUENCIA ,6) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TOTAL_TITULOS="'+;
	             STR( &LSAlsCR .QTPARCELAS ,6) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))







	*-------------------------------------------------------*
    *  IDENTIFICACAO DOS DOCUMENTOS REFERENCIADOS NO TITULO
	*-------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_FATURA_NUMERO="'+;
	             STR( &LSAlsCR .NOTA,7) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_NUMERO_RECIBO="'+;
	             STR( 0,7) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_PEDIDO_NUMERO="'+;
	             STR( &LSAlsCR .ORCAMENTO,7) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*-------------------------------------------------------*
    *  INFORMACOES DA NEGOCIACAO
	*-------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_IND_OPERACAO="'+;
	             'RECEBER'+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



    IF &LSAlsCR .DT_VENC = &LSAlsCR .DT_EMI
		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = ULtratalinha('DFCB_TIPO_PARCELA="'+;
		             'ENTRADA'+;
		             '"')

	ELSE
		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = ULtratalinha('DFCB_TIPO_PARCELA="'+;
		             'PARCELAS'+;
		             '"')
	ENDIF

		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*-------------------------------------------------------*
    private LSmddoc, LScpmref
	=W_DEFPROC("DOCFISCA.SPR")
	LSmddoc =  DFGetPropVT("MOD_DOC")

	=W_DEFPROC("DOCFISCA.SPR")
	LScpmref=  DFGetPropVT("NRO_CPMECF")
	LScpmref=  val(LScpmref)

	IF LScpmref = 0 OR  LSmddoc = "2D"
	      LSLinhaXML = "SIM"
    ELSE
	      LSLinhaXML = "NAO"
	ENDIF
	

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_IMPRIMIR_BOLETO="'+;
	             LSLinhaXML +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DATA_EMISSAO="'+;
	             DTOC( &LSAlsCR .DT_EMI) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DATA_VENCIMENTO="'+;
	             DTOC( &LSAlsCR .DT_VENC) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DATA_DESCONTO="'+;
	             DTOC( &LSAlsCR .DT_P_DESCT) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DATA_COBRARMORAJUROS="'+;
	             DTOC( &LSAlsCR .DT_CBR_JRS) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DATA_PROTESTAR="'+;
	             DTOC( &LSAlsCR .DT_PROTEST) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*---------------------------------------------------*			
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_VLR_DESCONTO="'+;
	             STR( &LSAlsCR .VLR_DSCT,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_VLR_MORA="'+;
	             STR( &LSAlsCR .VLR_MORA,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_VLR_JUROS="'+;
	             STR( &LSAlsCR .VLR_JUROS,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_VLR_ISS_RETIDO="'+;
	             STR( &LSAlsCR .VLR_ISSRTD,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_VLR_DOCUMENTO="'+;
	             STR( &LSAlsCR .VLR_DOC,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))






	*---------------------------------------------------*			
	private LNcpfcnpjc,LNim,LNie,LNnome,LNrazao,LNendereco
	private LNbairro,LNcidade,LNestado,	LNcep,LNibge
	private LNe_mail,LNddd,LNfone,LNobs



	LNcpfcnpjc = chrtran(str( &LSAlsCR .cliente,14)," ","0")
	LNim       =  &LSAlsCL .im_tomador
	LNie       =  &LSAlsCL .inscricao

	=W_DEFPROC("CLIENTES.SPR")
	IF CLLerRegistro( &LSAlsCR .CLIENTE)

		IF EMPTY(ALLTRIM( &LSAlsCL .cbnome)) OR ;
		   EMPTY(ALLTRIM( &LSAlsCL .cbendereco))
			LNnome	    =  &LSAlsCL .nome
			LNrazao	    =  &LSAlsCL .nome
			LNendereco 	=  &LSAlsCL .endereco
			LNbairro	=  &LSAlsCL .bairro
			LNcidade	=  &LSAlsCL .cidade
			LNestado	=  &LSAlsCL .estado
			LNcep		=  &LSAlsCL .cep

			LNibge      =  STR( &LSAlsCL .muni_ibge ,11)

			LNe_mail    =  &LSAlsCL .e_mail
			LNddd       = left( &LSAlsCL .fone,2)
			LNfone      = left( subs( &LSAlsCL .fone ,3),8)
		ELSE
			LNnome	    =  &LSAlsCL .CBnome
			LNrazao	    =  &LSAlsCL .CBnome
			LNendereco 	=  &LSAlsCL .CBendereco
			LNbairro	=  &LSAlsCL .CBbairro
			LNcidade	=  &LSAlsCL .CBcidade
			LNestado	=  &LSAlsCL .CBestado
			LNcep		=  &LSAlsCL .CBcep

			LNibge      =  STR( &LSAlsCL .CBmuni_ibg , 11)

			LNe_mail    =  &LSAlsCL .e_mail
			LNddd       = left( &LSAlsCL .cbfone,2)
			LNfone      = left( subs( &LSAlsCL .cbfone ,3),8)
		ENDIF


	ELSE

*----------- A BUSCA NO CLIENC ESTVA DIFICULTANDO A CORRECAO QDO HAVIA
*        PROBLEMAS COM ESTA ALTERACAO E POSSIVEL CORRIGIR NA NOTA E REEMITIR
*------------------------------------------------------------------
*  	    =W_DEFPROC("CLIENC.SPR")
*		IF CNLerRegistro( &LSAlsCR .Empresa ,  &LSAlsCR .Orcamento)
*			LNnome	    =  &LSAlsCN .nome
*			LNrazao	    =  &LSAlsCN .nome
*			LNendereco 	=  &LSAlsCN .endereco
*			LNbairro	=  &LSAlsCN .bairro
*			LNcidade	=  &LSAlsCN .cidade
*			LNestado	=  &LSAlsCN .estado
*			LNcep		=  &LSAlsCN .cep
*			LNibge      =  STR( &LSAlsCN .muni_ibge ,11)
*			LNe_mail    =  &LSAlsCN .e_mail
*			LNddd       = left( &LSAlsCN .fone,2)
*			LNfone      = left( subs( &LSAlsCN .fone ,3),8)
*------------------------------------------------------------------


		=W_DEFPROC("NOTA.SPR")
		IF NFLerRegistro( &LSAlsCR .Empresa ,  &LSAlsCR .NOTA )

			LNnome	    =  &LSalsNF .nome
			LNrazao	    =  &LSalsNF .nome
			LNendereco 	=  &LSalsNF .endereco
			LNbairro	=  &LSalsNF .bairro
			LNcidade	=  &LSalsNF .cidade
			LNestado	=  &LSalsNF .UF

*****   	LNcep		=  &LSalsNF .cep


            LNcep		=  CHRTRAN(str( &LSalsNF .cep ,8)," ","0")
			
			LNibge      =  STR( &LSalsNF .muni_ibge ,11)
			LNe_mail    =  &LSalsNF .e_mail
			LNddd       = left( &LSalsNF .fone,2)
			LNfone      = left( subs( &LSalsNF .fone ,3),8)

		ELSE
			LNnome	    =  'CONSUMIDOR'
			LNrazao	    =  ''
			LNendereco 	=  ''
			LNbairro	=  ''
			LNcidade	=  ''
			LNestado	=  ''
			LNcep		=  ''
			LNibge      =  ''
			LNe_mail    =  ''
			LNddd       =  ''
			LNfone      =  ''
		ENDIF

	ENDIF


	IF "NAO@INFORMADO" $ UPPER(LNe_mail)
       	LNe_mail    =  ''
    ENDIF



	*-------------------------------------------------------*
    *  INFORMACOES DA PARTICIPANTE
	*-------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_CPFCNPJ="'+;
	             LNcpfcnpjc+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_FISICO_JURIDICO="'+;
	             ''+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_UF="'+;
	             LNestado+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_IM="'+;
	             LNim+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_IE="'+;
	             LNie+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*----------------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = CRLimpaString(LNnome)


	=W_DEFPROC("DOCFISCA.SPR")
  	    LSLinhaXML = ('DFCB_NOME="'+;
	             LSLinhaXML+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*----------------------------------------------------------------*


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = CRLimpaString(LNrazao)


	LSLinhaXML = ('DFCB_RAZAO_SOCIAL="'+;
	             LSLinhaXML +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*----------------------------------------------------------------*


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TP_LOGRADOURO="'+;
	             ''+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_LOGRADOURO="'+;
	             LNendereco+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_NRO_LOGRADOURO="'+;
	             ''+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_COMPL_LOGRADOURO="'+;
	             ''+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_CEP="'+;
	             LNcep+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_IBGE="'+;
	             LNibge+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_MUNI_NOME="'+;
	             LNcidade+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_BAIRRO="'+;
	             LNbairro+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_CODIGO_PAIS="'+;
	             '1058'+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_NOME_PAIS="'+;
	             'BRASIL'+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DDD="'+;
	             LNddd+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_FONE="'+;
	             LNfone+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_E_MAIL="'+;
	             LNe_mail+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

    *--------------------------------------------------------*
    *----- INSTRUCOES
    *--------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_INSTRUCOES_LOCAL_PAGAMENTO="'+;
	             "PAGAVEL EM QUALQUER BANCO ATE O VENCIMENTO"+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




    *--------------------------------------------------------*
    *----- ABERTURA DO CAMPO OBSERVACAO
    *--------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_OBSERVACAO="')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *--------------------------------------------------------*
	LNobs       =  RTRIM( &LSAlsCR .OBS ) + ";"
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha(LNobs)
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

*----->
	IF  &LSAlsCR .DT_PROTEST <> {}
		LSLinhaXML = "Protestar em "+dtoc( &LSAlsCR .DT_PROTEST  )+ ";"
	ELSE
		LSLinhaXML = ""
	ENDIF
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha(LSLinhaXML)
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*----->
	IF  &LSAlsCR .vlr_mora > 0
		LSLinhaXML="Cobrar juros de R$ "
		tmpvalor = ;
		   strtran(str(  &LSAlsCR .vlr_mora ,10,2),".",",")
		tmpvalor = strtran(tmpvalor," ","")
		LSLinhaXML = LSLinhaXML + tmpvalor
		LSLinhaXML = LSLinhaXML + " para pagamento apos ";
		         + DTOC( &LSAlsCR .dt_venc )+ ";"
		
	ELSE
		LSLinhaXML = ";"
	ENDIF
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha(LSLinhaXML)
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*----->
*----->
	LSLinhaXML = ""
	IF  &LSAlsCR .nota > 0
		LSLinhaXML="Boleto Ref. N.F. Nro - "+STR( &LSAlsCR .nota,8)
	ENDIF
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha(LSLinhaXML)
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*----->
	IF  &LSAlsCR .vlr_issrtd  > 0

		LSLinhaXML = "ISS Retido no valor de R$ "
			
		tmpvalor = ;
		   strtran(str(   &LSAlsCR .vlr_issrtd ,10,2),".",",")
		tmpvalor = strtran(tmpvalor," ","")
		LSLinhaXML = LSLinhaXML + tmpvalor
	ELSE
		LSLinhaXML = ""
	ENDIF
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha(LSLinhaXML)
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*----->
	IF   &LSAlsCR .tp_parcela = 7		
		LSLinhaXML = "PARC:"+;
		   ALLTRIM(  &LSAlsCR .CODPARCELA)+;
		" - "+STR(  &LSAlsCR .sequencia,3)+;
	   	" de "+STR(  &LSAlsCR .qtparcelas,3)
	ELSE
		LSLinhaXML = ""
	ENDIF

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha(LSLinhaXML)
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*----->

    *--------------------------------------------------------*
    *----- FECHAMENTO DO CAMPO OBSERVACAO
    *--------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *--------------------------------------------------------*

	*-------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('/>')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC75M           CRModeloRefXML VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   28  º
*       º Variable:            CRModeloRefXML                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      78                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc75m     &&  CRModeloRefXML VALID
#REGION 2
RETURN

FUNCTION CRModeloRefXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\DOCCOBR.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\xmlDCCBR EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE xmlDCCBR


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC75U           CRExpCapaRetLegado VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   29  º
*       º Variable:            CRExpCapaRetLegado                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      79                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc75u     &&  CRExpCapaRetLegado VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRExpCapaRetLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	PRIVATE LSAlsCobr    && Cobranca
	PRIVATE LSAlsAviso   && RetornBC
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()

	SELE COBRANCA
	LSAlsCobr = alias()


	SELE RETORNBC
	LSAlsAviso = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."
	

	LSLinhaXML  = chrtran(STR( &LSAlsEmp .CGC ,14), " ","0")
	LSLinhaXML  = CRtratalinha('<ROW UNEM_CNPJ="'+LSLinhaXML+'"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LFieldTmp   =  &LSAlsEmp .INSCRICAO
	LSLinhaXML  = CRtratalinha('UNEM_IE="'+LFieldTmp+'"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	*----------------------------------------------------------*

	LSLinhaXML  =  "001"
	LSLinhaXML  = CRtratalinha('DFIN_CAIXA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	if &LSAlsAviso .banco = 990
		LSLinhaXML  =  "Registro"
	else
		LSLinhaXML  =  "Retorno"
	endif


	LSLinhaXML  = CRtratalinha('DFIN_TIPO_AVISO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsAviso .AVISO ,8), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_NUMERO_AVISO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsAviso .DTAVISO ), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_DT_AVISO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsAviso .DTPROCESSO ), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_DT_PROCESSAMENTO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsAviso .REG_TOTAL ,3), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_QTDE_ITENS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsAviso .TOT_DOC ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_VLR_DOCUMENTOS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  "Processado"
	LSLinhaXML  = CRtratalinha('DFIN_STATUS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsAviso .REG_PROCES ,3), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_QTDE_ITENS_PROCESSADOS="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsAviso .REG_REJEIT ,3), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_QTDE_ITENS_REJEITADOS="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsAviso .REG_DESCAR ,3), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_QTDE_ITENS_COM_ERRO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC75V           CRAvsExpNro VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   30  º
*       º Variable:            CRAvsExpNro                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      80                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc75v     &&  CRAvsExpNro VALID
#REGION 2
RETURN

FUNCTION CRAvsExpNro
	PARAMETERS ;
	    PrmEmp,PrmBanco,PrmCarteira,PrmVariacao,PrmAviso

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFmvretorn,LFbcretorn,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBanco
	PRIVATE LNCtrItens

    PRIVATE PrmData

	LSalias = ALIAS()

	LFempresa		= NetArq("empresa")
	LFbcretorn		= NetArq("retornbc")
	LFmvretorn		= NetArq("retornmv")
	LFcobranca		= NetArq("cobranca")
	LFBanco 		= NetArq("banco")
	LFduplicat		= NetArq("duplicat")
	LFclienc		= NetArq("clienc")
	LFclintes		= NetArq("clientes")
	
	LFNota   		= NetArq("nota")
	IF (LFEmpresa+LFmvretorn+LFbcretorn+LFduplicat+LFBanco+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHProcBaixa
		RETURN(.f.)
	ENDIF



    SELE Empresa
    SET ORDER TO TAG empresa
    SEEK PrmEmp
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Empresa : "+;
				STR(PrmEmp,3)
      	DO  FCHProcExpAviso
		RETURN(.F.)
	ENDIF


	SELE retornbc
	SET ORDER TO TAG aviso
	SEEK STR(PrmEmp,3)+STR(PrmBanco,3)+;
	   PrmCarteira+PrmVariacao+STR(PrmAviso,8)
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Aviso : "+;
				STR(PrmAviso,8)+" do Banco : "+ STR(PrmBanco,3)
      	DO  FCHProcExpAviso
		RETURN(.F.)
	ENDIF

    IF empty(retornbc.dtaviso)
		DO OBJ_MENS.SPR WITH ;
			"    Data do Aviso Deve ser Preenchida "+;
				STR(LNaviso,8)+" do Banco : "+ STR(LNbanco,3)
      	DO  FCHProcExpAviso
		RETURN(.F.)
	ENDIF

    SELE cobranca
    SET ORDER TO TAG CARTEIRA
    SEEK STR(PrmEmp,3)+STR(PrmBanco,3)+ PrmCarteira+PrmVariacao
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar COBRANCA : ";
		        +"Aviso:"   +STR(PrmAviso,8);
				+" Banco:"	+ STR(PrmBanco,3);
				+" Carteira:"	+ PrmCarteira;
				+" Variacao:"	+ PrmVariacao
      	DO  FCHProcExpAviso
		RETURN(.F.)
	ENDIF



	SELE banco
	SET ORDER TO TAG BANCO
	SEEK PrmBanco
	IF !FOUND()
			DO OBJ_MENS.SPR WITH ;
			"    Nao Foi Possivel Localizar BANCO : ";
		        +"Aviso:"   +STR(PrmAviso,8);
				+" Banco:"	+ STR(PrmBanco,3);
				+" Carteira:"	+ PrmCarteira;
				+" Variacao:"	+ PrmVariacao
		    SELE &LSAlsPeriodo
		    SKIP
		    LOOP
	ENDIF




	*-------------------------------------------------------*
	=CRAvsModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML


    PrmData   =  retornbc.dtaviso

*-----------------------------------------------------*
*   	LSfileXML	= CRAvsNmXMLExpt(PrmEmp, PrmData)
*   	LSfileXML	= "C:\DUPL\TMP\"+LSfileXML
*-----------------------------------------------------*



    *-----------------------------------------------*
    *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
    *-----------------------------------------------*
   	LSfileXML	= CRAvsNmXMLExpt(PrmEmp, PrmData)
   	LSdirtmpXML	= CRPthTmpDup(PrmEmp)

  	LSfileXML	= LSdirtmpXML    +    LSfileXML

    *-----------------------------------------------*


  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return
   	endif

	*---------------------------------------------------*
	=CRAvsIniXML(LSfileXML,LNroIDfileXML)
	*----------------------------------------------------*

    LNCtrItens = 0

	SELECT  retornmv
	SET ORDER TO TAG aviso
	SEEK STR(PrmEmp,3)+STR(PrmBanco,3)+;
	     PrmCarteira+PrmVariacao+STR(PrmAviso,8)


	DO WHILE  !EOF() AND ;
	    PrmAviso     = retornmv.aviso AND ;
		PrmBanco     = retornmv.banco AND ;
		PrmCarteira = retornmv.carteira AND ;
		PrmVariacao = retornmv.Variacao AND ;
		PrmEmp 	    = retornmv.empresa
		
        LNCtrItens = LNCtrItens + 1


        *------------------------------------------------*
        *  aqui chamada geracao do xml do capa do aviso   *------------------------------------------------*
        =CRExpCapaRetLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

        *------------------------------------------------*
        *  aqui chamada geracao do xml do ilocal cobranca
        *------------------------------------------------*
        =CRExpLccbrCapaRetLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

		SELE duplicat
		SET ORDER TO TAG doc
		SEEK STR(PrmEmp,3)+STR(retornmv.duplicata,9)
		IF FOUND()



            *------------------------------------------------*
            *  aqui chamada geracao do xml da duplicata            *------------------------------------------------*
            =CRExpItemRetLegado(LNCtrItens,;
                                LSfileXML,LNroIDfileXML)

            *------------------------------------------------*
            *  aqui chamada geracao do xml das duplicatas            *------------------------------------------------*
            =CRExpDuplRetLegado(LSfileXML,LNroIDfileXML)



            *------------------------------------------------*
            *  aqui chamada geracao do xml do clienc            *------------------------------------------------*
            =CRExpClieDupLegado(LSfileXML,LNroIDfileXML)

			SELE retornmv
		ENDIF
		*------------------------------------------------------*
		SELE retornmv
		SKIP
	ENDDO


	=CRAvsFinML(LSfileXML,LNroIDfileXML)

    =fclose(LNroIDfileXML)


    =CRAvsEnviaXML(PrmEmp,PrmData)

  	
	***************************

	DO  FCHProcExpAviso

	UNLOCK
RETURN(.T.)

PROCEDURE FCHProcExpAviso
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("cobranca" ,LFcobranca)
	=UP_fecha("retornbc" ,LFbcretorn)
	=UP_fecha("banco" ,LFbanco)
	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("nota" ,LFnota)
	=UP_fecha("clientes" ,LFclintes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC76I           CRAvsModeloXML VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   31  º
*       º Variable:            CRAvsModeloXML                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      81                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc76i     &&  CRAvsModeloXML VALID
#REGION 2
RETURN

FUNCTION CRAvsModeloXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\xmlDFin.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\xmlDFin EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE xmlDFin


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC76O           CRAvsIniXML VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   32  º
*       º Variable:            CRAvsIniXML                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      82                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc76o     &&  CRAvsIniXML VALID
#REGION 2
RETURN

FUNCTION CRAvsIniXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML



   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDFin
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND xmlDFin.XML_ORDEM < 9999999999901
	
		LSLinhaXML = xmlDFin.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE xmlDFin
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC76V           CRAvsFinML VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   33  º
*       º Variable:            CRAvsFinML                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      83                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc76v     &&  CRAvsFinML VALID
#REGION 2
RETURN

FUNCTION CRAvsFinML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDFin
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF xmlDFin.XML_ORDEM > 9999999999900
			LSLinhaXML = xmlDFin.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE xmlDFin
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC772           CRExpItemRetLegado VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   34  º
*       º Variable:            CRExpItemRetLegado                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      84                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc772     &&  CRExpItemRetLegado VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRExpItemRetLegado
PARAMETERS 	PrmCtrItem,;
			PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsItem    && RetornMV
	

	AlsANT = ALIAS()


	SELE RETORNMV
	LSAlsItem = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."

	*==========================================================*
	*  ITENS DO DOC FINANCEIRO - IDENTIFICACAO DO TITULO
	*==========================================================*
	LSLinhaXML  = chrtran(STR( PrmCtrItem ,3), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_SEQUENCIA_ITEM="';
	    + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	LSLinhaXML  = chrtran(STR( &LSAlsItem .OCORRENCIA ,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_OCORRENCIA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
          CASE &LSAlsItem .EFEITO = 01
            LSLinhaXML  = "15"      && Registro de Titulo -
          CASE &LSAlsItem .EFEITO = 02
            LSLinhaXML  = "01"      && Baixa Total
          CASE &LSAlsItem .EFEITO = 03
            LSLinhaXML  = "02"      && Baixa Parcial
          CASE &LSAlsItem .EFEITO = 04
            LSLinhaXML  = "11"      && Devolucao
          CASE &LSAlsItem .EFEITO = 05
            LSLinhaXML  = "12"      && Incobravel
          CASE &LSAlsItem .OCORRENCIA = 02
            LSLinhaXML  = "07"      && Registro de Entrada
          CASE &LSAlsItem .OCORRENCIA = 09
            LSLinhaXML  = "16"      && Baixa de Cobranca Banco
          CASE &LSAlsItem .OCORRENCIA = 10
            LSLinhaXML  = "16"      && Baixa de Cobranca Banco
          otherwise
            LSLinhaXML  = "00"      && Nao fazer nada / sem efeito

    ENDCASE
	LSLinhaXML  = CRtratalinha('ITDFIN_EFEITO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
          CASE &LSAlsItem .OCORRENCIA = 02
            LSLinhaXML  = "Registro de Entrada"
          CASE &LSAlsItem .OCORRENCIA = 09
            LSLinhaXML  = "Baixa de Cobranca Banco"
          CASE &LSAlsItem .OCORRENCIA = 10
            LSLinhaXML  = "Baixa de Cobranca Banco"
          CASE &LSAlsItem .EFEITO = 01
            LSLinhaXML  = "Registro de Titulo"
          CASE &LSAlsItem .EFEITO = 02
            LSLinhaXML  = "Baixa Total"
          CASE &LSAlsItem .EFEITO = 03
            LSLinhaXML  = "Baixa Parcial"
          CASE &LSAlsItem .EFEITO = 04
            LSLinhaXML  = "Devolucao"
          CASE &LSAlsItem .EFEITO = 05
            LSLinhaXML  = "Incobravel"
          otherwise
            LSLinhaXML  = "Nao fazer nada"

    ENDCASE
	LSLinhaXML  = CRtratalinha('ITDFIN_EFEITO_DESCRICAO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsItem .MOTIVOS )
	LSLinhaXML  = CRtratalinha('ITDFIN_MOTIVOS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsItem .NUM_NO_BCO )
	LSLinhaXML  = CRtratalinha('ITDFIN_NOSSO_NUMERO="'+;
	          LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .BANCO_COBR ,3), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_BANCO_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .AGENC_COBR ,5), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_AGENCIA_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .DSP_COBR ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_DESPESAS_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .OUT_DESP ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_OUTRAS_DESPESAS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .JUROS ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_JUROS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .IOF ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_IOF="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .ABATIMENTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_ABATIMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .DESCONTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_DESCONTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .MORA ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_MORA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .OUT_CREDT ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_OUTROS_CREDITOS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


    DO CASE
		CASE  &LSAlsItem .ocorrencia = 19 && INSTR. PROTESTO CONFIRMADO
			LSLinhaXML 	=  	"Sim"
		CASE retornmv.ocorrencia = 20 && INSTR. PROTESTO CANCELAD 					
			LSLinhaXML 	=  	"Nao"
		CASE retornmv.ocorrencia = 23 && ENTRADA CARTORIO
			LSLinhaXML 	=  	"Sim"
		CASE retornmv.ocorrencia = 34 && ENTRADA CARTORIO
			LSLinhaXML 	=  	"Sim"
        OTHERWISE
			LSLinhaXML 	=  	"Nao"

    ENDCASE
	LSLinhaXML  = CRtratalinha('ITDFIN_ENVIADA_CARTORIO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsItem .DTOCORRENC ), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_DT_OCORRENCIA="';
	          + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .VLR_PGTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_PGTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
        CASE &LSAlsItem .STATUS = "AP"
         	LSLinhaXML  = "Processar"
        CASE &LSAlsItem .STATUS = "PR"
         	LSLinhaXML  = "Processado"
        CASE &LSAlsItem .STATUS = "RJ"
         	LSLinhaXML  = "Rejeitado"
        otherwise
         	LSLinhaXML  = &LSAlsItem .STATUS
    ENDCASE

	LSLinhaXML  = CRtratalinha('ITDFIN_STATUS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC773           CRExpDuplRetLegado VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   35  º
*       º Variable:            CRExpDuplRetLegado                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      85                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc773     &&  CRExpDuplRetLegado VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRExpDuplRetLegado
PARAMETERS	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsDupl    && Duplicat
	PRIVATE LSAlsEmp    && Duplicat
	

	AlsANT = ALIAS()


	SELE EMPRESA
	LSAlsEmp = alias()


	SELE DUPLICAT
	LSAlsDupl = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."

	*==========================================================*
	*  TITULO - DADOS DO TITULO NAO RELACIONADOS A OCORRENCIA
	*==========================================================*

	LSLinhaXML  = chrtran(STR( &LSAlsDupl .PORTADOR ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_PORTADOR_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .PAGA_EM ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_RECEBEDOR_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .BANCO ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_CEDENTE_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = &LSAlsDupl .CARTEIRA
	LSLinhaXML  = CRtratalinha('TTL_CEDENTE_CARTEIRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = &LSAlsDupl .VARIACAO
	LSLinhaXML  = CRtratalinha('TTL_CEDENTE_VARIACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML = chrtran(ALLTRIM(STR( &LSAlsDupl .DUPLICATA ,15)), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = ALLTRIM(  &LSAlsDupl .CODPARCELA )
	LSLinhaXML  = CRtratalinha('TTL_CODIGO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = ALLTRIM( &LSAlsDupl .NUM_NO_BCO )
	LSLinhaXML  = CRtratalinha('TTL_NOSSO_NUMERO="'+;
	          LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .SEQUENCIA ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_NUMERO_PARCELA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .QTPARCELAS ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_QTDE_PARCELAS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(STR(  &LSAlsDupl .vlrparcini ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_INICIAL_DOCUMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


	LSLinhaXML  = chrtran(STR(  &LSAlsDupl .VLR_DOC ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DOCUMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_EMI ), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_EMISSAO="';
	          + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_VENC ), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_VENCIMENTO="';
	          + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsDupl .COD_BARRA
	LSLinhaXML  = CRtratalinha('TTL_COD_BARRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	PRIVATE  ;
    	    PrmEmpresa;
        	PrmNota
	PRIVATE  ;
    		PrmSerie,;
	 		PrmTipo,;
     		RtnNro_Doc,;
	 		RtnMod_Doc,;
	 		RtnCOD_IDFORN,;
	 		RtnSerie_Doc


    SELE nota
    set order to tag nota

    SEEK STR(  &LSAlsDupl .EMPRESA,3)+STR(  &LSAlsDupl .NOTA,7)
    IF FOUND()

    	    PrmEmpresa      = nota.empresa
        	PrmNota         = nota.nota
			PrmSerie   		= nota.Serie
			PrmTipo    		= nota.Tipo
			RtnNro_Doc 		= 0
		 	RtnMod_Doc		= ""
			RtnCOD_IDFORN	= ""
			RtnSerie_Doc	= ""
	
			=W_DEFPROC("DOCFISCA.SPR")
			=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)
    ELSE
    	    PrmEmpresa      = &LSAlsDupl .empresa
        	PrmNota         = &LSAlsDupl .NOTA
			PrmSerie   		= "001"
			PrmTipo    		= ""
			RtnNro_Doc 		= 0
		 	RtnMod_Doc		= ""
			RtnCOD_IDFORN	= ""
			RtnSerie_Doc	= ""

			=W_DEFPROC("DOCFISCA.SPR")
			=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)

    ENDIF
	*----------------------------------------------------------*
	LSLinhaXML  = RtnMod_Doc
	LSLinhaXML  = CRtratalinha('TTL_DOC_FISCAL_MODELO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( RtnNro_Doc,7), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DOC_FISCAL_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = RtnSerie_Doc
	LSLinhaXML  = CRtratalinha('TTL_DOC_FISCAL_SERIE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .NOTA ,7), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_FATURA_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .ORCAMENTO ,7), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_PEDIDO_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

    IF &LSAlsDupl .BANCO = 900
		LSLinhaXML  = "Pagar"
     ELSE
		LSLinhaXML  = "Receber"
	ENDIF

	LSLinhaXML  = CRtratalinha('TTL_IND_OPERACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    IF &LSAlsDupl .DT_EMI = &LSAlsDupl .DT_VENC
	      LSLinhaXML  = "Entrada"
	ELSE
	      LSLinhaXML  = "Parcelas"
	ENDIF
	LSLinhaXML  = CRtratalinha('TTL_TIPO_PARCELA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsDupl .TP_COBRANC ,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_TP_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
          CASE  &LSAlsDupl .TP_COBRANC = 01
            LSLinhaXML  = "Simples"
          CASE  &LSAlsDupl .TP_COBRANC = 06
            LSLinhaXML  = "Vendor"
          CASE  &LSAlsDupl .TP_COBRANC = 88
            LSLinhaXML  = "Cartorio"
          CASE  &LSAlsDupl .TP_COBRANC = 99
            LSLinhaXML  = "Incobravel"
          OTHERWISE = 01
            LSLinhaXML  = "N/Informado"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_TP_COBRANCA_DESCRICAO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
        CASE &LSAlsDupl .MOEDA = 00
              LSLinhaXML  = "Dinheiro"
        CASE &LSAlsDupl .MOEDA = 01
              LSLinhaXML  = "Dinheiro"
        CASE &LSAlsDupl .MOEDA = 02
              LSLinhaXML  = "Cheque"
        CASE &LSAlsDupl .MOEDA = 03
              LSLinhaXML  = "Duplicata"
        CASE &LSAlsDupl .MOEDA = 04
              LSLinhaXML  = "Cartao Debito"
        CASE &LSAlsDupl .MOEDA = 05
              LSLinhaXML  = "Cartao Credito"
        OTHERWISE
              LSLinhaXML  = "Dinheiro"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_FORMA_PGTO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
        CASE &LSAlsDupl .Natu = 00
              LSLinhaXML  = "Varejo"
        CASE &LSAlsDupl .Natu = 01
              LSLinhaXML  = "Revenda"
        CASE &LSAlsDupl .Natu = 02
              LSLinhaXML  = "Poder Publico"
        CASE &LSAlsDupl .Natu = 03
              LSLinhaXML  = "Frota"
        OTHERWISE
              LSLinhaXML  = "Varejo"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_NATUREZA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

    IF &LSAlsDupl .CONFNROBCO = .t.
        LSLinhaXML  = "Sim"
    else
        LSLinhaXML  = "Nao"
    ENDIF
	LSLinhaXML  = CRtratalinha('TTL_CONFIRMADO_NRO_BANCO="';
	    + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = "Nao"
	LSLinhaXML  = CRtratalinha('TTL_IMPRIMIR_BOLETO="';
	    + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    IF  &LSAlsDupl .TP_COBRANC = 88
			LSLinhaXML 	=  	"Sim"
	ELSE
			LSLinhaXML 	=  	"Nao"
	ENDIF
	LSLinhaXML  = CRtratalinha('TTL_ENVIADA_CARTORIO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_PGTO), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_PGTO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_BAIXA), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_BAIXA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .VLR_ISSRTD ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_ISS_RETIDO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .ABATIMENTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_ABATIMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .DESCONTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DESCONTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .DEVOLUCAO,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DEVOLUCAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .OUT_CREDT ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_OUTROS_CREDITOS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(STR( &LSAlsDupl .DSP_COBR ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DESPESAS_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .OUT_DESP ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_OUTRAS_DESPESAS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .IOF ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_IOF="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    IF EMPTY( &LSAlsDupl .dt_pgto )
        LNdiasAtraso =  0
    ELSE
        LNdiasAtraso =  &LSAlsDupl .dt_pgto -  &LSAlsDupl .dt_venc
    ENDIF

    IF LNdiasAtraso = 2 AND DOW(  &LSAlsDupl .dt_venc ) = 7
       LNdiasAtraso = 0
    ENDIF

    IF LNdiasAtraso = 1 AND DOW(  &LSAlsDupl .dt_venc ) = 1
       LNdiasAtraso = 0
    ENDIF

    IF &LSAlsDupl .dt_pgto <  &LSAlsDupl .dt_venc
       LNdiasAtraso = 0
    ENDIF

	LSLinhaXML  = chrtran(STR( LNdiasAtraso ,15,0), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DIAS_ATRASO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsEmp .multa ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_TAXA_MULTA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsEmp .mora ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_TAXA_MORA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNvlrMultaCalc
    LNvlrMultaCalc = 0

	IF LNdiasAtraso > 0
	    LNvlrMultaCalc =  &LSAlsDupl .vlr_doc * empresa.multa/100
	ENDIF

	LSLinhaXML  = chrtran(STR( LNvlrMultaCalc ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MULTA_CALCULADA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNvlrMoraCalc
    LNvlrMoraCalc = 0

	IF LNdiasAtraso > 0
	    LNvlrMoraCalc =  ;
	    &LSAlsDupl .vlr_doc * empresa.mora * LNdiasAtraso /100
	ENDIF
	

	LSLinhaXML  = chrtran(STR( LNvlrMoraCalc ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MORA_CALCULADA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNvlrMulta

    LNvlrMulta = 0
	LSLinhaXML  = chrtran(STR( LNvlrMulta ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MULTA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .MORA ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MORA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .JUROS ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_JUROS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    PRIVATE LNVlrDevido
    IF EMPTY( &LSAlsDupl .dt_pgto )
        LNVlrDevido =  0
    ELSE
        LNVlrDevido =   &LSAlsDupl .VLR_DOC;
                  + LNvlrMultaCalc;
                  + LNvlrMoraCalc;
                  - &LSAlsDupl .DEVOLUCAO;
                  - &LSAlsDupl .OUT_CREDT;
                  - &LSAlsDupl .ABATIMENTO;
                  - &LSAlsDupl .DESCONTO;
                  + &LSAlsDupl .out_desp
    ENDIF

	LSLinhaXML  = chrtran(STR( LNVlrDevido ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DEVIDO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .VLR_PGTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_PGTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNVlrDifDevido
    IF EMPTY( &LSAlsDupl .dt_pgto )
        LNVlrDifDevido =  0
    ELSE
        LNVlrDifDevido = &LSAlsDupl .VLR_PGTO - LNVlrDevido
    ENDIF

	LSLinhaXML  = chrtran(STR( LNVlrDevido ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DIF_PAGO_DEVIDO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .PARC_PGTO,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_PGTO_PARCIAL="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsDupl .OBS
	LSLinhaXML  = CRtratalinha('TTL_OBSERVACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*


	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC787           CRAvsNmXMLExpt VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   36  º
*       º Variable:            CRAvsNmXMLExpt                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      86                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc787     &&  CRAvsNmXMLExpt VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRAvsNmXMLExpt
PARAMETER PrmEmpresa,PrmData

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml

    PRIVATE LSnro	
	*----------------------------------------------------------*

    LSnro = SUBS(DTOS(PrmData),6)
    LSnro = CHRTRAN(LSnro," ","0")
	LSnomeArqXml = "AV"+LSnro

    LSnro = STR(PrmEmpresa,3)
    LSnro = CHRTRAN(LSnro," ","0")

  	LSfileXML	= LSnomeArqXml+LSnro+".XML"

	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC78F           CRtratalinha VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   37  º
*       º Variable:            CRtratalinha                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      87                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc78f     &&  CRtratalinha VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRtratalinha
PARAMETERS LSLINHA

	LSLINHA = UPPER(LSLINHA)
	LSLINHA = RTRIM(LSLINHA)


    LSLINHA =   strtran(LSLINHA,'&AMP;','&amp;')


RETURN(LSLINHA)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC78M           CRLimpaString VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   38  º
*       º Variable:            CRLimpaString                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      88                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc78m     &&  CRLimpaString VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRLimpaString
PARAMETERS PrmString
	*-------------------------------------------------------*
	PRIVATE LSstatus
	LSstatus = ""
	*-------------------------------------------------------*
	*PRMString = UPPER(PRMString)

	PRMString = chrtran(PRMString,"€","C")       && 01
	PRMString = chrtran(PRMString,"‡","c")       && 02
	PRMString = chrtran(PRMString,"¦","-")       && 04
	PRMString = chrtran(PRMString,"§","-")       && 05
	PRMString = chrtran(PRMString,"°",'')        && 06
	PRMString = chrtran(PRMString,"º",'')        && 07
	PRMString = chrtran(PRMString,"",'E')       && 08
	PRMString = chrtran(PRMString,"‚",'e')       && 09
	PRMString = chrtran(PRMString,"Ç",'A')       && 10
	PRMString = chrtran(PRMString,"Æ",'a')       && 11
	PRMString = chrtran(PRMString,"ø",'')        && 12
	PRMString = chrtran(PRMString,chr(0),'')     && 13
	PRMString = chrtran(PRMString,'"','')        && 14
	PRMString = chrtran(PRMString,'Ã','A')        && 14
	PRMString = chrtran(PRMString,'>',' ')        && 14
	PRMString = chrtran(PRMString,'<',' ')        && 14

	PRMString = strtran(PRMString,"&","&amp;")       && 03


RETURN(PrmString)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC78S           CR_Fputs VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   39  º
*       º Variable:            CR_Fputs                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      89                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc78s     &&  CR_Fputs VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CR_Fputs
PARAMETERS ;
			PrmNroIDfileXML,;
			PrmString,;
			PrmLEN

	PRIVATE LFretorno

	PrmString = CR_FputsLimpa(PrmString)

	LFretorno =fPuts(PrmNroIDfileXML,PrmString,LEN(PrmString))

RETURN(LFretorno)

*----------------------------------------------------------*



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC78Y           CRExpLccbrCapaRetLegado VALID      º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   40  º
*       º Variable:            CRExpLccbrCapaRetLegado            º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      90                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc78y     &&  CRExpLccbrCapaRetLegado VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRExpLccbrCapaRetLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	PRIVATE LSAlsCobr    && Cobranca
	PRIVATE LSAlsAviso   && RetornBC
	PRIVATE LSAlsBanco   && Banco
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()

	SELE COBRANCA
	LSAlsCobr = alias()



	SELE BANCO
	LSAlsBanco = alias()



	SELE RETORNMV
	LSAlsAviso = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	SET POINT TO ","
	SET SEPARATOR  TO "."


	*==========================================================*
	*  AVISO BANCARIO - IDENTIFICACAO DO AVISO
	*==========================================================*
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .Banco ,3), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia )
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_AGENCIA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia_DG )
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_AGENCIA_DV="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_AVISO_CONTA_CORRENTE="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta_DG )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_AVISO_CONTA_CORRENTE_DV="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Carteira )
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_CARTEIRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Variacao )
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_VARIACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .Banco_Nome
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_NOME_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	IF ALLTRIM( &LSAlsBanco .Tp_Lancame) = "CAIXA"
    	LSLinhaXML  =  "Caixa"
	ELSE
    	LSLinhaXML  =  "Banco"
	ENDIF
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_TP_LANCAMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQINI ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_BOLETO_INICIAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQATU ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_BOLETO_ATUAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQFIM ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_BOLETO_FINAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CODCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_CODIGO_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .DIGCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_DV_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CONVENIO
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_CONVENIO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_ESCRIT
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_COD_ESCRITURAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_EMPRES
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_COD_EMPRESA="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	IF  ALLTRIM( &LSAlsCobr .TP_INSCR )  $ "01/02/03/98/99/"
    	LSLinhaXML  =  &LSAlsCobr .TP_INSCR
    ELSE
   	    LSLinhaXML  =  "98"  && 98 NAO TEM
    ENDIF

	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_TP_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .NUM_INSCR
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .GRAVACAO
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_GRAVACAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .IDENT_SIS
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_IDENT_SIS="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_A
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_INSTRUCAO_A="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_B
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_INSTRUCAO_B="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC79B           CRExpClieDupLegado VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   41  º
*       º Variable:            CRExpClieDupLegado                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      91                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc79b     &&  CRExpClieDupLegado VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRExpClieDupLegado
PARAMETERS 		PrmFileXML,;
				PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsDupl    && Duplicat
	

	AlsANT = ALIAS()


	SELE DUPLICAT
	LSAlsDupl = alias()


	SELE CLIENTES
	LSAlsClt = alias()

	SELE CLIENC
	LSAlsClie = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."



    SELE Clienc
    SET ORDER TO TAG CLIENTE

	set near on
    SEEK &LSAlsDupl .cliente + 1
    SKIP -1
	SET NEAR OFF


    IF BOF() OR &LSAlsDupl .cliente <> &LSAlsClie .cliente

       sele clientes
       set order to tag cliente
       SEEK &LSAlsDupl .cliente
       IF FOUND()
	       m.cliente  =   STR( &LSAlsClt .cliente,14)
	       m.nome     =   &LSAlsDupl .nome
	       m.razao    =   &LSAlsClt .nome
	       m.uf       =   &LSAlsClt .estado
	       m.ie       =   &LSAlsClt .inscricao
	       m.im       =   &LSAlsClt .im_tomador
	       m.logr     =   &LSAlsClt .endereco
	       m.nro_logr =   &LSAlsClt .nro_logr
	       m.compllogr=   ""
	       m.cep      =   &LSAlsClt .cep
	       m.muni_ibge=   LEFT(ALLTRIM( STR( &LSAlsClt .muni_ibge ,11)),7)
	       m.muni_nome=   &LSAlsClt .cidade
	       m.bairro   =   &LSAlsClt .bairro
	       m.codpais  =   ""

           m.pais     =   "Brasil"
	       m.ddd      =   ""
	       m.fone     =   &LSAlsClt .fone
	       m.email    =   &LSAlsClt .e_mail


       ELSE
	       m.cliente  =   STR( &LSAlsDupl .cliente,14)
	       m.nome     =   &LSAlsDupl .nome
	       m.razao    =   &LSAlsDupl .nome
	       m.uf       =   ""
	       m.ie       =   ""
	       m.im       =   ""
	       m.tp_logr  =   ""
	       m.logr     =   ""
	       m.nro_logr =   ""
	       m.compllogr=   ""
	       m.cep      =   ""
	       m.muni_ibge=   ""
	       m.muni_nome=   ""
	       m.bairro   =   ""
	       m.codpais  =   ""
	       m.pais     =   "Brasil"
	       m.ddd      =   ""
	       m.fone     =   ""
	       m.email    =   ""
	   endif
    ELSE
       m.cliente  =   STR( &LSAlsClie .cliente,14)
       m.nome     =   &LSAlsDupl .nome
       m.razao    =   &LSAlsClie .nome
       m.uf       =   &LSAlsClie .estado
       m.ie       =   &LSAlsClie .inscricao
       m.im       =   &LSAlsClie .im_tomador
       m.logr     =   &LSAlsClie .endereco
       m.nro_logr =   &LSAlsClie .nro_logr
       m.compllogr=   ""
       m.cep      =   &LSAlsClie .cep
       m.muni_ibge=   LEFT(ALLTRIM( STR( &LSAlsClie .muni_ibge ,11)),7)
       m.muni_nome=   &LSAlsClie .cidade
       m.bairro   =   &LSAlsClie .bairro
       m.codpais  =   ""

       if empty( &LSAlsClie .pais )
          m.pais     =   "Brasil"
       ELSE
          m.pais     =   &LSAlsClie .pais
       endif
       m.ddd      =   &LSAlsClie .ddd
       m.fone     =   &LSAlsClie .fone
       m.email    =   &LSAlsClie .e_mail
    ENDIF

	IF "NAO@INFORMADO" $ UPPER(m.email)
       	m.email    =  ''
    ENDIF


	*==========================================================*
	*  CADASTRO
	*==========================================================*
	LSLinhaXML  = m.cliente
	LSLinhaXML  = CRtratalinha('CDSTR_CPFCNPJ="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = ""
	LSLinhaXML  = CRtratalinha('CDSTR_FISICO_JURIDICO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.nome
	LSLinhaXML  = CRLimpaString('CDSTR_NOME="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.nome
	LSLinhaXML  = CRLimpaString('CDSTR_RAZAO_SOCIAL="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.uf
	LSLinhaXML  = CRtratalinha('CDSTR_UF="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.ie
	LSLinhaXML  = CRtratalinha('CDSTR_IE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.im
	LSLinhaXML  = CRtratalinha('CDSTR_IM="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = ""
	LSLinhaXML  = CRtratalinha('CDSTR_TP_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.logr
	LSLinhaXML  = CRtratalinha('CDSTR_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.nro_logr
	LSLinhaXML  = CRtratalinha('CDSTR_NRO_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.compllogr
	LSLinhaXML  = CRtratalinha('CDSTR_COMPL_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.cep
	LSLinhaXML  = CRtratalinha('CDSTR_CEP="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.muni_ibge
	LSLinhaXML  = CRtratalinha('CDSTR_MUNI_IBGE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.muni_nome
	LSLinhaXML  = CRtratalinha('CDSTR_MUNI_NOME="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.bairro
	LSLinhaXML  = CRtratalinha('CDSTR_BAIRRO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.codpais
	LSLinhaXML  = CRtratalinha('CDSTR_CODIGO_PAIS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.pais
	LSLinhaXML  = CRtratalinha('CDSTR_NOME_PAIS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.ddd
	LSLinhaXML  = CRtratalinha('CDSTR_DDD="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.fone
	LSLinhaXML  = CRtratalinha('CDSTR_FONE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.email
	LSLinhaXML  = CRtratalinha('CDSTR_E_MAIL="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  ""
	LSLinhaXML  = CRtratalinha('CDSTR_OBSERVACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  ""
	LSLinhaXML  = CRtratalinha('/>')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC79P           CRAvsEnviaXML VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   42  º
*       º Variable:            CRAvsEnviaXML                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      92                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc79p     &&  CRAvsEnviaXML VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRAvsEnviaXML
PARAMETERS PrmEmp,PrmData


   	PRIVATE LSfileXML
   	PRIVATE LSPathOrigem,LSNomeOrigem,LSfileOrigem
   	PRIVATE LSPathDestino,LSNomeDestino,LSfileDestinoOrigem
   	
	*-----------------------------------------------*
	=W_DEFPROC("DUPLICAT.SPR")
   	LSNomeOrigem	= CRAvsNmXMLExpt(PrmEmp,PrmData)

*	LSPathOrigem    = "C:\Dupl\TMP\"
	LSPathOrigem    = CRPthTmpDup(PrmEmp)

    LSfileOrigem    = LSPathOrigem + LSNomeOrigem

	IF !FILE(LSfileOrigem)
	   RETURN(.F.)
	ENDIF
	
	
	
	*-----------------------------------------------*

   	LSNomeDestino   = LSNomeOrigem

*---------------------------------------------------------*
*	=W_DEFPROC("PARAMETR.SPR")
*	LSPathDestino   = PMGetFieldValue(PrmEmp,"DIR_DFIN")
*
*   IF TYPE("LSPathDestino") <> "C" or EMPTY(LSPathDestino)
*         LSPathDestino = "C:\Dupl\"
*	else
*         LSPathDestino = ALLTRIM(LSPathDestino)
*   ENDIF
*---------------------------------------------------------*

	*--------------------------------------------------*
    LSPathDestino =CRPthDstnDupDIR_DEFIN(PrmEmp)


    LSfileDestino   = LSPathDestino + LSNomeDestino

	*-----------------------------------------------*
			
	=CRCOPYLongo(LSFileOrigem,LSFileDestino)


	IF FILE(LSFileOrigem)
		DELETE FILE &LSFileOrigem
	ENDIF

	*--------------------------------------------------*



RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC79V           CRDuplNroExpDuplicata VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   44  º
*       º Variable:            CRDuplNroExpDuplicata              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      93                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc79v     &&  CRDuplNroExpDuplicata VALID
#REGION 2
RETURN

FUNCTION CRDuplNroExpDuplicata
	PARAMETERS ;
	    PrmEmp,PrmDuplicata,PrmMotivo

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBanco,LFclintes
	PRIVATE LNCtrItens

	LSalias = ALIAS()

	LFempresa		= NetArq("empresa")
	LFcobranca		= NetArq("cobranca")
	LFduplicat		= NetArq("duplicat")
	LFbanco   		= NetArq("banco")
	LFclienc		= NetArq("clienc")
	LFclintes		= NetArq("clientes")
	LFNota   		= NetArq("nota")
	IF (LFEmpresa+LFduplicat+LFBanco+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF





    SELE Empresa
    SET ORDER TO TAG empresa
    SEEK PrmEmp
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Empresa : "+;
				STR(PrmEmp,3)
      	DO  FCHExpDuplicata
		RETURN(.F.)
	ENDIF




	*-------------------------------------------------------*
	=CRDuplModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML

*   	LSfileXML	= CRNmDuplXMLExpt(PrmEmp,PrmDUPLICATA)
*   	LSfileXML	= "C:\DUPL\TMP\"+LSfileXML

    *-----------------------------------------------*
    *   DEFINE PATH E NOME DE ARQUIVO REMPORARIO
    *-----------------------------------------------*
  	LSfileXML	= CRNmDuplXMLExpt(PrmEmp,PrmDUPLICATA)
   	LSdirtmpXML	= CRPthTmpDup(PrmEmp)


   	LSfileXML	= LSdirtmpXML    +    LSfileXML

    *-----------------------------------------------*




  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      	DO  FCHExpDuplicata
      return
   	endif

	*---------------------------------------------------*
	=CRDuplIniXML(LSfileXML,LNroIDfileXML)
	*----------------------------------------------------*

	SELE duplicat
	SET ORDER TO TAG DOC
	SEEK STR(PrmEmp,3)+STR(PrmDUPLICATA,9)
    SET NEAR OFF

	DO WHILE  !EOF() AND ;
	    PrmDuplicata = duplicat.duplicata;
		PrmEmp 	    = duplicat.empresa
		

        *------------------------------------------------*
        =CRDuplMotivoLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplIedentLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplCedenteLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplPortadorLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplRecebedorLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplClieLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

		*------------------------------------------------------*
		SELE DUPLICAT
		SKIP
	ENDDO
	=CRDuplFinXML(LSfileXML,LNroIDfileXML)

    =fclose(LNroIDfileXML)

*----------------------------------------------------
*    =CRDupEnviaXML(PrmEmp,Date())
*----------------------------------------------------

    =CRDupEnviaXML(PrmEmp,PrmDUPLICATA)
  	
	***************************

  	DO  FCHExpDuplicata

	UNLOCK
RETURN(.T.)

PROCEDURE FCHExpDuplicata
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("cobranca" ,LFcobranca)
	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("banco" ,LFbanco)
	=UP_fecha("nota" ,LFnota)
	=UP_fecha("clientes" ,LFclintes)

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7A5           CRDuplModeloXML VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   45  º
*       º Variable:            CRDuplModeloXML                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      94                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7a5     &&  CRDuplModeloXML VALID
#REGION 2
RETURN

FUNCTION CRDuplModeloXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\xmlDupl.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\xmlDupl EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE xmlDupl


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7AC           CRDuplIniXML VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   46  º
*       º Variable:            CRDuplIniXML                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      95                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7ac     &&  CRDuplIniXML VALID
#REGION 2
RETURN

FUNCTION CRDuplIniXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML



   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDupl
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND xmlDupl.XML_ORDEM < 9999999999901
	
		LSLinhaXML = xmlDupl.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE xmlDupl
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7AH           CRDuplIedentLegado VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   47  º
*       º Variable:            CRDuplIedentLegado                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      96                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7ah     &&  CRDuplIedentLegado VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplIedentLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."
	

	LSLinhaXML  = chrtran(STR( &LSAlsEmp .CGC ,14), " ","0")
	LSLinhaXML  = CRtratalinha('UNEM_CNPJ="'+LSLinhaXML+'"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LFieldTmp   =  &LSAlsEmp .INSCRICAO
	LSLinhaXML  = CRtratalinha('UNEM_IE="'+LFieldTmp+'"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7AI           CRDuplCedenteLegado VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   48  º
*       º Variable:            CRDuplCedenteLegado                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      97                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7ai     &&  CRDuplCedenteLegado VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplCedenteLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	PRIVATE LSAlsCobr    && Cobranca
	PRIVATE LSAlsDupl    && Duplicat
	PRIVATE LSAlsBanco   && Banco
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()

	SELE DUPLICAT
	LSAlsDupl = alias()


	SELE Banco
	LSAlsBanco = alias()

    SET ORDE TO TAG BANCO
    SEEK  &LSAlsDupl .BANCO


	SELE COBRANCA
	LSAlsCobr = alias()

    SET ORDE TO TAG CARTEIRA
    SEEK STR( &LSAlsDupl .empresa,3);
        +STR( &LSAlsDupl .BANCO,3);
        +  &LSAlsDupl .CARTEIRA;
        +  &LSAlsDupl .VARIACAO

    IF !FOUND()
        SET ORDE TO TAG COBRANCA
        SEEK STR( &LSAlsDupl .empresa,3);
             +STR( &LSAlsDupl .BANCO,3)
       IF !FOUND()
          RETURN
       ENDIF
    ENDIF



	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	SET POINT TO ","
	SET SEPARATOR  TO "."




	*==========================================================*
	*  CEDENTE BANCARIO - IDENTIFICACAO DO AVISO
	*==========================================================*
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .Banco ,3), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia )
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_AGENCIA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia_DG )
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_AGENCIA_DV="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_CEDENTE_CONTA_CORRENTE="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta_DG )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_CEDENTE_CONTA_CORRENTE_DV="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Carteira )
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_CARTEIRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Variacao )
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_VARIACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .Banco_Nome
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_NOME_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
	IF ALLTRIM( &LSAlsBanco .Tp_Lancame) = "CAIXA"
    	LSLinhaXML  =  "Caixa"
	ELSE
    	LSLinhaXML  =  "Banco"
	ENDIF
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_TP_LANCAMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQINI ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_BOLETO_INICIAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQATU ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_BOLETO_ATUAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQFIM ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_BOLETO_FINAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CODCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_CODIGO_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .DIGCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_DV_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CONVENIO
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_CONVENIO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_ESCRIT
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_COD_ESCRITURAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_EMPRES
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_COD_EMPRESA="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	IF  ALLTRIM( &LSAlsCobr .TP_INSCR )  $ "01/02/03/98/99/"
    	LSLinhaXML  =  &LSAlsCobr .TP_INSCR
    ELSE
   	    LSLinhaXML  =  "98"  && 98 NAO TEM
    ENDIF


	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_TP_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .NUM_INSCR
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .GRAVACAO
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_GRAVACAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .IDENT_SIS
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_IDENT_SIS="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_A
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_INSTRUCAO_A="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_B
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_INSTRUCAO_B="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7B3           CRDuplPortadorLegado VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   49  º
*       º Variable:            CRDuplPortadorLegado               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      98                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7b3     &&  CRDuplPortadorLegado VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplPortadorLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	PRIVATE LSAlsCobr    && Cobranca
	PRIVATE LSAlsDupl    && Duplicat
	PRIVATE LSAlsBanco   && Banco
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()

	SELE DUPLICAT
	LSAlsDupl = alias()


	SELE Banco
	LSAlsBanco = alias()

    SET ORDE TO TAG BANCO
    SEEK  &LSAlsDupl .BANCO



	SELE COBRANCA
	LSAlsCobr = alias()

    SET ORDE TO TAG CARTEIRA
    SEEK STR( &LSAlsDupl .empresa,3);
        +STR( &LSAlsDupl .PORTADOR,3);
        +  &LSAlsDupl .CARTEIRA;
        +  &LSAlsDupl .VARIACAO

    IF !FOUND()
        SET ORDE TO TAG COBRANCA
        SEEK STR( &LSAlsDupl .empresa,3);
             +STR( &LSAlsDupl .PORTADOR,3)
       IF !FOUND()
          RETURN
       ENDIF
    ENDIF



	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	SET POINT TO ","
	SET SEPARATOR  TO "."




	*==========================================================*
	*  CEDENTE BANCARIO - IDENTIFICACAO DO AVISO
	*==========================================================*
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .Banco ,3), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia )
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_AGENCIA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia_DG )
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_AGENCIA_DV="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_PRTD_CONTA_CORRENTE="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta_DG )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_PRTD_CONTA_CORRENTE_DV="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Carteira )
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_CARTEIRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Variacao )
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_VARIACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .Banco_Nome
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_NOME_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	IF ALLTRIM( &LSAlsBanco .Tp_Lancame) = "CAIXA"
    	LSLinhaXML  =  "Caixa"
	ELSE
    	LSLinhaXML  =  "Banco"
	ENDIF
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_TP_LANCAMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*


	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQINI ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_BOLETO_INICIAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQATU ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_BOLETO_ATUAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQFIM ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_BOLETO_FINAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CODCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_CODIGO_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .DIGCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_DV_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CONVENIO
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_CONVENIO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_ESCRIT
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_COD_ESCRITURAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_EMPRES
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_COD_EMPRESA="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	IF  ALLTRIM( &LSAlsCobr .TP_INSCR )  $ "01/02/03/98/99/"
    	LSLinhaXML  =  &LSAlsCobr .TP_INSCR
    ELSE
   	    LSLinhaXML  =  "98"  && 98 NAO TEM
    ENDIF


	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_TP_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .NUM_INSCR
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .GRAVACAO
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_GRAVACAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .IDENT_SIS
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_IDENT_SIS="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_A
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_INSTRUCAO_A="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_B
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_INSTRUCAO_B="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7BI           CRDuplRecebedorLegado VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   50  º
*       º Variable:            CRDuplRecebedorLegado              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      99                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7bi     &&  CRDuplRecebedorLegado VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplRecebedorLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	PRIVATE LSAlsCobr    && Cobranca
	PRIVATE LSAlsDupl    && Duplicat
	PRIVATE LSAlsBanco   && Banco
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()

	SELE DUPLICAT
	LSAlsDupl = alias()


	SELE Banco
	LSAlsBanco = alias()

    SET ORDE TO TAG BANCO
    SEEK  &LSAlsDupl .BANCO


	SELE COBRANCA
	LSAlsCobr = alias()

    SET ORDE TO TAG CARTEIRA
    SEEK STR( &LSAlsDupl .empresa,3);
        +STR( &LSAlsDupl .PAGA_EM,3);
        +  &LSAlsDupl .CARTEIRA;
        +  &LSAlsDupl .VARIACAO

    IF !FOUND()
        SET ORDE TO TAG COBRANCA
        SEEK STR( &LSAlsDupl .empresa,3);
             +STR( &LSAlsDupl .PAGA_EM,3)
       IF !FOUND()
          RETURN
       ENDIF
    ENDIF



	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	SET POINT TO ","
	SET SEPARATOR  TO "."




	*==========================================================*
	*  CEDENTE BANCARIO - IDENTIFICACAO DO AVISO
	*==========================================================*
	*----------------------------------------------------------*
    if empty( &LSAlsDupl .dt_pgto )
  	     LSLinhaXML  = ""
    else
     	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .Banco ,3), " ","0")
    endif
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia )
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_AGENCIA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia_DG )
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_AGENCIA_DV="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_RCBD_CONTA_CORRENTE="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta_DG )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_RCBD_CONTA_CORRENTE_DV="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Carteira )
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_CARTEIRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Variacao )
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_VARIACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .Banco_Nome
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_NOME_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
	IF ALLTRIM( &LSAlsBanco .Tp_Lancame) = "CAIXA"
    	LSLinhaXML  =  "Caixa"
	ELSE
    	LSLinhaXML  =  "Banco"
	ENDIF
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_TP_LANCAMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQINI ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_BOLETO_INICIAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQATU ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_BOLETO_ATUAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQFIM ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_BOLETO_FINAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CODCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_CODIGO_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .DIGCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_DV_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CONVENIO
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_CONVENIO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_ESCRIT
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_COD_ESCRITURAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_EMPRES
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_COD_EMPRESA="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	IF  ALLTRIM( &LSAlsCobr .TP_INSCR )  $ "01/02/03/98/99/"
    	LSLinhaXML  =  &LSAlsCobr .TP_INSCR
    ELSE
   	    LSLinhaXML  =  "98"  && 98 NAO TEM
    ENDIF
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_TP_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .NUM_INSCR
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .GRAVACAO
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_GRAVACAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .IDENT_SIS
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_IDENT_SIS="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_A
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_INSTRUCAO_A="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_B
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_INSTRUCAO_B="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7BZ           CRDuplLegado VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   51  º
*       º Variable:            CRDuplLegado                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      100                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7bz     &&  CRDuplLegado VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplLegado
PARAMETERS	PrmFileXML,;
			PrmNroIDfileXML,;
			PrmMotivo




	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsDupl    && Duplicat

    PRIVATE LSAlsEmp	

	AlsANT = ALIAS()


    SELE EMPRESA
	LSAlsEmp = alias()


	SELE DUPLICAT
	LSAlsDupl = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."

	*==========================================================*
	*  TITULO - DADOS DO TITULO NAO RELACIONADOS A OCORRENCIA
	*==========================================================*

	*----------------------------------------------------------*
	LSLinhaXML = chrtran(ALLTRIM(STR( &LSAlsDupl .DUPLICATA ,15)), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = ALLTRIM(  &LSAlsDupl .CODPARCELA )
	LSLinhaXML  = CRtratalinha('TTL_CODIGO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = ALLTRIM( &LSAlsDupl .NUM_NO_BCO )
	LSLinhaXML  = CRtratalinha('TTL_NOSSO_NUMERO="'+;
	          LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .SEQUENCIA ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_NUMERO_PARCELA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .QTPARCELAS ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_QTDE_PARCELAS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(STR(  &LSAlsDupl .vlrparcini ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_INICIAL_DOCUMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(STR(  &LSAlsDupl .VLR_DOC ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DOCUMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_EMI ), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_EMISSAO="';
	          + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_VENC ), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_VENCIMENTO="';
	          + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsDupl .COD_BARRA
	LSLinhaXML  = CRtratalinha('TTL_COD_BARRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	PRIVATE  ;
    	    PrmEmpresa;
        	PrmNota
	PRIVATE  ;
    		PrmSerie,;
	 		PrmTipo,;
     		RtnNro_Doc,;
	 		RtnMod_Doc,;
	 		RtnCOD_IDFORN,;
	 		RtnSerie_Doc


    SELE nota
    set order to tag nota

    SEEK STR(  &LSAlsDupl .EMPRESA,3)+STR(  &LSAlsDupl .NOTA,7)
    IF FOUND()

    	    PrmEmpresa      = nota.empresa
        	PrmNota         = nota.nota
			PrmSerie   		= nota.Serie
			PrmTipo    		= nota.Tipo
			RtnNro_Doc 		= 0
		 	RtnMod_Doc		= ""
			RtnCOD_IDFORN	= ""
			RtnSerie_Doc	= ""
	
			=W_DEFPROC("DOCFISCA.SPR")
			=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)
    ELSE
    	    PrmEmpresa      = &LSAlsDupl .empresa
        	PrmNota         = &LSAlsDupl .NOTA
			PrmSerie   		= "001"
			PrmTipo    		= ""
			RtnNro_Doc 		= 0
		 	RtnMod_Doc		= ""
			RtnCOD_IDFORN	= ""
			RtnSerie_Doc	= ""

			=W_DEFPROC("DOCFISCA.SPR")
			=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)

    ENDIF
	*----------------------------------------------------------*
	LSLinhaXML  = RtnMod_Doc
	LSLinhaXML  = CRtratalinha('TTL_DOC_FISCAL_MODELO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( RtnNro_Doc,7), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DOC_FISCAL_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = RtnSerie_Doc
	LSLinhaXML  = CRtratalinha('TTL_DOC_FISCAL_SERIE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .NOTA ,7), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_FATURA_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .ORCAMENTO ,7), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_PEDIDO_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    IF &LSAlsDupl .BANCO = 900
		LSLinhaXML  = "Pagar"
     ELSE
		LSLinhaXML  = "Receber"
	ENDIF

	LSLinhaXML  = CRtratalinha('TTL_IND_OPERACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    IF &LSAlsDupl .DT_EMI = &LSAlsDupl .DT_VENC
	      LSLinhaXML  = "Entrada"
	ELSE
	      LSLinhaXML  = "Parcelas"
	ENDIF
	LSLinhaXML  = CRtratalinha('TTL_TIPO_PARCELA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsDupl .TP_COBRANC ,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_TP_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    LSLinhaXML  = ""

    DO CASE
          CASE  &LSAlsDupl .TP_COBRANC = 01
            LSLinhaXML  = "Simples"
          CASE  &LSAlsDupl .TP_COBRANC = 06
            LSLinhaXML  = "Vendor"
          CASE  &LSAlsDupl .TP_COBRANC = 88
            LSLinhaXML  = "Cartorio"
          CASE  &LSAlsDupl .TP_COBRANC = 99
            LSLinhaXML  = "Incobravel"
          OTHERWISE
            LSLinhaXML  = "Simples"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_TP_COBRANCA_DESCRICAO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
        CASE &LSAlsDupl .MOEDA = 00
              LSLinhaXML  = "Dinheiro"
        CASE &LSAlsDupl .MOEDA = 01
              LSLinhaXML  = "Dinheiro"
        CASE &LSAlsDupl .MOEDA = 02
              LSLinhaXML  = "Cheque"
        CASE &LSAlsDupl .MOEDA = 03
              LSLinhaXML  = "Duplicata"
        CASE &LSAlsDupl .MOEDA = 04
              LSLinhaXML  = "Cartao Debito"
        CASE &LSAlsDupl .MOEDA = 05
              LSLinhaXML  = "Cartao Credito"
        OTHERWISE
              LSLinhaXML  = "Dinheiro"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_FORMA_PGTO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
        CASE &LSAlsDupl .Natu = 00
              LSLinhaXML  = "Varejo"
        CASE &LSAlsDupl .Natu = 01
              LSLinhaXML  = "Revenda"
        CASE &LSAlsDupl .Natu = 02
              LSLinhaXML  = "Poder Publico"
        CASE &LSAlsDupl .Natu = 03
              LSLinhaXML  = "Frota"
        OTHERWISE
              LSLinhaXML  = "Varejo"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_NATUREZA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

    IF &LSAlsDupl .CONFNROBCO = .t.
        LSLinhaXML  = "Sim"
    else
        LSLinhaXML  = "Nao"
    ENDIF
	LSLinhaXML  = CRtratalinha('TTL_CONFIRMADO_NRO_BANCO="';
	    + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	IF TYPE("PrmMotivo") <> "C"
        PrmMotivo = "REGISTRAR"
    ENDIF

	DO CASE
	   CASE ("IMPRIMIR" $ PrmMotivo)
            LSLinhaXML  = "Sim"
	   CASE ("CANCELAR" $ PrmMotivo)
            LSLinhaXML  = "Nao"
	   CASE ("EXPORTAR" $ PrmMotivo)
            LSLinhaXML  = "Nao"
       OTHERWISE     && "REGISTRAR"
        	LSLinhaXML  = "Sim"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_IMPRIMIR_BOLETO="';
	    + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    IF  &LSAlsDupl .TP_COBRANC = 88
			LSLinhaXML 	=  	"Sim"
	ELSE
			LSLinhaXML 	=  	"Nao"
	ENDIF
	LSLinhaXML  = CRtratalinha('TTL_ENVIADA_CARTORIO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_PGTO), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_PGTO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_BAIXA), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_BAIXA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .VLR_ISSRTD ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_ISS_RETIDO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .ABATIMENTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_ABATIMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .DESCONTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DESCONTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .DEVOLUCAO,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DEVOLUCAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .OUT_CREDT ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_OUTROS_CREDITOS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(STR( &LSAlsDupl .DSP_COBR ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DESPESAS_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .OUT_DESP ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_OUTRAS_DESPESAS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .IOF ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_IOF="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	*----------------------------------------------------------*
    IF EMPTY( &LSAlsDupl .dt_pgto )
        LNdiasAtraso =  0
    ELSE
        LNdiasAtraso =  &LSAlsDupl .dt_pgto -  &LSAlsDupl .dt_venc
    ENDIF

    IF LNdiasAtraso = 2 AND DOW(  &LSAlsDupl .dt_venc ) = 7
       LNdiasAtraso = 0
    ENDIF

    IF LNdiasAtraso = 1 AND DOW(  &LSAlsDupl .dt_venc ) = 1
       LNdiasAtraso = 0
    ENDIF

    IF &LSAlsDupl .dt_pgto <  &LSAlsDupl .dt_venc
       LNdiasAtraso = 0
    ENDIF

	LSLinhaXML  = chrtran(STR( LNdiasAtraso ,15,0), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DIAS_ATRASO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsEmp .multa ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_TAXA_MULTA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsEmp .mora ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_TAXA_MORA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNvlrMultaCalc
    LNvlrMultaCalc = 0

	IF LNdiasAtraso > 0
	    LNvlrMultaCalc =  &LSAlsDupl .vlr_doc * empresa.multa/100
	ENDIF

	LSLinhaXML  = chrtran(STR( LNvlrMultaCalc ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MULTA_CALCULADA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNvlrMoraCalc
    LNvlrMoraCalc = 0

	IF LNdiasAtraso > 0
	    LNvlrMoraCalc =  ;
	    &LSAlsDupl .vlr_doc * empresa.mora * LNdiasAtraso /100
	ENDIF
	

	LSLinhaXML  = chrtran(STR( LNvlrMoraCalc ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MORA_CALCULADA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNvlrMulta

    LNvlrMulta = 0
	LSLinhaXML  = chrtran(STR( LNvlrMulta ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MULTA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(STR( &LSAlsDupl .MORA ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MORA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .JUROS ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_JUROS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))





	*----------------------------------------------------------*
    PRIVATE LNVlrDevido
    IF EMPTY( &LSAlsDupl .dt_pgto )
        LNVlrDevido =  0
    ELSE
        LNVlrDevido =   &LSAlsDupl .VLR_DOC;
                  + LNvlrMultaCalc;
                  + LNvlrMoraCalc;
                  - &LSAlsDupl .DEVOLUCAO;
                  - &LSAlsDupl .OUT_CREDT;
                  - &LSAlsDupl .ABATIMENTO;
                  - &LSAlsDupl .DESCONTO;
                  + &LSAlsDupl .out_desp
    ENDIF

	LSLinhaXML  = chrtran(STR( LNVlrDevido ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DEVIDO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*


	LSLinhaXML  = chrtran(STR( &LSAlsDupl .VLR_PGTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_PGTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    PRIVATE LNVlrDifDevido
    IF EMPTY( &LSAlsDupl .dt_pgto )
        LNVlrDifDevido =  0
    ELSE
        LNVlrDifDevido = &LSAlsDupl .VLR_PGTO - LNVlrDevido
    ENDIF

	LSLinhaXML  = chrtran(STR( LNVlrDevido ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DIF_PAGO_DEVIDO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .PARC_PGTO,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_PGTO_PARCIAL="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsDupl .OBS
	LSLinhaXML  = CRtratalinha('TTL_OBSERVACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*


	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7CN           CRDuplClieLegado VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   52  º
*       º Variable:            CRDuplClieLegado                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      101                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7cn     &&  CRDuplClieLegado VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplClieLegado
PARAMETERS 		PrmFileXML,;
				PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsDupl    && Duplicat
	

	AlsANT = ALIAS()


	SELE DUPLICAT
	LSAlsDupl = alias()


	SELE CLIENTES
	LSAlsClt = alias()

	SELE CLIENC
	LSAlsClie = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."







    SELE Clienc
    SET ORDER TO TAG CLIENTE

	set near on
    SEEK &LSAlsDupl .cliente + 1
    SKIP -1
	SET NEAR OFF

    IF BOF() OR &LSAlsDupl .cliente <> &LSAlsClie .cliente
       sele clientes
       set order to tag cliente
       SEEK &LSAlsDupl .cliente
       IF FOUND()
	       m.cliente  =   STR( &LSAlsClt .cliente,14)
	       m.nome     =   &LSAlsClt .nome
	       m.razao    =   &LSAlsClt .nome
	       m.uf       =   &LSAlsClt .estado
	       m.ie       =   &LSAlsClt .inscricao
	       m.im       =   &LSAlsClt .im_tomador
	       m.logr     =   &LSAlsClt .endereco
	       m.nro_logr =   &LSAlsClt .nro_logr
	       m.compllogr=   ""
	       m.cep      =   &LSAlsClt .cep
	       m.muni_ibge=   LEFT( ALLTRIM( STR( &LSAlsClt .muni_ibge ,11)),7)
	       m.muni_nome=   &LSAlsClt .cidade
	       m.bairro   =   &LSAlsClt .bairro
	       m.codpais  =   ""

           m.pais     =   "Brasil"
	       m.ddd      =   ""
	       m.fone     =   &LSAlsClt .fone
	       m.email    =   &LSAlsClt .e_mail

       ELSE
	       m.cliente  =   STR( &LSAlsDupl .cliente,14)
    	   m.nome     =   &LSAlsDupl .nome
	       m.razao    =   &LSAlsDupl .nome
	       m.uf       =   ""
	       m.ie       =   ""
	       m.im       =   ""
	       m.tp_logr  =   ""
	       m.logr     =   ""
	       m.nro_logr =   ""
	       m.compllogr=   ""
	       m.cep      =   ""
	       m.muni_ibge=   ""
	       m.muni_nome=   ""
	       m.bairro   =   ""
	       m.codpais  =   ""
	       m.pais     =   "Brasil"
	       m.ddd      =   ""
	       m.fone     =   ""
	       m.email    =   ""
       endif
    ELSE
       m.cliente  =   STR( &LSAlsClie .cliente,14)
       m.nome     =   &LSAlsClie .nome
       m.razao    =   &LSAlsClie .nome
       m.uf       =   &LSAlsClie .estado
       m.ie       =   &LSAlsClie .inscricao
       m.im       =   &LSAlsClie .im_tomador
       m.logr     =   &LSAlsClie .endereco
       m.nro_logr =   &LSAlsClie .nro_logr
       m.compllogr=   ""
       m.cep      =   &LSAlsClie .cep
       m.muni_ibge=   LEFT(ALLTRIM( STR( &LSAlsClie .muni_ibge ,11)),7)
       m.muni_nome=   &LSAlsClie .cidade
       m.bairro   =   &LSAlsClie .bairro
       m.codpais  =   ""

       if empty( &LSAlsClie .pais )
          m.pais     =   "Brasil"
       ELSE
          m.pais     =   &LSAlsClie .pais
       endif
       m.ddd      =   &LSAlsClie .ddd
       m.fone     =   &LSAlsClie .fone
       m.email    =   &LSAlsClie .e_mail
    ENDIF

	IF "NAO@INFORMADO" $ UPPER(m.email)
       	m.email    =  ''
    ENDIF


	*==========================================================*
	*  CADASTRO
	*==========================================================*
	LSLinhaXML  = m.cliente
	LSLinhaXML  = CRtratalinha('CDSTR_CPFCNPJ="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = ""
	LSLinhaXML  = CRtratalinha('CDSTR_FISICO_JURIDICO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


    LSLinhaXML  = CRLimpaString(m.nome)
	LSLinhaXML  = CRtratalinha('CDSTR_NOME="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = CRLimpaString(m.razao)
	LSLinhaXML  = CRtratalinha('CDSTR_RAZAO_SOCIAL="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	*----------------------------------------------------------*
    LSLinhaXML  = m.uf
	LSLinhaXML  = CRtratalinha('CDSTR_UF="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.ie
	LSLinhaXML  = CRtratalinha('CDSTR_IE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.im
	LSLinhaXML  = CRtratalinha('CDSTR_IM="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = ""
	LSLinhaXML  = CRtratalinha('CDSTR_TP_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.logr
	LSLinhaXML  = CRtratalinha('CDSTR_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.nro_logr
	LSLinhaXML  = CRtratalinha('CDSTR_NRO_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.compllogr
	LSLinhaXML  = CRtratalinha('CDSTR_COMPL_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.cep
	LSLinhaXML  = CRtratalinha('CDSTR_CEP="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.muni_ibge
	LSLinhaXML  = CRtratalinha('CDSTR_MUNI_IBGE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.muni_nome
	LSLinhaXML  = CRtratalinha('CDSTR_MUNI_NOME="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.bairro
	LSLinhaXML  = CRtratalinha('CDSTR_BAIRRO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.codpais
	LSLinhaXML  = CRtratalinha('CDSTR_CODIGO_PAIS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.pais
	LSLinhaXML  = CRtratalinha('CDSTR_NOME_PAIS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.ddd
	LSLinhaXML  = CRtratalinha('CDSTR_DDD="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.fone
	LSLinhaXML  = CRtratalinha('CDSTR_FONE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.email
	LSLinhaXML  = CRtratalinha('CDSTR_E_MAIL="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  ""
	LSLinhaXML  = CRtratalinha('CDSTR_OBSERVACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  ""
	LSLinhaXML  = CRtratalinha('/>')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7D1           CRDuplFinXML VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   53  º
*       º Variable:            CRDuplFinXML                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      102                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7d1     &&  CRDuplFinXML VALID
#REGION 2
RETURN

FUNCTION CRDuplFinXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDupl
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF xmlDupl.XML_ORDEM > 9999999999900
			LSLinhaXML = xmlDupl.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE xmlDupl
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7D6           CRDupEnviaXML VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   54  º
*       º Variable:            CRDupEnviaXML                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      103                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7d6     &&  CRDupEnviaXML VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRDupEnviaXML
PARAMETERS PrmEmp,PrmNroRef
	


   	PRIVATE LSfileXML
   	PRIVATE LSPathOrigem,LSNomeOrigem,LSfileOrigem
   	PRIVATE LSPathDestino,LSNomeDestino,LSfileDestinoOrigem
   	
	*-----------------------------------------------*
	=W_DEFPROC("DUPLICAT.SPR")

*--------------------------------------------------*
*** LSNomeOrigem	= CRNmDuplXMLExpt(PrmEmp,PrmNroRef)
***	LSPathOrigem    = "C:\Dupl\TMP\"
*--------------------------------------------------*


    *-----------------------------------------------*
    *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
    *-----------------------------------------------*
  	LSNomeOrigem	= CRNmDuplXMLExpt(PrmEmp,PrmNroRef)


	LSPathOrigem  = CRPthTmpDup(PrmEmp)

    LSfileOrigem    = LSPathOrigem + LSNomeOrigem

	IF !FILE(LSfileOrigem)
	   RETURN(.F.)
	ENDIF
	*-----------------------------------------------*



*-----------------------------------------------------------*
*	=W_DEFPROC("PARAMETR.SPR")
*	LSPathDestino   = PMGetFieldValue(PrmEmp,"DIR_DFIN")
*
*   IF TYPE("LSPathDestino") <> "C" or EMPTY(LSPathDestino)
*        LSPathDestino = "C:\Dupl\"
*	else
*         LSPathDestino = ALLTRIM(LSPathDestino)
*    ENDIF
*-----------------------------------------------------------*

    LSPathDestino =CRPthDstnDupDIR_DEFIN(PrmEmp)


	*--------------------------------------------------*

   	LSNomeDestino   = "DP"+LSNomeOrigem

    LSfileDestino   = LSPathDestino + LSNomeDestino

	*-----------------------------------------------*
			
	=CRCOPYLongo(LSFileOrigem,LSFileDestino)


	IF FILE(LSFileOrigem)
		DELETE FILE &LSFileOrigem
	ENDIF

	*--------------------------------------------------*



RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7DE           CRNmDuplXMLExpt VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   55  º
*       º Variable:            CRNmDuplXMLExpt                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      104                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7de     &&  CRNmDuplXMLExpt VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRNmDuplXMLExpt
PARAMETER PrmEmpresa,PrmNroRef

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml

    PRIVATE LSnro	
	*----------------------------------------------------------*
    IF TYPE("PrmNroRef") = "D"
         LSnro = SUBS(DTOS(PrmNroRef),3)
    ELSE
         LSnro = ALLTRIM(STR(PrmNroRef,9))
         LSnro = SUBS(LSnro,2)

    ENDIF



    LSnro = CHRTRAN(LSnro," ","0")


***	LSnomeArqXml = "DP"+LSnro
	LSnomeArqXml = LSnro



  	LSfileXML	= LSnomeArqXml+".XML"

	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7DJ           CRDuplExpPeriodoDupl VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   56  º
*       º Variable:            CRDuplExpPeriodoDupl               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      105                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc7dj     &&  CRDuplExpPeriodoDupl VALID
#REGION 2
RETURN

FUNCTION CRDuplExpPeriodoDupl
	PARAMETERS ;
	    PrmEmp,PrmDTInicio, PrmDTFinal,PrmMotivo

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBnaco,LFclintes
	PRIVATE LNCtrItens

	LSalias = ALIAS()

	LFempresa		= NetArq("empresa")
	LFcobranca		= NetArq("cobranca")
	LFbanco  		= NetArq("banco")
	LFduplicat		= NetArq("duplicat")
	LFclienc		= NetArq("clienc")
	LFNota   		= NetArq("nota")
	LFclintes		= NetArq("clientes")

	IF (LFEmpresa+LFduplicat+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF



    SELE Empresa
    SET ORDER TO TAG empresa
    SEEK PrmEmp
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Empresa : "+;
				STR(PrmEmp,3)
      	DO  FCHExpDuplicata
		RETURN(.F.)
	ENDIF












	SELE duplicat
	SET ORDER TO TAG EMISSAO
    SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtInicio)
    SET NEAR OFF

	IF EOF()
      	DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF

	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT  WHILE !EOF()  ;
   	             AND duplicat.dt_emi <= PrmDtFinal  ;
		         AND duplicat.empresa  = PrmEmp ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0

    BKregistro  = LNregistro
    BKimpressos = LNimpressos
    BKimpressao = LNimpressao


	*----------------------------------------------------*

	*-------------------------------------------------------*
	=CRDuplModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML

	DO WHILE       !EOF() ;
		  	  AND  LFsegue = .t. ;
	          AND  duplicat.dt_emi     <= PrmDtFinal;
		      AND  duplicat.empresa    = PrmEmp
		


        LDDt_Ant  = duplicat.dt_emi
        LDMesAnt  = MONTH(duplicat.dt_emi)
        LDAnoAnt  = YEAR(duplicat.dt_emi)


*
*	   	LSfileXML	= CRNmDuplXMLExpt(PrmEmp,LDDt_Ant)
*	   	LSfileXML	= "C:\DUPL\TMP\"+LSfileXML
*


        *-----------------------------------------------*
        *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
        *-----------------------------------------------*
      	LSfileXML	= CRNmDuplXMLExpt(PrmEmp,LDDt_Ant)
       	LSdirtmpXML	= CRPthTmpDup(PrmEmp)


       	LSfileXML	= LSdirtmpXML    +    LSfileXML

        *-----------------------------------------------*




	  	LNroIDfileXML 		=fcreate(LSfileXML)
	   	if LNroIDfileXML<0
     	   =fclose(LNroIDfileXML)
	        wait 'ERRO cria‡Æo arquivo tempor rio ';
	             +LSfileXML+'- <ENTER> ' window
      	     DO  FCHExpDuplicata
             EXIT
    	endif


 	    *---------------------------------------------------*
	    =CRDuplIniXML(LSfileXML,LNroIDfileXML)
        *----------------------------------------------------*

	    DO WHILE   !EOF() ;
		  	  AND  LFsegue = .t. ;
	          AND  MONTH(duplicat.dt_emi)      = LDMesAnt;
              AND  YEAR(duplicat.dt_emi)       = LDAnoAnt;
              AND  duplicat.dt_emi            <= PrmDtFinal ;
		      AND  duplicat.empresa            = PrmEmp
		
			=UPtermo()




	        *------------------------------------------------*
    	    =CRDuplMotivoLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        	*------------------------------------------------*

	        *------------------------------------------------*
    	    =CRDuplIedentLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*

	        *------------------------------------------------*
    	    =CRDuplCedenteLegado(LSfileXML,LNroIDfileXML)
        	*------------------------------------------------*


	        *------------------------------------------------*
    	    =CRDuplPortadorLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*


	        *------------------------------------------------*
    	    =CRDuplRecebedorLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*
	
	        *------------------------------------------------*
    	    =CRDuplLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        	*------------------------------------------------*

	        *------------------------------------------------*
	        =CRDuplClieLegado(LSfileXML,LNroIDfileXML)
    	    *------------------------------------------------*

			*------------------------------------------------------*
			SELE DUPLICAT
			SKIP
		ENDDO

		=CRDuplFinXML(LSfileXML,LNroIDfileXML)

        =fclose(LNroIDfileXML)

        =CRDupEnviaXML(PrmEmp,LDDt_Ant)

	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
  	
	***************************

  	DO  FCHExpDuplicata

	UNLOCK
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7DW           CRAvsExpPeriodo VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   57  º
*       º Variable:            CRAvsExpPeriodo                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      106                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc7dw     &&  CRAvsExpPeriodo VALID
#REGION 2
RETURN

FUNCTION CRAvsExpPeriodo
	PARAMETERS ;
	    PrmEmp,PrmDtInicio,PrmDtFinal

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*

    PRIVATE LSAlsPeriodo
	PRIVATE ;
	    PrmEmp,PrmBanco,PrmCarteira,PrmVariacao,PrmAviso


	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFmvretorn,LFbcretorn,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBanco,LFclintes
	PRIVATE LNCtrItens

	LSalias = ALIAS()

	LFempresa		= NetArq("empresa")
	LFbcretorn		= NetArq("retornbc")
	LFmvretorn		= NetArq("retornmv")
	LFcobranca		= NetArq("cobranca")
	LFbanco   		= NetArq("banco")
	LFduplicat		= NetArq("duplicat")
	LFclintes		= NetArq("clientes")


	LFclienc		= NetArq("clienc")
	LFNota   		= NetArq("nota")
	IF (LFEmpresa+LFmvretorn+LFbcretorn+LFbanco+LFduplicat+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHProcBaixa
		RETURN(.f.)
	ENDIF




    =NetArqAgain("Retornbc")
    LSAlsPeriodo    = Alias()


    SET NEAR ON
    SELE &LSAlsPeriodo
    SET ORDER TO TAG DT_AVISO
    SEEK STR(PrmEmp,3)+DTOS(PrmDtInicio)
    SET NEAR OFF

	IF EOF()
		DO  FCHProcBaixa
		RETURN(.f.)
	ENDIF



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT  WHILE !EOF()  ;
   	             AND &LSAlsPeriodo .DTAVISO <= PrmDtFinal  ;
		         AND &LSAlsPeriodo .empresa  = PrmEmp ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0

    BKregistro  = LNregistro
    BKimpressos = LNimpressos
    BKimpressao = LNimpressao


	*----------------------------------------------------*




	*-------------------------------------------------------*
	=CRAvsModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML

*  	LSfileXML	= CRAvsNmXMLExpt(PrmEmp,PrmDtInicio)
*  	LSfileXML	= "C:\DUPL\TMP\"+LSfileXML



    *-----------------------------------------------*
    *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
    *-----------------------------------------------*
   	LSfileXML	= CRAvsNmXMLExpt(PrmEmp,PrmDtInicio)
   	LSdirtmpXML	= CRPthTmpDup(PrmEmp)

  	LSfileXML	= LSdirtmpXML    +    LSfileXML

    *-----------------------------------------------*





  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return
   	endif

	*---------------------------------------------------*
	=CRAvsIniXML(LSfileXML,LNroIDfileXML)
	*----------------------------------------------------*

    SELE &LSAlsPeriodo
    SET ORDER TO TAG DT_AVISO


	DO WHILE  !EOF() AND ;
		    &LSAlsPeriodo .empresa = PrmEmp;
		AND &LSAlsPeriodo .DTAVISO <= PrmDtFinal

		=UPtermo()


        PrmEmp         = PrmEmp
        PrmBanco       = &LSAlsPeriodo .BANCO
        PrmCarteira    = &LSAlsPeriodo .CARTEIRA
        PrmVariacao    = &LSAlsPeriodo .VARIACAO
        PrmAviso       = &LSAlsPeriodo .AVISO

*--------------------------------------------------------------*
	    SELE cobranca
	    SET ORDER TO TAG CARTEIRA
	    SEEK STR(PrmEmp,3)+STR(PrmBanco,3)+ PrmCarteira+PrmVariacao
		IF !FOUND()
			DO OBJ_MENS.SPR WITH ;
			"    Nao Foi Possivel Localizar COBRANCA : ";
		        +"Aviso:"   +STR(PrmAviso,8);
				+" Banco:"	+ STR(PrmBanco,3);
				+" Carteira:"	+ PrmCarteira;
				+" Variacao:"	+ PrmVariacao
		    SELE &LSAlsPeriodo
		    SKIP
		    LOOP
		ENDIF

	    SELE banco
	    SET ORDER TO TAG BANCO
	    SEEK PrmBanco
		IF !FOUND()
			DO OBJ_MENS.SPR WITH ;
			"    Nao Foi Possivel Localizar BANCO : ";
		        +"Aviso:"   +STR(PrmAviso,8);
				+" Banco:"	+ STR(PrmBanco,3);
				+" Carteira:"	+ PrmCarteira;
				+" Variacao:"	+ PrmVariacao
		    SELE &LSAlsPeriodo
		    SKIP
		    LOOP
		ENDIF






	    SELE Empresa
	    SET ORDER TO TAG empresa
	    SEEK PrmEmp
		IF !FOUND()
			DO OBJ_MENS.SPR WITH ;
			    "    Nao Foi Possivel Localizar Empresa : "+;
					STR(PrmEmp,3)
		    SELE &LSAlsPeriodo
		    SKIP
		    LOOP
		ENDIF


		SELE retornbc
		SET ORDER TO TAG aviso
		SEEK STR(PrmEmp,3)+STR(PrmBanco,3)+;
		   PrmCarteira+PrmVariacao+STR(PrmAviso,8)
		IF !FOUND()
			DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Aviso : "+;
				STR(PrmAviso,8)+" do Banco : "+ STR(PrmBanco,3)
		    SELE &LSAlsPeriodo
		    SKIP
		    LOOP
		ENDIF



	    LNCtrItens = 0

		SELECT  retornmv
		SET ORDER TO TAG aviso
		SEEK STR(PrmEmp,3)+STR(PrmBanco,3)+;
		     PrmCarteira+PrmVariacao+STR(PrmAviso,8)


		DO WHILE  !EOF() AND ;
		    PrmAviso     = retornmv.aviso AND ;
			PrmBanco     = retornmv.banco AND ;
			PrmCarteira = retornmv.carteira AND ;
			PrmVariacao = retornmv.Variacao AND ;
			PrmEmp 	    = retornmv.empresa
		
	        LNCtrItens = LNCtrItens + 1


        	*------------------------------------------------*
		    *  aqui chamada geracao do xml do capa do aviso   	
			*------------------------------------------------*
    	    =CRExpCapaRetLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*

	        *------------------------------------------------*
	        *  aqui chamada geracao do xml do ilocal cobranca
    	    *------------------------------------------------*
	        =CRExpLccbrCapaRetLegado(LSfileXML,LNroIDfileXML)
    	    *------------------------------------------------*

			SELE duplicat
			SET ORDER TO TAG doc
			SEEK STR(PrmEmp,3)+STR(retornmv.duplicata,9)
			IF FOUND()



            	*------------------------------------------------*
            	*  aqui chamada geracao do xml da duplicata            	
				*------------------------------------------------*
	            =CRExpItemRetLegado(LNCtrItens,;
                                LSfileXML,LNroIDfileXML)

    	        *------------------------------------------------*
	            *  aqui chamada geracao do xml das duplicatas           	
                *------------------------------------------*
	            =CRExpDuplRetLegado(LSfileXML,LNroIDfileXML)

            	*------------------------------------------------*
            	*  aqui chamada geracao do xml do clienc
            	*------------------------------------------------*
    	        =CRExpClieDupLegado(LSfileXML,LNroIDfileXML)
	
				SELE retornmv
			ENDIF
			*------------------------------------------------------*
			SELE retornmv
			SKIP
		ENDDO
		*---------------------------------------------------------------*
		SELE &LSAlsPeriodo
		SKIP
	ENDDO
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*

    SELE &LSAlsPeriodo
    USE

	=CRAvsFinML(LSfileXML,LNroIDfileXML)

    =fclose(LNroIDfileXML)

    =CRAvsEnviaXML(PrmEmp,PrmDtInicio)

  	
	***************************

	DO  FCHProcExpAviso

	UNLOCK
RETURN(.T.)

PROCEDURE FCHProcExpAviso
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("cobranca" ,LFcobranca)
	=UP_fecha("retornbc" ,LFbcretorn)
	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("banco" ,LFbanco)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("nota" ,LFnota)
	=UP_fecha("clientes" ,LFclintes)
	
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7EC           CRNmLongoFileXMLDocFiscal VALID    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   58  º
*       º Variable:            CRNmLongoFileXMLDocFiscal          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      107                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7ec     &&  CRNmLongoFileXMLDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRNmLongoFileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
    PRIVATE LSPrefixo,LSTpDoc,LSNrDoc,LSNrEmp

	
	*----------------------------------------------------------*
    LSPrefixo = "DFISCB"
    LSTpDoc   = PrmMod_Doc
    LSNrDoc   = CHRTRAN(STR(PrmNro_Doc,7)," ","0")
    LSNrEmp   = CHRTRAN(STR(PrmEmpresa,3)," ","0")



	LSnomeArqXml = LSPrefixo+LSNrEmp+LSTpDoc+LSNrDoc+".XML"

   	LSfileXML	= LSnomeArqXml
	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7EK           DFCopyLongo VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   59  º
*       º Variable:            DFCopyLongo                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      108                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7ek     &&  DFCopyLongo VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRCopyLongo
PARAMETERS PrmArqOrigem,PrmArqDestino

    ! copyfox.exe &PrmArqOrigem &PrmArqDestino


RETURN(.T.)

*----------------------------------------------------------*


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7EP           CRDuplExpVencPeriodoDupl VALID     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   60  º
*       º Variable:            CRDuplExpVencPeriodoDupl           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      109                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc7ep     &&  CRDuplExpVencPeriodoDupl VALID
#REGION 2
RETURN

FUNCTION CRDuplExpVencPeriodoDupl
	PARAMETERS ;
	    PrmEmp,PrmDTInicio, PrmDTFinal,PrmMotivo

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBnaco,LFclintes
	PRIVATE LNCtrItens

	LSalias = ALIAS()

	LFempresa		= NetArq("empresa")
	LFcobranca		= NetArq("cobranca")
	LFbanco  		= NetArq("banco")
	LFduplicat		= NetArq("duplicat")
	LFclienc		= NetArq("clienc")
	LFclintes		= NetArq("clientes")

	LFNota   		= NetArq("nota")
	IF (LFEmpresa+LFduplicat+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF



    SELE Empresa
    SET ORDER TO TAG empresa
    SEEK PrmEmp
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Empresa : "+;
				STR(PrmEmp,3)
      	DO  FCHExpDuplicata
		RETURN(.F.)
	ENDIF






	SELE duplicat
	SET ORDER TO TAG RL_VENC
    SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtInicio)
    SET NEAR OFF

	IF EOF()
      	DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF
	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT  WHILE !EOF()  ;
   	             AND duplicat.dt_venc <= PrmDtFinal  ;
		         AND duplicat.empresa  = PrmEmp ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0

    BKregistro  = LNregistro
    BKimpressos = LNimpressos
    BKimpressao = LNimpressao


	*----------------------------------------------------*

	*-------------------------------------------------------*
	=CRDuplModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML



	*---------------------------------------------------*
	=CRDuplIniXML(LSfileXML,LNroIDfileXML)
	*----------------------------------------------------*

	DO WHILE       !EOF() ;
		  	  AND  LFsegue = .t. ;
	          AND  duplicat.dt_venc     <= PrmDtFinal;
		      AND  duplicat.empresa    = PrmEmp

		
        LDDt_Ant  = duplicat.dt_venc
        LDMesAnt  = MONTH(duplicat.dt_venc)
        LDAnoAnt  = YEAR(duplicat.dt_venc)




       *-----------------------------------------------*
       *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
       *-----------------------------------------------*
      	LSfileXML	= CRNmDuplXMLExpt(PrmEmp,LDDt_Ant)
      	LSdirtmpXML	= CRPthTmpDup(PrmEmp)

    	LSfileXML	= LSdirtmpXML    +    LSfileXML

       *-----------------------------------------------*

    	LNroIDfileXML 		=fcreate(LSfileXML)

    	if LNroIDfileXML<0
           =fclose(LNroIDfileXML)
            wait 'ERRO cria‡Æo arquivo tempor rio ';
              +LSfileXML+'- <ENTER> ' window
      	    DO  FCHExpDuplicata
            EXIT
   	    endif

        *------------------------------------------------*
   	    =CRDuplMotivoLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*
	    DO WHILE   !EOF() ;
		  	  AND  LFsegue = .t. ;
	          AND  MONTH(duplicat.dt_venc)      = LDMesAnt;
              AND  YEAR(duplicat.dt_venc)       = LDAnoAnt;
              AND  duplicat.dt_venc            <= PrmDtFinal ;
		      AND  duplicat.empresa            = PrmEmp
		
			=UPtermo()



	        *------------------------------------------------*
    	    =CRDuplMotivoLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        	*------------------------------------------------*

	        *------------------------------------------------*
    	    =CRDuplIedentLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*

	        *------------------------------------------------*
    	    =CRDuplCedenteLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*


	        *------------------------------------------------*
    	    =CRDuplPortadorLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*


	        *------------------------------------------------*
    	    =CRDuplRecebedorLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*

	        *------------------------------------------------*
    	    =CRDuplLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
	        *------------------------------------------------*

	        *------------------------------------------------*
    	    =CRDuplClieLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*

			*------------------------------------------------------*
			SELE DUPLICAT
			SKIP
		ENDDO
		=CRDuplFinXML(LSfileXML,LNroIDfileXML)

	    =fclose(LNroIDfileXML)

	    =CRDupEnviaXML(PrmEmp,LDDt_Ant)

	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*



  	
	***************************

  	DO  FCHExpDuplicata

	UNLOCK
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7F0           FCHExpDuplicata VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   61  º
*       º Variable:            FCHExpDuplicata                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      110                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc7f0     &&  FCHExpDuplicata VALID
#REGION 2
RETURN


PROCEDURE FCHExpDuplicata
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("cobranca" ,LFcobranca)
	=UP_fecha("banco" ,LFbanco)
	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("nota" ,LFnota)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7F1           CRDuplDFisExpDuplicata VALID       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   62  º
*       º Variable:            CRDuplDFisExpDuplicata             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      111                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc7f1     &&  CRDuplDFisExpDuplicata VALID
#REGION 2
RETURN

FUNCTION CRDuplDFisExpDuplicata
	PARAMETERS ;
	    PrmEmpresa,PrmNota,PrmMotivo

    * PrmMotivo  (RIMPRIMIR,EGISTRAR,CANCELAR,EXPORTAR)	

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBanco,LFclintes
	PRIVATE LNCtrItens
	PRIVATE LForcamento


    PRIVATE LFRetorno
	PRIVATE LSStatus


*--------------------------------------------------------*
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc


	*----------------------------------------------------*

	*-->>>>>>>>>>>       PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc,;
			  RtnDocEletro



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc,;
			  RtnDocEletro
*--------------------------------------------------------*


	LSalias = ALIAS()




	LForcamento     = NetArq("Orcament")
	LFempresa		= NetArq("empresa")
	LFcobranca		= NetArq("cobranca")
	LFduplicat		= NetArq("duplicat")
	LFbanco   		= NetArq("banco")
	LFclienc		= NetArq("clienc")
	LFclintes		= NetArq("clientes")
	LFNota   		= NetArq("nota")
	IF (LForcamento+LFEmpresa+LFduplicat+LFBanco+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF



    SELE nota
    SET ORDE TO nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !found()
		DO  FCHExpDuplicata
		RETURN(.T.)
	ENDIF



    SELE orcament
    SET ORDE TO geral
    SEEK STR(PrmEmpresa,3)+STR(nota.Orcamento,6)
	IF !FOUND() ;
	     OR orcament.natu_oper <> 1

		   	&& So Gerar Duplicatas para
		    && operacoes de Venda

		DO  FCHExpDuplicata
		RETURN(.T.)
	ENDIF



    SELE Empresa
    SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Empresa : "+;
				STR(PrmEmpresa,3)
      	DO  FCHExpDuplicata
		RETURN(.F.)
	ENDIF




	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
	*  ALGORITIMO DE GERACAO DO NUMERO DE DUPLICATA - CRgeradupl
	*----------------------------------------------------------------*
	*
	*	IF LNemp <> 10
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  STR(m.empresa,1)))   && 1 => DUPLICATA
	*	else
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  "0"))   && 1 => DUPLICATA
	*	ENDIF
	*-------------------------------------------------------------------*

    PRIVATE LSnota
    PRIVATE LNdup
    PRIVATE LNnroReC

	LSnota  = STR(PrmNota,7)
	LNdup	= PrmNota * 100		


	SET NEAR ON

	SELE Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(LNdup,9)

    SET NEAR OFF


    LNnroReC = RECNO()



	*-------------------------------------------------------*
	=CRDuplModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML




*----------------------------------------------------*
	PrmSerie   		= nota.Serie
	PrmTipo    		= nota.Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc,RtnDocEletro)


*--------------------------------------------------------*



*--------------------------------------------------------
*--------------------------------------------------------
*  	LSfileXML	= CRNmDuplXMLExpt(PrmEmpresa,RtnNro_Doc)
*
*
*  	LSfileXML	= "C:\DUPL\TMP\"+LSfileXML
*--------------------------------------------------------

   *-----------------------------------------------*
   *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
   *-----------------------------------------------*
   	LSfileXML	= CRNmDuplXMLExpt(PrmEmpresa,RtnNro_Doc)
   	LSdirtmpXML	= CRPthTmpDup(PrmEmpresa)


   	LSfileXML	= LSdirtmpXML    +    LSfileXML
   *-----------------------------------------------*


  	LNroIDfileXML 		=fcreate(LSfileXML)




   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      	DO  FCHExpDuplicata
      return(.f.)
   	endif

	*---------------------------------------------------*
	=CRDuplIniXML(LSfileXML,LNroIDfileXML)
	*----------------------------------------------------*





	SET NEAR OFF
	DO WHILE !EOF() ;
	    AND LSnota  = LEFT(STR( Duplicat.duplicata,9) ,7);
		AND PrmEmpresa 	=  Duplicat.empresa
		



        *------------------------------------------------*
        =CRDuplMotivoLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplIedentLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*



        *------------------------------------------------*
        =CRDuplCedenteLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplPortadorLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplRecebedorLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplClieLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

		*------------------------------------------------------*
		SELE DUPLICAT
		SKIP
	ENDDO
	=CRDuplFinXML(LSfileXML,LNroIDfileXML)

    =fclose(LNroIDfileXML)

*------------------------------------------*
*    =CRDupEnviaXML(PrmEmpresa,LNnroReC)
*------------------------------------------*
    =CRDupEnviaXML(PrmEmpresa,RtnNro_Doc)


    LFRetorno = .t.
	LSStatus = CRRespostaDup(PrmEmpresa, RtnNro_Doc, "NAO ESPERA")
	IF "ERRO" $ LSStatus
       LFRetorno = .f.
    ENDIF
  	
	***************************

  	DO  FCHExpDuplicata

	UNLOCK
RETURN(LFRetorno)

PROCEDURE FCHExpDuplicata
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("cobranca" ,LFcobranca)
	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("banco" ,LFbanco)
	=UP_fecha("nota" ,LFnota)
	=UP_fecha("clientes" ,LFclintes)

    IF TYPE("LForcamento") <> "U"
     	=UP_fecha("orcament" ,LForcamento)
    ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7FO           CREsperaRspDup VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   63  º
*       º Variable:            CREsperaRspDup                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      112                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7fo     &&  CREsperaRspDup VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CREsperaRspDup
PARAMETERS PrmEmpresa, PrmNroDoc


	*-------------------------------------------------------*
	PRIVATE LSstatus
	PRIVATE CtrAguarda

	LSstatus = ""

    CtrAguarda = 0
	LFlgEspera = .t.

	LNctr = 0

	CLEAR TYPEAHEAD


	DO WHILE LFlgEspera



		LSstatus=CRBuscaRspDup(PrmEmpresa, PrmNroDoc)

		DO CASE
 		 	CASE "ERRO ! Espera interrompida por usr" $ LSstatus
				LFlgEspera = .F.
		
			CASE "ERRO ! Nao houve retorno do comando" $ LSstatus
				LFlgEspera = .T.

			CASE "PROCESSADO" $ LSstatus
				LFlgEspera = .F.


			CASE "ERRO" $ LSstatus
				LFlgEspera = .F.

		ENDCASE


		IF LFlgEspera = .T.

			WAIT WINDOW LSmsg NOWAIT
			TECLA=INKEY(3)
			LNctr = LNctr + 1
			IF  LNctr > 60
				EXIT
			ENDIF
			IF TECLA = 27 OR LASTKEY() = 27
				IF fox_alert("Interrompe Espera NFe ? ")
					LSstatus = "ERRO ! Espera interrompida por usr"
					EXIT
				ENDIF
			ENDIF
		ENDIF



	ENDDO
    LSmsg = "Concluido leitura XML............ "
	WAIT WINDOW LSmsg NOWAIT

RETURN(LSstatus)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7FX           CRBuscaRspDup VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   64  º
*       º Variable:            CRBuscaRspDup                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      113                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7fx     &&  CRBuscaRspDup VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CRBuscaRspDup
PARAMETERS PrmEmpresa,PrmNro_Doc

	*-------------------------------------------------------*

	PRIVATE LSnroDoc
	PRIVATE LNfile
	PRIVATE LSstatus,LSFile,LNctr,TECLA


	*-------------------------------------------------------*
	*  obter o MOD_DOC
	*-------------------------------------------------------*



	*----------------------------------------------------------*

	LSstatus = ""
	LNfile = 0




	*--------------------------------------------------*

*----------------------------------------------------------*
*	=W_DEFPROC("PARAMETR.SPR")
*
*
*	LSPathDestino   = PMGetFieldValue(PrmEmpresa,"DIR_DFIN")
*
*    IF TYPE("LSPathDestino") <> "C" or EMPTY(LSPathDestino)
*         LSPathDestino = "C:\Dupl\"
*	else
*         LSPathDestino = ALLTRIM(LSPathDestino)
*    ENDIF
*----------------------------------------------------------*



    LSPathDestino =CRPthDstnDupDIR_DEFIN(PrmEmpresa)


	*--------------------------------------------------*


	=W_DEFPROC("DUPLICAT.SPR")
   	LSFile	= CRNmDuplXMLExpt(PrmEmpresa,PrmNro_Doc)

    LSFileOk  = LSPathDestino+strtran(LSFile,".XML",".$$$")
    LSFileErr = LSPathDestino+strtran(LSFile,".XML",".ERR")

    LSFileBKP = LSPathDestino+"\BKP\"+strtran(LSFile,".XML",".ERR")
    	
	*-----------------------------------------------------*

	LNctr = 0

	CLEAR TYPEAHEAD



	DO CASE

		CASE !(FILE(LSFileOk)) and !(FILE(LSFileErr))
			LSstatus = "ERRO ! Nao houve retorno do comando"

		OTHERWISE		
			TECLA=INKEY(3)


			IF (FILE(LSFileOk))
				LSstatus="PROCESSADO !- Financeiro Registrado"
			ELSE
				LSstatus="ERRO ! - Financeiro Nao Registrado"
            ENDIF



			IF (FILE(LSFileOk))
		   		delete file &LSFileOk
			ENDIF
			
			IF (FILE(LSFileErr))
                =CRCopyLongo(LSFileErr,LSFileBKP)
		   		delete file &LSFileErr
			ENDIF


	ENDCASE

	*---------------------------------------------------*
	* as barrar fornecem uma orientacao para se tratar
	* o retorno quando nao sao informados todos os
	* parametros de retorno.
	* A rotina (DFRespostaNFe ) que trata o staus identifique o
	* os parametro nao retornados com
	*---------------------------------------------------*
	LSstatus = LSstatus + "||||||||||||||||||||||||||||||"


RETURN(LSstatus)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7G4           CRRespostaDup VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   65  º
*       º Variable:            CRRespostaDup                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      114                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7g4     &&  CRRespostaDup VALID
#REGION 2
return
*---------------------------------------------------------------*
*		   PrmEsperaResposta,;
*		       && "ESPERA" ou "NAO ESPERA"
*
*---------------------------------------------------------------*

FUNCTION CRRespostaDup
PARAMETERS ;
		   PrmEmpresa,;	
		   PrmNroDoc,;
		   PrmEsperaResposta
	*-------------------------------------------------------*
	PRIVATE LSstatus
	LSstatus = ""


	IF PrmEsperaResposta = "ESPERA"
		LSstatus=CREsperaRspDup(PrmEmpresa,PrmNroDoc)
	ELSE
		LSstatus=CRBuscaRspDup(PrmEmpresa,PrmNroDoc)
	ENDIF


	*-------------------------------------------------------*


RETURN(LSstatus)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7GC           CRDuplMotivoLegado VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   66  º
*       º Variable:            CRDuplMotivoLegado                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      115                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7gc     &&  CRDuplMotivoLegado VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplMotivoLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML,;
			PrmMotivo
			

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."


	IF TYPE("PrmMotivo") <> "C"
        PrmMotivo = "REGISTRAR"
    ENDIF
	

	DO CASE

	   CASE ("CANCELAR" $ PrmMotivo)
        	LSLinhaXML  = "CANCELAR"

	   CASE ("IMPRIMIR" $ PrmMotivo)
        	LSLinhaXML  = "IMPRIMIR"


	   CASE ("EXPORTAR" $ PrmMotivo)

**        	LSLinhaXML  = "EXPORTAR"   && WARQUIA MANTEVE O REGISTRAR
        	LSLinhaXML  = "REGISTRAR"

       OTHERWISE
        	LSLinhaXML  = "REGISTRAR"
    ENDCASE


    LSLinhaXML  = CRtratalinha('<ROW XML_MOTIVO="'+LSLinhaXML+'"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7GJ           CRGer2XMLDpDocFiscal VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   70  º
*       º Variable:            CRGer2XMLDpDocFiscal               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      116                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4c30nc7gj     &&  CRGer2XMLDpDocFiscal VALID
#REGION 2
RETURN

FUNCTION CRGer2XMLDpDocFiscal

PARAMETER PrmEmpresa,;
		  PrmNro_Orca,;
		  PrmNro_Doc,;
		  PrmMod_doc,;
		  PrmSerie_Doc,;
		  PrmTP_Mov, ;
		  PrmNota,;
		  PrmMotivo



    * PrmMotivo  (IMPRIMIR,REGISTRAR,CANCELAR,EXPORTAR)	

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBanco,LFclintes
	PRIVATE LNCtrItens
	PRIVATE LForcamento


    PRIVATE LFRetorno
	PRIVATE LSStatus


	LSalias = ALIAS()

	LForcamento     = NetArq("Orcament")
	LFempresa		= NetArq("empresa")
	LFcobranca		= NetArq("cobranca")
	LFduplicat		= NetArq("duplicat")
	LFbanco   		= NetArq("banco")
	LFclienc		= NetArq("clienc")
	LFclintes		= NetArq("clientes")
	LFNota   		= NetArq("nota")
	IF (LForcamento+LFEmpresa+LFduplicat+LFBanco+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF






    SELE nota
    SET ORDE TO nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !found()
		DO  FCHExpDuplicata
		RETURN(.T.)
	ENDIF



    SELE orcament
    SET ORDE TO geral
    SEEK STR(PrmEmpresa,3)+STR(nota.Orcamento,6)
	IF !FOUND() ;
	     OR orcament.natu_oper <> 1

		   	&& So Gerar Duplicatas para
		    && operacoes de Venda

		DO  FCHExpDuplicata
		RETURN(.T.)
	ENDIF



    SELE Empresa
    SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Empresa : "+;
				STR(PrmEmpresa,3)
      	DO  FCHExpDuplicata
		RETURN(.F.)
	ENDIF




	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
	*  ALGORITIMO DE GERACAO DO NUMERO DE DUPLICATA - CRgeradupl
	*----------------------------------------------------------------*
	*
	*	IF LNemp <> 10
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  STR(m.empresa,1)))   && 1 => DUPLICATA
	*	else
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  "0"))   && 1 => DUPLICATA
	*	ENDIF
	*-------------------------------------------------------------------*
    PRIVATE LSnota
    PRIVATE LNdup
    PRIVATE LNnroReC

	LSnota  = STR(PrmNota,7)
	LNdup	= PrmNota * 100		



	SET NEAR ON

	SELE Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(LNdup,9)

    SET NEAR OFF


    LNnroReC = RECNO()




	*-------------------------------------------------------*
	=CRDuplModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML


	*-------------------------------------------------------*
*  	LSfileXML	= CRNm2FileXMLDocFiscal(PrmEmpresa,PrmMod_doc,PrmNro_Doc)
*  	LSfileXML	= "C:\DUPL\TMP\"+LSfileXML
	*-------------------------------------------------------*

   *-----------------------------------------------*
   *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
   *-----------------------------------------------*
   	LSfileXML	= CRNm2FileXMLDocFiscal(PrmEmpresa,PrmMod_doc,PrmNro_Doc)
   	LSdirtmpXML	= CRPthTmpDup(PrmEmpresa)


   	LSfileXML	= LSdirtmpXML    +    LSfileXML
   *-----------------------------------------------*



  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      	DO  FCHExpDuplicata
      return(.f.)
   	endif

	*---------------------------------------------------*
	=CRDuplIniXML(LSfileXML,LNroIDfileXML)
	*----------------------------------------------------*





	SET NEAR OFF
	DO WHILE !EOF() ;
	    AND LSnota  = LEFT(STR( Duplicat.duplicata,9) ,7);
		AND PrmEmpresa 	=  Duplicat.empresa
		



        *------------------------------------------------*
        =CRDuplMotivoLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplIedentLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*



        *------------------------------------------------*
        =CRDuplCedenteLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplPortadorLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplRecebedorLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplClieLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

		*------------------------------------------------------*
		SELE DUPLICAT
		SKIP
	ENDDO
	=CRDuplFinXML(LSfileXML,LNroIDfileXML)

    =fclose(LNroIDfileXML)

    LFRetorno = .t.
	***************************

******************************PROCEDURE FCHExpDuplicata
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("cobranca" ,LFcobranca)
	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("banco" ,LFbanco)
	=UP_fecha("nota" ,LFnota)
	=UP_fecha("clientes" ,LFclintes)

    IF TYPE("LForcamento") <> "U"
     	=UP_fecha("orcament" ,LForcamento)
    ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
*********************************RETURN

RETURN(LFRetorno)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7GZ           CRNm2FileXMLDocFiscal VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   74  º
*       º Variable:            CRNm2FileXMLDocFiscal              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      117                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7gz     &&  CRNm2FileXMLDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRNm2FileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*




   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
    PRIVATE LSPrefixo,LSTpDoc,LSNrDoc,LSNrEmp

	
	*----------------------------------------------------------*
    LSPrefixo = "DP"
    LSNrDoc   = CHRTRAN(STR(PrmNro_Doc,7)," ","0")
    LSNrEmp   = CHRTRAN(STR(PrmEmpresa,3)," ","0")



	LSnomeArqXml = LSPrefixo+subs(LSNrDoc,3)+".XML"

   	LSfileXML	= LSnomeArqXml
	
	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7H5           CRNm2LongoFileXMLDocFiscal VALID   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   75  º
*       º Variable:            CRNm2LongoFileXMLDocFiscal         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      118                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7h5     &&  CRNm2LongoFileXMLDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRNm2LongoFileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc

	*-------------------------------------------------------*
*
*   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
*    PRIVATE LSPrefixo,LSTpDoc,LSNrDoc,LSNrEmp

	
	*----------------------------------------------------------*
*    LSPrefixo = "DP"
*    LSTpDoc   = PrmMod_Doc
*    LSNrDoc   = CHRTRAN(STR(PrmNro_Doc,7)," ","0")
*    LSNrEmp   = CHRTRAN(STR(PrmEmpresa,3)," ","0")
*
*
*
*	LSnomeArqXml = LSPrefixo+LSNrEmp+LSTpDoc+LSNrDoc+".XML"
*
*   	LSfileXML	= LSnomeArqXml



	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*




   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
    PRIVATE LSPrefixo,LSTpDoc,LSNrDoc,LSNrEmp

	
	*----------------------------------------------------------*
    LSPrefixo = "DP"
    LSNrDoc   = CHRTRAN(STR(PrmNro_Doc,7)," ","0")
    LSNrEmp   = CHRTRAN(STR(PrmEmpresa,3)," ","0")



	LSnomeArqXml = LSPrefixo+subs(LSNrDoc,3)+".XML"

   	LSfileXML	= LSnomeArqXml
	
	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7HB           CRDFis_Tem_Duplicata VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   76  º
*       º Variable:            CRDFis_Tem_Duplicata               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      119                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7hb     &&  CRDFis_Tem_Duplicata VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRDFis_Tem_Duplicata
PARAMETER PrmEmpresa,;
		  PrmNro_Orca


	PRIVATE LSalias
	
	PRIVATE PrmAlsCR
	

	LSalias  = ALIAS()
	PrmAlsCR = CRGetAlias()


	*---------------------------------------------------*

	SELE &PrmAlsCR

	go bott
	go top
	

	SELE &PrmAlsCR
	SET ORDER TO TAG REFR_ORCA
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmNro_Orca,6)
	SET NEAR OFF



    IF   eof() ;
       or PrmEmpresa   <> &PrmAlsCR .empresa;
	   or PrmNro_Orca   <> &PrmAlsCR .orcamento

       LFRetorno = .F.

    ELSE

       LFRetorno = .T.
	
	ENDIF
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(LFRetorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7HJ           CR_Fputs VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   77  º
*       º Variable:            CR_Fputs                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      120                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7hj     &&  CR_Fputs VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION CR_FputsLimpa
PARAMETERS PrmString

	PRMString = chrtran(PRMString,"€","C")       && 01
	PRMString = chrtran(PRMString,"‡","c")       && 02
	PRMString = chrtran(PRMString,"¦","-")       && 04
	PRMString = chrtran(PRMString,"§","-")       && 05
	PRMString = chrtran(PRMString,"°",'')        && 06
	PRMString = chrtran(PRMString,"º",'')        && 07
	PRMString = chrtran(PRMString,"",'E')       && 08
	PRMString = chrtran(PRMString,"‚",'e')       && 09
	PRMString = chrtran(PRMString,"Ç",'A')       && 10
	PRMString = chrtran(PRMString,"Æ",'a')       && 11
	PRMString = chrtran(PRMString,"ø",'')        && 12
	PRMString = chrtran(PRMString,chr(0),'')     && 13

** nao 	PRMString = chrtran(PRMString,'"','')        && 14

RETURN(PrmString)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7HO           CRMntaStrgInfoCobranca VALID       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   78  º
*       º Variable:            CRMntaStrgInfoCobranca             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      121                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7ho     &&  CRMntaStrgInfoCobranca VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRMntaStrgInfoCobranca
PARAMETER PrmEmpresa,;
		  PrmNro_Orca


	PRIVATE LSalias
	
	PRIVATE PrmAlsCR
	PRIVATE LNrecDupl
	
	PRIVATE LNosiReferencia   && relaciona as duplicatas pelo
	                          && orcamento de referencia


	PRIVATE LsTmp  && String com detalhamento de Duplicatas
	

	LSalias  = ALIAS()
	PrmAlsCR = CRGetAlias()


	*---------------------------------------------------*

	SELE &PrmAlsCR
	SET ORDER TO TAG REFR_ORCA
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmNro_Orca,6)
	SET NEAR OFF



	go bott
	go top
	

	SELE &PrmAlsCR
	SET ORDER TO TAG REFR_ORCA
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmNro_Orca,6)
	SET NEAR OFF




	*----------------------------------------------------*

	LFsegue = .t.



	SET POINT TO ','

	LStmp = ""

	SELE &PrmAlsCR
	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa       = &PrmAlsCR .empresa;
	        AND PrmNro_Orca       = &PrmAlsCR .orcamento




		LNrecDupl = RECNO()

		*------------------------------------------------------------*
		LSdt  =  STR(DAY( &PrmAlsCR .dt_venc),2)+"/";
			   	+STR(MONTH( &PrmAlsCR .dt_venc),2)
		LSdt  = CHRTRAN(LSdt," ","0")
		
		LStmp = LStmp + ;
   				  TRANSF( &PrmAlsCR .duplicata,"@Z 999999999")+"-"+;
				  TRANSF( &PrmAlsCR .vlr_doc,"@Z 999999.99")+"-"+LSdt+" "


		*------------------------------------------------------------*		


		SELE &PrmAlsCR
		SET ORDER TO TAG refr_orca

		GO LNrecDupl
		SKIP
	ENDDO


	SET POINT TO

	*-----------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(LStmp)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7HY           CRPthTmpDup VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   81  º
*       º Variable:            CRPthTmpDup                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      122                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7hy     &&  CRPthTmpDup VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRPthTmpDup
PARAMETER PrmEmp

	*-------------------------------------------------------*


	*-----------------------------------------------*


	=W_DEFPROC("PARAMETR.SPR")
	LSPathTmp   = PMGetFieldValue(PrmEmp,"DIR_DFIN")

    IF TYPE("LSPathTmp") <> "C" or EMPTY(LSPathTmp)
         LSPathTmp = "Q:\XMLS\Dupl\"
	else
         LSPathTmp = ALLTRIM(LSPathTmp)
    ENDIF

    LSPathTmp = ALLTRIM(LSPathTmp)+"TMP\"



   *----   testar o diretorio ---

    PRIVATE LSfileXML, LNroIDfileXML

    LSfileXML	= LSPathTmp+"TESTE.TXT"


    LNroIDfileXML 		=fcreate(LSfileXML)

   	if LNroIDfileXML<0
          =fclose(LNroIDfileXML)
           wait 'ERRteste diretorio tempor rio ';
              +LSfileXML+'- <ENTER> ' window
    endif
    =fclose(LNroIDfileXML)



	
RETURN(LSPathTmp)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4C30NC7HZ           CRPthDstnDupDIR_DEFIN VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   82  º
*       º Variable:            CRPthDstnDupDIR_DEFIN              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      123                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4c30nc7hz     &&  CRPthDstnDupDIR_DEFIN VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRPthDstnDupDIR_DEFIN
PARAMETER PrmEmp

	*-------------------------------------------------------*


	*-----------------------------------------------*


	=W_DEFPROC("PARAMETR.SPR")
	LSPathTmp   = PMGetFieldValue(PrmEmp,"DIR_DFIN")

    IF TYPE("LSPathTmp") <> "C" or EMPTY(LSPathTmp)
         LSPathTmp = "Q:\XMLS\Dupl\"
	else
         LSPathTmp = ALLTRIM(LSPathTmp)
    ENDIF



   *----   testar o diretorio ---

    PRIVATE LSfileXML, LNroIDfileXML

    LSfileXML	= LSPathTmp+"TESTE.TXT"


    LNroIDfileXML 		=fcreate(LSfileXML)

   	if LNroIDfileXML<0
          =fclose(LNroIDfileXML)
           wait 'ERRteste diretorio tempor rio ';
              +LSfileXML+'- <ENTER> ' window
    endif
    =fclose(LNroIDfileXML)


	
RETURN(LSPathTmp)
