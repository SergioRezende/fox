*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º 01/27/16             NOTAITE.SPR               10:22:48 º
*       º                                                         º
*       ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶
*       º                                                         º
*       º Author's Name                                           º
*       º                                                         º
*       º Copyright (c) 2016 Company Name                         º
*       º Address                                                 º
*       º City,     Zip                                           º
*       º                                                         º
*       º Description:                                            º
*       º This program was automatically generated by GENSCRN.    º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º                MS-DOS Window definitions                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              NOTAITE/MS-DOS Screen Layout               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 1
@ 3,1 SAY "====> Com Uso de pseudo OO" ;
	SIZE 1,26, 0
@ 32,1 SAY "Metodos de Acesso aos Valores das Propriedades" ;
	SIZE 1,46, 0
@ 22,1 SAY "Metodos Chamados ao Executar IESetDerivadas - Nao devem ser Chamados Por Outro" ;
	SIZE 1,78, 0
@ 2,0 GET IETeste ;
	PICTURE "@*HN IETeste - Testes" ;
	SIZE 1,18,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xd5()
@ 7,6 GET IEVerifyInst ;
	PICTURE "@*HN IEVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xdd()
@ 8,6 GET IECreate ;
	PICTURE "@*HN IECreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xdm()
@ 9,6 GET IEDestroi ;
	PICTURE "@*HN IEDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xdt()
@ 10,6 GET IEReadProp ;
	PICTURE "@*HN IEReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xdz()
@ 11,6 GET IESetDerivadas ;
	PICTURE "@*HN IESetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xe7()
@ 12,10 GET IESetPropVT ;
	PICTURE "@*HN IESetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xef()
@ 13,10 GET IEGetPropVT ;
	PICTURE "@*HN IEGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xel()
@ 14,6 GET IEChk_Identidade ;
	PICTURE "@*HN IEChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xes()
@ 15,6 GET IE_Refresh ;
	PICTURE "@*HN IE_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xez()
@ 16,6 GET IEFind ;
	PICTURE "@*HN IEFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xf5()
@ 17,6 GET IEComandText ;
	PICTURE "@*HN IEComandText - Executa Comando em Parametro" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xgu()
@ 21,0 GET IECheq_Relacao ;
	PICTURE "@*HN IECheq_Relacao - Verifica Integridade NotaEnt X NotaIte" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xgv()
@ 23,4 GET IEcalcicmNormal ;
	PICTURE "@*HN 01-IEcalcIcmNormal - Calcula Valores ICMS Normal Entrada" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xgw()
@ 24,4 GET IEclcIcmSOper ;
	PICTURE "@*HN 01B-IEclcIcmSOper - Calcula Valores ICMS sobre operacao" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xgx()
@ 25,4 GET IEcalcIcmSubs ;
	PICTURE "@*HN 02-IEcalcIcmSubs - Calcula Valores ICMS Substituicao Tributaria" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xgy()
@ 29,4 GET IECalcCusto ;
	PICTURE "@*HN 03-IECalcCusto - Calcula Custo do Item na Operacao" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xgz()
@ 33,3 GET IEGetCusto ;
	PICTURE "@*HN IEGetCusto - Retorna Custo do Item" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xh0()
@ 34,3 GET IEGetBaseCalc ;
	PICTURE "@*HN IEGetBaseCalc - Retorna Base Calculo ICMS" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xid()
@ 35,3 GET IEGetBsIcmSO ;
	PICTURE "@*HN IEGetBsIcmSO - Retorna BASE ICMS SOBRE OPERACAO" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xie()
@ 36,3 GET IEGetBsSbBrt ;
	PICTURE "@*HN IEGetBsSbBrt - Retorna BASE_SBBRT" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xif()
@ 37,3 GET IEGetBsSubs ;
	PICTURE "@*HN IEGetBsSubs - Retorna BASE_SBBRT" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xig()
@ 38,3 GET IERtdoSaida ;
	PICTURE "@*HN IERtdoSaida - Ret.Vlr.ICM Retido na Saida" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xih()
@ 39,3 GET IERtdoEntrada ;
	PICTURE "@*HN IERtdoEntrada - Ret.Vlr.ICM Retido na Entrada" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xii()
@ 40,3 GET IEicmNormal ;
	PICTURE "@*HN IEicmNormal - Ret.Vlr.ICM Normal" ;
	SIZE 1,34,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xij()
@ 41,3 GET IEicmsSO ;
	PICTURE "@*HN IEicmsSO - Ret.Vlr.ICM Sobre Opera‡Æo" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xik()
@ 45,3 GET IEGetIPI ;
	PICTURE "@*HN IEGetIPI - Retorna Valor do IPI no item" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xil()
@ 46,3 GET IEVerifCustoDistocido ;
	PICTURE "@*HN IEVerifCustoDistocido - Verifica Distorcao entre Custo Atual e Nova Entrada" ;
	SIZE 1,77,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xim()
@ 47,3 GET IEDisplCusto ;
	PICTURE "@*HN IEDisplCusto - Visualiza Distorcao entre Custo Atual e Nova Entrada" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xiu()
@ 49,3 GET IEExtrato ;
	PICTURE "@*HN IEExtrato - Extrato de Situaca de entrada de itens" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xj1()
@ 52,4 GET AIEcalcIcmSubs ;
	PICTURE "@*HN 02-IEcalcIcmSubs - SUBSTITUIDA EM 18/10/2006" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xj9() ;
	DISABLE
@ 30,7 GET IEformulaCusto ;
	PICTURE "@*HN 03-IEformulaCusto -" ;
	SIZE 1,21,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xjj()
@ 27,4 GET IEcalcPis ;
	PICTURE "@*HN 02-IEcalcPis - Calcula PIS" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xjq()
@ 28,4 GET IEcalcCOFINS ;
	PICTURE "@*HN 02-IEcalcCOFINS- Calcula COFINS" ;
	SIZE 1,33,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xjx()
@ 42,3 GET IECST ;
	PICTURE "@*HN IECST - Ret.CST" ;
	SIZE 1,17,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xk5()
@ 1,38 GET IEatrb_path ;
	SIZE 1,21 ;
	DEFAULT " "
@ 1,1 SAY "1-Path definido para abertura do fbf" ;
	SIZE 1,36, 0
@ 5,6 GET IEDefnPath ;
	PICTURE "@*HN IEDefnPath - Define Pasta de localizacao do dbf referencia" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xkc()
@ 19,0 GET IEGetAlias ;
	PICTURE "@*HN IEGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xkj()
@ 43,3 GET PrdtOrigem ;
	PICTURE "@*HN IEPrdtOrigem - Ret.ORIGEM do Produto no item 1/2/3/4/5/6/7 (compoe CST)" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xkp()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              NOTAENT/MS-DOS Screen Layout               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 2
@ 23,2 GET NEGetFieldValue ;
	PICTURE "@*HN NEGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xkv()
@ 25,2 GET NEGetUFOrigem ;
	PICTURE "@*HN NEGetUFOrigem - Retorna UFs (Origem da NFE)" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xl2()
@ 26,2 GET NEGetUFDestino ;
	PICTURE "@*HN NEGetUFDestino - Retorna UFs (Destino da NFE)" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xl9()
@ 27,2 GET NEGetRetidoDestacado ;
	PICTURE "@*HN NEGetRetidoDestacado - Retido Destacado na NFE" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xmy()
@ 4,7 GET NEVerifyInst ;
	PICTURE "@*HN NEVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xmz()
@ 5,10 GET NECreate ;
	PICTURE "@*HN NECreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xn0()
@ 13,10 GET NEDestroi ;
	PICTURE "@*HN NEDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xn1()
@ 7,13 GET NEReadProp ;
	PICTURE "@*HN NEReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xn2()
@ 10,15 GET NESetDerivadas ;
	PICTURE "@*HN NESetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xn3()
@ 8,15 GET NESetPropVT ;
	PICTURE "@*HN NESetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xn4()
@ 9,15 GET NEGetPropVT ;
	PICTURE "@*HN NEGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xn5()
@ 3,2 GET NEChk_Identidade ;
	PICTURE "@*HN NEChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xn6()
@ 2,2 GET NEFind ;
	PICTURE "@*HN NEFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xoh()
@ 15,2 GET NEGetFieldValue ;
	PICTURE "@*HN NEGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xoi()
@ 14,2 GET NE_Refresh ;
	PICTURE "@*HN NE_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xoj()
@ 17,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 19,2 GET NELerRegistro ;
	PICTURE "@*HN NELerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xok()
@ 11,13 GET NEWriteProp ;
	PICTURE "@*HN NEWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xol()
@ 20,2 GET NESalvarRegistro ;
	PICTURE "@*HN NESalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xom()
@ 18,2 GET NEExiste ;
	PICTURE "@*HN NEExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xon()
@ 21,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 16,2 GET NEGetAlias ;
	PICTURE "@*HN NEGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xoo()
@ 1,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 29,2 GET NEVerPendencias ;
	PICTURE "@*HN NEVerPendencias - Ver se exitem NFent c status (c) Pendente envio XML" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xpy()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              NOTAENTA/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 3
@ 0,0 GET NEReg_Trans ;
	PICTURE "@*HN NEReg_Trans  - Registra Transito Para Nota de Entrada" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xpz()
@ 1,0 GET NECanc_Trans ;
	PICTURE "@*HN NECanc_Trans  - Cancela Transito Para Nota de Entrada" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xq0()
@ 3,0 GET NEReg_Entrada ;
	PICTURE "@*HN NEReg_Entrada- Processa Entrada de Mercadorias" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xq1()
@ 18,2 GET NEsoma_Saldo ;
	PICTURE "@*HN NEsoma_Saldo- Posiciona Saldo p./ Aoiar Proceso de Entrada" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xq2()
@ 19,2 GET NElocaRegSld ;
	PICTURE "@*HN NElocaRegSld- Checa Item e Apoia Processo de Entrada" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xq3()
@ 21,2 GET NEfatura ;
	PICTURE "@*HN NEfatura- Efetiva Entrada do Item em Apoia Processo de Entrada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xq4()
@ 23,5 GET NEDef_CFO ;
	PICTURE "@*VN NEDef_CFO - Define CFO para Item em Funcao de TP_MERCAD " ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xq5()
@ 45,5 GET NEClcDiretoCusto ;
	PICTURE "@*HN NEClcDiretoCusto - Calc Custo Direto Agregando ao Valor Merc Unit na NFE " ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xqe()
@ 24,5 GET ant0613NEClcICMS ;
	PICTURE "@*HN ant0613NEClcICMS - Calc ICMS no item da NFE" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xqo() ;
	DISABLE
@ 26,5 GET ant0613NEIcmsOper ;
	PICTURE "@*HN ant0613NEIcmsOper - Calc ICMS sobre opercao no item da NFE" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xqx() ;
	DISABLE
@ 27,5 GET ant0613NEBsBrRetido ;
	PICTURE "@*HN ant0613NEBsBrRetido - Calc Base Bruta do ICMS RETIDO" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xr6() ;
	DISABLE
@ 37,5 GET NEBsRetido ;
	PICTURE "@*HN NEBsRetido - Calc Base Normal do ICMS RETIDO" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xsz()
@ 38,5 GET NEClcRetido ;
	PICTURE "@*HN NEClcRetido - Calc ICMS RETIDO no item da NFE" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xt0()
@ 39,5 GET NEBsEntBrRetido ;
	PICTURE "@*HN NEBsEntBrRetido - Calc Base Bruta do ICMS RETIDO na Entrada" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xt1()
@ 40,5 GET NEBsEntRetido ;
	PICTURE "@*HN NEBsEntRetido - Calc Base Normal do ICMS RETIDO na Entrada" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xt2()
@ 41,5 GET NEClcEntRetido ;
	PICTURE "@*HN NEClcEntRetido - Calc ICMS RETIDO no item da NFE na Entrada" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xt3()
@ 46,5 GET NEClcIndiretoCusto ;
	PICTURE "@*HN NEClcIndiretoCusto - Calculo do Custo Indireto Alocado ao Item" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xt4()
@ 48,0 GET NECanc_Entrada ;
	PICTURE "@*HN NECanc_Entrada- Cancela Processo Entrada de Mercadorias" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xt5()
@ 50,2 GET NEDesfatura ;
	PICTURE "@*HN NEDesfatura- Cancela Entrada do Item em Apoia Processo de Entrada" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xtv()
@ 56,0 GET antNEVerifCustoDistocido ;
	PICTURE "@*HN antNEVerifCustoDistocido - Verifica Distorcao entre Custo Atual e Nova Entrada" ;
	SIZE 1,80,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xu4()
@ 57,0 GET NeAjustGru ;
	PICTURE "@*HN NeAjustGrupoNE - Ajuste grupo dene - rotina temporaria" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xud()
@ 58,3 GET NEAjustNE ;
	PICTURE "@*HN NeAjustNE - Ajuste ne - rotina temporaria" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xul()
@ 59,5 GET NEAjustITe ;
	PICTURE "@*HN NEAjustITe- Ajusta Campos Criados Para atender custos" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xum()
@ 22,1 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 47,1 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 44,7 GET antDIConvrtNEDocFiscal ;
	PICTURE "@*HN antDIConvrtNEDocFiscal - Converte um item de NOTA Ent. em item de DOCFISCA" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xun() ;
	DISABLE
@ 25,5 GET xxNEBCIcmsOper ;
	PICTURE "@*HN xxNEBCIcmsOper - Calc base ICMS sobre opercao no item da NFE" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xvj() ;
	DISABLE
@ 12,8 GET NEGeraXML_NOTA ;
	PICTURE "@*HN NEGeraXML_NOTA-Gera XML do DocFiscal ref a NF informada " ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xvs()
@ 13,8 GET NEEnviaNfe_NOTA ;
	PICTURE "@*HN NEEnviaNfe_NOTA-Envia XML do DocFiscal para NFe ref a NF informada " ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xvz()
@ 14,8 GET NERtrnoNfe_NOTA ;
	PICTURE "@*HN NERtrnoNfe_NOTA-Busca retorno NFe do DocFiscal ref a NF informada " ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xw0()
@ 4,3 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 11,8 GET NEDefIDNFDocFiscal ;
	PICTURE "@*HN NEDefIDNFDocFiscal - Gera ID DocFiscal Refente a NOTA ENT informada" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xw1()
@ 8,6 GET NF_CancDFis ;
	PICTURE "@*HN NF_CancDFis - Cancela Documento Fiscal (NF/NFS/NFe/NFSe/CUPOM)" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xw2()
@ 7,6 GET NEDefCancDFis ;
	PICTURE "@*HN NEDefCancDFis - Define Objetivo Canc DFis (ESCRITURACAO/CANCELAMENTO)" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xwz()
@ 6,6 GET NEDefEnvDFis ;
	PICTURE "@*HN NEDefEnvDFis - Define Objetivo Envio DFis (ESCRITURACAO/CANCELAMENTO)" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xx5()
@ 5,3 GET NEEscriturar ;
	PICTURE "@*HN NEEscriturar- Escritura NF Entrada Gerando DFis apos 01/03/2011" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xxc()
@ 9,3 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 2,1 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 15,3 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 10,5 GET NEGeraDFIS ;
	PICTURE "@*HN NEGeraDFIS-Gera Documento fiscal Para nota de Entrada" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xxj()
@ 16,5 GET NEProcEcrtDt ;
	PICTURE "@*HN NEProcEcrtDt - Processa Escrituracao de Saida por Periodo" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xxk()
@ 17,5 GET NEPendEcrtDt ;
	PICTURE "@*HN NEPendEcrtDt - Consulta Pendencias Para Escrituracao de Entrada por Periodo" ;
	SIZE 1,77,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xxl()
@ 34,5 GET NEClcICMS ;
	PICTURE "@*HN NEClcICMS - Calc ICMS no item da NFE" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xya()
@ 42,5 GET NEIcmsOper ;
	PICTURE "@*HN NEIcmsOper - Calc ICMS sobre opercao no item da NFE" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xyi()
@ 36,5 GET NEBsBrRetido ;
	PICTURE "@*HN NEBsBrRetido - Calc Base Bruta do ICMS RETIDO" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xyq()
@ 20,2 GET ant0613NEfatura ;
	PICTURE "@*HN ant0613NEfatura- Efetiva Entrada do Item em Apoia Processo de Entrada" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xz0() ;
	DISABLE
@ 28,5 GET ant0613NEBsRetido ;
	PICTURE "@*HN ant0613NEBsRetido - Calc Base Normal do ICMS RETIDO" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xz1() ;
	DISABLE
@ 29,5 GET antNEClcRetido ;
	PICTURE "@*HN antNEClcRetido - Calc ICMS RETIDO no item da NFE" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xz2() ;
	DISABLE
@ 30,5 GET antNEBsEntBrRetido ;
	PICTURE "@*HN antNEBsEntBrRetido - Calc Base Bruta do ICMS RETIDO na Entrada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8xzs() ;
	DISABLE
@ 31,5 GET antNEBsEntRetido ;
	PICTURE "@*HN antNEBsEntRetido - Calc Base Normal do ICMS RETIDO na Entrada" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8y01() ;
	DISABLE
@ 32,5 GET antNEClcEntRetido ;
	PICTURE "@*HN antNEClcEntRetido - Calc ICMS RETIDO no item da NFE na Entrada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8y0a() ;
	DISABLE
@ 35,5 GET NEBCIcmsOper ;
	PICTURE "@*HN NEBCIcmsOper - Calc base ICMS sobre opercao no item da NFE" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8y0i()
@ 51,1 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 52,0 GET NECalc_Entrada ;
	PICTURE "@*HN NECalc_Entrada- Calcula Entrada de Mercadorias" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8y0j()
@ 53,2 GET NECalcularIt ;
	PICTURE "@*HN NECalcularIt- Efetiva Calculos do Item Entrada do Item em Apoia Processo de Entrada" ;
	SIZE 1,85,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8y0k()
@ 33,5 GET NEClcBCICMS ;
	PICTURE "@*HN NEClcBCICMS - Calc BC ICMS no item da NFE" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8y1i()
@ 49,2 GET NECancRegSld ;
	PICTURE "@*HN NECancRegSld- Checa Item e Apoia cance de Entrada" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _4jv0m8y1r()



READ


#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XD5           IETeste VALID                      º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:    5   º
*       º Variable:            IETeste                            º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      1                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xd5     &&  IETeste VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IETeste
PARAMETERS PrmTeste
	A=IECreate()

	DO CASE
	   CASE UPPER(PrmTeste) = "IEFIND"
		   	=IESetPropVT("EMPRESA", 1)
			=IESetPropVT("FAVORECIDO", 126646)
			=IESetPropVT("ORCAMENTO", 111111)
			=IESetPropVT("ORDEM", 1)
		    =IEFind()
	ENDCASE
	
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XDD           IEVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:    6   º
*       º Variable:            IEVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      2                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xdd     &&  IEVerifyInst VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEVerifyInst
PRIVATE LSpath


	=W_DEFPROC("rotinas.spr")

	IF TYPE("IEDefnPath") = "U" OR EMPTY(IEDefnPath)
		LSpath = UPobterPath("NOTAITE")
	ELSE
		LSpath = IEDefnPath  && QUANDO SE QUER DIRECIONAR O PATH
		                     && INDEPENDENTE DOS PARAMETRO DE
		                     && DIRETORIOS COMUNS
	ENDIF


	IF TYPE("PBNotaIteAlias") = "U" ;
	   		OR EMPTY(PBNotaIteAlias) ;
	   		OR !USED(PBNotaIteAlias)
		=IECreate()
	ELSE
		IF !(LSPath $ DBF(PBNotaIteAlias)) && HOUVE MUDANCA DE DIR BASE
			=IEDestroi()				   && ELIMINA INSTACIA DE OUTRA BASE
			=IECreate()					   && CRIA INSTANCIA NA NOVA BASE
		ENDIF
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XDM           IECreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:    7   º
*       º Variable:            IECreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      3                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xdm     &&  IECreate VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IECreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()

	IF TYPE("PBNotaIteAlias") <> "U" ;
	   		AND !EMPTY(PBNotaIteAlias) ;
	   		AND USED(PBNotaIteAlias)
			RETURN(.T.)
	ENDIF
	

	IF TYPE("IEDefnPath") = "U" OR EMPTY(IEDefnPath)
		LSpath = UPobterPath("NOTAITE")
	ELSE
		LSpath = IEDefnPath  && QUANDO SE QUER DIRECIONAR O PATH
		                     && INDEPENDENTE DOS PARAMETRO DE
		                     && DIRETORIOS COMUNS
	ENDIF



	PUBLIC PBNotaIteAlias

	IF USED("NOTAITE")
	     =NetArqAgain(LSpath+"notaite")
	     PBNotaIteAlias     = Alias()
	ELSE
	     =NetArqAgain(LSpath+"notaite")
	     LSAlsTmp     = Alias()
	
	     =NetArqAgain(LSpath+"notaite")
	     PBNotaIteAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBNotaIteAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTNOTAITE[LMaxDim]
    PUBLIC DIMENSION VDNOTAITE[10,3]			&& VETOR PARA PROPRIEDADES
	*-----------------------------------------------------------*
	=IEReadProperty()
	=IESetDerivadas()   && carga dos calculos derivados
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XDT           IEDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:    8   º
*       º Variable:            IEDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      4                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xdt     &&  IEDestroi VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEDestroi
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBNotaIteAlias) AND USED(PBNotaIteAlias)
		SELECT &PBNotaIteAlias
		USE
	ENDIF	
	RELEASE PBNotaIteAlias
    RELEASE VTNotaIte
    RELEASE VDNotaIte

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XDZ           IEReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:    9   º
*       º Variable:            IEReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      5                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xdz     &&  IEReadProp VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=IEVerifyInst()

	SELE &PBNotaIteAlias
	SCATTER TO VTNotaite
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XE7           IESetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   10   º
*       º Variable:            IESetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      6                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xe7     &&  IESetDerivadas VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IESetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	=IEVerifyInst()
	*--------------------------------------------------------------*

    VDNotaIte(1,1) = UPPER("IEclcIcmSOper")
   	VDNotaIte(1,2) = .F.
   	VDNotaIte(1,3) = .F.

    VDNotaIte(2,1) = "CUSTO"
   	VDNotaIte(2,2) = 0
   	VDNotaIte(2,3) = .F.

    VDNotaIte(3,1) = UPPER("IEcalcIcmNormal")
   	VDNotaIte(3,2) = .F.
   	VDNotaIte(3,3) = .F.

    VDNotaIte(4,1) = UPPER("IEcalcIcmSubs")
   	VDNotaIte(4,2) = .F.
   	VDNotaIte(4,3) = .F.

    VDNotaIte(5,1) = UPPER("IECalcCusto")
   	VDNotaIte(5,2) = .F.
   	VDNotaIte(5,3) = .F.


    VDNotaIte(6,1) = UPPER("VLR_PIS")
   	VDNotaIte(6,2) = 0
   	VDNotaIte(6,3) = .F.

    VDNotaIte(7,1) = UPPER("VLR_COFINS")
   	VDNotaIte(7,2) = 0
   	VDNotaIte(7,3) = .F.

    VDNotaIte(8,1) = UPPER("IECalcPIS")
   	VDNotaIte(8,2) = .F.
   	VDNotaIte(8,3) = .F.

    VDNotaIte(9,1) = UPPER("IECalcCOFINS")
   	VDNotaIte(9,2) = .F.
   	VDNotaIte(9,3) = .F.

	*----------------------------------------------------------------*
	=IECalcIcmNormal()
	=IEclcIcmSOper()
	=IECalcIcmSubs()
	=IECalcPIS()
	=IECalcCOFINS()
	=IECalcCusto()

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XEF           IESetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   11   º
*       º Variable:            IESetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      7                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xef     &&  IESetPropVT VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IESetPropVT
PARAMETER  PrmField, PrmValue

	PRIVATE Lvalue
	=IEVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,PrmValue,;
						    PBNotaIteAlias,VTNotaIte,VDNotaIte)

RETURN(Lvalue)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XEL           IEGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   12   º
*       º Variable:            IEGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      8                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xel     &&  IEGetPropVT VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEGetPropVT
PARAMETER  PrmField
	PRIVATE Lvalue

	=IEVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,PBNotaIteAlias,VTNotaIte,VDNotaIte)

RETURN(Lvalue)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XES           IEChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   13   º
*       º Variable:            IEChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      9                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xes     &&  IEChk_Identidade VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION IEChk_Identidade
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn
	
	=IEVerifyInst()
	*----------------------------------------------------------------*
*	IF ;
*	   !FOUND(PBNotaiteAlias) OR ;
*	   PrmEmp 		 <> IEGetPropVT("EMPRESA") OR ;
*	   PrmBoletim 	 <> IEGetPropVT("ORCAMENTO") OR ;
*	   PrmFavorecido <> IEGetPropVT("FAVORECIDO") OR ;
*	   PrmOrdem   	 <> IEGetPropVT("ORDEM")
	    =IESetPropVT("EMPRESA",PrmEmp)
	    =IESetPropVT("ORCAMENTO",PrmBoletim)
	    =IESetPropVT("FAVORECIDO",PrmFavorecido)
	    =IESetPropVT("ORDEM",PrmOrdem)
		=IEFind()
*	ENDIF
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XEZ           IE_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   14   º
*       º Variable:            IE_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      10                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xez     &&  IE_Refresh VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION IE_Refresh
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn
	
	=IEVerifyInst()
	*----------------------------------------------------------------*
    =IESetPropVT("EMPRESA",PrmEmp)
    =IESetPropVT("ORCAMENTO",PrmBoletim)
    =IESetPropVT("FAVORECIDO",PrmFavorecido)
    =IESetPropVT("ORDEM",PrmOrdem)
	=IEFind()
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XF5           IEFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   15   º
*       º Variable:            IEFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      11                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xf5     &&  IEFind VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEFind
	PRIVATE LEmpresa, Lfavorecido, Lorcamento, Lordem
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=IEVerifyInst()

	LEmpresa    = IEGetPropVT("Empresa")
	Lfavorecido = IEGetPropVT("Favorecido")
	LOrcamento  = IEGetPropVT("Orcamento")
	LOrdem      = IEGetPropVT("Ordem")



	SELE &PBNotaIteAlias
	SET ORDER TO TAG CHV_BKP
	SEEK STR(LEmpresa,3)+STR(LFavorecido,14)+STR(Lorcamento,6)+STR(Lordem,3)

	IF FOUND()
		=IEReadProperty()
		=IESetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XGU           IEComandText VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   16   º
*       º Variable:            IEComandText                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      12                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xgu     &&  IEComandText VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEComandText
PARAMETER PrmCommand

	PRIVATE LSalias
	LSalias		= 	ALIAS()
	=IEVerifyInst()
	*--------------------------------------------------------------*
	
	&PrmCommand

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XGV           IECheq_Relacao VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   17   º
*       º Variable:            IECheq_Relacao                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      13                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xgv     &&  IECheq_Relacao VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IECheq_Relacao

	PRIVATE Lempresa,Lfavorecido,Lorcamento
	PRIVATE Lretorno
	=W_DEFPROC("NOTAENT.spr")
	Lempresa    = NEGetPropVT("EMPRESA")

	=W_DEFPROC("NOTAENT.spr")
	Lfavorecido = NEGetPropVT("FAVORECIDO")

	=W_DEFPROC("NOTAENT.spr")
	Lorcamento  = NEGetPropVT("REFERENCIA")

	Lretorno = .t.
   	IF    Lempresa <> IEGetPropVT("EMPRESA") ;
   	   OR Lfavorecido <> IEGetPropVT("FAVORECIDO") ;
	   OR Lorcamento <>	IESetPropVT("ORCAMENTO")
		Lretorno = .f.
	endif
	
RETURN(Lretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XGW           IEcalcicmNormal VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   18   º
*       º Variable:            IEcalcicmNormal                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      14                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xgw     &&  IEcalcicmNormal VALID
#REGION 1
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION Ubsicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula a Base ICMS NORMAL no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION IECalcIcmNormal

	IF IEGetPropVT("IECalcIcmNormal")  && rotina ja executada
		RETURN
	ENDIF	
	*-------------------------------------------------------------------*						

	PRIVATE  	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn,;
				LNbsbr_Icms,;
				LNaliq_Rdu,;
				LNbase_Icms,;
				LNicms,;
				LNbsbr_SOIcms,;
				LNbase_SOIcms,;
				LNSOicms

	PRIVATE  LPrmEmpresa
	PRIVATE  LPrmBoletim
	PRIVATE  LPrmForn
	PRIVATE  LNBCIcmsCapa				
	PRIVATE  LNIcmsCapa				


	PRIVATE  LNPrdtOrigem



	PRIVATE LDdata
	PRIVATE LSufOrigem
	PRIVATE LSufDestino
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples
	PRIVATE LSch_desti

	PRIVATE LNIcmsRtdCapa

	LNbsbr_Icms		= 0.00
	LNbase_Icms		= 0.00
	LNicms			= 0.00
	LNaliq_Rdu      = 100
	LNIcmsRtdCapa   = 0

	LNBCIcmsCapa    = 0				
	LNIcmsCapa      = 0	


				
	LSProduto       = IEGetPropVT("CODIGO")

    LNPrdtOrigem    = IEGetPropVT("ORIGEM")

	LDdata           = IEGetPropVT("DATA")
	LNvlrMercadoria  = IEGetPropVT("VLRVENDA")
	LNvlrIPI		 = IEGetPropVT("VLRIPI")
	LNcdg_Forn  	 = IEGetPropVT("CODFORN")
	LSch_desti  	 = IEGetPropVT("CH_DESTI")

	LPrmEmpresa		= IEGetPropVT("EMPRESA")
	LPrmBoletim		= IEGetPropVT("ORCAMENTO")



	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)



	=W_DEFPROC("notaent.spr")
	LNIcmsCapa = ;
		 NEGetFieldValue(LPrmEmpresa,LPrmBoletim,LNcdg_Forn,"VLR_ICMS")


	=W_DEFPROC("notaent.spr")
	LNBCIcmsCapa = ;
		 NEGetFieldValue(LPrmEmpresa,LPrmBoletim,LNcdg_Forn,"BASE_ICMS")

    *----------------------------------------------*
    * REGRA INSERIDA EM 29/11/2011 - TRATAR ICMS RETIDO PARA DEF ICMS NORMAL
    *----------------------------------------------*
	=W_DEFPROC("notaent.spr")
	LNIcmsRtdCapa = ;
		 NEGetFieldValue(LPrmEmpresa,LPrmBoletim,LNcdg_Forn,"ICMS_SUBS")

	*--------------------------------------------------------*
	=W_DEFPROC("forneced.spr")
	LNRgFiscFornecedor = FRrgm_Fisc(LNcdg_Forn)


	DO CASE

		CASE LSch_desti   = "3" && INTERNACIONAL
			=W_DEFPROC("tributar.spr")
			LNicmsOrigem    =	TRAlqIcmInUF(LSufDestino) && Aliq Interna
		
    	CASE LSufOrigem = LSufDestino
			=W_DEFPROC("tributar.spr")
			LNicmsOrigem    =	TRAlqIcmInUF(LSufOrigem) && Aliquota Interna
    	OTHERWISE
			=W_DEFPROC("tributar.spr")
			LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem, LNPrdtOrigem)
			                         && Aliquota Externa
	ENDCASE




	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbOrigem=TRDef_RgTrbMercad(LSufOrigem, LSproduto)

	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbDestino=TRDef_RgTrbMercad(LSufDestino, LSproduto)



	*----------------------------------------------------------*
	*                  COMPOSICAO DA REGRA                     *
	*----------------------------------------------------------*

    *----------------------------------------------------------*
    * REGRA APLICADA ANTES DE 12/05/2005
    * Alterada em fun‡Æo da informa‡Æo dos indices de redu‡Æo
    * no proprio corpo na NFE em fun‡Æo de acordos TARE
    *----------------------------------------------------------*
	

    *----------------------------------------------------------*
    * REGRA APLICADA APOS 12/05/2005
    * Alterada em fun‡Æo da informa‡Æo dos indices de redu‡Æo
    * no proprio corpo na NFE em fun‡Æo de acordos TARE
    *----------------------------------------------------------*


	LNbsbr_Icms = IEGetPropVT("BSBR_ICMS")

 	LNbase_Icms = IEGetPropVT("BASE_CALC")

	LNaliq_Rdu = IEGetPropVT("ALIQ_RDU")
    *----------------------------------------------------------*
*	IF LNRgTrbDestino = 1 AND LNRgFiscFornecedor = 0  && ICMS NORMAL

	IF LNIcmsCapa > 0 OR LNBCIcmsCapa > 0 OR LNIcmsRtdCapa > 0

	    LNicms = 0.00
    	LNicms =  LNbase_Icms * LNicmsOrigem/100
		*---> Define Icms Sobre Normal
	    LNicms =  LNbase_Icms * LNicmsOrigem/100

	ENDIF



	=IESetPropVT("BSBR_ICMS",LNbsbr_Icms)
	=IESetPropVT("ALIQ_RDU",LNaliq_Rdu)
	=IESetPropVT("BASE_CALC",LNbase_Icms)
	=IESetPropVT("VLR_ICMS", LNicms)
	=IESetPropVT("ALIQ_ICMS",LNicmsOrigem)


	=IESetPropVT("BSBRICMSO",LNbsbr_Icms)
	=IESetPropVT("BASEICMSO",LNbase_Icms)



    *----------------------------------------------------------*
    * REGRA APLICADA APOS 29/11/2011
    * Substituicao da regra que restringe por fornecedor por
    * regra geral que atende todas notas -
    *----------------------------------------------------------*
	*IF LNIcmsCapa > 0 AND ;
	*   ( LNcdg_Forn = 1 OR  LNcdg_Forn = 2 OR LNRgTrbDestino = 8)
    *----------------------------------------------------------*
*	IF LNIcmsRtdCapa > 0
*		=IESetPropVT("BSBRICMSO",LNbsbr_Icms)
*		=IESetPropVT("ALIQ_RDU",LNaliq_Rdu)
*		=IESetPropVT("BASEICMSO",LNbase_Icms)
*		=IESetPropVT("ICMSSOPER", LNicms)
*		=IESetPropVT("ALIQ_ICMS",LNicmsOrigem)
*
*
*		=IESetPropVT("BSBR_ICMS",0.00)
*		=IESetPropVT("BASE_CALC",0.00)
*		=IESetPropVT("VLR_ICMS", 0.00)
*
*	ELSE
		=IESetPropVT("BSBR_ICMS",LNbsbr_Icms)
		=IESetPropVT("ALIQ_RDU",LNaliq_Rdu)
		=IESetPropVT("BASE_CALC",LNbase_Icms)
		=IESetPropVT("VLR_ICMS", LNicms)
		=IESetPropVT("ALIQ_ICMS",LNicmsOrigem)

*	ENDIF	
	*----------------------------------------------------------------*
	=IESetPropVT("IECalcIcmNormal",.T.)  && rotina com valores atuais
RETURN(LNbase_Icms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XGX           IEclcIcmSOper VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   19   º
*       º Variable:            IEclcIcmSOper                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      15                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xgx     &&  IEclcIcmSOper VALID
#REGION 1
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION Ubsicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula a Base ICMS SOBRE OPERACAO no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION IEclcIcmSOper

	IF IEGetPropVT("IEclcIcmSOper")  && rotina ja executada
		RETURN
	ENDIF	
	*-------------------------------------------------------------------*						

	PRIVATE  	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn,;
				LNbsbr_Icms,;
				LNaliq_Rdu,;
				LNbase_Icms,;
				LNicms,;
				LNbsbr_SOIcms,;
				LNbase_SOIcms,;
				LNSOicms

	PRIVATE  LPrmEmpresa
	PRIVATE  LPrmBoletim
	PRIVATE  LPrmForn
	PRIVATE  LNIcmsSoCapa				
	PRIVATE  LNIcmsCapa				
	PRIVATE  LNBCIcmsCapa				

	PRIVATE  LNPrdtOrigem


	PRIVATE LDdata
	PRIVATE LSufOrigem
	PRIVATE LSufDestino
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples


	PRIVATE LNIcmsRtdCapa

	LNbsbr_SOIcms   = 0.00
	LNbase_SOIcms   = 0.00
	LNSOicms        = 0.00
	LNIcmsRtdCapa   = 0
	LNIcmsCapa	    = 0
	LNBCIcmsCapa    = 0
	

				
	LSProduto  = IEGetPropVT("CODIGO")
	
    LNPrdtOrigem    = IEGetPropVT("ORIGEM")
	

	LDdata           = IEGetPropVT("DATA")
	LNvlrMercadoria  = IEGetPropVT("VLRVENDA")
	LNvlrIPI		 = IEGetPropVT("VLRIPI")
	LNcdg_Forn  	 = IEGetPropVT("CODFORN")

	LPrmEmpresa		= IEGetPropVT("EMPRESA")
	LPrmBoletim		= IEGetPropVT("ORCAMENTO")


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)

	*--------------------------------------------------------*
	=W_DEFPROC("forneced.spr")
	LNRgFiscFornecedor = FRrgm_Fisc(LNcdg_Forn)



	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbOrigem=TRDef_RgTrbMercad(LSufOrigem, LSproduto)

	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbDestino=TRDef_RgTrbMercad(LSufDestino, LSproduto)


	DO CASE
    	CASE LNRgTrbDestino = 8  && IMPORTADA
			=W_DEFPROC("tributar.spr")
			LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) && Aliquota Interna
    	CASE LSufOrigem = LSufDestino
			=W_DEFPROC("tributar.spr")
			LNicmsOrigem    =	TRAlqIcmInUF(LSufOrigem) && Aliquota Interna
		OTHERWISE
			=W_DEFPROC("tributar.spr")
			LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem, LNPrdtOrigem)
			                  && Aliquota Externa
    ENDCASE


	=W_DEFPROC("notaent.spr")
	LNIcmsCapa = ;
		 NEGetFieldValue(LPrmEmpresa,LPrmBoletim,LNcdg_Forn,"VLR_ICMS")

	=W_DEFPROC("notaent.spr")
	LNIcmsSoCapa = ;
		 NEGetFieldValue(LPrmEmpresa,LPrmBoletim,LNcdg_Forn,"ICMSSOPER")



    *----------------------------------------------*
    * REGRA INSERIDA EM 29/11/2011 - TRATAR ICMS RETIDO PARA DEF ICMS NORMAL
    *----------------------------------------------*
	=W_DEFPROC("notaent.spr")
	LNIcmsRtdCapa = ;
		 NEGetFieldValue(LPrmEmpresa,LPrmBoletim,LNcdg_Forn,"ICMS_SUBS")



	*----------------------------------------------------------*
	*                  COMPOSICAO DA REGRA                     *
	*----------------------------------------------------------*

    *----------------------------------------------------------*
    * REGRA APLICADA ANTES DE 12/05/2005
    * Alterada em fun‡Æo da informa‡Æo dos indices de redu‡Æo
    * no proprio corpo na NFE em fun‡Æo de acordos TARE
    *----------------------------------------------------------*
	

    *----------------------------------------------------------*
    * REGRA APLICADA APOS 12/05/2005
    * Alterada em fun‡Æo da informa‡Æo dos indices de redu‡Æo
    * no proprio corpo na NFE em fun‡Æo de acordos TARE
    *----------------------------------------------------------*


	LNbsbr_SOIcms = IEGetPropVT("BSBRICMSO")

 	LNbase_SOIcms = IEGetPropVT("BASEICMSO")

	LNaliq_Rdu = IEGetPropVT("ALIQ_RDU")
    *----------------------------------------------------------*

    *----------------------------------------------------------*
    * REGRA APLICADA APOS 29/11/2011
    * Substituicao da regra que restringe por fornecedor por
    * regra geral que atende todas notas -
    *----------------------------------------------------------*
	*IF LNIcmsCapa > 0 AND ;
	*   ( LNcdg_Forn = 1 OR  LNcdg_Forn = 2 OR LNRgTrbDestino = 8)
    *----------------------------------------------------------*
	*IF LNIcmsRtdCapa > 0
	*	LNSOicms = IEGetPropVT("ICMSSOPER")
	*ELSE
	*	IF LNIcmsSoCapa > 0
	*	    LNSOicms = 0.00
    *		LNSOicms =  LNbase_SOIcms * LNicmsOrigem/100
	*	ENDIF
	*ENDIF
    *----------------------------------------------------------*


	IF LNIcmsRtdCapa > 0
	    LNSOicms = 0.00
   		LNSOicms =  LNbase_SOIcms * LNicmsOrigem/100
	ENDIF

	=IESetPropVT("ICMSSOPER",LNSOicms)

	*----------------------------------------------------------------*

	=IESetPropVT("IEclcIcmSOper",.T.)  && rotina com valores atuais

RETURN(LNSOicms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XGY           IEcalcIcmSubs VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   20   º
*       º Variable:            IEcalcIcmSubs                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      16                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xgy     &&  IEcalcIcmSubs VALID
#REGION 1
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION IECalcIcmSubs
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula a Base ICMS Retido no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION IECalcIcmSubs
	IF IEGetPropVT("IECalcIcmSubs")  && rotina ja executada
		RETURN
	ENDIF	
	*----------------------------------------------------------------*
	
	PRIVATE  	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn,;
				LNbsbr_Icms,;
				LNaliq_Rdu,;
				LNbase_Icms,;
				LNicms,;
				LNbsbr_SOIcms,;
				LNbase_SOIcms,;
				LNicmsSO,;
				LNbsbr_Retido,;
				LNbase_Retido,;
				LNiva,;
				LNicmsRtdSaida,;
				LNicmsRtdEntrada


	PRIVATE  LNPrdtOrigem



	PRIVATE LDdata
	PRIVATE LSufOrigem
	PRIVATE LSufDestino
	PRIVATE LNRetidoDestacado
	PRIVATE LNicmsDestino
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples

				
	LSProduto  = IEGetPropVT("CODIGO")

    LNPrdtOrigem    = IEGetPropVT("ORIGEM")


	LDdata           = IEGetPropVT("DATA")
	LNvlrMercadoria  = IEGetPropVT("VLRVENDA")
	LNvlrIPI		 = IEGetPropVT("VLRIPI")
	LNcdg_Forn  	 = IEGetPropVT("CODFORN")


	LNicms		  	 = IEGetPropVT("VLR_ICMS")


	LNbsbr_SOIcms    = IEGetPropVT("BSBRICMSO")
	LNbase_SOIcms    = IEGetPropVT("BASEICMSO")
	LNicmsSO	  	 = IEGetPropVT("ICMSSOPER")



	LPrmEmpresa		= IEGetPropVT("EMPRESA")
	LPrmBoletim		= IEGetPropVT("ORCAMENTO")

	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)


	=W_DEFPROC("notaent.spr")
	LNRetidoDestacado = ;
	    NEGetRetidoDestacado(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)
	*-----------------------------------------------------------------*

	=W_DEFPROC("tributar.spr")
	LNicmsOrigem	=	TRAlqIcmOuUF(LSufOrigem, LNPrdtOrigem) &&


	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmInUF(LSufDestino) &&


	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbOrigem=TRDef_RgTrbMercad(LSufOrigem, LSproduto)


	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbDestino=TRDef_RgTrbMercad(LSufDestino, LSproduto)



	=W_DEFPROC("TRIBUTAR.spr")
	LNiva= TRGet_IVA(LSufOrigem,LSproduto,LSufDestino,LDdata )


	LNbsbr_Icms = 	IEGetPropVT("BSBR_ICMS")

	*----------------------------------------------------------*
	*                  COMPOSICAO DA REGRA                     *
	*----------------------------------------------------------*
	LNbsbr_Retido   	= IEGetPropVT("BASE_SBBRT")
	LNbase_Retido   	= IEGetPropVT("BASE_SUBS")
	LNbsbrEntRetido   	= IEGetPropVT("BSENTSBBRT")
	LNbaseEntRetido   	= IEGetPropVT("BSENTSUBS")

	LNicmsRtdSaida		= 0.00
	LNicmsRtdEntrada	= 0.00


	*--------------------------------------------------------------*
	*--------------  CALCULO DO ICMS RETIDO NA SAIDA --------------*
	*--------------------------------------------------------------*



	*--------------------------------------------------------------*
	*--------------  CALCULO DO ICMS RETIDO NA SAIDA --------------*
	*--------------------------------------------------------------*

	DO CASE
		CASE LNRgTrbOrigem = 8 && IMPORTADA COM RETENCAO

			  		LNicmsRtdSaida =  ;
	  			       (LNbase_Retido * LNicmsDestino/100) ;
	  			       - LNicms && - LNicmsSO

		CASE LNRgTrbOrigem = 2 ;
			     AND  LNRgTrbDestino = 2  && RETIDO NA SAIDA


                   DO CASE

                      CASE LSufDestino = "MT" AND LNcdg_Forn = 1

			  		       LNicmsRtdSaida =  ;
	  			               (LNbase_Retido * 15/100)

                      OTHERWISE

			  		     LNicmsRtdSaida =  ;
	  			           (LNbase_Retido * LNicmsDestino/100) ;
	  			           - LNicms && - LNicmsSO


                   ENDCASE


		CASE LNRgTrbOrigem = 1 ;
			     AND  LNRgTrbDestino = 2  && RETIDO NA ENTRADA

                  DO CASE
                      CASE LSufDestino = "MT" AND LNcdg_Forn = 1

		  			       LNicmsRtdEntrada = ;
	  		                (LNbaseEntRetido * 15/100)

                      OTHERWISE

		  			       LNicmsRtdEntrada = ;
	  		                (LNbaseEntRetido * LNicmsDestino/100) ;
	  		                 - LNicms  && - LNicmsSO
	  		      ENDCASE
	  		
	  		

	ENDCASE




	IF LNicmsRtdSaida > 0.00
		=IESetPropVT("BASE_SBBRT",LNbsbr_Retido)
		=IESetPropVT("BASE_SUBS",LNbase_Retido)
		=IESetPropVT("ICMS_SUBS",LNicmsRtdSaida)

		=IESetPropVT("BSENTSBBRT",0.00)
		=IESetPropVT("BSENTSUBS",0.00)
		=IESetPropVT("ICMSENTSUB",0.00)


	ELSE
		=IESetPropVT("BASE_SBBRT",0.00)
		=IESetPropVT("BASE_SUBS",0.00)
		=IESetPropVT("ICMS_SUBS",0.00)


		=IESetPropVT("BSENTSBBRT",LNbsbrEntRetido)
		=IESetPropVT("BSENTSUBS",LNbaseEntRetido)
		=IESetPropVT("ICMSENTSUB",LNicmsRtdEntrada)
	ENDIF

	*----------------------------------------------------------------*
	=IESetPropVT("IECalcIcmSubs",.T.)  && rotina com valores atuais


RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XGZ           IECalcCusto VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   21   º
*       º Variable:            IECalcCusto                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      17                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xgz     &&  IECalcCusto VALID
#REGION 1
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION IECalcCusto
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula o Custo do Produto na Operacao
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION IECalcCusto
	IF IEGetPropVT("IECalcCusto")  && rotina ja executada
		RETURN
	ENDIF	
	*----------------------------------------------------------------*


	PRIVATE  	LDdata,;
				LNEmpresa,;
				LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNicms,;
				LNicmsSobreOperacao,;
				LNCusto_Ind,;
				LNicmsRtdSaida,;
				LNicmsRtdEntrada,;
				LNcusto,;
				LNtp_Mercard,;
				LNvlrPIS,;
				LNvlrCOFINS
				

	LDdata	   	 	    = IEGetPropVT("DATA")
	LNEmpresa		 	= IEGetPropVT("EMPRESA")
	LNvlrMercadoria  	= IEGetPropVT("VLRVENDA")
	LNvlrIPI		 	= IEGetPropVT("VLRIPI")
	LNicms		  	 	= IEGetPropVT("VLR_ICMS")
	LNicmsSobreOperacao	= IEGetPropVT("ICMSSOPER")
	LNCusto_Ind  	 	= IEGetPropVT("CUSTO_IND")
	LNicmsRtdSaida   	= IEGetPropVT("ICMS_SUBS")
    LNicmsRtdEntrada 	= IEGetPropVT("ICMSENTSUB")
    LNtp_Mercad      	= IEGetPropVT("TP_MERCAD")


	IF LNEmpresa = 10  AND LDdata >= CTOD("01.11.2007") ;
	    AND (LNtp_Mercad = 3 OR LNtp_Mercad = 7)
		LNvlrPIS		 	= IEGetPropVT("VLR_PIS")
		LNvlrCOFINS		 	= IEGetPropVT("VLR_COFINS")
	ELSE
		LNvlrPIS		 	= 0
		LNvlrCOFINS		 	= 0
	ENDIF
	

	LNcusto=IEformulaCusto(LNvlrMercadoria,;
						   LNvlrIPI,;
						   LNicms,;
						   LNicmsSobreOperacao,;
						   LNCusto_Ind,;
						   LNicmsRtdSaida,;
						   LNicmsRtdEntrada, ;
						   LNtp_Mercad,;
						   LNvlrPIS,;
						   LNvlrCOFINS)
	
	=IESetPropVT("CUSTO",LNcusto)

	*----------------------------------------------------------------*
	=IESetPropVT("IECalcCusto",.T.)  && rotina com valores atuais

RETURN


FUNCTION IFformulaCusto
PARAMETERS	LNvlrMercadoria,LNvlrIPI,LNicms,LNicmsSobreOperacao,;
	  LNCusto_Ind,LNicmsRtdSaida,LNicmsRtdEntrada, LNtp_Mercad ,;
	   LNvlrPIS, LNvlrCOFINS

	PRIVATE LNcusto

	DO CASE

		CASE  LNtp_Mercad = 8   && IMPORTADA COM RETENCAO TRIBUTADA
			
			LNcusto = LNvlrMercadoria + LNCusto_Ind+;
				 LNicmsRtdEntrada + LNicmsRtdSaida

		CASE  LNtp_Mercad = 1   && TRIBUTADA
			LNcusto = LNvlrMercadoria + LNvlrIPI + LNCusto_Ind+;
				 LNicmsRtdEntrada + LNicmsRtdSaida - LNicms

		OTHERWISE
			LNcusto = LNvlrMercadoria + LNvlrIPI + LNCusto_Ind+;
				 LNicmsRtdEntrada + LNicmsRtdSaida	

	ENDCASE

	LNcusto = LNcusto - (LNvlrPIS + LNvlrCOFINS)

RETURN(LNcusto)

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XH0           IEGetCusto VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   22   º
*       º Variable:            IEGetCusto                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      18                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xh0     &&  IEGetCusto VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEGetCusto
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn
	*----------------------------------------------------------------*
	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IECalcCusto")  && rotina nao esta executada
		=IECalcCusto()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("CUSTO"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XID           IEGetBaseCalc VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   23   º
*       º Variable:            IEGetBaseCalc                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      19                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xid     &&  IEGetBaseCalc VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEGetBaseCalc
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn
	*----------------------------------------------------------------*
	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmNormal")  && rotina nao esta executada
		=IEcalcIcmNormal()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("BASE_CALC"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XIE           IEGetBsIcmSO VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   24   º
*       º Variable:            IEGetBsIcmSO                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      20                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xie     &&  IEGetBsIcmSO VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEGetBsIcmSO
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmNormal")  && rotina nao esta executada
		=IEcalcIcmNormal()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("BASEICMSO"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XIF           IEGetBsSbBrt VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   25   º
*       º Variable:            IEGetBsSbBrt                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      21                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xif     &&  IEGetBsSbBrt VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEGetBsSbBrt
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmSubs")  && rotina nao esta executada
		=IEcalcIcmSubs()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("BASE_SBBRT"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XIG           IEGetBsSubs VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   26   º
*       º Variable:            IEGetBsSubs                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      22                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xig     &&  IEGetBsSubs VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEGetBsSubs
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmSubs")  && rotina nao esta executada
		=IEcalcIcmSubs()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("BASE_SUBS"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XIH           IERtdoSaida VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   27   º
*       º Variable:            IERtdoSaida                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      23                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xih     &&  IERtdoSaida VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IERtdoSaida
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmSubs")  && rotina nao esta executada
		=IEcalcIcmSubs()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("ICMS_SUBS"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XII           IERtdoEntrada VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   28   º
*       º Variable:            IERtdoEntrada                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      24                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xii     &&  IERtdoEntrada VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IERtdoEntrada
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmSubs")  && rotina nao esta executada
		=IEcalcIcmSubs()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("ICMSENTSUB"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XIJ           IEicmNormal VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   29   º
*       º Variable:            IEicmNormal                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      25                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xij     &&  IEicmNormal VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEicmNormal
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmNormal")  && rotina nao esta executada
		=IEcalcIcmNormal()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("VLR_ICMS"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XIK           IEicmsSO VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   30   º
*       º Variable:            IEicmsSO                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      26                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xik     &&  IEicmsSO VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEicmsSO
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmNormal")  && rotina nao esta executada
		=IEcalcIcmNormal()
	ENDIF	


	IF !IEGetPropVT("IEclcIcmSOper")  && rotina nao esta executada
		=IEclcIcmSOper()
	ENDIF	

	*----------------------------------------------------------------*


RETURN(IEGetPropVT("ICMSSOPER"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XIL           IEGetIPI VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   31   º
*       º Variable:            IEGetIPI                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      27                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xil     &&  IEGetIPI VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEGetIPI
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	*----------------------------------------------------------------*

RETURN(IEGetPropVT("VLRIPI"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XIM           IEVerifCustoDistocido VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   32   º
*       º Variable:            IEVerifCustoDistocido              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      28                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xim     &&  IEVerifCustoDistocido VALID
#REGION 1
return

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Verificar distorcao entre custo atual
	*    registrado no sistema e custo que esta sendo informado
	*------------------------------------------------------------*
	* COMENTARIO..: A rotina permite detectar erros no lancamento
	*               como codigo e ou valores errados
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*

FUNCTION IEVerifCustoDistocido
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem

	PRIVATE LFreturn
	PRIVATE LNCustoEntrada		&& Custo na entrada
	PRIVATE LDdtCusto
	PRIVATE LNAtualCusto		&& Custo no estoque atual
	PRIVATE LSCodigo
	PRIVATE LNDeltaCusto
	PRIVATE LNPercentual

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IECalcCusto")  && rotina nao esta executada
		=IECalcCusto()
	ENDIF	

	LDdtCusto 		= IEGetPropVT("DATA")
	LSCodigo        = IEGetPropVT("CODIGO")	

	=W_DEFPROC("estoque.spr")
	LNAtualCusto = EScustoMedio(PrmEmp,LSCodigo ,LDdtCusto)


	LNCustoEntrada = (IEGetCusto(PrmEmp, PrmFavorecido, ;
				PrmBoletim, PrmOrdem)) / IEGetPropVT("QTDE")


	*--------------------------------------------------------------*
	LNDeltaCusto = abs(LNCustoEntrada - LNAtualCusto)
	LNPercentual = int((LNDeltaCusto/LNAtualCusto)*100)	

	IF LNPercentual > 10
		IF LNDeltaCusto	< 0
			LNPercentual = LNPercentual * -1
		ENDIF
		LSmsg = "Atencao : Variacao de Custo na Ordem de : "+;
				STR(LNPercentual,6)+" % "+;
				" Codigo : "+LSCodigo+chr(13)+;
				" Custo Registrado = "+STR(LNAtualCusto,10,2)+chr(13)+;
				" Custo Neste Doc  = "+STR(LNCustoEntrada,10,2)
				
		=fox_alert(LSmsg,.t.)
	ENDIF
	*--------------------------------------------------------------*
	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XIU           IEDisplCusto VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   33   º
*       º Variable:            IEDisplCusto                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      29                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xiu     &&  IEDisplCusto VALID
#REGION 1
return

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Verificar distorcao entre custo atual
	*    registrado no sistema e custo que esta sendo informado
	*------------------------------------------------------------*
	* COMENTARIO..: A rotina permite detectar erros no lancamento
	*               como codigo e ou valores errados
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*

FUNCTION IEDisplCusto
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem

	PRIVATE LFreturn
	PRIVATE LNCustoEntrada		&& Custo na entrada
	PRIVATE LDdtCusto
	PRIVATE LNAtualCusto		&& Custo no estoque atual
	PRIVATE LSCodigo
	PRIVATE LNDeltaCusto
	PRIVATE LNPercentual


	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IECalcCusto")  && rotina nao esta executada
		=IECalcCusto()
	ENDIF	

	LDdtCusto 		= IEGetPropVT("DATA")
	LSCodigo        = IEGetPropVT("CODIGO")	

	=W_DEFPROC("estoque.spr")
	LNAtualCusto = EScustoMedio(PrmEmp,LSCodigo ,LDdtCusto)


	LNCustoEntrada = (IEGetCusto(PrmEmp, PrmFavorecido, ;
				PrmBoletim, PrmOrdem)) / IEGetPropVT("QTDE")


	*--------------------------------------------------------------*
	LNDeltaCusto = abs(LNCustoEntrada - LNAtualCusto)
	LNPercentual = int((LNDeltaCusto/LNAtualCusto)*100)	

		IF LNDeltaCusto	< 0
			LNPercentual = LNPercentual * -1
		ENDIF
		LSmsg = "Atencao : Variacao de Custo na Ordem de : "+;
				STR(LNPercentual,6)+" % "+;
				" Codigo : "+LSCodigo+chr(13)+;
				" Custo Registrado = "+STR(LNAtualCusto,10,2)+chr(13)+;
				" Custo Neste Doc  = "+STR(LNCustoEntrada,10,2)
				
		=fox_alert(LSmsg,.t.)
	*--------------------------------------------------------------*
	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XJ1           IEExtrato VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   34   º
*       º Variable:            IEExtrato                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      30                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4jv0m8xj1     &&  IEExtrato VALID
#REGION 1
RETURN

FUNCTION IEExtrato
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Notaite,ALS_Notaite
	PRIVATE ARQ_Tmp,ALS_Tmp
	store "" to ARQ_tmp,ALS_tmp



	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*

	IF  PrmEmpresa <> wp_cod_loja
		LSbase = wp_dircentral
	ELSE
		LSbase = wp_dirdat
	ENDIF

	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Notaite     = NetArqAgain(LSbase+"NOTAITE")
    ALS_Notaite     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Notaite
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	ALS_tmp = ALIAS()

	SELECT  data, ;
			hora,nota,operacao,tipo,qtde,(vlrvenda/QTDE) AS VALOR_UNI,situacao;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF

	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			NOTA			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			SITUACAO 	:H="STAT" :R;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Notaite")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XJ9           AIEcalcIcmSubs VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   35   º
*       º Variable:            AIEcalcIcmSubs                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      31                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xj9     &&  AIEcalcIcmSubs VALID
#REGION 1
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION IECalcIcmSubs
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula a Base ICMS Retido no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION AIECalcIcmSubs
	IF IEGetPropVT("IECalcIcmSubs")  && rotina ja executada
		RETURN
	ENDIF	
	*----------------------------------------------------------------*
	
	PRIVATE  	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn,;
				LNbsbr_Icms,;
				LNaliq_Rdu,;
				LNbase_Icms,;
				LNicms,;
				LNbsbr_SOIcms,;
				LNbase_SOIcms,;
				LNicmsSO,;
				LNbsbr_Retido,;
				LNbase_Retido,;
				LNiva,;
				LNicmsRtdSaida,;
				LNicmsRtdEntrada


	PRIVATE LDdata
	PRIVATE LSufOrigem
	PRIVATE LSufDestino
	PRIVATE LNRetidoDestacado
	PRIVATE LNicmsDestino
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples

				
	LSProduto  = IEGetPropVT("CODIGO")


	LDdata           = IEGetPropVT("DATA")
	LNvlrMercadoria  = IEGetPropVT("VLRVENDA")
	LNvlrIPI		 = IEGetPropVT("VLRIPI")
	LNcdg_Forn  	 = IEGetPropVT("CODFORN")


	LNicms		  	 = IEGetPropVT("VLR_ICMS")


	LNbsbr_SOIcms    = IEGetPropVT("BSBRICMSO")
	LNbase_SOIcms    = IEGetPropVT("BASEICMSO")
	LNicmsSO	  	 = IEGetPropVT("ICMSSOPER")



	LPrmEmpresa		= IEGetPropVT("EMPRESA")
	LPrmBoletim		= IEGetPropVT("ORCAMENTO")

	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)


	=W_DEFPROC("notaent.spr")
	LNRetidoDestacado = ;
	    NEGetRetidoDestacado(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)
	*-----------------------------------------------------------------*

	=W_DEFPROC("tributar.spr")
	LNicmsOrigem	=	TRAlqIcmouOuUF(LSufOrigem) &&


	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmouInUF(LSufDestino) &&


	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbOrigem=TRDef_RgTrbMercad(LSufOrigem, LSproduto)


	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbDestino=TRDef_RgTrbMercad(LSufDestino, LSproduto)



	=W_DEFPROC("TRIBUTAR.spr")
	LNiva= TRGet_IVA(LSufOrigem,LSproduto)


	LNbsbr_Icms = 	IEGetPropVT("BSBR_ICMS")

	*----------------------------------------------------------*
	*                  COMPOSICAO DA REGRA                     *
	*----------------------------------------------------------*
	LNbsbr_Retido   	= IEGetPropVT("BASE_SBBRT")
	LNbase_Retido   	= IEGetPropVT("BASE_SUBS")
	LNbsbrEntRetido   	= IEGetPropVT("BSENTSBBRT")
	LNbaseEntRetido   	= IEGetPropVT("BSENTSUBS")

	LNicmsRtdSaida		= 0.00
	LNicmsRtdEntrada	= 0.00

	*--------------------------------------------------------------*
	*--------------  CALCULO DO ICMS RETIDO NA SAIDA --------------*
	*--------------------------------------------------------------*



	*--------------------------------------------------------------*
	*--------------  CALCULO DO ICMS RETIDO NA SAIDA --------------*
	*--------------------------------------------------------------*

	DO CASE
		CASE LNRgTrbOrigem = 8 && IMPORTADA COM RETENCAO

			  		LNicmsRtdSaida =  ;
	  			       (LNbase_Retido * LNicmsOrigem/100) ;
	  			       - LNicms - LNicmsSO

		CASE LNRgTrbOrigem = 2 ;
			     AND  LNRgTrbDestino = 2  && RETIDO NA SAIDA

			  		LNicmsRtdSaida =  ;
	  			       (LNbase_Retido * LNicmsDestino/100) ;
	  			       - LNicms - LNicmsSO

		CASE LNRgTrbOrigem = 1 ;
			     AND  LNRgTrbDestino = 2  && RETIDO NA ENTRADA

		  			LNicmsRtdEntrada = ;
	  		        (LNbaseEntRetido * LNicmsDestino/100) ;
	  		        - LNicms - LNicmsSO
	ENDCASE




	IF LNicmsRtdSaida > 0.00
		=IESetPropVT("BASE_SBBRT",LNbsbr_Retido)
		=IESetPropVT("BASE_SUBS",LNbase_Retido)
		=IESetPropVT("ICMS_SUBS",LNicmsRtdSaida)

		=IESetPropVT("BSENTSBBRT",0.00)
		=IESetPropVT("BSENTSUBS",0.00)
		=IESetPropVT("ICMSENTSUB",0.00)


	ELSE
		=IESetPropVT("BASE_SBBRT",0.00)
		=IESetPropVT("BASE_SUBS",0.00)
		=IESetPropVT("ICMS_SUBS",0.00)


		=IESetPropVT("BSENTSBBRT",LNbsbrEntRetido)
		=IESetPropVT("BSENTSUBS",LNbaseEntRetido)
		=IESetPropVT("ICMSENTSUB",LNicmsRtdEntrada)
	ENDIF

	*----------------------------------------------------------------*
	=IESetPropVT("IECalcIcmSubs",.T.)  && rotina com valores atuais


RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XJJ           IEformulaCusto VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   36   º
*       º Variable:            IEformulaCusto                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      32                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4jv0m8xjj     &&  IEformulaCusto VALID
#REGION 1
RETURN


FUNCTION IEformulaCusto
PARAMETERS	LNvlrMercadoria,LNvlrIPI,LNicms,LNicmsSobreOperacao,;
	  LNCusto_Ind,LNicmsRtdSaida,LNicmsRtdEntrada, LNtp_Mercad ,;
	   LNvlrPIS, LNvlrCOFINS

	PRIVATE LNcusto

	DO CASE
		CASE  LNtp_Mercad = 8   && IMPORTADA COM RETENCAO TRIBUTADA
			
			LNcusto = LNvlrMercadoria + LNCusto_Ind+;
				 LNicmsRtdEntrada + LNicmsRtdSaida
		CASE  LNtp_Mercad = 1   && TRIBUTADA
			LNcusto = LNvlrMercadoria + LNvlrIPI + LNCusto_Ind+;
				 LNicmsRtdEntrada + LNicmsRtdSaida - LNicms
		OTHERWISE
			LNcusto = LNvlrMercadoria + LNvlrIPI + LNCusto_Ind+;
				 LNicmsRtdEntrada + LNicmsRtdSaida	
	ENDCASE

	LNcusto = LNcusto - (LNvlrPIS + LNvlrCOFINS)


RETURN(LNcusto)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XJQ           IEcalcPis VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   37   º
*       º Variable:            IEcalcPis                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      33                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xjq     &&  IEcalcPis VALID
#REGION 1
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION IEcalcPis
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula a PIS
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION IEcalcPis
	IF IEGetPropVT("IEcalcPis")  && rotina ja executada
		RETURN
	ENDIF	
	*----------------------------------------------------------------*
	
	PRIVATE  	LSproduto,;
				LNvlrMercadoria,;
				LNvlrPIS,;
				LNCusto_Ind



				
	LSProduto  = IEGetPropVT("CODIGO")

	LNvlrMercadoria  = IEGetPropVT("VLRVENDA")
	LNCusto_Ind	 	= IEGetPropVT("CUSTO_IND")


	*----------------------------------------------------------*
	*--------------  CALCULO DO PIS              --------------*
	*----------------------------------------------------------*

	LNvlrPIS =  ((LNvlrMercadoria+LNCusto_Ind) * 1.65/100)


	=IESetPropVT("VLR_PIS",LNvlrPIS)

	*----------------------------------------------------------------*
	=IESetPropVT("IEcalcPis",.T.)  && rotina com valores atuais


RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XJX           IEcalcCOFINS VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   38   º
*       º Variable:            IEcalcCOFINS                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      34                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xjx     &&  IEcalcCOFINS VALID
#REGION 1
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION IEcalcCOFINS
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula a COFINS
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION IEcalcCOFINS
	IF IEGetPropVT("IEcalcCOFINS")  && rotina ja executada
		RETURN
	ENDIF	
	*----------------------------------------------------------------*
	
	PRIVATE  	LSproduto,;
				LNvlrMercadoria,;
				LNvlrCOFINS,;
				LNCusto_Ind



	LSProduto  = IEGetPropVT("CODIGO")

	LNvlrMercadoria  = IEGetPropVT("VLRVENDA")


	LNCusto_Ind	 	= IEGetPropVT("CUSTO_IND")
	*----------------------------------------------------------*
	*--------------  CALCULO DO PIS              --------------*
	*----------------------------------------------------------*

	LNvlrCOFINS =  ((LNvlrMercadoria+LNCusto_Ind) * 7.6/100)


	=IESetPropVT("VLR_COFINS",LNvlrCOFINS)

	*----------------------------------------------------------------*
	=IESetPropVT("IEcalcCOFINS",.T.)  && rotina com valores atuais


RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XK5           IECST VALID                        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   39   º
*       º Variable:            IECST                              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      35                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xk5     &&  IECST VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IECST
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)
	*----------------------------------------------------------------*

RETURN(IEGetPropVT("CST"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XKC           IEDefnPath VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   42   º
*       º Variable:            IEDefnPath                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      36                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xkc     &&  IEDefnPath VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEDefnPath
PARAMETER PrmPath

	PUBLIC IEDefnPath

	IEDefnPath = PrmPath

RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XKJ           IEGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   43   º
*       º Variable:            IEGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      37                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xkj     &&  IEGetAlias VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEGetAlias

	=IEVerifyInst()

RETURN(PBNotaIteAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XKP           PrdtOrigem VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAITE,     Record Number:   44   º
*       º Variable:            PrdtOrigem                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      38                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xkp     &&  PrdtOrigem VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION IEPrdtOrigem
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)
	*----------------------------------------------------------------*

RETURN(IEGetPropVT("ORIGEM"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XKV           NEGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    2   º
*       º Variable:            NEGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      39                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xkv     &&  NEGetFieldValue VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetFieldValue
PARAMETERS PrmEmp,PrmBoletim,PrmForn,PrmField

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XL2           NEGetUFOrigem VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    3   º
*       º Variable:            NEGetUFOrigem                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      40                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xl2     &&  NEGetUFOrigem VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetUFOrigem
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT("UF"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XL9           NEGetUFDestino VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    4   º
*       º Variable:            NEGetUFDestino                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      41                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xl9     &&  NEGetUFDestino VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetUFDestino
PARAMETERS PrmEmp,PrmBoletim,PrmForn
	PRIVATE Lvalue


	=W_DEFPROC("empresa.spr")
	Lvalue = EMGet_UF(PrmEmp)

RETURN(Lvalue)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XMY           NEGetRetidoDestacado VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    5   º
*       º Variable:            NEGetRetidoDestacado               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      42                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xmy     &&  NEGetRetidoDestacado VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetRetidoDestacado
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT("ICMS_SUBS"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XMZ           NEVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    6   º
*       º Variable:            NEVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      43                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xmz     &&  NEVerifyInst VALID
#REGION 2
return
*---------------------------------------------------------------*



FUNCTION NEVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("NOTAENT")


	DO CASE

		CASE TYPE("PBNotaEntAlias") = "U" ;
		   		OR EMPTY(PBNotaEntAlias) ;
		   		OR !USED(PBNotaEntAlias)
			=NECreate()					

		CASE !("NOTAENT.DBF" $ DBF(PBNotaEntAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBNotaEntAlias
			=NECreate()					


		CASE  !(LSPath $ DBF(PBNotaEntAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=NEDestroi()				
			=NECreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XN0           NECreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    7   º
*       º Variable:            NECreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      44                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xn0     &&  NECreate VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NECreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBNotaEntAlias") <> "U" ;
	   		AND !EMPTY(PBNotaEntAlias) ;
	   		AND USED(PBNotaEntAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBNotaEntAlias

	IF USED("NotaEnt")
	     =NetArqAgain("NotaEnt")
	     PBNotaEntAlias     = Alias()
	ELSE
	     =NetArqAgain("NotaEnt")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("NotaEnt")
	     PBNotaEntAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBNotaEntAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTNotaEnt[LMaxDim]
    PUBLIC DIMENSION VDNotaEnt[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFNotaEnt[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFNotaEnt)



	*-----------------------------------------------------------*
	=NEReadProperty()
	=NESetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XN1           NEDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    8   º
*       º Variable:            NEDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      45                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xn1     &&  NEDestroi VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION NEDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBNotaEntAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBNotaEntAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBNotaEntAlias
	*  3- Se aplicar um FECHAMENTO a PBNotaEntAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBNotaEntAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBNotaEntAlias)) OR ;
	   !("NOTAENT.DBF" $ DBF(PBNotaEntAlias))

		RELEASE PBNotaEntAlias
    	RELEASE VTNotaEnt
	    RELEASE VDNotaEnt
		RELEASE VFNotaEnt
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBNotaEntAlias) AND USED(PBNotaEntAlias)
		SELECT &PBNotaEntAlias
		USE
	ENDIF	
	RELEASE PBNotaEntAlias
    RELEASE VTNotaEnt
    RELEASE VDNotaEnt
	RELEASE VFNotaEnt

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XN2           NEReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:    9   º
*       º Variable:            NEReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      46                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xn2     &&  NEReadProp VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBNotaEntAlias
	SCATTER TO VTNotaEnt
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XN3           NESetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   10   º
*       º Variable:            NESetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      47                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xn3     &&  NESetDerivadas VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NESetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDNotaEnt(1,1) = "UF DESTINO"
   	VDNotaEnt(1,2) = 0
   	VDNotaEnt(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XN4           NESetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   11   º
*       º Variable:            NESetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      48                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xn4     &&  NESetPropVT VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NESetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBNotaEntAlias,;
						    VTNotaEnt,;
						    VDNotaEnt,;
						    VFNotaEnt)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XN5           NEGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   12   º
*       º Variable:            NEGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      49                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xn5     &&  NEGetPropVT VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBNotaEntAlias,;
	            VTNotaEnt,;
	            VDNotaEnt,;
	            VFNotaEnt)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XN6           NEChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   13   º
*       º Variable:            NEChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      50                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xn6     &&  NEChk_Identidade VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION NEChk_Identidade
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	PRIVATE LFretorno
	LFretorno = .t.

	=NEVerifyInst()

    =NESetPropVT("EMPRESA",PrmEmp)
    =NESetPropVT("REFERENCIA",PrmBoletim)
    =NESetPropVT("CODFORN",PrmForn)

	LFretorno=NEFind()
RETURN(LFretorno)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XOH           NEFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   14   º
*       º Variable:            NEFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      51                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xoh     &&  NEFind VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEFind

	PRIVATE LEmpresa, LReferencia, LCodForn
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NEVerifyInst()


	LEmpresa    = NEGetPropVT("Empresa")
	LReferencia = NEGetPropVT("Referencia")
	LCodForn    = NEGetPropVT("CodForn")


	SELE &PBNotaentAlias
	SET ORDER TO TAG BOLETIM
	SEEK STR(LEmpresa,3)+STR(LReferencia,6)+STR(LCodForn,5)
	IF FOUND()
		=NEReadProperty()
		=NESetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XOI           NEGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   15   º
*       º Variable:            NEGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      52                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xoi     &&  NEGetFieldValue VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetFieldValue
PARAMETERS PrmEmp,PrmBoletim,PrmForn,PrmField

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT(PrmField))



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XOJ           NE_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   16   º
*       º Variable:            NE_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      53                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xoj     &&  NE_Refresh VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
FUNCTION NE_Refresh
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	PRIVATE LFreturn
	
	=NEVerifyInst()
	*----------------------------------------------------------------*
	
    =NESetPropVT("EMPRESA",PrmEmp)
    =NESetPropVT("REFERENCIA",PrmBoletim)
    =NESetPropVT("CODFORN",PrmForn)
	=NEFind()
	
RETURN(.t.)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XOK           NELerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   18   º
*       º Variable:            NELerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      54                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xok     &&  NELerRegistro VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NELerRegistro
PARAMETERS PrmEmp,PrmBoletim,PrmForn



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XOL           NEWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   19   º
*       º Variable:            NEWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      55                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xol     &&  NEWriteProp VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBNotaEntAlias
	=RLOCK()
	GATHER FROM  VTNotaEnt
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XOM           NESalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   20   º
*       º Variable:            NESalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      56                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xom     &&  NESalvarRegistro VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NESalvarRegistro

	=NEVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !NEExiste()
		SELE &PBNotaEntAlias
		APPEND BLANK
		LFretorno=NEWriteProp()
	ELSE
		SELE &PBNotaEntAlias
		LFretorno=NEWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XON           NEExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   21   º
*       º Variable:            NEExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      57                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xon     &&  NEExiste VALID
#REGION 2
return
*---------------------------------------------------------------*
FUNCTION NEExiste

	PRIVATE LEmpresa, LReferencia, LCodForn
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NEVerifyInst()


	LEmpresa    = NEGetPropVT("Empresa")
	LReferencia = NEGetPropVT("Referencia")
	LCodForn    = NEGetPropVT("CodForn")


	SELE &PBNotaentAlias
	SET ORDER TO TAG BOLETIM
	SEEK STR(LEmpresa,3)+STR(LReferencia,6)+STR(LCodForn,5)
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XOO           NEGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   23   º
*       º Variable:            NEGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      58                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xoo     &&  NEGetAlias VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetAlias

	=NEVerifyInst()

RETURN(PBNotaEntAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XPY           NEVerPendencias VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENT,     Record Number:   25   º
*       º Variable:            NEVerPendencias                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      59                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xpy     &&  NEVerPendencias VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEVerPendencias
PARAMETERS PrmEmp
    PRIVATE LSRetorno

	PRIVATE LSalias
	LSalias		= 	ALIAS()



	=W_DEFPROC("NOTAENT.SPR")
	NFAlias = NEGetAlias()

    SELECT NOTA,referencia FROM &NFAlias;
     WHERE empresa = PrmEmp ;
     and situacao = "c" ;
     INTO CURSOR NFEntTmp

   SELE NFEntTmp
   GO TOP
   IF EOF()
      LSretorno = 0
   ELSE
      LSretorno = NFEntTmp.nota
   ENDIF
   USE

   IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
   ENDIF


RETURN(LSretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XPZ           NEReg_Trans VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:    2  º
*       º Variable:            NEReg_Trans                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      60                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xpz     &&  NEReg_Trans VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NEReg_Trans
PARAMETERS LNemp,LNboletim,LNforn,PrmSolicitante
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar o Registro de Transito
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		.f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA
	*		SCGC210.spr
	*		SCGCF211.PRG
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.

	*******************************
    IF TYPE("PrmSolicitante") <> "C"
       PrmSolicitante = ""     && IMPORTACAO OU NORMAL
    ENDIF
	*******************************


	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	=NE_Refresh(LNemp,LNboletim,LNforn);

	*--------------------------------------------------------------*
	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)
	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)
	    WAIT WINDOW "ITEM => "+STR(notaite.ordem,2) NOWAIT
		IF LEFT(notaite.situacao,1) $ "A"
   			SELECT notaite
			IF !ULregItTrans()
				LFretorno = .F.
				EXIT
			ENDIF		
		ENDIF
		SELECT notaite
		SKIP
	ENDDO

	*----------------------------------------------------------*
	=W_DEFPROC("PEDIDO.SPR")
	=PDstat_pedd(notaent.empresa,notaent.pedido)
	*----------------------------------------------------------*
	SELE notaent
	IF LFretorno

		WAIT WINDOW " OK ! " NOWAIT
		SELECT notaent
		m.situacao  =   "B"+RIGHT(situacao,1)
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO situacao
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)

*-----------------------------------------------------------------*
*  Rotina de apoio para manipular o item atual da nota de entrada
*------------------------------------------------------------------*
FUNCTION  ULregItTrans
	IF !REGLOCK()
		RETURN(.F.)
	ENDIF

   	SCATTER MEMVAR MEMO
   	m.operacao = 'TRM.'   && TRANSITO / MERCADORIA
   	LNcstind  = 0
   	SET DECIMALS TO 2
   	m.situacao 	=  'B'+RIGHT(m.situacao,1)
   	m.nota 		=  notaent.nota
   	m.dtfat 	=  notaent.data_emi
    IF notaent.pedido > 0 ;
    	AND LEFT(m.codigo,7) <> "9999999";
	   	AND notaite.movestq = "S" ;
	   	AND notaite.movfin = "S"
		*----------------------------------------------------------*
		*-----------------------------------------------------------*
		*    So tratar pedido nos diretorios LOJA ou CENTRAL ou
		* para datas com superiores a 2000
		*-----------------------------------------------------------*
		IF notaent.data >= {01.01.2000}
		 =W_DEFPROC("PEDIDO.SPR")
		 IF !PDregistra_qte(notaent.empresa,notaent.pedido,notaite.codigo,;
							notaite.qtde,"REG.TRANSITO")

			***********************************************************
			** DESATIVADA VALIDACAO DE PEDIDO 19/08/2015 (ALMIR/NELSON)
			** PARA IMPORTACAO
			***********************************************************

            if PrmSolicitante <> "IMPORTACAO"
				RETURN(.F.)
			ENDIF
		 ENDIF
		ENDIF
		*----------------------------------------------------------*
   	ENDIF
   	SELECT notaite
    =edithand('REGRAVA')
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XQ0           NECanc_Trans VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:    3  º
*       º Variable:            NECanc_Trans                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      61                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xq0     &&  NECanc_Trans VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NECanc_Trans
PARAMETERS LNemp,LNboletim,LNforn,PrmSolicitante
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar o Cancelamento de Transito
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		.f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA
	*		SCGC210.spr
	*		SCGCF211.PRG
	*------------------------------------------------------------*




	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno




	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.



	*******************************
    IF TYPE("PrmSolicitante") <> "C"
       PrmSolicitante = ""     && IMPORTACAO OU NORMAL
    ENDIF
	*******************************


	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	IF !REGLOCK()
	    WAIT WINDOW "Documento nao poder ser bloqueado para o processo."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*--------------------------------------------------------------*
	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)
	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)
	    WAIT WINDOW "ITEM => "+STR(notaite.ordem,2) NOWAIT
		IF LEFT(notaite.situacao,1) $ "B"
   			SELECT notaite
			IF !ULCancItTrans()
				LFretorno = .F.
				EXIT
			ENDIF		
		ENDIF
		SELECT notaite
		SKIP
	ENDDO
	*----------------------------------------------------------*
	=W_DEFPROC("PEDIDO.SPR")
	=PDstat_pedd(notaent.empresa,notaent.pedido)
	*----------------------------------------------------------*
	SELE notaent
	IF LFretorno
		WAIT WINDOW " OK ! " NOWAIT
		SELECT notaent
		m.situacao  =   "A"+RIGHT(situacao,1)
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO situacao
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)

*-----------------------------------------------------------------*
*  Rotina de apoio para manipular o item atual da nota de entrada
*------------------------------------------------------------------*
FUNCTION  ULCancItTrans
	IF !REGLOCK()
		RETURN(.F.)
	ENDIF

   	SCATTER MEMVAR MEMO
   	m.operacao = 'TRM.'   && TRANSITO / MERCADORIA
   	LNcstind  = 0
   	SET DECIMALS TO 2
   	m.nota 		=  notaent.nota
   	m.dtfat 	=  notaent.data_emi
    IF notaent.pedido > 0 ;
    	AND LEFT(m.codigo,7) <> "9999999";
	   	AND notaite.movestq = "S" ;
	   	AND notaite.movfin = "S"
		*----------------------------------------------------------*
		*-----------------------------------------------------------*
		*    So tratar pedido nos diretorios LOJA ou CENTRAL ou
		* para datas com superiores a 2000
		*-----------------------------------------------------------*
		IF notaent.data >= {01.01.2000}
		 =W_DEFPROC("PEDIDO.SPR")
		 IF !PDregistra_qte(notaent.empresa,notaent.pedido,notaite.codigo,;
							notaite.qtde,"CANC.TRANSITO")



			***********************************************************
			** DESATIVADA VALIDACAO DE PEDIDO 19/08/2015 (ALMIR/NELSON)
			** PARA IMPORTACAO
			***********************************************************

            if PrmSolicitante <> "IMPORTACAO"
				RETURN(.F.)
			ENDIF


		 ENDIF
		ENDIF
		*----------------------------------------------------------*
   	ENDIF
   	m.situacao 	=  'A'+RIGHT(notaent.situacao,1)
   	SELECT notaite
    =edithand('REGRAVA')
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XQ1           NEReg_Entrada VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:    4  º
*       º Variable:            NEReg_Entrada                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      62                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xq1     &&  NEReg_Entrada VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NEReg_Entrada
PARAMETERS LNemp,LNboletim,LNforn,PrmSolicitante
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Processr Entradas
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		.f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA
	*		SCGC210.spr
	*		SCGCF211.PRG
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.

	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	IF !REGLOCK()
	    WAIT WINDOW "Documento nao poder ser bloqueado para o processo."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	=NE_Refresh(LNemp,LNboletim,LNforn);

	*--------------------------------------------------------------*

	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)

	*---------------------------------------------------------------*
	* Verificacao do itens para liberar entrada
	*---------------------------------------------------------------*
	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)

		IF  notaite.vlrvenda = 0
		    WAIT WINDOW "Entrada "+STR(notaent.referencia,6)+;
			    	" Possui Item sem Valor Lancado."
			LFretorno = .F.
			EXIT
		ENDIF

		IF notaite.movestq = "S" AND (LEFT(notaite.situacao,1) $ "B")
		    IF !NEsoma_Saldo()
				LFretorno = .F.
				EXIT
			ENDIF
		ENDIF

		**  TESTAR PEDIDO NO PERIODO ACIMA DE 1998
        IF PrmSolicitante <>  "IMPORTACAO"
			IF  notaent.data > {01.05.99} ;
		        AND (notaent.codforn = 1 or notaent.codforn = 2) ;
		        AND (notaent.empresa = 1 OR "CENTRAL" $ wp_dirdat) ;
		        AND notaite.ch_opera = "1" ;
				AND LEFT(notaite.classifica,2) $ "00/01" ;
				AND notaent.pedido = 0
				
			    WAIT WINDOW "Entrada "+STR(notaent.referencia,6)+;
			    	" sem Nro.Pedido."
				LFretorno = .F.
				EXIT
			ENDIF
		endif

	    IF notaent.pedido > 0 AND notaent.data > {01.01.2000}
				*----------------------------------------------------------*
				=W_DEFPROC("PEDIDO.SPR")
				IF !PDloc_item(notaent.empresa,;
							notaent.pedido,;
							notaite.codigo,.T.)

			        IF PrmSolicitante <>  "IMPORTACAO"
						LFretorno = .F.
						EXIT
					ENDIF
					
   				ENDIF
				*----------------------------------------------------------*
		ENDIF
		
		SELE notaite
		SKIP
	ENDDO
	SELE notaite
	IF !LFretorno   && OPERACAO ABORTADA
    	WAIT WINDOW " Os Itens estao irregulares. Tente Novamente.  <ENTER>"
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF			

	*---------------------------------------------------------------*

	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)

	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)

		LSmsg = "Cancelando Emp.: "+STR(notaent.empresa,3);
							+" NE: "+STR(notaent.nota,6);
							+" DT: "+DTOC(notaent.data) ;
							+"ITEM => "+STR(notaite.ordem,2)
		WAIT WINDOWS LSmsg NOWAIT

		IF LEFT(notaite.situacao,1) $ "B"
   			SELECT notaite
			IF !ULEntrait()
				LFretorno = .F.
				EXIT
			ENDIF		
		ENDIF
		SELECT notaite
		SKIP
	ENDDO
	*----------------------------------------------------------*
	=W_DEFPROC("PEDIDO.SPR")
	=PDstat_pedd(notaent.empresa,notaent.pedido)
	*----------------------------------------------------------*
	*----------------------------------------------------------*
	=W_DEFPROC("PEDIDO.SPR")
	LFretorno=PDstat_pedd(notaent.empresa,notaent.pedido)
	*----------------------------------------------------------*




	SELE notaent
	IF LFretorno OR PrmSolicitante =  "IMPORTACAO"

		WAIT WINDOW " OK ! " NOWAIT
		SELECT notaent

        IF PrmSolicitante =  "IMPORTACAO"
			m.situacao  = "C"+RIGHT(situacao,1)   && AGUARDANDO ESCRITURACAO
		ELSE
			m.situacao  = "c"+RIGHT(situacao,1)   && AGUARDANDO ESCRITURACAO
		ENDIF

		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO situacao
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ENDIF
	*--------------------------------------------------------------*

    IF PrmSolicitante <> "IMPORTACAO"

        IF wp_empresa  = 30 OR wp_empresa = 31 && CNB e CNG nao gera XML

				WAIT WINDOW " OK ! " NOWAIT
				SELECT notaent
	
				m.situacao  =   "C"+RIGHT(situacao,1)   && ESCRITURACAO

		        * DENTRO DO NEGeraDfis coloquei replicacao desta instrucao

				***************************
				SET FIELDS TO dtregis, hregis, usrregis,deletado
				SET FIELDS TO situacao
				=edithand('REGRAVA')
				CLEAR FIELDS
				SET FIELDS OFF
				***************************
		ELSE


			PRIVATE LSobjetivo,LSexibmsg
	
			LSexibmsg = "SIM"
	
			=W_DEFPROC("NOTAENT.SPR")
			LSobjetivo = ;
			   NEDefEnvDFis(  Notaent.Empresa, Notaent.nf_mod_doc )


			=W_DEFPROC("NOTAENT.SPR")
			IF NEGeraDFIS(Notaent.Empresa,Notaent.Nota,;
		              notaent.CodForn,;
		              LSexibmsg,;
		              LSobjetivo)

				WAIT WINDOW " OK ! " NOWAIT
				SELECT notaent
	
				m.situacao  =   "C"+RIGHT(situacao,1)   && ESCRITURACAO

		        * DENTRO DO NEGeraDfis coloquei replicacao desta instrucao

				***************************
				SET FIELDS TO dtregis, hregis, usrregis,deletado
				SET FIELDS TO situacao
				=edithand('REGRAVA')
				CLEAR FIELDS
				SET FIELDS OFF
				***************************
			ENDIF
		ENDIF
	ENDIF



	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)

*-----------------------------------------------------------------*
*  Rotina de apoio para manipular o item atual da nota de entrada
*------------------------------------------------------------------*
FUNCTION ULEntrait
	PRIVATE LFretorno
	LFretorno = .t.
	*-------------------------------------------------------------*
   	IF notaite.movestq = "S"
	    IF NEsoma_Saldo()
    		SELECT notaite
			IF REGLOCK()

				IF !NEfatura()
					LFretorno = .F.
					EXIT
				ENDIF
			ELSE
				LFretorno = .F.
				EXIT
			ENDIF
		ELSE
			LFretorno = .F.
			EXIT
		ENDIF
		SELECT  notaite
	ELSE
   		SELECT notaite
		IF REGLOCK()
			m.situacao = 'C'+RIGHT(m.situacao,1)
			m.dtfat = wp_dtoper
			=edithand('REGRAVA')
		ELSE
			LFretorno = .F.
			EXIT
		ENDIF
	ENDIF
	*-------------------------------------------------------------*
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XQ2           NEsoma_Saldo VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:    5  º
*       º Variable:            NEsoma_Saldo                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      63                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xq2     &&  NEsoma_Saldo VALID
#REGION 3
return

*---------------------------------------------------------------*
FUNCTION NEsoma_Saldo  && VERIFICA POSSIB. SOMA ESTOQUE  (proces)
	PRIVATE LNsaldo,LNqtde,LNcusto,LNreserva

	store 0 to  LNsaldo,LNqtde,LNcusto,LNreserva
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
    IF notaent.natu_oper = 6	&& REQUISICAO DE SAIDA
		*----------------------------------------------------------*
		*=W_DEFPROC("ESTOQUE.SPR")
		*=ESsaldo(notaent.empresa	,notaite.codigo ,;
		*		 notaite.classifica , notaent.data,;
		*		 LNqtde	, LNcusto	,notaent.hora	,LNreserva)
		*----------------------------------------------------------*
		=W_DEFPROC("ESTOQUE.SPR")
		IF NOT ESversaldo(notaent.empresa  ,notaite.codigo ,;
			notaent.data, notaite.qtde, LNreserva,;
					.T.,.F.,"SAIDA",notaent.hora,notaite.movestq)
			wp_msg = RTRIM(transform(notaite.codigo,'@R &masc_codi'))+;
	       			" Possui Saldo Insuficiente = "+STR(saldo.sld_atu,6)
    	  	WAIT WINDOW wp_msg+" <ENTER> "
			RETURN .F.
		ENDIF

        *-----------------------------------------------------------*
		*LNsaldo = LNqtde - LNreserva
	    *IF notaite.qtde > LNsaldo
	    *	wp_msg = RTRIM(transform(notaite.codigo,'@R &masc_codi'))+;
        *          	" Possui Saldo Insuficiente = "+STR(saldo.sld_atu,6)
		*	      	WAIT WINDOW wp_msg+" <ENTER> "
		*	RETURN .F.
		*ENDIF
        *-----------------------------------------------------------*
   ENDIF
RETURN(NElocaRegSld())





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XQ3           NElocaRegSld VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:    6  º
*       º Variable:            NElocaRegSld                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      64                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xq3     &&  NElocaRegSld VALID
#REGION 3
return

*---------------------------------------------------------------*
FUNCTION NElocaRegSld
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LFretorno
	LFretorno	=  .t.
	*----------------------------------------------------------*
   	PRIVATE LFlockReg
	PRIVATE LFabreAuto
	PRIVATE LNJaReserv	
	LFlockReg	= .T.	&& BLOQUEAR REGISTRO
    LFabreAuto	= .F. 	&& ABRIR CONTROLE AUTOMATICAMENTE
	LNJaReserv	= 0		&& QTDE JA RESERVADA DESTE ITEM NESTE DOC
	=W_DEFPROC("ESTOQUE.SPR")
	IF !ESversaldo(notaent.empresa,notaite.codigo, notaent.data,;
				notaite.qtde,LNJaReserv,LFabreAuto,;
				LFlockReg,"ENTRADA",;
				notaent.hora,notaite.movestq)
		LFretorno	=  .F.
	ENDIF
	*----------------------------------------------------------*
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XQ4           NEfatura VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:    7  º
*       º Variable:            NEfatura                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      65                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xq4     &&  NEfatura VALID
#REGION 3
return

*---------------------------------------------------------------*
FUNCTION NEfatura
	PRIVATE vlr_icms, m.icms_subs
	
	PRIVATE LFretorno
	LFretorno	=  .t.
	*----------------------------------------------------------*
  	SELECT notaite
   	LNnota = m.nota     && EVITA APAGAR N. NOTA
   	SCATTER MEMVAR MEMO
   	DO CASE
		CASE m.natu_oper = 1
		   m.operacao = 'ECP.'   && ENTRADA/COMPRA/PROCESSADA
		CASE m.natu_oper = 2
		   m.operacao = 'ETP.'   && ENTRADA/TRANSFERENCIA/PROCESSADA
		CASE m.natu_oper = 3
		   m.operacao = 'ERP.'   && ENTRADA/REMESSA/PROCESSADA
		CASE m.natu_oper = 4
		   m.operacao = 'EDP.'   && ENTRADA/DEVOLUCAO/PROCESSADA
		CASE m.natu_oper = 5
		   m.operacao = 'EOP.'   && ENTRADA/OUTRAS OPER/PROCESSADA
		CASE m.natu_oper = 6
		   m.operacao = 'SOP.'   && SAIDA/OUTRAS OPER / PROCESSADA
   	ENDCASE

	*---------------------------------------------------------------*
	*  CALCULO DO CUSTO INDIRETO
	*---------------------------------------------------------------*
	
	LNcstind = NEClcIndiretoCusto( ;
					notaent.data_emi, ;
					notaent.totproduto, notaent.vlr_ipi, ;
					notaent.vlrFrete, notaent.vlrdespes, ;
					notaent.vlrseguro,;
					notaite.vlrvenda, notaite.vlripi)

	**********************************
   	m.situacao 	= 'C'+RIGHT(m.situacao,1)
   	m.nota 	   	=  notaent.nota
   	m.dtfat 	=  notaent.data_emi
   	m.custo_ind =  LNcstind



    *-------------- ICMS NORMAL -------------*



	m.vlr_icms = NEClcICMS(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,;
							notaite.origem,;
							recno("NOTAITE"),;
							notaite.aliq_rdu,;
							notaite.aliq_icms)

    *-------------- ICMS SOBRE OPERACAO -------------*

    m.bsbricmso  = 0
    m.baseicmso  = 0
	m.icmssoper  = 0



	m.icmssoper = NEIcmsOper(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,;
							notaite.origem,;
							recno("NOTAITE"),;
							notaite.aliq_rdu,;
							notaite.aliq_icms)

	*---------------------------------------------------*


	m.Base_sbbrt = NEBsBrRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,  ;
							notaite.vlripi,    ;
							recno("NOTAITE"),;
							notaite.origem,;
							notaite.cst,;
							notaite.aliq_rdu)
							
							
				
	m.Base_subs  = NEBsRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.Base_sbbrt,    ;
							recno("NOTAITE"),;
							notaite.origem,;
							notaite.cst,;
							notaite.IVA)



	m.icms_subs  = NEClcRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.vlr_icms,m.Base_subs,;
							m.icmssoper,    ;
							recno("NOTAITE") ,;
							notaite.origem,;
							notaite.cst)


	m.BsEntsbbrt = NEBsEntBrRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,  ;
							notaite.vlripi,    ;
							notaite.custo_ind, ;
							recno("NOTAITE") ,;
							notaite.origem,;
							notaite.aliq_rdu,;
							notaite.IVA)
							
							
	m.BsEntSubs  = NEBsEntRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.BsEntsbbrt, ;
							recno("NOTAITE"), ;
							notaite.origem,;
							notaite.IVA)

	m.IcmsEntsub = NEClcEntRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.vlr_icms,m.BsEntSubs,;
							m.icmssoper,    ;
							recno("NOTAITE"),;
							notaite.origem,;
							notaite.IVA)





   	IF m.pedido > 0 and LEFT(m.codigo,7) <> "9999999"
		*-----------------------------------------------------------*
		*    So tratar pedido nos diretorios LOJA ou CENTRAL ou
		* para datas com superiores a 2000
		*-----------------------------------------------------------*
		IF notaent.data >= {01.01.2000}
	  	*----------------------------------------------------------*
			*-------------------------------------------------------*
			* NOTA COM NRO DE PEDIDO MAIS COMITEM QUE NAO CONSTA NO PEDIDO
			* Dµ ERRO E A PEDIDO DO NELSON/ALMIR (26/09/2015) O SISTEMA
			* IGNORA A FALHA E SEGUE EM FRENTE PARA NAO ATRAPALHAR A
			* IMPORTACAO
			*-------------------------------------------------------*
			*IF !PDregistra_qte(;
			*				notaent.empresa,;
			*				notaent.pedido,notaite.codigo,;
			*				notaite.qtde,"REG.ENTRADA")
			*	RETURN(.F.)
			*ENDIF

			=W_DEFPROC("PEDIDO.SPR")
			=PDregistra_qte(;
							notaent.empresa,;
							notaent.pedido,notaite.codigo,;
							notaite.qtde,"REG.ENTRADA")

		ENDIF
 		*----------------------------------------------------------*
   ENDIF
**
   SELECT notaite
	=edithand('REGRAVA')

    =W_DEFPROC("NOTAITE.SPR")
	=IE_Refresh(m.empresa,m.orcamento,m.favorecido,m.ordem)


    SELECT itemmov
	m.data = notaent.data
	m.hora = notaent.hora
	m.sld_estq = 0
	m.vlr_estq = 0




	************************************************************
	*    - GARANTIA CONTRA DUPLICACAO							*
	************************************************************
    *  INDICE E SEEK ALTERADO EM 10/10/2014 pq na filial estÆo
    * cancelando a nota na filial e alterando a data e que por algum
    * motivo de indice nao foi excluido o item no cancelamento na
    * central
    *************************************************************
	*SET ORDER TO TAG movimento
	*SEEK STR(m.empresa,3) + m.codigo + DTOS(m.data) + m.hora +;
	*		 		 + m.tipo + STR(m.nota,7) + STR(m.ordem,2)
    *************************************************************

    m.empresa = notaite.EMPRESA
	m.codigo  = notaite.CODIGO
	m.favorecido = notaite.FAVORECIDO
    m.tipo       = notaite.TIPO
    m.nota       = notaite.NOTA
    m.serie      = notaite.SERIE
    m.ordem      = notaite.ORDEM
    m.dtfat      = notaite.dtfat



*    SET ORDER TO TAG IT_DA_NOTA

    SET ORDER TO TAG IT_NF_REAL

    SEEK  ;
           STR(m.EMPRESA,3);
		  +m.CODIGO;
		  +STR(m.FAVORECIDO,14);
		  +m.TIPO;
		  +STR(m.NOTA,7);
		  +DTOS(m.DTFAT);
		  +STR(m.ORDEM,3)			 		



	IF FOUND()
   		=edithand('REGRAVA')
	ELSE
   		=edithand('SAVE')
	ENDIF



	SET ORDER TO TAG movimento

   	=W_DEFPROC("moviment.spr")
	=MVatu_cmd(itemmov.empresa,;
				itemmov.codigo,;
				itemmov.classifica,;
				itemmov.data,;
				itemmov.hora,;
				itemmov.tipo,;
				itemmov.nota,;
				itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e
	*----------------------------------------------------------*
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XQ5           NEDef_CFO VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:    8  º
*       º Variable:            NEDef_CFO                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      66                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4jv0m8xq5     &&  NEDef_CFO VALID
#REGION 3
RETURN

FUNCTION NEDef_CFO
	PARAMETER LStipo,LNTp_Mercad,LScfo
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Identificar o CFO Adequado a
	*               Conforme o Tipo de Mercadoria
	*------------------------------------------------------------*
	* COMENTARIO..:
    *   Com as Mudançãs nas Formas de Tributação Foram Criadas Situações em
    * que o CFO passou a Ser Definido em Função da OPERAÇÃO COMERCIAL e DA
    * NATUREZA FISCAL DA MERCADORIA (Substitução ou Tributada) e
    * Considerando  Aspectos  em Que Os Itens de Um Orcamento Mesclam
    * Mercadorias TRIBUTADAS e COM SUBSTITUIÇÃO . Deveríamos :
    *
    *         1-    Emitir uma Nota para Cada Grupo de Itens Com Mesmo CFO
    *         OU
    *          2-   Emitir Uma Nota Idependente do Grupo de CFO Porém
    *    Legendando Cada Item Para Permitir a Identificação do CFO Adequado
    *
	*       Optou-se Pela 2a Auternativa
	*			
	*			
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*			LStipo.....: Tipo Associado a Opera‡Æo Comercial
	*			LNTp_Mercad: Tipo de Mercadoria
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*			LSCFO....: CFO Definido
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
    PRIVATE ARQ_Tipooper ,ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Tipooper     = NetArqAgain("Tipooper")
    ALS_Tipooper     = Alias()

	*--------------------------------------------------------
	*--------------------------------------------------------
	
	SELE &ALS_Tipooper
	SET ORDER TO TAG tipo
	SEEK "E"+LStipo
	IF !FOUND()
   	    SEEK "e"+LStipo
		IF !FOUND()
		   	=up_fecha("&ALS_Tipooper")
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
		ENDIF
	ENDIF

	*------------------------------------------------------*
    LScfo = &ALS_Tipooper .cfo					&& CFO DEFAULT
	*------------------------------------------------------*

	IF LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
	   LScfo = &ALS_Tipooper .cfosubs
	ENDIF		
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XQE           NEClcDiretoCusto VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:    9  º
*       º Variable:            NEClcDiretoCusto                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      67                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xqe     &&  NEClcDiretoCusto VALID
#REGION 3
RETURN

FUNCTION NEClcDiretoCusto
	PARAMETERS LNemp,LScod, LNvlrMercadoria
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor Unitario de um item de
	*             NFE itegrando ao valor da mercadoria o :
	*					IPI
	*					RETIDO
	*					CUSTO_IND
	*			  O ICMS ja esta embutido no valor da mercadoria
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LNvlrMercadoria........: Valor da Mercadoria
	*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNvlrdesembolso.: Custo Total Considerando os Tributos
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal

	PRIVATE LNipi, LNicms

	PRIVATE LNbaseicms,LNicms,LNretido
	PRIVATE LNvlrdesembolso
	PRIVATE LNaliq_icms


	LNipi		=	0	
	LNicms		=	0



	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_grfiscal+ARQ_grfiscal) > 100000 ;
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	
	SELE &ALS_grupo
	SET ORDER TO TAG codigo

	SEEK LScod
	if not found()
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	endif

	SELE &ALS_grfiscal
	SET ORDER TO TAG tributacao
	SEEK &ALS_empresa .estado+LEFT( &ALS_grupo .classifica,5)

	LNaliq_icms		= 	7	&& % ver possibilidade de pasar em parametro
							&& A aliq_icms esta fixa em 7% porque
							&& os fornecedores sao de Sao Paulo
							&& mas deve ser feito um modelo que
							&& atenda a essa necessidade
							
	LNvlrdesembolso	=	LNvlrMercadoria
	LNaliq_ipi		=	&ALS_grupo .aliq_ipi

	LNiva			=	&ALS_grfiscal .iva
	LNtpmercad		=	&ALS_grfiscal .tp_mercad

	*************************************************************


	LNbaseicms = LNvlrMercadoria

	LNicms	   = (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	LNipi	   = (LNbaseicms * LNaliq_ipi)/100

	LNretido   = 0






	IF LNtpmercad = 2 AND LNiva > 0
		LNretido   = (LNbaseicms + LNipi) * LNiva * 0.17 - LNicms
	ENDIF










	*----------------------------------------------------------*

	LNvlrdesembolso  = LNvlrMercadoria + LNretido + LNipi

	*----------------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNvlrdesembolso)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XQO           ant0613NEClcICMS VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   10  º
*       º Variable:            ant0613NEClcICMS                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      68                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xqo     &&  ant0613NEClcICMS VALID
#REGION 3
RETURN

FUNCTION ant0613NEClcICMS
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria, ;
		PrmPrdtOrigem

	
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal


	PRIVATE LNbaseicms,LNicms
	PRIVATE LNaliq_icms

	PRIVATE LNUFOrigem
	PRIVATE LNUFDestino


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()


    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_grfiscal+ARQ_grfiscal) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	LNUFOrigem	 = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	LNUFDestino  = NEGetUFDestino(LNemp,LNboletim,LNforn)

	IF LNUFOrigem = LNUFDestino
		=W_DEFPROC("TRIBUTAR.SPR")
		LNaliq_icms  = TRAlqIcmInUF(LNUFOrigem)
	ELSE
		=W_DEFPROC("TRIBUTAR.SPR")
		LNaliq_icms  = TRAlqIcmOuUF(LNUFOrigem,PrmPrdtOrigem)
	ENDIF


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	LNicms		=	0


*--------------------------------------------------------*
*   REGRA SUBSTITUIDA EM 29/11/2011
*--------------------------------------------------------*
*	if &ALS_notaent .vlr_icms	> 0
*-------------------------------------------------------*
*	IF &ALS_notaent .icms_subs = 0
*-------------------------------------------------------*

	IF     &ALS_notaent .vlr_icms > 0 ;
	    OR &ALS_notaent .base_icms > 0 ;
	    OR &ALS_notaent .icms_subs > 0



		LNbaseicms    = LNvlrMercadoria

		*-------------------------------------------------------------*
		*  A base de ICMS e reduzida em 4.90% quando o fornecedor for
		* firestone em funcao da mudanca na cobranca de PIS e COFINS
		* que passaram a ser retidos.
		*-------------------------------------------------------------*

		*-------------------------------------------------------------*
		* "02/07/ " cst com reducao da base de calculo
		*--------------------------------------------------------------*
		
		
		
		if &ALS_notaent .reduc_icms > 0
			LNbaseicms  = LNvlrMercadoria * &ALS_notaent .reduc_icms
		ELSE
			if &ALS_notaent .codforn = 1
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.049
			endif

			if &ALS_notaent .codforn = 2
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.0519
			endif


		ENDIF

		LNicms	= (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	ENDIF

***	LNicms	= ROUND(LNicms,2)
	

	
	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNicms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XQX           ant0613NEIcmsOper VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   11  º
*       º Variable:            ant0613NEIcmsOper                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      69                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xqx     &&  ant0613NEIcmsOper VALID
#REGION 3
RETURN

FUNCTION ant0613NEIcmsOper
	PARAMETERS LNemp,LNboletim,LNforn, LScod, ;
	     LNvlrMercadoria, PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal


	PRIVATE LNbaseicms,LNicms
	PRIVATE LNaliq_icms

	PRIVATE LNUFOrigem
	PRIVATE LNUFDestino


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()


    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_grfiscal+ARQ_grfiscal) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF







	LNUFOrigem	 = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	LNUFDestino  = NEGetUFDestino(LNemp,LNboletim,LNforn)

	IF LNUFOrigem = LNUFDestino
		=W_DEFPROC("TRIBUTAR.SPR")
		LNaliq_icms  = TRAlqIcmInUF(LNUFOrigem)
	ELSE
		=W_DEFPROC("TRIBUTAR.SPR")
		LNaliq_icms  = TRAlqIcmOuUF(LNUFOrigem , PrmPrdtOrigem)
	ENDIF



	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	LNicms		=	0

*--------------------------------------------------------*
*   REGRA SUBSTITUIDA EM 29/11/2011
*--------------------------------------------------------*
*	if &ALS_notaent .icmssoper	> 0
*-------------------------------------------------------*
	IF  &ALS_notaent .icms_subs > 0



		LNbaseicms    = LNvlrMercadoria


		*-------------------------------------------------------------*
		*  A base de ICMS e reduzida em 4.90% quando o fornecedor for
		* firestone em funcao da mudanca na cobranca de PIS e COFINS
		* que passaram a ser retidos.
		*-------------------------------------------------------------*
		
		if &ALS_notaent .reduc_icms > 0
			LNbaseicms  = LNvlrMercadoria * &ALS_notaent .reduc_icms
		ELSE
			if &ALS_notaent .codforn = 1
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.049
			endif

			if &ALS_notaent .codforn = 2
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.0519
			endif

		ENDIF

		LNicms	= (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	ENDIF
	
**	LNicms	= ROUND(LNicms,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNicms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XR6           ant0613NEBsBrRetido VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   12  º
*       º Variable:            ant0613NEBsBrRetido                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      70                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xr6     &&  ant0613NEBsBrRetido VALID
#REGION 3
RETURN

FUNCTION ant0613NEBsBrRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria,;
	 LNipi,Notaite_PK, PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Bruta ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite

	PRIVATE LNicms
	PRIVATE LSufOrigem, LSufDestino

	PRIVATE LNBsBrRetido

	LNBsBrRetido = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()


	IF (ARQ_empresa+ARQ_notaen+ ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	SELE &ALS_notaite
	GO Notaite_PK


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)



    *----------------------------------------------------------*
    * NAO ATUALIZAR O IVA SE O IVA FOR INFORMADO OU SE A ENTRADA
    * JA ESTIVER PROCESSADA
    *----------------------------------------------------------*
	IF (           &ALS_notaent .informaiva  = "S" ;
	      OR LEFT( &ALS_notaent .situacao,1) = "C" ;
	   ) ;
	   OR ;
	   (  DATE() - &ALS_notaent .data > 10 AND &ALS_notaite .IVA > 0)
		LNiva= 	&ALS_notaite .IVA
	ELSE

		=W_DEFPROC("TRIBUTAR.spr")
		LNiva= TRGet_IVA( LSufOrigem  ,LScod, LSufDestino, ;
		         &ALS_notaent .data , PrmPrdtOrigem)
	ENDIF
	*************************************************************


	LNBsBrRetido   = 0
	

	IF &ALS_notaent .icms_subs	> 0

		*-------------------------------------------------------------*
*****   IF (LNtpmercad = 2 or LNtpmercad = 8) AND LNiva > 0

        IF &ALS_notaite .CST $ "1/2/7"
			DO CASE

		  		CASE LNtpmercad = 8  && REDUTOR NAAAO AFETA BASE DO RETIDO
					LNBsBrRetido  = (LNvlrMercadoria + LNipi)

		  		CASE LSufOrigem =  LSufDestino
		  		                    && REDUTOR NAAAO AFETA BASE DO RETIDO
					LNBsBrRetido  = (LNvlrMercadoria + LNipi)

                *------------------------------------------*
                * REGRA REVIZADA COM OLIVEIRA EM 25/11/2011
                * PARA ACERTA TRIBUTACAO NOTA 7605 DE 13/10/2010
                * FORNECEDOR LEXUS IMPORTACAO
                *------------------------------------------*
				CASE &ALS_notaent .reduc_icms > 0
						LNBsBrRetido  = (LNvlrMercadoria  ;
				                * &ALS_notaent .reduc_icms) +  LNipi
				

               *------------------------------------------*
               * REGRA SUBSTITUIDA PELA REGRA ACIMA
               *------------------------------------------*
			   *CASE &ALS_notaent .reduc_icms > 0
			   *			LNBsBrRetido  = (LNvlrMercadoria + LNipi) ;
			   *	                * &ALS_notaent .reduc_icms
               *------------------------------------------------

				CASE &ALS_notaent .reduc_icms = 0
					if &ALS_notaent .data >= {01.11.2006}
						DO CASE
							CASE &ALS_notaent .codforn = 1
								LNBsBrRetido    = ;
								(LNvlrMercadoria + LNipi)-;
									(LNvlrMercadoria)*0.049

							CASE &ALS_notaent .codforn = 2
								LNBsBrRetido    = ;
								(LNvlrMercadoria + LNipi)-;
									(LNvlrMercadoria)*0.0519


							OTHERWISE
								LNBsBrRetido   = (LNvlrMercadoria + LNipi)
							
						ENDCASE

					ELSE


						DO CASE
							CASE  &ALS_notaent .codforn = 1
								LNBsBrRetido    = ;
									(LNvlrMercadoria + LNipi)-;
									(LNvlrMercadoria + LNipi)*0.049
									
							CASE  &ALS_notaent .codforn = 2
								LNBsBrRetido    = ;
									(LNvlrMercadoria + LNipi)-;
								    ((LNvlrMercadoria + LNipi)*0.0519)
									
							OTHERWISE
								LNBsBrRetido   = (LNvlrMercadoria + LNipi)
						ENDCASE
					ENDIF
			ENDCASE

		ENDIF
	ENDIF

	LNBsBrRetido = LNBsBrRetido
	
	*----------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsBrRetido)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XSZ           NEBsRetido VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   13  º
*       º Variable:            NEBsRetido                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      71                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xsz     &&  NEBsRetido VALID
#REGION 3
RETURN

FUNCTION NEBsRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, ;
	           LNBsBrRetido,Notaite_PK,;
	           PrmPrdtOrigem,;
	           PrmCst,;
	           PrmIVA
	



	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Normal ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")





	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	

	PRIVATE LNipi, LNicms

	PRIVATE LNBsRetido

	PRIVATE LSufOrigem, LSufDestino

	LNBsRetido  = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()




	IF (ARQ_empresa+ARQ_notaent) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")

		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*



	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)





	*************************************************************


	IF &ALS_notaent .icms_subs	> 0

        IF PrmCST $ "1/2/7"
           DO CASE

              CASE LSufDestino = "MT" AND LNforn = 1
			       LNBsRetido   = (LNBsBrRetido)


              OTHERWISE
			       LNBsRetido   = (LNBsBrRetido) * PrmIVA

           ENDCASE

		ENDIF
	ENDIF



	*----------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsRetido)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XT0           NEClcRetido VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   14  º
*       º Variable:            NEClcRetido                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      72                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xt0     &&  NEClcRetido VALID
#REGION 3
RETURN

FUNCTION NEClcRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNicms, LNbaseRetido,;
	        LNicmssoper,Notaite_PK,PrmPrdtOrigem,;
	        PrmCST



	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")






	PRIVATE LSalias




	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	


	PRIVATE LNretido
	PRIVATE LNaliq_icms

	PRIVATE LSufOrigem, LSufDestino

	LSalias			= ALIAS()


    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()




	IF (ARQ_empresa+ARQ_notaent ) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	*************************************************************



	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)

	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)




	LNretido   = 0
	
	IF &ALS_notaent .icms_subs	> 0

        IF PrmCST $ "1/2/7"

            DO CASE

               CASE LSufDestino = "MT" AND LNforn = 1
			       LNretido   = LNbaseRetido * 0.15


               CASE LSufDestino $ ;
                "AM/AP/BA/DF/MA/MG/PB/PR/PE/RN/RS/SP/SE/TO"
			       LNretido   = LNbaseRetido * 0.18
 			       LNretido   = LNretido - LNicms     && - LNicmssoper


               CASE LSufDestino $  "RJ"
			       LNretido   = LNbaseRetido * 0.19
 			       LNretido   = LNretido - LNicms     && - LNicmssoper

               OTHERWISE

			       LNretido   = LNbaseRetido * 0.17
 			       LNretido   = LNretido - LNicms     && - LNicmssoper
			ENDCASE

		ENDIF
	ENDIF
	*----------------------------------------------------------*

	LNRetido = ROUND(LNRetido,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNretido)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XT1           NEBsEntBrRetido VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   15  º
*       º Variable:            NEBsEntBrRetido                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      73                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xt1     &&  NEBsEntBrRetido VALID
#REGION 3
RETURN

FUNCTION NEBsEntBrRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria, LNipi, ;
	             LNCustoIndireto,Notaite_PK, PrmPrdtOrigem,;
	             PrmAliq_rdu,PrmIVA


    *-------------------------------------------*
    * RETORNA O INDICE PARA PERCENTAUL
    * EX: INDICE 0,915
    *     100 - 0,915 * 100 = 8,5%
    *-------------------------------------------*

    IF PrmAliq_rdu <> 0
	    IF PrmAliq_rdu < 1
    	  PrmAliq_rdu = 100 - PrmAliq_rdu * 100
	    ENDIF
	endif


	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Bruta ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")
	
	
	

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent

	PRIVATE LNicms
	PRIVATE LSufOrigem, LSufDestino

	PRIVATE LNBsBrRetido

	LNBsBrRetido = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()



	IF (ARQ_empresa+ARQ_notaen) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*




	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp



	=W_DEFPROC("TRIBUTAR.spr")
	LNOriTpmercad	= TRDef_RgTrbMercad(  &ALS_notaent .uf  ,LScod)

	=W_DEFPROC("TRIBUTAR.spr")
	LNDstTpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)


	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)




    *----------------------------------------------------------*

    *----------------------------------------------------------*
    *----------------------------------------------------------*


	*************************************************************


	LNBsBrRetido   = 0
	

	IF &ALS_notaent .icmsentsub	> 0

		*-------------------------------------------------------------*


		IF LNOriTpmercad <> 2 AND LNDstTpmercad = 2 AND PrmIVA > 0

			DO CASE
				


				CASE &ALS_notaent .reduc_icms > 0
						LNBsBrRetido  = ;
						   ;
						  lnvlrmercadoria - ;
						   (LNvlrMercadoria  *  PrmAliq_rdu/100) +  LNipi


				OTHERWISE
						LNBsBrRetido   = (LNvlrMercadoria + LNipi)
			ENDCASE

			LNBsBrRetido = LNBsBrRetido + LNCustoIndireto

		ENDIF
	ENDIF

	
	
	*----------------------------------------------------------*

	LNBsBrRetido = LNBsBrRetido

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsBrRetido)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XT2           NEBsEntRetido VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   16  º
*       º Variable:            NEBsEntRetido                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      74                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xt2     &&  NEBsEntRetido VALID
#REGION 3
RETURN

FUNCTION NEBsEntRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNBsBrRetido,;
	   Notaite_PK, PrmPrdtOrigem,;
	   PrmIVA


	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Normal ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")





	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent

	PRIVATE LNipi, LNicms

	PRIVATE LNBsRetido
	PRIVATE LSufOrigem, LSufDestino

	LNBsRetido  = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()



	IF (ARQ_empresa+ARQ_notaent) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*




	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)


	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)


    *----------------------------------------------------------*

	*************************************************************


	IF &ALS_notaent .icmsentsubs	> 0
		IF LNtpmercad = 2 AND PrmIVA > 0
			LNBsRetido   = (LNBsBrRetido) * PrmIVA
		ENDIF
	ENDIF


	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsRetido)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XT3           NEClcEntRetido VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   17  º
*       º Variable:            NEClcEntRetido                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      75                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xt3     &&  NEClcEntRetido VALID
#REGION 3
RETURN

FUNCTION NEClcEntRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNicms, LNbaseRetido,;
	   LNicmssoper,Notaite_PK, PrmPrdtOrigem,;
	   PrmIVA
	
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")





	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent

	PRIVATE LSufOrigem, LSufDestino


	PRIVATE LNretido
	PRIVATE LNaliq_icms


	LSalias			= ALIAS()


    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()



	IF (ARQ_empresa+ARQ_notaent) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	*************************************************************


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)



	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)






	
	LNretido   = 0
	
	IF &ALS_notaent .icmsentsubs	> 0
		IF LNtpmercad = 2 AND PrmIVA > 0





            DO CASE

               CASE LSufDestino = "MT" AND LNforn = 1
			       LNretido   = LNbaseRetido * 0.15


               CASE LSufDestino $ ;
                "AM/AP/BA/DF/MA/MG/PB/PR/PE/RN/RS/SP/SE/TO"
			       LNretido   = LNbaseRetido * 0.18


               CASE LSufDestino $  "RJ"
			       LNretido   = LNbaseRetido * 0.19
 			       LNretido   = LNretido - LNicms     && - LNicmssoper

               OTHERWISE

			       LNretido   = LNbaseRetido * 0.17
 			       LNretido   = LNretido - LNicms     && - LNicmssoper
			ENDCASE



		ENDIF
	ENDIF
	*----------------------------------------------------------*

	LNRetido = ROUND(LNRetido,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNretido)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XT4           NEClcIndiretoCusto VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   18  º
*       º Variable:            NEClcIndiretoCusto                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      76                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xt4     &&  NEClcIndiretoCusto VALID
#REGION 3
RETURN

FUNCTION NEClcIndiretoCusto
PARAMETERS  NEdata_emi, ;
			NEtotproduto, NEvlr_ipi,;
			NEvlrFrete, NEvlrdespes, NEvlrseguro,;
			ITvlrMercad, ITvlripi


	*---------------------------------------------------------------*
	*  CALCULO DO CUSTO INDIRETO
	*---------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	

   	SET DECIMALS TO 6
	IF NEdata_emi < {01.09.1999} &&
   		TMP_totnf 	= 	NEtotproduto 	
   									&& NAO INCLUI O IPI =>
   									&& RATEIA COM O VALOR DA MERCADORIO
   									&& VLRVENDA
   		TMP_frete 	= 	STR(( NEvlrfrete;
   			    			+ NEvlrdespes ;
   			    			+ NEvlrseguro) / TMP_totnf,20,11)

   		TMP_frt   = SUBS(TMP_frete,1,LEN(TMP_frete)-8)
   		TMP_frete = VAL(CHRTRAN(TMP_FRT,",","."))

		*----->>>>>>>>   RATEIO   <<<<<<------*
   		TMP_rateio 	= STR((TMP_frete * ITvlrMercad),20,8) && ipi item
   		TMP_rt   	= SUBS(TMP_rateio,1,LEN(TMP_rateio)-6)
   		TMP_rateio  = VAL(CHRTRAN(TMP_RT,",","."))
	ELSE
   		TMP_rateio  = 	(	( ;
   									NEvlrfrete ;
   								+  	NEvlrdespes ;
   								+  	NEvlrseguro;
   							) ;
   							*     (ITvlrMercad+ITvlripi);
   						) ;
   						/;
			   		   (NEtotproduto + NEvlr_ipi)

	ENDIF
	if (NEtotproduto + NEvlr_ipi) = 0
		TMP_rateio = 0
	endif
	
	LNcstind  = TMP_rateio

  	SET DECIMALS TO 2

RETURN(LNcstind)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XT5           NECanc_Entrada VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   19  º
*       º Variable:            NECanc_Entrada                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      77                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xt5     &&  NECanc_Entrada VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NECanc_Entrada
PARAMETERS LNemp,LNboletim,LNforn,PrmSolicitante
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Cancelar Processo Entrada
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		.f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA
	*		SCGC210.spr
	*		SCGCF211.PRG
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	IF !REGLOCK()
	    WAIT WINDOW "Documento nao poder ser bloqueado para o processo."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*--------------------------------------------------------------*

	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)

	*---------------------------------------------------------------*
	* Verificacao do itens para liberar entrada
	*---------------------------------------------------------------*
	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)
		IF notaite.movestq = "S" AND (LEFT(notaite.situacao,1) $ "Cc")
		    IF !NElocaRegSld()
				LFretorno = .F.
				EXIT
			ENDIF
		ENDIF
		SELE notaite
		SKIP
	ENDDO
	SELE notaite
	IF !LFretorno   && OPERACAO ABORTADA
    	WAIT WINDOW " Os Itens estao irregulares. Tente Novamente.  <ENTER>"
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF			

	*---------------------------------------------------------------*

	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)

	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)
	    WAIT WINDOW "ITEM => "+STR(notaite.ordem,2) NOWAIT
		IF LEFT(notaite.situacao,1) $ "Cc"
   			SELECT notaite
			IF !ULCancEntrait()
				LFretorno = .F.
				EXIT
			ENDIF		
		ENDIF
		SELECT notaite
		SKIP
	ENDDO
	*----------------------------------------------------------*
	=W_DEFPROC("PEDIDO.SPR")
	=PDstat_pedd(notaent.empresa,notaent.pedido)
	*----------------------------------------------------------*
	SELE notaent
	IF LFretorno
		WAIT WINDOW " OK ! " NOWAIT
		SELECT notaent
		m.situacao  =   "B"+RIGHT(notaent.situacao,1)
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO situacao
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)

*-----------------------------------------------------------------*
*  Rotina de apoio para manipular o item atual da nota de entrada
*------------------------------------------------------------------*
FUNCTION ULCancEntrait
	PRIVATE LFretorno
	LFretorno = .t.
	*-------------------------------------------------------------*
   	IF notaite.movestq = "S"
	    IF NElocaRegSld()
    		SELECT notaite
			IF REGLOCK()
				IF !NEDesfatura()
					LFretorno = .F.
				ENDIF
			ELSE
				LFretorno = .F.
			ENDIF
		ELSE
			LFretorno = .F.
		ENDIF
		SELECT  notaite
	ELSE
   		SELECT notaite
		IF REGLOCK()
			m.situacao = 'B'+RIGHT(notaite.situacao,1)
			m.dtfat = wp_dtoper
			=edithand('REGRAVA')
		ELSE
			LFretorno = .F.
		ENDIF
	ENDIF
	*-------------------------------------------------------------*
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XTV           NEDesfatura VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   20  º
*       º Variable:            NEDesfatura                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      78                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xtv     &&  NEDesfatura VALID
#REGION 3
return

*---------------------------------------------------------------*
FUNCTION NEDesfatura
	PRIVATE LFretorno
	LFretorno	=  .t.
	*----------------------------------------------------------*
    SELECT notaite
    SCATTER MEMVAR MEMO
    DO CASE
		CASE notaent.natu_oper = 1
		   m.operacao = 'ECC.'   && ENTRADA/COMPRA/CANCELADA
		CASE notaent.natu_oper = 2
		   m.operacao = 'ETC.'   && ENTRADA/TRANSF/CANCELADA
		CASE notaent.natu_oper = 3
		   m.operacao = 'ERC.'   && ENTRADA/REMESSA/CANCELADA
		CASE notaent.natu_oper = 4
		   m.operacao = 'EDC.'   && ENTRADA/DEVOLUCAO/CANCELADA
		CASE notaent.natu_oper = 5
		   m.operacao = 'EOC.'   && ENTRADA/OUTRAS OPER / CANCE
		CASE notaent.natu_oper = 6
		   m.operacao = 'SOC.'   && SAIDA/OUTRAS OPER / CANCE
    ENDCASE
    LNcstind  = 0
    SET DECIMALS TO 2
    m.situacao 	= 'B'+RIGHT(notaent.situacao,1)
    m.nota 		= notaent.nota
    m.dtfat 	   	=  notaent.data_emi

    IF notaent.pedido > 0 and LEFT(notaite.codigo,7) <> "9999999"
		*-----------------------------------------------------------*
		*    So tratar pedido nos diretorios LOJA ou CENTRAL ou
		* para datas com superiores a 2000
		*-----------------------------------------------------------*
		IF notaent.data >= {01.01.2000}
		  *----------------------------------------------------------*
		  =W_DEFPROC("PEDIDO.SPR")
		  IF !PDregistra_qte(notaent.empresa,notaent.pedido,notaite.codigo,;
							notaite.qtde,"CANC.ENTRADA")
			RETURN(.F.)
		   ENDIF
		   *----------------------------------------------------------*
	    ENDIF
    ENDIF
    SELECT notaite
	=edithand('REGRAVA')
    IF LEFT(codigo,7) = "9999999"   && NAO REG. EM SALD OU ITEM COMENTA.
	  RETURN
    ENDIF
	m.data = notaent.data
	m.hora = notaent.hora
	m.sld_estq = 0
	m.vlr_estq = 0
	m.custo_ind =  LNcstind
    m.dtfat 	   	=  notaent.data_emi
	



    SELECT itemmov
    SET ORDER TO TAG movimento



	************************************************************
    *  INDICE E SEEK ALTERADO EM 10/10/2014 pq na filial estÆo
    * cancelando a nota na filial e alterando a data e que por algum
    * motivo de indice nao foi excluido o item no cancelamento na
    * central
    *************************************************************
	*SEEK STR(notaite.empresa,3)+notaite.codigo+;
	*		DTOS(notaent.data)+notaent.hora+notaent.tipo+;
	*		STR(notaent.nota,7)+STR(notaite.ordem,3)
    *************************************************************


*    SET ORDER TO TAG IT_DA_NOTA

    SET ORDER TO TAG IT_NF_REAL

    SEEK  ;
           STR(notaite.EMPRESA,3);
		  +notaite.CODIGO;
		  +STR(notaite.FAVORECIDO,14);
		  +notaite.TIPO;
		  +STR(notaite.NOTA,7);
		  +DTOS(notaent.DATA_EMI);
		  +STR(notaite.ORDEM,3)			 		


    *************************************************************


	IF !FOUND()
	    SET ORDER TO TAG movimento
		WAIT WINDOW "O registro de movimento no estoque nao foi encontrado"
		RETURN
	ELSE
	    SET ORDER TO TAG movimento
		=REGLOCK(.T.)
		REPLACE operacao WITH "****"   && faz o reg ser ignorado no saldo
									   && anulando seu efeito
		***********************************************************
		SELE itemmov
		LNregmov = RECNO()


	   	=W_DEFPROC("moviment.spr")
		=MVCancelMvto(itemmov.empresa,;
				itemmov.codigo,;
				itemmov.classifica,;
				itemmov.data,;
				itemmov.hora,;
				itemmov.tipo,;
				itemmov.nota,;
				itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e


		SELE itemmov
		GO LNregmov
	ENDIF
	*----------------------------------------------------------*
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XU4           antNEVerifCustoDistocido VALID     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   21  º
*       º Variable:            antNEVerifCustoDistocido           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      79                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xu4     &&  antNEVerifCustoDistocido VALID
#REGION 3
return

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Verificar distorcao entre custo atual
	*    registrado no sistema e custo que esta sendo informado
	*------------------------------------------------------------*
	* COMENTARIO..: A rotina permite detectar erros no lancamento
	*               como codigo e ou valores errados
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*

FUNCTION antNEVerifCustoDistocido
	PARAMETERS PrmEmpresa,PrmBoletim,PrmForn,PrmProduto,;
							 PrmVlrMercadoria, PrmVlrIPI,PrmQtde


	=W_DEFPROC("rotinas.spr")

	PRIVATE LNAtualCusto		&& Custo no estoque atual
	PRIVATE LDdtCusto
	PRIVATE LNCustoEntrada		&& Custo na entrada
	PRIVATE LSUfOrigem,	LSUfDestino
	PRIVATE	NEdata_emi, NEtotproduto, NEvlr_ipi, ;
				NEvlrFrete, NEvlrdespes, NEvlrseguro
	PRIVATE LNCusto_Ind
	PRIVATE LNDeltaCusto
	PRIVATE LNPercentual
	

	PRIVATE LSalias
    LSAlias      = Alias()

    ARQ_Notaent     = NetArqAgain("Notaent")
    ALS_Notaent     = Alias()
	


	*-----------------------------------------------------------*
	SELE &Als_notaent
	SET ORDER TO TAG boletim
	SEEK STR(PrmEmpresa,3)+STR(PrmBoletim,6)+STR(PrmForn,5)
	IF !FOUND()
		LSmsg = "Nao foi possivel verificar distorcao de custo . " +;
				"Doc. "+STR(PrmBoletim,6)+" Nao localizado. "
		=fox_alert(LSmsg,.t.)
	   	=up_fecha("&ALS_notaent")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	LDdtCusto 		= &Als_notaent .DATA
	NEdata_emi 		= &Als_notaent .DATA_EMI
	NEtotproduto	= &Als_notaent .TOTPRODUTO
	NEvlr_ipi		= &Als_notaent .VLR_IPI
	NEvlrFrete		= &Als_notaent .VLRFRETE
	NEvlrdespes		= &Als_notaent .VLRDESPES
	NEvlrseguro		= &Als_notaent .VLRSEGURO

	=W_DEFPROC("notaent.spr")
	LNCusto_Ind = NEClcIndiretoCusto( ;
			NEdata_emi, ;
			NEtotproduto, NEvlr_ipi,;
			NEvlrFrete, NEvlrdespes, NEvlrseguro,;
			PrmVlrMercadoria, PrmVlrIPI)


	
	
	=W_DEFPROC("notaent.spr")
	LSUfOrigem = NEGetUFOrigem(PrmEmpresa, PrmBoletim, PrmForn)

	=W_DEFPROC("notaent.spr")
	LSUfDestino = NEGetUFDestino(PrmEmpresa)



	*-----------------------------------------------------------*
	=W_DEFPROC("preco.spr")
	LNCustoEntrada = (PRCusto(PrmProduto,;
							LSufOrigem,;
							LSufDestino,;
							PrmVlrMercadoria,;
							PrmVlrIPI,;
							PrmForn,;
							LNCusto_Ind))/ PRMqtde
	=W_DEFPROC("estoque.spr")
	LNAtualCusto = EScustoMedio(PrmEmpresa,PrmProduto ,LDdtCusto)

	*--------------------------------------------------------------*
	LNDeltaCusto = abs(LNCustoEntrada - LNAtualCusto)
	LNPercentual = int((LNDeltaCusto/LNAtualCusto)*100)	

	IF LNPercentual > 10
		IF LNDeltaCusto	< 0
			LNPercentual = LNPercentual * -1
		ENDIF
		LSmsg = "Atencao : Variacao de Custo na Ordem de : "+;
				STR(LNPercentual,6)+" % "+chr(13)+;
				" Custo Registrado = "+STR(LNAtualCusto,10,2)+chr(13)+;
				" Custo Neste Doc  = "+STR(LNCustoEntrada,10,2)
				
		=fox_alert(LSmsg,.t.)
	ENDIF
	*--------------------------------------------------------------*
   	=up_fecha("&ALS_notaent")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XUD           NeAjustGru VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   22  º
*       º Variable:            NeAjustGru                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      80                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xud     &&  NeAjustGru VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NeAjustGru
  PARAMETERS A

	IF !USED("empresa")
		IF ! NetUse("empresa")
			WAIT WINDOW " ERRO !"
			RETURN
		ENDIF
	ENDIF

	IF !USED("notaent")
		IF ! NetUse("notaent")
			WAIT WINDOW " ERRO !"
			RETURN
		ENDIF
	ENDIF
	IF !USED("notaite")
		IF ! NetUse("notaite")
			WAIT WINDOW " ERRO !"
			RETURN
		ENDIF
	ENDIF

	IF !USED("itemmov")
		IF ! NetUse("itemmov")
			WAIT WINDOW " ERRO !"
			RETURN
		ENDIF
	ENDIF




	SELE notaent

*		=NEAjustNE(1,4272,1)
*		=NEAjustNE(1,1655,1)
*		=NEAjustNE(1,1675,1)
*		=NEAjustNE(1,1678,1)
*		=NEAjustNE(1,1686,1)
*		=NEAjustNE(1,929,1)
*		=NEAjustNE(1,947,1)
*		=NEAjustNE(1,3005,1)
*		=NEAjustNE(1,3022,1)
*		=NEAjustNE(1,3024,1)
*		=NEAjustNE(1,2924,1)
*		=NEAjustNE(1,8369,1)
*		=NEAjustNE(1,9735,1)
*		=NEAjustNE(1,10456,1)
*		=NEAjustNE(1,10463,1)
*		=NEAjustNE(1,12838,1)
*		=NEAjustNE(1,12850,1)
*		=NEAjustNE(1,12895,1)


    SELE notaent
    set order to tag dt_geral

	go bott
	set escape on
	

	DO WHILE !bof()
		SCATTER MEMVAR
		
		A = STR(EMPRESA,3)+" - " +DTOS(DATA)+ " - "+STR(NOTA,6)
		wait windows a nowait
				
		oreg_e = RECNO()
		=NEAjustNE(NOTAENT.EMPRESA, ;
		            NOTAENT.referencia,;
		              NOTAENT.codforn)
		SELE notaent
	    set order to tag dt_geral
		GO oreg_e
		SKIP -1
	ENDDO
	=UP_fecha("itemmov")
	=UP_fecha("notaent")
	=UP_fecha("notaite")
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XUL           NEAjustNE VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   23  º
*       º Variable:            NEAjustNE                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      81                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xul     &&  NEAjustNE VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NEAjustNE
PARAMETERS LNemp,LNboletim,LNforn
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Ajustar campos criados com novas implementa‡äes
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		.f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA
	*		SCGC210.spr
	*		SCGCF211.PRG
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.

	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	IF !REGLOCK()
	    WAIT WINDOW "Documento nao poder ser bloqueado para o processo."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*--------------------------------------------------------------*

	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)

	*---------------------------------------------------------------*
	* Verificacao do itens para liberar entrada
	*---------------------------------------------------------------*
	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)

		=NEAjustITe()
		SELE notaite
		SKIP
	ENDDO
	SELE notaent
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XUM           NEAjustITe VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   24  º
*       º Variable:            NEAjustITe                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      82                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xum     &&  NEAjustITe VALID
#REGION 3
return

*---------------------------------------------------------------*
FUNCTION NEAjustITe
	PRIVATE vlr_icms, m.icms_subs
	
	PRIVATE LFretorno
	LFretorno	=  .t.
	*----------------------------------------------------------*
  	SELECT notaite
   	LNnota = m.nota     && EVITA APAGAR N. NOTA
   	SCATTER MEMVAR MEMO
   	DO CASE
		CASE m.natu_oper = 1
		   m.operacao = 'ECP.'   && ENTRADA/COMPRA/PROCESSADA
		CASE m.natu_oper = 2
		   m.operacao = 'ETP.'   && ENTRADA/TRANSFERENCIA/PROCESSADA
		CASE m.natu_oper = 3
		   m.operacao = 'ERP.'   && ENTRADA/REMESSA/PROCESSADA
		CASE m.natu_oper = 4
		   m.operacao = 'EDP.'   && ENTRADA/DEVOLUCAO/PROCESSADA
		CASE m.natu_oper = 5
		   m.operacao = 'EOP.'   && ENTRADA/OUTRAS OPER/PROCESSADA
		CASE m.natu_oper = 6
		   m.operacao = 'SOP.'   && SAIDA/OUTRAS OPER / PROCESSADA
   	ENDCASE

	*---------------------------------------------------------------*
	*  CALCULO DO CUSTO INDIRETO
	*---------------------------------------------------------------*
	
	LNcstind = NEClcIndiretoCusto( ;
					notaent.data_emi, ;
					notaent.totproduto, notaent.vlr_ipi, ;
					notaent.vlrFrete, notaent.vlrdespes, ;
					notaent.vlrseguro,;
					notaite.vlrvenda, notaite.vlripi)

	**********************************
   	m.nota 	   	=  notaent.nota
   	m.dtfat 	=  notaent.data_emi
   	m.custo_ind =  LNcstind


    IF m.origem = 1		&& importado
	     m.bsbr_icms  = m.vlrvenda + m.VLRIPI
	ELSE
	     m.bsbr_icms  = m.vlrvenda
	ENDIF

    IF notaent.reduc_icms > 0
       m.aliq_rdu = notaent.reduc_icms
    ENDIF



	if m.reduc_icms > 0
	   m.base_calc = m.bsbr_icms * m.reduc_icms

	else
	   IF notaent.codforn = 1 OR notaent.codforn = 1130
	      m.base_calc = m.bsbr_icms  - ;
			 				(m.bsbr_icms * (4.9/100))
		  m.aliq_rdu  = 4.9/100
	   ENDIF

	   IF notaent.codforn = 2
	      m.base_calc = m.bsbr_icms  - ;
			 				(m.bsbr_icms * (5.19/100))
		  m.aliq_rdu  = 5.19/100
	   ENDIF


	endif
	

	m.vlr_icms = NEClcICMS(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda)


	m.Base_sbbrt = NEBsBrRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,  ;
							notaite.vlripi)
							
	m.Base_subs = NEBsRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.Base_sbbrt)

	m.icms_subs = NEClcRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.vlr_icms,m.Base_subs)


**
   SELECT notaite
	=edithand('REGRAVA')

    SELECT itemmov
	m.data = notaent.data
	m.hora = notaent.hora
	m.sld_estq = 0
	m.vlr_estq = 0
	************************************************************
	*    - GARANTIA CONTRA DUPLICACAO							*
	************************************************************
	SET ORDER TO TAG movimento
	SEEK STR(m.empresa,3) + m.codigo + DTOS(m.data) + m.hora +;
			 		 + m.tipo + STR(m.nota,7) + STR(m.ordem,3)
	IF FOUND()
		=RLOCK()

		REPLACE bsbr_icms with m.bsbr_icms
		REPLACE aliq_rdu  with m.aliq_rdu
		REPLACE base_calc with m.base_calc
		REPLACE vlr_icms  with m.vlr_icms
		REPLACE base_subs with m.base_subs
		REPLACE base_sbbrt with m. base_sbbrt
		REPLACE icms_subs with m.icms_subs

	ENDIF
	*----------------------------------------------------------*
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XUN           antDIConvrtNEDocFiscal VALID       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   27  º
*       º Variable:            antDIConvrtNEDocFiscal             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      83                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xun     &&  antDIConvrtNEDocFiscal VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION antDIConvrtNEDocFiscal
PARAMETERS PrmEmpresa,PrmNota,PrmFornCod

	PRIVATE PrmAlsNE,PrmAlsIT

	*--------------------------------------------------*
	PRIVATE LNCod_Mod_Rf,LaliqOrg
	
	PRIVATE LOperacao

	PRIVATE LUFDstn

	PRIVATE LMunDstn

	PRIVATE LUFOrig
	PRIVATE LMunOrig
	PRIVATE LTab_Cst

	*--------------------------------------------------*


	=W_DEFPROC("NOTAENT.SPR")
	PrmAlsNE = NEGetAlias()

*------------------------------*
*	=W_DEFPROC("ITEMMOV.SPR")
*	PrmAlsIT = IMGetAlias()
*------------------------------*

	=W_DEFPROC("NOTAITE.SPR")
	PrmAlsIT = IEGetAlias()



	=W_DEFPROC("NOTAENT.SPR")
	IF !NELerRegistro(PrmEmpresa,PrmNota,PrmFornCod)
		WAIT WINDOW "NFs nao localizada  <ENTER> " NOWAIT
		RETURN(.F.)
	ENDIF



	=W_DEFPROC("TIPOOPER.SPR")
	LNCod_Mod_Rf  	= TPGetFieldValue("E",  &PrmAlsNE .tipo ,"Cod_Mod_Rf")


	LOperacao = "ENTRADA"

	=W_DEFPROC("EMPRESA.SPR")
	LTab_Cst  = EMGet_TabCst(  &PrmAlsNE .EMPRESA )

	=W_DEFPROC("EMPRESA.SPR")
	LUFDstn   = EMGet_UF(  &PrmAlsNE .EMPRESA )

	=W_DEFPROC("EMPRESA.SPR")
	LMunDstn  = EMGet_Municipio(  &PrmAlsNE .EMPRESA )

	LUFOrig  = &PrmAlsNE .UF
	LMunOrig = &PrmAlsNE .CIDADE


	=W_DEFPROC("TRIBUTAR.SPR")
	LaliqOrg = TRAlqIcmOuUF(LUFOrig)  && ALIQ. EXTERNA DA UF ORIGEM


	=W_DEFPROC("TRIBUTAR.SPR")
	LaliqDst = TRAlqIcmInUF(LUFDstn)  && ALIQ. Interna DA UF DESTINO

	*---------------------------------------------------*

	SELE &PrmAlsIT
	SET ORDER TO TAG ITEMNOTA
	SET NEAR ON
	SEEK STR( &PrmAlsNE .Empresa,3)+;
		LEFT( &PrmAlsNE .TIPO ,1)+;
		STR(  &PrmAlsNE .CODFORN ,5)+;
		STR(  &PrmAlsNE .NOTA ,6)
	SET NEAR OFF

		

	DO WHILE !EOF() ;
	        AND PrmEmpresa     = &PrmAlsIT .empresa;
	        AND &PrmAlsNE .favorecido = &PrmAlsIT .Favorecido;
	        AND PrmNota    	   = &PrmAlsIT .nota ;
	        AND &PrmAlsNE .TIPO = &PrmAlsIT .tipo



		IF  &PrmAlsIT .qtde = 0
			SKIP
			LOOP
		
		ENDIF

	
		=W_DEFPROC("NOTAENT.SPR")
		LNVlrICMS =  NEClcICMS( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , &PrmAlsIT .vlrvenda)

		=W_DEFPROC("NOTAENT.SPR")
		LNVlrICMSSO =  NEIcmsOper( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , &PrmAlsIT .vlrvenda)


		=W_DEFPROC("NOTAENT.SPR")
		LNBsBrRetido =  NEBsBrRetido( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , ;
		        &PrmAlsIT .vlrvenda,;
   		        &PrmAlsIT .vlripi)

		=W_DEFPROC("NOTAENT.SPR")
		LNBsRetido =  NEBsBrRetido( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , ;
   		        LNBsBrRetido)

		=W_DEFPROC("NOTAENT.SPR")
		LNRetido =  NEClcRetido( PrmEmpresa,PrmNota,PrmFornCod,;
		        LNVlrICMS , ;
   		        LNBsRetido,;
   		        LNVlrICMSSO)


		
		IF  &PrmAlsNE .tp_pessoa = 1
			LFieldTmp = CHRTRAN(STR(  &PrmAlsNE .Favorecido,11)," ","0")
		ELSE
			LFieldTmp = CHRTRAN(STR(  &PrmAlsNE .Favorecido,14)," ","0")
		ENDIF

	    M.COD_IDFORN   =   LFieldTmp



	    M.EMPRESA   =  &PrmAlsIT .Empresa
	    M.TIPO   	=  &PrmAlsIT .tipo
	    M.NRO_DOC   =  &PrmAlsIT .nota
	    M.SERIE_DOC =  LEFT( &PrmAlsIT .Serie +"   ",3)

		IF EMPTY(m.serie_doc)
		    m.SERIE_DOC  =     LEFT( "01   ",3)
		endif


	    M.DT_DOC   	=  &PrmAlsNE .data_EMI
    	M.DT_ENTSAI =  &PrmAlsNE .Data

		*----------------------------------------------------*
		*  DADOS GERAIS DO ITEM NO REGISTRO
		*----------------------------------------------------*


	    M.MOD_DOC  	= LNCod_Mod_Rf
	    M.NRO_ITEM 	= &PrmAlsIT .Ordem
    	M.PRODCODIGO= &PrmAlsIT .Codigo
	    M.PRODDESCR = DFLimpaString( &PrmAlsIT .Descricao )
	    M.UNIDADE   = &PrmAlsIT .Unidade

		IF EMPTY(M.UNIDADE)
			M.UNIDADE = "UN"
		ENDIF

		IF EMPTY(M.UNIDADE)
			m.UNIDTRIBUT = "UN"
		ENDIF


    	M.PRECO_TAB    =    &PrmAlsIT .Preco
    	M.PRECOMAXTB   =    0
	    M.PRECOMINTB   =    0
	    M.PRECO_UNIT   =    &PrmAlsIT .Preco
	    M.QTDE   	   =    &PrmAlsIT .Qtde
	    M.VLR_DESCTO   =    0
	    M.PRC_DESCTO   =    0
    	M.VLRDESPFIN   =    0
	    M.VLRDESPOUT   =    0
    	M.VLR_FRETE    =    0
	    M.VLR_SEGURO   =    0
    	M.VLR_FINAL    =    &PrmAlsIT .VlrVenda +;
					    	&PrmAlsIT .vlripi+;
					    	&PrmAlsIT .ICMS_SUBS
    	
    	
    	
		IF &PrmAlsIT .MovEstq = "S"
		    M.IND_MOVEST   =     "SIM"
		ELSE
		    M.IND_MOVEST   =     "NAO"
		ENDIF
    	M.LT_QTITENS   =    0
	    M.LT_NRO   	   =    ""
    	M.LT_DT_FABR   =    {}
	    M.LT_VALIDAD   =    {}
	    M.CLSCOMNC     =    "00"
    	M.CLSGAS       =    "00"
	    M.CLSAGUA      =    "00"
    	M.CLSENRG      =    "00"


		*----------------------------------------------------*
		*  DADOS TRIBUTARIOS DO REGISTRO
		*----------------------------------------------------*
		
	    M.VLRATRIBUT   =     &PrmAlsIT .VlrVenda
    	M.CUSTONAOPE   =     0
	    M.CUSTOMEDAN   =     0

	*--------
	*    M.SALDO_ATU   =    &PrmAlsIT .Sld_estq
	*--------

	*--------
	*    IF  &PrmAlsIT .Sld_estq > 0
	*	    M.CUSTOMEDAT   =    ;
	*              &PrmAlsIT .Vlr_estq  /  &PrmAlsIT .Sld_estq
    *
	*	ELSE
	*	    M.CUSTOMEDAT   =    &PrmAlsIT .Vlr_estq
	*   ENDIF
	*--------
	    M.SALDO_ATU   =    0
	    M.CUSTOMEDAT   =    0

	*----------
    *	IF  &PrmAlsIT .MovEstq = "S"
	*	    IF  LEFT( &PrmAlsIT .Operacao,1) = "S"
	*		    M.SALDO_ANT   =    ;
	*	               &PrmAlsIT .Sld_estq +  &PrmAlsIT .Qtde
	*		ELSE
	*		    M.SALDO_ANT   =    ;
	*              &PrmAlsIT .Sld_estq -  &PrmAlsIT .Qtde
    *
	*		ENDIF
	*	ELSE
	*	    M.SALDO_ANT   =   &PrmAlsIT .Sld_estq
    *	ENDIF
	*----------

	    M.SALDO_ANT    =   0
	    M.CUSTOCONTB   =   0




		LTipo       = &PrmAlsIT .Tipo
		LProduto    = &PrmAlsIT .codigo
		LTp_mercad  = &PrmAlsIT .tp_mercad



*---------
*   	IF &PrmAlsIT .tp_mercad = 7   && SERVICO
*
*			LScfop =DICFOPS(LUFOrig, ;
*					          LMunOrig,;
*					          LUFDstn,;
*					          LMunDstn,;
*					          LTp_mercad,;
*					          LOperacao)
*		    M.CFOP   =   LScfop
*		ELSE
*--------

			=W_DEFPROC("TRIBUTAR.SPR")
			M.CFOP = TRCFO(&PrmAlsIT .Empresa, ;
		              &PrmAlsIT .Tipo,;
		              &PrmAlsIT .tp_mercad,;
		              "ENTRADA")
*--------
*		ENDIF



	    m.CFOP = ALLTRIM(CHRTRAN(m.CFOP,".",""))


		m.origemmrcd = chrtran(str( &PrmAlsIT .origem ,1)," ","0")



		LSCst = DICST_IPI(  &PrmAlsIT .VlrIPI, LOperacao)
    	M.CST_IPI   =   LSCst

	    IF &PrmAlsIT .tp_mercad = 7   && SERVICO
			LSCst = DICST_ISS(  &PrmAlsIT .VlrVenda, LOperacao)
		ELSE
			LSCst = DICST_ISS(  0, LOperacao)
		ENDIF
    	M.CST_ISS   =   LSCst

		LSCst = DICST_PIS(  0, LOperacao)
    	M.CST_PIS   =   LSCst

		LSCst = DICST_COFINS(  0, LOperacao)
    	M.CST_COFINS   =   LSCst

		LSCst = DICST_IR(  0, LOperacao)
    	M.CST_IR   =   LSCst


		*-------------   ICMS ----------------
*--------
*		LSCst = DICST_ICMS(LTab_cst,LTipo,Ltp_mercad,LProduto)
*  		M.CST_ICMS   =   LSCst
*--------

	    M.ALQICMORIG   =   LaliqOrg
	    M.ALQICMDEST   =   LaliqDst

*"CLG/CLH/CFG/CFH/CFM/CID/CLC/CLD/CFC/CFD/CIB/CLE/CLF/CFS/CFE/"
*"CFF/CIC/CLJ/CFL/ASC/CEE/ASI/CFJ/CFK/TAB/TBB/TAC/TBC/TAD/TBD/"
*"RBV/RBU/RBF/RBH/RBJ/RBM/RBN/RBG/RBI/RBL/RBO/RAC/RBC/RIB/RAA/"
*"RBR/RAE/RBE/RID/RBP/RBQ/RCA/RDA/DAF/DBF/DAC/DBC/DBD/DAE/DBE/"
*"DAG/DBG/"


		DO CASE
			CASE;
			 &PrmAlsNE .tipo $ ;
 			 "CLG/CLH/CFG/CFH/CFM/CID/CLC/CLD/CFC/CFD/CIB/CLE/CLF/CFS/CFE/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "CFF/CIC/CLJ/CFL/ASC/CEE/ASI/CFJ/CFK/TAB/TBB/TAC/TBC/TAD/TBD/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "RBV/RBU/RBF/RBH/RBJ/RBM/RBN/RBG/RBI/RBL/RBO/RAC/RBC/RIB/RAA/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "RBR/RAE/RBE/RID/RBP/RBQ/RCA/RDA/DAF/DBF/DAC/DBC/DBD/DAE/DBE/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "DAG/DBG/"
	   		    M.CST_ICMS     =   m.origemmrcd+"90"

		   		M.BC_ICMS         = &PrmAlsIT .base_calc

			    IF &PrmAlsIT .BsBr_Icms >= &PrmAlsIT .base_calc  	
  			      M.BCBRUTAICM    =   &PrmAlsIT .BsBr_Icms
			    ELSE
  		    	  M.BCBRUTAICM    =   &PrmAlsIT .base_calc
		   		ENDIF
      	   		M.VLR_ICMS   	  =   &PrmAlsIT .Vlr_Icms

			    M.BCBRTRTD_S   =   0
			    M.BC_RTD_S     =   0
		    	M.ALQICMRTDS   =   0
		    	M.ICM_RTD_S    =    0


			CASE    LNBsRetido = 0 ;
				AND &PrmAlsIT .vlr_icms = 0 ;
				AND &PrmAlsIT .tp_mercad = 2


	   		    M.CST_ICMS     =   m.origemmrcd+"60"
			    M.BCBRUTAICM   =   0
    			M.IND_REDUCA   =   0
		    	M.BC_ICMS      =   0
    	  		M.VLR_ICMS     =   0

			    M.BCBRTRTD_S   =   &PrmAlsIT .Base_sbbrt
			    M.BC_RTD_S     =   LNBsRetido
		    	M.ALQICMRTDS   =   &PrmAlsIT .Aliq_Icms
		    	M.ICM_RTD_S    =   &PrmAlsIT .ICMS_Subs


			*--------------------------
			*CASE    &PrmAlsIT .BASE_SUBS > 0 ;
			*	AND (&PrmAlsIT .icmssoper > 0 OR &PrmAlsIT .vlr_icms > 0)
			*--------------------------

			CASE    LNBsRetido > 0 ;
				AND (LNVlrICMSSO > 0 ;
				     OR &PrmAlsIT .vlr_icms > 0)

				IF &PrmAlsIT .vlr_icms = 0
			   		M.BC_ICMS    =   &PrmAlsIT .baseicmso
	      	   		M.VLR_ICMS   =   LNVlrICMSSO
				ELSE
			   		M.BC_ICMS    =   &PrmAlsIT .base_calc
	      	   		M.VLR_ICMS   =   &PrmAlsIT .Vlr_Icms
				ENDIF


	   		    M.CST_ICMS        =   m.origemmrcd+"10"

			    IF &PrmAlsIT .BsBr_Icms >= &PrmAlsIT .base_calc  	
  			      M.BCBRUTAICM   =   &PrmAlsIT .BsBr_Icms
			    ELSE
  		    	  M.BCBRUTAICM   =   &PrmAlsIT .base_calc
		   		ENDIF


			    M.BCBRTRTD_S   =   &PrmAlsIT .Base_sbbrt
			    M.BC_RTD_S     =   &PrmAlsIT .Base_subs
		    	M.ALQICMRTDS   =   &PrmAlsIT .Aliq_Icms
		    	M.ICM_RTD_S    =   &PrmAlsIT .ICMS_Subs


    	  	OTHERWISE
	  		    M.CST_ICMS        = m.origemmrcd+ &PrmAlsIT .cst + "0"
		   		M.BC_ICMS         =   &PrmAlsIT .base_calc

			    IF &PrmAlsIT .BsBr_Icms >= &PrmAlsIT .base_calc  	
  			      M.BCBRUTAICM   =   &PrmAlsIT .BsBr_Icms
			    ELSE
  		    	  M.BCBRUTAICM   =   &PrmAlsIT .base_calc
		   		ENDIF
      	   		M.VLR_ICMS   =   &PrmAlsIT .Vlr_Icms

			    M.BCBRTRTD_S   =   0
			    M.BC_RTD_S     =   0
		    	M.ALQICMRTDS   =   0
		    	M.ICM_RTD_S   =    0

      	ENDCASE

		M.IVA          =   &PrmAlsIT .Iva
		
		DO CASE
			CASE SUBS(M.CST_ICMS,2,2) $ "30/40/41/50/60"
			    M.ALIQ_ICMS    =   0
		    	M.BC_ICMS      =   0
    	  		M.VLR_ICMS     =   0
			OTHERWISE			
			    M.ALIQ_ICMS  =   &PrmAlsIT .Aliq_Icms
		ENDCASE




		Laliq  = ABS(LaliqOrg - LaliqDst)
    	M.DIF_ALIQ   =   Laliq



		=W_DEFPROC("TRIBUTAR.SPR")
		LRgmTrb = TRDef_RgTrbMercad(LUFOrig,;
		                           &PrmAlsIT .Codigo,;
						 'RETORNAR STRING' )

	    M.RGTRIBORIG   =   LRgmTrb

		=W_DEFPROC("TRIBUTAR.SPR")
		LRgmTrb = TRDef_RgTrbMercad(LUFDstn,;
					  &PrmAlsIT .Codigo,;
						 'RETORNAR STRING' )

	    m.RGTRIBDEST   =   LRgmTrb

	  	IF &PrmAlsNE .BASE_ISENT = 0
		    M.BASE_ISENT   =   0
		ELSE
		    M.BASE_ISENT   =   ;
		    				M.VLR_FINAL ;
						    - ( &PrmAlsIT .vlripi;
					    	+   &PrmAlsIT .ICMS_SUBS)
		ENDIF
		
		
	  	IF &PrmAlsNE .BASE_OUTR = 0
	    	M.BASE_OUTR    =   0
	    ELSE
		    M.BASE_OUTR   =   &PrmAlsIT .base_outr
	    ENDIF



	    M.BCBRTRTD_E   =   0
    	M.BC_RTD_E   =   0
	    M.ICM_RTD_E   =   0

	    M.INDAPURIPI   =   "1"


		IF m.origemmrcd = "1"   && IMPORTADA
		    M.BC_IPI    =   &PrmAlsIT .vlrvenda
	    	M.ALIQ_IPI  =   &PrmAlsIT .aliq_ipi
		    M.VLR_IPI   =   &PrmAlsIT .vlripi
		ELSE
		    M.BC_IPI    =   0
	    	M.ALIQ_IPI  =   0
		    M.VLR_IPI   =   0
		ENDIF		
		




	    M.BC_ISS   =   &PrmAlsIT .base_iss
	    M.ALIQ_ISS   =   &PrmAlsIT .aliq_iss
    	M.VLR_ISS   =   &PrmAlsIT .vlr_iss

	*---------
	*    IF &PrmAlsIT .vlr_issrtd > 0
	*    	M.BC_ISS_RTD   =   &PrmAlsIT .base_iss
	*	    M.ALIQ_ISSRT   =   &PrmAlsIT .aliq_iss
	*	    M.VLR_ISSRTD   =   &PrmAlsIT .vlr_issrtd
	*	ELSE
	*   	M.BC_ISS_RTD   =   0
	*	    M.ALIQ_ISSRT   =   0
	*	    M.VLR_ISSRTD   =   0
	*	ENDIF
    *--------------
    	M.BC_ISS_RTD   =   0
	    M.ALIQ_ISSRT   =   0
	    M.VLR_ISSRTD   =   0

	    M.BC_PIS   	 =   0
    	M.ALIQ_PIS   =   0
	    M.QTDBASEPIS =   0
    	M.VLR_PIS    =   0
	    M.PIS_RTD    =   0
    	M.BC_COFINS  =   0
	    M.ALIQCOFINS =   0
    	M.QTDBASECOF =   0
	    M.VLR_COFINS =   0
    	M.COFINS_RTD =   0
    	M.VLRALQCFRT =   0
	    M.BC_IR   	 =   0
	    M.ALIQ_IR    =   0
	    M.VLR_IR     =   0
    	M.IR_RTD     =   0
	    M.BC_CSLL    =   0
    	M.ALIQ_CSLL  =   0
	    M.VLR_CSLL   =   0
    	M.ADNTA_CSLL =   0
	    M.LANC_AUTO  =   "SIM"

***		=DISalvarRegistro()


		LEmpresa    = m.Empresa
		LMod_Doc    = m.Mod_Doc
		LCod_IdForn = m.Cod_IdForn
		LNro_Doc    = m.Nro_Doc
		LSerie_Doc  = m.Serie_Doc
		LNro_Item   = m.Nro_Item


		SELE &PBDocFisItAlias
		SET ORDER TO TAG ITEM
		SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	      STR(LNro_Doc,7)+LSerie_Doc+STR(LNro_Item,5)
	
		IF !found()
			APPEND BLANK
		ENDIF
		=RLOCK()
		GATHER MEMVAR
		UNLOCK

		SELE &PrmAlsIT
		SKIP
	ENDDO
	*---------------------------------------------------*
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XVJ           xxNEBCIcmsOper VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   28  º
*       º Variable:            xxNEBCIcmsOper                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      84                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xvj     &&  xxNEBCIcmsOper VALID
#REGION 3
RETURN

FUNCTION xxNEBCIcmsOper
	PARAMETERS LNemp,LNboletim,LNforn, LScod, ;
	      LNvlrMercadoria, PrmPrdtOrigem




	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal


	PRIVATE LNbaseicms,LNicms
	PRIVATE LNaliq_icms



	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()


    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_grfiscal+ARQ_grfiscal) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	LNicms		=	0
	LNbaseicms  = 0





	IF  &ALS_notaent .icms_subs > 0


	    LNUFOrigem	 = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	    LNUFDestino  = NEGetUFDestino(LNemp,LNboletim,LNforn)

	   IF LNUFOrigem = LNUFDestino
		  =W_DEFPROC("TRIBUTAR.SPR")
		  LNaliq_icms  = TRAlqIcmInUF(LNUFOrigem)
	   ELSE
		  =W_DEFPROC("TRIBUTAR.SPR")
		  LNaliq_icms  = TRAlqIcmOuUF(LNUFOrigem,PrmPrdtOrigem)
	   ENDIF


		LNbaseicms    = LNvlrMercadoria

                             ** retirado ==> + &ALS_notaent .vlrfrete


		*-------------------------------------------------------------*
		*  A base de ICMS e reduzida em 4.90% quando o fornecedor for
		* firestone em funcao da mudanca na cobranca de PIS e COFINS
		* que passaram a ser retidos.
		*-------------------------------------------------------------*
		

		if &ALS_notaent .reduc_icms > 0
			LNbaseicms  = LNvlrMercadoria * &ALS_notaent .reduc_icms
		ELSE
			if &ALS_notaent .codforn = 1
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.049
			endif

			if &ALS_notaent .codforn = 2
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.0519
			endif

		ENDIF

		LNicms	= (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	ENDIF
	
	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNbaseicms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XVS           NEGeraXML_NOTA VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   29  º
*       º Variable:            NEGeraXML_NOTA                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      85                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xvs     &&  NEGeraXML_NOTA VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NEGeraXML_NOTA
PARAMETERS PrmEmpresa,PrmBoletim,PrmForn


PRIVATE ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc


STORE 0 TO  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc



	=W_DEFPROC("NOTAENT.SPR")
	=NEDefIDNFDocFiscal(PrmEmpresa,PrmBoletim,PrmForn,;
						PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						RtnSerie_Doc)

	*---------------------------------------------------

	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFGerXMLDocFiscal(PrmEmpresa,RtnMod_Doc,RtnCOD_IDFORN,;
		  RtnNro_Doc,RtnSerie_Doc )

	  	WAIT WINDOW "Nao foi possivel gerar XML EFD/NFe. <ENTER>"
		RETURN(.f.)
	ENDIF


RETURN(.T.)

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XVZ           NEEnviaNfe_NOTA VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   30  º
*       º Variable:            NEEnviaNfe_NOTA                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      86                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xvz     &&  NEEnviaNfe_NOTA VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NEEnviaNfe_NOTA
PARAMETERS PrmEmpresa,PrmBoletim,PrmForn


PRIVATE ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc


STORE 0 TO  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc

	=W_DEFPROC("NOTAENT.SPR")
	=NEDefIDNFDocFiscal(PrmEmpresa,PrmBoletim,PrmForn,;
						PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						RtnSerie_Doc)

	*---------------------------------------------------

	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFGerXMLDocFiscal(PrmEmpresa,RtnMod_Doc,RtnCOD_IDFORN,;
		  RtnNro_Doc,RtnSerie_Doc )

	  	WAIT WINDOW "Nao foi possivel gerar XML EFD/NFe. <ENTER>"
		RETURN(.f.)
	ENDIF



	=W_DEFPROC("DOCFISCA.SPR")
	IF !(DFNeEnvNFeXML(PrmEmpresa,RtnMod_Doc,RtnNro_Doc))
	  	WAIT WINDOW "Nao foi possivel copiar XML para NFe. <ENTER>"
		RETURN(.f.)
	ENDIF


RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XW0           NERtrnoNfe_NOTA VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   31  º
*       º Variable:            NERtrnoNfe_NOTA                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      87                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xw0     &&  NERtrnoNfe_NOTA VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NERtrnoNfe_NOTA
PARAMETERS PrmEmpresa,PrmBoletim,PrmForn, PrmEspera



PRIVATE ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc


	=W_DEFPROC("NOTAENT.SPR")
	=NEDefIDNFDocFiscal(PrmEmpresa,PrmBoletim,PrmForn,;
						PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						RtnSerie_Doc)


	IF TYPE("PrmEspera") <> "C" OR EMPTY(PrmEspera)
		PrmEspera = "ESPERA"
	ENDIF



	*-------------------------------------------------------------*



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc





	=W_DEFPROC("DOCFISCA.SPR")

		LSstatus = (DFRespostaNFe;
		      (;
				PrmEmpresa,;
	   			RtnMod_Doc,;
	   			RtnNro_Doc,;
			     PrmEspera,;
				  RtnStatus,;
				  RtnRecibo,;
			      RtnProtocolo,;
		          RtnChvNFe,;
		          RtnJstfCanc,;
		          RtnPrtcCanc;
			  );
			)




	IF  "ERRO" $ LSstatus
		WAIT WINDOW LSstatus  NOWAIT
	ENDIF


	=W_DEFPROC("NOTAENT.SPR")
	IF NELerRegistro(PrmEmpresa,PrmBoletim,PrmForn)
  	    	
	    	=NESetPropVT("NFE_STATUS",RtnStatus)
			=NESetPropVT("NFE_RECIBO",RtnRecibo)
			=NESetPropVT("NFE_PROTOC",RtnProtocolo)
		*****	=NESetPropVT("NFE_CHV",RtnChvNFe)
			=NESetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=NESetPropVT("NFEPRTCCAN",RtnPrtcCanc)

			=NESalvarRegistro()
	ENDIF




	=W_DEFPROC("DOCFISCA.SPR")
	IF (DFLerRegistro(PrmEmpresa,RtnMod_Doc,RtnCOD_IDFORN,;
			  RtnNRO_DOC,RtnSerie_Doc ))

 	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
			=DFSetPropVT("NFE_RECIBO",RtnRecibo)
			=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
			=DFSetPropVT("NFE_CHV",RtnChvNFe)
			=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)

			=DFSalvarRegistro()
	ENDIF

RETURN






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XW1           NEDefIDNFDocFiscal VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   33  º
*       º Variable:            NEDefIDNFDocFiscal                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      88                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xw1     &&  NEDefIDNFDocFiscal VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NEDefIDNFDocFiscal
PARAMETERS PrmEmpresa,PrmBoletim,PrmForn,;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc,;
	 RtnDocEletro


	PRIVATE NFAlias

	PRIVATE  ;
	 PrmNota
	
	PRIVATE LNtp_pessoa


    PrmNota = PrmBoletim




	=W_DEFPROC("NOTAENT.SPR")
	NFAlias = NEGetAlias()


	=W_DEFPROC("NOTAENT.SPR")
	IF !NELerRegistro(PrmEmpresa,PrmBoletim,PrmForn)

		MSG = "NF Entrada nao localizada ";
		     +str(PrmBoletim,7);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	PrmTipo    		= &NFAlias .Tipo

    PrmSerie  =     LEFT( &NFAlias .Serie +"   ",3)

	IF EMPTY(PrmSerie)
	    PrmSerie  =     LEFT( "01   ",3)
	endif





	=W_DEFPROC("CLIENTES.SPR")
	LNtp_pessoa =  CLDef_TipoPessoa(  &NFAlias .Favorecido)


	=W_DEFPROC("CLIENTES.SPR")
	LNtp_pessoa =  CLDef_TipoPessoa( &NFAlias .Favorecido)


*	IF  LNtp_pessoa = 1
*		 RtnCOD_IDFORN = CHRTRAN(STR(  &NFAlias .Favorecido,11)," ","0")
*	ELSE
		 RtnCOD_IDFORN = CHRTRAN(STR(  &NFAlias .Favorecido,14)," ","0")
*	ENDIF

	RtnSerie_Doc  = PrmSerie
    RtnNro_Doc    =  PrmNota


 *------------------------------------------------------------------*
 * em maio de 2013 o campo notareal foi criado para atender notas de
 * entrada com mais de seis digitos no numero. N hora de gerar para
 * o dfis enviamos o numero real que pode ter + de 6 digitos
 *------------------------------------------------------------------*

    RtnNro_Doc    =   &NFAlias .notareal



	DO CASE

		CASE ALLTRIM( &NFAlias .nf_mod_doc) <> ""

			RtnMod_Doc   =   &NFAlias .nf_mod_doc
		    m.MOD_DOC    =   &NFAlias .nf_mod_doc

		CASE PrmBoletim > 1000000 AND PrmBoletim < 2000000
			RtnMod_Doc   =   "2D"  && CUPOM
		    m.MOD_DOC    =   "2D"  && CUPOM

			RtnDocEletro = "NAO"

		CASE PrmBoletim > 3000000 AND PrmBoletim < 4000000
			RtnMod_Doc   =   "55"  && NFe
		    m.MOD_DOC    =   "55"  && NFe


			RtnSerie_Doc  = "00 "


			RtnDocEletro = "SIM"
		
		OTHERWISE			
			=W_DEFPROC("TIPOOPER.SPR")
			RtnMod_Doc    = ;
			   TPGetFieldValue("E",  &NFAlias .tipo ,"Cod_Mod_Rf")
		    m.MOD_DOC    = RtnMod_Doc

			RtnDocEletro = "NAO"

	ENDCASE
	






RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XW2           NF_CancDFis VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   34  º
*       º Variable:            NF_CancDFis                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      89                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xw2     &&  NF_CancDFis VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NF_CancDFis
PARAMETERS PrmEmpresa, PrmNota, PrmObjetivo




	PRIVATE NFAlias


	PRIVATE LSAlias
	LSalias		= 	ALIAS()


	=W_DEFPROC("NOTA.SPR")
	NFAlias = NFGetAlias()



	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NF nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	*-->>>>>>>>>>>>>     PARA ENVIO NFE
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= &NFAlias .Serie
	PrmTipo    		= &NFAlias .Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*

	*-->>>>>>>>>>>       PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc
	*----------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)





	IF  RtnMOD_DOC    <>   "55"
		RETURN(.T.)
	ENDIF

	RETURN(.T.)


    PRIVATE LFOk_NFe

	LFOk_NFe = .T.
*
*	=W_DEFPROC("DOCFISCA.SPR")
*	LFOk_NFe = DFConvrtNFDocFiscal(PrmEmpresa,PrmNota)
*


	PRIVATE LSXMLObjetivo

	LSXMLObjetivo = "CANCELAMENTO"

	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		LFOk_NFe =(DFGerXMLDocFiscal(PrmEmpresa,;
									RtnMod_Doc,;
 						            RtnCOD_IDFORN,;
		 							RtnNro_Doc,;
		 							RtnSerie_Doc,;
		 							LSXMLObjetivo ))
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe
	   LFOk_NFe = (DFEnviaNFeXML(;
	   					PrmEmpresa,;
	   					RtnMod_Doc,;
	   					RtnNro_Doc))
	ENDIF

	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe
		LSstatus = (DFRespostaNFe;
		      (;
				PrmEmpresa,;
				RtnMod_Doc,;
	   			RtnNro_Doc,;
			     "ESPERA",;
				  RtnStatus,;
				  RtnRecibo,;
			      RtnProtocolo,;
		          RtnChvNFe,;
		          RtnJstfCanc,;
		          RtnPrtcCanc;
			  );
			)
		IF "ERRO" $ LSstatus
			 LFOk_NFe = .F.
		ENDIF
		IF !("CANCELADA" $ LSstatus)
			 LFOk_NFe = .F.
		ENDIF

	ENDIF


	IF LFOk_NFe
		=W_DEFPROC("NOTA.SPR")
		IF NFLerRegistro(PrmEmpresa, PrmNota)
  	    	=NFSetPropVT("NFE_STATUS",RtnStatus)
			=NFSetPropVT("NFE_RECIBO",RtnRecibo)
			=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
			=NFSetPropVT("NFE_CHV",RtnChvNFe)
			=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
			=NFSalvarRegistro()
		ENDIF
	ENDIF

	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		IF (DFLerRegistro(PrmEmpresa,RtnMod_Doc,;
		      RtnCOD_IDFORN,;
			  RtnNro_Doc,RtnSerie_Doc ))
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
		ENDIF
	ENDIF


	=W_DEFPROC("rotinas.spr")


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	*--------------------------------------------------------------*
RETURN(LFOk_NFe)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XWZ           NEDefCancDFis VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   35  º
*       º Variable:            NEDefCancDFis                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      90                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xwz     &&  NEDefCancDFis VALID
#REGION 3
return
*---------------------------------------------------------------*

********************
FUNCTION NEDefCancDFis
PARAMETERS PrmEmpresa



	*----------------------------------------------------*

	*----------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "CANCELAMENTO"


RETURN(PrmObjetivo)


FUNCTION NEWNEDefCancDFis

	*-----------------------------------------------------------*
	PRIVATE LSscr_ENT

	*------------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ENT = EMGetFieldValue(PrmEmpresa,"ESCRT_ENT")


	*------------------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "NAO INTEGRAR"



	IF LSscr_ENT = "S"
		PrmObjetivo = "ESCRITURACAO"

	ENDIF

RETURN(PrmObjetivo)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XX5           NEDefEnvDFis VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   36  º
*       º Variable:            NEDefEnvDFis                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      91                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xx5     &&  NEDefEnvDFis VALID
#REGION 3
return
*---------------------------------------------------------------*

********************
FUNCTION NEDefEnvDFis
PARAMETERS PrmEmpresa,PrmModDoc


	*----------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "ESCRITURACAO"


	*-----------------------------------------------------------*
	PRIVATE LSscr_ENT


	*------------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ENT = EMGetFieldValue(PrmEmpresa,"ESCRT_ENT")

	*------------------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "NAO INTEGRAR"



	IF LSscr_ENT = "S"
		PrmObjetivo = "ESCRITURACAO"

	ENDIF

    IF TYPE("PrmModDoc")  <> "C"
       PrmModDoc = ""
    endif
   	IF LSscr_ENT = "C"     && C =>CONSULTAR DOC ELETRONICO
       IF PrmModDoc $  "55/57"
		   PrmObjetivo = "CONSULTAR"
       ENDIF
    ENDIF




RETURN(PrmObjetivo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XXC           NEEscriturar VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   37  º
*       º Variable:            NEEscriturar                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      92                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xxc     &&  NEEscriturar VALID
#REGION 3
return
*---------------------------------------------------------------*
FUNCTION NEEscriturar
PARAMETERS PrmAlias,LSExibeMsg


	PRIVATE LSExibeMsg
	IF TYPE("LSExibeMsg") <> "C"
		LSExibeMsg = "SIM"
	ENDIF


	*-------------------------------------------------------------*
    * GERANDO DFIS
	*-------------------------------------------------------------*
	PRIVATE LSobjetivo

	LSobjetivo = NEDefEnvDFis(  &PrmAlias .Empresa, &PrmAlias .nf_mod_doc )

	IF  LSobjetivo $ "ESCRITURACAO/CONSULTAR"

		=W_DEFPROC("NOTAENT.SPR")
		IF !(NEGeraDFIS( &PrmAlias .Empresa,;
			             &PrmAlias .Nota,;
			             &PrmAlias .CodForn,;
			             LSExibeMsg,;
			             PrmObjetivo))
			IF LSExibeMsg = "SIM"

	   			DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				"  O Emissor de Documentos Fiscais"+;
				" nao acatou a Escrituracao."+;
     			" Repita o processo e se persistir a negacao entre "+;
   	 			" em contato com suporte"
			ENDIF
			
   			SELE notaent

   			RETURN(.f.)
	 	ENDIF
	ENDIF


	*---------------------------------------------------------------*


	*----------------------------------------------------------------*
	wp_msg = " ** Faturamento Concluido ** "
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*

RETURN(.T.)







*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XXJ           NEGeraDFIS VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   41  º
*       º Variable:            NEGeraDFIS                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      93                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xxj     &&  NEGeraDFIS VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NEGeraDFIS
PARAMETERS PrmEmpresa,PrmBoletim,PrmForn,PrmExibeMsg,PrmObjetivo
	*-----------------------------------------------*
	*---> Notaent.Empresa -> PrmEmpresa
	*---> Notaent.Nota    -> PrmBoletim
	*---> Notaent.CodForn -> PrmForn
	*-----------------------------------------------*


	PRIVATE PrmObjetivo
	*-----------------------------------------------------*

	PRIVATE PrmAlias

	PRIVATE LSalias

	*--------------------------------------------------*

	PRIVATE ;
    	 PrmSerie,;
		 PrmTipo,;
    	 RtnNro_Doc,;
		 RtnMod_Doc,;
		 RtnCOD_IDFORN,;
		 RtnSerie_Doc,;
		 RtnDocEletro
	*--------------------------------------------------*
	*----------------------------------------------------*

	*-->>>>>>>>>>>       PARA DADOS RETORNO DO CONTROLADOR DFis
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc
	*----------------------------------------------------*

	LSalias = ALIAS()
	
	*-----------------------------------------------*

    IF TYPE("PrmObjetivo") <> "C"
		PrmObjetivo = "ESCRITURACAO"
	ENDIF

	IF type("PrmExibeMsg") $ "C"
		PrmExibeMsg	 = "SIM"
	ENDIF


	=W_DEFPROC("NOTAENT.SPR")
	PrmAlias = NEGetAlias()


	=W_DEFPROC("NOTAENT.SPR")
	IF !NELerRegistro(PrmEmpresa,PrmBoletim,PrmForn)
		MSG = "NEnt nao localizada ";
		     +str(PrmNota,7);
		     +"Forn:"+str(PrmFornCOD,14);
		     +" <ENTER>"
		WAIT MSG NOWAIT
		RETURN(.F.)
	ENDIF


	* SITUACAO = c PROCESSADA AGUARDA ESCRITURACAO
	*          = C PROCESSADA E ESCRITURADA

	IF  !(LEFT( &PrmAlias .SITUACAO,1) $ "cC")

		* NAO PROCESSAR ENTRADAS NAO EFETIVADAS
		
		RETURN(.T.)
	ENDIF


	IF   &PrmAlias .tipo $ "QLA/SCA"
		* NAO PROCESSAR AJUSTES DE ESTOQUE
				
		RETURN(.T.)
	ENDIF


	*---------------------------------------------------*
	
	*---------------------------------------------------*

	STORE 0 TO  ;
    	 PrmSerie,;
		 PrmTipo,;
    	 RtnNro_Doc,;
		 RtnMod_Doc,;
		 RtnCOD_IDFORN,;
		 RtnSerie_Doc,;
		 RtnDocEletro


	PrmSerie = &PrmAlias .serie
	PrmTipo  = &PrmAlias .tipo


	=W_DEFPROC("NOTAENT.SPR")
	=NEDefIDNFDocFiscal(PrmEmpresa,PrmBoletim,PrmForn,;
						PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						RtnSerie_Doc,RtnDocEletro)



	*--------------------------------------------------------*

    PRIVATE LFOk_NFe

	LFOk_NFe = .T.


	
	=W_DEFPROC("DOCFISCA.SPR")
	LFOk_NFe = DFConvrtNEDocFiscal(PrmEmpresa,PrmBoletim,;
              	PrmForn,PrmExibeMsg)




	*--------------------------------------------------------*

	PRIVATE LSXMLObjetivo

	LSXMLObjetivo = PrmObjetivo

	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		LFOk_NFe =(DFGerXMLDocFiscal(PrmEmpresa,;
									RtnMod_Doc,;
 						            RtnCOD_IDFORN,;
		 							RtnNro_Doc,;
		 							RtnSerie_Doc,;
		 							LSXMLObjetivo,PrmExibeMsg ))



	ENDIF
	*----------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe

*--------------------------------------------------------
*   altarada para permitir a subrotina verifica se existe duplicata para o
*    doc fiscal informado
*---------------------------------------------------------
*	   LFOk_NFe = (DFEnviaNFeXML(;
*	   					PrmEmpresa,;
*	   					RtnMod_Doc,;
*	   					RtnNro_Doc))
*---------------------------------------------------------
		LFOk_NFe =(DFEnviaNFeXML(PrmEmpresa,;
									RtnMod_Doc,;
 						            RtnCOD_IDFORN,;
		 							RtnNro_Doc,;
		 							RtnSerie_Doc,;
		 							LSXMLObjetivo ))

	ENDIF


	*----------------------------------------------------------*


	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe
			
			
*--------------------------------------------------------
*   altarada para permitir a subrotina verifica se existe duplicata para o
*    doc fiscal informado
*---------------------------------------------------------
*		LSstatus = (DFRespostaNFe;
*		      (;
*				PrmEmpresa,;
*				RtnMod_Doc,;
*	   			RtnNro_Doc,;
*			     "ESPERA",;
*				  RtnStatus,;
*				  RtnRecibo,;
*			      RtnProtocolo,;
*		          RtnChvNFe,;
*		          RtnJstfCanc,;
*		          RtnPrtcCanc;
*			  );
*			)
*
		LSstatus = (DFRespostaNFe;
		      (;
				PrmEmpresa,;
				RtnMod_Doc,;
                RtnCOD_IDFORN,;
	   			RtnNro_Doc,;
	   			RtnSerie_Doc,;
			     "ESPERA",;
				  RtnStatus,;
				  RtnRecibo,;
			      RtnProtocolo,;
		          RtnChvNFe,;
		          RtnJstfCanc,;
		          RtnPrtcCanc;
			  );
			)

			
		IF "ERRO" $ LSstatus

			LSMSG = LEFT(str(PrmBoletim,7)+ "-" + LSstatus,225)

			IF	PrmExibeMsg	 = "SIM"

				=fox_alert(LSmsg,.t.)

			ENDIF
			
		    LFOk_NFe = .F.
		
		ENDIF

	ENDIF


	IF LFOk_NFe
		=W_DEFPROC("NOTAENT.SPR")
		IF NELerRegistro(PrmEmpresa,PrmBoletim,PrmForn)
  	    	=NESetPropVT("NFE_STATUS",RtnStatus)
			=NESetPropVT("NFE_RECIBO",RtnRecibo)
			=NESetPropVT("NFE_PROTOC",RtnProtocolo)

		****	=NESetPropVT("NFE_CHV",RtnChvNFe)


			=NESetPropVT("SITUACAO","C")

			=NESalvarRegistro()
		ENDIF
	ENDIF



	=W_DEFPROC("rotinas.spr")


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF


   *-----<<<< CONSIDERA A NFe MESMO COM ERRO >>>>*------						
   ******* RETURN(.T.) ALTERADO EM  30/01/2012 COM EXPORT IMEDIATA
   *----------------------------------------------------


	*--------------------------------------------------------------*
RETURN(LFOk_NFe)







RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XXK           NEProcEcrtDt VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   42  º
*       º Variable:            NEProcEcrtDt                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      94                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xxk     &&  NEProcEcrtDt VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NEProcEcrtDt
PARAMETER PrmEmp,PrmDtIni,PrmDtFim



	PRIVATE  LNregistro

	PRIVATE LN_NFregistro

    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTAENT")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	=DFVerifyInst()



	SELE &ALSNota
	SET ORDER TO TAG RLDTENTR
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT  WHILE !EOF() AND &ALSNota .empresa = PrmEmp ;
				AND &ALSNota .data >= PrmDtIni ;
    	        AND &ALSNota .data <= PrmDtFim ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0

    BKregistro  = LNregistro
    BKimpressos = LNimpressos
    BKimpressao = LNimpressao


	*----------------------------------------------------*

	DO WHILE !EOF() ;
					AND	LFsegue = .t. ;
					AND &ALSNota .empresa = PrmEmp ;
					AND &ALSNota .data >= PrmDtIni ;
	                AND &ALSNota .data <= PrmDtFim
		

		DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	    LNregistro  = BKregistro
    	LNimpressos = BKimpressos
	    LNimpressao = BKimpressao


		=UPtermo()

	    BKregistro  = LNregistro
    	BKimpressos = LNimpressos
	    BKimpressao = LNimpressao


		IF &ALSNota .nfe_status <> "PROCESSADA" ;
		   AND !( &ALSNota .tipo $ "QLA/SCA")

			LPrmNota = &ALSNota .Nota
	
			LN_NFregistro = RECNO()
			LSExibeMsg = "NAO"

	
			=NEEscriturar(ALSNota,LSExibeMsg)

			SELE  &ALSNota
			SET ORDER TO TAG RLDTENTR
			GO LN_NFregistro
		ENDIF

 		SKIP
		CTR = 	CTR + 1
	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XXL           NEPendEcrtDt VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   43  º
*       º Variable:            NEPendEcrtDt                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      95                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xxl     &&  NEPendEcrtDt VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NEPendEcrtDt
PARAMETER PrmEmp,PrmDtIni,PrmDtFim



	PRIVATE  LNregistro

	PRIVATE LN_NFregistro

    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTAENT")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF




	SELE &ALSNota
	SET ORDER TO TAG RLDTENTR
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI

    SET TALK ON

    SELECT ;
        NT.EMPRESA, ;
        NT.NOTA, ;
        NT.TIPO, ;
        NT.NF_MOD_DOC, ;
        NT.DATA, ;
        NT.CODFORN;
    FROM &ALSNota NT ;
    WHERE ;
	        NT.empresa = PrmEmp ;
	    AND NT.data >= PrmDtIni ;
        AND NT.data <= PrmDtFim ;
        AND NT.nfe_status <> "PROCESSADA" ;
		AND !( NT.tipo $ "QLA/SCA");
	INTO TABLE C:\NFe\pendEnt ;
	ORDER BY ;
        NT.DATA, ;
        NT.NF_MOD_DOC, ;
        NT.NOTA
	
	sele pendEnt
	brows  TITLE  "C:\NFe\pendEnt.dbf"
	use

    SET TALK OFF

	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XYA           NEClcICMS VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   44  º
*       º Variable:            NEClcICMS                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      96                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xya     &&  NEClcICMS VALID
#REGION 3
RETURN

FUNCTION NEClcICMS
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria, ;
		PrmPrdtOrigem, Notaite_PK,;
		PrmAliq_rdu,;
		PrmAliq_ICMS
		

    *-------------------------------------------*
    * RETORNA O INDICE PARA PERCENTAUL
    * EX: INDICE 0,915
    *     100 - 0,915 * 100 = 8,5%
    *-------------------------------------------*


    IF PrmAliq_rdu <> 0
	    IF PrmAliq_rdu < 1
    	  PrmAliq_rdu = 100 - PrmAliq_rdu * 100
	    ENDIF
	endif



	
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal




	PRIVATE LNbaseicms,LNicms

	PRIVATE LNUFOrigem
	PRIVATE LNUFDestino


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()


    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()



    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()



	IF (ARQ_empresa+ARQ_notaent+ARQ_grfiscal+ARQ_grfiscal;
	     ) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF




    *----------------------------------------------------------*


	LNicms		=	0

    *----------------------------------------------------------*


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	LNicms		  =	0
	LNbaseicms    = 0


	IF     &ALS_notaent .vlr_icms > 0 ;
	    OR &ALS_notaent .base_icms > 0 ;
	    OR &ALS_notaent .icms_subs > 0


		LNbaseicms  = lnvlrmercadoria - (lnvlrmercadoria * PrmAliq_rdu /100)

		LNicms	= (LNbaseicms * PrmAliq_icms)/100  && 2o MEMBRO DA SOMA

	ENDIF	

	
	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNicms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XYI           NEIcmsOper VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   45  º
*       º Variable:            NEIcmsOper                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      97                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xyi     &&  NEIcmsOper VALID
#REGION 3
RETURN

FUNCTION NEIcmsOper
	PARAMETERS LNemp,LNboletim,LNforn, LScod, ;
	     LNvlrMercadoria, PrmPrdtOrigem, Notaite_PK,;
	     Prmaliq_rdu,  PrmAliq_icms


    *-------------------------------------------*
    * RETORNA O INDICE PARA PERCENTAUL
    * EX: INDICE 0,915
    *     100 - 0,915 * 100 = 8,5%
    *-------------------------------------------*

    IF PrmAliq_rdu <> 0
	    IF PrmAliq_rdu < 1
    	  PrmAliq_rdu = 100 - PrmAliq_rdu * 100
	    ENDIF
	endif



	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")


	LNicms		=	0


	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal




	PRIVATE LNbaseicms,LNicms

	PRIVATE LNUFOrigem
	PRIVATE LNUFDestino


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()


    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()




	IF (ARQ_empresa+ARQ_notaent+ARQ_grfiscal+;
	    ARQ_grfiscal) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF


    *----------------------------------------------------------*
    *----------------------------------------------------------*


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*


	IF  &ALS_notaent .icms_subs > 0

		LNbaseicms    = LNvlrMercadoria
		LNbaseicms  = lnvlrmercadoria - (lnvlrmercadoria * Prmaliq_rdu /100)
		
		LNicms	= (LNbaseicms * PrmAliq_icms)/100  && 2o MEMBRO DA SOMA

	ENDIF
	
**	LNicms	= ROUND(LNicms,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNicms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XYQ           NEBsBrRetido VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   46  º
*       º Variable:            NEBsBrRetido                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      98                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xyq     &&  NEBsBrRetido VALID
#REGION 3
RETURN

FUNCTION NEBsBrRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria,;
	 LNipi,Notaite_PK, ;
	 PrmPrdtOrigem,;
	 PrmCST,;
	 PrmAliq_rdu
	

    *-------------------------------------------*
    * RETORNA O INDICE PARA PERCENTAUL
    * EX: INDICE 0,915
    *     100 - 0,915 * 100 = 8,5%
    *-------------------------------------------*

    IF PrmAliq_rdu <> 0
	    IF PrmAliq_rdu < 1
    	  PrmAliq_rdu = 100 - PrmAliq_rdu * 100
	    ENDIF
	endif
	
	
	
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Bruta ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")






	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent

	PRIVATE LNicms
	PRIVATE LSufOrigem, LSufDestino

	PRIVATE LNBsBrRetido

	LNBsBrRetido = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()



	IF (ARQ_empresa+ARQ_notaen) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)



    *----------------------------------------------------------*
	LNicms		=	0
    *----------------------------------------------------------*

	*-------------------------------------------------------------*

	*-------------------------------------------------------------*


	LNBsBrRetido   = 0


****    SET STEP ON	

	IF &ALS_notaent .icms_subs	> 0


        IF PrmCST $ "1/2/7"
			DO CASE

		  		CASE LNtpmercad = 8  && REDUTOR NAAAO AFETA BASE DO RETIDO
					LNBsBrRetido  = (LNvlrMercadoria + LNipi)

		  		CASE LSufOrigem =  LSufDestino
		  		                    && REDUTOR NAAAO AFETA BASE DO RETIDO
					LNBsBrRetido  = (LNvlrMercadoria + LNipi)


				CASE &ALS_notaent .reduc_icms > 0
				
				
                      DO CASE

                         CASE LSufDestino = "MT" AND LNforn = 1
           			       LNBsBrRetido   = (LNvlrMercadoria + LNipi )


                         OTHERWISE
						    LNBsBrRetido  = ;
						        ;
						         lnvlrmercadoria - ;
						        (LNvlrMercadoria  *  PrmAliq_rdu/100);
						           +  LNipi

                      ENDCASE

				
				
				
				
				
				
				


				OTHERWISE

				
                      DO CASE

                         CASE LSufDestino = "MT" AND LNforn = 1
           			       LNBsBrRetido   = (LNvlrMercadoria + LNipi )


                         OTHERWISE
						    LNBsBrRetido  = ;
						        ;
						         lnvlrmercadoria - ;
						        (LNvlrMercadoria  *  PrmAliq_rdu/100);
						           +  LNipi

                      ENDCASE


			ENDCASE

		ENDIF
	ENDIF

	LNBsBrRetido = LNBsBrRetido
	
	*----------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsBrRetido)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XZ0           ant0613NEfatura VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   47  º
*       º Variable:            ant0613NEfatura                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      99                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xz0     &&  ant0613NEfatura VALID
#REGION 3
return

*---------------------------------------------------------------*
FUNCTION ant0613NEfatura
	PRIVATE vlr_icms, m.icms_subs
	
	PRIVATE LFretorno
	LFretorno	=  .t.
	*----------------------------------------------------------*
  	SELECT notaite
   	LNnota = m.nota     && EVITA APAGAR N. NOTA
   	SCATTER MEMVAR MEMO
   	DO CASE
		CASE m.natu_oper = 1
		   m.operacao = 'ECP.'   && ENTRADA/COMPRA/PROCESSADA
		CASE m.natu_oper = 2
		   m.operacao = 'ETP.'   && ENTRADA/TRANSFERENCIA/PROCESSADA
		CASE m.natu_oper = 3
		   m.operacao = 'ERP.'   && ENTRADA/REMESSA/PROCESSADA
		CASE m.natu_oper = 4
		   m.operacao = 'EDP.'   && ENTRADA/DEVOLUCAO/PROCESSADA
		CASE m.natu_oper = 5
		   m.operacao = 'EOP.'   && ENTRADA/OUTRAS OPER/PROCESSADA
		CASE m.natu_oper = 6
		   m.operacao = 'SOP.'   && SAIDA/OUTRAS OPER / PROCESSADA
   	ENDCASE

	*---------------------------------------------------------------*
	*  CALCULO DO CUSTO INDIRETO
	*---------------------------------------------------------------*
	
	LNcstind = NEClcIndiretoCusto( ;
					notaent.data_emi, ;
					notaent.totproduto, notaent.vlr_ipi, ;
					notaent.vlrFrete, notaent.vlrdespes, ;
					notaent.vlrseguro,;
					notaite.vlrvenda, notaite.vlripi)

	**********************************
   	m.situacao 	= 'C'+RIGHT(m.situacao,1)
   	m.nota 	   	=  notaent.nota
   	m.dtfat 	=  notaent.data_emi
   	m.custo_ind =  LNcstind



    *-------------- ICMS NORMAL -------------*

    IF m.origem = 1		&& importado
	     m.bsbr_icms  = m.vlrvenda + m.VLRIPI
	ELSE
	     m.bsbr_icms  = m.vlrvenda
	ENDIF

	m.aliq_rdu = 0
	
    IF notaent.reduc_icms > 0
       m.aliq_rdu = notaent.reduc_icms
    ENDIF

	DO CASE
		CASE m.aliq_rdu > 0
		   m.base_calc = m.bsbr_icms * m.aliq_rdu

		CASE notaent.codforn = 1 OR notaent.codforn = 1130
		      m.base_calc = m.bsbr_icms  - ;
			 				(m.bsbr_icms * (4.9/100))
			  m.aliq_rdu  = 4.9/100

		CASE notaent.codforn = 2
		      m.base_calc = m.bsbr_icms  - ;
			 				(m.bsbr_icms * (5.19/100))
			  m.aliq_rdu  = 5.19/100

		OTHERWISE
			m.base_calc = m.bsbr_icms
	ENDCASE	

**    SET STEP ON

	m.vlr_icms = NEClcICMS(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,;
							notaite.origem)

    *-------------- ICMS SOBRE OPERACAO -------------*

    m.bsbricmso  = 0
    m.baseicmso  = 0
	m.icmssoper  = 0


	if notaent.icmssoper > 0

		DO CASE
			CASE m.origem = 1		&& importado
			     m.bsbricmso  = m.vlrvenda + m.VLRIPI + m.custo_ind
			CASE m.tp_mercad = 8		&& importado
			     m.bsbricmso  = m.vlrvenda
			OTHERWISE	
		         m.bsbricmso  = m.vlrvenda  &&  + m.custo_ind
		ENDCASE
	
		DO CASE
			CASE m.aliq_rdu > 0

			 m.baseicmso  = m.bsbricmso * m.aliq_rdu

		     **** m.baseicmso = m.bsbricmso  - ;
				 				(m.bsbricmso * m.aliq_rdu)

			CASE notaent.codforn = 1 OR notaent.codforn = 1130
		      m.baseicmso = m.bsbricmso  - ;
				 				(m.bsbricmso * (4.9/100))


			CASE notaent.codforn = 2
		      m.baseicmso = m.bsbricmso  - ;
				 				(m.bsbricmso * (5.19/100))



			OTHERWISE
				m.baseicmso = m.bsbricmso
		ENDCASE	
	
		m.icmssoper = NEIcmsOper(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,;
							notaite.origem)

	endif
	*---------------------------------------------------*


	m.Base_sbbrt = NEBsBrRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,  ;
							notaite.vlripi,    ;
							recno("NOTAITE"),;
							notaite.origem)
				
	m.Base_subs  = NEBsRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.Base_sbbrt,    ;
							recno("NOTAITE"),;
							notaite.origem)


	m.icms_subs  = NEClcRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.vlr_icms,m.Base_subs,;
							m.icmssoper,    ;
							recno("NOTAITE") ,;
							notaite.origem)


	m.BsEntsbbrt = NEBsEntBrRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,  ;
							notaite.vlripi,    ;
							notaite.custo_ind, ;
							recno("NOTAITE") ,;
							notaite.origem)
							
	m.BsEntSubs  = NEBsEntRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.BsEntsbbrt, ;
							recno("NOTAITE"), ;
							notaite.origem)

	m.IcmsEntsub = NEClcEntRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.vlr_icms,m.BsEntSubs,;
							m.icmssoper,    ;
							recno("NOTAITE"),;
							notaite.origem)





   	IF m.pedido > 0 and LEFT(m.codigo,7) <> "9999999"
		*-----------------------------------------------------------*
		*    So tratar pedido nos diretorios LOJA ou CENTRAL ou
		* para datas com superiores a 2000
		*-----------------------------------------------------------*
		IF notaent.data >= {01.01.2000}
		  *----------------------------------------------------------*
		  =W_DEFPROC("PEDIDO.SPR")
		  IF !PDregistra_qte(notaent.empresa,notaent.pedido,notaite.codigo,;
							notaite.qtde,"REG.ENTRADA")
			RETURN(.F.)
		  ENDIF
		ENDIF
 		 *----------------------------------------------------------*
   ENDIF
**
   SELECT notaite
	=edithand('REGRAVA')

    =W_DEFPROC("NOTAITE.SPR")
	=IE_Refresh(m.empresa,m.orcamento,m.favorecido,m.ordem)


    SELECT itemmov
	m.data = notaent.data
	m.hora = notaent.hora
	m.sld_estq = 0
	m.vlr_estq = 0
	************************************************************
	*    - GARANTIA CONTRA DUPLICACAO							*
	************************************************************
	SET ORDER TO TAG movimento
	SEEK STR(m.empresa,3) + m.codigo + DTOS(m.data) + m.hora +;
			 		 + m.tipo + STR(m.nota,7) + STR(m.ordem,2)
	IF FOUND()
   		=edithand('REGRAVA')
	ELSE
   		=edithand('SAVE')
	ENDIF
   	=W_DEFPROC("moviment.spr")
	=MVatu_cmd(itemmov.empresa,;
				itemmov.codigo,;
				itemmov.classifica,;
				itemmov.data,;
				itemmov.hora,;
				itemmov.tipo,;
				itemmov.nota,;
				itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e
	*----------------------------------------------------------*
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XZ1           ant0613NEBsRetido VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   48  º
*       º Variable:            ant0613NEBsRetido                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      100                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xz1     &&  ant0613NEBsRetido VALID
#REGION 3
RETURN

FUNCTION ant0613NEBsRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, ;
	           LNBsBrRetido,Notaite_PK,;
	           PrmPrdtOrigem
	
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Normal ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite
	

	PRIVATE LNipi, LNicms

	PRIVATE LNBsRetido

	PRIVATE LSufOrigem, LSufDestino

	LNBsRetido  = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()



	IF (ARQ_empresa+ARQ_notaent+ ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")

		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaite
	GO Notaite_PK


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)


    *----------------------------------------------------------*
    * NAO ATUALIZAR O IVA SE O IVA FOR INFORMADO OU SE A ENTRADA
    * JA ESTIVER PROCESSADA
    *----------------------------------------------------------*
	IF (           &ALS_notaent .informaiva  = "S" ;
	      OR LEFT( &ALS_notaent .situacao,1) = "C" ;
	   ) ;
	   OR ;
	   (  DATE() - &ALS_notaent .data > 10 AND &ALS_notaite .IVA > 0)
		LNiva= 	&ALS_notaite .IVA
	ELSE

		=W_DEFPROC("TRIBUTAR.spr")

		LNiva= TRGet_IVA( LSufOrigem  ,LScod, LSufDestino, ;
		         &ALS_notaent .data , PrmPrdtOrigem)

	ENDIF



	*************************************************************


	IF &ALS_notaent .icms_subs	> 0


****	IF (LNtpmercad = 2 or LNtpmercad = 8) AND LNiva > 0

        IF &ALS_notaite .CST $ "1/2/7"

			LNBsRetido   = (LNBsBrRetido) * LNiva

		ENDIF
	ENDIF


*	LNBsRetido = ROUND(LNBsRetido,2)

	*----------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsRetido)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XZ2           antNEClcRetido VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   49  º
*       º Variable:            antNEClcRetido                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      101                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xz2     &&  antNEClcRetido VALID
#REGION 3
RETURN

FUNCTION antNEClcRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNicms, LNbaseRetido,;
	        LNicmssoper,Notaite_PK,PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite
	


	PRIVATE LNretido
	PRIVATE LNaliq_icms

	PRIVATE LSufOrigem, LSufDestino

	LSalias			= ALIAS()


    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()



	IF (ARQ_empresa+ARQ_notaent +ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
	
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaite
	GO Notaite_PK

	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	*************************************************************



	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)

	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)


    *----------------------------------------------------------*
    * NAO ATUALIZAR O IVA SE O IVA FOR INFORMADO OU SE A ENTRADA
    * JA ESTIVER PROCESSADA
    *----------------------------------------------------------*
	IF (           &ALS_notaent .informaiva  = "S" ;
	      OR LEFT( &ALS_notaent .situacao,1) = "C" ;
	   ) ;
	   OR ;
	   (  DATE() - &ALS_notaent .data > 10 AND &ALS_notaite .IVA > 0)
		LNiva= 	&ALS_notaite .IVA
	ELSE

		=W_DEFPROC("TRIBUTAR.spr")
		LNiva= TRGet_IVA( LSufOrigem  ,LScod, LSufDestino, ;
		         &ALS_notaent .data , PrmPrdtOrigem )
	ENDIF


	LNretido   = 0
	
	IF &ALS_notaent .icms_subs	> 0

*****   IF (LNtpmercad = 2 or LNtpmercad = 8) AND LNiva > 0

        IF &ALS_notaite .CST $ "1/2/7"


			LNretido   = LNbaseRetido * 0.17
			LNretido   = LNretido - LNicms     && - LNicmssoper

		ENDIF
	ENDIF
	*----------------------------------------------------------*

	LNRetido = ROUND(LNRetido,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNretido)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8XZS           antNEBsEntBrRetido VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   50  º
*       º Variable:            antNEBsEntBrRetido                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      102                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8xzs     &&  antNEBsEntBrRetido VALID
#REGION 3
RETURN

FUNCTION antNEBsEntBrRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria, LNipi, ;
	             LNCustoIndireto,Notaite_PK, PrmPrdtOrigem

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Bruta ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite

	PRIVATE LNicms
	PRIVATE LSufOrigem, LSufDestino

	PRIVATE LNBsBrRetido

	LNBsBrRetido = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()


	IF (ARQ_empresa+ARQ_notaen+ ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaite
	GO Notaite_PK



	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp



	=W_DEFPROC("TRIBUTAR.spr")
	LNOriTpmercad	= TRDef_RgTrbMercad(  &ALS_notaent .uf  ,LScod)

	=W_DEFPROC("TRIBUTAR.spr")
	LNDstTpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)


	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)




    *----------------------------------------------------------*
    * NAO ATUALIZAR O IVA SE O IVA FOR INFORMADO OU SE A ENTRADA
    * JA ESTIVER PROCESSADA
    *----------------------------------------------------------*
	IF (           &ALS_notaent .informaiva  = "S" ;
	      OR LEFT( &ALS_notaent .situacao,1) = "C" ;
	   ) ;
	   OR ;
	   (  DATE() - &ALS_notaent .data > 10 AND &ALS_notaite .IVA > 0)
		LNiva= 	&ALS_notaite .IVA
	ELSE

		=W_DEFPROC("TRIBUTAR.spr")
		LNiva= TRGet_IVA( LSufOrigem  ,LScod, LSufDestino, ;
		         &ALS_notaent .data , PrmPrdtOrigem)
	ENDIF


	*************************************************************


	LNBsBrRetido   = 0
	

	IF &ALS_notaent .icmsentsub	> 0

		*-------------------------------------------------------------*


		IF LNOriTpmercad <> 2 AND LNDstTpmercad = 2 AND LNiva > 0

			DO CASE
				


				CASE &ALS_notaent .reduc_icms > 0
						LNBsBrRetido  = (LNvlrMercadoria + LNipi) ;
			                * &ALS_notaent .reduc_icms


				CASE &ALS_notaent .reduc_icms = 0

					if &ALS_notaent .data >= {01.11.2006}
						DO CASE
							CASE &ALS_notaent .codforn = 1
								LNBsBrRetido    = ;
									(LNvlrMercadoria + LNipi)-;
									((LNvlrMercadoria)*0.049)

							CASE &ALS_notaent .codforn = 2
								LNBsBrRetido    = ;
									(LNvlrMercadoria + LNipi)-;
									((LNvlrMercadoria)*0.0519)
						
							OTHERWISE
								LNBsBrRetido   = (LNvlrMercadoria + LNipi)
						ENDCASE

					ELSE
						if &ALS_notaent .codforn = 1
							LNBsBrRetido    = (LNvlrMercadoria + LNipi)-;
								((LNvlrMercadoria + LNipi)*0.049)
						ELSE	
							LNBsBrRetido   = (LNvlrMercadoria + LNipi)
						ENDIF
					ENDIF
			ENDCASE

			LNBsBrRetido = LNBsBrRetido + LNCustoIndireto

		ENDIF
	ENDIF

	
	
	*----------------------------------------------------------*

	LNBsBrRetido = LNBsBrRetido

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsBrRetido)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8Y01           antNEBsEntRetido VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   51  º
*       º Variable:            antNEBsEntRetido                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      103                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8y01     &&  antNEBsEntRetido VALID
#REGION 3
RETURN

FUNCTION antNEBsEntRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNBsBrRetido,;
	   Notaite_PK, PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Normal ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite

	PRIVATE LNipi, LNicms

	PRIVATE LNBsRetido
	PRIVATE LSufOrigem, LSufDestino

	LNBsRetido  = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaite
	GO Notaite_PK



	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)


	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)


    *----------------------------------------------------------*
    * NAO ATUALIZAR O IVA SE O IVA FOR INFORMADO OU SE A ENTRADA
    * JA ESTIVER PROCESSADA
    *----------------------------------------------------------*
	IF (           &ALS_notaent .informaiva  = "S" ;
	      OR LEFT( &ALS_notaent .situacao,1) = "C" ;
	   ) ;
	   OR ;
	   (  DATE() - &ALS_notaent .data > 10 AND &ALS_notaite .IVA > 0)
		LNiva= 	&ALS_notaite .IVA
	ELSE

		=W_DEFPROC("TRIBUTAR.spr")
		LNiva= TRGet_IVA( LSufOrigem  ,LScod, LSufDestino, ;
		         &ALS_notaent .data, PrmPrdtOrigem )
	ENDIF


	*************************************************************


	IF &ALS_notaent .icmsentsubs	> 0
		IF LNtpmercad = 2 AND LNiva > 0
			LNBsRetido   = (LNBsBrRetido) * LNiva
		ENDIF
	ENDIF


	*----------------------------------------------------------*
*	LNBsRetido = ROUND(LNBsRetido,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsRetido)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8Y0A           antNEClcEntRetido VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   52  º
*       º Variable:            antNEClcEntRetido                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      104                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8y0a     &&  antNEClcEntRetido VALID
#REGION 3
RETURN

FUNCTION antNEClcEntRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNicms, LNbaseRetido,;
	   LNicmssoper,Notaite_PK, PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite

	PRIVATE LSufOrigem, LSufDestino


	PRIVATE LNretido
	PRIVATE LNaliq_icms


	LSalias			= ALIAS()


    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
	
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	SELE &ALS_notaite
	GO Notaite_PK

	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	*************************************************************


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)



	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)




    *----------------------------------------------------------*
    * NAO ATUALIZAR O IVA SE O IVA FOR INFORMADO OU SE A ENTRADA
    * JA ESTIVER PROCESSADA
    *----------------------------------------------------------*
	IF (           &ALS_notaent .informaiva  = "S" ;
	      OR LEFT( &ALS_notaent .situacao,1) = "C" ;
	   ) ;
	   OR ;
	   (  DATE() - &ALS_notaent .data > 10 AND &ALS_notaite .IVA > 0)
		LNiva= 	&ALS_notaite .IVA
	ELSE

		=W_DEFPROC("TRIBUTAR.spr")
		LNiva= TRGet_IVA( LSufOrigem  ,LScod, LSufDestino, ;
		         &ALS_notaent .data,  PrmPrdtOrigem )
	ENDIF


	
	LNretido   = 0
	
	IF &ALS_notaent .icmsentsubs	> 0
		IF LNtpmercad = 2 AND LNiva > 0


			LNretido   = LNbaseRetido * 0.17
			LNretido   = LNretido - LNicms     && - LNicmssoper


		ENDIF
	ENDIF
	*----------------------------------------------------------*

	LNRetido = ROUND(LNRetido,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNretido)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8Y0I           NEBCIcmsOper VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   53  º
*       º Variable:            NEBCIcmsOper                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      105                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8y0i     &&  NEBCIcmsOper VALID
#REGION 3
RETURN

FUNCTION NEBCIcmsOper
	PARAMETERS LNemp,LNboletim,LNforn, LScod, ;
	      LNvlrMercadoria, PrmPrdtOrigem, Notaite_PK,;
		PrmAliq_rdu,;
		PrmAliq_ICMS
		

    *-------------------------------------------*
    * RETORNA O INDICE PARA PERCENTAUL
    * EX: INDICE 0,915
    *     100 - 0,915 * 100 = 8,5%
    *-------------------------------------------*

    IF PrmAliq_rdu <> 0
	    IF PrmAliq_rdu < 1
    	  PrmAliq_rdu = 100 - PrmAliq_rdu * 100
	    ENDIF
	endif



	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal



	PRIVATE LNbaseicms,LNicms



	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()


    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()






    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_grfiscal+ARQ_grfiscal;
	       ) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)

	*--------------------------------------------------------------------*
	LNicms		=	0
	LNbaseicms  = 0



    *----------------------------------------------------------*


	LNicms		=	0
    *----------------------------------------------------------*

	IF  &ALS_notaent .icms_subs > 0

		*-------------------------------------------------------------*

		LNbaseicms  = lnvlrmercadoria - (lnvlrmercadoria * PrmAliq_rdu /100)

		LNicms	= (LNbaseicms * PrmAliq_icms)/100  && 2o MEMBRO DA SOMA
	ENDIF
	
	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNbaseicms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8Y0J           NECalc_Entrada VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   55  º
*       º Variable:            NECalc_Entrada                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      106                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8y0j     &&  NECalc_Entrada VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NECalc_Entrada
PARAMETERS LNemp,LNboletim,LNforn,PrmSolicitante
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Processr Entradas
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		.f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA
	*		SCGC210.spr
	*		SCGCF211.PRG
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.

	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	IF !REGLOCK()
	    WAIT WINDOW "Documento nao poder ser bloqueado para o processo."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	=NE_Refresh(LNemp,LNboletim,LNforn);

	*--------------------------------------------------------------*

	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)

	*---------------------------------------------------------------*
	* Verificacao do itens para liberar entrada
	*---------------------------------------------------------------*

	*---------------------------------------------------------------*

	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)

	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)

		LSmsg = "Calculando Emp.: "+STR(notaent.empresa,3);
							+" NE: "+STR(notaent.nota,6);
							+" DT: "+DTOC(notaent.data) ;
							+"ITEM => "+STR(notaite.ordem,2)
		WAIT WINDOWS LSmsg NOWAIT

		SELECT notaite
		IF !ULCalcIT()
			LFretorno = .F.
			EXIT
		ENDIF		
		SELECT notaite
		SKIP
	ENDDO
	*----------------------------------------------------------*




	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)

*-----------------------------------------------------------------*
*  Rotina de apoio para manipular o item atual da nota de entrada
*------------------------------------------------------------------*
FUNCTION ULCalcit
	PRIVATE LFretorno
	LFretorno = .t.
	*-------------------------------------------------------------*
	SELECT notaite
	IF REGLOCK()
		IF !NECalcularIt()     && ****
			LFretorno = .F.
			EXIT
		ENDIF
	ELSE
		LFretorno = .F.
		EXIT
	ENDIF
	*-------------------------------------------------------------*
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8Y0K           NECalcularIt VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   56  º
*       º Variable:            NECalcularIt                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      107                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8y0k     &&  NECalcularIt VALID
#REGION 3
return

*---------------------------------------------------------------*
FUNCTION NECalcularIt
	PRIVATE vlr_icms, m.icms_subs
	
	PRIVATE LFretorno
	LFretorno	=  .t.
	*----------------------------------------------------------*
  	SELECT notaite
   	LNnota = m.nota     && EVITA APAGAR N. NOTA
   	SCATTER MEMVAR MEMO
   	DO CASE
		CASE m.natu_oper = 1
		   m.operacao = 'ECP.'   && ENTRADA/COMPRA/PROCESSADA
		CASE m.natu_oper = 2
		   m.operacao = 'ETP.'   && ENTRADA/TRANSFERENCIA/PROCESSADA
		CASE m.natu_oper = 3
		   m.operacao = 'ERP.'   && ENTRADA/REMESSA/PROCESSADA
		CASE m.natu_oper = 4
		   m.operacao = 'EDP.'   && ENTRADA/DEVOLUCAO/PROCESSADA
		CASE m.natu_oper = 5
		   m.operacao = 'EOP.'   && ENTRADA/OUTRAS OPER/PROCESSADA
		CASE m.natu_oper = 6
		   m.operacao = 'SOP.'   && SAIDA/OUTRAS OPER / PROCESSADA
   	ENDCASE

	*---------------------------------------------------------------*
	*  CALCULO DO CUSTO INDIRETO
	*---------------------------------------------------------------*
	
	LNcstind = NEClcIndiretoCusto( ;
					notaent.data_emi, ;
					notaent.totproduto, notaent.vlr_ipi, ;
					notaent.vlrFrete, notaent.vlrdespes, ;
					notaent.vlrseguro,;
					notaite.vlrvenda, notaite.vlripi)

	**********************************
*   	m.situacao 	= 'C'+RIGHT(m.situacao,1)
   	m.situacao 	= m.situacao


   	m.nota 	   	=  notaent.nota
   	m.dtfat 	=  notaent.data_emi
   	m.custo_ind =  LNcstind



    *-------------- ICMS NORMAL -------------*

    IF m.origem = 1		&& importado
	     m.bsbr_icms  = m.vlrvenda + m.VLRIPI
	ELSE
	     m.bsbr_icms  = m.vlrvenda
	ENDIF

	m.aliq_rdu = notaite.aliq_rdu
	

	m.vlr_icms = NEClcICMS(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,;
							notaite.origem,;
							recno("NOTAITE"),;
	                        notaite.aliq_rdu,;
	                        notaite.aliq_icms;
							)
							
							

    *-------------- ICMS SOBRE OPERACAO -------------*

    m.bsbricmso  = 0
    m.baseicmso  = 0
	m.icmssoper  = 0



	m.baseicmso = m.bsbricmso
	
	m.baseicmso = NEBCIcmsOper(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,;
							notaite.origem,;
							recno("NOTAITE"),;
	                        notaite.aliq_rdu,;
	                        notaite.aliq_icms;
							)
							



	
	m.icmssoper = NEIcmsOper(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,;
							notaite.origem,;
							recno("NOTAITE"),;
	                        notaite.aliq_rdu,;
	                        notaite.aliq_icms;
							)

							

	*---------------------------------------------------*


	m.Base_sbbrt = NEBsBrRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,  ;
							notaite.vlripi,    ;
							recno("NOTAITE"),;
							notaite.origem,;
							notaite.cst,;
							notaite.aliq_rdu)
							
				
	m.Base_subs  = NEBsRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.Base_sbbrt,    ;
							recno("NOTAITE"),;
							notaite.origem,;
							notaite.cst,;
							notaite.aliq_rdu)



	m.icms_subs  = NEClcRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.vlr_icms,;
							m.Base_subs,;
							m.icmssoper,    ;
							recno("NOTAITE"),;
							notaite.origem,;
							notaite.cst)

*--------------------------------------------------------*

	m.BsEntsbbrt = NEBsEntBrRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,  ;
							notaite.vlripi,    ;
							notaite.custo_ind, ;
							recno("NOTAITE") ,;
							notaite.origem,;
							notaite.aliq_rdu,;
							notaite.IVA)
							
							
							
	m.BsEntSubs  = NEBsEntRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.BsEntsbbrt, ;
							recno("NOTAITE"), ;
							notaite.origem,;
							notaite.IVA)

							

	m.IcmsEntsub = NEClcEntRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.vlr_icms,m.BsEntSubs,;
							m.icmssoper,    ;
							recno("NOTAITE"),;
							notaite.origem,;
							notaite.IVA)




**
   SELECT notaite
	=edithand('REGRAVA')

    =W_DEFPROC("NOTAITE.SPR")
	=IE_Refresh(m.empresa,m.orcamento,m.favorecido,m.ordem)

	*----------------------------------------------------------*
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8Y1I           NEClcBCICMS VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   57  º
*       º Variable:            NEClcBCICMS                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      108                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8y1i     &&  NEClcBCICMS VALID
#REGION 3
RETURN

FUNCTION NEClcBCICMS
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria, ;
		PrmPrdtOrigem, Notaite_PK,;
		PrmAliq_rdu,;
		PrmAliq_ICMS
		

    *-------------------------------------------*
    * RETORNA O INDICE PARA PERCENTAUL
    * EX: INDICE 0,915
    *     100 - 0,915 * 100 = 8,5%
    *-------------------------------------------*

    IF PrmAliq_rdu <> 0
	    IF PrmAliq_rdu < 1
    	  PrmAliq_rdu = 100 - PrmAliq_rdu * 100
	    ENDIF
	endif
	
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal




	PRIVATE LNbaseicms,LNicms

	PRIVATE LNUFOrigem
	PRIVATE LNUFDestino


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()


    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()



    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()



	IF (ARQ_empresa+ARQ_notaent+ARQ_grfiscal+ARQ_grfiscal;
	     ) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF




    *----------------------------------------------------------*


	LNicms		=	0

    *----------------------------------------------------------*


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	LNicms		  =	0
	LNbaseicms    = 0


	IF     &ALS_notaent .vlr_icms > 0 ;
	    OR &ALS_notaent .base_icms > 0 ;
	    OR &ALS_notaent .icms_subs > 0



		LNbaseicms  = lnvlrmercadoria - (lnvlrmercadoria * PrmAliq_rdu /100)


	ENDIF	

	
	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNbaseicms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4JV0M8Y1R           NECancRegSld VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTAENTA,     Record Number:   58  º
*       º Variable:            NECancRegSld                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      109                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4jv0m8y1r     &&  NECancRegSld VALID
#REGION 3
return

*---------------------------------------------------------------*
FUNCTION NECancRegSld
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LFretorno
	LFretorno	=  .t.
	*----------------------------------------------------------*
   	PRIVATE LFlockReg
	PRIVATE LFabreAuto
	PRIVATE LNJaReserv	
	LFlockReg	= .T.	&& BLOQUEAR REGISTRO
    LFabreAuto	= .F. 	&& ABRIR CONTROLE AUTOMATICAMENTE
	LNJaReserv	= 0		&& QTDE JA RESERVADA DESTE ITEM NESTE DOC
	=W_DEFPROC("ESTOQUE.SPR")


    * USAR A OPERACAO SAIDA NO PROCESSO DE CANCELAMENTO
    * IMPEDE QUE QUE SEJA CANCELADO UMA NOTA QDO O ITEM FOR FICAR NEGATIVO
    * A EXCECAO  PARA USUARIO MASTER QUE PODERA CANCELAR A NOTA MESMO
    * QUE SALDO FIQUE NEGATIVO
    *  PARA CANCELAMENTO A OPERA€ÇO E SAIDA IMPLEMENTADA EM 20/10/2014



    IF lMaster  && PARA USUARIO MASTER PERMITE
    	IF !ESversaldo(notaent.empresa,notaite.codigo, notaent.data,;
				notaite.qtde,LNJaReserv,LFabreAuto,;
				LFlockReg,"ENTRADA",;
				notaent.hora,notaite.movestq)
			LFretorno	=  .F.
		ENDIF
	ELSE
		IF !ESversaldo(notaent.empresa,notaite.codigo, notaent.data,;
				notaite.qtde,LNJaReserv,LFabreAuto,;
				LFlockReg,"SAIDA",;
				notaent.hora,notaite.movestq)
			LFretorno	=  .F.
		ENDIF
	ENDIF
	*----------------------------------------------------------*
RETURN(LFretorno)
