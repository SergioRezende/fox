*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        08/21/15            MOVIMENT.SPR               09:44:15 
*                                                                
*       픔컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        Author's Name                                           
*                                                                
*        Copyright (c) 2015 Company Name                         
*        Address                                                 
*        City,     Zip                                           
*                                                                
*        Description:                                            
*        This program was automatically generated by GENSCRN.    
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                       MS-DOS Window definitions                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                  PRECO/MS-DOS Setup Code - SECTION 2           
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 3
return

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                     MOVIMENT/MS-DOS Screen Layout              
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 1
@ 3,0 GET MVAtu_Cmd ;
	PICTURE "@*HN MVAtu_Cmd  - Atualiza de Saldos Fisicos e Financeiros com Base em ITEMMOV" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd2d()
@ 4,0 GET MVCancelMvto ;
	PICTURE "@*HN MVCancelMvto - Clancela Item do Movimento" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd2e()
@ 6,5 GET MVBlqSaldo ;
	PICTURE "@*HN MVBlqSaldo - Bloquear Reg. Saldo  com Base em ITEMMOV" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd2f()
@ 7,5 GET MVDesBlqSaldo ;
	PICTURE "@*HN MVDesBlqSaldo - Desbloqueia Bloquear Reg. Saldo  com Base em ITEMMOV" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd3b()
@ 10,3 GET MVObterSaldos ;
	PICTURE "@*HN MVObterSaldos - Obter Saldos Base para Processar Movimento" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd3i()
@ 11,8 GET MVIniRegSaldos ;
	PICTURE "@*HN MVIniRegSaldos - Inicializa Registro de Saldos" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd3u()
@ 13,3 GET MVprocessaMvto ;
	PICTURE "@*HN MVprocessaMvto - Processa o Movimento Com Base no Registro Informado" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd3v()
@ 14,6 GET MVSincrItmAnexo ;
	PICTURE "@*HN MVSincrItmAnexo  - Sincronizar Saldos de ItmAnexo Com Itemmov" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd3w()
@ 15,6 GET MVAtlzSaldos ;
	PICTURE "@*HN MVAtlzSaldos - Atualiza Saldos a Partir da Data do Movimento" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd3x()
@ 16,8 GET MVAtlzComplSaldos ;
	PICTURE "@*HN MVAtlzComplSaldos - Complementa Atualizacao de Saldos " ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd4q()
@ 18,6 GET MVGetCustMedio ;
	PICTURE "@*HN MVGetCustMedio - Obter o Custo Medio Para Operacao em Andamento" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd4x()
@ 19,6 GET MVGetIndRedutor ;
	PICTURE "@*HN MVGetIndRedutor - Obter o Indice de Reducao Oper(/OU*) 1.26 ou 1.24" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd53()
@ 20,8 GET MVSetSldEntradas ;
	PICTURE "@*HN MVSetSldEntradas - Opera Var(Ambientais) P/ Movim de Entr" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd5a()
@ 21,8 GET MVSetSldSaidas ;
	PICTURE "@*HN MVSetSldSaidas - Opera Var(Ambientais) P/ Movim de Saidas" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd5b()
@ 22,8 GET MVSetSaldos ;
	PICTURE "@*HN MVSetSaldos - Atualiza <Saldo Atual> e <Vlr Atual> => NO CUSTO MEDIO" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd5c()
@ 23,6 GET MVSldFuturo ;
	PICTURE "@*HN MVSldFuturo - Ajusta Registros de Saldo alem da Data Movimento" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd5d()




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                     NOTAENT/MS-DOS Screen Layout               
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 2
@ 23,2 GET NEGetFieldValue ;
	PICTURE "@*HN NEGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd67()
@ 25,2 GET NEGetUFOrigem ;
	PICTURE "@*HN NEGetUFOrigem - Retorna UFs (Origem da NFE)" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd6c()
@ 26,2 GET NEGetUFDestino ;
	PICTURE "@*HN NEGetUFDestino - Retorna UFs (Destino da NFE)" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd6i()
@ 27,2 GET NEGetRetidoDestacado ;
	PICTURE "@*HN NEGetRetidoDestacado - Retido Destacado na NFE" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd6n()
@ 4,7 GET NEVerifyInst ;
	PICTURE "@*HN NEVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd6s()
@ 5,10 GET NECreate ;
	PICTURE "@*HN NECreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd6z()
@ 13,10 GET NEDestroi ;
	PICTURE "@*HN NEDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd70()
@ 7,13 GET NEReadProp ;
	PICTURE "@*HN NEReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd71()
@ 10,15 GET NESetDerivadas ;
	PICTURE "@*HN NESetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd72()
@ 8,15 GET NESetPropVT ;
	PICTURE "@*HN NESetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd73()
@ 9,15 GET NEGetPropVT ;
	PICTURE "@*HN NEGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd74()
@ 3,2 GET NEChk_Identidade ;
	PICTURE "@*HN NEChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd7w()
@ 2,2 GET NEFind ;
	PICTURE "@*HN NEFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd82()
@ 15,2 GET NEGetFieldValue ;
	PICTURE "@*HN NEGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd88()
@ 14,2 GET NE_Refresh ;
	PICTURE "@*HN NE_Refresh - Forca Atualiza놹o Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd8c()
@ 17,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 19,2 GET NELerRegistro ;
	PICTURE "@*HN NELerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd8h()
@ 11,13 GET NEWriteProp ;
	PICTURE "@*HN NEWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd8i()
@ 20,2 GET NESalvarRegistro ;
	PICTURE "@*HN NESalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd8j()
@ 18,2 GET NEExiste ;
	PICTURE "@*HN NEExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd8k()
@ 21,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 16,2 GET NEGetAlias ;
	PICTURE "@*HN NEGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd8l()
@ 1,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 29,2 GET NEVerPendencias ;
	PICTURE "@*HN NEVerPendencias - Ver se exitem NFent c status (c) Pendente envio XML" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd8m()




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                      PRECO/MS-DOS Screen Layout                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 3
@ 1,0 GET PRVlrSaida ;
	PICTURE "@*HN PRVlrSaida - Obert Valor para Operacao de saida" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd9e()
@ 2,3 GET PRVlrTransf ;
	PICTURE "@*HN PRVlrTransf   - Obter Valor para Transferencias" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd9n()
@ 8,4 GET PRVlrVenda ;
	PICTURE "@*HN PRVlrVenda -Preco Vendas Para OSI Informada" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd9t()
@ 11,4 GET PRClas_Cms ;
	PICTURE "@*HN PRClas_Cms - Obter a Classificao de Grupo de Comissao para Produto" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvd9z()
@ 12,0 GET PRCusto ;
	PICTURE "@*HN PRCusto - Obter Custo do Produto" ;
	SIZE 1,34,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvda0()
@ 13,0 GET PRtabvigor ;
	PICTURE "@*HN PRtabvigor" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvda1()
@ 14,0 GET PRdesconto ;
	PICTURE "@*HN PRdesconto" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvda2()
@ 15,0 GET PRbrow_tab ;
	PICTURE "@*HN PRbrow_tab" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvdas()
@ 16,0 GET PRpromocao ;
	PICTURE "@*HN PRpromocao" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvdaz()
@ 9,7 GET PRVlrTabVgr ;
	PICTURE "@*HN PRVlrTabVgr -Preco em Vigor na Dt Informada" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvdb7()
@ 3,5 GET PRVlrTransf ;
	PICTURE "@*HN trfdp1912 - aux de PRVlrTransf - para Orcamentos apos 01-09-2012" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvdbd()
@ 4,5 GET PRVlrTransf ;
	PICTURE "@*HN trf_dep010503 - aux de PRVlrTransf - para Orcamentos apos 01-05-2003" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvdbk()
@ 5,5 GET PRVlrTransf ;
	PICTURE "@*HN trf_ate010503 - aux de PRVlrTransf - para Orcamentos antes de 01-05-2003" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _4fe0kvdbl()



READ


#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                       PRECO/MS-DOS Cleanup Code                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 3
return


*****
************************************
********************


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD2D           MVAtu_Cmd VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    2  
*        Variable:            MVAtu_Cmd                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      1                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd2d     &&  MVAtu_Cmd VALID
#REGION 1
RETURN

******---------------------------------
* APOS A GRAVACAO DO NOVO REGISTRO DE ITEMMOV GERADO POR ENTRADAS,
*	 ESTA ROTINA E ATIVADA  //  ou // PARA CORRECAO DO ESTOQUE
*
*   - VOLTA UM REGISTRO
*	- CAPTURA CUSTO MEDIO ANTERIOR
*	- LOOP NO MOVIMENTO DO PRODUTO
*		-AVANCA UM REGISTRO
*		-RECALCULA CUSTO MEDIO
*
*	- FIM LOOP
*   - ATULIZA VALORES NO CONTROLE DA SALDOS DOS MESES AFETADOS
****************************************
PROCEDURE MVatu_cmd		&& ATUALIZA CUSTO MEDIO COM BASE NO ITEMMOV
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata,;
			PRMhora,;
			PRMtipo,;
			PRMnota,;
			PRMordem

*	IF PRMcodigo = "13010719"
*		set step on
*	endif

    = W_DEFPROC("rotinas.spr")






	SELE Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)


	*------------------------------------------------------------------*
	*   Inicio Efetivo da Rotina Apos o Posicionamento
	*------------------------------------------------------------------*

	PRIVATE sld_ante, vlr_ante, res_ante
	PRIVATE sld_atu, vlr_atu, dt_entrada, dt_saida

	PRIVATE	LNredutor   &&    Indice de reducao de icms em entrada
						&& Transf Internas
	PRIVATE	LSoperacao  &&    Indica a operacao "*" ou "/" que envolvera
						&& o LNredudor

    && Valores Basicos  Saldo

	PRIVATE LNvlratu	&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNsldatu	&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNcstmedio  && CUSTO MEDIO DO PRODUTO
	PRIVATE LNreserva   && saldo em reserva


    && Valores de Detalhementos de Saldo
	PRIVATE m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	

	store 0 to  sld_ante, vlr_ante, res_ante, sld_atu, vlr_atu
	store {} to dt_entrada, dt_saida

			
	store 0 to m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	



	LNvlratu	= 0		&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	LNsldatu	= 0		&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	LNcstmedio  = 0     && CUSTO MEDIO DO PRODUTO
	LNreserva   = 0     && saldo em reserva


    =MVBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)


    =MVObterSaldos( m.sld_ante, m.vlr_ante, m.res_ante,;
                  m.dt_entrada, m.dt_saida,;
    			  LNsldatu, LNvlratu, LNreserva,;
    	          m.qtd_compra, m.vlr_compra, ;
   	              m.qtd_venda , m.vlr_venda , ;
   	              m.qtd_e_tran, m.vlr_e_tran, ;
   	              m.qtd_e_outr, m.vlr_e_outr, ;
   	              m.qtd_s_tran, m.vlr_s_tran, ;
		          m.qtd_s_outr, m.vlr_s_outr, ;
				  m.ven_tab, m.ven_contab, m.ven_enc, ;
	 			  m.reserva)


	************************************************************
	=MVprocessaMvto(PRMempresa,;
					PRMcodigo,;
					PRMclasse,;
					PRMdata,;
					PRMhora,;
					PRMtipo,;
					PRMnota,;
					PRMordem)


	***************************
	****************	ATUALIZANDA SALDOS ABERTOS EM MESES FUTUROS
	****************
    =MVDesBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)
	
	SELE ITEMMOV
	SET ORDER TO TAG movimento
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD2E           MVCancelMvto VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    3  
*        Variable:            MVCancelMvto                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      2                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd2e     &&  MVCancelMvto VALID
#REGION 1
RETURN

******---------------------------------
****************************************
PROCEDURE MVCancelMvto
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata,;
			PRMhora,;
			PRMtipo,;
			PRMnota,;
			PRMordem

    = W_DEFPROC("rotinas.spr")

	SELE Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)




	PRIVATE sld_ante, vlr_ante, res_ante
	PRIVATE sld_atu, vlr_atu, dt_entrada, dt_saida

	PRIVATE	LNredutor   &&    Indice de reducao de icms em entrada
						&& Transf Internas
	PRIVATE	LSoperacao  &&    Indica a operacao "*" ou "/" que envolvera
						&& o LNredudor

    && Valores Basicos  Saldo

	PRIVATE LNvlratu	&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNsldatu	&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNcstmedio  && CUSTO MEDIO DO PRODUTO
	PRIVATE LNreserva   && saldo em reserva


    && Valores de Detalhementos de Saldo
	PRIVATE m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	

	store 0 to  sld_ante, vlr_ante, res_ante, sld_atu, vlr_atu
	store {} to dt_entrada, dt_saida

			
	store 0 to m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	



	LNvlratu	= 0		&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	LNsldatu	= 0		&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	LNcstmedio  = 0     && CUSTO MEDIO DO PRODUTO
	LNreserva   = 0     && saldo em reserva

    =MVBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)

    =MVObterSaldos( m.sld_ante, m.vlr_ante, m.res_ante,;
	              m.dt_entrada, m.dt_saida,;
    			  LNsldatu, LNvlratu, LNreserva,;
    	          m.qtd_compra, m.vlr_compra, ;
   	              m.qtd_venda , m.vlr_venda , ;
   	              m.qtd_e_tran, m.vlr_e_tran, ;
   	              m.qtd_e_outr, m.vlr_e_outr, ;
   	              m.qtd_s_tran, m.vlr_s_tran, ;
		          m.qtd_s_outr, m.vlr_s_outr, ;
				  m.ven_tab, m.ven_contab, m.ven_enc, ;
	 			  m.reserva)
	************************************************************

	*----------------------------------------------------------------*
	*    Efetiva Cancelamento do Registro de Movimento
	*----------------------------------------------------------------*
	
    SELE itemmov
    =edithand('APAGA')

	SELE itmanexo
	SET ORDER TO TAG movanexo
	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)
	IF FOUND()
		=REGLOCK(.T.)
		=edithand('APAGA')
		UNLOCK
	ENDIF

    SELE itemmov
	*----------------------------------------------------------------*


	=MVprocessaMvto(PRMempresa,;
					PRMcodigo,;
					PRMclasse,;
					PRMdata,;
					PRMhora,;
					PRMtipo,;
					PRMnota,;
					PRMordem)

	***************************
	****************	ATUALIZANDA SALDOS ABERTOS EM MESES FUTUROS
	****************
    =MVDesBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)
	
	SELE ITEMMOV
	SET ORDER TO TAG movimento
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD2F           MVBlqSaldo VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    4  
*        Variable:            MVBlqSaldo                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      3                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd2f     &&  MVBlqSaldo VALID
#REGION 1
RETURN

******---------------------------------

FUNCTION MVBlqSaldo		&& Bloquear Reg de Saldo
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata

 	SELE saldo	

	************ POSICIONA SALDO CASO NAO TENHA SIDO FEITO ANTES ******
    SET ORDER TO TAG clas_saldo
    SEEK STR(PRMempresa,3)+PRMclasse+;
         STR(YEAR(PRMdata),4)+;
         STR(MONTH(PRMdata),2)

    IF !FOUND()

        =MVIniRegSaldos(PRMempresa,;
        			    PRMdata, ;
        			 	PRMcodigo,;
        			 	m.sld_atu,;
        			 	m.vlr_atu,;
        			 	m.reserva)

 		SELE SALDO
	    SET ORDER TO TAG clas_saldo
        SEEK STR(PRMempresa,3)+PRMclasse+;
    		 STR(YEAR(PRMdata),4)+;
             STR(MONTH(PRMdata),2)
   		IF !FOUND()
			=uperrosys()
			 WAIT WINDOW "ERRO. REG.SALDO NAO LOCALIZADO. <ENTER>..."
			 CLOSE ALL
			 QUIT
		ENDIF
	ENDIF
	*************************************************************

RETURN(reglock(.T.)) 	&& CONFIRMA O BLOQUEIO DO SALDO


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD3B           MVDesBlqSaldo VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    5  
*        Variable:            MVDesBlqSaldo                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      4                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd3b     &&  MVDesBlqSaldo VALID
#REGION 1
RETURN

******---------------------------------

FUNCTION MVDesBlqSaldo		&& Bloquear Reg de Saldo
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata

 	SELE saldo	

	************ POSICIONA SALDO CASO NAO TENHA SIDO FEITO ANTES ******
    SET ORDER TO TAG clas_saldo
    SEEK STR(PRMempresa,3)+PRMclasse+;
         STR(YEAR(PRMdata),4)+;
         STR(MONTH(PRMdata),2)

    IF FOUND()
	   UNLOCK
	ENDIF

RETURN(reglock(.T.)) 	&& CONFIRMA O BLOQUEIO DO SALDO


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD3I           MVObterSaldos VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    6  
*        Variable:            MVObterSaldos                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      5                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd3i     &&  MVObterSaldos VALID
#REGION 1
RETURN

******---------------------------------

PROCEDURE MVObterSaldos

********************   INICIO DA BUSCA DE SALDOS  **********************
PARAMETERS        m.sld_ante, m.vlr_ante, m.res_ante,;
                  m.dt_entrada, m.dt_saida,;
				  LNsldatu, LNvlratu, LNreserva,;
    	          qtd_compra, vlr_compra, ;
   	              qtd_venda , vlr_venda , ;
   	              qtd_e_tran, vlr_e_tran, ;
   	              qtd_e_outr, vlr_e_outr, ;
   	              qtd_s_tran, vlr_s_tran, ;
		          qtd_s_outr, vlr_s_outr, ;
				  ven_tab, ven_contab, ven_enc, ;
	 			  reserva

    ARQ_Itemmov  = NetArqAgain("ITEMMOV")
    ALS_Itemmov  = Alias()


    ARQ_ItmAnexo  = NetArqAgain("ITMANEXO")
    ALS_ItmAnexo  = Alias()

    ARQ_Saldo    = NetArqAgain("SALDO")
    ALS_Saldo   = Alias()


	* Captar Saldo Inicial do Mes

    SELE &ALS_Saldo
  	SET ORDER TO TAG clas_saldo
    SEEK STR(itemmov.empresa,3)+itemmov.classifica+;
    	    STR(YEAR(itemmov.data),4)+;
            STR(MONTH(itemmov.data),2)
	IF FOUND()
		m.sld_ante 	= &ALS_Saldo .sld_ante
	   	m.vlr_ante 	= &ALS_Saldo .vlr_ante
	   	m.res_ante 	= &ALS_Saldo .res_ante
		m.dt_entrada= &ALS_Saldo .dt_entrada
		m.dt_saida	= &ALS_Saldo .dt_saida

	ELSE
		m.sld_ante = 0	
	   	m.vlr_ante = 0
	   	m.res_ante 	= 0
		m.dt_entrada= {}
		m.dt_saida	= {}
	ENDIF




	SELE &ALS_Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SET NEAR ON

	SEEK STR(itemmov.EMPRESA,3) + itemmov.CODIGO   +;
		 DTOS(itemmov.DATA)     + itemmov.HORA     +;
		 itemmov.TIPO           + STR(itemmov.NOTA,7)      +;
		 STR(itemmov.ORDEM,3)

	SET NEAR OFF


	IF !(BOF() AND EOF())       && ITEMMOV ESTA VAZIO
		SKIP -1
		********************************************************
		* INICIO : ESTE BLOCO DE COMANDO FOI COLOCADO PARA EVITAR
		*          QUE QUANDO UMA RESERVA ESTIVER SENDO CANCELADA
		*          E OUTRO USUARIO INICIAR A ROTINA ATU_CMD O
		*          REGISTRO DE RESERVA QUE ESTA EM PROCESSO "****"
		*		   NAO INTERFIRA NO SALDO PROVOCANDO A MANUTENCAO
		*			DE SALDO DE RESERVA SENDO QUE A MESMA JA SAIU
		********************************************************
		DO WHILE !BOF()
		  IF &ALS_Itemmov .codigo  <> ITEMMOV.CODIGO ;
             OR &ALS_Itemmov .empresa <> ITEMMOV.EMPRESA
				EXIT
		  ENDIF

		  IF SUBS(&ALS_Itemmov .operacao,2,3) <> "***"
				EXIT
		  ENDIF
		  SKIP -1
		ENDDO
		***********************************************************
		* FIM DO BLOCO
		***********************************************************
	ENDIF
	IF BOF() ;
           OR &ALS_Itemmov .codigo      <> ITEMMOV.CODIGO ;
           OR &ALS_Itemmov .empresa     <> ITEMMOV.EMPRESA ;
		   OR YEAR(&ALS_Itemmov .data)  <> YEAR(ITEMMOV.data) ;
 		   OR MONTH(&ALS_Itemmov .data) <> MONTH(ITEMMOV.data)
						

			LNsldatu  = &ALS_Saldo .sld_ante
			LNvlratu  = &ALS_Saldo .vlr_ante
			LNreserva = &ALS_Saldo .res_ante
			m.res_ant = &ALS_Saldo .res_ante
	        STORE 0  TO  qtd_compra, vlr_compra, ;
     	                 qtd_venda , vlr_venda , ;
   	                     qtd_e_tran, vlr_e_tran, ;
   	                     qtd_e_outr, vlr_e_outr, ;
   	                     qtd_s_tran, vlr_s_tran, ;
		                 qtd_s_outr, vlr_s_outr, ;
 			 	         ven_tab, ven_contab, ven_enc, ;
	 			         reserva
	ELSE
		m.sld_ante = &ALS_Saldo .sld_ante
		m.vlr_ante = &ALS_Saldo .vlr_ante
		m.res_ante = &ALS_Saldo .res_ante

		LNsldatu  = &ALS_Itemmov .sld_estq
		LNvlratu  = &ALS_Itemmov .vlr_estq
		LNreserva = &ALS_Itemmov .sld_rese

		SELE &ALS_ItmAnexo
		SET ORDER TO TAG movanexo
		SEEK  STR(&ALS_Itemmov .empresa,3)+;
		          &ALS_Itemmov .codigo+;
			 DTOS(&ALS_Itemmov .data)+;
			      &ALS_Itemmov .hora+;
			      &ALS_Itemmov .tipo+;
			  STR(&ALS_Itemmov .nota,7)+;
			  STR(&ALS_Itemmov .ordem,3)

		IF !FOUND()
			m.qtd_compra = 0
			m.vlr_compra = 0
			m.qtd_venda  = 0
			m.vlr_venda  = 0
			m.qtd_e_tran = 0
			m.vlr_e_tran = 0
			m.qtd_e_outr = 0
			m.vlr_e_outr = 0
			m.qtd_s_tran = 0
			m.vlr_s_tran = 0
			m.qtd_s_outr = 0
			m.vlr_s_outr = 0
			m.ven_tab    = 0
			m.ven_contab = 0
			m.ven_enc    = 0
		ELSE
	        m.qtd_compra	= &ALS_ItmAnexo .q_compra
    	    m.vlr_compra	= &ALS_ItmAnexo .v_compra
        	m.qtd_venda 	= &ALS_ItmAnexo .q_venda
	        m.vlr_venda 	= &ALS_ItmAnexo .v_venda
	        m.qtd_e_tran	= &ALS_ItmAnexo .qe_tran
	        m.vlr_e_tran	= &ALS_ItmAnexo .ve_tran
	        m.qtd_e_outr	= &ALS_ItmAnexo .qe_outr
	        m.vlr_e_outr	= &ALS_ItmAnexo .ve_outr
	        m.qtd_s_tran	= &ALS_ItmAnexo .qs_tran
	        m.vlr_s_tran	= &ALS_ItmAnexo .vs_tran
	        m.qtd_s_outr	= &ALS_ItmAnexo .qs_outr
	        m.vlr_s_outr	= &ALS_ItmAnexo .vs_outr
	        m.ven_tab		= &ALS_ItmAnexo .v_tab
	        m.ven_contab	= &ALS_ItmAnexo .v_contab
	        m.ven_enc		= &ALS_ItmAnexo .v_enc
		ENDIF
	ENDIF

    =up_fecha("&ALS_Itemmov")
    =up_fecha("&ALS_ItmAnexo")
    =up_fecha("&ALS_Saldo")

	SELE itemmov

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD3U           MVIniRegSaldos VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    7  
*        Variable:            MVIniRegSaldos                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      6                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd3u     &&  MVIniRegSaldos VALID
#REGION 1
RETURN

******---------------------------------

PROCEDURE  MVIniRegSaldos   && Inicializa Registro de Saldos
PARAMETER 	LNempresa, LD_data, LScodigo, ;
            SLD_Abertura,;
            VLR_abertura, ;
            SLD_Reserva


        SELE GRUPO
        SET ORDER TO TAG CODIGO
        SEEK LScodigo
        IF !FOUND()
			=uperrosys()
			 WAIT WINDOW "ERRO. REG.PRODUTO NAO LOCALIZADO. <ENTER>..."
			 CLOSE ALL
			 QUIT
        ENDIF

        LSclassifica = Grupo.classifica

		SELE SALDO
		SET ORDER TO TAG emp_mes	
 		SEEK 	STR(LNempresa,3)+;
  			    STR(YEAR(LD_data),4)+;
			    STR(MONTH(LD_data),2)+;
			    LSclassifica
		**************************
	    m.empresa    = LNempresa
	    m.codigo     = LScodigo
	    m.classifica = LSclassifica
	    m.sld_ante   = SLD_Abertura
	    m.vlr_ante   = VLR_abertura
        m.res_ante   = SLD_Reserva
        m.reserva    = SLD_Reserva
		m.qtd_compra = 0
		m.vlr_compra = 0
		m.qtd_venda  = 0
		m.vlr_venda  = 0
		m.qtd_e_tran = 0
		m.vlr_e_tran = 0
		m.qtd_e_outr = 0
		m.vlr_e_outr = 0
		m.qtd_s_tran = 0
		m.vlr_s_tran = 0
		m.qtd_s_outr = 0
		m.vlr_s_outr = 0
		m.ven_tab    = 0
		m.ven_contab = 0
		m.ven_enc    = 0
	    m.status     = 'A'
	    IF FOUND()
	    	=REGLOCK(.T.)
			=edithand('REGRAVA')
	    ELSE
		    m.dtabert    = LD_data
			=edithand('SAVE')
	    ENDIF
	    UNLOCK
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD3V           MVprocessaMvto VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    8  
*        Variable:            MVprocessaMvto                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      7                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd3v     &&  MVprocessaMvto VALID
#REGION 1
RETURN


FUNCTION MVprocessaMvto		&& ATUALIZA CUSTO MEDIO COM BASE NO ITEMMOV
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata,;
			PRMhora,;
			PRMtipo,;
			PRMnota,;
			PRMordem


	************************************************************



	SELE Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SET NEAR ON

	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)


	SET NEAR OFF
	
	DO WHILE !EOF() ;
			AND PRMCodigo = itemmov.codigo ;
		    AND PRMEmpresa  = itemmov.empresa
		*-----------------------------------------------------------------*
		*  A condicao :
 		*   (PRMCodigo = itemmov.codigo OR PRMClasse= itemmov.classifica) ;
		*   foicolocada em substituicao a:
 		*   (PRMClasse = itemmov.classifica) ;
 		* POR MOTIVO DE  UMA CORRUPCAO NO CAMPO classifica do itemmov
 		* que provocava a saida do laco e nao processava os movimentos
 		* posteriores ao itemmov danificado. Como o codigo estava intacto
 		* esta condicao permite uma tolerancia a corrupcao do campo
 		* mesmo nao resolvendo o problema
		*-----------------------------------------------------------------*
		MsgStep = STR(PRMempresa,3)+"-"+itemmov.codigo+"-"+;
		          DTOS(itemmov.data)+"-"+itemmov.hora+"-"+;
		          itemmov.tipo+"-"+STR( itemmov.nota,7)+"-"+;
				STR(itemmov.ordem,3)
		wait window MsgStep nowait
 		
		

		SELE itemmov
		=REGLOCK(.T.)		&& BLOQ. ITEMMOV P/ ATUALIZAR

		IF YEAR(saldo.dtabert)  <> YEAR(itemmov.data) or ;
		   MONTH(saldo.dtabert) <> MONTH(itemmov.data)

				****** TESTA MOTIVO DO CHAMADO A ROTINA ********
				***********************************************

			    =MVAtlzSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
						    m.sld_ante, 		m.vlr_ante, ;
						    m.res_ante,;
			    			LNsldatu, 			LNvlratu, ;
							m.qtd_compra, 		m.vlr_compra, ;
  			 				m.qtd_venda , 		m.vlr_venda , ;
 			  				m.qtd_e_tran, 		m.vlr_e_tran, ;
  			  				m.qtd_e_outr, 		m.vlr_e_outr, ;
  			  				m.qtd_s_tran, 		m.vlr_s_tran, ;
  			  				m.qtd_s_outr, 		m.vlr_s_outr)

				* Rotina complementar em funcao do excesso de parametros
				* para MVAtlzSaldos impedir o uso de uma so procedure

			    =MVAtlzComplSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
				  				m.ven_tab, ;
				  				m.ven_contab, ;
								m.ven_enc, ;
				  				m.dt_entrada, ;
				  				m.dt_saida, ;
			  					LNreserva )



				*----------------------------------------------------*
				*   O movimento Passou para uma data fora do mes
				* em que o registro de saldo estava posicionado,
				* entao o reg. de saldo deve ser inicializado no
				* mes seguite mesmo que o movimento tenha saltado
				* mais de um mes, ou seja, pode haver um mes sem
				* REGISTRO DE MOVIMENTO mas nao sem REGISTRO DE SALDO
				*----------------------------------------------------*

				LD_nvdata = GOMONTH(saldo.dtabert,1)


		        =MVIniRegSaldos( saldo.empresa,;
		        			     LD_nvdata,;
		        			     saldo.codigo,;
		        			     LNsldatu,;
		        			     LNvlratu,;
		        			     LNreserva)

				SELE itemmov

				LOOP
		ENDIF




		PRIVATE tipo,operacao, qtde, tp_mercad, cst
		PRIVATE aliq_icms, vlrvenda,base_calc, vlripi, custo_ind
        PRIVATE icms_subs
		PRIVATE preco, ch_opera, ch_desti, codigo, classifica

		PRIVATE movfin,movestq,movvalor,movcusto
		PRIVATE orcamento,codforn


		SCATTER MEMVAR MEMO FIELDS tipo,operacao, qtde, tp_mercad, cst,;
			aliq_icms, vlrvenda,base_calc, vlripi, custo_ind, preco,;
            icms_subs,	ch_opera, ch_desti, codigo, classifica,;
			movfin,movestq,movvalor,movcusto,orcamento,codforn

*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
*>>>>>>>>>>>>>>>>>>>>>>>>>>   MOVIMENTACAO DE SALDOS AUXILIARES
*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		SET DECIMALS TO 8

        =MVGetCustMedio((operacao), (movcusto),LNcstmedio, ;
         							 LNsldatu, LNvlratu)

		*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		LNredutor   = 0
		LSoperacao  = "/"		&& => DIVISAO PELO LNredutor

        =MVGetIndRedutor((operacao), LNredutor,LSoperacao)

		IF LEFT(m.operacao,1) = "E"
			m.dt_entrada  = itemmov.data
		ELSE
			IF LEFT(m.operacao,1) = "S"
					m.dt_saida  = itemmov.data
			ENDIF			
		ENDIF

		*----------------------------------------------------------*
	*	PRIVATE LSUfOrigem
	*	PRIVATE LSUfDestino
		PRIVATE LNcusto

		IF LEFT(itemmov.operacao,1) = "E"		&& ENTRADAS
			=W_DEFPROC("notaite.spr")
			LNcusto= IEGetCusto( itemmov.Empresa, ;
					         itemmov.Favorecido,;
							 itemmov.orcamento , ;					
							 itemmov.ordem)
		ELSE
			LNcusto = 0
		ENDIF

		*----------------------------------------------------------*



		DO MVSetSldEntradas WITH LNcusto

		DO MVSetSldSaida
		
		DO MVSetSaldos WITH PrmEmpresa, LNcusto



		*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		*>>>>>>>>>>>>>>>>>>>>> FIM DOS TESTES DE CONTROLE DE MOVIMENTACAO
		*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		SET DECIMALS TO 2



		SELE itmanexo
		*****************************************************
        =MVSincrItmAnexo(m.qtd_compra, m.vlr_compra, m.qtd_venda,;
        				m.vlr_venda,  m.qtd_e_tran,    m.vlr_e_tran, ;
        				m.qtd_e_outr, m.vlr_e_outr, m.qtd_s_tran,;
        				m.vlr_s_tran, m.qtd_s_outr, m.vlr_s_outr,;
        				m.ven_tab	, m.ven_contab, m.ven_enc)
		*****************************************************
		m.sld_estq	= LNsldatu
		IF m.sld_estq = 0 OR LNvlratu = 0
		   m.vlr_estq = LNcstmedio && ULTIMO CUSTO
		   LNvlratu	  =  LNcstmedio
		ELSE
		    m.vlr_estq  = LNvlratu
		ENDIF
        IF LNreserva < 0	&& caso de interf. do usua.no reg. de res.
			LNreserva = 0
		ENDIF
		m.sld_rese  = LNreserva

		

		SELE itemmov
		SET FIELDS TO dtregis, hregis, usrregis,deletado
	    SET FIELDS TO sld_estq, vlr_estq, sld_rese
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		*****************************************************
		UNLOCK
		SKIP
	ENDDO

 	SELECT SALDO

	=MVAtlzSaldos(saldo.empresa,saldo.classifica,;
			    			 saldo.dtabert,;
						    m.sld_ante,	m.vlr_ante, ;
                            m.res_ante,;
			    			LNsldatu, 			LNvlratu, ;
							m.qtd_compra, 		m.vlr_compra, ;
   			 				m.qtd_venda , 		m.vlr_venda , ;
   			  				m.qtd_e_tran, 		m.vlr_e_tran, ;
   			  				m.qtd_e_outr, 		m.vlr_e_outr, ;
   			  				m.qtd_s_tran, 		m.vlr_s_tran, ;
   			  				m.qtd_s_outr, 		m.vlr_s_outr)

				* Rotina complementar em funcao do excesso de parametros
				* para MVAtlzSaldos impedir o uso de uma so procedure

    =MVAtlzComplSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
				  				m.ven_tab, ;
				  				m.ven_contab, ;
								m.ven_enc, ;
				  				m.dt_entrada, ;
				  				m.dt_saida, ;
			  					LNreserva )



	PRMdata = saldo.dtabert

 	SELECT SALDO
	UNLOCK
	=MVSldFuturo(PRMempresa,;
				 PRMclasse,;
				 PRMdata,;
				 LNsldatu,;
				 LNvlratu,;
				 LNreserva)

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD3W           MVSincrItmAnexo VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    9  
*        Variable:            MVSincrItmAnexo                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      8                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd3w     &&  MVSincrItmAnexo VALID
#REGION 1
RETURN

******---------------------------------

PROCEDURE MVSincrItmAnexo
PARAMETERS  m.q_compra, m.v_compra,  m.q_venda, m.v_venda,;
			m.qe_tran , m.ve_tran ,  m.qe_outr, m.ve_outr,;
			m.qs_tran , m.vs_tran ,  m.qs_outr, m.vs_outr,;
			m.v_tab   , m.v_contab,  m.v_enc

			


********************  INICIO DA BUSCA DE SALDOS **********************
	SELE itmanexo
	SET ORDER TO TAG movanexo
	SEEK STR(itemmov.empresa,3)+itemmov.codigo+;
			 DTOS(itemmov.data)+itemmov.hora+itemmov.tipo+;
			 STR(itemmov.nota,7)+STR(itemmov.ordem,3)
	IF !FOUND()
		SELE itmanexo
		SET ORDER TO TAG movanexo
		m.empresa 	= itemmov.empresa
		m.codigo 	= itemmov.codigo
	    m.classifica = itemmov.classifica
		m.data		= itemmov.data
		m.hora		= itemmov.hora
		m.tipo		= itemmov.tipo
		m.nota		= itemmov.nota
		m.ordem		= itemmov.ordem

		=edithand('SAVE')
    ELSE
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO ;
  	           	q_compra, v_compra,q_venda, v_venda, qe_tran, ve_tran,;
				qe_outr,ve_outr,qs_tran, vs_tran, qs_outr,vs_outr,;
				v_tab, v_contab, v_enc	
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD3X           MVAtlzSaldos VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   10  
*        Variable:            MVAtlzSaldos                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      9                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd3x     &&  MVAtlzSaldos VALID
#REGION 1
RETURN

******---------------------------------

PROCEDURE MVAtlzSaldos

PARAMETERS   	PRempresa,			PRclassifica,;
				PRdata,;
			    m.sld_ante, 		m.vlr_ante, ;
                m.res_ante,;
	   			m.sld_atu, 			m.vlr_atu, ;
				m.qtd_compra, 		m.vlr_compra, ;
    			m.qtd_venda , 		m.vlr_venda , ;
    			m.qtd_e_tran, 		m.vlr_e_tran, ;
    			m.qtd_e_outr, 		m.vlr_e_outr, ;
    			m.qtd_s_tran, 		m.vlr_s_tran, ;
    			m.qtd_s_outr, 		m.vlr_s_outr


	IF m.sld_atu = 0
		m.sld_atu = 0
		m.vlr_atu = 0
*	ELSE
*        IF m.reserva < 0	&& caso de interf. do usua.no reg. de res.
*			m.reserva = 0
*		ENDIF
	ENDIF




    ARQ_Saldo    = NetArqAgain("SALDO")
    ALS_Saldo    = Alias()

   	SELE &ALS_Saldo
  	SET ORDER TO TAG clas_saldo
    SEEK STR(PRempresa,3)+PRclassifica+;
    		STR(YEAR(PRdata),4)+;
        	STR(MONTH(PRdata),2)

	***************************
	SET FIELDS TO dtregis, hregis, usrregis,deletado
    SET FIELDS TO sld_ante, vlr_ante, ;
                  res_ante,;
			      sld_atu, vlr_atu, qtd_compra, vlr_compra, ;
    			  qtd_venda , vlr_venda , ;
    			  qtd_e_tran, vlr_e_tran, ;
    			  qtd_e_outr, vlr_e_outr, ;
    			  qtd_s_tran, vlr_s_tran, ;
    			  qtd_s_outr, vlr_s_outr, ;
				  ven_tab, ven_contab, ven_enc, ;
				  dt_entrada,dt_saida, reserva

     IF FOUND()
		=edithand('REGRAVA')
	 ELSE
		=edithand('SAVE')
   	 ENDIF	
	CLEAR FIELDS
	SET FIELDS OFF
    UNLOCK
    =up_fecha("&ALS_Saldo")

	***************************

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD4Q           MVAtlzComplSaldos VALID            
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   11  
*        Variable:            MVAtlzComplSaldos                  
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      10                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd4q     &&  MVAtlzComplSaldos VALID
#REGION 1
RETURN

******---------------------------------

* Rotina complementar em funcao do excesso de parametros
* para MVAtlzSaldos

PROCEDURE MVAtlzComplSaldos

PARAMETERS   	PRempresa,			PRclassifica,;
				PRdata,;
				m.ven_tab, 			m.ven_contab, ;
				m.ven_enc, ;
				m.dt_entrada, 		m.dt_saida, ;
				m.reserva

    ARQ_Saldo    = NetArqAgain("SALDO")
    ALS_Saldo    = Alias()

   	SELE &ALS_Saldo
  	SET ORDER TO TAG clas_saldo
    SEEK STR(PRempresa,3)+PRclassifica+;
    		STR(YEAR(PRdata),4)+;
        	STR(MONTH(PRdata),2)

	***************************
    SET FIELDS TO  ven_tab, ven_contab, ven_enc, ;
				  dt_entrada,dt_saida, reserva

     IF FOUND()
		=edithand('REGRAVA')
	 ELSE
		=edithand('SAVE')
   	 ENDIF	
	CLEAR FIELDS
	SET FIELDS OFF
    UNLOCK
    =up_fecha("&ALS_Saldo")

	***************************

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD4X           MVGetCustMedio VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   12  
*        Variable:            MVGetCustMedio                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      11                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd4x     &&  MVGetCustMedio VALID
#REGION 1
RETURN

******---------------------------------

PROCEDURE MVGetCustMedio

PARAMETERS  m.operacao, movcusto, LNcstmedio, LNsldatu, LNvlratu

        LNcstmedio = 0
		DO CASE
			CASE  (m.movcusto = "N" 	AND LNsldatu = 0)
		   	   LNcstmedio = LNvlratu  && ASSUME ULTIMO CUSTO ANTES DE ZERAR
			
			CASE  LEFT(m.operacao,1) = "S" AND ;
				  m.movcusto <> "N"  AND LNsldatu = 0

			*-------- ATENDE ex: VLG = COMPLEM DE PRECO EM PRODUTO ZERADO
		   	   LNcstmedio = LNvlratu  && ASSUME ULTIMO CUSTO ANTES DE ZERAR
									  && P/REGISTRAR VLR.DA OPERACAO
									  && DO CONTRARIO SERIA VLR=0 DEVIDO
									  && AO SALDO 0

			CASE  LEFT(m.operacao,1) = "E" AND ;
				  m.movcusto = "S" AND LNsldatu = 0
		       LNcstmedio = 0
		   	   LNvlratu   = 0         && ASSUME NOVO CUSTO A PARTIR DO ZERO
			CASE LNsldatu > 0 	
			   LNcstmedio = LNvlratu / LNsldatu   && ASSUME CUSTO ATUAL
		ENDCASE

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD53           MVGetIndRedutor VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   13  
*        Variable:            MVGetIndRedutor                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      12                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd53     &&  MVGetIndRedutor VALID
#REGION 1
RETURN

******---------------------------------

PROCEDURE MVGetIndRedutor

PARAMETERS  m.operacao, LNredutor, LSoperacao

		**************************************
		*   Aplicando o INDICE DE REDUCAO AO VLRVENDA provoca-se a
		* retirada do do VALOR DE ICMS que esta agregada ao valor
		* da mercadoria
		**************************************

		IF itemmov.data   < CTOD("01.05.2003")
		   do ind_ate010503
		ELSE
		   do ind_dep010503
		ENDIF

RETURN


PROCEDURE ind_dep010503

		LNredutor   = 1
		LSoperacao  = "*"		&& => no novo calculo de custo evista
		IF LEFT(m.operacao,1) = "E"
			m.dt_entrada  = itemmov.data
			IF m.tp_mercad <> 2
				LNredutor = 1-(m.aliq_icms /100)  && Extrair ICMS do custo
			ENDIF
		ENDIF
RETURN

PROCEDURE ind_ate010503

		LNredutor   = 0
		LSoperacao  = "/"	&& =>PARA MANTER COERENCIA ANTIGA
		IF LEFT(m.operacao,1) = "E"
			m.dt_entrada  = itemmov.data
			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************
			*********************************************************
			*    Inicio de tratamento nao parametrizavel ( ESPECIFICO)
			*		Para PNEUS Ind,Caminhao,Tratores,Agric,Terrapl
			*	> "00448"  e < "00800"	
			**********************************************************
			IF itemmov.data      >= CTOD("11.10.1997") AND ;
					   m.ch_opera   = "2" AND m.ch_desti   = "1" AND ;
					   m.tp_mercad = 2
					    IF LEFT(itemmov.classifica,5) > "00448" AND ;
						   LEFT(itemmov.classifica,5) < "00800"
							LNredutor = 1.24
						ELSE
							LNredutor = 1.26
						ENDIF				
			ELSE
				IF itemmov.data  >= CTOD("01.09.1999")
					LNredutor = 1-(m.aliq_icms /100)
					LSoperacao  = "*"	&& => MULTIPLICACAO PELO LNredutor
				ELSE
					LNredutor = 1+(m.aliq_icms /100)
					LSoperacao  = "/"	&& =>PARA MANTER COERENCIA ANTIGA
				ENDIF
			ENDIF
			**************************************
			* FIM APLICA INDICE DE REDUCAO AO VLRVENDA
			**************************************
		ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD5A           MVSetSldEntradas VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   14  
*        Variable:            MVSetSldEntradas                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      13                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd5a     &&  MVSetSldEntradas VALID
#REGION 1
RETURN

******---------------------------------

PROCEDURE MVSetSldEntradas
PARAMETERS LNcusto

		DO CASE
			CASE itemmov.data   < CTOD("01.05.2003")
				   do ste_ate010503
			CASE itemmov.data   < CTOD("01.07.2003") && CTOD("20.08.2003")
													 && CTOD("22.07.2003")
				   do ste_dep010503
			OTHERWISE
				   do ste_nvocst
		ENDCASE
RETURN


PROCEDURE ste_nvocst   && INCORPORA ICMS_SUBS AO CUSTO

   		DO CASE
			* ---------------> ENTRADAS PROCESSADAS
			CASE m.operacao = 'ECP.' 	 && ENTRADA\COMPRA\PROCESSADA
 			   	 m.qtd_compra = m.qtd_compra + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S" OR (m.movcusto = "N" AND LNvlratu = 0)
				   	 m.vlr_compra = m.vlr_compra + LNcusto
				 ELSE
				   	 m.vlr_compra = m.vlr_compra  + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ETP.'     &&  ENTRADA\TRANSF.\PROCESSADA
		   		 m.qtd_e_tran = m.qtd_e_tran + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S" OR (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_tran = m.vlr_e_tran + LNcusto
				 ELSE
			   		 m.vlr_e_tran = m.vlr_e_tran + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ERP.' OR ;
			     m.operacao = 'EDP.' OR ;
			     m.operacao = 'EOP.'      &&  ENTRADA\OUTRAS\PROCESSADA
		   		 m.qtd_e_outr = m.qtd_e_outr + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S" OR (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_outr = m.vlr_e_outr + LNcusto
				 ELSE
			   		 m.vlr_e_outr = m.vlr_e_outr + (m.qtde * LNcstmedio)
				 ENDIF

		ENDCASE
RETURN



PROCEDURE ste_dep010503   && INCORPORA ICMS_SUBS AO CUSTO

   		DO CASE
			* ---------------> ENTRADAS PROCESSADAS
			CASE m.operacao = 'ECP.' 	 && ENTRADA\COMPRA\PROCESSADA
 			   	 m.qtd_compra = m.qtd_compra + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
					IF m.ch_desti = "3"		&& ignora ICMS (NAO EMBUTIDO)
					   	 m.vlr_compra = m.vlr_compra ;
				   	 	+ m.vlrvenda + m.vlripi + m.custo_ind +	m.icms_subs
					ELSE
					   	 m.vlr_compra = m.vlr_compra ;
						   	 	+ (m.vlrvenda &LSoperacao LNredutor) ;
				   	 			+ m.vlripi + m.custo_ind + m.icms_subs
					ENDIF
				 ELSE
				   	 m.vlr_compra = m.vlr_compra ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ETP.'     &&  ENTRADA\TRANSF.\PROCESSADA
		   		 m.qtd_e_tran = m.qtd_e_tran + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_tran = m.vlr_e_tran ;
							+ (m.vlrvenda &LSoperacao LNredutor) ;
							+ m.vlripi + m.custo_ind + m.icms_subs
				 ELSE
			   		 m.vlr_e_tran = m.vlr_e_tran ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ERP.' OR ;
			     m.operacao = 'EDP.' OR ;
			     m.operacao = 'EOP.'      &&  ENTRADA\OUTRAS\PROCESSADA
		   		 m.qtd_e_outr = m.qtd_e_outr + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_outr = m.vlr_e_outr ;
				   		 			+ (m.vlrvenda &LSoperacao LNredutor) ;
				   		 			+ m.vlripi + m.custo_ind + m.icms_subs
				 ELSE
			   		 m.vlr_e_outr = m.vlr_e_outr ;
			   		 		+ (m.qtde * LNcstmedio)
				 ENDIF

		ENDCASE
RETURN

PROCEDURE ste_ate010503

   		DO CASE
			* ---------------> ENTRADAS PROCESSADAS
			CASE m.operacao = 'ECP.' 	 && ENTRADA\COMPRA\PROCESSADA
 			   	 m.qtd_compra = m.qtd_compra + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
					IF m.ch_desti = "3"		&& ignora ICMS (NAO EMBUTIDO)
					   	 m.vlr_compra = m.vlr_compra ;
				   	 	+ m.vlrvenda + m.vlripi + m.custo_ind
					ELSE
					   	 m.vlr_compra = m.vlr_compra ;
						   	 	+ (m.vlrvenda &LSoperacao LNredutor) ;
				   	 			+ m.vlripi + m.custo_ind
					ENDIF
				 ELSE
				   	 m.vlr_compra = m.vlr_compra ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ETP.'     &&  ENTRADA\TRANSF.\PROCESSADA
		   		 m.qtd_e_tran = m.qtd_e_tran + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_tran = m.vlr_e_tran ;
							+ (m.vlrvenda &LSoperacao LNredutor) ;
							+ m.vlripi + m.custo_ind
				 ELSE
			   		 m.vlr_e_tran = m.vlr_e_tran ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ERP.' OR ;
			     m.operacao = 'EDP.' OR ;
			     m.operacao = 'EOP.'      &&  ENTRADA\OUTRAS\PROCESSADA
		   		 m.qtd_e_outr = m.qtd_e_outr + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_outr = m.vlr_e_outr ;
				   		 			+ (m.vlrvenda &LSoperacao LNredutor) ;
				   		 			+ m.vlripi + m.custo_ind
				 ELSE
			   		 m.vlr_e_outr = m.vlr_e_outr ;
			   		 		+ (m.qtde * LNcstmedio)
				 ENDIF

		ENDCASE
RETURN

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD5B           MVSetSldSaidas VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   15  
*        Variable:            MVSetSldSaidas                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      14                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd5b     &&  MVSetSldSaidas VALID
#REGION 1
RETURN

******---------------------------------

PROCEDURE MVSetSldSaidas


		DO CASE

************CASE  m.tp_mercad = 7 AND  LEFT(m.operacao,1) = 'S' && SAIDA

			*-- SERVICO/SAIDA/VENDA/NAO NF DE ENTRADA--------------*
			CASE  m.tp_mercad = 7 AND LEFT(m.operacao,1) = 'S' AND ;
				  m.ch_opera = "1" AND m.tipo <> "ENT"

				 IF m.movestq = "S"
					 m.qtd_venda  = m.qtd_venda  + m.qtde
					 m.vlr_venda = m.vlr_venda   + m.vlrvenda + m.vlripi
				 ENDIF

			*-- SAIDA/VENDA/NAO NF DE ENTRADA--------------*

			CASE  LEFT(m.operacao,1) = 'S' AND ;
				  m.ch_opera = "1" AND m.tipo <> "ENT"
				 IF m.movestq = "S"
					 m.qtd_venda  = m.qtd_venda  + m.qtde
					 m.vlr_venda  = m.vlr_venda  + (LNcstmedio * m.qtde)
			   		 m.ven_contab = m.ven_contab + (m.qtde * LNcstmedio)
				 ENDIF

				 IF m.movvalor <> "N" 	&& Nos 1os MOVIMENTOS o Sim = ESPACO BRANCO
			   		 m.ven_tab 	  = m.ven_tab    + (m.qtde * m.preco)
					 m.ven_enc    = m.ven_enc +  m.vlrvenda	 + m.vlripi
					            && VEND.NO.PRECO FIN.c/ENCARG.
				 ENDIF
	 			 *---- O VALOR DA VENDA COM ENCARGOS = VLRVENDA --*
			CASE LEFT(m.operacao,3) = 'STP' && SAIDA\TRANSF.\PROCESSADAS
				 IF m.movestq = "S"
			   		 m.qtd_s_tran = m.qtd_s_tran + m.qtde
					 *---- CALCULO ESPECIAL PARA TRANSFERENCIAS ------*
					*----------------------------------------------------*
					*      O uso da fun눯o UPcustotransf foi desativado em
					* 27/12/2000 por ser redundante. O custo  apurado na
					* funco equivale ao custo normal que e calculado de
					* forma direta.
					*     O calculo usado na funcao parte do valor
					* registrado na nota de saida e que nao  corrigido
					* quando o custo  alterado pela corre눯o de uma entrada
					* anterior a tranf. EX:
					*     Na filial SIA foi dada entrada de produto em
					* codigo trocado o que elevou o custo deste e logo em
					* seguida foi feita transf. com custo errado. quando
					* a entrada foi corrigida o custo medio ficou correto
					* mas a transf nao foi ajusta.
					*----------------------------------------------------*
					* m.vlr_s_tran = m.vlr_s_tran+(m.qtde * UPcustotrasf())
					*----------------------------------------------------*
			   		 m.vlr_s_tran = m.vlr_s_tran + (m.qtde * LNcstmedio)
				 ENDIF
			CASE LEFT(m.operacao,1) = 'S' AND ;
			     SUBS(m.operacao,3,1) = 'P'	&& SAIDA\? OUTRAS ?\PROCESSADAS
				 IF m.movestq = "S"
			   		 m.qtd_s_outr = m.qtd_s_outr + m.qtde
			   		 m.vlr_s_outr = m.vlr_s_outr + (m.qtde * LNcstmedio)
				 ENDIF
		ENDCASE
RETURN

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD5C           MVSetSaldos VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   16  
*        Variable:            MVSetSaldos                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      15                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd5c     &&  MVSetSaldos VALID
#REGION 1
RETURN

******---------------------------------

PROCEDURE MVSetSaldos
PARAMETERS 	PRMempresa, LNcusto
	
	LSalias	= ALIAS()
    PRIVATE ARQ_Empresa,ALS_Empresa

	LSalias	= ALIAS()
	*-----------------------------------------------------------*


    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa

	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE SALDO ESTOQUE			*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF m.movestq = "S"
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
				IF SUBS(m.operacao,3,1) = "P" && SAIDA PROCESSADA
							LNsldatu   = LNsldatu - m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
				IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
						LNsldatu = LNsldatu + m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "R" AND m.operacao <> "R***"
				LNreserva  = LNreserva + m.qtde
		ENDCASE
	ENDIF


	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE VALOR ESTOQUE		*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA

		DO CASE
			CASE itemmov.data   < CTOD("01.05.2003")
					do Set_ate010503     && usado antes de  01/05/2003

			CASE itemmov.data   < CTOD("01.07.2003") && CTOD("20.08.2003")
													 && CTOD("22.07.2003")
					do Set_dep010503	 && usado depois de  01/05/2003
			OTHERWISE
				    do set_nvocst
		ENDCASE

    ENDIF

    =UP_Fecha("&ALS_Empresa")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN

PROCEDURE set_nvocst

	 DO CASE
		CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
			LNvlratu	= LNcstmedio * LNsldatu

		CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
			*--------------------------------------------------*
			IF m.movcusto = "S" OR (LNvlratu = 0)
				LNvlratu = LNvlratu + LNcusto
			ELSE
				LNvlratu	= LNcstmedio * LNsldatu
			ENDIF
			*-------------------------------------------------------*
	 ENDCASE
RETURN

*--------------------------------------------*
PROCEDURE Set_ate010503

	 DO CASE
		CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
			LNvlratu	= LNcstmedio * LNsldatu

		CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
			*--------------------------------------------------*
			IF m.movcusto = "S" OR (LNvlratu = 0)
				DO CASE
					CASE m.ch_desti = "3"	&& ignora ICMS (NAO
										&& EMBUTIDO) INTERNACIONAL
						LNvlratu = LNvlratu + m.vlrvenda ;
							 + m.vlripi + m.custo_ind
					OTHERWISE
						LNvlratu = LNvlratu ;
							+ (m.vlrvenda &LSoperacao LNredutor) ;
						 	+ m.vlripi + m.custo_ind
				ENDCASE
			ELSE
				LNvlratu	= LNcstmedio * LNsldatu
			ENDIF
			*-------------------------------------------------------*
	 ENDCASE
RETURN

*------------------------------------------------*
PROCEDURE Set_dep010503

	 DO CASE
		CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
			LNvlratu	= LNcstmedio * LNsldatu

		CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
			*--------------------------------------------------*
			IF m.movcusto = "S" OR (LNvlratu = 0)
				DO CASE
					CASE m.ch_desti = "3"	&& ignora ICMS (NAO
										&& EMBUTIDO) INTERNACIONAL
						LNvlratu = LNvlratu + m.vlrvenda ;
							 + m.vlripi + m.custo_ind
					OTHERWISE
						IF m.tp_mercad = 2	&& Regime Substituicao
							LNvlratu = LNvlratu + m.vlrvenda ;
								+ m.vlripi + m.custo_ind + m.icms_subs
						ELSE
							LNvlratu = LNvlratu ;
								+ (m.vlrvenda &LSoperacao LNredutor) ;
							 	+ m.vlripi + m.custo_ind + m.icms_subs
						ENDIF
				ENDCASE
			ELSE
				LNvlratu	= LNcstmedio * LNsldatu
			ENDIF
				*-------------------------------------------------------*
	 ENDCASE
RETURN
*------------------------------------------------*



PROCEDURE ANT2MVSetSaldos
	

	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE SALDO ESTOQUE			*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF m.movestq = "S"
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
				IF SUBS(m.operacao,3,1) = "P" && SAIDA PROCESSADA
							LNsldatu   = LNsldatu - m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
				IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
						LNsldatu = LNsldatu + m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "R" AND m.operacao <> "R***"
				LNreserva  = LNreserva + m.qtde
		ENDCASE
	ENDIF


	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE VALOR ESTOQUE		*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS

				LNvlratu	= LNcstmedio * LNsldatu

			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS

				*-------------------------------------------------------*
				IF m.movcusto = "S" OR (LNvlratu = 0)
					IF m.ch_desti = "3"		&& ignora ICMS (NAO EMBUTIDO) INTERNACIONAL
						LNvlratu = LNvlratu + m.vlrvenda ;
									 + m.vlripi + m.custo_ind
					ELSE
									
						LNvlratu = LNvlratu ;
								+ (m.vlrvenda &LSoperacao LNredutor) ;
								 	+ m.vlripi + m.custo_ind

					ENDIF
				ELSE
					LNvlratu	= LNcstmedio * LNsldatu
				ENDIF

				*-------------------------------------------------------*


		ENDCASE
	ENDIF

RETURN

*--------------------------------------------------*
* PROCESSO ANTIGO
*--------------------------------------------------*

PROCEDURE AntgMVSetSaldos
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
				DO CASE
					CASE SUBS(m.operacao,3,1) = "P" && SAIDA PROCESSADA
						 IF m.movestq = "S"
								LNsldatu   = LNsldatu - m.qtde
						 ENDIF
						&& CALCULA CUSTO MEDIO ATUAL
						&& ATUALIZA VALOR ESTOQUE
						LNvlratu	= LNcstmedio * LNsldatu
				ENDCASE
			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
				DO CASE
					CASE SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
						LNsldatu = LNsldatu + m.qtde
						*----------------------------------------------*
						IF m.movcusto = "S" OR (LNvlratu = 0)


							IF m.ch_desti = "3"	&& ignora ICMS (NAO
												&& EMBUTIDO) INTERNACIONAL
							    LNvlratu = LNvlratu + m.vlrvenda ;
									 + m.vlripi + m.custo_ind
							ELSE
								LNvlratu = LNvlratu ;
									+ (m.vlrvenda &LSoperacao LNredutor) ;
									 	+ m.vlripi + m.custo_ind
							ENDIF

						ELSE
							LNvlratu	= LNcstmedio * LNsldatu
						ENDIF

						*----------------------------------------------*

				ENDCASE

			CASE  LEFT(m.operacao,1) = "R" AND m.operacao <> "R***"
				LNreserva  = LNreserva + m.qtde
		ENDCASE


RETURN

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD5D           MVSldFuturo VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   17  
*        Variable:            MVSldFuturo                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      16                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvd5d     &&  MVSldFuturo VALID
#REGION 1
RETURN

******---------------------------------

FUNCTION MVSldFuturo		&& Bloquear Reg de Saldo
PARAMETERS PRMempresa, ;
			PRMclassifica, ;
			PRMdata, ;
			PRMsldatu, ;
			PRMvlratu, ;
			PRMreserva

 	SELECT SALDO
	SET ORDER TO TAG clas_saldo

    SEEK STR(PRMempresa,3)+PRMclassifica+;
    	    STR(YEAR(PRMdata),4)+;
            STR(MONTH(PRMdata),2)

	IF !EOF()
		SKIP
		m.sld_ante   = PRMsldatu
		m.vlr_ante   = PRMvlratu
        m.res_ante   = PRMreserva
		m.sld_atu 	 = PRMsldatu
		m.vlr_atu    = PRMvlratu
		m.reserva	 = PRMreserva
		m.qtd_compra = 0
		m.vlr_compra = 0
		m.qtd_venda  = 0
		m.vlr_venda  = 0
		m.qtd_e_tran = 0
		m.vlr_e_tran = 0
		m.qtd_e_outr = 0
		m.vlr_e_outr = 0
		m.qtd_s_tran = 0
		m.vlr_s_tran = 0
		m.qtd_s_outr = 0
		m.vlr_s_outr = 0
		m.ven_tab    = 0
		m.ven_contab = 0
		m.ven_enc    = 0
	    m.status     = 'A'
		DO WHILE !EOF() AND PRMclassifica = saldo.classifica ;
						AND PRMempresa	  = saldo.empresa
			=MVAtlzSaldos(saldo.empresa,saldo.classifica,;
			    			 saldo.dtabert,;
						    m.sld_ante, 		m.vlr_ante, ;
						    m.res_ante,;
			    			m.sld_atu, 			m.vlr_atu, ;
							m.qtd_compra, 		m.vlr_compra, ;
   			 				m.qtd_venda , 		m.vlr_venda , ;
   			  				m.qtd_e_tran, 		m.vlr_e_tran, ;
   			  				m.qtd_e_outr, 		m.vlr_e_outr, ;
   			  				m.qtd_s_tran, 		m.vlr_s_tran, ;
   			  				m.qtd_s_outr, 		m.vlr_s_outr)


				* Rotina complementar em funcao do excesso de parametros
				* para MVAtlzSaldos impedir o uso de uma so procedure

			    =MVAtlzComplSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
				  				m.ven_tab, ;
				  				m.ven_contab, ;
				  				m.ven_enc, ;
				  				m.dt_entrada, ;
				  				m.dt_saida, ;
				  				m.reserva )

			***************************
			SELE SALDO
			SKIP
		ENDDO
	ENDIF
	SET ORDER TO TAG emp_mes

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD67           NEGetFieldValue VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    2   
*        Variable:            NEGetFieldValue                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      17                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd67     &&  NEGetFieldValue VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetFieldValue
PARAMETERS PrmEmp,PrmBoletim,PrmForn,PrmField

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT(PrmField))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD6C           NEGetUFOrigem VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    3   
*        Variable:            NEGetUFOrigem                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      18                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd6c     &&  NEGetUFOrigem VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetUFOrigem
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT("UF"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD6I           NEGetUFDestino VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    4   
*        Variable:            NEGetUFDestino                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      19                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd6i     &&  NEGetUFDestino VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetUFDestino
PARAMETERS PrmEmp,PrmBoletim,PrmForn
	PRIVATE Lvalue


	=W_DEFPROC("empresa.spr")
	Lvalue = EMGet_UF(PrmEmp)

RETURN(Lvalue)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD6N           NEGetRetidoDestacado VALID         
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    5   
*        Variable:            NEGetRetidoDestacado               
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      20                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd6n     &&  NEGetRetidoDestacado VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetRetidoDestacado
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT("ICMS_SUBS"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD6S           NEVerifyInst VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    6   
*        Variable:            NEVerifyInst                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      21                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd6s     &&  NEVerifyInst VALID
#REGION 2
return
*---------------------------------------------------------------*



FUNCTION NEVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("NOTAENT")


	DO CASE

		CASE TYPE("PBNotaEntAlias") = "U" ;
		   		OR EMPTY(PBNotaEntAlias) ;
		   		OR !USED(PBNotaEntAlias)
			=NECreate()					

		CASE !("NOTAENT.DBF" $ DBF(PBNotaEntAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBNotaEntAlias
			=NECreate()					


		CASE  !(LSPath $ DBF(PBNotaEntAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=NEDestroi()				
			=NECreate()					
	ENDCASE

	
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD6Z           NECreate VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    7   
*        Variable:            NECreate                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      22                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd6z     &&  NECreate VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NECreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBNotaEntAlias") <> "U" ;
	   		AND !EMPTY(PBNotaEntAlias) ;
	   		AND USED(PBNotaEntAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBNotaEntAlias

	IF USED("NotaEnt")
	     =NetArqAgain("NotaEnt")
	     PBNotaEntAlias     = Alias()
	ELSE
	     =NetArqAgain("NotaEnt")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("NotaEnt")
	     PBNotaEntAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBNotaEntAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTNotaEnt[LMaxDim]
    PUBLIC DIMENSION VDNotaEnt[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFNotaEnt[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFNotaEnt)



	*-----------------------------------------------------------*
	=NEReadProperty()
	=NESetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD70           NEDestroi VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    8   
*        Variable:            NEDestroi                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      23                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd70     &&  NEDestroi VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION NEDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBNotaEntAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBNotaEntAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBNotaEntAlias
	*  3- Se aplicar um FECHAMENTO a PBNotaEntAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBNotaEntAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBNotaEntAlias)) OR ;
	   !("NOTAENT.DBF" $ DBF(PBNotaEntAlias))

		RELEASE PBNotaEntAlias
    	RELEASE VTNotaEnt
	    RELEASE VDNotaEnt
		RELEASE VFNotaEnt
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBNotaEntAlias) AND USED(PBNotaEntAlias)
		SELECT &PBNotaEntAlias
		USE
	ENDIF	
	RELEASE PBNotaEntAlias
    RELEASE VTNotaEnt
    RELEASE VDNotaEnt
	RELEASE VFNotaEnt

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD71           NEReadProp VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    9   
*        Variable:            NEReadProp                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      24                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd71     &&  NEReadProp VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBNotaEntAlias
	SCATTER TO VTNotaEnt
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD72           NESetDerivadas VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   10   
*        Variable:            NESetDerivadas                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      25                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd72     &&  NESetDerivadas VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NESetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDNotaEnt(1,1) = "UF DESTINO"
   	VDNotaEnt(1,2) = 0
   	VDNotaEnt(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD73           NESetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   11   
*        Variable:            NESetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      26                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd73     &&  NESetPropVT VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NESetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBNotaEntAlias,;
						    VTNotaEnt,;
						    VDNotaEnt,;
						    VFNotaEnt)

RETURN(Lvalue)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD74           NEGetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   12   
*        Variable:            NEGetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      27                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd74     &&  NEGetPropVT VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBNotaEntAlias,;
	            VTNotaEnt,;
	            VDNotaEnt,;
	            VFNotaEnt)

RETURN(Lvalue)





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD7W           NEChk_Identidade VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   13   
*        Variable:            NEChk_Identidade                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      28                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd7w     &&  NEChk_Identidade VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION NEChk_Identidade
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	PRIVATE LFretorno
	LFretorno = .t.

	=NEVerifyInst()

    =NESetPropVT("EMPRESA",PrmEmp)
    =NESetPropVT("REFERENCIA",PrmBoletim)
    =NESetPropVT("CODFORN",PrmForn)

	LFretorno=NEFind()
RETURN(LFretorno)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD82           NEFind VALID                       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   14   
*        Variable:            NEFind                             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      29                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd82     &&  NEFind VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEFind

	PRIVATE LEmpresa, LReferencia, LCodForn
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NEVerifyInst()


	LEmpresa    = NEGetPropVT("Empresa")
	LReferencia = NEGetPropVT("Referencia")
	LCodForn    = NEGetPropVT("CodForn")


	SELE &PBNotaentAlias
	SET ORDER TO TAG BOLETIM
	SEEK STR(LEmpresa,3)+STR(LReferencia,6)+STR(LCodForn,5)
	IF FOUND()
		=NEReadProperty()
		=NESetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD88           NEGetFieldValue VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   15   
*        Variable:            NEGetFieldValue                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      30                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd88     &&  NEGetFieldValue VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetFieldValue
PARAMETERS PrmEmp,PrmBoletim,PrmForn,PrmField

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT(PrmField))



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD8C           NE_Refresh VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   16   
*        Variable:            NE_Refresh                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      31                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd8c     &&  NE_Refresh VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
FUNCTION NE_Refresh
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	PRIVATE LFreturn
	
	=NEVerifyInst()
	*----------------------------------------------------------------*
	
    =NESetPropVT("EMPRESA",PrmEmp)
    =NESetPropVT("REFERENCIA",PrmBoletim)
    =NESetPropVT("CODFORN",PrmForn)
	=NEFind()
	
RETURN(.t.)






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD8H           NELerRegistro VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   18   
*        Variable:            NELerRegistro                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      32                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd8h     &&  NELerRegistro VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NELerRegistro
PARAMETERS PrmEmp,PrmBoletim,PrmForn



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)
RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD8I           NEWriteProp VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   19   
*        Variable:            NEWriteProp                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      33                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd8i     &&  NEWriteProp VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBNotaEntAlias
	=RLOCK()
	GATHER FROM  VTNotaEnt
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD8J           NESalvarRegistro VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   20   
*        Variable:            NESalvarRegistro                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      34                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd8j     &&  NESalvarRegistro VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NESalvarRegistro

	=NEVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !NEExiste()
		SELE &PBNotaEntAlias
		APPEND BLANK
		LFretorno=NEWriteProp()
	ELSE
		SELE &PBNotaEntAlias
		LFretorno=NEWriteProp()
	ENDIF

RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD8K           NEExiste VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   21   
*        Variable:            NEExiste                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      35                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd8k     &&  NEExiste VALID
#REGION 2
return
*---------------------------------------------------------------*
FUNCTION NEExiste

	PRIVATE LEmpresa, LReferencia, LCodForn
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NEVerifyInst()


	LEmpresa    = NEGetPropVT("Empresa")
	LReferencia = NEGetPropVT("Referencia")
	LCodForn    = NEGetPropVT("CodForn")


	SELE &PBNotaentAlias
	SET ORDER TO TAG BOLETIM
	SEEK STR(LEmpresa,3)+STR(LReferencia,6)+STR(LCodForn,5)
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD8L           NEGetAlias VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   23   
*        Variable:            NEGetAlias                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      36                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd8l     &&  NEGetAlias VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGetAlias

	=NEVerifyInst()

RETURN(PBNotaEntAlias)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD8M           NEVerPendencias VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   25   
*        Variable:            NEVerPendencias                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      37                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd8m     &&  NEVerPendencias VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEVerPendencias
PARAMETERS PrmEmp
    PRIVATE LSRetorno

	PRIVATE LSalias
	LSalias		= 	ALIAS()



	=W_DEFPROC("NOTAENT.SPR")
	NFAlias = NEGetAlias()

    SELECT NOTA,referencia FROM &NFAlias;
     WHERE empresa = PrmEmp ;
     and situacao = "c" ;
     INTO CURSOR NFEntTmp

   SELE NFEntTmp
   GO TOP
   IF EOF()
      LSretorno = 0
   ELSE
      LSretorno = NFEntTmp.nota
   ENDIF
   USE

   IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
   ENDIF


RETURN(LSretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD9E           PRVlrSaida VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    2     
*        Variable:            PRVlrSaida                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      38                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd9e     &&  PRVlrSaida VALID
#REGION 3
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRVlrSaida
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto, PrmEspecifico

	=W_DEFPROC("rotinas.spr")
	PRIVATE LNvalor
	PRIVATE LSalias

	PRIVATE LNtp_mercad
	
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_orcamento,ALS_orcamento
    PRIVATE ARQ_clienc,ALS_clienc
    PRIVATE ARQ_tipooper,ALS_tipooper
    PRIVATE ARQ_grupo,ALS_grupo
    PRIVATE ARQ_saldo,ALS_saldo
    PRIVATE ARQ_Preco,ALS_Preco




	LSalias = ALIAS()
	LNvalor = 0

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_orcamento     = NetArqAgain("ORCAMENTO")
    ALS_Orcamento     = Alias()

    ARQ_clienc     = NetArqAgain("clienc")
    ALS_clienc     = Alias()


    ARQ_Tipooper     = NetArqAgain("TIPOOPER")
    ALS_Tipooper     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Saldo     = NetArqAgain("SALDO")
    ALS_Saldo     = Alias()

    ARQ_Preco     = NetArqAgain("PRECO")
    ALS_Preco     = Alias()


	IF (ARQ_Empresa + ARQ_Orcamento+ARQ_tipooper+;
		ARQ_grupo+ARQ_Saldo+ARQ_Preco+Arq_clienc) > 100000
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF
	*---------------------------------------------------------*
    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

	SELECT &ALS_Clienc
	SET ORDER TO tag emporca
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF


	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

	*------------------------------------------------------------*
	=W_DEFPROC("TRIBUTAR.SPR")

	DO CASE

        *------------------------------------------------------------*
        * A venda bonificacao deve sair com mesmo valor aplicado as  *
        * transferencias                                             *
        *------------------------------------------------------------*
		Case TYPE("PrmEspecifico") = "C"
		    DO CASE
			  CASE PrmEspecifico = "VENDA BONIFICACAO"
				LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
					ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)
		    ENDCASE

		CASE &ALS_tipooper .ch_opera = "2" && TRANSFERENCIAS
			LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
				ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)


		CASE &ALS_tipooper .tipo = "ECP" && REMESP DEPO.FECHADO
			LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
				ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)

		CASE &ALS_tipooper .tipo = "RDO" && REMESP DEPO.FECHADO
			LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
				ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)

		CASE left( &ALS_tipooper .tipo,1) = "R" && REMESSAS EM GERAL
			LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
				ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)


		OTHERWISE
			LNvalor = PRVlrVenda(PrmEmpresa, PrmOrcamento, PrmProduto,;
	 			ALS_Empresa,ALS_Orcamento,ALS_Preco)

	ENDCASE

	*------------------------------------------------------------*

    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Orcamento")
    =up_fecha("&ALS_Tipooper")
    =up_fecha("&ALS_Grupo")
    =up_fecha("&ALS_Saldo")
    =up_fecha("&ALS_Preco")
    =up_fecha("&ALS_Clienc")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNvalor)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD9N           PRVlrTransf VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    3     
*        Variable:            PRVlrTransf                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      39                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvd9n     &&  PRVlrTransf VALID
#REGION 3
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRVlrTransf
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto,;
		ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo


	=W_DEFPROC("rotinas.spr")
	PRIVATE LNvalor
	PRIVATE LSalias

	PRIVATE LNtp_mercad
	

	LSalias = ALIAS()
	LNvalor = 0

	*---------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF


    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF


	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

	*------------------------------------------------------------*
**    IF &ALS_tipooper .ch_opera = "2" && TRANSFERENCIAS


        DO CASE

		  CASE &ALS_Orcamento .data < CTOD("01.05.2003")
			DO trf_ate010503

		  CASE &ALS_Orcamento .data < CTOD("01.09.2012")
			DO trf_dep010503
          OTHERWISE

			DO trfdp1912

        ENDCASE



				
****  ENDIF
	*------------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNvalor)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD9T           PRVlrVenda VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    4     
*        Variable:            PRVlrVenda                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      40                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


FUNCTION _4fe0kvd9t     &&  PRVlrVenda VALID
#REGION 3
return
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Pre뇇 de Tabela do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*					- TABELA EM VIGOR : Conforme a data passada
	*				como parametro;
	*
	*					- EMPRESA DE REFERENCIA : Duas Empresas podem
	*				usar uma tabela comum para evitar redundancia de
	*				informa뉏es ;
	*					EX : SIA usa tabela 2 (EMPTAB = 2)
	*						 W-3 refere a mesma (EMPTAB = 2)
	*
	*					- PRECO DIFERENCIADO PARA :
	*						Transferencia
	*						Vendas E Outras
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LSnatu_oper....: Indicativo da Natureza da Opercao
	*							(2) = 	Transferencia
	*							(<>2)	=	Outras Operacoes
	*						  Alteram a forma de definir o preco
	*		LSTpOper.......: TIPO Identificador da Operacao Comercial
	*		LScodigo..........: Codigo do produto
    *       LDdata.........: Data para Refereciar a tabela em Vigor
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNpreco........: Preco Localizado
	*		LSclascms......: Grupo de Comissao 		
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRVlrVenda
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto,;
 			ALS_Empresa,ALS_Orcamento,ALS_Preco

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LNpreco
	PRIVATE LNtbVigor, LSsrVigor

	*-----------------------------------------------------------*

	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LNpreco 	= 0
	STORE 0  TO LNtbVigor
	STORE "" TO LSsrVigor

	*-----------------------------------------------------------*
	*-----------------------------------------------------------*
	*--------------------------------------------------------

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF
	

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	*------------------------------------------------------------*

	IF !PRtabvigor(( &ALS_Orcamento .data ),LNtbVigor, LSsrVigor)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	*------------------------------------------------------------*
    SELECT &ALS_preco
   	SET ORDER TO TAG tabela
    IF SEEK(STR( &ALS_empresa .emptab,3);
           +STR( LNtbVigor ,3)+ LSsrVigor + PrmProduto)
       LNpreco 		=   &ALS_preco .preco
    ELSE
        LNpreco 	=	0
	ENDIF
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNpreco)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVD9Z           PRClas_Cms VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    5     
*        Variable:            PRClas_Cms                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      41                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


FUNCTION _4fe0kvd9z     &&  PRClas_Cms VALID
#REGION 3
return
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Pre뇇 de Tabela do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*					- TABELA EM VIGOR : Conforme a data passada
	*				como parametro;
	*
	*					- EMPRESA DE REFERENCIA : Duas Empresas podem
	*				usar uma tabela comum para evitar redundancia de
	*				informa뉏es ;
	*					EX : SIA usa tabela 2 (EMPTAB = 2)
	*						 W-3 refere a mesma (EMPTAB = 2)
	*
	*					- PRECO DIFERENCIADO PARA :
	*						Transferencia
	*						Vendas E Outras
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LSnatu_oper....: Indicativo da Natureza da Opercao
	*							(2) = 	Transferencia
	*							(<>2)	=	Outras Operacoes
	*						  Alteram a forma de definir o preco
	*		LSTpOper.......: TIPO Identificador da Operacao Comercial
	*		LScodigo..........: Codigo do produto
    *       LDdata.........: Data para Refereciar a tabela em Vigor
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LSclascms........: Preco Localizado
	*		LSclascms......: Grupo de Comissao 		
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRClas_Cms
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LSclascms
	PRIVATE LNtbVigor, LSsrVigor


    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Preco,ALS_Preco



	*-----------------------------------------------------------*

	LSalias	= ALIAS()
	*-----------------------------------------------------------*

	LSclascms 	= ""
	STORE 0  TO LNtbVigor
	STORE "" TO LSsrVigor

	*-----------------------------------------------------------*
	*-----------------------------------------------------------*
    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Preco     = NetArqAgain("PRECO")
    ALS_Preco     = Alias()

	*--------------------------------------------------------
    IF (ARQ_Empresa + ARQ_Orcamento + ARQ_Preco) > 100000
								    && HOUVE FALHA ABERT
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF

	*--------------------------------------------------------

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF
	

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF


	*------------------------------------------------------------*

	IF !PRtabvigor(( &ALS_Orcamento .data ),LNtbVigor, LSsrVigor)
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF

	*------------------------------------------------------------*
    SELECT &ALS_preco
   	SET ORDER TO TAG tabela
    IF SEEK(STR( &ALS_empresa .emptab,3);
           +STR( LNtbVigor ,3)+ LSsrVigor + PrmProduto)
       LSclascms 		=   &ALS_preco .clas_cms
	ENDIF
	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_Preco")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSclascms)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVDA0           PRCusto VALID                      
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    6     
*        Variable:            PRCusto                            
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      42                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvda0     &&  PRCusto VALID
#REGION 3
return

FUNCTION  PRCusto
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn,;
				PrmCUSTO_IND

	PRIVATE LNcusto, LNRtdoSaida, LNRtdoEntrada
	PRIVATE LNtp_mercad
	PRIVATE LNaliq_icms, LNicms
	LNcusto = 0
		

	=W_DEFPROC("tributar.spr")
	LNRtdoSaida = TRRtdoSaida(LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNRtdoEntrada = TRRtdoEntrada(LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn)
	
	=W_DEFPROC("tributar.spr")
	LNaliq_icms = TRAlqIcmInUF(LSufDestino)

	=W_DEFPROC("tributar.spr")
	LNtp_mercad = TRRegTrbMercadoria(LSufDestino,LSproduto)


	LNicms = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicms = TRicmNormal (LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn)
	*---------------------------------------------------------*

	IF LNtp_mercad = 1  && TRIBUTADA
		LNcusto = LNvlrMercadoria + LNvlrIPI + PrmCUSTO_IND+;
				LNRtdoEntrada + LNRtdoSaida	 - LNicms
	ELSE
		LNcusto = LNvlrMercadoria + LNvlrIPI + PrmCUSTO_IND+;
				LNRtdoEntrada + LNRtdoSaida	
	ENDIF

	*---------------------------------------------------------*



RETURN(LNcusto)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVDA1           PRtabvigor VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    7     
*        Variable:            PRtabvigor                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      43                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvda1     &&  PRtabvigor VALID
#REGION 3
RETURN

FUNCTION PRtabvigor
	PARAMETER LDdata,LNtabela,LSserie
    =W_DEFPROC("rotinas.spr")
    PRIVATE LSalias
	PRIVATE LFcadtab

	LNtabela = 0
   	LSserie  = ""

    LSalias	    = ALIAS()
    LFcadtab	= NetArq("cadtab")
    IF (LFcadtab) > 100000 && HOUVE FALHA ABERT
		=UP_fecha("cadtab" ,LFcadtab)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
    	RETURN(.f.)
    ENDIF
	SELE cadtab
	SET ORDER TO TAG tabela
	GO TOP
	DO WHILE !EOF()
		IF LDdata < cadtab.dtinicio or LDdata > cadtab.dtfim
			skip
			LOOP
		ENDIF
		LNtabela = cadtab.tabela
    	LSserie  = cadtab.serie
		EXIT
	ENDDO
	IF EOF()
	   DO OBJ_ALER.SPR WITH ;
		  "Nao foi encontrada nenhuma Tabela que vigor nesta data "+ ;
		    DTOC(LDdata)
	ENDIF
	=UP_fecha("cadtab" ,LFcadtab)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNtabela <> 0)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVDA2           PRdesconto VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    8     
*        Variable:            PRdesconto                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      44                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvda2     &&  PRdesconto VALID
#REGION 3
RETURN

FUNCTION PRdesconto
    PARAMETER LNemp,LSCodigo,LDdata,LNnat_clie,LNdesconto,LNerro, ;
        PrmVendedor

    = W_DEFPROC("rotinas.spr")
    PRIVATE LSalias
    PRIVATE LFpreco,LFprod_cms,LFempresa
	PRIVATE LNtabela,LSserie
    PRIVATE LFvertab
    PRIVATE LNFuncaoComissao

	LNdesconto  = 0
    LNERRO      = 0
	LNtabela	= 0
	LSserie 	= ""

	IF TYPE("PrmVendedor") = "N"
    	=W_DEFPROC("USUARIO.SPR")
		LNFuncaoComissao = USGetComissFuncao(PrmVendedor)
	ELSE

		LNFuncaoComissao = 0
	ENDIF

    LSalias	    = ALIAS()
    LFpreco     = NetArq("preco")
    LFprod_cms  = NetArq("prod_cms")
    LFempresa   = NetArq("empresa")
    IF (LFpreco+LFprod_cms) > 100000 && HOUVE FALHA ABERT
	    DO ULFchDesconto
	    LNERRO = 99         && OUTRAS FALHAS
    	RETURN(.F.)
    ENDIF
    IF !Prtabvigor(LDdata,LNtabela,LSserie)
	    DO ULFchDesconto
		LNERRO = 1         && NAO HA TABELA EM VIGOR NESTE PERIODO
    	RETURN(.F.)
    ENDI
    IF !Prpromocao(LNemp,LScodigo,LNnat_clie,LDdata,{},0,LNdesconto)
	   SELE empresa
	   SET ORDER TO TAG empresa 	
	   SEEK LNemp
	   IF !FOUND()
	       DO ULFchDesconto
		   LNERRO = 99         && OUTRAS FALHAS
    	   RETURN(.F.)
	   ENDIF
       SELE Preco
       SET ORDE TO tabela
       seek str(empresa.emptab,3)+STR(LNtabela,3)+LSserie+LSCodigo

       IF !FOUND()
		  DO ULFchDesconto
		  LNERRO = 4         && PRODUTO NAO CADASTRO EM TABELA PRECO
          RETURN(.F.)
       ENDI

       LSclas_cms = Preco.clas_cms

       SELE Prod_cms
       SET ORDE TO tabela



	   *--------------------------------------------------------------*	
	   *    O controle de desonto por funcao nao e viavel sendo assim
	   * a comissao fica vinculada a funcao mas o desconto sera o que
	   * estiver cadastrado no nivel padrao = 00
	   *--------------------------------------------------------------*	
       *seek str(LNemp,3)+STR(LNtabela,3)+LSserie+;
       *       LSClas_cms+str(LNFuncaoComissao,2)
       *IF !FOUND()
	   *    seek str(LNemp,3)+STR(LNtabela,3)+LSserie+LSClas_cms+str(0,2)
       *   IF !FOUND()
	   *	  DO ULFchDesconto
	   *      LNERRO = 1   && PRODUTO NAO CADASTRADO NA TABELA PROD_CMS
	   *      RETURN(.F.)
       *   ENDI
       * ENDIF
	   *--------------------------------------------------------------*	

       seek str(LNemp,3)+STR(LNtabela,3)+LSserie+LSClas_cms+str(0,2)
   	   IF !FOUND()
		  DO ULFchDesconto
          LNERRO = 1   && PRODUTO NAO CADASTRADO NA TABELA PROD_CMS
          RETURN(.F.)
   	   ENDI



       Do Case
          Case LNnat_clie = 0
               LNdesconto = prod_cms.desc_varej
          Case LNnat_clie = 1
               LNdesconto = prod_cms.desc_reven
          Case LNnat_clie = 2
               LNdesconto = prod_cms.desc_ppubl
          Case LNnat_clie = 3
               LNdesconto = prod_cms.desc_frota
       EndC
    ENDI

	DO ULFchDesconto

    IF LNdesconto=0
       LNERRO = 2
      ELSE
       LNERRO = 3
    ENDI
RETURN(LNdesconto<>0)

PROCEDURE ULFchDesconto
    =UP_fecha("preco"    ,LFpreco)
	=UP_fecha("prod_cms" ,LFprod_cms)
	=UP_fecha("empresa" ,LFempresa)
	IF !EMPTY(LSalias) AND USED(LSalias)
	   SELECT &LSalias
	ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVDAS           PRbrow_tab VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    9     
*        Variable:            PRbrow_tab                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      45                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvdas     &&  PRbrow_tab VALID
#REGION 3
RETURN

FUNCTION PRbrow_Tab
PARAMETERS LNemp,LNempTab,LNtab,LSserie,LDdtsaldo,LScodigo,LSclassifica
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Visualizar Tabela de Precos,Saldos e Reservas
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite visualizar a TABELA DE PRECOS
	*			demontrando SALDO e REZERVAS DE CADA PRODUTO
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LNemptab.......: Empresa de Referencia Para Tabela de Precos
	*		LNtab..........: Codigo da Tabela de Precos
	*		LSserie........: Serie da Tabela de Precos
	*		LDdtsaldo......: Data de Referencia para Consultar
	*						tabela de SALDOS
	*		LScodigo.......: Codigo do Produto que se quer
	*						 Posicionar ou Aproximar ou retornar
	*						 para rotina chamadora
	*		LSclassifica...: Classificao do Produto que se quer
	*						 Posicionar ou Aproximar ou retornar
	*						 para rotina chamadora
	*------------------------------------------------------------*
	*  RETORNO.....:- REGISTRO DO PRODUTO e PRECO POSICIONADO para
	*					ser tratado na rotina
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSemptmp

	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente



	*------------------------------------------------------------*

	=W_DEFPROC("AUTOPROC.SPR")
	=APTempGeral()

	*------------------------------------------------------------*

	SELE preco
	SET ORDER TO TAG tabela
	SET NEAR ON
	SEEK STR(LNempTab,3)+;
	     STR(LNtab,3)+;
	     LSserie+;
         ALLTRIM(LScodigo)
	SET NEAR OFF


    SELECT saldo
    SET ORDER TO TAG clas_saldo
    SELECT grupo
    SET ORDER TO TAG codigo
    SEEK preco.codigo
		
    SET ORDER TO TAG ordem

    SET RELATION TO STR(LNempTab,3)+STR(LNtab,3)+LSserie+;
                            grupo.codigo INTO preco ADDITIVE
    SET RELATION TO STR(LNemp,3)+grupo.classifica+;
        STR(YEAR(LDdtsaldo),4)+STR(MONTH(LDdtsaldo),2) ;
        	INTO saldo ADDITIVE
*--------
    LSemptmp =  STRTRAN(STR(LNemp,3),' ','0')

	KEYBOARD "{CTRL-F10}"

 	DO loc_dlog WITH .T.,;
		  " grupo.FLG_DESCRI = 'S' OR ;
		  (('&LSemptmp' $ grupo.tab_preco OR grupo.tp_mercad = 7)) ;
		    AND (!EMPTY(preco.codigo) OR ;
			 grupo.cdg_tipo <> 4) ","","B","ULtabres"

	CLEAR FIELDS
	SET FIELDS OFF
    SET ORDER TO TAG classifica
	SET RELATION TO
	*--------------------------------------------------------------*
	POP KEY 	&& reabilita teclas de atalho def. anteriormente
	*-----------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVDAZ           PRpromocao VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:   10     
*        Variable:            PRpromocao                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      46                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _4fe0kvdaz     &&  PRpromocao VALID
#REGION 3
RETURN

FUNCTION PRPROMOCAO
PARAMETERS LNemp,LScod,LNNatuclie,LDFIM,LDINICIO,LNPRECO,LNDesconto

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Pre뇇 Promocional
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite informar preco e desconto
	*			    promocional atraves de parametros
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....: PROMOCAO
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LScod..........: Codigo do produto
    *       LNNotclie......: Tipo do Cliente
    *                        0 - Varejo
    * 						 1 - Revenda
    *     					 2 - Poder Publico
    *						 3 - Frota
	*		LDFim..........: Data Final da Promocao
	*       LDInicio.......: Data Inicial da Promocao
	*       LNPreco........: Preco Promocao
    *       LNDesconto.....: Desconto conforme tipo do cliente
    *       LFretorno......: .t.  => Tem Promocao na data informada
    *                        .f.  => Nao Tem Promocao na data informada
	*------------------------------------------------------------*
	*  RETORNO.....: LFretorno
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno, LFpromocao
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LFpromocao		= NetArq("promocao")
	IF (LFpromocao) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("promocao" ,LFpromocao)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF

	LFretorno 	= .f.

    SELE PROMOCAO
    SET ORDE TO PROMOCAO
    SET NEAR ON
    SEEK STR(LNemp,3)+LScod+DTOS(LDfim)
    SET NEAR OFF
    IF promocao.empresa <> LNemp ;
    	OR promocao.codigo <> LScod ;
    	OR LDfim < promocao.dt_inicio ;
    	OR LDfim > promocao.Dt_fim
    	
       LFretorno = .f.
      else
       LFretorno = .t.
	   LDFim 	=  promocao.dt_fim
	   LDInicio =  promocao.dt_inicio
	   LNPreco  =  promocao.preco
	   	Do Case
	    	Case LNNatuclie = 0
	           LNDesconto = promocao.desc_varej
	     	Case LNNatuclie = 1
   	           LNDesconto = promocao.desc_reven
	      	Case LNNatuclie = 2
   	           LNDesconto = promocao.desc_ppubl
	      	Case LNNatuclie = 3
   	           LNDesconto = promocao.desc_frota
   	  	EndC
   	ENDI
	IF LNdesconto = 0
       LFretorno = .f.
	ENDIF
	
	=UP_fecha("promocao" ,LFpromocao)
   IF !EMPTY(LSalias) AND USED(LSalias)
      SELECT &LSalias
   ENDIF
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVDB7           PRVlrTabVgr VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:   11     
*        Variable:            PRVlrTabVgr                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      47                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


FUNCTION _4fe0kvdb7     &&  PRVlrTabVgr VALID
#REGION 3
return
	*------------------------------------------------------------*

FUNCTION PRVlrTabVgr
PARAMETERS PrmEmpresa, PrmData,PrmProduto

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LNpreco
	PRIVATE LNtbVigor, LSsrVigor
	PRIVATE LNEmpTab

	*-----------------------------------------------------------*

	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LNpreco 	= 0
	STORE 0  TO LNtbVigor
	STORE "" TO LSsrVigor

	*-----------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	LNEmpTab = EMGetFieldValue(PrmEmpresa,"EMPTAB")

	*------------------------------------------------------------*

	IF !PRtabvigor(PrmData, LNtbVigor, LSsrVigor)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	*------------------------------------------------------------*
    SELECT preco
   	SET ORDER TO TAG tabela
    IF SEEK(STR( LNEmpTab, 3);
           +STR( LNtbVigor ,3)+ LSsrVigor + PrmProduto)
       LNpreco 		=   preco .preco
    ELSE
        LNpreco 	=	0
	ENDIF
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNpreco)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVDBD           PRVlrTransf VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:   12     
*        Variable:            PRVlrTransf                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      48                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvdbd     &&  PRVlrTransf VALID
#REGION 3
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*



PROCEDURE trfdp1912

		PRIVATE LSUFdestino


		=W_DEFPROC("TRIBUTAR.SPR")
	   	LNtp_mercad = TRDef_TpMercad(PrmEmpresa,PrmOrcamento,PrmProduto)

		*------------------------------------------------------------*
		SELECT &ALS_Saldo
	   	SET ORDER TO TAG clas_saldo
	   	SEEK STR(PrmEmpresa,3)+ &ALS_grupo .classifica+;
    	    	STR(YEAR( &ALS_Orcament .data ),4)+;
    	    	STR(MONTH( &ALS_Orcament .data ),2)

	   	IF FOUND()

			IF &ALS_saldo .sld_atu = 0
		        LNvalor		=	&ALS_saldo .vlr_atu / 1
			else
		        LNvalor		=	&ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
			ENDIF

			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************

			IF &ALS_tipooper .ch_desti = "1"  && INTERNAS

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2
							LNvalor = LNvalor
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE

			ELSE

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2

						=W_DEFPROC("CLIENC.SPR")
						LSUFdestino = CNGetUFDestino(PrmEmpresa,;
													PrmOrcamento)

						=W_DEFPROC("TRIBUTAR.SPR")
						LNiva = TRGet_IVA(  &als_empresa .estado, ;
								            PrmProduto,;
								            LSUFdestino ,;
								            &ALS_Orcament .data )

						*=W_DEFPROC("TRIBUTAR.SPR")
						*LNiva=TRGet_IVA( &als_empresa .estado, PrmProduto)

						DO CASE
							CASE LNiva = 1.32
								LNvalor = LNvalor * 0.8945
							CASE LNiva = 1.42
								LNvalor = LNvalor * 0.8803
							CASE LNiva = 1.45
								LNvalor = LNvalor * 0.8761
							OTHERWISE							
								LNvalor = LNvalor
						ENDCASE
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE
			ENDIF
	   ENDIF
       IF LNvalor = 0
			=W_DEFPROC("ITEMMOV.SPR")
            LNvalor = IMGetUltCstMedioEstq(PrmEmpresa, ;
                                          &ALS_Orcament .data, ;
                                           PrmProduto)
       ENDIF
RETURN





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVDBK           PRVlrTransf VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:   13     
*        Variable:            PRVlrTransf                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      49                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvdbk     &&  PRVlrTransf VALID
#REGION 3
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*



PROCEDURE trf_dep010503

		PRIVATE LSUFdestino


		=W_DEFPROC("TRIBUTAR.SPR")
	   	LNtp_mercad = TRDef_TpMercad(PrmEmpresa,PrmOrcamento,PrmProduto)

		*------------------------------------------------------------*
		SELECT &ALS_Saldo
	   	SET ORDER TO TAG clas_saldo
	   	SEEK STR(PrmEmpresa,3)+ &ALS_grupo .classifica+;
    	    	STR(YEAR( &ALS_Orcament .data ),4)+;
    	    	STR(MONTH( &ALS_Orcament .data ),2)

	   	IF FOUND()

			IF &ALS_saldo .sld_atu = 0
		        LNvalor		=	&ALS_saldo .vlr_atu / 1
			else
		        LNvalor		=	&ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
			ENDIF

			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************

			IF &ALS_tipooper .ch_desti = "1"  && INTERNAS

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2
							LNvalor = LNvalor
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE

			ELSE

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2

						=W_DEFPROC("CLIENC.SPR")
						LSUFdestino = CNGetUFDestino(PrmEmpresa,;
													PrmOrcamento)

						=W_DEFPROC("TRIBUTAR.SPR")
						LNiva = TRGet_IVA(  &als_empresa .estado, ;
								            PrmProduto,;
								            LSUFdestino ,;
								            &ALS_Orcament .data )

						*=W_DEFPROC("TRIBUTAR.SPR")
						*LNiva=TRGet_IVA( &als_empresa .estado, PrmProduto)

						DO CASE
							CASE LNiva = 1.32
								LNvalor = LNvalor * 0.9055
							CASE LNiva = 1.42
								LNvalor = LNvalor * 0.8917
							CASE LNiva = 1.45
								LNvalor = LNvalor * 0.8877
							OTHERWISE							
								LNvalor = LNvalor
						ENDCASE
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE
			ENDIF
	   ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4FE0KVDBL           PRVlrTransf VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:   14     
*        Variable:            PRVlrTransf                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      50                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4fe0kvdbl     &&  PRVlrTransf VALID
#REGION 3
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*

PROCEDURE trf_ate010503

		=W_DEFPROC("TRIBUTAR.SPR")
	   	LNtp_mercad = TRDef_TpMercad(PrmEmpresa,PrmOrcamento,PrmProduto)

		*------------------------------------------------------------*
		SELECT &ALS_Saldo
	   	SET ORDER TO TAG clas_saldo
	   	SEEK STR(PrmEmpresa,3)+ &ALS_grupo .classifica+;
    	    	STR(YEAR( &ALS_Orcament .data ),4)+;
    	    	STR(MONTH( &ALS_Orcament .data ),2)
	   	IF FOUND()
			IF &ALS_saldo .sld_atu = 0
		        LNvalor		=	&ALS_saldo .vlr_atu / 1
			else
		        LNvalor		=	&ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
			ENDIF
			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************
			IF &ALS_tipooper .ch_desti = "1"
				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2
						************************************************
						*    Inicio de tratamento nao parametrizavel
						*	( ESPECIFICO)
						*	Para PNEUS Ind,Caminhao,Tratores,Agric,	
						*	Terrapl > "00448"  e < "00800"	
						************************************************
						IF LEFT( &ALS_grupo .classifica,5) > "00448" AND ;
						   LEFT( &ALS_grupo .classifica,5) < "00800"
						        LNvalor = LNvalor * 1.24
						ELSE
						        LNvalor = LNvalor * 1.26
						ENDIF				
					OTHERWISE
						LNvalor = LNvalor
				ENDCASE
			ELSE
		        LNvalor = LNvalor / ((100 - &ALS_tipooper .aliq_icms) / 100)
			ENDIF
	   ENDIF
RETURN
