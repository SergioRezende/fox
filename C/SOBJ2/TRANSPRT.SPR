*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        06/30/15            TRANSPRT.SPR               15:17:27 
*                                                                
*       픔컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        Author's Name                                           
*                                                                
*        Copyright (c) 2015 Company Name                         
*        Address                                                 
*        City,     Zip                                           
*                                                                
*        Description:                                            
*        This program was automatically generated by GENSCRN.    
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                       MS-DOS Window definitions                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                     TRANSPRT/MS-DOS Screen Layout              
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 1
@ 7,5 GET TRPVerifyInst ;
	PICTURE "@*HN TRPVerifyInst - Verifica Instancia" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruq2()
@ 8,8 GET TRPCreate ;
	PICTURE "@*HN TRPCreate - Instancia" ;
	SIZE 1,23,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruqd()
@ 17,8 GET TRPDestroi ;
	PICTURE "@*HN TRPDestroi - Desinstancia" ;
	SIZE 1,27,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrus3()
@ 9,10 GET TRPReadProp ;
	PICTURE "@*HN TRPReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrus4()
@ 10,10 GET TRPSetDerivadas ;
	PICTURE "@*HN TRPSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrus5()
@ 13,10 GET TRPSetPropVT ;
	PICTURE "@*HN TRPSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrus6()
@ 14,10 GET TRPGetPropVT ;
	PICTURE "@*HN TRPGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrus7()
@ 4,2 GET TRPChk_Identidade ;
	PICTURE "@*HN TRPChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrus8()
@ 3,2 GET TRPFind ;
	PICTURE "@*HN TRPFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrus9()
@ 20,2 GET TRPGetFieldValue ;
	PICTURE "@*HN TRPGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrusa()
@ 19,2 GET TRP_Refresh ;
	PICTURE "@*HN TRP_Refresh - Forca Atualiza놹o Objeto" ;
	SIZE 1,40,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrutm()
@ 24,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 26,2 GET TRPLerRegistro ;
	PICTURE "@*HN TRPLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,44,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrutn()
@ 16,10 GET TRPWriteProp ;
	PICTURE "@*HN TRPWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruto()
@ 27,2 GET TRPSalvarRegistro ;
	PICTURE "@*HN TRPSalvarRegistro - Salva Registro" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrutp()
@ 25,2 GET TRPExiste ;
	PICTURE "@*HN TRPExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrutq()
@ 32,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 21,2 GET TRPGetAlias ;
	PICTURE "@*HN TRPGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _4dy0wrutr()
@ 11,10 GET TRPSetConfig ;
	PICTURE "@*HN TRPSetConfig - Carga Propriedades de Configuracao/Parametros" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruts()
@ 28,2 GET TRPBtnVal ;
	PICTURE "@*HN TRPBtnVal - Trata Comandos de navegacao" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruv3()
@ 5,5 GET TRPTrtChave ;
	PICTURE "@*HN TRPTrtChave - Trata Acesso por Chave " ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruv4()
@ 29,2 GET TRPView ;
	PICTURE "@*HN TRPView - Visualisa BROWSE" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruv5()
@ 30,5 GET TRPLOCATE ;
	PICTURE "@*HN TRPLOCATE - Apoio a CLView - Visualisa BROWSE" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruv6()
@ 18,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 22,2 GET TRPScatter ;
	PICTURE "@*HN TRPScatter - Carrega Var de Memoria" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruv7()
@ 1,2 SAY "CLAS:V-1.0 => IMPLEMENTA NAVEGACAO E MANUTENCAO COMPLETA (BASE=CLIENTES)" ;
	SIZE 1,72, 0
@ 2,2 SAY "*---------------------------------------------------------------------*" ;
	SIZE 1,71, 0
@ 35,4 GET TRGerXMLTransFiscal ;
	PICTURE "@*HN TRGerXMLTransFiscal-Gera XML da Transportadora DocFiscal Por Doc Fiscal informado" ;
	SIZE 1,83,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruv8()
@ 33,2 SAY "XML=>" ;
	SIZE 1,5, 0
@ 36,8 GET TRNmFileXMLDocFiscal ;
	PICTURE "@*HN TRNmFileXMLDocFiscal-Define Path+File do XML DOC FISCAL" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruv9()
@ 40,10 GET TRInicioXML ;
	PICTURE "@*HN TRInicioXML-Monta Cabecalho XML com base no modelo-xmlDCCBR" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4dy0wruva()
@ 42,10 GET TRFinalXML ;
	PICTURE "@*HN TRFinalXML-Monta Cabecalho XML com base no modelo-xmlDCCBRS" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4dy0wruwm()
@ 39,8 GET TRGravaXMLTrDocFiscal ;
	PICTURE "@*HN TRGravaXMLTrDocFiscal - Converte uma Doc Fiscal em XML" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruwn()
@ 38,8 GET TRModeloRefXML ;
	PICTURE "@*HN TRModeloRefXML-MODELO P/MONTAR REF XML Doc Fiscal-xmlDCFIS" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4dy0wruwo()
@ 37,8 GET TRNmLongoFileXMLDocFiscal ;
	PICTURE "@*HN TRNmLongoFileXMLDocFiscal-Define Path+File do XML DOC FISCAL" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _4dy0wruwp()



READ


#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUQ2           TRPVerifyInst VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:    2  
*        Variable:            TRPVerifyInst                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      1                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruq2     &&  TRPVerifyInst VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION TRPVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("TRANSPRT")


	DO CASE

		CASE TYPE("PBTransprtAlias") = "U" ;
		   		OR EMPTY(PBTransprtAlias) ;
		   		OR !USED(PBTransprtAlias)
			=TRPCreate()					

		CASE !("TRANSPRT.DBF" $ DBF(PBTransprtAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBTransprtAlias
			=TRPCreate()					


		CASE  !(LSPath $ DBF(PBTransprtAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=TRPDestroi()				
			=TRPCreate()					
	ENDCASE

	
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUQD           TRPCreate VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:    3  
*        Variable:            TRPCreate                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      2                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruqd     &&  TRPCreate VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION TRPCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBTRANSPRTAlias") <> "U" ;
	   		AND !EMPTY(PBTRANSPRTAlias) ;
	   		AND USED(PBTRANSPRTAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBTRANSPRTAlias

	IF USED("TRANSPRT")
	     =NetArqAgain("TRANSPRT")
	     PBTRANSPRTAlias     = Alias()
	ELSE
	     =NetArqAgain("TRANSPRT")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("TRANSPRT")
	     PBTRANSPRTAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBTRANSPRTAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTTRANSPRT[LMaxDim]&& VETOR PARA CAMPOS DA TABELA
    PUBLIC DIMENSION VDTRANSPRT[2,3]	&& VETOR PARA CAMPOS DERIVADAS
    PUBLIC DIMENSION VFTRANSPRT[1]      && VETOR CABECALHO DOS CAMPOS
    PUBLIC DIMENSION VCTRANSPRT[8,3]	&& VETOR PARA CONFIGURACOES


	=AFIELDS(VFTRANSPRT)



	*-----------------------------------------------------------*
	=TRPReadProperty()
	=TRPSetDerivadas()
	=TRPSetConfig()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUS3           TRPDestroi VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:    4  
*        Variable:            TRPDestroi                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      3                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrus3     &&  TRPDestroi VALID
#REGION 1
return
*---------------------------------------------------------------*


FUNCTION TRPDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBTRANSPRTAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBTRANSPRTAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBTRANSPRTAlias
	*  3- Se aplicar um FECHAMENTO a PBTRANSPRTAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBTRANSPRTAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBTRANSPRTAlias)) OR ;
	   !("TRANSPRT.DBF" $ DBF(PBTRANSPRTAlias))

		RELEASE PBTRANSPRTAlias
    	RELEASE VTTRANSPRT
	    RELEASE VDTRANSPRT
		RELEASE VFTRANSPRT
		RELEASE VCTRANSPRT
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBTRANSPRTAlias) AND USED(PBTRANSPRTAlias)
		SELECT &PBTRANSPRTAlias
		USE
	ENDIF	
	RELEASE PBTRANSPRTAlias
    RELEASE VTTRANSPRT
    RELEASE VDTRANSPRT
	RELEASE VFTRANSPRT
	RELEASE VCTRANSPRT

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUS4           TRPReadProp VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:    5  
*        Variable:            TRPReadProp                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      4                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrus4     &&  TRPReadProp VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION TRPReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBTRANSPRTAlias
	SCATTER TO VTTRANSPRT
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUS5           TRPSetDerivadas VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:    6  
*        Variable:            TRPSetDerivadas                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      5                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrus5     &&  TRPSetDerivadas VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION TRPSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDTRANSPRT(1,1) = "NAOINFORMADO"	&& TITULO	
   	VDTRANSPRT(1,2) = 0					&& VALOR
   	VDTRANSPRT(1,3) = .F.				&& FLAG .T. => FOI CARREGADO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUS6           TRPSetPropVT VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:    7  
*        Variable:            TRPSetPropVT                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      6                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrus6     &&  TRPSetPropVT VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION TRPSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBTRANSPRTAlias,;
						    VTTRANSPRT,;
						    VDTRANSPRT,;
						    VFTRANSPRT,;
						    VCTRANSPRT)

RETURN(Lvalue)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUS7           TRPGetPropVT VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:    8  
*        Variable:            TRPGetPropVT                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      7                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrus7     &&  TRPGetPropVT VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION TRPGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBTRANSPRTAlias,;
	            VTTRANSPRT,;
	            VDTRANSPRT,;
			    VFTRANSPRT,;
			    VCTRANSPRT)

RETURN(Lvalue)





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUS8           TRPChk_Identidade VALID            
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:    9  
*        Variable:            TRPChk_Identidade                  
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      8                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrus8     &&  TRPChk_Identidade VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*


FUNCTION TRPChk_Identidade
PARAMETERS PrmCGC
	PRIVATE LFretorno
	LFretorno = .t.

	=TRPVerifyInst()

    =TRPSetPropVT("CGC",PrmCGC)

	LFretorno=TRPFind()
RETURN(LFretorno)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUS9           TRPFind VALID                      
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   10  
*        Variable:            TRPFind                            
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      9                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrus9     &&  TRPFind VALID
#REGION 1
return

*---------------------------------------------------------------*

FUNCTION TRPFind


	PRIVATE LCGC
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=TRPVerifyInst()


	SELE &PBTransprtAlias

	LSchaveAcesso  =TRPGetPropVT("CHAVE DE LEITURA")


	DO CASE
		CASE UPPER(LSchaveAcesso) = "CGC"
			LCGC = TRPgetPropVT("CGC")
			SET ORDER TO TAG CGC
			SEEK LCgc
		OTHERWISE
			LCGC = TRPgetPropVT("CGC")
			SET ORDER TO TAG CGC
			SEEK LCgc
	ENDCASE


	IF FOUND()
		=TRPReadProperty()
		=TRPSetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LFreturn)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUSA           TRPGetFieldValue VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   11  
*        Variable:            TRPGetFieldValue                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      10                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrusa     &&  TRPGetFieldValue VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION TRPGetFieldValue
PARAMETERS PrmCGC,PrmField

	=TRPChk_Identidade(PrmCGC)

RETURN(TRPGetPropVT(PrmField))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUTM           TRP_Refresh VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   12  
*        Variable:            TRP_Refresh                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      11                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrutm     &&  TRP_Refresh VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRP_Refresh
PARAMETERS PrmCGC
	PRIVATE LFretorno
	LFretorno = .t.

	=TRPVerifyInst()

    =TRPSetPropVT("CGC",PrmCGC)

	LFretorno=TRPFind()
RETURN(LFretorno)






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUTN           TRPLerRegistro VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   14  
*        Variable:            TRPLerRegistro                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      12                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrutn     &&  TRPLerRegistro VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRPLerRegistro
PARAMETERS PrmCGC

	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno =TRPChk_Identidade(PrmCGC)

RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUTO           TRPWriteProp VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   15  
*        Variable:            TRPWriteProp                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      13                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruto     &&  TRPWriteProp VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION TRPWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBTRANSPRTAlias
	=RLOCK()
	GATHER FROM  VTTRANSPRT
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUTP           TRPSalvarRegistro VALID            
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   16  
*        Variable:            TRPSalvarRegistro                  
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      14                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrutp     &&  TRPSalvarRegistro VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRPSalvarRegistro

	=TRPVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !TRPExiste()
		SELE &PBTRANSPRTAlias
		APPEND BLANK
		LFretorno=TRPWriteProp()
	ELSE
		SELE &PBTRANSPRTAlias
		LFretorno=TRPWriteProp()
	ENDIF

RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUTQ           TRPExiste VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   17  
*        Variable:            TRPExiste                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      15                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrutq     &&  TRPExiste VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION TRPExiste


	PRIVATE LCGC
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=TRPVerifyInst()


	SELE &PBTRANSPRTAlias

	LSchaveAcesso  =TRPGetPropVT("CHAVE DE LEITURA")


	DO CASE
		CASE UPPER(LSchaveAcesso) = "CGC"
			LCGC = TRPgetPropVT("CGC")
			SET ORDER TO TAG CGC
			SEEK LCGC
		OTHERWISE
			LCGC = TRPgetPropVT("CGC")
			SET ORDER TO TAG CGC
			SEEK LCGC
	ENDCASE


	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LFreturn)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUTR           TRPGetAlias VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   19  
*        Variable:            TRPGetAlias                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      16                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wrutr     &&  TRPGetAlias VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION TRPGetAlias

	=TRPVerifyInst()

RETURN(PBTRANSPRTAlias)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUTS           TRPSetConfig VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   20  
*        Variable:            TRPSetConfig                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      17                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruts     &&  TRPSetConfig VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION TRPSetConfig

	*--------------------------------------------------------------*
    VCTRANSPRT(1,1) = "REG_STATE" && INSERT/EDICAO/BROWSER/
   	VCTRANSPRT(1,2) = ""
   	VCTRANSPRT(1,3) = .T.
	*--------------------------------------------------------------*
    VCTRANSPRT(2,1) = "CHV_LER" && p/ leitura do ultimo reg + 1
   	VCTRANSPRT(2,2) = ""
   	VCTRANSPRT(2,3) = .T.
	*--------------------------------------------------------------*
    VCTRANSPRT(3,1) = "CHV_COMPARA" && p/ leitura do ultimo reg + 1
   	VCTRANSPRT(3,2) = ""
   	VCTRANSPRT(3,3) = .T.
	*--------------------------------------------------------------*
    VCTRANSPRT(4,1) = "CHV_BROW" && p/ leitura do ultimo reg + 1
   	VCTRANSPRT(4,2) = ""
   	VCTRANSPRT(4,3) = .T.
	*--------------------------------------------------------------*
    VCTRANSPRT(5,1) = "ISEDITING" && p/ leitura do ultimo reg + 1
   	VCTRANSPRT(5,2) = .F.
   	VCTRANSPRT(5,3) = .T.
	*--------------------------------------------------------------*
    VCTRANSPRT(6,1) = "ISADDING" && p/ leitura do ultimo reg + 1
   	VCTRANSPRT(6,2) = .F.
   	VCTRANSPRT(6,3) = .T.
	*--------------------------------------------------------------*
    VCTRANSPRT(7,1) = "ISREADING" && p/ leitura do ultimo reg + 1
   	VCTRANSPRT(7,2) = .F.
   	VCTRANSPRT(7,3) = .T.
	*--------------------------------------------------------------*
    VCTRANSPRT(8,1) = "CHAVE DE LEITURA" && TAG DO CHAVE USADA EM FIND
   	VCTRANSPRT(8,2) = "CGC"
   	VCTRANSPRT(8,3) = .T.
	*--------------------------------------------------------------*
	
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUV3           TRPBtnVal VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   21  
*        Variable:            TRPBtnVal                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      18                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruv3     &&  TRPBtnVal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRPBtnVal
PARAMETERS PrmTecla

	PRIVATE Lchv_Ler
	PRIVATE Lchv_Compara
	PRIVATE Lchv_Brow

	PRIVATE LCGC


	=TRPVerifyInst()

	Lchv_ler     = TRPGetPropVT("CHV_LER")
	Lchv_compara = TRPGetPropVT("CHV_COMPARA")
	Lchv_brow    = TRPGetPropVT("CHV_BROW")

	
	SELE &PBTRANSPRTAlias
	DO CASE
	
		CASE PrmTecla = "LOCATE"
			LCGC    = MNGetPropVT("CGC")

			=TRPView(LCGC)
			SELE &PBTRANSPRTAlias
			SCATTER MEMVAR MEMO

			
		OTHERWISE

		    DO btn_val with PrmTecla,;
	   			       Lchv_ler,;
	   			       Lchv_compara,;
	   			       Lchv_brow,;
	   			       .T.,;
	   			       .T.
	   			
	ENDCASE
	   			
	=TRPSetPropVT("ISEDITING",ISEDITING)
	=TRPSetPropVT("ISADDING",ISADDING)
	=TRPSetPropVT("ISREADING",ISREADING)
	   			
RETURN(.t.)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUV4           TRPTrtChave VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   22  
*        Variable:            TRPTrtChave                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      19                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruv4     &&  TRPTrtChave VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRPTrtChave
PARAMETERS PrmCGC

	PRIVATE LFretorno
	LFretorno = .t.

	=TRPVerifyInst()


    =TRPSetPropVT("CGC",PrmCGC)
	*--------------------------------------------------------------*

	LFretorno=TRPFind()

	SELE &PBTransprtAlias

RETURN(UPtratachv())





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUV5           TRPView VALID                      
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   23  
*        Variable:            TRPView                            
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      20                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruv5     &&  TRPView VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRPView
PARAMETERS PrmCGC

	PRIVATE LerTrans
	LerMuni =""


	PRIVATE PrmVlrLocate && VARIAVEL USADA PARA LOCATE
	                     && E PRESERVADA PARA USO NO CONTINUE
	                     && ELA E PUBLICA PARA:
	                     && MNView, MNLOCATE e MNContinue

	PrmVlrLocate = ""


	=W_DEFPROC("rotinas.spr")
	PRIVATE Lretorno
	=TRPVerifyInst()
	*--------------------------------------------------------------*
	IF TYPE("PrmCGC") <> "N"
		PrmCGC = 0
	ENDIF
	
	IF TYPE("PrmOrdem") <> "C" OR EMPTY(PrmOrdem)
		PrmOrdem = "CGC"
	ENDIF


	DO CASE
		CASE PrmOrdem = ""

			 PrmOrdem = ""

		OTHERWISE
		    SELECT DISTINCT ;
    		   	  CGC,;
    		   	  NOME,;
    		   	  BAIRRO,;
    	 		  CIDADE;
		     FROM  &PBTRANSPRTAlias ;
    		 ORDER BY  NOME;
		     INTO CURSOR TRPVIEW
	ENDCASE

	LOCATE FOR ALLTRIM(PrmCGC) $ CGC


	=UPLocDefWindow()

	ON KEY LABEL L DO TRPLOCATE WITH "CGC", LerCGC
	ON KEY LABEL M DO TRPLOCATE WITH "CGC", LerCGC
	ON KEY LABEL l DO TRPLOCATE WITH "CGC", LerCGC
	ON KEY LABEL m DO TRPLOCATE WITH "CGC", LerCGC



	ON KEY LABEL CTRL-G DO TRPCONTINUE


	BROWSE  FIELDS;
			CGC,;
			NOME ;
			:P="@S30",;
			CIDADE ;
			:P="@S30";
			:H="MUNICIPIO - (M)",;
			BAIRRO ;
			:P="@S30";
		WINDOW wzlocate ;
    		NOAPPEND NODELETE NOEDIT  ;
    			COLOR SCHEME 10


	=UPLocRelWindow()


	ON KEY LABEL CTRL-G
	ON KEY LABEL L
	ON KEY LABEL l
	ON KEY LABEL M
	ON KEY LABEL m
	ON KEY LABEL C
	ON KEY LABEL c
	ON KEY LABEL I
	ON KEY LABEL i


	PrmCGC    = TRPVIEW.CGC


	SELE TRPVIEW
	USE

	=TRP_Refresh(PrmCGC)
		
	*--------------------------------------------------------------*
RETURN(PrmTRANSPRT)

PROCEDURE  TRPCONTINUE

	CONTINUE
	IF EOF()
		GO TOP
		CONTINUE
	ENDIF

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUV6           TRPLOCATE VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   24  
*        Variable:            TRPLOCATE                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      21                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruv6     &&  TRPLOCATE VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*


FUNCTION TRPLOCATE
PARAMETERS PrmCGC,PrmUltimaPesquisa


	DO LOC_BROW.SPR with PrmFields,PrmUltimaPesquisa



	PrmVlrLocate = PrmUltimaPesquisa
	
	PrmVlrLocate = ALLTRIM(PrmVlrLocate)
	PrmVlrLocate = UPPER(PrmVlrLocate)




	
	DO CASE

		CASE  PrmFields = "CGC"
			LOCATE FOR PrmVlrLocate $ CGC ALL

	ENDCASE
	
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUV7           TRPScatter VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   26  
*        Variable:            TRPScatter                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      22                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruv7     &&  TRPScatter VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRPScatter

	PRIVATE LFretorno
	LFretorno = .t.

	=TRPVerifyInst()
	SELE &PBTRANSPRTAlias
	SCATTER MEMVAR MEMO
RETURN(.T.)






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUV8           TRGerXMLTransFiscal VALID          
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   29  
*        Variable:            TRGerXMLTransFiscal                
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      23                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruv8     &&  TRGerXMLTransFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGerXMLTransFiscal
PARAMETER PrmEmpresa,;
		  PrmMod_Doc,;
		  PrmCOD_IDFORN,;
		  PrmNro_Doc,;
		  PrmSerie_Doc,;
		  PrmTP_Mov
		


	PRIVATE LSalias
	
	PRIVATE PrmAlsDF
	PRIVATE LNrecDupl
	

	LSalias  = ALIAS()
	PrmAlsDF = DFGetAlias()

	*-----------------------------------------------------------*

	=TRModeloRefXML()

	*-----------------------------------------------------------*


	SELE &PrmAlsDF


	IF !DFLerRegistro(PrmEmpresa,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "MODELO: "+PrmMOD_DOC+;
		      "FORN. : "+STR(PrmCOD_IDFORN,6)+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC

      =fclose(LNroIDfileXML)
   	  return(.F.)
    ENDIF


	*-------------------------------------------------------*

   	PRIVATE LSfileXML,LNroIDfileXML


   	LSfileXML	= TRNmFileXMLDocFiscal(PrmEmpresa,PrmMod_doc,PrmNro_Doc)
   	LSfileXML	= "C:\NFE\TMP\"+LSfileXML


  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria눯o arquivo tempor쟲io '+LSfileXML+'- <ENTER> ' window
      return
   	endif

	*---------------------------------------------------*

	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() ;
	        AND PrmEmpresa    = &PrmAlsDF .empresa;
	        AND PrmMod_Doc    = &PrmAlsDF .MOD_DOC ;
	        AND PrmCOD_IDFORN = &PrmAlsDF .COD_IDFORN ;
	        AND PrmNro_Doc    = &PrmAlsDF .NRO_DOC ;
	        AND PrmSERIE_DOC  = &PrmAlsDF .SERIE_DOC;
         TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

	=TRInicioXML(LSfileXML,LNroIDfileXML)


	SET POINT TO ','


	SELE &PrmAlsDF
	DO WHILE !EOF() ;
			AND PrmTP_Mov = "SAIDA" ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa    = &PrmAlsDF .empresa;
	        AND PrmMod_Doc    = &PrmAlsDF .MOD_DOC ;
	        AND PrmCOD_IDFORN = &PrmAlsDF .COD_IDFORN ;
	        AND PrmNro_Doc    = &PrmAlsDF .NRO_DOC ;
	        AND PrmSERIE_DOC  = &PrmAlsDF .SERIE_DOC

		=UPtermo()

		LNrecDF = RECNO()


		*----------------------------------------------------*
    	* TESTA SE EXISTEM INFORMACOES DA TRANSPORTADORA
		*----------------------------------------------------*

		IF    EMPTY( &PrmAlsDF .TRSCPFCNPJ ) ;
		  AND  EMPTY( &PrmAlsDF .TRSNOME ) 	
		
			SELE &PrmAlsDF
			GO LNrecDF
			SKIP
			loop
		ENDIF


		=TRGravaXMLTrDocFiscal(;
 				PrmEmpresa,;
		  		PrmNro_Doc,;
			 	PrmMod_doc,;
				PrmCOD_IDFORN,;
			  	PrmSerie_Doc,;
				LSfileXML,;
				LNroIDfileXML;
				)


		SELE &PrmAlsDF
		

		GO LNrecDF
		SKIP
	ENDDO

	=TRFinalXML(LSfileXML,LNroIDfileXML)


	SET POINT TO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUV9           TRNmFileXMLDocFiscal VALID         
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   31  
*        Variable:            TRNmFileXMLDocFiscal               
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      24                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruv9     &&  TRNmFileXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRNmFileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*



	LSnomeArqXml = "DFISTR"+;
				   PrmMod_Doc
	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")


   	LSfileXML	= LSnomeArqXml+".XML"
	
RETURN(LSfileXML)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUVA           TRInicioXML VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   32  
*        Variable:            TRInicioXML                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      25                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruva     &&  TRInicioXML VALID
#REGION 1
RETURN

FUNCTION TRInicioXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML



	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDCTRN
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND xmlDCTRN.XML_ORDEM < 9999999999901
	
		LSLinhaXML = xmlDCTRN.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE xmlDCTRN
	USE
		

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUWM           TRFinalXML VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   33  
*        Variable:            TRFinalXML                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      26                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruwm     &&  TRFinalXML VALID
#REGION 1
RETURN

FUNCTION TRFinalXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDCTRN
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF xmlDCTRN.XML_ORDEM > 9999999999900
			LSLinhaXML = xmlDCTRN.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE xmlDCTRN
	USE
		

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUWN           TRGravaXMLTrDocFiscal VALID        
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   34  
*        Variable:            TRGravaXMLTrDocFiscal              
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      27                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruwn     &&  TRGravaXMLTrDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION TRGravaXMLTrDocFiscal
PARAMETERS  PrmEmp,;
			PrmNro_Doc,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmSerie_Doc,;
			PrmFileXML,;
			PrmNroIDfileXML




	IF !DFLerRegistro(PrmEmp,;
			PrmMod_doc,;
			PrmCod_IDForn,;
			PrmNro_Doc,;
			PrmSerie_Doc)
	      wait "Nao foi localizado DOC.FISCL :"+;
		      "FILIAL: "+STR(PrmEMP,3)+;
		      "MODELO: "+PrmMOD_DOC+;
		      "FORN. : "+STR(PrmCOD_IDFORN,6)+;
		      "NRO.  : "+STR(PrmNRO_DOC,7)+;
		      "SERIE : "+PrmSERIE_DOC
   	  return(.F.)
   ENDIF


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	*-------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	=EMLerRegistro(PrmEmp)

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("CGC")
	UNEM_CNPJ    =  STR(LFieldTmp,14)
	UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")


	SET POINT TO ","
	SET SEPARATOR  TO "."




	LSLinhaXML = ULtratalinha('<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*==========================================================*
	*  CAMPOS IDENTIFICADORES
	*==========================================================*

	=W_DEFPROC("EMPRESA.SPR")

	LSEmite_NFe = EMGetPropVT("EMITE_NFE")




	IF LSEmite_NFe $ "H"   && H=HOMOLOGACAO

		LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             "55" +;
	             '"')
                =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	ELSE
		LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             DFGetPropVT("MOD_DOC") +;
	             '"')
                =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	ENDIF

	LSLinhaXML = ULtratalinha('DFIS_IND_OPERACAO="'+;
	             DFGetPropVT("IND_OPER") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
	LSLinhaXML = ULtratalinha('DFIS_TP_MOVIMENTO="'+;
	             DFGetPropVT("TP_MOV") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*

	LNNro_Doc  = DFGetPropVT("NRO_DOC")

	DO CASE
		CASE LNNro_Doc > 4000000
			LNNro_Doc = LNNro_Doc - 4000000
		CASE LNNro_Doc > 3000000
			LNNro_Doc = LNNro_Doc - 3000000
	ENDCASE





	LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO_FISCAL="'+;
	             STR(LNNro_Doc,7) +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*----------------------------------------------------*
	* SERIE UNICA => "0"
	*----------------------------------------------------*
	

	LSLinhaXML = DFGetPropVT("SERIE_DOC")
	IF "U" $ LSLinhaXML
		LSLinhaXML = "0"
	ENDIF

	LSLinhaXML = ULtratalinha('DFIS_SERIE="'+;
	             LSLinhaXML +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*-- TRANSPORTADORA  -------------------------------------*



	LSLinhaXML = ULtratalinha('DFTR_RNTC="'+;
	             DFGetPropVT("TRSRNTC") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_PLACA_UF="'+;
	             DFGetPropVT("TRSPLACAUF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_PLACA_VEICULO="'+;
	             DFGetPropVT("TRSPLACA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_CPFCNPJ="'+;
	             DFGetPropVT("TRSCPFCNPJ") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_NOME="'+;
	             DFGetPropVT("TRSNOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_UF="'+;
	             DFGetPropVT("TRSUF") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_IE="'+;
	             DFGetPropVT("TRSIE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_TP_LOGRADOURO="'+;
	             DFGetPropVT("TRSLOGRA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_LOGRADOURO="'+;
	             DFGetPropVT("TRSLOGRA") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_NRO="'+;
	             DFGetPropVT("TRSNRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COMPLEMENTO="'+;
	             DFGetPropVT("TRSCOMPLEM") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_CEP="'+;
	             DFGetPropVT("TRSCEP") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_MUNI_IBGE="'+;
	             DFGetPropVT("TRSMUNIBGE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_MUNI_NOME="'+;
	             DFGetPropVT("TRSMUNNOME") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_BAIRRO="'+;
	             DFGetPropVT("TRSBAIRRO") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_PAIS="'+;
	             DFGetPropVT("TRSPAIS") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_FONE="'+;
	             DFGetPropVT("TRSFONE") +;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*--------------------------------------------------------------*
	LSLinhaXML = ULtratalinha('DFTR_COLETA_CPFCNPJ="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COLETA_IE="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COLETA_NOME="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_COLETA_MUNI_IBGE="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_COLETA_ENDERECO="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*--------------------------------------------------------------*
	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_CPFCNPJ="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_IE="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_NOME="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_MUNI_IBGE="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LSLinhaXML = ULtratalinha('DFTR_ENTREGA_ENDERECO="'+;
	             ""+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	LSLinhaXML = ULtratalinha('DFTR_RESPONSAVEL_SEGURO="'+;
	             "4"+;
	             '"')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*-------------------------------------------------------*
	LSLinhaXML = ULtratalinha('/>')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)

FUNCTION ULtratalinha
PARAMETERS LSLINHA

	LSLINHA = UPPER(LSLINHA)
	LSLINHA = RTRIM(LSLINHA)

RETURN(LSLINHA)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUWO           TRModeloRefXML VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   35  
*        Variable:            TRModeloRefXML                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      28                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruwo     &&  TRModeloRefXML VALID
#REGION 1
RETURN

FUNCTION TRModeloRefXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\DOCFISTR.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\xmlDCTRN EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE xmlDCTRN


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _4DY0WRUWP           TRNmLongoFileXMLDocFiscal VALID    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRANSPRT,     Record Number:   36  
*        Variable:            TRNmLongoFileXMLDocFiscal          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      29                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _4dy0wruwp     &&  TRNmLongoFileXMLDocFiscal VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRNmLongoFileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc


   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
    PRIVATE LSPrefixo,LSTpDoc,LSNrDoc,LSNrEmp

	
	*----------------------------------------------------------*
    LSPrefixo = "DFISTR"
    LSTpDoc   = PrmMod_Doc
    LSNrDoc   = CHRTRAN(STR(PrmNro_Doc,7)," ","0")
    LSNrEmp   = CHRTRAN(STR(PrmEmpresa,3)," ","0")



	LSnomeArqXml = LSPrefixo+LSNrEmp+LSTpDoc+LSNrDoc+".XML"

   	LSfileXML	= LSnomeArqXml
	
RETURN(LSfileXML)
