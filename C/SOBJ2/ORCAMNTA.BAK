*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ 26/05/2014           ORCAMNTA.SPR              17:28:37 ╨
*       ╨                                                         ╨
*       гддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╤
*       ╨                                                         ╨
*       ╨ Author's Name                                           ╨
*       ╨                                                         ╨
*       ╨ Copyright (c) 2014 Company Name                         ╨
*       ╨ Address                                                 ╨
*       ╨ City,     Zip                                           ╨
*       ╨                                                         ╨
*       ╨ Description:                                            ╨
*       ╨ This program was automatically generated by GENSCRN.    ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨                MS-DOS Window definitions                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨         ORCAMNTA/MS-DOS Setup Code - SECTION 2          ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
RETURN

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨         ORCAMENT/MS-DOS Setup Code - SECTION 2          ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 2
RETURN

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨           PRECO/MS-DOS Setup Code - SECTION 2           ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 3
return

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨          ESTOQUE/MS-DOS Setup Code - SECTION 2          ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 5
RETURN

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨         CLIENTES/MS-DOS Setup Code - SECTION 2          ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 10
RETURN

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨          CLIEN_R/MS-DOS Setup Code - SECTION 2          ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 11
RETURN

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨         AUTOPROC/MS-DOS Setup Code - SECTION 2          ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 12
return

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              ORCAMNTA/MS-DOS Screen Layout              ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
@ 36,1 GET ORimp_osi ;
	PICTURE "@*HN ORloc_orc  - Auxilia na Montagem do Brow para Localizar Orcamentos" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _42s11gjo3()
@ 37,4 GET ORLoc_Browse ;
	PICTURE "@*HN ORLoc_Browse -Browse de Pesquisa de Orcamento - TABELA TMP ORCABROW" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _42s11gjoh()
@ 1,1 GET ORadOrcament ;
	PICTURE "@*HN ORadOrcament - Cria um Registro de Orcamento Padrao" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _42s11gjor()
@ 2,3 GET ORnro_OSI ;
	PICTURE "@*HN ORnro_OSI   - Informa Numero Disponivel para O.S.I" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _42s11gjos()
@ 6,1 GET ORValEntClie ;
	PICTURE "@*HN ORValEntCli - Valida Entrada do Cliente no Orcamento" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gjot()
@ 7,4 GET ORValid_Clie ;
	PICTURE "@*HN ORValid_Clie- Critica do Cliente Informado " ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _42s11gjpn()
@ 8,4 GET ORAtlz_Clie ;
	PICTURE "@*HN ORAtlz_Clie- Atualiza Dados do Cliente Cadastrados no Orcamento" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _42s11gjpw()
@ 10,1 GET ORclas_oper ;
	PICTURE "@*HN ORclas_oper - Classifica Operacao Comercial Para Definicao do TIPO " ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _42s11gjq8()
@ 11,1 GET ORnewclas_oper ;
	PICTURE "@*HN ORnewclas_oper - Classifica Operacao Comercial Para Definicao do TIPO " ;
	SIZE 1,72,1 ;
	DEFAULT 1 ;
	VALID _42s11gjq9()
@ 18,3 GET ORdef_tribut ;
	PICTURE "@*HN ORdef_tribut-Def.Caracteristica Trib. e Operacionais Produto" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gjqa()
@ 13,1 GET ORprzmedio ;
	PICTURE "@*HN ORprzmedio - Calcula Prz Medio , Nro Pgtos e Taxa Juros " ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _42s11gjrm()
@ 19,3 GET ORcalc_vlres ;
	PICTURE "@*HN ORcalc_vlres- Calcula Valores Comerciais " ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _42s11gjrt()
@ 16,1 GET ORrecalc_OSI ;
	PICTURE "@*HN ORrecalc_OSI- Reclassifica e Recalcula OSI Por mudancas no Orcamento" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _42s11gjs1()
@ 17,3 GET ORrecalc_item ;
	PICTURE "@*HN ORrecalc_item- Reclassifica e Recalcula ITENS DA OSI Por mudancas no Orcamento" ;
	SIZE 1,80,1 ;
	DEFAULT 1 ;
	VALID _42s11gjs2()
@ 14,1 GET ORsoma_orc ;
	PICTURE "@*HN ORsoma_orc  - Soma Valores Comerciais e Tributarios do Orcamento" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _42s11gjsm()
@ 24,1 GET ORSelimp_osi ;
	PICTURE "@*HN ORSelimp_osi- Seleciona OSI que Sera Impressa" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _42s11gjsv()
@ 25,5 GET ORimp_osi ;
	PICTURE "@*HN ORimp_osi   - Coordena Impressao da OSI" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _42s11gjt5()
@ 49,1 GET ORgrvavisolib ;
	PICTURE "@*HN ORgrvavisolib- Grava Numero do Orcamento Para Avisar Liberacao de Credito" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _42s11gjtk()
@ 50,1 GET ORleravisolib ;
	PICTURE "@*HN ORleravisolib- Ler Numero do Orcamento Para Avisar Liberacao de Credito" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _42s11gjtl()
@ 39,1 GET ORTenta_Liberar ;
	PICTURE "@*HN ORTenta_Liberar - Avalia Orcamento com Dados do Sistema Para Tentar Liberacao" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _42s11gjtm()
@ 21,1 GET ORimp_orca ;
	PICTURE "@*HN ORimp_orca   - Relaciona todos Itens da Osi" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _42s11gjua()
@ 40,3 GET ORVer_credito ;
	PICTURE "@*HN ORVer_credito - Faz uma Varredura nas Condicoes de Credito do Cliente" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _42s11gjul()
@ 26,1 GET ORSelreserva ;
	PICTURE "@*HN ORSelreserva- Seleciona OSI que Sera Reservada" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _42s11gjuw()
@ 29,1 GET ORSelcancreserva ;
	PICTURE "@*HN ORSelcancreserva- Seleciona OSI que tera Reserva Cancelada" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _42s11gjv4()
@ 27,4 GET ORreserva ;
	PICTURE "@*HN ORreserva- Controla o Processo de Reserva de Uma OSI" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gjv5()
@ 30,4 GET ORcancreserva ;
	PICTURE "@*HN ORcancreserva- Controla o Processo de Cancelamento de Reserva de Uma OSI" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _42s11gjv6()
@ 28,7 GET ORprocreserva_item ;
	PICTURE "@*HN ORprocreserva_item - Registra/Cancela Reserva para Item em ITEMMOV" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _42s11gjvx()
@ 3,3 GET ORVTmotivos ;
	PICTURE "@*HN ORVTmotivos - Preenche Vetor de Motivos de OSI" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _42s11gjwa()
@ 4,3 GET ORVlr_e_FormPgto ;
	PICTURE "@*HN ORVlr_e_FormPgto-Obtem Vlrs Dinh.,Chq.,Cartao e Dupl(Ticket) no pgto" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _42s11gjwg()
@ 22,1 GET ORlog ;
	PICTURE "@*HN ORlog - Extrato de Log de Orcamento" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _42s11gjwh()
@ 41,1 GET ORCanc_Libera ;
	PICTURE "@*HN ORCanc_Libera - Cancela liberacao ORCAMENTO" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _42s11gjwi()
@ 34,1 GET ORSelParaFat ;
	PICTURE "@*HN ORSelParaFat- Seleciona OSI para faturamento" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _42s11gjwj()
@ 32,1 GET ORSelPFatDireto ;
	PICTURE "@*HN ORSelPFatDireto- Seleciona OSI para fat direto sem reserva e osi" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _42s11gjxc()
@ 73,0 GET ORimp_osi ;
	PICTURE "@*HN ORSleOrFinFat - Seleciona Orcamento Financeiros para Faturar" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gjxk()
@ 74,0 GET ORimp_osi ;
	PICTURE "@*HN ORSleOrNFinFat - Seleciona Orcamento NAO Financeiros para Faturar" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _42s11gjxt()
@ 38,1 SAY "*------------------------------------------------------------------*" ;
	SIZE 1,68, 0
@ 71,0 GET ORCancPdLiberacaoXML ;
	PICTURE "@*HN ORCancPdLiberacaoXML - Gera XML cancelando solicitando Liberacao de Credito p OSI" ;
	SIZE 1,83,1 ;
	DEFAULT 1 ;
	VALID _42s11gjy4() ;
	DISABLE
@ 72,0 GET ORConsPdLiberacaoXML ;
	PICTURE "@*HN ORConsPdLiberacaoXML - Gera XML p consultar solicitando Liberacao de Credito p OSI" ;
	SIZE 1,84,1 ;
	DEFAULT 1 ;
	VALID _42s11gjy5() ;
	DISABLE
@ 51,1 SAY "********<<<  EM DESENVOLVIMENTO >>>********************" ;
	SIZE 1,55, 0
@ 57,2 GET ORGraXMLPddCredito ;
	PICTURE "@*HN ORGraXMLPddCredito-Gera XML pedido Libera Credito para ORCAMENTO " ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _42s11gjy6()
@ 59,5 GET ORNmFileXMLPddCr ;
	PICTURE "@*HN ORNmFileXMLPddCr-Define Path+File do XML Pedido Credito" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _42s11gjyv()
@ 61,7 GET ORIniPddCrdtXML ;
	PICTURE "@*HN ORIniPddCrdtXML-Monta Cabecalho XML com base no modelo-xmlPDDCR" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _42s11gjz1()
@ 63,7 GET ORFinPddCrdtXML ;
	PICTURE "@*HN ORFinPddCrdtXML-Monta Fechamento XML do pdd Lib Cred modelo-xmlPddCr" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _42s11gjz7()
@ 62,11 GET ORGrvXMLPddCrdt ;
	PICTURE "@*HN ORGrvXMLPddCrdt-Grv XML Pedido Credito em XML" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _42s11gjzd()
@ 58,5 GET ORMdlPddCrdtRefXML ;
	PICTURE "@*HN ORMdlPddCrdtRefXML-MODELO P/MONTAR REF XML Solicitacao Credito XMLPDDCR" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _42s11gjze()
@ 60,5 GET ORNmPddCrdtLngFileXMLCREDT ;
	PICTURE "@*HN ORNmPddCrdtLngFileXMLCREDT-Define Path+File do XML Ped. Credito " ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _42s11gjzf()
@ 70,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 52,0 SAY "-------<<<< XML PEDIDO LIBERACAO CREDITO >>>>> ------------------------------" ;
	SIZE 1,77, 0
@ 53,0 GET ORXMLRegPede_p_Liberar ;
	PICTURE "@*HN ORXMLRegPede_p_Liberar -  - XML REGISTRA pedido Liberacao" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _42s11gjzg()
@ 54,0 GET ORXMLCanPede_p_Liberar ;
	PICTURE "@*HN ORXMLCanPede_p_Liberar - XML CANCELA pedido Liberacao" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _42s11gk0c()
@ 56,0 GET ORXMLCnstPede_p_Liberar ;
	PICTURE "@*HN ORXMLCnstPede_p_Liberar - XML CONSULTA pedido Liberacao" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _42s11gk0i()
@ 55,0 GET ORXMLFatPede_p_Liberar ;
	PICTURE "@*HN ORXMLFatPede_p_Liberar - XML FATURA pedido Liberacao" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gk0o()
@ 66,0 GET ORRtrnoCnstXMLPddCr ;
	PICTURE "@*HN ORRtrnoCnstXMLPddCr-Busca retorno XML PddCr ref OSI informada" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _42s11gk0v()
@ 68,5 GET OREsperaRspPddCR ;
	PICTURE "@*HN OREsperaRspPddCR - Executa ORBuscaRspPddCR Enquanto nao houver resposta" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _42s11gk11()
@ 69,8 GET ORBuscaRspPddCR ;
	PICTURE "@*HN ORBuscaRspPddCR-Busca Arq e L┬ conteudo Resposta PddCr" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _42s11gk12()
@ 67,2 GET ORRespXMLPddCR ;
	PICTURE "@*HN ORRespXMLPddCR - Le e Def. Tratamento para  resposta Pdd credito" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _42s11gk13()
@ 43,1 GET ORXMLTenta_Liberar ;
	PICTURE "@*HN ORXMLTenta_Liberar - Avalia Orcamento com Dados do Sistema Para Tentar Liberacao" ;
	SIZE 1,82,1 ;
	DEFAULT 1 ;
	VALID _42s11gk14()
@ 44,3 GET ORXMLVer_credito ;
	PICTURE "@*HN ORXMLVer_credito - Faz uma Varredura nas Condicoes de Credito do Cliente" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _42s11gk20()
@ 45,1 GET ORXMLCanc_Libera ;
	PICTURE "@*HN ORXMLCanc_Libera - Cancela liberacao ORCAMENTO" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _42s11gk26()
@ 46,3 GET ORXMLCanc_credito ;
	PICTURE "@*HN ORXMLCanc_credito - Faz uma Varredura nas Condicoes de Credito do Cliente" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _42s11gk2f()




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              ORCAMENT/MS-DOS Screen Layout              ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 2
@ 32,0 SAY "*---------- ROTINAS BASEADAS NO CONCEITO DE CLASSES ------------------*" ;
	SIZE 1,71, 0
@ 33,1 GET ORExiste ;
	PICTURE "@*HN ORExiste - Retorna .T. se existir ou .F. se nao existir o Numero Orcamento" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _42s11gk2m() ;
	DISABLE
@ 36,1 GET ORGetValor ;
	PICTURE "@*HN ORGetValor - Valor total do Orcamento" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _42s11gk2n()
@ 35,1 GET ORGetDt_Fat ;
	PICTURE "@*HN ORGetDt_Fat - Data Faturamento" ;
	SIZE 1,32,1 ;
	DEFAULT 1 ;
	VALID _42s11gk2o()
@ 28,1 GET ORView ;
	PICTURE "@*HN ORView - Visualisa Orcamentos" ;
	SIZE 1,31,1 ;
	DEFAULT 1 ;
	VALID _42s11gk2p()
@ 6,4 GET ORVerifyInst ;
	PICTURE "@*HN ORVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _42s11gk2q()
@ 7,7 GET ORCreate ;
	PICTURE "@*HN ORCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _42s11gk3g()
@ 16,7 GET ORDestroi ;
	PICTURE "@*HN ORDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _42s11gk3n()
@ 8,9 GET ORReadProp ;
	PICTURE "@*HN ORReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _42s11gk3u()
@ 9,9 GET ORSetDerivadas ;
	PICTURE "@*HN ORSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _42s11gk40()
@ 12,9 GET ORSetPropVT ;
	PICTURE "@*HN ORSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _42s11gk46()
@ 13,9 GET ORGetPropVT ;
	PICTURE "@*HN ORGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _42s11gk47()
@ 3,1 GET ORChk_Identidade ;
	PICTURE "@*HN ORChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _42s11gk48()
@ 2,1 GET ORFind ;
	PICTURE "@*HN ORFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gk49()
@ 19,1 GET ORGetFieldValue ;
	PICTURE "@*HN ORGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gk4a()
@ 18,1 GET OR_Refresh ;
	PICTURE "@*HN OR_Refresh - Forca Atualiza┤ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _42s11gk50()
@ 15,9 GET ORWriteProp ;
	PICTURE "@*HN ORWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _42s11gk56()
@ 20,1 GET ORGetAlias ;
	PICTURE "@*HN ORGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gk5b()
@ 10,9 GET ORSetConfig ;
	PICTURE "@*HN ORSetConfig - Carga Propriedades de Configuracao/Parametros" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _42s11gk5h()
@ 4,4 GET ORTrtChv ;
	PICTURE "@*HN ORTrtChv- Trata Acesso " ;
	SIZE 1,25,1 ;
	DEFAULT 1 ;
	VALID _42s11gk5n()
@ 17,1 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 21,1 GET ORScatter ;
	PICTURE "@*HN ORScatter - Carrega Var de Memoria" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	VALID _42s11gk5o()
@ 0,0 SAY "CLAS:V-1.0 => IMPLEMENTA NAVEGACAO E MANUTENCAO COMPLETA (BASE=CLIENTES)" ;
	SIZE 1,72, 0
@ 1,0 SAY "*---------------------------------------------------------------------*" ;
	SIZE 1,71, 0
@ 23,1 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 25,1 GET ORLerRegistro ;
	PICTURE "@*HN ORLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _42s11gk5p()
@ 26,1 GET ORSalvarRegistro ;
	PICTURE "@*HN ORSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _42s11gk5q()
@ 24,1 GET ORExiste ;
	PICTURE "@*HN ORExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gk5r()
@ 27,1 GET ORBtnVal ;
	PICTURE "@*HN ORBtnVal - Trata Comandos de navegacao" ;
	SIZE 1,40,1 ;
	DEFAULT 1 ;
	VALID _42s11gk6j()
@ 29,1 GET ORView ;
	PICTURE "@*HN IMPLEMENTAR - ORView - Visualisa BROWSE" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _42s11gk6q() ;
	DISABLE
@ 30,3 GET ORLOCATE ;
	PICTURE "@*HN IMPLEMENTAR - ORLOCATE - Apoio a CLView - Visualisa BROWSE" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _42s11gk6v() ;
	DISABLE
@ 38,0 SAY "*---------------------------------------------------------------------*" ;
	SIZE 1,71, 0
@ 42,5 GET ORGeraBTS ;
	PICTURE "@*HN ORGeraBTS - Gera um registro BTS para a OSI" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _42s11gk71()
@ 39,1 GET ORGerBTS1 ;
	PICTURE "@*HN ORGerBTS1 - Converte uma OSI em REGISTRO BTS Por Empresa/Periodo" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _42s11gk7b()
@ 43,5 GET ORGeraProdBTS ;
	PICTURE "@*HN ORGeraProdBTS - Gera um registro BTS para a OSI" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _42s11gk7c()
@ 44,5 GET ORGeraSrvcBTS ;
	PICTURE "@*HN ORGeraSrvcBTS - Gera um registro BTS para a OSI" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _42s11gk7d()
@ 40,1 GET ORGerBTS2 ;
	PICTURE "@*HN ORGerBTS2 - Converte uma OSI em REGISTRO BTS Por OSI" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gk82()
@ 47,1 GET OREditaBTS ;
	PICTURE "@*HN OREditaBTS - Chamada independente para editar BTS" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _42s11gk8d()




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨               PRECO/MS-DOS Screen Layout                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 3
@ 1,0 GET PRVlrSaida ;
	PICTURE "@*HN PRVlrSaida - Obert Valor para Operacao de saida" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _42s11gk8k()
@ 2,3 GET PRVlrTransf ;
	PICTURE "@*HN PRVlrTransf   - Obter Valor para Transferencias" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _42s11gk8l()
@ 8,4 GET PRVlrVenda ;
	PICTURE "@*HN PRVlrVenda -Preco Vendas Para OSI Informada" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _42s11gk8m()
@ 11,4 GET PRClas_Cms ;
	PICTURE "@*HN PRClas_Cms - Obter a Classificao de Grupo de Comissao para Produto" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _42s11gk8n()
@ 12,0 GET PRCusto ;
	PICTURE "@*HN PRCusto - Obter Custo do Produto" ;
	SIZE 1,34,1 ;
	DEFAULT 1 ;
	VALID _42s11gk9l()
@ 13,0 GET PRtabvigor ;
	PICTURE "@*HN PRtabvigor" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _42s11gk9t()
@ 14,0 GET PRdesconto ;
	PICTURE "@*HN PRdesconto" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _42s11gka0()
@ 15,0 GET PRbrow_tab ;
	PICTURE "@*HN PRbrow_tab" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _42s11gka8()
@ 16,0 GET PRpromocao ;
	PICTURE "@*HN PRpromocao" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _42s11gka9()
@ 9,7 GET PRVlrTabVgr ;
	PICTURE "@*HN PRVlrTabVgr -Preco em Vigor na Dt Informada" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _42s11gkaa()
@ 3,5 GET PRVlrTransf ;
	PICTURE "@*HN trf_dep010912 - aux de PRVlrTransf - para Orcamentos apos 01-09-2012" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _42s11gkab()
@ 4,5 GET PRVlrTransf ;
	PICTURE "@*HN trf_dep010503 - aux de PRVlrTransf - para Orcamentos apos 01-05-2003" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _42s11gkb3()
@ 5,5 GET PRVlrTransf ;
	PICTURE "@*HN trf_ate010503 - aux de PRVlrTransf - para Orcamentos antes de 01-05-2003" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _42s11gkba()




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              TRIBUTAR/MS-DOS Screen Layout              ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 4
@ 36,0 SAY "ROTINAS AINDA VINCULADAS AO ORCAMENTO (AINDA DEPEDEM DO NRO ORCAMENTO)" ;
	SIZE 1,70, 0
@ 3,0 SAY "ROTINAS GERAIS - COM PARAMETROS MAIS INDEPENDENTES E ESPECIFICOS" ;
	SIZE 1,64, 0
@ 12,3 GET TRGet_IPIProd ;
	PICTURE "@*HN TRGet_IPIProd - Obtem a Aliquota de IPI do Produto" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _42s11gkbi()
@ 13,3 GET TRGet_ISSAlq ;
	PICTURE "@*HN TRGet_ISSAlq - Obtem Aliquota de ISS" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _42s11gkbn()
@ 15,6 GET TRdefcst ;
	PICTURE "@*HN TRdefcst - Define CST para Item do Orcamento" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _42s11gkbt()
@ 28,3 GET TRAlqIcmInUF ;
	PICTURE "@*HN TRAlqIcmInUF - Obetem Aliquota Interna de ICMS na UF informada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _42s11gkbu()
@ 29,3 GET TRAlqIcmOuUF ;
	PICTURE "@*HN TRAlqIcmOuUF - Obetem Aliquota Externa de ICMS na UF informada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _42s11gkbv()
@ 25,3 GET TRCFO ;
	PICTURE "@*HN TRCFO  - Obtem CFO Pela OPERACAO E TIPO MERCADORIA" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _42s11gkbw()
@ 37,0 GET ANTTRpct_trib ;
	PICTURE "@*HN ANTTRpct_trib - SUBSTITUIDA EM 10/06/2009" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _42s11gkcl() ;
	DISABLE
@ 41,6 GET TRGet_IPIAlq ;
	PICTURE "@*HN 02-TRGet_IPIAlq - Obtem a Aliquota de IPI do produto para o orcamento" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _42s11gkcz()
@ 42,6 GET TRGet_cst ;
	PICTURE "@*HN 03-TRGet_cst - Obtem CST para o produto no orcamento" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gkd7()
@ 30,3 GET TRDef_tpMercad ;
	PICTURE "@*HN TRDef_tpMercad- DESVIO COMPATIBILIZA COM TRDef_RgTrbMercad (DESCARTAR FUTURO)" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _42s11gkd8()
@ 43,6 GET TRGet_rduIcms ;
	PICTURE "@*HN 06-TRGet_rduIcms - Obtem Aliquota de Reducao do ICMS" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gkd9()
@ 44,6 GET TRGet_IcmsAlq ;
	PICTURE "@*HN 07-TRGet_IcmsAlq - Obtem Aliquota de ICMS para Orcamento" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _42s11gkda()
@ 45,6 GET TRGet_CFO ;
	PICTURE "@*HN 08-TRGet_CFO  - Obtem CFO" ;
	SIZE 1,27,1 ;
	DEFAULT 1 ;
	VALID _42s11gke3()
@ 39,2 GET TRcalc_tribu ;
	PICTURE "@*HN TRcalc_tribu- Calcula Valores Tributarios Fiscais" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _42s11gkeb()
@ 49,3 GET CSTENT ;
	PICTURE "@*HN ?? - Define CST NF Entrada" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _42s11gkeu()
@ 50,4 GET TRRtdoSaida ;
	PICTURE "@*HN 15-TRRtdoSaida - Ret.Vlr.ICM Retido na Saida" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _42s11gkev()
@ 51,4 GET TRRtdoEntrada ;
	PICTURE "@*HN 16-TRRtdoEntrada - Ret.Vlr.ICM Retido na Entrada" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _42s11gkew()
@ 52,4 GET TRicmNormal ;
	PICTURE "@*HN 17-TRicmNormal - Ret.Vlr.ICM Normal" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _42s11gkex()
@ 53,4 GET TREnbsicmNormal ;
	PICTURE "@*HN 18-TREnbsicmNormal - Ret.Base ICMS Norma Entrada" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _42s11gkfo()
@ 54,4 GET TREbsRtdoCIVA ;
	PICTURE "@*HN 19-TREbsRtdoCIVA - Ret.Base ICMS Retido Entrada (Com IVA)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _42s11gkfu()
@ 55,4 GET TREbsRtdoSIVA ;
	PICTURE "@*HN 20-TREbsRtdoSIVA - Ret.Base ICMS Retido Entrada (Sem IVA)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _42s11gkg2()
@ 1,6 GET TRgrupoALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,17 GET TRgrfiscalALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,28 GET TRtab_IvaALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,39 GET TRtipooperALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 40,4 GET TRcalc_Difer ;
	PICTURE "@*HN 11-TRcalc_Difer- Ajusta Diferanca geradas nos tributo percentuais" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _42s11gkga()
@ 46,0 SAY "ROTINAS PARA NOVA PLANILHA TRIBUTARIA (OPERCMRC e CLASFISC)" ;
	SIZE 1,59, 0
@ 47,4 GET TRVincTipo ;
	PICTURE "@*HN 16-TRVincTipo - Vincula TIPOOPER a OPERCMRC e A CLASFISC" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _42s11gkgg()
@ 4,3 GET TRGet_IVA ;
	PICTURE "@*HN TRGet_IVA - Obtem o IVA Ajustada proprio do produto (Pecas)" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _42s11gkgh()
@ 48,1 SAY "ROTINAS PARA ENTRADA JA USADAS EM SCGC245 (CONTAB NOTAS ENTRADA)" ;
	SIZE 1,64, 0
@ 26,3 GET TRCFOPServico ;
	PICTURE "@*HN TRCFOPServico - Define CFOP para Servico" ;
	SIZE 1,42,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _42s11gkh4()
@ 20,3 GET TRCST_IPI ;
	PICTURE "@*HN TRCST_IPI - Codigo de Situacao Tributaria para IPI" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _42s11gkhb()
@ 21,3 GET TRCST_ISS ;
	PICTURE "@*HN TRCST_ISS - Codigo Sit Tributaria ISS" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _42s11gkhh()
@ 35,3 GET TRGenero ;
	PICTURE "@*HN TRGenero - Define Genero do Produto" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _42s11gkhn()
@ 18,3 GET antTRCST_Entrada ;
	PICTURE "@*HN antTRCST_Entrada- Antes do oliveira criar tabela 3 cst < 31/12/2011" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _42s11gkht() ;
	DISABLE
@ 14,3 GET TRcst_Icms ;
	PICTURE "@*HN TRcst_Icms - Define CST completo com 3 digitos" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _42s11gkhu()
@ 22,3 GET TRCST_PIS ;
	PICTURE "@*HN TRCST_PIS - Desenvolver" ;
	SIZE 1,25,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _42s11gkhv() ;
	DISABLE
@ 23,3 GET TRCST_COFINS ;
	PICTURE "@*HN TRCST_COFINS - Desenvolver" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _42s11gkhw() ;
	DISABLE
@ 24,3 GET TRCST_IR ;
	PICTURE "@*HN TRCST_IR - Desenvolver" ;
	SIZE 1,24,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _42s11gkhx() ;
	DISABLE
@ 0,0 SAY "ALIASES" ;
	SIZE 1,7, 0
@ 31,5 GET TRDef_RgTrbMercad ;
	PICTURE "@*HN TRDef_RgTrbMercad - Retorna o Regime Tributario da Merc. na UF" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _42s11gkip()
@ 38,0 GET TRpct_trib ;
	PICTURE "@*HN TRpct_trib - (01 a 09) em Pacote de Tributos - Acelera processo" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _42s11gkix()
@ 32,5 GET TRCnvrt_RgTrbMercad ;
	PICTURE "@*HN TRCnvrt_RgTrbMercad - Converte Codigo Reg Trib em String" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _42s11gkja()
@ 17,3 GET TRcst_Entrada ;
	PICTURE "@*HN TRcst_Entrada - Define CST para Item do Orcamento" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _42s11gkjh()
@ 6,5 GET TR_InternaIVAAjustada ;
	PICTURE "@*HN TR_InternaIVAAjustada - AUX. IVA IVA interna (PECAS) TERMO DE ACORDO TO/DF/GO" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _42s11gkji()
@ 7,5 GET TR_ICM49IVAjustada ;
	PICTURE "@*HN TR_ICM49IVAjustada - AUX. (PECAS) -PROT.ICMS 49-8/5/2008 IVA AJUSTAS DF/MT" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _42s11gkjj()
@ 9,5 GET TR_ICM62IVAjustada ;
	PICTURE "@*HN TR_ICM62IVAjustada - AUX. (PECAS) -PROT.ICMS 62-22/6/2012 IVA AJUSTAS" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _42s11gkk7()
@ 8,5 GET TR_ICM92IVAjustada ;
	PICTURE "@*HN TR_ICM92IVAjustada - AUX.(PNEUM)-CONV.ICMS 92-30/9/2011 IVA AJUSTAS" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _42s11gkkf()




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              ESTOQUE/MS-DOS Screen Layout               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 5
@ 10,0 SAY "----------------------   REDEFICAO DE REGRAS   ----------------------------" ;
	SIZE 1,75, 0
@ 19,1 SAY "-------------------------   CONSULTAS   ----------------------------------" ;
	SIZE 1,74, 0
@ 1,3 GET ESPsq_Produtos ;
	PICTURE "@*HN ESPsq_Produtos - Abre Pesquisa de Produto Order Tabela Ret. CODIGO" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _42s11gkko()
@ 7,0 GET ESAbresaldo ;
	PICTURE "@*HN ESAbresaldo-Abre Reg.de Controle de Saldo " ;
	SIZE 1,44,1 ;
	DEFAULT 1 ;
	VALID _42s11gkku()
@ 8,0 GET ESversaldo ;
	PICTURE "@*HN ESversaldo -Verificar se Existe Saldo Para Atender/Abre Controle " ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _42s11gkkv()
@ 9,0 GET ESsaldo ;
	PICTURE "@*HN obs * ESsaldo    -Informa Saldo Momento Informado Considara DATA e HORA" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _42s11gkkw()
@ 12,0 GET EScustoMedio ;
	PICTURE "@*HN EScustoMedio - Custo M┌dio do Produto na Empresa X e na Data X" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _42s11gklt()
@ 13,0 GET EScustoEstq ;
	PICTURE "@*HN obs * EScustoEstq - Custo do Estoque Produto na Empresa X e na Data X" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _42s11gkm5()
@ 15,0 GET EScustoAgregado ;
	PICTURE "@*HN EScustoAgregado -Custo M┌dio Agregado de Tributacao , etc" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _42s11gkmf()
@ 16,3 GET ESAgregarTrbt ;
	PICTURE "@*HN ESAgregarTrbt -Agrega Tributos ao Valor Passado Como Custo" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _42s11gkmg()
@ 17,0 GET ESprc_compra ;
	PICTURE "@*HN ESprc_compra" ;
	SIZE 1,14,1 ;
	DEFAULT 1 ;
	VALID _42s11gkmh()
@ 20,0 GET EScrtcestq ;
	PICTURE "@*HN antEScrtcestq  - SQL sobre pedido p/ critica de estocagem" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _42s11gkmi()
@ 21,0 GET EScrtcestq ;
	PICTURE "@*HN EScrtcestq  - SQL sobre pedido p/ critica de estocagem" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _42s11gknb()
@ 22,0 GET ESextrato ;
	PICTURE "@*HN ESextrato - Extrato de Movimentacao de Estoque" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _42s11gkni()
@ 23,7 GET ESimpext ;
	PICTURE "@*HN ESimpext - Sub rotina para Impressao Extrato " ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _42s11gkns()
@ 24,0 GET ESextRess ;
	PICTURE "@*HN ESextRess - Extrato de Ressarcimento" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _42s11gkny()
@ 25,7 GET ESOrigDest ;
	PICTURE "@*HN ESOrigDest - Funcao de Apoio aos Extratos" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _42s11gknz()
@ 26,0 GET ESextEntradas ;
	PICTURE "@*HN ESextEntradas - Extrato de Movimentacao de Entrada" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _42s11gko0()
@ 27,0 GET ESextTrasf ;
	PICTURE "@*HN ESextTrasf - Extrato de Movimentacao de Entrada por Transferencia" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _42s11gkoo()
@ 2,3 GET ESVld_Produto ;
	PICTURE "@*HN ESVld_Produto - Verifica Validade do Produto Informado" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _42s11gkoz()
@ 3,3 GET ESGet_Origem ;
	PICTURE "@*HN ESGet_Origem - Origem Importado ou Nacional" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _42s11gkp5()




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              MOVIMENT/MS-DOS Screen Layout              ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 6
@ 3,0 GET MVAtu_Cmd ;
	PICTURE "@*HN MVAtu_Cmd  - Atualiza de Saldos Fisicos e Financeiros com Base em ITEMMOV" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _42s11gkpc()
@ 4,0 GET MVCancelMvto ;
	PICTURE "@*HN MVCancelMvto - Clancela Item do Movimento" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _42s11gkpm()
@ 6,5 GET MVBlqSaldo ;
	PICTURE "@*HN MVBlqSaldo - Bloquear Reg. Saldo  com Base em ITEMMOV" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _42s11gkpn()
@ 7,5 GET MVDesBlqSaldo ;
	PICTURE "@*HN MVDesBlqSaldo - Desbloqueia Bloquear Reg. Saldo  com Base em ITEMMOV" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _42s11gkpo()
@ 10,3 GET MVObterSaldos ;
	PICTURE "@*HN MVObterSaldos - Obter Saldos Base para Processar Movimento" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _42s11gkq9()
@ 11,8 GET MVIniRegSaldos ;
	PICTURE "@*HN MVIniRegSaldos - Inicializa Registro de Saldos" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _42s11gkqj()
@ 13,3 GET MVprocessaMvto ;
	PICTURE "@*HN MVprocessaMvto - Processa o Movimento Com Base no Registro Informado" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _42s11gkqq()
@ 14,6 GET MVSincrItmAnexo ;
	PICTURE "@*HN MVSincrItmAnexo  - Sincronizar Saldos de ItmAnexo Com Itemmov" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _42s11gkr3()
@ 15,6 GET MVAtlzSaldos ;
	PICTURE "@*HN MVAtlzSaldos - Atualiza Saldos a Partir da Data do Movimento" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gkr4()
@ 16,8 GET MVAtlzComplSaldos ;
	PICTURE "@*HN MVAtlzComplSaldos - Complementa Atualizacao de Saldos " ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _42s11gkr5()
@ 18,6 GET MVGetCustMedio ;
	PICTURE "@*HN MVGetCustMedio - Obter o Custo Medio Para Operacao em Andamento" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _42s11gkr6()
@ 19,6 GET MVGetIndRedutor ;
	PICTURE "@*HN MVGetIndRedutor - Obter o Indice de Reducao Oper(/OU*) 1.26 ou 1.24" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _42s11gkru()
@ 20,8 GET MVSetSldEntradas ;
	PICTURE "@*HN MVSetSldEntradas - Opera Var(Ambientais) P/ Movim de Entr" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _42s11gks2()
@ 21,8 GET MVSetSldSaidas ;
	PICTURE "@*HN MVSetSldSaidas - Opera Var(Ambientais) P/ Movim de Saidas" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _42s11gksc()
@ 22,8 GET MVSetSaldos ;
	PICTURE "@*HN MVSetSaldos - Atualiza <Saldo Atual> e <Vlr Atual> => NO CUSTO MEDIO" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _42s11gksj()
@ 23,6 GET MVSldFuturo ;
	PICTURE "@*HN MVSldFuturo - Ajusta Registros de Saldo alem da Data Movimento" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _42s11gksk()




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              FORNECED/MS-DOS Screen Layout              ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 7
@ 23,4 GET FRGet_UF ;
	PICTURE "@*HN 01-FRGet_UF - Obter UF do Fornecedor" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _42s11gksl()
@ 24,4 GET FRrgm_Fisc ;
	PICTURE "@*HN 01-FRrgm_Fisc - Obter o Regime Fiscal (Normal ou Simples)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _42s11gksm()
@ 3,9 GET FRVerifyInst ;
	PICTURE "@*HN FRVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _42s11gkte()
@ 4,12 GET FRCreate ;
	PICTURE "@*HN FRCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _42s11gktk()
@ 12,12 GET FRDestroi ;
	PICTURE "@*HN FRDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _42s11gkts()
@ 6,15 GET FRReadProp ;
	PICTURE "@*HN FRReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _42s11gkty()
@ 9,17 GET FRSetDerivadas ;
	PICTURE "@*HN FRSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _42s11gku4()
@ 7,17 GET FRSetPropVT ;
	PICTURE "@*HN FRSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _42s11gku5()
@ 8,17 GET FRGetPropVT ;
	PICTURE "@*HN FRGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _42s11gku6()
@ 2,4 GET FRChk_Identidade ;
	PICTURE "@*HN FRChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _42s11gku7()
@ 1,4 GET FRFind ;
	PICTURE "@*HN FRFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gku8()
@ 14,4 GET FRGetFieldValue ;
	PICTURE "@*HN FRGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gkuy()
@ 13,4 GET FR_Refresh ;
	PICTURE "@*HN FR_Refresh - Forca Atualiza┤ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _42s11gkv4()
@ 16,4 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 18,4 GET FRLerRegistro ;
	PICTURE "@*HN FRLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _42s11gkv9()
@ 10,15 GET FRWriteProp ;
	PICTURE "@*HN FRWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _42s11gkvf()
@ 19,4 GET FRSalvarRegistro ;
	PICTURE "@*HN FRSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _42s11gkvl()
@ 17,4 GET FRExiste ;
	PICTURE "@*HN FRExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gkvm()
@ 20,4 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 15,4 GET FRGetAlias ;
	PICTURE "@*HN FRGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gkvn()
@ 26,4 GET FRGet_Nome ;
	PICTURE "@*HN 01-FRGet_Nome - Obter Nome do Fornecedor" ;
	SIZE 1,42,1 ;
	DEFAULT 1 ;
	VALID _42s11gkvo()
@ 27,4 GET FRGet_Inscr ;
	PICTURE "@*HN 01-FRGet_Inscr - Obter Nome do Fornecedor" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _42s11gkvp()




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              NOTAENT/MS-DOS Screen Layout               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 8
@ 23,2 GET NEGetFieldValue ;
	PICTURE "@*HN NEGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gkwf()
@ 25,2 GET NEGetUFOrigem ;
	PICTURE "@*HN NEGetUFOrigem - Retorna UFs (Origem da NFE)" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _42s11gkwk()
@ 26,2 GET NEGetUFDestino ;
	PICTURE "@*HN NEGetUFDestino - Retorna UFs (Destino da NFE)" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _42s11gkwp()
@ 27,2 GET NEGetRetidoDestacado ;
	PICTURE "@*HN NEGetRetidoDestacado - Retido Destacado na NFE" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _42s11gkwv()
@ 4,7 GET NEVerifyInst ;
	PICTURE "@*HN NEVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _42s11gkx0()
@ 5,10 GET NECreate ;
	PICTURE "@*HN NECreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _42s11gkx7()
@ 13,10 GET NEDestroi ;
	PICTURE "@*HN NEDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _42s11gkx8()
@ 7,13 GET NEReadProp ;
	PICTURE "@*HN NEReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _42s11gkx9()
@ 10,15 GET NESetDerivadas ;
	PICTURE "@*HN NESetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _42s11gkxa()
@ 8,15 GET NESetPropVT ;
	PICTURE "@*HN NESetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _42s11gkxw()
@ 9,15 GET NEGetPropVT ;
	PICTURE "@*HN NEGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _42s11gky3()
@ 3,2 GET NEChk_Identidade ;
	PICTURE "@*HN NEChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _42s11gkya()
@ 2,2 GET NEFind ;
	PICTURE "@*HN NEFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gkyg()
@ 15,2 GET NEGetFieldValue ;
	PICTURE "@*HN NEGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gkym()
@ 14,2 GET NE_Refresh ;
	PICTURE "@*HN NE_Refresh - Forca Atualiza┤ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _42s11gkys()
@ 17,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 19,2 GET NELerRegistro ;
	PICTURE "@*HN NELerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _42s11gkyt()
@ 11,13 GET NEWriteProp ;
	PICTURE "@*HN NEWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _42s11gkyu()
@ 20,2 GET NESalvarRegistro ;
	PICTURE "@*HN NESalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _42s11gkyv()
@ 18,2 GET NEExiste ;
	PICTURE "@*HN NEExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gkzf()
@ 21,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 16,2 GET NEGetAlias ;
	PICTURE "@*HN NEGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gkzm()
@ 1,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 29,2 GET NEVerPendencias ;
	PICTURE "@*HN NEVerPendencias - Ver se exitem NFent c status (c) Pendente envio XML" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _42s11gkzr()




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              EMPRESA/MS-DOS Screen Layout               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 9
@ 21,2 GET EMGet_UF ;
	PICTURE "@*HN EMGet_UF - Obter UF da Loja" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _42s11gkzy()
@ 23,2 GET EMGet_Juro ;
	PICTURE "@*HN EMGet_Juro - Obter Juro Mes da Loja" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _42s11gl03()
@ 29,2 GET verif ;
	PICTURE "@*HN Verificar Codigo de Empresa" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _42s11gl09()
@ 30,2 GET EMrodanroNF ;
	PICTURE "@*HN EMrodanroNF - Roda Numeracao de Nota " ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _42s11gl0a()
@ 24,2 GET EMGet_Mora ;
	PICTURE "@*HN EMGet_Mora - Obter Mora diaria" ;
	SIZE 1,32,1 ;
	DEFAULT 1 ;
	VALID _42s11gl0b()
@ 25,2 GET EMGet_Sigla ;
	PICTURE "@*HN EMGet_Sigla - Obter Sigla da empresa" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _42s11gl0c()
@ 26,2 GET EMGet_ECFSerie ;
	PICTURE "@*HN EMGet_ECFSerie - Obter Nro Serie Ecf" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _42s11gl0z()
@ 22,2 GET EMGet_Municipio ;
	PICTURE "@*HN EMGet_Municipio - Obter UF da Loja" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	VALID _42s11gl14()
@ 28,2 GET EMGet_TabCst ;
	PICTURE "@*HN EMGet_TabCst - Obter Tab_CST" ;
	SIZE 1,30,1 ;
	DEFAULT 1 ;
	VALID _42s11gl1a()
@ 17,2 GET EMLerRegistro ;
	PICTURE "@*HN EMLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _42s11gl1f()
@ 18,2 GET EMSalvarRegistro ;
	PICTURE "@*HN EMSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _42s11gl1l()
@ 16,2 GET EMExiste ;
	PICTURE "@*HN EMExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gl1r()
@ 2,7 GET EMVerifyInst ;
	PICTURE "@*HN EMVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _42s11gl1s()
@ 3,10 GET EMCreate ;
	PICTURE "@*HN EMCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _42s11gl1t()
@ 11,10 GET EMDestroi ;
	PICTURE "@*HN EMDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _42s11gl1u()
@ 5,13 GET EMReadProp ;
	PICTURE "@*HN EMReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _42s11gl2h()
@ 8,15 GET EMSetDerivadas ;
	PICTURE "@*HN EMSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _42s11gl2n()
@ 6,15 GET EMSetPropVT ;
	PICTURE "@*HN EMSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _42s11gl2s()
@ 7,15 GET EMGetPropVT ;
	PICTURE "@*HN EMGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _42s11gl2y()
@ 1,2 GET EMChk_Identidade ;
	PICTURE "@*HN EMChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _42s11gl34()
@ 0,2 GET EMFind ;
	PICTURE "@*HN EMFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gl3a()
@ 13,2 GET EMGetFieldValue ;
	PICTURE "@*HN EMGetFieldValue -Rtrn vlr Campo p/ reg.existente-(erro se chave n existir)" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _42s11gl3b()
@ 12,2 GET EM_Refresh ;
	PICTURE "@*HN EM_Refresh - Forca Atualiza┤ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _42s11gl3c()
@ 15,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 9,13 GET EMWriteProp ;
	PICTURE "@*HN EMWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _42s11gl3d()
@ 19,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 14,2 GET EMGetAlias ;
	PICTURE "@*HN EMGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gl48()
@ 31,1 SAY "*-----------------------------------------------------------*" ;
	SIZE 1,61, 0
@ 32,2 GET EMMarcaFlgNF ;
	PICTURE "@*HN EMMarcaFlgNF - Marca flag de controle etapa faturamento NF" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _42s11gl4e()
@ 27,2 GET EMGet_ECFModelo ;
	PICTURE "@*HN EMGet_ECFModelo - Obter Nro Serie Ecf" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _42s11gl4l()




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              CLIENTES/MS-DOS Screen Layout              ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 10
@ 6,5 GET CLVerifyInst ;
	PICTURE "@*HN CLVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _42s11gl4r()
@ 7,8 GET CLCreate ;
	PICTURE "@*HN CLCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _42s11gl4s()
@ 16,8 GET CLDestroi ;
	PICTURE "@*HN CLDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _42s11gl4t()
@ 8,10 GET CLReadProp ;
	PICTURE "@*HN CLReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _42s11gl4u()
@ 9,10 GET CLSetDerivadas ;
	PICTURE "@*HN CLSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _42s11gl5h()
@ 12,10 GET CLSetPropVT ;
	PICTURE "@*HN CLSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _42s11gl5n()
@ 13,10 GET CLGetPropVT ;
	PICTURE "@*HN CLGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _42s11gl5t()
@ 3,2 GET CLChk_Identidade ;
	PICTURE "@*HN CLChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _42s11gl5z()
@ 2,2 GET CLFind ;
	PICTURE "@*HN CLFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gl65()
@ 19,2 GET CLGetFieldValue ;
	PICTURE "@*HN CLGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11gl6c()
@ 18,2 GET CL_Refresh ;
	PICTURE "@*HN CL_Refresh - Forca Atualiza┤ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _42s11gl6d()
@ 23,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 25,2 GET CLLerRegistro ;
	PICTURE "@*HN CLLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _42s11gl6e()
@ 15,10 GET CLWriteProp ;
	PICTURE "@*HN CLWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _42s11gl6f()
@ 26,2 GET CLSalvarRegistro ;
	PICTURE "@*HN CLSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _42s11gl70()
@ 24,2 GET CLExiste ;
	PICTURE "@*HN CLExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gl76()
@ 30,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 20,2 GET CLGetAlias ;
	PICTURE "@*HN CLGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _42s11gl7d()
@ 10,10 GET CLSetConfig ;
	PICTURE "@*HN CLSetConfig - Carga Propriedades de Configuracao/Parametros" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _42s11gl7i()
@ 27,2 GET CLBtnVal ;
	PICTURE "@*HN CLBtnVal - Trata Comandos de navegacao" ;
	SIZE 1,40,1 ;
	DEFAULT 1 ;
	VALID _42s11gl7p()
@ 4,5 GET CLTrtChvCPFCNPJINS ;
	PICTURE "@*HN CLTrtChvCPFCNPJINS - Trata Acesso por Chave por CPF/CNPJ e INSCRICAO" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _42s11gl7v()
@ 31,2 GET CLBuscaNOMEAprox ;
	PICTURE "@*HN CLBuscaNOMEAprox - Busca aproximada por nome" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _42s11gl7w()
@ 17,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 32,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 22,2 GET CLScatter ;
	PICTURE "@*HN CLScatter - Carrega Var de Memoria" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	VALID _42s11gl7x()
@ 28,2 GET CLView ;
	PICTURE "@*HN CLView - Visualisa BROWSE" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _42s11gl7y()
@ 29,4 GET CLLOCATE ;
	PICTURE "@*HN CLLOCATE - Apoio a CLView - Visualisa BROWSE" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _42s11gl8p()
@ 0,1 SAY "CLAS:V-1.0 => IMPLEMENTA NAVEGACAO E MANUTENCAO COMPLETA (BASE=CLIENTES)" ;
	SIZE 1,72, 0
@ 1,1 SAY "*---------------------------------------------------------------------*" ;
	SIZE 1,71, 0
@ 33,2 GET CLAtribuiIBGE ;
	PICTURE "@*HN CLAtribuiIBGE - Atribui Codigo Ibge as clientes Ja Cadastrados" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _42s11gl8v()
@ 21,2 GET CLGSetAreaAlias ;
	PICTURE "@*HN CLGSetAreaAlias - Seleciona area da tabela " ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _42s11gl92()
@ 34,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              CLIEN_R/MS-DOS Screen Layout               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 11
@ 3,2 GET CLGetUFOrigem ;
	PICTURE "@*HN CLGetUFOrigem - Retorna UFs (Origem da NFE)" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _42s11gl98()
@ 5,2 GET CLLocCli ;
	PICTURE "@*HN CLLocCli-Localiza Cliente" ;
	SIZE 1,27,1 ;
	DEFAULT 1 ;
	VALID _42s11gl9d()
@ 9,2 GET CLSetControleCredito ;
	PICTURE "@*HN CLSetControleCredito - Registrar Aleracao Limite de Credito" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _42s11gl9e()
@ 10,2 GET CLObterVlrAlteradoCredito ;
	PICTURE "@*HN CLObterVlrAlteradoCredito - Retorna o Valor (+) ou (-) alterado no Credito" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _42s11gl9f()
@ 11,2 GET CLSetUltAtendimento ;
	PICTURE "@*HN CLSetUltAtendimento - Registra data do ultimo atendimento" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _42s11gla1()
@ 12,2 GET CLSQLSemFidelizacao ;
	PICTURE "@*HN CLSQLSemFidelizacao - SQL Clientes Novos e Fidelizados Semanal" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _42s11gla8()
@ 13,2 GET CLSQLMesFidelizacao ;
	PICTURE "@*HN CLSQLMesFidelizacao - SQL Clientes Novos e Fidelizados Mensal" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _42s11glah()
@ 15,6 GET CLCalc_Cgc ;
	PICTURE "@*HN CLCalc_Cgc    - Teste CGC" ;
	SIZE 1,27,1 ;
	DEFAULT 1 ;
	VALID _42s11glar()
@ 17,2 GET CLInscricao ;
	PICTURE "@*HN CLInscricao" ;
	SIZE 1,13,1 ;
	DEFAULT 1 ;
	VALID _42s11glas()
@ 17,16 GET CLRO_Inscr ;
	PICTURE "@*HN CLRO_Inscr" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _42s11glat()
@ 17,28 GET CLMG_Inscr ;
	PICTURE "@*HN CLMG_Inscr" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _42s11glbr()
@ 17,40 GET CLBA_Inscr ;
	PICTURE "@*HN CLBA_Inscr" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _42s11glc0()
@ 17,52 GET CLPR_Inscr ;
	PICTURE "@*HN CLPR_Inscr" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _42s11glc9()
@ 17,64 GET CLRR_Inscr ;
	PICTURE "@*HN CLRR_Inscr" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _42s11glci()
@ 18,16 GET CLSP_Inscr ;
	PICTURE "@*HN CLSP_Inscr" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _42s11glcj()
@ 18,28 GET CLDF_Inscr ;
	PICTURE "@*HN CLDF_Inscr" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _42s11glck()
@ 18,40 GET CLTO_AntigaInscr ;
	PICTURE "@*HN CLTO_AntigaInscr" ;
	SIZE 1,18,1 ;
	DEFAULT 1 ;
	VALID _42s11gld7()
@ 18,58 GET CLTO_NovaInscr ;
	PICTURE "@*HN CLTO_NovaInscr" ;
	SIZE 1,16,1 ;
	DEFAULT 1 ;
	VALID _42s11glde()
@ 4,2 GET CLItensAdq ;
	PICTURE "@*HN CLItensAdq - Cosulta itens adiquiridos pelo Cliente (Param PLACA)" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _42s11gldl()
@ 6,2 GET CLVldCli ;
	PICTURE "@*HN CLVldCli-Valida  Cliente" ;
	SIZE 1,27,1 ;
	DEFAULT 1 ;
	VALID _42s11glds()
@ 7,2 GET CLimpARCA ;
	PICTURE "@*HN CLimpARCA - Importa registro do ARCA" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _42s11gle0()
@ 14,2 GET CLVld_CPF_CNPJ ;
	PICTURE "@*HN CLVld_CPF_CNPJ - Valida CPF ou CNPJ" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _42s11gle1()
@ 16,2 GET CLDef_TipoPessoa ;
	PICTURE "@*HN CLDef_TipoPessoa - Define se Pessoa Fisica ou Juridica" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _42s11glen()
@ 2,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 23,5 GET CLEsperaRspCad ;
	PICTURE "@*HN CLEsperaRspCad - Executa CLBuscaRspCad Enquanto nao houver resposta" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _42s11glet()
@ 24,8 GET CLBuscaRspCad ;
	PICTURE "@*HN CLBuscaRspCad-Busca Arq e L┬ conteudo Resposta Cad" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _42s11glez()
@ 22,2 GET CLImportaCad ;
	PICTURE "@*HN CLImportaCad - Importa Cadastro ORION" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _42s11glf8()
@ 21,2 SAY "--Importar Dados Orion Cadastro --------" ;
	SIZE 1,40, 0
@ 25,11 GET CLImpCadOrion ;
	PICTURE "@*HN CLImpCadOrion - Exec. import arq EXPCLIEN.TXT p/ CLIENTES.DBF" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _42s11glff()




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              AUTOPROC/MS-DOS Screen Layout              ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 12
@ 4,4 GET APtemp_res ;
	PICTURE "@*HN 03-APtemp_res  - Verifica Tempo Para Processar Liberacao de Reserva" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _42s11glfg()
@ 5,4 GET APtemp_BkpML ;
	PICTURE "@*HN 06-APtemp_BkpML  - Verifica Tempo Para Processar BKP" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _42s11glg4()
@ 3,1 GET APTempGeral ;
	PICTURE "@*HN 00-APTempGeral - Controle geral de porcessoa temporizados" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _42s11glgc()



READ


#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨                PRECO/MS-DOS Cleanup Code                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 3
return


*****
************************************
********************


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨               ESTOQUE/MS-DOS Cleanup Code               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 5

RETURN








********************************------------***************************
* ROTINAS COPIADAS DA BIBLIOTECA ROTESTOQ
*----------------------------------------------------------------------*
*****************************************************************

********************************************************************
*	UEvendas => Rotina para Verificacao das vendas de um produto
*				solicitado em um periodo
*
*	CHAMADO por SCGC800 : Verificacao de Previsao X Venda Real
*				OBJ_ROL1: Apuracao de Venda real no Periodo
*
********************************************************************

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              CLIENTES/MS-DOS Cleanup Code               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 10

RETURN








********************************------------***************************
* ROTINAS COPIADAS DA BIBLIOTECA ROTESTOQ
*----------------------------------------------------------------------*
*****************************************************************

********************************************************************
*	UEvendas => Rotina para Verificacao das vendas de um produto
*				solicitado em um periodo
*
*	CHAMADO por SCGC800 : Verificacao de Previsao X Venda Real
*				OBJ_ROL1: Apuracao de Venda real no Periodo
*
********************************************************************

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨               CLIEN_R/MS-DOS Cleanup Code               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 11

RETURN








********************************------------***************************
* ROTINAS COPIADAS DA BIBLIOTECA ROTESTOQ
*----------------------------------------------------------------------*
*****************************************************************

********************************************************************
*	UEvendas => Rotina para Verificacao das vendas de um produto
*				solicitado em um periodo
*
*	CHAMADO por SCGC800 : Verificacao de Previsao X Venda Real
*				OBJ_ROL1: Apuracao de Venda real no Periodo
*
********************************************************************

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              AUTOPROC/MS-DOS Cleanup Code               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 12
return


*****
************************************
********************



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨   ESTOQUE/MS-DOS Supporting Procedures and Functions    ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 5
FUNCTION UEvendas
	PARAMETERS LNempresa,LSclas,LScodigo,LDdtini,LDdtfim,LNemdias,;
				LNqtvenda,LNqtentra,LNvlrvenda
	
	=W_DEFPROC("rotinas.SPR")
	*********************************************************************
	PRIVATE ALL
	LSalias 	= ALIAS()

	LNqtvenda   = 0
	LNqtentra	= 0
	LNvlrvenda  = 0

	LNacmqtvenda   	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO
	LNacmqtentra	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO
	LNacmvlrvenda  	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO

	*********************>>> REGISTRO DE SAIDAS <<<*********************
	*
	*   O saldo formado no so e considerado ate a 2/3 do
	* do periodo devido a pouca influencia nas vendas do periodo
	* das entradas do 1/3 restante
	*
	********************************************************************
	LDdtfimsld = LDdtini 		 		&& data para referenciar saldo apuradao
	LNdiassld  = INT(LNemdias / 3)* 2  && para apurar o saldo formado
							 			&& ate metade do periodo
	LNctrdias = 0
	DO WHILE LNctrdias <= LNdiassld
		IF DOW(LDdtfimsld) <> 1
			LNctrdias = LNctrdias +1
		ENDIF
		LDdtfimsld = LDdtfimsld + 1
	ENDDO
	*******************************************************************
	DO UEvervendas WITH LDdtini,LDdtfim, LNempresa, LScodigo,;
			LDdtfimsld,LNqtvenda,LNqtentra,LNvlrvenda

	LNacmqtvenda   	= LNqtvenda
	LNacmqtentra	= LNqtentra
	LNacmvlrvenda  	= LNvlrvenda

	*******************************************************************
	SELE grupoanx
	SET ORDER TO TAG classifica
	SEEK LSclas
	IF FOUND()
		*******************************************************************
		DO UEvervendas WITH LDdtini,LDdtfim, LNempresa,;
				grupoanx.codanx,;
				LDdtfimsld,LNqtvenda,LNqtentra,LNvlrvenda
		LNacmqtvenda   	= LNacmqtvenda  + LNqtvenda
		LNacmqtentra	= LNacmqtentra  + LNqtentra
		LNacmvlrvenda  	= LNacmvlrvenda + LNvlrvenda
		*******************************************************************
	ENDIF	
	LNqtvenda 	=	LNacmqtvenda
	LNqtentra	=	LNacmqtentra
	LNvlrvenda	=	LNacmvlrvenda

	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

********************************************************************

PROCEDURE UEvervendas
	PARAMETERS  LDdtini,LDdtfim, LNempresa, LScodigo,LDdtfimsld,;
				LNqtvenda,LNqtentra,LNvlrvenda,LFdevolucao
	******************************************************************
	*	LFdevolucao	= .F. => Processa as devolucoes abatendo nas vendas
	*	              .T. => Nao abate devolucoes nas vendas
	*
	*	LNempresa 	= 999 => FAZ COM QUE A ROTINA LEVANDE  DADOS DE TODAS
	*						EMPRESAS REGISTRADAS NO ARQ. EMPRESA
	*******************************************************************
	=W_DEFPROC("rotinas.SPR")
	PRIVATE ALL
	LSalias 	= ALIAS()
	LNqtvenda   = 0
	LNqtentra	= 0
	LNvlrvenda  = 0

	SELE empresa
	SET ORDER TO TAG empresa
	IF LNempresa = 999
		GO TOP
	ELSE
		SEEK LNempresa
	ENDIF
	DO WHILE !EOF() AND (LNempresa = 999 OR LNempresa = empresa.empresa)
		SELE itemmov
		SET ORDER TO TAG movimento
		SET NEAR ON
		SEEK STR(empresa.empresa,3)+LScodigo+DTOS(LDdtini)
		SET NEAR OFF
		DO WHILE itemmov.data <= LDdtfim AND ;
				 itemmov.empresa = empresa.empresa AND ;
				 itemmov.codigo  = LScodigo
			IF LEFT(itemmov.operacao,1) = 'S' AND itemmov.ch_opera = "1" 	
			 	LNvlrvenda = LNvlrvenda + itemmov.vlrvenda
				IF itemmov.movestq = "S"
				 	LNqtvenda  = LNqtvenda  + itemmov.qtde
				ENDIF
			ENDIF
			IF !LFdevolucao  && ABATER DEVOLUCOES
				IF LEFT(itemmov.operacao,1) = 'E' AND itemmov.ch_opera = "4" AND ;
				    itemmov.movestq = "S"
				 	LNvlrvenda = LNvlrvenda - itemmov.vlrvenda
					IF (LNqtvenda  - itemmov.qtde) >=  0
				 		LNqtvenda  = LNqtvenda  - itemmov.qtde
					ENDIF
				ENDIF
			ENDIF
		IF itemmov.data <= LDdtfimsld AND LEFT(itemmov.operacao,1) = 'E' ;
				AND itemmov.ch_opera <> "4" AND itemmov.movestq = "S"
				 	LNqtentra  = LNqtentra  + itemmov.qtde
		ENDIF
			***********************************************************
			*  CASO A MERCADORIA SAI POR TRANSFERENCIA OU POR MOV. QUE NAO
			* SEJA VENDA ELA E DESCONSIDERADA
			* DAS ENTRADAS POIS NAO ESTA DESTINADA AO ESTOQUE DE VENDA
			***********************************************************
			IF LEFT(itemmov.operacao,1) = 'S' AND ;
					itemmov.ch_opera <> "1"	&& SAIDAS DEVERSAS DA VENDA
				 IF itemmov.movestq = "S"
					 	LNqtentra  = LNqtentra  - itemmov.qtde
				 ENDIF
				 IF LNqtentra < 0
				 	LNqtentra = 0
				 ENDIF
			ENDIF
			SKIP
		ENDDO	
		IF LNempresa <> 999		&& PESQUISA SO NA EMPRESA INFORMADA
			EXIT
		ENDIF
		SELE empresa
		SKIP
	ENDDO
	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(0)




**********************************************************************
* FUNCTION UEleanexado : Retorna o Codigo ou Codigo Anexado ao Codigo
*						Passado em Parametro
*		LSclas		=>	Codigo a Ser Verificado
*		LSresposta	=>  Indica qual a resposta desejad
*					"ANEXO" = Responder se o Produto Possui algum item
*							Anexado a ele
*					"ANEXADO" = Responder se o Produto esta ANEXADO a
*							outro
*					"QUALQUER"= Responder se existe vinculo em qualqer
*							sentido
***********************************************************************

FUNCTION UEleanexado
PARAMETERS LSclas,LSpergunta
	PRIVATE LSalias, LSresposta

	=W_DEFPROC("rotinas.SPR")

	PRIVATE LFerro
	LSalias = ALIAS()

	LSresposta = ""
    SELE grupoanx
	DO CASE
		CASE LSpergunta = "ANEXO"
			SET ORDER TO TAG classifica
			SEEK LSclas
			IF FOUND()
				LSresposta = grupoanx.codanx	&& E ANEXO DO CODIGO INFORMADO
			ENDIF
		CASE LSpergunta = "ANEXADO"
			SET ORDER TO TAG clasanx
			SEEK LSclas
			IF FOUND()
				LSresposta = grupoanx.codanx	&& E ANEXO DO CODIGO INFORMADO
			ENDIF
		CASE LSpergunta = "QUALQUER"
			LSresposta = UEleanexado(LSclas,"ANEXO")
			IF EMPTY(LSresposta)
				LSresposta = UEleanexado(LSclas,"ANEXADO")
			ENDIF
	ENDCASE
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSresposta)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨  CLIENTES/MS-DOS Supporting Procedures and Functions    ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 10
FUNCTION UEvendas
	PARAMETERS LNempresa,LSclas,LScodigo,LDdtini,LDdtfim,LNemdias,;
				LNqtvenda,LNqtentra,LNvlrvenda
	
	=W_DEFPROC("rotinas.prg")
	*********************************************************************
	PRIVATE ALL
	LSalias 	= ALIAS()

	LNqtvenda   = 0
	LNqtentra	= 0
	LNvlrvenda  = 0

	LNacmqtvenda   	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO
	LNacmqtentra	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO
	LNacmvlrvenda  	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO

	*********************>>> REGISTRO DE SAIDAS <<<*********************
	*
	*   O saldo formado no so e considerado ate a 2/3 do
	* do periodo devido a pouca influencia nas vendas do periodo
	* das entradas do 1/3 restante
	*
	********************************************************************
	LDdtfimsld = LDdtini 		 		&& data para referenciar saldo apuradao
	LNdiassld  = INT(LNemdias / 3)* 2  && para apurar o saldo formado
							 			&& ate metade do periodo
	LNctrdias = 0
	DO WHILE LNctrdias <= LNdiassld
		IF DOW(LDdtfimsld) <> 1
			LNctrdias = LNctrdias +1
		ENDIF
		LDdtfimsld = LDdtfimsld + 1
	ENDDO
	*******************************************************************
	DO UEvervendas WITH LDdtini,LDdtfim, LNempresa, LScodigo,;
			LDdtfimsld,LNqtvenda,LNqtentra,LNvlrvenda

	LNacmqtvenda   	= LNqtvenda
	LNacmqtentra	= LNqtentra
	LNacmvlrvenda  	= LNvlrvenda

	*******************************************************************
	SELE grupoanx
	SET ORDER TO TAG classifica
	SEEK LSclas
	IF FOUND()
		*******************************************************************
		DO UEvervendas WITH LDdtini,LDdtfim, LNempresa,;
				grupoanx.codanx,;
				LDdtfimsld,LNqtvenda,LNqtentra,LNvlrvenda
		LNacmqtvenda   	= LNacmqtvenda  + LNqtvenda
		LNacmqtentra	= LNacmqtentra  + LNqtentra
		LNacmvlrvenda  	= LNacmvlrvenda + LNvlrvenda
		*******************************************************************
	ENDIF	
	LNqtvenda 	=	LNacmqtvenda
	LNqtentra	=	LNacmqtentra
	LNvlrvenda	=	LNacmvlrvenda

	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

********************************************************************

PROCEDURE UEvervendas
	PARAMETERS  LDdtini,LDdtfim, LNempresa, LScodigo,LDdtfimsld,;
				LNqtvenda,LNqtentra,LNvlrvenda,LFdevolucao
	******************************************************************
	*	LFdevolucao	= .F. => Processa as devolucoes abatendo nas vendas
	*	              .T. => Nao abate devolucoes nas vendas
	*
	*	LNempresa 	= 999 => FAZ COM QUE A ROTINA LEVANDE  DADOS DE TODAS
	*						EMPRESAS REGISTRADAS NO ARQ. EMPRESA
	*******************************************************************
	=W_DEFPROC("rotinas.prg")
	PRIVATE ALL
	LSalias 	= ALIAS()
	LNqtvenda   = 0
	LNqtentra	= 0
	LNvlrvenda  = 0

	SELE empresa
	SET ORDER TO TAG empresa
	IF LNempresa = 999
		GO TOP
	ELSE
		SEEK LNempresa
	ENDIF
	DO WHILE !EOF() AND (LNempresa = 999 OR LNempresa = empresa.empresa)
		SELE itemmov
		SET ORDER TO TAG movimento
		SET NEAR ON
		SEEK STR(empresa.empresa,3)+LScodigo+DTOS(LDdtini)
		SET NEAR OFF
		DO WHILE itemmov.data <= LDdtfim AND ;
				 itemmov.empresa = empresa.empresa AND ;
				 itemmov.codigo  = LScodigo
			IF LEFT(itemmov.operacao,1) = 'S' AND itemmov.ch_opera = "1" 	
			 	LNvlrvenda = LNvlrvenda + itemmov.vlrvenda
				IF itemmov.movestq = "S"
				 	LNqtvenda  = LNqtvenda  + itemmov.qtde
				ENDIF
			ENDIF
			IF !LFdevolucao  && ABATER DEVOLUCOES
				IF LEFT(itemmov.operacao,1) = 'E' AND itemmov.ch_opera = "4" AND ;
				    itemmov.movestq = "S"
				 	LNvlrvenda = LNvlrvenda - itemmov.vlrvenda
					IF (LNqtvenda  - itemmov.qtde) >=  0
				 		LNqtvenda  = LNqtvenda  - itemmov.qtde
					ENDIF
				ENDIF
			ENDIF
		IF itemmov.data <= LDdtfimsld AND LEFT(itemmov.operacao,1) = 'E' ;
				AND itemmov.ch_opera <> "4" AND itemmov.movestq = "S"
				 	LNqtentra  = LNqtentra  + itemmov.qtde
		ENDIF
			***********************************************************
			*  CASO A MERCADORIA SAI POR TRANSFERENCIA OU POR MOV. QUE NAO
			* SEJA VENDA ELA E DESCONSIDERADA
			* DAS ENTRADAS POIS NAO ESTA DESTINADA AO ESTOQUE DE VENDA
			***********************************************************
			IF LEFT(itemmov.operacao,1) = 'S' AND ;
					itemmov.ch_opera <> "1"	&& SAIDAS DEVERSAS DA VENDA
				 IF itemmov.movestq = "S"
					 	LNqtentra  = LNqtentra  - itemmov.qtde
				 ENDIF
				 IF LNqtentra < 0
				 	LNqtentra = 0
				 ENDIF
			ENDIF
			SKIP
		ENDDO	
		IF LNempresa <> 999		&& PESQUISA SO NA EMPRESA INFORMADA
			EXIT
		ENDIF
		SELE empresa
		SKIP
	ENDDO
	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(0)




**********************************************************************
* FUNCTION UEleanexado : Retorna o Codigo ou Codigo Anexado ao Codigo
*						Passado em Parametro
*		LSclas		=>	Codigo a Ser Verificado
*		LSresposta	=>  Indica qual a resposta desejad
*					"ANEXO" = Responder se o Produto Possui algum item
*							Anexado a ele
*					"ANEXADO" = Responder se o Produto esta ANEXADO a
*							outro
*					"QUALQUER"= Responder se existe vinculo em qualqer
*							sentido
***********************************************************************

FUNCTION UEleanexado
PARAMETERS LSclas,LSpergunta
	PRIVATE LSalias, LSresposta

	=W_DEFPROC("rotinas.prg")

	PRIVATE LFerro
	LSalias = ALIAS()

	LSresposta = ""
    SELE grupoanx
	DO CASE
		CASE LSpergunta = "ANEXO"
			SET ORDER TO TAG classifica
			SEEK LSclas
			IF FOUND()
				LSresposta = grupoanx.codanx	&& E ANEXO DO CODIGO INFORMADO
			ENDIF
		CASE LSpergunta = "ANEXADO"
			SET ORDER TO TAG clasanx
			SEEK LSclas
			IF FOUND()
				LSresposta = grupoanx.codanx	&& E ANEXO DO CODIGO INFORMADO
			ENDIF
		CASE LSpergunta = "QUALQUER"
			LSresposta = UEleanexado(LSclas,"ANEXO")
			IF EMPTY(LSresposta)
				LSresposta = UEleanexado(LSclas,"ANEXADO")
			ENDIF
	ENDCASE
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSresposta)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨   CLIEN_R/MS-DOS Supporting Procedures and Functions    ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 11
FUNCTION UEvendas
	PARAMETERS LNempresa,LSclas,LScodigo,LDdtini,LDdtfim,LNemdias,;
				LNqtvenda,LNqtentra,LNvlrvenda
	
	=W_DEFPROC("rotinas.prg")
	*********************************************************************
	PRIVATE ALL
	LSalias 	= ALIAS()

	LNqtvenda   = 0
	LNqtentra	= 0
	LNvlrvenda  = 0

	LNacmqtvenda   	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO
	LNacmqtentra	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO
	LNacmvlrvenda  	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO

	*********************>>> REGISTRO DE SAIDAS <<<*********************
	*
	*   O saldo formado no so e considerado ate a 2/3 do
	* do periodo devido a pouca influencia nas vendas do periodo
	* das entradas do 1/3 restante
	*
	********************************************************************
	LDdtfimsld = LDdtini 		 		&& data para referenciar saldo apuradao
	LNdiassld  = INT(LNemdias / 3)* 2  && para apurar o saldo formado
							 			&& ate metade do periodo
	LNctrdias = 0
	DO WHILE LNctrdias <= LNdiassld
		IF DOW(LDdtfimsld) <> 1
			LNctrdias = LNctrdias +1
		ENDIF
		LDdtfimsld = LDdtfimsld + 1
	ENDDO
	*******************************************************************
	DO UEvervendas WITH LDdtini,LDdtfim, LNempresa, LScodigo,;
			LDdtfimsld,LNqtvenda,LNqtentra,LNvlrvenda

	LNacmqtvenda   	= LNqtvenda
	LNacmqtentra	= LNqtentra
	LNacmvlrvenda  	= LNvlrvenda

	*******************************************************************
	SELE grupoanx
	SET ORDER TO TAG classifica
	SEEK LSclas
	IF FOUND()
		*******************************************************************
		DO UEvervendas WITH LDdtini,LDdtfim, LNempresa,;
				grupoanx.codanx,;
				LDdtfimsld,LNqtvenda,LNqtentra,LNvlrvenda
		LNacmqtvenda   	= LNacmqtvenda  + LNqtvenda
		LNacmqtentra	= LNacmqtentra  + LNqtentra
		LNacmvlrvenda  	= LNacmvlrvenda + LNvlrvenda
		*******************************************************************
	ENDIF	
	LNqtvenda 	=	LNacmqtvenda
	LNqtentra	=	LNacmqtentra
	LNvlrvenda	=	LNacmvlrvenda

	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

********************************************************************

PROCEDURE UEvervendas
	PARAMETERS  LDdtini,LDdtfim, LNempresa, LScodigo,LDdtfimsld,;
				LNqtvenda,LNqtentra,LNvlrvenda,LFdevolucao
	******************************************************************
	*	LFdevolucao	= .F. => Processa as devolucoes abatendo nas vendas
	*	              .T. => Nao abate devolucoes nas vendas
	*
	*	LNempresa 	= 999 => FAZ COM QUE A ROTINA LEVANDE  DADOS DE TODAS
	*						EMPRESAS REGISTRADAS NO ARQ. EMPRESA
	*******************************************************************
	=W_DEFPROC("rotinas.prg")
	PRIVATE ALL
	LSalias 	= ALIAS()
	LNqtvenda   = 0
	LNqtentra	= 0
	LNvlrvenda  = 0

	SELE empresa
	SET ORDER TO TAG empresa
	IF LNempresa = 999
		GO TOP
	ELSE
		SEEK LNempresa
	ENDIF
	DO WHILE !EOF() AND (LNempresa = 999 OR LNempresa = empresa.empresa)
		SELE itemmov
		SET ORDER TO TAG movimento
		SET NEAR ON
		SEEK STR(empresa.empresa,3)+LScodigo+DTOS(LDdtini)
		SET NEAR OFF
		DO WHILE itemmov.data <= LDdtfim AND ;
				 itemmov.empresa = empresa.empresa AND ;
				 itemmov.codigo  = LScodigo
			IF LEFT(itemmov.operacao,1) = 'S' AND itemmov.ch_opera = "1" 	
			 	LNvlrvenda = LNvlrvenda + itemmov.vlrvenda
				IF itemmov.movestq = "S"
				 	LNqtvenda  = LNqtvenda  + itemmov.qtde
				ENDIF
			ENDIF
			IF !LFdevolucao  && ABATER DEVOLUCOES
				IF LEFT(itemmov.operacao,1) = 'E' AND itemmov.ch_opera = "4" AND ;
				    itemmov.movestq = "S"
				 	LNvlrvenda = LNvlrvenda - itemmov.vlrvenda
					IF (LNqtvenda  - itemmov.qtde) >=  0
				 		LNqtvenda  = LNqtvenda  - itemmov.qtde
					ENDIF
				ENDIF
			ENDIF
		IF itemmov.data <= LDdtfimsld AND LEFT(itemmov.operacao,1) = 'E' ;
				AND itemmov.ch_opera <> "4" AND itemmov.movestq = "S"
				 	LNqtentra  = LNqtentra  + itemmov.qtde
		ENDIF
			***********************************************************
			*  CASO A MERCADORIA SAI POR TRANSFERENCIA OU POR MOV. QUE NAO
			* SEJA VENDA ELA E DESCONSIDERADA
			* DAS ENTRADAS POIS NAO ESTA DESTINADA AO ESTOQUE DE VENDA
			***********************************************************
			IF LEFT(itemmov.operacao,1) = 'S' AND ;
					itemmov.ch_opera <> "1"	&& SAIDAS DEVERSAS DA VENDA
				 IF itemmov.movestq = "S"
					 	LNqtentra  = LNqtentra  - itemmov.qtde
				 ENDIF
				 IF LNqtentra < 0
				 	LNqtentra = 0
				 ENDIF
			ENDIF
			SKIP
		ENDDO	
		IF LNempresa <> 999		&& PESQUISA SO NA EMPRESA INFORMADA
			EXIT
		ENDIF
		SELE empresa
		SKIP
	ENDDO
	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(0)




**********************************************************************
* FUNCTION UEleanexado : Retorna o Codigo ou Codigo Anexado ao Codigo
*						Passado em Parametro
*		LSclas		=>	Codigo a Ser Verificado
*		LSresposta	=>  Indica qual a resposta desejad
*					"ANEXO" = Responder se o Produto Possui algum item
*							Anexado a ele
*					"ANEXADO" = Responder se o Produto esta ANEXADO a
*							outro
*					"QUALQUER"= Responder se existe vinculo em qualqer
*							sentido
***********************************************************************

FUNCTION UEleanexado
PARAMETERS LSclas,LSpergunta
	PRIVATE LSalias, LSresposta

	=W_DEFPROC("rotinas.prg")

	PRIVATE LFerro
	LSalias = ALIAS()

	LSresposta = ""
    SELE grupoanx
	DO CASE
		CASE LSpergunta = "ANEXO"
			SET ORDER TO TAG classifica
			SEEK LSclas
			IF FOUND()
				LSresposta = grupoanx.codanx	&& E ANEXO DO CODIGO INFORMADO
			ENDIF
		CASE LSpergunta = "ANEXADO"
			SET ORDER TO TAG clasanx
			SEEK LSclas
			IF FOUND()
				LSresposta = grupoanx.codanx	&& E ANEXO DO CODIGO INFORMADO
			ENDIF
		CASE LSpergunta = "QUALQUER"
			LSresposta = UEleanexado(LSclas,"ANEXO")
			IF EMPTY(LSresposta)
				LSresposta = UEleanexado(LSclas,"ANEXADO")
			ENDIF
	ENDCASE
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSresposta)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJO3           ORimp_osi VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:    2  ╨
*       ╨ Variable:            ORimp_osi                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      1                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjo3     &&  ORimp_osi VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------------------------------------------*

PROCEDURE ORloc_orc		&& sist. localizacao de orcamentos
PARAMETERS LSsit, LScompl, LSorigem

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Visualisar Orcamentos que atendam aos parametros
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		PARAMETERS LSsit, LScompl, LSorigem
	*			LSsit   => indica as situacoes que devem ser relacionadas
	*			LScompl => indica os complementos de situacoes solicitados
	*		 	LSorigem=> indica qual operacao solicitou ex: RESERVA,
	*						LIBERA
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*

	PRIVATE 	LFdestrava

	ON KEY LABEL ESCAPE
	CLEAR TYPEAHEAD
    SELECT orcament

	IF TYPE("LScompl") <> "C"
		LScompl = ""
	ENDIF

	IF TYPE("LSorigem") <> "C"
		LSorigem = ""
	ENDIF

	IF TYPE("ver") <> "N"
		m.ver = 2   && ver todos
	ENDIF





	LNreg = RECNO()     && permite reposicionar registro

	LNemp = orcament.empresa
	LNorca= orcament.orcamento
	SET ORDER TO tag situacao
	SET NEAR ON
	SEEK STR(wp_empresa,3)+LEFT(LSsit,1)    &&posic. na 1a sit.strig
	SET NEAR OFF
	IF EOF() OR wp_empresa <> orcament.empresa OR ;
			!(LEFT(orcament.situacao,1) $ LSsit)
		wp_msg = "Nao existem orcamentos para esta opcao. <ENTER>"
		=UPbeeps(.F.,wp_msg)
		UNLOCK
	    m.sOldError=ON('error')
		ON ERROR *
		GO LNreg
		ON ERROR &sOldError
		KEYBOARD CHR(27)		
		=INKEY(0)
 		RETURN
	ENDIF
************************>
	wl_arqtmp = ""
	LNtmp     = 65		&& TABELA ASCII A = 65
	IF !UPabretmp("orc")
		wp_flgfecha = .t.
	ENDIF
	IF wp_flgfecha
		KEYBOARD "{ESCAPE}"
		RETURN
	ENDIF
	SET SAFET OFF
	LStmp = "&wp_dirtmp"+"&wl_arqtmp"
*****************************>
	SELE clienc
	SET ORDER TO TAG emporca

	SELE orcament
	LFdestrava = .f.
	IF LSorigem = "LIBERAR"	&& devem ser mostrados reg.protegidos
		LFdestrava = .t.
	ENDIF
	SET RELATION TO STR(EMPRESA,3)+STR(ORCAMENTO,6) INTO clienc


	
	DO CASE

		CASE ("A" $ LSsit OR "F" $ LSsit OR "G" $ LSsit OR "I" $ LSsit)  ;
		 	  AND (m.ver <> 1 OR lMaster)

				&& RESERVA E CANC. DE RESERVA P/ VER ORCAMENTO COM
				&& RESERVAS PELO ESTOQUE

			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome,veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
	   	    FOR ;
				(  !orcament.protegido ;
					OR lMaster;
					OR LFdestrava ;
					OR ;
				     (     orcament.protegido ;
				       AND orcament.operador = wl_vendedor;
				     );
				) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
			    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl) ;
	 			WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX

		CASE ("A" $ LSsit OR "F" $ LSsit OR "G" $ LSsit OR "I" $ LSsit)  ;
		 	  AND (m.ver = 1 OR lMaster)

				&& RESERVA E CANC. DE RESERVA P/ VER ORCAMENTO COM
				&& RESERVAS PELO ESTOQUE
			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome,veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
		   	    FOR ;
   		        (orcament.operador = wl_vendedor) AND ;
	   		    LEFT(orcament.situacao,1) $ LSsit     AND ;
	   	    	(EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl) ;
	    		WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX

		CASE WPprgativo = "SCGC201A" OR m.ver <> 1 && ver alem proprios
	
			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome, veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
	   	    FOR ;
				(!orcament.protegido OR lMaster OR LFdestrava OR ;
				(orcament.protegido AND orcament.operador = wl_vendedor)) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
		   	    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl);
	    		WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX
		OTHERWISE
			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome,veiculo,placa, ;
					dt_fat,nota,dtregis,hregis,usrregis ;
   	        FOR ;
				(lMaster OR orcament.operador = wl_vendedor) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
		   	    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl) ;
    			WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX
	ENDCASE
	SET RELATION TO

    SELE 0
    USE &LStmp EXCLU ALIAS ORCABROW
	INDEX ON NOME TAG nome_todos ADDITIVE

*-----------------------> FIM PREPARACAO ARQ. TEMPORARIO	
	IF EOF() AND BOF()
		wp_msg = "Nao existem orcamentos para esta opcao. <ENTER>"
		=UPbeeps(.F.,wp_msg)
		KEYBOARD CHR(27)		
		=INKEY(0)
	    SELECT orcament
		GO LNreg
	ELSE
		Lpar1 = ""
		Lpar2 = ""
		SET ORDER TO TAG nome_todos
		GO TOP

		DO ORLoc_Browse WITH .T., Lpar1, Lpar2, "B"


	    SELECT orcament
		SET ORDER TO tag orcamento
		SET RELATION TO
*------------------------------------- posiciona orcamento
		SEEK STR(orcabrow.empresa,3)+STR(orcabrow.orcamento,6)
*------------------------------------ encerra secao orcabrow
		IF !FOUND() OR LASTKEY() = 27
			KEYBOARD CHR(27)		
			GO LNreg
		ENDIF
	ENDIF
	SELECT orcabrow
	USE
	SELECT orcament
    SCATTER MEMVAR MEMO
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJOH           ORLoc_Browse VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:    3  ╨
*       ╨ Variable:            ORLoc_Browse                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      2                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gjoh     &&  ORLoc_Browse VALID
#REGION 1
RETURN
PROCEDURE ORLoc_Browse
   PARAMETERS wl_indice, wl_for1, wl_key, wl_frmato
	*********************************************************************			
	* wl_indice   => .t. => Nao selecionar indice (assumir corrente)
	*				 .f. => Selecionar indice em PSQCDX.SPR
	* wl_for	  => Condicao de listagem no browse
	*
	* wl_frmato	  => Permite escolha do formato armazenado no arq
	*			 FORMATO.DBF
	*
	*
	*********************************************************************			

	=W_DEFPROC("rotinas.spr")

				
	PUSH KEY CLEAR
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()

	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
						_MED_FINDA

	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	HIDE MENU _MSYSMENU

	DEFINE WINDOW wzlocate ;
		FROM 1, 1 ;
		TO 12,79 ;
		TITLE "REGISTROS" ;
		FLOAT ;
        GROW;
		CLOSE ;
		SHADOW ;
		MINIMIZE ;
        ZOOM;
		SYSTEM ;
		COLOR SCHEME 10


    wl_for 		= wl_for1
    VLlocctag 	= tag()


    IF !wl_indice
    	DO psqcdx.spr
		IF LASTKEY()  =  27
		    ON KEY LABEL ENTER
    		SET FORMAT TO
    		set order to  tag &VLlocctag
			RELEASE WINDOW wzlocate
			POP KEY 			&& reabilita teclas de atalho def. anteriormente
			POP MENU _MSYSMENU
			SET SYSMENU OFF
			RETURN
		ENDIF
    ENDIF


    ON KEY LABEL ENTER KEYBOARD CHR(23)
    IF !EMPTY(wl_for)
       wl_for = " FOR "+wl_for
	   IF !EOF()
		   SKIP
	   ENDIF
	   SKIP -1	
    ELSE
       wl_for = " "
    ENDIF


    IF !EMPTY(wl_key)
	   wl_key1 = "'"+&wl_key+"','"+&wl_key+"'"
       wl_key2 = " KEY "+wl_key1
    ELSE
       wl_key2 = " "
    ENDIF

	*----------------------------------------------------*
	*	 SUB. ROTINAS
	*----------------------------------------------------*
	
	ON KEY LABEL F12    DO OBJ_CALC.SPR


    Lusrtmp	= nUsr
    ON KEY LABEL L 		DO LORCABRO.SPR
    ON KEY LABEL CTRL-L DO LORCABRO.SPR
	ON ERROR WAIT WINDOW "O AUXILIAR DE BUSCA NAO ESTA DISPONIVEL."

********************  FORMATACAO *******************

	SET FIELDS TO
	LSaliasant = ALIAS()
	LStagtmp   = TAG()

	IF TYPE("wl_frmato") $ "UL" OR EMPTY(wl_frmato)
		SELE indice
		SET ORDER TO TAG dbf_tag
		SEEK "ORCABROW"+LStagtmp
		IF FOUND()
			LSvaria = indice.variacao
		ELSE
			LSvaria = 'A'
		ENDIF	
	ELSE
		LSvaria = wl_frmato     && FORMATO SOLICITADO NA CHAMDA DA ROTINA
	ENDIF
**	
    SELE formato
    SET ORDER TO TAG formato
	SEEK "ORCABROW"+LSvaria
	IF FOUND()
		LFforma = RTRIM(formato.mascara)  && POSSUI FORMATO DEFINIDO
	ELSE
		LFforma = ""                      && NAO POSSUI FORMATO DEFINIDO
    ENDIF		
	SELE &LSaliasant
****************************************************


    SET FORMAT TO
*	KEYBOARD "L"
	DO WHILE .T.
	*    BROWSE &LFforma WINDOW wzlocate &wl_for REST &wl_key2 ;
  	*			NOAPPEND NODELETE NOEDIT VALID :F btn_val('ATUALIZA') ;
	*		&wp_timeout COLOR SCHEME 10
    *
	    BROWSE &LFforma WINDOW wzlocate &wl_for REST &wl_key2 ;
  				NOAPPEND NODELETE NOEDIT   ;
			&wp_timeout COLOR SCHEME 10
		IF READKEY() <> 20
			EXIT
		ENDIF
		=W_DEFPROC("rotinas.spr")
		DO UPprotege	&& ATIVA PROTECAO DE TELA
	ENDDO
	SET COLOR OF SCHEME 10 TO ,,,,,,W+/B
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	HIDE MENU _MSYSMENU

	ON ERROR DO UPerrosys

    ON KEY LABEL CTRL-L
    ON KEY LABEL L
    ON KEY LABEL ENTER
    SET FORMAT TO
	SET FIELDS TO
    set order to  tag &VLlocctag
	RELEASE WINDOW wzlocate
	POP KEY 			&& reabilita teclas de atalho def. anteriormente
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJOR           ORadOrcament VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:    4  ╨
*       ╨ Variable:            ORadOrcament                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      3                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjor     &&  ORadOrcament VALID
#REGION 1
RETURN

FUNCTION ORadOrcament
PARAMETERS LNemp,LNorcamento
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Cria um  Registro de Orcamento padrao
	*          para agilizar abertura de uma venda
	*------------------------------------------------------------*
	* COMENTARIO..: Varia Vendas sao Negociadas a Principio com
	*           caracteristas Padronizadas e so no Decorrer da Nego-
	*           ciacao Sao Informadoas a Caracteristicas Especificas
	*           da Operacao
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNorcamento....: Numero Osi Aberta
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*
	*	=ORadOrcament((wp_empresa),m.orcamento)
	*
	*
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFempresa, LForcament, LFclienc
	LSalias = ALIAS()

	LFempresa  = NetArq("empresa")
	LForcament = NetArq("orcament")
	LFclienc   = NetArq("clienc")
	IF (LFempresa+LForcament+LFclienc) > 100000 && HOUVE FALHA DE ABERTURA
		DO ORFchadOrcament
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		DO ORFchadOrcament
		RETURN(.F.)
	ENDIF
	SELE orcament
	SCATTER MEMVAR BLANK
	
  	m.data = wp_dtoper	
	m.hora = TIME()
	m.natu_oper = 1           	&& VENDA
	m.motivo	= 1           	&& NORMAL
	m.situacao 	= "A "			&& ABERTO
	m.empresa  	= LNemp			&& EMPRESA CHAMADORA DA ROTINA
	m.tab_cst	= empresa.tab_cst   && indica tabela CST

*----> CLIENTE PADRAO
	m.cliente   = 0
	m.nome		=""
	m.tp_pessoa = 1
	m.natu_cli	= 0
	m.estado	= empresa.estado
	m.inscricao = 'ISENTO'
	m.tp_inscr	= 2
	m.nome_inscr ="ISENTO"
	m.revendedor= "N"
    m.endereco  = " "
	m.bairro	= " "
	m.cidade	= empresa.cidade
	m.cep       = " "
	m.fone  	= " "
	m.veiculo	= " "
	m.placa     = " "
	m.hodom		= 0
*----> OUTROS
	m.nota 		= 0
	m.dt_fat	= {}
	m.tp_parcela= 1
	m.moeda 	= 1
	
	m.prazo 	= "000/000/000/000/000/"
    m.prazomedio= 0
	m.taxa      = 0
	m.vias_osi = 1
	m.vlr_ent  = 0
	m.vlrfrete = 0
	m.vlrseguro = 0
	m.lim_libera = 0
	m.lim_prazo  = 0
	m.lmt_parcel  = "N"
	m.usr_libera = 0
	m.protegido  = .f.
	m.operador   = nUsr
	m.negociacao = 1
	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	LNorcamento = ORnro_OSI((LNemp),"INCREMENTAR SEQUENCIA",0)
	IF LNorcamento = 0
		DO ORFchadOrcament
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	IF "BALCAO" $ LSprograma
		m.juromes   = 0     &&empresa.juromes
	ELSE
		m.juromes   = 0     && faturista opera com juro = 0
	ENDIF
	*------------------------------------------------------------*
	DO WHILE .T.
		DO OBJ_VDOR.SPR WITH LNemp,LNorcamento,m.operador
		IF LASTKEY() = 27 OR m.operador <> 0
			EXIT
		ENDIF
	ENDDO
	SELE orcament
	IF LASTKEY() = 27
		DO ORFchadOrcament
		RETURN(.F.)
	ENDIF
	*---------------------------------------------------------*
	SELECT orcament
	*---------------------------------------------------------*
	* Devido a posibilidade de 2 vendedores alterarem o numeros
	* sugeridos para um numero inexistente porem igual nos dois
	* casos, o sistema faz nova checagem no momento da gravacao
	*----------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	SET ORDER TO TAG orcamento
	IF FOUND()
		WAIT WINDOW  "Numero de Orcamento ja Cadastrado.  <ENTER>"
		DO ORFchadOrcament
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	m.orcamento = LNorcamento	
	m.tipo		= "???"
	=edithand('SAVE')
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	IF !FOUND()
		=edithand('SAVE')
	ELSE
		=edithand('REGRAVA')
	ENDIF
	SELE orcament
	IF !ORnewclas_oper((LNemp),(LNorcamento))
		   	wp_msg = "Atencao!!! "+CHR(13)+;
	   			"     Nao Foi Possivel Classificar a Operacao."
		=UPbeeps(.f.,wp_msg)
	ENDIF
	*------------------------------------------------------------*
	DO ORFchadOrcament
RETURN(.T.)


PROCEDURE ORFchadOrcament
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("orcament" ,LForcament)
	=UP_fecha("clienc" ,LFclienc)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJOS           ORnro_OSI VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:    5  ╨
*       ╨ Variable:            ORnro_OSI                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      4                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjos     &&  ORnro_OSI VALID
#REGION 1
RETURN

FUNCTION ORnro_OSI
PARAMETERS LNemp,LSprocesso,LNnumero
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar um numero disponivel para OSI
	*------------------------------------------------------------*
	* COMENTARIO..: Para Controlar a numeracao de O.S.I e utiliza-
	*			do um artificio envolvendo os campos EMPRESA,
	*			ORCAMENTO e NOTA para criar um registro de CONTROLE
	*			EX:
	*				 EMPRESA   = 0 (ZERO) - REGISTRO DE CONTROLE
	*				 ORCAMENTO = 001  	  - Referente a Empresa 001
	*					    ou = 002      -   //      //  //    002
	*				 NOTA      = 002651   - Ultimo Numero de ORCAMENTO
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LSprocesso.....: Indica qual o processo que se deseja
	*						realizar, podendo ser:
	*			 1 - "ALTERAR SEQUENCIA" = Alterar o NUMERO conforme
	*					o parametro LNnumero
	*			 2 - "INCREMENTAR SEQUENCIA" = Usada para controlar
	*					a insercao de OSI
	*			 3 - "INFORMAR SEQUENCIA"
	*
	*		LNnumero.......: Para processo de ALTERAR SEQUENCIA
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*				- LNnro = Numero disponivel para a O.S.I
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*
	*	m.orcamento = ORnro_OSI((wp_empresa),"INCREMENTAR SEQUENCIA",0)
	*
	*	=ORnro_OSI((wp_empresa),"ALTERAR SEQUENCIA",(m.orcamento))
	*
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LNnro
	PRIVATE LForcament
	PRIVATE m.empresa, m.orcamento,m.nota,m.situacao

	LSalias = ALIAS()

	LForcament = NetArq("orcament")
	IF (LForcament) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("orcament" ,LForcament)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*------------------------------------------------------------*
	LNnro 	= 0
	*------------------------------------------------------------*
	SELECT orcament
	SET ORDER TO TAG geral
	SEEK STR(0,3)+STR(LNemp,6)
	IF !FOUND()
		SET NEAR ON
		SEEK STR(LNemp+1,3)
		SET NEAR OFF
		DO WHILE !BOF() AND orcament.empresa > LNemp
			SKIP -1
		ENDDO
		IF BOF() OR orcament.empresa <> LNemp
			m.nota = 1      && NAO EXISTE OSI LANCADAS PARA EMPRESA

			DO OBJ_MENS.SPR WITH ;
				"  Nao foi Possivel Localizar o Controle"+;
			  	" de Numeracao de ORCAMENTOS..=> "+chr(13)+" <<<<<        Sera ATRIBUIDO Nro 1         >>>>"+chr(13)+chr(13)+;
			  	", Para Alterar Edit o Campo Ultimo Orcamento em  Cadastro de Empresas."

			*------------------------------------------------------------*
			*DO OBJ_MENS.SPR WITH ;
			*	"  Nao foi Possivel Localizar o Controle"+;
			*  	" de Numeracao de ORCAMENTOS.."
			*=UP_fecha("orcament" ,LForcament)
			*IF !EMPTY(LSalias) AND USED(LSalias)
			*	SELECT &LSalias
			*ENDIF
			*RETURN(LNnro)
			*------------------------------------------------------------*
		ELSE
			m.nota = orcament.orcamento
		ENDIF
		m.empresa	= 	0
		m.orcamento	=	LNemp
		=edithand('SAVE')
	ENDIF
	*------------------------------------------------------------*
	DO CASE
		CASE LSprocesso = "ALTERAR SEQUENCIA"
			=REGLOCK(.T.)
			REPLACE orcament.nota WITH LNnumero
			LNnro 	= orcament.nota
		CASE LSprocesso = "INCREMENTAR SEQUENCIA"
			=REGLOCK(.T.)
			IF orcament.nota > 999999 && O CAMPO NOTA POSSUI 7 DIGT
									  &&ESSE TESTE GARANTE O REINICIO
									  && POIS O CAMPO ORCAMENTO TEM 6 DIGT
				REPLACE orcament.nota WITH 1
			ELSE
				REPLACE orcament.nota WITH orcament.nota + 1
			ENDIF
			LNnro 	= orcament.nota
		CASE LSprocesso = "INFORMAR SEQUENCIA"
			LNnro 	= orcament.nota
	ENDCASE
	UNLOCK
	*------------------------------------------------------------*
	=UP_fecha("orcament" ,LForcament)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNnro)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJOT           ORValEntClie VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:    6  ╨
*       ╨ Variable:            ORValEntClie                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      5                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjot     &&  ORValEntClie VALID
#REGION 1
RETURN

FUNCTION ORValEntClie
PARAMETERS LNemp,LNkey,LNcliente,LSch_opera,LStipo,;
			m.natu_cli,m.tp_pessoa, m.cliente, m.nome, ;
			m.fone, m.estado, m.inscricao,;
			m.tp_inscr, m.revendedor, m.endereco,;
			m.bairro, m.cidade, m.cep, m.regiao,;
			m.banco,m.nome_inscr,m.nome_natu
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Localizar e Validar a entrada de um cliente
	*			no orcamento
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite fazer verificacoes proprias
	*			do campo de informacao do CGC/CPF do cliente para
	*			orcamento
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LNkey..........: Codigo da Tecla de Saida do Campo
	*		LNcliente......: Codigo do Cliente
	*		LSch_opera.....: Operacao definida para o orcamento
	*		LStipo.........: Tipo da classificacao da operacao
	*		m.inscricao....: Permite a distinca
		*    <> Demais parametro sao variaveis de memoria para retor-
	*	   nar a rotina
	*------------------------------------------------------------*
	*  RETORNO.....:- REGISTRO DO CLIENTE  POSICIONADO para
	*					ser tratado na rotina
	*				- .F. Para codigo nao localizado ou nao aceito
	*				- .T. Para codigo Localizado
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	LSalias = ALIAS()

	IF !ORValid_Clie((wp_empresa),LNkey,m.cliente,(m.ch_opera),(m.tipo),;
			m.inscricao)
		RETURN(.F.)
	ENDIF
	m.cgccliente = str(m.cliente,14)
	SHOW GET m.cgccliente

	*-----------------------------------------------------------*
	*	PESQUISAR DADOS EM POSSIVEL VENDA A VISTA	GRAVADOS    *
	* NA NOTA FISCAL											*
	*-----------------------------------------------------------*
	IF m.cliente > 0 AND !FOUND("CLIENTES")
		SELE nota
		SET ORDER TO TAG favorecido
		SET NEAR ON
		SEEK STR(m.cliente + 1,14)		&& POSICIONAR UM A FRENTE
		SET NEAR OFF
		SKIP -1
	ENDIF	
	*---------------------------------------------------------*
	*	Atribuir valores defaut caso nao encontre cliente no
	* CADASTRO E NEM EM NOTAS
	*-----------------------------------------------------------*
	IF m.cliente = 0 OR (!FOUND("CLIENTES")  ;
						  AND nota.favorecido <> m.cliente)
	   IF  EMPTY(m.nome)
			m.natu_cli  = 0		&& varejo
			m.tp_pessoa = 1
			m.cidade	= empresa.cidade
			m.estado	= empresa.estado
			m.inscricao = 'ISENTO'
			m.tp_inscr	= 2
			m.nome_inscr ="OUTROS"
			m.revendedor= "N"
			m.fone 		= "(   )-   -    "
		ENDIF
		SHOW GET m.estado
		SHOW GET m.cidade
		SHOW GET m.inscricao
		SHOW GET m.tp_inscr
		SHOW GET m.nome_inscr
		SHOW GET m.revendedor
		SHOW GET m.tp_pessoa
		SHOW GET m.fone
		m.cgccliente = str(m.cliente,14)
		SHOW GET m.cgccliente
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN .T.
	ENDIF
	DO CASE
		CASE FOUND("CLIENTES")
			m.natu_cli = clientes.natureza
			SCATTER MEMVAR FIELDS ;
				clientes.tp_pessoa, clientes.cliente, clientes.nome, ;
				clientes.fone, clientes.estado, clientes.inscricao,;
				clientes.tp_inscr, clientes.revendedor, clientes.endereco,;
				clientes.bairro, clientes.cidade, clientes.cep, ;
				clientes.regiao  MEMO
			*---------------------------------------------------------*
			*	Determinar o Banco de Cobranca Conforme Cidade
			*---------------------------------------------------------*
			m.banco  = UPdefbanco(clientes.cbcidade, clientes.cbestado)	
			m.regiao = clientes.regiao	
		CASE nota.favorecido = m.cliente
			SELE nota
			m.cliente 	= nota.favorecido
			m.estado	= nota.uf
			SCATTER MEMVAR FIELDS ;
				nota.tp_pessoa, nota.nome, ;
				nota.fone, nota.inscricao,;
				nota.tp_inscr, nota.revendedor, nota.endereco,;
				nota.bairro, nota.cidade, nota.cep, ;
				nota.regiao  MEMO
	ENDCASE

	IF m.revendedor <> "S"
		m.revendedor = "N"
	ENDIF   		

	SELE tab1
	SEEK 'INS'+str(m.tp_inscr,1)
	m.nome_inscr = tab001.descricao

	SEEK 'NTZ'+CHRTRAN(STR(m.natu_cli,1)," ","0")
	m.nome_natu = tab001.descricao

	SELECT &LSalias
	SHOW GET m.cliente
	SHOW GET m.nome
	SHOW GET m.endereco
	SHOW GET m.bairro
	SHOW GET m.cidade
	SHOW GET m.estado
	SHOW GET m.cep
	SHOW GET m.fone
	SHOW GET m.inscricao
	SHOW GET m.tp_inscr
	SHOW GET m.nome_inscr
	SHOW GET m.natu_cli
	SHOW GET m.tp_pessoa
	m.cgccliente = str(m.cliente,14)
	SHOW GET m.cgccliente
	SHOW GET m.nome_natu
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN .T.

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	
	
	

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJPN           ORValid_Clie VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:    7  ╨
*       ╨ Variable:            ORValid_Clie                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      6                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjpn     &&  ORValid_Clie VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORValid_Clie
PARAMETERS LNemp,LNkey,LNcliente,LSch_opera,LStipo,LSinscricao
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Localizar e Validar um cliente para orcamento
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite localizar um cliente ou
	*			filial e validar sua atribuicao ao orcamento
	*			de acordo com as caracteristicas da operacao
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LNkey..........: Codigo da Tecla de Saida do Campo
	*		LNcliente......: Codigo do Cliente
	*		LSch_opera.....: Operacao definida para o orcamento
	*		LStipo.........: Tipo da classificacao da operacao
	*		LSinscricao....: Campo para diferenciar clientes com
	*						duas inscricoes (Ocorre com fazendas)
	*						dois cadastros com mesmo CPF e inscricao
	*						e enderecos diferentes
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:- REGISTRO DO CLIENTE  POSICIONADO para
	*					ser tratado na rotina
	*				- .F. Para codigo nao localizado ou nao aceito
	*				- .T. Para codigo Localizado
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFretorno
	PRIVATE LSmsg
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	IF !USED("CLIENTES")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	SELECT clientes
	SET ORDER TO TAG cliente
	IF LNkey = 9
	   	ON KEY LABEL ESCAPE
	   	DO loc_dlog WITH .T.
	   	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	   	IF LASTKEY() <> 27
		   	LNcliente	= 	clientes.cliente
			LSinscricao	=	clientes.inscricao
		ENDIF	
	ENDIF
	*-----------------------------------------------------------*
   	IF LASTKEY() <> 27
		SET NEAR ON
		SEEK LNcliente
		SET NEAR OFF
	    IF FOUND() AND !EMPTY(LSinscricao)
			DO WHILE !EOF() AND LNcliente = clientes.cliente
				IF LSinscricao = clientes.inscricao
					EXIT
				ENDIF
			    SKIP	&& VERIFICA SE E DUPLICADO E CHECA A INSCRICAO
			ENDDO
			IF EOF() OR LNcliente <> clientes.cliente OR ;
		  			LSinscricao <> clientes.inscricao
					SKIP -1			  && PEGAR DADOS DO REG. LOCALIZADP
			ENDIF				  && PRIMEIRO
		ENDIF
	ENDIF
	*-----------------------------------------------------------*
	*	Critica a tecla
	*-----------------------------------------------------------*
	IF LASTKEY() = 27
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*-----------------------------------------------------------*
	*	Critica a validade CPF/CGC informado
	*-----------------------------------------------------------*
	IF  Calc_cgc(LNcliente) = "3"	&& INVALIDO
		=UPbeeps(.F.,"Numero de Doc. Invalido. <ENTER>")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	*-----------------------------------------------------------*
	*	Critica a localizacao do registro
	*-----------------------------------------------------------*
	IF (LNcliente = 0 OR !FOUND() )
		IF (LNcliente <> 0 AND !FOUND() )
			LSmsg = "Cliente nao cadastrado. Informe "+;
						"dados ou Solicite cadastro. <ENTER>"
			=UPbeeps(.F.,LSmsg)
		ENDIF
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF
	*----------------------------------------------------------*
	*   Validacao do Registro de Cliente X Operacao Orcamento
	*----------------------------------------------------------*
	*   Nao aceitar operacao de venda para outra filial
	*-----------------------------------------------------------------*
	SELE EMPRESA
	SET ORDER TO TAG EMPRESA
	SEEK LNemp

	*---------------------------------------------------------------*
	*	Retorno a area anterior
	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	*---------------------------------------------------------------*
	IF LSch_opera = "1"	&& CHECAGEM PARA NAO VENDER PARA FILIAL
		IF LNcliente <> empresa.cgc	   && VER SE NAO E UMA FILIAL
			IF LEFT(str(LNcliente,14),10) = LEFT(str(empresa.cgc,14),10)
				LSmsg = "Operacao nao Aceita Filial. <ENTER>"
				=UPbeeps(.F.,LSmsg)
				RETURN(.F.)
			ENDIF
		ENDIF
	ENDIF
	*-----------------------------------------------------------------*
	*  Nao aceitar operacao de transferencia que nao seja para filial
	*-----------------------------------------------------------------*
	IF LSch_opera = "2"	&& CHECAGEM PARA NAO TRANSF PARA CLIENTES
		LSempcgc =  str(empresa.cgc,14)
		IF 	LNcliente = empresa.cgc	;
			OR LEFT(str(LNcliente,14),10) <> LEFT(str(empresa.cgc,14),10)
				LSmsg = "Operacao Exige Filial. <ENTER>"
				=UPbeeps(.F.,LSmsg)
				RETURN(.F.)
		ENDIF
	ENDIF
	*----------------------------------------------------------*
RETURN(.T.)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJPW           ORAtlz_Clie VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:    8  ╨
*       ╨ Variable:            ORAtlz_Clie                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      7                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjpw     &&  ORAtlz_Clie VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORAtlz_Clie
PARAMETERS LNemp,LNorca
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Verificar se Houve Atualiza┤фo do Cadastro
	* 			do Cliente Relacionado ao Orcamento e Providenciar
	*           a transferencia de Valores e Reclassifica┤фo da
	*           operacao
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao e ativada antes de efetivar o fatura
	*			mento ou quando o programa de cadastro ┌ acessado
	*			pelo programa de orcamento
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LNorca....: Codigo da Tecla de Saida do Campo
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFretorno
	PRIVATE LSmsg
	PRIVATE LFclientes, LFclienc,LForcament
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	LFclienc	= NetArq("clienc")
	LFclientes	= NetArq("clientes")
	LForcament	= NetArq("orcament")
	IF (LFclientes+LFclienc+LForcament) > 100000
		DO ORfchAtlz_Clie
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	SELECT orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorca,6)
	IF !FOUND()
		DO ORfchAtlz_Clie
		RETURN(.T.)
	ENDIF

	SELECT clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorca,6)
	IF !FOUND()
		DO ORfchAtlz_Clie
		RETURN(.T.)
	ENDIF

	SELECT clientes
	SET ORDER TO TAG cliente
	SEEK clienc.cliente
	IF !FOUND()
		DO ORfchAtlz_Clie
		RETURN(.T.)
	ENDIF
	
 	DO WHILE !EOF() AND clienc.cliente = clientes.cliente
		IF clienc.inscricao = clientes.inscricao
			EXIT
		ENDIF
		SKIP	&& VERIFICA SE E DUPLICADO E CHECA A INSCRICAO
	ENDDO
	IF EOF() OR clienc.cliente <> clientes.cliente OR ;
			clienc.inscricao <> clientes.inscricao
		SKIP -1			  && PEGAR DADOS DO REG. LOCALIZADP
	ENDIF				  && PRIMEIRO
	*----------------------------------------------------------*
	IF (clienc.tp_pessoa <> clientes.tp_pessoa OR ;
					clienc.cliente <> clientes.cliente OR ;
					clienc.estado <> clientes.estado OR ;
					clienc.inscricao <> clientes.inscricao OR ;
					clienc.tp_inscr <> clientes.tp_inscr OR ;
					clienc.revendedor <> clientes.revendedor)
		SCATTER MEMVAR FIELDS tp_pessoa, cliente, nome, fone, estado,;
				 inscricao,tp_inscr, revendedor MEMO
		IF m.revendedor <> "S"
			m.revendedor = "N"
		ENDIF   		
		SELE  clienc
		=REGLOCK(.T.)
		=edithand('REGRAVA')
		SELE orcament
		=RLOCK()
		
		REPLACE orcament.lmt_parcela  WITH clientes.lmt_parcela
		*----------------------------------------------------------*
		*  Ajustar Classifica┤фo do Orcamento					   *
		*----------------------------------------------------------*
		LStipoAnt	= orcament.tipo
		m.tipo 		= orcament.tipo
		=W_DEFPROC("orcament.spr")
		IF !ORnewclas_oper((LNemp),(LNorca))
		   	wp_msg = "Atencao!!! "+CHR(13)+;
					"     Nao Foi Possivel Classificar a Operacao."
			=UPbeeps(.f.,wp_msg)
		ELSE
			IF m.tipo <> LStipoAnt
			   	wp_msg = "Atencao!!! "+CHR(13)+;
	   					"     Devido a Alteracoes do Cadasto "+;
   						"do Cliente a Operacao "+;
			   			chr(13)+;
				   	"Foi Reclassificada Para "+m.tipo+chr(13)+chr(13)+;
		  				" Podendo Afetar o Valor. Verrifique."
				=UPbeeps(.f.,wp_msg)
				*---------------------------------------------------*
				=W_DEFPROC("ORCAMENT.SPR")
				=ORrecalc_OSI((LNemp),(LNorca))
				*----------------------------------------------------*
			ENDIF			
		ENDIF
	ENDIF
	*----------------------------------------------------------*

	*----------------------------------------------------------*
	DO ORfchAtlz_Clie
RETURN(.T.)

PROCEDURE ORfchAtlz_Clie
		=UP_fecha("orcament" ,LForcament)
		=UP_fecha("clienc" ,LFclienc)
		=UP_fecha("clientes" ,LFclientes)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
RETURN
****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJQ8           ORclas_oper VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:    9  ╨
*       ╨ Variable:            ORclas_oper                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      8                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjq8     &&  ORclas_oper VALID
#REGION 1
RETURN

FUNCTION ORclas_oper
	PARAMETERS LNemp,LNnatuOper,LNmotivo,LSUFdestino,LNtp_inscr,LNnatu_cli,;
		LNtp_pgto,LStipo,;
		LSch_opera,LSch_produ,LSch_motiv,LSch_desti,LSch_contr,LSch_condi

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Classificar a operacao comercial permitindo
	*			a atribuicao do TIPO
	*------------------------------------------------------------*
	* COMENTARIO..: Todas operacoes realizadas tem uma classificacao
	*			que servira DE ORIENTACAO para todos processos reali-
	*			zados, como TRIBUTACAO, BAIXA ESTOQUE, RESERVA, FATU-
	*			RAMENTO .....
	*				Esta CLASSIFICAO permite a orientacao do processo
	*			a ser realizado....
	*				A classificacao leva em consideracao as caracteris-
	*			ticas da :
	*					-OPERACAO(venda,transferenci,..)
	*					-CLIENTE(contribuinte,destino,...)
	*					-COMERCIAL(prazo,...)
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LNnatuOper.....: Indica Natureza da Operacao
	*							1-Venda ou Compra
	*							2-Transferencia
	*							3-S.Remessa
	*							4-Devolucao
	*							5-Requisicao
	*							6-NF.Entrada
	*							7-Outras
	*		LNmotivo.......: Conforme a Natureza
	*                         Ver vetor VTLmotivo em SCGC2.PRG
	*		LSUFdestino....: UF do Cliente
	*					
	*		LNtp_inscr.....: Tipo de Inscricao do Cliente
	*						1=ISENTO
	*						2=INSCRITO
	*		LNnatu_cli.....: Natureza do Cliente
	*						0= VAREJO
	*						1= REVENDA
	*						3= P.PUBLICO
	*						4= FROTA
	*		LNtp_pgto......: Tipo de Pagamento Proposto
	*						1= A VISTA
	*						2= C.APRESENTACAO
	*						3= A PRESA
	*		LStipo.........: Tipo Informado Diretamente para
	*						completar a classificacao
	*
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*	LSch_opera,LSch_produ,LSch_motiv,LSch_desti,LSch_contr,LSch_condi
	*------------------------------------------------------------*
	* EXEMPLO : SCGC2.PRG
	*			OBJ_ITOR.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LFretorno
	PRIVATE LSalias
	LSalias = ALIAS()
	*------------------------------------------------------------*
	IF (LNnatuOper = 1 AND LNmotivo = 8) OR ;
	   (LNnatuOper = 2 AND LNmotivo = 5) OR ;
	   (LNnatuOper = 3 AND LNmotivo = 6) OR ;
	   (LNnatuOper = 4 AND LNmotivo = 8) OR ;
	   (LNnatuOper = 5) OR   (LNnatuOper = 7)
		SELECT tipooper
		SET ORDER TO TAG tipo
		SEEK 's'+LStipo
		IF !FOUND()
			SEEK 'S'+LStipo  	
		ENDIF
	ELSE
	  DO CASE
		CASE LNnatuOper = 1
			STORE "1"     TO LSch_opera  && 1=VENDA 		
			STORE "1"     TO LSch_produ  && 1=PROD.E SERV COMERCIAL
			STORE STR(LNmotivo,1)  TO LSch_motiv    && 1=NORMAL  2=RECLAMADA
											&& 3=COMPLEMENTO 4=ENTRGA FUTU.		
			SELE empresa
			SET ORDER TO TAG empresa
			SEEK LNemp
			IF empresa.estado = LSUFdestino
				LSch_desti = "1"   && ESTADUAL
				LSch_contr = "1"   && CONSUMIDOR ESTADUAL				
			ELSE
				LSch_desti = "2"   && ITERESTADUAL
				IF LNtp_inscr = 1
					LSch_contr = "2"
				ELSE
					LSch_contr = "3"
				ENDIF			
			ENDIF
			IF LNnatu_cli =  1		&& REVENDEDOR
				LSch_contr = "4"
			ENDIF	
			IF LSch_motiv = "4"  && VENDA P/ ENTREGA FUTURA
				LSch_condi = "3"
			ELSE
			    IF LNtp_pgto > 1		&& 2=C/APRES e 3= A PRAZO
					LSch_condi = "2"
				ELSE
					LSch_condi = "1"
				ENDIF
			ENDIF
		**------>>> para IMOBILIZADO // CARCACA E SUCATA
			IF LNmotivo > 4    && 5=IMOBIL // 6=CARAC // 7= SUCATA
				STORE "1"  TO LSch_motiv    && 1=NORMAL
				STORE "3"  TO LSch_condi    && 3=CONDICAO NULA DE PGTO
				STORE "5"  TO LSch_contr    && 5=CONTRIBUINTE NULO
			ENDIF
			DO CASE
				CASE LNmotivo = 5
					STORE "2"     TO LSch_produ  && 2=IMOBILIZADO		
				CASE LNmotivo = 6
					STORE "3"     TO LSch_produ  && 3=CARCACA
				CASE LNmotivo = 7
					STORE "4"     TO LSch_produ  && 4=SUCATA
			ENDCASE
		CASE LNnatuOper = 2
			STORE "2"     TO LSch_opera  && 2=TRANSFERENCIA
			STORE "5"     TO LSch_contr  && 5=CONTR. NULO SEM EFEITO NA
			STORE "3"	  TO LSch_condi  && 3=CONDICAO NULA SEM EFEITO OPER.
			STORE "1"     TO LSch_motiv  && 1=TRANSFERENCIA NORMAL
			STORE STR(LNmotivo,1)  TO LSch_produ && VALIDO P/ OPCAO 1 e 2
			IF LNmotivo = 3
			   STORE "5"  TO LSch_produ    && 5=MAT.DE USO SERVICO
		    ELSE
				IF LNmotivo = 4
				   STORE "6"  TO LSch_produ    && 6=MAT.DE CONSUMO
				ENDIF
			ENDIF
		
			SELE empresa
			SEEK LNemp          && EMPRESA NO PAPEL DE PARAMETRO
			IF empresa.estado = LSUFdestino
				LSch_desti = "1"   && ESTADUAL
			ELSE
				LSch_desti = "2"   && ITERESTADUAL
			ENDIF
		CASE LNnatuOper = 3
			STORE "3"     TO LSch_opera  && 3=REMESSA
			STORE "5"     TO LSch_contr  && 5=CONTR. NULO SEM EFEITO OPER
			STORE "3"	  TO LSch_condi  && 3=CONDICAO NULA SEM EFEITO OPER.
		    STORE "1"  	  TO LSch_produ  && 1=CONSIDERA SEMPRE MERCADORIA

			DO CASE
				CASE LNmotivo = 1
					STORE "5"     TO LSch_motiv  && 5=CONSIGNACAO
		    	CASE LNmotivo = 2
					STORE "6"  TO LSch_motiv    && 6=DEMONSTRACAO
				CASE LNmotivo = 3
					STORE "2"  TO LSch_motiv    && 2=RECLAMADA
				CASE LNmotivo = 4
					STORE "4"  TO LSch_motiv    && 4=ENTREGA FUTURA
				CASE LNmotivo = 5
					STORE "7"  TO LSch_motiv    && 7=CONSERTO
				CASE LNmotivo = 6
					STORE "8"  TO LSch_motiv    && 8=OUTRAS
			ENDCASE
			SELE empresa
			SEEK LNemp
			IF empresa.estado = LSUFdestino
				LSch_desti = "1"   && ESTADUAL
			ELSE
				LSch_desti = "2"   && ITERESTADUAL
			ENDIF
		CASE LNnatuOper = 4
			STORE "4"     TO LSch_opera  && 4=DEVOLUCAO
			STORE "5"     TO LSch_contr  && 5=CONTR. NULO SEM EFEITO NA OPE
			STORE "3"	  TO LSch_condi  && 3=CONDICAO NULA SEM EFEITO OPER.
		    STORE "1"  	  TO LSch_motiv  &&1=NOR EXCETO P/CONSIG(2)DEMONS(3)
			DO CASE
				CASE LNmotivo < 4
					STORE "1"     TO LSch_produ  && 1=MERCADORIA
					IF LNmotivo = 2
						STORE "5"  	  TO LSch_motiv  && 5=CONSIGNACAO
					ELSE
						IF LNmotivo = 3
							STORE "6"  	  TO LSch_motiv  && 6=DEMONSTRACAO
						ENDIF
					ENDIF
		    	CASE LNmotivo = 4
					STORE "5"  TO LSch_produ    && 5=MAT. USO SERVICO
				CASE LNmotivo = 5
					STORE "6"  TO LSch_produ    && 6=MAT. CONSUMO
				CASE LNmotivo = 6
					STORE "2"  TO LSch_produ    && 2=IMOILIZADO
				CASE LNmotivo = 7
					STORE "7"  TO LSch_produ    && 7=ICMS P/ REEMBOLSO
				CASE LNmotivo = 8
					STORE "8"  TO LSch_produ    && 8=OUTRAS
				CASE LNmotivo = 9
					STORE "1"  TO LSch_produ    && 1=MERC.COMERCIAL
					STORE "6"  TO LSch_contr    && 6=CONS.INSC.REG.ACORDO
			ENDCASE
			SELE empresa
			SEEK LNemp
			IF empresa.estado = LSUFdestino
				LSch_desti = "1"   && ESTADUAL
			ELSE
				LSch_desti = "2"   && ITERESTADUAL
			ENDIF
			SELECT tipooper
	  ENDCASE
 	  SELECT tipooper
	  SET ORDER TO tpopera
	  SEEK 'S'+LSch_opera+LSch_produ+LSch_motiv+;
				  LSch_desti+LSch_contr+LSch_condi
	ENDIF
	IF !FOUND()
		WAIT WINDOW ;
		"A OPERACAO NAO PODE SER CLASSIFICADA. CHAME SUPORTE...<<ENTER>>"
		LFretorno	= 	.f.
		LStipo = "???"
	ELSE
		LFretorno	= 	.t.
		LSch_opera	=	tipooper.ch_opera
		LSch_produ	=	tipooper.ch_produ
		LSch_motiv	=	tipooper.ch_motiv
		LSch_desti	=	tipooper.ch_desti
		LSch_contr	=	tipooper.ch_contr
		LSch_condi	=	tipooper.ch_condi
		LStipo		=	tipooper.tipo
	ENDIF
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJQ9           ORnewclas_oper VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   10  ╨
*       ╨ Variable:            ORnewclas_oper                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      9                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjq9     &&  ORnewclas_oper VALID
#REGION 1
RETURN

FUNCTION ORnewclas_oper
	PARAMETERS LNemp, LNosi

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Classificar a operacao comercial permitindo
	*			a atribuicao do TIPO
	*------------------------------------------------------------*
	* COMENTARIO..: Todas operacoes realizadas tem uma classificacao
	*			que servira DE ORIENTACAO para todos processos reali-
	*			zados, como TRIBUTACAO, BAIXA ESTOQUE, RESERVA, FATU-
	*			RAMENTO .....
	*				Esta CLASSIFICAO permite a orientacao do processo
	*			a ser realizado....
	*				A classificacao leva em consideracao as caracteris-
	*			ticas da :
	*					-OPERACAO(venda,transferenci,..)
	*					-CLIENTE(contribuinte,destino,...)
	*					-COMERCIAL(prazo,...)
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*	Dados do Orcamento Trabalhados na Classifica┤фo	
	*		Eempresa..........: Empresa em operacao
	*		Natu_Oper.........: Indica Natureza da Operacao
	*							1-Venda ou Compra
	*							2-Transferencia
	*							3-S.Remessa
	*							4-Devolucao
	*							5-Requisicao
	*							6-NF.Entrada
	*		Motivo...........: Conforme a Natureza
	*                         Ver vetor VTLmotivo em SCGC2.PRG
	*		EXEMPLO
	*	CASE m.natu_oper = 1
	*		VTLmotivo(1) = "Normal         "
	*		VTLmotivo(2) = "Reclamada      "
	*		VTLmotivo(3) = "Complemento    "
	*		VTLmotivo(4) = "Entrega Futura "
	*		VTLmotivo(5) = "Imobilizado    "
	*		VTLmotivo(6) = "Carcacas       "
	*		VTLmotivo(7) = "Sucatas        "
	*		VTLmotivo(8) = "Outras         "
	*		VTLmotivo(9) = "               "
	*	CASE m.natu_oper = 2
	*		VTLmotivo(1) = "Mercadoria Comercial  "
	*		VTLmotivo(2) = "Bens Imobilizados     "
	*----------------------------------------------------------------*
	*		Estado(Destino)..: UF do Cliente
	*					
	*		Tp_Inscr.........: Tipo de Inscricao do Cliente
	*						1=ISENTO
	*						2=INSCRITO
	*		Natu_cli.....: Natureza do Cliente
	*						0= VAREJO
	*						1= REVENDA
	*						3= P.PUBLICO
	*						4= FROTA
	*		Tp_parcela......: Tipo de Parcelamento Proposto
	*						1= A VISTA
	*						2= PARCELADO NO CHEQUE
	*						3= PARCELADO NO DUPLICATA
	*						4= PARCELADO NO CARTAO
	*		Tipo.........: Tipo Informado Diretamente para
	*						completar a classificacao
	*
	*
	*------------------------------------------------------------*
	*  RETORNO.....:  TIPO DEFINIDO + Grava Classifica┤фo no Proprio
	*              Orcamento Indicado Pelo Parametro
	*------------------------------------------------------------*
	* EXEMPLO : SCGC2.PRG
	*			OBJ_ITOR.SCR
	*			=W_DEFPROC("ORCAMENT.spr")
	*			=ORnewclas_oper(EMPRESA,ORCAMENTO)
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LNnatuOper,LNmotivo,;
	    LSUFdestino,LNtp_inscr,LNnatu_cli,;
		LNTp_parcela,;
		LSch_opera,LSch_produ,LSch_motiv,LSch_desti,LSch_contr,LSch_condi
	PRIVATE LSalias
	PRIVATE	LFempresa,LForcamento,LFtipooper,LFclienc

	LSalias = ALIAS()

	*--------------------------------------------------------
	LFempresa		= NetArq("empresa")
	LForcamento		= NetArq("orcament")
	LFtipooper		= NetArq("tipooper")
	LFclienc		= NetArq("clienc")
	*--------------------------------------------------------
    IF (LFempresa+LForcamento+LFtipooper+LFclienc) > 100000
		DO OBJ_MENS.SPR WITH;
		   Chr(13)+"  Houve Falha na Abertura de Tabelas"+;
		   " para Classificar Orcamento "+STR(LNosi,6)+chr(13)+chr(13)+;
		   "       CLASSIFICACAO NAO EFETUADA."
	    DO ULFchclas_oper
		RETURN(.f.)
	ENDIF
	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
		DO OBJ_MENS.SPR WITH ;
			Chr(13)+"  Orcamento "+STR(LNosi,6)+;
			" Nao Foi Localizado."+chr(13)+chr(13)+;
			"       CLASSIFICACAO NAO EFETUADA."
	    DO ULFchclas_oper
		RETURN(.f.)
	ENDIF
	IF !REGLOCK()
		DO OBJ_MENS.SPR WITH ;
			Chr(13)+"Nao Foi Possivel Bloquer Orcamento "+STR(LNosi,6)+;
			" Para Processo."+chr(13)+chr(13)+;
			"       CLASSIFICACAO NAO EFETUADA."
	    DO ULFchclas_oper
		RETURN(.f.)
	ENDIF
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
		DO OBJ_MENS.SPR WITH ;
			Chr(13)+"  Dados do Cliente (CLIENC) "+STR(LNosi,6)+;
			" Nao Foram Localizadoa."+chr(13)+chr(13)+;
			"       CLASSIFICACAO NAO EFETUADA."
	    DO ULFchclas_oper
		RETURN(.f.)
	ENDIF

		
	*------------------------------------------------------------*
	LNnatuOper  = orcament.natu_oper
	LNmotivo 	= orcament.motivo
    LSUFdestino = clienc.estado
    LNtp_inscr  = clienc.tp_inscr
    LNnatu_cli  = clienc.natu_cli
    LNTp_parcela   = orcament.Tp_parcela
    LStipo      = "???"
	*------------------------------------------------------------*

	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp

	DO CASE

		CASE (LNnatuOper = 1 AND LNmotivo = 8) OR ;
		   (LNnatuOper = 2 AND LNmotivo = 5) OR ;
		   (LNnatuOper = 3 AND LNmotivo = 6) OR ;
		   (LNnatuOper = 4 AND LNmotivo = 8) OR ;
		   (LNnatuOper = 5) OR (LNnatuOper = 7)
			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+orcament.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

		*CASE clienc.seguimento = 2  ;
		*     AND empresa.estado $ "BA/GO/MA/MS/PB/PA/PE/RN/SE/DF/" ;
		*     AND clienc.estado $ "BA/GO/MA/MS/PB/PA/PE/RN/SE/DF/" ;
		*     AND clienc.estado <> empresa.estado
		*	 SELECT tipooper
 		*	 SET ORDER TO TAG tipo
		*	 SEEK 'S'+"VCI"
		*	 IF !FOUND()
		*		SEEK 's'+"VCI"
		*	 ENDIF
		*  em 19/01/2007 incluiu AL/MT

		CASE clienc.seguimento = 2  and orcament.data > {30.08.2007} ;
		     AND empresa.estado $ ;
		        "BA/GO/MA/MS/PB/PA/PE/RN/SE/DF/AL/MT/RJ/RS/TO/RO" ;
		     AND clienc.estado $  ;
		        "BA/GO/MA/MS/PB/PA/PE/RN/SE/DF/AL/MT/RJ/RS/TO/RO" ;
		     AND clienc.estado <> empresa.estado

			 SELECT tipooper
 			 SET ORDER TO TAG tipo
			 SEEK 'S'+"VCI"
			 IF !FOUND()
				SEEK 's'+"VCI"
			 ENDIF


		CASE clienc.seguimento = 2  ;
		     AND empresa.estado $ "BA/GO/MA/MS/PB/PA/PE/RN/SE/DF/AL/MT" ;
		     AND clienc.estado $  "BA/GO/MA/MS/PB/PA/PE/RN/SE/DF/AL/MT" ;
		     AND clienc.estado <> empresa.estado

			 SELECT tipooper
 			 SET ORDER TO TAG tipo
			 SEEK 'S'+"VCI"
			 IF !FOUND()
				SEEK 's'+"VCI"
			 ENDIF
	
		OTHERWISE
		  	DO CASE
				CASE LNnatuOper = 1
					STORE "1"     TO LSch_opera  && 1=VENDA 		
					STORE "1"     TO LSch_produ  && 1=PROD.E SERV COMERCIAL
					STORE STR(LNmotivo,1)  TO LSch_motiv
											&& 1=NORMAL 2=RECLAMADA
											&& 3=COMPLEMENTO 4=ENTRGA FUTU.		

					IF empresa.estado = LSUFdestino
						LSch_desti = "1"   && ESTADUAL
						LSch_contr = "1"   && CONSUMIDOR ESTADUAL				
					ELSE
						LSch_desti = "2"   && ITERESTADUAL
						IF LNtp_inscr = 1
							LSch_contr = "2"
						ELSE
							LSch_contr = "3"
						ENDIF			
					ENDIF
					IF LNnatu_cli =  1		&& REVENDEDOR
						LSch_contr = "4"
					ENDIF	
					IF LSch_motiv = "4"  && VENDA P/ ENTREGA FUTURA
						LSch_condi = "3"
					ELSE
					    IF LNTp_parcela > 1		&& >1 => PARCELADO
						    IF LNTp_parcela = 6		&& 6 = VENDOR = A VISTA
								LSch_condi = "1"
							ELSE
								LSch_condi = "2"
							ENDIF
						ELSE
							LSch_condi = "1"
						ENDIF
					ENDIF
				**------>>> para IMOBILIZADO // CARCACA E SUCATA
					IF LNmotivo > 4    && 5=IMOBIL // 6=CARAC // 7= SUCATA
						STORE "1"  TO LSch_motiv && 1=NORMAL
						STORE "3"  TO LSch_condi && 3=CONDICAO NULA DE PGTO
						STORE "5"  TO LSch_contr    && 5=CONTRIBUINTE NULO
					ENDIF
				DO CASE
					CASE LNmotivo = 5
						STORE "2"     TO LSch_produ  && 2=IMOBILIZADO		
					CASE LNmotivo = 6
						STORE "3"     TO LSch_produ  && 3=CARCACA
					CASE LNmotivo = 7
						STORE "4"     TO LSch_produ  && 4=SUCATA
				ENDCASE

			CASE LNnatuOper = 2
				STORE "2" TO LSch_opera  && 2=TRANSFERENCIA
				STORE "5" TO LSch_contr  && 5=CONTR. NULO SEM EFEITO NA
				STORE "3" TO LSch_condi  && 3=CONDICAO NULA SEM EFEITO OPER.
				STORE "1" TO LSch_motiv  && 1=TRANSFERENCIA NORMAL
				STORE STR(LNmotivo,1) TO LSch_produ && VALIDO P/ OPCAO 1 e 2
				IF LNmotivo = 3
				   STORE "5"  TO LSch_produ    && 5=MAT.DE USO SERVICO
			    ELSE
					IF LNmotivo = 4
					   STORE "6"  TO LSch_produ    && 6=MAT.DE CONSUMO
					ENDIF
				ENDIF
		
				SELE empresa
				SET ORDER TO TAG empresa
				SEEK LNemp          && EMPRESA NO PAPEL DE PARAMETRO
				IF empresa.estado = LSUFdestino
					LSch_desti = "1"   && ESTADUAL
				ELSE
					LSch_desti = "2"   && ITERESTADUAL
				ENDIF
			CASE LNnatuOper = 3
				STORE "3" TO LSch_opera  && 3=REMESSA
				STORE "5" TO LSch_contr  && 5=CONTR. NULO SEM EFEITO OPER
				STORE "3" TO LSch_condi  && 3=CONDICAO NULA SEM EFEITO OPER.
			    STORE "1" TO LSch_produ  && 1=CONSIDERA SEMPRE MERCADORIA

				DO CASE
					CASE LNmotivo = 1
						STORE "5"     TO LSch_motiv  && 5=CONSIGNACAO
		    		CASE LNmotivo = 2
						STORE "6"  TO LSch_motiv    && 6=DEMONSTRACAO
					CASE LNmotivo = 3
						STORE "2"  TO LSch_motiv    && 2=RECLAMADA
					CASE LNmotivo = 4
						STORE "4"  TO LSch_motiv    && 4=ENTREGA FUTURA
					CASE LNmotivo = 5
						STORE "7"  TO LSch_motiv    && 7=CONSERTO
					CASE LNmotivo = 6
						STORE "8"  TO LSch_motiv    && 8=OUTRAS
				ENDCASE
				SELE empresa
				SET ORDER TO TAG empresa
				SEEK LNemp
				IF empresa.estado = LSUFdestino
					LSch_desti = "1"   && ESTADUAL
				ELSE
					LSch_desti = "2"   && ITERESTADUAL
				ENDIF
			CASE LNnatuOper = 4
				STORE "4" TO LSch_opera  && 4=DEVOLUCAO
				STORE "5" TO LSch_contr  && 5=CONTR. NULO SEM EFEITO NA OPE
				STORE "3" TO LSch_condi  && 3=CONDICAO NULA SEM EFEITO OPER.
			    STORE "1" TO LSch_motiv  &&1=NOR EXCETO P/CONSIG(2)DEMONS(3)
				DO CASE
					CASE LNmotivo < 4
						STORE "1"     TO LSch_produ  && 1=MERCADORIA
						IF LNmotivo = 2
							STORE "5"  	  TO LSch_motiv  && 5=CONSIGNACAO
						ELSE
							IF LNmotivo = 3
								STORE "6"  TO LSch_motiv  && 6=DEMONSTRACAO
							ENDIF
						ENDIF
			    	CASE LNmotivo = 4
						STORE "5"  TO LSch_produ    && 5=MAT. USO SERVICO
					CASE LNmotivo = 5
						STORE "6"  TO LSch_produ    && 6=MAT. CONSUMO
					CASE LNmotivo = 6
						STORE "2"  TO LSch_produ    && 2=IMOILIZADO
					CASE LNmotivo = 7
						STORE "7"  TO LSch_produ    && 7=ICMS P/ REEMBOLSO
					CASE LNmotivo = 8
						STORE "8"  TO LSch_produ    && 8=OUTRAS
					CASE LNmotivo = 9
						STORE "1"  TO LSch_produ && 1=MERC.COMERCIAL
						STORE "6"  TO LSch_contr && 6=CONS.INSC.REG.ACORDO
				ENDCASE
				SELE empresa
				SET ORDER TO TAG empresa
				SEEK LNemp
				IF empresa.estado = LSUFdestino
					LSch_desti = "1"   && ESTADUAL
				ELSE
					LSch_desti = "2"   && ITERESTADUAL
				ENDIF
				SELECT tipooper
		  ENDCASE
	 	  SELECT tipooper
		  SET ORDER TO tpopera
		  SEEK 'S'+LSch_opera+LSch_produ+LSch_motiv+;
				  LSch_desti+LSch_contr+LSch_condi
	ENDCASE

	IF !FOUND()
		WAIT WINDOW ;
		"A OPERACAO NAO PODE SER CLASSIFICADA. CHAME SUPORTE...<<ENTER>>"
		LFretorno	= 	.f.
		LStipo = "???"
	ELSE
		LFretorno	= 	.t.
		LSch_opera	=	tipooper.ch_opera
		LSch_produ	=	tipooper.ch_produ
		LSch_motiv	=	tipooper.ch_motiv
		LSch_desti	=	tipooper.ch_desti
		LSch_contr	=	tipooper.ch_contr
		LSch_condi	=	tipooper.ch_condi
		LStipo		=	tipooper.tipo
	ENDIF
	*------------------------------------------------------------*
	SELE orcament
    m.tipo		= 	LStipo
	*----------------------------------------------------------*
	*     Ajuste das Informa┤Дes do Orcamento Vinculadas ao TIPO
	* e Que Pode Sofrer Altera┤фo ao se Alterar o TIPO
	*----------------------------------------------------------*
	*    Caso o Tipo da Opera┤фo Nфo Aceite Informar a Aliq. ICMS
	* Ser═ assumida a Aliq. Determinada No Tipo. Caso Contrario
	* ser═ Considerada a Aliq. Informada no Orcamento
	*----------------------------------------------------------*
	IF m.tipo = "???" OR tipooper.info_icms = "N"
		m.aliq_icms = tipooper.aliq_icms
	ELSE
		m.aliq_icms = orcament.aliq_icms
	ENDIF			
	IF m.tipo <> orcament.tipo OR m.aliq_icms <> orcament.aliq_icms
		*---------------------------------------------------------*
		*     Devido a mudaca de tipo, condicoes ou dados do cliente
		*  a OSI deve ser recalculada. Para indicar esta necessidade
		* FLGTRASAC = .f. .  Este artificio evita que a OSI seja
		* recalculada durante a edicao dos itens onde serao recalcu-
		* lados os itens do arq. TEMPORARIO em edicao, evitando perda
		* de tempo.
		*     A OSI nao deve sofrer nehum tipo de processo enquato
		* o FLGTRANSAC = .F. com excessao da edicao dos itens que
		* obrigara o recalculo e convertera o FLGTRANSAC = .T.
		*     As rotinas de RESERVA,IMPOSI,ENV.P/FAT,FATURAMENTO,
		* LIBERACAO,CANC OSI NAO PODEM SER EXECUTADAS COM
		* FLGTRANSAC = .F. .
		*     Na entrada da edicao dos itens o flag e verificado
		* e se necessario recalcula a OSI.
		*     Na saida dos itens por gravacao o flag ASSUME .T. pois
		* os itens do arq. temporario que esta sendo gravado ja estao
		* reprocessados
		*---------------------------------------------------------*
		m.flgtransac = .F.
		*---------------------------------------------------------*
	ELSE
		m.flgtransac = orcament.flgtransac
	ENDIF


	*------------------------------------------------------------*
	SET FIELDS TO dtregis, hregis, usrregis,deletado
    SET FIELDS TO tipo,aliq_icms,flgtransac
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------*
	DO ULFchclas_oper
RETURN(LFretorno)

PROCEDURE ULFchclas_oper
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("orcament" ,LForcament)
	=UP_fecha("tipooper" ,LFtipooper)
	=UP_fecha("clienc" ,LFclienc)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJQA           ORdef_tribut VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   11  ╨
*       ╨ Variable:            ORdef_tribut                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      10                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*


FUNCTION _42s11gjqa     &&  ORdef_tribut VALID
#REGION 1
RETURN

FUNCTION ORdef_tribut
	PARAMETERS LNemp,LSCdgProduto,LNorcament,;
			LNalq_icms,LNalq_ipi,LNalq_iss,LNalq_rdu,;
			LScfo,LScst,LNtp_mercad,LNiva
	*------------------------------------------------------------*
	* obs: Esta Rotina Esta Trabalhando co Parametros Desnecessarios
	* apartire dom momento que a reestrutura┤фo de ORCAMENT E ORCATMP
	* forem ao ar
	* ex: Chamada em SCD0400.SPR
	*			=ORdef_tribut((orcament.empresa),(tmpitem.codigo),;
	*					(orcament.orcamento),;
	*					m.aliq_icms,m.aliq_ipi,m.aliq_iss,;
	*				    m.cfo,m.cst,m.tp_mercad,m.iva)
	*   Os Parametros com (0) Sфo desnecessarios
	*         Anota┤фo feita em 21/08/2000
	*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Definir as caracteristicas TRIBUTARIAS E
	*			OPERACIONAIS para um produto
	*------------------------------------------------------------*
	* COMENTARIO..: Os itens apresentam caracteristicas que devem
	*			ser reconhecidas durante os processos. Esta rotina
	*			identifica estas caracteristicas.
	*               Outro ponto e que apartir de alteracoes da
	*            imlementadas apartir de 07/2000, os itens de um
	*            mesmo orcamento podem apresentar CFOs diferentes
	*            Como esta rotina e ativada para cada item que esta
	*			 sendo processado ┌ possivel tratar o CFO diferenciado
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LSCdgProduto...: Codigodo Produto em Questao
	*		LNorcament.....: Orcamento
	*------------------------------------------------------------*
	*  RETORNO.....:
	*			LNalq_icms,LNalq_ipi,LNalq_iss,LNalq_rdu,
	*			LScfo,LScst,LNtp_mercad,LNiva
	*------------------------------------------------------------*
	* EXEMPLO : OBJ_ITOR
	*		 	ORrecalc_item
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
    PRIVATE LSalias

	LSalias = ALIAS()
	*------------------------------------------------------------*
	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*

	=W_DEFPROC("tributar.spr")

    =TRpct_trib(LNemp, LNorcament, LSCdgProduto, ;
	    LNiva, LNalq_ipi, LNtp_mercad, LScst,;
    	LNalq_iss, LNalq_rdu, LNalq_icms, LScfo)

		



	*=W_DEFPROC("tributar.spr")
    *LNtp_mercad = TRDef_TpMercad((LNemp),(LNorcament),(LSCdgProduto))

	*=W_DEFPROC("tributar.spr")
    *LScfo = TRGet_CFO((LNemp),(LNorcament),(LSCdgProduto))

	*=W_DEFPROC("tributar.spr")
    *LNalq_icms  = TRGet_IcmsAlq((LNemp),(LNorcament))

	*=W_DEFPROC("tributar.spr")
	*LNalq_rdu   = TRGet_rduIcms((LNemp),(LNorcament))

	*=W_DEFPROC("tributar.spr")
	*LNalq_iss = TRGet_ISSAlq((LNemp))


	*=W_DEFPROC("tributar.spr")
    *LNiva     = TRGet_IVA((LNemp),(LSCdgProduto))

	*=W_DEFPROC("tributar.spr")
    *LNalq_ipi = TRGet_IpiAlq((LNemp),(LNorcament),(LSCdgProduto))

	*=W_DEFPROC("tributar.spr")
    *LScst     = TRGet_CST((LNemp),(LNorcament),(LSCdgProduto),(LScst))

	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.t.)


****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJRM           ORprzmedio VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   12  ╨
*       ╨ Variable:            ORprzmedio                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      11                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjrm     &&  ORprzmedio VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
FUNCTION ORprzmedio
	PARAMETER LSprazo,LNjuromes,LNnumpgt, LNprazomedio,LNtaxa

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Calcular o Numero de Pagamentos, Prazo Medio
	*          e a Taxa de Juros
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*     EM 22/08/2000 foi Criada ORprzmedio Que Deve Substituir
	* UAprzmedio em SCGC2.PRG e cuja principal diferenca e retornar
	* os valore nos parametros
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LSprazo.......: STRING "000/030/060" BASE P/ PROCESSO
	*		LNjuromes.....: JUROS MENSSAIS
	*
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:
	*				-LNnumpgt......:
	*				-LNprazomedio..:
	*               -LNtaxa........:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SVD0400.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*-----------------------------------------------------------*
	PRIVATE	LNocorrenc,LNposic,LNdias,LNinicio,LNprzacm

	LNocorrenc   = 1
    LNposic      = 0
	LNdias	     = 0
    LNinicio     = 1
    LNprzacm     = 0
    LNnumpgt   	 = 0
	LNprazomedio = 0
	LNtaxa		 = 0

	DO WHILE .t.
        LNposic = AT("/",LSprazo, LNocorrenc)
        LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))

   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
			EXIT
		ENDIF

		IF LNdias = 0 AND LNnumpgt > 0
	        LNnumpgt   = LNnumpgt
		ELSE
	        LNnumpgt   = LNnumpgt + 1
		ENDIF
        LNprzacm   = LNprzacm  + INT(VAL(SUBS(LSprazo,LNinicio,3)))
		LNocorrenc = LNocorrenc + 1
        LNinicio   = LNposic + 1
	ENDDO
	IF LNnumpgt <> 0
	    LNprazomedio = LNprzacm / LNnumpgt
	ENDIF
	

	IF LNjuromes = 0 OR LNprazomedio = 0
    	LNtaxa = 0
    ELSE
       	LNtaxa = ROUND((LNjuromes / 30) *LNprazomedio,2)
	ENDIF
	
	*----------------------------------------------------------*
RETURN(.T.)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJRT           ORcalc_vlres VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   13  ╨
*       ╨ Variable:            ORcalc_vlres                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      12                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gjrt     &&  ORcalc_vlres VALID
#REGION 1
RETURN

FUNCTION ORcalc_vlres
	PARAMETERS LNpreco,LNqtde,LNdesc,LNdscAdicional,;
			LNtaxa, LNprc_final,LNvlrvenda,	LSinformado
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Calcular Valores Comerciais  TRIBUTARIAS E
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*			LNpreco......: Preco em Tabela
	*			LNqtde.......:
	*			LNdesc.......: Desconto
	*			LNdscAdicional: Valor disponivel para injetar como
	*							desconto. Exemplo valor de bonus
	*                           (┌ alterado retornado com o valor
	*							efetivamente usado para desconto
	*							uma vez que o disponivel pode ser
	*							superior ao valor da operacao)
	*			LNtaxa.......: Taxa de Juros
	*			LNvlrvenda...: Valor atual
	*			LSinformado..: Indica quais dados Informados
	*------------------------------------------------------------*
	*  RETORNO.....:
	*			LNprc_final,LNvlrvenda
	*------------------------------------------------------------*
	* EXEMPLO : OBJ_ITOR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LNauxVlr
	PRIVATE LNtmpdif
	*------------------------------------------------------------*
	DO CASE
		CASE LSinformado ="DADO PRECO e DESCONTO"
		     LNauxVlr = ;
		     	ROUND((LNpreco-ROUND(LNpreco * LNdesc / 100,2))*LNqtde,2)
		     LNauxVlr = ;
		     		LNauxVlr+ROUND(LNauxVlr* ROUND(LNtaxa / 100,4),2)
			*------------------------------------------------------------*
			*   Qdo a diferenca do valor anterior p/ o novo for so questao
			* de arredondamento (<= 0.02) nao considerar novo calculo
			* MOTIVO : Os vendedores arredondam os precos e o recalculo do
			*		sistema os forcaria a redigitar os precos
			*------------------------------------------------------------*
			 LNtmpdif = ABS(LNvlrvenda  - LNauxVlr)

	
			 IF LNtmpdif > 0.50	OR  (LNauxVlr <= 1 AND LNtmpdif > 0.02)

			 *IF LNtmpdif > 0.50	OR  LNauxVlr  = 0
			     LNvlrvenda  = LNauxVlr
				 IF LNqtde > 0
					 LNprc_final= ROUND(LNauxVlr / LNqtde,2)
					 LNvlrvenda = LNprc_final * LNqtde	&& calc.arredondado
				 ELSE
					 LNprc_final  = LNauxVlr
				 ENDIF
			ENDIF

		CASE LSinformado ="DADO PRECO FINAL (PRECOFINAL)"
		     LNauxVlr  = LNpreco
		     LNauxVlr  = LNauxVlr + ROUND(LNauxVlr * ROUND(LNtaxa/ 100,4),2)
		     LNperct   = LNauxVlr - LNprc_final
			 IF LNauxVlr <> 0
			     LNdesc = ROUND(ROUND(LNperct * 100,2) / LNauxVlr,2)
				 IF LNpreco < 0.20
					LNdesc 	= 0
					LNpreco  	= LNprc_final
				 ENDIF
			 ELSE
			     LNdesc = 0
			     LNpreco    = LNprc_final
			 ENDIF
			 *--==============================>>> CALC. DESCONTO REAL
			 LNvlrvenda  = LNprc_final * LNqtde

		CASE LSinformado ="DADO VALOR FINAL (VLRVENDA)"
			 DO OBJ_ALER.SPR WITH "Opcao Desativada."
			 =uperrosys()

	ENDCASE
	*----------------------------------------------------------------*
	*  Aplicacao do Desconto Adicional
	*----------------------------------------------------------------*


	*----------------------------------------------------------------*
RETURN(.T.)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJS1           ORrecalc_OSI VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   14  ╨
*       ╨ Variable:            ORrecalc_OSI                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      13                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjs1     &&  ORrecalc_OSI VALID
#REGION 1
RETURN

PROCEDURE ORrecalc_OSI
	PARAMETERS LNemp,LNorcament
	*------------------------------------------------------------*
	*  CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	*  OBJETIVO.......: Reclassificar, Recalcular e Retributar itens
	*				de um orcamento que sofreu  alteracoes
	*------------------------------------------------------------*
	*  COMENTARIO.....:
	*------------------------------------------------------------*
	*  OBS............:
	*------------------------------------------------------------*
	*  TABELAS.......:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LNorcamento:
	*		LFobriga...:
	*					 .F. => Nao obriga o Recalculo se nao houver
	*							diferencas
	*					 .T. => Obriga Recalculo Independednte de
	*							haver diferencas
	*-------------------------------------------------------------*
	*		
	*		LSinformado..: Assume PADRAO "DADO PRECO e DESCONTO"
	*                   entre as opcoes abaixo
	*		
	*						"DADO PRECO e DESCONTO"
	*						"DADO PRECO FINAL (PRECOFINAL)"
	*						"DADO VALOR FINAL (VLRVENDA)"
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*
	*------------------------------------------------------------*
	* CHAMADAS : ORatlz_clie
	*			 SCGC2.PRG   - (BTN_VAL2) / (UArotfat)
	*			 SCGC201.SCR - (CAD_BTN) / (PREP_FAT)
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	
	*------------------------------------------------------------*
	PRIVATE LSalias
	PRIVATE LForcament,LForcatmp

	LSalias = ALIAS()
	PRIVATE LNbs_TRIBUTAR		&& BASE PARA TIBUTAR
	PRIVATE LDdtpesq			&& PARA PESQUISA DE BASE IPI TRANSD

	LForcament		= NetArq("orcament")
	LForcatmp		= NetArq("orcatmp")
	*--------------------------------------------------------
    IF (LForcamento+LForcatmp) > 100000
	    DO FCHrecalc_osi
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	SELE orcament
	SET ORDER TO orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)	
	IF !FOUND()	  OR 	(LEFT(orcament.situacao,1) $ "OZ"))
		DO FCHrecalc_osi
		RETURN(.f.)
	ENDIF

	SELECT  orcatmp
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	SET NEAR OFF
	IF LNemp <> orcatmp.empresa OR LNorcament <> orcatmp.orcamento
		DO FCHrecalc_osi
		RETURN(.t.)				&& NAO EXISTEM ITENS GRAVADOS => OK
	ENDIF

    WAIT WINDOW "Os itens serao RECALCULADOS !!!!!!.  <ENTER>"

	*----------------------------------------------------------*
	*		Atualizar ORCATMP com dados alterados
	*----------------------------------------------------------*
    SELE orcatmp
	**************	PARA RECALCULAR VALORES ************
	*--------------------------------------------------------------*
	*  Este laco grava nos itens os dados que podem ter sido altera-
	* dos e que podem ter implicado em alteracao da classificaca
	*		ex: CODIGO  NAO E ALTERADO
	*			TIPO    PODE TER SIDO ALTERADO
	*			NATU_CLI .....
	*-------------------------------------------------------------*
	*-------    VARIAVEIS SERAO REDEFINIDAS NESTA ROTINA  ----*
	*---------------------------------------------------------*
	DO WHILE !EOF() AND LNemp  = orcatmp.empresa;
					 AND LNorcament	= orcatmp.orcamento
		*----------------------------------------------------------*
		=W_DEFPROC("ORCAMENT.SPR")
		=ORrecalc_item((LNemp),(LNorcament),(orcatmp.codigo),;
					 (orcatmp.ordem))
		*----------------------------------------------------------*
		SELE orcatmp
		SKIP
	ENDDO
	*-----------------------------------------------------------------*
	=ORsoma_orc(LNemp,LNorcament)
	*-----------------------------------------------------------------*
	DO FCHrecalc_osi
RETURN(.T.)


PROCEDURE FCHrecalc_osi
	=UP_fecha("orcament",LForcament)
	=UP_fecha("orcatmp" ,LForcatmp)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJS2           ORrecalc_item VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   15  ╨
*       ╨ Variable:            ORrecalc_item                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      14                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gjs2     &&  ORrecalc_item VALID
#REGION 1
RETURN

FUNCTION ORrecalc_item
	PARAMETERS  LNemp,LNorcament,LScdgprod,LNordem,LSinformado

	*------------------------------------------------------------*
	*  CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	*  OBJETIVO.......: Reclassificar, Recalcular e Retributar um
	*				item do orcamento que sofreu  alteracoes
	*------------------------------------------------------------*
	*  COMENTARIO.....:
	*------------------------------------------------------------*
	*  OBS............:
	*------------------------------------------------------------*
	*  TABELAS.......:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LNorcament.:
	*		LScdgprod..:
	*		LNordem....:
	*------------------------------------------------------------*
	*		LSinformado..: Indica quais dados Informados para orientar
	*						o calculo
	*----------------------------------------------------------*
	*  LSinformado	= "DADO PRECO e DESCONTO"  && Esta opcao em que
	* este era valor assumido independente de ser ou nao uma importacao
	* foi desativada em 30/12/2000 em funcao de servi┤os da IDL em que
	* o desconto vem conrrompido. por isso passou-se a adotar o
	* calculo a partir do preco final
	*----------------------------------------------------------*
	*		
	*		NA IMPORTACAO
	*				LSinformado..:
	*					Assume PADRAO "DADO PRECO FINAL (PRECOFINAL)"
	*                   	entre as opcoes pois o preco ja vem definido
	*                       desta forma o preco final deve ser mantido e
	*                       ajuste ocorre em relacao ao desconto
	*
	*
	*
	*
	*		NA OPERACAO NORMAL DE REGISTRO DE OSI
	*
	*		LSinformado..: Assume PADRAO "DADO PRECO e DESCONTO"
	*                   	entre as opcoes neste caso o juros e prazo
	*						afetam o calculo preco final
	*		
	*						"DADO PRECO e DESCONTO"
	*						"DADO PRECO FINAL (PRECOFINAL)"
	*						"DADO VALOR FINAL (VLRVENDA)"
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* CHAMADAS : ORrecalc_OSI
	*			 SCGC008.PRG - IMPORTACAO DADOS
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	*  ALGUMAS ROTINAS DE REGISTRO DA VENDA NAO FORAM AJUSTDAS PARA
	* PASSAR PARAMETROS SENDO ASSIM ASSUME "DADO PRECO e DESCONTO"
	
	IF TYPE("LSinformado") <> "C"
			LSinformado = "DADO PRECO e DESCONTO"
	ENDIF
	PRIVATE LSalias
	PRIVATE LForcament, LForcatmp, LFclienc
	LSalias = ALIAS()
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LForcatmp		= NetArq("orcatmp")
	LFclienc		= NetArq("clienc")
	LFtipooper		= NetArq("tipooper")
	*--------------------------------------------------------
    IF (LForcamento+LForcatmp+LFclienc+LFtipooper) > 100000
	    DO FCHitemrecalc
		RETURN(.f.)
	ENDIF

	SELE orcament
	SET ORDER TO orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)	

	STORE 0  TO  m.tp_parcela,m.prazomedio,m.taxa

	STORE 0  TO m.aliq_icms,m.aliq_ipi,m.aliq_rdu
	STORE 0  TO m.aliq_iss, m.tp_mercad, m.iva
	STORE "" TO m.cfo



***	STORE "" TO m.cst

    IF TYPE("m.cst") = "U"
  	   STORE "" TO m.cst
  	ENDIF



	*---------------------------------------------------------*


	SCATTER MEMVAR FIELDS aliq_icms,aliq_ipi,aliq_rdu

	SELE clienc
	SET ORDER TO emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)	

	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+orcament.tipo
	IF !FOUND()
			SEEK 's'+orcament.tipo
	ENDIF

	SELE ORCATMP
	SET ORDER TO TAG orcacodigo
	SEEK STR(LNemp,3)+STR(LNorcament,6)+LScdgprod+STR(LNordem,2)

	=REGLOCK(.T.)
	GATHER MEMVAR FIELDS aliq_icms,aliq_ipi,aliq_rdu

	m.aliq_icms  =  orcament.aliq_icms	&& GERAL INFORMADA
	m.aliq_ipi   =  orcament.aliq_ipi	&& GERAL INFORMADA
	m.aliq_rdu   =  orcament.aliq_rdu
	*----------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	=ORdef_tribut((LNemp),(orcatmp.codigo),;
		(orcament.orcamento),m.aliq_icms,;
		m.aliq_ipi,m.aliq_iss,m.aliq_rdu,m.cfo,m.cst,m.tp_mercad,m.iva)

	*----------------------------------------------------*
	m.preco 	= orcatmp.preco
	m.clas_cms 	= orcatmp.clas_cms

	*----------------------------------------------------------*
	SELE orcatmp
	GATHER MEMVAR FIELDS aliq_icms,aliq_ipi,aliq_iss,aliq_rdu,;
                   cfo,cst,preco,clas_cms
	*-----------------------------------------------------*
	m.preco		= orcatmp.PRECO
	m.desconto	= orcatmp.DESCONTO
	m.precofinal= orcatmp.PRECOFINAL
	m.vlrvenda  = orcatmp.VLRVENDA
	m.desc_adici= orcatmp.DESC_ADICI
	*----------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	=ORcalc_vlres(m.preco,(orcatmp.qtde),m.DESCONTO,m.desc_adici,;
			(orcament.taxa),m.precofinal,m.vlrvenda,LSinformado)
	SELE orcatmp
	GATHER MEMVAR FIELDS preco,desconto,desc_adici,precofinal,vlrvenda
	*----------------------------------------------------------*
	STORE 0 TO m.base_iss,m.vlr_iss,m.base_calc,;
		m.vlr_icms,m.base_isent,m.base_sbbrt,m.base_subs,;
		m.icms_subs,m.base_outr,m.base_ipi,m.vlripi,m.base_isipi,;
		m.bsbr_icms
	*----------------------------------------------------------*
    *    O Numero maximo de parametros passados a uma UDF e 24
    * o vTParam aplia essa condicao (mas por questoes de facilidade o
    * vetor so e utilizado para completar os parametros excedentes)
	*----------------------------------------------------------*

	dimension vTParam[ 7 ]
	vTParam[01] = m.base_ipi
	vTParam[02] = m.vlripi
	vTParam[03] = m.base_isipi
	vTParam[04] = m.bsbr_icms
	vTParam[05] = clienc.seguimento
	vTParam[06] = m.vlr_issrtd
	vTParam[07] = clienc.subst_iss




	=W_DEFPROC("TRIBUTAR.SPR")
	=TRcalc_tribu((LNemp),(orcament.tipo),(cst),(vlrvenda),(tp_mercad),;
		(aliq_iss),(aliq_icms),(aliq_ipi),(aliq_rdu),(iva),(data),;
		(clienc.estado),(qtde),(orcatmp.codigo),;
		m.base_iss,m.vlr_iss,m.base_calc,;
		m.vlr_icms,m.base_isent,m.base_sbbrt,m.base_subs,;
		m.icms_subs,m.base_outr, vTParam)

	m.base_ipi   = vTParam[01]
	m.vlripi     = vTParam[02]
	m.base_isipi = vTParam[03]
	m.bsbr_icms  = vTParam[04]
	m.vlr_issrtd = vTParam[06]

	*----------------------------------------------------------*

	SELE orcatmp
	GATHER MEMVAR FIELDS base_iss,vlr_iss,base_calc,;
		vlr_icms,base_isent,base_sbbrt,base_subs,;
		icms_subs,base_outr,base_ipi,vlripi,base_isipi,bsbr_icms,;
		vlr_issrtd
	*----------------------------------------------------------*
    DO FCHitemrecalc
RETURN(.T.)



PROCEDURE FCHitemrecalc
	=UP_fecha("orcament" ,LForcament)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("orcatmp" ,LForcatmp)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJSM           ORsoma_orc VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   16  ╨
*       ╨ Variable:            ORsoma_orc                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      15                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjsm     &&  ORsoma_orc VALID
#REGION 1
RETURN

PROCEDURE ORsoma_orc
	PARAMETERS LNemp,LNorcament,;
    		 LNvalor,LNiss,LNicms,LNipi,LNsubs,LNtot,;
    		         LNbsiss,LNbsicms,LNbsipi,LNbssubs,;
         			 LNbsisent,LNbsoutr	

	*------------------------------------------------------------*
	*  CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	*  OBJETIVO.......: Totaliza Valores do Orcamento e atribui
	*				ao Orcamento (GRAVA)
	*------------------------------------------------------------*
	*  COMENTARIO.....:
	*------------------------------------------------------------*
	*  OBS............:
	*------------------------------------------------------------*
	*  TABELAS.......:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LSorcamento:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* CHAMADAS : SCGC2.PRG - (BTN_VAL2) / (UArotfat)
	*			 SCGC201.SCR - (CAD_BTN) / (PREF_FAT)
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LSalias
	LSalias = ALIAS()
	PRIVATE LNbs_TRIBUTAR		&& BASE PARA TIBUTAR
	PRIVATE LDdtpesq			&& PARA PESQUISA DE BASE IPI TRANSD
	PRIVATE LForcament,LForcatmp
	LForcament		= NetArq("orcament")
	LForcatmp		= NetArq("orcatmp")
	*--------------------------------------------------------
    IF (LForcamento+LForcatmp) > 100000
		DO FCHsoma_osi
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
    STORE 0 TO LNvalor,LNiss,LNicms,LNipi,LNsubs,LNtot
	STORE 0 TO LNbsiss,LNbsicms,LNbsipi,LNbssubs
	STORE 0 TO LNbsisent,LNbsoutr	
	*------------------------------------------------------------*
	SELE orcament
	SET ORDER TO orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)	
	IF !FOUND() OR (LEFT(orcament.situacao,1) $ "OZ")) OR !REGLOCK()
		DO FCHsoma_osi
		RETURN(.F.)
	ENDIF

	SELECT  orcatmp
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		DO FCHsoma_osi
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------*
	DO WHILE !EOF() AND LNemp = orcatmp.empresa;
					AND LNorcament	= orcatmp.orcamento
					
		IF !left(orcatmp.situacao,1) $ "YykeZ"
			IF ORCAMENT.CH_OPERA = "1"
				LNvalor	= 	LNvalor + orcatmp.vlrvenda - orcatmp.vlripi
			ELSE
				LNvalor	= 	LNvalor + orcatmp.vlrvenda
			ENDIF			
			
			LNbsiss		=	LNbsiss	+	orcatmp.base_iss
			LNbsicms	=	LNbsicms+	orcatmp.base_calc
			LNbsipi		=	LNbsipi	+	orcatmp.base_ipi
			LNbssubs	=	LNbssubs+	orcatmp.base_subs
			LNbsisent	=	LNbsisent+	orcatmp.base_isent
			LNbsoutr	=	LNbsoutr+	orcatmp.base_outr
			

			LNiss   	= 	LNiss   + orcatmp.vlr_iss
			LNicms		=   LNicms  + orcatmp.vlr_icms
			LNipi		=   LNipi   + orcatmp.vlripi
			LNsubs		=   LNsubs  + orcatmp.icms_subs
		ENDIF
        skip
    ENDDO
	LNtot  = LNvalor + m.LNsubs + orcament.vlrfrete + ;
	 					orcament.vlrseguro + LNipi
	*------------------------------------------------------------*
	SELE orcament
	REPLACE orcament.valor 	WITH LNtot
	*------------------------------------------------------------*
	DO FCHsoma_osi
RETURN(.T.)

PROCEDURE FCHsoma_osi
	=UP_fecha("orcament",LForcament)
	=UP_fecha("orcatmp" ,LForcatmp)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJSV           ORSelimp_osi VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   17  ╨
*       ╨ Variable:            ORSelimp_osi                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      16                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gjsv     &&  ORSelimp_osi VALID
#REGION 1
RETURN

FUNCTION ORSelimp_osi
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Selecional OSI que Sera  Impressa
	*------------------------------------------------------------*
	* COMENTARIO..: Serve para agregar as chamadas para
	*			  reservas feitas em SCGC201 e SCGC201A
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LForcament,LFclienc,LFclientes,LFliberacao
	PRIVATE LSalias
	LFind_cop   = .F.  && INDICA QUE A OSI E UMA COPIA
	LFalt_sit	= .f.  && INDICA A ULreg_osi se a sit ja pode ser alterada
	LFind_imp 	= .f.  && INDICA se houve impr.de itens p/ que atualiza no
					   && vias
	LFind_can 	= .f.  && INDICA que a osi esta sendo cancelada

	*------------------------------------------------------------*
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()
	*------------------------------------------------------------*

	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFclientes		= NetArq("clientes")
	LFliberacao		= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFclienc+LFclientes+LFliberacao) > 100000  && HOUVE FALHA ABERT
		DO FCHSelimp_osi
		RETURN
	ENDIF
	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH "IL", "E"	 && SITUACOES EM ORDEM										&& CRESCENTE
	*------------------------------------------------------------*
	IF LASTKEY() = 27
		DO FCHSelimp_osi
		RETURN
	ENDIF
	CLEAR TYPEAHEAD


	*----------------------------------------------------------*
	* POR CONTA DO PROJETO SPED-FISCAL NAO SERA ACEITO
	* CLIENTE SEM CPF/CNPJ E SEM MUNICIPIO VALIDO
	*----------------------------------------------------------*
	

	LValida = .t.
	=W_DEFPROC("CLIENC.SPR")
	IF CNVldaCPFCNPJ(orcament.empresa,orcament.orcamento) <> .t.
		=UPbeeps;
		(.F.,"Deve ser Informado CPF ou CNPJ Valido na OSI. <ENTER>")
		LValida = .f.
	ENDIF


	=W_DEFPROC("CLIENC.SPR")
	IF CNVldaMunicipio(orcament.empresa,orcament.orcamento) <> .t.
		=UPbeeps;
		(.F.,"Deve ser Informado MUNICIPIO-UF Valido na OSI. <ENTER>")
		LValida = .f.
	ENDIF


	=W_DEFPROC("CLIENC.SPR")
	IF CNVldaMunicipio(orcament.empresa,orcament.orcamento) <> .t.
		=UPbeeps;
		(.F.,"Deve ser Informado MUNICIPIO-UF Valido na OSI. <ENTER>")
		LValida = .f.
	ENDIF


	=W_DEFPROC("CLIENC.SPR")
	IF CNIBGENaoCadastrado(orcament.empresa,orcament.orcamento) <> .t.
		=UPbeeps;
		(.F.,"Deve ser Informado Municipio com COIGO IBGE Valido. <ENTER>")
		LValida = .f.
	ENDIF



	*----------------------------------------------------------*


	IF orcament.flgtransac = .f.
		DO OBJ_MENS.SPR WITH " O orcamento Selecionado Sofreu" +;
		" Alteracoes que Afetam Valores e Nao Foi Recalculado." +;
		CHR(13)+;
		" Reedite os Itens e Grave para Forcar o Calculo."
		LValida = .f.
	ENDIF

	IF RIGHT(orcament.situacao,1) = "F"
		WAIT WINDOW "Orc.com cred. bloq..Nao aceita esta operacao."
		LValida = .f.
	ENDIF


	IF RIGHT(orcament.situacao,1) = "D"
		WAIT WINDOW "OSI. Aguardando Liberacao de Credito. "
		LValida = .f.
	ENDIF
	IF RIGHT(orcament.situacao,1) = "H"
		WAIT WINDOW ;
			"Liberacao em outras Condicoes de Credito. Ver <8-Lib.CR>"
		LValida = .f.
	ENDIF


	IF LValida = .f.
		DO FCHSelimp_osi
		RETURN(.F.)
	ENDIF




    SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(orcament.empresa,3)+STR(orcament.orcamento,6)
	IF !FOUND() OR liberaco.situacao <> "LIBE"
		WAIT WINDOW ;
			"Nфo Conta Libera┤фo de Credito Para OSI"
		DO FCHSelimp_osi
		RETURN
	ENDIF

	SELE orcament

	*================>>>> FICA BLOQUEADO ATE FTURAMENTO COMPLETAR .
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(orcament.empresa,3)+STR(orcament.orcamento,6)

	SELE clientes
	SET ORDER TO TAG cliente
	SEEK clienc.cliente
	IF (orcament.tp_parcela > 1 ) AND ;
		(clienc.cliente = 0 OR !FOUND("CLIENTES"))
		*------------------------------------------------------------*
		*   Nфo Serao aceitas vendas Parcelado CHEQUE ou DUPLICATA
		*	sem cadastro do cliente
		*------------------------------------------------------------*
		IF orcament.empresa <> 1 OR orcament.tp_parcela = 2 ;
			OR orcament.tp_parcela = 3
			WAIT WINDOW "Solicite o Cadastramento do Cliente .<ENTER> "
		**  SO AVISAR MAS EMITIR OSI
		**	DO FCHSelimp_osi
		**	RETURN
		ENDIF
	ENDIF

	SELE orcament

	*******************************************************************
	*        2o  - IMPRIME OSI
	*******************************************************************

	=W_DEFPROC("ORCAMENT.SPR")
	=ORimp_osi((orcament.empresa),(orcament.orcamento),"EMISSAO NORMAL OSI")
	DO FCHSelimp_osi
	UNLOCK ALL
RETURN

PROCEDURE FCHSelimp_osi
	=UP_fecha("orcament" ,LForcament)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("clientes" ,LFclientes)
	=UP_fecha("liberaco" ,LFliberacao)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	POP KEY 			&& reabilita teclas de atalho def. anteriormente
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJT5           ORimp_osi VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   18  ╨
*       ╨ Variable:            ORimp_osi                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      17                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjt5     &&  ORimp_osi VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------------------------------------------*
* FUNCTION ORimp_osi && IMPRESSAO DA OSI
* FUNCTION ORreg_osi && REGISTRA A IMPRESSAO DA OSI PARA O ITEM
*------------------------------------------------------------*

FUNCTION ORimp_osi
	PARAMETERS LNemp,LNorcamento,LSmotivo
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Imprimir OSI
	*------------------------------------------------------------*
	* COMENTARIO..: Imprime OSI NORMAL como O CANCELAMENTO
	*			 		-O processo inclui :
	*						-IMPRESSA DA OSI
	*						-ALTERACAO DA SITUACAO DOS ITENS
	*						CONFORME A OPERACAO (EMISS/CANCELA)
	*						-ALTERACAO DA SITUACAO DA CAPA DO
	*						ORCAMENTO
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LNorcamento....: Numero do Orcamento para Processar
	*		LSmotivo.......: Motivo da Impressao da OSI
	*			LSmotivo = "EMISSAO NORMAL OSI"
	*			LSmotivo = "CANCELAMENTO OSI"
	*			LSmotivo = "COPIA OSI"
	*------------------------------------------------------------*
	*  RETORNO.....: .T.	OSI IMPRESSA
	*				 .F.	PROBLEMAS NAS IMPRESSAO DA OSI
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LFimp_Ok    && Flag para indicar se houve falha ao tentar
						&& mudar a situacao do item que ┌ feita no
						&& comando REPORT relosi2

	PRIVATE LFalt_sit 	&& PARM p/ ROTINA ORreg_osi INDICA PROC NORMA P/
						&& SITUACAO
	PRIVATE LFind_canc	&& PARA /p ROTINA ORreg_osi INDICA PROC DE
						&& CANCELAMENTO
	PRIVATE LFind_cop   && INDICA QUE A OSI E OU NAO E UMA COPIA

	PRIVATE LSsituacao  && STRING COM AS SITUACOES QUE DEVEM SER ENGLOBADAS
						&& NA IMPRESSAO DOS ITENS

	PRIVATE LForcament,LForcatmp,LFclienc,LFusuario,LFtransprt,LFtipooper

	*-----------------------------------------------------------*
	LFimp_Ok	= .t.
	LFind_cop 	= .F.  && INDICA QUE A OSI E UMA COPIA
	LFalt_sit 	= .f.  && INDICA A ULreg_osi se a sit ja pode ser alterada
	LFind_canc 	= .f.  && INDICA que a osi esta sendo cancelada
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LForcatmp		= NetArq("orcatmp")
	LFclienc		= NetArq("clienc")
	LFusuario		= NetArq("usuario")
	LFtransprt		= NetArq("transprt")
	LFtipooper		= NetArq("tipooper")
	LFgrupo			= NetArq("grupo")
	*--------------------------------------------------------
    IF (LForcament+LForcatmp+LFclienc+LFusuario+LFtransprt) > 100000
		DO FCHimp_osi
		RETURN(.f.)
	ENDIF

    IF (LFtipooper+LFgrupo) > 100000
		DO FCHimp_osi
		RETURN(.f.)
	ENDIF

	*-----------------------------------------------------------*
	DO CASE
		CASE LSmotivo = "EMISSAO NORMAL OSI"
			LFalt_sit  = .T.   && ROT. ORreg_osi deve alterar campo situacao
			LFind_canc = .F.   && nao e processo de cancelamento
			LFind_cop   = .F.  && INDICA QUE A OSI NAO E UMA COPIA
			LSsituacao	= "Ik"
		CASE LSmotivo = "CANCELAMENTO OSI"
			LFalt_sit  = .T.   && ROT. ORreg_osi deve alterar campo situacao
			LFind_canc = .T.   && nao e processo de cancelamento
			LFind_cop   = .F.  && INDICA QUE A OSI NAO E UMA COPIA
			LSsituacao	= "Ik"
		CASE LSmotivo = "COPIA OSI"
			LFalt_sit  = .T.   && ROT. ORreg_osi deve alterar campo situacao
			LFind_canc = .T.   && nao e processo de cancelamento
			LFind_cop   = .T.  && INDICA QUE A OSI E UMA COPIA
			LSsituacao	= "MY"
	ENDCASE

	*--------------------------------------------------------------------*
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("tmp",2)
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi
	*--------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	IF !FOUND()
		WAIT WINDOW "No OSI nao Localizado Para Impressao.. <ENTER>"
		DO FCHimp_osi
		RETURN(.F.)
	ENDIF
	IF !REGLOCK()
	   WAIT WINDOW "Orcamento em uso em outro ponto. Tente novamente."
	   DO FCHimp_osi
	   RETURN(.f.)
	ENDIF

	SELE tipooper
	SET ORDER TO TAG tipo
	SEEK "S"+orcament.tipo
	IF !FOUND()
		SEEK "s"+orcament.tipo
	ENDIF

	SELE clienc
	SET ORDER TO TAG emporca
	

	SELE usuario
	SET ORDER TO TAG usuario

	SELE transprt
	SET ORDER TO TAG CGC

	SELE grupo
	SET ORDER TO TAG codigo
	
	SELE orcatmp
	SET ORDER TO TAG ORCAMENTO
	SET RELATION TO  codigo  INTO grupo

	*********************************
	SELE orcatmp
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	SET NEAR OFF
	*********************************
	*------------------------------------------------------------*
	*  INICIA GERACAO DE ARQUIVO TEMPORARIO
	*------------------------------------------------------------*
	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "TMP" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
		DO FCHimp_osi
		RETURN(.F.)
 	ENDIF		
	WAIT WINDOW ;
		"AGUARDE. Gerando Arq. Temporario.<TECLADO> = Interrompe " NOWAIT
	SELE orcatmp
	**********************************************************************
	*	SITUACAO :
	*           I => RESERVADO AGUARDAND IMPRESSAO
	*           k => FOI CANCELADA A RESERVA MAS NAO EMITIU OSI
	*  TODOS SAO ENVOLVIDOS PARA PERMITIR QUE MESMO SE O PROCESSO FOR INTER_
	*  ROMPIDO, A PROXIMA EXECUCAO FIQUE INTEGRA
	**********************************************************************
	COPY TO &LSarqtmp  FIELDS empresa,orcament.tipo, orcamento,codigo,;
					  grupo.classifica,qtde,;
					  descricao,descrcompl,ordem, ;
					  orcament.hodom,tipooper.movestq,SITUACAO ;
				FOR  (LEFT(orcatmp.situacao,1) $ LSsituacao) ;
				WHILE LNorcamento = orcatmp.orcamento ;
							AND LNemp = orcatmp.empresa
	SELE 0
	USE &LSarqtmp   ALIAS LARQtmp EXCL
	INDEX ON orcamento TAG orcamento ADDITIVE

	*------------------------------------------------------------*
	*    O numero de itens a osi (12) e completado para forcar o
	* relatorio RELOSI a passar em todas as linhas detalhe e
	* permitir a impressao de dados adicionas que acompanham estas
	* linhas (EX:  NRO.OSI/DATA/VEICULO/PLACA/ODOM/OBS)
	*------------------------------------------------------------*
	LNtot_reg = reccount()
	LNlimite  = CEILING(LNtot_reg / 12) * 12  && PROXIMO INTEIRO
	DO WHILE LNtot_reg < LNlimite
		APPEND BLANK
		=REGLOCK(.T.)
		REPLACE ORCAMENTO WITH LNorcamento && FORCA O REGISTRO PARA FICAR
									       && APOS OS REGISTROS REAIS
		LNtot_reg = LNtot_reg + 1
	ENDDO
	GO TOP
	*********************************
	SELE orcament
	SET ORDER TO TAG ORCAMENTO
	SET RELATION TO  ORCAMENTO INTO LARQtmp
	SET RELATION TO  OPERADOR INTO USUARIO ADDITIVE
	SET RELATION TO  TRANSP INTO TRANSPRT  ADDITIVE
	SET RELATION TO  STR(EMPRESA,3)+STR(ORCAMENTO,6) INTO CLIENC ADDITIVE

	SET SKIP TO LARQtmp

	SET POINT TO ","
	SET SEPARATOR  TO "."

	LNreginicio = RECNO()

	*---------------------------------------------------------------*
	ON ERROR
	REPORT FORM relosi2 ;
				WHILE orcament.orcamento = LNorcamento  AND ;
				ORreg_osi(LFimp_Ok,LFalt_sit,LFind_can) ;
					   NOCONSOLE TO PRINTER
	ON ERROR DO UPerrosys

	*--------------------------------------------------------------*
	*	Alterar situacao dos itens
	*--------------------------------------------------------------*
	SELECT orcament
	GO LNreginicio
	*---------------------------------------------------------------*
	SELE LARQtmp
	USE
	SELE orcament
	*---------------------------------------------------------------*
	****  SO PARA FECHAR ARQUIVO P/ IMP

	IF !(EMPTY(ALLTRIM(wp_impestq)))
		LNmtmp =UPnometmp("tpm",2)
		RUN &wp_impestq > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtestq
	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	**************                          ************************
	SELECT orcament
	GO LNreginicio
	********
	IF LFimp_Ok = .t.
		=REGLOCK(.T.)
		DO CASE
			CASE  LSmotivo = "EMISSAO NORMAL OSI" ;
			   OR LSmotivo = "COPIA OSI"
					REPLACE situacao with "M "
			CASE LSmotivo = "CANCELAMENTO OSI"
				REPLACE situacao with "Y "   	&& OSI CANCELADA
				REPLACE dt_fat   WITH wp_dtoper	&& FICA COMO DT CANCELAMENTO
		ENDCASE
		REPLACE vias_osi WITH orcament.vias_osi + 1
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
	ENDIF
	***************************
	*------------------------------------------------------------*
	DO FCHimp_osi
	KEYBOARD CHR(4)
RETURN(.T.)

*----------------------------------------------------------*

FUNCTION ORreg_osi		&& REGISTRA A IMPRESSAO DA OSI PARA O ITEM
PARAMETERS LFimp_Ok,LFalt_sit, LFind_can

	PRIVATE LSalias
	PRIVATE LFretorno

	LFretorno   = .t.
	LFimp_Ok	= .t.
	IF EMPTY(LARQtmp.codigo) 	&& LINHA DE PREENCHIMENTO PARA COMPLETAR
								&& 12 LINHA POR OSI(APPEND  BLANK)
								&& DA ROTINA ORimp_osi
		RETURN(.T.)				
	ENDIF

	IF LFalt_sit		&& = .T. altere a sit. p/ evitar dupla impressao
		LSalias = alias()
    	SELECT orcatmp
		SET ORDER TO orcacodigo
		SEEK STR(LARQtmp.empresa,3) +;
		     STR(LARQtmp.orcamento,6) + LARQtmp.codigo + ;
		     STR(LARQtmp.ordem,2)
		IF FOUND()
			=REGLOCK(.T.)
			DO CASE
				CASE LFind_can = .t. OR LEFT(LARQtmp.situacao,1) = "k"
					REPLACE orcatmp.situacao with "Y"
				OTHERWISE
					REPLACE orcatmp.situacao with "M "
			ENDCASE
			REPLACE imp_via WITH orcament.vias_osi
			LFretorno 	= .t.
		ELSE
			LFretorno 	= .f.
			LFimp_Ok	= .F.
		ENDIF
		SELE &LSalias
	ENDIF
RETURN(LFretorno)

PROCEDURE FCHimp_osi
	=UP_fecha("orcament",LForcament)
	=UP_fecha("orcatmp" ,LForcatmp)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("usuario" ,LFusuario)
	=UP_fecha("transprt" ,LFtransprt)
	=UP_fecha("tipooper" ,LFtipooper)
	=UP_fecha("grupo" ,LFgrupo)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJTK           ORgrvavisolib VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   19  ╨
*       ╨ Variable:            ORgrvavisolib                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      18                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjtk     &&  ORgrvavisolib VALID
#REGION 1
return
*---------------------------------------------------------------*
FUNCTION ORgrvavisolib
	PARAMETERS LNorcamento
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Gravar em Arq. TMP o numero do orcamento que
	*			deve ser avisado a carteira para liberar credito
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNorcamento....: Nro do Orcamento para registrar Aviso
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LSfile			&& NOME DO ARQ. QUE CONTEM A HORA DA
							&& ULTIMA LIBERACAO
	PRIVATE LNctrl			&& NUMERO DO ARQ. DADO PELO S.Operacional

	LSfile = wp_dirtmp+"CTRLLIBE.TXT"
	LNctrl = FOPEN(LSfile,2)
	IF LNctrl = -1
		LNctrl = FCREATE(LSfile,0)
	ENDIF
	IF LNctrl <> -1
		LStmplib = FSEEK(LNctrl,0,0)
		LStmplib = FWRITE(LNctrl,STR(LNorcamento,6))
		=FCLOSE(LNctrl)
	ENDIF
RETURN(.t.)


****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJTL           ORleravisolib VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   20  ╨
*       ╨ Variable:            ORleravisolib                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      19                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjtl     &&  ORleravisolib VALID
#REGION 1
return
*---------------------------------------------------------------*
FUNCTION ORleravisolib
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: LER em Arq. TMP o numero do orcamento que
	*			deve ser avisado a carteira para liberar credito
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*				LNnro_orc...: NUMERO DO ORCAMENTO PARA LIBERAR
	*------------------------------------------------------------*
	* EXEMPLO .....: FUNCAO UPprotege em ROTINAS.SPR
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LSfile			&& NOME DO ARQ. QUE CONTEM A HORA DA
							&& ULTIMA LIBERACAO
	PRIVATE LNctrl			&& NUMERO DO ARQ. DADO PELO S.Operacional
	PRIVATE LStmpmsg	
	PRIVATE LNnro_orc
	*------------------------------------------------------------*
	LNnro_orc	= 0

	LSfile = wp_dirtmp+"CTRLLIBE.TXT"
	LNctrl = FOPEN(LSfile,2)
	IF LNctrl = -1
		LNctrl = FCREATE(LSfile,0)
	ENDIF
	IF LNctrl <> -1
		LStmplib = FSEEK(LNctrl,0,0)
		LStmplib = FGETS(LNctrl,6)
		IF LStmplib <> "999999"
			LSmsg = "Orcamento Aguadando Liberacao ......["+LStmplib+"]"
			LNnro_orc	= INT(VAL(LStmplib))

			LStmplib = FSEEK(LNctrl,0,0)
			LStmplib = FWRITE(LNctrl,"999999")
			=FCLOSE(LNctrl)
			=UPbeeps(.T.,LSmsg,2,600)
		ENDIF
	ENDIF
	=FCLOSE(LNctrl)
RETURN(LNnro_orc)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJTM           ORTenta_Liberar VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   21  ╨
*       ╨ Variable:            ORTenta_Liberar                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      20                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjtm     &&  ORTenta_Liberar VALID
#REGION 1
RETURN

FUNCTION ORTenta_Liberar
	PARAMETERS LNemp,LNosi



	=W_DEFPROC("EMPRESA.SPR")
	LSCnsltCrdt = EMGetFieldValue(wp_empresa,"CNSLT_CRDT")


    IF LSCnsltCrdt = "S"   && USAR NOVA ROTINA XML

        =ORXMLTenta_Liberar(LNemp,LNosi)

        RETURN(.T.)
    ENDIF








	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Verificar Condicoes de Credito do Cliente
	*------------------------------------------------------------*
	* COMENTARIO..: Apos a edicao dos itens e na reserva as condi-
	*			coes do orcamento sao avaliadas com objetivo de
	*			liberara a venda atraves do campo SITUACAO
	*
	* 	&& usada para prever mudanca de situacao na reserva e
	*	&& no retorno da edicao dos itens
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp.......: Empresa em questao
	*		LNosi.......: Nro do Orcamento em questao
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*
	PRIVATE LDdt_libera		&& Retorna a Data de liberacao
	PRIVATE LNlim_libera	&& Retorna o valor a praso liberado
	PRIVATE LNlmt_parcela	&& Retorna se Existe Limitacao para Duplcat
	PRIVATE LNlim_prazo		&& Retorna o usuario (neste caso o SISTEMA=0)
	PRIVATE LSsit			&& Retorna a situacao Definida pelo Processo
	PRIVATE LNtp_parcela
	
	PRIVATE LSalias
	PRIVATE LForcament,LFclienc
	*-----------------------------------------------------------*
	LSalias	= ALIAS()

	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFliberacoes	= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFclienc+LFliberacoes) > 100000
		DO FCHtenta_lib
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHtenta_lib
		RETURN(.F.)
	ENDIF
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
		DO FCHtenta_lib
		RETURN(.F.)
	ENDIF

	SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(LNemp,3)+STR(LNosi,6)

	LSsit = orcament.situacao
	*------------------------------------------------------------*
	*	Condicoes de Liberacao :
	*						a - Imediata
	*						b - Conforme Informacoes
	*
	*------------------------------------------------------------*
	DO CASE
		CASE RIGHT(LSsit,1) = "F"
			*-------------------------------------------------*
			* Situacao = "F" && CREDITO BLOQUEADO SO SERA TRATADO
			*	 DIRETAMENTE PELA OCAO <8-Lib.Cred> e nao
			* automaticamente
			*-------------------------------------------------*
		CASE orcament.tp_parcela = 1 	&& A Vista
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO

		CASE orcament.tp_parcela = 4
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO
									  	 &&  Vendas em cartao sao liberadas
									  	 && sem verificacao
		CASE FOUND("liberaco") ;
			AND orcament.valor 		<= liberaco.limite ;
			AND orcament.prazomedio	<= liberaco.prazomedio ;
			AND orcament.tp_parcela = liberaco.tp_parcela
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO
									  	 &&  Permanecendo as mesmas
									  	 && condicoes da ultima liberacao

		CASE (orcament.lmt_parcela = "S" AND orcament.tp_parcela = 3)
			LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Existe Restricao a venda
									  	 && com duplicata

		CASE ORVer_credito(clienc.cliente,  ;
				orcament.valor - orcament.vlr_ent, 0, 0,;
				    clienc.inscricao) = 0
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO
									  	 &&  Nфo havendo restricoes ao
										 && credito
		OTHERWISE
			LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Nao Existe Dados
									  	 && para liberacao
	ENDCASE

	*------------------------------------------------------------------*
	*	A rotina ORVer_credito desloca os registros de orcament para
	*	pesquisar o debito formado por osis em aberto , por isso e
	*  nescessario reposicionar o orcamento para regravar as codicoes
	*  de liberacao
	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHtenta_lib
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------------*

	SELE liberaco
	IF  RIGHT(LSsit,1) = "E"  && FOI LIBERADO
		m.data 		= 	wp_dtoper
		m.liberador =	0		&& SISTEMA
		m.tp_parcela= 	orcament.tp_parcela
		m.validade	=	wp_dtoper + 30
		m.situacao  =  "LIBE"
		m.limite 	=   orcament.valor - orcament.vlr_ent		
		m.prazomedio=   orcament.prazomedio


		IF FOUND("liberaco")
			IF liberaco.limite > orcament.valor - orcament.vlr_ent		
				m.limite 	= 	liberaco.limite
			ENDIF
			IF liberaco.prazomedio >   orcament.prazomedio
				m.prazomedio=   liberaco.prazomedio
			ENDIF
			=edithand('REGRAVA')
		ELSE
			m.empresa 	= 	orcament.empresa
			m.orcamento	=	orcament.orcamento
			m.limite 	= 	orcament.valor - orcament.vlr_ent		
			m.prazomedio=   orcament.prazomedio
			=edithand('SAVE')
		ENDIF
	ELSE
		m.situacao  =  "BLOQ"
		IF FOUND("liberaco")

			SET FIELDS TO situacao	&& SO ALTERAR CAMPO SITUACAO
									&& OS DEMAIS PERMANECEM
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
		ENDIF
	ENDIF

	SELE orcament
	m.situacao   = LSsit
	SET FIELDS TO situacao, dtregis, hregis, usrregis, deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------------*
	DO FCHtenta_lib

RETURN(.T.)


PROCEDURE FCHtenta_lib
	=UP_fecha("orcament",LForcament)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("liberaco" ,LFliberacoes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJUA           ORimp_orca VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   22  ╨
*       ╨ Variable:            ORimp_orca                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      21                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjua     &&  ORimp_orca VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION ORimp_orca
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Relacao dos itens de OSI
	*------------------------------------------------------------*
	* COMENTARIO..:  Relaciona itens da OSI
	*				Util no caso de OSIs DE CONTROLE INTERNO
	*				TIPO MERCADORIA DANIFICADA E OUTROS
	*
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LNorcamento....: Numero do Orcamento para Processar
	*------------------------------------------------------------*
	*  RETORNO.....: .T.	OSI IMPRESSA
	*				 .F.	PROBLEMAS NAS IMPRESSAO DA OSI
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*------------------------------------------------------------*
	LFalt_sit	= .f.  && INDICA A ULreg_osi se a sit ja pode ser alterada
	LFind_imp 	= .f.  && INDICA se houve impr.de itens p/ que

	PRIVATE LForcament,LForcatmp,LFclienc,LFusuario,LFtransprt
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	*--------------------------------------------------------
    IF (LForcament) > 100000
		DO FCHimp_orca
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH "ABCDEFGHIJKLMNOPQRSTUVXWYZ",.F.
							 && SITUACOES EM ORDEM
							 && CRESCENTE
	*------------------------------------------------------------*

	IF LASTKEY() = 27 OR EOF()
		DO FCHimp_orca
		RETURN(.F.)
	ENDIF
	
	IF m.valor = 0
		IF !fox_alert("Orcamento com VALOR = 0. [ Continua ? ]")
			DO FCHimp_orca
			RETURN(.F.)
		ENDIF
	ENDIF

	LForcatmp		= NetArq("orcatmp")
	LFclienc		= NetArq("clienc")
	LFusuario		= NetArq("usuario")
	LFtransprt		= NetArq("transprt")

	*--------------------------------------------------------*

    IF (LForcatmp+LFclienc+LFusuario+LFtransprt) > 100000
		DO FCHimp_orca
		RETURN(.f.)
	ENDIF

	SELE orcament
	***************  IMPRESSAO OSI  **********************
	IF !(EMPTY(ALLTRIM(wp_imporc)))
		RUN &wp_imporc > \TMP\SAIDA.TXT
	ENDIF
	SET PRINTER TO &wp_prtorc

	SELE clienc
	SET ORDER TO TAG emporca

	SELE transprt
	SET ORDER TO TAG CGC

	SELE orcatmp
	SET ORDER TO TAG ORCAMENTO
	******>>>> INICIO CONTROLE ARQUIVOS
	wl_arqtmp = ""
	LNtmp     = 65		&& TABELA ASCII A = 65
	IF !UPabretmp("tmp")
		WAIT WINDOW "Nao Foi Possivel Abrir Arq. Temporario. <ENTER>"
		DO FCHimp_orca
		RETURN(.F.)
	ENDIF
	******>>>> INICIO CONTROLE LOCAL

	SELECT  orcatmp
	SET ORDER TO TAG  orcamento
	SET NEAR ON
	IF "TIPO" $ KEY()
		SEEK STR(orcament.empresa,3)+LEFT(orcament.tipo,1);
				+STR(orcament.orcamento,6)
	ELSE
		SEEK STR(orcament.empresa,3)+STR(orcament.orcamento,6)
	ENDIF
	SET NEAR OFF
	***
	SET SAFET OFF
	LStmp = "\TMP\"+"&wl_arqtmp"
	COPY TO &LStmp 	WHILE  orcament.empresa = orcatmp.empresa ;
						AND orcament.orcamento = orcatmp.orcamento
	SELE 0
	USE "\TMP\"+"&wl_arqtmp" ALIAS TMPORCA exclu
	INDEX ON STR(EMPRESA,3)+STR(ORCAMENTO,6)  TAG orcamento ADDITIVE
	*-----------------------------------------------------------------*
	*   PREPARAR MODO DE SELECAO
	*-----------------------------------------------------------------*

	SELE orcament
	SET ORDER TO TAG ORCAMENTO
	SET RELATION TO  STR(EMPRESA,3)+STR(ORCAMENTO,6) INTO tmporca
	SET RELATION TO  TRANSP INTO TRANSPRT ADDITIVE
	SET RELATION TO  STR(EMPRESA,3)+STR(ORCAMENTO,6) INTO CLIENC ADDITIVE

	SET SKIP TO tmporca
	SET POINT TO ","
	SET SEPARATOR  TO "."

	LNreginicio = RECNO()
	m.ordem = "A"
	ON ERROR
	REPORT FORM relorca ;
			  WHILE orcament.orcamento = m.orcamento ;
			  AND orcament.empresa = wp_empresa NOCONSOLE TO PRINTER
	ON ERROR DO UPerrosys
	GO LNreginicio
	******************************************************
	SELE tmporca
	use
	SELE orcament
	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		RUN &wp_imposi > \TMP\SAIDA.TXT
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO

	*********************************************************
	SELECT orcament
	GO LNreginicio
	DO FCHimp_orca
	*------------------------------------------------------------*
RETURN(.T.)

PROCEDURE FCHimp_orca
	=UP_fecha("orcament",LForcament)
	=UP_fecha("orcatmp" ,LForcatmp)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("usuario" ,LFusuario)
	=UP_fecha("transprt" ,LFtransprt)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJUL           ORVer_credito VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   23  ╨
*       ╨ Variable:            ORVer_credito                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      22                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gjul     &&  ORVer_credito VALID
#REGION 1
RETURN

FUNCTION ORVer_credito	&& FUNCAO PARA VERIFICACAO DE CREDITO DO CLIENTES
	PARAMETER LNcgc, LNvlr, LNvlrdb, LNvlrorca,PrmInscricao
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Verificar Condicoes de Credito do Cliente
	*------------------------------------------------------------*
	* COMENTARIO..: Apura o saldo da crteira de Cobranca
	*				Apura o valor de orcamentos em aberto para
	*			o cliente sem considerar valores avista ou entradas
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*			LNcgc....: Cliente para Pesquisa
	*			LNvlr....: Valor do Orcamento que se quer atender
	*			LNvlrdb..: Para Retorna Debito em Cobranca
	*			LNvlrorca: Para Retorna Vlr de Orcamentos pendentes
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*			LNretorno = 0 && 0=> Sem Restricoes
	*			LNretorno = 1 && 1=> Consulta nao realizada
	*			LNretorno = 2 && 2=> Sem movimento a + de 12 meses
	*			LNretorno = 3 && 3=> Credito insuficiente
	*			LNretorno = 4 && 4=> Titulo Vencido a Mais de 5 dias
	*			LNretorno = 5 && 5=> Med. Atrazo > 15 dias nas ult.10
	*			LNretorno = 6 && 6=> Orc.abertos + deb superam limite
	*			LNretorno = 7 && 7=> Atualizar Cadastro
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
		=W_DEFPROC("rotinas.spr")

		PRIVATE LSalias



		PRIVATE	LFclientes,LFclienc,LFduplicat,LForcament	
		PRIVATE	LNretorno
		PRIVATE	LN_numdp,LN_dias,LN_med,LN_saldo_dp,LN_ultima10
		PRIVATE LNregosi	&& Nro do registro do orcamento na
							&& entrada da rotina e antes de deslocar
							&& os orcamentos para apurar o valor
							&& de osis em aberto
		PRIVATE LStmp
		
		LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
		*--------------------------------------------------------
		LNretorno 		= 0 && 0=> Sem restricoes
		LNvlrorca 		= 0  && ORCAMENTOS APROVADOS				
		LNvlrdb 		= 0	&& DEBITO ACUMULADO
		*--------------------------------------------------------
		LN_numdp 		= 0	&& NUMERO DE TITULOS
		LN_dias  		= 0    && ACM. DE DIAS DE ATRAZO
		LN_med	 		= 0	&& MEDIA DE ATRAZO POR DUP
		LN_saldo_dp 	= 0	&& SALDO RESTANTE DA DUPLICATA
		LN_ultima10 	= 0 && CONTA AS ULTIMAS 10 DUPLICATAS
		LN_diasAtlzCad  = 0 && Dias da Atualiza┤фo do cadastro
		*--------------------------------------------------------


		LNregosi = 0

		LFclientes		= NetArq("clientes")
		LFduplicat		= NetArq("duplicat")
		LForcament		= NetArq("orcament")
		LFclienc		= NetArq("clienc")

		IF (LFclientes+LFclienc+LFduplicat+LForcament) > 100000
			LNretorno = 1 && 1=> Consulta nao realizada
			DO 	ORfchVer_credito
			RETURN(LNretorno)
		ENDIF
		*--------------------------------------------------------
		SELE orcament
		LNregosi = RECNO()
		*--------------------------------------------------------
		SELE clientes
		SET ORDER TO TAG clie_inscr
		SEEK STR(LNcgc,14)+PrmInscricao
		IF !FOUND()
			LNretorno = 1 && 1=> Consulta nao realizada
			DO 	ORfchVer_credito
			RETURN(LNretorno)
		ENDIF
		*--------------------------------------------------------
		IF EMPTY(clientes.dtliberacd)
			LN_diasAtlzCad = 999999
		ELSE
			LN_diasAtlzCad = date() - clientes.dtliberacd
		ENDIF
		*--------------------------------------------------------

		*--------------------------------------------------------

		SELE duplicat
		SET ORDER TO TAG doc_clie
		SET NEAR ON
		SEEK STR(LNcgc + 1  ,14)  && 1a do proximo cliente
		SET NEAR OFF
		IF EOF()
			GO BOTT
		ELSE
			SKIP -1
		ENDIF
		*--------------------------------------------------------
		*   DETERMINA O VALOR COMPROMETIDO EM ORCAMENTOS
		*--------------------------------------------------------

		SELE orcament
		SET ORDER TO TAG orcamento

		SELE clienc
		SET ORDER TO TAG cliente
		SET NEAR ON
		SEEK LNcgc+1
		SET NEAR OFF
		IF clienc.cliente <>  LNcgc
			SKIP -1
		ENDIF		


		IF clienc.cliente =  LNcgc
			DO WHILE !BOF() AND LNcgc = clienc.cliente

				IF clienc.inscricao = PrmInscricao
					SELE orcament
					SET ORDER TO TAG orcamento
					SEEK STR(clienc.empresa,3)+STR(clienc.orcamento,6)
					IF FOUND() AND !(LEFT(orcament.situacao,1) $ "AOZY")
						LStmp = CHRTRAN(STR(orcament.tp_parcela,2)," ","0")
						IF LStmp $ ("02/03/")  && CHQ.A PRAZO / DUPLICATA
						   LNvlrorca=LNvlrorca+;
						      (orcament.valor-orcament.vlr_ent)
						ENDIF
					ENDIF
				ENDIF
				SELE clienc
				SKIP -1
			ENDDO
		ENDIF
		*--------------------------------------------------------
		SELE duplicat
		DO WHILE !EOF() AND !BOF() AND LNcgc = cliente

			IF EMPTY(DT_PGTO) AND ((wp_dtoper - DT_VENC) > 5)
				LNretorno = 4 && 4=> Titulos vencidos em aberto
			ENDIF

			LN_saldo_dp =vlr_doc - abatimento - desconto - vlr_pgto

			IF !EMPTY(DT_PGTO)		
				IF  LN_ultima10 < 10   && VALIDO P/ ULTIMAS 10 PGAS
					LN_ultima10 = LN_ultima10  + 1	
					LN_numdp= LN_numdp + 1	
					LN_dias = LN_dias + dt_pgto - dt_venc
					LN_med  = LN_dias / LN_numdp
				ENDIF
			ELSE
				LNvlrdb = LNvlrdb + LN_saldo_dp
			ENDIF
			SKIP -1
		ENDDO
		*--------------------------------------------------------
		DO CASE

			CASE clientes.natureza = 0 AND LN_diasAtlzCad > 360
			    && varejo  12 meses
				LNretorno = 7 && 7=> Atualizar Cadastro
			CASE clientes.natureza = 1 AND LN_diasAtlzCad > 90
			    && REVENDA 3 meses


				LNretorno = 7 && 7=> Atualizar Cadastro
			CASE clientes.natureza = 2 AND LN_diasAtlzCad > 180
			    && P PUBLICO 6 meses
				LNretorno = 7 && 7=> Atualizar Cadastro
			CASE clientes.natureza = 3 AND LN_diasAtlzCad > 180
			    && FROTA 6 meses
				LNretorno = 7 && 7=> Atualizar Cadastro


			CASE (wp_dtoper - clientes.ult_atend) > 365
				LNretorno = 2 && 2=> Sem movimento a + de 12 meses

			CASE LNretorno = 4 && 4=> Titulos vencidos em aberto
				LNretorno = 4 && 4=> Titulos vencidos em aberto
			CASE LNvlr > clientes.credito
				LNretorno = 3 && 3=> Credito insuficiente
			CASE LNvlrdb + LNvlr > clientes.credito
				LNretorno = 3 && 3=> Credito insuficiente
			CASE LNvlrdb + LNvlr + LNvlrorca > clientes.credito
				LNretorno = 6 && 6=> Orc.abertos + deb superam limite
			CASE LN_med > 15
				LNretorno = 5 && 5=> Med. Atrazo > 15 dias nas ult.10
		ENDCASE
		*---------------------------------------------------------*
		DO 	ORfchVer_credito
	RETURN(LNretorno)

	PROCEDURE ORfchVer_credito
		SELE orcament
		IF LNregosi > 0
			GO LNregosi
		ENDIF
		=UP_fecha("clientes" ,LFclientes)
		=UP_fecha("clienc" ,LFclienc)
		=UP_fecha("duplicat" ,LFduplicat)
		=UP_fecha("orcament" ,LForcament)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
	RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJUW           ORSelreserva VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   24  ╨
*       ╨ Variable:            ORSelreserva                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      23                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gjuw     &&  ORSelreserva VALID
#REGION 1
RETURN

FUNCTION ORSelreserva
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Selecional OSI que Sera  Reservada
	*------------------------------------------------------------*
	* COMENTARIO..: Serve para agregar as chamadas para
	*			  reservas feitas em SCGC201 e SCGC201A
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")


	PRIVATE LValida
	PRIVATE LSorcament
	PRIVATE LSalias

	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	*--------------------------------------------------------
    IF (LForcament) > 100000  && HOUVE FALHA ABERT
		DO FCHSelReserva
		RETURN
	ENDIF
	*------------------------------------------------------------*

	*------------------------------------------------------------*

	=W_DEFPROC("AUTOPROC.SPR")
	=APTempGeral()

	*------------------------------------------------------------*

	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH "AEFG"	 && SITUACOES EM ORDEM										&& CRESCENTE
	*------------------------------------------------------------*
	IF LASTKEY() <> 27
	

		*----------------------------------------------------------*
	
		CLEAR TYPEAHEAD
		IF RIGHT(orcament.situacao,1) = "F"
			WAIT WINDOW "Orc.com cred. bloq..Nao aceita esta operacao."
		ELSE
			IF orcament.flgtransac = .f.
				DO OBJ_MENS.SPR WITH " O orcamento Selecionado Sofreu" +;
				" Alteracoes que Afetam Valores e Nao Foi Recalculado." +;
				CHR(13)+;
				" Reedite os Itens e Grave para Forcar o Calculo."
			ELSE
				IF fox_alert('Confirma a Reserva de Mercadoria.' )
					*----------------------------------------------------*
					=ORreserva(orcament.empresa,orcament.orcamento)
					*----------------------------------------------------*
				ENDIF
			ENDIF
		ENDIF
	ENDIF
	DO FCHSelReserva
RETURN

PROCEDURE FCHSelReserva
	=UP_fecha("orcament" ,LForcament)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	POP KEY 			&& reabilita teclas de atalho def. anteriormente
	UNLOCK ALL
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJV4           ORSelcancreserva VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   25  ╨
*       ╨ Variable:            ORSelcancreserva                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      24                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gjv4     &&  ORSelcancreserva VALID
#REGION 1
RETURN

FUNCTION ORSelcancr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Selecional OSI que tera a reserva Cancelada
	*------------------------------------------------------------*
	* COMENTARIO..: Serve para agregar as chamadas para cancelamento
	*			de  reservas feitas em SCGC201 e SCGC201A
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias, LForcament
	
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	*--------------------------------------------------------
    IF (LForcament) > 100000  && HOUVE FALHA ABERT
		DO FCHSelCancReserva
		RETURN
	ENDIF
	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH "GI" && SITUACOES EM ORDEM CRESCENTE
	*------------------------------------------------------------*
	IF LASTKEY() <> 27
		CLEAR TYPEAHEAD
		IF fox_alert('Confirma Cancelamento de Reserva ? ')
			*------------------------------------------------------------*
			=ORcancreserva(orcament.empresa,orcament.orcamento)
			*------------------------------------------------------------*
		ENDIF
	ENDIF
	*------------------------------------------------------------*
	DO FCHSelCancReserva
RETURN

PROCEDURE FCHSelCancReserva
	=UP_fecha("orcament" ,LForcament)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	UNLOCK ALL
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJV5           ORreserva VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   26  ╨
*       ╨ Variable:            ORreserva                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      25                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjv5     &&  ORreserva VALID
#REGION 1
RETURN
FUNCTION ORreserva
	PARAMETER LNemp,LNosi
	*------------------------------------------------------------*
	* CLASSIFICACAO:  []
	*------------------------------------------------------------*
	* OBJETIVO....: Controla o Processo de  Reserva
	*			de Uma OSI
	*------------------------------------------------------------*
	* COMENTARIO..: Conforme os parameros passados esta rotina
	*			posiciona no orcaento e controla a reserva
	*			dos itens da osi informada
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*			LNemp.......:  Empresa em Processo
	*			LNosi.......:  Orcamento Originario da Reserva
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias, LForcament, LForcatmp, LFtipooper
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LForcatmp		= NetArq("orcatmp")
	LFtipooper		= NetArq("tipooper")
	*--------------------------------------------------------
    IF (LForcament+LForcatmp+LFtipooper) > 100000  && HOUVE FALHA ABERT
		DO FCHReserva
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
		DO FCHReserva
		RETURN(.F.)
	ENDIF

	IF !REGLOCK()
	   WAIT WINDOW "Orcamento em uso em outro ponto. Tente novamente."
		DO FCHReserva
		RETURN(.F.)
	ENDIF


	SELECT  orcatmp
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(orcament.empresa,3)+STR(orcament.orcamento,6)
	SET NEAR OFF

	IF orcament.empresa <> orcatmp.empresa ;
		OR orcament.orcamento <> orcatmp.orcamento
		DO FCHReserva
		RETURN(.F.)
	ENDIF

	LFflgtrans = .t.
	LFflgreser = .t. 	&& ALTERAR STATUS P/ D=RESERVA
	LFflgretod = .t. 	&& IGNORA CONFIRMACOES POR ITEM
	LFflgretod = .t.    && antes tinha opc.t. e.f.fox_alert
						&& ("Reservar todos ?")
	LNordemmenos = 0    && reordena os itens que ficam abaixo de item
						&& ELIMINADO


	****  && LIBERACAO DE CRED
	SELE orcament
	LNregorc = RECNO()  	&& PARA REPOSICIONAR EM ORCAMENTO
	*---------------------------------------------------------------*
	* 	LSprograma ┌ uma variavel publica recebida como parametro em
	* SVD2 e que identifica a forma de operacao do sistema de
	* faturamento
	*	 	LSprograma = "VENDA"
	*		LSprograma = "BALCAO"
	*		LSprograma = "BALCAO-2"
	*---------------------------------------------------------------*
	IF ("BALCAO" $ LSprograma)  && FATURISTA NAO TESTA CREDITO DO CLIENTE
		*---------------------------------------------------------------*
		=W_DEFPROC("orcament.spr")
		IF !ORTenta_Liberar(orcament.empresa,orcament.orcamento)
			*-----------------------------------------------------*
		   	WAIT WINDOW ;
		   	"Nao foi possivel verificar criterios de liberacao."+;
		   		" Tente novamente."
			DO FCHReserva
			RETURN(.F.)
		ENDIF
	ENDIF
	*-------------------------------------------------------------------*
	* REPOSICIONA ORCAMENT POR CAUSA DE DESLOCAMENTO DE REGST. EM VER_CR
	*-------------------------------------------------------------------*

	SELE orcament
	SET ORDER TO tag orcamento
	GO LNregorc
	IF !REGLOCK()
	   	WAIT WINDOW "Orcamento em uso em outro ponto. Tente novamente."
		DO FCHReserva
		RETURN(.F.)
	ENDIF
	****************************************
	SELECT  orcatmp
	DO WHILE !eof() AND orcament.orcamento = orcatmp.orcamento ;
					AND orcament.empresa  = orcatmp.empresa

	   WAIT WINDOW "ITEM => "+STR(orcatmp.ordem,2) NOWAIT
		************************************************************
		*   SITUACAO :												*
		*		A = > RESERVAR ITEM NOVO							*
		*		y = > ITEM CANCELADO 								*
		*		E = > ALTERAR A RESERVA ANTERIOR					*
		*		e = > ELIMINAR ITEM COM RESERVA DO ORCAMENTO		*
		************************************************************

	   IF LEFT(orcatmp.situacao,1) $ 'AyEeI' 		&& aprov
		  wp_msg = 'Reservar => '+STR(orcatmp.qtde,5)+" "+;
			  		alltrim(orcatmp.codigo)+" "+orcatmp.descricao
		  IF LFflgretod OR fox_alert(wp_msg)
			*----------------------------------------------------------*
		   	PRIVATE LFlockReg
			PRIVATE LFabreAuto
		   	LFlockReg	= .T.	&& BLOQUEAR REGISTRO
		    LFabreAuto	= .F. 	&& NAO ABRIR CONTROLE AUTOMATICAMENTE
			SELE tipooper
			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+orcament.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo  	
			ENDIF

			SELE orcament						
			=W_DEFPROC("ESTOQUE.SPR")
			IF ESversaldo(orcatmp.empresa,orcatmp.codigo ,;
				wp_dtoper,orcatmp.qtde,orcatmp.qtderes,LFabreAuto,;
				LFlockReg,"RESERVA",orcament.hora_fat,tipooper.movestq)
				*------------------------------------------------------*
    		     SELECT orcatmp
        		 IF REGLOCK()
					LSprocesso	= 	""
					DO CASE
						CASE LEFT(orcatmp.situacao,1) $ 'e'
		            		LSprocesso		=  "ELIMINA"
							LNordemmenos = LNordemmenos + 1
						CASE LEFT(orcatmp.situacao,1) $ 'y'
			            	LSprocesso		=	"ANULA"
						CASE LEFT(orcatmp.situacao,1) $ 'I'
						    IF  LNordemmenos > 0
			    	        	LSprocesso	=	"RESERVA"
							ENDIF
						OTHERWISE
			            	LSprocesso	=  "RESERVA"
					ENDCASE
					IF !EMPTY(LSprocesso)
						*------------------------------------------*
						=W_DEFPROC("ORCAMENT.SPR")
						IF !ORprocreserva_item(orcatmp.empresa,;
							orcament.tipo,orcatmp.orcamento,;
							orcatmp.codigo,orcatmp.ordem, LSprocesso)

							LFflgtrans = .F.

	 					ENDIF
						*------------------------------------------*
					ENDIF
    	    	 ELSE
					LFflgtrans = .F.
					*EXIT
	 			 ENDIF
	    	  ELSE
				LFflgtrans = .F.
				*EXIT
	    	  ENDIF
    	  ENDIF
		  UNLOCK
	   ENDIF
       SELECT  orcatmp
	   SET ORDER TO TAG orcamento
	   SKIP
	ENDDO
	WAIT WINDOW " OK !" NOWAIT

	IF LFflgtrans = .F.
		SELE orcament
		IF LEFT(orcament.situacao,1) $ "AG"
		 	m.situacao 	= "G"+RIGHT(orcament.situacao,1)
		 	                     && Aguarda Res Complementar
			SET FIELDS TO dtregis, hregis, usrregis,deletado
			SET FIELDS TO situacao, dt_res, hora_res
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
		ENDIF		
		DO OBJ_MENS.SPR WITH chr(13)+;
				"    Houve falha no Processo de Reserva."+chr(13)+chr(13)+;
				"           Repita o Comando."

		*--------------------------------------------------------
		DO FCHReserva
		UNLOCK ALL
		RETURN(.F.)
	ENDIF

	SELECT orcament
	DO CASE
		CASE LEFT(orcament.situacao,1) = "F"  && aguard res. osi comple.
	 		m.situacao 	= "L"+RIGHT(orcament.situacao,1)
	 		                                  && aguard imp. osi comple

		CASE LEFT(orcament.situacao,1) $ "EGA"  && aguard res. comple.
		 	m.situacao 	= "I"+RIGHT(orcament.situacao,1)
		 	                                  && reserva integral
	ENDCASE
	m.dt_res   	= wp_dtoper
	m.hora_res 	= time()
	IF !(RIGHT(orcament.situacao,1)) $ "DF"		
	                                 && CREDITO LIBERADO..........
		IF orcament.usr_libera = 9999 OR (EMPTY(orcament.lim_libera);
				 AND EMPTY(orcament.dt_libera))
			m.dt_libera  = wp_dtoper
			m.lim_libera = orcament.valor
			m.lim_prazo  = orcament.prazomedio
			m.usr_libera = 9999
		ENDIF
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO   situacao, dt_res, hora_res, dt_libera, ;
					lim_libera,lim_prazo,usr_libera
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ELSE
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO situacao, dt_res, hora_res
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		*------------------------------------------------------------*
		=W_DEFPROC("ORCAMENT.SPR")
		=ORgrvavisolib(orcament.orcamento)	&& AVISAR PARA LIBERAR
		*------------------------------------------------------------*
	ENDIF
	*--------------------------------------------------------
	DO FCHReserva
	UNLOCK ALL
RETURN(.T.)


PROCEDURE FCHReserva
	=UP_fecha("orcament" ,LForcament)
	=UP_fecha("orcatmp" ,LForcatmp)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJV6           ORcancreserva VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   27  ╨
*       ╨ Variable:            ORcancreserva                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      26                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gjv6     &&  ORcancreserva VALID
#REGION 1
RETURN

FUNCTION ORcancreserva
	PARAMETER LNemp,LNosi
	*------------------------------------------------------------*
	* CLASSIFICACAO:  []
	*------------------------------------------------------------*
	* OBJETIVO....: Controla o Processo de Cancelamento de Reserva
	*			de Uma OSI
	*------------------------------------------------------------*
	* COMENTARIO..: Conforme os parameros passados esta rotina
	*			posiciona no orcaento e controla o cancelamento
	*			dos itens da osi informada
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*			LNemp.......:  Empresa em Processo
	*			LNosi.......:  Orcamento Originario da Reserva
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF

	IF !REGLOCK()
	   WAIT WINDOW "Orcamento em uso em outro ponto. Tente novamente."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
	    RETURN(.f.)
	ENDIF

	SELECT  orcatmp
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(orcament.empresa,3)+STR(orcament.orcamento,6)
	SET NEAR OFF
	IF orcament.empresa <> orcatmp.empresa ;
		OR orcament.orcamento <> orcatmp.orcamento
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
	    RETURN
	ENDIF

	LFflgtrans = .t.
	LFflgreser = .t.
	LFflgretod = .t.	&& IGNORA CONFIRMACOES POR ITEM
	LFflgretod = fox_alert("Cancelar Reservas de todos itens ?")

	LNordemmenos = 0  && reordena os itens que ficam abaixo de item
					  &&  ELIMINADO
	DO WHILE !eof() AND orcament.orcamento 	= orcatmp.orcamento ;
					AND orcament.empresa 	= orcatmp.empresa
   		WAIT WINDOW "ITEM => "+STR(orcatmp.ordem,2) NOWAIT

		IF LEFT(orcatmp.situacao,1) $ 'GI' 			&& possui.res

			  wp_msg = 'Cacela Reserva de => '+STR(orcatmp.qtde,5)+" "+;
				  		alltrim(orcatmp.codigo)+" "+orcatmp.descricao
		  IF LFflgretod or fox_alert(wp_msg)
			*----------------------------------------------------------*
		   	PRIVATE LFlockReg
			PRIVATE LFabreAuto
		   	LFlockReg	= .T.	&& BLOQUEAR REGISTRO
		    LFabreAuto	= .F. 	&& NAO ABRIR CONTROLE AUTOMATICAMENTE

	   	     SELECT orcatmp
        	 IF REGLOCK()
				*------------------------------------------*
				=W_DEFPROC("ORCAMENT.SPR")
				IF !ORprocreserva_item(orcatmp.empresa,;
					orcament.tipo,orcatmp.orcamento,;
					orcatmp.codigo,orcatmp.ordem, "CANCELA")
					LFflgtrans = .F.
					EXIT
 				ENDIF
				*------------------------------------------*
	         ELSE
				LFflgtrans = .F.
				EXIT
	 		 ENDIF
		  ELSE
			  LFflgreser = .F.   && MANTER O ESTATUS DE RESERVA
		  ENDIF
	   ENDIF
   	   SELECT  orcatmp
	   SET ORDER TO TAG orcamento
	   SKIP
	ENDDO
	WAIT WINDOW " OK ! " NOWAIT

	SELECT orcament
	IF LFflgtrans AND  LFflgreser
		REPLACE situacao WITH "A "
		REPLACE dt_res   WITH CTOD('  .  .  ')
		REPLACE hora_res WITH '        '
	ELSE
		WAIT WINDOW "Processo NAO FOI concluido."
	ENDIF
	*--------------------------------------------------------
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	unlock all
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJVX           ORprocreserva_item VALID           ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   28  ╨
*       ╨ Variable:            ORprocreserva_item                 ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      27                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjvx     &&  ORprocreserva_item VALID
#REGION 1
RETURN

FUNCTION ORprocreserva_item
	PARAMETER LNemp,LStipo,LNosi,LScodigo,LNordem, LSoperacao
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Processar Insercao ou Cancelamento de Reservas
	*------------------------------------------------------------*
	* COMENTARIO..: Antiga ( UAreserva ) Esta rotina localiza o
	*			registro de ITEMMOV equivalente a RESERVA que esta
	*			sendo inserida ou excluida e processa adequadamente
	*           conforme a solicitacao
	*				A rotina trabalha nas tabelas ITEMMOV e ORCATMP
	*			conforme o parametro da operacao solicitada
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*			LNemp.......:  Empresa em Processo
	*			LStipo......:  Tipo da Operacao
	*			LNosi.......:  Orcamento Originario da Reserva
	*			LScodigo....:  Codigo do Produto p/ montar chave
	*			LNordem.....:  Ordem do Produto em orcatmp
	*			LSoperacao..:  Processo solicitado
	*				"RESERVA"...: Processar Reserva
	*				"CANCELA"...: Cancela Reserva mas mantem registro em
	*								ORCATMP e em SITUACAO = "A"
	*									(QUANDO OSI NAO  FOI EMITIDA
	*									ESTANDO SOMENTE EM RESERVA OSI)
	*				"ELIMINA"...: Cancela Reserva e Elimina registro em
	*								ORCATMP (QUANDO PROGRAMA PARA DESABILI
	*								TAR RESERVA NAO LOCALIZA A CAPA DO
	*								ORCAMENTO ELE ORDENA A ELIMINACAO DO
	*								ITEM
	*				"ANULA".....: Quando osi foi emitida e o item deve
	*								permanecer registrado mas com situacao
	*								de cancelamento
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR

	*--------------------------------------------------------
	SELECT orcatmp
	SET ORDER TO TAG orcacodigo
	SEEK STR(LNemp,3)+STR(LNosi,6)+LScodigo+STR(LNordem,2)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF	

	SELE grupo
	SET ORDER TO TAG codigo
	SEEK orcatmp.codigo

	SELECT itemmov
   	SET ORDER TO TAG itensosi
  	SEEK STR(LNemp,3)+"R"+STR(LNosi,7)+orcatmp.codigo+STR(LNordem,3)
    IF FOUND()
	    SET ORDER TO TAG movimento
		=REGLOCK(.T.)
		*-----------------------------------------------------------*
		*   Se houver falha durante o processo o registro aida fica
		* sob o controle da rotina SCGC204.PRG para processar a
		* baixa da reserva . A chave BX_RESERVA exige o 1╖ caracter
		* igual a "R"
		*-----------------------------------------------------------*		
		REPLACE operacao WITH "R***"   && faz o reg ser ignorado no saldo
									   && anulando seu efeito
		REPLACE dlibreserv WITH wp_dtsys
		REPLACE hlibreserv WITH time()
		***********************************************************
		SELE itemmov
		LNregmov = RECNO()

		SELE itemmov
	   	=W_DEFPROC("moviment.spr")
		=MVCancelMvto(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e

		SELE itemmov
	ENDIF




   	DO CASE
   		CASE LSoperacao = "ELIMINA"      && APAGA ITEM COM RESERVA
			   SELECT orcatmp
				=REGLOCK(.T.)
				=edithand('APAGA')
				RETURN(.t.)
   		CASE LSoperacao = "CANCELA"      && CANCELA RESERVAS
		      m.situacao = 'A '
    		  m.operacao = 'RVCS'   && RESERVA/VENDA/CANCELADA/
 			  m.qtderes	 =  0
   		CASE LSoperacao = "RESERVA"      && CANCELA RESERVAS
		      m.situacao = 'I'+RIGHT(m.situacao,1)
    		  m.operacao = 'RVPS'   && RESERVA/VENDA/PROCESSADA/
 			  m.qtderes	 =  orcatmp.qtde
   		CASE LSoperacao = "ANULA"      && ANULANDO ITEM
		      m.situacao = 'k'+RIGHT(m.situacao,1) && P/ CANC. EM OSI
    		  m.operacao = 'RVCS'   && RESERVA/VENDA/CANCELADA/
 			  m.qtderes	 =  0
  	ENDCASE


   	SELECT orcatmp

   	m.ordem = orcatmp.ordem - LNordemmenos
   	REPLACE situacao WITH m.situacao
   	REPLACE qtderes  WITH m.qtderes
   	REPLACE ordem    WITH m.ordem

   	m.qtde = orcatmp.qtde		&& NO ITEMMOV PODERIA HAVER OUTRA QTDE
								&& CASOS DE ALTERACAO DE RESERVA
	SELECT itemmov
  	SET ORDER TO TAG movimento
	*------------------------------------------------------------------*
   	*	ITENS COM QTDE = 0 NAO SAO PROCESSADOS
	*	orcatmp.tp_mercad = 7  && SERVICO NAO NECESSITA SALDO
	*	LEFT(orcatmp.codigo,4) = "9999"  && COMENTARIO NAO NECESSITA SALDO
	*------------------------------------------------------------------*
   	IF orcatmp.qtde  <> 0  	 ;
   		AND orcatmp.tp_mercad <> 7

		IF m.operacao = 'RVPS'   && RESERVA/VENDA/PROCESSADA/
			m.data = wp_dtoper
 			m.hora = time()
		 	m.sld_estq = 0
		 	m.vlr_estq = 0
			W_FULTDT = DATE()
			W_FULTH = "00:00"
			***************************************
			SELECT usuario
			SET ORDER TO TAG usuario
			SEEK m.operador
			***************************************
			SELECT itemmov
			IF usuario.temp_res = 99999
				m.dlibreserv = CTOD("12.12.9999")
				m.hlibreserv = "99:99"
			ELSE		
				do UPtempmais with m.data, m.hora, usuario.temp_res
				m.dlibreserv = W_FULTDT
				m.hlibreserv = LEFT(W_FULTH,5)		
			ENDIF
			*-------------------------------------------------------*
		   	m.sld_estq = 0
		   	m.vlr_estq = 0

			m.empresa 	=	orcatmp.empresa
			m.serie 	=	" "
		   	m.dtfat 	=   {}
			m.data 		=   wp_dtoper
		   	m.hora     	= 	orcament.hora
			m.orcamento	=	orcatmp.orcamento
			m.operador	=	orcament.operador
			m.motivo	=	orcament.motivo
			SELE TIPOOPER
			SCATTER FIELDS ;
				 CH_OPERA,CH_PRODU,CH_MOTIV,CH_DESTI,CH_CONTR,CH_CONDI,;
					TIPO TO MEMVAR

			m.FAVORECIDO  =    clienc.cliente
			m.NATU_CLI    =    clienc.NATU_CLI
			m.CODFORN     =    0
			m.PRAZOMEDIO  =    orcament.PRAZOMEDIO
			m.TP_parcela  =    orcament.TP_parcela
			m.TAXA        =    orcament.TAXA
			m.DESCONTO    =    orcatmp.DESCONTO
			m.DESC_ALT    =    orcatmp.DESC_ALT
			m.USR_DALT    =    orcatmp.USR_DALT
			m.NEGOCIACAO  =    orcament.NEGOCIACAO

			IF FOUND("GRUPO") AND grupo.TP_CONTROL = 9
				m.MOVESTQ     =    "N"
			ELSE
				m.MOVESTQ     =    tipooper.MOVESTQ
			ENDIF
			m.MOVVALOR    =    tipooper.MOVVALOR
			m.MOVCUSTO    =    tipooper.MOVCUSTO
			m.INFO_VLR    =    tipooper.INFO_VLR
			m.INFO_ICMS   =    tipooper.INFO_ICMS
			m.INFO_BASE   =    tipooper.INFO_BASE

			m.ORDEM       =    orcatmp.ORDEM
			m.CODIGO      =    orcatmp.CODIGO
			m.CLASSIFICA  =    grupo.CLASSIFICA
			m.UNIDADE     =    orcatmp.UNIDADE
			m.DESCRICAO   =    orcatmp.DESCRICAO
			m.TP_MERCAD   =    orcatmp.TP_MERCAD
			m.PESO        =    orcatmp.PESO
			m.IVA         =    orcatmp.IVA
			m.CLAS_CMS    =    orcatmp.CLAS_CMS
			m.CFO         =    orcatmp.CFO
			m.ORIGEM      =    orcatmp.ORIGEM
			m.CST         =    orcatmp.CST
			m.BASE_ISS    =    orcatmp.BASE_ISS
			m.ALIQ_ISS    =    orcatmp.ALIQ_ISS
			m.VLR_ISS     =    orcatmp.VLR_ISS
			m.BASE_CALC   =    orcatmp.BASE_CALC
			m.ALIQ_ICMS   =    orcatmp.ALIQ_ICMS
			m.VLR_ICMS    =    orcatmp.VLR_ICMS
			m.BASE_SBBRT  =    orcatmp.BASE_SBBRT
			m.BASE_SUBS   =    orcatmp.BASE_SUBS
			m.ICMS_SUBS   =    orcatmp.ICMS_SUBS
			m.BASE_ISENT  =    orcatmp.BASE_ISENT
			m.BASE_OUTR   =    orcatmp.BASE_OUTR
			m.BASE_ISIPI  =    orcatmp.BASE_ISIPI
			m.BASE_IPI    =    orcatmp.BASE_IPI
			m.ALIQ_IPI    =    orcatmp.ALIQ_IPI
			m.VLRIPI      =    orcatmp.VLRIPI
			m.PRECO       =    orcatmp.PRECO
			m.PRECOFINAL  =    orcatmp.PRECOFINAL
			m.QTDE        =    orcatmp.QTDE
			m.VLRVENDA    =    orcatmp.VLRVENDA

			m.SLD_ESTQ    =    0
			m.VLR_ESTQ    =    0
			m.SLD_RESE    =    0
			*-------------------------------------------------------*
			SELE ITEMMOV
		   =edithand('SAVE')
		   =W_DEFPROC("moviment.spr")
		   =MVatu_cmd(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e

		ENDIF
	ENDIF
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJWA           ORVTmotivos VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   29  ╨
*       ╨ Variable:            ORVTmotivos                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      28                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjwa     &&  ORVTmotivos VALID
#REGION 1
RETURN

PROCEDURE ORVTmotivos

	STORE SPACE(15)   TO VTLmotivo
	DO CASE
		CASE m.natu_oper = 1
			VTLmotivo(1) = "Normal         "
			VTLmotivo(2) = "Reclamada      "
			VTLmotivo(3) = "Complemento    "
			VTLmotivo(4) = "Entrega Futura "
			VTLmotivo(5) = "Imobilizado    "
			VTLmotivo(6) = "Carcacas       "
			VTLmotivo(7) = "Sucatas        "
			VTLmotivo(8) = "Outras         "
			VTLmotivo(9) = "               "
		CASE m.natu_oper = 2
			VTLmotivo(1) = "Mercadoria Comercial  "
			VTLmotivo(2) = "Bens Imobilizados     "
			VTLmotivo(3) = "Mat. de Uso em Servico"
			VTLmotivo(4) = "Material de Consumo   "
			VTLmotivo(5) = "Outros                "
			VTLmotivo(6) = "                      "
			VTLmotivo(7) = "                      "
			VTLmotivo(8) = "                      "
			VTLmotivo(9) = "               "
		CASE m.natu_oper = 3
			VTLmotivo(1) = "Consignacao    "
			VTLmotivo(2) = "Demonstracao   "
			VTLmotivo(3) = "Reclamacao     "
			VTLmotivo(4) = "Entrega Futura "
			VTLmotivo(5) = "Conserto       "
			VTLmotivo(6) = "Outras         "
			VTLmotivo(7) = "               "
			VTLmotivo(8) = "               "
			VTLmotivo(9) = "               "
		CASE m.natu_oper = 4
			VTLmotivo(1) = "Mercadoria Comercial   "
			VTLmotivo(2) = "Remessa em Consignacao "
			VTLmotivo(3) = "Remessa em Demonstracao"
			VTLmotivo(4) = "Mat. Uso Servico       "
			VTLmotivo(5) = "Mat. Consumo           "
			VTLmotivo(6) = "Compra de Imobilizado  "
			VTLmotivo(7) = "ICMS p/ Reembolso      "
			VTLmotivo(8) = "Outros                 "
			VTLmotivo(9) = "Merc.Com.Regime Acordo "
		CASE m.natu_oper = 5
			VTLmotivo(1) = "Mercadoria Danificada  "
			VTLmotivo(2) = "Reserva P/Fat.Futuro   "
			VTLmotivo(3) = "                       "
			VTLmotivo(4) = "                       "
			VTLmotivo(5) = "                       "
			VTLmotivo(6) = "                       "
			VTLmotivo(7) = "                       "
			VTLmotivo(8) = "                       "
			VTLmotivo(9) = "               "
	ENDCASE
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJWG           ORVlr_e_FormPgto VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   30  ╨
*       ╨ Variable:            ORVlr_e_FormPgto                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      29                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjwg     &&  ORVlr_e_FormPgto VALID
#REGION 1
RETURN

PROCEDURE ORVlr_e_FormPgto
PARAMETERS PrmEmpresa,PrmOrcamento,;
			PrmChequeVlr,;
			PrmDinheiroVlr,;
			PrmCartaoVlr,;
			PrmVlrDuplicata

	PRIVATE LForca_pgt
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	*------------------------------------------------------------*
	LForca_pgt		= NetArq("orca_pgt")
	*--------------------------------------------------------
    IF (LForca_pgt) > 100000  && HOUVE FALHA ABERT
		=UP_fecha("LForca_pgt" ,LFLForca_pgt)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN
	ENDIF

	*--------------------------------------------------------------*
	SELE orca_pgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	SET NEAR OFF

	store 0 to PrmChequeVlr,PrmDinheiroVlr,PrmCartaoVlr,PrmVlrDuplicata

	DO WHILE !EOF() ;
			AND orca_pgt.empresa = PrmEmpresa ;
			AND orca_pgt.orcamento = PrmOrcamento
		DO CASE
			CASE orca_pgt.moeda = 1
				PrmDinheiroVlr = PrmDinheiroVlr + orca_pgt.Vlr_Pgto
			CASE orca_pgt.moeda = 2 OR orca_pgt.banco = 857 ;
				OR orca_pgt.banco = 858
				PrmChequeVlr = PrmChequeVlr + orca_pgt.Vlr_Pgto
			CASE orca_pgt.moeda = 3 ;
			   OR orca_pgt.banco = 859 ;
			   OR orca_pgt.banco = 860
			
				PrmVlrDuplicata = PrmVlrDuplicata + orca_pgt.Vlr_Pgto
			CASE orca_pgt.moeda = 4 OR  orca_pgt.moeda = 5
				PrmCartaoVlr = PrmCartaoVlr + orca_pgt.Vlr_Pgto
			OTHERWISE
				PrmDinheiroVlr = PrmDinheiroVlr + orca_pgt.Vlr_Pgto
		ENDCASE
		SKIP
	ENDDO

	*--------------------------------------------------------------*
	=UP_fecha("LForca_pgt" ,LForca_pgt)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJWH           ORlog VALID                        ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   31  ╨
*       ╨ Variable:            ORlog                              ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      30                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gjwh     &&  ORlog VALID
#REGION 1
RETURN

FUNCTION ORlog
PARAMETERS PrmEmpresa,PrmOrcamento

	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PRIVATE LSAlias
	PRIVATE ARQ_LogOrca,ALS_LogOrca
	store "" to ARQ_tmp,ALS_tmp

	*-------------------------------------------------------------*
	*-------------------------------------------------------------*

	LSAlias = Alias()

    ARQ_LogOrca     = NetArqAgain("Log_Orca")
    ALS_LogOrca     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_LogOrca
	SET ORDER TO TAG emporca

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmOrcamento <> orcamento
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND ORCAMENTO = PrmOrcamento
	SELE 0
	USE &ARQ_tmp
	ALS_tmp = ALIAS()

	KEYBOARD CHR(13)
	=INKEY(1)

	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
*	ON KEY LABEL P      DO ESimpext WITH "REL407"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ LOG ORCAMENTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF

	BROWSE  FIELDS ;
			DTREGIS		:H="DATA" :R,;
			USRREGIS	:H="Usr"  :R,;
			OCORRENCIA   :H="OCORRENCIA";
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_LogOrca")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJWI           ORCanc_Libera VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   32  ╨
*       ╨ Variable:            ORCanc_Libera                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      31                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjwi     &&  ORCanc_Libera VALID
#REGION 1
RETURN

FUNCTION ORCanc_Libera
	PARAMETERS LNemp,LNosi




	=W_DEFPROC("EMPRESA.SPR")
	LSCnsltCrdt = EMGetFieldValue(wp_empresa,"CNSLT_CRDT")


    IF LSCnsltCrdt = "S"   && USAR NOVA ROTINA XML

        =ORXMLCanc_Libera(LNemp,LNosi)

        RETURN(.T.)
    ENDIF




	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: cancela liberacao
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp.......: Empresa em questao
	*		LNosi.......: Nro do Orcamento em questao
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*
	PRIVATE LDdt_libera		&& Retorna a Data de liberacao
	PRIVATE LNlim_libera	&& Retorna o valor a praso liberado
	PRIVATE LNlmt_parcela	&& Retorna se Existe Limitacao para Duplcat
	PRIVATE LNlim_prazo		&& Retorna o usuario (neste caso o SISTEMA=0)
	PRIVATE LSsit			&& Retorna a situacao Definida pelo Processo
	PRIVATE LNtp_parcela
	
	PRIVATE LSalias
	PRIVATE LForcament,LFliberacoes
	*-----------------------------------------------------------*
	LSalias	= ALIAS()

	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFliberacoes	= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFliberacoes) > 100000
		DO FCHCanc_lib
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHCanc_lib
		RETURN(.F.)
	ENDIF

	SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(LNemp,3)+STR(LNosi,6)

	LSsit = orcament.situacao
	LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Existe Restricao a venda
									  	 && com duplicata
	*------------------------------------------------------------------*

	SELE liberaco
	m.empresa 	= 	orcament.empresa
	m.orcamento	=	orcament.orcamento
	m.data 		= 	wp_dtoper
	m.liberador =	0		&& SISTEMA
	m.tp_parcela= 	orcament.tp_parcela
	m.validade	=	wp_dtoper + 30
	m.situacao  =  "BLOQ"
	m.limite 	=   0
	m.prazomedio=   0
	IF FOUND("liberaco")
		=edithand('REGRAVA')
	ELSE
		=edithand('SAVE')
	ENDIF
	SELE orcament
	m.situacao   = LSsit
	SET FIELDS TO situacao, dtregis, hregis, usrregis, deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------------*
	DO FCHCanc_lib

RETURN(.T.)


PROCEDURE FCHCanc_lib
	=UP_fecha("orcament",LForcament)
	=UP_fecha("liberaco" ,LFliberacoes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJWJ           ORSelParaFat VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   33  ╨
*       ╨ Variable:            ORSelParaFat                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      32                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gjwj     &&  ORSelParaFat VALID
#REGION 1
RETURN

FUNCTION ORSelParaFat

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSorcament
	PRIVATE LSalias
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	*--------------------------------------------------------
    IF (LForcament) > 100000  && HOUVE FALHA ABERT
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*

	*------------------------------------------------------------*

	=W_DEFPROC("AUTOPROC.SPR")
	=APTempGeral()

	*------------------------------------------------------------*

	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH "o"	 && SITUACOES EM ORDEM										&& CRESCENTE
	*------------------------------------------------------------*
	IF LASTKEY() = 27
		*---------------------------------------------------------*
		CLEAR TYPEAHEAD
		=INKEY(0.01)
		RETURN(.F.)
	ENDIF
	CLEAR TYPEAHEAD
	=INKEY(0.01)

RETURN(.T.)





****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJXC           ORSelPFatDireto VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   34  ╨
*       ╨ Variable:            ORSelPFatDireto                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      33                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gjxc     &&  ORSelPFatDireto VALID
#REGION 1
RETURN

FUNCTION ORSelPFatDireto

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSorcament
	PRIVATE LSalias
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	*--------------------------------------------------------
    IF (LForcament) > 100000  && HOUVE FALHA ABERT
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*

	*------------------------------------------------------------*

	=W_DEFPROC("AUTOPROC.SPR")
	=APTempGeral()

	*------------------------------------------------------------*

	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH "AIMo"	 && SITUACOES EM ORDEM										&& CRESCENTE
	*------------------------------------------------------------*
	IF LASTKEY() = 27
		*---------------------------------------------------------*
		CLEAR TYPEAHEAD
		=INKEY(0.01)
		RETURN(.F.)
	ENDIF
	CLEAR TYPEAHEAD
	=INKEY(0.01)

RETURN(.T.)





****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJXK           ORimp_osi VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   35  ╨
*       ╨ Variable:            ORimp_osi                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      34                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjxk     &&  ORimp_osi VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------------------------------------------*

PROCEDURE ORSleOrFinFat		&& sist. localizacao de orcamentos
PARAMETERS LSsit, LScompl, LSorigem

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Visualisar Orcamentos que atendam aos parametros
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		PARAMETERS LSsit, LScompl, LSorigem
	*			LSsit   => indica as situacoes que devem ser relacionadas
	*			LScompl => indica os complementos de situacoes solicitados
	*		 	LSorigem=> indica qual operacao solicitou ex: RESERVA,
	*						LIBERA
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*

	PRIVATE 	LFdestrava

	ON KEY LABEL ESCAPE
	CLEAR TYPEAHEAD
    SELECT orcament

	IF TYPE("LScompl") <> "C"
		LScompl = ""
	ENDIF

	IF TYPE("LSorigem") <> "C"
		LSorigem = ""
	ENDIF

	IF TYPE("ver") <> "N"
		m.ver = 2   && ver todos
	ENDIF





	LNreg = RECNO()     && permite reposicionar registro

	LNemp = orcament.empresa
	LNorca= orcament.orcamento
	SET ORDER TO tag situacao
	SET NEAR ON
	SEEK STR(wp_empresa,3)+LEFT(LSsit,1)    &&posic. na 1a sit.strig
	SET NEAR OFF
	IF EOF() OR wp_empresa <> orcament.empresa OR ;
			!(LEFT(orcament.situacao,1) $ LSsit)
		wp_msg = "Nao existem orcamentos para esta opcao. <ENTER>"
		=UPbeeps(.F.,wp_msg)
		UNLOCK
	    m.sOldError=ON('error')
		ON ERROR *
		GO LNreg
		ON ERROR &sOldError
		KEYBOARD CHR(27)		
		=INKEY(0)
 		RETURN
	ENDIF
************************>
	wl_arqtmp = ""
	LNtmp     = 65		&& TABELA ASCII A = 65
	IF !UPabretmp("orc")
		wp_flgfecha = .t.
	ENDIF
	IF wp_flgfecha
		KEYBOARD "{ESCAPE}"
		RETURN
	ENDIF
	SET SAFET OFF
	LStmp = "&wp_dirtmp"+"&wl_arqtmp"
*****************************>

	SELE clienc
	SET ORDER TO TAG emporca




	SELE orcament
	LFdestrava = .f.
	IF LSorigem = "LIBERAR"	&& devem ser mostrados reg.protegidos
		LFdestrava = .t.
	ENDIF
	SET RELATION TO STR(EMPRESA,3)+STR(ORCAMENTO,6) INTO clienc


	
	
	COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome, veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
	   	    FOR ;
				(!orcament.protegido OR lMaster OR LFdestrava OR ;
				(orcament.protegido AND orcament.operador = wl_vendedor)) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
		   	    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl);
	    		WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX


	SET RELATION TO

    SELE 0
    USE &LStmp EXCLU ALIAS ORCABROW
	INDEX ON NOME TAG nome_todos ADDITIVE

*-----------------------> FIM PREPARACAO ARQ. TEMPORARIO	
	IF EOF() AND BOF()
		wp_msg = "Nao existem orcamentos para esta opcao. <ENTER>"
		=UPbeeps(.F.,wp_msg)
		KEYBOARD CHR(27)		
		=INKEY(0)
	    SELECT orcament
		GO LNreg
	ELSE
		Lpar1 = ""
		Lpar2 = ""
		SET ORDER TO TAG nome_todos
		GO TOP

		DO ORLoc_Browse WITH .T., Lpar1, Lpar2, "B"


	    SELECT orcament
		SET ORDER TO tag orcamento
		SET RELATION TO
*------------------------------------- posiciona orcamento
		SEEK STR(orcabrow.empresa,3)+STR(orcabrow.orcamento,6)
*------------------------------------ encerra secao orcabrow
		IF !FOUND() OR LASTKEY() = 27
			KEYBOARD CHR(27)		
			GO LNreg
		ENDIF
	ENDIF
	SELECT orcabrow
	USE
	SELECT orcament
    SCATTER MEMVAR MEMO
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJXT           ORimp_osi VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   36  ╨
*       ╨ Variable:            ORimp_osi                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      35                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjxt     &&  ORimp_osi VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------------------------------------------*

PROCEDURE ORSleOrNFinFat		&& sist. localizacao de orcamentos
PARAMETERS LSsit, LScompl, LSorigem

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Visualisar Orcamentos que atendam aos parametros
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		PARAMETERS LSsit, LScompl, LSorigem
	*			LSsit   => indica as situacoes que devem ser relacionadas
	*			LScompl => indica os complementos de situacoes solicitados
	*		 	LSorigem=> indica qual operacao solicitou ex: RESERVA,
	*						LIBERA
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*

	PRIVATE 	LFdestrava

	ON KEY LABEL ESCAPE
	CLEAR TYPEAHEAD
    SELECT orcament

	IF TYPE("LScompl") <> "C"
		LScompl = ""
	ENDIF

	IF TYPE("LSorigem") <> "C"
		LSorigem = ""
	ENDIF

	IF TYPE("ver") <> "N"
		m.ver = 2   && ver todos
	ENDIF





	LNreg = RECNO()     && permite reposicionar registro

	LNemp = orcament.empresa
	LNorca= orcament.orcamento
	SET ORDER TO tag situacao
	SET NEAR ON
	SEEK STR(wp_empresa,3)+LEFT(LSsit,1)    &&posic. na 1a sit.strig
	SET NEAR OFF
	IF EOF() OR wp_empresa <> orcament.empresa OR ;
			!(LEFT(orcament.situacao,1) $ LSsit)
		wp_msg = "Nao existem orcamentos para esta opcao. <ENTER>"
		=UPbeeps(.F.,wp_msg)
		UNLOCK
	    m.sOldError=ON('error')
		ON ERROR *
		GO LNreg
		ON ERROR &sOldError
		KEYBOARD CHR(27)		
		=INKEY(0)
 		RETURN
	ENDIF
************************>
	wl_arqtmp = ""
	LNtmp     = 65		&& TABELA ASCII A = 65
	IF !UPabretmp("orc")
		wp_flgfecha = .t.
	ENDIF
	IF wp_flgfecha
		KEYBOARD "{ESCAPE}"
		RETURN
	ENDIF
	SET SAFET OFF
	LStmp = "&wp_dirtmp"+"&wl_arqtmp"
*****************************>
	SELE clienc
	SET ORDER TO TAG emporca

	SELE orcament
	LFdestrava = .f.
	IF LSorigem = "LIBERAR"	&& devem ser mostrados reg.protegidos
		LFdestrava = .t.
	ENDIF
	SET RELATION TO STR(EMPRESA,3)+STR(ORCAMENTO,6) INTO clienc


	
	DO CASE

		CASE ("A" $ LSsit OR "F" $ LSsit OR "G" $ LSsit OR "I" $ LSsit)  ;
		 	  AND (m.ver <> 1 OR lMaster)

				&& RESERVA E CANC. DE RESERVA P/ VER ORCAMENTO COM
				&& RESERVAS PELO ESTOQUE

			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome,veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
	   	    FOR ;
				(  !orcament.protegido ;
					OR lMaster;
					OR LFdestrava ;
					OR ;
				     (     orcament.protegido ;
				       AND orcament.operador = wl_vendedor;
				     );
				) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
			    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl) ;
	 			WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX

		CASE ("A" $ LSsit OR "F" $ LSsit OR "G" $ LSsit OR "I" $ LSsit)  ;
		 	  AND (m.ver = 1 OR lMaster)

				&& RESERVA E CANC. DE RESERVA P/ VER ORCAMENTO COM
				&& RESERVAS PELO ESTOQUE
			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome,veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
		   	    FOR ;
   		        (orcament.operador = wl_vendedor) AND ;
	   		    LEFT(orcament.situacao,1) $ LSsit     AND ;
	   	    	(EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl) ;
	    		WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX

		CASE WPprgativo = "SCGC201A" OR m.ver <> 1 && ver alem proprios
	
			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome, veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
	   	    FOR ;
				(!orcament.protegido OR lMaster OR LFdestrava OR ;
				(orcament.protegido AND orcament.operador = wl_vendedor)) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
		   	    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl);
	    		WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX
		OTHERWISE
			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome,veiculo,placa, ;
					dt_fat,nota,dtregis,hregis,usrregis ;
   	        FOR ;
				(lMaster OR orcament.operador = wl_vendedor) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
		   	    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl) ;
    			WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX
	ENDCASE
	SET RELATION TO

    SELE 0
    USE &LStmp EXCLU ALIAS ORCABROW
	INDEX ON NOME TAG nome_todos ADDITIVE

*-----------------------> FIM PREPARACAO ARQ. TEMPORARIO	
	IF EOF() AND BOF()
		wp_msg = "Nao existem orcamentos para esta opcao. <ENTER>"
		=UPbeeps(.F.,wp_msg)
		KEYBOARD CHR(27)		
		=INKEY(0)
	    SELECT orcament
		GO LNreg
	ELSE
		Lpar1 = ""
		Lpar2 = ""
		SET ORDER TO TAG nome_todos
		GO TOP

		DO ORLoc_Browse WITH .T., Lpar1, Lpar2, "B"


	    SELECT orcament
		SET ORDER TO tag orcamento
		SET RELATION TO
*------------------------------------- posiciona orcamento
		SEEK STR(orcabrow.empresa,3)+STR(orcabrow.orcamento,6)
*------------------------------------ encerra secao orcabrow
		IF !FOUND() OR LASTKEY() = 27
			KEYBOARD CHR(27)		
			GO LNreg
		ENDIF
	ENDIF
	SELECT orcabrow
	USE
	SELECT orcament
    SCATTER MEMVAR MEMO
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJY4           ORCancPdLiberacaoXML VALID         ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   38  ╨
*       ╨ Variable:            ORCancPdLiberacaoXML               ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      36                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjy4     &&  ORCancPdLiberacaoXML VALID
#REGION 1
RETURN

FUNCTION ORCancPdLiberacaoXML
	PARAMETERS LNemp,LNosi

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: cancela liberacao
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp.......: Empresa em questao
	*		LNosi.......: Nro do Orcamento em questao
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*
	PRIVATE LDdt_libera		&& Retorna a Data de liberacao
	PRIVATE LNlim_libera	&& Retorna o valor a praso liberado
	PRIVATE LNlmt_parcela	&& Retorna se Existe Limitacao para Duplcat
	PRIVATE LNlim_prazo		&& Retorna o usuario (neste caso o SISTEMA=0)
	PRIVATE LSsit			&& Retorna a situacao Definida pelo Processo
	PRIVATE LNtp_parcela
	
	PRIVATE LSalias
	PRIVATE LForcament,LFliberacoes
	*-----------------------------------------------------------*
	LSalias	= ALIAS()

	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFliberacoes	= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFliberacoes) > 100000
		DO FCHCanc_lib
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHCanc_lib
		RETURN(.F.)
	ENDIF

	SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(LNemp,3)+STR(LNosi,6)

	LSsit = orcament.situacao
	LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Existe Restricao a venda
									  	 && com duplicata
	*------------------------------------------------------------------*

	SELE liberaco
	m.empresa 	= 	orcament.empresa
	m.orcamento	=	orcament.orcamento
	m.data 		= 	wp_dtoper
	m.liberador =	0		&& SISTEMA
	m.tp_parcela= 	orcament.tp_parcela
	m.validade	=	wp_dtoper + 30
	m.situacao  =  "BLOQ"
	m.limite 	=   0
	m.prazomedio=   0
	IF FOUND("liberaco")
		=edithand('REGRAVA')
	ELSE
		=edithand('SAVE')
	ENDIF
	SELE orcament
	m.situacao   = LSsit
	SET FIELDS TO situacao, dtregis, hregis, usrregis, deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------------*
	DO FCHCanc_lib

RETURN(.T.)


PROCEDURE FCHCanc_lib
	=UP_fecha("orcament",LForcament)
	=UP_fecha("liberaco" ,LFliberacoes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJY5           ORConsPdLiberacaoXML VALID         ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   39  ╨
*       ╨ Variable:            ORConsPdLiberacaoXML               ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      37                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjy5     &&  ORConsPdLiberacaoXML VALID
#REGION 1
RETURN

FUNCTION ORConsPdLiberacaoXML
	PARAMETERS LNemp,LNosi

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: cancela liberacao
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp.......: Empresa em questao
	*		LNosi.......: Nro do Orcamento em questao
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*
	PRIVATE LDdt_libera		&& Retorna a Data de liberacao
	PRIVATE LNlim_libera	&& Retorna o valor a praso liberado
	PRIVATE LNlmt_parcela	&& Retorna se Existe Limitacao para Duplcat
	PRIVATE LNlim_prazo		&& Retorna o usuario (neste caso o SISTEMA=0)
	PRIVATE LSsit			&& Retorna a situacao Definida pelo Processo
	PRIVATE LNtp_parcela
	
	PRIVATE LSalias
	PRIVATE LForcament,LFliberacoes
	*-----------------------------------------------------------*
	LSalias	= ALIAS()

	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFliberacoes	= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFliberacoes) > 100000
		DO FCHCanc_lib
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHCanc_lib
		RETURN(.F.)
	ENDIF

	SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(LNemp,3)+STR(LNosi,6)

	LSsit = orcament.situacao
	LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Existe Restricao a venda
									  	 && com duplicata
	*------------------------------------------------------------------*

	SELE liberaco
	m.empresa 	= 	orcament.empresa
	m.orcamento	=	orcament.orcamento
	m.data 		= 	wp_dtoper
	m.liberador =	0		&& SISTEMA
	m.tp_parcela= 	orcament.tp_parcela
	m.validade	=	wp_dtoper + 30
	m.situacao  =  "BLOQ"
	m.limite 	=   0
	m.prazomedio=   0
	IF FOUND("liberaco")
		=edithand('REGRAVA')
	ELSE
		=edithand('SAVE')
	ENDIF
	SELE orcament
	m.situacao   = LSsit
	SET FIELDS TO situacao, dtregis, hregis, usrregis, deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------------*
	DO FCHCanc_lib

RETURN(.T.)


PROCEDURE FCHCanc_lib
	=UP_fecha("orcament",LForcament)
	=UP_fecha("liberaco" ,LFliberacoes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJY6           ORGraXMLPddCredito VALID           ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   41  ╨
*       ╨ Variable:            ORGraXMLPddCredito                 ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      38                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjy6     &&  ORGraXMLPddCredito VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORGraXMLPddCredito
PARAMETER PrmEmpresa,;
		  PrmNro_Orca,;
		  PrmSerie_Doc,;
   		  PrmTipoOperacao && REGISTRAR,CANCELAR,CONSULTAR,ENCERRAR


	PRIVATE LSalias
	
	PRIVATE PrmAlsOR
	PRIVATE LNrecOrca
	
	PRIVATE LNosiReferencia   && relaciona as duplicatas pelo
	                          && orcamento de referencia

	

	LSalias  = ALIAS()
	PrmAlsOR = ORGetAlias()



	*-------------------------------------------------------*
	=ORMdlPddCrdtRefXML()

	*-------------------------------------------------------*

   	PRIVATE LSfileXML,LNroIDfileXML




   	LSfileXML	= ORNmFileXMLPddCr(PrmEmpresa,PrmNro_Orca)
   	LSfileXML	= "C:\NFE\TMP\"+LSfileXML


  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria┤фo arquivo tempor═rio '+LSfileXML+'- <ENTER> ' window
      return
   	endif





	*---------------------------------------------------*

	SELE &PrmAlsOR
	SET ORDER TO TAG GERAL
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmNro_Orca,6)
	SET NEAR OFF




	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.


    IF !EOF()
		LNregistro = RECNO()

		COUNT  WHILE !EOF() ;
			AND PrmEmpresa    = &PrmAlsOR .empresa;
	        AND PrmNro_Orca   = &PrmAlsOR .orcamento ;
         TO LNimpressao
		GO LNregistro
	
	ENDIF
	
	LNimpressos = 0
	*----------------------------------------------------*


	=ORIniPddCrdtXML(LSfileXML,LNroIDfileXML)


	SET POINT TO ','


	SELE &PrmAlsOR
	DO WHILE !EOF() ;
	        AND PrmEmpresa       = &PrmAlsOR .empresa;
	        AND PrmNro_Orca       = &PrmAlsOR .orcamento

		=UPtermo()



		LNrecOrca = RECNO()



		=ORGrvXMLPddCrdt(;
 				PrmEmpresa,;
		  		PrmNro_Orca,;
		  		PrmSerie_Doc,;
                PrmTipoOperacao,;
				LSfileXML,;
				LNroIDfileXML;
				)


		SELE &PrmAlsOR
		SET ORDER TO TAG GERAL

		GO LNrecOrca
		SKIP
	ENDDO

	=ORFinPddCrdtXML(LSfileXML,LNroIDfileXML)


	SET POINT TO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJYV           ORNmFileXMLPddCr VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   42  ╨
*       ╨ Variable:            ORNmFileXMLPddCr                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      39                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjyv     &&  ORNmFileXMLPddCr VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORNmFileXMLPddCr
PARAMETER PrmEmpresa,PrmNro_Doc

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*



	LSnomeArqXml = "PC"+;
				   STR(PrmNro_Doc,6)
				
	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")


   	LSfileXML	= LSnomeArqXml+".XML"
	
RETURN(LSfileXML)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJZ1           ORIniPddCrdtXML VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   43  ╨
*       ╨ Variable:            ORIniPddCrdtXML                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      40                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjz1     &&  ORIniPddCrdtXML VALID
#REGION 1
RETURN

FUNCTION ORIniPddCrdtXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML



   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\XMLPDDCR
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND XMLPDDCR.XML_ORDEM < 9999999999901
	
		LSLinhaXML = XMLPDDCR.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE XMLPDDCR
	USE
		

RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJZ7           ORFinPddCrdtXML VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   44  ╨
*       ╨ Variable:            ORFinPddCrdtXML                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      41                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjz7     &&  ORFinPddCrdtXML VALID
#REGION 1
RETURN

FUNCTION ORFinPddCrdtXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\XMLPDDCR
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF XMLPDDCR.XML_ORDEM > 9999999999900
			LSLinhaXML = XMLPDDCR.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE XMLPDDCR
	USE
		

RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJZD           ORGrvXMLPddCrdt VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   45  ╨
*       ╨ Variable:            ORGrvXMLPddCrdt                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      42                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjzd     &&  ORGrvXMLPddCrdt VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION ORGrvXMLPddCrdt
PARAMETERS  	PrmEmpresa,;
		  		PrmNro_Doc,;
                PrmSerie_Doc,;
		  		PrmTipoOperacao,;
				PrmFileXML,;
				PrmNroIDfileXML


 && REGISTRAR,CANCELAR,CONSULTAR,ENCERRAR


	PRIVATE LSAlsOR   && ORCAMENT
	PRIVATE LSAlsCN   && CLIENC
	

	LSAlsOR = ORGetAlias()


	IF !ORLerRegistro(PrmEmpresa,;
			PrmNro_Doc)
	      wait "Nao foi localizado Orcamento :"+;
		      "FILIAL: "+STR(PrmEmpresa,3)+;
		      "NRO.  : "+STR(PrmNro_Doc,9)
   	  return(.F.)
    ENDIF





	=W_DEFPROC("CLIENC.SPR")
	LSAlsCN = CNGetAlias()


	=W_DEFPROC("CLIENC.SPR")
	IF !CNLerRegistro(PrmEmpresa,PrmNro_Doc)
	      wait "Nao foi localizado Cliente (CLIENC) do Orcamento :"+;
		      "FILIAL: "+STR(PrmEmpresa,3)+;
		      "NRO.  : "+STR(PrmNro_Doc,9)
   	  return(.F.)
    ENDIF


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_Crd
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*

	=W_DEFPROC("EMPRESA.SPR")
	=EMLerRegistro(PrmEmpresa)

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("CGC")
	UNEM_CNPJ    =  STR(LFieldTmp,14)
	UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")

	SET POINT TO ","
	SET SEPARATOR  TO "."

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"')

 	  =W_DEFPROC("DOCFISCA.SPR")
	  =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("INSCRICAO")

	=W_DEFPROC("DOCFISCA.SPR")
	LFieldTmp = DFLimpaString(LFieldTmp)


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('UNEM_IE="'+LFieldTmp+'"')

 	  =W_DEFPROC("DOCFISCA.SPR")
	  =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*==========================================================*
	*  IDENTIFICACAO DA SOLICITACAO DE CREDITO - ORCAMENTO
	*==========================================================*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_TIPO_OPERACAO="'+;
	             PrmTipoOperacao +;
	             '"')

	  =W_DEFPROC("DOCFISCA.SPR")
      =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
	*----------------------------------------------------------*



	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_NUMERO="'+;
	             STR(PrmNro_Doc,7) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_SERIE="'+;
	             PrmSerie_Doc +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*==========================================================*
	*  PARTICIPANTE
	*==========================================================*
	private LNcpfcnpjc,LNie,LNnome


	LNcpfcnpjc  =  chrtran(str( &LSAlsCN .cliente,14)," ","0")
	LNie        =  &LSAlsCN .inscricao

	=W_DEFPROC("DOCFISCA.SPR")
    LNie        =  DFLimpaString(LNie)


    LNie_UF     =  &LSAlsCN .estado
	LNnome	    =  &LSAlsCN .nome


	*----------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_CPFCNPJ="'+;
	             LNcpfcnpjc+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_IE="'+;
	             LNie+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_IE_UF="'+;
	             LNie_UF+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = DFLimpaString(LNnome)

	=W_DEFPROC("DOCFISCA.SPR")
  	    LSLinhaXML = ('SLCR_NOME="'+;
	             LSLinhaXML+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*==========================================================*
	*  DADOS DA SOLICITACAO
	*==========================================================*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_DATA="'+;
	             DTOC( &LSAlsOR .DATA) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_HORA="'+;
	              &LSAlsOR .HORA +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_NOME_SOLICITANTE="'+;
	              wp_nmusr +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_LIMITE_SOLICITADO="'+;
	             STR( &LSAlsOR .VALOR ;
	                 -;
	                   &LSAlsOR .VLR_ENT ;
	             ,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*----------------------------------------------------------------------*

	DO CASE

			CASE     &LSAlsOR .TP_PARCELA = 1

				LScodigo    = "01"
				LSdescricao = "Dinheiro"


			CASE     &LSAlsOR .TP_PARCELA = 2
				LScodigo    = "02"
				LSdescricao = "Cheque A Vista"


			CASE     &LSAlsOR .TP_PARCELA = 3
				LScodigo    = "03"
				LSdescricao = "Cheque A Prazo"

			CASE     &LSAlsOR .TP_PARCELA = 4
				LScodigo    = "04"
				LSdescricao = "Duplicata"


			CASE     &LSAlsOR .TP_PARCELA = 5
				LScodigo    = "05"
				LSdescricao = "Cheque Eletronico"


			CASE     &LSAlsOR .TP_PARCELA = 6
			
				LScodigo    = "06"
				LSdescricao = "Cartao Rotativo"

			CASE     &LSAlsOR .TP_PARCELA = 7

				LScodigo    = "07"
				LSdescricao = "Cartao Parcelado Administradora"

			CASE     &LSAlsOR .TP_PARCELA = 8
			
				LScodigo    = "08"
				LSdescricao = "Cartao Parcelado Loja"

	ENDCASE


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_FORMA_PGTO="'+;
	        		     LScodigo +;
				             '"')
   	   =W_DEFPROC("DOCFISCA.SPR")
	   =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_FORMA_PGTO_DESCRICAO="'+;
	        		     LSdescricao +;
				             '"')
	   =W_DEFPROC("DOCFISCA.SPR")
	   =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

    *----------------------------------------------------------------------*


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_PRAZO_MEDIO="'+;
	             STR( &LSAlsOR .PRAZOMEDIO,5,0) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*-------------------------------------------------------*
	*-------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_STATUS="'+;
	             '' +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	*-------------------------------------------------------*
	LSLinhaXML = ULtratalinha('/>')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJZE           ORMdlPddCrdtRefXML VALID           ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   46  ╨
*       ╨ Variable:            ORMdlPddCrdtRefXML                 ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      43                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjze     &&  ORMdlPddCrdtRefXML VALID
#REGION 1
RETURN

FUNCTION ORMdlPddCrdtRefXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\XMLPDDCR.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\XMLPDDCR EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE XMLPDDCR


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF

RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJZF           ORNmPddCrdtLngFileXMLCREDT VALID   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   47  ╨
*       ╨ Variable:            ORNmPddCrdtLngFileXMLCREDT         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      44                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjzf     &&  ORNmPddCrdtLngFileXMLCREDT VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORNmPddCrdtLngFileXMLCREDT
PARAMETER PrmEmpresa,PrmNro_Doc

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
    PRIVATE LSPrefixo,LSTpDoc,LSNrDoc,LSNrEmp

	
	*----------------------------------------------------------*
    LSPrefixo = "CRDT"
    LSTpDoc   = ""
    LSNrDoc   = CHRTRAN(STR(PrmNro_Doc,6)," ","0")
    LSNrEmp   = CHRTRAN(STR(PrmEmpresa,3)," ","0")



	LSnomeArqXml = LSPrefixo+LSNrEmp+LSTpDoc+LSNrDoc+".XML"

   	LSfileXML	= LSnomeArqXml
	
RETURN(LSfileXML)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GJZG           ORXMLRegPede_p_Liberar VALID       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   50  ╨
*       ╨ Variable:            ORXMLRegPede_p_Liberar             ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      45                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gjzg     &&  ORXMLRegPede_p_Liberar VALID
#REGION 1
RETURN

FUNCTION ORXMLRegPede_p_Liberar
	PARAMETERS PrmEmp,PrmOsi,PrmSerie
	
   IF TYPE("PrmSerie") <> "C"
      PrmSerie = "001"
   ENDIF

   PRIVATE LSTipoOperacao

   LSTipoOperacao = "REGISTRAR"  && REGISTRAR,CANCELAR,CONSULTAR,FATURAR


   =ORGraXMLPddCredito( ;
          PrmEmp,;
		  PrmOsi,;
		  PrmSerie,;
   		  LSTipoOperacao)




RETURN(.T.)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK0C           ORXMLCanPede_p_Liberar VALID       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   51  ╨
*       ╨ Variable:            ORXMLCanPede_p_Liberar             ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      46                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk0c     &&  ORXMLCanPede_p_Liberar VALID
#REGION 1
RETURN

FUNCTION ORXMLCanPede_p_Liberar
	PARAMETERS PrmEmp,PrmOsi,PrmSerie
	
   IF TYPE("PrmSerie") <> "C"
      PrmSerie = "001"
   ENDIF

   PRIVATE LSTipoOperacao

   LSTipoOperacao = "CANCELAR"  && REGISTRAR,CANCELAR,CONSULTAR,FATURAR


   =ORGraXMLPddCredito( ;
          PrmEmp,;
		  PrmOsi,;
		  PrmSerie,;
   		  LSTipoOperacao)




RETURN(.T.)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK0I           ORXMLCnstPede_p_Liberar VALID      ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   52  ╨
*       ╨ Variable:            ORXMLCnstPede_p_Liberar            ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      47                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk0i     &&  ORXMLCnstPede_p_Liberar VALID
#REGION 1
RETURN

FUNCTION ORXMLCnstPede_p_Liberar
	PARAMETERS PrmEmp,PrmOsi,PrmSerie
	
   IF TYPE("PrmSerie") <> "C"
      PrmSerie = "001"
   ENDIF

   PRIVATE LSTipoOperacao

   LSTipoOperacao = "CONSULTAR"  && REGISTRAR,CANCELAR,CONSULTAR,FATURAR


   =ORGraXMLPddCredito( ;
          PrmEmp,;
		  PrmOsi,;
		  PrmSerie,;
   		  LSTipoOperacao)




RETURN(.T.)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK0O           ORXMLFatPede_p_Liberar VALID       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   53  ╨
*       ╨ Variable:            ORXMLFatPede_p_Liberar             ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      48                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk0o     &&  ORXMLFatPede_p_Liberar VALID
#REGION 1
RETURN

FUNCTION ORXMLFatPede_p_Liberar
	PARAMETERS PrmEmp,PrmOsi,PrmSerie
	
   IF TYPE("PrmSerie") <> "C"
      PrmSerie = "001"
   ENDIF

   PRIVATE LSTipoOperacao

   LSTipoOperacao = "FATURAR"  && REGISTRAR,CANCELAR,CONSULTAR,FATURAR


   =ORGraXMLPddCredito( ;
          PrmEmp,;
		  PrmOsi,;
		  PrmSerie,;
   		  LSTipoOperacao)




RETURN(.T.)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK0V           ORRtrnoCnstXMLPddCr VALID          ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   54  ╨
*       ╨ Variable:            ORRtrnoCnstXMLPddCr                ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      49                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk0v     &&  ORRtrnoCnstXMLPddCr VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION ORRtrnoCnstXMLPddCr
PARAMETERS PrmEmpresa, PrmOSI,PrmEspera, RtnStatus, Rtrn_Vlr_liberado



	IF TYPE("PrmEspera") <> "C" OR EMPTY(PrmEspera)
		PrmEspera = "ESPERA"
	ENDIF

	*-------------------------------------------------------------*
	*--> PARA DADOS RETORNO



	STORE "" TO 	  RtnStatus




	=W_DEFPROC("ORCAMENT.SPR")

		LSstatus = (ORRespXMLPddCR;
		      (;
				PrmEmpresa,;
	   			PrmOSI,;
  			    RtnStatus, ;
  			    Rtrn_Vlr_liberado;
			)




	IF  "ERRO" $ LSstatus
		WAIT WINDOW LSstatus  NOWAIT
	ENDIF

RETURN






*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK11           OREsperaRspPddCR VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   55  ╨
*       ╨ Variable:            OREsperaRspPddCR                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      50                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk11     &&  OREsperaRspPddCR VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION OREsperaRspPddCR
PARAMETERS PrmEmpresa, PrmNroDoc,Rtrn_Vlr_liberado


	*-------------------------------------------------------*
	PRIVATE LSstatus
	PRIVATE CtrAguarda

	LSstatus = ""
    Rtrn_Vlr_liberado = 0

    CtrAguarda = 0
	LFlgEspera = .t.

	DO WHILE LFlgEspera


		LSstatus=ORBuscaArqRspPddCR(PrmEmpresa, PrmNroDoc,Rtrn_Vlr_liberado)

		DO CASE
 		 	CASE "ERRO ! Espera interrompida por usr" $ LSstatus
				LFlgEspera = .F.
		
			CASE "ERRO ! Nao houve retorno do comando" $ LSstatus
				LFlgEspera = .T.


            OTHERWISE
				LFlgEspera = .F.

		ENDCASE
	ENDDO
    LSmsg = "Concluido leitura XML............ "
	WAIT WINDOW LSmsg NOWAIT

RETURN(LSstatus)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK12           ORBuscaRspPddCR VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   56  ╨
*       ╨ Variable:            ORBuscaRspPddCR                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      51                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk12     &&  ORBuscaRspPddCR VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION ORBuscaRspPddCR
PARAMETERS PrmEmpresa,PrmNro_Doc,Rtrn_Vlr_liberado

	*-------------------------------------------------------*

	PRIVATE LSnroDoc
	PRIVATE LNfile
	PRIVATE LSstatus,LSFile,LNctr,TECLA
    PRIVATE LNLimite_Liberado


    PRIVATE LSCampo
	PRIVATE LSConteudo


	*-------------------------------------------------------*
	*  obter o MOD_DOC
	*-------------------------------------------------------*



	*----------------------------------------------------------*

	LSstatus = ""
	LNfile = 0



	LSnroDoc  = CHRTRAN(STR(PrmNro_Doc,6)," ","")

	*--------------------------------------------------*

	=W_DEFPROC("PARAMETR.SPR")

	LSPathDestino   = PMGetFieldValue(PrmEmpresa,"DIR_DFIS")



    IF TYPE("LSPathDestino") <> "C" or EMPTY(LSPathDestino)
         LSPathDestino = "C:\NFE\"
	else
         LSPathDestino = ALLTRIM(LSPathDestino)
    ENDIF


	*--------------------------------------------------*



	LSFile    = LSPathDestino+"CR_"+LSnroDoc+".TXT"



	LNctr = 0

	CLEAR TYPEAHEAD


	DO WHILE !(FILE(LSFile))

	    LSmsg = STR(LNctr,3)+"-Aguarda NF  - <ESC>=Sai "+LSFile

		WAIT WINDOW LSmsg NOWAIT
		TECLA=INKEY(3)
		LNctr = LNctr + 1
		IF  LNctr > 60
			EXIT
		ENDIF
		IF TECLA = 27 OR LASTKEY() = 27
			IF fox_alert("Interrompe Espera NFe ? ")
				LSstatus = "ERRO ! Espera interrompida por usr"
				EXIT
			ENDIF
		ENDIF

	ENDDO


    LNLimite_Liberado = 0
    LSstatus = ""

	DO CASE
		CASE LSstatus = "ERRO ! Espera interrompida por usr"
 		 	LSstatus = "ERRO ! Espera interrompida por usr"

		CASE !FILE(LSFile)
			LSstatus = "ERRO ! Nao houve retorno do comando"

		OTHERWISE		
			TECLA=INKEY(3)
			LNfile=FOPEN(LSFile)	
			IF LNfile > 0
				LSstatus=""
				DO WHILE !FEOF(LNfile)


					LScampo    = RTRIM(UPPER(fgets(LNfile,255)))
	                IF FEOF(LNfile)
	                   EXIT
	                ENDIF
					LSconteudo = RTRIM(UPPER(fgets(LNfile,255)))


                    DO CASE
                       CASE  UPPER(LScampo) = "SLCR_LIMITE_LIBERADO"
                             LNLimite_Liberado = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "SLCR_STATUS"
                             LSStatus      = LSconteudo
                   ENDCASE
				
				ENDDO

				=FCLOSE(LNfile)



				**---- > RENOMEIA ????????.??K  =>  K de ok
				LSnewFile =  ;
					    STRtran(LSFile,".TXT",".K"+PrmMod_Doc)

			ELSE
				LSstatus = "ERRO ! Nao houve retorno do comando"


				**---- > RENOMEIA ????????.??E  =>  E de Erro
				LSnewFile =  ;
				    STRtran(LSFile,".TXT",".E"+PrmMod_Doc)

			ENDIF



			IF FILE(LSnewFile)
		   		delete file &LSnewFile
			ENDIF
			RENAME &LSFile TO &LSnewFile


	ENDCASE

    Rtrn_Vlr_liberado = 0

	*---------------------------------------------------*


RETURN(LSstatus)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK13           ORRespXMLPddCR VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   57  ╨
*       ╨ Variable:            ORRespXMLPddCR                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      52                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk13     &&  ORRespXMLPddCR VALID
#REGION 1
return
*---------------------------------------------------------------*
*		   PrmEsperaResposta,;
*		       && "ESPERA" ou "NAO ESPERA"
*
*---------------------------------------------------------------*

FUNCTION ORRespXMLPddCR

PARAMETER  PrmEmpresa,;
		   PrmNro_Doc,;
		   RtnStatus,;
		   Rtrn_Vlr_liberado

	*-------------------------------------------------------*

	PRIVATE LSalias
	PRIVATE PrmAlsDF

	LSalias = ALIAS()
	PrmAlsDF = DFGetAlias()

		
		
		
	*-------------------------------------------------------*
	PRIVATE LSstatus,LSstatus2
	LSstatus = ""
    LSstatus2 = ""

	IF PrmEsperaResposta = "ESPERA"
	   LSstatus=OREsperaRspPddCr(PrmEmpresa,PrmNro_Doc,Rtrn_Vlr_liberado)
	ELSE
	   LSstatus=ORBuscaArqRspNPddCr(PrmEmpresa,PrmNro_Doc,Rtrn_Vlr_liberado)
	ENDIF


	*-------------------------------------------------------*


	DO CASE

		CASE LSstatus = "ERRO ! Nao houve retorno do comando"
				RtnStatus = LSstatus
		OTHERWISE
				RtnStatus = LSstatus
	
	ENDCASE


   IF !EMPTY(LSalias) AND USED(LSalias)
	  SELECT &LSalias
   ENDIF


RETURN(LSstatus


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK14           ORXMLTenta_Liberar VALID           ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   58  ╨
*       ╨ Variable:            ORXMLTenta_Liberar                 ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      53                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk14     &&  ORXMLTenta_Liberar VALID
#REGION 1
RETURN

FUNCTION ORXMLTenta_Liberar
	PARAMETERS LNemp,LNosi

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Verificar Condicoes de Credito do Cliente
	*------------------------------------------------------------*
	* COMENTARIO..: Apos a edicao dos itens e na reserva as condi-
	*			coes do orcamento sao avaliadas com objetivo de
	*			liberara a venda atraves do campo SITUACAO
	*
	* 	&& usada para prever mudanca de situacao na reserva e
	*	&& no retorno da edicao dos itens
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp.......: Empresa em questao
	*		LNosi.......: Nro do Orcamento em questao
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*
	PRIVATE LDdt_libera		&& Retorna a Data de liberacao
	PRIVATE LNlim_libera	&& Retorna o valor a praso liberado
	PRIVATE LNlmt_parcela	&& Retorna se Existe Limitacao para Duplcat
	PRIVATE LNlim_prazo		&& Retorna o usuario (neste caso o SISTEMA=0)
	PRIVATE LSsit			&& Retorna a situacao Definida pelo Processo
	PRIVATE LNtp_parcela
	
	PRIVATE LSalias
	PRIVATE LForcament,LFclienc
	*-----------------------------------------------------------*
	LSalias	= ALIAS()

	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFliberacoes	= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFclienc+LFliberacoes) > 100000
		DO FCHtenta_lib
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHtenta_lib
		RETURN(.F.)
	ENDIF
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
		DO FCHtenta_lib
		RETURN(.F.)
	ENDIF

	SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(LNemp,3)+STR(LNosi,6)

	LSsit = orcament.situacao
	*------------------------------------------------------------*
	*	Condicoes de Liberacao :
	*						a - Imediata
	*						b - Conforme Informacoes
	*
	*------------------------------------------------------------*



	PRIVATE  PrmEmpresa,PrmOSI,PrmSerie,RtnStatus,Rtrn_Vlr_liberado
	PrmEmpresa = LNEmp
	PrmOSI     = LNOSI
	PrmSerie   = "000"
	RtnStatus  = ""
	Rtrn_Vlr_liberado = 0
	





	DO CASE
		CASE RIGHT(LSsit,1) = "F"
			*-------------------------------------------------*
			* Situacao = "F" && CREDITO BLOQUEADO SO SERA TRATADO
			*	 DIRETAMENTE PELA OCAO <8-Lib.Cred> e nao
			* automaticamente
			*-------------------------------------------------*
		CASE orcament.tp_parcela = 1 	&& A Vista
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO

		CASE orcament.tp_parcela = 4
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO
									  	 &&  Vendas em cartao sao liberadas
									  	 && sem verificacao
		CASE FOUND("liberaco") ;
			AND orcament.valor 		<= liberaco.limite ;
			AND orcament.prazomedio	<= liberaco.prazomedio ;
			AND orcament.tp_parcela = liberaco.tp_parcela
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO
									  	 &&  Permanecendo as mesmas
									  	 && condicoes da ultima liberacao

		CASE (orcament.lmt_parcela = "S" AND orcament.tp_parcela = 3)
			LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Existe Restricao a venda
									  	 && com duplicata


*---------------------------------------------
*****  >>>> MUDANCA EM RELACAO AO MODELO FOX PARA MODELO SERVICO XML
*---------------------------------------------
*		CASE ORVer_credito(clienc.cliente,  ;
*				orcament.valor - orcament.vlr_ent, 0, 0,;
*				    clienc.inscricao) = 0
*-----------------------------------------------------------



		CASE ORXMLVer_credito(PrmEmpresa,PrmOSI,PrmSerie,;
                              RtnStatus,Rtrn_Vlr_liberado) = 0





			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO
									  	 &&  Nфo havendo restricoes ao
										 && credito
		OTHERWISE
			LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Nao Existe Dados
									  	 && para liberacao
	ENDCASE

	*------------------------------------------------------------------*
	*	A rotina ORVer_credito desloca os registros de orcament para
	*	pesquisar o debito formado por osis em aberto , por isso e
	*  nescessario reposicionar o orcamento para regravar as codicoes
	*  de liberacao
	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHtenta_lib
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------------*

	SELE liberaco
	IF  RIGHT(LSsit,1) = "E"  && FOI LIBERADO
		m.data 		= 	wp_dtoper
		m.liberador =	0		&& SISTEMA
		m.tp_parcela= 	orcament.tp_parcela
		m.validade	=	wp_dtoper + 30
		m.situacao  =  "LIBE"
		m.limite 	=   orcament.valor - orcament.vlr_ent		
		m.prazomedio=   orcament.prazomedio


		IF FOUND("liberaco")
			IF liberaco.limite > orcament.valor - orcament.vlr_ent		
				m.limite 	= 	liberaco.limite
			ENDIF
			IF liberaco.prazomedio >   orcament.prazomedio
				m.prazomedio=   liberaco.prazomedio
			ENDIF
			=edithand('REGRAVA')
		ELSE
			m.empresa 	= 	orcament.empresa
			m.orcamento	=	orcament.orcamento
			m.limite 	= 	orcament.valor - orcament.vlr_ent		
			m.prazomedio=   orcament.prazomedio
			=edithand('SAVE')
		ENDIF
	ELSE
		m.situacao  =  "BLOQ"
		IF FOUND("liberaco")

			SET FIELDS TO situacao	&& SO ALTERAR CAMPO SITUACAO
									&& OS DEMAIS PERMANECEM
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
		ENDIF
	ENDIF

	SELE orcament
	m.situacao   = LSsit
	SET FIELDS TO situacao, dtregis, hregis, usrregis, deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------------*
	DO FCHtenta_lib

RETURN(.T.)


PROCEDURE FCHtenta_lib
	=UP_fecha("orcament",LForcament)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("liberaco" ,LFliberacoes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK20           ORXMLVer_credito VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   59  ╨
*       ╨ Variable:            ORXMLVer_credito                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      54                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gk20     &&  ORXMLVer_credito VALID
#REGION 1
RETURN

FUNCTION ORXMLVer_credito
	PARAMETER PrmEmpresa,PrmOSI,PrmSerie,RtnStatus,Rtrn_Vlr_liberado
	



    IF TYPE("PrmSerie") <> "C"
      PrmSerie = "000"
    ENDIF
	
	
	=W_DEFPROC("rotinas.spr")
    =ORXMLRegPede_p_Liberar(PrmEmpresa,PrmOSI,PrmSerie)



    PrmEspera = "ESPERA"
    RtnStatus = ""


    =ORRtrnoCnstXMLPddCr(PrmEmpresa, PrmOSI,PrmEspera, RtnStatus, ;
                         Rtrn_Vlr_liberado)

    IF "APROVADO" $ RtnStatus
       LNretorno = 0
    ELSE
       LNretorno = 999
    ENDIF

RETURN(LNretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK26           ORXMLCanc_Libera VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   60  ╨
*       ╨ Variable:            ORXMLCanc_Libera                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      55                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk26     &&  ORXMLCanc_Libera VALID
#REGION 1
RETURN

FUNCTION ORXMLCanc_Libera
	PARAMETERS LNemp,LNosi

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: cancela liberacao
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp.......: Empresa em questao
	*		LNosi.......: Nro do Orcamento em questao
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*
	PRIVATE LDdt_libera		&& Retorna a Data de liberacao
	PRIVATE LNlim_libera	&& Retorna o valor a praso liberado
	PRIVATE LNlmt_parcela	&& Retorna se Existe Limitacao para Duplcat
	PRIVATE LNlim_prazo		&& Retorna o usuario (neste caso o SISTEMA=0)
	PRIVATE LSsit			&& Retorna a situacao Definida pelo Processo
	PRIVATE LNtp_parcela
	
	PRIVATE LSalias
	PRIVATE LForcament,LFliberacoes
	*-----------------------------------------------------------*
	LSalias	= ALIAS()

	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFliberacoes	= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFliberacoes) > 100000
		DO FCHCanc_lib
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHCanc_lib
		RETURN(.F.)
	ENDIF

	SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(LNemp,3)+STR(LNosi,6)

	LSsit = orcament.situacao
	LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Existe Restricao a venda
									  	 && com duplicata
	*------------------------------------------------------------------*


	IF ORXMLCanc_credito(PrmEmpresa,PrmOSI,PrmSerie,;
                              RtnStatus,Rtrn_Vlr_liberado) = 0
		SELE liberaco
		m.empresa 	= 	orcament.empresa
		m.orcamento	=	orcament.orcamento
		m.data 		= 	wp_dtoper
		m.liberador =	0		&& SISTEMA
		m.tp_parcela= 	orcament.tp_parcela
		m.validade	=	wp_dtoper + 30
		m.situacao  =  "BLOQ"
		m.limite 	=   0
		m.prazomedio=   0
		IF FOUND("liberaco")
			=edithand('REGRAVA')
		ELSE
			=edithand('SAVE')
		ENDIF
		SELE orcament
		m.situacao   = LSsit
		SET FIELDS TO situacao, dtregis, hregis, usrregis, deletado
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
	ENDIF
	*------------------------------------------------------------------*
	DO FCHCanc_lib

RETURN(.T.)


PROCEDURE FCHCanc_lib
	=UP_fecha("orcament",LForcament)
	=UP_fecha("liberaco" ,LFliberacoes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK2F           ORXMLCanc_credito VALID            ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMNTA,     Record Number:   61  ╨
*       ╨ Variable:            ORXMLCanc_credito                  ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      56                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gk2f     &&  ORXMLCanc_credito VALID
#REGION 1
RETURN

FUNCTION ORXMLCanc_credito
	PARAMETER PrmEmpresa,PrmOSI,PrmSerie,RtnStatus,Rtrn_Vlr_liberado
	


    IF TYPE("PrmSerie") <> "C"
      PrmSerie = "000"
    ENDIF
	
	
	=W_DEFPROC("rotinas.spr")
    =ORXMLCanPede_p_Liberar(PrmEmpresa,PrmOSI,PrmSerie)



    PrmEspera = "ESPERA"
    RtnStatus = ""


    =ORRtrnoCnstXMLPddCr(PrmEmpresa, PrmOSI,PrmEspera, RtnStatus, ;
                         Rtrn_Vlr_liberado)


    IF "CANCELADO" $ RtnStatus
       LNretorno = 0
    ELSE
       LNretorno = 999
    ENDIF

RETURN(LNretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK2M           ORExiste VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:    3  ╨
*       ╨ Variable:            ORExiste                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      57                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk2m     &&  ORExiste VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ANTORExiste
PARAMETERS PrmEmp,PrmOrcamento
	Private FlgExiste
	FlgExiste=ORChk_Identidade(PrmEmp,PrmOrcamento)

RETURN(Lexiste)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK2N           ORGetValor VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:    4  ╨
*       ╨ Variable:            ORGetValor                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      58                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk2n     &&  ORGetValor VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORGetValor
PARAMETERS PrmEmp,PrmOrcamento

	=ORChk_Identidade(PrmEmp,PrmOrcamento)

RETURN(ORGetPropVT("VALOR"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK2O           ORGetDt_Fat VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:    5  ╨
*       ╨ Variable:            ORGetDt_Fat                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      59                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk2o     &&  ORGetDt_Fat VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORGetDt_fat
PARAMETERS PrmEmp,PrmOrcamento

	=ORChk_Identidade(PrmEmp,PrmOrcamento)

RETURN(ORGetPropVT("DT_FAT"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK2P           ORView VALID                       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:    6  ╨
*       ╨ Variable:            ORView                             ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      60                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk2p     &&  ORView VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORView
PARAMETERS PrmEmpresa
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE Lretorno
    PRIVATE ARQ_Clienc,ALS_Clienc


	LSalias		= 	ALIAS()

	=ORVerifyInst()
	*--------------------------------------------------------------*

    ARQ_Clienc  = NetArqAgain("CLIENC")
    ALS_Clienc  = Alias()
	*--------------------------------------------------------------*


	Lretorno = ""
    SELECT  ;
		 OR.empresa,;
		 OR.orcamento,;
		 OR.operador,;
		 OR.situacao,;
		 OR.data,;
		 cl.fone,;
		 OR.valor,;
		 cl.nome,;
		 OR.veiculo,;
		 OR.dtregis,;
		 OR.hregis,;
		 OR.usrregis ;
    	 FROM  &ALS_Clienc CL, &PBOrcamentAlias OR;
	WHERE OR.EMPRESA = PrmEmpresa ;
	      AND CL.EMPRESA = OR.EMPRESA ;
	      AND CL.ORCAMENTO = OR.ORCAMENTO ;
    ORDER BY OR.ORCAMENTO;
    INTO CURSOR ORVIEW


	ON KEY LABEL ESCAPE
  	DO loc_dlog WITH .T.,.F.,.F., .F., .F.,.F., "ORCABROW"
   	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	LNkey 	= LASTKEY()   && PERMITIR TRATAMENTO DA DESISTENCIA
							  && NA ROTINA CHAMADORA
	IF LASTKEY() <> 27
		Lretorno = ORVIEW.Orcamento
		=OR_Refresh(PrmEmpresa,Lretorno)
	ELSE
		Lretorno = 0
	ENDIF
	SELE ORVIEW
	USE
		
	*--------------------------------------------------------------*
   	=up_fecha("&ALS_Clienc")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(Lretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK2Q           ORVerifyInst VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:    7  ╨
*       ╨ Variable:            ORVerifyInst                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      61                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk2q     &&  ORVerifyInst VALID
#REGION 2
return
*---------------------------------------------------------------*



FUNCTION ORVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Orcament")


	DO CASE

		CASE TYPE("PBOrcamentAlias") = "U" ;
		   		OR EMPTY(PBOrcamentAlias) ;
		   		OR !USED(PBOrcamentAlias)
			=ORCreate()					

		CASE !("ORCAMENT.DBF" $ DBF(PBOrcamentAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBOrcamentAlias
			=ORCreate()					


		CASE  !(LSPath $ DBF(PBOrcamentAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=ORDestroi()				
			=ORCreate()					
	ENDCASE

	
RETURN(.t.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK3G           ORCreate VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:    8  ╨
*       ╨ Variable:            ORCreate                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      62                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk3g     &&  ORCreate VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBOrcamentAlias") <> "U" ;
	   		AND !EMPTY(PBOrcamentAlias) ;
	   		AND USED(PBOrcamentAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBOrcamentAlias

	IF USED("Orcament")
	     =NetArqAgain("Orcament")
	     PBOrcamentAlias     = Alias()
	ELSE
	     =NetArqAgain("Orcament")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Orcament")
	     PBOrcamentAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBOrcamentAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTOrcament[LMaxDim]&& VETOR PARA CAMPOS DA TABELA
    PUBLIC DIMENSION VDOrcament[2,3]	&& VETOR PARA CAMPOS DERIVADAS
    PUBLIC DIMENSION VFOrcament[1]      && VETOR CABECALHO DOS CAMPOS
    PUBLIC DIMENSION VCOrcament[8,3]	&& VETOR PARA CONFIGURACOES


	=AFIELDS(VFOrcament)



	*-----------------------------------------------------------*
	=ORReadProperty()
	=ORSetDerivadas()
	=ORSetConfig()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK3N           ORDestroi VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:    9  ╨
*       ╨ Variable:            ORDestroi                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      63                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk3n     &&  ORDestroi VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION ORDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBOrcamentAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBOrcamentAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBOrcamentAlias
	*  3- Se aplicar um FECHAMENTO a PBOrcamentAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBOrcamentAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBOrcamentAlias)) OR ;
	   !("ORCAMENT.DBF" $ DBF(PBOrcamentAlias))

		RELEASE PBOrcamentAlias
    	RELEASE VTOrcament
	    RELEASE VDOrcament
		RELEASE VFOrcament
		RELEASE VCOrcament
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBOrcamentAlias) AND USED(PBOrcamentAlias)
		SELECT &PBOrcamentAlias
		USE
	ENDIF	
	RELEASE PBOrcamentAlias
    RELEASE VTOrcament
    RELEASE VDOrcament
	RELEASE VFOrcament
	RELEASE VCOrcament

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK3U           ORReadProp VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   10  ╨
*       ╨ Variable:            ORReadProp                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      64                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk3u     &&  ORReadProp VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBOrcamentAlias
	SCATTER TO VTOrcament
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK40           ORSetDerivadas VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   11  ╨
*       ╨ Variable:            ORSetDerivadas                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      65                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk40     &&  ORSetDerivadas VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDOrcament(1,1) = "NAOINFORMADO"	&& TITULO	
   	VDOrcament(1,2) = 0					&& VALOR
   	VDOrcament(1,3) = .F.				&& FLAG .T. => FOI CARREGADO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK46           ORSetPropVT VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   12  ╨
*       ╨ Variable:            ORSetPropVT                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      66                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk46     &&  ORSetPropVT VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBOrcamentAlias,;
						    VTOrcament,;
						    VDOrcament,;
						    VFOrcament,;
						    VCOrcament)

RETURN(Lvalue)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK47           ORGetPropVT VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   13  ╨
*       ╨ Variable:            ORGetPropVT                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      67                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk47     &&  ORGetPropVT VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBOrcamentAlias,;
	            VTOrcament,;
	            VDOrcament,;
			    VFOrcament,;
			    VCOrcament)

RETURN(Lvalue)





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK48           ORChk_Identidade VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   14  ╨
*       ╨ Variable:            ORChk_Identidade                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      68                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk48     &&  ORChk_Identidade VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORChk_Identidade
PARAMETERS PrmEmpresa,PrmOrcamento

	PRIVATE LFretorno
	LFretorno = .t.

	=ORVerifyInst()

    =ORSetPropVT("EMPRESA",PrmEmpresa)
    =ORSetPropVT("ORCAMENTO",PrmOrcamento)

	LFretorno=ORFind()
RETURN(LFretorno)





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK49           ORFind VALID                       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   15  ╨
*       ╨ Variable:            ORFind                             ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      69                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk49     &&  ORFind VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORFind


	PRIVATE LEmpresa,LOrcamento
	PRIVATE LFreturn
	PRIVATE LSchaveAcesso


	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=ORVerifyInst()


	SELE &PBOrcamentAlias
	LSchaveAcesso  =ORGetPropVT("CHAVE DE LEITURA")


    LEmpresa =ORGetPropVT("EMPRESA")
    LOrcamento=ORGetPropVT("ORCAMENTO")



	SELE &PBOrcamentAlias
	DO CASE
		CASE UPPER(LSchaveAcesso) = "?????"
			SELE &PBOrcamentAlias

		OTHERWISE
			SET ORDER TO TAG geral
			SEEK STR(Lempresa,3)+STR(Lorcamento,6)	

	ENDCASE
	IF FOUND()
		=ORReadProperty()
		=ORSetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK4A           ORGetFieldValue VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   16  ╨
*       ╨ Variable:            ORGetFieldValue                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      70                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk4a     &&  ORGetFieldValue VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORGetFieldValue
PARAMETERS PrmEmp,PrmOrcamento,	PrmField

	=ORChk_Identidade(PrmEmp,PrmOrcamento)

RETURN(ORGetPropVT(PrmField))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK50           OR_Refresh VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   17  ╨
*       ╨ Variable:            OR_Refresh                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      71                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk50     &&  OR_Refresh VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION OR_Refresh
PARAMETERS PrmEmpresa,PrmOrcamento

	PRIVATE LFretorno
	LFretorno = .t.
	
	=ORVerifyInst()
	*----------------------------------------------------------------*
	
    =ORSetPropVT("EMPRESA",PrmEmpresa)
    =ORSetPropVT("ORCAMENTO",PrmOrcamento)
	LFretorno=ORFind()
	
RETURN(LFretorno)







*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK56           ORWriteProp VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   18  ╨
*       ╨ Variable:            ORWriteProp                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      72                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk56     &&  ORWriteProp VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBOrcamentAlias
	=RLOCK()
	GATHER FROM  VTOrcament
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK5B           ORGetAlias VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   19  ╨
*       ╨ Variable:            ORGetAlias                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      73                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk5b     &&  ORGetAlias VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORGetAlias

	=ORVerifyInst()

RETURN(PBOrcamentAlias)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK5H           ORSetConfig VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   20  ╨
*       ╨ Variable:            ORSetConfig                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      74                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk5h     &&  ORSetConfig VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORSetConfig

	*--------------------------------------------------------------*
    VCOrcament(1,1) = "REG_STATE" && INSERT/EDICAO/BROWSER/
   	VCOrcament(1,2) = ""
   	VCOrcament(1,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(2,1) = "CHV_LER" && p/ leitura do ultimo reg + 1
   	VCOrcament(2,2) = ""
   	VCOrcament(2,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(3,1) = "CHV_COMPARA" && p/ leitura do ultimo reg + 1
   	VCOrcament(3,2) = ""
   	VCOrcament(3,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(4,1) = "CHV_BROW" && p/ leitura do ultimo reg + 1
   	VCOrcament(4,2) = ""
   	VCOrcament(4,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(5,1) = "ISEDITING" && p/ leitura do ultimo reg + 1
   	VCOrcament(5,2) = .F.
   	VCOrcament(5,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(6,1) = "ISADDING" && p/ leitura do ultimo reg + 1
   	VCOrcament(6,2) = .F.
   	VCOrcament(6,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(7,1) = "ISREADING" && p/ leitura do ultimo reg + 1
   	VCOrcament(7,2) = .F.
   	VCOrcament(7,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(8,1) = "CHAVE DE LEITURA" && TAG DO CHAVE USADA EM FIND
   	VCOrcament(8,2) = "ORCAMENTO"
   	VCOrcament(8,3) = .T.
	*--------------------------------------------------------------*
	
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK5N           ORTrtChv VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   21  ╨
*       ╨ Variable:            ORTrtChv                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      75                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk5n     &&  ORTrtChv VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORTrtChv
PARAMETERS PrmEmpresa,PrmOrcamento

	PRIVATE LFretorno
	LFretorno = .t.

	=ORVerifyInst()


    =ORSetPropVT("EMPRESA",PrmEmpresa)
    =ORSetPropVT("ORCAMENTO",PrmOrcamento)
	*--------------------------------------------------------------*

	LFretorno=ORFind()

	SELE &PBOrcamentAlias
RETURN(UPtratachv())





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK5O           ORScatter VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   23  ╨
*       ╨ Variable:            ORScatter                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      76                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk5o     &&  ORScatter VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORScatter

	PRIVATE LFretorno
	LFretorno = .t.

	=ORVerifyInst()
	SELE &PBOrcamentAlias
	SCATTER MEMVAR MEMO
RETURN(.T.)






*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK5P           ORLerRegistro VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   27  ╨
*       ╨ Variable:            ORLerRegistro                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      77                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk5p     &&  ORLerRegistro VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORLerRegistro
PARAMETERS PrmEmpresa,PrmOrcamento



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = ORChk_Identidade(PrmEmpresa,PrmOrcamento)
RETURN(LFretorno)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK5Q           ORSalvarRegistro VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   28  ╨
*       ╨ Variable:            ORSalvarRegistro                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      78                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk5q     &&  ORSalvarRegistro VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORSalvarRegistro

	=ORVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !ORExiste()
		SELE &PBOrcamentAlias
		APPEND BLANK
		LFretorno=ORWriteProp()
	ELSE
		SELE &PBOrcamentAlias
		LFretorno=ORWriteProp()
	ENDIF

RETURN(LFretorno)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK5R           ORExiste VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   29  ╨
*       ╨ Variable:            ORExiste                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      79                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk5r     &&  ORExiste VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ORExiste


	PRIVATE LEmpresa,LOrcamento
	PRIVATE LFreturn
	PRIVATE LSchaveAcesso


	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=ORVerifyInst()


	SELE &PBOrcamentAlias
	LSchaveAcesso  =ORGetPropVT("CHAVE DE LEITURA")


    LEmpresa =ORGetPropVT("EMPRESA")
    LOrcamento=ORGetPropVT("ORCAMENTO")



	SELE &PBOrcamentAlias
	DO CASE
		CASE UPPER(LSchaveAcesso) = "?????"
			SELE &PBOrcamentAlias

		OTHERWISE
			SET ORDER TO TAG geral
			SEEK STR(Lempresa,3)+STR(Lorcamento,6)	

	ENDCASE
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK6J           ORBtnVal VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   30  ╨
*       ╨ Variable:            ORBtnVal                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      80                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk6j     &&  ORBtnVal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLBtnVal
PARAMETERS PrmTecla

	PRIVATE Lchv_Ler
	PRIVATE Lchv_Compara
	PRIVATE Lchv_Brow
	PRIVATE LOrcamento


	=ORVerifyInst()

	Lchv_ler    = ORGetPropVT("CHV_LER")
	Lchv_compara= ORGetPropVT("CHV_COMPARA")
	Lchv_brow   = ORGetPropVT("CHV_BROW")

	
	SELE &PBOrcamentAlias
	DO CASE
	
		CASE PrmTecla = "LOCATE"

			LOrcamento     = ORGetPropVT("ORCAMENTO")

			=ORView(LOrcamento)
			SELE &PBOrcamentAlias
			SCATTER MEMVAR MEMO

			
		OTHERWISE

		    DO btn_val with PrmTecla,;
	   			       Lchv_ler,;
	   			       Lchv_compara,;
	   			       Lchv_brow,;
	   			       .T.,;
	   			       .T.
	   			
	ENDCASE
	   			
	=ORSetPropVT("ISEDITING",ISEDITING)
	=ORSetPropVT("ISADDING",ISADDING)
	=ORSetPropVT("ISREADING",ISREADING)
	   			
RETURN(.t.)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK6Q           ORView VALID                       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   31  ╨
*       ╨ Variable:            ORView                             ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      81                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk6q     &&  ORView VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK6V           ORLOCATE VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   32  ╨
*       ╨ Variable:            ORLOCATE                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      82                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk6v     &&  ORLOCATE VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK71           ORGeraBTS VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   34  ╨
*       ╨ Variable:            ORGeraBTS                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      83                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk71     &&  ORGeraBTS VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORGeraBTS
PARAMETERS  PrmEmp,;
			PrmOrcamento,;
			PrmFile,;
			PrmNroIDFile


	PRIVATE LAliasOR
	PRIVATE LAliasEmpresa
	PRIVATE LAliasClienc


	PRIVATE Ltmp


	IF !ORLerRegistro(PrmEmp,PrmOrcamento)
	      wait "Nao foi localizado OSI :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "OSI: "+STR(PrmOrcamento,6)
    	  return(.F.)
	ENDIF




	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinha

	*-------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	=EMLerRegistro(PrmEmp)


	=W_DEFPROC("CLIENC.SPR")
	=CNLerRegistro(PrmEmp,PrmOrcamento)


	LAliasOR=ORGetAlias()

	=W_DEFPROC("CLIENC.SPR")
	LAliasClienc = CNGetAlias()


	=W_DEFPROC("EMPRESA.SPR")
	LAliasEmpresa = EMGetAlias()


	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("CGC")
    UNEM_CNPJ    =  STR(LFieldTmp,14)


	*-------------------------------------------------------*

	LSLinha = 'REG01'
	*--> CODIGO IDENTIFCADOR DA BTS
	LSLinha = LSLinha+'027399'

	*--> CODIGO IDENTIFCADOR DA BTS
	LSLinha = LSLinha+CHRTRAN(STR(PrmOrcamento,6)," ","0") +SPACE(24)


    set centu off
	Ltmp    = CHRTRAN(DTOC( &LAliasOR .data),".","")
    set centu on


	LSLinha = LSLinha+Ltmp

	LSLinha = LSLinha+ &LAliasOR .hora
	LSLinha = LSLinha+ "1"    && 1-VENDA BALCAO
	LSLinha = LSLinha+ "5"    && SITUACAO 5-FATURADA
	


	=W_DEFPROC("EMPRESA.SPR")
	Ltmp = EMGetFieldValue(PrmEmp,"GRTREL_BTS")
	LSLinha = LSLinha+LEFT(Ltmp+SPACE(50),50)



	IF &LAliasOR .prazomedio = 0
		LSLinha = LSLinha+LEFT("A VISTA"+SPACE(50),50)
	ELSE	
		LSLinha = LSLinha+LEFT("A PRAZO"+SPACE(50),50)
	ENDIF

	LSLinha = LSLinha+ &LAliasOR .placa

	LSLinha = LSLinha+ LEFT( &LAliasOR .montadora+SPACE(50),50)
	LSLinha = LSLinha+ LEFT( &LAliasOR .veiculo+SPACE(50),50)
	LSLinha = LSLinha+ LEFT( &LAliasOR .conf_veic+SPACE(5),5)
	LSLinha = LSLinha+ CHRTRAN(STR( &LAliasOR .anofabveic ,4)," ","0")
	LSLinha = LSLinha+ LEFT( &LAliasOR .cor_veic+SPACE(30),30)
	LSLinha = LSLinha+ SPACE(50) && CARROCERIA
	LSLinha = LSLinha+ LEFT( &LAliasOR .LICENCA_TX+SPACE(30),30)


	IF &LAliasClienc .tp_pessoa = 1    && PESSOA FISICA
		Ltmp = CHRTRAN(STR( &LAliasClienc .CLIENTE,11)," ","0")
	ELSE	
		Ltmp = ""
	ENDIF
	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(20),20)

	IF &LAliasClienc .tp_pessoa = 2    && PESSOA JURIDICA
		Ltmp = CHRTRAN(STR( &LAliasClienc .CLIENTE,14)," ","0")
	ELSE	
		Ltmp = ""
	ENDIF
	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(20),20)

	LSLinha = LSLinha+ LEFT( &LAliasClienc .NOME+SPACE(60),60)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .CEP+SPACE(8),8)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .ENDERECO+SPACE(200),200)
	LSLinha = LSLinha+ SPACE(10)    && TIPO LOGRADOURO
	LSLinha = LSLinha+ SPACE(100)   && DESCRICAO LOGRADOURO
	LSLinha = LSLinha+ SPACE(10)    && NUMERO LOGRADOURO
	LSLinha = LSLinha+ SPACE(50)    && COMPLEMENTO
	LSLinha = LSLinha+ LEFT( &LAliasClienc .BAIRRO+SPACE(40),40)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .CIDADE+SPACE(40),40)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .ESTADO+SPACE(2),2)
	IF EMPTY( &LAliasClienc .PAIS)
		LSLinha = LSLinha+ LEFT( "BRASIL"+SPACE(10),10)
	ELSE
		LSLinha = LSLinha+ LEFT( &LAliasClienc .PAIS+SPACE(10),10)
	ENDIF
	
	LSLinha = LSLinha+ LEFT( &LAliasClienc .CX_POSTAL+SPACE(10),10)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .E_MAIL+SPACE(100),100)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .RAMO_TRAB+SPACE(30),30)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .DSCRREGIAO+SPACE(30),30)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .DDD+SPACE(10),10)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .FONE+SPACE(20),20)

	LSLinha = LSLinha+ SPACE(50)    && NOME CONDUTOR

	Ltmp = CHRTRAN(STR( &LAliasOR .HODOM,6)," ","0")

	LSLinha = LSLinha+ LEFT( Ltmp +SPACE(10),10)

	=fPuts(PrmNroIDFile,LSLinha,LEN(LSLinha))



RETURN(.t.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK7B           ORGerBTS1 VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   35  ╨
*       ╨ Variable:            ORGerBTS1                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      84                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk7b     &&  ORGerBTS1 VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORGerBTS1
PARAMETER PrmEmpresa,PrmDtIni,PrmDtFim




	PRIVATE LSalias
	
	PRIVATE PrmAlsOrcament
	PRIVATE PrmAlsTmpOrca
	
	LSalias = ALIAS()


	=W_DEFPROC("ORCATMP.SPR")
	PrmAlsOrcament = ORGetAlias()

	LSalias = ALIAS()

	=W_DEFPROC("ORCATMP.SPR")
	PrmAlsTmpOrca = OTGetAlias()




	*-------------------------------------------------------*

   	PRIVATE LSfileTXT,LNroIDfileTXT

   	LSfileTXT	= "\SCGC\EXPORTA\BTS.TXT"
  	LNroIDfileTXT 		=fcreate(LSfileTXT)
   	if LNroIDfileTXT<0
      =fclose(LNroIDfileTXT)
      wait 'ERRO cria┤фo arquivo tempor═rio '+LSfileTXT+'- <ENTER> ' window
      return
   	endif


	*---------------------------------------------------*

	SELE &PrmAlsOrcament
	SET ORDER TO TAG DATA_FAT
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+DTOS(PrmDtIni)
	SET NEAR OFF

	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() ;
	        AND PrmEmpresa =  &PrmAlsOrcament .empresa;
	        AND PrmDtIni   <= &PrmAlsOrcament .dt_fat ;
	        AND PrmDtFim   >= &PrmAlsOrcament .dt_fat ;
         TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*



	SELE &PrmAlsOrcament
	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa =  &PrmAlsOrcament .empresa;
	        AND PrmDtIni   <= &PrmAlsOrcament .dt_fat ;
	        AND PrmDtFim   >= &PrmAlsOrcament .dt_fat

		=UPtermo()
		LRegOrcamento = RECNO()

		IF LEFT( &PrmAlsOrcament .SITUACAO,1) = "O"  ;
		   AND &PrmAlsOrcament .E_OSI_BTS = 1    && OSI BTS FATURADA

			=ORGeraBTS(;
				&PrmAlsOrcament .Empresa,;
				&PrmAlsOrcament .Orcamento,;
				LSfileTXT,;
				LNroIDfileTXT)

	
			SELE &PrmAlsTmpOrca
			SET ORDER TO TAG orcamento
			SET NEAR ON
			SEEK STR(PrmEmpresa,3)+STR( &PrmAlsOrcament .Orcamento,6)
			SET NEAR OFF
	
			
			DO WHILE !EOF() ;
				AND	LFsegue = .t. ;
	        	AND PrmEmpresa =  &PrmAlsTmpOrca .empresa;
		        AND &PrmAlsOrcament .Orcamento = &PrmAlsTmpOrca .orcamento
	
				LRegItemOrcamento = RECNO()

				IF LEFT( &PrmAlsTmpOrca .SITUACAO,1) = "O"  ;
		
					IF &PrmAlsTmpOrca .tp_mercad = 7
						=ORGeraSrvcBTS(;
							&PrmAlsTmpOrca .Empresa,;
							&PrmAlsTmpOrca .Orcamento,;
							&PrmAlsTmpOrca .Ordem,;
							LSfileTXT,;
							LNroIDfileTXT)
					ELSE
						=ORGeraProdBTS(;
							&PrmAlsTmpOrca .Empresa,;
							&PrmAlsTmpOrca .Orcamento,;
							&PrmAlsTmpOrca .Ordem,;
							LSfileTXT,;
							LNroIDfileTXT)
	
					ENDIF
				ENDIF
				SELE &PrmAlsTmpOrca
				SET ORDER TO TAG orcamento
				GO LRegItemOrcamento
				SKIP
			ENDDO
		ENDIF

		
		SELE &PrmAlsOrcament
		SET ORDER TO TAG DATA_FAT
		GO LRegOrcamento
		SKIP
	ENDDO


	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileTXT)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK7C           ORGeraProdBTS VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   36  ╨
*       ╨ Variable:            ORGeraProdBTS                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      85                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk7c     &&  ORGeraProdBTS VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORGeraProdBTS
PARAMETERS  PrmEmp,;
			PrmOrcamento,;
			PrmOrdem,;
			PrmFile,;
			PrmNroIDFile



	PRIVATE PrmAlsTmpOrca




	PRIVATE Ltmp


	=W_DEFPROC("ORCATMP.SPR")
	IF !OTLerRegistro(PrmEmp,PrmOrcamento,PrmOrdem)
	      wait "Nao foi localizado OSI :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "OSI: "+STR(PrmOrcamento,6)+;
		      "ITEM: "+STR(PrmOrdem,2)
    	  return(.F.)
	ENDIF


	=W_DEFPROC("ORCATMP.SPR")
	PrmAlsTmpOrca = OTGetAlias()



	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinha

	*-------------------------------------------------------*


	*-------------------------------------------------------*

	LSLinha = 'REG02'
	*--> CODIGO IDENTIFCADOR DA BTS
	LSLinha = LSLinha+'027399'


	*--> CODIGO IDENTIFCADOR DA BTS
	LSLinha = LSLinha+CHRTRAN(STR(PrmOrcamento,6)," ","0") +SPACE(24)


	*--> CODIGO DO PRODUTO NO BTS
	LSLinha = LSLinha+ LEFT( &PrmAlsTmpOrca .codigo+SPACE(50),50)

	*--> CODIGO DO PRODUTO FABRICANTE
	=W_DEFPROC("GRUPO.SPR")
	Ltmp = GRGetFieldValue( &PrmAlsTmpOrca .codigo, ;
	                                  "CDG_NO_FBR")

	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(50),50)




	*--> CODIGO DE BARRA DO PRODUTO NO BTS
	Ltmp    = ""
	LSLinha = LSLinha+ LEFT( Ltmp +SPACE(50),50)


	*--> DESCRICAO DO PRODUTO NO BTS
	LSLinha = LSLinha+ LEFT( &PrmAlsTmpOrca .descricao+SPACE(100),100)


	*--> APLICACAO DO PRODUTO
	=W_DEFPROC("GRUPO.SPR")
	Ltmp = GRGetFieldValue( &PrmAlsTmpOrca .codigo, ;
	                                  "APLICACAO")

	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(50),50)


	*--> QTDE
	Ltmp    = STR( &PrmAlsTmpOrca .qtde ,15,5)
	Ltmp    = CHRTRAN(Ltmp," ","0")
	Ltmp    = CHRTRAN(Ltmp,".","")
	Ltmp    = CHRTRAN(Ltmp,",","")
	LSLinha = LSLinha+Ltmp


	*--> VLR UNITARIO
	Ltmp    = STR( &PrmAlsTmpOrca .vlrvenda / &PrmAlsTmpOrca .qtde ,15,5)
	Ltmp    = CHRTRAN(Ltmp," ","0")
	Ltmp    = CHRTRAN(Ltmp,".","")
	Ltmp    = CHRTRAN(Ltmp,",","")
	LSLinha = LSLinha+Ltmp


	*--> PROD ENTREGUE
	Ltmp    = "S"
	LSLinha = LSLinha+Ltmp


	*--> PROD TEXTO
	Ltmp    = SPACE(2000)
	LSLinha = LSLinha+Ltmp


	=W_DEFPROC("GRUPO.SPR")
	Ltmp = GRGetNomeFab( &PrmAlsTmpOrca .codigo)
	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(50),50)


	*--> CODIGO NCM
	=W_DEFPROC("GRUPO.SPR")
	Ltmp = GRGetFieldValue( &PrmAlsTmpOrca .codigo, ;
	                                  "COD_NCM")
	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(10),10)

	*---------------------------------------------*

	=fPuts(PrmNroIDFile,LSLinha,LEN(LSLinha))



RETURN(.t.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK7D           ORGeraSrvcBTS VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   37  ╨
*       ╨ Variable:            ORGeraSrvcBTS                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      86                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk7d     &&  ORGeraSrvcBTS VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORGeraSrvcBTS
PARAMETERS  PrmEmp,;
			PrmOrcamento,;
			PrmOrdem,;
			PrmFile,;
			PrmNroIDFile



	PRIVATE PrmAlsTmpOrca , 	LAliasOR





	PRIVATE Ltmp




	IF !ORLerRegistro(PrmEmp,PrmOrcamento)
	      wait "Nao foi localizado OSI :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "OSI: "+STR(PrmOrcamento,6)
    	  return(.F.)
	ENDIF




	=W_DEFPROC("ORCATMP.SPR")
	IF !OTLerRegistro(PrmEmp,PrmOrcamento,PrmOrdem)
	      wait "Nao foi localizado OSI :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "OSI: "+STR(PrmOrcamento,6)+;
		      "ITEM: "+STR(PrmOrdem,2)
    	  return(.F.)
	ENDIF


	=W_DEFPROC("ORCATMP.SPR")
	PrmAlsTmpOrca = OTGetAlias()



	=W_DEFPROC("ORCAMENT.SPR")
	LAliasOR=ORGetAlias()





	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinha

	*-------------------------------------------------------*


	*-------------------------------------------------------*

	LSLinha = 'REG03'

	*--> CODIGO IDENTIFCADOR DA BTS
	LSLinha = LSLinha+'027399'

	*--> CODIGO IDENTIFCADOR DA ORDEM SERVICO BTS
	LSLinha = LSLinha+CHRTRAN(STR(PrmOrcamento,6)," ","0") +SPACE(24)


	*--> CODIGO DO PRODUTO NO BTS
	LSLinha = LSLinha+ LEFT( &PrmAlsTmpOrca .codigo+SPACE(50),50)

	*--> DESCRICAO DO PRODUTO NO BTS
	LSLinha = LSLinha+ LEFT( &PrmAlsTmpOrca .descricao+SPACE(100),100)



	*--> DATA EXECUCAO
    set centu off
	Ltmp    = CHRTRAN(DTOC( &LAliasOR .dt_fat),".","")
    set centu on

	LSLinha = LSLinha+Ltmp





	*--> TEMPO EXECUCAO

	**** Ltmp    = CHRTRAN( &PrmAlsTmpOrca .Tempo_exec, ":","")

	Ltmp = UPtempopas( &LAliasOR .dt_res , ;
	             &LAliasOR .dt_fat , ;
	             &LAliasOR .hora_res ,;
	             &LAliasOR .hora_fat )


    Ltmp=UPFrmtaTempo(Ltmp)

	LSLinha = LSLinha+ LEFT( LEFT(Ltmp,2)+subs(ltmp,4,2)+SPACE(6),6)

	*--> NOME EXECUTOR
	=W_DEFPROC("USUARIO.SPR")
	Ltmp    = USGetNomeUsr( &PrmAlsTmpOrca .executante)


	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(100),100)

*------------------------------->

	*--> VLR SERVICO
	Ltmp    = STR( &PrmAlsTmpOrca .vlrvenda,15,2)
	Ltmp    = CHRTRAN(Ltmp," ","0")
	Ltmp    = CHRTRAN(Ltmp,".","")
	Ltmp    = CHRTRAN(Ltmp,",","")
	LSLinha = LSLinha+Ltmp


	*--> STATUS SERVICO
	Ltmp    = "F"
	LSLinha = LSLinha+Ltmp


	*---------------------------------------------*

	=fPuts(PrmNroIDFile,LSLinha,LEN(LSLinha))



RETURN(.t.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK82           ORGerBTS2 VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   38  ╨
*       ╨ Variable:            ORGerBTS2                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      87                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk82     &&  ORGerBTS2 VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORGerBTS2
PARAMETER PrmEmpresa,PrmOSI




	PRIVATE LSalias
	
	PRIVATE PrmAlsOrcament
	PRIVATE PrmAlsTmpOrca
	
	LSalias = ALIAS()


	=W_DEFPROC("ORCATMP.SPR")
	PrmAlsOrcament = ORGetAlias()

	LSalias = ALIAS()

	=W_DEFPROC("ORCATMP.SPR")
	PrmAlsTmpOrca = OTGetAlias()



	SET STEP ON

	*---------------------------------------------------*

	SELE &PrmAlsOrcament
	SET ORDER TO TAG GERAL
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmOSI,6)
	SET NEAR OFF

   	if !FOUND()
      wait 'OSI nao localizada- <ENTER> ' window
  	  SELECT &LSalias
      return
   	endif

	IF LEFT( &PrmAlsOrcament .SITUACAO,1) <> "O"
      wait 'OSI nao faturada- <ENTER> ' window
 * 	  SELECT &LSalias
 *     return
   	endif


	IF &PrmAlsOrcament .E_OSI_BTS = 1    && OSI BTS FATURADA
      wait 'OSI nao definida como BTS- <ENTER> ' window
  	  SELECT &LSalias
      return
   	endif


	*-------------------------------------------------------*

   	PRIVATE LSfileTXT,LNroIDfileTXT

   	LSfileTXT	= "\SCGC\EXPORTA\OS"+STR(PrmOSI,6)+".TXT"
   	LSfileTXT   = CHRTRAN(LSfileTXT," ","0")

  	LNroIDfileTXT 		=fcreate(LSfileTXT)
   	if LNroIDfileTXT<0
      =fclose(LNroIDfileTXT)
      wait 'ERRO cria┤фo arquivo tempor═rio '+LSfileTXT+'- <ENTER> ' window
      return
   	endif


	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

    LNimpressao = 1
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*



	SELE &PrmAlsOrcament

	=UPtermo()
	LRegOrcamento = RECNO()


	=ORGeraBTS(;
			&PrmAlsOrcament .Empresa,;
			&PrmAlsOrcament .Orcamento,;
			LSfileTXT,;
			LNroIDfileTXT)


    *-----------------------------------*
    *---> GERAR REGISTROS TIPO 2 PRODUTOS
    *-----------------------------------*
	
	SELE &PrmAlsTmpOrca
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR( &PrmAlsOrcament .Orcamento,6)
	SET NEAR OFF
	
			
	DO WHILE !EOF() ;
		AND	LFsegue = .t. ;
       	AND PrmEmpresa =  &PrmAlsTmpOrca .empresa;
        AND &PrmAlsOrcament .Orcamento = &PrmAlsTmpOrca .orcamento
	
		LRegItemOrcamento = RECNO()
		IF !(LEFT( &PrmAlsTmpOrca .SITUACAO,1) $ "yY")
		

				IF &PrmAlsTmpOrca .tp_mercad <> 7
					=ORGeraProdBTS(;
						&PrmAlsTmpOrca .Empresa,;
						&PrmAlsTmpOrca .Orcamento,;
						&PrmAlsTmpOrca .Ordem,;
						LSfileTXT,;
						LNroIDfileTXT)

				ENDIF

		ENDIF
		SELE &PrmAlsTmpOrca
		SET ORDER TO TAG orcamento
		GO LRegItemOrcamento
		SKIP
	ENDDO
		

    *-----------------------------------*
    *---> GERAR REGISTROS TIPO 3 SERVICOS
    *-----------------------------------*

	SELE &PrmAlsTmpOrca
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR( &PrmAlsOrcament .Orcamento,6)
	SET NEAR OFF
	
			
	DO WHILE !EOF() ;
		AND	LFsegue = .t. ;
       	AND PrmEmpresa =  &PrmAlsTmpOrca .empresa;
        AND &PrmAlsOrcament .Orcamento = &PrmAlsTmpOrca .orcamento
	
		LRegItemOrcamento = RECNO()
		IF !(LEFT( &PrmAlsTmpOrca .SITUACAO,1) $ "yY")
		

				IF &PrmAlsTmpOrca .tp_mercad = 7
					=ORGeraSrvcBTS(;
						&PrmAlsTmpOrca .Empresa,;
						&PrmAlsTmpOrca .Orcamento,;
						&PrmAlsTmpOrca .Ordem,;
						LSfileTXT,;
						LNroIDfileTXT)
				ENDIF

		ENDIF
		SELE &PrmAlsTmpOrca
		SET ORDER TO TAG orcamento
		GO LRegItemOrcamento
		SKIP
	ENDDO
		
    *-----------------------------------*


	SELE &PrmAlsOrcament
	SET ORDER TO TAG DATA_FAT
	GO LRegOrcamento
	SKIP


	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileTXT)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK8D           OREditaBTS VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ORCAMENT,     Record Number:   39  ╨
*       ╨ Variable:            OREditaBTS                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      88                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk8d     &&  OREditaBTS VALID
#REGION 2
RETURN

FUNCTION OREditaBTS
	PARAMETERS  LNemp,LNorca
	*---------------------------------------------------------*
	*	Objetivo : Chamar Rotina para Informar Dados do Cliente
	*---------------------------------------------------------*
	SELE orcament
	LNregistro	=	RECNO()

	DO SVD0200A.SPR with LNemp, LNorca

	GO LNregistro
	CLEAR TYPEAHEAD

RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK8K           PRVlrSaida VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:    2     ╨
*       ╨ Variable:            PRVlrSaida                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      89                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk8k     &&  PRVlrSaida VALID
#REGION 3
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRVlrSaida
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto, PrmEspecifico

	=W_DEFPROC("rotinas.spr")
	PRIVATE LNvalor
	PRIVATE LSalias

	PRIVATE LNtp_mercad
	
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_orcamento,ALS_orcamento
    PRIVATE ARQ_clienc,ALS_clienc
    PRIVATE ARQ_tipooper,ALS_tipooper
    PRIVATE ARQ_grupo,ALS_grupo
    PRIVATE ARQ_saldo,ALS_saldo
    PRIVATE ARQ_Preco,ALS_Preco




	LSalias = ALIAS()
	LNvalor = 0

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_orcamento     = NetArqAgain("ORCAMENTO")
    ALS_Orcamento     = Alias()

    ARQ_clienc     = NetArqAgain("clienc")
    ALS_clienc     = Alias()


    ARQ_Tipooper     = NetArqAgain("TIPOOPER")
    ALS_Tipooper     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Saldo     = NetArqAgain("SALDO")
    ALS_Saldo     = Alias()

    ARQ_Preco     = NetArqAgain("PRECO")
    ALS_Preco     = Alias()


	IF (ARQ_Empresa + ARQ_Orcamento+ARQ_tipooper+;
		ARQ_grupo+ARQ_Saldo+ARQ_Preco+Arq_clienc) > 100000
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF
	*---------------------------------------------------------*
    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

	SELECT &ALS_Clienc
	SET ORDER TO tag emporca
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF


	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

	*------------------------------------------------------------*
	=W_DEFPROC("TRIBUTAR.SPR")

	DO CASE

        *------------------------------------------------------------*
        * A venda bonificacao deve sair com mesmo valor aplicado as  *
        * transferencias                                             *
        *------------------------------------------------------------*
		Case TYPE("PrmEspecifico") = "C"
		    DO CASE
			  CASE PrmEspecifico = "VENDA BONIFICACAO"
				LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
					ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)
		    ENDCASE

		CASE &ALS_tipooper .ch_opera = "2" && TRANSFERENCIAS
			LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
				ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)

		CASE &ALS_tipooper .tipo = "RDO" && REMESP DEPO.FECHADO
			LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
				ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)

		CASE left( &ALS_tipooper .tipo,1) = "R" && REMESSAS EM GERAL
			LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
				ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)


		OTHERWISE
			LNvalor = PRVlrVenda(PrmEmpresa, PrmOrcamento, PrmProduto,;
	 			ALS_Empresa,ALS_Orcamento,ALS_Preco)

	ENDCASE

	*------------------------------------------------------------*

    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Orcamento")
    =up_fecha("&ALS_Tipooper")
    =up_fecha("&ALS_Grupo")
    =up_fecha("&ALS_Saldo")
    =up_fecha("&ALS_Preco")
    =up_fecha("&ALS_Clienc")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNvalor)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK8L           PRVlrTransf VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:    3     ╨
*       ╨ Variable:            PRVlrTransf                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      90                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk8l     &&  PRVlrTransf VALID
#REGION 3
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRVlrTransf
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto,;
		ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo


	=W_DEFPROC("rotinas.spr")
	PRIVATE LNvalor
	PRIVATE LSalias

	PRIVATE LNtp_mercad
	

	LSalias = ALIAS()
	LNvalor = 0

	*---------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF


    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF


	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

	*------------------------------------------------------------*
**    IF &ALS_tipooper .ch_opera = "2" && TRANSFERENCIAS


        DO CASE

		  CASE &ALS_Orcamento .data < CTOD("01.05.2003")
			DO trf_ate010503

		  CASE &ALS_Orcamento .data < CTOD("01.09.2012")
			DO trf_dep010503
          OTHERWISE

			DO trf_dep010912

        ENDCASE



				
****  ENDIF
	*------------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNvalor)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK8M           PRVlrVenda VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:    4     ╨
*       ╨ Variable:            PRVlrVenda                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      91                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*


FUNCTION _42s11gk8m     &&  PRVlrVenda VALID
#REGION 3
return
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Pre┤o de Tabela do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*					- TABELA EM VIGOR : Conforme a data passada
	*				como parametro;
	*
	*					- EMPRESA DE REFERENCIA : Duas Empresas podem
	*				usar uma tabela comum para evitar redundancia de
	*				informa┤Дes ;
	*					EX : SIA usa tabela 2 (EMPTAB = 2)
	*						 W-3 refere a mesma (EMPTAB = 2)
	*
	*					- PRECO DIFERENCIADO PARA :
	*						Transferencia
	*						Vendas E Outras
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LSnatu_oper....: Indicativo da Natureza da Opercao
	*							(2) = 	Transferencia
	*							(<>2)	=	Outras Operacoes
	*						  Alteram a forma de definir o preco
	*		LSTpOper.......: TIPO Identificador da Operacao Comercial
	*		LScodigo..........: Codigo do produto
    *       LDdata.........: Data para Refereciar a tabela em Vigor
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNpreco........: Preco Localizado
	*		LSclascms......: Grupo de Comissao 		
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRVlrVenda
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto,;
 			ALS_Empresa,ALS_Orcamento,ALS_Preco

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LNpreco
	PRIVATE LNtbVigor, LSsrVigor

	*-----------------------------------------------------------*

	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LNpreco 	= 0
	STORE 0  TO LNtbVigor
	STORE "" TO LSsrVigor

	*-----------------------------------------------------------*
	*-----------------------------------------------------------*
	*--------------------------------------------------------

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF
	

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	*------------------------------------------------------------*

	IF !PRtabvigor(( &ALS_Orcamento .data ),LNtbVigor, LSsrVigor)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	*------------------------------------------------------------*
    SELECT &ALS_preco
   	SET ORDER TO TAG tabela
    IF SEEK(STR( &ALS_empresa .emptab,3);
           +STR( LNtbVigor ,3)+ LSsrVigor + PrmProduto)
       LNpreco 		=   &ALS_preco .preco
    ELSE
        LNpreco 	=	0
	ENDIF
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNpreco)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK8N           PRClas_Cms VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:    5     ╨
*       ╨ Variable:            PRClas_Cms                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      92                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*


FUNCTION _42s11gk8n     &&  PRClas_Cms VALID
#REGION 3
return
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Pre┤o de Tabela do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*					- TABELA EM VIGOR : Conforme a data passada
	*				como parametro;
	*
	*					- EMPRESA DE REFERENCIA : Duas Empresas podem
	*				usar uma tabela comum para evitar redundancia de
	*				informa┤Дes ;
	*					EX : SIA usa tabela 2 (EMPTAB = 2)
	*						 W-3 refere a mesma (EMPTAB = 2)
	*
	*					- PRECO DIFERENCIADO PARA :
	*						Transferencia
	*						Vendas E Outras
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LSnatu_oper....: Indicativo da Natureza da Opercao
	*							(2) = 	Transferencia
	*							(<>2)	=	Outras Operacoes
	*						  Alteram a forma de definir o preco
	*		LSTpOper.......: TIPO Identificador da Operacao Comercial
	*		LScodigo..........: Codigo do produto
    *       LDdata.........: Data para Refereciar a tabela em Vigor
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LSclascms........: Preco Localizado
	*		LSclascms......: Grupo de Comissao 		
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRClas_Cms
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LSclascms
	PRIVATE LNtbVigor, LSsrVigor


    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Preco,ALS_Preco



	*-----------------------------------------------------------*

	LSalias	= ALIAS()
	*-----------------------------------------------------------*

	LSclascms 	= ""
	STORE 0  TO LNtbVigor
	STORE "" TO LSsrVigor

	*-----------------------------------------------------------*
	*-----------------------------------------------------------*
    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Preco     = NetArqAgain("PRECO")
    ALS_Preco     = Alias()

	*--------------------------------------------------------
    IF (ARQ_Empresa + ARQ_Orcamento + ARQ_Preco) > 100000
								    && HOUVE FALHA ABERT
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF

	*--------------------------------------------------------

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF
	

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF


	*------------------------------------------------------------*

	IF !PRtabvigor(( &ALS_Orcamento .data ),LNtbVigor, LSsrVigor)
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF

	*------------------------------------------------------------*
    SELECT &ALS_preco
   	SET ORDER TO TAG tabela
    IF SEEK(STR( &ALS_empresa .emptab,3);
           +STR( LNtbVigor ,3)+ LSsrVigor + PrmProduto)
       LSclascms 		=   &ALS_preco .clas_cms
	ENDIF
	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_Preco")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSclascms)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK9L           PRCusto VALID                      ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:    6     ╨
*       ╨ Variable:            PRCusto                            ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      93                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gk9l     &&  PRCusto VALID
#REGION 3
return

FUNCTION  PRCusto
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn,;
				PrmCUSTO_IND

	PRIVATE LNcusto, LNRtdoSaida, LNRtdoEntrada
	PRIVATE LNtp_mercad
	PRIVATE LNaliq_icms, LNicms
	LNcusto = 0
		

	=W_DEFPROC("tributar.spr")
	LNRtdoSaida = TRRtdoSaida(LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNRtdoEntrada = TRRtdoEntrada(LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn)
	
	=W_DEFPROC("tributar.spr")
	LNaliq_icms = TRAlqIcmInUF(LSufDestino)

	=W_DEFPROC("tributar.spr")
	LNtp_mercad = TRRegTrbMercadoria(LSufDestino,LSproduto)


	LNicms = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicms = TRicmNormal (LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn)
	*---------------------------------------------------------*

	IF LNtp_mercad = 1  && TRIBUTADA
		LNcusto = LNvlrMercadoria + LNvlrIPI + PrmCUSTO_IND+;
				LNRtdoEntrada + LNRtdoSaida	 - LNicms
	ELSE
		LNcusto = LNvlrMercadoria + LNvlrIPI + PrmCUSTO_IND+;
				LNRtdoEntrada + LNRtdoSaida	
	ENDIF

	*---------------------------------------------------------*



RETURN(LNcusto)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GK9T           PRtabvigor VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:    7     ╨
*       ╨ Variable:            PRtabvigor                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      94                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gk9t     &&  PRtabvigor VALID
#REGION 3
RETURN

FUNCTION PRtabvigor
	PARAMETER LDdata,LNtabela,LSserie
    =W_DEFPROC("rotinas.spr")
    PRIVATE LSalias
	PRIVATE LFcadtab

	LNtabela = 0
   	LSserie  = ""

    LSalias	    = ALIAS()
    LFcadtab	= NetArq("cadtab")
    IF (LFcadtab) > 100000 && HOUVE FALHA ABERT
		=UP_fecha("cadtab" ,LFcadtab)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
    	RETURN(.f.)
    ENDIF
	SELE cadtab
	SET ORDER TO TAG tabela
	GO TOP
	DO WHILE !EOF()
		IF LDdata < cadtab.dtinicio or LDdata > cadtab.dtfim
			skip
			LOOP
		ENDIF
		LNtabela = cadtab.tabela
    	LSserie  = cadtab.serie
		EXIT
	ENDDO
	IF EOF()
	   DO OBJ_ALER.SPR WITH ;
		  "Nao foi encontrada nenhuma Tabela que vigor nesta data "+ ;
		    DTOC(LDdata)
	ENDIF
	=UP_fecha("cadtab" ,LFcadtab)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNtabela <> 0)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKA0           PRdesconto VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:    8     ╨
*       ╨ Variable:            PRdesconto                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      95                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gka0     &&  PRdesconto VALID
#REGION 3
RETURN

FUNCTION PRdesconto
    PARAMETER LNemp,LSCodigo,LDdata,LNnat_clie,LNdesconto,LNerro, ;
        PrmVendedor

    = W_DEFPROC("rotinas.spr")
    PRIVATE LSalias
    PRIVATE LFpreco,LFprod_cms,LFempresa
	PRIVATE LNtabela,LSserie
    PRIVATE LFvertab
    PRIVATE LNFuncaoComissao

	LNdesconto  = 0
    LNERRO      = 0
	LNtabela	= 0
	LSserie 	= ""

	IF TYPE("PrmVendedor") = "N"
    	=W_DEFPROC("USUARIO.SPR")
		LNFuncaoComissao = USGetComissFuncao(PrmVendedor)
	ELSE

		LNFuncaoComissao = 0
	ENDIF

    LSalias	    = ALIAS()
    LFpreco     = NetArq("preco")
    LFprod_cms  = NetArq("prod_cms")
    LFempresa   = NetArq("empresa")
    IF (LFpreco+LFprod_cms) > 100000 && HOUVE FALHA ABERT
	    DO ULFchDesconto
	    LNERRO = 99         && OUTRAS FALHAS
    	RETURN(.F.)
    ENDIF
    IF !Prtabvigor(LDdata,LNtabela,LSserie)
	    DO ULFchDesconto
		LNERRO = 1         && NAO HA TABELA EM VIGOR NESTE PERIODO
    	RETURN(.F.)
    ENDI
    IF !Prpromocao(LNemp,LScodigo,LNnat_clie,LDdata,{},0,LNdesconto)
	   SELE empresa
	   SET ORDER TO TAG empresa 	
	   SEEK LNemp
	   IF !FOUND()
	       DO ULFchDesconto
		   LNERRO = 99         && OUTRAS FALHAS
    	   RETURN(.F.)
	   ENDIF
       SELE Preco
       SET ORDE TO tabela
       seek str(empresa.emptab,3)+STR(LNtabela,3)+LSserie+LSCodigo

       IF !FOUND()
		  DO ULFchDesconto
		  LNERRO = 4         && PRODUTO NAO CADASTRO EM TABELA PRECO
          RETURN(.F.)
       ENDI

       LSclas_cms = Preco.clas_cms

       SELE Prod_cms
       SET ORDE TO tabela



	   *--------------------------------------------------------------*	
	   *    O controle de desonto por funcao nao e viavel sendo assim
	   * a comissao fica vinculada a funcao mas o desconto sera o que
	   * estiver cadastrado no nivel padrao = 00
	   *--------------------------------------------------------------*	
       *seek str(LNemp,3)+STR(LNtabela,3)+LSserie+;
       *       LSClas_cms+str(LNFuncaoComissao,2)
       *IF !FOUND()
	   *    seek str(LNemp,3)+STR(LNtabela,3)+LSserie+LSClas_cms+str(0,2)
       *   IF !FOUND()
	   *	  DO ULFchDesconto
	   *      LNERRO = 1   && PRODUTO NAO CADASTRADO NA TABELA PROD_CMS
	   *      RETURN(.F.)
       *   ENDI
       * ENDIF
	   *--------------------------------------------------------------*	

       seek str(LNemp,3)+STR(LNtabela,3)+LSserie+LSClas_cms+str(0,2)
   	   IF !FOUND()
		  DO ULFchDesconto
          LNERRO = 1   && PRODUTO NAO CADASTRADO NA TABELA PROD_CMS
          RETURN(.F.)
   	   ENDI



       Do Case
          Case LNnat_clie = 0
               LNdesconto = prod_cms.desc_varej
          Case LNnat_clie = 1
               LNdesconto = prod_cms.desc_reven
          Case LNnat_clie = 2
               LNdesconto = prod_cms.desc_ppubl
          Case LNnat_clie = 3
               LNdesconto = prod_cms.desc_frota
       EndC
    ENDI

	DO ULFchDesconto

    IF LNdesconto=0
       LNERRO = 2
      ELSE
       LNERRO = 3
    ENDI
RETURN(LNdesconto<>0)

PROCEDURE ULFchDesconto
    =UP_fecha("preco"    ,LFpreco)
	=UP_fecha("prod_cms" ,LFprod_cms)
	=UP_fecha("empresa" ,LFempresa)
	IF !EMPTY(LSalias) AND USED(LSalias)
	   SELECT &LSalias
	ENDIF
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKA8           PRbrow_tab VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:    9     ╨
*       ╨ Variable:            PRbrow_tab                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      96                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gka8     &&  PRbrow_tab VALID
#REGION 3
RETURN

FUNCTION PRbrow_Tab
PARAMETERS LNemp,LNempTab,LNtab,LSserie,LDdtsaldo,LScodigo,LSclassifica
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Visualizar Tabela de Precos,Saldos e Reservas
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite visualizar a TABELA DE PRECOS
	*			demontrando SALDO e REZERVAS DE CADA PRODUTO
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LNemptab.......: Empresa de Referencia Para Tabela de Precos
	*		LNtab..........: Codigo da Tabela de Precos
	*		LSserie........: Serie da Tabela de Precos
	*		LDdtsaldo......: Data de Referencia para Consultar
	*						tabela de SALDOS
	*		LScodigo.......: Codigo do Produto que se quer
	*						 Posicionar ou Aproximar ou retornar
	*						 para rotina chamadora
	*		LSclassifica...: Classificao do Produto que se quer
	*						 Posicionar ou Aproximar ou retornar
	*						 para rotina chamadora
	*------------------------------------------------------------*
	*  RETORNO.....:- REGISTRO DO PRODUTO e PRECO POSICIONADO para
	*					ser tratado na rotina
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSemptmp

	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente



	*------------------------------------------------------------*

	=W_DEFPROC("AUTOPROC.SPR")
	=APTempGeral()

	*------------------------------------------------------------*

	SELE preco
	SET ORDER TO TAG tabela
	SET NEAR ON
	SEEK STR(LNempTab,3)+;
	     STR(LNtab,3)+;
	     LSserie+;
         ALLTRIM(LScodigo)
	SET NEAR OFF


    SELECT saldo
    SET ORDER TO TAG clas_saldo
    SELECT grupo
    SET ORDER TO TAG codigo
    SEEK preco.codigo
		
    SET ORDER TO TAG ordem

    SET RELATION TO STR(LNempTab,3)+STR(LNtab,3)+LSserie+;
                            grupo.codigo INTO preco ADDITIVE
    SET RELATION TO STR(LNemp,3)+grupo.classifica+;
        STR(YEAR(LDdtsaldo),4)+STR(MONTH(LDdtsaldo),2) ;
        	INTO saldo ADDITIVE
*--------
    LSemptmp =  STRTRAN(STR(LNemp,3),' ','0')

	KEYBOARD "{CTRL-F10}"

 	DO loc_dlog WITH .T.,;
		  " grupo.FLG_DESCRI = 'S' OR ;
		  (('&LSemptmp' $ grupo.tab_preco OR grupo.tp_mercad = 7)) ;
		    AND (!EMPTY(preco.codigo) OR ;
			 grupo.cdg_tipo <> 4) ","","B","ULtabres"

	CLEAR FIELDS
	SET FIELDS OFF
    SET ORDER TO TAG classifica
	SET RELATION TO
	*--------------------------------------------------------------*
	POP KEY 	&& reabilita teclas de atalho def. anteriormente
	*-----------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKA9           PRpromocao VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:   10     ╨
*       ╨ Variable:            PRpromocao                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      97                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gka9     &&  PRpromocao VALID
#REGION 3
RETURN

FUNCTION PRPROMOCAO
PARAMETERS LNemp,LScod,LNNatuclie,LDFIM,LDINICIO,LNPRECO,LNDesconto

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Pre┤o Promocional
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite informar preco e desconto
	*			    promocional atraves de parametros
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....: PROMOCAO
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LScod..........: Codigo do produto
    *       LNNotclie......: Tipo do Cliente
    *                        0 - Varejo
    * 						 1 - Revenda
    *     					 2 - Poder Publico
    *						 3 - Frota
	*		LDFim..........: Data Final da Promocao
	*       LDInicio.......: Data Inicial da Promocao
	*       LNPreco........: Preco Promocao
    *       LNDesconto.....: Desconto conforme tipo do cliente
    *       LFretorno......: .t.  => Tem Promocao na data informada
    *                        .f.  => Nao Tem Promocao na data informada
	*------------------------------------------------------------*
	*  RETORNO.....: LFretorno
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno, LFpromocao
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LFpromocao		= NetArq("promocao")
	IF (LFpromocao) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("promocao" ,LFpromocao)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF

	LFretorno 	= .f.

    SELE PROMOCAO
    SET ORDE TO PROMOCAO
    SET NEAR ON
    SEEK STR(LNemp,3)+LScod+DTOS(LDfim)
    SET NEAR OFF
    IF promocao.empresa <> LNemp ;
    	OR promocao.codigo <> LScod ;
    	OR LDfim < promocao.dt_inicio ;
    	OR LDfim > promocao.Dt_fim
    	
       LFretorno = .f.
      else
       LFretorno = .t.
	   LDFim 	=  promocao.dt_fim
	   LDInicio =  promocao.dt_inicio
	   LNPreco  =  promocao.preco
	   	Do Case
	    	Case LNNatuclie = 0
	           LNDesconto = promocao.desc_varej
	     	Case LNNatuclie = 1
   	           LNDesconto = promocao.desc_reven
	      	Case LNNatuclie = 2
   	           LNDesconto = promocao.desc_ppubl
	      	Case LNNatuclie = 3
   	           LNDesconto = promocao.desc_frota
   	  	EndC
   	ENDI
	IF LNdesconto = 0
       LFretorno = .f.
	ENDIF
	
	=UP_fecha("promocao" ,LFpromocao)
   IF !EMPTY(LSalias) AND USED(LSalias)
      SELECT &LSalias
   ENDIF
RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKAA           PRVlrTabVgr VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:   11     ╨
*       ╨ Variable:            PRVlrTabVgr                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      98                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*


FUNCTION _42s11gkaa     &&  PRVlrTabVgr VALID
#REGION 3
return
	*------------------------------------------------------------*

FUNCTION PRVlrTabVgr
PARAMETERS PrmEmpresa, PrmData,PrmProduto

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LNpreco
	PRIVATE LNtbVigor, LSsrVigor
	PRIVATE LNEmpTab

	*-----------------------------------------------------------*

	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LNpreco 	= 0
	STORE 0  TO LNtbVigor
	STORE "" TO LSsrVigor

	*-----------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	LNEmpTab = EMGetFieldValue(PrmEmpresa,"EMPTAB")

	*------------------------------------------------------------*

	IF !PRtabvigor(PrmData, LNtbVigor, LSsrVigor)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	*------------------------------------------------------------*
    SELECT preco
   	SET ORDER TO TAG tabela
    IF SEEK(STR( LNEmpTab, 3);
           +STR( LNtbVigor ,3)+ LSsrVigor + PrmProduto)
       LNpreco 		=   preco .preco
    ELSE
        LNpreco 	=	0
	ENDIF
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNpreco)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKAB           PRVlrTransf VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:   12     ╨
*       ╨ Variable:            PRVlrTransf                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      99                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkab     &&  PRVlrTransf VALID
#REGION 3
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*



PROCEDURE trf_dep010912

		PRIVATE LSUFdestino


		=W_DEFPROC("TRIBUTAR.SPR")
	   	LNtp_mercad = TRDef_TpMercad(PrmEmpresa,PrmOrcamento,PrmProduto)

		*------------------------------------------------------------*
		SELECT &ALS_Saldo
	   	SET ORDER TO TAG clas_saldo
	   	SEEK STR(PrmEmpresa,3)+ &ALS_grupo .classifica+;
    	    	STR(YEAR( &ALS_Orcament .data ),4)+;
    	    	STR(MONTH( &ALS_Orcament .data ),2)

	   	IF FOUND()

			IF &ALS_saldo .sld_atu = 0
		        LNvalor		=	&ALS_saldo .vlr_atu / 1
			else
		        LNvalor		=	&ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
			ENDIF

			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************

			IF &ALS_tipooper .ch_desti = "1"  && INTERNAS

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2
							LNvalor = LNvalor
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE

			ELSE

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2

						=W_DEFPROC("CLIENC.SPR")
						LSUFdestino = CNGetUFDestino(PrmEmpresa,;
													PrmOrcamento)

						=W_DEFPROC("TRIBUTAR.SPR")
						LNiva = TRGet_IVA(  &als_empresa .estado, ;
								            PrmProduto,;
								            LSUFdestino ,;
								            &ALS_Orcament .data )

						*=W_DEFPROC("TRIBUTAR.SPR")
						*LNiva=TRGet_IVA( &als_empresa .estado, PrmProduto)

						DO CASE
							CASE LNiva = 1.32
								LNvalor = LNvalor * 0.8945
							CASE LNiva = 1.42
								LNvalor = LNvalor * 0.8803
							CASE LNiva = 1.45
								LNvalor = LNvalor * 0.8761
							OTHERWISE							
								LNvalor = LNvalor
						ENDCASE
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE
			ENDIF
	   ENDIF
RETURN





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKB3           PRVlrTransf VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:   13     ╨
*       ╨ Variable:            PRVlrTransf                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      100                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkb3     &&  PRVlrTransf VALID
#REGION 3
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*



PROCEDURE trf_dep010503

		PRIVATE LSUFdestino


		=W_DEFPROC("TRIBUTAR.SPR")
	   	LNtp_mercad = TRDef_TpMercad(PrmEmpresa,PrmOrcamento,PrmProduto)

		*------------------------------------------------------------*
		SELECT &ALS_Saldo
	   	SET ORDER TO TAG clas_saldo
	   	SEEK STR(PrmEmpresa,3)+ &ALS_grupo .classifica+;
    	    	STR(YEAR( &ALS_Orcament .data ),4)+;
    	    	STR(MONTH( &ALS_Orcament .data ),2)

	   	IF FOUND()

			IF &ALS_saldo .sld_atu = 0
		        LNvalor		=	&ALS_saldo .vlr_atu / 1
			else
		        LNvalor		=	&ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
			ENDIF

			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************

			IF &ALS_tipooper .ch_desti = "1"  && INTERNAS

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2
							LNvalor = LNvalor
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE

			ELSE

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2

						=W_DEFPROC("CLIENC.SPR")
						LSUFdestino = CNGetUFDestino(PrmEmpresa,;
													PrmOrcamento)

						=W_DEFPROC("TRIBUTAR.SPR")
						LNiva = TRGet_IVA(  &als_empresa .estado, ;
								            PrmProduto,;
								            LSUFdestino ,;
								            &ALS_Orcament .data )

						*=W_DEFPROC("TRIBUTAR.SPR")
						*LNiva=TRGet_IVA( &als_empresa .estado, PrmProduto)

						DO CASE
							CASE LNiva = 1.32
								LNvalor = LNvalor * 0.9055
							CASE LNiva = 1.42
								LNvalor = LNvalor * 0.8917
							CASE LNiva = 1.45
								LNvalor = LNvalor * 0.8877
							OTHERWISE							
								LNvalor = LNvalor
						ENDCASE
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE
			ENDIF
	   ENDIF
RETURN



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKBA           PRVlrTransf VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         PRECO,     Record Number:   14     ╨
*       ╨ Variable:            PRVlrTransf                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      101                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkba     &&  PRVlrTransf VALID
#REGION 3
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*

PROCEDURE trf_ate010503

		=W_DEFPROC("TRIBUTAR.SPR")
	   	LNtp_mercad = TRDef_TpMercad(PrmEmpresa,PrmOrcamento,PrmProduto)

		*------------------------------------------------------------*
		SELECT &ALS_Saldo
	   	SET ORDER TO TAG clas_saldo
	   	SEEK STR(PrmEmpresa,3)+ &ALS_grupo .classifica+;
    	    	STR(YEAR( &ALS_Orcament .data ),4)+;
    	    	STR(MONTH( &ALS_Orcament .data ),2)
	   	IF FOUND()
			IF &ALS_saldo .sld_atu = 0
		        LNvalor		=	&ALS_saldo .vlr_atu / 1
			else
		        LNvalor		=	&ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
			ENDIF
			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************
			IF &ALS_tipooper .ch_desti = "1"
				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2
						************************************************
						*    Inicio de tratamento nao parametrizavel
						*	( ESPECIFICO)
						*	Para PNEUS Ind,Caminhao,Tratores,Agric,	
						*	Terrapl > "00448"  e < "00800"	
						************************************************
						IF LEFT( &ALS_grupo .classifica,5) > "00448" AND ;
						   LEFT( &ALS_grupo .classifica,5) < "00800"
						        LNvalor = LNvalor * 1.24
						ELSE
						        LNvalor = LNvalor * 1.26
						ENDIF				
					OTHERWISE
						LNvalor = LNvalor
				ENDCASE
			ELSE
		        LNvalor = LNvalor / ((100 - &ALS_tipooper .aliq_icms) / 100)
			ENDIF
	   ENDIF
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKBI           TRGet_IPIProd VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:    4  ╨
*       ╨ Variable:            TRGet_IPIProd                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      102                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkbi     &&  TRGet_IPIProd VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IPIProd
PARAMETERS PrmProduto

    PRIVATE LNipialq

	=W_DEFPROC("GRUPO.SPR")
	LNipialq =GRGetFieldValue(PrmProduto,"ALIQ_IPI")

RETURN(LNipialq)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKBN           TRGet_ISSAlq VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:    5  ╨
*       ╨ Variable:            TRGet_ISSAlq                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      103                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkbn     &&  TRGet_ISSAlq VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_ISSAlq
PARAMETERS PrmEmpresa


    PRIVATE LNaliq_iss

	=W_DEFPROC("EMPRESA.SPR")
	LNaliq_iss =EMGetFieldValue(PrmEmpresa,"ALIQ_ISS")

RETURN(LNaliq_iss)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKBT           TRdefcst VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:    6  ╨
*       ╨ Variable:            TRdefcst                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      104                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*


FUNCTION _42s11gkbt     &&  TRdefcst VALID
#REGION 4
RETURN

FUNCTION TRdefcst
	PARAMETERS Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto,PrmCst

	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_tab_cst,ALS_tab_cst
	LSalias = ALIAS()

    ARQ_Tab_Cst     = NetArqAgain("TAB_CST")
    ALS_Tab_Cst     = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()



	IF ( ARQ_Tab_Cst)+ ARQ_Tipooper > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ PrmTipo
	IF !FOUND()
		SEEK 's'+  PrmTipo
	ENDIF
	IF !FOUND()
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF



	LScst = " "
	DO CASE
		CASE &Als_tipooper .ch_opera = "4"  && DEVOLUCAO
			LScst =  PrmCST
		OTHERWISE
			SELECT &Als_tab_cst
			SET ORDER TO TAG cst
			SEEK STR(Prmtab_cst,2)+PrmTipo+STR(Prmtp_mercad,1)
			IF !FOUND()
				IF tipooper.ch_opera = "3"
					LScst =  "4"
				ENDIF
			ELSE
				LScst =  RIGHT( &Als_tab_cst .cst,1)
			ENDIF
	ENDCASE
	*------------------------------------------------------------*
    =up_fecha("&ALS_Tab_cst")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKBU           TRAlqIcmInUF VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:    7  ╨
*       ╨ Variable:            TRAlqIcmInUF                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      105                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkbu     &&  TRAlqIcmInUF VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRAlqIcmInUF
PARAMETERS PrmUF

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    LSAlias      = Alias()
    LNaliq_icms = 0
	*--------------------------------------------------------*
	DO CASE
		CASE PrmUF $ "MG/RJ/SP/PR/SC"
		    LNaliq_icms = 18
		OTHERWISE
		    LNaliq_icms = 17
	ENDCASE
	*--------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKBV           TRAlqIcmOuUF VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:    8  ╨
*       ╨ Variable:            TRAlqIcmOuUF                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      106                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkbv     &&  TRAlqIcmOuUF VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRAlqIcmOuUF
PARAMETERS PrmUF, PrmOrigemMercadoria

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    LSAlias      = Alias()
    LNaliq_icms = 0


    IF TYPE("PrmOrigemMercadoria") = "L"   && NAO FOI REPASSADO PARAMETRO -
                                           && CHAMADA ROTINA ANTIGA
		PrmOrigemMercadoria = 0

    ENDIF





	*--------------------------------------------------------*

	DO CASE
		CASE PrmOrigemMercadoria = 2
		    LNaliq_icms = 4

		CASE PrmUF $ "MG/RJ/SP/PR/SC"
		    LNaliq_icms = 7
		OTHERWISE
		    LNaliq_icms = 12
	ENDCASE
	*--------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKBW           TRCFO VALID                        ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:    9  ╨
*       ╨ Variable:            TRCFO                              ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      107                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkbw     &&  TRCFO VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRCFO
PARAMETERS PrmEmpresa, PrmTipo, PrmTp_mercad,PrmOperacao

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*

	*------------------------------------------------------------*

    PRIVATE LScfo
    PRIVATE LSalias
    PRIVATE PrmTp_mercad

    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()


	STORE 0 TO ARQ_Tipooper
	*--------------------------------------------------------
	IF TYPE("TRtipooperALIAS") = "U" OR !USED(TRtipooperALIAS)
		PUBLIC TRtipooperALIAS
	    ARQ_Tipooper     = NetArqAgain("TIPOOPER")
	    TRtipooperALIAS  = Alias()
	ENDIF
    ALS_Tipooper     = TRtipooperALIAS


    LScfo = SPACE(5)
	*--------------------------------------------------------*

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	IF UPPER(PrmOperacao) = "SAIDA"
		SEEK 'S'+ PrmTipo
		IF !FOUND()
			SEEK 's'+  PrmTipo
		ENDIF
	ELSE
		SEEK 'E'+ PrmTipo
		IF !FOUND()
			SEEK 'e'+  PrmTipo
		ENDIF
	ENDIF

	*--------------------------------------------------------*

	IF !FOUND()
   		*=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF

		IF  PrmTipo = "CPM"
		   LScfo = "5.929"
		ENDIF
		
        RETURN(LScfo)
	ENDIF


	*------------------------------------------------------*

	DO CASE


		CASE  PrmTipo = "CPM"
		   LScfo = "5.929"


		CASE PrmTp_mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs


		CASE     PrmTp_mercad = 7 ;
		  	 AND UPPER(PrmOperacao) = "SAIDA" ;
			 AND &Als_tipooper .ch_opera = "1"  && Venda/Compra SERVICO


		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO

		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE

	LScfo = LEFT(ALLTRIM(LScfo)+"   ",5)

	*------------------------------------------------------------*
	*=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LScfo)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKCL           ANTTRpct_trib VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   10  ╨
*       ╨ Variable:            ANTTRpct_trib                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      108                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkcl     &&  ANTTRpct_trib VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ANTTRpct_trib
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto, ;
    LNiva, LNipialq, LNtp_mercad, LScst, ;
    LNaliq_iss, LNaliq_rdu, LNaliq_icms, LScfo


	=W_DEFPROC("rotinas.spr")


 	 PRIVATE LNtab_cst

    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_GrFiscal,ALS_GrFiscal
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper
	PRIVATE LSUForigem, LSUFdestino

    LSAlias      = Alias()

	
    LNiva = 0
    LNipialq = 0
	LNtp_mercad	= 99999   && INVALIDO
	LScst		= " "		&& ASSUME 0
    LNaliq_iss = 0
    LNaliq_rdu = 0
    LNaliq_icms = 0
    LScfo = ""


    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_GrFiscal  = NetArqAgain("GRFISCAL")
    ALS_GrFiscal  = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()


    LNiva = 0
	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto

	*---------------------------------------------------------------*

	SELE &Als_GRfiscal
	SET ORDER TO trb_classe
	SEEK &Als_empresa .estado + LEFT( &Als_grupo .classifica,5)
	IF !FOUND()
		SET ORDER TO trb_sbgrpo
		SEEK &Als_empresa .estado + LEFT( &Als_grupo .classifica,8)
	ENDIF

	*---------------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF


	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    *=========>>>>>>>   OBTER IVA    <<<<<<



	=W_DEFPROC("CLIENC.SPR")
	LSUFdestino = CNGetUFDestino(PrmEmpresa,;
								PrmOrcamento)




	=W_DEFPROC("EMPRESA.SPR")
	LSUForigem = EMGet_UF(PrmEmpresa)


	=W_DEFPROC("TRIBUTAR.SPR")
	LNiva = TRGet_IVA( LSUForigem,;
			            PrmProduto,;
			            LSUFdestino ,;
			            &ALS_Orcament .data )




    *=========>>>>>>>   OBTER ALIQ IPI    <<<<<<

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA
	DO CASE
		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA
		CASE &Als_Grupo .origem = 1
			LNipialq   =  &Als_Grupo .aliq_ipi

		OTHERWISE
			LNipialq   =	0
	ENDCASE


    *=========>>>>>>>   OBTER TP_MERCAD    <<<<<<
	*--------------------------------------------------------
	*	IF &Als_Orcamento .data < {01.03.2000}
	*		LNtp_mercad	= 	&Als_grupo .tp_mercad
	*	ELSE
	*		LNtp_mercad	= 	&Als_grfiscal .tp_mercad
	*	ENDIF
	*--------------------------------------------------------


    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)


	*----------------------------------------------------------------*
	*		Identificar mercadorias em regime de substituicao ESTADUAL
	*	em caso de operacao ITERESTADUAIS com consumidor INSCRITO(2)/
	*	REVENDA(4) ou DEVOLUCOES passa mercadoria para regime tributado
	*----------------------------------------------------------------*
	IF LNtp_mercad = 2	AND &Als_tipooper .ch_desti = "2"
		IF     &Als_grfiscal .subgrupo > "02000" ;
		   AND &Als_grfiscal .subgrupo < "99999" ;
		   AND &Als_grfiscal .subgrupo <> "04042"
			DO CASE
				*----------------------------------------------------*
				* TODAS OPERACOES DIFERENTES DE VENDAS
				*----------------------------------------------------*
				CASE &Als_tipooper .ch_opera <> "1" && TODAS OPER DIFERE
				                                    && DE VENDA
					LNtp_mercad	= 	1
				*----------------------------------------------------*
				* TODAS VENDAS Q NAO FOREM PARA 1-CONSSUMIDOR  OU
				*                               3-CONTR NAO ISCRITO
				*----------------------------------------------------
				CASE !( &Als_tipooper .ch_contr $ "3/1" )
					LNtp_mercad	= 	1
			ENDCASE
		ENDIF
	ENDIF
    *=========>>>>>>>   OBTER CST    <<<<<<





	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

	LNtab_cst = &ALS_empresa .tab_cst

	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
	*---------------------------------------------------------------*

	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto)


    *=========>>>>>>>   OBTER ALIQ ISS    <<<<<<
	LNaliq_iss   =	&Als_empresa .aliq_iss
    *=========>>>>>>>   OBTER ALIQ reducao icms   <<<<<<

	LNaliq_rdu    =  0
	IF &Als_empresa .REDUZ_BASE = 0
		LNaliq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNaliq_rdu   = &Als_empresa .REDUZ_BASE  && USAR ALIQUOTA
			                                        && INFORMADA
		endif
	ENDIF

    *=========>>>>>>>   OBTER ALIQ icms   <<<<<<
	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms = &Als_orcament .aliq_icms && USAR ALIQUOTA
											   && INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA
												     && INFORMADA
	ENDIF
    *=========>>>>>>>   OBTER CFO   <<<<<<


	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE LNTp_Mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE




	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
    do TRFcht_Fecha

RETURN

PROCEDURE TRFcht_Fecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_GrFiscal")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKCZ           TRGet_IPIAlq VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   11  ╨
*       ╨ Variable:            TRGet_IPIAlq                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      109                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkcz     &&  TRGet_IPIAlq VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IpiAlq
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto

	=W_DEFPROC("rotinas.spr")

    PRIVATE LNipialq
    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNipialq = 0
	*--------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA

	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
		RETURN(LNipialq)
	ENDIF


    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF
	*------------------------------------------------------------*

	DO CASE
		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA
		CASE &Als_Grupo .origem = 1

			LNipialq   =  TRGet_IPIProd(PrmProduto)

		OTHERWISE
			LNipialq   =	0
	ENDCASE

	*------------------------------------------------------------*

    DO TRFch_IPIAlqFecha

RETURN(LNipialq)

PROCEDURE TRFch_IPIAlqFecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKD7           TRGet_cst VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   12  ╨
*       ╨ Variable:            TRGet_cst                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      110                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkd7     &&  TRGet_cst VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_cst
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto,PrmCST

	=W_DEFPROC("rotinas.spr")

    PRIVATE LScst
    PRIVATE LSalias

    PRIVATE LNtab_cst
    PRIVATE LNtp_mercad

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Orcamento,ALS_Orcamento

    LSAlias      = Alias()

    *----------------------------------------------------*
	LScst		= " "		&& ASSUME 0

    *----------------------------------------------------*

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()


    LScst  = " "

	LNtab_cst = 0

	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF

	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

 	LNtab_cst = &ALS_empresa .tab_cst

	*--------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF

	*------------------------------------------------------------*


    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)
	*---------------------------------------------------------------*
	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto)


	*------------------------------------------------------------*

    DO TRFch_CSTFecha

RETURN(LScst)

PROCEDURE TRFch_CSTFecha
	IF LScst = " "
		WP_MSG = "ATENCAO :  Nao foi Encontrada TABELA de C.S.T p/ "+;
			"[ Tab:"+STR(LNtab_cst,2)+;
			" Tipo:"+ &ALS_orcamento .tipo +" Mercad"+;
			STR(LNtp_mercad,1)+chr(13)+;
			"SOLICITE CADASTRO URGENTE !!!!!!."
			DO OBJ_ALER.SPR WITH WP_MSG
	ENDIF

    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Orcamento")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKD8           TRDef_tpMercad VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   13  ╨
*       ╨ Variable:            TRDef_tpMercad                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      111                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkd8     &&  TRDef_tpMercad VALID
#REGION 4
RETURN


*--------------------------------------------------------------------*
* ESTA ROTINA ESTA VINCULADA AO ITEM DO ORCAMENTO E DEVE SER DESATIVADA
* EM (TRIBUTAR) QDO FOR MIGRADA PARA ITEM DE (ORCAMENTO OU ITEMMOV)
* COMENTARIO EM 14/05/2009
*---------------------------------------------------------------------*



FUNCTION TRDef_TpMercad
	PARAMETER PrmEmpresa,PrmOrcamento,PrmProduto


	=W_DEFPROC("rotinas.spr")

	PRIVATE LUFEmpresa
	PRIVATE	LNtp_mercad

	=W_DEFPROC("EMPRESA.SPR")
	LUFEmpresa = EMGetFieldValue(PrmEmpresa,"ESTADO")


	*--------------------------------------------------------


	LNtp_mercad	= 99999   && INVALIDO


	LNtp_mercad=;
		TRDef_RgTrbMercad( LUFEmpresa ,PrmProduto)

	*--------------------------------------------------------


RETURN(LNtp_mercad)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKD9           TRGet_rduIcms VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   14  ╨
*       ╨ Variable:            TRGet_rduIcms                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      112                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkd9     &&  TRGet_rduIcms VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_rduIcms
PARAMETERS PrmEmpresa, PrmOrcamento

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
    *     Definir melhor as regras de reducao de base de ICMS
    * Por enquanto :
    *   FILIAL ARG => Usa reducao informada no registro da empresa
    *   Outras situacaoes ocorrem conforme a operacao e o indice
    *   deve ser informado no tipooper e atribuido ao orcamento
	*------------------------------------------------------------*

    PRIVATE LNaliq_rdu
    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNaliq_rdu = 0
	*--------------------------------------------------------*


    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF


	*------------------------------------------------------------*

	LNalq_rdu    =  0
	IF &Als_empresa .REDUZ_BASE = 0
		LNalq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNalq_rdu = &Als_empresa .REDUZ_BASE
		ELSE
			LNalq_rdu = &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA

		endif
	ENDIF

	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_rdu)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKDA           TRGet_IcmsAlq VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   15  ╨
*       ╨ Variable:            TRGet_IcmsAlq                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      113                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkda     &&  TRGet_IcmsAlq VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IcmsAlq
PARAMETERS PrmEmpresa, PrmOrcamento

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    PRIVATE ARQ_Empresa   , ALS_Empresa
    PRIVATE ARQ_Orcamento , ALS_Orcamento
    PRIVATE ARQ_Tipooper  , ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNaliq_icms = 0
	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF


	*------------------------------------------------------------*

	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms  =  &Als_orcament .aliq_icms && USAR ALIQUOTA INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA INFORMADA
	ENDIF

	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKE3           TRGet_CFO VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   16  ╨
*       ╨ Variable:            TRGet_CFO                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      114                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gke3     &&  TRGet_CFO VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_CFO
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*

	*------------------------------------------------------------*

    PRIVATE LScfo
    PRIVATE LSalias
    PRIVATE LNtp_mercad

    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()


    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LScfo = ""
	*--------------------------------------------------------*



	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LScfo)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LScfo)
	ENDIF


	*------------------------------------------------------*


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)

	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE PrmTp_mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE


	*------------------------------------------------------------*
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LScfo)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKEB           TRcalc_tribu VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   17  ╨
*       ╨ Variable:            TRcalc_tribu                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      115                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkeb     &&  TRcalc_tribu VALID
#REGION 4
RETURN

FUNCTION TRcalc_tribu
	PARAMETERS LNemp,LStipo,LScst,LNvlrvenda,LNtp_mercad;
				LNalq_iss,LNalq_icms,LNalq_ipi,LNalq_rdu,;
				LNiva,;
				LDdata,;
				LSufdesti,;
				LNqtde,;
				LScodprd,;
				LNbsIss,LNvlrIss,;
				LNbsIcms,LNvlrIcms,LNbsIsent,;
				LNbsSbBrt,LNbsSubs,LNicmSub,LNbsOutr,;
		        vTParam

	LNbsIpi      = vTParam[01]
	LNvlrIpi     = vTParam[02]
	LNbsIsIpi    = vTParam[03]
	LNbsbrIcms   = vTParam[04]
    PrmSeg       = vTParam[05]
    LNissrtd     = vTParam[06]
    PrmSbstISS   = vTParam[07]


	*----------------------------------------------------------*
    *    O Numero maximo de parametros passados a uma UDF e 24
    * o vTParam aplia essa condicao (mas por questoes de facilidade o
    * vetor so e utilizado para completar os parametros excedentes)
	*----------------------------------------------------------*


	*------------------------------------------------------------*
	*  CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	*  OBJETIVO.......: Calcular Valores TRIBUTARIAS E FISCAIS
	*------------------------------------------------------------*
	*  COMENTARIO.....:
	*------------------------------------------------------------*
	*  OBS............:
	*------------------------------------------------------------*
	*  TABELAS.......:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LStipo.....:
	*		LScst......: Codigo Situacao Tributaria
	*		LNvlrvenda.: Valor da Venda (Movimentacao)
	*		LNtp_mercad:
	*		LNalq_iss..:
	*		LNalq_icms.:
	*		LNalq_ipi..:
	*		LNalq_rdu..:
	*		LNiva......:
	*		LDdata.....:
	*		LSufdesti..:
	*		LNqtde.....: Para atendeder necessidade no calc base IPI
	*					 da transferencia
	*		LScodprd...: As Rotinas Novas > 22/08/2000 passam o
	*                  Codigo do Produto LEN(LScodprd) = 11 e as
	*                  antigas , que devem ser substituidas usam
	*                  a Classifica┤фo LEN(LScodprd) > 11
	*                  => Quando Vier o Codigo => Ler Grupo e Achar a
	*                  Classifica┤фo para uso interno desta Rotina
	*
	*	Para atendeder necessidade no calc base IPI
	*					 da transferencia
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNbsIss....:
	*		LNvlrIss...:
	*		LNbsIcms...:
	*		LNvlrIcms..:
	*		LNbsIsent..:
	*		LNbsSbBrt..:
	*		LNbsSubs...:
	*		LNbsOutr...:
	*		LNbsIpi....:
	*		LNvlrIpi...:
	*		LNbsIsIpi..:
	*		LNbsbrIcms.:
	*------------------------------------------------------------*
	* CHAMADAS : OBJ_ITOR.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LNbs_TRIBUTAR		&& BASE PARA TIBUTAR
	PRIVATE LDdtpesq			&& PARA PESQUISA DE BASE IPI TRANSD
	PRIVATE LSclasprd


    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_Saldo,ALS_Saldo

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Saldo  = NetArqAgain("SALDO")
    ALS_Saldo  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

	*------------------------------------------------------------*
	IF LEN(LScodprd) > 11
		LSclasprd = LScodprd
	ELSE
		SELE &ALS_grupo
		SET ORDER TO TAG codigo
		SEEK LScodprd
		IF !FOUND()
			LSclasprd = ""
		ELSE	
			LSclasprd = &ALS_grupo .classifica
		ENDIF
	ENDIF
	*------------------------------------------------------------*
	SELECT &ALS_tipooper
	SET ORDER TO tag tipo
	SEEK "S"+LStipo
	IF !FOUND()
		SEEK "s"+LStipo
		IF !FOUND()
		    DO TRcalc_Fecha
			RETURN(.f.)
		ENDIF
	ENDIF
	*------------------------------------------------------------*
	SELECT &ALS_empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
	    DO TRcalc_Fecha
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	STORE 0 TO LNbsIss,LNvlrIss,LNbsIcms,LNvlrIcms,LNbsIsent,;
			LNbsSbBrt,LNbsSubs,LNbsOutr,LNbsIpi,LNvlrIpi,LNbsIsIpi
			
	STORE 0 TO LNissrtd
	
	*------------------------------------------------------------*
	*		TRIBUTOS INDEPENDENTES DA SITUACAO TRIBUTARIA
	*------------------------------------------------------------*
	*	Calculo envolvendo ISS
	*		-tp_mercad= 7 => SERVICO
	*------------------------------------------------------------*
	LNbsIss		=	0
	LNvlrIss	=	0
	IF LNtp_mercad = 7
		LNbsIss	 =	LNvlrvenda
		LNvlrIss =  ROUND(LNbsIss * ROUND(LNalq_iss  / 100,4),2)
	ENDIF
	
	*------------------------------------------------------------*
	*	Calculo envolvendo ISS RETIDO
	*------------------------------------------------------------*
	LNIssRtd	=	0
	IF PrmSbstISS = 1  && se = 1 segumento retem iss
		LNIssRtd = LNvlrIss
	ENDIF
	
	*------------------------------------------------------------*
	*	Calculo envolvendo IPI
	*		-Devolucao:		A base do IPI e o proprio vlrvenda
	*		-Outras   : 	O IPI ja esta embutido no valor de
	*				de venda. Por isso e necessario retira-lo
	*				para determinar a base Original
	*------------------------------------------------------------*
	LNbsIpi 	= 	0
	LNvlripi 	= 	0
	LNbsIsIp	=	LNvlrvenda
	IF LNalq_Ipi > 0
		DO CASE
			CASE &ALS_tipooper .ch_opera = "4" 	&& DEVOLUCAO
				LNbsIpi  = LNvlrvenda
			CASE &ALS_tipooper .ch_opera = "2" 	&& TRANSFERENCIA
				*----------------------------------------------------*
				*  CASO DAS IMPORTACOES INICIADAS EM 2006
				*----------------------------------------------------*
				LNbsIpi  = LNvlrvenda
			CASE &ALS_tipooper .ch_opera = "2" 	&& TRANSFERENCIA
				*----------------------------------------------------*
				*  CASO ANTIGO QDO AS IMPORTACOES FORAM TRATADAS
				* DE FORMA ERRADA
				*----------------------------------------------------*
				*    	Determina o Ultimo dia do mes Anterior para
				*   data de pesquisa E MES ANTERIOR P/ O REGISTRO DO
				*   SALDO
				*     MOTIVO : A base do ipi nas transferencias
				*			e a media do valor de venda nos meses
				*			anteriores
				*----------------------------------------------------*
				LDdtpesq   = LDdata - DAY(LDdata)
				SELE &ALS_SALDO
				SEEK STR(LNemp,3)+LSclasprd+;
							STR(YEAR(LDdata),4)+;
						 	 STR(MONTH(LDdata),2)
				*----------------------------------------------------*
				*    Caso nao seja possivel determinar a media
				*  sera considerado o custo medio ANTERIOR OU ATUAL
				*	(ULTIMO CASO)
				*----------------------------------------------------*
				DO CASE
					CASE FOUND() AND &ALS_saldo .sld_ante > 0
					   LNbsipi = &ALS_saldo .vlr_ante / &ALI_saldo .sld_ante
					CASE FOUND() AND &ALS_saldo .sld_atu  > 0
					   LNbsipi = &ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
				ENDCASE					
				*----------------------------------------------------*
				DO WHILE LDdtpesq > {31.12.1994}
					SEEK STR(LNemp,3)+LSclasprd+;
							STR(YEAR(LDdtpesq),4)+;
						 	 STR(MONTH(LDdtpesq),2)
					IF !FOUND() OR &ALS_SALDO .qtd_venda = 0
	   					LDdtpesq   = GOMONTH(LDdtpesq,-1)
						LOOP
					ENDIF					
					LNbsipi = &ALS_SALDO .ven_enc / &ALS_SALDO .qtd_venda
					IF LDdata <= {24.06.1998}
						LNbsipi	= LNbsipi * 0.70
					ELSE
						LNbsipi	= LNbsipi * 0.90
					ENDIF						
					EXIT
				ENDDO			
				LNbsipi = LNbsipi * LNqtde
			OTHERWISE
				LNbsIpi  = ROUND(LNvlrvenda/(1+LNalq_ipi/100),2)
		ENDCASE
		LNvlripi 	= ROUND(LNbsIpi * ROUND(LNalq_ipi  / 100,4),2)
		LNbsIsIp	= 0
	ENDIF
	LNvlripi = TRcalc_Difer(LNvlripi,LNqtde,2)
	
	*------------------------------------------------------------*
	*		TRIBUTOS PELA SITUACAO TRIBUTARIA
	*------------------------------------------------------------*
	*  BASE DE INCIDENCIA DE TRIBUTOS
	*    - EM DEVOLUCOES O IPI COMPOE A BASE DE TRIBUTACAO
	*    - NAS OUTRAS OPERACOES O IPI E RETIRADO PARA COMPOR A
	*     BASE
	*------------------------------------------------------------*
	IF &ALS_tipooper .ch_opera $ "4/2" 	&& DEVOLUCAO/TRANSF
		LNbs_TRIBUTAR	= LNvlrvenda
	ELSE
		IF LDdata > {01.01.2000}
			*-----------------------------------------------------*
			&&    O IPI so passou a ser calculado nas saidas a partir
			&& de 01.01.2000 e mesmo assim conssideramos o ipi
			&& como sendo imbutido no valor particado
			&& por isso ele ┌ retirado para compor a tributacao
			&&    Uma checagem mais detalhada indicara uma diferenca
			&& nas notas anteriores a esta data pois o ipi foi calculado
			&& apos a emissфo das notas(Contador PEDRO) e nao foi
			&& considerado para tributa┤фo
			*----------------------------------------------------*
			LNbs_TRIBUTAR	= LNvlrvenda - LNvlrIpi
		ELSE
			LNbs_TRIBUTAR	= LNvlrvenda
		ENDIF
	ENDIF										
	*------------------------------------------------------------*
	*------>>> BASE BRUTA DE ICMS SEM CONSIDERAR REDUCOES
	DO CASE
		CASE LScst $ "0/1/2/7"		&& ENVOLVE MERCAD TRIBUTADA NORMAL
			LNbsbrIcms	= LNbs_TRIBUTAR
        OTHERWISE
   			LNbsbrIcms	= 0
	ENDCASE

	*------>>> BASE LIQUIDA  DE ICMS CONSIDERANDO  REDUCOES----*
    *    As reducoes podem ser em funcao da operacao = "0/1"
    *  ou em funcao da empresa CST = "2/7"
	*  OBS: As reducoes em funcao da operacao foram introduzidas
	*     apos mudancas no recolhimento de PIS/COFINS em que as NF
	*  da firestone vinham com reducao na base do icms e que em caso
	*  de devolucoes deveriam operar com reducao da base.....
    *----------------------------------------------------------*
	DO CASE
		CASE LScst $ "0/1"		&& ENVOLVE MERCAD TRIBUTADA NORMAL
			LNbsIcms	= LNbsbrIcms - ;
		             ROUND(LNbsbrIcms * LNalq_rdu/100,2)
		CASE LScst $ "2/7"		&& REDUZIR BASE DO ICMS
			LNbsIcms	= LNbsbrIcms - ;
		             ROUND(LNbsbrIcms * LNalq_rdu/100,2)
	ENDCASE

	*------------------------------------------------------------*
	*----------------->>> BASE SUBSTITUICAO <<<------------------*
	*------------------------------------------------------------*



	IF LScst $ "1/3/7/"		
		LNbsSbBrt	= LNbs_TRIBUTAR + LNvlrIpi
		*----> INTERESTADUAL  e CONSUMIDOR INSCRITO
		
		DO CASE

			CASE &ALS_tipooper .ch_desti = "2" ;
			     AND &ALS_tipooper .ch_contr = "2";
			     AND LDdata < CTOD("01.10.11")
                *--------------------------------------------*
                * regra anterior ao protocolo 21/2011 *
                *--------------------------------------------*
	
				LNbssubs = LNbs_TRIBUTAR + LNvlrIpi


			CASE &ALS_tipooper .ch_desti = "2"  ;
			     AND ;
			     (     &ALS_tipooper .ch_contr = "1";
			        OR &ALS_tipooper .ch_contr = "2";
			        OR &ALS_tipooper .ch_contr = "3";
			     )
				 *------------------------------------------------------*
	             * PROTOCOLO INTERESTADUAL 21/2011 CONFAZ EM VIGOR DESDE
    	         * junho/2011 equipara
    	         *  (1) - CONSUMIDOR ESTADUAL
    	         *  (2) - CONSUMIDOR INSCRITO
    	         *  (3) - CONSUMIDOR NAO INSCRITO
	             *  nas operacoes interestaduais
				 *-----------------------------------------------------*

				LNbssubs = LNbs_TRIBUTAR + LNvlrIpi







			CASE LScst $ "1/7" AND LDdata < CTOD("01.01.97")
				LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi) *  1.45)

			CASE LScst $ "3" AND &ALS_tipooper .ch_desti = "1"
				LNbssubs = ((LNbs_TRIBUTAR+LNvlrIpi)   *  1.225)
				*  qualquer situacao de retencao interna sera
				*	 entendida como reem bolso 1.225
				*	 (DEFINIDO COM PEDRO EM 17/04/97)

			CASE LScst $ "3" AND LDdata < CTOD("01.01.97")
				LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi) *  1.225)

			CASE &ALS_tipooper .ch_opera = "4"

				DO CASE
	               CASE LEFT(LSclasprd,2) $ "00/01"  ;
	                    OR LEFT(LSclasprd,5) $ "04042"
						*----------------------------------------------*
    	            	* REGRA TRATAR REDUCAO PIS COFIS PARA PNEUS
    	            	* CAMARAS E PROTETORES
						* Oliveira 21/09/2004 => Em fun┤фo da altera┤фo
						* do convenio 10/03 a redu┤фo (PIS/COFINS) passa
						* a insidir sobre a base de substitui┤фo
						*----------------------------------------------*
						IF LDdata < {05.03.2007}
						    LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
						    LNbssubs	= LNbssubs - ;
					             ROUND(LNbssubs * LNalq_rdu/100,2)
						ELSE
					    	LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
					    	LNbssubs	= LNbssubs - ;
			            	 ROUND((LNbs_TRIBUTAR*LNiva) * LNalq_rdu/100,2)

						ENDIF


				   OTHERWISE
						*----------------------------------------------*
    	        	    * REGRA TRATAR REUCAO ICMS PA PECAS
						* Oliveira 21/09/2004 => Em fun┤фo da altera┤фo
						* do convenio 10/03 a redu┤фo (PIS/COFINS) passa
						* a insidir sobre a base de substitui┤фo
						*----------------------------------------------*

				    	LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
					ENDCASE

			OTHERWISE
			    LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
		ENDCASE
	ENDIF
	*------------------------------------------------------------*
	*--------------------->>> OUTRAS <<<-------------------------*
	*------------------------------------------------------------*
	DO CASE
		CASE LScst = "0"		&& COM REDUCAO BASE CALCULO ICMS
		                        && atribuido apos mudanca pis cofins
			LNbsisent 	= LNbsbrIcms - LNbsicms
		CASE LScst = "1"		&& COM REDUCAO BASE CALCULO ICMS
		                        && BASICAMENT EM DEVOLUCOE
		                        && TRIBUTADA E COM SUBSTITUICAO
			LNbsisent 	= LNbsbrIcms - LNbsicms
		CASE LScst = "2"		&& COM REDUCAO BASE CALCULO ICMS
			LNbsisent 	= LNbs_TRIBUTAR - LNbsicms
		CASE LScst = "3"		&& ISENT. OU N. TRIB. E COM SUBST. TRIB
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "4"		&& ISENT. OU N. TRIB. E COM SUBST. TRIB
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "5"		&& COM SUSPENSAO OU DIFERIMENTO
			LNbsoutr 	= LNbs_TRIBUTAR
		CASE LScst = "6"		&& ICMS CABRADO ANTES POR SUBSTITUICAO
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "7"		&& COM REDUCAO BASE CALCULO ICMS POR SUBS
			LNbsisent 	= LNbs_TRIBUTAR - LNbsicms
	ENDCASE
	*---------------------- CALCULANDO VALORES ------------------*
	LNvlricms 	= LNbsicms * LNalq_icms / 100

	IF LNbssubs > 0
		IF LSufdesti $ "MG/SP/RJ" AND &ALS_tipooper .ch_opera <> "4"			
			*------ ALIQUOTA INTERNA 18 % ----*
			LNicmSub = ;
			 ((LNbssubs) * 0.18) - (LNbsIcms * LNalq_icms / 100)
		ELSE
        	LNicmSub = ;
        	 ((LNbssubs) * 0.17) - (LNbsIcms * LNalq_icms / 100)
		ENDIF
	ENDIF
	*------------------------------------------------------------*
    DO TRcalc_Fecha

	*------------------------------------------------------------*

	vTParam[01] = LNbsIpi
	vTParam[02] = LNvlrIpi
	vTParam[03] = LNbsIsIpi
	vTParam[04] = LNbsbrIcms
    vTParam[06] = LNissrtd


	*------------------------------------------------------------*
RETURN(.T.)


PROCEDURE TRcalc_Fecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Saldo")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKEU           CSTENT VALID                       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   18  ╨
*       ╨ Variable:            CSTENT                             ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      116                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkeu     &&  CSTENT VALID
#REGION 4
RETURN

PROCEDURE TXMP


           * A ROTINA A SER DESENVOLVIDA DEVE SUBSTITUIR TRECHO DE
           * PROGRAMA ESCRITO EM SCT0310 QUE GERA O SINTEGRA E CORRIGE
           * O CST


			*---------------------------------------------------*			
			*  ATENCAO : Definir Regra para Informar corretamente
			*           CST em NOTAS DE ENTRADA
			*---------------------------------------------------*			

			IF itemmov.cst <> " "
				LScst   = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
					  LIVROENT.cst+ "0"
			ELSE
				DO CASE
					CASE LIVROENT.tp_mercad = 1 ;
					    and LIVROENT.base_calc > 0 ;
					    and LIVROENT.base_calc <> LIVROENT.vlrvenda
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
					CASE LIVROENT.tp_mercad = 1 and LIVROENT.base_calc > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "0"  + "0"
					CASE LIVROENT.tp_mercad = 1 and LIVROENT.base_calc = 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
					CASE   LIVROENT.tp_mercad = 2 ;
					   and LIVROENT.icms_subs > 0 ;
					   and LIVROENT.base_calc > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "1"  + "0"
					CASE LIVROENT.tp_mercad = 2 and LIVROENT.icms_subs > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "6"  + "0"
					CASE LEFT(LIVROENT.codigo,5) = "99999"
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "9"  + "0"
					OTHERWISE
						LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
				ENDCASE
			ENDIF
RETURN

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKEV           TRRtdoSaida VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   19  ╨
*       ╨ Variable:            TRRtdoSaida                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      117                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkev     &&  TRRtdoSaida VALID
#REGION 4
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRI─гO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser═
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido ┌ calculado conforme a f╒rmula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda nфo trata de forma parametrizada
	*					 a aliquota interna e at┌ que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa┤фo atual
	*					 em termos de Pneul┐ndia
	*------------------------------------------------------------------*						

FUNCTION TRRtdoSaida
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNicms,LNbase_Icms,LNbase_Rtdo

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNicmsOrigem       && Aliquota Externa no Estado Origem
	PRIVATE LNicmsDestino      && Aliquota Interna no Estado Destino
 	
    LSAlias      = Alias()

	LNicms = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) &&
	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmInUF(LSufDestino) &&

	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNbase_Rtdo = TREbsRtdoCIVA(LSproduto,;
							LSufOrigem,;
							LSufDestino,;
							LNvlrMercadoria,;
							LNvlrIPI,;
							LNcdg_Forn)


	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2

  		   LNicms =  (LNbase_Rtdo * LNicmsDestino/100)-;
   	    	         (LNbase_Icms  * LNicmsOrigem/100)

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNicms)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKEW           TRRtdoEntrada VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   20  ╨
*       ╨ Variable:            TRRtdoEntrada                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      118                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkew     &&  TRRtdoEntrada VALID
#REGION 4
RETURN

FUNCTION TRRtdoEntrada
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn

	=W_DEFPROC("rotinas.spr")
				
	PRIVATE LSalias,LNicms,LNbase_Icms,LNbase_Rtdo

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNicmsOrigem       && Aliquota Externa no Estado Origem
	PRIVATE LNicmsDestino      && Aliquota Interna no Estado Destino
	PRIVATE LNiva			   &&
 	
	LNicms = 0.00
    LSAlias      = Alias()

	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) &&
	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmInUF(LSufDestino) &&
	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNbase_Rtdo = TREbsRtdoCIVA(LSproduto,;
							LSufOrigem,;
							LSufDestino,;
							LNvlrMercadoria,;
							LNvlrIPI,;
							LNcdg_Forn)



	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*


	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 1 and LNRgTrbDestino = 2

  		   LNicms =  (LNbase_Rtdo * LNicmsDestino/100)-;
   	    	         (LNbase_Icms  * LNicmsOrigem/100)


	    ENDIF
	ENDIF


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNicms)

*--------------   descartado em 6/10/2003
*  		   LNicms =  ((LNvlrMercadoria + LNvlrIPI);
*	   			 * LNiva * LNicmsDestino/100)-;
*	             (LNbase_Icms  * LNicmsOrigem/100)
*----------------

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKEX           TRicmNormal VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   21  ╨
*       ╨ Variable:            TRicmNormal                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      119                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkex     &&  TRicmNormal VALID
#REGION 4
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION UITicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRI─гO :  -Calcula o ICMS NORMAL no Item de Entrada :
	*				-Sera Calculado para TP_MERCAD = 1
	*					(Mercadoria Tributada)
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*-------------------------------------------------------------------*						

FUNCTION TRicmNormal
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
				
	=W_DEFPROC("rotinas.spr")


	PRIVATE LSalias,LNicms,LNbase_Icms
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples

	LNicms = 0.00
    LSAlias      = Alias()

	
	*--------------------------------------------------------*
	=W_DEFPROC("forneced.spr")
	LNRgFiscFornecedor = FRrgm_Fisc(LNcdg_Forn)

    IF 	LSufOrigem = LSufDestino
		=W_DEFPROC("tributar.spr")
		LNicmsOrigem    =	TRAlqIcmInUF(LSufOrigem) && Aliquota Interna
	ELSE
		=W_DEFPROC("tributar.spr")
		LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) && Aliquota Externa
	ENDIF


	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)


	**** IF LNRgTrbOrigem = 1  AND LNRgTrbDestino = 1

	IF LNRgTrbDestino = 1 AND LNRgFiscFornecedor = 0
	    LNicms =  LNbase_Icms * LNicmsOrigem/100
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNicms)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKFO           TREnbsicmNormal VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   22  ╨
*       ╨ Variable:            TREnbsicmNormal                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      120                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkfo     &&  TREnbsicmNormal VALID
#REGION 4
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION Ubsicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRI─гO :  -Calcula a Base ICMS NORMAL no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION TREnbsicmNormal
	PARAMETERS 	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
				
	=W_DEFPROC("rotinas.spr")


	PRIVATE LSalias,LNbase_Icms

    LSAlias      = Alias()

	LNbase_Icms = 0.00

	*--------------------------------------------------------*

    IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 	LNbase_Icms = LNvlrMercadoria - (LNvlrMercadoria * (4.9/100))
	ELSE
	 	LNbase_Icms = LNvlrMercadoria
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNbase_Icms)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKFU           TREbsRtdoCIVA VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   23  ╨
*       ╨ Variable:            TREbsRtdoCIVA                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      121                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkfu     &&  TREbsRtdoCIVA VALID
#REGION 4
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRI─гO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser═
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido ┌ calculado conforme a f╒rmula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda nфo trata de forma parametrizada
	*					 a aliquota interna e at┌ que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa┤фo atual
	*					 em termos de Pneul┐ndia
	*------------------------------------------------------------------*						

FUNCTION TREbsRtdoCIVA
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNbase_Retido

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNiva			   &&
 	
    LSAlias      = Alias()

	LNbase_Retido = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")

	LNiva = TRGet_IVA( LSufOrigem,;
			            LSproduto,;
			            LSUFdestino ,;
			            wp_dtoper )

	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2
  	
  		  LNbase_Retido =  (LNvlrMercadoria + LNvlrIPI)

		  IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (4.9/100))
		  ENDIF

		  IF LNcdg_Forn = 2
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (5.19/100))
		  ENDIF

          LNbase_Retido = LNbase_Retido *  LNiva

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNbase_Retido)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKG2           TREbsRtdoSIVA VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   24  ╨
*       ╨ Variable:            TREbsRtdoSIVA                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      122                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkg2     &&  TREbsRtdoSIVA VALID
#REGION 4
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRI─гO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser═
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido ┌ calculado conforme a f╒rmula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda nфo trata de forma parametrizada
	*					 a aliquota interna e at┌ que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa┤фo atual
	*					 em termos de Pneul┐ndia
	*------------------------------------------------------------------*						

FUNCTION TREbsRtdoSIVA
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNbase_Retido

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
 	
    LSAlias      = Alias()

	LNbase_Retido = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2
  	
  		  LNbase_Retido =  (LNvlrMercadoria + LNvlrIPI)

		  IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (4.9/100))
		  ENDIF

		  IF LNcdg_Forn = 2
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (5.19/100))
		  ENDIF

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNbase_Retido)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKGA           TRcalc_Difer VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   29  ╨
*       ╨ Variable:            TRcalc_Difer                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      123                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkga     &&  TRcalc_Difer VALID
#REGION 4
RETURN

FUNCTION TRcalc_Difer
	PARAMETERS LNValorTotal,LNqtde,Lncasas
	*------------------------------------------------------------*
	PRIVATE LNajuste
	LNajuste = ROUND(LNValorTotal/LNqtde,Lncasas)*LNqtde
RETURN(LNajuste)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKGG           TRVincTipo VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   31  ╨
*       ╨ Variable:            TRVincTipo                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      124                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*


FUNCTION _42s11gkgg     &&  TRVincTipo VALID
#REGION 4
RETURN

FUNCTION TRVincTipo
	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_TipoOper,ALS_TipoOper
    PRIVATE ARQ_ClasFisc,ALS_ClasFisc
	LSalias = ALIAS()

    ARQ_TipoOper     = NetArqAgain("TIPOOPER")
    ALS_TipoOper     = Alias()

    ARQ_ClasFisc     = NetArqAgain("CLASFISC")
    ALS_ClasFisc     = Alias()

	IF ( ARQ_TipoOper + ARQ_ClasFisc) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&Als_TipoOper")
        =up_fecha("&Als_ClasFisc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = " "
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*


	*-----------------------------------------------*
	*CRIAR CODIGO DA CLASSIFICACAO <CODCLASSIF>
	*-----------------------------------------------*



	SELE &ALS_ClasFisc
	SET ORDER TO TAG CFOP
	GO TOP

	CTRCFOP = 1
	QBRCFOP = CFOP
	DO WHILE !EOF()
		m.CODCLASSIF = INT(VAL(CHRTRAN(CFOP,".","")))*10+CTRCFOP
		=RLOCK()
		REPLACE CODCLASSIF WITH m.CODCLASSIF
		QBRCFOP = CFOP
		SKIP

		IF QBRCFOP = CFOP
			CTRCFOP = CTRCFOP + 1
		ELSE
			CTRCFOP = 1
		ENDIF
	
	ENDDO



	*-----------------------------------------------*
	*ATRIBUIR CODIGO DA CLASSIFICACAO A TABELA TIPOOPER (FOX)
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFO


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODOPERA   WITH &ALS_ClasFisc .CODOPERA
		REPLACE &Als_TipoOper .CODCLASSIF WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO
		


	*-----------------------------------------------*
	*  OPERACOE VICULADAS A CFO SUBSTITUICAO
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFOSUBS


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODCLSSUBS WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO
		

	*-----------------------------------------------*
	*  OPERACOE VICULADAS A CFO SERVICO
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFOSERVICO


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODCLSERVC WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO


	*-----------------------------------------------*
	*  ATRIBUICAO CST
	*-----------------------------------------------*





	*------------------------------------------------------------*
    =up_fecha("&Als_TipoOper")
    =up_fecha("&Als_ClasFisc")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)

*BROWS FIELDS CL.CODOPERA,CL.CODCLASSIF,CL.CFOP,;
*         TP.CFO,TP.CFOSUBS,TP.CFOSERVICO,TP.TIPO,TP.CODOPERA,;
*         TP.CODCLASSIF,TP.CODCLSSUBS,TP.CODCLSERVC


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKGH           TRGet_IVA VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   32  ╨
*       ╨ Variable:            TRGet_IVA                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      125                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkgh     &&  TRGet_IVA VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TRGet_IVA
PARAMETERS 	PrmUFOrigem,;
			PrmProduto, ;
			PrmUFDestino,;
			PrmData,;
    		PrmPrdtOrigem,;
    		PrmAlsNF,;
    		PrmAlsIT
    		
    		


	=W_DEFPROC("rotinas.spr")


	IF TYPE("PrmPrdtOrigem") <> "N"
	   PrmPrdtOrigem  = 0   && ASSUME NACIONAL
	ENDIF


	IF TYPE("PrmUFDestino") <> "C"
	    DO OBJ_ALER.SPR WITH ;
		   "ERRO -> CHAMADA DA FUNCAO TRget_IVA NAO FOI ADAPTADA ";
		         +CHR(13)+CHR(13)+;
			   "   <ENTER>  "
				SET STEP ON
	ENDIF

    PRIVATE LNiva
    PRIVATE LSalias
	PRIVATE LSuf

	PRIVATE LNalq_externaUForg, LNalq_internaUFDst


    PRIVATE ALS_Grupo
    PRIVATE ARQ_tab_iva,ALS_tab_iva

    LSAlias      = Alias()


	STORE 0 TO ARQ_Grupo, ARQ_tab_iva
	*--------------------------------------------------------

	=W_DEFPROC("GRUPO.SPR")
    ALS_Grupo    = GRGetAlias()

	*--------------------------------------------------------


	IF TYPE("TRtab_IvaALIAS") = "U" OR !USED(TRtab_IvaALIAS)
		PUBLIC TRtab_IvaALIAS
	    ARQ_tab_iva     = NetArqAgain("TAB_IVA")
	    TRtab_IvaALIAS  = Alias()
	ENDIF

    ALS_tab_iva  = TRtab_IvaALIAS

    LNiva = 0
	*--------------------------------------------------------*

	
	LSuf = PrmUFDestino

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
        DO TRFcht_IVAFecha
        RETURN(LNiva)
	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para Produto  especifico
	*------------------------------------------------------------*

	SELE &ALS_tab_iva
	SET ORDER TO TAG subgrupo
	SEEK LSuf + LEFT( &Als_Grupo .classifica,5)+PrmProduto
    IF !FOUND()
		SEEK "BR"+ LEFT( &Als_Grupo .classifica,5)+PrmProduto
	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para SubGrupo do Produto
	*------------------------------------------------------------*

	IF FOUND()
	    LNiva		= 	&Als_tab_iva .iva
	ELSE
		SELE &ALS_tab_iva
		SEEK LSuf + LEFT( &Als_Grupo .classifica,5)+""
    	IF !FOUND()
			SEEK "BR" + LEFT( &Als_Grupo .classifica,5)+""
		ENDIF

	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para SubGrupo do Produto
	*------------------------------------------------------------*

	IF FOUND()
	    LNiva		= 	&Als_tab_iva .iva
	ELSE
		SELE &ALS_tab_iva
		SEEK LSuf + LEFT( &Als_Grupo .classifica,2)+SPACE(3)
    	IF !FOUND()
			SEEK "BR" + LEFT( &Als_Grupo .classifica,2)+SPACE(3)
		ENDIF

		IF FOUND()
		    LNiva		= 	&Als_tab_iva .iva
		ENDIF
	ENDIF

    *-------------------------------------------------------------*
    * Regras para definicao de IVA Ajustada
	*-------------------------------------------------------------*
	*--ANTIGA---------------------------------------------------*
	*		IF (PrmUFOrigem $ "MT/DF" OR PrmUFDestino  $ "MT/DF");
	*		    	and PrmUFOrigem <> PrmUFDestino ;
	*		    	and PrmData >= {01.06.2008} ;
	*		    	and PrmData <  {01.09.2012}
	*
	*            LNiva = TR_TOIVAAjustada(LNiva)
	*       ENDIF
	*-----------------------------------------------------------*

    LNiva =  TR_InternaIVAAjustada(LNiva)

    LNiva = TR_ICM49IVAjustada(LNiva)

    LNiva = TR_ICM62IVAjustada(LNiva)

    LNiva = TR_ICM92IVAjustada(LNiva)




	*------------------------------------------------------------*

    DO TRFcht_IVAFecha

RETURN(LNiva)

PROCEDURE TRFcht_IVAFecha
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKH4           TRCFOPServico VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   34  ╨
*       ╨ Variable:            TRCFOPServico                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      126                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkh4     &&  TRCFOPServico VALID
#REGION 4
RETURN

*-------------------------------------------------------*
*-----> DEFINECFOP PARA SERVICO
*-------------------------------------------------------*

FUNCTION TRCFOPServico
PARAMETERS PrmUFOrgn, ;
           PrmMuniOrgn,;
           PrmUFDstn,;
           PrmMuniDstn,;
           PrmTp_mercad,;
           PrmOperacao

PRIVATE LScfps

	DO CASE
		CASE PrmTp_mercad <> 7   && nao e servico
			LScfps  = "0000"		
		CASE PrmUFOrgn = PrmUFDstn
			LScfps  = "5933"		
		CASE PrmUFOrgn <> PrmUFDstn
			LScfps  = "6933"		
		OTHERWISE
			LScfps  = "0000"		


    *-------------------------------------------------------------*
    *----> lembrar porque foram colocador os codigos abaixo
    *--> este codegos estava dando erro na NFr
    *-------------------------------------------------------------*
    *
  	*	CASE PrmUFOrgn = PrmUFDstn AND PrmMuniOrgn = PrmMuniDstn
	*		LScfps  = "9101"		
	*	CASE PrmUFOrgn = PrmUFDstn AND PrmMuniOrgn <> PrmMuniDstn
	*		LScfps  = "9102"		
	*	CASE PrmUFOrgn <> PrmUFDstn
	*		LScfps  = "9103"		
	*	OTHERWISE
	*		LScfps  = "0000"		
	ENDCASE
RETURN(LScfps)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKHB           TRCST_IPI VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   35  ╨
*       ╨ Variable:            TRCST_IPI                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      127                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkhb     &&  TRCST_IPI VALID
#REGION 4
RETURN

FUNCTION TRCST_IPI
PARAMETERS PrmVlrIPI,PrmOperacao
	PRIVATE LScstIPI

*---------------------------------------------------------*
* ROTINA ERRADA ATE SET/11
*---------------------------------------------------------*
*	DO CASE
*		CASE PrmOperacao = "SAIDA" AND PrmVlrIPI > 0
*			LScstIPI  = "50"		
*		CASE PrmOperacao = "SAIDA" AND PrmVlrIPI = 0
*			LScstIPI  = "53"		
*		CASE PrmOperacao = "ENTRADA" AND PrmVlrIPI > 0
*			LScstIPI  = "50"		
*		CASE PrmOperacao = "ENTRADA" AND PrmVlrIPI = 0
*			LScstIPI  = "53"		
*		OTHERWISE
*			LScstIPI  = "53"		
*	ENDCASE
*---------------------------------------------------------*


	DO CASE
		CASE PrmOperacao = "SAIDA"
	***		LScstIPI  = "99"		
			LScstIPI  = "53"		
		OTHERWISE
	***		LScstIPI  = "49"		
			LScstIPI  = "03"		
	ENDCASE
	
RETURN(LScstIPI)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKHH           TRCST_ISS VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   36  ╨
*       ╨ Variable:            TRCST_ISS                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      128                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkhh     &&  TRCST_ISS VALID
#REGION 4
RETURN

FUNCTION TRCST_ISS
PARAMETERS PrmVlrISS,PrmOperacao
PRIVATE LScstISS

	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlrISS > 0   &&  servico
			LScstISS  = "00"		
		CASE PrmOperacao = "SAIDA" AND PrmVlrISS = 0   && nao e servico
			LScstISS  = "07"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlrISS > 0   &&  servico
			LScstISS  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlrISS = 0   && nao e servico
			LScstISS  = "07"		
		OTHERWISE
			LScstISS  = "07"		
	ENDCASE
RETURN(LScstISS)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKHN           TRGenero VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   37  ╨
*       ╨ Variable:            TRGenero                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      129                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkhn     &&  TRGenero VALID
#REGION 4
RETURN

FUNCTION TRGenero
PARAMETERS PrmTp_mercad,PrmClassifica,PrmOperacao
PRIVATE LSgenero

	DO CASE
		CASE PrmTp_mercad = 7
			LSgenero  = "00"		
		CASE LefT(Prmclassifica,2) $ "00/01"
			LSgenero  = "40"		
		OTHERWISE
			LSgenero  = "87"		
	ENDCASE
RETURN(LSgenero)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKHT           antTRCST_Entrada VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   38  ╨
*       ╨ Variable:            antTRCST_Entrada                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      130                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
*
*(ILIVROENT.cst, ILIVROENT.origem, ILIVROENT.tp_mercad,
*		ILIVROENT.base_calc, ILIVROENT.vlrvenda,
*		ILIVROENT.icms_subs, ILIVROENT.codigo
*
*(PrmCstInfo   , PrmOrigem       ,PrmTp_Mercad        ,
*		Prmbase_calc, PrmVlrvenda,;
*		Prmicms_subs, PrmCodigo

FUNCTION _42s11gkht     &&  antTRCST_Entrada VALID
#REGION 4
RETURN


FUNCTION antTRCST_Entrada
PARAMETERS PrmCstInfo,PrmOrigem,PrmTp_Mercad,Prmbase_calc,PrmVlrvenda,;
		Prmicms_subs, PrmCodigo, Prmtipo

PRIVATE LScst


			*---------------------------------------------------*			
			*  ATENCAO : Definir Regra para Informar corretamente
			*           CST em NOTAS DE ENTRADA
			*---------------------------------------------------*			

		DO CASE
			CASE;
			 Prmtipo $ ;
 			 "CLG/CLH/CFG/CFH/CFM/CID/CLC/CLD/CFC/CFD/CIB/CLE/CLF/CFS/CFE/";
 			 OR ;
			 Prmtipo $ ;
 			 "CFF/CIC/CLJ/CFL/ASC/CEE/ASI/CFJ/CFK/TAB/TBB/TAC/TBC/TAD/TBD/";
 			 OR ;
			 Prmtipo $ ;
 			 "RBV/RBU/RBF/RBH/RBJ/RBM/RBN/RBG/RBI/RBL/RBO/RAC/RBC/RIB/RAA/";
 			 OR ;
			 Prmtipo $ ;
 			 "RBR/RAE/RBE/RID/RBP/RBQ/RCA/RDA/DAF/DBF/DAC/DBC/DBD/DAE/DBE/";
 			 OR ;
			 Prmtipo $ ;
 			 "DAG/DBG/"

			  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "9"  + "0"


			*CASE PrmCstInfo <> " "
			*	LScst   = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
			*		  PrmCstInfo+ "0"


			CASE PrmTp_Mercad = 7
			  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "9"  + "0"

			CASE PrmTp_Mercad = 1
			  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "0"  + "0"


			CASE PrmTp_Mercad = 2
			  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"

			OTHERWISE
				DO CASE
					CASE PrmTp_Mercad = 1 ;
					    and Prmbase_calc > 0 ;
					    and Prmbase_calc <> PrmVlrvenda
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"


					CASE PrmTp_Mercad = 1 and Prmbase_calc > 0
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "0"  + "0"
					CASE PrmTp_Mercad = 1 and Prmbase_calc = 0
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"
					CASE   PrmTp_Mercad = 2 ;
					   and Prmicms_subs > 0 ;
					   and Prmbase_calc > 0
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
					CASE PrmTp_Mercad = 2 and Prmicms_subs > 0
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"
					CASE LEFT(PrmCodigo,5) = "99999"
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "9"  + "0"
					OTHERWISE
						LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"
				ENDCASE
		ENDCASE
		

RETURN(LScst)





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKHU           TRcst_Icms VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   39  ╨
*       ╨ Variable:            TRcst_Icms                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      131                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*


FUNCTION _42s11gkhu     &&  TRcst_Icms VALID
#REGION 4
RETURN

FUNCTION TRcst_Icms
	PARAMETERS Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto,PrmCst


	PRIVATE Lcst
	

	=W_DEFPROC("GRUPO.SPR")
	LSCst =  GRGetOrigem(PrmProduto)

	LSCst =  STR( LSCst,1)
	
	
	LSCst =  LScst + ;
			 TRdefcst(Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto,PrmCst) + ;
			 "0"
	LSCst = CHRTRAN(LSCst," ","0")

RETURN(LScst)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKHV           TRCST_PIS VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   40  ╨
*       ╨ Variable:            TRCST_PIS                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      132                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkhv     &&  TRCST_PIS VALID
#REGION 4
RETURN

FUNCTION TRCST_PIS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "07"		
	ENDCASE
RETURN(LScst)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKHW           TRCST_COFINS VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   41  ╨
*       ╨ Variable:            TRCST_COFINS                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      133                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkhw     &&  TRCST_COFINS VALID
#REGION 4
RETURN

FUNCTION TRCST_COFINS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "01"	   && ANTES "00"	
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "04"      && ANTES "00"
	ENDCASE
RETURN(LScst)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKHX           TRCST_IR VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   42  ╨
*       ╨ Variable:            TRCST_IR                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      134                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkhx     &&  TRCST_IR VALID
#REGION 4
RETURN

FUNCTION TRCST_IR
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "07"		
	ENDCASE
RETURN(LScst)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKIP           TRDef_RgTrbMercad VALID            ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   44  ╨
*       ╨ Variable:            TRDef_RgTrbMercad                  ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      135                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkip     &&  TRDef_RgTrbMercad VALID
#REGION 4
RETURN

FUNCTION TRDef_RgTrbMercad
	PARAMETER PrmUF,PrmProduto,PrmFormaRetorno
	
	
	
	*-----------------------------------------------------------------*	
	*--> PrmFormaRetorno = 'RETORNAR STRING'
	*   RETORNAR EM FORMATO STRIG (USADO EM DOC FISCAL - EFD E NFe )
	*-----------------------------------------------------------------*	
	




	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE	LSClassifica
	PRIVATE	LNtp_mercad
	LNtp_mercad	= 99999   && INVALIDO
	
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*--------------------------------------------------------

	=W_DEFPROC("GRUPO.spr")
	LSClassifica=GRGetFieldValue(PrmProduto,"CLASSIFICA")


	=W_DEFPROC("GRFISCAL.spr")
	LNtp_mercad	= GFGetTp_Mercadoria(PrmUF, LSClassifica)



*	*--------------------------------------------------------------------*
*	* Rotina estava perdida  em TRIBUTAR TRpct_trib
*	* transcrevi em 06/09/2012 e precisa de uma reavaliacao
*	* para decidir se continua
*	*--------------------------------------------------------------------*
*	*----------------------------------------------------------------*
*	*		Identificar mercadorias em regime de substituicao ESTADUAL
*	*	em caso de operacao ITERESTADUAIS com consumidor INSCRITO(2)/
*	*	REVENDA(4) ou DEVOLUCOES passa mercadoria para regime tributado
*	*----------------------------------------------------------------*
*
*	IF LNtp_mercad = 2	AND &Als_tipooper .ch_desti = "2"
*		IF     left(LSClassifica,5) > "02000" ;
*		   AND left(LSClassifica,5) < "99999" ;
*		   AND left(LSClassifica,5) <> "04042"
*			DO CASE
*				*----------------------------------------------------*
*				* TODAS OPERACOES DIFERENTES DE VENDAS
*				*----------------------------------------------------*
*				CASE &Als_tipooper .ch_opera <> "1" && TODAS OPER DIFERE
*				                                    && DE VENDA
*					LNtp_mercad	= 	1
*				*----------------------------------------------------*
*				* TODAS VENDAS Q NAO FOREM PARA 1-CONSSUMIDOR  OU
*				*                               3-CONTR NAO ISCRITO
*				*----------------------------------------------------
*				CASE !( &Als_tipooper .ch_contr $ "3/1" )
*					LNtp_mercad	= 	1
*			ENDCASE
*		ENDIF
*	ENDIF
*

	*-------------------------------------------------------------*

	IF TYPE('PrmFormaRetorno') = "C" ;
	   AND  PrmFormaRetorno = 'RETORNAR STRING'
	
		DO CASE

			CASE LNtp_mercad = 7
				LNtp_mercad	= "SERVICO"		

			CASE LNtp_mercad = 2
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			CASE LNtp_mercad = 8
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			OTHERWISE
				LNtp_mercad	= "ICMS NORMAL"		

		ENDCASE


	ENDIF





	*-------------------------------------------------------------*


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNtp_mercad)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKIX           TRpct_trib VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   45  ╨
*       ╨ Variable:            TRpct_trib                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      136                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkix     &&  TRpct_trib VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRpct_trib
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto, ;
    LNiva, LNipialq, LNtp_mercad, LScst, ;
    LNaliq_iss, LNaliq_rdu, LNaliq_icms, LScfo


	=W_DEFPROC("rotinas.spr")


	PRIVATE LSEmpEstado
	PRIVATE LSClassifica
	PRIVATE LSProdOrigem
	PRIVATE LNtab_cst
	PRIVATE LNEmpReduzBase



    PRIVATE LSalias

    PRIVATE ARQ_GrFiscal,ALS_GrFiscal
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper
	PRIVATE LSUForigem, LSUFdestino

    LSAlias      = Alias()

	
    LNiva = 0
    LNipialq = 0
	LNtp_mercad	= 99999   && INVALIDO
*-*	LScst		= " "		&& ASSUME 0
    LNaliq_iss = 0
    LNaliq_rdu = 0
    LNaliq_icms = 0
    LScfo = ""




    ARQ_GrFiscal  = NetArqAgain("GRFISCAL")
    ALS_GrFiscal  = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()


    LNiva = 0
	*--------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	IF !EMLerRegistro(PrmEmpresa)
	    do TRFcht_Fecha
		RETURN
	ENDIF


	=W_DEFPROC("GRUPO.SPR")
	IF !GRLerRegistro(PrmProduto)
	    do TRFcht_Fecha
		RETURN
	ENDIF




	*---------------------------------------------------------------*


	=W_DEFPROC("EMPRESA.SPR")
	LSEmpEstado = EMGet_UF(PrmEmpresa)

	=W_DEFPROC("GRUPO.SPR")
	LSClassifica = GRGetClassifica(PrmProduto)


	=W_DEFPROC("GRUPO.SPR")
	LSProdOrigem = GRGetOrigem(PrmProduto)




	SELE &Als_GRfiscal
	SET ORDER TO trb_classe
	SEEK LSEmpEstado + LEFT( LSClassifica,5)
	IF !FOUND()
		SET ORDER TO trb_sbgrpo
		SEEK LSEmpEstado + LEFT( LSClassifica,8)
	ENDIF

	*---------------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF


	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    *=========>>>>>>>   OBTER IVA    <<<<<<



	=W_DEFPROC("CLIENC.SPR")
	LSUFdestino = CNGetUFDestino(PrmEmpresa,PrmOrcamento)


	=W_DEFPROC("EMPRESA.SPR")
	LSUForigem = EMGet_UF(PrmEmpresa)


	=W_DEFPROC("TRIBUTAR.SPR")
	LNiva = TRGet_IVA( LSUForigem,;
			            PrmProduto,;
			            LSUFdestino ,;
			            &ALS_Orcament .data )




    *=========>>>>>>>   OBTER ALIQ IPI    <<<<<<

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA
	DO CASE

		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA

		CASE LSProdOrigem = 1
			=W_DEFPROC("GRUPO.SPR")
			LNipialq   =  GRGetFieldValue(PrmProduto,"ALIQ_IPI")

		OTHERWISE
			LNipialq   =	0
	ENDCASE


    *=========>>>>>>>   OBTER TP_MERCAD    <<<<<<

    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)

*    *-----------------------------------------------------------------*
*    * A ROTINA ABAIXO FOI DESATIVADA E TRANSFERIDA PARA
*    * FUNCTION TRDef_RgTrbMercad EM 06/09/2012
*	* PARAMETER PrmUF,PrmProduto,PrmFormaRetorno
*    *-----------------------------------------------------------------*
*
*	*----------------------------------------------------------------*
*	*		Identificar mercadorias em regime de substituicao ESTADUAL
*	*	em caso de operacao ITERESTADUAIS com consumidor INSCRITO(2)/
*	*	REVENDA(4) ou DEVOLUCOES passa mercadoria para regime tributado
*	*----------------------------------------------------------------*
*
*
*	*IF LNtp_mercad = 2	AND &Als_tipooper .ch_desti = "2"
*		IF     &Als_grfiscal .subgrupo > "02000" ;
*		   AND &Als_grfiscal .subgrupo < "99999" ;
*		   AND &Als_grfiscal .subgrupo <> "04042"
*			DO CASE
*				*----------------------------------------------------*
*				* TODAS OPERACOES DIFERENTES DE VENDAS
*				*----------------------------------------------------*
*				CASE &Als_tipooper .ch_opera <> "1" && TODAS OPER DIFERE
*				                                    && DE VENDA
*					LNtp_mercad	= 	1
*				*----------------------------------------------------*
*				* TODAS VENDAS Q NAO FOREM PARA 1-CONSSUMIDOR  OU
*				*                               3-CONTR NAO ISCRITO
*				*----------------------------------------------------
*				CASE !( &Als_tipooper .ch_contr $ "3/1" )
*					LNtp_mercad	= 	1
*			ENDCASE
*		ENDIF
*	ENDIF
    *=========>>>>>>>   OBTER CST    <<<<<<


	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LNtab_cst = EMGet_TabCst(PrmEmpresa)


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
	*---------------------------------------------------------------*

	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto,LScst)

    *=========>>>>>>>   OBTER ALIQ ISS    <<<<<<


	=W_DEFPROC("EMPRESA.SPR")
	LNaliq_iss = EMGetFieldValue(PrmEmpresa,"ALIQ_ISS")


    *=========>>>>>>>   OBTER ALIQ reducao icms   <<<<<<
	=W_DEFPROC("EMPRESA.SPR")
	LNEmpReduzBase = EMGetFieldValue(PrmEmpresa,"REDUZ_BASE")


	LNaliq_rdu    =  0


	IF LNEmpReduzBase = 0
		LNaliq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNaliq_rdu   = LNEmpReduzBase  && USAR ALIQUOTA
			                                        && INFORMADA
		endif
	ENDIF

    *=========>>>>>>>   OBTER ALIQ icms   <<<<<<
	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms = &Als_orcament .aliq_icms && USAR ALIQUOTA
											   && INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA
												     && INFORMADA
	ENDIF
    *=========>>>>>>>   OBTER CFO   <<<<<<


	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE LNTp_Mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE




	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
    do TRFcht_Fecha

RETURN

PROCEDURE TRFcht_Fecha
   	=up_fecha("&ALS_GrFiscal")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKJA           TRCnvrt_RgTrbMercad VALID          ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   46  ╨
*       ╨ Variable:            TRCnvrt_RgTrbMercad                ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      137                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkja     &&  TRCnvrt_RgTrbMercad VALID
#REGION 4
RETURN

FUNCTION TRCnvrt_RgTrbMercad
	PARAMETER PrmTpMercad
	
	
	
	*-----------------------------------------------------------------*	
	*--> PrmFormaRetorno = 'RETORNAR STRING'
	*   RETORNAR EM FORMATO STRIG (USADO EM DOC FISCAL - EFD E NFe )
	*-----------------------------------------------------------------*	
	




	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE	LSClassifica
	PRIVATE	LNtp_mercad
	LNtp_mercad	= 99999   && INVALIDO
	
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*--------------------------------------------------------
	LNtp_mercad	= PrmTpMercad

	*-------------------------------------------------------------*

	
		DO CASE

			CASE LNtp_mercad = 7
				LNtp_mercad	= "SERVICO"		

			CASE LNtp_mercad = 2
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			CASE LNtp_mercad = 8
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			OTHERWISE
				LNtp_mercad	= "ICMS NORMAL"		

		ENDCASE



	*-------------------------------------------------------------*


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNtp_mercad)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKJH           TRcst_Entrada VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   47  ╨
*       ╨ Variable:            TRcst_Entrada                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      138                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*


FUNCTION _42s11gkjh     &&  TRcst_Entrada VALID
#REGION 4
RETURN

FUNCTION TRcst_Entrada
PARAMETERS PrmCst,PrmOrigem,PrmTp_Mercad,Prmbase_calc,PrmVlrvenda,;
		Prmicms_subs, PrmProduto, Prmtipo



    Prmtab_cst = 3



	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_tab_cst,ALS_tab_cst
	LSalias = ALIAS()

    ARQ_Tab_Cst     = NetArqAgain("TAB_CST")
    ALS_Tab_Cst     = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()



	IF ( ARQ_Tab_Cst)+ ARQ_Tipooper > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'E'+ PrmTipo
	IF !FOUND()
		SEEK 'e'+  PrmTipo
	ENDIF
	IF !FOUND()
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF



	LScst = " "
	DO CASE
		CASE &Als_tipooper .ch_opera = "4"  && DEVOLUCAO
*****			LScst =  PrmCST
	     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  PrmCST  + "0"
		OTHERWISE
			SELECT &Als_tab_cst
			SET ORDER TO TAG cst
			SEEK STR(Prmtab_cst,2)+PrmTipo+STR(Prmtp_mercad,1)
			IF !FOUND()
				IF tipooper.ch_opera = "3"
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"

				ENDIF
			ELSE
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  LEFT( &Als_tab_cst .cst,1)  + "0"
			ENDIF
	ENDCASE
	*------------------------------------------------------------*
	* EXCECOES
	*------------------------------------------------------------*
    DO CASE
		CASE PrmTipo = "CLA" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "2"  + "0"
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
				CASE Prmicms_subs = 0 AND Prmbase_calc = 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"
			ENDCASE

		CASE PrmTipo = "CLB" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "2"  + "0"

				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
				CASE Prmicms_subs = 0 AND Prmbase_calc = 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"
			ENDCASE
			
		CASE PrmTipo = "CFA" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "7"  + "0"
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE
			
		CASE PrmTipo = "CFB" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "7"  + "0"
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE

		CASE PrmTipo = "CFM" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE
			
		CASE PrmTipo = "CFS" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE

    ENDCASE


	*------------------------------------------------------------*

    =up_fecha("&ALS_Tab_cst")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKJI           TR_InternaIVAAjustada VALID        ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   48  ╨
*       ╨ Variable:            TR_InternaIVAAjustada              ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      139                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkji     &&  TR_InternaIVAAjustada VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_InternaIVAAjustada
PARAMETERS LNiva




    *-------------------------------------------------------------
    * conforme solicitacao do Celio Repassada pelo almir foi revgada
    * a instrucao anterior para DF e GO retornando o IVA interno
    * para ser orientada pelo cadastro na tabela TAB_IVA e
    * ignorar regras internas do programa
    *
    *-------------------------------------------------------------
     IF 1 =  1
        RETURN(LNIva)
     ENDIF



	*------------------------------------------------------------*
	* IVA TERMO DE ACORDO TO/DF/GO
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra para termo de acordo
    *   revenda INTERNA DE pecas no TO
    *   => PECAS
    *      => TO / DF / GO
	*------------------------------------------------------------*
		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*
        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*





 		IF LEFT( &Als_Grupo .classifica,2) = "04" ;
 		   AND 	PrmData >= {01.06.2008} ;
		   AND  PrmData <  {01.01.2013}

	        DO CASE
				CASE (PrmUFOrigem $ "TO" AND PrmUFDestino  $ "TO")
					LNiva = 1.265				

				CASE (PrmUFOrigem $ "DF" AND PrmUFDestino  $ "DF")
					LNiva = 1.596				

				CASE (PrmUFOrigem $ "GO" AND PrmUFDestino  $ "GO")
					LNiva = 1.596				

        	ENDCASE
		ENDIF


        *-------------------------------------------------------------
        * conforme solicitacao do Celio Repassada pelo almir foi revgada
        * a instrucao anterior para DF e GO retornando o IVA interno
        * para 1.400 apartir de 01/01/2012
        *-------------------------------------------------------------

 		IF LEFT( &Als_Grupo .classifica,2) = "04" ;
 		   AND PrmData >=  {01.01.2013}

	        DO CASE
				CASE (PrmUFOrigem $ "TO" AND PrmUFDestino  $ "TO")
					LNiva = 1.265				

				CASE (PrmUFOrigem $ "DF" AND PrmUFDestino  $ "DF")
					LNiva = 1.400				

				CASE (PrmUFOrigem $ "GO" AND PrmUFDestino  $ "GO")
					LNiva = 1.400				
        	ENDCASE
		ENDIF



RETURN(LNIva)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKJJ           TR_ICM49IVAjustada VALID           ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   49  ╨
*       ╨ Variable:            TR_ICM49IVAjustada                 ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      140                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkjj     &&  TR_ICM49IVAjustada VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_ICM49IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PECAS
    *      => MT e DF
	*------------------------------------------------------------*

		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*
		DO CASE

			CASE (PrmUFOrigem $ "DF") ;
			    	and PrmUFOrigem <> PrmUFDestino ;
			    	and PrmData >= {01.06.2008} ;
			    	and PrmData <  {01.09.2012}
				*---------------------------------------------------*
				* PROTOCOLO ICMS 49 -8 DE MAI DE 2008 IVA AJUSTAS DF/MT
				*-----------------------------------------------------*
				LFajustaIVA = LFajustaIVA
							&& SO PARA JUSTIFICAR IF AFIRMATIVO

			CASE (PrmUFOrigem $ "MT");
			    	and PrmUFOrigem <> PrmUFDestino ;
			    	and PrmData >= {01.06.2008} ;
			    	and PrmData <  {01.09.2012}
				*------------------------------------------------*
				* PROTOCOLO ICMS 49 -8 DE MAI DE 2008 IVA AJUSTAS DF/MT
				*----------------------------------------------------*
				LFajustaIVA = LFajustaIVA
							&& SO PARA JUSTIFICAR IF AFIRMATIVO
			OTHERWISE
				RETURN(LNIva)
		ENDCASE
		
        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*

	 	DO CASE
			*--------------------------------------------*
			* PECAS E ACESSORIOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "04"
	 		   IF LEFT( &Als_Grupo .classifica,5)  $ "04041/04042/04043"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF

			*--------------------------------------------*
			* PESOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) = "07075"
	 		   IF SUBS( &Als_Grupo .classifica,6,3)  $ "599/699/799/899/999"
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
			*--------------------------------------------*
			* MATERIAL BORRACHARIA
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "05"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
 	
	 	ENDCASE

		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)


			do case
				case LNiva = 1.265				
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.417				
								case LNalq_internaUFDst = 18
									LNiva = 1.435				
								case LNalq_internaUFDst = 19
									LNiva = 1.452			
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.341				
								case LNalq_internaUFDst = 18
									LNiva = 1.358			
								case LNalq_internaUFDst = 19
									LNiva = 1.374			
		                    endcase
					endcase
				case LNiva = 1.400				
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.569				
								case LNalq_internaUFDst = 18
									LNiva = 1.588				
								case LNalq_internaUFDst = 19
									LNiva = 1.607				
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.484				
								case LNalq_internaUFDst = 18
									LNiva = 1.502				
								case LNalq_internaUFDst = 19
									LNiva = 1.521			
		                    endcase
					endcase
			endcase
		ENDIF


RETURN(LNIva)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKK7           TR_ICM62IVAjustada VALID           ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   50  ╨
*       ╨ Variable:            TR_ICM62IVAjustada                 ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      141                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkk7     &&  TR_ICM62IVAjustada VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_ICM62IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PECAS
	*------------------------------------------------------------*

		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*

		IF ;
		   (PrmUFOrigem $ ;
		      "DF/AC/AL/AP/BA/GO/MA/MT/PB/PR/PE/PI/RN/RR/SC/SE/TO");
		    	and PrmUFOrigem <> PrmUFDestino ;
		    	and PrmData >=  {01.09.2012}
			*------------------------------------------------------------*
			* PROTOCOLO ICMS 62 -22 DE JUN DE 2012 IVA AJUSTAS
			*------------------------------------------------------------*
			LFajustaIVA = LFajustaIVA && SO PARA JUSTIFICAR IF AFIRMATIVO
		ELSE
			RETURN(LNIva)
		ENDIF




        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*

	 	DO CASE
			*--------------------------------------------*
			* PECAS E ACESSORIOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "04"
	 		   IF LEFT( &Als_Grupo .classifica,5)  $ "04041/04042/04043"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF

			*--------------------------------------------*
			* PESOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) = "07075"
	 		   IF SUBS( &Als_Grupo .classifica,6,3)  $ "599/699/799/899/999"
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
			*--------------------------------------------*
			* MATERIAL BORRACHARIA
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "05"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
 	
	 	ENDCASE

		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem,PrmPrdtOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)


			do case
				case LNiva = 1.400	OR LNiva = 1.5960
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.7883				
								case LNalq_internaUFDst = 18
									LNiva = 1.8101			
								case LNalq_internaUFDst = 19
									LNiva = 1.8324				
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.6921				
								case LNalq_internaUFDst = 18
									LNiva = 1.7128				
								case LNalq_internaUFDst = 19
									LNiva = 1.7339			
		                    endcase
					endcase
			endcase
		ENDIF

RETURN(LNIva)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKKF           TR_ICM92IVAjustada VALID           ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         TRIBUTAR,     Record Number:   51  ╨
*       ╨ Variable:            TR_ICM92IVAjustada                 ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      142                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkkf     &&  TR_ICM92IVAjustada VALID
#REGION 4
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*
* em 18 de janeiro incorporamos o tratamento da aliquota de 4%



FUNCTION TR_ICM92IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PNEUMATICOS
	*------------------------------------------------------------*

		LFajustaIVA = .f.


        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*

		IF  PrmUFOrigem <> PrmUFDestino ;
		   	and PrmData >=  {01.09.2012}
			*------------------------------------------------------------*
			* PROTOCOLO ICMS 62 -22 DE JUN DE 2012 IVA AJUSTAS
			*------------------------------------------------------------*
			LFajustaIVA = LFajustaIVA && SO PARA JUSTIFICAR IF AFIRMATIVO
		ELSE
			RETURN(LNIva)
		ENDIF

        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*


	 	DO CASE
			*--------------------------------------------*
			* PNEUMATICOS - PNEUS/CAMARAS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) $ "00/01"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA

			*--------------------------------------------*
			* PROTETORES
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) $ "04042"
	 		   IF LEFT( &Als_Grupo .classifica,8)  $ "04042920"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
	 	ENDCASE


		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem,PrmPrdtOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)


			do case
				case LNiva = 1.42				
					do case
						case LNalq_externaUForg	= 4
							LNiva = 1.6424				
						case LNalq_externaUForg	= 7
							LNiva = 1.5911				
						case LNalq_externaUForg	= 12
							LNiva = 1.5055				
					endcase
				case LNiva = 1.32				
					do case
						case LNalq_externaUForg	= 4
							LNiva = 1.5267				
						case LNalq_externaUForg	= 7
							LNiva = 1.479				
						case LNalq_externaUForg	= 12
							LNiva = 1.3995				
					endcase
				case LNiva = 1.45				
					do case
						case LNalq_externaUForg	= 4
							LNiva = 1.6771				
						case LNalq_externaUForg	= 7
							LNiva = 1.6247				
						case LNalq_externaUForg	= 12
							LNiva = 1.5373				
					endcase
			endcase
		ENDIF

RETURN(LNIva)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKKO           ESPsq_Produtos VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:    4   ╨
*       ╨ Variable:            ESPsq_Produtos                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      143                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkko     &&  ESPsq_Produtos VALID
#REGION 5
RETURN
PROCEDURE ESPsq_Produtos
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Pesquisar Produtos em uma Lista
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: GRUPO
	*------------------------------------------------------------*
	* PARAMETROS..:
	*             LScodigo : Codigo do Produto - Pode Ser Utiliza
	*                  para posicionamento parcial
	*------------------------------------------------------------*
	* CHAMADAS.............:
	*------------------------------------------------------------*
	PARAMETERS LScodigo

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_grupo, ALS_grupo

    LSalias      = Alias()
    ARQ_grupo    = NetArqAgain("GRUPO")
    ALS_grupo    = Alias()



	SELE &ALS_grupo
	SET ORDER TO TAG codigo
	SET NEAR ON
	SEEK ALLTRIM(LScodigo)
	SET NEAR OFF
	*----------------------------------------------------------*
	ON KEY LABEL ESCAPE

	SET ORDER TO TAG ordem
	ON KEY LABEL ESCAPE
	DO loc_dlog WITH .T.

	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	IF LASTKEY() <> 27
	   LScodigo = &ALS_grupo .codigo
	ELSE
	   SEEK ALLTRIM(LScodigo)
	   IF !FOUND()
		   LScodigo = ""
	   ENDIF
	ENDIF

	=UP_fecha(ALS_GRUPO)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScodigo)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKKU           ESAbresaldo VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:    5   ╨
*       ╨ Variable:            ESAbresaldo                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      144                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkku     &&  ESAbresaldo VALID
#REGION 5
RETURN
PROCEDURE ESAbresaldo

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Abrir Registro de Controles de saldo
	* 			do produto informado no periodo informado
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: SALDO, ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Que se quer abrir o Saldo
	*		LSclass........: Classificaso do Produto
	*		LSclass........: Classificaso do Produto
	*		LDdtini........: Referencia do mes inicial
	*		LDdtfim........: Referencia do mes final
	*------------------------------------------------------------*
	* CHAMADAS.............:
	*------------------------------------------------------------*
	PARAMETERS LNemp,LScod,LSclass,LDdtini,LDdtfim

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFsaldo,LFitemmov
	PRIVATE LDdtincrementa, LDdtencerra

	*--------------------------------------------------------------*
	PRIVATE m.sld_ante,m.sld_atu,m.vlr_ante,m.vlr_atu
	PRIVATE m.empresa,m.codigo, m.classifica
	PRIVATE m.qtd_compra,m.vlr_compra,m.qtd_venda,m.vlr_venda,;
			m.qtd_e_tran,m.vlr_e_tran,m.qtd_e_outr,m.vlr_e_outr,;
			m.qtd_s_tran,m.vlr_s_tran,m.qtd_s_outr,m.vlr_s_outr,;
			m.ven_tab,m.ven_contab,m.ven_enc,m.dtabert,m.status
	*--------------------------------------------------------------*
	LSalias			= ALIAS()
	LFsaldo			= NetArq("saldo")
	LFitemmov			= NetArq("itemmov")
	IF (LFsaldo+LFitemmov) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("saldo" ,LFsaldo)
		=UP_fecha("itemmov" ,LFitemmov)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*----------------------------------------------------------------*
	* Redimensiona as datas para permitir o controle do incremento de
	* 1 mes na data inicial dentro do laco
	*----------------------------------------------------------------*
	LDdtincrementa	= LDdtini - DAY(LDdtini) + 1 && 1o DIA DO MES
	LDdtencerra		= LDdtfim -	DAY(LDdtfim) + 1 && 1o DIA DO MES

   	m.sld_ante   = 0
   	m.vlr_ante   = 0

	DO WHILE LDdtincrementa <= LDdtencerra
   		SELECT saldo
	   	SET ORDER TO TAG clas_saldo
   		SET NEAR ON
   		SEEK STR(LNemp,3)+LSclass+;
	        	STR(YEAR(LDdtincrementa),4)+;
    	    	STR(MONTH(LDdtincrementa),2)
	   	SET NEAR OFF

	   	IF  FOUND()
			SKIP -1			&& TESTE SE EXISTE REGISTRO ANTERIOR
	      	IF !BOF() ;
	      		AND saldo.empresa  = LNemp ;
	      		AND saldo.classifica = LSclass
			    	m.sld_ante   = saldo.sld_atu
			    	m.vlr_ante   = saldo.vlr_atu
			ELSE
				SELE itemmov
				SET ORDER TO TAG movsimples
				SET NEAR ON
				SEEK STR(LNemp,3)+LScod+DTOS(LDdtincrementa)
				SET NEAR OFF
				*-------------------------------------------------*
				* PROCURANDO MOVIMENTO ANTERIOR A DATA
				*-------------------------------------------------*
				SKIP -1
				DO WHILE !BOF() ;
						AND itemmov.empresa  = LNemp ;
						AND itemmov.codigo   = LScod ;
						AND itemmov.data >= LDdtincrementa
	
					SKIP -1
				ENDDO
				IF !BOF() 	AND itemmov.empresa  = LNemp ;
							AND itemmov.codigo   = LScod ;
						AND itemmov.data < LDdtincrementa
					* ENCONTROU MOV ANTERIOR

			    	m.sld_ante   = itemmov.sld_estq
			    	m.vlr_ante   = itemmov.vlr_estq
				ENDIF
			ENDIF	
			SELE SALDO
	   		SEEK STR(LNemp,3)+LSclass+;
	        	STR(YEAR(LDdtincrementa),4)+;
    	    	STR(MONTH(LDdtincrementa),2)

			SET FIELDS TO dtregis, hregis, usrregis,deletado
		    SET FIELDS TO sld_ante, vlr_ante
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF

	   	ELSE
			SKIP -1			&& TESTE SE EXISTE REGISTRO ANTERIOR
	      	IF !BOF() ;
	      		AND saldo.empresa  = LNemp ;
	      		AND saldo.classifica = LSclass
			    	m.sld_ante   = saldo.sld_atu
			    	m.vlr_ante   = saldo.vlr_atu
			ELSE
				SELE itemmov
				SET ORDER TO TAG movsimples
				SET NEAR ON
				SEEK STR(LNemp,3)+LScod+DTOS(LDdtincrementa)
				SET NEAR OFF
				*-------------------------------------------------*
				* PROCURANDO MOVIMENTO ANTERIOR A DATA
				*-------------------------------------------------*
				SKIP -1
				DO WHILE !BOF() ;
						AND itemmov.empresa  = LNemp ;
						AND itemmov.codigo   = LScod ;
						AND itemmov.data >= LDdtincrementa
	
					SKIP -1
				ENDDO
				IF !BOF() 	AND itemmov.empresa  = LNemp ;
							AND itemmov.codigo   = LScod ;
						AND itemmov.data < LDdtincrementa
					* ENCONTROU MOV ANTERIOR

			    	m.sld_ante   = itemmov.sld_estq
			    	m.vlr_ante   = itemmov.vlr_estq
				ENDIF
			ENDIF	
	    	m.sld_atu    = m.sld_ante
	    	m.vlr_atu    = m.vlr_ante

   			m.empresa    = LNemp
	    	m.codigo     = LScod
		    m.classifica = LSclass

			STORE 0 TO 	m.qtd_compra,m.vlr_compra,m.qtd_venda,m.vlr_venda,;
					m.qtd_e_tran,m.vlr_e_tran,m.qtd_e_outr,m.vlr_e_outr,;
					m.qtd_s_tran,m.vlr_s_tran,m.qtd_s_outr,m.vlr_s_outr,;
					m.ven_tab,m.ven_contab,m.ven_enc

			m.dtabert   = LDdtincrementa
		    m.status    = 'A'
			SELE SALDO
			=edithand('SAVE')
	
		ENDIF
		LDdtincrementa	= GOMONTH(LDdtincrementa,1) && PROXIMO 1o DIA DO MES
	ENDDO

	=UP_fecha("saldo" ,LFsaldo)
	=UP_fecha("itemmov" ,LFitemmov)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKKV           ESversaldo VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:    6   ╨
*       ╨ Variable:            ESversaldo                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      145                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkkv     &&  ESversaldo VALID
#REGION 5
RETURN

FUNCTION ESversaldo
	PARAMETERS LNemp,LScod,LDdata,LNqtde,LNJaReserv,;
				LFabreAuto,LFlockreg,LSoperacao,LShora,;
				LSmovEstq

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Verificar Saldo Para  atender solicitacao
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....:
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdata.........: Data na Qual se quer o saldo
	*		LNqtde.........: Qtde Solicitada
	*		LNJaReserv.....: Qtde ja Reservada Anteriormente desta
	*						propria Solicitacao
	*						Ex: SOLICITA 10 mas JA TEM 3 RESERVADO
	*						ATERIORMENTE => TEM QUE ATENDEDER 7
	*						esta qu
	*		LFAbreAuto.....: .f. Nao abre Controle quando nao Existe
	*						 .t. Abre Registro de Saldo para Mes
	*		LSoperacao.....: Indica qual opercao esta originando a
	*						chamada a rotina ex:
	*					"RESERVA" => Processo de Reserva ex: SCGC2.PRG
	*
	*
	*					"SAIDA" => Processo de Saida ex: SCGC2.PRG
	*					"ENTRADA"=>Processo de Entrada ex: SCGC210.SCR
	*							(Para entradas so ┌ necessario localizar
	*							registro de SALDO  e bloquear nao
	*							sendo verificados saldos
	*		LShora.........: Perimite verificar o saldo pelo
	*					movimento (ITEMMOV) localizando o  movimento
	*					anterior do item na data e hora informada
	*					so esta sendo utilizado para REQUISICOES
	*					de saida que podem ser lancadas em datas
	*					anteriores e devem considerar o saldo do
	*					momento (OBS: No caso de recuperacao de
	*							NFS e possivel utilizar esta
	*							tecnica , ver futuro)
	*		LSmovEstq.......: "N"= Operacao nao movimentara estoque
	*								so deseja localiza/block REG.SALDO					
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LFretorno......: .F. ou .T.
	*
	* CHAMADAS.....: SCGC2.PRG,OBJ_ITOR.SCR,SCGCF201
	*				 SCGC210.SCR			
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFsaldo
	PRIVATE LFgrupo
	PRIVATE LFempresa
    PRIVATE LNreal_saldo
 	PRIVATE LNbloq_saldo
	PRIVATE LFgrfiscal
	*------------------------------------------------------------*
	LSalias			= ALIAS()
	LFsaldo			= NetArq("saldo")
	LFgrfiscal		= NetArq("grfiscal")
	LFempresa		= NetArq("empresa")
	LFgrupo			= NetArq("grupo")
	*------------------------------------------------------------*
	IF (LFsaldo+LFgrfiscal+LFempresa+LFgrupo) > 100000
		DO ESver_fecha
      	WAIT WINDOW "(ESversaldo)- Falha Abertura de Tabelas.<ENTER>"
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		DO ESver_fecha
      	WAIT WINDOW ;
      		"(ESversaldo)- Registro de Empresa Nao Localizado. <ENTER>"
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	SELECT grupo
	SET ORDER TO TAG codigo
	SEEK LScod
	IF !FOUND()
		DO ESver_fecha
      	WAIT WINDOW ;
      		"(ESversaldo)- Registro de Produto Nao Localizado.<ENTER>"
		RETURN(.f.)
	ENDIF
	IF  grupo.tp_control = 9   && PRODUTO SEM CONTROLE DA ESTOQUE
		DO ESver_fecha
		RETURN(.T.)
	ENDIF

	*------------------------------------------------------------*
	SELECT GRfiscal
	SET ORDER TO TAG tributacao
	SEEK empresa.estado+LEFT(grupo.classifica,5)
	IF !FOUND()
		SET ORDER TO TAG tributacao
		SEEK empresa.estado+LEFT(grupo.classifica,2)
		IF !FOUND()
			DO ESver_fecha
    	  	WAIT WINDOW ;
			"(ESversaldo)- Registro Fiscal de Produto "+ALLTRIM(LScod)+;
					"  Nao Localizado.<ENTER>"
			RETURN(.f.)
		ENDIF
	ENDIF
	IF  grfiscal.tp_mercad =  7
		DO ESver_fecha
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
    SELECT saldo
    SET ORDER TO TAG clas_saldo
    SEEK STR(LNemp,3)+grupo.classifica+;
        STR(YEAR(LDdata),4)+;
        STR(MONTH(LDdata),2)
    IF !FOUND()
		IF !LFAbreAuto OR;
		   !ESAbresaldo((LNemp),(LScod),(grupo.classifica),;
					(LDdata), (LDdata))
	      	WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
    	           " nao foi aberto para movimentacao. Solicite abertura."
			DO ESver_fecha
			RETURN(.f.)
		ENDIF
    ENDIF

    IF LScod   <> saldo.codigo OR ;
   	   grupo.classifica <> saldo.classifica
		    DO OBJ_ALER.SPR WITH ;
	   		"Os dados do Item "+LScod+chr(13)+;
			"Estao irregulares. Reedite a Doc e verifique o Item."
			DO ESver_fecha
			RETURN(.f.)
    ENDIF
	
	*-----------------------------------------------------------------*
	IF LSmovEstq <> "N" AND !ULatendeOper(LSoperacao)
		DO ESver_fecha
      	WAIT WINDOW  "(ESversaldo)- Estoque Insuficiente. <ENTER>"
		RETURN(.f.)
	ENDIF
	*----------------------------------------------------------------*
	IF LFlockreg		&& BLOQUEAR REGISTRO PARA PROCESSO
	   IF !REGLOCK()
	      	WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
                 " nao pode ser bloqueado para efetivar reserva."
			DO ESver_fecha
			RETURN(.f.)
	   ENDIF
	ENDIF
	*------------------------------------------------------------*
	DO ESver_fecha
RETURN(.T.)


PROCEDURE ESver_fecha
	=UP_fecha("saldo"    ,LFsaldo)
	=UP_fecha("grfiscal" ,LFgrfiscal)
	=UP_fecha("empresa"  ,LFempresa)
	=UP_fecha("grupo"    ,LFgrupo)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



FUNCTION ULatendeOper
PARAMETERS LSoperacao
	*-----------------------------------------------------------------*
	*	Esta Rotina Permite Tratar individualmente o saldo de acordo
	*	com a operacao "RESERVA", "SAIDA" ou "ENTRADA"
	*-----------------------------------------------------------------*
	PRIVATE LFretorno
	LFretorno = .T.	
	DO CASE
		CASE LSoperacao = "RESERVA"
		    LNbloq_saldo = saldo.sld_atu - saldo.reserva + LNJaReserv
			IF LNqtde > LNbloq_saldo
				      WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
			        " ESTOQUE (-) RESERVA =>> "+ALLTRIM(STR(LNbloq_saldo,7))
					LFretorno = .F.	
			ENDIF
		
		CASE LSoperacao = "SAIDA"
		    LNreal_saldo = saldo.sld_atu
		    LNbloq_saldo = saldo.sld_atu - saldo.reserva + LNJaReserv

			DO CASE
				CASE LNqtde > LNreal_saldo
			       WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
			          " ESTOQUE =>> "+ALLTRIM(STR(LNreal_saldo,7))
					LFretorno = .F.	

				CASE LNqtde > LNbloq_saldo
				      WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
			        " ESTOQUE (-) RESERVA =>> "+ALLTRIM(STR(LNbloq_saldo,7))
					LFretorno = .F.	
			ENDCASE
		CASE LSoperacao = "ENTRADA"
			LFretorno = .T.	
	ENDCASE
RETURN(LFretorno)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKKW           ESsaldo VALID                      ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:    7   ╨
*       ╨ Variable:            ESsaldo                            ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      146                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkkw     &&  ESsaldo VALID
#REGION 5
RETURN
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar saldo em momento  solicitado
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*						LNemp = 999  faz com que a rotina le-
	*						vante os dados de todas empresas regis-
	*						tradas no arq. empresa
	*		LScod..........: Codigo do Produto
	*		LSclass........: Classificaso do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LNqtde.........: Referencia p/ Retorno
	*		LNcusto........: Referencia p/ Retorno
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*		LNreserva......: Qtde Reservada
	*------------------------------------------------------------*
	*	CHAMADA............: NEsoma_Saldo
	*
	*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNqtde.........: Saldo Total do Estoque na Data
	*		LNcusto........: Valor do Estoque  total
	*		LNreserva......: Parte do Saldo que esta Reservada
	*------------------------------------------------------------*



FUNCTION ESsaldo
	PARAMETERS LNemp,LScod,LSclass,LDdtbase,LNqtde,LNcusto, LShora,;
				LNreserva

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFsaldo,LFitemmov,LFempresa
	PRIVATE TMPcusto

	LNqtde  	= 0
	LNcusto 	= 0
	LNreserva 	= 0

	IF TYPE("LShora") <> "C" or EMPTY(LShora)
		LShora = "99:99:99"			&&  FORCA PESQUISA NO FINAL DO DIA
	ELSE
		LShora = LEFT(LShora,6)+"60" && FORCA PESQUISA NO PROXIMO MINUTO
	ENDIF
	LSalias			= ALIAS()
	LFempresa		= NetArq("empresa")
	LFsaldo			= NetArq("saldo")
	LFitemmov		= NetArq("itemmov")
	IF (LFempresa+LFsaldo+LFitemmov) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("empresa" ,LFempresa)
		=UP_fecha("saldo" ,LFsaldo)
		=UP_fecha("itemmov" ,LFitemmov)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE empresa
	SET ORDER TO TAG empresa
	IF LNemp = 999
		GO TOP
	ELSE
		SEEK LNemp
	ENDIF
	DO WHILE !EOF() AND (LNemp = 999 OR LNemp = empresa.empresa)
		SELECT  itemmov
		SET ORDER TO TAG movimento
		SET NEAR ON
		SEEK STR(empresa.empresa,3)+LScod+dtos(LDdtbase)+LShora
										&& POSICIONA A FRENTE PARA
										&& VOLTAR E PEGAR SALDO DE
										&& FECHAMENTO OU ATUAL DO DIA
		SET NEAR OFF
		IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
			=UP_fecha("empresa" ,LFempresa)
			=UP_fecha("saldo" ,LFsaldo)
			=UP_fecha("itemmov" ,LFitemmov)
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(0)
		ELSE
			SKIP -1
		ENDIF


		IF BOF() OR LScod <> itemmov.codigo ;
			OR empresa.empresa <> itemmov.empresa

		   	SELE saldo
		   	SET ORDER TO TAG emp_mes
	 		SEEK STR(empresa.empresa,3)+STR(YEAR(LDdtbase),4)+;
					STR(MONTH(LDdtbase),2)+LSclass
			IF FOUND()
		   		LNqtde    = LNqtde  + saldo.sld_ante
		   		LNcusto   = LNcusto + saldo.vlr_ante
				LNreserva = LNreserva + saldo.reserva
			ELSE
				SELECT  itemmov
				SKIP				&& avanca p/ pegar dat di 1o lancamento
				IF !BOF() AND LScod = itemmov.codigo AND ;
				  		  empresa.empresa = itemmov.empresa)
				   SELE saldo
				   SEEK STR(empresa.empresa,3)+;
		   	   			STR(YEAR(itemmov.data),4)+;
						STR(MONTH(itemmov.data),2)+LSclass
				   IF FOUND()
		  			    LNqtde    = LNqtde + saldo.sld_ante
					    LNcusto   = LNcusto + saldo.vlr_ante
						LNreserva = LNreserva + saldo.reserva
					ELSE
						&& NAO ENCONTROU NENUMA REFERENCIA ANTERIOR
						&& RECOMPOE A SALDO ANTERIOR ANULANDO OPERACAO
					    TMPcusto = 0
						IF itemmov.sld_estq = 0
						    TMPcusto   = itemmov.vlr_estq
						ELSE						
						    TMPcusto   = itemmov.vlr_estq / itemmov.sld_estq
						ENDIF
						DO CASE
							CASE LEFT(itemmov.operacao,1) = "S"
						    	LNqtde  = LNqtde + itemmov.sld_estq + ;
				    						 itemmov.qtde
								LNreserva = LNreserva + itemmov.sld_rese
							CASE LEFT(itemmov.operacao,1) = "E"
						    	LNqtde  = LNqtde + itemmov.sld_estq - ;
				    						 itemmov.qtde
						ENDCASE	
			    	    LNcusto   = LNcusto + (LNqtde * TMPcusto)
				   ENDIF
				ENDIF
			ENDIF
		ELSE
			IF itemmov.sld_estq > 0	
		    	LNqtde    = LNqtde + itemmov.sld_estq
		    	LNcusto   = LNcusto + itemmov.vlr_estq
				LNreserva = LNreserva + itemmov.sld_rese
			ENDIF
		ENDIF


		IF LNqtde = 0	&& EM ITEMMOV O ULTIMO CUSTO FICA REGISTRADO
						&& QDO O ESTOQUE ZERA PORTANTO DEVE SER ZARADO
						&& POIS A ROTINA DEVE REORNAR O CUSTO ESTOCADO
		    LNcusto   = 0
		ENDIF	
		IF LNemp <> 999		&& PESQUISA SO NA EMPRESA INFORMADA
			EXIT				&& EVITA DESLOCAR REGISTRO DE EMPRESA
								&& QUE ESTA SENDO CONTROLADO EM SCGC800
								&& UPregprevisao
		ENDIF
		SELE EMPRESA
		SKIP
	ENDDO
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("saldo" ,LFsaldo)
	=UP_fecha("itemmov" ,LFitemmov)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNqtde)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKLT           EScustoMedio VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:    8   ╨
*       ╨ Variable:            EScustoMedio                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      147                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gklt     &&  EScustoMedio VALID
#REGION 5
RETURN
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Custo M┌dio do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNcusto........: Custo M┌dio do Produto no Momento
	*						(Custo Total / Saldo )
	*
	*------------------------------------------------------------*
	*	CHAMADA............: NEsoma_Saldo
	*
	*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNcusto........: Custo M┌dio do Produto no Momento
	*						(Custo Total / Saldo )
	*------------------------------------------------------------*

FUNCTION EScustoMedio
	PARAMETERS LNemp,LScod,LDdtbase, LShora, LNcusto

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_saldo    , ALS_saldo
	PRIVATE ARQ_itemmov  , ALS_itemmov
	

	PRIVATE TMPcusto

	LNsaldo  	= 0
	LNcusto 	= 0
	LNreserva 	= 0

	IF TYPE("LShora") <> "C" or EMPTY(LShora)
		LShora = "99:99:99"			&&  FORCA PESQUISA NO FINAL DO DIA
	ELSE
		LShora = LEFT(LShora,6)+"60" && FORCA PESQUISA NO PROXIMO MINUTO
	ENDIF


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_saldo  	= NetArqAgain("SALDO")
    ALS_saldo  	= Alias()

    ARQ_itemmov	= NetArqAgain("ITEMMOV")
    ALS_itemmov	= Alias()


	IF (ARQ_grupo+ARQ_empresa+ARQ_saldo+ARQ_itemmov) > 100000
						 && HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*------------------------

	SELECT  &ALS_itemmov
	SET ORDER TO TAG movimento
	SET NEAR ON
	SEEK STR( &ALS_empresa .empresa,3)+LScod+dtos(LDdtbase)+LShora
									&& POSICIONA A FRENTE PARA
									&& VOLTAR E PEGAR SALDO DE
									&& FECHAMENTO OU ATUAL DO DIA
	SET NEAR OFF
	IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ELSE
		SKIP -1
		DO WHILE !BOF() AND &ALS_itemmov .sld_estq = 0 ;
		                AND LScod = &ALS_itemmov .codigo ;
		                AND &ALS_empresa .empresa = &ALS_itemmov .empresa
			SKIP -1
		ENDDO
	ENDIF
	
	IF BOF() OR LScod <> &ALS_itemmov .codigo ;
			 OR &ALS_empresa .empresa <> &ALS_itemmov .empresa

		SELE &ALS_grupo
		SET ORDER TO TAG codigo

	   	SELE &ALS_saldo
	   	SET ORDER TO TAG emp_mes
 		SEEK STR( &ALS_empresa .empresa,3)+STR(YEAR(LDdtbase),4)+;
					STR(MONTH(LDdtbase),2)+ &ALS_grupo .classifica
		IF FOUND()
	   		LNsaldo    = &ALS_saldo .sld_ante
	   		LNcusto    = &ALS_saldo .vlr_ante
		ELSE
			SELECT  &ALS_itemmov
			SKIP		&& avanca p/ pegar data do 1o lancamento

			IF !BOF() AND LScod = &ALS_itemmov .codigo AND ;
				  		  &ALS_empresa .empresa = &ALS_itemmov .empresa)
			   SELE &ALS_saldo
			   SEEK STR( &ALS_empresa .empresa,3)+;
	   	   			STR(YEAR( &ALS_itemmov .data),4)+;
					STR(MONTH( &ALS_itemmov .data),2)+;
					&ALS_grupo .classifica

			   IF FOUND()
	  			    LNsaldo   = &ALS_saldo .sld_ante
				    LNcusto   = &ALS_saldo .vlr_ante
				ELSE
					&& NAO ENCONTROU NENUMA REFERENCIA ANTERIOR
					&& RECOMPOE A SALDO ANTERIOR ANULANDO OPERACAO

				    TMPcusto = 0
					IF &ALS_itemmov .sld_estq = 0
					    TMPcusto   = &ALS_itemmov .vlr_estq
					ELSE						
					    TMPcusto   = &ALS_itemmov .vlr_estq / ;
					                        &ALS_itemmov .sld_estq
					ENDIF

					DO CASE
						CASE LEFT( &ALS_itemmov .operacao,1) = "S"
					    	LNsaldo  = &ALS_itemmov .sld_estq + ;
					    				 &ALS_itemmov .qtde
						CASE LEFT( &ALS_itemmov .operacao,1) = "E"
					    	LNsaldo  = &ALS_itemmov .sld_estq - ;
					    				&ALS_itemmov .qtde
					ENDCASE	
		    	    LNcusto   = LNcusto + (LNsaldo * TMPcusto)
			   ENDIF
			ENDIF
		ENDIF
	ELSE
    	LNsaldo   = &ALS_itemmov .sld_estq
    	LNcusto   = &ALS_itemmov .vlr_estq
	ENDIF

	*-------------------------------------------------------------*
	
	IF LNsaldo = 0	&& EM ITEMMOV O ULTIMO CUSTO FICA REGISTRADO
					&& QDO O ESTOQUE ZERA PORTANTO DEVE SER ZARADO
					&& POIS A ROTINA DEVE REORNAR O CUSTO ESTOCADO
	    LNcusto   = 0
	ELSE
    	LNcusto   = LNcusto / LNsaldo
	ENDIF	


    =up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
	=up_fecha("&ALS_saldo")
    =up_fecha("&ALS_itemmov")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNcusto)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKM5           EScustoEstq VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:    9   ╨
*       ╨ Variable:            EScustoEstq                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      148                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkm5     &&  EScustoEstq VALID
#REGION 5
RETURN
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Custo M┌dio do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNcusto........: Custo M┌dio do Produto no Momento
	*						(Custo Total / Saldo )
	*
	*------------------------------------------------------------*
	*	CHAMADA............: NEsoma_Saldo
	*
	*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNcusto........: Custo M┌dio do Produto no Momento
	*						(Custo Total / Saldo )
	*------------------------------------------------------------*

FUNCTION EScustoEstq
	PARAMETERS LNemp,LScod,LDdtbase, LShora

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_saldo    , ALS_saldo
	PRIVATE ARQ_itemmov  , ALS_itemmov
	

	PRIVATE TMPcusto,LNcusto

	LNsaldo  	= 0
	LNcusto 	= 0

	IF TYPE("LShora") <> "C" or EMPTY(LShora)
		LShora = "99:99:99"			&&  FORCA PESQUISA NO FINAL DO DIA
	ELSE
		LShora = LEFT(LShora,6)+"60" && FORCA PESQUISA NO PROXIMO MINUTO
	ENDIF


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_saldo  	= NetArqAgain("SALDO")
    ALS_saldo  	= Alias()

    ARQ_itemmov	= NetArqAgain("ITEMMOV")
    ALS_itemmov	= Alias()


	IF (ARQ_grupo+ARQ_empresa+ARQ_saldo+ARQ_itemmov) > 100000
						 && HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*------------------------

	SELECT  &ALS_itemmov
	SET ORDER TO TAG movimento
	SET NEAR ON
	SEEK STR( &ALS_empresa .empresa,3)+LScod+dtos(LDdtbase)+LShora
									&& POSICIONA A FRENTE PARA
									&& VOLTAR E PEGAR SALDO DE
									&& FECHAMENTO OU ATUAL DO DIA
	SET NEAR OFF
	IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ELSE
		SKIP -1
		DO WHILE !BOF() AND &ALS_itemmov .sld_estq = 0 ;
		                AND LScod = &ALS_itemmov .codigo ;
		                AND &ALS_empresa .empresa = &ALS_itemmov .empresa
			SKIP -1
		ENDDO
	ENDIF
	
	IF BOF() OR LScod <> &ALS_itemmov .codigo ;
			 OR &ALS_empresa .empresa <> &ALS_itemmov .empresa

		SELE &ALS_grupo
		SET ORDER TO TAG codigo

	   	SELE &ALS_saldo
	   	SET ORDER TO TAG emp_mes
 		SEEK STR( &ALS_empresa .empresa,3)+STR(YEAR(LDdtbase),4)+;
					STR(MONTH(LDdtbase),2)+ &ALS_grupo .classifica
		IF FOUND()
	   		LNsaldo    = &ALS_saldo .sld_ante
	   		LNcusto    = &ALS_saldo .vlr_ante
		ELSE
			SELECT  &ALS_itemmov
			SKIP		&& avanca p/ pegar data do 1o lancamento

			IF !BOF() AND LScod = &ALS_itemmov .codigo AND ;
				  		  &ALS_empresa .empresa = &ALS_itemmov .empresa)
			   SELE &ALS_saldo
			   SEEK STR( &ALS_empresa .empresa,3)+;
	   	   			STR(YEAR( &ALS_itemmov .data),4)+;
					STR(MONTH( &ALS_itemmov .data),2)+;
					&ALS_grupo .classifica

			   IF FOUND()
	  			    LNsaldo   = &ALS_saldo .sld_ante
				    LNcusto   = &ALS_saldo .vlr_ante
				ELSE
					&& NAO ENCONTROU NENUMA REFERENCIA ANTERIOR
					&& RECOMPOE A SALDO ANTERIOR ANULANDO OPERACAO

				    TMPcusto = 0
					IF &ALS_itemmov .sld_estq = 0
					    TMPcusto   = &ALS_itemmov .vlr_estq
					ELSE						
					    TMPcusto   = &ALS_itemmov .vlr_estq / ;
					                        &ALS_itemmov .sld_estq
					ENDIF

					DO CASE
						CASE LEFT( &ALS_itemmov .operacao,1) = "S"
					    	LNsaldo  = &ALS_itemmov .sld_estq + ;
					    				 &ALS_itemmov .qtde
						CASE LEFT( &ALS_itemmov .operacao,1) = "E"
					    	LNsaldo  = &ALS_itemmov .sld_estq - ;
					    				&ALS_itemmov .qtde
					ENDCASE	
		    	    LNcusto   = LNcusto + (LNsaldo * TMPcusto)
			   ENDIF
			ENDIF
		ENDIF
	ELSE
    	LNsaldo   = &ALS_itemmov .sld_estq
    	LNcusto   = &ALS_itemmov .vlr_estq
	ENDIF

	*-------------------------------------------------------------*
	
	IF LNsaldo = 0	&& EM ITEMMOV O ULTIMO CUSTO FICA REGISTRADO
					&& QDO O ESTOQUE ZERA PORTANTO DEVE SER ZARADO
					&& POIS A ROTINA DEVE REORNAR O CUSTO ESTOCADO
	    LNcusto   = 0
	ENDIF	


    =up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
	=up_fecha("&ALS_saldo")
    =up_fecha("&ALS_itemmov")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNcusto)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKMF           EScustoAgregado VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   10   ╨
*       ╨ Variable:            EScustoAgregado                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      149                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkmf     &&  EScustoAgregado VALID
#REGION 5
RETURN

FUNCTION EScustoAgregado
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Informar Custo M┌dio do Produto Recomposto
	*             da Tributa┤фo que implicara no custo desembolso
	*			  CUSTO + ICMS + RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNvlrdesembolso.: Custo M┌dio do Produto no Momento
	*                       Agregado de Tributos => Custo desembolso
	*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNvlrdesembolso.: Custo M┌dio do Produto no Momento
	*                       Agregado de Tributos => Custo desembolso
	*------------------------------------------------------------*
	PARAMETERS LNemp,LScod,LDdtbase, LShora, LNvlrdesembolso

	=W_DEFPROC("rotinas.spr")

	PRIVATE LNcusto
	PRIVATE LNvlrdesembolso

	*--------------------------------------------------------------------*
	* 	Calculo do Custo M┌dio Agregando Tributos + Valore Que o Tornam
	* a Representa┤фo do Valor Desembolsado
	*			LNCUSTO + LNicms + LNretido
	*--------------------------------------------------------------------*
	LNcusto = 0

	LNcusto	= EScustoMedio(LNemp,LScod,LDdtbase, LShora, LNcusto)

	*--------------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*

	*** LNvlrdesembolso =  ESAgregarTrbt(LNemp,LScod, LNCusto)

	LNvlrdesembolso =  LNcusto



RETURN(LNvlrdesembolso)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKMG           ESAgregarTrbt VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   11   ╨
*       ╨ Variable:            ESAgregarTrbt                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      150                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkmg     &&  ESAgregarTrbt VALID
#REGION 5
RETURN

FUNCTION ESAgregarTrbt
	PARAMETERS LNemp,LScod, LNCusto

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Recompor ao valor informado a
	*             Tributa┤фo que implicara no custo desembolso
	*			  CUSTO + ICMS + RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNvlrdesembolso.: Custo M┌dio do Produto no Momento
	*                       Agregado de Tributos => Custo desembolso
	*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNvlrdesembolso.: Custo Informad do Produto
	*                       Agregado de Tributos => Custo desembolso
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal

	PRIVATE LNipi, LNicms

	PRIVATE LNbaseicms,LNicms,LNretido
	PRIVATE LNvlrdesembolso
	PRIVATE LNaliq_icms


	LNipi		=	0	
	LNicms		=	0



	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_grfiscal+ARQ_grfiscal) > 100000 ;
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	
	SELE &ALS_grupo
	SET ORDER TO TAG codigo

	SEEK LScod
	if not found()
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	endif

	SELE &ALS_grfiscal
	SET ORDER TO TAG tributacao
	SEEK &ALS_empresa .estado+LEFT( &ALS_grupo .classifica,5)

	LNaliq_icms		= 	7	&& % ver possibilidade de pasar em parametro
							&& A aliq_icms esta fixa em 7% porque
							&& os fornecedores sao de Sao Paulo
							&& mas deve ser feito um modelo que
							&& atenda a essa necessidade
							
	LNvlrdesembolso	=	LNcusto
	LNaliq_ipi		=	&ALS_grupo .aliq_ipi

	LNiva			=	&ALS_grfiscal .iva
	LNtpmercad		=	&ALS_grfiscal .tp_mercad

	*************************************************************


	LNbaseicms = (LNcusto*100) / (100+LNaliq_ipi-LNaliq_icms)

	LNicms	   = (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	LNipi	   = (LNbaseicms * LNaliq_ipi)/100

	LNretido   = 0


	IF LNtpmercad = 2 AND LNiva > 0
		LNretido   = (LNbaseicms + LNipi) * LNiva * 0.17 - LNicms
	ENDIF

	LNvlrdesembolso  = LNcusto + LNicms + LNretido


	*----------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNvlrdesembolso)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKMH           ESprc_compra VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   12   ╨
*       ╨ Variable:            ESprc_compra                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      151                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkmh     &&  ESprc_compra VALID
#REGION 5
RETURN

**********************************************************************
*	Rotina para calculo do preco de compra e venda
*	chamado por SCGC807 SCGC800A E SCGC240A
**********************************************************************
* PARAMETROS
*
*	LNqtde		: Quantidade solicitada
*	LNtab		: Preco de tabela
*	LNdesc		: Desconto total (Normal ou Com Vendor ja aplicado)
*	LNalqipi	: Aliquota de IPI
*   LNalqfrt	: Taxa de Frete
*	LNicmralq	: Aliquota do retido
*	LNiva		: IVA ou MARCKUP
*	LNicmcalq	: Aliquota do ICM de Credito
*
* VARIAVEIS LOCAIS
*	LNliq		: Preco de Tabela Aplicado o Desconto
*	LNipi		: Valor do IPI sobre preco liquido
*	LNcti		: Custo inicial
*	LNfret		: Valor do frete
*	LNadic		: Adicional
*	LNicmc		: Valor ICM de Credito
*	LNicmr		: Valor ICM Retido
*	LNcto		: Custo Total
*	LNpis		: Aliquota do PIS
*	LNcofins	: Aliquota de Cofins
*	LNpcomra 	: Preco de Compra
*	LNpvd		: Preco de Venda
*
*******************************************************************

PROCEDURE ESprc_compra
	PARAMETERS LNqtde,LNtab,LNdesc,LNalqipi,LNalqfrt,LNicmralq,;
			   LNiva, LNicmcalq, LNvendor,LNliq,LNipi,;
			   LNcti,LNfret,LNadic,;
			   LNicmc, LNicmr, LNcto,;
			   LNpis,LNcofins,LNmargem;
			   LNpcompra,LNpvd

	PRIVATE ALL

	STORE 0 TO   LNliq,LNipi,LNcti,LNfret,LNadic,LNicmc,LNicmr,LNcto

	LNliq 		= ((LNtab * (1 - LNdesc/100)) * LNqtde ) * LNvendor
	LNipi 		= LNliq * (LNalqipi /100)
	LNcti 		= (LNliq + LNipi)
	LNfret		= LNcti * (LNalqfrt / 100)

	LNadic		= (LNicmralq /100) * ;
					LNcti * (1+(LNiva /100))

	LNicmc		= LNliq * (LNicmcalq / 100)

	LNicmr		= LNadic - LNicmc
	LNcto 		= (LNcti + LNadic + LNfret) - LNicmc
	LNpcompra 	= LNliq
	LNpvd	 	= LNcto / (1- (LNpis/100 + LNcofins/100 + LNmargem/100 ))

RETURN




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKMI           EScrtcestq VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   13   ╨
*       ╨ Variable:            EScrtcestq                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      152                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkmi     &&  EScrtcestq VALID
#REGION 5
RETURN

**********************************************************************
*******************************************************************

PROCEDURE EScrtcestq
	PARAMETERS PrmDiasAcima
	
	=W_DEFPROC("rotinas.spr")
    PRIVATE LNpeso

	PRIVATE LSalias
	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_prvitstq , ALS_prvitstq

	LSalias			= ALIAS()


    ARQ_empresa  	= NetArqAgain("EMPRESA")
    ALS_empresa  	= Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_prvitstq  	= NetArqAgain("prvitstq")
    ALS_prvitstq  	= Alias()



	SELECT  IT.regional,IT.filial,lj.sigla,IT.codigo,;
		GR.descricao, 	IT.saldo,;
        IT.RVgiromedi AS giromedio, ;
        INT(IIF(IT.RVgiromedi > 0,IT.saldo /IT.RVgiromedi, ;
        			 IIF(IT.saldo>0,9999.00,0.00)))	 as duracao,;
        INT((IT.RVgiromedio*30)) as consumo, ;
        INT(((IT.RVgiromedio*30) - IT.saldo)) as ajuste ;
   	FROM &ALS_empresa LJ,;
   		 &ALS_grupo GR,;
         c:\tmp\prvitstq IT;
   	WHERE       	LJ.empresa = IT.regional ;
   		 and  	GR.codigo  = IT.CODIGO ;
         and 	((IT.saldo > 0 and IT.RVgiromedio = 0) ;
    	 or 	(IT.RVgiromedio > 0));
         and 	IT.filial = 999;
   	ORDER BY  filial, duracao ;
   	into cursor tmp1
   	
	SELECT * FROM tmp1 ;
        WHERE  duracao > PrmDiasAcima  ;
             AND not EMPTY(descricao) ;
	   	ORDER BY  regional,duracao

	REPORT FORM RES1110 TO FILE l:\TMP\PRT0001A.REL

   	=up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
   	=up_fecha("&ALS_prvitstq")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKNB           EScrtcestq VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   14   ╨
*       ╨ Variable:            EScrtcestq                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      153                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gknb     &&  EScrtcestq VALID
#REGION 5
RETURN

**********************************************************************
*******************************************************************

PROCEDURE EScrtcestq
	PARAMETERS PrmDiasAcima
	
	=W_DEFPROC("rotinas.spr")
    PRIVATE LNpeso

	PRIVATE LSalias
	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_prvitstq , ALS_prvitstq

	LSalias			= ALIAS()


    ARQ_empresa  	= NetArqAgain("EMPRESA")
    ALS_empresa  	= Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_prvitstq  	= NetArqAgain("prvitstq")
    ALS_prvitstq  	= Alias()



	SELECT  GR.codigo, GR.descricao,;
	 	IT.saldo,;
        IT.RVgiromedi AS giromedio, ;
        INT(IIF(IT.RVgiromedi > 0,IT.saldo /IT.RVgiromedi, ;
        			 IIF(IT.saldo>0,9999.00,0.00)))	 as duracao,;
        INT((IT.RVgiromedio*30)) as consumo, ;
        INT(((IT.RVgiromedio*30) - IT.saldo)) as ajuste ;
   	FROM &ALS_empresa LJ,;
   		 &ALS_grupo GR,;
         c:\tmp\prvitstq IT;
   	WHERE       	LJ.empresa = IT.regional ;
   		 and  	GR.codigo  = IT.CODIGO ;
         and 	((IT.saldo > 0 and IT.RVgiromedio = 0) ;
    	 or 	(IT.RVgiromedio > 0));
         and 	IT.filial = 999;
   	ORDER BY  filial, duracao ;
   	into cursor tmp1
   	
	SELECT * FROM tmp1 ;
        WHERE  duracao > PrmDiasAcima  ;
             AND not EMPTY(descricao) ;
	   	ORDER BY  regional,duracao

	REPORT FORM RES1110 TO FILE l:\TMP\PRT0001A.REL

   	=up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
   	=up_fecha("&ALS_prvitstq")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKNI           ESextrato VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   15   ╨
*       ╨ Variable:            ESextrato                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      154                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkni     &&  ESextrato VALID
#REGION 5
RETURN

FUNCTION ESextrato
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	store "" to ARQ_tmp,ALS_tmp



	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*


	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF


	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	ALS_tmp = ALIAS()


	SELECT  data, ;
			left(hora,5) AS HORA,;
			LEFT(IIF(nota <> 0,"NF"+STR(nota,7),;
			    LEFT(TIPO,2)+STR(orcamento,6))+SPACE(10),10) as doc,;
			operacao, ;
			tipo,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			sld_estq  AS SALDO, ;
			sld_rese  AS SALDORES,;
			IIF(sld_estq > 0,vlr_estq / sld_estq,0000.00) AS cst_medio,;
			ULgetvlrUni(OPERACAO,EMPRESA,FAVORECIDO,;
			    ORCAMENTO,ORDEM,vlrvenda,QTDE) as VALOR_UNI, ;
			(icms_subs/qtde) AS ICMS_SUBS, ;
			(custo_ind/qtde) AS CUSTO_IND,;
			ESOrigDest(favorecido) AS ORIGEM,;
			IIF(negociacao = 2,"S"," ") AS vdcasada,;
			LEFT(RTRIM(DESCRICAO)+"-"+RTRIM(DESCRCOMPL)+"-"+INFO_COMPL,100) AS descricao;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)


	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			DOC			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			SALDO    	:H="SALDO"	:P="@r ####9" :R,;
			SALDORES 	:H="RES"	:P="@r ####9" :R, ;
			CST_MEDIO	:H="CST.M"	:P="@r ####9.99" :R, ;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			icms_subs	:H="R$.Sbst"	:P="@r ####9.99" :R, ;
			custo_ind	:H="Cust.Ind"	:P="@r ####9.99" :R, ;
			ORIGEM		:H="O/D"    :P="AAA" :R, ;
			vdcasada    :H="ENCOMENDA" :R,;
			descricao   :H="DESCRICAO";
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
    =up_fecha("TMPEXT")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF
	
RETURN


FUNCTION ULgetvlrUni
PARAMETERS PrmOperacao, PrmEmp, PrmFavorecido, ;
              PrmBoletim, PrmOrdem,PrmVlrVenda,PrmQtde

	PRIVATE LNVALOR_UNI

	LNVALOR_UNI = 00000000
	if LEFT(PrmOperacao,1) = "E"
		=W_DEFPROC("notaite.spr")
		LNVALOR_UNI=;
		  IEGetCusto(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem) / PrmQtde
	ELSE
		LNVALOR_UNI= PrmVlrVenda / PrmQtde
	ENDIF

RETURN(LNVALOR_UNI)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKNS           ESimpext VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   16   ╨
*       ╨ Variable:            ESimpext                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      155                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkns     &&  ESimpext VALID
#REGION 5
RETURN


PROCEDURE ESimpext
PARAMETERS PrmRel
	DO UPPreImpressao WITH  PrmRel, .F. , .F., .F.
	CLEAR TYPEAHEAD
RETURN



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKNY           ESextRess VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   17   ╨
*       ╨ Variable:            ESextRess                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      156                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkny     &&  ESextRess VALID
#REGION 5
RETURN

FUNCTION ESextRess
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	store "" to ARQ_tmp,ALS_tmp


	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*


	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF


	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
        FOR  LEFT(OPERACAO,1) $ "E/S" ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo ;
		      AND DATA   <= PrmDtFim
		
	SELE 0
	USE &ARQ_tmp
	ALS_tmp = ALIAS()

	SELECT  data, ;
			dtfat AS dataemi,;
			operacao,;
			tipo,;
			IIF(nota <> 0,"NF"+STR(nota,7),LEFT(TIPO,2)+STR(orcamento,6)) as doc,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			IIF(qtde > 0,vlrvenda / Qtde,vlrvenda)   AS VALOR_UNI, ;
			(vlripi * 100 / vlrvenda) AS Aliqipi,;
			iva,;
			ESOrigDest(favorecido) AS ORIGEM;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)

	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407A"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ EXTRATO APOIO AO RESSARCIMENTO MANUAL ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
		BROWSE  FIELDS ;
				DATA		:H="DT.ENT" :R,;
				DATAEMI		:H="DT.EMI" :R,;
				QTDE     	:H="QTDE"	:P="@r ####9" :R,;
				DOC			:H="DOC" :R,;
				VALOR_UNI	:H="R$.UNI"	:P="@r #,##9.99" :R, ;
				ALIQIPI    	:H="IPI"	:P="@r ##" :R,;
				IVA     	:H="IVA"	:P="@r 9.99" :R,;
				TIPO     	:H="TIPO"	  :R,;
				OPERACAO   	:H="OPERACAO"  :R;
				TITLE "[ EXTRATO P/ RESSARCIMENTO ]";
				COLOR SCHEME 10 ;
				  NODELETE NOAPPEND NORMAL  NOEDIT;
			    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	
	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF

RETURN



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKNZ           ESOrigDest VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   18   ╨
*       ╨ Variable:            ESOrigDest                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      157                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gknz     &&  ESOrigDest VALID
#REGION 5
RETURN

FUNCTION ESOrigDest
PARAMETERS PrmCGC
	PRIVATE LSalias,LSsigla
	LSalias = Alias()
	IF EMPTY(PrmCGC)
		RETURN("   ")
	ENDIF

	SELECT &ALS_empresa
	SET ORDER TO TAG CGC
	SEEK PrmCGC
	IF FOUND()
		LSsigla = &ALS_empresa .sigla
	else
		LSsigla = "   "
	ENDIF	
	SELE &LSalias
RETURN(LSsigla)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKO0           ESextEntradas VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   19   ╨
*       ╨ Variable:            ESextEntradas                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      158                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gko0     &&  ESextEntradas VALID
#REGION 5
RETURN

FUNCTION ESextEntradas
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	PRIVATE LNsaldo
	
	store "" to ARQ_tmp,ALS_tmp
	LNsaldo = 0


	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*


	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF


	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		FOR     LEFT(operacao,1) = "E" ;
		    AND CH_OPERA = "1" ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	go top
	ALS_tmp = ALIAS()
	LNsaldo = 0
	LNctr   = 0

	SELECT  data, ;
			left(hora,5) AS HORA,;
			IIF(nota <> 0,"NF"+STR(nota,7),LEFT(TIPO,2)+STR(orcamento,6)) as doc,;
			operacao, ;
			tipo,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			ULESextrEnt(qtde,movestq,operacao) AS SALDO, ;
			sld_rese  AS SALDORES,;
			IIF(sld_estq > 0,vlr_estq / sld_estq,0) AS cst_medio,;
			IIF(qtde > 0,vlrvenda / Qtde,vlrvenda) as VALOR_UNI, ;
			ESOrigDest(favorecido) AS ORIGEM,;
			IIF(negociacao = 2,"S"," ") AS vdcasada;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			DOC			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			SALDO    	:H="SALDO"	:P="@r ####9" :R,;
			SALDORES 	:H="RES"	:P="@r ####9" :R, ;
			CST_MEDIO	:H="CST.M"	:P="@r ###9.99" :R, ;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			ORIGEM		:H="O/D"    :P="AAA" :R, ;
			vdcasada    :H="ENCOMENDA" :R;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	
	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF

RETURN


FUNCTION ULESextrEnt
PARAMETERS PrmQtde,PrmMovestq,PrmOperacao
	PRIVATE LnRetorno
	IF LNctr   = 0
		LNctr = 1
		RETURN(000000)
	ENDIF

	DO CASE
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "E"
			 LNsaldo = LNsaldo + PrmQtde
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "S"
			 LNsaldo = LNsaldo - PrmQtde
	ENDCASE	
	LnRetorno	 = LNsaldo
RETURN(LnRetorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKOO           ESextTrasf VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   20   ╨
*       ╨ Variable:            ESextTrasf                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      159                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkoo     &&  ESextTrasf VALID
#REGION 5
RETURN

FUNCTION ESextTrasf
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	PRIVATE LNsaldo
	
	store "" to ARQ_tmp,ALS_tmp
	LNsaldo = 0


	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*

	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF

	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		FOR     LEFT(operacao,1) = "E" ;
		    AND CH_OPERA = "2" ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	go top
	ALS_tmp = ALIAS()
	LNsaldo = 0
	LNctr   = 0

	SELECT  data, ;
			left(hora,5) AS HORA,;
			IIF(nota <> 0,"NF"+STR(nota,7),LEFT(TIPO,2)+STR(orcamento,6)) as doc,;
			operacao, ;
			tipo,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			ULESextrEnt(qtde,movestq,operacao) AS SALDO, ;
			sld_rese  AS SALDORES,;
			IIF(sld_estq > 0,vlr_estq / sld_estq,0) AS cst_medio,;
			IIF(qtde > 0,vlrvenda / Qtde,vlrvenda) as VALOR_UNI, ;
			ESOrigDest(favorecido) AS ORIGEM,;
			IIF(negociacao = 2,"S"," ") AS vdcasada;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			DOC			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			SALDO    	:H="SALDO"	:P="@r ####9" :R,;
			SALDORES 	:H="RES"	:P="@r ####9" :R, ;
			CST_MEDIO	:H="CST.M"	:P="@r ###9.99" :R, ;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			ORIGEM		:H="O/D"    :P="AAA" :R, ;
			vdcasada    :H="ENCOMENDA" :R;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF
	
RETURN


FUNCTION ULESextrEnt
PARAMETERS PrmQtde,PrmMovestq,PrmOperacao
	PRIVATE LnRetorno
	IF LNctr   = 0
		LNctr = 1
		RETURN(000000)
	ENDIF

	DO CASE
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "E"
			 LNsaldo = LNsaldo + PrmQtde
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "S"
			 LNsaldo = LNsaldo - PrmQtde
	ENDCASE	
	LnRetorno	 = LNsaldo
RETURN(LnRetorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKOZ           ESVld_Produto VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   21   ╨
*       ╨ Variable:            ESVld_Produto                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      160                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkoz     &&  ESVld_Produto VALID
#REGION 5
RETURN
PROCEDURE ESVld_Produto
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Pesquisar Produtos em uma Lista
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: GRUPO
	*------------------------------------------------------------*
	* PARAMETROS..:
	*             LScodigo : Codigo do Produto - Pode Ser Utiliza
	*                  para posicionamento parcial
	*------------------------------------------------------------*
	* CHAMADAS.............:
	*------------------------------------------------------------*
	PARAMETERS LScodigo

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_grupo, ALS_grupo
  	PRIVATE LFretorno

    LSalias      = Alias()
    ARQ_grupo    = NetArqAgain("GRUPO")
    ALS_grupo    = Alias()

	SELE &ALS_grupo
	SET ORDER TO TAG codigo
	SEEK ALLTRIM(LScodigo)
	IF !FOUND()
	   LFretorno= .f.
	ELSE
	   LFretorno= .T.
	ENDIF

	=UP_fecha(ALS_GRUPO)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKP5           ESGet_Origem VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         ESTOQUE,     Record Number:   22   ╨
*       ╨ Variable:            ESGet_Origem                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      161                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkp5     &&  ESGet_Origem VALID
#REGION 5
RETURN
FUNCTION ESGet_Origem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	PARAMETERS LScodigo,PrmOrigem

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_grupo, ALS_grupo
  	PRIVATE LFretorno

    LSalias      = Alias()
    ARQ_grupo    = NetArqAgain("GRUPO")
    ALS_grupo    = Alias()

	SELE &ALS_grupo
	SET ORDER TO TAG codigo
	SEEK ALLTRIM(LScodigo)
	IF FOUND()
	   PrmOrigem= 	&Als_Grupo .origem
	   LFretorno= 	.t.
	ELSE
	   PrmOrigem= 	0
	   LFretorno= .f.
	ENDIF

	=UP_fecha(ALS_GRUPO)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKPC           MVAtu_Cmd VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:    2  ╨
*       ╨ Variable:            MVAtu_Cmd                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      162                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkpc     &&  MVAtu_Cmd VALID
#REGION 6
RETURN

******---------------------------------
* APOS A GRAVACAO DO NOVO REGISTRO DE ITEMMOV GERADO POR ENTRADAS,
*	 ESTA ROTINA E ATIVADA  //  ou // PARA CORRECAO DO ESTOQUE
*
*   - VOLTA UM REGISTRO
*	- CAPTURA CUSTO MEDIO ANTERIOR
*	- LOOP NO MOVIMENTO DO PRODUTO
*		-AVANCA UM REGISTRO
*		-RECALCULA CUSTO MEDIO
*
*	- FIM LOOP
*   - ATULIZA VALORES NO CONTROLE DA SALDOS DOS MESES AFETADOS
****************************************
PROCEDURE MVatu_cmd		&& ATUALIZA CUSTO MEDIO COM BASE NO ITEMMOV
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata,;
			PRMhora,;
			PRMtipo,;
			PRMnota,;
			PRMordem

*	IF PRMcodigo = "13010719"
*		set step on
*	endif

    = W_DEFPROC("rotinas.spr")

	SELE Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)


	*------------------------------------------------------------------*
	*   Inicio Efetivo da Rotina Apos o Posicionamento
	*------------------------------------------------------------------*

	PRIVATE sld_ante, vlr_ante, res_ante
	PRIVATE sld_atu, vlr_atu, dt_entrada, dt_saida

	PRIVATE	LNredutor   &&    Indice de reducao de icms em entrada
						&& Transf Internas
	PRIVATE	LSoperacao  &&    Indica a operacao "*" ou "/" que envolvera
						&& o LNredudor

    && Valores Basicos  Saldo

	PRIVATE LNvlratu	&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNsldatu	&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNcstmedio  && CUSTO MEDIO DO PRODUTO
	PRIVATE LNreserva   && saldo em reserva


    && Valores de Detalhementos de Saldo
	PRIVATE m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	

	store 0 to  sld_ante, vlr_ante, res_ante, sld_atu, vlr_atu
	store {} to dt_entrada, dt_saida

			
	store 0 to m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	



	LNvlratu	= 0		&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	LNsldatu	= 0		&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	LNcstmedio  = 0     && CUSTO MEDIO DO PRODUTO
	LNreserva   = 0     && saldo em reserva


    =MVBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)


    =MVObterSaldos( m.sld_ante, m.vlr_ante, m.res_ante,;
                  m.dt_entrada, m.dt_saida,;
    			  LNsldatu, LNvlratu, LNreserva,;
    	          m.qtd_compra, m.vlr_compra, ;
   	              m.qtd_venda , m.vlr_venda , ;
   	              m.qtd_e_tran, m.vlr_e_tran, ;
   	              m.qtd_e_outr, m.vlr_e_outr, ;
   	              m.qtd_s_tran, m.vlr_s_tran, ;
		          m.qtd_s_outr, m.vlr_s_outr, ;
				  m.ven_tab, m.ven_contab, m.ven_enc, ;
	 			  m.reserva)


	************************************************************
	=MVprocessaMvto(PRMempresa,;
					PRMcodigo,;
					PRMclasse,;
					PRMdata,;
					PRMhora,;
					PRMtipo,;
					PRMnota,;
					PRMordem)


	***************************
	****************	ATUALIZANDA SALDOS ABERTOS EM MESES FUTUROS
	****************
    =MVDesBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)
	
	SELE ITEMMOV
	SET ORDER TO TAG movimento
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKPM           MVCancelMvto VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:    3  ╨
*       ╨ Variable:            MVCancelMvto                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      163                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkpm     &&  MVCancelMvto VALID
#REGION 6
RETURN

******---------------------------------
****************************************
PROCEDURE MVCancelMvto
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata,;
			PRMhora,;
			PRMtipo,;
			PRMnota,;
			PRMordem

    = W_DEFPROC("rotinas.spr")

	SELE Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)




	PRIVATE sld_ante, vlr_ante, res_ante
	PRIVATE sld_atu, vlr_atu, dt_entrada, dt_saida

	PRIVATE	LNredutor   &&    Indice de reducao de icms em entrada
						&& Transf Internas
	PRIVATE	LSoperacao  &&    Indica a operacao "*" ou "/" que envolvera
						&& o LNredudor

    && Valores Basicos  Saldo

	PRIVATE LNvlratu	&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNsldatu	&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNcstmedio  && CUSTO MEDIO DO PRODUTO
	PRIVATE LNreserva   && saldo em reserva


    && Valores de Detalhementos de Saldo
	PRIVATE m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	

	store 0 to  sld_ante, vlr_ante, res_ante, sld_atu, vlr_atu
	store {} to dt_entrada, dt_saida

			
	store 0 to m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	



	LNvlratu	= 0		&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	LNsldatu	= 0		&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	LNcstmedio  = 0     && CUSTO MEDIO DO PRODUTO
	LNreserva   = 0     && saldo em reserva

    =MVBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)

    =MVObterSaldos( m.sld_ante, m.vlr_ante, m.res_ante,;
	              m.dt_entrada, m.dt_saida,;
    			  LNsldatu, LNvlratu, LNreserva,;
    	          m.qtd_compra, m.vlr_compra, ;
   	              m.qtd_venda , m.vlr_venda , ;
   	              m.qtd_e_tran, m.vlr_e_tran, ;
   	              m.qtd_e_outr, m.vlr_e_outr, ;
   	              m.qtd_s_tran, m.vlr_s_tran, ;
		          m.qtd_s_outr, m.vlr_s_outr, ;
				  m.ven_tab, m.ven_contab, m.ven_enc, ;
	 			  m.reserva)
	************************************************************

	*----------------------------------------------------------------*
	*    Efetiva Cancelamento do Registro de Movimento
	*----------------------------------------------------------------*
	
    SELE itemmov
    =edithand('APAGA')

	SELE itmanexo
	SET ORDER TO TAG movanexo
	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)
	IF FOUND()
		=REGLOCK(.T.)
		=edithand('APAGA')
		UNLOCK
	ENDIF

    SELE itemmov
	*----------------------------------------------------------------*


	=MVprocessaMvto(PRMempresa,;
					PRMcodigo,;
					PRMclasse,;
					PRMdata,;
					PRMhora,;
					PRMtipo,;
					PRMnota,;
					PRMordem)

	***************************
	****************	ATUALIZANDA SALDOS ABERTOS EM MESES FUTUROS
	****************
    =MVDesBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)
	
	SELE ITEMMOV
	SET ORDER TO TAG movimento
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKPN           MVBlqSaldo VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:    4  ╨
*       ╨ Variable:            MVBlqSaldo                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      164                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkpn     &&  MVBlqSaldo VALID
#REGION 6
RETURN

******---------------------------------

FUNCTION MVBlqSaldo		&& Bloquear Reg de Saldo
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata

 	SELE saldo	

	************ POSICIONA SALDO CASO NAO TENHA SIDO FEITO ANTES ******
    SET ORDER TO TAG clas_saldo
    SEEK STR(PRMempresa,3)+PRMclasse+;
         STR(YEAR(PRMdata),4)+;
         STR(MONTH(PRMdata),2)

    IF !FOUND()

        =MVIniRegSaldos(PRMempresa,;
        			    PRMdata, ;
        			 	PRMcodigo,;
        			 	m.sld_atu,;
        			 	m.vlr_atu,;
        			 	m.reserva)

 		SELE SALDO
	    SET ORDER TO TAG clas_saldo
        SEEK STR(PRMempresa,3)+PRMclasse+;
    		 STR(YEAR(PRMdata),4)+;
             STR(MONTH(PRMdata),2)
   		IF !FOUND()
			=uperrosys()
			 WAIT WINDOW "ERRO. REG.SALDO NAO LOCALIZADO. <ENTER>..."
			 CLOSE ALL
			 QUIT
		ENDIF
	ENDIF
	*************************************************************

RETURN(reglock(.T.)) 	&& CONFIRMA O BLOQUEIO DO SALDO


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKPO           MVDesBlqSaldo VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:    5  ╨
*       ╨ Variable:            MVDesBlqSaldo                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      165                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkpo     &&  MVDesBlqSaldo VALID
#REGION 6
RETURN

******---------------------------------

FUNCTION MVDesBlqSaldo		&& Bloquear Reg de Saldo
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata

 	SELE saldo	

	************ POSICIONA SALDO CASO NAO TENHA SIDO FEITO ANTES ******
    SET ORDER TO TAG clas_saldo
    SEEK STR(PRMempresa,3)+PRMclasse+;
         STR(YEAR(PRMdata),4)+;
         STR(MONTH(PRMdata),2)

    IF FOUND()
	   UNLOCK
	ENDIF

RETURN(reglock(.T.)) 	&& CONFIRMA O BLOQUEIO DO SALDO


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKQ9           MVObterSaldos VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:    6  ╨
*       ╨ Variable:            MVObterSaldos                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      166                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkq9     &&  MVObterSaldos VALID
#REGION 6
RETURN

******---------------------------------

PROCEDURE MVObterSaldos

********************   INICIO DA BUSCA DE SALDOS  **********************
PARAMETERS        m.sld_ante, m.vlr_ante, m.res_ante,;
                  m.dt_entrada, m.dt_saida,;
				  LNsldatu, LNvlratu, LNreserva,;
    	          qtd_compra, vlr_compra, ;
   	              qtd_venda , vlr_venda , ;
   	              qtd_e_tran, vlr_e_tran, ;
   	              qtd_e_outr, vlr_e_outr, ;
   	              qtd_s_tran, vlr_s_tran, ;
		          qtd_s_outr, vlr_s_outr, ;
				  ven_tab, ven_contab, ven_enc, ;
	 			  reserva

    ARQ_Itemmov  = NetArqAgain("ITEMMOV")
    ALS_Itemmov  = Alias()


    ARQ_ItmAnexo  = NetArqAgain("ITMANEXO")
    ALS_ItmAnexo  = Alias()

    ARQ_Saldo    = NetArqAgain("SALDO")
    ALS_Saldo   = Alias()


	* Captar Saldo Inicial do Mes

    SELE &ALS_Saldo
  	SET ORDER TO TAG clas_saldo
    SEEK STR(itemmov.empresa,3)+itemmov.classifica+;
    	    STR(YEAR(itemmov.data),4)+;
            STR(MONTH(itemmov.data),2)
	IF FOUND()
		m.sld_ante 	= &ALS_Saldo .sld_ante
	   	m.vlr_ante 	= &ALS_Saldo .vlr_ante
	   	m.res_ante 	= &ALS_Saldo .res_ante
		m.dt_entrada= &ALS_Saldo .dt_entrada
		m.dt_saida	= &ALS_Saldo .dt_saida

	ELSE
		m.sld_ante = 0	
	   	m.vlr_ante = 0
	   	m.res_ante 	= 0
		m.dt_entrada= {}
		m.dt_saida	= {}
	ENDIF




	SELE &ALS_Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SET NEAR ON

	SEEK STR(itemmov.EMPRESA,3) + itemmov.CODIGO   +;
		 DTOS(itemmov.DATA)     + itemmov.HORA     +;
		 itemmov.TIPO           + STR(itemmov.NOTA,7)      +;
		 STR(itemmov.ORDEM,3)

	SET NEAR OFF


	IF !(BOF() AND EOF())       && ITEMMOV ESTA VAZIO
		SKIP -1
		********************************************************
		* INICIO : ESTE BLOCO DE COMANDO FOI COLOCADO PARA EVITAR
		*          QUE QUANDO UMA RESERVA ESTIVER SENDO CANCELADA
		*          E OUTRO USUARIO INICIAR A ROTINA ATU_CMD O
		*          REGISTRO DE RESERVA QUE ESTA EM PROCESSO "****"
		*		   NAO INTERFIRA NO SALDO PROVOCANDO A MANUTENCAO
		*			DE SALDO DE RESERVA SENDO QUE A MESMA JA SAIU
		********************************************************
		DO WHILE !BOF()
		  IF &ALS_Itemmov .codigo  <> ITEMMOV.CODIGO ;
             OR &ALS_Itemmov .empresa <> ITEMMOV.EMPRESA
				EXIT
		  ENDIF

		  IF SUBS(&ALS_Itemmov .operacao,2,3) <> "***"
				EXIT
		  ENDIF
		  SKIP -1
		ENDDO
		***********************************************************
		* FIM DO BLOCO
		***********************************************************
	ENDIF
	IF BOF() ;
           OR &ALS_Itemmov .codigo      <> ITEMMOV.CODIGO ;
           OR &ALS_Itemmov .empresa     <> ITEMMOV.EMPRESA ;
		   OR YEAR(&ALS_Itemmov .data)  <> YEAR(ITEMMOV.data) ;
 		   OR MONTH(&ALS_Itemmov .data) <> MONTH(ITEMMOV.data)
						

			LNsldatu  = &ALS_Saldo .sld_ante
			LNvlratu  = &ALS_Saldo .vlr_ante
			LNreserva = &ALS_Saldo .res_ante
			m.res_ant = &ALS_Saldo .res_ante
	        STORE 0  TO  qtd_compra, vlr_compra, ;
     	                 qtd_venda , vlr_venda , ;
   	                     qtd_e_tran, vlr_e_tran, ;
   	                     qtd_e_outr, vlr_e_outr, ;
   	                     qtd_s_tran, vlr_s_tran, ;
		                 qtd_s_outr, vlr_s_outr, ;
 			 	         ven_tab, ven_contab, ven_enc, ;
	 			         reserva
	ELSE
		m.sld_ante = &ALS_Saldo .sld_ante
		m.vlr_ante = &ALS_Saldo .vlr_ante
		m.res_ante = &ALS_Saldo .res_ante

		LNsldatu  = &ALS_Itemmov .sld_estq
		LNvlratu  = &ALS_Itemmov .vlr_estq
		LNreserva = &ALS_Itemmov .sld_rese

		SELE &ALS_ItmAnexo
		SET ORDER TO TAG movanexo
		SEEK  STR(&ALS_Itemmov .empresa,3)+;
		          &ALS_Itemmov .codigo+;
			 DTOS(&ALS_Itemmov .data)+;
			      &ALS_Itemmov .hora+;
			      &ALS_Itemmov .tipo+;
			  STR(&ALS_Itemmov .nota,7)+;
			  STR(&ALS_Itemmov .ordem,3)

		IF !FOUND()
			m.qtd_compra = 0
			m.vlr_compra = 0
			m.qtd_venda  = 0
			m.vlr_venda  = 0
			m.qtd_e_tran = 0
			m.vlr_e_tran = 0
			m.qtd_e_outr = 0
			m.vlr_e_outr = 0
			m.qtd_s_tran = 0
			m.vlr_s_tran = 0
			m.qtd_s_outr = 0
			m.vlr_s_outr = 0
			m.ven_tab    = 0
			m.ven_contab = 0
			m.ven_enc    = 0
		ELSE
	        m.qtd_compra	= &ALS_ItmAnexo .q_compra
    	    m.vlr_compra	= &ALS_ItmAnexo .v_compra
        	m.qtd_venda 	= &ALS_ItmAnexo .q_venda
	        m.vlr_venda 	= &ALS_ItmAnexo .v_venda
	        m.qtd_e_tran	= &ALS_ItmAnexo .qe_tran
	        m.vlr_e_tran	= &ALS_ItmAnexo .ve_tran
	        m.qtd_e_outr	= &ALS_ItmAnexo .qe_outr
	        m.vlr_e_outr	= &ALS_ItmAnexo .ve_outr
	        m.qtd_s_tran	= &ALS_ItmAnexo .qs_tran
	        m.vlr_s_tran	= &ALS_ItmAnexo .vs_tran
	        m.qtd_s_outr	= &ALS_ItmAnexo .qs_outr
	        m.vlr_s_outr	= &ALS_ItmAnexo .vs_outr
	        m.ven_tab		= &ALS_ItmAnexo .v_tab
	        m.ven_contab	= &ALS_ItmAnexo .v_contab
	        m.ven_enc		= &ALS_ItmAnexo .v_enc
		ENDIF
	ENDIF

    =up_fecha("&ALS_Itemmov")
    =up_fecha("&ALS_ItmAnexo")
    =up_fecha("&ALS_Saldo")

	SELE itemmov

RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKQJ           MVIniRegSaldos VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:    7  ╨
*       ╨ Variable:            MVIniRegSaldos                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      167                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkqj     &&  MVIniRegSaldos VALID
#REGION 6
RETURN

******---------------------------------

PROCEDURE  MVIniRegSaldos   && Inicializa Registro de Saldos
PARAMETER 	LNempresa, LD_data, LScodigo, ;
            SLD_Abertura,;
            VLR_abertura, ;
            SLD_Reserva


        SELE GRUPO
        SET ORDER TO TAG CODIGO
        SEEK LScodigo
        IF !FOUND()
			=uperrosys()
			 WAIT WINDOW "ERRO. REG.PRODUTO NAO LOCALIZADO. <ENTER>..."
			 CLOSE ALL
			 QUIT
        ENDIF

        LSclassifica = Grupo.classifica

		SELE SALDO
		SET ORDER TO TAG emp_mes	
 		SEEK 	STR(LNempresa,3)+;
  			    STR(YEAR(LD_data),4)+;
			    STR(MONTH(LD_data),2)+;
			    LSclassifica
		**************************
	    m.empresa    = LNempresa
	    m.codigo     = LScodigo
	    m.classifica = LSclassifica
	    m.sld_ante   = SLD_Abertura
	    m.vlr_ante   = VLR_abertura
        m.res_ante   = SLD_Reserva
        m.reserva    = SLD_Reserva
		m.qtd_compra = 0
		m.vlr_compra = 0
		m.qtd_venda  = 0
		m.vlr_venda  = 0
		m.qtd_e_tran = 0
		m.vlr_e_tran = 0
		m.qtd_e_outr = 0
		m.vlr_e_outr = 0
		m.qtd_s_tran = 0
		m.vlr_s_tran = 0
		m.qtd_s_outr = 0
		m.vlr_s_outr = 0
		m.ven_tab    = 0
		m.ven_contab = 0
		m.ven_enc    = 0
	    m.status     = 'A'
	    IF FOUND()
	    	=REGLOCK(.T.)
			=edithand('REGRAVA')
	    ELSE
		    m.dtabert    = LD_data
			=edithand('SAVE')
	    ENDIF
	    UNLOCK
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKQQ           MVprocessaMvto VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:    8  ╨
*       ╨ Variable:            MVprocessaMvto                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      168                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkqq     &&  MVprocessaMvto VALID
#REGION 6
RETURN


FUNCTION MVprocessaMvto		&& ATUALIZA CUSTO MEDIO COM BASE NO ITEMMOV
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata,;
			PRMhora,;
			PRMtipo,;
			PRMnota,;
			PRMordem


	************************************************************

	SELE Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SET NEAR ON

	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)


	SET NEAR OFF
	
	DO WHILE !EOF() ;
			AND PRMCodigo = itemmov.codigo ;
		    AND PRMEmpresa  = itemmov.empresa
		*-----------------------------------------------------------------*
		*  A condicao :
 		*   (PRMCodigo = itemmov.codigo OR PRMClasse= itemmov.classifica) ;
		*   foicolocada em substituicao a:
 		*   (PRMClasse = itemmov.classifica) ;
 		* POR MOTIVO DE  UMA CORRUPCAO NO CAMPO classifica do itemmov
 		* que provocava a saida do laco e nao processava os movimentos
 		* posteriores ao itemmov danificado. Como o codigo estava intacto
 		* esta condicao permite uma tolerancia a corrupcao do campo
 		* mesmo nao resolvendo o problema
		*-----------------------------------------------------------------*
		MsgStep = STR(PRMempresa,3)+"-"+itemmov.codigo+"-"+;
		          DTOS(itemmov.data)+"-"+itemmov.hora+"-"+;
		          itemmov.tipo+"-"+STR( itemmov.nota,7)+"-"+;
				STR(itemmov.ordem,3)
		wait window MsgStep nowait
 		
		

		SELE itemmov
		=REGLOCK(.T.)		&& BLOQ. ITEMMOV P/ ATUALIZAR

		IF YEAR(saldo.dtabert)  <> YEAR(itemmov.data) or ;
		   MONTH(saldo.dtabert) <> MONTH(itemmov.data)

				****** TESTA MOTIVO DO CHAMADO A ROTINA ********
				***********************************************

			    =MVAtlzSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
						    m.sld_ante, 		m.vlr_ante, ;
						    m.res_ante,;
			    			LNsldatu, 			LNvlratu, ;
							m.qtd_compra, 		m.vlr_compra, ;
  			 				m.qtd_venda , 		m.vlr_venda , ;
 			  				m.qtd_e_tran, 		m.vlr_e_tran, ;
  			  				m.qtd_e_outr, 		m.vlr_e_outr, ;
  			  				m.qtd_s_tran, 		m.vlr_s_tran, ;
  			  				m.qtd_s_outr, 		m.vlr_s_outr)

				* Rotina complementar em funcao do excesso de parametros
				* para MVAtlzSaldos impedir o uso de uma so procedure

			    =MVAtlzComplSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
				  				m.ven_tab, ;
				  				m.ven_contab, ;
								m.ven_enc, ;
				  				m.dt_entrada, ;
				  				m.dt_saida, ;
			  					LNreserva )



				*----------------------------------------------------*
				*   O movimento Passou para uma data fora do mes
				* em que o registro de saldo estava posicionado,
				* entao o reg. de saldo deve ser inicializado no
				* mes seguite mesmo que o movimento tenha saltado
				* mais de um mes, ou seja, pode haver um mes sem
				* REGISTRO DE MOVIMENTO mas nao sem REGISTRO DE SALDO
				*----------------------------------------------------*

				LD_nvdata = GOMONTH(saldo.dtabert,1)


		        =MVIniRegSaldos( saldo.empresa,;
		        			     LD_nvdata,;
		        			     saldo.codigo,;
		        			     LNsldatu,;
		        			     LNvlratu,;
		        			     LNreserva)

				SELE itemmov

				LOOP
		ENDIF




		PRIVATE tipo,operacao, qtde, tp_mercad, cst
		PRIVATE aliq_icms, vlrvenda,base_calc, vlripi, custo_ind
        PRIVATE icms_subs
		PRIVATE preco, ch_opera, ch_desti, codigo, classifica

		PRIVATE movfin,movestq,movvalor,movcusto
		PRIVATE orcamento,codforn


		SCATTER MEMVAR MEMO FIELDS tipo,operacao, qtde, tp_mercad, cst,;
			aliq_icms, vlrvenda,base_calc, vlripi, custo_ind, preco,;
            icms_subs,	ch_opera, ch_desti, codigo, classifica,;
			movfin,movestq,movvalor,movcusto,orcamento,codforn

*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
*>>>>>>>>>>>>>>>>>>>>>>>>>>   MOVIMENTACAO DE SALDOS AUXILIARES
*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		SET DECIMALS TO 8

        =MVGetCustMedio((operacao), (movcusto),LNcstmedio, ;
         							 LNsldatu, LNvlratu)

		*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		LNredutor   = 0
		LSoperacao  = "/"		&& => DIVISAO PELO LNredutor

        =MVGetIndRedutor((operacao), LNredutor,LSoperacao)

		IF LEFT(m.operacao,1) = "E"
			m.dt_entrada  = itemmov.data
		ELSE
			IF LEFT(m.operacao,1) = "S"
					m.dt_saida  = itemmov.data
			ENDIF			
		ENDIF

		*----------------------------------------------------------*
	*	PRIVATE LSUfOrigem
	*	PRIVATE LSUfDestino
		PRIVATE LNcusto

		IF LEFT(itemmov.operacao,1) = "E"		&& ENTRADAS
			=W_DEFPROC("notaite.spr")
			LNcusto= IEGetCusto( itemmov.Empresa, ;
					         itemmov.Favorecido,;
							 itemmov.orcamento , ;					
							 itemmov.ordem)
		ELSE
			LNcusto = 0
		ENDIF

		*----------------------------------------------------------*



		DO MVSetSldEntradas WITH LNcusto

		DO MVSetSldSaida
		
		DO MVSetSaldos WITH PrmEmpresa, LNcusto



		*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		*>>>>>>>>>>>>>>>>>>>>> FIM DOS TESTES DE CONTROLE DE MOVIMENTACAO
		*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		SET DECIMALS TO 2



		SELE itmanexo
		*****************************************************
        =MVSincrItmAnexo(m.qtd_compra, m.vlr_compra, m.qtd_venda,;
        				m.vlr_venda,  m.qtd_e_tran,    m.vlr_e_tran, ;
        				m.qtd_e_outr, m.vlr_e_outr, m.qtd_s_tran,;
        				m.vlr_s_tran, m.qtd_s_outr, m.vlr_s_outr,;
        				m.ven_tab	, m.ven_contab, m.ven_enc)
		*****************************************************
		m.sld_estq	= LNsldatu
		IF m.sld_estq = 0 OR LNvlratu = 0
		   m.vlr_estq = LNcstmedio && ULTIMO CUSTO
		   LNvlratu	  =  LNcstmedio
		ELSE
		    m.vlr_estq  = LNvlratu
		ENDIF
        IF LNreserva < 0	&& caso de interf. do usua.no reg. de res.
			LNreserva = 0
		ENDIF
		m.sld_rese  = LNreserva

		

		SELE itemmov
		SET FIELDS TO dtregis, hregis, usrregis,deletado
	    SET FIELDS TO sld_estq, vlr_estq, sld_rese
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		*****************************************************
		UNLOCK
		SKIP
	ENDDO

 	SELECT SALDO

	=MVAtlzSaldos(saldo.empresa,saldo.classifica,;
			    			 saldo.dtabert,;
						    m.sld_ante,	m.vlr_ante, ;
                            m.res_ante,;
			    			LNsldatu, 			LNvlratu, ;
							m.qtd_compra, 		m.vlr_compra, ;
   			 				m.qtd_venda , 		m.vlr_venda , ;
   			  				m.qtd_e_tran, 		m.vlr_e_tran, ;
   			  				m.qtd_e_outr, 		m.vlr_e_outr, ;
   			  				m.qtd_s_tran, 		m.vlr_s_tran, ;
   			  				m.qtd_s_outr, 		m.vlr_s_outr)

				* Rotina complementar em funcao do excesso de parametros
				* para MVAtlzSaldos impedir o uso de uma so procedure

    =MVAtlzComplSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
				  				m.ven_tab, ;
				  				m.ven_contab, ;
								m.ven_enc, ;
				  				m.dt_entrada, ;
				  				m.dt_saida, ;
			  					LNreserva )



	PRMdata = saldo.dtabert

 	SELECT SALDO
	UNLOCK
	=MVSldFuturo(PRMempresa,;
				 PRMclasse,;
				 PRMdata,;
				 LNsldatu,;
				 LNvlratu,;
				 LNreserva)

RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKR3           MVSincrItmAnexo VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:    9  ╨
*       ╨ Variable:            MVSincrItmAnexo                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      169                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkr3     &&  MVSincrItmAnexo VALID
#REGION 6
RETURN

******---------------------------------

PROCEDURE MVSincrItmAnexo
PARAMETERS  m.q_compra, m.v_compra,  m.q_venda, m.v_venda,;
			m.qe_tran , m.ve_tran ,  m.qe_outr, m.ve_outr,;
			m.qs_tran , m.vs_tran ,  m.qs_outr, m.vs_outr,;
			m.v_tab   , m.v_contab,  m.v_enc

			


********************  INICIO DA BUSCA DE SALDOS **********************
	SELE itmanexo
	SET ORDER TO TAG movanexo
	SEEK STR(itemmov.empresa,3)+itemmov.codigo+;
			 DTOS(itemmov.data)+itemmov.hora+itemmov.tipo+;
			 STR(itemmov.nota,7)+STR(itemmov.ordem,3)
	IF !FOUND()
		SELE itmanexo
		SET ORDER TO TAG movanexo
		m.empresa 	= itemmov.empresa
		m.codigo 	= itemmov.codigo
	    m.classifica = itemmov.classifica
		m.data		= itemmov.data
		m.hora		= itemmov.hora
		m.tipo		= itemmov.tipo
		m.nota		= itemmov.nota
		m.ordem		= itemmov.ordem

		=edithand('SAVE')
    ELSE
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO ;
  	           	q_compra, v_compra,q_venda, v_venda, qe_tran, ve_tran,;
				qe_outr,ve_outr,qs_tran, vs_tran, qs_outr,vs_outr,;
				v_tab, v_contab, v_enc	
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ENDIF
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKR4           MVAtlzSaldos VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:   10  ╨
*       ╨ Variable:            MVAtlzSaldos                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      170                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkr4     &&  MVAtlzSaldos VALID
#REGION 6
RETURN

******---------------------------------

PROCEDURE MVAtlzSaldos

PARAMETERS   	PRempresa,			PRclassifica,;
				PRdata,;
			    m.sld_ante, 		m.vlr_ante, ;
                m.res_ante,;
	   			m.sld_atu, 			m.vlr_atu, ;
				m.qtd_compra, 		m.vlr_compra, ;
    			m.qtd_venda , 		m.vlr_venda , ;
    			m.qtd_e_tran, 		m.vlr_e_tran, ;
    			m.qtd_e_outr, 		m.vlr_e_outr, ;
    			m.qtd_s_tran, 		m.vlr_s_tran, ;
    			m.qtd_s_outr, 		m.vlr_s_outr


	IF m.sld_atu = 0
		m.sld_atu = 0
		m.vlr_atu = 0
*	ELSE
*        IF m.reserva < 0	&& caso de interf. do usua.no reg. de res.
*			m.reserva = 0
*		ENDIF
	ENDIF




    ARQ_Saldo    = NetArqAgain("SALDO")
    ALS_Saldo    = Alias()

   	SELE &ALS_Saldo
  	SET ORDER TO TAG clas_saldo
    SEEK STR(PRempresa,3)+PRclassifica+;
    		STR(YEAR(PRdata),4)+;
        	STR(MONTH(PRdata),2)

	***************************
	SET FIELDS TO dtregis, hregis, usrregis,deletado
    SET FIELDS TO sld_ante, vlr_ante, ;
                  res_ante,;
			      sld_atu, vlr_atu, qtd_compra, vlr_compra, ;
    			  qtd_venda , vlr_venda , ;
    			  qtd_e_tran, vlr_e_tran, ;
    			  qtd_e_outr, vlr_e_outr, ;
    			  qtd_s_tran, vlr_s_tran, ;
    			  qtd_s_outr, vlr_s_outr, ;
				  ven_tab, ven_contab, ven_enc, ;
				  dt_entrada,dt_saida, reserva

     IF FOUND()
		=edithand('REGRAVA')
	 ELSE
		=edithand('SAVE')
   	 ENDIF	
	CLEAR FIELDS
	SET FIELDS OFF
    UNLOCK
    =up_fecha("&ALS_Saldo")

	***************************

RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKR5           MVAtlzComplSaldos VALID            ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:   11  ╨
*       ╨ Variable:            MVAtlzComplSaldos                  ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      171                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkr5     &&  MVAtlzComplSaldos VALID
#REGION 6
RETURN

******---------------------------------

* Rotina complementar em funcao do excesso de parametros
* para MVAtlzSaldos

PROCEDURE MVAtlzComplSaldos

PARAMETERS   	PRempresa,			PRclassifica,;
				PRdata,;
				m.ven_tab, 			m.ven_contab, ;
				m.ven_enc, ;
				m.dt_entrada, 		m.dt_saida, ;
				m.reserva

    ARQ_Saldo    = NetArqAgain("SALDO")
    ALS_Saldo    = Alias()

   	SELE &ALS_Saldo
  	SET ORDER TO TAG clas_saldo
    SEEK STR(PRempresa,3)+PRclassifica+;
    		STR(YEAR(PRdata),4)+;
        	STR(MONTH(PRdata),2)

	***************************
    SET FIELDS TO  ven_tab, ven_contab, ven_enc, ;
				  dt_entrada,dt_saida, reserva

     IF FOUND()
		=edithand('REGRAVA')
	 ELSE
		=edithand('SAVE')
   	 ENDIF	
	CLEAR FIELDS
	SET FIELDS OFF
    UNLOCK
    =up_fecha("&ALS_Saldo")

	***************************

RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKR6           MVGetCustMedio VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:   12  ╨
*       ╨ Variable:            MVGetCustMedio                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      172                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkr6     &&  MVGetCustMedio VALID
#REGION 6
RETURN

******---------------------------------

PROCEDURE MVGetCustMedio

PARAMETERS  m.operacao, movcusto, LNcstmedio, LNsldatu, LNvlratu

        LNcstmedio = 0
		DO CASE
			CASE  (m.movcusto = "N" 	AND LNsldatu = 0)
		   	   LNcstmedio = LNvlratu  && ASSUME ULTIMO CUSTO ANTES DE ZERAR
			
			CASE  LEFT(m.operacao,1) = "S" AND ;
				  m.movcusto <> "N"  AND LNsldatu = 0

			*-------- ATENDE ex: VLG = COMPLEM DE PRECO EM PRODUTO ZERADO
		   	   LNcstmedio = LNvlratu  && ASSUME ULTIMO CUSTO ANTES DE ZERAR
									  && P/REGISTRAR VLR.DA OPERACAO
									  && DO CONTRARIO SERIA VLR=0 DEVIDO
									  && AO SALDO 0

			CASE  LEFT(m.operacao,1) = "E" AND ;
				  m.movcusto = "S" AND LNsldatu = 0
		       LNcstmedio = 0
		   	   LNvlratu   = 0         && ASSUME NOVO CUSTO A PARTIR DO ZERO
			CASE LNsldatu > 0 	
			   LNcstmedio = LNvlratu / LNsldatu   && ASSUME CUSTO ATUAL
		ENDCASE

RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKRU           MVGetIndRedutor VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:   13  ╨
*       ╨ Variable:            MVGetIndRedutor                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      173                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gkru     &&  MVGetIndRedutor VALID
#REGION 6
RETURN

******---------------------------------

PROCEDURE MVGetIndRedutor

PARAMETERS  m.operacao, LNredutor, LSoperacao

		**************************************
		*   Aplicando o INDICE DE REDUCAO AO VLRVENDA provoca-se a
		* retirada do do VALOR DE ICMS que esta agregada ao valor
		* da mercadoria
		**************************************

		IF itemmov.data   < CTOD("01.05.2003")
		   do ind_ate010503
		ELSE
		   do ind_dep010503
		ENDIF

RETURN


PROCEDURE ind_dep010503

		LNredutor   = 1
		LSoperacao  = "*"		&& => no novo calculo de custo evista
		IF LEFT(m.operacao,1) = "E"
			m.dt_entrada  = itemmov.data
			IF m.tp_mercad <> 2
				LNredutor = 1-(m.aliq_icms /100)  && Extrair ICMS do custo
			ENDIF
		ENDIF
RETURN

PROCEDURE ind_ate010503

		LNredutor   = 0
		LSoperacao  = "/"	&& =>PARA MANTER COERENCIA ANTIGA
		IF LEFT(m.operacao,1) = "E"
			m.dt_entrada  = itemmov.data
			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************
			*********************************************************
			*    Inicio de tratamento nao parametrizavel ( ESPECIFICO)
			*		Para PNEUS Ind,Caminhao,Tratores,Agric,Terrapl
			*	> "00448"  e < "00800"	
			**********************************************************
			IF itemmov.data      >= CTOD("11.10.1997") AND ;
					   m.ch_opera   = "2" AND m.ch_desti   = "1" AND ;
					   m.tp_mercad = 2
					    IF LEFT(itemmov.classifica,5) > "00448" AND ;
						   LEFT(itemmov.classifica,5) < "00800"
							LNredutor = 1.24
						ELSE
							LNredutor = 1.26
						ENDIF				
			ELSE
				IF itemmov.data  >= CTOD("01.09.1999")
					LNredutor = 1-(m.aliq_icms /100)
					LSoperacao  = "*"	&& => MULTIPLICACAO PELO LNredutor
				ELSE
					LNredutor = 1+(m.aliq_icms /100)
					LSoperacao  = "/"	&& =>PARA MANTER COERENCIA ANTIGA
				ENDIF
			ENDIF
			**************************************
			* FIM APLICA INDICE DE REDUCAO AO VLRVENDA
			**************************************
		ENDIF
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKS2           MVSetSldEntradas VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:   14  ╨
*       ╨ Variable:            MVSetSldEntradas                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      174                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gks2     &&  MVSetSldEntradas VALID
#REGION 6
RETURN

******---------------------------------

PROCEDURE MVSetSldEntradas
PARAMETERS LNcusto

		DO CASE
			CASE itemmov.data   < CTOD("01.05.2003")
				   do ste_ate010503
			CASE itemmov.data   < CTOD("01.07.2003") && CTOD("20.08.2003")
													 && CTOD("22.07.2003")
				   do ste_dep010503
			OTHERWISE
				   do ste_nvocst
		ENDCASE
RETURN


PROCEDURE ste_nvocst   && INCORPORA ICMS_SUBS AO CUSTO

   		DO CASE
			* ---------------> ENTRADAS PROCESSADAS
			CASE m.operacao = 'ECP.' 	 && ENTRADA\COMPRA\PROCESSADA
 			   	 m.qtd_compra = m.qtd_compra + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S" OR (m.movcusto = "N" AND LNvlratu = 0)
				   	 m.vlr_compra = m.vlr_compra + LNcusto
				 ELSE
				   	 m.vlr_compra = m.vlr_compra  + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ETP.'     &&  ENTRADA\TRANSF.\PROCESSADA
		   		 m.qtd_e_tran = m.qtd_e_tran + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S" OR (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_tran = m.vlr_e_tran + LNcusto
				 ELSE
			   		 m.vlr_e_tran = m.vlr_e_tran + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ERP.' OR ;
			     m.operacao = 'EDP.' OR ;
			     m.operacao = 'EOP.'      &&  ENTRADA\OUTRAS\PROCESSADA
		   		 m.qtd_e_outr = m.qtd_e_outr + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S" OR (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_outr = m.vlr_e_outr + LNcusto
				 ELSE
			   		 m.vlr_e_outr = m.vlr_e_outr + (m.qtde * LNcstmedio)
				 ENDIF

		ENDCASE
RETURN



PROCEDURE ste_dep010503   && INCORPORA ICMS_SUBS AO CUSTO

   		DO CASE
			* ---------------> ENTRADAS PROCESSADAS
			CASE m.operacao = 'ECP.' 	 && ENTRADA\COMPRA\PROCESSADA
 			   	 m.qtd_compra = m.qtd_compra + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
					IF m.ch_desti = "3"		&& ignora ICMS (NAO EMBUTIDO)
					   	 m.vlr_compra = m.vlr_compra ;
				   	 	+ m.vlrvenda + m.vlripi + m.custo_ind +	m.icms_subs
					ELSE
					   	 m.vlr_compra = m.vlr_compra ;
						   	 	+ (m.vlrvenda &LSoperacao LNredutor) ;
				   	 			+ m.vlripi + m.custo_ind + m.icms_subs
					ENDIF
				 ELSE
				   	 m.vlr_compra = m.vlr_compra ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ETP.'     &&  ENTRADA\TRANSF.\PROCESSADA
		   		 m.qtd_e_tran = m.qtd_e_tran + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_tran = m.vlr_e_tran ;
							+ (m.vlrvenda &LSoperacao LNredutor) ;
							+ m.vlripi + m.custo_ind + m.icms_subs
				 ELSE
			   		 m.vlr_e_tran = m.vlr_e_tran ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ERP.' OR ;
			     m.operacao = 'EDP.' OR ;
			     m.operacao = 'EOP.'      &&  ENTRADA\OUTRAS\PROCESSADA
		   		 m.qtd_e_outr = m.qtd_e_outr + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_outr = m.vlr_e_outr ;
				   		 			+ (m.vlrvenda &LSoperacao LNredutor) ;
				   		 			+ m.vlripi + m.custo_ind + m.icms_subs
				 ELSE
			   		 m.vlr_e_outr = m.vlr_e_outr ;
			   		 		+ (m.qtde * LNcstmedio)
				 ENDIF

		ENDCASE
RETURN

PROCEDURE ste_ate010503

   		DO CASE
			* ---------------> ENTRADAS PROCESSADAS
			CASE m.operacao = 'ECP.' 	 && ENTRADA\COMPRA\PROCESSADA
 			   	 m.qtd_compra = m.qtd_compra + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
					IF m.ch_desti = "3"		&& ignora ICMS (NAO EMBUTIDO)
					   	 m.vlr_compra = m.vlr_compra ;
				   	 	+ m.vlrvenda + m.vlripi + m.custo_ind
					ELSE
					   	 m.vlr_compra = m.vlr_compra ;
						   	 	+ (m.vlrvenda &LSoperacao LNredutor) ;
				   	 			+ m.vlripi + m.custo_ind
					ENDIF
				 ELSE
				   	 m.vlr_compra = m.vlr_compra ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ETP.'     &&  ENTRADA\TRANSF.\PROCESSADA
		   		 m.qtd_e_tran = m.qtd_e_tran + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_tran = m.vlr_e_tran ;
							+ (m.vlrvenda &LSoperacao LNredutor) ;
							+ m.vlripi + m.custo_ind
				 ELSE
			   		 m.vlr_e_tran = m.vlr_e_tran ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ERP.' OR ;
			     m.operacao = 'EDP.' OR ;
			     m.operacao = 'EOP.'      &&  ENTRADA\OUTRAS\PROCESSADA
		   		 m.qtd_e_outr = m.qtd_e_outr + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_outr = m.vlr_e_outr ;
				   		 			+ (m.vlrvenda &LSoperacao LNredutor) ;
				   		 			+ m.vlripi + m.custo_ind
				 ELSE
			   		 m.vlr_e_outr = m.vlr_e_outr ;
			   		 		+ (m.qtde * LNcstmedio)
				 ENDIF

		ENDCASE
RETURN

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKSC           MVSetSldSaidas VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:   15  ╨
*       ╨ Variable:            MVSetSldSaidas                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      175                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gksc     &&  MVSetSldSaidas VALID
#REGION 6
RETURN

******---------------------------------

PROCEDURE MVSetSldSaidas


		DO CASE

************CASE  m.tp_mercad = 7 AND  LEFT(m.operacao,1) = 'S' && SAIDA

			*-- SERVICO/SAIDA/VENDA/NAO NF DE ENTRADA--------------*
			CASE  m.tp_mercad = 7 AND LEFT(m.operacao,1) = 'S' AND ;
				  m.ch_opera = "1" AND m.tipo <> "ENT"

				 IF m.movestq = "S"
					 m.qtd_venda  = m.qtd_venda  + m.qtde
					 m.vlr_venda = m.vlr_venda   + m.vlrvenda + m.vlripi
				 ENDIF

			*-- SAIDA/VENDA/NAO NF DE ENTRADA--------------*

			CASE  LEFT(m.operacao,1) = 'S' AND ;
				  m.ch_opera = "1" AND m.tipo <> "ENT"
				 IF m.movestq = "S"
					 m.qtd_venda  = m.qtd_venda  + m.qtde
					 m.vlr_venda  = m.vlr_venda  + (LNcstmedio * m.qtde)
			   		 m.ven_contab = m.ven_contab + (m.qtde * LNcstmedio)
				 ENDIF

				 IF m.movvalor <> "N" 	&& Nos 1os MOVIMENTOS o Sim = ESPACO BRANCO
			   		 m.ven_tab 	  = m.ven_tab    + (m.qtde * m.preco)
					 m.ven_enc    = m.ven_enc +  m.vlrvenda	 + m.vlripi
					            && VEND.NO.PRECO FIN.c/ENCARG.
				 ENDIF
	 			 *---- O VALOR DA VENDA COM ENCARGOS = VLRVENDA --*
			CASE LEFT(m.operacao,3) = 'STP' && SAIDA\TRANSF.\PROCESSADAS
				 IF m.movestq = "S"
			   		 m.qtd_s_tran = m.qtd_s_tran + m.qtde
					 *---- CALCULO ESPECIAL PARA TRANSFERENCIAS ------*
					*----------------------------------------------------*
					*      O uso da fun┤фo UPcustotransf foi desativado em
					* 27/12/2000 por ser redundante. O custo  apurado na
					* funcфo equivale ao custo normal que e calculado de
					* forma direta.
					*     O calculo usado na funcao parte do valor
					* registrado na nota de saida e que nao ┌ corrigido
					* quando o custo ┌ alterado pela corre┤фo de uma entrada
					* anterior a tranf. EX:
					*     Na filial SIA foi dada entrada de produto em
					* codigo trocado o que elevou o custo deste e logo em
					* seguida foi feita transf. com custo errado. quando
					* a entrada foi corrigida o custo medio ficou correto
					* mas a transf nao foi ajusta.
					*----------------------------------------------------*
					* m.vlr_s_tran = m.vlr_s_tran+(m.qtde * UPcustotrasf())
					*----------------------------------------------------*
			   		 m.vlr_s_tran = m.vlr_s_tran + (m.qtde * LNcstmedio)
				 ENDIF
			CASE LEFT(m.operacao,1) = 'S' AND ;
			     SUBS(m.operacao,3,1) = 'P'	&& SAIDA\? OUTRAS ?\PROCESSADAS
				 IF m.movestq = "S"
			   		 m.qtd_s_outr = m.qtd_s_outr + m.qtde
			   		 m.vlr_s_outr = m.vlr_s_outr + (m.qtde * LNcstmedio)
				 ENDIF
		ENDCASE
RETURN

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKSJ           MVSetSaldos VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:   16  ╨
*       ╨ Variable:            MVSetSaldos                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      176                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gksj     &&  MVSetSaldos VALID
#REGION 6
RETURN

******---------------------------------

PROCEDURE MVSetSaldos
PARAMETERS 	PRMempresa, LNcusto
	
	LSalias	= ALIAS()
    PRIVATE ARQ_Empresa,ALS_Empresa

	LSalias	= ALIAS()
	*-----------------------------------------------------------*


    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa

	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE SALDO ESTOQUE			*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF m.movestq = "S"
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
				IF SUBS(m.operacao,3,1) = "P" && SAIDA PROCESSADA
							LNsldatu   = LNsldatu - m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
				IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
						LNsldatu = LNsldatu + m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "R" AND m.operacao <> "R***"
				LNreserva  = LNreserva + m.qtde
		ENDCASE
	ENDIF


	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE VALOR ESTOQUE		*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA

		DO CASE
			CASE itemmov.data   < CTOD("01.05.2003")
					do Set_ate010503     && usado antes de  01/05/2003

			CASE itemmov.data   < CTOD("01.07.2003") && CTOD("20.08.2003")
													 && CTOD("22.07.2003")
					do Set_dep010503	 && usado depois de  01/05/2003
			OTHERWISE
				    do set_nvocst
		ENDCASE

    ENDIF

    =UP_Fecha("&ALS_Empresa")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN

PROCEDURE set_nvocst

	 DO CASE
		CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
			LNvlratu	= LNcstmedio * LNsldatu

		CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
			*--------------------------------------------------*
			IF m.movcusto = "S" OR (LNvlratu = 0)
				LNvlratu = LNvlratu + LNcusto
			ELSE
				LNvlratu	= LNcstmedio * LNsldatu
			ENDIF
			*-------------------------------------------------------*
	 ENDCASE
RETURN

*--------------------------------------------*
PROCEDURE Set_ate010503

	 DO CASE
		CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
			LNvlratu	= LNcstmedio * LNsldatu

		CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
			*--------------------------------------------------*
			IF m.movcusto = "S" OR (LNvlratu = 0)
				DO CASE
					CASE m.ch_desti = "3"	&& ignora ICMS (NAO
										&& EMBUTIDO) INTERNACIONAL
						LNvlratu = LNvlratu + m.vlrvenda ;
							 + m.vlripi + m.custo_ind
					OTHERWISE
						LNvlratu = LNvlratu ;
							+ (m.vlrvenda &LSoperacao LNredutor) ;
						 	+ m.vlripi + m.custo_ind
				ENDCASE
			ELSE
				LNvlratu	= LNcstmedio * LNsldatu
			ENDIF
			*-------------------------------------------------------*
	 ENDCASE
RETURN

*------------------------------------------------*
PROCEDURE Set_dep010503

	 DO CASE
		CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
			LNvlratu	= LNcstmedio * LNsldatu

		CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
			*--------------------------------------------------*
			IF m.movcusto = "S" OR (LNvlratu = 0)
				DO CASE
					CASE m.ch_desti = "3"	&& ignora ICMS (NAO
										&& EMBUTIDO) INTERNACIONAL
						LNvlratu = LNvlratu + m.vlrvenda ;
							 + m.vlripi + m.custo_ind
					OTHERWISE
						IF m.tp_mercad = 2	&& Regime Substituicao
							LNvlratu = LNvlratu + m.vlrvenda ;
								+ m.vlripi + m.custo_ind + m.icms_subs
						ELSE
							LNvlratu = LNvlratu ;
								+ (m.vlrvenda &LSoperacao LNredutor) ;
							 	+ m.vlripi + m.custo_ind + m.icms_subs
						ENDIF
				ENDCASE
			ELSE
				LNvlratu	= LNcstmedio * LNsldatu
			ENDIF
				*-------------------------------------------------------*
	 ENDCASE
RETURN
*------------------------------------------------*



PROCEDURE ANT2MVSetSaldos
	

	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE SALDO ESTOQUE			*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF m.movestq = "S"
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
				IF SUBS(m.operacao,3,1) = "P" && SAIDA PROCESSADA
							LNsldatu   = LNsldatu - m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
				IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
						LNsldatu = LNsldatu + m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "R" AND m.operacao <> "R***"
				LNreserva  = LNreserva + m.qtde
		ENDCASE
	ENDIF


	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE VALOR ESTOQUE		*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS

				LNvlratu	= LNcstmedio * LNsldatu

			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS

				*-------------------------------------------------------*
				IF m.movcusto = "S" OR (LNvlratu = 0)
					IF m.ch_desti = "3"		&& ignora ICMS (NAO EMBUTIDO) INTERNACIONAL
						LNvlratu = LNvlratu + m.vlrvenda ;
									 + m.vlripi + m.custo_ind
					ELSE
									
						LNvlratu = LNvlratu ;
								+ (m.vlrvenda &LSoperacao LNredutor) ;
								 	+ m.vlripi + m.custo_ind

					ENDIF
				ELSE
					LNvlratu	= LNcstmedio * LNsldatu
				ENDIF

				*-------------------------------------------------------*


		ENDCASE
	ENDIF

RETURN

*--------------------------------------------------*
* PROCESSO ANTIGO
*--------------------------------------------------*

PROCEDURE AntgMVSetSaldos
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
				DO CASE
					CASE SUBS(m.operacao,3,1) = "P" && SAIDA PROCESSADA
						 IF m.movestq = "S"
								LNsldatu   = LNsldatu - m.qtde
						 ENDIF
						&& CALCULA CUSTO MEDIO ATUAL
						&& ATUALIZA VALOR ESTOQUE
						LNvlratu	= LNcstmedio * LNsldatu
				ENDCASE
			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
				DO CASE
					CASE SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
						LNsldatu = LNsldatu + m.qtde
						*----------------------------------------------*
						IF m.movcusto = "S" OR (LNvlratu = 0)


							IF m.ch_desti = "3"	&& ignora ICMS (NAO
												&& EMBUTIDO) INTERNACIONAL
							    LNvlratu = LNvlratu + m.vlrvenda ;
									 + m.vlripi + m.custo_ind
							ELSE
								LNvlratu = LNvlratu ;
									+ (m.vlrvenda &LSoperacao LNredutor) ;
									 	+ m.vlripi + m.custo_ind
							ENDIF

						ELSE
							LNvlratu	= LNcstmedio * LNsldatu
						ENDIF

						*----------------------------------------------*

				ENDCASE

			CASE  LEFT(m.operacao,1) = "R" AND m.operacao <> "R***"
				LNreserva  = LNreserva + m.qtde
		ENDCASE


RETURN

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKSK           MVSldFuturo VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         MOVIMENT,     Record Number:   17  ╨
*       ╨ Variable:            MVSldFuturo                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      177                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gksk     &&  MVSldFuturo VALID
#REGION 6
RETURN

******---------------------------------

FUNCTION MVSldFuturo		&& Bloquear Reg de Saldo
PARAMETERS PRMempresa, ;
			PRMclassifica, ;
			PRMdata, ;
			PRMsldatu, ;
			PRMvlratu, ;
			PRMreserva

 	SELECT SALDO
	SET ORDER TO TAG clas_saldo

    SEEK STR(PRMempresa,3)+PRMclassifica+;
    	    STR(YEAR(PRMdata),4)+;
            STR(MONTH(PRMdata),2)

	IF !EOF()
		SKIP
		m.sld_ante   = PRMsldatu
		m.vlr_ante   = PRMvlratu
        m.res_ante   = PRMreserva
		m.sld_atu 	 = PRMsldatu
		m.vlr_atu    = PRMvlratu
		m.reserva	 = PRMreserva
		m.qtd_compra = 0
		m.vlr_compra = 0
		m.qtd_venda  = 0
		m.vlr_venda  = 0
		m.qtd_e_tran = 0
		m.vlr_e_tran = 0
		m.qtd_e_outr = 0
		m.vlr_e_outr = 0
		m.qtd_s_tran = 0
		m.vlr_s_tran = 0
		m.qtd_s_outr = 0
		m.vlr_s_outr = 0
		m.ven_tab    = 0
		m.ven_contab = 0
		m.ven_enc    = 0
	    m.status     = 'A'
		DO WHILE !EOF() AND PRMclassifica = saldo.classifica ;
						AND PRMempresa	  = saldo.empresa
			=MVAtlzSaldos(saldo.empresa,saldo.classifica,;
			    			 saldo.dtabert,;
						    m.sld_ante, 		m.vlr_ante, ;
						    m.res_ante,;
			    			m.sld_atu, 			m.vlr_atu, ;
							m.qtd_compra, 		m.vlr_compra, ;
   			 				m.qtd_venda , 		m.vlr_venda , ;
   			  				m.qtd_e_tran, 		m.vlr_e_tran, ;
   			  				m.qtd_e_outr, 		m.vlr_e_outr, ;
   			  				m.qtd_s_tran, 		m.vlr_s_tran, ;
   			  				m.qtd_s_outr, 		m.vlr_s_outr)


				* Rotina complementar em funcao do excesso de parametros
				* para MVAtlzSaldos impedir o uso de uma so procedure

			    =MVAtlzComplSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
				  				m.ven_tab, ;
				  				m.ven_contab, ;
				  				m.ven_enc, ;
				  				m.dt_entrada, ;
				  				m.dt_saida, ;
				  				m.reserva )

			***************************
			SELE SALDO
			SKIP
		ENDDO
	ENDIF
	SET ORDER TO TAG emp_mes

RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKSL           FRGet_UF VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:    2  ╨
*       ╨ Variable:            FRGet_UF                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      178                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gksl     &&  FRGet_UF VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRGet_UF
PARAMETERS Prmfornece
	=FRChk_Identidade(Prmfornece)
RETURN(FRGetPropVT("ESTADO"))




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKSM           FRrgm_Fisc VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:    3  ╨
*       ╨ Variable:            FRrgm_Fisc                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      179                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gksm     &&  FRrgm_Fisc VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRrgm_Fisc
PARAMETERS Prmfornece

	=FRChk_Identidade(Prmfornece)

RETURN(FRGetPropVT("RGMEFISCAL"))
	



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKTE           FRVerifyInst VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:    4  ╨
*       ╨ Variable:            FRVerifyInst                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      180                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkte     &&  FRVerifyInst VALID
#REGION 7
return
*---------------------------------------------------------------*



FUNCTION FRVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Fornece")


	DO CASE

		CASE TYPE("PBForneceAlias") = "U" ;
		   		OR EMPTY(PBForneceAlias) ;
		   		OR !USED(PBForneceAlias)
			=FRCreate()					

		CASE !("FORNECE.DBF" $ DBF(PBForneceAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBForneceAlias
			=FRCreate()					


		CASE  !(LSPath $ DBF(PBForneceAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=FRDestroi()				
			=FRCreate()					
	ENDCASE

	
RETURN(.t.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKTK           FRCreate VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:    5  ╨
*       ╨ Variable:            FRCreate                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      181                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gktk     &&  FRCreate VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBForneceAlias") <> "U" ;
	   		AND !EMPTY(PBForneceAlias) ;
	   		AND USED(PBForneceAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBForneceAlias

	IF USED("Fornece")
	     =NetArqAgain("Fornece")
	     PBForneceAlias     = Alias()
	ELSE
	     =NetArqAgain("Fornece")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Fornece")
	     PBForneceAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBForneceAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTFornece[LMaxDim]
    PUBLIC DIMENSION VDFornece[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFFornece[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFFornece)



	*-----------------------------------------------------------*
	=FRReadProperty()
	=FRSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKTS           FRDestroi VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:    6  ╨
*       ╨ Variable:            FRDestroi                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      182                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkts     &&  FRDestroi VALID
#REGION 7
return
*---------------------------------------------------------------*


FUNCTION FRDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBForneceAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBForneceAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBForneceAlias
	*  3- Se aplicar um FECHAMENTO a PBForneceAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBForneceAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBForneceAlias)) OR ;
	   !("FORNECE.DBF" $ DBF(PBForneceAlias))

		RELEASE PBForneceAlias
    	RELEASE VTFornece
	    RELEASE VDFornece
		RELEASE VFFornece
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBForneceAlias) AND USED(PBForneceAlias)
		SELECT &PBForneceAlias
		USE
	ENDIF	
	RELEASE PBForneceAlias
    RELEASE VTFornece
    RELEASE VDFornece
	RELEASE VFFornece

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKTY           FRReadProp VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:    7  ╨
*       ╨ Variable:            FRReadProp                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      183                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkty     &&  FRReadProp VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBForneceAlias
	SCATTER TO VTFornece
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKU4           FRSetDerivadas VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:    8  ╨
*       ╨ Variable:            FRSetDerivadas                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      184                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gku4     &&  FRSetDerivadas VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDFornece(1,1) = "NAOINFORMADO"
   	VDFornece(1,2) = 0
   	VDFornece(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKU5           FRSetPropVT VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:    9  ╨
*       ╨ Variable:            FRSetPropVT                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      185                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gku5     &&  FRSetPropVT VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBForneceAlias,;
						    VTFornece,;
						    VDFornece,;
						    VFFornece)

RETURN(Lvalue)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKU6           FRGetPropVT VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:   10  ╨
*       ╨ Variable:            FRGetPropVT                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      186                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gku6     &&  FRGetPropVT VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBForneceAlias,;
	            VTFornece,;
	            VDFornece,;
	            VFFornece)

RETURN(Lvalue)





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKU7           FRChk_Identidade VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:   11  ╨
*       ╨ Variable:            FRChk_Identidade                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      187                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gku7     &&  FRChk_Identidade VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRChk_Identidade
PARAMETERS Prmfornece

	PRIVATE LFretorno
	LFretorno = .t.

	=FRVerifyInst()
	=FRSetPropVT("CODIGO",Prmfornece)

	LFretorno=FRFind()
RETURN(LFretorno)





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKU8           FRFind VALID                       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:   12  ╨
*       ╨ Variable:            FRFind                             ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      188                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gku8     &&  FRFind VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRFind

	PRIVATE Lcodigo
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=FRVerifyInst()

	Lcodigo   = FRGetPropVT("CODIGO")

	SELE &PBForneceAlias
	SET ORDER TO TAG CODIGO
	SEEK Lcodigo

	IF FOUND()
		=FRReadProperty()
		=FRSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKUY           FRGetFieldValue VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:   13  ╨
*       ╨ Variable:            FRGetFieldValue                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      189                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkuy     &&  FRGetFieldValue VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRGetFieldValue
PARAMETERS Prmfornece,PrmField

	=FRChk_Identidade(Prmfornece)

RETURN(FRGetPropVT(PrmField))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKV4           FR_Refresh VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:   14  ╨
*       ╨ Variable:            FR_Refresh                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      190                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkv4     &&  FR_Refresh VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FR_Refresh
PARAMETERS Prmfornece
			
	
	


	PRIVATE LFretorno


	=FRVerifyInst()
	=FRSetPropVT("CODIGO",Prmfornece)

	LFretorno=FRFind()
RETURN(LFretorno)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKV9           FRLerRegistro VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:   16  ╨
*       ╨ Variable:            FRLerRegistro                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      191                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkv9     &&  FRLerRegistro VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRLerRegistro
PARAMETERS Prmfornece



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = FRChk_Identidade(Prmfornece)
RETURN(LFretorno)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKVF           FRWriteProp VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:   17  ╨
*       ╨ Variable:            FRWriteProp                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      192                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkvf     &&  FRWriteProp VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBForneceAlias
	=RLOCK()
	GATHER FROM  VTFornece
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKVL           FRSalvarRegistro VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:   18  ╨
*       ╨ Variable:            FRSalvarRegistro                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      193                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkvl     &&  FRSalvarRegistro VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRSalvarRegistro

	=FRVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !FRExiste()
		SELE &PBForneceAlias
		APPEND BLANK
		LFretorno=FRWriteProp()
	ELSE
		SELE &PBForneceAlias
		LFretorno=FRWriteProp()
	ENDIF

RETURN(LFretorno)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKVM           FRExiste VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:   19  ╨
*       ╨ Variable:            FRExiste                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      194                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkvm     &&  FRExiste VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRExiste

	PRIVATE Lcodigo

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=FRVerifyInst()

	Lcodigo   = FRGetPropVT("CODIGO")

	SELE &PBForneceAlias
	SET ORDER TO TAG CODIGO
	SEEK Lcodigo

	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKVN           FRGetAlias VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:   21  ╨
*       ╨ Variable:            FRGetAlias                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      195                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkvn     &&  FRGetAlias VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION FRGetAlias

	=FRVerifyInst()

RETURN(PBForneceAlias)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKVO           FRGet_Nome VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:   22  ╨
*       ╨ Variable:            FRGet_Nome                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      196                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkvo     &&  FRGet_Nome VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRGet_NOME
PARAMETERS Prmfornece
	=FRChk_Identidade(Prmfornece)
RETURN(FRGetPropVT("NOME"))




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKVP           FRGet_Inscr VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         FORNECED,     Record Number:   23  ╨
*       ╨ Variable:            FRGet_Inscr                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      197                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkvp     &&  FRGet_Inscr VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRGet_Inscr
PARAMETERS Prmfornece
	=FRChk_Identidade(Prmfornece)
RETURN(FRGetPropVT("INSCRICAO"))




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKWF           NEGetFieldValue VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:    2   ╨
*       ╨ Variable:            NEGetFieldValue                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      198                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkwf     &&  NEGetFieldValue VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NEGetFieldValue
PARAMETERS PrmEmp,PrmBoletim,PrmForn,PrmField

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT(PrmField))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKWK           NEGetUFOrigem VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:    3   ╨
*       ╨ Variable:            NEGetUFOrigem                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      199                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkwk     &&  NEGetUFOrigem VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NEGetUFOrigem
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT("UF"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKWP           NEGetUFDestino VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:    4   ╨
*       ╨ Variable:            NEGetUFDestino                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      200                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkwp     &&  NEGetUFDestino VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NEGetUFDestino
PARAMETERS PrmEmp,PrmBoletim,PrmForn
	PRIVATE Lvalue


	=W_DEFPROC("empresa.spr")
	Lvalue = EMGet_UF(PrmEmp)

RETURN(Lvalue)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKWV           NEGetRetidoDestacado VALID         ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:    5   ╨
*       ╨ Variable:            NEGetRetidoDestacado               ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      201                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkwv     &&  NEGetRetidoDestacado VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NEGetRetidoDestacado
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT("ICMS_SUBS"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKX0           NEVerifyInst VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:    6   ╨
*       ╨ Variable:            NEVerifyInst                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      202                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkx0     &&  NEVerifyInst VALID
#REGION 8
return
*---------------------------------------------------------------*



FUNCTION NEVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("NOTAENT")


	DO CASE

		CASE TYPE("PBNotaEntAlias") = "U" ;
		   		OR EMPTY(PBNotaEntAlias) ;
		   		OR !USED(PBNotaEntAlias)
			=NECreate()					

		CASE !("NOTAENT.DBF" $ DBF(PBNotaEntAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBNotaEntAlias
			=NECreate()					


		CASE  !(LSPath $ DBF(PBNotaEntAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=NEDestroi()				
			=NECreate()					
	ENDCASE

	
RETURN(.t.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKX7           NECreate VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:    7   ╨
*       ╨ Variable:            NECreate                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      203                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkx7     &&  NECreate VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NECreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBNotaEntAlias") <> "U" ;
	   		AND !EMPTY(PBNotaEntAlias) ;
	   		AND USED(PBNotaEntAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBNotaEntAlias

	IF USED("NotaEnt")
	     =NetArqAgain("NotaEnt")
	     PBNotaEntAlias     = Alias()
	ELSE
	     =NetArqAgain("NotaEnt")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("NotaEnt")
	     PBNotaEntAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBNotaEntAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTNotaEnt[LMaxDim]
    PUBLIC DIMENSION VDNotaEnt[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFNotaEnt[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFNotaEnt)



	*-----------------------------------------------------------*
	=NEReadProperty()
	=NESetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKX8           NEDestroi VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:    8   ╨
*       ╨ Variable:            NEDestroi                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      204                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkx8     &&  NEDestroi VALID
#REGION 8
return
*---------------------------------------------------------------*


FUNCTION NEDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBNotaEntAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBNotaEntAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBNotaEntAlias
	*  3- Se aplicar um FECHAMENTO a PBNotaEntAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBNotaEntAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBNotaEntAlias)) OR ;
	   !("NOTAENT.DBF" $ DBF(PBNotaEntAlias))

		RELEASE PBNotaEntAlias
    	RELEASE VTNotaEnt
	    RELEASE VDNotaEnt
		RELEASE VFNotaEnt
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBNotaEntAlias) AND USED(PBNotaEntAlias)
		SELECT &PBNotaEntAlias
		USE
	ENDIF	
	RELEASE PBNotaEntAlias
    RELEASE VTNotaEnt
    RELEASE VDNotaEnt
	RELEASE VFNotaEnt

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKX9           NEReadProp VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:    9   ╨
*       ╨ Variable:            NEReadProp                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      205                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkx9     &&  NEReadProp VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NEReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBNotaEntAlias
	SCATTER TO VTNotaEnt
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKXA           NESetDerivadas VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   10   ╨
*       ╨ Variable:            NESetDerivadas                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      206                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkxa     &&  NESetDerivadas VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NESetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDNotaEnt(1,1) = "UF DESTINO"
   	VDNotaEnt(1,2) = 0
   	VDNotaEnt(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKXW           NESetPropVT VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   11   ╨
*       ╨ Variable:            NESetPropVT                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      207                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkxw     &&  NESetPropVT VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NESetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBNotaEntAlias,;
						    VTNotaEnt,;
						    VDNotaEnt,;
						    VFNotaEnt)

RETURN(Lvalue)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKY3           NEGetPropVT VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   12   ╨
*       ╨ Variable:            NEGetPropVT                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      208                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gky3     &&  NEGetPropVT VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NEGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBNotaEntAlias,;
	            VTNotaEnt,;
	            VDNotaEnt,;
	            VFNotaEnt)

RETURN(Lvalue)





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKYA           NEChk_Identidade VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   13   ╨
*       ╨ Variable:            NEChk_Identidade                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      209                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkya     &&  NEChk_Identidade VALID
#REGION 8
return
*---------------------------------------------------------------*


FUNCTION NEChk_Identidade
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	PRIVATE LFretorno
	LFretorno = .t.

	=NEVerifyInst()

    =NESetPropVT("EMPRESA",PrmEmp)
    =NESetPropVT("REFERENCIA",PrmBoletim)
    =NESetPropVT("CODFORN",PrmForn)

	LFretorno=NEFind()
RETURN(LFretorno)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKYG           NEFind VALID                       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   14   ╨
*       ╨ Variable:            NEFind                             ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      210                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkyg     &&  NEFind VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NEFind

	PRIVATE LEmpresa, LReferencia, LCodForn
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NEVerifyInst()


	LEmpresa    = NEGetPropVT("Empresa")
	LReferencia = NEGetPropVT("Referencia")
	LCodForn    = NEGetPropVT("CodForn")


	SELE &PBNotaentAlias
	SET ORDER TO TAG BOLETIM
	SEEK STR(LEmpresa,3)+STR(LReferencia,6)+STR(LCodForn,5)
	IF FOUND()
		=NEReadProperty()
		=NESetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKYM           NEGetFieldValue VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   15   ╨
*       ╨ Variable:            NEGetFieldValue                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      211                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkym     &&  NEGetFieldValue VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NEGetFieldValue
PARAMETERS PrmEmp,PrmBoletim,PrmForn,PrmField

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT(PrmField))



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKYS           NE_Refresh VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   16   ╨
*       ╨ Variable:            NE_Refresh                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      212                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkys     &&  NE_Refresh VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
FUNCTION NE_Refresh
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	PRIVATE LFreturn
	
	=NEVerifyInst()
	*----------------------------------------------------------------*
	
    =NESetPropVT("EMPRESA",PrmEmp)
    =NESetPropVT("REFERENCIA",PrmBoletim)
    =NESetPropVT("CODFORN",PrmForn)
	=NEFind()
	
RETURN(.t.)






*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKYT           NELerRegistro VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   18   ╨
*       ╨ Variable:            NELerRegistro                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      213                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkyt     &&  NELerRegistro VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NELerRegistro
PARAMETERS PrmEmp,PrmBoletim,PrmForn



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)
RETURN(LFretorno)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKYU           NEWriteProp VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   19   ╨
*       ╨ Variable:            NEWriteProp                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      214                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkyu     &&  NEWriteProp VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NEWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBNotaEntAlias
	=RLOCK()
	GATHER FROM  VTNotaEnt
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKYV           NESalvarRegistro VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   20   ╨
*       ╨ Variable:            NESalvarRegistro                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      215                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkyv     &&  NESalvarRegistro VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NESalvarRegistro

	=NEVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !NEExiste()
		SELE &PBNotaEntAlias
		APPEND BLANK
		LFretorno=NEWriteProp()
	ELSE
		SELE &PBNotaEntAlias
		LFretorno=NEWriteProp()
	ENDIF

RETURN(LFretorno)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKZF           NEExiste VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   21   ╨
*       ╨ Variable:            NEExiste                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      216                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkzf     &&  NEExiste VALID
#REGION 8
return
*---------------------------------------------------------------*
FUNCTION NEExiste

	PRIVATE LEmpresa, LReferencia, LCodForn
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NEVerifyInst()


	LEmpresa    = NEGetPropVT("Empresa")
	LReferencia = NEGetPropVT("Referencia")
	LCodForn    = NEGetPropVT("CodForn")


	SELE &PBNotaentAlias
	SET ORDER TO TAG BOLETIM
	SEEK STR(LEmpresa,3)+STR(LReferencia,6)+STR(LCodForn,5)
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKZM           NEGetAlias VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   23   ╨
*       ╨ Variable:            NEGetAlias                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      217                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkzm     &&  NEGetAlias VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NEGetAlias

	=NEVerifyInst()

RETURN(PBNotaEntAlias)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKZR           NEVerPendencias VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         NOTAENT,     Record Number:   25   ╨
*       ╨ Variable:            NEVerPendencias                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      218                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkzr     &&  NEVerPendencias VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION NEVerPendencias
PARAMETERS PrmEmp
    PRIVATE LSRetorno

	PRIVATE LSalias
	LSalias		= 	ALIAS()



	=W_DEFPROC("NOTAENT.SPR")
	NFAlias = NEGetAlias()

    SELECT NOTA FROM &NFAlias;
     WHERE empresa = PrmEmp ;
     and situacao = "c" ;
     INTO CURSOR NFEntTmp

   SELE NFEntTmp
   GO TOP
   IF EOF()
      LSretorno = 0
   ELSE
      LSretorno = NFEntTmp.nota
   ENDIF
   USE

   IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
   ENDIF


RETURN(LSretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GKZY           EMGet_UF VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:    2   ╨
*       ╨ Variable:            EMGet_UF                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      219                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gkzy     &&  EMGet_UF VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_UF
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("ESTADO"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL03           EMGet_Juro VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:    3   ╨
*       ╨ Variable:            EMGet_Juro                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      220                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl03     &&  EMGet_Juro VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Juro
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("JUROMES"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL09           verif VALID                        ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:    4   ╨
*       ╨ Variable:            verif                              ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      221                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl09     &&  verif VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION UVerifEmp
PARAMETERS LNemp,LSnome,LNkey
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFempresa
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	LFempresa		= NetArq("empresa")
	IF (LFempresa) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("empresa" ,LFempresa)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	SELECT empresa
	SET ORDER TO TAG empresa
	IF LNkey = 9
	   ON KEY LABEL ESCAPE
	   DO loc_dlog WITH .F.
	   ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	   LNemp	  = empresa.empresa
	ENDIF

	SET NEAR ON
	SEEK LNemp
   	IF LASTKEY() = 27 OR !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LFretorno = .F.
	ELSE
		LSnome  = empresa.sigla
		LFretorno = .T.
	ENDIF
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	=UP_fecha("empresa" ,LFempresa)
RETURN(LFretorno)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL0A           EMrodanroNF VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:    5   ╨
*       ╨ Variable:            EMrodanroNF                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      222                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl0a     &&  EMrodanroNF VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION EMrodanroNF
PARAMETERS LNemp,LStp_process
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Incrementar Numeracao de Nota/Cupom
	*	
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LStp_process...: Processo definido em NFDefProcess
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	=REGLOCK(.T.)
	DO CASE
		CASE LStp_proces = "NOTA" OR LStp_proces = "NOTA/CUPOM"
			REPLACE empresa.nota WITH empresa.nota + 1 && ULTIMA NOTA GERADA
			REPLACE FLAGIMPNF 	WITH 1
		CASE LStp_proces = "CUPOM"
			REPLACE empresa.ult_cupom  WITH ult_cupom + 1
			REPLACE FLAGIMPCPM 	WITH 1
		CASE LStp_proces = "NF.SERVICO"
			REPLACE empresa.Ult_NFsrvc WITH empresa.Ult_NFsrvc + 1
			REPLACE FLAGIMPSRV 	WITH 1

	ENDCASE
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL0B           EMGet_Mora VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:    6   ╨
*       ╨ Variable:            EMGet_Mora                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      223                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl0b     &&  EMGet_Mora VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Mora
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("MORA"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL0C           EMGet_Sigla VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:    7   ╨
*       ╨ Variable:            EMGet_Sigla                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      224                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl0c     &&  EMGet_Sigla VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Sigla
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("SIGLA"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL0Z           EMGet_ECFSerie VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:    8   ╨
*       ╨ Variable:            EMGet_ECFSerie                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      225                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl0z     &&  EMGet_ECFSerie VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_ECFSerie
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("ECF_SERIE"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL14           EMGet_Municipio VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:    9   ╨
*       ╨ Variable:            EMGet_Municipio                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      226                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl14     &&  EMGet_Municipio VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Municipio
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("CIDADE"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL1A           EMGet_TabCst VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   10   ╨
*       ╨ Variable:            EMGet_TabCst                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      227                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl1a     &&  EMGet_TabCst VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_TabCst
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("TAB_CST"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL1F           EMLerRegistro VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   11   ╨
*       ╨ Variable:            EMLerRegistro                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      228                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl1f     &&  EMLerRegistro VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMLerRegistro
PARAMETERS  PrmEmp



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = EMChk_Identidade(PrmEmp)
RETURN(LFretorno)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL1L           EMSalvarRegistro VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   12   ╨
*       ╨ Variable:            EMSalvarRegistro                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      229                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl1l     &&  EMSalvarRegistro VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMSalvarRegistro

	=EMVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !EMExiste()
		SELE &PBEmpresaAlias
		APPEND BLANK
		LFretorno=EMWriteProp()
	ELSE
		SELE &PBEmpresaAlias
		LFretorno=EMWriteProp()
	ENDIF

RETURN(LFretorno)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL1R           EMExiste VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   13   ╨
*       ╨ Variable:            EMExiste                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      230                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl1r     &&  EMExiste VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION EMExiste
	PRIVATE LEmpresa

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=EMVerifyInst()

	LEmpresa    = EMGetPropVT("Empresa")


	SELE &PBEmpresaAlias
	SET ORDER TO TAG empresa
	SEEK Lempresa

	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL1S           EMVerifyInst VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   14   ╨
*       ╨ Variable:            EMVerifyInst                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      231                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl1s     &&  EMVerifyInst VALID
#REGION 9
return
*---------------------------------------------------------------*



FUNCTION EMVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Empresa")


	DO CASE

		CASE TYPE("PBEmpresalias") = "U" ;
		   		OR EMPTY(PBEmpresaAlias) ;
		   		OR !USED(PBEmpresaAlias)
			=EMCreate()					

		CASE !("EMPRESA.DBF" $ DBF(PBEmpresaAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBEmpresaAlias
			=EMCreate()					


		CASE  !(LSPath $ DBF(PBEmpresaAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=EMDestroi()				
			=EMCreate()					
	ENDCASE

	
RETURN(.t.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL1T           EMCreate VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   15   ╨
*       ╨ Variable:            EMCreate                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      232                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl1t     &&  EMCreate VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION EMCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBEmpresaAlias") <> "U" ;
	   		AND !EMPTY(PBEmpresaAlias) ;
	   		AND USED(PBEmpresaAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBEmpresaAlias

	IF USED("Empresa")
	     =NetArqAgain("Empresa")
	     PBEmpresaAlias     = Alias()
	ELSE
	     =NetArqAgain("Empresa")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Empresa")
	     PBEmpresaAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBEmpresaAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTEmpresa[LMaxDim]
    PUBLIC DIMENSION VDEmpresa[2,3]			&& VETOR PARA PROPRIEDADES
	*-----------------------------------------------------------*
	=EMReadProperty()
	=EMSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL1U           EMDestroi VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   16   ╨
*       ╨ Variable:            EMDestroi                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      233                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl1u     &&  EMDestroi VALID
#REGION 9
return
*---------------------------------------------------------------*


FUNCTION EMDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBEmpresaAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBDocFiscaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBDocFiscaAlias
	*  3- Se aplicar um FECHAMENTO a PBDocFiscaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBDocFiscaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBEmpresaAlias)) OR ;
	   !("EMPRESA.DBF" $ DBF(PBEmpresaAlias))

		RELEASE PBEmpresaAlias
    	RELEASE VTEmpresa
	    RELEASE VDEmpresa
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBEmpresaAlias) AND USED(PBEmpresaAlias)
		SELECT &PBEmpresaAlias
		USE
	ENDIF	
	RELEASE PBEmpresaAlias
    RELEASE VTEmpresa
    RELEASE VDEmpresa

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL2H           EMReadProp VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   17   ╨
*       ╨ Variable:            EMReadProp                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      234                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl2h     &&  EMReadProp VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION EMReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=EMVerifyInst()

	SELE &PBEmpresaAlias
	SCATTER TO VTEmpresa
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL2N           EMSetDerivadas VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   18   ╨
*       ╨ Variable:            EMSetDerivadas                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      235                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl2n     &&  EMSetDerivadas VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION EMSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

**	=EMVerifyInst()
	*--------------------------------------------------------------*
    VDEmpresa(1,1) = "NAOINFORMADO"
   	VDEmpresa(1,2) = 0
   	VDEmpresa(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL2S           EMSetPropVT VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   19   ╨
*       ╨ Variable:            EMSetPropVT                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      236                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl2s     &&  EMSetPropVT VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION EMSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

**	=EMVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,PrmValue,;
						    PBEmpresaAlias,VTEmpresa,VDEmpresa)

RETURN(Lvalue)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL2Y           EMGetPropVT VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   20   ╨
*       ╨ Variable:            EMGetPropVT                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      237                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl2y     &&  EMGetPropVT VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION EMGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

**	=DFVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,PBEmpresaAlias,VTEmpresa,VDEmpresa)

RETURN(Lvalue)





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL34           EMChk_Identidade VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   21   ╨
*       ╨ Variable:            EMChk_Identidade                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      238                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl34     &&  EMChk_Identidade VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMChk_Identidade
PARAMETERS  PrmEmp


	PRIVATE LFretorno
	LFretorno = .t.



	=EMVerifyInst()

    =EMSetPropVT("EMPRESA",PrmEmp)
	LFretorno=EMFind()

RETURN(LFretorno)





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL3A           EMFind VALID                       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   22   ╨
*       ╨ Variable:            EMFind                             ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      239                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl3a     &&  EMFind VALID
#REGION 9
return
*---------------------------------------------------------------*
FUNCTION EMFind

	PRIVATE Lcodigo
	PRIVATE LFreturn

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=EMVerifyInst()

	Lcodigo   = EMGetPropVT("EMPRESA")

	SELE &PBEmpresaAlias
	SET ORDER TO TAG empresa
	SEEK Lcodigo

	IF FOUND()
		=EMReadProperty()
		=EMSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)






*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL3B           EMGetFieldValue VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   23   ╨
*       ╨ Variable:            EMGetFieldValue                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      240                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl3b     &&  EMGetFieldValue VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION EMGetFieldValue
PARAMETERS  PrmEmp,PrmField			


	IF !EMChk_Identidade(PrmEmp)
		DO WHILE .T.
			=UPerrosys("Chamada GetFieldValue para Reg. Inexistente!")
		ENDDO
	ENDIF				

RETURN(EMGetPropVT(PrmField))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL3C           EM_Refresh VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   24   ╨
*       ╨ Variable:            EM_Refresh                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      241                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl3c     &&  EM_Refresh VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EM_Refresh
PARAMETERS  PrmEmpresa
	

	PRIVATE LFreturn

	=EMVerifyInst()


	= EMSetPropVT("Empresa"   ,PrmEmpresa)

	*----------------------------------------------------------------*


	=EMFind()
	
RETURN(.t.)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL3D           EMWriteProp VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   26   ╨
*       ╨ Variable:            EMWriteProp                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      242                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl3d     &&  EMWriteProp VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION EMWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=EMVerifyInst()

	SELE &PBEmpresaAlias
	=RLOCK()
	GATHER FROM  VTEmpresa
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL48           EMGetAlias VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   28   ╨
*       ╨ Variable:            EMGetAlias                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      243                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl48     &&  EMGetAlias VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION EMGetAlias

	=EMVerifyInst()

RETURN(PBEmpresaAlias)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL4E           EMMarcaFlgNF VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   30   ╨
*       ╨ Variable:            EMMarcaFlgNF                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      244                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl4e     &&  EMMarcaFlgNF VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION EMMarcaFlgNF
PARAMETERS LNemp,PrmNivelProcesso
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Incrementar Flag Nota/Cupom
	*	
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	=REGLOCK(.T.)

	REPLACE FLAGIMPNF 	WITH PrmNivelProcesso

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL4L           EMGet_ECFModelo VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         EMPRESA,     Record Number:   31   ╨
*       ╨ Variable:            EMGet_ECFModelo                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      245                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl4l     &&  EMGet_ECFModelo VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_ECFModelo
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("TIPO_ECF"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL4R           CLVerifyInst VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:    2  ╨
*       ╨ Variable:            CLVerifyInst                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      246                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl4r     &&  CLVerifyInst VALID
#REGION 10
return
*---------------------------------------------------------------*



FUNCTION CLVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Clientes")


	DO CASE

		CASE TYPE("PBClientesAlias") = "U" ;
		   		OR EMPTY(PBClientesAlias) ;
		   		OR !USED(PBClientesAlias)
			=CLCreate()					

		CASE !("CLIENTES.DBF" $ DBF(PBClientesAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBClientesAlias
			=CLCreate()					


		CASE  !(LSPath $ DBF(PBClientesAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=CLDestroi()				
			=CLCreate()					
	ENDCASE

	
RETURN(.t.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL4S           CLCreate VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:    3  ╨
*       ╨ Variable:            CLCreate                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      247                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl4s     &&  CLCreate VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CLCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBClientesAlias") <> "U" ;
	   		AND !EMPTY(PBClientesAlias) ;
	   		AND USED(PBClientesAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBClientesAlias

	IF USED("Clientes")
	     =NetArqAgain("Clientes")
	     PBClientesAlias     = Alias()
	ELSE
	     =NetArqAgain("Clientes")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Clientes")
	     PBClientesAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBClientesAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTClientes[LMaxDim]&& VETOR PARA CAMPOS DA TABELA
    PUBLIC DIMENSION VDClientes[2,3]	&& VETOR PARA CAMPOS DERIVADAS
    PUBLIC DIMENSION VFClientes[1]      && VETOR CABECALHO DOS CAMPOS
    PUBLIC DIMENSION VCClientes[8,3]	&& VETOR PARA CONFIGURACOES


	=AFIELDS(VFClientes)



	*-----------------------------------------------------------*
	=CLReadProperty()
	=CLSetDerivadas()
	=CLSetConfig()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL4T           CLDestroi VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:    4  ╨
*       ╨ Variable:            CLDestroi                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      248                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl4t     &&  CLDestroi VALID
#REGION 10
return
*---------------------------------------------------------------*


FUNCTION CLDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBClientesAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBClientesAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBClientesAlias
	*  3- Se aplicar um FECHAMENTO a PBClientesAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBClientesAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBClientesAlias)) OR ;
	   !("CLIENTES.DBF" $ DBF(PBClientesAlias))

		RELEASE PBClientesAlias
    	RELEASE VTClientes
	    RELEASE VDClientes
		RELEASE VFClientes
		RELEASE VCClientes
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBClientesAlias) AND USED(PBClientesAlias)
		SELECT &PBClientesAlias
		USE
	ENDIF	
	RELEASE PBClientesAlias
    RELEASE VTClientes
    RELEASE VDClientes
	RELEASE VFClientes
	RELEASE VCClientes

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL4U           CLReadProp VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:    5  ╨
*       ╨ Variable:            CLReadProp                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      249                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl4u     &&  CLReadProp VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CLReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBClientesAlias
	SCATTER TO VTClientes
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL5H           CLSetDerivadas VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:    6  ╨
*       ╨ Variable:            CLSetDerivadas                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      250                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl5h     &&  CLSetDerivadas VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CLSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDClientes(1,1) = "NAOINFORMADO"	&& TITULO	
   	VDClientes(1,2) = 0					&& VALOR
   	VDClientes(1,3) = .F.				&& FLAG .T. => FOI CARREGADO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL5N           CLSetPropVT VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:    7  ╨
*       ╨ Variable:            CLSetPropVT                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      251                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl5n     &&  CLSetPropVT VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CLSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBClientesAlias,;
						    VTClientes,;
						    VDClientes,;
						    VFClientes,;
						    VCClientes)

RETURN(Lvalue)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL5T           CLGetPropVT VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:    8  ╨
*       ╨ Variable:            CLGetPropVT                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      252                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl5t     &&  CLGetPropVT VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CLGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBClientesAlias,;
	            VTClientes,;
	            VDClientes,;
			    VFClientes,;
			    VCClientes)

RETURN(Lvalue)





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL5Z           CLChk_Identidade VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:    9  ╨
*       ╨ Variable:            CLChk_Identidade                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      253                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl5z     &&  CLChk_Identidade VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLChk_Identidade

PARAMETERS PrmCliente,PrmInscricao
	PRIVATE LFretorno
	LFretorno = .t.

	=CLVerifyInst()



    =CLSetPropVT("CLIENTE",PrmCliente)
	IF TYPE("PrmInscricao") $ "U/L" OR EMPTY(PrmInscricao)
	    =CLSetPropVT("INSCRICAO",.F.)
	    =CLSetPropVT("CHAVE DE LEITURA","CLIENTE")
	ELSE
	    =CLSetPropVT("INSCRICAO",PrmInscricao)
	    =CLSetPropVT("CHAVE DE LEITURA","CLIE_INSCR")
	ENDIF

	LFretorno=CLFind()
RETURN(LFretorno)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL65           CLFind VALID                       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   10  ╨
*       ╨ Variable:            CLFind                             ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      254                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl65     &&  CLFind VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CLFind
	PRIVATE LCliente
	PRIVATE LInscricao
	PRIVATE LNome
	PRIVATE LFreturn
	PRIVATE LSchaveAcesso
	

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=CLVerifyInst()




	SELE &PBClientesAlias
	LSchaveAcesso  =CLGetPropVT("CHAVE DE LEITURA")


	DO CASE
		CASE UPPER(LSchaveAcesso) = "CLIENTE"
			LCliente    = CLGetPropVT("Cliente")
			SET ORDER TO TAG CLIENTE
			SEEK LCliente

		CASE UPPER(LSchaveAcesso) = "CLIE_INSCR"
			LCliente    = CLGetPropVT("Cliente")
			LInscricao  = CLGetPropVT("Inscricao")
			SET ORDER TO TAG CLIE_Inscr
			SEEK STR(Lcliente,14)+Linscricao

		CASE UPPER(LSchaveAcesso) = "NOME"
			LNome  = CLGetPropVT("NOME")
			SET ORDER TO TAG NOME
			SET NEAR ON
			SEEK RTRIM(LNome)
			SET NEAR OFF
			LNome = LEFT( &PBClientesAlias .nome ,45)
			SEEK LNome
		OTHERWISE
			SET ORDER TO TAG CLIENTE
			SEEK LCliente

	ENDCASE
	IF FOUND()
		=CLReadProperty()
		=CLSetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LFreturn)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL6C           CLGetFieldValue VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   11  ╨
*       ╨ Variable:            CLGetFieldValue                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      255                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl6c     &&  CLGetFieldValue VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CLGetFieldValue
PARAMETERS  PrmCliente,;
			PrmInscricao,;
			PrmField

	=CLChk_Identidade(PrmCliente,PrmInscricao)

RETURN(CLGetPropVT(PrmField))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL6D           CL_Refresh VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   12  ╨
*       ╨ Variable:            CL_Refresh                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      256                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl6d     &&  CL_Refresh VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CL_Refresh
PARAMETERS PrmCliente,PrmInscricao

	PRIVATE LFretorno
	LFretorno = .t.

	=CLVerifyInst()

    =CLSetPropVT("CLIENTE",PrmCliente)

	IF TYPE("PrmInscricao") $ "U/L" OR EMPTY(PrmInscricao)
	    =CLSetPropVT("INSCRICAO",.F.)
	    =CLSetPropVT("CHAVE DE LEITURA","CLIENTE")
	ELSE
	    =CLSetPropVT("INSCRICAO",PrmInscricao)
	    =CLSetPropVT("CHAVE DE LEITURA","CLIE_INSCR")
	ENDIF



	LFretorno=CLFind()
RETURN(LFretorno)






*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL6E           CLLerRegistro VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   14  ╨
*       ╨ Variable:            CLLerRegistro                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      257                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl6e     &&  CLLerRegistro VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLLerRegistro
PARAMETERS PrmCliente,PrmInscricao



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = CLChk_Identidade(PrmCliente,PrmInscricao)
RETURN(LFretorno)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL6F           CLWriteProp VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   15  ╨
*       ╨ Variable:            CLWriteProp                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      258                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl6f     &&  CLWriteProp VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CLWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBClientesAlias
	=RLOCK()
	GATHER FROM  VTClientes
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL70           CLSalvarRegistro VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   16  ╨
*       ╨ Variable:            CLSalvarRegistro                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      259                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl70     &&  CLSalvarRegistro VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLSalvarRegistro

	=CLVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !CLExiste()
		SELE &PBClientesAlias
		APPEND BLANK
		LFretorno=CLWriteProp()
	ELSE
		SELE &PBClientesAlias
		LFretorno=CLWriteProp()
	ENDIF

RETURN(LFretorno)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL76           CLExiste VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   17  ╨
*       ╨ Variable:            CLExiste                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      260                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl76     &&  CLExiste VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CLExiste


	PRIVATE LCliente, LInscricao
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=CLVerifyInst()


	LCliente    = CLGetPropVT("Cliente")
	LInscricao  = CLGetPropVT("Inscricao")


	SELE &PBClientesAlias

	IF TYPE("LInscricao") $ "U/L" OR EMPTY(LInscricao)
		SET ORDER TO TAG CLIENTE
		SEEK LCliente
	ELSE
		SET ORDER TO TAG CLIE_Inscr
		SEEK STR(Lcliente,14)+Linscricao
	ENDIF
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LFreturn)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL7D           CLGetAlias VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   19  ╨
*       ╨ Variable:            CLGetAlias                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      261                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl7d     &&  CLGetAlias VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CLGetAlias

	=CLVerifyInst()

RETURN(PBClientesAlias)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL7I           CLSetConfig VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   20  ╨
*       ╨ Variable:            CLSetConfig                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      262                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl7i     &&  CLSetConfig VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CLSetConfig

	*--------------------------------------------------------------*
    VCClientes(1,1) = "REG_STATE" && INSERT/EDICAO/BROWSER/
   	VCClientes(1,2) = ""
   	VCClientes(1,3) = .T.
	*--------------------------------------------------------------*
    VCClientes(2,1) = "CHV_LER" && p/ leitura do ultimo reg + 1
   	VCClientes(2,2) = ""
   	VCClientes(2,3) = .T.
	*--------------------------------------------------------------*
    VCClientes(3,1) = "CHV_COMPARA" && p/ leitura do ultimo reg + 1
   	VCClientes(3,2) = ""
   	VCClientes(3,3) = .T.
	*--------------------------------------------------------------*
    VCClientes(4,1) = "CHV_BROW" && p/ leitura do ultimo reg + 1
   	VCClientes(4,2) = ""
   	VCClientes(4,3) = .T.
	*--------------------------------------------------------------*
    VCClientes(5,1) = "ISEDITING" && p/ leitura do ultimo reg + 1
   	VCClientes(5,2) = .F.
   	VCClientes(5,3) = .T.
	*--------------------------------------------------------------*
    VCClientes(6,1) = "ISADDING" && p/ leitura do ultimo reg + 1
   	VCClientes(6,2) = .F.
   	VCClientes(6,3) = .T.
	*--------------------------------------------------------------*
    VCClientes(7,1) = "ISREADING" && p/ leitura do ultimo reg + 1
   	VCClientes(7,2) = .F.
   	VCClientes(7,3) = .T.
	*--------------------------------------------------------------*
    VCClientes(8,1) = "CHAVE DE LEITURA" && TAG DO CHAVE USADA EM FIND
   	VCClientes(8,2) = "CLIENTE"
   	VCClientes(8,3) = .T.
	*--------------------------------------------------------------*
	
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL7P           CLBtnVal VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   21  ╨
*       ╨ Variable:            CLBtnVal                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      263                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl7p     &&  CLBtnVal VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLBtnVal
PARAMETERS PrmTecla

PRIVATE Lchv_Ler
PRIVATE Lchv_Compara
PRIVATE Lchv_Brow
PRIVATE LCliente


	=CLVerifyInst()

	Lchv_ler    = CLGetPropVT("CHV_LER")
	Lchv_compara= CLGetPropVT("CHV_COMPARA")
	Lchv_brow    = CLGetPropVT("CHV_BROW")

	
	SELE &PBClientesAlias
	SET ORDER TO TAG NOME
	DO CASE
	
		CASE PrmTecla = "LOCATE"

			LCliente     = CLGetPropVT("CLIENTE")

			=CLView(LCliente)
			SELE &PBClientesAlias
			SCATTER MEMVAR MEMO

			
		OTHERWISE

		    DO btn_val with PrmTecla,;
	   			       Lchv_ler,;
	   			       Lchv_compara,;
	   			       Lchv_brow,;
	   			       .T.,;
	   			       .T.
	   			
	ENDCASE
	   			
	=CLSetPropVT("ISEDITING",ISEDITING)
	=CLSetPropVT("ISADDING",ISADDING)
	=CLSetPropVT("ISREADING",ISREADING)
	   			
RETURN(.t.)




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL7V           CLTrtChvCPFCNPJINS VALID           ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   22  ╨
*       ╨ Variable:            CLTrtChvCPFCNPJINS                 ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      264                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl7v     &&  CLTrtChvCPFCNPJINS VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLTrtChvCPFCNPJINS
PARAMETERS PrmCliente,PrmInscricao

	PRIVATE LFretorno
	LFretorno = .t.

	=CLVerifyInst()

    =CLSetPropVT("CLIENTE",PrmCliente)
	IF TYPE("PrmInscricao") $ "U/L" OR EMPT(PrmInscricao)
	    =CLSetPropVT("INSCRICAO",.F.)
	    =CLSetPropVT("CHAVE DE LEITURA","CLIENTE")
	ELSE
	    =CLSetPropVT("INSCRICAO",PrmInscricao)
	    =CLSetPropVT("CHAVE DE LEITURA","CLIE_INSCR")
	ENDIF
	*--------------------------------------------------------------*

	LFretorno=CLFind()
	IF isadding
		IF LFretorno
			IF !fox_alert("Cliente Ja Cadastrado. DUPLICAR ?")
				RETURN(.F.)
			ENDIF
			wp_msg = 'Informe Seu Codigo e sua Senha p/ DUPLICAR..'
			LNusuario = nUsr
			BTMP   =  'usuario.usuario = LNusuario '
			LNusr_ret = 0
			DO obj_prmt.SPR WITH   wp_msg , Btmp
			IF LNusr_ret <>  0
			   RETURN(.T.)
			ENDIF
		ENDIF
	ENDIF

	SELE &PBClientesAlias
RETURN(UPtratachv())





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL7W           CLBuscaNOMEAprox VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   23  ╨
*       ╨ Variable:            CLBuscaNOMEAprox                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      265                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl7w     &&  CLBuscaNOMEAprox VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLBuscaNOMEAprox
PARAMETERS PrmNOME



	PRIVATE LFretorno
	LFretorno = .t.

	=CLVerifyInst()

    =CLSetPropVT("NOME",PrmNOME)
    =CLSetPropVT("CHAVE DE LEITURA","NOME")
	*--------------------------------------------------------------*

	LFretorno=CLFind()

	SELE &PBClientesAlias
RETURN(UPtratachv())





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL7X           CLScatter VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   26  ╨
*       ╨ Variable:            CLScatter                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      266                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl7x     &&  CLScatter VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLScatter

	PRIVATE LFretorno
	LFretorno = .t.

	=CLVerifyInst()
	SELE &PBClientesAlias
	SCATTER MEMVAR MEMO
RETURN(.T.)






*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL7Y           CLView VALID                       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   27  ╨
*       ╨ Variable:            CLView                             ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      267                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl7y     &&  CLView VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLView
PARAMETER PrmCliente,PrmOrdem

	PRIVATE LerNome
	LerNnome =""
	PRIVATE LerCPF_CNPJ
	LerCPF_CNPJ =""

	PRIVATE PrmVlrLocate && VARIAVEL USADA PARA LOCATE
	                     && E PRESERVADA PARA USO NO CONTINUE
	                     && ELA E PUBLICA PARA:
	                     && MNView, MNLOCATE e MNContinue

	PrmVlrLocate = ""


	=W_DEFPROC("rotinas.spr")
	PRIVATE Lretorno
	=CLVerifyInst()
	*--------------------------------------------------------------*
	IF TYPE("PrmCliente") <> "N"
		PrmCliente = 0
	ENDIF
	
	IF TYPE("PrmOrdem") <> "C" OR EMPTY(PrmOrdem)
		PrmOrdem = "NOME"
	ENDIF

	SELE  &PBClientesAlias


	DO CASE
		CASE PrmOrdem = "NOME"
			SET ORDER TO TAG NOME
		OTHERWISE
			SET ORDER TO TAG CLIENTE
	ENDCASE




	=UPLocDefWindow()

	ON KEY LABEL L DO CLLOCATE WITH "NOME", LerNnome
	ON KEY LABEL l DO CLLOCATE WITH "NOME", LerNnome
	ON KEY LABEL N DO CLLOCATE WITH "NOME", LerNnome
	ON KEY LABEL n DO CLLOCATE WITH "NOME", LerNnome
	ON KEY LABEL C DO CLLOCATE WITH "CLIENTE", LerCPF_CNPJ
	ON KEY LABEL c DO CLLOCATE WITH "CLIENTE", LerCPF_CNPJ

	ON KEY LABEL CTRL-G DO CLCONTINUE


	BROWSE  FIELDS;
			CLIENTE;
			:H="CPF_CNPJ - (C)",;
			NOME;
			:H="NOME - (N)";
			REST ;
		WINDOW wzlocate ;
    		NOAPPEND NODELETE NOEDIT  ;
    			COLOR SCHEME 10



	=UPLocRelWindow()


	ON KEY LABEL CTRL-G
	ON KEY LABEL L
	ON KEY LABEL l
	ON KEY LABEL N
	ON KEY LABEL n
	ON KEY LABEL C
	ON KEY LABEL c



	Lretorno = &PBClientesAlias .CLIENTE


	=CL_Refresh(Lretorno)
		
	*--------------------------------------------------------------*
RETURN(Lretorno)


PROCEDURE  CLCONTINUE

	CONTINUE
	IF EOF()
		GO TOP
		CONTINUE
	ENDIF

RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL8P           CLLOCATE VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   28  ╨
*       ╨ Variable:            CLLOCATE                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      268                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl8p     &&  CLLOCATE VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*


FUNCTION CLLOCATE
PARAMETERS PrmFields,PrmUltimaPesquisa


	DO LOC_BROW.SPR with PrmFields,PrmUltimaPesquisa



	PrmVlrLocate = PrmUltimaPesquisa
	
	PrmVlrLocate = ALLTRIM(PrmVlrLocate)
	PrmVlrLocate = UPPER(PrmVlrLocate)
	
	DO CASE
		CASE  PrmFields = "NOME"
			LOCATE FOR NOME >= PrmVlrLocate

		CASE  PrmFields = "CLIENTE"
			LOCATE FOR ALLTRIM(PrmVlrLocate) $ ALLTRIM(STR(CLIENTE,14))
	ENDCASE
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL8V           CLAtribuiIBGE VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   31  ╨
*       ╨ Variable:            CLAtribuiIBGE                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      269                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl8v     &&  CLAtribuiIBGE VALID
#REGION 10
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLAtribuiIBGE



	PPNOME = POPUP()

	DEACTIVATE POPUP &PPNOME
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	*--------------------------------------------------------------*


	PrmVlrLocate = ""


	=W_DEFPROC("rotinas.spr")
	PRIVATE Lretorno
	=CLVerifyInst()
	*--------------------------------------------------------------*

	SELE  &PBClientesAlias

	=CLBtnVal('TOP')

	=UPCriatermo()
	=UPIniciatermo()


	* =CLBtnVal('TOP')

	SELE  &PBClientesAlias
	GO TOP
	
	LFsegue = .t.

	CLEAR TYPEAHEAD
	=INKEY(0.1)
	DO WHILE !EOF() AND	LFsegue

		=UPtermo() && DEMONSTRA PROGRESSAO E  VERIFICA PEDIDO DE
				   && INTERRUPCAO E SET EM LFsegue = .F.

		
		=W_DEFPROC("MUNICPIO.SPR")
		m.muni_ibge = MNGet_MUNI_IBGE( &PBClientesAlias .Estado,;
		                               &PBClientesAlias .cidade)
		IF m.muni_ibge > 0
			SELE  &PBClientesAlias
			=rlock()
			REPLACE MUNI_IBGE WITH M.MUNI_IBGE
		ENDIF

		SELE  &PBClientesAlias
		SKIP
		
	ENDDO
	=UPEncerratermo()

	=CL_Refresh(  &PBClientesAlias .CLIENTE)
		
	*--------------------------------------------------------------*
	POP KEY 			&& reabilita teclas de atalho def. anteriormente
	ACTIVATE POPUP &PPNOME

RETURN(" ")




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL92           CLGSetAreaAlias VALID              ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIENTES,     Record Number:   32  ╨
*       ╨ Variable:            CLGSetAreaAlias                    ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      270                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl92     &&  CLGSetAreaAlias VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CLGSetAreaAlias

	=CLVerifyInst()
	SELE &PBClientesAlias

RETURN(PBClientesAlias)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL98           CLGetUFOrigem VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:    2   ╨
*       ╨ Variable:            CLGetUFOrigem                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      271                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl98     &&  CLGetUFOrigem VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION CLGetUFOrigem
PARAMETERS PrmCliente,PrmInscricao

	=CLChk_Identidade(PrmCliente,PrmInscricao)

RETURN(CLGetPropVT("ESTADO"))


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL9D           CLLocCli VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:    3   ╨
*       ╨ Variable:            CLLocCli                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      272                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl9d     &&  CLLocCli VALID
#REGION 11
return

*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLLocCli

PARAMETERS LNemp,LNkey,LNcliente,LSinscricao

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Localizar um cliente
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite localizar um cliente ou
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LNkey..........: Codigo da Tecla de Saida do Campo
	*                        e Ultima tecla retornada desta funcao
	*                        para uso na rotina chamadora ex:
	*                        o operador tecla ESC para desistir de
	*                        qualquer escolha no browse do clientes
	*		LNcliente......: Codigo do Cliente
	*		LSinscricao....: Campo para diferenciar clientes com
	*						duas inscricoes (Ocorre com fazendas)
	*						dois cadastros com mesmo CPF e inscricao
	*						e enderecos diferentes
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:- REGISTRO DO CLIENTE  POSICIONADO para
	*					ser tratado na rotina
	*				- .F. Para codigo nao localizado ou nao aceito
	*				- .T. Para codigo Localizado
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFretorno
	PRIVATE LSmsg
	*-----------------------------------------------------------*
	PRIVATE LSalias
	PRIVATE ARQ_Clientes, ALS_Clientes
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	IF !USED("CLIENTES")
	    ARQ_Clientes    = NetArq("CLIENTES")
	    ALS_Clientes   	= Alias()
	ENDIF
	*-----------------------------------------------------------*
	SELECT clientes
	SET ORDER TO TAG cliente
	IF LNkey = 9
	   	ON KEY LABEL ESCAPE
	   	DO loc_dlog WITH .T.
	   	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	   	IF LASTKEY() <> 27
		   	LNcliente	= 	clientes.cliente
			LSinscricao	=	clientes.inscricao
		ENDIF	
		LNkey 	= LASTKEY()   && PERMITIR TRATAMENTO DA DESISTENCIA
							  && NA ROTINA CHAMADORA
	ENDIF
	*-----------------------------------------------------------*
   	IF LASTKEY() <> 27
		SET NEAR ON
		SEEK LNcliente
		SET NEAR OFF
	    IF FOUND() AND !EMPTY(LSinscricao)
			DO WHILE !EOF() AND LNcliente = clientes.cliente
				IF LSinscricao = clientes.inscricao
					EXIT
				ENDIF
			    SKIP	&& VERIFICA SE E DUPLICADO E CHECA A INSCRICAO
			ENDDO
			IF EOF() OR LNcliente <> clientes.cliente OR ;
		  			LSinscricao <> clientes.inscricao
					SKIP -1			  && PEGAR DADOS DO REG. LOCALIZADP
			ENDIF				  && PRIMEIRO
		ENDIF
		IF LNcliente	= 	clientes.cliente
			LSinscricao	=	clientes.inscricao
		ENDIF
	ENDIF
	*-----------------------------------------------------------*
	*	Critica a tecla
	*-----------------------------------------------------------*
	IF LASTKEY() = 27
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*-----------------------------------------------------------*
	*	Critica a localizacao do registro
	*-----------------------------------------------------------*
	IF (LNcliente = 0 OR !FOUND() )
		IF (LNcliente <> 0 AND !FOUND() )
			LSmsg = "Cliente nao cadastrado. Informe "+;
						"dados ou Solicite cadastro. <ENTER>"
			=UPbeeps(.F.,LSmsg)
		ENDIF
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL9E           CLSetControleCredito VALID         ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:    4   ╨
*       ╨ Variable:            CLSetControleCredito               ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      273                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl9e     &&  CLSetControleCredito VALID
#REGION 11
return

*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLGrvControleCredito

PARAMETERS CLIENTE_ID, CR_ANTIGO, CR_NOVO, RESPONSAVE

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Gravar Registro de Controle de Alteracoes de
	*           Credito
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	IF m.cr_antigo = m.cr_novo	&& So Registrar Qdo houver Alteracao
		RETURN(.T.)
	ENDIF
	
	*-----------------------------------------------------------*
	PRIVATE LSalias
	PRIVATE ARQ_CtrlCred, ALS_CtrlCred
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
    ARQ_CtrlCred    = NetArqAgain("CTRLCRED")
    ALS_CtrlCred   	= Alias()
	*------------------------------------------------------------*
	m.DT_REGISTR	= date()

   	SELE &ALS_CtrlCred
  	SET ORDER TO TAG key_unica
    SEEK STR(m.CLIENTE_ID,14)+DTOS(m.DT_REGISTR)
    IF FOUND()
		m.CR_ANTIGO	= &ALS_CtrlCred .CR_ANTIGO
		=edithand('REGRAVA')
	ELSE
		=edithand('SAVE')
   	ENDIF	

    =up_fecha("&ALS_CtrlCred")

	*------------------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GL9F           CLObterVlrAlteradoCredito VALID    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:    5   ╨
*       ╨ Variable:            CLObterVlrAlteradoCredito          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      274                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gl9f     &&  CLObterVlrAlteradoCredito VALID
#REGION 11
return

*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLObterVlrAlteradoCredito

PARAMETERS PRcliente, PRdata

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Obter o Valor de Ajuste de Credito na
	*  			data especificada
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO  :
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	
	*-----------------------------------------------------------*
	PRIVATE LSalias
	PRIVATE ARQ_CtrlCred, ALS_CtrlCred
	PRIVATE LNvalor
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
    ARQ_CtrlCred    = NetArqAgain("CTRLCRED")
    ALS_CtrlCred   	= Alias()
	*------------------------------------------------------------*

   	SELE &ALS_CtrlCred
  	SET ORDER TO TAG key_unica
    SEEK STR(PRcliente,14) + DTOS(PRdata)
    IF FOUND()
		LNvalor =  &ALS_CtrlCred .CR_NOVO - &ALS_CtrlCred .CR_ANTIGO
	ELSE
		LNvalor =  0
   	ENDIF	

    =up_fecha("&ALS_CtrlCred")

	*------------------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNvalor)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLA1           CLSetUltAtendimento VALID          ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:    6   ╨
*       ╨ Variable:            CLSetUltAtendimento                ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      275                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gla1     &&  CLSetUltAtendimento VALID
#REGION 11
return

*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLSetUltAtendimento

PARAMETERS PrmpCliente,PrmInscricao, PrmData

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Atualiza data do ultimo atendimento do Cliente
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO  :
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	
	*-----------------------------------------------------------*
	PRIVATE LSalias
	PRIVATE ARQ_Clientes, ALS_Clientes
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
    ARQ_Clientes    = NetArqAgain("CLIENTES")
    ALS_Clientes   	= Alias()
	*------------------------------------------------------------*

    SELE &ALS_Clientes
    SET ORDE TO clie_inscr
    SEEK STR(PrmpCliente,14)+PrmInscricao
	IF !FOUND()
	    SET ORDE TO cliente
	    SEEK STR(PrmpCliente,14)
	ENDIF

	IF FOUND()
		=REGLOCK()
		REPLACE ULT_ATEND WITH PrmData
	ENDIF


    =up_fecha("&ALS_Clientes")

	*------------------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLA8           CLSQLSemFidelizacao VALID          ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:    7   ╨
*       ╨ Variable:            CLSQLSemFidelizacao                ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      276                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gla8     &&  CLSQLSemFidelizacao VALID
#REGION 11
return

*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLSQLSemFidelizacao

PARAMETERS PrmpCliente,PrmInscricao, PrmData

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Atualiza data do ultimo atendimento do Cliente
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO  :
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	
	*-----------------------------------------------------------*
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT MAX(DT.DATA) AS SEMANA, ;
	 		0000000000 	AS NOVOS,;
	 		0000000000 	AS CAD_SIMPLES,;
	 		COUNT(*) 	AS CLIENTES,;
			0000000000 	AS NAO_CAD ;
	   FROM Q:\SCGC\COMUM\DATAS   DT, ;
	   		Q:\SCGC\LOJA\CLIENTES CL,;
	   		Q:\SCGC\LOJA\NOTA NFS;
	   WHERE     DT.DATA        = NFS.DATA ;
			 AND NFS.CH_OPERA   = "1" ;
			 AND NFS.STATUS   <> 2 ;
	         AND NFS.FAVORECIDO = CL.CLIENTE ;
	         AND NFS.DATA-30    > CL.DTCAD ;
   	 GROUP BY DT.ANO, DT.SEMANA_DO_  ;
    UNION ;
	SELECT MAX(DT.DATA) AS SEMANA, ;
	 		COUNT(*) 	AS NOVOS,;
	 		0000000000 	AS CAD_SIMPLES,;
	 		0000000000 	AS CLIENTES,;
			0000000000 	AS NAO_CAD ;
	   FROM Q:\SCGC\COMUM\DATAS   DT, ;
	   		Q:\SCGC\LOJA\CLIENTES CL,;
	   		Q:\SCGC\LOJA\NOTA NFS;
	   WHERE     DT.DATA        = NFS.DATA ;
			 AND NFS.CH_OPERA   = "1" ;
			 AND NFS.STATUS   <> 2 ;
	         AND NFS.FAVORECIDO = CL.CLIENTE ;
	         AND NFS.DATA       <= CL.DTCAD+30 ;
   	 GROUP BY DT.ANO, DT.SEMANA_DO_ INTO CURSOR TMP

    SELECT * FROM TMP  UNION ;
	SELECT MAX(DT.DATA) AS SEMANA, ;
	 		0000000000 	AS NOVOS,;
	 		0000000000 	AS CAD_SIMPLES,;
	 		0000000000 	AS CLIENTES,;
			COUNT(*) 	AS NAO_CAD ;
	   FROM Q:\SCGC\COMUM\DATAS   DT, ;
	   		Q:\SCGC\LOJA\NOTA NFS;
	   WHERE     DT.DATA        = NFS.DATA ;
			 AND NFS.CH_OPERA   = "1" ;
			 AND NFS.STATUS   <> 2 ;
	         AND NFS.FAVORECIDO = 0  ;
   	 GROUP BY DT.ANO, DT.SEMANA_DO_ INTO CURSOR TMP1


	SELECT  NFS.FAVORECIDO , ;
			MIN(NFS.DATA)   AS DATA ;
	   FROM Q:\SCGC\LOJA\NOTA NFS;
	   WHERE ;
			     NFS.CH_OPERA   = "1" ;
			 AND NFS.STATUS   <> 2 ;
	         AND NFS.FAVORECIDO > 0  ;
	         AND NFS.FAVORECIDO NOT IN  ;
	                    (SELECT CLIENTE FROM Q:\SCGC\LOJA\CLIENTES)  ;
   	 GROUP BY NFS.FAVORECIDO INTO CURSOR CADSIMPL




    SELECT * FROM TMP1  UNION ;
	SELECT MAX(DT.DATA) AS SEMANA, ;
	 		0000000000 	AS NOVOS,;
	 		COUNT(*) 	AS CAD_SIMPLES,;
	 		0000000000 	AS CLIENTES,;
			0000000000	AS NAO_CAD ;
	   FROM Q:\SCGC\COMUM\DATAS   DT, ;
	   		CADSIMPL  NFS;
	   WHERE     DT.DATA        = NFS.DATA ;
   	 GROUP BY DT.ANO, DT.SEMANA_DO_ INTO CURSOR CLIE_CTR



	SELECT SEMANA, ;
			SUM(NOVOS)       AS NOVOS, ;
			SUM(CLIENTES)    AS CLIENTES, ;
	 		SUM(CAD_SIMPLES) AS CAD_SIMPLES,;
			SUM(NAO_CAD)     AS NAO_CAD ;
	FROM CLIE_CTR GROUP BY SEMANA ;
	INTO TABLE  Q:\SCGC\CONSULTAS\FIDELIZA
    *------------------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLAH           CLSQLMesFidelizacao VALID          ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:    8   ╨
*       ╨ Variable:            CLSQLMesFidelizacao                ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      277                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11glah     &&  CLSQLMesFidelizacao VALID
#REGION 11
return

*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLSQLMesFidelizacao

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Atualiza data do ultimo atendimento do Cliente
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO  :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_datas  , ALS_datas
	PRIVATE ARQ_clientes  , ALS_clientes
	PRIVATE ARQ_nota   , ALS_nota

	LSalias			= ALIAS()

    ARQ_datas  	= NetArqAgain("datas")
    ALS_datas  	= Alias()

    ARQ_Nota  	= NetArqAgain("Nota")
    ALS_Nota  	= Alias()

    ARQ_Clientes  	= NetArqAgain("Clientes")
    ALS_Clientes  	= Alias()
	
	*-----------------------------------------------------------*
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SET TALK ON
	SELECT * FROM &ALS_DATAS GROUP BY ANO,MES INTO CURSOR CRSDATA



	SELECT MAX(DT.DATA) AS SEMANA, ;
	 		0000000000 	AS NOVOS,;
	 		0000000000 	AS CAD_SIMPLES,;
	 		COUNT(*) 	AS CLIENTES,;
			0000000000 	AS NAO_CAD ;
	   FROM CRSDATA   DT, ;
	   		&ALS_CLIENTES CL,;
	   		&ALS_NOTA NFS;
	   WHERE ;
			 	 DT.ANO  = YEAR(NFS.DATA) ;
			 AND DT.MES  = MONTH(NFS.DATA) ;
			 AND NFS.CH_OPERA   = "1" ;
			 AND NFS.STATUS   <> 2 ;
	         AND NFS.FAVORECIDO = CL.CLIENTE ;
	         AND NFS.DATA-30    > CL.DTCAD ;
   	 GROUP BY DT.ANO, DT.MES  ;
    UNION ;
	SELECT MAX(DT.DATA) AS SEMANA, ;
	 		COUNT(*) 	AS NOVOS,;
	 		0000000000 	AS CAD_SIMPLES,;
	 		0000000000 	AS CLIENTES,;
			0000000000 	AS NAO_CAD ;
	   FROM CRSDATA   DT, ;
	   		&ALS_CLIENTES CL,;
	   		&ALS_NOTA NFS;
	   WHERE ;
			 	 DT.ANO  = YEAR(NFS.DATA) ;
			 AND DT.MES  = MONTH(NFS.DATA) ;
			 AND NFS.CH_OPERA   = "1" ;
			 AND NFS.STATUS   <> 2 ;
	         AND NFS.FAVORECIDO = CL.CLIENTE ;
	         AND NFS.DATA       <= CL.DTCAD+30 ;
   	 GROUP BY DT.ANO, DT.MES INTO CURSOR TMP


    SELECT * FROM TMP  UNION ;
	SELECT MAX(DT.DATA) AS SEMANA, ;
	 		0000000000 	AS NOVOS,;
	 		0000000000 	AS CAD_SIMPLES,;
	 		0000000000 	AS CLIENTES,;
			COUNT(*) 	AS NAO_CAD ;
	   FROM CRSDATA   DT, ;
	   		&ALS_NOTA NFS;
	   WHERE ;
			 	 DT.ANO  = YEAR(NFS.DATA) ;
			 AND DT.MES  = MONTH(NFS.DATA) ;
			 AND NFS.CH_OPERA   = "1" ;
			 AND NFS.STATUS   <> 2 ;
	         AND NFS.FAVORECIDO = 0  ;
   	 GROUP BY DT.ANO, DT.MES INTO CURSOR TMP1


	SELECT  NFS.FAVORECIDO , ;
			MIN(NFS.DATA)   AS DATA ;
	   FROM	&ALS_NOTA NFS;
	   WHERE ;
			     NFS.CH_OPERA   = "1" ;
			 AND NFS.STATUS   <> 2 ;
	         AND NFS.FAVORECIDO > 0  ;
	         AND NFS.FAVORECIDO NOT IN  ;
                    (SELECT CLIENTE FROM &ALS_CLIENTES)  ;
   	 GROUP BY NFS.FAVORECIDO INTO CURSOR CADSIMPL


    SELECT * FROM TMP1  UNION ;
	SELECT MAX(DT.DATA) AS SEMANA, ;
	 		0000000000 	AS NOVOS,;
	 		COUNT(*) 	AS CAD_SIMPLES,;
	 		0000000000 	AS CLIENTES,;
			0000000000	AS NAO_CAD ;
	   FROM CRSDATA   DT, ;
	   		CADSIMPL  NFS;
	   WHERE ;
			 	 DT.ANO  = YEAR(NFS.DATA) ;
			 AND DT.MES  = MONTH(NFS.DATA) ;
   	 GROUP BY DT.ANO, DT.MES INTO CURSOR CLIE_CTR


	if "CENTRAL" $ UPPER(wp_dirdat)
		SELECT SEMANA AS MES, ;
			SUM(NOVOS)       AS NOVOS, ;
			SUM(CLIENTES)    AS CLIENTES, ;
	 		SUM(CAD_SIMPLES) AS CAD_SIMPLES,;
			SUM(NAO_CAD)     AS NAO_CAD ;
		FROM CLIE_CTR GROUP BY SEMANA ;
		INTO TABLE  Q:\SCGC\CONSULTAS\FDLZMESC
	ELSE
		SELECT SEMANA AS MES, ;
			SUM(NOVOS)       AS NOVOS, ;
			SUM(CLIENTES)    AS CLIENTES, ;
	 		SUM(CAD_SIMPLES) AS CAD_SIMPLES,;
			SUM(NAO_CAD)     AS NAO_CAD ;
		FROM CLIE_CTR GROUP BY SEMANA ;
		INTO TABLE  Q:\SCGC\CONSULTAS\FDLZMESL
	ENDIF
	

    *------------------------------------------------------------------*
	SET TALK OFF

   	=up_fecha("&ALS_datas")
   	=up_fecha("&ALS_clientes")
   	=up_fecha("&ALS_nota")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLAR           CLCalc_Cgc VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:    9   ╨
*       ╨ Variable:            CLCalc_Cgc                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      278                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11glar     &&  CLCalc_Cgc VALID
#REGION 11
RETURN


*--------------------------------------------------------------------*
* objetivo : consiste CGC ou CPF                                     *
*--------------------------------------------------------------------*
FUNCTION CLCalc_Cgc
   parameter p_cgc
   PRIVATE TMPcgccpf
   PRIVATE LNcpfcnpj


   TMPcgccpf= alltrim(str(p_cgc,14))

   cgc_aux  = strtran(str(p_cgc,14)," ","0")



   *------------------------------------------------*
    PRIVATE ARQ_CPF_CNPJ,ALS_CPF_CNPJ

    ARQ_CPF_CNPJ = NetArqAgain("CPF_CNPJ")
    ALS_CPF_CNPJ = Alias()


	LNcpfcnpj = INT(VAL( cgc_aux ))

    SELE &ALS_CPF_CNPJ
  	SET ORDER TO TAG CPF_CNPJ
    SEEK  cgc_aux
    IF FOUND()
	   Lreturn =  &ALS_CPF_CNPJ .tp_pessoa
	   	=up_fecha("&ALS_CPF_CNPJ")
	    return(Lreturn)
    ENDIF


   	=up_fecha("&ALS_CPF_CNPJ")

   *------------------------------------------------*



   if p_cgc = 0
     return "3"			&& INVALIDO
   endif

*   IF "1111111" $ cgc_aux
*     return "3"			&& INVALIDO
*   endif

*   IF "2222222" $ cgc_aux
*     return "3"			&& INVALIDO
*   endif

*   IF "3333333" $ cgc_aux
*     return "3"			&& INVALIDO
*   endif

*   IF "4444444" $ cgc_aux
*     return "3"			&& INVALIDO
*   endif

*   IF "5555555" $ cgc_aux
*     return "3"			&& INVALIDO
*   endif

*   IF "6666666" $ cgc_aux
*     return "3"			&& INVALIDO
*   endif
*   IF "7777777" $ cgc_aux
*     return "3"			&& INVALIDO
*   endif
*   IF "8888888" $ cgc_aux
*     return "3"			&& INVALIDO
*   endif
*   IF "9999999" $ cgc_aux
*     return "3"			&& INVALIDO
*   endif
   IF "0000000" $ cgc_aux
     return "3"			&& INVALIDO
   endif

   *---------------------------------------------------------*
*  if CLcgc1(cgc_aux)
*     return "2"			&& CGC OK
*  endif
   *---------------------------------------------------------*
   if LEN(TMPcgccpf) > 11
   	  IF CLcgc1(cgc_aux)
	      return "2"			&& CGC OK
	  ELSE
	      return "3"			&& CGC NAO OK
	  ENDIF
   endif
   *---------------------------------------------------------*
	
   acumulo  = 0
   resto    = 0
   digito_1 = 0
   digito_2 = 0
   cont     = 0
   for cont = 1 to 9
       acumulo = acumulo + val(subs(cgc_aux,cont+3,1))*cont
   next
   resto = mod(acumulo,11)
   if resto = 10
      digito_1 = 0
   else
      digito_1 = val(right(str(resto,3),1))
   endif
   acumulo = digito_1 * 9

   for cont = 1 to 8
       acumulo = acumulo + val(subs(cgc_aux,cont+4,1))*cont
   next
   resto = mod(acumulo,11)
   if resto = 10
      digito_2 = 0
   else
      digito_2 = val(right(str(resto,3),1))
   endif

*   A = str(digito_1,1) + str(digito_2,1)
*   wait window "Digitos : "+ a

   if subst(cgc_aux,13,2) # str(digito_1,1) + str(digito_2,1)

	   if CLcgc1(cgc_aux)
    	  return "2"			&& CGC OK
	   endif

      return "3"			&& CODIGO INVALIDO
   else
      return "1"			&& CPF OK
   endif
return

*--------------------------------------------------------------------*
* objetivo : funcao auxiliar a funcao Calc_Cgc                       *
*--------------------------------------------------------------------*
function CLCgc1
    parameter p_cgc1
    acumulo1    = 0
    digito_11   = 0
    digito_21   = 0
    resto1      = 0
    cont1       = 0
    cont2       = 12
    for cont1 = 2 to 9
        acumulo1 = acumulo1 + val(subst(p_cgc1,cont2,1))*cont1
        cont2    = cont2 - 1
    next
    cont2 = 4
    for cont1 = 2 to 5
        acumulo1 = acumulo1 + val(subst(p_cgc1,cont2,1))*cont1
        cont2    = cont2 - 1
    next
    resto1 = mod(acumulo1,11)
    if resto1 = 0 or resto1 = 1
       digito_11 = 0
    else
       digito_11 = 11 - resto1
       digito_11 = val(right(str(digito_11,3),1))
    endif
    acumulo1 = digito_11 * 2
    cont2 = 12
    for cont1 = 3 to 9
        acumulo1 = acumulo1 + val(subst(p_cgc1,cont2,1))*cont1
        cont2    = cont2 - 1
    next
    cont2 = 5
    for cont1 = 2 to 6
        acumulo1 = acumulo1 + val(subst(p_cgc1,cont2,1))*cont1
        cont2    = cont2 - 1
    next
    resto1 = mod(acumulo1,11)
    if resto1 = 0 or resto1 = 1
       digito_21 = 0
    else
       digito_21 = 11 - resto1
       digito_21 = val(right(str(digito_21,3),1))
    endif
* 	 a = str(digito_11,1) + str(digito_21,1)
*     wait window "Digitos : "+ a

    if subst(p_cgc1,13,2) # str(digito_11,1) + str(digito_21,1)
       return (.f.)
    endif
return


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLAS           CLInscricao VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   10   ╨
*       ╨ Variable:            CLInscricao                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      279                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11glas     &&  CLInscricao VALID
#REGION 11
RETURN

*** ?UPInscricao("AL","240000048",1,0,0,Mens)
*** ?UPInscricao("GO","109876547",1,0,0,Mens)
*** ?UPInscricao("TO","29010227836",1,0,0,Mens)

FUNCTION CLInscricao
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Criticar Inscricoes Estaduais
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao e recursiva para calcular a soma dos
	*		digitos
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LSUf...........: Estados ao qual pertence Inscricao
	*		LSinscricao....: Numero da Inscricao
	*       LNPosicao......: Para uso na Recursividade indica qual
	*						 digito sera testado
	*						 A primeira chamada no prog Principal
	*						 deve passar o valor 1
	*		LNpeso.........: Peso atribuido a posicao do digito a
	*						ser testado ex
	*								INSC : 01.40.7420-0
	*								PESO : 98 76 5432
	*		LNnro_dgt......: Numero de Digito que devem ter seus
	*						produtos somados na inscricao do item
	*						anterior serao os 8 primeiros
	*       LSMens.........: Menssagem de Retorno
	*
	*------------------------------------------------------------*
	*  RETORNO.....:    Na recursao retorna NUMERICO PARA SOMA
	*					No encerramento da rotina retorna LOGICO
	*		LFretorno......: Flag de Retorno .f. ou .t.
	*------------------------------------------------------------*
PARAMETERS LSuf,LSinscricao,LNPosicao,LNpeso,LNnro_dgt,LSMens
	PRIVATE LNsoma,LNdigito,LFretorno, LNmult,LNresto

	IF LNposicao = 1
		IF "ISENTO" $ UPPER(LSinscricao)
			RETURN(.T.)
		ENDIF

		*--------------------------------------------------*
		DO UPlimpStrg WITH LSinscricao  && RETORNA strg SEM CARAc DE MASCARA
		*--------------------------------------------------*

		*--------------------------------------------------*
		* ROTINAS COM CALCULO DIFERENCIADAS
		*--------------------------------------------------*
		DO CASE


			CASE LSuf = "AC"
				RETURN(.T.)

			CASE LSuf = "RJ"
				RETURN(.T.)

			CASE LSuf = "TO"
				IF (CLTO_AntigaInscr((LSinscricao),LSMens))
					RETURN(.T.)
				ENDIF
				RETURN(CLTO_NovaInscr((LSinscricao),LSMens))
			CASE LSuf = "MG"
				RETURN(CLMG_Inscr((LSuf),(LSinscricao),1,0,0,LSMens))

			CASE LSuf = "BA"
				RETURN(CLBA_Inscr((LSuf),(LSinscricao),1,0,0,LSMens))

			CASE LSuf = "PR"
				RETURN(CLPR_Inscr((LSuf),(LSinscricao),1,0,0,LSMens))

			CASE LSuf = "RO"
				RETURN(CLRO_Inscr((LSuf),(LSinscricao),LSMens))

			CASE LSuf = "RR"
				RETURN(CLRR_Inscr((LSuf),(LSinscricao),1,0,0,LSMens))

			CASE LSuf = "SP"
				RETURN(CLSP_Inscr((LSuf),(LSinscricao),1,0,0,LSMens))

			CASE LSuf = "DF"
				RETURN(CLDF_Inscr((LSuf),(LSinscricao),1,0,0,LSMens))

		ENDCASE
		*--------------------------------------------------*
		* INICIALIZACAO DO PESO
		*--------------------------------------------------*
		DO CASE
			CASE LSuf = "TO"
				LNpeso 		= 9
				LNnro_dgt	= 10
			CASE LSuf = "MT"
				LNpeso 		= 3
				LNnro_dgt	= 10
			CASE LSuf = "PE"
				LNpeso 		= 5
				LNnro_dgt	= 13
			CASE LSuf = "RS"
				LNpeso 		= 2
				LNnro_dgt	= 9
			OTHERWISE
				LNpeso		= 9
				LNnro_dgt	= 8
		ENDCASE
		IF LEN(LSinscricao) < LNnro_dgt + 1
				LSmens 		= "Inscricao com Tamanho Invalido"
				RETURN(.f.)
		ENDIF
		*--------------------------------------------------*
		*   VERIFICANDO CODIGO DA UF
		*--------------------------------------------------*
		LFretorno = .t.
		DO CASE

			CASE LSuf = "AC" AND "0100447400157" $ LSinscricao
				LFretorno 	= .T.

			CASE LSuf = "AC" AND LEFT(LSinscricao,2) <> "01"
				LSmens 		= "Codigo Invalido p/ UF=ACRE"
				LFretorno 	= .f.
			CASE LSuf = "AL" AND LEFT(LSinscricao,2) <> "24"
				LSmens 		= "Codigo Invalido p/ UF=ALAGOAS"
				LFretorno 	= .f.
			CASE LSuf = "AP" AND LEFT(LSinscricao,2) <> "03"
				LSmens 		= "Codigo Invalido p/ UF=AMAPA"
				LFretorno 	= .f.
			*CASE LSuf = "GO" AND LEFT(LSinscricao,2) <> "10"
			*	LSmens 		= "Codigo Invalido p/ UF=GO"
			*	LFretorno 	= .f.
			CASE LSuf = "MA" AND LEFT(LSinscricao,2) <> "12"
				LSmens 		= "Codigo Invalido p/ UF=MA"
				LFretorno 	= .f.
			*CASE LSuf = "MT" AND LEFT(LSinscricao,2) <> "13"
			*	LSmens 		= "Codigo Invalido p/ UF=MT"
			*	LFretorno 	= .f.
			CASE LSuf = "MS" AND LEFT(LSinscricao,2) <> "28"
				LSmens 		= "Codigo Invalido p/ UF=MS"
				LFretorno 	= .f.
			CASE LSuf = "PA" AND LEFT(LSinscricao,2) <> "15"
				LSmens 		= "Codigo Invalido p/ UF=PA"
				LFretorno 	= .f.
			CASE LSuf = "TO" AND (LEFT(LSinscricao,2) <> "29" ;
					OR LEN(LSinscricao) < 11)
				LSmens 		= "Codigo Invalido p/ UF=TO"
				LFretorno 	= .f.
			CASE LSuf = "DF" AND LEFT(LSinscricao,2) <> "07"
				LSmens 		= "Codigo Invalido p/ UF=TO"
				LFretorno 	= .f.
		ENDCASE
		IF LFretorno = .f.
			RETURN(.f.)
		ENDIF
	ENDIF

	*----------------------------------------------------------*
	*  			 1a PARTE - DETERMINANDO A SOMA
	* Esta parte e envolvida na recursao da rotina
	*----------------------------------------------------------*
	DO CASE
		CASE LSuf = "PE"
		IF LNpeso = 0		&& QUANDO CHEGAR A 0 VOLTA A 9
			LNpeso = 9
		ENDIF
	OTHERWISE
		IF LNpeso = 1		&& QUANDO CHEGAR A 0 VOLTA A 9
			LNpeso = 9
		ENDIF
	ENDCASE

	*--------------------------------------------------*
	DO CASE
		CASE UPPER(LSuf) $ ;
			"AC/AL/AP/AM/GO/MT/MS/MA/PA/PB/PE/PI/RN/RS/RO/SC/SE/CE/ES"

			LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))
			LNmult	 =  LNpeso

			*--------------------------------------------------*
			*  USO DA RECURSAO PARA APURAR A SOMA DOS DIGITOS
			*--------------------------------------------------*
			IF LNposicao <> LNnro_dgt
			   LNsoma   = (LNdigito*LNmult)+;
			   CLInscricao(LSuf,LSinscricao,(LNPosicao+1),LNpeso-1,;
			   		LNnro_dgt,LSMens)
			ELSE
				LNsoma   = (LNdigito*LNmult)&& A ultima rcursao devolve so
											&& o digito da posicao
			ENDIF
			IF LNposicao <> 1
				RETURN(LNsoma)
			ENDIF		
		CASE UPPER(LSuf) $ "TO"
			IF LNposicao = 3 OR LNposicao = 4
			   *-----------------------------------------------*
			   *  3a E 4a nao entram no calc => nao decrementa peso
			   *  e nao soma
			   *-----------------------------------------------*
			   LNsoma   = ;
			   CLInscricao(LSuf,LSinscricao,(LNPosicao+1),LNpeso,;
			   		LNnro_dgt,LSMens)
			  RETURN(LNsoma)	
			ENDIF

			LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))
			LNmult	 =  LNpeso

			*--------------------------------------------------*
			*  USO DA RECURSAO PARA APURAR A SOMA DOS DIGITOS
			*--------------------------------------------------*
			IF LNposicao <> LNnro_dgt
			   LNsoma   = (LNdigito*LNmult)+;
			   CLInscricao(LSuf,LSinscricao,(LNPosicao+1),LNpeso-1,;
			   		LNnro_dgt,LSMens)
			ELSE
				LNsoma   = (LNdigito*LNmult)&& A ultima rcursao devolve so
											&& o digito da posicao
			ENDIF
			IF LNposicao <> 1
				RETURN(LNsoma)
			ENDIF		

		OTHERWISE
			LSmens 		= "Verificaao Nao disponivel para UF"
			LFretorno 	= .f.
			RETURN(.F.)
	ENDCASE


	*----------------------------------------------------------*
	*	   2a PARTE - CALCULANDO E COMPARANDO O DIGITO
	* 			Esta parte nao interfere na recursao
	*----------------------------------------------------------*

	DO CASE
		*--------------------------------------------------*
		CASE UPPER(LSuf) $ ;
				"AC/AL/AM/MT/MS/TO/MA/PA/PB/PI/RN/RS/RO/SC/SE/CE/ES"
			LNresto = LNsoma % 11					
			IF LNresto < 2
				LSdg_Found = 0
			ELSE
				LSdg_Found = 11-LNresto
			ENDIF			
			LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
			*------------------------------------------------------*
			LFretorno = .t.
			DO CASE
				CASE UPPER(LSuf) $ "AL"	 AND LNresto =  10 ;
					AND !(SUBS(LSinscricao,LNnro_dgt+1,1) $ "0")
						LSmens 		= "Digito Invalido para Inscricao"
						LFretorno 	= .f.
				CASE LSdg_Found <> SUBS(LSinscricao,LNnro_dgt+1,1)			
					LSmens 		= "Digito Invalido para Inscricao"
					LFretorno 	= .f.
			ENDCASE			
			*------------------------------------------------------*
		CASE UPPER(LSuf) $ "PE"
			LNresto = LNsoma % 11					
			IF LNresto < 2
				LSdg_Found = 11 - LNresto - 10
			ELSE
				LSdg_Found = 11-LNresto
			ENDIF			
			LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
			*------------------------------------------------------*
			LFretorno = .t.
			DO CASE
				CASE LSdg_Found <> SUBS(LSinscricao,LNnro_dgt+1,1)			
					LSmens 		= "Digito Invalido para Inscricao"
					LFretorno 	= .f.
			ENDCASE			
			*------------------------------------------------------*
		CASE UPPER(LSuf) $ "GO"	
			LNresto = (LNsoma*10)%11

			IF LNresto = 10
				LSdg_Found = 0
			ELSE
				LSdg_Found = LNresto
			ENDIF			
			LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
			*------------------------------------------------------*
			LFretorno = .t.
			DO CASE
				CASE LSdg_Found <> SUBS(LSinscricao,LNnro_dgt+1,1)			
						LSmens 		= "Digito Invalido para Inscricao"
						LFretorno 	= .f.
			ENDCASE			
			IF LFretorno = .f.  AND LNresto = 10
				LFretorno = .t.
				LSdg_Found = 1
				LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
				IF LSdg_Found <> SUBS(LSinscricao,LNnro_dgt+1,1)			
					LFretorno 	= .f.
				ENDIF
			ENDIF		



		CASE UPPER(LSuf) = "AP"	&& TRATAMENTO - AMAPA
			*------------------------------------------------------*
			PRIVATE LNnro_insc, LS_dig_P, LS_dig_D
			LNnro_insc	=	INT(VAL(LEFT(LSinscricao,8)))
			DO CASE
				CASE LNnro_insc <= 03017000
					LS_dig_P	=	"5"
					LS_dig_D	=	"0"
				CASE LNnro_insc <= 03019022
					LS_dig_P	=	"9"
					LS_dig_D	=	"1"
				OTHERWISE
					LS_dig_P	=	"0"
					LS_dig_D	=	"1"
			ENDCASE
			LNsoma	= LNsoma + 	INT(VAL(LS_dig_P))

			LNresto = LNsoma % 11					
			IF LNresto < 2
				IF LNresto = 1
					LSdg_Found = 0
				ELSE
					LSdg_Found = INT(VAL(LS_dig_D))
				ENDIF				
			ELSE
				LSdg_Found = 11-LNresto
			ENDIF			
			LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
			*--------------------------------------------------*
			LFretorno = .t.
			DO CASE
				CASE LSdg_Found <> SUBS(LSinscricao,LNnro_dgt+1,1)			
					LSmens 		= "Digito Invalido para Inscricao"
					LFretorno 	= .f.
			ENDCASE			
		OTHERWISE
			LFretorno 	= .f.
	ENDCASE
	
RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLAT           CLRO_Inscr VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   11   ╨
*       ╨ Variable:            CLRO_Inscr                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      280                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11glat     &&  CLRO_Inscr VALID
#REGION 11
RETURN

*** ?UPRO_Inscr("RO","00000000625213")
*** ?UPRO_Inscr("RO","00000000988006")

FUNCTION CLRO_Inscr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Criticar Inscricoes Estado Rondonia
	*------------------------------------------------------------*
	* COMENTARIO..: Rotina diferenciada das demais
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LSUf...........: Estados ao qual pertence Inscricao
	*		LSinscricao....: Numero da Inscricao
	*       LSMens.........: Menssagem de Retorno
	*
	*------------------------------------------------------------*
	*  RETORNO.....:    Na recursao retorna NUMERICO PARA SOMA
	*					No encerramento da rotina retorna LOGICO
	*		LFretorno......: Flag de Retorno .f. ou .t.
	*------------------------------------------------------------*
PARAMETERS LSuf,LSinscricao,LSMens

	PRIVATE LNsoma,LNdigito, LNpeso
	PRIVATE LSBKPinscricao


	LSBKPinscricao = LSinscricao


	*------------------------------------------------------------*
	*  CALCULO NA FORMULA ATE 01/08/2000
	*------------------------------------------------------------*

*    IF LSinscricao = "00000000988006"
*    	RETURN(.T.)
*    ENDIF

	LSinscricao= "0000" + "000"+RIGHT(LSinscricao,6) && ANULAR 3 CASAS DO
										    && CODG MUNICIPIO


	IF LEN(LSinscricao) < 9
			LSmens 		= "Inscricao com Tamanho Invalido"
			RETURN(.f.)
	ENDIF

	*------------------------------------------------------------*
	*  CALCULO DO DIGITO
	*------------------------------------------------------------*


	LNsoma		= 0
	LNpeso      = 6

	FOR LNPosicao = 1 TO 12
		LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))

		LSproduto	= (LNdigito*LNpeso)
	    LNsoma   	= LNsoma+ LSproduto

		LNpeso   	= LNpeso - 1

		IF LNpeso < 2
		   LNpeso = 9
		ENDIF

	NEXT
	

	LSdg_Found = 11 - (LNsoma % 11)


	IF LSdg_found > 9
		LSdg_found	= LSdg_found - 10
	ENDIF
	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")

	*--------------------------------------------------*

	LFretorno = .t.

	IF  LSdg_Found = RIGHT(LSinscricao,1)			
		LSmens 		= ""
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*





	*------------------------------------------------------------*
	*  CALCULO NA FORMULA POSTERIOR 01/08/2000
	*------------------------------------------------------------*


	*    A DIFERENCA E QUE NO PROXIMO CALCULO SE A INSCRICAO FOI
	*   INFORMADA COM 14 DIGITOS NENHUM SERA SUBSTITUIDO POR "0"


	*------------------------------------------------------------*

	LSinscricao	= LSBKPinscricao




	LSinscricao= RIGHT("00000000000"+LSinscricao,14)
									 && AS NOVAS INSCRICOES JA
									 && POSSUES 14 DIGITOS
									

	IF LEN(LSinscricao) < 10
			LSmens 		= "Inscricao com Tamanho Invalido"
			RETURN(.f.)
	ENDIF

	*------------------------------------------------------------*
	*  CALCULO DO DIGITO
	*------------------------------------------------------------*


	LNsoma		= 0
	LNpeso      = 6

	FOR LNPosicao = 1 TO 13
		LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))

		LSproduto	= (LNdigito*LNpeso)
	    LNsoma   	= LNsoma+ LSproduto

		LNpeso   	= LNpeso - 1

		IF LNpeso < 2
		   LNpeso = 9
		ENDIF

	NEXT
	

	LSdg_Found = 11 - (LNsoma % 11)


	IF LSdg_found > 9
		LSdg_found	= LSdg_found - 10
	ENDIF
	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")


	*--------------------------------------------------*

	LFretorno = .t.

	*------------------------------------------------------------*
	IF  LSdg_Found <> RIGHT(LSinscricao,1)			
		LSmens 		= "Digito Invalido para Inscricao"
		RETURN(.F.)
	ENDIF


RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLBR           CLMG_Inscr VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   12   ╨
*       ╨ Variable:            CLMG_Inscr                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      281                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11glbr     &&  CLMG_Inscr VALID
#REGION 11
RETURN

*** ?UPInscricao("AL","240000048",1,0,0,Mens)
*** ?UPInscricao("GO","109876547",1,0,0,Mens)
*** ?UPInscricao("TO","29010227836",1,0,0,Mens)

FUNCTION CLMG_Inscr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Criticar Inscricoes Estado Minas Gerais
	*------------------------------------------------------------*
	* COMENTARIO..: Rotina diferenciada das demais
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LSUf...........: Estados ao qual pertence Inscricao
	*		LSinscricao....: Numero da Inscricao
	*       LNPosicao......: Para uso na Recursividade indica qual
	*						 digito sera testado
	*						 A primeira chamada no prog Principal
	*						 deve passar o valor 1
	*		LNpeso.........: Peso atribuido a posicao do digito a
	*						ser testado ex
	*								INSC : 01.40.7420-0
	*								PESO : 98 76 5432
	*		LNnro_dgt......: Numero de Digito que devem ter seus
	*						produtos somado na inscricao do item
	*						anterior serao os 8 primeiros
	*       LSMens.........: Menssagem de Retorno
	*
	*------------------------------------------------------------*
	*  RETORNO.....:    Na recursao retorna NUMERICO PARA SOMA
	*					No encerramento da rotina retorna LOGICO
	*		LFretorno......: Flag de Retorno .f. ou .t.
	*------------------------------------------------------------*
PARAMETERS LSuf,LSinscricao,LNPosicao,LNpeso,LNnro_dgt,LSMens
	PRIVATE LNsoma,LNdigito,LFretorno, LNmult ,LNdezena,LNresto
	PRIVATE LSproduto


	IF LEFT(LSinscricao,2) = "PR"
		RETURN(.T.)
	ENDIF

	IF "4813973" $ LSinscricao
		RETURN(.T.)
	ENDIF

	IF "9326640" $ LSinscricao
		RETURN(.T.)
	ENDIF

	IF "7049153" $ LSinscricao
		RETURN(.T.)
	ENDIF

	IF "7681267" $ LSinscricao
		RETURN(.T.)
	ENDIF

	IF "7100986" $ LSinscricao
		RETURN(.T.)
	ENDIF

	IF "3635720" $ LSinscricao
		RETURN(.T.)
	ENDIF


	IF LEN(LSinscricao) < 13
			LSmens 		= "Inscricao com Tamanho Invalido"
			RETURN(.f.)
	ENDIF

	*------------------------------------------------------------*
	*  CALCULO DO 1o DIGITO
	*------------------------------------------------------------*
	LSinscricao = LEFT(LSinscricao,3)+"0"+SUBS(LSinscricao,4)
	LNsoma		= 0
	FOR LNPosicao = 1 TO 12
		LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))

		IF LNposicao % 2 = 1
			LNmult	 =  1
		ELSE
			LNmult	 =  2
		ENDIF		
		LSproduto	= (LNdigito*LNmult)
		LSproduto	= CHRTRAN(STR(LNdigito*LNmult,2)," ","0")
	    LNsoma   = LNsoma+ VAL(LEFT(LSproduto,1))  ;
	    				 + VAL(RIGHT(LSproduto,1))
	NEXT
	
	LNdezena = (INT(LNsoma/10)*10)+10	&& 1a DEZENA SUPERIOR A SOMA
	LSdg_Found = LNdezena-LNsoma
	IF LSdg_found > 9
		LSdg_found	= 0
	ENDIF
	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
	*--------------------------------------------------*
	LFretorno = .t.
	IF  LSdg_Found <> SUBS(LSinscricao,13,1)			
		LSmens 		= "Digito Invalido para Inscricao"
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*

	*------------------------------------------------------------*
	*  CALCULO DO 2o DIGITO
	*------------------------------------------------------------*
	* RETIRAR O ZERO INSERIDO NA 4a POSICAO
	*------------------------------------------------------------*

	LSinscricao = LEFT(LSinscricao,3)+SUBS(LSinscricao,5)
	LNmult	 =  3
	LNsoma		= 0
	FOR LNPosicao = 1 TO 12
		LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))

		IF LNmult = 1
			LNmult	 =  11
		ENDIF		
	    LNsoma   = LNsoma+ (LNdigito*LNmult)
		LNmult	 =  LNmult - 1
	NEXT
	*-------------------------------------------------------------*
	LNresto	   = LNsoma % 11
	IF LNresto < 2
		LSdg_Found	=	0
	ELSE
		LSdg_Found = 11-LNresto
	ENDIF
	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
	*--------------------------------------------------*
	LFretorno = .t.
	IF  LSdg_Found <> SUBS(LSinscricao,13,1)			
		LSmens 		= "Digito Invalido para Inscricao"
		LFretorno 	= .f.
	ENDIF			
RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLC0           CLBA_Inscr VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   13   ╨
*       ╨ Variable:            CLBA_Inscr                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      282                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11glc0     &&  CLBA_Inscr VALID
#REGION 11
RETURN

*** ?UPInscricao("AL","240000048",1,0,0,Mens)
*** ?UPInscricao("GO","109876547",1,0,0,Mens)
*** ?UPInscricao("TO","29010227836",1,0,0,Mens)

FUNCTION CLBA_Inscr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Criticar Inscricoes Estado BAHIA
	*------------------------------------------------------------*
	* COMENTARIO..: Rotina diferenciada das demais
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LSUf...........: Estados ao qual pertence Inscricao
	*		LSinscricao....: Numero da Inscricao
	*       LNPosicao......: Para uso na Recursividade indica qual
	*						 digito sera testado
	*						 A primeira chamada no prog Principal
	*						 deve passar o valor 1
	*		LNpeso.........: Peso atribuido a posicao do digito a
	*						ser testado ex
	*								INSC : 01.40.7420-0
	*								PESO : 98 76 5432
	*		LNnro_dgt......: Numero de Digito que devem ter seus
	*						produtos somado na inscricao do item
	*						anterior serao os 8 primeiros
	*       LSMens.........: Menssagem de Retorno
	*
	*------------------------------------------------------------*
	*  RETORNO.....:    Na recursao retorna NUMERICO PARA SOMA
	*					No encerramento da rotina retorna LOGICO
	*		LFretorno......: Flag de Retorno .f. ou .t.
	*------------------------------------------------------------*
PARAMETERS LSuf,LSinscricao,LNPosicao,LNpeso,LNnro_dgt,LSMens
	PRIVATE LNsoma,LNdigito,LFretorno, LNmult ,LNdezena,LNresto
	PRIVATE LS1o_Digt,LS2o_Digt

	IF LEN(LSinscricao) < 8
			LSmens 		= "Inscricao com Tamanho Invalido"
			RETURN(.f.)
	ENDIF

	*------------------------------------------------------------*
	*  CALCULO DO 2o DIGITO
	*------------------------------------------------------------*
	LNsoma		= 0
	LNpeso		= 7
	FOR LNPosicao = 1 TO 6
		LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))
		LNmult	 =  LNpeso
	    LNsoma   = LNsoma+ (LNdigito*LNmult)
		LNpeso	 = LNpeso - 1
	NEXT
	*-------------------------------------------------------------*
	DO CASE
		CASE LEFT(LSinscricao,1) $ "0123458" && USAR MODULO 10
			LNresto	   = LNsoma % 10
			IF LNresto = 0
				LSdg_Found	=	0
			ELSE
				LSdg_Found = 10-LNresto
			ENDIF
		CASE LEFT(LSinscricao,1) $ "679" && USAR MODULO 10
			LNresto	   = LNsoma % 11
			IF LNresto < 2
				LSdg_Found	=	0
			ELSE
				LSdg_Found = 11-LNresto
			ENDIF
		OTHERWISE
			LSdg_Found	=	0
			RETURN(.F.)			
	ENDCASE
	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
	LS2o_Digt	 = LSdg_Found
	*--------------------------------------------------*
	LFretorno = .t.
	IF  LSdg_Found <> SUBS(LSinscricao,8,1)			
		LSmens 		= "Digito Invalido para Inscricao"
		RETURN(.f.)
	ENDIF			
	*------------------------------------------------------------*

	*------------------------------------------------------------*
	*  CALCULO DO 1o DIGITO
	*------------------------------------------------------------*
	*  INSERIDO 2o DIGITO
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  CALCULO DO 2o DIGITO
	*------------------------------------------------------------*
	LNsoma		= 0
	LNpeso		= 8
	FOR LNPosicao = 1 TO 6
		LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))
		LNmult	 =  LNpeso
	    LNsoma   = LNsoma+ (LNdigito*LNmult)
		LNpeso	 = LNpeso - 1
	NEXT
	LNdigito = 	INT(VAL(LS2o_Digt))		&& AGREGANDO 2o DIGITO AO CALCULO
	LNmult	 =  LNpeso
    LNsoma   = LNsoma+ (LNdigito*LNmult)
	LNpeso	 = LNpeso - 1

	*-------------------------------------------------------------*
	DO CASE
		CASE LEFT(LSinscricao,1) $ "0123458" && USAR MODULO 10
			LNresto	   = LNsoma % 10
			IF LNresto = 0
				LSdg_Found	=	0
			ELSE
				LSdg_Found = 10-LNresto
			ENDIF
		CASE LEFT(LSinscricao,1) $ "679" && USAR MODULO 10
			LNresto	   = LNsoma % 11
			IF LNresto < 2
				LSdg_Found	=	0
			ELSE
				LSdg_Found = 11-LNresto
			ENDIF
	ENDCASE
	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
	LS1o_Digt	 = LSdg_Found
	*--------------------------------------------------*
	LFretorno = .t.
	IF  LSdg_Found <> SUBS(LSinscricao,7,1)			
		LSmens 		= "Digito Invalido para Inscricao"
		LFretorno 	= .f.
	ENDIF			
	*------------------------------------------------------------*
RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLC9           CLPR_Inscr VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   14   ╨
*       ╨ Variable:            CLPR_Inscr                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      283                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11glc9     &&  CLPR_Inscr VALID
#REGION 11
RETURN

*** ?UPInscricao("AL","240000048",1,0,0,Mens)
*** ?UPInscricao("GO","109876547",1,0,0,Mens)
*** ?UPInscricao("TO","29010227836",1,0,0,Mens)

FUNCTION CLPR_Inscr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Criticar Inscricoes Estado PARANA
	*------------------------------------------------------------*
	* COMENTARIO..: Rotina diferenciada das demais
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LSUf...........: Estados ao qual pertence Inscricao
	*		LSinscricao....: Numero da Inscricao
	*       LNPosicao......: Para uso na Recursividade indica qual
	*						 digito sera testado
	*						 A primeira chamada no prog Principal
	*						 deve passar o valor 1
	*		LNpeso.........: Peso atribuido a posicao do digito a
	*						ser testado ex
	*								INSC : 01.40.7420-0
	*								PESO : 98 76 5432
	*		LNnro_dgt......: Numero de Digito que devem ter seus
	*						produtos somado na inscricao do item
	*						anterior serao os 8 primeiros
	*       LSMens.........: Menssagem de Retorno
	*
	*------------------------------------------------------------*
	*  RETORNO.....:    Na recursao retorna NUMERICO PARA SOMA
	*					No encerramento da rotina retorna LOGICO
	*		LFretorno......: Flag de Retorno .f. ou .t.
	*------------------------------------------------------------*
PARAMETERS LSuf,LSinscricao,LNPosicao,LNpeso,LNnro_dgt,LSMens
	PRIVATE LNsoma,LNdigito,LFretorno, LNmult ,LNdezena,LNresto
	PRIVATE LS1o_Digt,LS2o_Digt

	IF LEN(LSinscricao) < 10
			LSmens 		= "Inscricao com Tamanho Invalido"
			RETURN(.f.)
	ENDIF

	*------------------------------------------------------------*
	*  CALCULO DO 1o DIGITO
	*------------------------------------------------------------*
	LNsoma		= 0
	LNpeso		= 3
	FOR LNPosicao = 1 TO 8
		LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))
		LNmult	 =  LNpeso
	    LNsoma   = LNsoma+ (LNdigito*LNmult)
		LNpeso	 = LNpeso - 1
		IF LNpeso = 1
			LNpeso = 7
		ENDIF
	NEXT
	*-------------------------------------------------------------*
	LNresto	   = LNsoma % 11
	IF LNresto < 2
		LSdg_Found	=	0
	ELSE
		LSdg_Found = 11-LNresto
	ENDIF

	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
	*--------------------------------------------------*
	LFretorno = .t.
	IF  LSdg_Found <> SUBS(LSinscricao,9,1)			
		LSmens 		= "Digito Invalido para Inscricao"
		RETURN(.f.)
	ENDIF			
	*------------------------------------------------------------*

	*------------------------------------------------------------*
	*  CALCULO DO 2o DIGITO
	*------------------------------------------------------------*
	*  INSERIDO 2o DIGITO
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  CALCULO DO 2o DIGITO
	*------------------------------------------------------------*
	LNsoma		= 0
	LNpeso		= 4
	FOR LNPosicao = 1 TO 9
		LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))
		LNmult	 =  LNpeso
	    LNsoma   = LNsoma+ (LNdigito*LNmult)
		LNpeso	 = LNpeso - 1
		IF LNpeso = 1
			LNpeso = 7
		ENDIF
	NEXT
	*-------------------------------------------------------------*
	LNresto	   = LNsoma % 11
	IF LNresto < 2
		LSdg_Found	=	0
	ELSE
		LSdg_Found = 11-LNresto
	ENDIF
	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
	*--------------------------------------------------*
	LFretorno = .t.
	IF  LSdg_Found <> SUBS(LSinscricao,10,1)			
		LSmens 		= "Digito Invalido para Inscricao"
		LFretorno 	= .f.
	ENDIF			
	*------------------------------------------------------------*
RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLCI           CLRR_Inscr VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   15   ╨
*       ╨ Variable:            CLRR_Inscr                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      284                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11glci     &&  CLRR_Inscr VALID
#REGION 11
RETURN

*** ?UPInscricao("AL","240000048",1,0,0,Mens)
*** ?UPInscricao("GO","109876547",1,0,0,Mens)
*** ?UPInscricao("TO","29010227836",1,0,0,Mens)

FUNCTION CLRR_Inscr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Criticar Inscricoes Estado RORAIMA
	*------------------------------------------------------------*
	* COMENTARIO..: Rotina diferenciada das demais
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LSUf...........: Estados ao qual pertence Inscricao
	*		LSinscricao....: Numero da Inscricao
	*       LNPosicao......: Para uso na Recursividade indica qual
	*						 digito sera testado
	*						 A primeira chamada no prog Principal
	*						 deve passar o valor 1
	*		LNpeso.........: Peso atribuido a posicao do digito a
	*						ser testado ex
	*								INSC : 01.40.7420-0
	*								PESO : 98 76 5432
	*		LNnro_dgt......: Numero de Digito que devem ter seus
	*						produtos somado na inscricao do item
	*						anterior serao os 8 primeiros
	*       LSMens.........: Menssagem de Retorno
	*
	*------------------------------------------------------------*
	*  RETORNO.....:    Na recursao retorna NUMERICO PARA SOMA
	*					No encerramento da rotina retorna LOGICO
	*		LFretorno......: Flag de Retorno .f. ou .t.
	*------------------------------------------------------------*
PARAMETERS LSuf,LSinscricao,LNPosicao,LNpeso,LNnro_dgt,LSMens
	PRIVATE LNsoma,LNdigito,LFretorno, LNmult ,LNdezena,LNresto
	PRIVATE LS1o_Digt,LS2o_Digt

	IF LEN(LSinscricao) < 9
		LSmens 		= "Inscricao com Tamanho Invalido"
		RETURN(.f.)
	ENDIF
	IF LEFT(LSinscricao,2) <> "24"
		LSmens 		= "Codigo Invalido p/ UF=RR"
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------*
	*  CALCULO DO 1o DIGITO
	*------------------------------------------------------------*
	LNsoma		= 0
	FOR LNPosicao = 1 TO 8
		LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))
	    LNsoma   =  LNsoma+ (LNdigito*LNposicao)
	NEXT
	*-------------------------------------------------------------*
	LNresto	   = LNsoma % 9
	LSdg_Found = LNresto

	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
	*--------------------------------------------------*
	LFretorno = .t.
	IF  LSdg_Found <> SUBS(LSinscricao,9,1)			
		LSmens 		= "Digito Invalido para Inscricao"
		RETURN(.f.)
	ENDIF			
	*------------------------------------------------------------*
RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLCJ           CLSP_Inscr VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   16   ╨
*       ╨ Variable:            CLSP_Inscr                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      285                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11glcj     &&  CLSP_Inscr VALID
#REGION 11
RETURN

*** ?UPInscricao("AL","240000048",1,0,0,Mens)
*** ?UPInscricao("GO","109876547",1,0,0,Mens)
*** ?UPInscricao("TO","29010227836",1,0,0,Mens)

FUNCTION CLSP_Inscr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Criticar Inscricoes Estado SAO PAULO
	*------------------------------------------------------------*
	* COMENTARIO..: Rotina diferenciada das demais
	*				Sao tratadas duas situacoes diferentes
	*					1- PRODUTORES RURAIS
	*					2- INDUSTRIA E COMERCIO
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LSUf...........: Estados ao qual pertence Inscricao
	*		LSinscricao....: Numero da Inscricao
	*       LNPosicao......: Para uso na Recursividade indica qual
	*						 digito sera testado
	*						 A primeira chamada no prog Principal
	*						 deve passar o valor 1
	*		LNpeso.........: Peso atribuido a posicao do digito a
	*						ser testado ex
	*								INSC : 01.40.7420-0
	*								PESO : 98 76 5432
	*		LNnro_dgt......: Numero de Digito que devem ter seus
	*						produtos somado na inscricao do item
	*						anterior serao os 8 primeiros
	*       LSMens.........: Menssagem de Retorno
	*
	*------------------------------------------------------------*
	*  RETORNO.....:    Na recursao retorna NUMERICO PARA SOMA
	*					No encerramento da rotina retorna LOGICO
	*		LFretorno......: Flag de Retorno .f. ou .t.
	*------------------------------------------------------------*
PARAMETERS LSuf,LSinscricao,LNPosicao,LNpeso,LNnro_dgt,LSMens
	PRIVATE LNsoma,LNdigito,LFretorno, LNmult ,LNdezena,LNresto

	DO CASE
		CASE LEFT(LSinscricao,1) = "P" 		&& PRODUTOR RURAL
			IF LEN(LSinscricao) < 13
				LSmens 		= "Inscricao com Tamanho Invalido"
				RETURN(.f.)
			ENDIF
			*------------------------------------------------------------*
			*  CALCULO DO 1o DIGITO
			*------------------------------------------------------------*
			LNsoma		= 0
			LNpeso		= 1
			FOR LNPosicao = 2 TO 9
				LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))
				LNmult	 =  LNpeso
			    LNsoma   = LNsoma+ (LNdigito*LNmult)
				IF LNpeso = 1 OR LNpeso = 8
					LNpeso	 = LNpeso + 2
				ELSE
					LNpeso	 = LNpeso + 1
				ENDIF
			NEXT
			*-------------------------------------------------------------*
			LNresto	   = LNsoma % 11
			LSdg_Found = LNresto

			* DIGITO SERA O DIGITO MAIS A DIREITA DO RESTO DA DIVISAO *

			LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,2)," ","0")
			LSdg_Found 	 = RIGHT(LSdg_Found ,1)

			*--------------------------------------------------*
			LFretorno = .t.
			IF  LSdg_Found <> SUBS(LSinscricao,10,1)			
				LSmens 		= "Digito Invalido para Inscricao"
				RETURN(.f.)
			ENDIF			
			*------------------------------------------------------------*
			RETURN(LFretorno)
		OTHERWISE
			IF LEN(LSinscricao) < 12
				LSmens 		= "Inscricao com Tamanho Invalido"
				RETURN(.f.)
			ENDIF
			*------------------------------------------------------------*
			*  CALCULO DO 1o DIGITO
			*------------------------------------------------------------*
			LNsoma		= 0
			LNpeso		= 1
			FOR LNPosicao = 1 TO 8
				LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))
				LNmult	 =  LNpeso
			    LNsoma   = LNsoma+ (LNdigito*LNmult)
				IF LNpeso = 1 OR LNpeso = 8
					LNpeso	 = LNpeso + 2
				ELSE
					LNpeso	 = LNpeso + 1
				ENDIF
			NEXT
			*-------------------------------------------------------------*
			LNresto	   = LNsoma % 11
			LSdg_Found = LNresto

			* DIGITO SERA O DIGITO MAIS A DIREITA DO RESTO DA DIVISAO *

			LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,2)," ","0")
			LSdg_Found 	 = RIGHT(LSdg_Found ,1)

			*--------------------------------------------------*
			LFretorno = .t.
			IF  LSdg_Found <> SUBS(LSinscricao,9,1)			
				LSmens 		= "Digito Invalido para Inscricao"
				RETURN(.f.)
			ENDIF			

			*------------------------------------------------------------*
			*  CALCULO DO 2o DIGITO
			*------------------------------------------------------------*
			LNsoma		= 0
			LNpeso		= 3
			FOR LNPosicao = 1 TO 11
				LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))
				LNmult	 =  LNpeso
			    LNsoma   = LNsoma+ (LNdigito*LNmult)
				LNpeso	 = LNpeso - 1
				IF LNpeso = 1
					LNpeso = 10
				ENDIF
			NEXT
			*-------------------------------------------------------------*
			*-------------------------------------------------------------*
			LNresto	   = LNsoma % 11
			LSdg_Found = LNresto

			* DIGITO SERA O DIGITO MAIS A DIREITA DO RESTO DA DIVISAO *

			LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,2)," ","0")
			LSdg_Found 	 = RIGHT(LSdg_Found ,1)

			*--------------------------------------------------*
			LFretorno = .t.
			IF  LSdg_Found <> SUBS(LSinscricao,12,1)			
				LSmens 		= "Digito Invalido para Inscricao"
				LFretorno = .F.
			ENDIF			
	ENDCASE
RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLCK           CLDF_Inscr VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   17   ╨
*       ╨ Variable:            CLDF_Inscr                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      286                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11glck     &&  CLDF_Inscr VALID
#REGION 11
RETURN

*** ?UPInscricao("AL","240000048",1,0,0,Mens)
*** ?UPInscricao("GO","109876547",1,0,0,Mens)
*** ?UPInscricao("TO","29010227836",1,0,0,Mens)

FUNCTION CLDF_Inscr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Criticar Inscricoes EstadoDF
	*------------------------------------------------------------*
	* COMENTARIO..: Rotina diferenciada das demais
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LSUf...........: Estados ao qual pertence Inscricao
	*		LSinscricao....: Numero da Inscricao
	*       LNPosicao......: Para uso na Recursividade indica qual
	*						 digito sera testado
	*						 A primeira chamada no prog Principal
	*						 deve passar o valor 1
	*		LNpeso.........: Peso atribuido a posicao do digito a
	*						ser testado ex
	*								INSC : 01.40.7420-0
	*								PESO : 98 76 5432
	*		LNnro_dgt......: Numero de Digito que devem ter seus
	*						produtos somado na inscricao do item
	*						anterior serao os 8 primeiros
	*       LSMens.........: Menssagem de Retorno
	*
	*------------------------------------------------------------*
	*  RETORNO.....:    Na recursao retorna NUMERICO PARA SOMA
	*					No encerramento da rotina retorna LOGICO
	*		LFretorno......: Flag de Retorno .f. ou .t.
	*------------------------------------------------------------*
PARAMETERS LSuf,LSinscricao,LNPosicao,LNpeso,LNnro_dgt,LSMens
	PRIVATE LNsoma,LNdigito,LFretorno, LNmult ,LNdezena,LNresto
	PRIVATE LS1o_Digt,LS2o_Digt

	IF LEN(LSinscricao) < 13
			LSmens 		= "Inscricao com Tamanho Invalido"
			RETURN(.f.)
	ENDIF

	*------------------------------------------------------------*
	*  CALCULO DO 1o DIGITO
	*------------------------------------------------------------*
	LNsoma		= 0
	LNpeso		= 4
	FOR LNPosicao = 1 TO 11
		LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))
		LNmult	 =  LNpeso
	    LNsoma   = LNsoma+ (LNdigito*LNmult)
		LNpeso	 = LNpeso - 1
		IF LNpeso = 1
			LNpeso = 9
		ENDIF
	NEXT
	*-------------------------------------------------------------*
	LNresto	   = LNsoma % 11
	IF LNresto < 2
		LSdg_Found	=	0
	ELSE
		LSdg_Found = 11-LNresto
	ENDIF

	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
	*--------------------------------------------------*
	LFretorno = .t.
	IF  LSdg_Found <> SUBS(LSinscricao,12,1)			
		LSmens 		= "Digito Invalido para Inscricao"
		RETURN(.f.)
	ENDIF			
	*------------------------------------------------------------*

	*------------------------------------------------------------*
	*  CALCULO DO 2o DIGITO
	*------------------------------------------------------------*
	*  INSERIDO 2o DIGITO
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  CALCULO DO 2o DIGITO
	*------------------------------------------------------------*
	LNsoma		= 0
	LNpeso		= 5
	FOR LNPosicao = 1 TO 12
		LNdigito = 	INT(VAL(SUBS(LSinscricao,LNposicao,1)))
		LNmult	 =  LNpeso
	    LNsoma   = LNsoma+ (LNdigito*LNmult)
		LNpeso	 = LNpeso - 1
		IF LNpeso = 1
			LNpeso = 9
		ENDIF
	NEXT
	*-------------------------------------------------------------*
	LNresto	   = LNsoma % 11
	IF LNresto < 2
		LSdg_Found	=	0
	ELSE
		LSdg_Found = 11-LNresto
	ENDIF
	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
	*--------------------------------------------------*
	LFretorno = .t.
	IF  LSdg_Found <> SUBS(LSinscricao,13,1)			
		LSmens 		= "Digito Invalido para Inscricao"
		LFretorno 	= .f.
	ENDIF			
	*------------------------------------------------------------*
RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLD7           CLTO_AntigaInscr VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   18   ╨
*       ╨ Variable:            CLTO_AntigaInscr                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      287                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gld7     &&  CLTO_AntigaInscr VALID
#REGION 11
RETURN


	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Criticar Inscricoes Antigas
	*               Valida ate dezembro 2003
	*               Estado Tocantins
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LSinscricao....: Numero da Inscricao
	*       LSMens.........: Menssagem de Retorno
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LFretorno......: Flag de Retorno .f. ou .t.
	*------------------------------------------------------------*
FUNCTION CLTO_AntigaInscr
PARAMETERS LSinscricao,LSMens
	PRIVATE LNPosicao
	PRIVATE LNsoma
	PRIVATE LNdigito
	PRIVATE LFretorno
	PRIVATE LNmult
	PRIVATE LNdezena
	PRIVATE LNresto
	PRIVATE LSproduto

	IF LEN(LSinscricao) < 11
			LSmens 		= "Inscricao com Tamanho Invalido"
			RETURN(.f.)
	ENDIF

	*------------------------------------------------------------*
	*  CALCULO DO 1o DIGITO
	*------------------------------------------------------------*
	LNsoma		=  0
	LNmult	    =  9

	FOR LNPosicao = 1 TO 10

		IF LNPosicao <> 3 and  LNPosicao <> 4
			LNdigito    = INT(VAL(SUBS(LSinscricao,LNposicao,1)))
			LSproduto	= (LNdigito*LNmult)
			LSproduto	= CHRTRAN(STR(LNdigito*LNmult,2)," ","0")
		    LNsoma   	= LNsoma+ VAL(LSproduto)
	    	LNmult 		= LNmult - 1
	   	ENDIF
	NEXT
	
	LNdezena = (LNsoma % 11)	&& Divisao Modal =>  Resto

	IF LNdezena >= 2
		LSdg_Found = 11-LNdezena
	else
		LSdg_Found = 0
	ENDIF
	
	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
	*--------------------------------------------------*
	LFretorno = .t.
	IF  LSdg_Found <> SUBS(LSinscricao,11,1)			
		LSmens 		= "Digito Invalido para Inscricao"
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLDE           CLTO_NovaInscr VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   19   ╨
*       ╨ Variable:            CLTO_NovaInscr                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      288                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11glde     &&  CLTO_NovaInscr VALID
#REGION 11
RETURN


	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Criticar Inscricoes Nova
	*               Valida a partir de janeiro 2003
	*               Estado Tocantins
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LSinscricao....: Numero da Inscricao
	*       LSMens.........: Menssagem de Retorno
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LFretorno......: Flag de Retorno .f. ou .t.
	*------------------------------------------------------------*
FUNCTION CLTO_NovaInscr
PARAMETERS LSinscricao,LSMens
	PRIVATE LNPosicao
	PRIVATE LNsoma
	PRIVATE LNdigito
	PRIVATE LFretorno
	PRIVATE LNmult
	PRIVATE LNdezena
	PRIVATE LNresto
	PRIVATE LSproduto

	IF LEN(ALLTRIM(LSinscricao)) <> 9
			LSmens 		= "Inscricao com Tamanho Invalido"
			RETURN(.f.)
	ENDIF

	*------------------------------------------------------------*
	*  CALCULO DO 1o DIGITO
	*------------------------------------------------------------*
	LNsoma		=  0
	LNmult	    =  9

	FOR LNPosicao = 1 TO 8

		LNdigito    = INT(VAL(SUBS(LSinscricao,LNposicao,1)))
		LSproduto	= (LNdigito*LNmult)
		LSproduto	= CHRTRAN(STR(LNdigito*LNmult,2)," ","0")
	    LNsoma   	= LNsoma+ VAL(LSproduto)
    	LNmult 		= LNmult - 1
	NEXT
	
	LNdezena = (LNsoma % 11)	&& Divisao Modal =>  Resto

	IF LNdezena >= 2
		LSdg_Found = 11-LNdezena
	else
		LSdg_Found = 0
	ENDIF
	
	LSdg_Found 	 = CHRTRAN(STR(LSdg_Found ,1)," ","0")
	*--------------------------------------------------*
	LFretorno = .t.
	IF  LSdg_Found <> SUBS(LSinscricao,9,1)			
		LSmens 		= "Digito Invalido para Inscricao"
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
RETURN(LFretorno)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLDL           CLItensAdq VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   20   ╨
*       ╨ Variable:            CLItensAdq                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      289                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gldl     &&  CLItensAdq VALID
#REGION 11
return

*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLItensAdq

PARAMETERS PRcliente, PRdata

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Obter o Valor de Ajuste de Credito na
	*  			data especificada
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO  :
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	
	*-----------------------------------------------------------*
	PRIVATE LSalias
	PRIVATE ARQ_CtrlCred, ALS_CtrlCred
	PRIVATE LNvalor
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
    ARQ_CtrlCred    = NetArqAgain("CTRLCRED")
    ALS_CtrlCred   	= Alias()
	*------------------------------------------------------------*

   	SELE &ALS_CtrlCred
  	SET ORDER TO TAG key_unica
    SEEK STR(PRcliente,14) + DTOS(PRdata)
    IF FOUND()
		LNvalor =  &ALS_CtrlCred .CR_NOVO - &ALS_CtrlCred .CR_ANTIGO
	ELSE
		LNvalor =  0
   	ENDIF	

    =up_fecha("&ALS_CtrlCred")

	*------------------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNvalor)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLDS           CLVldCli VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   21   ╨
*       ╨ Variable:            CLVldCli                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      290                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11glds     &&  CLVldCli VALID
#REGION 11
return

*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLVldCli
PARAMETERS LNcliente,LSinscricao

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFretorno
	PRIVATE LSmsg
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	IF !USED("CLIENTES")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	SELECT clientes
	SET ORDER TO TAG cliente
	*-----------------------------------------------------------*
   	IF LASTKEY() <> 27
		SET NEAR ON
		SEEK LNcliente
		SET NEAR OFF
	    IF FOUND() AND !EMPTY(LSinscricao)
			DO WHILE !EOF() AND LNcliente = clientes.cliente
				IF LSinscricao = clientes.inscricao
					EXIT
				ENDIF
			    SKIP	&& VERIFICA SE E DUPLICADO E CHECA A INSCRICAO
			ENDDO
			IF EOF() OR LNcliente <> clientes.cliente OR ;
		  			LSinscricao <> clientes.inscricao
					SKIP -1			  && PEGAR DADOS DO REG. LOCALIZADP
			ENDIF				  && PRIMEIRO
		ENDIF
		IF LNcliente	= 	clientes.cliente
			LSinscricao	=	clientes.inscricao
		ENDIF
	ENDIF
	*-----------------------------------------------------------*
	*-----------------------------------------------------------*
	*	Critica a localizacao do registro
	*-----------------------------------------------------------*
	IF (LNcliente = 0 OR !FOUND() )
		IF (LNcliente <> 0 AND !FOUND() )
			LSmsg = "Cliente nao cadastrado. Informe "+;
						"dados ou Solicite cadastro. <ENTER>"
			=UPbeeps(.F.,LSmsg)
		ENDIF
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLE0           CLimpARCA VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   22   ╨
*       ╨ Variable:            CLimpARCA                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      291                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11gle0     &&  CLimpARCA VALID
#REGION 11
return

*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

PROCEDURE CLimpARCA

    SET DATE GERMAN
    SET CENTU ON

	LsDados =chr(34) && char '"'   aspas seguida de espaco


	=UPTrataArq("C:\TMP\CLIENTES.XML","C:\TMP\CLI_REC.XML")
	DO ULcadClie



	=UPTrataArq("C:\TMP\LIMITE.XML","C:\TMP\LMT_REC.XML")
	*DO ULcadLimite

RETURN
*******************************************************************
* TRATAMENTO DE ARQUIVOS TEXTOS
*     Trata dados de um arquivo origem DANIFICADO
*   para um arquivo destino TRATADO
*
* DIRETORIOS FIXOS
*					 \SCGC\RECUPERA\  (ESTRUTURAS VAZIAS)		
*					 \TMP\			  (DIRETORIO TEMPORARIO)
*******************************************************************
FUNCTION UPTrataArq
PARAMETERS PrmArqOrigem,PrmArqDestino

   PRIVATE lErro
   PRIVATE LSfiledanificado, LNdanif,LNtamdanif
   PRIVATE LSfilerecuperado, LNrecup
   PRIVATE LSchar,Lstring
   PRIVATE LSorigfie,LSdestfie
   CLOSE ALL

   LSfilerecuperado=PrmArqDestino
   LNrecup 			=fcreate(LSfilerecuperado)
   if LNrecup<0
      =fclose(LNrecup)
      wait 'ERRO cria┤фo arquivo tempor═rio <Enter>' window
      return
   endif



   LSfiledanificado=PrmArqOrigem
   LNdanif    =fopen(LSfiledanificado,0)
   LNtamdanif =fseek(LNdanif,0,2)
   if LNdanif<0 or LNtamdanif<=0
      =fclose(LNdanif)
      wait 'ERRO abertura arquivo <Enter>' window
      return
   endif


	LSchar = ""
	LString = ""
	

	DO  GRVCabecalho
*	DO  FORACAB
	do while !feof(LNdanif)
		DO  IMPODADOS
	ENDDO


		
	
	if lastkey()=27
   		wait 'Processamento interrompido pelo usu═rio <Enter>' window
	    =fclose(LNdanif)
	    =fclose(LNrecup)
	endif
   =fclose(LNdanif)
   =fclose(LNrecup)
   *************************************************************



return

PROCEDURE GRVCabecalho
   *************************************************************
    =fseek(LNdanif,0,0) && move ponteiro p/bof
	LSchar = ""
	LString = ""
	LsDados =chr(34) && char '" '   aspas seguida de espaco

	do while !feof(LNdanif)
      		wait 'Reconstruindo Registros...'+left(LSchar,30)+' <Esc> Pausa' window nowait
      		if inkey()=27
         		wait '<Enter> Continua  <Esc> Pausa' window nowait
         		if inkey(0)=27

            		exit
         		endif
      		endif

      		LSchar = FGETS(LNdanif,1)
      		LString = LString+LSchar

			IF LSchar = ">"
	       		=fPuts(LNrecup,LString,LEN(LString))
	      		LString = ""
			ENDIF

			IF "<ROW " $ LString
	       		=fPuts(LNrecup,LString,LEN(LString))
	      		LString = ""
				EXIT
			ENDIF
	enddo
RETURN

PROCEDURE FORACAB
   *************************************************************
    =fseek(LNdanif,0,0) && move ponteiro p/bof
	LSchar = ""
	LString = ""
	LsDados =chr(34) && char '" '   aspas seguida de espaco

	
	do while !feof(LNdanif)
      		wait 'Reconstruindo Registros...'+left(LSchar,30)+' <Esc> Pausa' window nowait
      		if inkey()=27
         		wait '<Enter> Continua  <Esc> Pausa' window nowait
         		if inkey(0)=27

            		exit
         		endif
      		endif

      		LSchar = FGETS(LNdanif,1)
      		LString = LString+LSchar

			IF LSchar = ">"
	      		LString = ""
			ENDIF

			IF "<ROW " $ LString
	      		LString = ""
				EXIT
			ENDIF

*			IF "<ROWDATA>" $ LString
*	      		LString = ""
*				EXIT
*			ENDIF
	enddo

RETURN

PROCEDURE impodados

	do while !feof(LNdanif)
      		wait 'Reconstruindo Registros...'+left(LSchar,30)+' <Esc> Pausa' window nowait
      		if inkey()=27
         		wait '<Enter> Continua  <Esc> Pausa' window nowait
         		if inkey(0)=27

            		exit
         		endif
      		endif


      		LSchar = LERCHAR()

*			IF LSchar = "/"  OR LSchar = LsDados
*				SET STEP ON
*			ENDIF

			DO CASE
			   CASE LSchar = "/"
	       		    LSNextChar = LERCHAR()
					IF LSNextChar = ">"
						=fPuts(LNrecup,LString,LEN(LString))
*	      				LString = "/>"
					ENDIF
   			  		LString = LString+LSchar+LSNextChar
			   CASE  LSchar = LsDados   && ASPAS
   			  		LString = LString+LSchar
   			  		LSchar = ""
   			  		

	       		    LSNextChar = LERCHAR()
					IF  LSNextChar = LsDados    && COUTRA ASPAS CAMPO VAZIO
    			  		LString = LString+LSNextChar
		       		    LSNextChar = LERCHAR()
					ENDIF
					
					DO CASE
						CASE LSNextChar $ " "
	    			  		LString = LString+LSNextChar
				       		=fPuts(LNrecup,LString,LEN(LString))
			    	  		LString = ""
						CASE LSNextChar $ "/"
				       		=fPuts(LNrecup,LString,LEN(LString))
			    	  		LString = ""
		      				LString = "/"
							EXIT
						OTHERWISE
		   			  		LString = LString+LSNextChar
					ENDCASE
					
				OTHERWISE
   			  		LString = LString+LSchar
			ENDCASE
			IF "<ROW " $ LString
	       		=fPuts(LNrecup,LString,LEN(LString))
	      		LString = ""
				EXIT
			ENDIF
			
	enddo

	if LEN(LString) > 0
		=fPuts(LNrecup,LString,LEN(LString))
	ENDIF

RETURN

FUNCTION LERCHAR
	PRIVATE Lchar
	Lchar = FGETS(LNdanif,1)
RETURN(Lchar)

PROCEDURE ULcadClie
	SELE 0
	USE X:\SCGC\LOJA\CLIENTES

	SELE 0
	USE LINHA EXCL
	ZAP
	PACK
	APPEND FROM C:\TMP\CLI_REC.XML TYPE SDF
	GO TOP

    LSano	  = ""
	LSmes	  = ""
	LSdia	  = ""
	LSTipoEnd = ""


	m.CBendereco 	= ""
	m.CBcep 		= ""
	m.CBbairro 		= ""
	m.CBcidade 		= ""
    m.CBestado 		= ""

	m.endereco 	= ""
	m.cep 		= ""
	m.bairro 	= ""
	m.muni_ibge = 0
	m.cidade 	= ""
    m.estado 	= ""


	m.empresa = 1   && wp_empresa

	DO WHILE !EOF()
		

		IF "/>" $ LINHA    && FINAL DE UM REGISTRO
			SET STEP ON
			DO CASE
				CASE left(LSTipoEnd,3) $ "Fat/Res/End"
					m.endereco 	= Lendereco
					m.cep 		= Lcep
					m.bairro 	= Lbairro
					m.muni_ibge = Lmuni_ibge
					m.cidade 	= Lcidade
				    m.estado 	= Lestado
				CASE LEFT(LSTipoEnd,3) $ "Cob"
					m.CBendereco = Lendereco
					m.CBcep 	 = Lcep
					m.CBbairro 	 = Lbairro
					m.muni_ibge  = Lmuni_ibge
					m.CBcidade 	 = Lcidade
				    m.CBestado 	 = Lestado
			ENDCASE
			LTipoEnd 	= ""
			Lendereco 	= ""
			Lcep 		= ""
			Lbairro 	= ""
			Lmuni_ibge 	= 0
			Lcidade 	= ""
		    Lestado 	= ""
		ENDIF	




		DO CASE
			CASE LEFT(LINHA,23) = "CLNT_CLNT_DATA_CADASTRO"
			   LSano= SUBS(LINHA,26,4)
			   LSmes= SUBS(LINHA,30,2)
			   LSdia= SUBS(LINHA,32,2)
		       m.dtcad = ctod(LSdia+"/"+LSmes+"/"+LSano)

			CASE LEFT(LINHA,12) = "PESS_PESS_ID"
			   m.empresa = INT(VAL(SUBS(LINHA,23,4)))

			CASE LEFT(LINHA,22) = "PESS_PESS_RAZAO_SOCIAL"
			   m.nome= SUBS(LINHA,25)
			   m.nome= RTRIM(STRTRAN(m.nome,LsDados,""))
			   m.CBnome= m.nome

			CASE LEFT(LINHA,14) =    "PESS_PESS_NOME"
			   m.fantasia= SUBS(LINHA,17)
			   m.fantasia= RTRIM(STRTRAN(m.fantasia,LsDados,""))

			CASE LEFT(LINHA,17) =    "PESS_PESS_CPFCNPJ"
			   m.cliente= INT(VAL(SUBS(LINHA,20)))


			CASE LEFT(LINHA,25) =    "PESS_PESS_FISICO_JURIDICO"

			   IF "Jur" $ subs(LINHA,28)
			     m.tp_pessoa = 2   && JURIDICA
			   ELSE
			     m.tp_pessoa = 1   && FISICA
			   ENDIF

			CASE LEFT(LINHA,28) =    "CLNT_CLNT_OBJETIVO_COMERCIAL"

			   IF "Consumo" $ subs(LINHA,31)
			     m.revendedor = "N"
			   ELSE
			     m.revendedor = "S"
			   ENDIF

			CASE LEFT(LINHA,16) =    "DOCS_DOCS_NUMERO"
			   m.inscricao = SUBS(LINHA,19)
			   IF "ISENTO" $ m.inscricao
			      m.tp_inscr = 2
			   ELSE
			      m.tp_inscr = 1
			   ENDIF
			   m.inscricao= RTRIM(STRTRAN(m.inscricao,LsDados,""))

			CASE LEFT(LINHA,14) =    "TPEN_TPEN_NOME"
			   LSTipoEnd 	= SUBS(LINHA,17)
			   LSTipoEnd= RTRIM(STRTRAN(LSTipoEnd,LsDados,""))

			CASE LEFT(LINHA,25) =    "ENDE_ENDE_TIPO_LOGRADOURO"
			   Lendereco 	= SUBS(LINHA,28)
			   Lendereco= RTRIM(STRTRAN(Lendereco,LsDados,""))

			CASE LEFT(LINHA,16) =    "ENDE_ENDE_NUMERO"
			   Lendereco 	= Lendereco+" "+SUBS(LINHA,19)
			   Lendereco= RTRIM(STRTRAN(Lendereco,LsDados,""))

			CASE LEFT(LINHA,20) =    "ENDE_ENDE_LOGRADOURO"
			   Lendereco 	= Lendereco+" "+SUBS(LINHA,23)
			   Lendereco= RTRIM(STRTRAN(Lendereco,LsDados,""))

			CASE LEFT(LINHA,21) =    "ENDE_ENDE_COMPLEMENTO"
			   Lendereco 	= Lendereco+" "+SUBS(LINHA,24)
			   Lendereco= RTRIM(STRTRAN(Lendereco,LsDados,""))

			CASE LEFT(LINHA,13) =    "ENDE_ENDE_CEP"
			   Lcep = SUBS(LINHA,16)
			   Lcep = RTRIM(STRTRAN(Lcep,LsDados,""))

			CASE LEFT(LINHA,14) =    "BAIR_BAIR_NOME"
			   Lbairro 	= SUBS(LINHA,17)
			   Lbairro  = RTRIM(STRTRAN(Lbairro,LsDados,""))

			CASE LEFT(LINHA,14) =    "MUNI_MUNI_IBGE"
			   Lmuni_ibge 	= INT(VAL(SUBS(LINHA,17)))

			CASE LEFT(LINHA,14) =    "MUNI_MUNI_NOME"
			   Lcidade 	= SUBS(LINHA,17)
			   Lcidade  = RTRIM(STRTRAN(Lcidade,LsDados,""))

			CASE LEFT(LINHA,12) =    "ESTA_ESTA_UF"
			   Lestado 	= SUBS(LINHA,15)
			   Lestado= RTRIM(STRTRAN(Lestado,LsDados,""))

			CASE LEFT(LINHA,16) =    "TELE_TELE_NUMERO"
			   m.fone = SUBS(LINHA,19)
			   m.fone= RTRIM(STRTRAN(m.fone,LsDados,""))

			CASE LEFT(LINHA,23) =    "LMCR_LMCR_LIMITE_MENSAL"
			   m.credito= INT(VAL(SUBS(LINHA,26)))


		ENDCASE
		SELE LINHA
		SKIP
	ENDDO
	
	IF EMPTY(m.CBendereco)
		m.CBendereco 	= m.endereco
		m.CBcep 		= m.cep
		m.CBbairro 		= m.bairro
		m.CBcidade 		= m.cidade
	    m.CBestado 		= m.estado
	ENDIF




	SELE CLIENTES
	SET ORDER TO TAG CLIENTE
	SEEK M.CLIENTE
	IF !FOUND()
		APPEND BLANK
	ENDIF
	=RLOCK()
	GATHER MEMVAR
	

RETURN



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLE1           CLVld_CPF_CNPJ VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   23   ╨
*       ╨ Variable:            CLVld_CPF_CNPJ                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      292                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11gle1     &&  CLVld_CPF_CNPJ VALID
#REGION 11
RETURN


*--------------------------------------------------------------------*
* objetivo : consiste CGC ou CPF                                     *
*--------------------------------------------------------------------*

FUNCTION CLVld_CPF_CNPJ
   parameter PrmCPF_Cnpj

   PRIVATE LNTMP

   IF EMPTY(PrmCPF_Cnpj)
   	  return(.f.)
   ENDIF
	

   LNtmp = CLCalc_cgc(PrmCPF_Cnpj)

*   IF  isadding AND LNtmp = "3"
*		RETURN(.F.)
*   ENDIF

   IF LNtmp = "3"
		RETURN(.F.)
   ENDIF


RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLEN           CLDef_TipoPessoa VALID             ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   24   ╨
*       ╨ Variable:            CLDef_TipoPessoa                   ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      293                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11glen     &&  CLDef_TipoPessoa VALID
#REGION 11
RETURN


*--------------------------------------------------------------------*

FUNCTION CLDef_TipoPessoa
   parameter PrmCPF_Cnpj



   PRIVATE LNTMP
   PRIVATE LNtp_pessoa

   LNtmp = CLCalc_cgc(PrmCPF_Cnpj)

   DO CASE
	
		CASE LNtmp = "1"
			LNtp_pessoa = 1
		CASE LNtmp = "2"
			LNtp_pessoa = 2
		OTHERWISE
			LNtp_pessoa = 0
   ENDCASE
RETURN(LNtp_pessoa)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLET           CLEsperaRspCad VALID               ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   26   ╨
*       ╨ Variable:            CLEsperaRspCad                     ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      294                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11glet     &&  CLEsperaRspCad VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION CLEsperaRspCad
PARAMETERS PrmEmpresa


	*-------------------------------------------------------*
	PRIVATE LSstatus
	PRIVATE CtrAguarda

	LSstatus = ""

    CtrAguarda = 0
	LFlgEspera = .t.

	DO WHILE LFlgEspera


		LSstatus=CLBuscaArqRspCad(PrmEmpresa)

		DO CASE
 		 	CASE "ERRO ! Espera interrompida por usr" $ LSstatus
				LFlgEspera = .F.
		
			otherwise
				LFlgEspera = .F.

		ENDCASE
	ENDDO
    LSmsg = "Concluido leitura XML............ "
	WAIT WINDOW LSmsg NOWAIT

RETURN(LSstatus)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLEZ           CLBuscaRspCad VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   27   ╨
*       ╨ Variable:            CLBuscaRspCad                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      295                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11glez     &&  CLBuscaRspCad VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION CLBuscaRspCad
PARAMETERS PrmEmpresa

	*-------------------------------------------------------*

	PRIVATE LSnroDoc
	PRIVATE LNfile
	PRIVATE LSstatus,LSFile,LNctr,TECLA




	*-------------------------------------------------------*
	*  obter o MOD_DOC
	*-------------------------------------------------------*



	*----------------------------------------------------------*

	LSstatus = ""
	LNfile = 0



	*--------------------------------------------------*

	=W_DEFPROC("PARAMETR.SPR")

	LSPathDestino   = PMGetFieldValue(PrmEmpresa,"DIR_DFIS")



    IF TYPE("LSPathDestino") <> "C" or EMPTY(LSPathDestino)
         LSPathDestino = "C:\NFE\"
	else
         LSPathDestino = ALLTRIM(LSPathDestino)
    ENDIF


	*--------------------------------------------------*



	LSFile    = LSPathDestino+"EXPCLIEN.TXT"


	LNctr = 0

	CLEAR TYPEAHEAD


	DO WHILE !(FILE(LSFile))

   	   LSmsg = STR(LNctr,3)+"-Aguarda Cadastro - <ESC>=Sai "+LSFile

		WAIT WINDOW LSmsg NOWAIT
		TECLA=INKEY(3)
		LNctr = LNctr + 1
		IF  LNctr > 1   && > 60
			EXIT
		ENDIF
		IF TECLA = 27 OR LASTKEY() = 27
			IF fox_alert("Interrompe Espera Cadastro ? ")
				LSstatus = "ERRO ! Espera interrompida por usr"
				EXIT
			ENDIF
		ENDIF

	ENDDO

	DO CASE
		CASE LSstatus = "ERRO ! Espera interrompida por usr"
 		 	LSstatus = "ERRO ! Espera interrompida por usr"

		CASE !FILE(LSFile)
			LSstatus = "ERRO ! Nao houve retorno do comando"

		OTHERWISE		
			TECLA=INKEY(3)

            =CLImpCadOrion(LSFile)
			LSstatus=""

			IF FILE(LSFile)
		   		delete file &LSFile
			ENDIF


	ENDCASE

	*---------------------------------------------------*
	* as barrar fornecem uma orientacao para se tratar
	* o retorno quando nao sao informados todos os
	* parametros de retorno.
	* A rotina (DFRespostaNFe ) que trata o staus identifique o
	* os parametro nao retornados com
	*---------------------------------------------------*
	LSstatus = LSstatus + "||||||||||||||||||||||||||||||"


RETURN(LSstatus)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLF8           CLImportaCad VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   28   ╨
*       ╨ Variable:            CLImportaCad                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      296                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11glf8     &&  CLImportaCad VALID
#REGION 11
return
*---------------------------------------------------------------*
*		   PrmEsperaResposta,;
*		       && "ESPERA" ou "NAO ESPERA"
*
*---------------------------------------------------------------*

FUNCTION CLImportaCad

PARAMETER  PrmEmpresa,;
           PrmEsperaResposta,;
		   RtnStatus
		
	*-------------------------------------------------------*

	PRIVATE LSalias
	PRIVATE PrmAlsCL

	LSalias = ALIAS()
	PrmAlsCL = CLGetAlias()

	SELE &PrmAlsCL

	GO BOTT
	GO TOP

		
		
		
		
	*-------------------------------------------------------*
	PRIVATE LSstatus,LSstatus2
	LSstatus = ""
    LSstatus2 = ""

	IF PrmEsperaResposta = "ESPERA"
		LSstatus=CLEsperaRspCad(PrmEmpresa)
	ELSE
		LSstatus=CLBuscaRspCad(PrmEmpresa)
	ENDIF


	*-------------------------------------------------------*


	DO CASE

		CASE LSstatus = "ERRO ! Nao houve retorno do comando"
				RtnStatus = LSstatus
	
		ENDCASE


 	   IF !EMPTY(LSalias) AND USED(LSalias)
		  SELECT &LSalias
	   ENDIF


RETURN(LSstatus+LSstatus2)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLFF           CLImpCadOrion VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         CLIEN_R,     Record Number:   30   ╨
*       ╨ Variable:            CLImpCadOrion                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      297                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _42s11glff     &&  CLImpCadOrion VALID
#REGION 11
RETURN

FUNCTION CLImpCadOrion
PARAMETER PrmLSFile


*			PrmLSFile = "X:\TMP\CLIENTE.TXT"	

			PRIVATE LNFile
			PRIVATE LSCampo
			PRIVATE LSConteudo


            SET DATE GERMAN
            SET CENTU ON


* -----------------------------



			LNfile=FOPEN(PrmLSFile)	

			IF LNfile > 0
				LSstatus=""

				DO WHILE !FEOF(LNfile)
                    * preencher cadastro com base no txt

					LScampo    = RTRIM(UPPER(fgets(LNfile,255)))
	                IF FEOF(LNfile)
	                   EXIT
	                ENDIF
					LSconteudo = RTRIM(UPPER(fgets(LNfile,255)))


                    DO CASE
                       CASE  UPPER(LScampo) = "EMPRESA"
                             m.empresa = INT(VAL(LSconteudo))
                       CASE  UPPER(LScampo) = "TP_PESSOA"
                            if "SICA" $ UPPER(LSconteudo) && O sinal agudo nao e reconhecido
                                     m.tp_pessoa = 1
                            else
                                     m.tp_pessoa = 1
                            endif
                       CASE  UPPER(LScampo) = "CLIENTE"
                             m.cliente = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "NOME"
                             m.NOME      = LSconteudo

                       CASE  UPPER(LScampo) = "TP_INSCR"
                             m.tp_inscr = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "INSCRICAO"
                            if "ISENT" $ UPPER(LSconteudo) && ISENT vai pertencer tanto a ISENTO como a ISENTA
                                     m.inscricao = "ISENTO"
                            else
                                     m.inscricao = LSconteudo
                            endif

                       CASE  UPPER(LScampo) = "INSSUBSISS"
                             m.inssubsiss = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "IM_TOMADOR"
                             m.IM_TOMADOR = LSconteudo

                       CASE  UPPER(LScampo) = "REVENDEDOR"
                             m.REVENDEDOR = LSconteudo

                       CASE  UPPER(LScampo) = "REVENDEDOR"
                             m.REVENDEDOR = LSconteudo

*------------>


                       CASE  UPPER(LScampo) = "FANTASIA"
                             m.FANTASIA = LSconteudo


                       CASE  UPPER(LScampo) = "TP_LOGRADOURO"
                             m.TmpTP_LOGR = LSconteudo

                       CASE  UPPER(LScampo) = "ENDERECO"
                             m.TmpENDERECO = LSconteudo

                       CASE  UPPER(LScampo) = "NRO_LOGR"
                             m.TmpNRO_LOGR = LSconteudo

                       CASE  UPPER(LScampo) = "COMPLEMENTO"
                             m.TmpComplemento = LSconteudo

*------------->

                       CASE  UPPER(LScampo) = "BAIRRO"
                             m.BAIRRO = LSconteudo

                       CASE  UPPER(LScampo) = "CIDADE"
                             m.CIDADE = LSconteudo

                       CASE  UPPER(LScampo) = "ESTADO"
                             m.ESTADO = LSconteudo

                       CASE  UPPER(LScampo) = "CEP"
                             m.CEP = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "MUNI_IBGE"
                             m.MUNI_IBGE = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "FONE"
                             m.FONE  = LSconteudo

                       CASE  UPPER(LScampo) = "FONE"
                             m.FONE  = LSconteudo

*------------>

                       CASE  UPPER(LScampo) = "CBNOME"
                             m.CBNOME = LSconteudo


                       CASE  UPPER(LScampo) = "CBTP_LOGRADOURO"
                             m.TmpCBTP_LOGR = LSconteudo

                       CASE  UPPER(LScampo) = "CBENDERECO"
                             m.TmpCBENDERECO = LSconteudo

                       CASE  UPPER(LScampo) = "CBNRO_LOGR"
                             m.TmpCBNRO_LOGR = LSconteudo

                       CASE  UPPER(LScampo) = "CBCOMPLEMENTO"
                             m.TmpCBComplemento = LSconteudo






                       CASE  UPPER(LScampo) = "CBBAIRRO"
                             m.CBBAIRRO = LSconteudo

                       CASE  UPPER(LScampo) = "CBCIDADE"
                             m.CBCIDADE = LSconteudo

                       CASE  UPPER(LScampo) = "CBESTADO"
                             m.CBESTADO = LSconteudo

                       CASE  UPPER(LScampo) = "CBCEP"
                             m.CBCEP = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "CBMUNI_IBGE"
                             m.CBMUNI_IBGE = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "CBFONE"
                             m.CBFONE  = LSconteudo

                       CASE  UPPER(LScampo) = "CBFONE"
                             m.CBFONE  = LSconteudo

*------------>

                       CASE  UPPER(LScampo) = "CREDITO"
                             m.CREDITO  = VAL(LSconteudo)


                       CASE  UPPER(LScampo) = "DTCAD"
                             m.DTCAD  = CTOD(LSconteudo)

                       CASE  UPPER(LScampo) = "ULTSERVICO"
                             m.ULTSERVICO  = CTOD(LSconteudo)


                       CASE  UPPER(LScampo) = "ULTATEND" or UPPER(LScampo) = "ULT_ATEND"
                             m.ULT_ATEND  = CTOD(LSconteudo)

                       CASE  UPPER(LScampo) = "REGIAO"
                             m.REGIAO  = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "STATUS"
                             m.STATUS  = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "NATUREZA"
                             m.NATUREZA  = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "NATUREZA"
                             m.NATUREZA  = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "VENDEDOR"
                             m.VENDEDOR  = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "USRVINCVND"
                             m.USRVINCVND  = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "SEXO"
                             m.SEXO  = LSconteudo

                       CASE  UPPER(LScampo) = "DT_NASC"
                             m.DT_NASC  = CTOD(LSconteudo)

                       CASE  UPPER(LScampo) = "DT_ALTER"
                             m.DT_ALTER  = CTOD(LSconteudo)

                       CASE  UPPER(LScampo) = "LMT_PARCEL"
                             m.LMT_PARCEL  = LSconteudo

                       CASE  UPPER(LScampo) = "VENDEDOR2"
                             m.VENDEDOR2  = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "USR_REGIS"
                             m.USR_REGIS  = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "DT_ALTCR"
                             m.DT_ALTCR  = CTOD(LSconteudo)


                       CASE  UPPER(LScampo) = "USR_ALTCR"
                             m.USR_ALTCR  = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "DTLIBERACD"
                             m.DTLIBERACD  = CTOD(LSconteudo)

                       CASE  UPPER(LScampo) = "USLIBERACD"
                              m.USLIBERACD  = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "DTREGIS"
                             m.DTREGIS  = CTOD(LSconteudo)

                       CASE  UPPER(LScampo) = "HREGIS"
                             m.HREGIS  = LSconteudo

                       CASE  UPPER(LScampo) = "USRREGIS"
                              m.USRREGIS  = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "E_MAIL"
                             m.E_MAIL  = LSconteudo

                       CASE  UPPER(LScampo) = "E_MAIL_NFE"
                             m.E_MAIL_NFE  = LSconteudo

                       CASE  UPPER(LScampo) = "SEGUIMENTO"
                              m.SEGUIMENTO  = INT(VAL(LSconteudo))


                       CASE  UPPER(LScampo) = "OBS"
                              m.OBS  = LSconteudo

                       CASE  UPPER(LScampo) = "SUBST_ISS"
                              m.SUBST_ISS  = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "EMITE_BLTO"
                              m.EMITE_BLTO  = LSconteudo

                    ENDCASE


				ENDDO

				=FCLOSE(LNfile)

                do  SETMEMVET

           	    =W_DEFPROC("CLIENTES.SPR")
                =CLSalvarRegistro()

			ENDIF
			
 			
RETURN

PROCEDURE SETMEMVET

	=W_DEFPROC("rotinas.spr")


    =W_DEFPROC("CLIENTES.SPR")
	=CLVerifyInst()


    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("EMPRESA", M.EMPRESA)


	=W_DEFPROC("rotinas.spr")
    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("TP_PESSOA", M.TP_PESSOA)
	
    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CLIENTE", M.CLIENTE)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("NOME", M.NOME)
	
    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("TP_INSCR", M.TP_INSCR)
	
    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("INSCRICAO", M.INSCRICAO)
	
    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("INSSUBSISS", M.INSSUBSISS)
	
    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("IM_TOMADOR", M.IM_TOMADOR)
	
    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("REVENDEDOR", M.REVENDEDOR)
	
    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("FANTASIA", M.FANTASIA)



*---------------------------------
    M.ENDERECO =    RTRIM(m.TmpTP_LOGR) + " " +;
                    RTRIM(m.TmpENDERECO) + " " +;
                    "nro. " +;
                    RTRIM(m.TmpNRO_LOGR) + " " +;
                    RTRIM(m.TmpComplemento)




    M.CBENDERECO =    RTRIM(m.TmpCBTP_LOGR) + " " +;
                    RTRIM(m.TmpCBENDERECO) + " " +;
                    "nro. " +;
                    RTRIM(m.TmpCBNRO_LOGR) + " " +;
                    RTRIM(m.TmpCBComplemento)






*------------------------------------


    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("ENDERECO", M.ENDERECO)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("NRO_LOGR", M.TmpNRO_LOGR)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("BAIRRO", M.BAIRRO)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CIDADE", M.CIDADE)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("ESTADO", M.ESTADO)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CEP", M.CEP)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("MUNI_IBGE", M.MUNI_IBGE)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("FONE", M.FONE)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CBNOME", M.CBNOME)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CBENDERECO", M.CBENDERECO)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CBNRO_LOGR", M.TmpCBNRO_LOGR)


    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CBBAIRRO", M.CBBAIRRO)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CBCIDADE", M.CBCIDADE)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CBESTADO", M.CBESTADO)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CBCEP", M.CBCEP)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CBCEP", M.CBCEP)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CBFONE", M.CBFONE)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("CREDITO", M.CREDITO)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("DTCAD", M.DTCAD)


    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("ULTSERVICO", M.ULTSERVICO)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("ULT_ATEND", M.ULT_ATEND)


    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("REGIAO", M.REGIAO)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("STATUS", M.STATUS)


    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("NATUREZA", M.NATUREZA)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("VENDEDOR", M.VENDEDOR)

	
    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("USRVINCVND", M.USRVINCVND)


    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("SEXO", M.SEXO)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("DT_NASC", M.DT_NASC)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("DT_ALTER", M.DT_ALTER)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("LMT_PARCEL", M.LMT_PARCEL)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("VENDEDOR2", M.VENDEDOR2)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("USR_REGIS", M.USR_REGIS)


    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("DT_ALTCR", M.DT_ALTCR)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("USR_ALTCR", M.USR_ALTCR)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("DTLIBERACD", M.DTLIBERACD)


    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("USLIBERACD", M.USLIBERACD)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("DTREGIS", M.DTREGIS)


    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("HREGIS", M.HREGIS)



    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("USRREGIS", M.USRREGIS)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("E_MAIL", M.E_MAIL)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("E_MAIL_NFE", M.E_MAIL_NFE)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("SEGUIMENTO", M.SEGUIMENTO)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("OBS", M.OBS)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("SUBST_ISS", M.SUBST_ISS)

    =W_DEFPROC("CLIENTES.SPR")
	=CLSetPropVT("EMITE_BLTO", M.EMITE_BLTO)




RETURN

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLFG           APtemp_res VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         AUTOPROC,     Record Number:    2  ╨
*       ╨ Variable:            APtemp_res                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      298                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11glfg     &&  APtemp_res VALID
#REGION 12
return
*---------------------------------------------------------------*
FUNCTION APtemp_res

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LStmplib		&& LE A HORA DA ULTIMA LIBERACAO DE RESERVA
	PRIVATE LNtmpEspera     && TEMPO EM MINUTOS ENTRE UMA VERIFICACAO
	                        && E OUTRA

	SELE TIMEPROC
	SET ORDER TO TAG PROCESSO
	SEEK "VERIFICA RESERVA"
	
*	IF FOUND() AND RLOCK()
*		LStmplib    = ULTIMAEXEC
*		LNtmpEspera = MINUTOSITV
*
*		IF EMPTY(LNtmpEspera)
*			LStmpEspera= 10
*		ENDIF
*
*		IF LStmplib > TIME() ;
*			OR UPtempopas(DATE(), DATE(), LStmplib, TIME()) >= LNtmpEspera
*
*			*--------------------------------------------------*
*
*			DO SCGC204.PRG
*
*			*--------------------------------------------------*
*			LStmplib = time()
*			REPLACE ULTIMAEXEC WITH LStmplib
*		ENDIF
*	ENDIF



	IF FOUND() AND RLOCK()

			LDDtUltmaExec	= timeproc.DT_ULTEXEC
			LSHraUltmaExec  = timeproc.ULTIMAEXEC


			LNtmpEspera = timeproc.MINUTOSITV
			IF EMPTY(LNtmpEspera)
				LNtmpEspera= 10
			ENDIF
			IF (UPtempopas(LDDtUltmaExec, DATE(), LSHraUltmaExec, TIME())) ;
			      >= (LNtmpEspera)

				LSHraUltmaExec = time()

				REPLACE timeproc.DT_ULTEXEC WITH DATE()
				REPLACE timeproc.ULTIMAEXEC WITH LSHraUltmaExec

				*--------------------------------------------------*

				DO SCGC204.PRG

				*--------------------------------------------------*
			ENDIF
	ENDIF




	UNLOCK
RETURN(.t.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLG4           APtemp_BkpML VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         AUTOPROC,     Record Number:    3  ╨
*       ╨ Variable:            APtemp_BkpML                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      299                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11glg4     &&  APtemp_BkpML VALID
#REGION 12
return
*---------------------------------------------------------------*
FUNCTION APtemp_BkpML
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LSEstacao
	PRIVATE LDDtUltmaExec		&& LE A HORA DA ULTIMA LIBERACAO DE RESERVA
	PRIVATE LSHraUltmaExec		&& LE A HORA DA ULTIMA LIBERACAO DE RESERVA
	PRIVATE LNtmpEspera     && TEMPO EM MINUTOS ENTRE UMA VERIFICACAO
	                        && E OUTRA

	SELE TIMEPROC
	SET ORDER TO TAG PROCESSO
	SEEK "BACKUP ML"
	IF FOUND() AND RLOCK()
		LSEstacao = SYS(0)
		LSestacao =SUBS(LSestacao,1,at(" ",LSestacao)-1)

		
		IF   EMPTY(timeproc.NMESTACOES) ;
		  OR LSEstacao $ UPPER(timeproc.NMESTACOES)

			LDDtUltmaExec	= timeproc.DT_ULTEXEC
			LSHraUltmaExec  = timeproc.ULTIMAEXEC


			LNtmpEspera = timeproc.MINUTOSITV
			IF EMPTY(LNtmpEspera)
				LNtmpEspera= 10
			ENDIF
			IF (UPtempopas(LDDtUltmaExec, DATE(), LSHraUltmaExec, TIME())) ;
			      >= (LNtmpEspera)

				LSHraUltmaExec = time()

				REPLACE timeproc.DT_ULTEXEC WITH DATE()
				REPLACE timeproc.ULTIMAEXEC WITH LSHraUltmaExec

				*--------------------------------------------------*

				=W_DEFPROC("SCGC002.SPR")
				DO ULinicializa

				*--------------------------------------------------*
			ENDIF
		ENDIF		
	ENDIF
	UNLOCK
RETURN(.t.)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _42S11GLGC           APTempGeral VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         AUTOPROC,     Record Number:    4  ╨
*       ╨ Variable:            APTempGeral                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      300                                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _42s11glgc     &&  APTempGeral VALID
#REGION 12
return
*---------------------------------------------------------------*
FUNCTION APTempGeral
	PRIVATE LSaliasTime
	PRIVATE LFTimeProc

	=W_DEFPROC("rotinas.spr")


	LSaliasTime = alias()

	LFTimeProc = NetArq("TIMEPROC")
	IF LFTimeProc > 1000
		RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
	*  CONTROLE DE LIBERACAO DE RESERVAS
	*----------------------------------------------------------*
	=APtemp_res()


	*----------------------------------------------------------*
	*  CONTROLE DE BACKUP  ML
	*----------------------------------------------------------*
	=APtemp_BkpML()


	IF !EMPTY(LSaliasTime) AND USED(LSaliasTime)
		SELECT &LSaliasTime
	ENDIF

RETURN(.t.)
