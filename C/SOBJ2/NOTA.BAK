*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º 13/06/2014             NOTA.SPR                10:09:40 º
*       º                                                         º
*       ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶
*       º                                                         º
*       º Author's Name                                           º
*       º                                                         º
*       º Copyright (c) 2014 Company Name                         º
*       º Address                                                 º
*       º City,     Zip                                           º
*       º                                                         º
*       º Description:                                            º
*       º This program was automatically generated by GENSCRN.    º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º                MS-DOS Window definitions                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º           NOTA/MS-DOS Setup Code - SECTION 2            º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 1
return

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º          NOTA_A/MS-DOS Setup Code - SECTION 2           º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 2
return

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º          NOTA_B/MS-DOS Setup Code - SECTION 2           º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 3
return

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º           PRECO/MS-DOS Setup Code - SECTION 2           º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 5
return

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º          ESTOQUE/MS-DOS Setup Code - SECTION 2          º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 6
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º         ORCAMENT/MS-DOS Setup Code - SECTION 2          º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 7
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º         ORCAMNTA/MS-DOS Setup Code - SECTION 2          º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 8
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º         DUPLICAT/MS-DOS Setup Code - SECTION 2          º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 9
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º         DUPLIC_A/MS-DOS Setup Code - SECTION 2          º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 10
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º                NOTA/MS-DOS Screen Layout                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 1
@ 1,0 SAY "====> Com Uso de pseudo OO" ;
	SIZE 1,26, 0
@ 5,5 GET NFVerifyInst ;
	PICTURE "@*HN NFVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _43a0ls1yy()
@ 6,8 GET NFCreate ;
	PICTURE "@*HN NFCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _43a0ls1z6()
@ 14,8 GET NFDestroi ;
	PICTURE "@*HN NFDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _43a0ls1z7()
@ 8,11 GET NFReadProp ;
	PICTURE "@*HN NFReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls1zm()
@ 11,14 GET NFSetDerivadas ;
	PICTURE "@*HN NFSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _43a0ls1zs()
@ 9,14 GET NFSetPropVT ;
	PICTURE "@*HN NFSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls1zz()
@ 10,14 GET NFGetPropVT ;
	PICTURE "@*HN NFGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls205()
@ 4,0 GET NFChk_Identidade ;
	PICTURE "@*HN NFChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _43a0ls20f()
@ 3,0 GET NFFind ;
	PICTURE "@*HN NFFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls20m()
@ 16,0 GET NFGetFieldValue ;
	PICTURE "@*HN NFGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls20t()
@ 15,0 GET NF_Refresh ;
	PICTURE "@*HN NF_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _43a0ls20u()
@ 12,11 GET NFWriteProp ;
	PICTURE "@*HN NFWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _43a0ls216()
@ 19,0 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 21,0 GET NFLerRegistro ;
	PICTURE "@*HN NFLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _43a0ls21c()
@ 22,0 GET NFSalvarRegistro ;
	PICTURE "@*HN NFSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _43a0ls21i()
@ 20,0 GET NFExiste ;
	PICTURE "@*HN NFExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls21p()
@ 23,0 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 17,0 GET NFGetAlias ;
	PICTURE "@*HN NFGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls21x()
@ 24,0 GET NFFaxinaDados ;
	PICTURE "@*HN NFFaxinaDados-Retira char invalidor e outras validacoes" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _43a0ls223()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º               NOTA_A/MS-DOS Screen Layout               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 2
@ 30,1 TO 30,78
@ 3,1 GET NFRgAvisoCaixa ;
	PICTURE "@*HN 10-NFRgAvisoCaixa - Gera Registro de Lancamento para Sistema de Caixa" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _43a0ls22b()
@ 4,4 GET NFRgAvistaCaixa ;
	PICTURE "@*HN 10A-NFRgAvistaCaixa-Gera Reg.NF.A Vista Lancamento para Sistema de Caixa" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _43a0ls22c()
@ 5,4 GET NFRgAprazoCaixa ;
	PICTURE "@*HN 10B-NFRgAprazoCaixa-Gera Reg.NF.A Prazo Lancamento para Sistema de Caixa" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _43a0ls22t()
@ 6,1 GET NFCnAvisoCaixa ;
	PICTURE "@*HN 11-NFCnAvisoCaixa - Gera Registro Cancelamento de Lanc. para Sistema de Caixa" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _43a0ls233()
@ 7,4 GET NFCnAvstaCaixa ;
	PICTURE "@*HN 11A-NFCnAvstaCaixa-Gera Reg.NF.A Vista Lancamento para Sistema de Caixa" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _43a0ls23a()
@ 8,4 GET NFCnAprzoCaixa ;
	PICTURE "@*HN 11B-NFCnAprzoCaixa-Gera Reg.NF.A Prazo Lancamento para Sistema de Caixa" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _43a0ls23o()
@ 9,1 GET NFNroNFServico ;
	PICTURE "@*HN 12-NFNroNFServico - Numero da Ultima NF. Servico" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _43a0ls23x()
@ 10,1 GET NFNroCtrlCupom ;
	PICTURE "@*HN 12-NFNroCtrlCupom  - Numero do Ultimo Cupom" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _43a0ls247() ;
	DISABLE
@ 11,1 GET NFDelItensNf ;
	PICTURE "@*HN 14-NFDelItensNf- Apaga Itens de Nota no Arq. Movimento" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _43a0ls24e()
@ 12,1 GET NFdefNatureza ;
	PICTURE "@*HN 15-NFdefNatureza - Define a Menssagem do Campo Natureza em RELNFS2" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _43a0ls24n()
@ 13,1 GET NFpede_cancelamento ;
	PICTURE "@*HN 16-NFpede_cancelamento-Seleciona Doc Fiscal Para Cancelamento" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _43a0ls24u()
@ 17,3 GET NFCancNota ;
	PICTURE "@*HN NFCancNota-" ;
	SIZE 1,13,1 ;
	DEFAULT 1 ;
	VALID _43a0ls255()
@ 22,3 GET NFCancCupom ;
	PICTURE "@*HN 16.2-NFCancCupom" ;
	SIZE 1,18,1 ;
	DEFAULT 1 ;
	VALID _43a0ls25d()
@ 23,3 GET NFCancTEF ;
	PICTURE "@*HN 16.3-NFCancTEF" ;
	SIZE 1,16,1 ;
	DEFAULT 1 ;
	VALID _43a0ls25n()
@ 24,3 GET NFCancNCN ;
	PICTURE "@*HN 16.4-NFCancNCN" ;
	SIZE 1,16,1 ;
	DEFAULT 1 ;
	VALID _43a0ls25x()
@ 20,3 GET NFCanCopias ;
	PICTURE "@*HN 16.5-NFCanCopias" ;
	SIZE 1,18,1 ;
	DEFAULT 1 ;
	VALID _43a0ls266()
@ 18,3 GET NFCancNfSrv ;
	PICTURE "@*HN NFCancNfSrv-" ;
	SIZE 1,14,1 ;
	DEFAULT 1 ;
	VALID _43a0ls26e()
@ 25,3 GET NFCtrlCancFatura ;
	PICTURE "@*HN 16-NFCtrlCancFatura - Controla o Cancelamento de Notas Fiscais/Cupons Visnculados" ;
	SIZE 1,83,1 ;
	DEFAULT 1 ;
	VALID _43a0ls26n()
@ 26,7 GET NFCancFatura ;
	PICTURE "@*HN 16-NFCancFatura / UNFdesfatura - Cancela Nota Fiscal" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls26y()
@ 27,11 GET UNFbaixa_saldo ;
	PICTURE "@*HN 16.1-UNFbaixa_saldo" ;
	SIZE 1,21,1 ;
	DEFAULT 1 ;
	VALID _43a0ls27b()
@ 28,11 GET UNFdesfatura ;
	PICTURE "@*HN 16.2-UNFdesfatura " ;
	SIZE 1,20,1 ;
	DEFAULT 1 ;
	VALID _43a0ls27i()
@ 29,11 GET ULatvitem ;
	PICTURE "@*HN 16.3-ULatvitem" ;
	SIZE 1,16,1 ;
	DEFAULT 1 ;
	VALID _43a0ls27q()
@ 31,1 GET NFEcfInforme ;
	PICTURE "@*HN 17-NFEcfInforme - Informa o 1o e Ultimo Cupom do Periodo, Vlr.Registrado e Vlr.ICMS" ;
	SIZE 1,85,1 ;
	DEFAULT 1 ;
	VALID _43a0ls27w()
@ 32,1 GET NFtot_nfs ;
	PICTURE "@*HN 18-NFtot_nfs  - Totaliza notas Fiscais de Saida do Periodo - Apoio Importacao" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _43a0ls285()
@ 33,1 GET NFgeraBonus ;
	PICTURE "@*HN 19-NFgeraBonus - Gera Bonus para Uso em Servico" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _43a0ls28c()
@ 34,1 GET NFCancBonus ;
	PICTURE "@*HN 20-NFCancBonus - Cancela Bonus para Uso em Servico" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _43a0ls28d()
@ 35,1 GET NFVldPortFatura ;
	PICTURE "@*HN 21-NFVldPortFatura - Valida Faturamento Para Portador XXX" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls28v()
@ 36,1 GET NFConjNfRef ;
	PICTURE "@*HN 22-NFConjNfRef - Consulta Nf com a mesma referencia" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _43a0ls293()
@ 39,4 GET NFDMSVer20 ;
	PICTURE "@*HN 25-NFDMSVer20 - Gera DMS por Parametros apos mudanaca que desvincula CUPOM e NOTA" ;
	SIZE 1,83,1 ;
	DEFAULT 1 ;
	VALID _43a0ls29i()
@ 43,5 GET NFSqlDMS ;
	PICTURE "@*HN 25-NFSqlDMS-Gera CURSOR com NF Servico pra base de Rel.Prest.Serv e DMS" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _43a0ls29s()
@ 1,1 GET NFView ;
	PICTURE "@*HN NFView - Browse das Notas " ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _43a0ls29t()
@ 2,1 GET NF_aviso ;
	PICTURE "@*HN NF_aviso - Trata avisos ao operador" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2ad() ;
	COLOR SCHEME 14
@ 40,4 GET NFDMSVer30 ;
	PICTURE "@*HN 25-NFDMSVer30 - Gera DMS por Parametros apos mudanaca que desvincula CUPOM e NOTA" ;
	SIZE 1,83,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2ak()
@ 38,1 GET NFDMS ;
	PICTURE "@*HN NFDMS - Gera DMS por Parametros apos mudanaca que desvincula CUPOM e NOTA" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2av()
@ 41,4 GET NFDMSVer40 ;
	PICTURE "@*HN 25-NFDMSVer40 - Gera DMS por Parametros apos mudanaca que desvincula CUPOM e NOTA" ;
	SIZE 1,83,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2b1()
@ 44,8 GET NFmunidms ;
	PICTURE "@*HN NFmunidms - retorna o codimo municipi conforme tab DMS GYN" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2bc()
@ 21,6 GET NFCanNFCopia ;
	PICTURE "@*HN 16.5-NFCanNFCopia" ;
	SIZE 1,19,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2bi()
@ 15,3 GET NFDefCancDFis ;
	PICTURE "@*HN NFDefCancDFis - Define Objetivo Canc DFis (ESCRITURACAO/CANCELAMENTO)" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2br()
@ 16,3 GET NF_CancDFis ;
	PICTURE "@*HN NF_CancDFis - Cancela Documento Fiscal (NF/NFS/NFe/NFSe/CUPOM)" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2c3()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º               NOTA_B/MS-DOS Screen Layout               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 3
@ 4,0 GET NFRot_Fat ;
	PICTURE "@*HN NFRot_Fat- Rotina GERAL de Faturamento " ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2ch()
@ 2,5 GET NFregEnvioFat ;
	PICTURE "@*HN NFregEnvioFat- Prepara Enviop para Processo de Faturamento" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2cs()
@ 13,5 GET NF_DefFat ;
	PICTURE "@*HN NF_DefFat-Controla Def Dt,Nro p/ NF,Cupom,NFservc,NFe Apos 15/03/2006" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2d1()
@ 11,5 GET NFchq_Final ;
	PICTURE "@*HN NFchq_Final- Checagem de Dados OSI/ITENS para Liberar Processo de Faturamento" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2db()
@ 15,8 GET NF_02NroNota ;
	PICTURE "@*HN NF_02NroNota-Obtem o Numero para proximo NF,NFe,NFServico ou Cupom " ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2dv()
@ 52,3 GET NFFatura ;
	PICTURE "@*HN NFFatura-Controla Fat. Conjunto Produto e Servico mesma NF" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2e7()
@ 54,6 GET NFAbreNota ;
	PICTURE "@*HN NFAbreNota  - Abre Registro de Nota/Cupom (Com dados Basicos)" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2f5()
@ 55,9 GET NFFat_Item ;
	PICTURE "@*HN NFFat_Item- Fatura um Item (Orcatmp ==> Itemmov )" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2fh()
@ 73,7 GET NFinfo_Nf ;
	PICTURE "@*HN NFinfo_Cobr - Funcoes P/Fornecer Info. Adicionais p/ Imp.NF/CUPOM" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2fx()
@ 74,7 GET NFinfoCbrSrv ;
	PICTURE "@*HN NFinfoCbrSrv - Funcoes P/Fornecer Info. Adicionais p/ Imp.NF.Servico" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2fy()
@ 75,7 GET NFinfoSrvCbr ;
	PICTURE "@*HN NFinfoSrvCbr - Idem NFinfoCbrSrv - adaptada para layout menor de 01/05/2006" ;
	SIZE 1,77,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2ge()
@ 86,2 GET UNFmarcanf ;
	PICTURE "@*HN ESP - UNFmarcanf - Set Status de Processo no Registro NF" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2gm()
@ 87,2 GET UNFEmpMarcanf ;
	PICTURE "@*HN ESP - UNFEmpMarcanf - Set Status de Processo no Registro NF" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2gs()
@ 88,2 GET ULbaixa_Saldo ;
	PICTURE "@*HN ESP - ULbaixa_Saldo - Solicita Baixa de Saldo Para Faturamento" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2gz()
@ 29,7 GET NFNfSrvExstCop ;
	PICTURE "@*HN NFNfSrvExstCop - Verifica se Existe Copia Ativa NF SERVICO" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2h5()
@ 30,7 GET NFNfN1ExstCop ;
	PICTURE "@*HN NFNfN1ExstCop - Verifica se Existe Copia Ativa NF N1" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2hc()
@ 28,0 GET NFProcessCopia ;
	PICTURE "@*HN NFProcessCopia-Controla Geracao Copia de Cupon em NF e NF.Servico" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2hj()
@ 32,4 GET NFGerCopia ;
	PICTURE "@*HN NFGerCopia - Gera Copia de Cupom Fiscal em NF(Produto e Servico)" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2i8()
@ 5,6 GET NFverClasOSI ;
	PICTURE "@*HN NFverClasOSI- Verifica Consistencia da Classificacao da Operacao OSI" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2ir()
@ 6,6 GET NFchqLiberCred ;
	PICTURE "@*HN NFchqLiberCred- Verifica se houve Liberacao e Credito para Venda" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2iy()
@ 7,6 GET NFinfoCompl ;
	PICTURE "@*HN NFinfoCompl- Info Complementares do Vendedor" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2j5()
@ 58,5 GET FCHrot_fat ;
	PICTURE "@*HN FCHrot_fat" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2j6()
@ 1,1 GET NFEnvioParaFat ;
	PICTURE "@*HN NFEnvioParaFat- Prepara Enviop para Processo de Faturamento" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2jh()
@ 17,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 57,5 GET NFRecuperaFat ;
	PICTURE "@*HN NFRecuperaFat- Rotina Recuperacao de NF" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2jq()
@ 18,5 GET ULGerCupom ;
	PICTURE "@*HN ULGerCupom" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2k0()
@ 19,5 GET ULGerNFSU ;
	PICTURE "@*HN ULGerNFSU  NF ou NFe" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2k8()
@ 20,5 GET ULGerServicoNf ;
	PICTURE "@*HN ULGerServicoNf NFS ou NFSe" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2ke()
@ 12,5 GET NFBloqEmpresa ;
	PICTURE "@*HN NFBloqEmpresa - Bloq de Empresa para uso como SEMAFORO" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2kl()
@ 49,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 76,2 GET NFatlzOrcament ;
	PICTURE "@*HN NFatlzOrcament" ;
	SIZE 1,16,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2km()
@ 3,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 27,0 GET NF_02ImpCopia ;
	PICTURE "@*HN NF_02ImpCopia - Solicita Copia Cupom em NF e Imprime apos 15/03/2006" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2l0()
@ 61,4 GET NFAjustTmpItens ;
	PICTURE "@*HN NFAjustTmpItens - Preenche o TMP com reg em branco e linha de impressao para novo LAYOUT" ;
	SIZE 1,90,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2l9()
@ 62,4 GET NFLinhaProd ;
	PICTURE "@*HN NFLinhaProd - Formata String para Linha na grid de Produtos do Formulario NFs" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2lm()
@ 43,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 44,2 GET NFGeraXML_NOTA ;
	PICTURE "@*HN NFGeraXML_NOTA-Gera XML do DocFiscal ref a NF informada " ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2lv()
@ 45,2 GET NFEnviaNfe_NOTA ;
	PICTURE "@*HN NFEnviaNfe_NOTA-Envia XML do DocFiscal para NFe ref a NF informada " ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2m3()
@ 48,2 GET NFRtrnoNfe_NOTA ;
	PICTURE "@*HN NFRtrnoNfe_NOTA-Busca retorno NFe do DocFiscal ref a NF informada " ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2m4()
@ 8,2 GET ANTNFProcessFat ;
	PICTURE "@*HN ANTNFProcessFat- Efetiva Processo Faturamento  apos 15/03/2006" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2mm() ;
	DISABLE
@ 22,5 GET NF_ImpCupomFiscal ;
	PICTURE "@*HN NF_ImpCupomFiscal -  Impressao do Cupom Fiscal" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2na()
@ 23,5 GET NF_ImpNFFiscal ;
	PICTURE "@*HN NF_ImpNFFiscal - Impressao da Nota Fiscal" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2np()
@ 24,5 GET NF_ImpNFSrvico ;
	PICTURE "@*HN NF_ImpNFSrvico -  Impressao da NF de Servico" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2o8()
@ 34,4 GET NF_CopNF_Imprime ;
	PICTURE "@*HN NF_CopNF_Imprime -  Impressao de Copia de cupom em NF convencional" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2or()
@ 35,4 GET NF_CopNFSrvImprime ;
	PICTURE "@*HN NF_CopNFSrvImprime -  Impressao de Copia do cupom em NF Servico" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2p8()
@ 78,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 84,2 GET NFAtlzDadosNFe ;
	PICTURE "@*HN NFAtlzDadosNFe -Atlz retorno NFe no Orcamento, Nota e Doc Fiscal/Emp/ Periodo" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2pq()
@ 85,2 GET NFVrfSeqNroNotas ;
	PICTURE "@*HN NFVrfSeqNroNotas-Verifica a seq nro nota gera arq. log em loc informado" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2pz()
@ 14,8 GET NF_02DefProcess ;
	PICTURE "@*HN NF_02DefProcess-Def Processo DocFiscal CUPOM,NF,NFe,NFS,NFSe 15/03/2010" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2qc()
@ 53,5 GET NFSerie ;
	PICTURE "@*HN NFSerie" ;
	SIZE 1,9,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2qr()
@ 26,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 60,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 41,2 GET NF_GeraDFis ;
	PICTURE "@*HN NF_GeraDFis - Gera Documento Fiscal(NF/NFS/NFe/NFSe/CUPOM)" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2qz()
@ 56,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 38,2 GET antNFDefEnvDFis ;
	PICTURE "@*HN antNFDefEnvDFis - Define Objetivo Envio DFis (ESCRITURACAO/CANCELAMENTO)" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2rs() ;
	DISABLE
@ 46,2 GET NFReenvNFe ;
	PICTURE "@*HN NFReenvNFe - Renvia- NFe ->NF->DOC->XML->NFe" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls2s4()
@ 47,2 GET NFEscriturar ;
	PICTURE "@*HN NFEscriturar - Envia Registro nota para Escituracao" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls2s5()
@ 16,8 GET NFDefMod_Doc ;
	PICTURE "@*HN NFDefMod_Doc- Define Modelo de Documento" ;
	SIZE 1,42,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2sm()
@ 25,5 GET NFPrtSrvico ;
	PICTURE "@*HN NFPrtSrvico -  nova Impressao da NF de Servico p Emp 7,8,9 e 17" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2st()
@ 36,6 GET NFPrtCpSrvico ;
	PICTURE "@*HN NFPrtCpSrvico -  nova Impressao de Copia do cupom em NF Servico" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2td()
@ 64,4 GET NFARGAjustItens ;
	PICTURE "@*HN NFARGAjustItens - Ajustar pa nf servico de ARG LAYOUT" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2te()
@ 65,4 GET NFARGLinhaSRVC ;
	PICTURE "@*HN NFARGLinhaSRVC - Formata String para Linha na grid de Produtos do Formulario NFs" ;
	SIZE 1,82,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2u9()
@ 79,2 GET NFProcEcrtDt ;
	PICTURE "@*HN NFProcEcrtDt - Processa Escrituracao de Saida por Periodo" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2uj()
@ 21,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 31,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 33,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 37,0 SAY "----------------------------------------------------------------------------" ;
	SIZE 1,76, 0
@ 67,4 GET NFV3AjustTmpItens ;
	PICTURE "@*HN NFV3AjustTmpItens - Preenche o TMP com reg em branco e linha de impressao para novo LAYOUT" ;
	SIZE 1,92,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2us()
@ 68,4 GET NFV3LinhaProd ;
	PICTURE "@*HN NFV3LinhaProd - Formata String para Linha na grid de Produtos do Formulario NFs" ;
	SIZE 1,81,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2v4()
@ 80,2 GET NFPendEcrtDt ;
	PICTURE "@*HN NFPendEcrtDt - Consulta Pendencias Para Escrituracao de Saida por Periodo" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2vd()
@ 70,4 GET NFABOAjustItens ;
	PICTURE "@*HN NFABOAjustItens - Ajustar pa nf servico de ABO LAYOUT" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2vl()
@ 71,4 GET NFABOLinhaSRVC ;
	PICTURE "@*HN NFABOLinhaSRVC - Formata String para Linha na grid de Produtos do Formulario NFs" ;
	SIZE 1,82,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2vu()
@ 9,2 GET NFProcessFat ;
	PICTURE "@*HN NFProcessFat- Efetiva Processo Fat APOS 01/06/2012 - CUPOM ELETRONICO" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2w4()
@ 81,2 GET NFEmitPrdReenvNFe ;
	PICTURE "@*HN NFEmitPrdReenvNFe - Renvia - NFe ->NF->DOC->XML->NFe - Por Periodo " ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls2wx()
@ 39,2 GET NFDefEnvDFis ;
	PICTURE "@*HN NFDefEnvDFis - Define Objetivo Envio DFis (ESCRITURACAO/CANCELAMENTO)" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2x9()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              MOVIMENT/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 4
@ 3,0 GET MVAtu_Cmd ;
	PICTURE "@*HN MVAtu_Cmd  - Atualiza de Saldos Fisicos e Financeiros com Base em ITEMMOV" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2xm()
@ 4,0 GET MVCancelMvto ;
	PICTURE "@*HN MVCancelMvto - Clancela Item do Movimento" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2xx()
@ 6,5 GET MVBlqSaldo ;
	PICTURE "@*HN MVBlqSaldo - Bloquear Reg. Saldo  com Base em ITEMMOV" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2yb()
@ 7,5 GET MVDesBlqSaldo ;
	PICTURE "@*HN MVDesBlqSaldo - Desbloqueia Bloquear Reg. Saldo  com Base em ITEMMOV" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2yc()
@ 10,3 GET MVObterSaldos ;
	PICTURE "@*HN MVObterSaldos - Obter Saldos Base para Processar Movimento" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2yo()
@ 11,8 GET MVIniRegSaldos ;
	PICTURE "@*HN MVIniRegSaldos - Inicializa Registro de Saldos" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2yz()
@ 13,3 GET MVprocessaMvto ;
	PICTURE "@*HN MVprocessaMvto - Processa o Movimento Com Base no Registro Informado" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2z6()
@ 14,6 GET MVSincrItmAnexo ;
	PICTURE "@*HN MVSincrItmAnexo  - Sincronizar Saldos de ItmAnexo Com Itemmov" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2zl()
@ 15,6 GET MVAtlzSaldos ;
	PICTURE "@*HN MVAtlzSaldos - Atualiza Saldos a Partir da Data do Movimento" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2zs()
@ 16,8 GET MVAtlzComplSaldos ;
	PICTURE "@*HN MVAtlzComplSaldos - Complementa Atualizacao de Saldos " ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _43a0ls2zt()
@ 18,6 GET MVGetCustMedio ;
	PICTURE "@*HN MVGetCustMedio - Obter o Custo Medio Para Operacao em Andamento" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _43a0ls306()
@ 19,6 GET MVGetIndRedutor ;
	PICTURE "@*HN MVGetIndRedutor - Obter o Indice de Reducao Oper(/OU*) 1.26 ou 1.24" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _43a0ls30c()
@ 20,8 GET MVSetSldEntradas ;
	PICTURE "@*HN MVSetSldEntradas - Opera Var(Ambientais) P/ Movim de Entr" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls30k()
@ 21,8 GET MVSetSldSaidas ;
	PICTURE "@*HN MVSetSldSaidas - Opera Var(Ambientais) P/ Movim de Saidas" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls30x()
@ 22,8 GET MVSetSaldos ;
	PICTURE "@*HN MVSetSaldos - Atualiza <Saldo Atual> e <Vlr Atual> => NO CUSTO MEDIO" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _43a0ls315()
@ 23,6 GET MVSldFuturo ;
	PICTURE "@*HN MVSldFuturo - Ajusta Registros de Saldo alem da Data Movimento" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _43a0ls31i()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º               PRECO/MS-DOS Screen Layout                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 5
@ 1,0 GET PRVlrSaida ;
	PICTURE "@*HN PRVlrSaida - Obert Valor para Operacao de saida" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _43a0ls31r()
@ 2,3 GET PRVlrTransf ;
	PICTURE "@*HN PRVlrTransf   - Obter Valor para Transferencias" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _43a0ls324()
@ 8,4 GET PRVlrVenda ;
	PICTURE "@*HN PRVlrVenda -Preco Vendas Para OSI Informada" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _43a0ls32d()
@ 11,4 GET PRClas_Cms ;
	PICTURE "@*HN PRClas_Cms - Obter a Classificao de Grupo de Comissao para Produto" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _43a0ls32n()
@ 12,0 GET PRCusto ;
	PICTURE "@*HN PRCusto - Obter Custo do Produto" ;
	SIZE 1,34,1 ;
	DEFAULT 1 ;
	VALID _43a0ls32x()
@ 13,0 GET PRtabvigor ;
	PICTURE "@*HN PRtabvigor" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _43a0ls32y()
@ 14,0 GET PRdesconto ;
	PICTURE "@*HN PRdesconto" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _43a0ls33c()
@ 15,0 GET PRbrow_tab ;
	PICTURE "@*HN PRbrow_tab" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _43a0ls33m()
@ 16,0 GET PRpromocao ;
	PICTURE "@*HN PRpromocao" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _43a0ls33u()
@ 9,7 GET PRVlrTabVgr ;
	PICTURE "@*HN PRVlrTabVgr -Preco em Vigor na Dt Informada" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _43a0ls343()
@ 3,5 GET PRVlrTransf ;
	PICTURE "@*HN trf_dep010912 - aux de PRVlrTransf - para Orcamentos apos 01-09-2012" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _43a0ls34a()
@ 4,5 GET PRVlrTransf ;
	PICTURE "@*HN trf_dep010503 - aux de PRVlrTransf - para Orcamentos apos 01-05-2003" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _43a0ls34i()
@ 5,5 GET PRVlrTransf ;
	PICTURE "@*HN trf_ate010503 - aux de PRVlrTransf - para Orcamentos antes de 01-05-2003" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _43a0ls34t()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              ESTOQUE/MS-DOS Screen Layout               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 6
@ 10,0 SAY "----------------------   REDEFICAO DE REGRAS   ----------------------------" ;
	SIZE 1,75, 0
@ 19,1 SAY "-------------------------   CONSULTAS   ----------------------------------" ;
	SIZE 1,74, 0
@ 1,3 GET ESPsq_Produtos ;
	PICTURE "@*HN ESPsq_Produtos - Abre Pesquisa de Produto Order Tabela Ret. CODIGO" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _43a0ls354()
@ 7,0 GET ESAbresaldo ;
	PICTURE "@*HN ESAbresaldo-Abre Reg.de Controle de Saldo " ;
	SIZE 1,44,1 ;
	DEFAULT 1 ;
	VALID _43a0ls35f()
@ 8,0 GET ESversaldo ;
	PICTURE "@*HN ESversaldo -Verificar se Existe Saldo Para Atender/Abre Controle " ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _43a0ls35r()
@ 9,0 GET ESsaldo ;
	PICTURE "@*HN obs * ESsaldo    -Informa Saldo Momento Informado Considara DATA e HORA" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _43a0ls35s()
@ 12,0 GET EScustoMedio ;
	PICTURE "@*HN EScustoMedio - Custo M‚dio do Produto na Empresa X e na Data X" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _43a0ls36h()
@ 13,0 GET EScustoEstq ;
	PICTURE "@*HN obs * EScustoEstq - Custo do Estoque Produto na Empresa X e na Data X" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _43a0ls36u()
@ 15,0 GET EScustoAgregado ;
	PICTURE "@*HN EScustoAgregado -Custo M‚dio Agregado de Tributacao , etc" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls377()
@ 16,3 GET ESAgregarTrbt ;
	PICTURE "@*HN ESAgregarTrbt -Agrega Tributos ao Valor Passado Como Custo" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _43a0ls37e()
@ 17,0 GET ESprc_compra ;
	PICTURE "@*HN ESprc_compra" ;
	SIZE 1,14,1 ;
	DEFAULT 1 ;
	VALID _43a0ls37f()
@ 20,0 GET EScrtcestq ;
	PICTURE "@*HN antEScrtcestq  - SQL sobre pedido p/ critica de estocagem" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls37w()
@ 21,0 GET EScrtcestq ;
	PICTURE "@*HN EScrtcestq  - SQL sobre pedido p/ critica de estocagem" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _43a0ls385()
@ 22,0 GET ESextrato ;
	PICTURE "@*HN ESextrato - Extrato de Movimentacao de Estoque" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls38c()
@ 23,7 GET ESimpext ;
	PICTURE "@*HN ESimpext - Sub rotina para Impressao Extrato " ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls38o()
@ 24,0 GET ESextRess ;
	PICTURE "@*HN ESextRess - Extrato de Ressarcimento" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _43a0ls38u()
@ 25,7 GET ESOrigDest ;
	PICTURE "@*HN ESOrigDest - Funcao de Apoio aos Extratos" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _43a0ls394()
@ 26,0 GET ESextEntradas ;
	PICTURE "@*HN ESextEntradas - Extrato de Movimentacao de Entrada" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _43a0ls39b()
@ 27,0 GET ESextTrasf ;
	PICTURE "@*HN ESextTrasf - Extrato de Movimentacao de Entrada por Transferencia" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _43a0ls39n()
@ 2,3 GET ESVld_Produto ;
	PICTURE "@*HN ESVld_Produto - Verifica Validade do Produto Informado" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _43a0ls39z()
@ 3,3 GET ESGet_Origem ;
	PICTURE "@*HN ESGet_Origem - Origem Importado ou Nacional" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3a6()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              ORCAMENT/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 7
@ 32,0 SAY "*---------- ROTINAS BASEADAS NO CONCEITO DE CLASSES ------------------*" ;
	SIZE 1,71, 0
@ 33,1 GET ORExiste ;
	PICTURE "@*HN ORExiste - Retorna .T. se existir ou .F. se nao existir o Numero Orcamento" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ae() ;
	DISABLE
@ 36,1 GET ORGetValor ;
	PICTURE "@*HN ORGetValor - Valor total do Orcamento" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ak()
@ 35,1 GET ORGetDt_Fat ;
	PICTURE "@*HN ORGetDt_Fat - Data Faturamento" ;
	SIZE 1,32,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3al()
@ 28,1 GET ORView ;
	PICTURE "@*HN ORView - Visualisa Orcamentos" ;
	SIZE 1,31,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3av()
@ 6,4 GET ORVerifyInst ;
	PICTURE "@*HN ORVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3b3()
@ 7,7 GET ORCreate ;
	PICTURE "@*HN ORCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3b9()
@ 16,7 GET ORDestroi ;
	PICTURE "@*HN ORDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3bh()
@ 8,9 GET ORReadProp ;
	PICTURE "@*HN ORReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3bo()
@ 9,9 GET ORSetDerivadas ;
	PICTURE "@*HN ORSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3bu()
@ 12,9 GET ORSetPropVT ;
	PICTURE "@*HN ORSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3c2()
@ 13,9 GET ORGetPropVT ;
	PICTURE "@*HN ORGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3c3()
@ 3,1 GET ORChk_Identidade ;
	PICTURE "@*HN ORChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3cf()
@ 2,1 GET ORFind ;
	PICTURE "@*HN ORFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3cl()
@ 19,1 GET ORGetFieldValue ;
	PICTURE "@*HN ORGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3cr()
@ 18,1 GET OR_Refresh ;
	PICTURE "@*HN OR_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3cx()
@ 15,9 GET ORWriteProp ;
	PICTURE "@*HN ORWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3d3()
@ 20,1 GET ORGetAlias ;
	PICTURE "@*HN ORGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3d9()
@ 10,9 GET ORSetConfig ;
	PICTURE "@*HN ORSetConfig - Carga Propriedades de Configuracao/Parametros" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3df()
@ 4,4 GET ORTrtChv ;
	PICTURE "@*HN ORTrtChv- Trata Acesso " ;
	SIZE 1,25,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3dl()
@ 17,1 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 21,1 GET ORScatter ;
	PICTURE "@*HN ORScatter - Carrega Var de Memoria" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3dm()
@ 0,0 SAY "CLAS:V-1.0 => IMPLEMENTA NAVEGACAO E MANUTENCAO COMPLETA (BASE=CLIENTES)" ;
	SIZE 1,72, 0
@ 1,0 SAY "*---------------------------------------------------------------------*" ;
	SIZE 1,71, 0
@ 23,1 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 25,1 GET ORLerRegistro ;
	PICTURE "@*HN ORLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3dx()
@ 26,1 GET ORSalvarRegistro ;
	PICTURE "@*HN ORSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3e4()
@ 24,1 GET ORExiste ;
	PICTURE "@*HN ORExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ea()
@ 27,1 GET ORBtnVal ;
	PICTURE "@*HN ORBtnVal - Trata Comandos de navegacao" ;
	SIZE 1,40,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3eh()
@ 29,1 GET ORView ;
	PICTURE "@*HN IMPLEMENTAR - ORView - Visualisa BROWSE" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3eo() ;
	DISABLE
@ 30,3 GET ORLOCATE ;
	PICTURE "@*HN IMPLEMENTAR - ORLOCATE - Apoio a CLView - Visualisa BROWSE" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ev() ;
	DISABLE
@ 38,0 SAY "*---------------------------------------------------------------------*" ;
	SIZE 1,71, 0
@ 42,5 GET ORGeraBTS ;
	PICTURE "@*HN ORGeraBTS - Gera um registro BTS para a OSI" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3f1()
@ 39,1 GET ORGerBTS1 ;
	PICTURE "@*HN ORGerBTS1 - Converte uma OSI em REGISTRO BTS Por Empresa/Periodo" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3f2()
@ 43,5 GET ORGeraProdBTS ;
	PICTURE "@*HN ORGeraProdBTS - Gera um registro BTS para a OSI" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3fz()
@ 44,5 GET ORGeraSrvcBTS ;
	PICTURE "@*HN ORGeraSrvcBTS - Gera um registro BTS para a OSI" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3g9()
@ 40,1 GET ORGerBTS2 ;
	PICTURE "@*HN ORGerBTS2 - Converte uma OSI em REGISTRO BTS Por OSI" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3gj()
@ 47,1 GET OREditaBTS ;
	PICTURE "@*HN OREditaBTS - Chamada independente para editar BTS" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls3gk()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              ORCAMNTA/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 8
@ 36,1 GET ORimp_osi ;
	PICTURE "@*HN ORloc_orc  - Auxilia na Montagem do Brow para Localizar Orcamentos" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3h1()
@ 37,4 GET ORLoc_Browse ;
	PICTURE "@*HN ORLoc_Browse -Browse de Pesquisa de Orcamento - TABELA TMP ORCABROW" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3hd()
@ 1,1 GET ORadOrcament ;
	PICTURE "@*HN ORadOrcament - Cria um Registro de Orcamento Padrao" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ho()
@ 2,3 GET ORnro_OSI ;
	PICTURE "@*HN ORnro_OSI   - Informa Numero Disponivel para O.S.I" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3i0()
@ 6,1 GET ORValEntClie ;
	PICTURE "@*HN ORValEntCli - Valida Entrada do Cliente no Orcamento" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ia()
@ 7,4 GET ORValid_Clie ;
	PICTURE "@*HN ORValid_Clie- Critica do Cliente Informado " ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3im()
@ 8,4 GET ORAtlz_Clie ;
	PICTURE "@*HN ORAtlz_Clie- Atualiza Dados do Cliente Cadastrados no Orcamento" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3iw()
@ 10,1 GET ORclas_oper ;
	PICTURE "@*HN ORclas_oper - Classifica Operacao Comercial Para Definicao do TIPO " ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3j6()
@ 11,1 GET ORnewclas_oper ;
	PICTURE "@*HN ORnewclas_oper - Classifica Operacao Comercial Para Definicao do TIPO " ;
	SIZE 1,72,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3jl()
@ 18,3 GET ORdef_tribut ;
	PICTURE "@*HN ORdef_tribut-Def.Caracteristica Trib. e Operacionais Produto" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3k5()
@ 13,1 GET ORprzmedio ;
	PICTURE "@*HN ORprzmedio - Calcula Prz Medio , Nro Pgtos e Taxa Juros " ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ki()
@ 19,3 GET ORcalc_vlres ;
	PICTURE "@*HN ORcalc_vlres- Calcula Valores Comerciais " ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3kq()
@ 16,1 GET ORrecalc_OSI ;
	PICTURE "@*HN ORrecalc_OSI- Reclassifica e Recalcula OSI Por mudancas no Orcamento" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3kz()
@ 17,3 GET ORrecalc_item ;
	PICTURE "@*HN ORrecalc_item- Reclassifica e Recalcula ITENS DA OSI Por mudancas no Orcamento" ;
	SIZE 1,80,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3l8()
@ 14,1 GET ORsoma_orc ;
	PICTURE "@*HN ORsoma_orc  - Soma Valores Comerciais e Tributarios do Orcamento" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3lp()
@ 24,1 GET ORSelimp_osi ;
	PICTURE "@*HN ORSelimp_osi- Seleciona OSI que Sera Impressa" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3lz()
@ 25,5 GET ORimp_osi ;
	PICTURE "@*HN ORimp_osi   - Coordena Impressao da OSI" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3mc()
@ 49,1 GET ORgrvavisolib ;
	PICTURE "@*HN ORgrvavisolib- Grava Numero do Orcamento Para Avisar Liberacao de Credito" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ms()
@ 50,1 GET ORleravisolib ;
	PICTURE "@*HN ORleravisolib- Ler Numero do Orcamento Para Avisar Liberacao de Credito" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3mt()
@ 39,1 GET ORTenta_Liberar ;
	PICTURE "@*HN ORTenta_Liberar - Avalia Orcamento com Dados do Sistema Para Tentar Liberacao" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3n8()
@ 21,1 GET ORimp_orca ;
	PICTURE "@*HN ORimp_orca   - Relaciona todos Itens da Osi" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3nl()
@ 40,3 GET ORVer_credito ;
	PICTURE "@*HN ORVer_credito - Faz uma Varredura nas Condicoes de Credito do Cliente" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3nv()
@ 26,1 GET ORSelreserva ;
	PICTURE "@*HN ORSelreserva- Seleciona OSI que Sera Reservada" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3o8()
@ 29,1 GET ORSelcancreserva ;
	PICTURE "@*HN ORSelcancreserva- Seleciona OSI que tera Reserva Cancelada" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3o9()
@ 27,4 GET ORreserva ;
	PICTURE "@*HN ORreserva- Controla o Processo de Reserva de Uma OSI" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3op()
@ 30,4 GET ORcancreserva ;
	PICTURE "@*HN ORcancreserva- Controla o Processo de Cancelamento de Reserva de Uma OSI" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3p3()
@ 28,7 GET ORprocreserva_item ;
	PICTURE "@*HN ORprocreserva_item - Registra/Cancela Reserva para Item em ITEMMOV" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3pd()
@ 3,3 GET ORVTmotivos ;
	PICTURE "@*HN ORVTmotivos - Preenche Vetor de Motivos de OSI" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3pr()
@ 4,3 GET ORVlr_e_FormPgto ;
	PICTURE "@*HN ORVlr_e_FormPgto-Obtem Vlrs Dinh.,Chq.,Cartao e Dupl(Ticket) no pgto" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ps()
@ 22,1 GET ORlog ;
	PICTURE "@*HN ORlog - Extrato de Log de Orcamento" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3q9()
@ 41,1 GET ORCanc_Libera ;
	PICTURE "@*HN ORCanc_Libera - Cancela liberacao ORCAMENTO" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3qj()
@ 34,1 GET ORSelParaFat ;
	PICTURE "@*HN ORSelParaFat- Seleciona OSI para faturamento" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3qt()
@ 32,1 GET ORSelPFatDireto ;
	PICTURE "@*HN ORSelPFatDireto- Seleciona OSI para fat direto sem reserva e osi" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3r0()
@ 76,0 GET ORimp_osi ;
	PICTURE "@*HN ORSleOrFinFat - Seleciona Orcamento Financeiros para Faturar" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3r8()
@ 77,0 GET ORimp_osi ;
	PICTURE "@*HN ORSleOrNFinFat - Seleciona Orcamento NAO Financeiros para Faturar" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3r9()
@ 38,1 SAY "*------------------------------------------------------------------*" ;
	SIZE 1,68, 0
@ 74,0 GET ORCancPdLiberacaoXML ;
	PICTURE "@*HN ORCancPdLiberacaoXML - Gera XML cancelando solicitando Liberacao de Credito p OSI" ;
	SIZE 1,83,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3rv() ;
	DISABLE
@ 75,0 GET ORConsPdLiberacaoXML ;
	PICTURE "@*HN ORConsPdLiberacaoXML - Gera XML p consultar solicitando Liberacao de Credito p OSI" ;
	SIZE 1,84,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3s4() ;
	DISABLE
@ 51,1 SAY "********<<<  EM DESENVOLVIMENTO >>>********************" ;
	SIZE 1,55, 0
@ 57,2 GET ORGraXMLPddCredito ;
	PICTURE "@*HN ORGraXMLPddCredito-Gera XML pedido Libera Credito para ORCAMENTO " ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3sd()
@ 59,5 GET ORNmFileXMLPddCr ;
	PICTURE "@*HN ORNmFileXMLPddCr-Define Path+File do XML Pedido Credito" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3so()
@ 61,7 GET ORIniPddCrdtXML ;
	PICTURE "@*HN ORIniPddCrdtXML-Monta Cabecalho XML com base no modelo-xmlPDDCR" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls3sv()
@ 63,7 GET ORFinPddCrdtXML ;
	PICTURE "@*HN ORFinPddCrdtXML-Monta Fechamento XML do pdd Lib Cred modelo-xmlPddCr" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls3sw()
@ 62,11 GET ORGrvXMLPddCrdt ;
	PICTURE "@*HN ORGrvXMLPddCrdt-Grv XML Pedido Credito em XML" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3t8()
@ 58,5 GET ORMdlPddCrdtRefXML ;
	PICTURE "@*HN ORMdlPddCrdtRefXML-MODELO P/MONTAR REF XML Solicitacao Credito XMLPDDCR" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls3tp()
@ 60,5 GET ORNmPddCrdtLngFileXMLCREDT ;
	PICTURE "@*HN ORNmPddCrdtLngFileXMLCREDT-Define Path+File do XML Ped. Credito " ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3tw()
@ 73,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 52,0 SAY "-------<<<< XML PEDIDO LIBERACAO CREDITO >>>>> ------------------------------" ;
	SIZE 1,77, 0
@ 53,0 GET ORXMLRegPede_p_Liberar ;
	PICTURE "@*HN ORXMLRegPede_p_Liberar -  - XML REGISTRA pedido Liberacao" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3u3()
@ 54,0 GET ORXMLCanPede_p_Liberar ;
	PICTURE "@*HN ORXMLCanPede_p_Liberar - XML CANCELA pedido Liberacao" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3u9()
@ 56,0 GET ORXMLCnstPede_p_Liberar ;
	PICTURE "@*HN ORXMLCnstPede_p_Liberar - XML CONSULTA pedido Liberacao" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ug()
@ 55,0 GET ORXMLFatPede_p_Liberar ;
	PICTURE "@*HN ORXMLFatPede_p_Liberar - XML FATURA pedido Liberacao" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3un()
@ 69,0 GET ORRtrnoCnstXMLPddCr ;
	PICTURE "@*HN ORRtrnoCnstXMLPddCr-Busca retorno XML PddCr ref OSI informada" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3uu()
@ 71,5 GET OREsperaRspPddCR ;
	PICTURE "@*HN OREsperaRspPddCR - Executa ORBuscaRspPddCR Enquanto nao houver resposta" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3v1()
@ 72,8 GET ORBuscaRspPddCR ;
	PICTURE "@*HN ORBuscaRspPddCR-Busca Arq e Lˆ conteudo Resposta PddCr" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3v8()
@ 70,2 GET ORRespXMLPddCR ;
	PICTURE "@*HN ORRespXMLPddCR - Le e Def. Tratamento para  resposta Pdd credito" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3vi()
@ 43,1 GET ORXMLTenta_Liberar ;
	PICTURE "@*HN ORXMLTenta_Liberar - Avalia Orcamento com Dados do Sistema Para Tentar Liberacao" ;
	SIZE 1,82,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3vq()
@ 44,3 GET ORXMLVer_credito ;
	PICTURE "@*HN ORXMLVer_credito - Faz uma Varredura nas Condicoes de Credito do Cliente" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3vr()
@ 45,1 GET ORXMLCanc_Libera ;
	PICTURE "@*HN ORXMLCanc_Libera - Cancela liberacao ORCAMENTO" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3wa()
@ 46,3 GET ORXMLCanc_credito ;
	PICTURE "@*HN ORXMLCanc_credito - Faz uma Varredura nas Condicoes de Credito do Cliente" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3wk()
@ 65,0 GET OREnvXMPddCr ;
	PICTURE "@*HN OREnvXMPddCr-Envia XMLPddCr" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3wr()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              DUPLICAT/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 9
IF WVISIBLE("_43a0ls1wy")
	ACTIVATE WINDOW _43a0ls1wy SAME
ELSE
	ACTIVATE WINDOW _43a0ls1wy NOSHOW
ENDIF
@ 19,2 GET CRComandText ;
	PICTURE "@*HN CRComandText - Executa Comando em Parametro" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3wy()
@ 2,7 GET CRVerifyInst ;
	PICTURE "@*HN CRVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3x4()
@ 3,10 GET CRCreate ;
	PICTURE "@*HN CRCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3xa()
@ 9,10 GET CRDestroi ;
	PICTURE "@*HN CRDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3xi()
@ 4,13 GET CRReadProp ;
	PICTURE "@*HN CRReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3xq()
@ 7,15 GET CRSetDerivadas ;
	PICTURE "@*HN CRSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3xw()
@ 5,15 GET CRSetPropVT ;
	PICTURE "@*HN CRSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3y2()
@ 6,15 GET CRGetPropVT ;
	PICTURE "@*HN CRGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ya()
@ 1,2 GET CRChk_Identidade ;
	PICTURE "@*HN CRChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3yg()
@ 0,2 GET CRFind ;
	PICTURE "@*HN CRFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ym()
@ 11,2 GET CRGetFieldValue ;
	PICTURE "@*HN CRGetFieldValue -Rtrn vlr Campo p/ reg.existente-(erro se chave n existir)" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3ys()
@ 10,2 GET CR_Refresh ;
	PICTURE "@*HN CR_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3yy()
@ 13,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 15,2 GET CRLerRegistro ;
	PICTURE "@*HN CRLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3yz()
@ 8,13 GET CRWriteProp ;
	PICTURE "@*HN CRWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3zb()
@ 16,2 GET CRSalvarRegistro ;
	PICTURE "@*HN CRSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3zg()
@ 14,2 GET CRExiste ;
	PICTURE "@*HN CRExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3zn()
@ 17,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 12,2 GET CRGetAlias ;
	PICTURE "@*HN CRGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls3zv()
@ 18,2 GET CRFaxinaDados ;
	PICTURE "@*HN CRFaxinaDados-Retira char invalidor e outras validacoes" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _43a0ls400()
@ 27,1 GET CRGerXMLDpDocFiscal ;
	PICTURE "@*HN CRGerXMLDpDocFiscal-Gera XML Dp DFis Por Doc Fiscal informado - DOCCOBR" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _43a0ls407()
@ 20,1 SAY "XML=>" ;
	SIZE 1,5, 0
@ 29,5 GET CRNmFileXMLDocFiscal ;
	PICTURE "@*HN CRNmFileXMLDocFiscal-Define Path+File do XML DOC FISCAL" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _43a0ls40i()
@ 30,11 GET CRInicioXML ;
	PICTURE "@*HN CRInicioXML-Monta Cabecalho XML com base no modelo-xmlDCCBR" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls40j()
@ 32,11 GET CRFinalXML ;
	PICTURE "@*HN CRFinalXML-Monta Fechamento XML com base no modelo-xmlDCCBRS" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls40v()
@ 31,15 GET CRGravaXMLDpDocFiscal ;
	PICTURE "@*HN CRGravaXMLDpDocFiscal - Converte uma Doc Fiscal em XML" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _43a0ls415()
@ 28,5 GET CRModeloRefXML ;
	PICTURE "@*HN CRModeloRefXML-MODELO P/MONTAR REF XML Doc Fiscal-xmlDCFIS" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls42b()
@ 82,10 GET CRExpCapaRetLegado ;
	PICTURE "@*HN CRExpCapaRetLegado - Exporta Capa Retonos Bancarios para XML" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls42i()
@ 78,1 GET CRAvsExpNro ;
	PICTURE "@*HN CRAvsExpNro-Processa Exportacao de Avisos de retorno" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls42s()
@ 80,6 GET CRAvsModeloXML ;
	PICTURE "@*HN CRAvsModeloXML-MODELO P/MONTAR REF XML Export Avisos Legado xmlDFin" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls435()
@ 81,6 GET CRAvsIniXML ;
	PICTURE "@*HN CRAvsIniXML-Monta Cabecalho XML com base no modelo-xmlDFin" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls43c()
@ 87,7 GET CRAvsFinML ;
	PICTURE "@*HN CRAvsFinML-Monta Cabecalho XML com base no modelo-xmlDFin" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls43j()
@ 84,10 GET CRExpItemRetLegado ;
	PICTURE "@*HN CRExpItemRetLegado - Exporta Itens Retonos Bancarios para XML" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _43a0ls43k()
@ 85,10 GET CRExpDuplRetLegado ;
	PICTURE "@*HN CRExpDuplRetLegado - Exporta Dados Duplicatas para XML" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _43a0ls443()
@ 79,6 GET CRAvsNmXMLExpt ;
	PICTURE "@*HN CRAvsNmXMLExpt-Define Path+File do XML DOC FINANCEIRO" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _43a0ls44s()
@ 70,4 GET CRtratalinha ;
	PICTURE "@*HN CRtratalinha-Trata linha antes da gravacao XML" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls44y()
@ 73,4 GET CRLimpaString ;
	PICTURE "@*HN CRLimpaString - Elimina Caracteres especiais de string" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _43a0ls454()
@ 71,4 GET CR_Fputs ;
	PICTURE "@*HN CR_Fputs - Elimina caracteres especiais da string XML" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls45c()
@ 83,10 GET CRExpLccbrCapaRetLegado ;
	PICTURE "@*HN CRExpLccbrCapaRetLegado - Exporta Capa Retonos Bancarios para XML" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _43a0ls45i()
@ 86,10 GET CRExpClieDupLegado ;
	PICTURE "@*HN CRExpClieDupLegado - Exporta Dados Cliente da Dupl para XML" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _43a0ls45u()
@ 88,7 GET CRAvsEnviaXML ;
	PICTURE "@*HN CRAvsEnviaXML-Envia XMLDFIN" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _43a0ls466()
@ 89,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 44,1 GET CRDuplNroExpDuplicata ;
	PICTURE "@*HN CRDuplNroExpDuplicata -Processa Exportacao de Duplicatas por nro duplicata" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _43a0ls46g()
@ 49,4 GET CRDuplModeloXML ;
	PICTURE "@*HN CRDuplModeloXML-MODELO P/MONTAR REF XML Export Duplicatas Legado xmlDupl" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls46h()
@ 50,4 GET CRDuplIniXML ;
	PICTURE "@*HN CRDuplIniXML-Monta Cabecalho XML com base no modelo-xmlDupl" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls46z()
@ 52,8 GET CRDuplIedentLegado ;
	PICTURE "@*HN CRDuplIedentLegado - Exporta Identificacao empresa" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _43a0ls475()
@ 53,8 GET CRDuplCedenteLegado ;
	PICTURE "@*HN CRDuplCedenteLegado - Exporta BANCO CEDENTE  para XML" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls47d()
@ 54,8 GET CRDuplPortadorLegado ;
	PICTURE "@*HN CRDuplPortadorLegado - Exporta BANCO PORTADOR  para XML" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _43a0ls47q()
@ 55,8 GET CRDuplRecebedorLegado ;
	PICTURE "@*HN CRDuplRecebedorLegado - Exporta BANCO RECEBEDOR  para XML" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls483()
@ 56,8 GET CRDuplLegado ;
	PICTURE "@*HN CRDuplLegado - Exporta Dados Duplicatas para XML" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _43a0ls48h()
@ 57,8 GET CRDuplClieLegado ;
	PICTURE "@*HN CRDuplClieLegado - Exporta Dados Cliente da Dupl para XML" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls48i()
@ 58,4 GET CRDuplFinXML ;
	PICTURE "@*HN CRDuplFinXML-Monta Cabecalho XML com base no modelo-xmlDupl" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls48s()
@ 65,4 GET CRDupEnviaXML ;
	PICTURE "@*HN CRDupEnviaXML-Envia XMLDupl" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _43a0ls48y()
@ 48,4 GET CRNmDuplXMLExpt ;
	PICTURE "@*HN CRNmDuplXMLExpt-Define Path+File do XML DOC XMDUPL" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4as()
@ 45,1 GET CRDuplExpPeriodoDupl ;
	PICTURE "@*HN CRDuplExpPeriodoDupl-Processa Exportacao de Duplicatas por empresa e periodo" ;
	SIZE 1,78,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4az()
@ 77,1 GET CRAvsExpPeriodo ;
	PICTURE "@*HN CRAvsExpPeriodo-Processa Exportacao de Periodo Avisos de retorno" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4b0()
@ 29,5 GET CRNmLongoFileXMLDocFiscal ;
	PICTURE "@*HN CRNmLongoFileXMLDocFiscal-Define Path+File do XML DOC FISCAL" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4b1()
@ 69,4 GET DFCopyLongo ;
	PICTURE "@*HN CRCopyLongo - Copia xml para nome longo Servidor Servicos" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4b2()
@ 46,1 GET CRDuplExpVencPeriodoDupl ;
	PICTURE "@*HN CRDuplExpVencPeriodoDupl- Exportar Duplicatas com vencimento no Periodo" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4b3()
@ 74,1 GET FCHExpDuplicata ;
	PICTURE "@*HN FCHExpDuplicata" ;
	SIZE 1,17,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ch()
@ 42,1 GET CRDuplDFisExpDuplicata ;
	PICTURE "@*HN CRDuplDFisExpDuplicata -Proc Exp de Duplicatas por nro Doc.Fiscal (nota)" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4cp()
@ 67,6 GET CREsperaRspDup ;
	PICTURE "@*HN CREsperaRspDup - Executa CRBuscaRspDup Enquanto nao houver resposta" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4cq()
@ 68,8 GET CRBuscaRspDup ;
	PICTURE "@*HN CRBuscaRspDup-Busca Arq Resposta Dup" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4cr()
@ 66,4 GET CRRespostaDup ;
	PICTURE "@*HN CRRespostaDup - Le e Def. Tratamento para  resposta Dupl-" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4dm()
@ 51,8 GET CRDuplMotivoLegado ;
	PICTURE "@*HN CRDuplMotivoLegado - Motivo da Exporcao" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4dv()
@ 75,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 26,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 37,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 38,1 GET CRGer2XMLDpDocFiscal ;
	PICTURE "@*HN CRGer2XMLDpDocFiscal-Gera XML Dp DFis Por Doc Fiscal informado-XMLDUPL" ;
	SIZE 1,72,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4e8()
@ 59,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 43,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 47,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 39,4 GET CRNm2FileXMLDocFiscal ;
	PICTURE "@*HN CRNm2FileXMLDocFiscal-Define Path+File do XML DOC FISCAL" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4e9()
@ 40,4 GET CRNm2LongoFileXMLDocFiscal ;
	PICTURE "@*HN CRNm2LongoFileXMLDocFiscal-Define Path+File do XML DOC FISCAL" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ea()
@ 22,2 GET CRDFis_Tem_Duplicata ;
	PICTURE "@*HN CRDFis_Tem_Duplicata-Verifica se o DFis possui Duplicata" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4eb()
@ 72,8 GET CR_Fputs ;
	PICTURE "@*HN CR_FputsLimpa - Elimina caracteres especiais da string XML" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4f9()
@ 35,1 GET CRMntaStrgInfoCobranca ;
	PICTURE "@*HN CRMntaStrgInfoCobranca-Nonta String com Inf Cobranca para Uso em XML DFis" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ff()
@ 34,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 64,1 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 60,1 GET CRPthTmpDup ;
	PICTURE "@*HN CRPthTmpDup - Define Path p/ arquivo tmp exporta Financeiro" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4fp()
@ 61,1 GET CRPthDstnDupDIR_DEFIN ;
	PICTURE "@*HN CRPthDstnDupDIR_DEFIN - Define Path p/ arquivo final exporta Financeiro" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4fq()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              DUPLIC_A/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 10
IF WVISIBLE("_43a0ls1x0")
	ACTIVATE WINDOW _43a0ls1x0 SAME
ELSE
	ACTIVATE WINDOW _43a0ls1x0 NOSHOW
ENDIF
@ 38,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 2,0 GET CRGetNome ;
	PICTURE "@*HN CRGetNome - Retorna Nome" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4fr()
@ 4,0 GET CRsld_dup ;
	PICTURE "@*HN 01-CRsld_dup  - Saldo financeiro da Duplicata" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4fs()
@ 5,0 GET CRdb_Cobr ;
	PICTURE "@*HN 02-CRdb_Cobr  - Informa Debito de Cobranca (Dup.Emitidas)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ft()
@ 6,0 GET CRcr_Cobr ;
	PICTURE "@*HN 03-CRcr_Cobr  - Informa Credito o de Cobranca (Dup.Recebidas)" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4gr()
@ 7,0 GET CRsld_dup ;
	PICTURE "@*HN 04-CRsld_Cobr - Informa Saldo de Cobranca " ;
	SIZE 1,44,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4gy()
@ 8,12 GET CRidlate26geradupl ;
	PICTURE "@*HN 06-CRIDLate26geradupl - Gerar duplicatas - FILIAL IDL" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4h7() ;
	DISABLE
@ 16,5 GET CRNroIDdupl ;
	PICTURE "@*HN 08-CRNroIDdupl Gera o Numero de ID para Duplicata" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4h8()
@ 17,5 GET CRajustaVenc ;
	PICTURE "@*HN 08-CRajustaVenc  - Ajusta Data de Voncimento Considerando Sab,Dom e Feriado" ;
	SIZE 1,77,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4h9()
@ 18,5 GET CRAlteraFatura ;
	PICTURE "@*HN 09-CRAlteraFatura - Altera o Nro Fatura das Duplicatas" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ha()
@ 21,0 GET CRcancdupl ;
	PICTURE "@*HN 10-CRcancdupl - Cancela Duplicatas Referentes a NF" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4hb()
@ 27,0 GET CRProcBaixa ;
	PICTURE "@*HN 11-CRProcBaixa-Processa Comandos de Baixa e Outros Relacionados a Duplicatas" ;
	SIZE 1,78,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ig()
@ 31,0 GET CRCancProcBaixa ;
	PICTURE "@*HN 12-CRCancProcBaixa-Cancela Processamento Comandos de Baixa e Outros " ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4iv()
@ 33,0 GET CRRgAvisoCaixa ;
	PICTURE "@*HN 13-CRRgAvisoCaixa - Gera Registro de Lancamento para Sistema de Caixa" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4iw()
@ 34,0 GET CRCnAvisoCaixa ;
	PICTURE "@*HN 14-CRCnAvisoCaixa - Gera Registro Cancelamento de Lanc. para Sistema de Caixa" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ix()
@ 36,0 GET CRRefinanciamento ;
	PICTURE "@*HN 19-CRRefinanciamento - Refinanciamento  simples de uma Duplicata" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4jw()
@ 37,0 GET CRUltSeqdupl ;
	PICTURE "@*HN 18-CRUltSeqdupl - Retorna Ultima Sequencia Gerada para Duplicatas" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ka()
@ 39,0 GET CRChkp_FilDupl ;
	PICTURE "@*HN 15-CRChkp_FilDupl - Checkup pro Filial de Distorcoes em Vlr_pgto X Liq em RETORNMV" ;
	SIZE 1,84,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4kb()
@ 40,0 GET CRChkp_AllDupl ;
	PICTURE "@*HN 16-CRChkp_AllDupl - Checkup Geral de Distorcoes em Vlr_pgto X Liq em RETORNMV" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4kc()
@ 41,0 GET CRobtvlrpg ;
	PICTURE "@*HN 17-CRobtvlrpg - Obetem Valores Liquidados em RETORNMV" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4kd()
@ 43,0 GET CRgetNvVlrDup ;
	PICTURE "@*HN 18-CRgetNvVlrDup - Obtem Novo Principal para Reparcelamento" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ke()
@ 44,0 GET CRNv_VlrDup ;
	PICTURE "@*HN 19-CRNv_VlrDup - Calc (Vlr Dupl)=X Onde  X+(Juros+Desp-Desc) = Vlr Informado" ;
	SIZE 1,78,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4lc()
@ 53,3 GET CR_001geraNssNro ;
	PICTURE "@*HN 21-CR_001geraNssNro - Gera o campo NossoNumero para Boleto Banco do Brasil" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ll()
@ 54,3 GET CR_237geraNssNro ;
	PICTURE "@*HN 22-CR_237geraNssNro - Gera o campo NossoNumero para Boleto Bradesco" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4lw()
@ 28,8 GET CRProc237 ;
	PICTURE "@*HN 11A-CRProc237-Processa Ocorrencia Retorno Banco Bradesco - 237" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4lx()
@ 29,8 GET CRProc001 ;
	PICTURE "@*HN 11B-CRProc001-Processa Ocorrencia Retorno Banco Bradesco - 001" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ly()
@ 30,8 GET CRProcantigo ;
	PICTURE "@*HN 11a-CRProcantigo - PRimeiro" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4lz()
@ 15,3 GET CRgeraVdor ;
	PICTURE "@*HN 07-CRgeraVdor - Gerar duplicatas com base no vendor" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4mz()
@ 64,10 GET CRtxsVendor ;
	PICTURE "@*HN 26-CRtxsVendor - Taxas do Vendor" ;
	SIZE 1,34,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4nb()
@ 62,4 GET CRcalcVendor ;
	PICTURE "@*HN 25-CRcalcVendor - Calculo Valor Vendor" ;
	SIZE 1,40,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4nc()
@ 58,2 GET CRConfigParcelas ;
	PICTURE "@*HN 27-CRConfigParcelas - Monta Simulacao de Parcelamento" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4nd()
@ 59,4 GET CRQtdeParcelas ;
	PICTURE "@*HN 28-CRQtdeParcelas-Qtde Parec. basedo na String PRAZO 000/030/060.." ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ne()
@ 61,6 GET CRDiasParcela ;
	PICTURE "@*HN 28-CRDiasParcela-Retorna o Prazo da Parcela com base em PRAZO 000/030/060.." ;
	SIZE 1,77,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4og()
@ 57,0 GET CRViewParcelas ;
	PICTURE "@*HN 23-CRViewParcelas-Visualisa e edita vencimentos" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4om()
@ 60,6 GET CRDiaSemana ;
	PICTURE "@*HN 28-CRDiaSemana-Dia da Semana Para Data" ;
	SIZE 1,40,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ou()
@ 63,6 GET CRVerifTxsVendor ;
	PICTURE "@*HN 27-CRVerifTxsVendor - Verifica se Taxas de Vendor estao Cadastradas" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ov()
@ 10,3 GET CRgeraDE12MAR08 ;
	PICTURE "@*HN 07-CRgeraDE12MAR08 - Gerar duplicatas - A PARTIR 12 MAR 2008" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ow()
@ 11,3 GET CRIDLApos26geradupl ;
	PICTURE "@*HN 06-CRIDLApos26geradupl - Gerar duplicatas - FILIAL IDL" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4q2()
@ 20,0 GET CRAtrzcancdupl ;
	PICTURE "@*HN 10-CRAtrzcancdupl - Verifica se as Dupl Podem ser canceladas (Junto com Canc da nota)" ;
	SIZE 1,87,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4qi()
@ 13,6 GET CRdefcarteira ;
	PICTURE "@*HN 28-CRdefcarteira - Define Carteira e Variacao para cobranca" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4qj()
@ 48,0 GET CRDupgeraboleto ;
	PICTURE "@*HN 20a-CRDupgeraboleto - Gera Dados para Emissao de Boleto com base na Dup" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4qk()
@ 49,2 GET CRGrvBoleto ;
	PICTURE "@*HN 20b-CRGrvBoleto - Grava Registro de Boleto" ;
	SIZE 1,44,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4ql()
@ 47,0 GET CRgeraboleto ;
	PICTURE "@*HN 20-CRgeraboleto - Gera Dados para Emissao de Boleto -PARA NF INFORMADA" ;
	SIZE 1,72,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4qm()
@ 65,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 66,0 GET CRreplicaDupl ;
	PICTURE "@*HN CRreplicaDupl-Replica duplica em + x parcelas mensais" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4qv()
@ 50,6 GET ULmsgBoleto ;
	PICTURE "@*HN ULmsgBoleto - Area de mensagem boleto comercial" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4r3()
@ 51,6 GET ULmsgVendor ;
	PICTURE "@*HN ULmsgVendor - Area de mensagem boleto vendor" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4rc()
@ 52,6 GET ULmsgBltSPE ;
	PICTURE "@*HN ULmsgBltSPE - Area de mensagem boleto SPE" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4t3()
@ 67,0 GET CRAplicaINCC ;
	PICTURE "@*HN CRAplicaINCC - Aplica INCC para toda carteira de Cobranca" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4tc()
@ 69,0 GET CRAplicaIGPM ;
	PICTURE "@*HN CRAplicaIGPM - Aplica IGPM para toda carteira de Cobranca" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4td()
@ 68,0 SAY "--------------------------------------------------------------------------" ;
	SIZE 1,74, 0
@ 24,5 GET CRfatimporta ;
	PICTURE "@*HN CRfatimporta-Gera Retornbc (Aviso) de faturamento Banco 990 " ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4te()
@ 23,0 GET CRGerfatPeriodo ;
	PICTURE "@*HN CRGerfatPeriodo-Gera Retornbc (Aviso) de faturamento Banco 990 por periodo" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4tf()
@ 12,3 GET CRgeraDE01JUL12 ;
	PICTURE "@*HN 07-CRgeraDE01JUL12 - Gerar duplicatas - A PARTIR 01 JUL 2012" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4tg()
@ 55,1 SAY "-------------------------------------------------------------------------" ;
	SIZE 1,73, 0
@ 46,1 SAY "-------------------------------------------------------------------------" ;
	SIZE 1,73, 0




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              EMPRESA/MS-DOS Screen Layout               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 11
HIDE WINDOW ALL
ACTIVATE SCREEN
@ 21,2 GET EMGet_UF ;
	PICTURE "@*HN EMGet_UF - Obter UF da Loja" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4tw()
@ 23,2 GET EMGet_Juro ;
	PICTURE "@*HN EMGet_Juro - Obter Juro Mes da Loja" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4u6()
@ 29,2 GET verif ;
	PICTURE "@*HN Verificar Codigo de Empresa" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4uf()
@ 30,2 GET EMrodanroNF ;
	PICTURE "@*HN EMrodanroNF - Roda Numeracao de Nota " ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4w7()
@ 24,2 GET EMGet_Mora ;
	PICTURE "@*HN EMGet_Mora - Obter Mora diaria" ;
	SIZE 1,32,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4wf()
@ 25,2 GET EMGet_Sigla ;
	PICTURE "@*HN EMGet_Sigla - Obter Sigla da empresa" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4wl()
@ 26,2 GET EMGet_ECFSerie ;
	PICTURE "@*HN EMGet_ECFSerie - Obter Nro Serie Ecf" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4wm()
@ 22,2 GET EMGet_Municipio ;
	PICTURE "@*HN EMGet_Municipio - Obter UF da Loja" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4wn()
@ 28,2 GET EMGet_TabCst ;
	PICTURE "@*HN EMGet_TabCst - Obter Tab_CST" ;
	SIZE 1,30,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4wo()
@ 17,2 GET EMLerRegistro ;
	PICTURE "@*HN EMLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4wp()
@ 18,2 GET EMSalvarRegistro ;
	PICTURE "@*HN EMSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4wq()
@ 16,2 GET EMExiste ;
	PICTURE "@*HN EMExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4xk()
@ 2,7 GET EMVerifyInst ;
	PICTURE "@*HN EMVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4xq()
@ 3,10 GET EMCreate ;
	PICTURE "@*HN EMCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4xx()
@ 11,10 GET EMDestroi ;
	PICTURE "@*HN EMDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4y3()
@ 5,13 GET EMReadProp ;
	PICTURE "@*HN EMReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4y4()
@ 8,15 GET EMSetDerivadas ;
	PICTURE "@*HN EMSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4y5()
@ 6,15 GET EMSetPropVT ;
	PICTURE "@*HN EMSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4y6()
@ 7,15 GET EMGetPropVT ;
	PICTURE "@*HN EMGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4y7()
@ 1,2 GET EMChk_Identidade ;
	PICTURE "@*HN EMChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4y8()
@ 0,2 GET EMFind ;
	PICTURE "@*HN EMFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4z8()
@ 13,2 GET EMGetFieldValue ;
	PICTURE "@*HN EMGetFieldValue -Rtrn vlr Campo p/ reg.existente-(erro se chave n existir)" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4zf()
@ 12,2 GET EM_Refresh ;
	PICTURE "@*HN EM_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4zk()
@ 15,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 9,13 GET EMWriteProp ;
	PICTURE "@*HN EMWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4zl()
@ 19,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 14,2 GET EMGetAlias ;
	PICTURE "@*HN EMGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4zm()
@ 31,1 SAY "*-----------------------------------------------------------*" ;
	SIZE 1,61, 0
@ 32,2 GET EMMarcaFlgNF ;
	PICTURE "@*HN EMMarcaFlgNF - Marca flag de controle etapa faturamento NF" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4zn()
@ 27,2 GET EMGet_ECFModelo ;
	PICTURE "@*HN EMGet_ECFModelo - Obter Nro Serie Ecf" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4zo()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              TRIBUTAR/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 12
@ 36,0 SAY "ROTINAS AINDA VINCULADAS AO ORCAMENTO (AINDA DEPEDEM DO NRO ORCAMENTO)" ;
	SIZE 1,70, 0
@ 3,0 SAY "ROTINAS GERAIS - COM PARAMETROS MAIS INDEPENDENTES E ESPECIFICOS" ;
	SIZE 1,64, 0
@ 12,3 GET TRGet_IPIProd ;
	PICTURE "@*HN TRGet_IPIProd - Obtem a Aliquota de IPI do Produto" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _43a0ls4zp()
@ 13,3 GET TRGet_ISSAlq ;
	PICTURE "@*HN TRGet_ISSAlq - Obtem Aliquota de ISS" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _43a0ls50m()
@ 15,6 GET TRdefcst ;
	PICTURE "@*HN TRdefcst - Define CST para Item do Orcamento" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _43a0ls50s()
@ 28,3 GET TRAlqIcmInUF ;
	PICTURE "@*HN TRAlqIcmInUF - Obetem Aliquota Interna de ICMS na UF informada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _43a0ls50z()
@ 29,3 GET TRAlqIcmOuUF ;
	PICTURE "@*HN TRAlqIcmOuUF - Obetem Aliquota Externa de ICMS na UF informada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _43a0ls516()
@ 25,3 GET TRCFO ;
	PICTURE "@*HN TRCFO  - Obtem CFO Pela OPERACAO E TIPO MERCADORIA" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _43a0ls517()
@ 41,6 GET TRGet_IPIAlq ;
	PICTURE "@*HN 02-TRGet_IPIAlq - Obtem a Aliquota de IPI do produto para o orcamento" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _43a0ls518()
@ 42,6 GET TRGet_cst ;
	PICTURE "@*HN 03-TRGet_cst - Obtem CST para o produto no orcamento" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls519()
@ 30,3 GET TRDef_tpMercad ;
	PICTURE "@*HN TRDef_tpMercad- DESVIO COMPATIBILIZA COM TRDef_RgTrbMercad (DESCARTAR FUTURO)" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _43a0ls528()
@ 43,6 GET TRGet_rduIcms ;
	PICTURE "@*HN 06-TRGet_rduIcms - Obtem Aliquota de Reducao do ICMS" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls52f()
@ 44,6 GET TRGet_IcmsAlq ;
	PICTURE "@*HN 07-TRGet_IcmsAlq - Obtem Aliquota de ICMS para Orcamento" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _43a0ls52o()
@ 45,6 GET TRGet_CFO ;
	PICTURE "@*HN 08-TRGet_CFO  - Obtem CFO" ;
	SIZE 1,27,1 ;
	DEFAULT 1 ;
	VALID _43a0ls52p()
@ 39,2 GET TRcalc_tribu ;
	PICTURE "@*HN TRcalc_tribu- Calcula Valores Tributarios Fiscais" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _43a0ls52q()
@ 49,3 GET CSTENT ;
	PICTURE "@*HN ?? - Define CST NF Entrada" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _43a0ls53r()
@ 50,4 GET TRRtdoSaida ;
	PICTURE "@*HN 15-TRRtdoSaida - Ret.Vlr.ICM Retido na Saida" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _43a0ls53z()
@ 51,4 GET TRRtdoEntrada ;
	PICTURE "@*HN 16-TRRtdoEntrada - Ret.Vlr.ICM Retido na Entrada" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _43a0ls540()
@ 52,4 GET TRicmNormal ;
	PICTURE "@*HN 17-TRicmNormal - Ret.Vlr.ICM Normal" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _43a0ls541()
@ 53,4 GET TREnbsicmNormal ;
	PICTURE "@*HN 18-TREnbsicmNormal - Ret.Base ICMS Norma Entrada" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _43a0ls542()
@ 54,4 GET TREbsRtdoCIVA ;
	PICTURE "@*HN 19-TREbsRtdoCIVA - Ret.Base ICMS Retido Entrada (Com IVA)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls543()
@ 55,4 GET TREbsRtdoSIVA ;
	PICTURE "@*HN 20-TREbsRtdoSIVA - Ret.Base ICMS Retido Entrada (Sem IVA)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls559()
@ 1,6 GET TRgrupoALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,17 GET TRgrfiscalALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,28 GET TRtab_IvaALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,39 GET TRtipooperALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 40,4 GET TRcalc_Difer ;
	PICTURE "@*HN 11-TRcalc_Difer- Ajusta Diferanca geradas nos tributo percentuais" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _43a0ls55i()
@ 46,0 SAY "ROTINAS PARA NOVA PLANILHA TRIBUTARIA (OPERCMRC e CLASFISC)" ;
	SIZE 1,59, 0
@ 47,4 GET TRVincTipo ;
	PICTURE "@*HN 16-TRVincTipo - Vincula TIPOOPER a OPERCMRC e A CLASFISC" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _43a0ls55j()
@ 4,3 GET TRGet_IVA ;
	PICTURE "@*HN TRGet_IVA - Obtem o IVA Ajustada proprio do produto (Pecas)" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _43a0ls55k()
@ 48,1 SAY "ROTINAS PARA ENTRADA JA USADAS EM SCGC245 (CONTAB NOTAS ENTRADA)" ;
	SIZE 1,64, 0
@ 26,3 GET TRCFOPServico ;
	PICTURE "@*HN TRCFOPServico - Define CFOP para Servico" ;
	SIZE 1,42,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls55l()
@ 20,3 GET TRCST_IPI ;
	PICTURE "@*HN TRCST_IPI - Codigo de Situacao Tributaria para IPI" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls56o()
@ 21,3 GET TRCST_ISS ;
	PICTURE "@*HN TRCST_ISS - Codigo Sit Tributaria ISS" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls56u()
@ 35,3 GET TRGenero ;
	PICTURE "@*HN TRGenero - Define Genero do Produto" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls570()
@ 14,3 GET TRcst_Icms ;
	PICTURE "@*HN TRcst_Icms - Define CST completo com 3 digitos" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls576()
@ 22,3 GET TRCST_PIS ;
	PICTURE "@*HN TRCST_PIS - Desenvolver" ;
	SIZE 1,25,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls577() ;
	DISABLE
@ 23,3 GET TRCST_COFINS ;
	PICTURE "@*HN TRCST_COFINS - Desenvolver" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls578() ;
	DISABLE
@ 24,3 GET TRCST_IR ;
	PICTURE "@*HN TRCST_IR - Desenvolver" ;
	SIZE 1,24,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _43a0ls579() ;
	DISABLE
@ 0,0 SAY "ALIASES" ;
	SIZE 1,7, 0
@ 31,5 GET TRDef_RgTrbMercad ;
	PICTURE "@*HN TRDef_RgTrbMercad - Retorna o Regime Tributario da Merc. na UF" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _43a0ls57a()
@ 38,0 GET TRpct_trib ;
	PICTURE "@*HN TRpct_trib - (01 a 09) em Pacote de Tributos - Acelera processo" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _43a0ls57b()
@ 32,5 GET TRCnvrt_RgTrbMercad ;
	PICTURE "@*HN TRCnvrt_RgTrbMercad - Converte Codigo Reg Trib em String" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _43a0ls58k()
@ 17,3 GET TRcst_Entrada ;
	PICTURE "@*HN TRcst_Entrada - Define CST para Item do Orcamento" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _43a0ls58s()
@ 6,5 GET TR_InternaIVAAjustada ;
	PICTURE "@*HN TR_InternaIVAAjustada - AUX. IVA IVA interna (PECAS) TERMO DE ACORDO TO/DF/GO" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _43a0ls58t()
@ 7,5 GET TR_ICM49IVAjustada ;
	PICTURE "@*HN TR_ICM49IVAjustada - AUX. (PECAS) -PROT.ICMS 49-8/5/2008 IVA AJUSTAS DF/MT" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _43a0ls58u()
@ 9,5 GET TR_ICM62IVAjustada ;
	PICTURE "@*HN TR_ICM62IVAjustada - AUX. (PECAS) -PROT.ICMS 62-22/6/2012 IVA AJUSTAS" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _43a0ls58v()
@ 8,5 GET TR_ICM92IVAjustada ;
	PICTURE "@*HN TR_ICM92IVAjustada - AUX.(PNEUM)-CONV.ICMS 92-30/9/2011 IVA AJUSTAS" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _43a0ls59u()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              FORNECED/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 13
@ 23,4 GET FRGet_UF ;
	PICTURE "@*HN 01-FRGet_UF - Obter UF do Fornecedor" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5a4()
@ 24,4 GET FRrgm_Fisc ;
	PICTURE "@*HN 01-FRrgm_Fisc - Obter o Regime Fiscal (Normal ou Simples)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5ab()
@ 3,9 GET FRVerifyInst ;
	PICTURE "@*HN FRVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5ac()
@ 4,12 GET FRCreate ;
	PICTURE "@*HN FRCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5ad()
@ 12,12 GET FRDestroi ;
	PICTURE "@*HN FRDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5ae()
@ 6,15 GET FRReadProp ;
	PICTURE "@*HN FRReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5af()
@ 9,17 GET FRSetDerivadas ;
	PICTURE "@*HN FRSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5ag()
@ 7,17 GET FRSetPropVT ;
	PICTURE "@*HN FRSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5bd()
@ 8,17 GET FRGetPropVT ;
	PICTURE "@*HN FRGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5bj()
@ 2,4 GET FRChk_Identidade ;
	PICTURE "@*HN FRChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5bp()
@ 1,4 GET FRFind ;
	PICTURE "@*HN FRFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5bv()
@ 14,4 GET FRGetFieldValue ;
	PICTURE "@*HN FRGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5bw()
@ 13,4 GET FR_Refresh ;
	PICTURE "@*HN FR_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5bx()
@ 16,4 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 18,4 GET FRLerRegistro ;
	PICTURE "@*HN FRLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5by()
@ 10,15 GET FRWriteProp ;
	PICTURE "@*HN FRWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5bz()
@ 19,4 GET FRSalvarRegistro ;
	PICTURE "@*HN FRSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5c0()
@ 17,4 GET FRExiste ;
	PICTURE "@*HN FRExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5cv()
@ 20,4 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 15,4 GET FRGetAlias ;
	PICTURE "@*HN FRGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5d3()
@ 26,4 GET FRGet_Nome ;
	PICTURE "@*HN 01-FRGet_Nome - Obter Nome do Fornecedor" ;
	SIZE 1,42,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5d9()
@ 27,4 GET FRGet_Inscr ;
	PICTURE "@*HN 01-FRGet_Inscr - Obter Nome do Fornecedor" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5da()




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              GRFISCAL/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 14
@ 23,0 SAY "Metodos de Acesso aos Valores das Propriedades" ;
	SIZE 1,46, 0
@ 24,1 GET GFGetTp_Mercadoria ;
	PICTURE "@*HN GFGetTp_Mercadoria - Retorna Tipo Fiscal do Produto na UF" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5db()
@ 3,6 GET GFVerifyInst ;
	PICTURE "@*HN GFVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5dc()
@ 4,9 GET GFCreate ;
	PICTURE "@*HN GFCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5dd()
@ 12,9 GET GFDestroi ;
	PICTURE "@*HN GFDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5de()
@ 6,12 GET GFReadProp ;
	PICTURE "@*HN GFReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5ee()
@ 9,14 GET GFSetDerivadas ;
	PICTURE "@*HN GFSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5ek()
@ 7,14 GET GFSetPropVT ;
	PICTURE "@*HN GFSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5eq()
@ 8,14 GET GFGetPropVT ;
	PICTURE "@*HN GFGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5ew()
@ 2,1 GET GFChk_Identidade ;
	PICTURE "@*HN GFChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5ex()
@ 1,1 GET GFFind ;
	PICTURE "@*HN GFFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5ey()
@ 14,1 GET GFGetFieldValue ;
	PICTURE "@*HN GFGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5ez()
@ 13,1 GET GF_Refresh ;
	PICTURE "@*HN GF_Refresh - Forca Atualiza‡ao Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5f0()
@ 16,1 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 18,1 GET GFLerRegistro ;
	PICTURE "@*HN GFLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5f1()
@ 10,12 GET GFWriteProp ;
	PICTURE "@*HN GFWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5fx()
@ 19,1 GET GFSalvarRegistro ;
	PICTURE "@*HN GFSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5g3()
@ 17,1 GET GFExiste ;
	PICTURE "@*HN GFExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5ga()
@ 20,1 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 15,1 GET GFGetAlias ;
	PICTURE "@*HN GFGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _43a0ls5gg()

IF NOT WVISIBLE("_43a0ls1x0")
	ACTIVATE WINDOW _43a0ls1x0
ENDIF
IF NOT WVISIBLE("_43a0ls1wy")
	ACTIVATE WINDOW _43a0ls1wy
ENDIF


READ


#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º                PRECO/MS-DOS Cleanup Code                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 5
return


*****
************************************
********************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º               ESTOQUE/MS-DOS Cleanup Code               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 6

RETURN








********************************------------***************************
* ROTINAS COPIADAS DA BIBLIOTECA ROTESTOQ
*----------------------------------------------------------------------*
*****************************************************************

********************************************************************
*	UEvendas => Rotina para Verificacao das vendas de um produto
*				solicitado em um periodo
*
*	CHAMADO por SCGC800 : Verificacao de Previsao X Venda Real
*				OBJ_ROL1: Apuracao de Venda real no Periodo
*
********************************************************************

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              DUPLICAT/MS-DOS Cleanup Code               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 9

RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              DUPLIC_A/MS-DOS Cleanup Code               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 10

RETURN




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º   ESTOQUE/MS-DOS Supporting Procedures and Functions    º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 6
FUNCTION UEvendas
	PARAMETERS LNempresa,LSclas,LScodigo,LDdtini,LDdtfim,LNemdias,;
				LNqtvenda,LNqtentra,LNvlrvenda
	
	=W_DEFPROC("rotinas.SPR")
	*********************************************************************
	PRIVATE ALL
	LSalias 	= ALIAS()

	LNqtvenda   = 0
	LNqtentra	= 0
	LNvlrvenda  = 0

	LNacmqtvenda   	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO
	LNacmqtentra	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO
	LNacmvlrvenda  	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO

	*********************>>> REGISTRO DE SAIDAS <<<*********************
	*
	*   O saldo formado no so e considerado ate a 2/3 do
	* do periodo devido a pouca influencia nas vendas do periodo
	* das entradas do 1/3 restante
	*
	********************************************************************
	LDdtfimsld = LDdtini 		 		&& data para referenciar saldo apuradao
	LNdiassld  = INT(LNemdias / 3)* 2  && para apurar o saldo formado
							 			&& ate metade do periodo
	LNctrdias = 0
	DO WHILE LNctrdias <= LNdiassld
		IF DOW(LDdtfimsld) <> 1
			LNctrdias = LNctrdias +1
		ENDIF
		LDdtfimsld = LDdtfimsld + 1
	ENDDO
	*******************************************************************
	DO UEvervendas WITH LDdtini,LDdtfim, LNempresa, LScodigo,;
			LDdtfimsld,LNqtvenda,LNqtentra,LNvlrvenda

	LNacmqtvenda   	= LNqtvenda
	LNacmqtentra	= LNqtentra
	LNacmvlrvenda  	= LNvlrvenda

	*******************************************************************
	SELE grupoanx
	SET ORDER TO TAG classifica
	SEEK LSclas
	IF FOUND()
		*******************************************************************
		DO UEvervendas WITH LDdtini,LDdtfim, LNempresa,;
				grupoanx.codanx,;
				LDdtfimsld,LNqtvenda,LNqtentra,LNvlrvenda
		LNacmqtvenda   	= LNacmqtvenda  + LNqtvenda
		LNacmqtentra	= LNacmqtentra  + LNqtentra
		LNacmvlrvenda  	= LNacmvlrvenda + LNvlrvenda
		*******************************************************************
	ENDIF	
	LNqtvenda 	=	LNacmqtvenda
	LNqtentra	=	LNacmqtentra
	LNvlrvenda	=	LNacmvlrvenda

	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

********************************************************************

PROCEDURE UEvervendas
	PARAMETERS  LDdtini,LDdtfim, LNempresa, LScodigo,LDdtfimsld,;
				LNqtvenda,LNqtentra,LNvlrvenda,LFdevolucao
	******************************************************************
	*	LFdevolucao	= .F. => Processa as devolucoes abatendo nas vendas
	*	              .T. => Nao abate devolucoes nas vendas
	*
	*	LNempresa 	= 999 => FAZ COM QUE A ROTINA LEVANDE  DADOS DE TODAS
	*						EMPRESAS REGISTRADAS NO ARQ. EMPRESA
	*******************************************************************
	=W_DEFPROC("rotinas.SPR")
	PRIVATE ALL
	LSalias 	= ALIAS()
	LNqtvenda   = 0
	LNqtentra	= 0
	LNvlrvenda  = 0

	SELE empresa
	SET ORDER TO TAG empresa
	IF LNempresa = 999
		GO TOP
	ELSE
		SEEK LNempresa
	ENDIF
	DO WHILE !EOF() AND (LNempresa = 999 OR LNempresa = empresa.empresa)
		SELE itemmov
		SET ORDER TO TAG movimento
		SET NEAR ON
		SEEK STR(empresa.empresa,3)+LScodigo+DTOS(LDdtini)
		SET NEAR OFF
		DO WHILE itemmov.data <= LDdtfim AND ;
				 itemmov.empresa = empresa.empresa AND ;
				 itemmov.codigo  = LScodigo
			IF LEFT(itemmov.operacao,1) = 'S' AND itemmov.ch_opera = "1" 	
			 	LNvlrvenda = LNvlrvenda + itemmov.vlrvenda
				IF itemmov.movestq = "S"
				 	LNqtvenda  = LNqtvenda  + itemmov.qtde
				ENDIF
			ENDIF
			IF !LFdevolucao  && ABATER DEVOLUCOES
				IF LEFT(itemmov.operacao,1) = 'E' AND itemmov.ch_opera = "4" AND ;
				    itemmov.movestq = "S"
				 	LNvlrvenda = LNvlrvenda - itemmov.vlrvenda
					IF (LNqtvenda  - itemmov.qtde) >=  0
				 		LNqtvenda  = LNqtvenda  - itemmov.qtde
					ENDIF
				ENDIF
			ENDIF
		IF itemmov.data <= LDdtfimsld AND LEFT(itemmov.operacao,1) = 'E' ;
				AND itemmov.ch_opera <> "4" AND itemmov.movestq = "S"
				 	LNqtentra  = LNqtentra  + itemmov.qtde
		ENDIF
			***********************************************************
			*  CASO A MERCADORIA SAI POR TRANSFERENCIA OU POR MOV. QUE NAO
			* SEJA VENDA ELA E DESCONSIDERADA
			* DAS ENTRADAS POIS NAO ESTA DESTINADA AO ESTOQUE DE VENDA
			***********************************************************
			IF LEFT(itemmov.operacao,1) = 'S' AND ;
					itemmov.ch_opera <> "1"	&& SAIDAS DEVERSAS DA VENDA
				 IF itemmov.movestq = "S"
					 	LNqtentra  = LNqtentra  - itemmov.qtde
				 ENDIF
				 IF LNqtentra < 0
				 	LNqtentra = 0
				 ENDIF
			ENDIF
			SKIP
		ENDDO	
		IF LNempresa <> 999		&& PESQUISA SO NA EMPRESA INFORMADA
			EXIT
		ENDIF
		SELE empresa
		SKIP
	ENDDO
	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(0)




**********************************************************************
* FUNCTION UEleanexado : Retorna o Codigo ou Codigo Anexado ao Codigo
*						Passado em Parametro
*		LSclas		=>	Codigo a Ser Verificado
*		LSresposta	=>  Indica qual a resposta desejad
*					"ANEXO" = Responder se o Produto Possui algum item
*							Anexado a ele
*					"ANEXADO" = Responder se o Produto esta ANEXADO a
*							outro
*					"QUALQUER"= Responder se existe vinculo em qualqer
*							sentido
***********************************************************************

FUNCTION UEleanexado
PARAMETERS LSclas,LSpergunta
	PRIVATE LSalias, LSresposta

	=W_DEFPROC("rotinas.SPR")

	PRIVATE LFerro
	LSalias = ALIAS()

	LSresposta = ""
    SELE grupoanx
	DO CASE
		CASE LSpergunta = "ANEXO"
			SET ORDER TO TAG classifica
			SEEK LSclas
			IF FOUND()
				LSresposta = grupoanx.codanx	&& E ANEXO DO CODIGO INFORMADO
			ENDIF
		CASE LSpergunta = "ANEXADO"
			SET ORDER TO TAG clasanx
			SEEK LSclas
			IF FOUND()
				LSresposta = grupoanx.codanx	&& E ANEXO DO CODIGO INFORMADO
			ENDIF
		CASE LSpergunta = "QUALQUER"
			LSresposta = UEleanexado(LSclas,"ANEXO")
			IF EMPTY(LSresposta)
				LSresposta = UEleanexado(LSclas,"ANEXADO")
			ENDIF
	ENDCASE
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSresposta)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS1YY           NFVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    3      º
*       º Variable:            NFVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      1                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls1yy     &&  NFVerifyInst VALID
#REGION 1
return
*---------------------------------------------------------------*



FUNCTION NFVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Nota")


	DO CASE

		CASE TYPE("PBNotaAlias") = "U" ;
		   		OR EMPTY(PBNotaAlias) ;
		   		OR !USED(PBNotaAlias)
			=NFCreate()					

		CASE !("NOTA.DBF" $ DBF(PBNotaAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBNotaAlias
			=NFCreate()					


		CASE  !(LSPath $ DBF(PBNotaAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=NFDestroi()				
			=NFCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS1Z6           NFCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    4      º
*       º Variable:            NFCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      2                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls1z6     &&  NFCreate VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NFCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBNotaAlias") <> "U" ;
	   		AND !EMPTY(PBNotaAlias) ;
	   		AND USED(PBNotaAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBNotaAlias

	IF USED("Nota")
	     =NetArqAgain("Nota")
	     PBNotaAlias     = Alias()
	ELSE
	     =NetArqAgain("Nota")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Nota")
	     PBNotaAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBNotaAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTNota[LMaxDim]
    PUBLIC DIMENSION VDNota[2,3]			&& VETOR PARA PROPRIEDADES
	*-----------------------------------------------------------*
	=NFReadProperty()
	=NFSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS1Z7           NFDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    5      º
*       º Variable:            NFDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      3                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls1z7     &&  NFDestroi VALID
#REGION 1
return
*---------------------------------------------------------------*


FUNCTION NFDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBNotaAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBNotaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBNotaAlias
	*  3- Se aplicar um FECHAMENTO a PBNotaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBNotaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBNotaAlias)) OR ;
	   !("NOTA.DBF" $ DBF(PBNotaAlias))

		RELEASE PBNotaAlias
    	RELEASE VTNota
	    RELEASE VDNota
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBNotaAlias) AND USED(PBNotaAlias)
		SELECT &PBNotaAlias
		USE
	ENDIF	
	RELEASE PBNotaAlias
    RELEASE VTNota
    RELEASE VDNota

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS1ZM           NFReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    6      º
*       º Variable:            NFReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      4                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls1zm     &&  NFReadProp VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NFReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=NFVerifyInst()

	SELE &PBNotaAlias
	SCATTER TO VTNota
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS1ZS           NFSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    7      º
*       º Variable:            NFSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      5                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls1zs     &&  NFSetDerivadas VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NFSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

**	=NFVerifyInst()
	*--------------------------------------------------------------*
    VDNota(1,1) = "NAOINFORMADO"
   	VDNota(1,2) = 0
   	VDNota(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS1ZZ           NFSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    8      º
*       º Variable:            NFSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      6                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls1zz     &&  NFSetPropVT VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NFSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

**	=NFVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,PrmValue,;
						    PBNotaAlias,VTNota,VDNota)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS205           NFGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:    9      º
*       º Variable:            NFGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      7                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls205     &&  NFGetPropVT VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NFGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

**	=NFVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,PBNotaAlias,VTNota,VDNota)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS20F           NFChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   10      º
*       º Variable:            NFChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      8                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls20f     &&  NFChk_Identidade VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFChk_Identidade
PARAMETERS  ;
			PrmEmp,;
			PrmNota


	PRIVATE LFretorno
	LFretorno = .t.



	=NFVerifyInst()
    =NFSetPropVT("EMPRESA",PrmEmp)
    =NFSetPropVT("NOTA",PrmNota)


	LFretorno=NFFind()
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS20M           NFFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   11      º
*       º Variable:            NFFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      9                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls20m     &&  NFFind VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NFFind

	PRIVATE LEmpresa,;
			LNota
			
	
	


	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NFVerifyInst()


	LEmpresa    = NFGetPropVT("Empresa")
	LNota       = NFGetPropVT("Nota")


	SELE &PBNotaAlias
	SET ORDER TO TAG NOTA
	SEEK STR(Lempresa,3)+STR(LNota,7)
	
	IF FOUND()
		=NFReadProperty()
		=NFSetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS20T           NFGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   12      º
*       º Variable:            NFGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      10                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls20t     &&  NFGetFieldValue VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NFGetFieldValue
PARAMETERS  PrmEmp,;
			PrmNota,;
			PrmField			

	=NFChk_Identidade(PrmEmp,;
					  PrmNota)

RETURN(NFGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS20U           NF_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   13      º
*       º Variable:            NF_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      11                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls20u     &&  NF_Refresh VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NF_Refresh
PARAMETERS  PrmEmpresa,;
			PrmNota
			
	
	


	PRIVATE LFreturn

	=NFVerifyInst()


	= NFSetPropVT("Empresa" ,PrmEmpresa)
	= NFSetPropVT("Nota"    ,PrmNota)

	*----------------------------------------------------------------*


	=NFFind()
	
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS216           NFWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   14      º
*       º Variable:            NFWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      12                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls216     &&  NFWriteProp VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NFWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=NFVerifyInst()

	SELE &PBNotaAlias
	GATHER FROM  VTNota
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS21C           NFLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   16      º
*       º Variable:            NFLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      13                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls21c     &&  NFLerRegistro VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFLerRegistro
PARAMETERS  PrmEmp,;
			PrmNota

	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = NFChk_Identidade(PrmEmp,;
			PrmNota)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS21I           NFSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   17      º
*       º Variable:            NFSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      14                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls21i     &&  NFSalvarRegistro VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFSalvarRegistro

	=NFVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !NFExiste()
		SELE &PBNotaAlias
		APPEND BLANK
		LFretorno=NFWriteProp()
	ELSE
		SELE &PBNotaAlias
		LFretorno=NFWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS21P           NFExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   18      º
*       º Variable:            NFExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      15                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls21p     &&  NFExiste VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NFExiste

	PRIVATE LEmpresa,;
			LNota
			

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NFVerifyInst()

	LEmpresa    = NFGetPropVT("Empresa")
	LNota	    = NFGetPropVT("NOTA")


	SELE &PBNotaAlias
	SET ORDER TO TAG NOTA
	SEEK STR(Lempresa,3)+STR(LNota,7)
	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS21X           NFGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   20      º
*       º Variable:            NFGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      16                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls21x     &&  NFGetAlias VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NFGetAlias

	=NFVerifyInst()

RETURN(PBNotaAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS223           NFFaxinaDados VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA,     Record Number:   21      º
*       º Variable:            NFFaxinaDados                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      17                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls223     &&  NFFaxinaDados VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NFFaxinaDados

	PRIVATE LSAlias, TOTAL, CTR
	=NFVerifyInst()

	LSAlias = NFGetAlias()
	
	SELE &LSAlias





	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*





	COUNT TO TOTAL
	CTR = 0

	GO TOP
	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;

		=UPtermo()


		=RLOCK()


		CTR = 	CTR + 1
		MSG = STR(CTR,7)+" DE "+STR(TOTAL,7)
		WAIT WINDOW MSG NOWAIT


		REPLACE NOME WITH UPLimpaString(NOME)
		REPLACE ENDERECO WITH UPLimpaString(ENDERECO)


		=W_DEFPROC("CLIENTES.SPR")
		IF !CLVld_CPF_CNPJ( &LSAlias .FAVORECIDO )
			REPLACE CPFCNPJVLD  WITH "E"  && CPF/CNPJ ERRADO
		ENDIF

		SKIP
	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
	


RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS22B           NFRgAvisoCaixa VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    3    º
*       º Variable:            NFRgAvisoCaixa                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      18                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls22b     &&  NFRgAvisoCaixa VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFRgAvisoCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa
	*------------------------------------------------------------*
    PRIVATE LFreturn
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()
	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !FOUND()
	    =up_fecha("&ALS_Nota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*

   	IF &ALS_Nota .ch_condi = "1"   &&  A VISTA
		LFreturn = NFRgAvistaCaixa(PrmEmpresa,PrmNota)
   	ELSE
		LFreturn = NFRgAprazoCaixa(PrmEmpresa,PrmNota)
   	ENDIF

	*---------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS22C           NFRgAvistaCaixa VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    4    º
*       º Variable:            NFRgAvistaCaixa                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      19                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls22c     &&  NFRgAvistaCaixa VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFRgAvistaCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa de NF A VISTA
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_LancaCx,ALS_LancaCx
    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_OrPgt,ALS_OrPgt

	PRIVATE LNseqDup
	
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    ARQ_OrPgt  = NetArqAgain("ORCA_PGT")
    ALS_OrPgt  = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()

	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND() OR &ALS_Nota .ch_condi <> "1"   && NÇO  A VISTA
	    =up_fecha("&ALS_Nota")
    	=up_fecha("&ALS_OrPgt")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
    * So gera controle para notas :
    *    - Operacao de Venda (ch_opera = "1")
    *    - A para notas a prazo com entrada  	
	*----------------------------------------------------------*
	SELE &ALS_OrPgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(&ALS_Nota .referencia,6)
	SET NEAR OFF
	*-------------------------------------------------------------*
	DO WHILE !EOF() ;
			AND &ALS_OrPgt .empresa = PrmEmpresa ;
			AND &ALS_OrPgt .orcamento = &ALS_Nota .referencia
	   	m.EMPRESA 	= PrmEmpresa
	   	m.PORTADOR  = 0            && Defini Caixa
		m.NOME      = &ALS_Nota .nome
 		m.data      = &ALS_Nota .data
 		m.dt_VENC   = &ALS_Nota .data
		*--------------------------------------------------------------*
		*=> Pgto Entrada em Diheiro(1) ou Cheque(2) => La‡ar para CAIXA
		*--------------------------------------------------------------*
		IF &ALS_OrPgt .modo_pgto = 1  AND ;
		    ( &ALS_OrPgt .moeda = 1 OR &ALS_OrPgt .moeda = 2 )
			
		    m.TIPO_DOC  = 1            && Codigo Tabela Padrao para NF
		    m.NUM_DOC   = STR(PrmNota,15)
	    	m.valor     = &ALS_OrPgt .vlr_pgto
			IF &ALS_OrPgt .moeda = 1
				m.MOEDA = "DINHEIRO"
			ELSE
				m.MOEDA = "CHEQUE"
			ENDIF			

		    m.JUROS        = 0
		    m.DESCONTOS    = 0
		    m.PROCESSADO   = "N"
		    m.OPERACAO     = "LANCAR"
		    m.LOG_LANCA    = "Lanc. Automatico Faturamento."

		    sele &ALS_LancaCx
		    =edithand('SAVE')
		    IF m.MOEDA = "CHEQUE"
			    m.TIPO_DOC  = 3         && REGISTRO PARA CONTROLE DE CHQ
			    sele &ALS_LancaCx
			    =edithand('SAVE')
		    ENDIF
		ENDIF
		SELE &ALS_OrPgt
		SKIP
	ENDDO
	*-------------------------------------------------------------*
	*---------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
   	=up_fecha("&ALS_OrPgt")
   	=up_fecha("&ALS_LancaCx")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS22T           NFRgAprazoCaixa VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    5    º
*       º Variable:            NFRgAprazoCaixa                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      20                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls22t     &&  NFRgAprazoCaixa VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFRgAprazoCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    PRIVATE ARQ_LancaCx,ALS_LancaCx
    PRIVATE ARQ_Duplicat,ALS_Duplicat

	PRIVATE LNseqDup
	
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()

    ARQ_Duplicat  = NetArqAgain("DUPLICAT")
    ALS_Duplicat  = Alias()


	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !FOUND() OR &ALS_Nota .ch_condi = "1"  &&  A VISTA
	    =up_fecha("&ALS_Nota")
    	=up_fecha("&ALS_LancaCx")
    	=up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
	*----------------------------------------------------------*

	=W_DEFPROC("duplicat.spr")
    LNnroDup = CRNroIDdupl(PrmEmpresa,PrmNota,1)


    SELE &ALS_Duplicat
  	SET ORDER TO TAG doc
	SET NEAR ON
    SEEK STR(PrmEmpresa,3)+STR(LNnroDup,9)
    SET NEAR OFF
	*-------------------------------------------------------------*
	DO WHILE !EOF() ;
			AND &ALS_Duplicat .empresa = PrmEmpresa ;
			AND &ALS_Duplicat .nota = PrmNota
	   	m.EMPRESA 	= PrmEmpresa
	   	m.PORTADOR  = 0            && Defini Caixa
		m.NOME      = &ALS_Nota .nome
 		m.data      = &ALS_Nota .data
 		m.dt_VENC   =  &ALS_Duplicat .dt_venc
		*--------------------------------------------------------------*
		*=> Pgto Entrada em Diheiro(1) ou Cheque(2) => La‡ar para CAIXA
		*--------------------------------------------------------------*
		IF  ( &ALS_Duplicat .moeda = 1 OR &ALS_Duplicat .moeda = 2 )
			
			IF &ALS_Duplicat .moeda = 1
				m.MOEDA = "DINHEIRO"
			ELSE
				m.MOEDA = "CHEQUE"
			ENDIF			

	        m.NUM_DOC   = STR( &ALS_Duplicat .duplicata ,15)
    		m.valor     = &ALS_Duplicat .vlr_doc

		    m.JUROS        = 0
		    m.DESCONTOS    = 0
		    m.PROCESSADO   = "N"
		    m.OPERACAO     = "LANCAR"
		    m.LOG_LANCA    = "Lanc. Automatico Faturamento."

			IF &ALS_Duplicat .portador = 993  && Entrada para CAIXA
	       		m.TIPO_DOC  = 2            && Codigo Tabela Padrao para dupl
			    sele &ALS_LancaCx
			    =edithand('SAVE')
			ENDIF
			
		    IF m.MOEDA = "CHEQUE"
			    m.TIPO_DOC  = 3         && REGISTRO PARA CONTROLE DE CHQ
			    sele &ALS_LancaCx
			    =edithand('SAVE')
		    ENDIF
		ENDIF
		SELE &ALS_Duplicat
		SKIP
	ENDDO
	*-------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
   	=up_fecha("&ALS_LancaCx")
   	=up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS233           NFCnAvisoCaixa VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    6    º
*       º Variable:            NFCnAvisoCaixa                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      21                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls233     &&  NFCnAvisoCaixa VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFCnAvisoCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Cancelamento
	*             de Lancamento no Sistema de Caixa
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

    PRIVATE LFretorno
    PRIVATE LSalias

    PRIVATE ARQ_Nota,ALS_Nota

    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !FOUND()
	    =up_fecha("&ALS_Nota")
	    =up_fecha("&ALS_Orcamento")
    	=up_fecha("&ALS_LancaCx")
    	=up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF


	*---------------------------------------------------------------*

   	IF &ALS_Nota .ch_condi = "1"   &&  A VISTA
		LFreturn = NFCnAvstaCaixa(PrmEmpresa,PrmNota)
   	ELSE
		LFreturn = NFCnAprzoCaixa(PrmEmpresa,PrmNota)
   	ENDIF

	*---------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS23A           NFCnAvstaCaixa VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    7    º
*       º Variable:            NFCnAvstaCaixa                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      22                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls23a     &&  NFCnAvstaCaixa VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFCnAvstaCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Cancelamento lara Lancamento
	*              no Sistema de Caixa de NF A VISTA
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_LancaCx,ALS_LancaCx
    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_OrPgt,ALS_OrPgt

	PRIVATE LNseqDup
	
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    ARQ_OrPgt  = NetArqAgain("ORCA_PGT")
    ALS_OrPgt  = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()

	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND() OR &ALS_Nota .ch_condi <> "1"   && NÇO  A VISTA
	    =up_fecha("&ALS_Nota")
    	=up_fecha("&ALS_OrPgt")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
    * So gera controle para notas :
    *    - Operacao de Venda (ch_opera = "1")
    *    - A para notas a prazo com entrada  	
	*----------------------------------------------------------*
	SELE &ALS_OrPgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(&ALS_Nota .referencia,6)
	SET NEAR OFF
	*-------------------------------------------------------------*
	DO WHILE !EOF() ;
			AND &ALS_OrPgt .empresa = PrmEmpresa ;
			AND &ALS_OrPgt .orcamento = &ALS_Nota .referencia
	   	m.EMPRESA 	= PrmEmpresa
	   	m.PORTADOR  = 0            && Defini Caixa
		m.NOME      = &ALS_Nota .nome
 		m.data      = &ALS_Nota .data
 		m.dt_VENC   = &ALS_Nota .data
		*--------------------------------------------------------------*
		*=> Pgto Entrada em Diheiro(1) ou Cheque(2) => La‡ar para CAIXA
		*--------------------------------------------------------------*
		IF &ALS_OrPgt .modo_pgto = 1  AND ;
		    ( &ALS_OrPgt .moeda = 1 OR &ALS_OrPgt .moeda = 2 )
			
		    m.TIPO_DOC  = 1            && Codigo Tabela Padrao para NF
		    m.NUM_DOC   = STR(PrmNota,15)
	    	m.valor     = &ALS_OrPgt .vlr_pgto
			IF &ALS_OrPgt .moeda = 1
				m.MOEDA = "DINHEIRO"
			ELSE
				m.MOEDA = "CHEQUE"
			ENDIF			

		    m.JUROS        = 0
		    m.DESCONTOS    = 0
		    m.PROCESSADO   = "N"
		    m.OPERACAO     = "CANCELAR"
		    m.LOG_LANCA    = "** Cancelamento Lanc.Faturamento."

		    sele &ALS_LancaCx
		    =edithand('SAVE')
		    IF m.MOEDA = "CHEQUE"
			    m.TIPO_DOC  = 3         && REGISTRO PARA CONTROLE DE CHQ
			    sele &ALS_LancaCx
			    =edithand('SAVE')
		    ENDIF
		ENDIF
		SELE &ALS_OrPgt
		SKIP
	ENDDO
	*-------------------------------------------------------------*
	*---------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
   	=up_fecha("&ALS_OrPgt")
   	=up_fecha("&ALS_LancaCx")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS23O           NFCnAprzoCaixa VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    8    º
*       º Variable:            NFCnAprzoCaixa                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      23                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls23o     &&  NFCnAprzoCaixa VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFCnAprzoCaixa
  PARAMETER PrmEmpresa,PrmNota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias
	=W_DEFPROC("rotinas.spr")

    PRIVATE ARQ_Nota,ALS_Nota
    PRIVATE ARQ_LancaCx,ALS_LancaCx
    PRIVATE ARQ_Duplicat,ALS_Duplicat

	PRIVATE LNseqDup
	
    LSAlias      = Alias()

    ARQ_Nota     = NetArqAgain("NOTA")
    ALS_Nota     = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()

    ARQ_Duplicat  = NetArqAgain("DUPLICAT")
    ALS_Duplicat  = Alias()


	*-----------------------------------------*

    SELE &ALS_Nota
  	SET ORDER TO TAG nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !FOUND() OR &ALS_Nota .ch_condi = "1"  &&  A VISTA
	    =up_fecha("&ALS_Nota")
    	=up_fecha("&ALS_LancaCx")
    	=up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	*----------------------------------------------------------*
	*----------------------------------------------------------*

	=W_DEFPROC("duplicat.spr")
    LNnroDup = CRNroIDdupl(PrmEmpresa,PrmNota,1)


    SELE &ALS_Duplicat
  	SET ORDER TO TAG doc
	SET NEAR ON
    SEEK STR(PrmEmpresa,3)+STR(LNnroDup,9)
    SET NEAR OFF
	*-------------------------------------------------------------*
	DO WHILE !EOF() ;
			AND &ALS_Duplicat .empresa = PrmEmpresa ;
			AND &ALS_Duplicat .nota = PrmNota
	   	m.EMPRESA 	= PrmEmpresa
	   	m.PORTADOR  = 0            && Defini Caixa
		m.NOME      = &ALS_Nota .nome
 		m.data      = &ALS_Nota .data
 		m.dt_VENC   =  &ALS_Duplicat .dt_venc
		*--------------------------------------------------------------*
		*=> Pgto Entrada em Diheiro(1) ou Cheque(2) => La‡ar para CAIXA
		*--------------------------------------------------------------*
		IF  ( &ALS_Duplicat .moeda = 1 OR &ALS_Duplicat .moeda = 2 )
			
			IF &ALS_Duplicat .moeda = 1
				m.MOEDA = "DINHEIRO"
			ELSE
				m.MOEDA = "CHEQUE"
			ENDIF			

	        m.NUM_DOC   = STR( &ALS_Duplicat .duplicata ,15)
    		m.valor     = &ALS_Duplicat .vlr_doc

		    m.JUROS        = 0
		    m.DESCONTOS    = 0
		    m.PROCESSADO   = "N"
		    m.OPERACAO     = "CANCELAR"
		    m.LOG_LANCA    = "** Cancelamento Lanc.Faturamento."


			IF &ALS_Duplicat .portador = 993  && Entrada para CAIXA
	       		m.TIPO_DOC  = 2            && Codigo Tabela Padrao para dupl
			    sele &ALS_LancaCx
			    =edithand('SAVE')
			ENDIF
			
		    IF m.MOEDA = "CHEQUE"
			    m.TIPO_DOC  = 3         && REGISTRO PARA CONTROLE DE CHQ
			    sele &ALS_LancaCx
			    =edithand('SAVE')
		    ENDIF
		ENDIF
		SELE &ALS_Duplicat
		SKIP
	ENDDO
	*-------------------------------------------------------------*
    =up_fecha("&ALS_Nota")
   	=up_fecha("&ALS_LancaCx")
   	=up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS23X           NFNroNFServico VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:    9    º
*       º Variable:            NFNroNFServico                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      24                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls23x     &&  NFNroNFServico VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFNroNfServico
PARAMETERS LNemp,LStp_process,LNnota,LNcupom
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Definir o numero da nota ou cumpo conforme a
	*		empresa e o processo determinado
	*------------------------------------------------------------*
	* COMENTARIO..: O padrao ‚ retornar o numero da ultima nota
	*				faturada
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LStp_process...: Processo definido em NFDefProcess
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNnota.........: Numero definido para Nota
	*		LNcupom........: Numero Cupom relacionado a nota
	*						(Quando processo de RECUPERACAO)
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	DO  CASE

		CASE LStp_proces = "REC.NOTA/CUPOM"
			DO OBJ_2FAT.SPR WITH LNcupom,0,LNnota,"SERVICO"
			IF LNnota > 0				&& CONFIRMOU OS DADOS
				LNnota     = LNnota - 1 && O USUARIO VAI DIGITAR O NUMERO
										&& REAL DA NOTA O SISTEMA TRATA COMO
										&& O ULTIMO NUMERO ,POR ISSO
										&& SUBTRAIR O 1 						 				
				IF LNnota < 2000000
					LNnota = LNnota + 2000000
				ENDIF
			ENDIF
		OTHERWISE
			LNnota     = empresa.ult_nfsrvc
			IF LNnota < 2000000
				LNnota = LNnota + 2000000
			ENDIF

	ENDCASE
	*--------------------------------------------------------------*
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota+1,7)  && VER SE PROXIMO NUMERO JA GRAVADO
	IF FOUND()
	   	WAIT WINDOW "No. Nota ja emitido. "+STR(LNnota+1,7)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS247           NFNroCtrlCupom VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   10    º
*       º Variable:            NFNroCtrlCupom                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      25                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls247     &&  NFNroCtrlCupom VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFNroCtrlCupom
PARAMETERS LNemp,LStp_process,LNcupom
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Definir o numero de Controle Interno de Cupom
	*------------------------------------------------------------*
	* COMENTARIO..: O padrao ‚ retornar o numero do ultimo
	*              Controle Interno de Cupom Faturado
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LStp_process...: Processo definido em NFDefProcess
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNcupom........: Numero Cupom relacionado a nota
	*						(Quando processo de RECUPERACAO)
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LNnumeroDoc
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*------------------------------------------------------------*
	DO  CASE
		CASE LStp_proces = "CUPOM"
			LNnumeroDoc     = empresa.ult_cupom 						 				
			IF LNnumeroDoc < 1000000
				LNnumeroDoc = LNnumeroDoc + 1000000
			ENDIF
		CASE LStp_proces = "REC.CUPOM"
			DO OBJ_2FAT.SPR WITH LNcupom,LNnumeroDoc,0,(LStp_proces)
			IF LNnumeroDoc > 0		&& CONFIRMOU OS DADOS
				LNnumeroDoc = LNnumeroDoc - 1
										&& O USUARIO VAI DIGITAR O NUMERO
										&& REAL DA NOTA O SISTEMA TRATA COMO
										&& O ULTIMO NUMERO ,POR ISSO
										&& SUBTRAIR O 1 						 				
				IF LNnumeroDoc < 1000000
					LNnumeroDoc = LNnumeroDoc + 1000000
				ENDIF
			ENDIF
	ENDCASE
	*--------------------------------------------------------------*
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnumeroDoc+1,7)
								  && VER SE PROXIMO NUMERO JA GRAVADO
	IF FOUND()
	   	WAIT WINDOW "No. Nota ja emitido. "+STR(LNnumeroDoc+1,7)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNnumeroDoc)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS24E           NFDelItensNf VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   11    º
*       º Variable:            NFDelItensNf                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      26                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls24e     &&  NFDelItensNf VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFDelItensNf
PARAMETERS LNemp,LNnota
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Eliminar Itens Referentes a Nota No Movimento*	
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNnota.........: Nro da Nota para eliminar itens
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LNcodigo
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
    SELECT itemmov
    SET ORDER TO TAG itensnota
	SET NEAR ON
    SEEK STR(LNemp,3)+"S"+STR(LNnota,7)
	SET NEAR OFF
	DO WHILE !EOF() AND LNemp = itemmov.empresa ;
					AND LEFT(itemmov.operacao,1) = "S" ;
					AND LNnota    = itemmov.nota

			IF itemmov.tipo <> nota.tipo
				SKIP
				LOOP
			ENDIF

		    LNcodigo = itemmov.codigo
			SELE itmanexo
			SET ORDER TO TAG movanexo
			SEEK STR(itemmov.empresa,3)+itemmov.codigo+;
				 DTOS(itemmov.data)+itemmov.hora+itemmov.tipo+;
			 	STR(itemmov.nota,7)+STR(itemmov.ordem,3)
			if found()
				=REGLOCK(.T.)
				=edithand('APAGA')
			ENDIF
			UNLOCK
			SELE itemmov
		   	=W_DEFPROC("moviment.spr")
			=MVCancelMvto(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e
			SELE itemmov
		    SET ORDER TO TAG movimento
			SKIP
    ENDDO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS24N           NFdefNatureza VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   12    º
*       º Variable:            NFdefNatureza                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      27                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls24n     &&  NFdefNatureza VALID
#REGION 2
return
*---------------------------------------------------------------*
FUNCTION NFdefNatureza
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Informar a menssagem adequada para o
	*                campo natureza a ser impresso em RELNFS2
	*------------------------------------------------------------*
	* COMENTARIO..:     Esta funcao foi implementada em funcao
	*              de se querer informa a natureza VENDA CARTAO
	*              que nao e uma natureza expecificada em funcao
	*              do tipo como as demais
	*				   O rgistro da nota ja esta posicionado pelo
	*   			relatorio
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*		
	*------------------------------------------------------------*
	* EXEMPLO : RELNFS2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	IF nota.ch_opera = "1" AND (nota.tp_parcela = 4 OR nota.tp_parcela = 5)
		RETURN("VENDA CARTAO")
	ENDIF
	IF nota.ch_opera = "1" AND (nota.tp_parcela = 6)
		RETURN("VENDA VENDOR")
	ENDIF
	
RETURN(nota.natureza)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS24U           NFpede_cancelamento VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   13    º
*       º Variable:            NFpede_cancelamento                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      28                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls24u     &&  NFpede_cancelamento VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFpede_cancelamento



	PRIVATE LSstatus
	LSstatus = ""

	PRIVATE LSemiteNFe, LSemiteCFe

	PRIVATE LSdbant,VLleitura,VLlerfim,VLcompara,VLchvlimi, LNregvolta
	PRIVATE LStipo,LNnf
	PRIVATE LNEmpSelec, LNNotaSelec
	******>>>> INICIO CONTROLE ARQUIVOS
	*>> parametros repassados a btn_val
	VLleitura = "STR(wp_empresa,3)"
                         * repassa chave de leitura p/ btn_val
	VLlerfim  = "STR(wp_empresa+1,3)"
           * repassa chave de leitura p/ btn_val (POSICAO FINAL + 1 REG)

	VLcompara = "nota.empresa = wp_empresa "
                         * repassa chave de comparacao p/ btn_val
	VLchvlimi = "STR(wp_empresa,3)"
	*-----------------------------------------------------------------*
	LSdbant = ALIAS()
	SELE nota
	SET ORDER TO TAG ORDEM_EMI
	SET NEAR ON
	SEEK VLlerfim
	ON KEY LABEL ESCAPE
	DO loc_dlog WITH .T.,Vlcompara, VLchvlimi,.F.,.F., .F.
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	SET NEAR OFF

	IF LASTKEY() = 27
		SELE orcament
	    RETURN .F.
	ENDIF


	LNnota = nota.nota

	IF LNnota = 0
	   SELE orcament
	   RETURN
	ENDIF
    LScp1 = STR(LNnota,7)

	wp_msg = "Confirma Solicitacao de Cancelamento p/ "+LScp1
	IF !fox_alert(wp_msg)
	   SELE orcament
	   RETURN
	ENDIF
	wp_msg = 'Informe Seu Codigo e sua Senha p/ CANCELAR..'
	LNusuario = nUsr
	BTMP   =  'usuario.usuario = LNusuario '
	LNusr_ret = 0
	DO obj_prmt.SPR WITH   wp_msg , Btmp
	IF LNusr_ret =  0
	   WAIT WINDOW "Cancelamento nao Efetuado.....<ENTER>"
	   SELE orcament
	   RETURN
	ENDIF




	=W_DEFPROC("EMPRESA.SPR")
	LSemiteNFe = EMGetFieldValue(wp_empresa,"EMITE_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemiteCFe = EMGetFieldValue(wp_empresa,"EMITE_CFE")




	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(wp_empresa,3)+STR(LNnota,7)
	IF !FOUND()
	   WAIT WINDOW ;
	   "Cancelamento nao iniciado. Nao Localizou Reg. no Sistema .<ENTER>"
	   SELE orcament
	   RETURN
	ENDIF
	
	LNEmpSelec  = nota.empresa
	LNNotaSelec = nota.nota


**	SET STEP ON

    M.NFEJSTFCAN    = nota.NFEJSTFCAN

    do obj_just.spr with M.NFEJSTFCAN

    if m.NFEJSTFCAN = ""
	   WAIT WINDOW ;
	   "Cancelamento nao iniciado. Nao Localizou Reg. no Sistema .<ENTER>"
	   SELE orcament
	   RETURN
	ENDIF

    SELE NOTA
	=REGLOCK(.T.)

    REPLACE nota.NFEJSTFCAN   WITH m.NFEJSTFCAN

	UNLOCK

	

	DO CASE

        CASE LSemiteCFe = "S" ;
		        AND  ( nota.nota > 1000000 ;
		        AND nota.nota < 2000000)

			&& ==> SOLICITOU CANCELAMENTO DE UM CUPOM FISCAL ELETRONICO

			IF NFCanCopias(LNEmpSelec,LNNotaSelec,M.NFEJSTFCAN)
				=NFCancNota(LNEmpSelec,LNNotaSelec)
			ENDIF


		CASE   (nota.cupom > 0 AND nota.tipo <> "CPM" ) ;
			AND (nota.tp_parcela = 4 or nota.tp_parcela = 5)
			&& ==> SOLICITOU CANCELAMENTO DE UM TEF
			=NFCancTEF(LNEmpSelec,LNNotaSelec)
		

		CASE   (nota.nota <= 999999 AND nota.cupom = 0 )

			&& ==> SOLICITOU CANCELAMENTO DE UMA NOTA
			=NFCancNota(LNEmpSelec,LNNotaSelec)


		CASE   (    nota.nota > 1000000 ;
		        AND nota.nota < 2000000)

			&& ==> SOLICITOU CANCELAMENTO DE UM CUPO

			IF NFCanCopias(LNEmpSelec,LNNotaSelec,M.NFEJSTFCAN)
				=NFCancCupom(LNEmpSelec,LNNotaSelec)
			ENDIF

 		CASE   (    nota.nota > 2000000 ;
		        AND nota.nota < 3000000 ;
		        AND nota.cupom = 0 )
			&& ==> SOLICITOU CANCELAMENTO DE UMA NOTA DE SERVICO
			=NFCancNfSrv(LNEmpSelec,LNNotaSelec)


		CASE   (    nota.nota > 3000000 ;
		        AND nota.nota < 4000000 ;
		        AND nota.cupom = 0 )
			&& ==> SOLICITOU CANCELAMENTO DE UMA NFe
			=NFCancNota(LNEmpSelec,LNNotaSelec)


 		CASE   (    nota.nota > 4000000 ;
		        AND nota.nota < 5000000 ;
		        AND nota.cupom = 0 )
			&& ==> SOLICITOU CANCELAMENTO DE UMA NFSe
			=NFCancNfSrv(LNEmpSelec,LNNotaSelec)


		CASE   (nota.cupom > 0 AND nota.tipo <> "CPM" )
			&& ==> SOLICITOU CANCELAMENTO DE UM CUPO

			IF NFCanCopias(LNEmpSelec,LNNotaSelec)
				=NFCancCupom(LNEmpSelec,LNNotaSelec)
			ENDIF


		CASE   nota.tipo = "CPM" AND LSemiteNFe = "S"

			&& ==> SOLICITOU CANCELAMENTO DE UMA COPIA
			=NFCanNFCopia(LNEmpSelec,LNNotaSelec)


		CASE   nota.tipo = "CPM"
			&& ==> SOLICITOU CANCELAMENTO DE TODAS Copias
			=NFCanCopias(LNEmpSelec,LNNotaSelec)

		OTHERWISE
			&& ==> SOLICITOU CANCELAMENTO DE UMA NOTA
			=NFCancNota(LNEmpSelec,LNNotaSelec)
			
	ENDCASE

    SELE orcament

RETURN

***



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS255           NFCancNota VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   14    º
*       º Variable:            NFCancNota                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      29                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls255     &&  NFCancNota VALID
#REGION 2
return
*---------------------------------------------------------------*

********************
FUNCTION NFCancNota
PARAMETERS PrmEmpresa,PrmNota
	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF
		
		***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF nota.data <> wp_dtoper
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
		   "      A Nota Fiscal informada para cancelamento "+;
		   "nao pertence a data de hoje. Esta operacao so "+;
		   " e permitida em caso de intervencao do suporte."
			wp_msg = 'Usuario Suporte...'
		BTMP   =  'usuario.retroacao = "S"'
		LNusr_ret = 0
		DO obj_prmt.SPR WITH   wp_msg , Btmp
		IF LNusr_ret =  0
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF	
	SCATTER MEMVAR


	*----------------------------------------------------------------*
	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa,PrmNota)
	IF LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			

	*-----------------------------------------------------------*

	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*
	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
	REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************

	IF LSobjetivo = "ESCRITURACAO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	UNLOCK ALL
    SELE orcament
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS25D           NFCancCupom VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   15    º
*       º Variable:            NFCancCupom                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      30                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls25d     &&  NFCancCupom VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION NFCancCupom
PARAMETERS PrmEmpresa,PrmNota
	PRIVATE  Flg_aceita,LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr
	STORE 0  TO  LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr

	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.F.)
	ENDIF

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
		
	***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***

	=W_DEFPROC("ECF.spr")
	LNcupom = INT(ECFnrocupom())
	IF LNcupom = 0
   		DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+chr(13)+;
		   "  A ECF esta Retornando Numero de CUPOM = ZERO." +;
		   "Verifique <STATUS>. Verifique <Numero do Cupom>. "+;
		   "Verifique <RESET>. Se Persistir Contacte SUPORTE."
	    SELE orcament
		RETURN(.F.)
	ENDIF

	SELE nota

    IF nota.cupom   = LNcupom
		  Flg_aceita = .T.
    ELSE
		  Flg_aceita = .F.
	ENDIF
							
	IF !Flg_aceita
	   LScp1 = STR(PrmNota,7)
	   LScp2 = STR(nota.cupom,7)
	   LScp3 = STR(LNcupom,7)
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				   "      O numero de DOCUMENTO ["+LScp1+;
				   "] informado p/ cancelamento "+;
				    "esta relacionado ao CUPOM ["+LScp2+;
				    " ] sendo que o ultimo CUPOM localizado pelo "+;
				    "sistema e  ["+LScp3+"]"+;
				    chr(13)+"   Verifique os dados e tente novamente."
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Reg. Cupom Nao Pode ser Bloqueado Para Cancelamento.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	*-----------------------  CACELANDO ECF--------------------------*	

	LNCartaoVlr = 0
	=W_DEFPROC("ECF.spr")
	LSstatus=ECFcanccpm(nota.cupom,LNCartaoVlr)

	IF SUBS(LSstatus,7,1) = "E"
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
		   "      A impressora fiscal nao acatou o cancelamento."+;
		   "Repita o processo e se persistir a negacao entre "+;
		   " em contato com suporte informando o menssagem : "+;
		    LSstatus
	   SELE orcament
	   RETURN(.f.)
	ENDIF			




	CLEAR TYPEAHEAD


	SELE  NOTA
	SCATTER MEMVAR
	*-----------------------------------------------------------*
	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*





	*----------------------------------------------------------------*

	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa,PrmNota)
	IF LSobjetivo = "ESCRITURACAO" or LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	*----------------------------------------------------------------*


	***********   LIBERAR STATUS DE PROCESSO EM EMPRESA *******
	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
	REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************
	UNLOCK ALL
    LScp1 = STR(PrmNota,7)
    DO OBJ_MENS.SPR WITH ;
    	   "    OK !! " + CHR(13)+CHR(13)+;
		   "    Cumpom cancelado na ECF e no REGISTRO "+chr(13)+;
		   " [ "+LScp1+" ]"
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS25N           NFCancTEF VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   16    º
*       º Variable:            NFCancTEF                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      31                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls25n     &&  NFCancTEF VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFCancTEF
PARAMETERS PrmEmpresa,PrmNota
	PRIVATE  Flg_aceita,LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr
	STORE 0  TO  LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr

	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF
		
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***

	=W_DEFPROC("ECF.spr")
	LNcupom = INT(ECFnrocupom())
	IF LNcupom = 0
   		DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+chr(13)+;
		   "  A ECF esta Retornando Numero de CUPOM = ZERO." +;
		   "Verifique <STATUS>. Verifique <Numero do Cupom>. "+;
		   "Verifique <RESET>. Se Persistir Contacte SUPORTE."
	    SELE orcament
		RETURN(.F.)
	ENDIF

	SELE nota


  	IF (nota.cupom+1) = LNcupom OR;
	   (nota.cupom)   = LNcupom
		  Flg_aceita = .T.
 	ELSE
		  Flg_aceita = .F.
	ENDIF

							
	IF !Flg_aceita
	   LScp1 = STR(PrmNota,7)
	   LScp2 = STR(nota.cupom,7)
	   LScp3 = STR(LNcupom,7)
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				   "      O numero de DOCUMENTO ["+LScp1+;
				   "] informado p/ cancelamento "+;
				    "esta relacionado ao CUPOM ["+LScp2+;
				    " ] sendo que o ultimo CUPOM localizado pelo "+;
				    "sistema e  ["+LScp3+"]"+;
				    chr(13)+"   Verifique os dados e tente novamente."
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	=W_DEFPROC("ORCAMENT.SPR")
	=ORVlr_e_FormPgto(nota.Empresa,;
				  nota.Referencia,;
				  LNCheque1Vlr,;
				  LNDinheiroVlr,;
				  LNCartaoVlr)

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Reg. Cupom Nao Pode ser Bloqueado Para Cancelamento.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	************************************************	
	LSstatus=ECFcanccpm(nota.cupom,LNCartaoVlr)

	IF SUBS(LSstatus,7,1) = "E"
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
		   "      A impressora fiscal nao acatou o cancelamento."+;
		   "Repita o processo e se persistir a negacao entre "+;
		   " em contato com suporte informando o menssagem : "+;
		    LSstatus
	   SELE orcament
	   RETURN(.f.)
	ENDIF			







	CLEAR TYPEAHEAD
	SELE  NOTA
	SCATTER MEMVAR

	*-----------------------------------------------------------*
	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*


	*----------------------------------------------------------------*

	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa,PrmNota)
	IF LSobjetivo = "ESCRITURACAO" or LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	*----------------------------------------------------------------*





	***********   LIBERAR STATUS DE PROCESSO EM EMPRESA *******
	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
	REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************
	UNLOCK ALL
    LScp1 = STR(PrmNota,7)
    DO OBJ_MENS.SPR WITH ;
    	   "    OK !! " + CHR(13)+CHR(13)+;
		   "    Cumpom cancelado na ECF e no REGISTRO "+chr(13)+;
		   " [ "+LScp1+" ]"
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS25X           NFCancNCN VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   17    º
*       º Variable:            NFCancNCN                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      32                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls25x     &&  NFCancNCN VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFCancNCN
PARAMETERS PrmEmpresa,PrmNota
	PRIVATE  Flg_aceita,LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr
	STORE 0  TO  LNCheque1Vlr,LNDinheiroVlr, LNCartaoVlr

	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF
		
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***

	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Reg. Cupom Nao Pode ser Bloqueado Para Cancelamento.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF

	*-----------------------------------------------------------*

	LSstatus=ECFcanccpm(nota.cupom,0)

	*-----------------------------------------------------------*

	CLEAR TYPEAHEAD
	SELE  NOTA
	SCATTER MEMVAR
	*-----------------------------------------------------------*
	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*




	*----------------------------------------------------------------*

	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa,PrmNota)
	IF LSobjetivo = "ESCRITURACAO" or LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa,PrmNota,LSobjetivo ))
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF			


	*----------------------------------------------------------------*



	***********   LIBERAR STATUS DE PROCESSO EM EMPRESA *******
	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
	REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************
	UNLOCK ALL
    LScp1 = STR(PrmNota,7)
    DO OBJ_MENS.SPR WITH ;
    	   "    OK !! " + CHR(13)+CHR(13)+;
		   "    Cumpom cancelado na ECF e no REGISTRO "+chr(13)+;
		   " [ "+LScp1+" ]"
RETURN(.t.)

****************************************************************************

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS266           NFCanCopias VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   18    º
*       º Variable:            NFCanCopias                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      33                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls266     &&  NFCanCopias VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION NFCanCopias
PARAMETER PrmEmpresa, PrmNota,prmNFEJSTFCAN



	PRIVATE LNnroReferencia

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND()
		RETURN(.F.)
	ENDIF

	IF nota.tipo = "CPM"
		LNnroReferencia = nota.referencia	
	ELSE
		LNnroReferencia = nota.nota	
	ENDIF



	LFretorno = .T.

	SET ORDER TO TAG referencia
	SEEK STR(PrmEmpresa,3)+STR(LNnroReferencia,7)
	DO WHILE !EOF() AND PrmEmpresa   = nota.empresa ;
	                AND LNnroReferencia =  nota.referencia
			IF nota.tipo <> "CPM"
				SKIP
				LOOP
			ENDIF

		    SELE NOTA
			=REGLOCK(.T.)

		    REPLACE nota.NFEJSTFCAN   WITH prmNFEJSTFCAN

			UNLOCK



			*-------------------------------------------------------*

			PRIVATE LSobjetivo
			LSobjetivo = NFDefCancDFis(PrmEmpresa, nota.nota)
			IF LSobjetivo = "CANCELAMENTO"
				IF !(NF_CancDFis(PrmEmpresa, nota.nota, LSobjetivo ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+;
				   CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao acatou"+;
					" o cancelamento."+;
			        " Repita o processo e se persistir a negacao entre "+;
				    " em contato com suporte"

					LFretorno = .F.
					EXIT

					*SELE NOTA
					*SKIP
					*LOOP
				ENDIF
			ENDIF


			*------------------------------------------------------------*
	



		    m.status = 2
			=RLOCK()
			***************************
			SELE nota
			SET FIELDS TO dtregis, hregis, usrregis,deletado
		    SET FIELDS TO status
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
			***************************

			*-------------------------------------------------------*

			IF LSobjetivo = "ESCRITURACAO"
				IF !(NF_CancDFis(PrmEmpresa, nota.nota, LSobjetivo ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao acatou"+;
					" o cancelamento."+;
				     " Repita o processo e se persistir a negacao entre "+;
				     " em contato com suporte"

					LFretorno = .F.
					EXIT

					*SELE NOTA
					*SKIP
					*LOOP
				ENDIF
			ENDIF


			*------------------------------------------------------------*


			SELE NOTA
			SKIP
	ENDDO
	***************************
	UNLOCK ALL
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS26E           NFCancNfSrv VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   19    º
*       º Variable:            NFCancNfSrv                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      34                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls26e     &&  NFCancNfSrv VALID
#REGION 2
return
*---------------------------------------------------------------*

********************
FUNCTION NFCancNfSrv
PARAMETERS PrmEmpresa,PrmNota
	SELE empresa
	SEEK PrmEmpresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN(.f.)
	ENDIF
		
		***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***
	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF nota.data <> wp_dtoper
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
		   "      A Nota Fiscal informada para cancelamento "+;
		   "nao pertence a data de hoje. Esta operacao so "+;
		   " e permitida em caso de intervencao do suporte."
			wp_msg = 'Usuario Suporte...'
		BTMP   =  'usuario.retroacao = "S"'
		LNusr_ret = 0
		DO obj_prmt.SPR WITH   wp_msg , Btmp
		IF LNusr_ret =  0
		   SELE orcament
		   RETURN(.f.)
		ENDIF
	ENDIF	
	SCATTER MEMVAR

	*----     CACELANDO DOCUMENTO FISCAL        -------*	

	*-------------------------------------------------------*
	PRIVATE LSobjetivo
	LSobjetivo = NFDefCancDFis(PrmEmpresa, PrmNota)
	IF LSobjetivo = "CANCELAMENTO"
		IF !(NF_CancDFis(PrmEmpresa, PrmNota, LSobjetivo ))
			   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
  	   	   RETURN(.f.)
		ENDIF
	ENDIF			
    *---------------------------------------------------------*

	*-----------------------------------------------------------*
	=W_DEFPROC("nota.spr")
	=NFCtrlCancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
	*-----------------------------------------------------------*

	*-------------------------------------------------------*
	IF LSobjetivo = "ESCRITURACAO"
		IF !(NF_CancDFis(PrmEmpresa, PrmNota, LSobjetivo ))
			   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o cancelamento."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		   SELE orcament
  	   	   RETURN(.f.)
		ENDIF
	ENDIF			
    *---------------------------------------------------------*



	SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
	REPLACE FLAGIMPSRV 	WITH 4	&& LIBERA FATURAMENTO
	*************************************************************
	UNLOCK ALL
    SELE orcament
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS26N           NFCtrlCancFatura VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   20    º
*       º Variable:            NFCtrlCancFatura                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      35                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls26n     &&  NFCtrlCancFatura VALID
#REGION 2
return
*---------------------------------------------------------------*
FUNCTION NFCtrlCancFatura
PARAMETERS 	LNemp, LNnota, LStp_proc
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Controlar o Cancelamento de NF/Cupons Vinculados
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNnota.........: Nro da Nota para Cancelar
	*		LStp_proc......: "NORMAL"
	*	     				 "AUTOMATICO"
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .F. ou .T.
	*		
	*------------------------------------------------------------*
	* EXEMPLO : SCGC004
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE TmpRefOsi
	PRIVATE LNMarcaRegNota


	IF TYPE("LStp_proc") <> "C"
		LStp_proc = "NORMAL"
	ENDIF


	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota,7)

	IF !FOUND()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Nao Localizado "+;
	   		"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF


	*------------------------------------------------------------*
	*   Verificar se as duplicatas estao em condicao de cancelamento
	*------------------------------------------------------------*
	=W_DEFPROC("DUPLICAT.spr")
	IF !CRAtrzcancdupl((LNemp),(nota.orcamento))
		   WAIT WINDOW ;
		   "Duplicata com Vlr. Pago nao permitem cancelamento <ENTER>"
	   RETURN(.f.)
	ENDIF
	
	*------------------------------------------------------------*
	* Inicio cancelamento copias vinculadas
	*------------------------------------------------------------*

	LNnroRegCupom  = 0
	SELE nota
*	=NFCanCopias(LNemp,LNnota)


	* Qdo um cupom for cancelado suas copias tambem devem ser canceladas
	*------------------------------------------------------------*
	* Inicio cancelamento normal
	*------------------------------------------------------------*
	

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota,7)

	IF !FOUND()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Nao Localizado "+;
	   		"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF


	IF !REGLOCK()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Esta Aberto Para Outro Usuario. "+;
   			"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF

	TmpRefOsi = nota.referencia
	
	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(TmpRefOsi,6)
	IF FOUND()
		IF !REGLOCK()
			IF LStp_proc =  "NORMAL"
				WAIT WINDOW ;
					"O Orc.Ref. a Nota Esta Aberto Para Outro Usuario. "+;
				   	"Tente Novamente <ENTER>"
			ENDIF
			RETURN(.f.)
		ENDIF
	ENDIF

	*-------------------------------------------------------------------
	* POR DESCARACTERZAR A NOTA O PROCESSO (IF) SEGUINTE E TIDO COMO
	*-------------------------------------------------------------------
	* UM PROCESSO COMPLEMENTAR DE CANCELAMENTO A SER EXECUTADO SOMENTE QDO.
	* O CANCELAMENTO NORMAL JA FOI EXECUTADO
	*-------------------------------------------------------------------
	
	SELE NOTA	
	IF  nota.tipo = "ENT"
	    m.status = 2
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado,status
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
		UNLOCK ALL
		RETURN(.t.)
	ENDIF

	DO WHILE !BOF() AND LNemp   = nota.empresa ;
	                AND TmpRefOsi =  nota.referencia
		SELE NOTA
		SKIP -1
	ENDDO

	IF !BOF()
		SKIP
	ENDIF

	DO WHILE !EOF() AND LNemp   = nota.empresa ;
	                AND TmpRefOsi =  nota.referencia

		LNMarcaRegNota = RECNO()
		=NFCancFatura(LNemp, nota.nota, LStp_proc)
		SELE nota
		SET ORDER TO TAG nota
		GO LNMarcaRegNota
		SKIP
	ENDDO


	*********************************
	* REABILITAR ORCAMENTO
	*********************************

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota,7)

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(nota.referencia,6)
	
	IF FOUND()
		=REGLOCK(.T.)
		SELE orcament
		m.situacao = orcament.situacao
		DO CASE
			CASE orcament.situacao = "OC"
									&& Fat. direto pelo faturista
    			m.situacao = 'A '&& Orcamento aberto estado inicial
			OTHERWISE
		    	m.situacao = 'o '    && Volta a osi para caixa

		ENDCASE
		REPLACE situacao WITH m.situacao
	ENDIF
	*********************************************************************
	SELE nota
	CLEAR FIELDS
	SET FIELDS OFF
	UNLOCK ALL
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS26Y           NFCancFatura VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   21    º
*       º Variable:            NFCancFatura                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      36                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls26y     &&  NFCancFatura VALID
#REGION 2
return
*---------------------------------------------------------------*
FUNCTION NFcancFatura
PARAMETERS 	LNemp, LNnota, LStp_proc
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Cancelar Nota Fiscal
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNnota.........: Nro da Nota para Cancelar
	*		LStp_proc......: "NORMAL"
	*	     				 "AUTOMATICO"
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .F. ou .T.
	*		
	*------------------------------------------------------------*
	* EXEMPLO : SCGC004
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LNosiNfReferencia

	IF TYPE("LStp_proc") <> "C"
		LStp_proc = "NORMAL"
	ENDIF

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(LNemp,3)+STR(LNnota,7)

	IF !FOUND()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Nao Localizado "+;
	   		"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF

	IF !REGLOCK()
		IF LStp_proc =  "NORMAL"
		   WAIT WINDOW "Registro da Nota Esta Aberto Para Outro Usuario. "+;
   			"Tente Novamente <ENTER>"
		ENDIF
	   RETURN(.f.)
	ENDIF

	LNosiNfReferencia = nota.referencia

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNosiNfReferencia,6)
	IF FOUND()
		IF !REGLOCK()
			IF LStp_proc =  "NORMAL"
				WAIT WINDOW ;
					"O Orc.Ref. a Nota Esta Aberto Para Outro Usuario. "+;
				   	"Tente Novamente <ENTER>"
			ENDIF
			RETURN(.f.)
		ENDIF
	ENDIF
	*----- POR DESCARACTERZAR A NOTA O PROCESSO (IF) SEGUINTE E TIDO COMO
	* UM PROCESSO COMPLEMENTAR DE CANCELAMENTO A SER EXECUTADO SOMENTE QDO.
	* O CANCELAMENTO NORMAL JA FOI EXECUTADO
	*-------------------------------------------------------------------
	SELE nota
	IF  nota.tipo = "ENT"
	    m.status = 2
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
	    SET FIELDS TO status
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
		UNLOCK ALL
		RETURN(.t.)
	ENDIF









	SELECT  itemmov
	SET ORDER TO TAG itensnota
	SET NEAR ON
	SEEK STR(LNemp,3)+"S"+STR(LNnota,7)
	SET NEAR OFF
	************************************
	LFretorno = .t.  && SE .F. => TRANSACAO DEVE SER ABORTADA
	DO WHILE !eof() AND nota.nota     = itemmov.nota ;
					AND nota.empresa  = itemmov.empresa
			*---------------------------------------------------*
			*   Registros de SCA podem se misturar a ordem dos
			* registros de saidas comercias quando coincidirem
			* os numeros da SCA e da NFS. Pois as duas operacoes
			* sao de saida.
			*	A condicao abaixo evita que registro de tipos
			* distintos sejam confundidos.
			*---------------------------------------------------*
			IF nota.tipo  <> itemmov.tipo
				SKIP
				LOOP
			ENDIF
		    SKIP					&& PASSA PARA REGISTRAR O PROXIMO
			IF !EOF()
		   	   LNproximo  = RECNO()  && POR CAUSA DA DELECAO
			ELSE
			   LNproximo  = 0
			ENDIF
	        SKIP - 1				&&  VOLTA AO REG. DEVIDO
			IF !REGLOCK()
			   LFretorno = .f.
			   EXIT
			ENDIF
			IF !UNFbaixa_saldo()
			   LFretorno = .f.
			   EXIT
			ENDIF

			DO UNFdesfatura

	    	SELECT itemmov
			SET ORDER TO TAG itensnota
			IF LNproximo  > 0
				GO LNproximo && DEVIDO A DELECAO E PROCESS DE ATU_CMD
			ELSE
				EXIT
			ENDIF
	ENDDO
	SELE nota
	IF !LFretorno   && OPERACAO NAO FOI CONCLUIDA COM SUCESSO
		RETURN(.f.)
	ENDIF			
	********************************
	LNnota	= nota.nota

				
    *------------------------------------------------*
	* NOTIFICAR CANCELAMENTO AO SISTEMA DE CAIXA
    *   Quando um orcamento gerar mais de uma nota
    * o sistema so notificara o caixa quando a ultima
    * nota for cancelada
    *------------------------------------------------*
	=NFCnAvisoCaixa((LnEmp), (LNnota))
    *------------------------------------------------*

	*------------------------------------------*
	=W_DEFPROC("DUPLICAT.spr")
	=CRcancdupl((LNemp),(LNnota))
	*------------------------------------------*
	*----------------------------------------------------------------*
**	DO  NFCancBonus WITH (LNemp),(nota.referencia)
	*----------------------------------------------------------------*



	*********************************
	* REABILITAR ORCAMENTO
	*********************************
	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNosiNfReferencia,6)
	
	IF FOUND()
		=REGLOCK(.T.)
		IF !(orcament.qtdnfgerad - 1) < 1
			IF nota.status <> 2
				REPLACE qtdnfgerad WITH orcament.qtdnfgerad - 1
			ENDIF
		ENDIF

		IF nota.status <> 2
			SELE orcament
			REPLACE qtdnfgerad WITH orcament.qtdnfgerad - 1
			m.situacao = orcament.situacao
			IF orcament.qtdnfgerad < 1		&& ULTIMA NOTA DO ORCAMENTO
				DO CASE
					CASE orcament.situacao = "OC"
											&& Fat. direto pelo faturista
		    			m.situacao = 'A '&& Orcamento aberto estado inicial
					CASE (WP_ECF $ "SRIQ") ;
						AND LEFT(orcament.situacao,1) = "O"
						&&  ESTA USANDO ECF
				    	m.situacao = 'o '    && Volta a osi para caixa
					CASE LEFT(orcament.situacao,1) = "O" && Faturado
				    	m.situacao = 'M '  && Volta a osi impressa integral
				ENDCASE
				REPLACE situacao WITH m.situacao
			ENDIF
		ENDIF
	ENDIF
	*********************************************************************
	SELE nota
	m.status = 2
	***************************
	SET FIELDS TO dtregis, hregis, usrregis,deletado
	SET FIELDS TO status
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF

	IF orcament.qtdnfgerad > 0 AND nota.status = 2
		IF LStp_proc =  "NORMAL"
		    DO OBJ_ALER.SPR WITH ;
			   "O Orcamento Gerou Mais de Uma nota. Cancele Todas......"+;
			   CHR(13)+;
			   "So assim o Orcamento Sera Disponibilizado."
		ENDIF
	ENDIF
	UNLOCK ALL
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS27B           UNFbaixa_saldo VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   22    º
*       º Variable:            UNFbaixa_saldo                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      37                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls27b     &&  UNFbaixa_saldo VALID
#REGION 2
return
*---------------------------------------------------------------*
*********************************
PROCEDURE UNFbaixa_saldo  && VERIFICA POSSIBILIDADE DE  BAIXA  NO ESTOQUE
   IF itemmov.tp_mercad = 7  && SERVICO NAO NECESSITA SALDO
      RETURN .T.
   ENDIF
   IF LEFT(itemmov.codigo,4) = "9999"  && COMENTARIO NAO NECESSITA SALDO
      RETURN .T.
   ENDIF

   SELECT saldo
   SET ORDER TO TAG clas_saldo
   SEEK STR(LNemp,3)+itemmov.classifica+;
        STR(YEAR(nota.data),4)+;
        STR(MONTH(nota.data),2)
   IF !FOUND()
      WAIT WINDOW RTRIM(transform(itemmov.codigo,'@R &masc_codi'))+;
                   " nao foi aberto para movimentacao. Solicite abertura."
      RETURN .F.
   ENDIF
RETURN .T.



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS27I           UNFdesfatura VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   23    º
*       º Variable:            UNFdesfatura                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      38                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls27i     &&  UNFdesfatura VALID
#REGION 2
return
*---------------------------------------------------------------*
PROCEDURE UNFdesfatura
* se nao for localiza em orcatmp deve ser apagado em itemmov

   SELECT itemmov
   SET ORDER TO TAG movimento
   SELE itmanexo
   SET ORDER TO TAG movanexo
   SEEK STR(itemmov.empresa,3)+itemmov.codigo+;
			 DTOS(itemmov.data)+itemmov.hora+itemmov.tipo+;
			 STR(itemmov.nota,7)+STR(itemmov.ordem,3)
   IF FOUND()
		=REGLOCK(.T.)
		=edithand('APAGA')
   ENDIF
   SELE itemmov
   =REGLOCK(.T.)
   *-------------------------------------------------------------*
   *    Desfaturao  item em orcatmp
   *-------------------------------------------------------------*

   =ULatvitem(nota.empresa,nota.referencia,itemmov.ordem)

   m.codigo = itemmov.codigo
   *-------------------------------------------------------------*
   IF itemmov.qtde  = 0 				OR ;
   	  itemmov.tp_mercad = 7 			OR ;
      itemmov.situacao = "OC"  			OR ;
      !FOUND("ORCATMP")					&& (OC) Fat. direto sem reserva
      									&& SE NA ROTINA ULATVITEM NAO
      									&& TIVER ENCONTRADO ORCATMP
      									&& EXCLUI DO MOVIMENTO
			SELE itemmov
		   	=W_DEFPROC("moviment.spr")
			=MVCancelMvto(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e

   ELSE
		   **************** REABILITA RESERVA ANTERIOR AO FATURAMENTO *****
		   	SELE itemmov
		   	m.situacao = "M "
	   	   	m.operacao = 'RVPS'   && RESERVA/VENDA/PROCESSADA/
									  && APROVEITA O MOV. P/ RESERVA
	   	   	m.nota     = 0
		  	***************************
		   	SET FIELDS TO dtregis, hregis, usrregis,deletado
		   	SET FIELDS TO situacao,operacao,nota
		   	=edithand('REGRAVA')
		   	CLEAR FIELDS
		   	SET FIELDS OFF
		   	***************************
			SELE itemmov
		   	=W_DEFPROC("moviment.spr")
			=MVatu_cmd(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e
   ENDIF


RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS27Q           ULatvitem VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   24    º
*       º Variable:            ULatvitem                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      39                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls27q     &&  ULatvitem VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION ULatvitem
	PARAMETERS LNemp,LNreferencia,LNordem

		*---------------------------------------------------------*
		*  Reativa o item de orcatmp vinculado ao item da nota
		* itemmov cancelado
		*---------------------------------------------------------*
		PRIVATE LSalias
		LSalias = ALIAS()

		SELECT  orcatmp
		SET ORDER TO TAG orcamento
		SEEK STR(LNemp,3)+STR(LNreferencia,6)+STR(LNordem,2)
		************************************
		IF FOUND()
	    	SELECT orcatmp
			DO CASE
				CASE orcatmp.situacao = "OC" && Fat direto pelo faturista
		    		m.situacao = 'A '        && OSI aberto estado inicial
				OTHERWISE
			    	m.situacao = 'o '    && Volta a osi para caixa
			ENDCASE


	*		DO CASE
	*			CASE orcatmp.situacao = "OC" && Fat direto pelo faturista
	*	    		m.situacao = 'A '        && OSI aberto estado inicial
	*			CASE (WP_ECF $ "SRIQ") AND LEFT(orcatmp.situacao,1) = "O"
	*				&&  ESTA USANDO ECF
	*		    	m.situacao = 'o '    && Volta a osi para caixa
	*			CASE LEFT(orcatmp.situacao,1) = "O" && Faturado
	*		    	m.situacao = 'M '    && Volta a osi impressa integral
	*		ENDCASE
*


			=REGLOCK(.T.)
			REPLACE situacao WITH m.situacao				
		ENDIF
		SELE &LSalias
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS27W           NFEcfInforme VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   25    º
*       º Variable:            NFEcfInforme                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      40                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _43a0ls27w     &&  NFEcfInforme VALID
#REGION 2
return
*---------------------------------------------------------------*
FUNCTION NFEcfInforme
PARAMETERS 	LNemp, LDdtini, LDdtFim, LNnroIni,LNnroFim,LNvalorTot,;
			LNicmsTot
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:   Colher informacoes referentes saidas regis-
	*			tradas em ECF
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LDdtini........: Data Inicial
	*		LDdtfim........: Data Final
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNnroIni.......: Numero do 1 Cupom Emitido
	*		LNnroFim.......: Numero do Ultimo Cupom Emitido
	*		LNvalorTot.....: Valor das Saidas Registradas em ECF
	*		LNicmsTot......: Valor do ICMS Registrado
	*------------------------------------------------------------*
	* EXEMPLO : SCGC220
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	LSalias = ALIAS()
	PRIVATE LSmsg
	PRIVATE LNicmCalc
	*------------------------------------------------------------*
	LNnroIni		= 	99999999
	LNnroFim		= 	0
	LNvalorTot		=	0
	LNicmsTot		=	0
	LNicmCalc		=	0


	SELE nota
	SET ORDER TO TAG data
	SET NEAR ON
	SEEK STR(LNemp,3)+DTOS(LDdtIni)
	SET NEAR OFF
	DO WHILE !EOF() AND LNemp = nota.empresa AND nota.data <= LDdtFim
		LSmsg = "Informacoes do ECF ... Data : "+DTOC(nota.data)+;
				" Nota : "+STR(nota.nota,7)
		WAIT WINDOW LSmsg NOWAIT				

		IF nota.cupom = 0 OR nota.tipo = "CPM"
			SKIP
			LOOP
		ENDIF

		IF nota.cupom > LNnroFim
			LNnroFim = nota.cupom
		ENDIF
		IF nota.cupom < LNnroIni
			LNnroIni = nota.cupom
		ENDIF
		IF nota.status <> 2 && NOTA CANCELADA
			LNvalorTot	=	LNvalorTot 	+ 	nota.total_nota
			*--------------------------------------------------------*
			*   O campo nota.vlr_icms nao era calculado ate o mes 7/2000
			* por isso adota-se o calculo do icms na linha abaixo
			* esse problema pode ser sanado calculando-se o VLR_ICMS para
			* todas as notas emitidas
			*--------------------------------------------------------*
	******	LNicmsTot	=	LNicmsTot	+	nota.vlr_icms		
			IF nota.base_icms > 0 ;
				AND nota.aliq_icms > 0 ;
				AND nota.vlr_icms = 0
					LNicmCalc = ROUND(nota.base_icms*nota.aliq_icms / 100,2)
			ELSE
					LNicmCalc 	=	nota.vlr_icms
			ENDIF
			LNicmsTot	=	LNicmsTot	+	LNicmCalc
		ENDIF
		SKIP
	ENDDO
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS285           NFtot_nfs VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   26    º
*       º Variable:            NFtot_nfs                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      41                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls285     &&  NFtot_nfs VALID
#REGION 2
RETURN

FUNCTION NFtot_nfs
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Retornar o Valor Totadas das Nota emitidas
	*			em um periodo especifico
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Filial em que se deve apurar o valor
	*		LDt_ini........: Data inicial que se deve apurar o valor
	*		LDt_fim........: Data inicial que se deve apurar o valor
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o VALOR DAS NOTAS VALIDAS
	*------------------------------------------------------------*
	*  EXEMPLO.....:
	*------------------------------------------------------------*

PARAMETERS  LNemp, LDt_ini, LDt_fim
	PRIVATE LNtotal, LSalias
	PRIVATE LFnota
	LSalias			= ALIAS()
		
	=W_DEFPROC("rotinas.spr")
	LFnota	= NetArq("nota")
	IF (LFnota) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("nota" ,LFnota)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*---------------------------------------------------------------*	
	*	Valor total das notas nao canceladas
	*---------------------------------------------------------------*	
	LNtotal  = 0
	sele nota
	SET ORDER TO TAG data
	SET NEAR ON
	SEEK STR(LNemp,3)+DTOS(LDt_ini)
	SET NEAR OFF
	DO WHILE !EOF() AND nota.data  <= LDt_fim ;
					AND nota.empresa  = LNemp
			LNtotal 	=  LNtotal + nota.total_nota
			SKIP
	ENDDO

	=UP_fecha("nota" ,LFnota)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNtotal)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS28C           NFgeraBonus VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   27    º
*       º Variable:            NFgeraBonus                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      42                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls28c     &&  NFgeraBonus VALID
#REGION 2
RETURN
*********************************************************************
*  NFgeraBonus.....: Gera Bonus
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Bonus
*                   Empresa
*                   Orcament
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

PROCEDURE NFGeraBonus
	
	PARAMETERS LNEmp,LNOrcamento
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE LFbonus,LForcamento,LFclienc,LFempresa,LForcatmp
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFbonus 	= NetArq("bonus")
	LForcamento = NetArq("Orcament")
	LFclienc    = NetArq("clienc")
	LFempresa   = NetArq("empresa")
	LForcatmp   = NetArq("orcatmp")
	IF (LFbonus+LFempresa+LForcamento+LFclienc+LForcatmp) > 100000
		=UP_fecha("bonus"  		,LFbonus )
		=UP_fecha("orcamento" 	,LForcamento )
		=UP_fecha("clienc" 		,LFclienc )
		=UP_fecha("empresa" 	,LFempresa)
		=UP_fecha("orcatmp" 	,LForcatmp)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF

    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

	*------------------------------------------------------------*
	*   O bonus so e gerado para varejo , Pessoa Fisica e que
	* Tenha o CPF informado e seja faturado apos  {31.12.2000}
	*------------------------------------------------------------*
	IF clienc.natu_cli <> 0  ;
		OR clienc.tp_pessoa <> 1 ;
		OR clienc.cliente = 0 ;
		OR orcament.dt_fat < {01.10.2000}
		
		=UP_fecha("bonus"  		,LFbonus )
		=UP_fecha("orcamento" 	,LForcamento )
		=UP_fecha("clienc" 		,LFclienc )
		=UP_fecha("empresa" 	,LFempresa)
		=UP_fecha("orcatmp" 	,LForcatmp)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF
	*----------------------------------------------------------------*
	wp_msg = "Gerando Bonus OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*

	m.empresa 	=	LNemp
	m.osi_origem=	LNorcamento
	m.cliente	=	clienc.cliente
	m.nf_origem	=	orcament.nota
	m.dt_emissao=	orcament.dt_fat
	m.valor		=   orcament.valor * empresa.Tx_Bonus / 100
	m.osi_aplica= 	0
	m.vlr_sldbns=   0
	*---------------------------------------------------------------*
	*   Em caso de ser utilizado bonus no orcamento sera feito um
	* levantamento do valor nao utilizado e este saldo e acrecentado
	* ao valor do novo bonus uma vez que o bonus utilizado e baixado
	* pelo fato de ter sido vinculado ao orcamento e nao pelo uso ou
	* nao do seu valor integral. Este Procedimento evita a criacao de
	* controle de conta corrente para saldo de bonus
	*---------------------------------------------------------------*
	IF orcament.bonus_serv > 0
		LNvlrBonusConsumido = 0
		SELE orcatmp
		SET ORDER TO TAG orcamento
		SET NEAR ON
		SEEK STR(LNemp,3)+STR(LNorcamento,6)
		SET NEAR OFF
		DO WHILE !EOF() AND LNemp = orcatmp.empresa ;
						AND LNorcamento = orcatmp.orcamento
			IF orcatmp.tp_mercad = 7 AND LEFT(orcatmp.situacao,1) = "O"
				LNvlrBonusConsumido = ;
							LNvlrBonusConsumido + orcatmp.desc_adici
			ENDIF
			SKIP
		ENDDO
		LNsldBonus	= orcament.bonus_serv - LNvlrBonusConsumido
		m.valor		= m.valor + LNsldBonus
		m.vlr_sldbns= LNsldBonus
	ENDIF
	
	IF m.valor > 0
		SELE bonus
		SET ORDER TO TAG osi_origem
		SEEK STR(LNemp,3)+STR(LNorcamento,6)
		IF !FOUND()
			=edithand('SAVE')
		ELSE
			=edithand('REGRAVA')
		ENDIF
	ENDIF
	*----------------------------------------------------------*
	=UP_fecha("bonus"  		,LFbonus )
	=UP_fecha("orcamento" 	,LForcamento )
	=UP_fecha("clienc" 		,LFclienc )
	=UP_fecha("empresa" 	,LFempresa)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS28D           NFCancBonus VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   28    º
*       º Variable:            NFCancBonus                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      43                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls28d     &&  NFCancBonus VALID
#REGION 2
RETURN
*********************************************************************
*  NFCancBonus.....: Cancela Bonus
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Bonus
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

PROCEDURE NFCancBonus
	
	PARAMETERS LNEmp,LNOrcamento
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE LFbonus
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFbonus		= NetArq("bonus")
	IF (LFbonus) > 100000
		=UP_fecha("bonus"  ,LFbonus)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF

	*----------------------------------------------------------------*
	wp_msg = "Cancelando Bonus OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*
	SELE bonus
	SET ORDER TO TAG osi_origem
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	IF FOUND()
		=edithand('APAGA')
	ENDIF
	*----------------------------------------------------------*
	=UP_fecha("bonus"  ,LFbonus)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS28V           NFVldPortFatura VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   29    º
*       º Variable:            NFVldPortFatura                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      44                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls28v     &&  NFVldPortFatura VALID
#REGION 2
RETURN

*********************************************************************
*  NFVldPortFatura
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [****]
*---------------------------------------------------------------
*  OBJETIVO.......:  Validar o faturamento em uma determinada
*               forma de pagamento considerendo as combinacoes
*               entre Prmtp_parcela,PrmModo_pgto,PrmMoeda,PrmBanco
*---------------------------------------------------------------
*  COMENTARIO.....:  A empresa estabelece as regras para faturamento
*               atraves de combinacoes autorizadas entre :
*				Prmtp_parcela,PrmModo_pgto,PrmMoeda,PrmBanco
*
*---------------------------------------------------------------
*  PARAMETROS.....:
*             PrmTp_parcela:  01- A Vista
*                             02- Cheque Parcelado
*                             03- Duplicata Parcelada
*                             04- Cartao Parcelado
*                             05- Cartao a Vista
*                             06- Vendor Vista
*
*
*             PrmModo_Pgto    01- Entrada
*							  02- Restante
*
*		      PrmMoeda        00- Indiferente
*							  01- Dinheiro
*						      02- Cheque
*							  03- Duplicata
*                             04- Chq.Eletronico
*                             05- Cartao
*                             06- Vendor
*
*             PrmBanco     (Codigo do Portador)
*
*
*     Pela Combinacao dos parametros e possivel verificar se a
*   configuracao da fatura e aceita para determinado portador
*
*---------------------------------------------------------------
* RETORNO.........: .t.  ou .f.
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

FUNCTION NFVldPortFatura
PARAMETERS Prmtp_parcela,PrmModo_pgto,PrmMoeda,PrmBanco

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias, LFretorno
	LSalias = ALIAS()
	LFretorno  = .t.
	SELE pg_prmtd
	SET ORDER TO TAG pg_prmtd
	SEEK STR(PrmTP_PARCELA,1)+STR(PrmMODO_PGTO,1)+;
				STR(PrmMOEDA,2)+STR(PrmBANCO,3)
	IF !FOUND()
		LFretorno  = .f.
	ENDIF
	SELE &LSalias

RETURN(LFretorno)

********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS293           NFConjNfRef VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   30    º
*       º Variable:            NFConjNfRef                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      45                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls293     &&  NFConjNfRef VALID
#REGION 2
RETURN

FUNCTION NFConjNfRef
PARAMETERS PrmEmpresa,PrmReferencia


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PRIVATE LSAlias
	PRIVATE ARQ_Nota,ALS_Nota

	PRIVATE ARQ_Tmp1,ALS_Tmp1
	store "" to ARQ_tmp1,ALS_tmp1

	PRIVATE ARQ_Tmp2,ALS_Tmp2
	store "" to ARQ_tmp2,ALS_tmp2



	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*

	LSbase = wp_dirdat

	LSAlias = Alias()


    ARQ_Nota     = NetArqAgain(LSbase+"NOTA")
    ALS_Nota     = Alias()

	ARQ_tmp1=UPnometmp("EX1")
	ARQ_tmp2=UPnometmp("EX2")

	DO CASE
		CASE PrmReferencia < 1000000  && REFERENCIA  UMA OSI
			SELE &ALS_nota
			SET ORDER TO TAG REFERENCIA

			SET NEAR ON
			SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
			SET NEAR OFF

			IF PrmEmpresa <> empresa OR PrmReferencia <> referencia
				SKIP -1
			ENDIF

			WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

			COPY TO &ARQ_tmp1 WITH CDX ;
				WHILE EMPRESA = PrmEmpresa ;
				      AND REFERENCIA = PrmReferencia
			SELE 0
			USE &ARQ_tmp1
			ALS_tmp1 = ALIAS()
			SELECT  data, hora, status,nota,cupom,referencia,;
				tipo,total_nota,nome;
				FROM &ALS_tmp1 ;
				ORDER BY DATA,HORA ;
				INTO CURSOR EXTR_1

			*--------------------------------------------*
		    * Busca das copias de cupom
			*--------------------------------------------*
			SELE &als_tmp1

		    DO WHILE !EOF()
			  IF nota >= 1000000 AND nota <= 2000000
				PrmReferencia = nota
				SELE &ALS_nota
				SET ORDER TO TAG REFERENCIA

				SET NEAR ON
				SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
				SET NEAR OFF

				IF PrmEmpresa <> empresa OR PrmReferencia <> referencia
					SKIP -1
				ENDIF

				WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

			    =up_fecha("&ALS_Tmp2")
				COPY TO &ARQ_tmp2 WITH CDX ;
				WHILE EMPRESA = PrmEmpresa ;
				      AND REFERENCIA = PrmReferencia
				SELE 0
				USE &ARQ_tmp2
				ALS_tmp2 = ALIAS()
		
				SELECT * FROM EXTR_1;
					UNION;			
				SELECT  data, hora, status,nota,cupom,referencia,;
					tipo,total_nota,nome;
					FROM &ALS_tmp2 ;
					INTO CURSOR EXTR_1
		      ENDIF
			  SELE &ALS_TMP1
			  SKIP
		    ENDDO

		OTHERWISE
		*------------------------------------------------------------*	
		*CASE PrmReferencia >= 1000000 AND PrmReferencia <= 2000000
		*	                                && REFERENCIA  UM CUPOM
		*------------------------------------------------------------*	
			SELE &ALS_nota
			SET ORDER TO TAG REFERENCIA

			SET NEAR ON
			SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
			SET NEAR OFF

			IF PrmEmpresa <> empresa OR PrmReferencia <> referencia
				SKIP -1
			ENDIF

			WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

			COPY TO &ARQ_tmp1 WITH CDX ;
				WHILE EMPRESA = PrmEmpresa ;
				      AND REFERENCIA = PrmReferencia
			SELE 0
			USE &ARQ_tmp1
			ALS_tmp1 = ALIAS()
			SELECT  data, hora, status,nota,cupom,referencia,;
				tipo,total_nota,nome;
				FROM &ALS_tmp1 ;
				INTO CURSOR EXTR_1

			*--------------------------------------------*
		    * Busca das OUTRAS NOTAS
			*--------------------------------------------*
			SELE &als_tmp1

		    DO WHILE !EOF()
			  IF nota < 1000000 OR  nota > 2000000


				PrmReferencia = referencia
				SELE &ALS_nota
				SET ORDER TO TAG NOTA
				
				SET NEAR ON
				SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
				SET NEAR OFF

				IF PrmEmpresa <> empresa OR PrmReferencia <> nota
					SKIP -1
				ENDIF

				IF PrmEmpresa <> empresa OR PrmReferencia <> nota
					exit
				endif

				PrmReferencia = referencia
				SELE &ALS_nota
				SET ORDER TO TAG REFERENCIA

				SET NEAR ON
				SEEK STR(PrmEmpresa,3)+STR(PrmReferencia,7)
				SET NEAR OFF

				IF PrmEmpresa <> empresa OR PrmReferencia <> referencia
					SKIP -1
				ENDIF


				WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

			    =up_fecha("&ALS_Tmp2")
				COPY TO &ARQ_tmp2 WITH CDX ;
				WHILE EMPRESA = PrmEmpresa ;
				      AND REFERENCIA = PrmReferencia
				SELE 0
				USE &ARQ_tmp2
				ALS_tmp2 = ALIAS()
		
				SELECT * FROM EXTR_1;
					UNION;			
				SELECT  data, hora, status,nota,cupom,referencia,;
					tipo,total_nota,nome;
					FROM &ALS_tmp2 ;
					INTO CURSOR EXTR_1
		      ENDIF
			  SELE &ALS_TMP1
			  SKIP
		    ENDDO

	ENDCASE

	SELECT * FROM EXTR_1;
			ORDER BY DATA,HORA ;
			INTO CURSOR EXTR_1

    SELE EXTR_1

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ REFERENCIAS EQUIVALENTES PARA NF ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF

	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			STATUS,;
			NOTA		:H="DOC Fiscal" :R,;
			TIPO,;
			CUPOM,;
			REFERENCIA,;
			TOTAL_NOTA 	:H="VALOR"	:P="@r #######9.99" :R,;
			NOME  ;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_nota")
    =up_fecha("EXTR_1")
    =up_fecha("EXTR_2")
    =up_fecha("&ALS_Tmp1")
    =up_fecha("&ALS_Tmp2")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS29I           NFDMSVer20 VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   31    º
*       º Variable:            NFDMSVer20                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      46                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls29i     &&  NFDMSVer20 VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFDMSVer20
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")

    PRIVATE LSalias
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Nota,ALS_Nota

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_nota  = NetArqAgain("NOTA")
    ALS_nota  = Alias()


	SELE &ALS_Nota
	SET ORDER TO TAG DATA

	SELE &ALS_Empresa
	SET ORDER TO TAG EMPRESA

	SELE 0
   	USE Q:\SCGC\COMUM\DMS  EXCL

	SELE DMS
    ZAP
	PACK

	SELE &ALS_Empresa
	seek PrmEmpresa


	LNempresa   = PrmEmpresa
    LDataInicio = PrmDataInicio
   	LDataFinal  = PrmDataFinal
   	LSPeriodo   = STR(YEAR(LDataFinal),4)+Str(Month(LDataFinal),2)
	LSPeriodo   = STRTRAN(LSPeriodo," ", "0")
   	LSExtensao  = SUBS(LSPeriodo,3,2)+".D"+SUBS(LSPeriodo,5,2)


    LNinscr_Muni = STRTRAN( &ALS_Empresa .insc_munic,".","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni," ","0")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"-","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"/","")
    LNinscr_Muni = Left(LNinscr_Muni,7)
   	LNAIDF    = &ALS_Empresa .AIDF
	LNANOAIDF = &ALS_Empresa .ANOAIDF
    LNMODISS  = &ALS_Empresa .MODISS
    LScidade  = &ALS_Empresa .cidade
	LSarqDst  = "Q:\SCGC\DMS\"+;
	            LEFT(LNinscr_Muni,6)+LSExtensao  && INSC+AA+.D MM



    LsTipo       = "H"

	sele dms

    LsEmpresa    = LEFT( &ALS_Empresa .nome + SPACE(50),50)
   	LsCNPJ       = strtran(str( &ALS_Empresa .cgc,14)," ","0")
    LsDMSNegativa= "N"
	LsEspaco     = space(83)
	LsData       = DTOS(DATE())
	LsEmail      = LEFT("deptofiscal@pneulandia.com.br"+space(35),35)
   	LsVersao     = "V.2.0"
	LsEspaco2     = space(35)

   	LScabecalho =   LsTipo+LNinscr_Muni+LSPeriodo+LsEmpresa+;
    		 LsCNPJ+ LsDMSNegativa+LsEspaco+LsData+LsEmail+;
    		 LsVersao+LsEspaco2
	APPEND BLANK
	REPLACE dms with  LScabecalho

*-------------------------------------------------------------*


	SET TALK ON

	=W_DEFPROC("nota.spr")
	TmpCrs = NFSqlDMS(LNEmpresa, LDataInicio, LDataFinal)

    SELECT * FROM &TmpCrs ;
    INTO CURSOR TMPNOTA ;
	ORDER BY EMPRESA,DATA,NOTA




   	SELECT "D" AS identif,SPACE(4) AS espaco1,;
       strtran(str(nota,10)," ","0") AS NOTA,;
       strtran(str(LNAIDF,7)," ","0") AS AIDF,;
        strtran(str(LNANOAIDF,4)," ","0") AS ANOAIDF,;
        strtran(str(YEAR(data),4)," ","0")  AS ANONF,;
        strtran(str(MONTH(data),2)," ","0") AS MESNF,;
        strtran(str(DAY(data),2)," ","0") AS DIANF,;
       strtran(str(LNMODISS,1)," ","0") AS MODISS,;
		   IIF(status = 2  ,"1","0") AS sitnf,;
		   LEFT(nome+space(50),50) AS nome,;
		   IIF(tp_pessoa = 1,"F","J") AS tp_pess,;
		   strtran(str(Favorecido,14)," ","0") AS favo,;		   	
		   IIF(cidade = LScidade,"1","0") AS CIDADE,;
		   LEFT(cidade+space(25),25)	AS cidtomad,;
 	       strtran(str(INT(base_iss*100),13)," ","0") AS baseiss,;
 	       strtran(str(INT(totSERVICO*100),13)," ","0") AS vlrnf,;
 	       strtran(str(INT(aliq_iss*100),4)," ","0") AS aliqiss,;
 	       strtran(str(INT(vlr_iss*100),13)," ","0") AS vlriss,;
 	       SPACE(88)  AS espaco2;
	 	from &TmpCrs ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_B1


	SELECT * FROM DMS_B1 ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_D


	SET TALK OFF

 	SELE DMS_D
   	COPY TO  L:\TMP\DMS_D  TYPE SDF
 	
    SELECT DMS
	APPEND FROM L:\TMP\DMS_D.TXT TYPE SDF

	 *-----------------------------------------------------------*

	count to LsQtde
	LsQtde = LsQtde - 1
	GO TOP
	
    LsTipo  = "T"
   	LsQtde  =  strtran(str(LsQtde,4)," ","0")
   	LSEspaco= space(240)

    LStotal =   LsTipo+LsQtde+Lsespaco
	APPEND BLANK
	REPLACE dms with  LStotal
	
	GO TOP
	COPY TO &LSarqDst TYPE SDF
	USE
	
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	SET TALK OFF
RETURN(.T.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS29S           NFSqlDMS VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   32    º
*       º Variable:            NFSqlDMS                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      47                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls29s     &&  NFSqlDMS VALID
#REGION 2
return
*---------------------------------------------------------------*
*  Esta rotina gera um CURSOR com dados de prestacao de servico
* que sera utilizado na emissao do RELATORIO DE PRESTACAO DE SER-
* VICO  e NA GERACAO DO ARQUIVO DMS para municipio
*---------------------------------------------------------------*
FUNCTION NFSqlDMS
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")

    PRIVATE LSalias
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Nota,ALS_Nota

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_nota  = NetArqAgain("NOTA")
    ALS_nota  = Alias()


	SELE &ALS_Nota
	SET ORDER TO TAG DATA


    SELECT * FROM &ALS_Nota NOTA ;
   	WHERE (nota.empresa = PrmEmpresa ;
   		AND nota.data >= m.PrmDataInicio ;
   		AND nota.data <= m.PrmDataFinal) ;
   		AND nota.ch_produ $ "1/5" ;
 	 		AND ((nota.base_iss > 0 AND nota.aliq_iss > 0 );
                OR (nota.status <> 1 AND nota.empresa = 10)) ;
    INTO CURSOR TMPNOTA ;
	ORDER BY EMPRESA,DATA,NOTA




	SELE &ALS_Empresa
	SET ORDER TO TAG EMPRESA
	seek PrmEmpresa


	*---------------------------------------------------------*
	*    Copias de cupons com servio. Serao utilizadas para
	*  atribuir o numero da NF Copia (CPM) ao cupom emitido
	*  pois para o municipio o doc. fiscal e a nf e nao o
	*  cupom. Como os dados de ISS estao no cupom sera feito
	*  um select entre CUPONS e NF copia relacionada onde o
	* numero do documento sera o da NF.copia
	*---------------------------------------------------------*

	SET TALK ON

   	SELECT STR(EMPRESA,3)+STR(REFERENCIA,7) AS NRO_CUPOM,;
   		empresa,nota,referencia,status, ;
        base_iss,;
 	    total_nota,;
		totservico,;
		totproduto,;
 	    aliq_iss,;
 	    vlr_iss;
	 	from TMPNOTA where empresa = PrmEmpresa;
 	       and tipo = "CPM";
 	       and data <=  PrmDataFinal ;
 	       and data >= PrmDataInicio ;
 	       and vlr_iss > 0;
 	    order by empresa,nota,referencia into cursor DMS_CPMs


	*---------------------------------------------------------*
	*    Seleciona todas notas que nao estao vinculadas a cupons
	*  em que constem servio.
	*  DOCUMENTO FISCAL = NOTA
	*  ==> A) NF COM SERVICO NAO VINCULADAS A CUPONS
	*---------------------------------------------------------*

   	SELECT ;
	   empresa,;
	   operacao,;
   	   nota,;
	   cupom,;
       data,;
   	   status,;
	   nome,;
	   tp_pessoa,;
	   Favorecido,;		   	
	   cidade,;
	   NFmunidms(uf,cidade) AS MUNI_DMS,;
       base_iss,;
 	   total_nota,;
	   totservico,;
	   totproduto,;
 	   aliq_iss,;
 	   vlr_iss;
 	from TMPNOTA where empresa = PrmEmpresa;
       and tipo <> "CPM" ;
       and (nota < 1000000 or nota >= 2000000);
       and data <=  PrmDataFinal ;
       and data >= PrmDataInicio and vlr_iss > 0;
    into cursor DMS_A1

	*---------------------------------------------------------*
	*    Nos cupons para os quais foram emitidas copias
	*  o numero do documento assume o numero da NF copia
	*  DOCUMENTO FISCAL = COPIA
	*  ==> B) COPIAS DE CUPONS COM SERVICO
	*---------------------------------------------------------*
   	SELECT ;
		NF.empresa,;
	    NF.operacao,;
   		CPM.nota,;
		NF.cupom,;
   	    NF.data,;
   	    CPM.status,;
	    NF.nome,;
	    NF.tp_pessoa,;
	    NF.Favorecido,;		   	
	    NF.cidade,;
	    NFmunidms(NF.uf,NF.cidade) AS MUNI_DMS,;
        CPM.base_iss,;
 	    CPM.total_nota,;
		CPM.totservico,;
		CPM.totproduto,;
 	    CPM.aliq_iss,;
 	    CPM.vlr_iss;
 	from TMPNOTA NF, DMS_CPMs CPM ;
	 	where NF.empresa = PrmEmpresa;
 	       and NF.tipo <> "CPM" ;
 	       and NF.empresa= CPM.empresa ;
 	       and NF.nota   = CPM.referencia ;
 	       and NF.nota > 1000000 ;
		   and NF.nota < 2000000 ;
 	       and NF.data <=  PrmDataFinal ;
 	       and NF.data >= PrmDataInicio ;
 	       and NF.vlr_iss > 0;
    into cursor DMS_A2

	*---------------------------------------------------------*
	*---------------------------------------------------------*
	*    Seleciona todos cupons que nao estao vinculadas a
	*  copias em NF  e  que constem servio.
	*  DOCUMENTO FISCAL = CUPOM
	*  ==> C) CUPONS NAO VINCULADOS A COPIAS EM NF
	*---------------------------------------------------------*

   	SELECT ;
	   empresa,;
	   operacao,;
   	   nota,;
	   cupom,;
       data,;
   	   status,;
	   nome,;
	   tp_pessoa,;
	   Favorecido,;		   	
	   cidade,;
	   NFmunidms(uf,cidade) AS MUNI_DMS,;
       base_iss,;
 	   total_nota,;
	   totservico,;
	   totproduto,;
 	   aliq_iss,;
 	   vlr_iss;
 	from TMPNOTA where empresa = PrmEmpresa;
       and nota > 1000000 ;
	   and nota < 2000000 ;
       and data <=  PrmDataFinal ;
       and data >= PrmDataInicio and vlr_iss > 0;
       and STR(EMPRESA,3)+STR(NOTA,7) ;
           not in (SELECT NRO_CUPOM from DMS_CPMs);
    into cursor DMS_A3



    SELECT * FROM  DMS_A1 ;
    UNION ;
    SELECT * FROM  DMS_A2 ;
    into cursor DMS_A4


    SELECT * FROM  DMS_A3 ;
    UNION ;
    SELECT * FROM  DMS_A4 ;
    into cursor DMS_A5


    SELECT * FROM  DMS_A5 ;
 	    order by NOTA into cursor DMS_A1

	SET TALK OFF
    *-----------------------------------------------------------*
	
	sele TMPNOTA
	USE

	sele DMS_A2
	USE

	sele DMS_A3
	USE

	sele DMS_A4
	USE

	sele DMS_A5
	USE

	
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	SET TALK OFF
RETURN("DMS_A1")
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS29T           NFView VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   33    º
*       º Variable:            NFView                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      48                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _43a0ls29t     &&  NFView VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFView
PARAMETER PrmFiltro

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	0
	*------------------------------------------------------------*
	PRIVATE VLleitura,VLlerfim,VLcompara,VLchvlimi, LNregvolta
	PRIVATE LStipo,LNnf, LNnroNF
	******>>>> INICIO CONTROLE ARQUIVOS
	*>> parametros repassados a btn_val
	VLleitura = "STR(wp_empresa,3)"
                         * repassa chave de leitura p/ btn_val
	VLlerfim  = "STR(wp_empresa+1,3)"
           * repassa chave de leitura p/ btn_val (POSICAO FINAL + 1 REG)

	IF TYPE("PrmFiltro") <> "C"
		PrmFiltro = ""
	ENDIF

	VLcompara = ;
	  "nota.empresa = wp_empresa "+PrmFiltro
                         * repassa chave de comparacao p/ btn_val
	VLchvlimi = "STR(wp_empresa,3)"
	*-----------------------------------------------------------------*
	SELE nota
	SET ORDER TO TAG ORDEM_EMI
	SET NEAR ON
	SEEK VLlerfim
	ON KEY LABEL ESCAPE
	DO loc_dlog WITH .T.,Vlcompara, VLchvlimi,.F.,.F., .F.
	LFretorno = 0
	IF lastkey() = 23
		LFretorno = RECNO()
	ENDIF
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	SET NEAR OFF
	

	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2AD           NF_aviso VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   34    º
*       º Variable:            NF_aviso                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      49                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2ad     &&  NF_aviso VALID
#REGION 2
return
*---------------------------------------------------------------*
FUNCTION NF_aviso
PARAMETERS PrmEmp,PrmNfinicio,PrmCtrlCpmIni,PrmSolicitante,PrmTp_Process

	private lndoc	
	LNDOC = 0

	IF PrmSolicitante <> "IMPORTACAO"
		DO CASE
    		CASE "CUPOM" $ PrmTp_Process
				LNDOC = PRMCtrlCpmIni
	    	CASE "NOTA" $ PrmTp_Process
				LNDOC = PRMnfinicio
		ENDCASE
	ENDIF

	*-------------------------------------------------*
	*  DEFINIR MENSAGEM AO OPERADOR
	*-------------------------------------------------*
	SELE nota
	SET ORDER TO TAG NOTA
	SEEK STR(PrmEmp,3)+STR(LNDoc,7)
    LSdef_msg  = ""
	do case
		case PrmSolicitante = "IMPORTACAO"
		   LSdef_msg  = ""
		case  nota.ch_opera $ "12" AND ;
			nota.ch_desti = "2"  AND ;
				EMPTY(ALLTRIM(nota.inscsubst)) AND ;
				nota.icms_subs > 0
			   LSdef_msg  = ;
				   	"Recolher Imposto N.F. "+STR(LNDOC,7)
		case  nota.ch_opera $ "2" AND ;
			  nota.ch_desti = "2"  AND ;
			  nota.uf = "TO" AND ;
			  nota.cfo = "6.152 "
			   LSdef_msg = "Recolher Imposto N.F. "+STR(LNDOC,7)
	ENDCASE
	IF LSdef_msg <> ""
	   wp_msg  = LSdef_msg
	   DO OBJ_ALER.SPR WITH  wp_msg
	ENDIF
	*----------------------------------------------------------------*
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2AK           NFDMSVer30 VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   35    º
*       º Variable:            NFDMSVer30                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      50                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2ak     &&  NFDMSVer30 VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFDMSVer30
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")

    PRIVATE LSalias
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Nota,ALS_Nota

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_nota  = NetArqAgain("NOTA")
    ALS_nota  = Alias()


	SELE &ALS_Nota
	SET ORDER TO TAG DATA

	SELE &ALS_Empresa
	SET ORDER TO TAG EMPRESA

	SELE 0
   	USE Q:\SCGC\COMUM\DMS  EXCL

	SELE DMS
    ZAP
	PACK

	SELE &ALS_Empresa
	seek PrmEmpresa


	LNempresa   = PrmEmpresa
    LDataInicio = PrmDataInicio
   	LDataFinal  = PrmDataFinal
   	LSPeriodo   = STR(YEAR(LDataFinal),4)+Str(Month(LDataFinal),2)
	LSPeriodo   = STRTRAN(LSPeriodo," ", "0")
   	LSExtensao  = SUBS(LSPeriodo,3,2)+".D"+SUBS(LSPeriodo,5,2)


    LNinscr_Muni = STRTRAN( &ALS_Empresa .insc_munic,".","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni," ","0")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"-","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"/","")
    LNinscr_Muni = Left(LNinscr_Muni,7)

   	LNAIDF    = &ALS_Empresa .AIDF
	LNANOAIDF = &ALS_Empresa .ANOAIDF
    LNMODISS  = &ALS_Empresa .MODISS
    LScidade  = &ALS_Empresa .cidade
	LSarqDst  = "Q:\SCGC\DMS\"+;
	            LEFT(LNinscr_Muni,6)+LSExtensao  && INSC+AA+.D MM



    LsTipo       = "H"

	sele dms

    LsEmpresa    = LEFT( &ALS_Empresa .nome + SPACE(50),50)

   	LsCNPJ       = strtran(str( &ALS_Empresa .cgc,14)," ","0")
    LsDMSNegativa= "N"
	LsEspaco     = space(83)
	LsData       = DTOS(DATE())
	LsEmail      = LEFT("deptofiscal@pneulandia.com.br"+space(35),35)
   	LsVersao     = "V.3.0"
   	LsTpDoc      = "NF   "
   	LsUltForm    = space(7)
	LsEspaco2    = space(23)

   	LScabecalho =   LsTipo+LNinscr_Muni+LSPeriodo+LsEmpresa+;
    		 LsCNPJ+ LsDMSNegativa+LsEspaco+LsData+LsEmail+;
    		 LsVersao+;
    		 LsTpDoc+;
    		 LsUltForm+;		
    		 LsEspaco2
	APPEND BLANK
	REPLACE dms with  LScabecalho

*-------------------------------------------------------------*


	SET TALK ON

	=W_DEFPROC("nota.spr")
	TmpCrs = NFSqlDMS(LNEmpresa, LDataInicio, LDataFinal)

    SELECT * FROM &TmpCrs ;
    INTO CURSOR TMPNOTA ;
	ORDER BY EMPRESA,DATA,NOTA




   	SELECT     "D" AS identif,;
        SPACE(4) AS espaco1,;
        strtran(str(nota,10)," ","0") AS NOTA,;
        strtran(str(LNAIDF,7)," ","0") AS AIDF,;
        strtran(str(LNANOAIDF,4)," ","0") AS ANOAIDF,;
        strtran(str(YEAR(data),4)," ","0")  AS ANONF,;
        strtran(str(MONTH(data),2)," ","0") AS MESNF,;
        strtran(str(DAY(data),2)," ","0") AS DIANF,;
        strtran(str(LNMODISS,1)," ","0") AS MODISS,;
	    IIF(status = 2  ,"1","0") AS sitnf,;
		LEFT(nome+space(50),50) AS nome,;
		IIF(tp_pessoa = 1,"F","J") AS tp_pess,;
		strtran(str(Favorecido,14)," ","0") AS favo,;		   	
		IIF(cidade = LScidade,"1","0") AS CIDADE,;
		LEFT(cidade+space(25),25)	AS cidtomad,;
 	    strtran(str(INT(base_iss*100),13)," ","0") AS baseiss,;
 	    strtran(str(INT(totSERVICO*100),13)," ","0") AS vlrnf,;
 	    strtran(str(INT(aliq_iss*100),4)," ","0") AS aliqiss,;
 	    "00"     AS atvddiss,;
 	    SPACE(86)  AS espaco2;
	 	from &TmpCrs ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_B1


	SELECT * FROM DMS_B1 ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_D


	SET TALK OFF

 	SELE DMS_D
   	COPY TO  L:\TMP\DMS_D  TYPE SDF
 	
    SELECT DMS
	APPEND FROM L:\TMP\DMS_D.TXT TYPE SDF

	 *-----------------------------------------------------------*

	count to LsQtde
	LsQtde = LsQtde - 1
	GO TOP
	
    LsTipo  = "T"
   	LsQtde  =  strtran(str(LsQtde,4)," ","0")
   	LSEspaco= space(240)

    LStotal =   LsTipo+LsQtde+Lsespaco
	APPEND BLANK
	REPLACE dms with  LStotal
	
	GO TOP
	COPY TO &LSarqDst TYPE SDF
	USE
	
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	SET TALK OFF
RETURN(.T.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2AV           NFDMS VALID                        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   36    º
*       º Variable:            NFDMS                              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      51                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2av     &&  NFDMS VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFDMS
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")



	DO CASE
		CASE PrmDataInicio < {01.08.2009}
			=NFDMSVer30(PrmEmpresa, PrmDataInicio, PrmDataFinal)
		OTHERWISE
			=NFDMSVer40(PrmEmpresa, PrmDataInicio, PrmDataFinal)
	ENDCASE

RETURN(.T.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2B1           NFDMSVer40 VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   37    º
*       º Variable:            NFDMSVer40                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      52                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2b1     &&  NFDMSVer40 VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NFDMSVer40
PARAMETERS PrmEmpresa, PrmDataInicio, PrmDataFinal

	=W_DEFPROC("rotinas.spr")

    PRIVATE LSalias
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Nota,ALS_Nota

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_nota  = NetArqAgain("NOTA")
    ALS_nota  = Alias()


	SELE &ALS_Nota
	SET ORDER TO TAG DATA

	SELE &ALS_Empresa
	SET ORDER TO TAG EMPRESA

	SELE 0
   	USE Q:\SCGC\COMUM\DMS  EXCL

	SELE DMS
    ZAP
	PACK

	SELE &ALS_Empresa
	seek PrmEmpresa


	LNempresa   = PrmEmpresa
    LDataInicio = PrmDataInicio
   	LDataFinal  = PrmDataFinal
   	LSPeriodo   = STR(YEAR(LDataFinal),4)+Str(Month(LDataFinal),2)
	LSPeriodo   = STRTRAN(LSPeriodo," ", "0")
   	LSExtensao  = SUBS(LSPeriodo,3,2)+".D"+SUBS(LSPeriodo,5,2)


    LNinscr_Muni = STRTRAN( &ALS_Empresa .insc_munic,".","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni," ","0")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"-","")
    LNinscr_Muni = STRTRAN(LNinscr_Muni,"/","")
    LNinscr_Muni = Left(LNinscr_Muni,7)

   	LNAIDF    = &ALS_Empresa .AIDF
	LNANOAIDF = &ALS_Empresa .ANOAIDF
    LNMODISS  = &ALS_Empresa .MODISS
    LScidade  = &ALS_Empresa .cidade
	LSarqDst  = "Q:\SCGC\DMS\"+;
	            LEFT(LNinscr_Muni,6)+LSExtensao  && INSC+AA+.D MM



    LsTipo       = "H"

	sele dms

    LsEmpresa    = LEFT( &ALS_Empresa .nome + SPACE(50),50)

   	LsCNPJ       = strtran(str( &ALS_Empresa .cgc,14)," ","0")
    LsDMSNegativa= "N"
	LsEspaco     = space(83)
	LsData       = DTOS(DATE())
	LsEmail      = LEFT("deptofiscal@pneulandia.com.br"+space(35),35)
   	LsVersao     = "V.4.0"
   	LsTpDoc      = "NF   "
   	LsUltForm    = space(7)
	LsEspaco2    = space(23)

   	LScabecalho =   LsTipo+LNinscr_Muni+LSPeriodo+LsEmpresa+;
    		 LsCNPJ+ LsDMSNegativa+LsEspaco+LsData+LsEmail+;
    		 LsVersao+;
    		 LsTpDoc+;
    		 LsUltForm+;		
    		 LsEspaco2
	APPEND BLANK
	REPLACE dms with  LScabecalho

*-------------------------------------------------------------*


	SET TALK ON

	=W_DEFPROC("nota.spr")
	TmpCrs = NFSqlDMS(LNEmpresa, LDataInicio, LDataFinal)

    SELECT * FROM &TmpCrs ;
    INTO CURSOR TMPNOTA ;
	ORDER BY EMPRESA,DATA,NOTA




   	SELECT     "D" AS identif,;
        SPACE(4) AS espaco1,;
        strtran(str(nota,10)," ","0") AS NOTA,;
        strtran(str(LNAIDF,7)," ","0") AS AIDF,;
        strtran(str(LNANOAIDF,4)," ","0") AS ANOAIDF,;
        strtran(str(YEAR(data),4)," ","0")  AS ANONF,;
        strtran(str(MONTH(data),2)," ","0") AS MESNF,;
        strtran(str(DAY(data),2)," ","0") AS DIANF,;
        strtran(str(LNMODISS,1)," ","0") AS MODISS,;
	    IIF(status = 2  ,"1","0") AS sitnf,;
		LEFT(nome+space(50),50) AS nome,;
		IIF(tp_pessoa = 1,"F","J") AS tp_pess,;
		strtran(str(Favorecido,14)," ","0") AS favo,;		   	
        SPACE(26) AS espaco2,;
 	    strtran(str(INT(base_iss*100),13)," ","0") AS baseiss,;
 	    strtran(str(INT(totSERVICO*100),13)," ","0") AS vlrnf,;
 	    strtran(str(INT(aliq_iss*100),4)," ","0") AS aliqiss,;
 	    "00"     AS atvddiss,;
	    strtran(str(MUNI_DMS,6)," ","0") AS MUNI_DMS,;
 	    SPACE(80)  AS espaco3;
	 	from &TmpCrs ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_B1



	SELECT * FROM DMS_B1 ;
 	    order by NOTA,ANONF,MESNF,DIANF into cursor DMS_D


	SET TALK OFF

 	SELE DMS_D
   	COPY TO  L:\TMP\DMS_D  TYPE SDF
 	
    SELECT DMS
	APPEND FROM L:\TMP\DMS_D.TXT TYPE SDF

	 *-----------------------------------------------------------*

	count to LsQtde
	LsQtde = LsQtde - 1
	GO TOP
	
    LsTipo  = "T"
   	LsQtde  =  strtran(str(LsQtde,4)," ","0")
   	LSEspaco= space(240)

    LStotal =   LsTipo+LsQtde+Lsespaco
	APPEND BLANK
	REPLACE dms with  LStotal
	
	GO TOP
	COPY TO &LSarqDst TYPE SDF
	USE
	
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Nota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	SET TALK OFF
RETURN(.T.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2BC           NFmunidms VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   38    º
*       º Variable:            NFmunidms                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      53                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2bc     &&  NFmunidms VALID
#REGION 2
return
*---------------------------------------------------------------*
FUNCTION NFmunidms
PARAMETERS PrmUf, PrmCidade
PRIVATE LNretorno

    WAIT WINDOW PrmUf + "-" +PrmCidade NOWAIT

	=W_DEFPROC("DMSMUNI.spr")
    LNretorno=DMNGet_MUNIDMS(PrmUf, PrmCidade)



RETURN(LNretorno)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2BI           NFCanNFCopia VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   39    º
*       º Variable:            NFCanNFCopia                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      54                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2bi     &&  NFCanNFCopia VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION NFCanNFCopia
PARAMETER PrmEmpresa, PrmNota

	PRIVATE LNnroReferencia

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND() or nota.tipo <> "CPM"
		RETURN(.F.)
	ENDIF

	LFretorno = .T.
	DO WHILE !EOF() AND PrmEmpresa   = nota.empresa ;
	                AND PrmNota      = nota.nota
			IF nota.tipo <> "CPM"
				SKIP
				LOOP
			ENDIF
			*-------------------------------------------------------*
			PRIVATE LSobjetivo
			LSobjetivo = NFDefCancDFis(PrmEmpresa, PrmNota)
			IF LSobjetivo = "CANCELAMENTO"
				IF !(NF_CancDFis(PrmEmpresa, PrmNota, LSobjetivo ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!";
				    +CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao "+;
					"acatou o cancelamento."+;
				     " Repita o processo e se persistir a negacao entre "+;
				     " em contato com suporte"
						SELE NOTA
					
					LFretorno = .F.
					EXIT


					*SKIP
					*LOOP

				ENDIF
			ENDIF
			*-------------------------------------------------------*

		    m.status = 2
			=RLOCK()
			***************************
			SET FIELDS TO dtregis, hregis, usrregis,deletado
		    SET FIELDS TO status
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
			***************************


			*-------------------------------------------------------*
			IF LSobjetivo = "ESCRITURACAO"
				IF !(NF_CancDFis(PrmEmpresa, PrmNota, LSobjetivo ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!";
				    +CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao "+;
					"acatou o cancelamento."+;
				     " Repita o processo e se persistir a negacao entre "+;
				     " em contato com suporte"
						SELE NOTA

					LFretorno = .F.
					EXIT


					*SKIP
					*LOOP
				ENDIF
			ENDIF
			*-------------------------------------------------------*

			SELE NOTA
			SKIP
	ENDDO
	***************************
	UNLOCK ALL
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2BR           NFDefCancDFis VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   40    º
*       º Variable:            NFDefCancDFis                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      55                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2br     &&  NFDefCancDFis VALID
#REGION 2
return
*---------------------------------------------------------------*

********************
FUNCTION NFDefCancDFis
PARAMETERS PrmEmpresa,PrmNota


	*-->>>>>>>>>>>>>     PARA ENVIO NFE
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= ""
	PrmTipo    		= ""
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*



	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	*----------------------------------------------------*


**	RETURN("NAO INTEGRAR")
	


	*-----------------------------------------------------------*
	PRIVATE LSemi_NF,LSemi_NFe,LSemi_NFS,LSemi_NFSe,LSemi_ECF,LSemi_CFE
	PRIVATE LSscr_NF,LSscr_NFe,LSscr_NFS,LSscr_NFSe,LSscr_ECF,LSscr_CFE

	*------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NF = EMGetFieldValue(PrmEmpresa,"EMITE_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFe = EMGetFieldValue(PrmEmpresa,"EMITE_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFS = EMGetFieldValue(PrmEmpresa,"EMITE_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFSe = EMGetFieldValue(PrmEmpresa,"EMITE_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_ecf = EMGetFieldValue(PrmEmpresa,"EMITE_ECF")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_CFE = EMGetFieldValue(PrmEmpresa,"EMITE_CFE")


	*------------------------------------------------------------*

	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NF = EMGetFieldValue(PrmEmpresa,"ESCRT_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFS = EMGetFieldValue(PrmEmpresa,"ESCRT_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFSe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ecf = EMGetFieldValue(PrmEmpresa,"ESCRT_ECF")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_cfe = EMGetFieldValue(PrmEmpresa,"ESCRT_CFE")

	*------------------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "NAO INTEGRAR"



	DO CASE

		CASE  RtnMOD_DOC    =   "2D"  && CUPOM

			DO CASE
				CASE LSemi_CFE = "S"
	 				PrmObjetivo = "CANCELAMENTO"

				CASE LSscr_CFE = "S"
	 				PrmObjetivo = "ESCRITURACAO"

				OTHERWISE
					PrmObjetivo = "NAO INTEGRAR"
			ENDCASE
	
*		CASE  RtnMOD_DOC    =   "2D"  && CUPOM
*
*			DO CASE
*				CASE LSemi_ECF = "S"
*	 				PrmObjetivo = "CANCELAMENTO"
*
*				CASE LSscr_ECF = "S"
*	 				PrmObjetivo = "ESCRITURACAO"
*
*				OTHERWISE
*					PrmObjetivo = "NAO INTEGRAR"
*			ENDCASE
*
		CASE  RtnMOD_DOC    $   "03/77"  && NF SERVICO
				DO CASE
					CASE LSemi_NFS = "S" OR LSemi_NFSe = "S" 				
		 				PrmObjetivo = "CANCELAMENTO"

					CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE

		CASE  RtnMOD_DOC    $   "01/55"  && NF/NFe
				DO CASE
					CASE LSemi_NF = "S" OR LSemi_NFe = "S" 				
		 				PrmObjetivo = "CANCELAMENTO"

					CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE

		OTHERWISE			
				PrmObjetivo = "NAO INTEGRAR"

		ENDCASE
RETURN(PrmObjetivo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2C3           NF_CancDFis VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_A,     Record Number:   41    º
*       º Variable:            NF_CancDFis                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      56                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2c3     &&  NF_CancDFis VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NF_CancDFis
PARAMETERS PrmEmpresa, PrmNota, PrmObjetivo




	PRIVATE NFAlias


	PRIVATE LSAlias
	LSalias		= 	ALIAS()


	=W_DEFPROC("NOTA.SPR")
	NFAlias = NFGetAlias()



	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NF nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF





	*-->>>>>>>>>>>>>     PARA ENVIO NFE
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= &NFAlias .Serie
	PrmTipo    		= &NFAlias .Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*

	*-->>>>>>>>>>>       PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc
	*----------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)



*----------------------------------------------------------------*
*---------------- B1 - Bloco evita o envio de XML de cancelamento
*----------------------------------------------------------------*
*
*	IF  RtnMOD_DOC    <>   "55"
*		RETURN(.T.)
*	ENDIF
*
*	RETURN(.T.)
*
*----------------------------------------------------------------
    PRIVATE LFOk_NFe

	LFOk_NFe = .T.


*-----------------
	=W_DEFPROC("NOTA.SPR")
	M.NFEJSTFCAN  =   NFGetFieldValue(PrmEmpresa,PrmNota,"NFEJSTFCAN")

	=W_DEFPROC("DOCFISCA.SPR")
	IF (DFLerRegistro(PrmEmpresa,RtnMod_Doc,;
	      RtnCOD_IDFORN,;
		  RtnNro_Doc,RtnSerie_Doc ))
		=DFSetPropVT("NFEJSTFCAN", M.NFEJSTFCAN)
		=DFSalvarRegistro()
	ENDIF

*----------------

	PRIVATE LSXMLObjetivo

	LSXMLObjetivo = "CANCELAMENTO"

	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		LFOk_NFe =(DFGerXMLDocFiscal(PrmEmpresa,;
									RtnMod_Doc,;
 						            RtnCOD_IDFORN,;
		 							RtnNro_Doc,;
		 							RtnSerie_Doc,;
		 							LSXMLObjetivo ))


	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe

*--------------------------------------------------------
*   altarada para permitir a subrotina verifica se existe duplicata para o
*    doc fiscal informado
*---------------------------------------------------------
*	   LFOk_NFe = (DFEnviaNFeXML(;
*	   					PrmEmpresa,;
*	   					RtnMod_Doc,;
*	   					RtnNro_Doc))
*---------------------------------------------------------
		LFOk_NFe =(DFEnviaNFeXML(PrmEmpresa,;
									RtnMod_Doc,;
 						            RtnCOD_IDFORN,;
		 							RtnNro_Doc,;
		 							RtnSerie_Doc,;
		 							LSXMLObjetivo ))



	ENDIF

	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe

*--------------------------------------------------------
*   altarada para permitir a subrotina verifica se existe duplicata para o
*    doc fiscal informado
*---------------------------------------------------------
*		LSstatus = (DFRespostaNFe;
*		      (;
*				PrmEmpresa,;
*				RtnMod_Doc,;
*	   			RtnNro_Doc,;
*			     "ESPERA",;
*				  RtnStatus,;
*				  RtnRecibo,;
*			      RtnProtocolo,;
*		          RtnChvNFe,;
*		          RtnJstfCanc,;
*		          RtnPrtcCanc;
*			  );
*			)
*
		LSstatus = (DFRespostaNFe;
		      (;
				PrmEmpresa,;
				RtnMod_Doc,;
                RtnCOD_IDFORN,;
	   			RtnNro_Doc,;
	   			RtnSerie_Doc,;
			     "ESPERA",;
				  RtnStatus,;
				  RtnRecibo,;
			      RtnProtocolo,;
		          RtnChvNFe,;
		          RtnJstfCanc,;
		          RtnPrtcCanc;
			  );
			)







		IF !("CANCELADA" $ LSstatus)
			 LFOk_NFe = .F.
		ENDIF
*		IF "ERRO" $ LSstatus
*			 LFOk_NFe = .F.
*		ENDIF

	ENDIF


	IF LFOk_NFe
		=W_DEFPROC("NOTA.SPR")
		IF NFLerRegistro(PrmEmpresa, PrmNota)
  	    	=NFSetPropVT("NFE_STATUS",RtnStatus)
			=NFSetPropVT("NFE_RECIBO",RtnRecibo)
			=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
			=NFSetPropVT("NFE_CHV",RtnChvNFe)
			=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
			=NFSalvarRegistro()
		ENDIF
	ENDIF

	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		IF (DFLerRegistro(PrmEmpresa,RtnMod_Doc,;
		      RtnCOD_IDFORN,;
			  RtnNro_Doc,RtnSerie_Doc ))
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
		ENDIF
	ENDIF


	=W_DEFPROC("rotinas.spr")


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	*--------------------------------------------------------------*
RETURN(LFOk_NFe)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2CH           NFRot_Fat VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    2    º
*       º Variable:            NFRot_Fat                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      57                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2ch     &&  NFRot_Fat VALID
#REGION 3
return

*---------------------------------------------------------------*

FUNCTION  NFrot_fat
	PARAMETERS  LSsolicitante,LSemcaminhar,LSTrataBoleto
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Controla o processo de Faturamento
	*				Esta e a primeira instancia de rotinas para
	*				FATURAMENTO/PREPARACAO
	*------------------------------------------------------------*
	* COMENTARIO..: A rotina serve a dois objetivos
	*				1- Preparacao para  Faturamento
	*				2- Preparacao e  Faturamento
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS AMBIENTAIS..:
	*					LNecf.......: Nro da Conexao aberta com
	*							ECF no programa OBJ_ECF.SPR
	*						OBS: Quando o Sistema nao esta usando
	*							ECF esta variavel nao e inicializada
	*							portanto ela e inicializada com
	*							valor = 0 nesta rotina
	*  PARAMETROS..:
	*		LSsolicitante..: Identifica os Pontos em que esta
	*				 rotina pode ser chamada
	*			   		LSsolicitante = "VENDEDOR"
	*					LSsolicitante = "CAIXA"
	*					LSsolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					LSsolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					LSsolicitante = "IMPORTACAO"		&& SCGC008
	*                   LSsolicitante = "RECUPERACAO"
	*
	*		LSemcaminhar....: Orienta o processo para :
	*					LSemcaminhar	  = "PREPARAR FATURAMENTO"
	*					LSemcaminhar	  = "EFETIVAR FATURAMENTO"
	*       LSTrataBoleto...:
	*                         = "EMITIR BOLETO"
	*                         = "SEM BOLETO" OU .F.
	*			
	*		LFretorno.......:
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()

	PRIVATE LStp_proces		&& = "CUPOM", "NOTA", "NOTA/CUPOM",
							&&   "RECUP.CUPOM", "RECUP.NOTA",
							&&			 "RECUP.NOTA/CUPOM"
	PRIVATE LFservico		&&   INDICA SE EXISTE SERVICO P/ FATURAR
	PRIVATE LFflagtrans		&&   INDICA SITUACAO DE CONCLUSAO DO PROCESSO
	PRIVATE LSsitRequerida  &&   Armazena a SITUACAO requrida para
							&& a operacao e repassa a ORloc_orc

	PRIVATE LForcament,LFclienc,LFclientes,LFliberacao
	PRIVATE LSalias

	*------------------------------------------------------------*
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFclientes		= NetArq("clientes")
	LFliberacao		= NetArq("liberaco")
	*--------------------------------------------------------

    IF (LForcament+LFclienc+LFclientes) > 100000  && HOUVE FALHA ABERT
		DO FCHrot_fat
		RETURN(.f.)
	ENDIF



	*****************************************************************
	* 				Inicio Verificacao de Requisitos				*
	*****************************************************************
	IF TYPE("LNecf") = "U"
		LNecf	=	0
	ENDIF
	LSsitRequerida = ""
	DO CASE
		CASE LSsolicitante = "CAIXA"				&& OBJ_ECF
			LSsitRequerida =  "o"
		CASE LSsolicitante = "FATURISTA SIMPLES"    && OBJ_ECF
			LSsitRequerida =  "AIMo"
		CASE LSsolicitante = "RECUPERACAO"			&& OBJ_ECF
			LSsitRequerida =  "AIMo"
		CASE LSsolicitante = "IMPORTACAO"			&& SCGC008
								&& REGISTRO JA E PASSADO PASICIONADO
	ENDCASE
	CLEAR TYPEAHEAD

	SELE orcament
	
	CLEAR TYPEAHEAD

	LNregvolta = RECNO()



	IF orcament.valor = 0
		IF !fox_alert("Orcamento com VALOR = 0. [ Continua ? ]")
			DO FCHrot_fat
			RETURN(.f.)
		ENDIF
	ENDIF




	*----------------------------------------------------------------*
	IF LSsolicitante <> "IMPORTACAO"
		IF !NFverClasOSI(orcament.empresa,orcament.orcamento)
			DO FCHrot_fat
			RETURN(.F.)
		ENDIF
	ENDIF

	*----------------------------------------------------------------*

	IF LSsolicitante <> "IMPORTACAO"
		IF !NFchqLiberCred(orcament.empresa,orcament.orcamento)
			DO FCHrot_fat
			RETURN(.F.)
		ENDIF
	ENDIF

	*----------------------------------------------------------------*


	SELE orcament

	*****************************************************************
	* 				Fim Informacoes Complementares
	*****************************************************************
	LFretorno = .t.




	IF LSsolicitante <> "IMPORTACAO"
		DO SVD0205.spr with;
			 orcament.empresa,orcament.orcamento,LFretorno

	ENDIF

	IF LFretorno
		LFretorno = NFProcessFat(orcament.empresa,;
					 orcament.orcamento,LSsolicitante,;
					 LSTrataBoleto)
	ENDIF


	DO FCHrot_fat
	UNLOCK ALL
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2CS           NFregEnvioFat VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    3    º
*       º Variable:            NFregEnvioFat                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      58                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2cs     &&  NFregEnvioFat VALID
#REGION 3
return
*---------------------------------------------------------------*
FUNCTION  NFregEnvioFat
PARAMETERS LNemp,LNorcamento
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Alterar o STATUS do orcamento e dos itens
	*			para "o" que equivale a enviado para faturamento
	*
	*------------------------------------------------------------*
	* COMENTARIO..: O status "o" ‚ verificado com requisito no
	*    processo que efetiva o faturamento				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LNorcamento:
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	************************************
	=UPtransacao("INICIAR")
	************************************
	LFflgtrans = .t.

	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcamento,6)

	IF orcament.flgtransac = .f.
		DO OBJ_MENS.SPR WITH " O orcamento Selecionado Sofreu" +;
		" Alteracoes que Afetam Valores e Nao Foi Recalculado." +;
		CHR(13)+;
		" Reedite os Itens e Grave para Forcar o Calculo."
		RETURN(.f.)
	ENDIF

	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+orcament.tipo
	IF !FOUND()
		SEEK 's'+orcament.tipo
	ENDIF
	IF !found()
		SELECT orcament
		RETURN(.f.)
	ENDIF
	
	SELECT  orcatmp
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	SET NEAR OFF

	LFflgtrans = .F.  && Se nenhum item for processado no laco
					  && o processo deve ser rejeitado

	DO WHILE !EOF() AND LNemp 		= orcatmp.empresa ;
					AND LNorcamento = orcatmp.orcamento
		***  NAO PROCESSAR ITENS CANCELADOS
		IF LEFT(orcatmp.situacao,1) $ "YykeZ"
			SKIP
			LOOP
		ENDIF
		LFflgtrans = .T.

		***** SO SERA PROCESSADO QDO TODOS OS ITENS SE ENCONTRAREM EM
		***** SITUACAO DE CANCELAMENTO OU PRONTOS P/ FATURAR
		IF !(LEFT(orcatmp.situacao,1) $ "Mo") && OSI e FECHADO
			LFflgtrans = .F.
			EXIT
		ENDIF
		*----------------------------------------------------------*
		IF tipooper.movestq = "S"
	    	SELECT orcatmp
			IF REGLOCK()
			   REPLACE situacao WITH "o"+RIGHT(orcatmp.situacao,1)
			ELSE
				LFflgtrans = .F.
				EXIT
			ENDIF
			SELECT  orcatmp
		ELSE
	    	SELECT orcatmp
			IF REGLOCK()
			   REPLACE situacao WITH "o"+RIGHT(orcatmp.situacao,1)
			ELSE
				LFflgtrans = .F.
				EXIT
			ENDIF
		ENDIF
		SELE orcatmp
		SKIP
	ENDDO
	IF !LFflgtrans
		SELECT orcament
		RETURN(.f.)
	ENDIF			
	SELECT orcament
	REPLACE situacao WITH "o"+RIGHT(situacao,1)
	************************************
	=UPtransacao("TERMINAR")
	************************************
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2D1           NF_DefFat VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    4    º
*       º Variable:            NF_DefFat                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      59                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2d1     &&  NF_DefFat VALID
#REGION 3
return
*---------------------------------------------------------------*
*  Define numero para faturamento nomal, ou seja, Nota Fiscal serie
* Unica e Cupom
*---------------------------------------------------------------*
FUNCTION NF_DefFat
PARAMETERS PrmSolicitante

	=W_DEFPROC("NOTA.SPR")


	*---------------------------------------------------------*

	IF PrmSolicitante <> "IMPORTACAO"
		m.datanf =	wp_dtoper    && REGISTRA A DATA DA GERACAO DA NF
	ELSE
		m.datanf = orcament.dt_fat    && REG. DATA DA GERACAO DA NF
	ENDIF


	*--------------------------------------------------------*
	

	DO CASE
		CASE orcament.empresa = 6 and (orcament.orcamento = 49275 or ;
		                               orcament.orcamento = 49546)
			IF !NF_02DefProcess((orcament.empresa),(orcament.tipo),;
					(LFproduto),(LFservico),(LFipi),(m.datanf),;
					LStp_process,clienc.tp_pessoa,clienc.tp_inscr,;
					clienc.inscricao,PrmSolicitante)
	  				SELE orcament
				RETURN(.F.)
			ENDIF

		CASE m.datanf < {30.09.2006}
			IF !NF_01DefProcess((orcament.empresa),(orcament.tipo),;
					(LFproduto),(LFservico),;
					LStp_process,PrmSolicitante)
	  				SELE orcament
				RETURN(.F.)
			ENDIF
		OTHERWISE
			IF !NF_02DefProcess((orcament.empresa),(orcament.tipo),;
					(LFproduto),(LFservico),(LFipi),(m.datanf),;
					LStp_process,clienc.tp_pessoa,clienc.tp_inscr,;
					clienc.inscricao,PrmSolicitante)
	  				SELE orcament
				RETURN(.F.)
			ENDIF
	ENDCASE



	IF PrmSolicitante <> "IMPORTACAO"
		*---------------------------------------------------------*
		STORE 0  TO LNnroNF, LNNfServico, LNCtrlCpm
		STORE 0  TO LNNFCop, LNnfSrvCop,LNcupom
		STORE 0  TO LNNroRPS
		*---------------------------------------------------------*

		=W_DEFPROC("NOTA.SPR")
		IF !NF_02NroNota((orcament.empresa),(LStp_process),;
				LNnroNF, LNNfServico, LNCtrlCpm,;		
				LNNFCop, LNnfSrvCop,LNcupom,LNNroRPS)
		    WAIT WINDOW ;
		    	"Nao foram atribuidos NUMEROS AO REGISTRO DE NOTA/CUPOM"
    		SELE orcament
			RETURN(.F.)
		ENDIF
		m.datanf		=	wp_dtoper    && REGISTRA A DATA DA GERACAO DA NF
		m.horanf		=	time()		 && REGISTRA A HORA

	ELSE
		STORE 0  TO LNnroNF, LNNfServico, LNCtrlCpm
		STORE 0  TO LNNFCop, LNnfSrvCop,LNcupom

		m.datanf	   = orcament.dt_fat    && REG. DATA DA GERACAO DA NF
		m.horanf	   = orcament.hora_fat  && REG. HORA - nao inf. impor

		LNnroNF		   = orcament.nota - 1
		LNCtrlCpm = orcament.nota - 1
		LNNfServico = orcament.NFSERVICO - 1
		LNcupom		   = orcament.cupom
		LNNroRPS       = orcament.RPS
		LNNFCop     = 0
		LNnfSrvCop  = 0
	ENDIF



	*---------------------------------------------------------*

	STORE LNnroNF        +1 TO LNnfinicio
	STORE LNNfServico    +1	TO LNnfsrvIni
	STORE LNCtrlCpm      +1 TO LNCtrlCpmIni

	STORE LNnroNF  		TO LNnffim
	STORE LNNfServico	TO LNnfsrvFim
	STORE LNCtrlCpm  	TO LNCtrlCpmFim


	STORE LNNFCop     TO LNnfCopInicio , LNnfCopFim
	STORE LNnfSrvCop  TO LNSrvCopIni  , LNSrvCopFim

	*---------------------------------------------------------*

	IF LNnroNF+LNNfServico+LNCtrlCpm+;
		 LNNFCop+LNnfSrvCop+LNcupom = 0
		   WAIT WINDOW ;
		   	"Nao foram atribidos NUMEROS AO REGISTRO DE NOTA/CUPOM"
	   		SELE orcament
			RETURN(.F.)
	ENDIF
	*---------------------------------------------------------*
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2DB           NFchq_Final VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    5    º
*       º Variable:            NFchq_Final                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      60                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2db     &&  NFchq_Final VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFchq_Final
PARAMETERS LNemp,LNorcamento,LSsolicitante,LFservico,LFproduto
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Consite a OSI/ITENS de Controlar o Faturamento
	*------------------------------------------------------------*
	* COMENTARIO..: 	Antes de Liberar para Faturamento pode
	*				ser feita  a consistencia dos dados da osi
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcamento....: Nro do Orcamento para Consistir
	*		LSsolicitante..: Informacao ultizada para orientar
	*						a Baixa de saldo indicando se
	*						deve ser cancelada reservas e......
	*			   		LSsolicitante = "VENDEDOR"
	*					LSsolicitante = "CAIXA"
	*					LSsolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					LSsolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					LSsolicitante = "IMPORTACAO"	&& SCGC201A
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE FCHvlr,FCHqtde
	PRIVATE	LSret1_cita, LSret2_cita
	
	

	IF	TYPE("LSsolicitante") <> "C"
		LSsolicitante = "VENDEDOR"

	ENDIF

*	IF	LSsolicitante = "IMPORTACAO"
*		RETURN(.T.)
*	ENDIF


	*-----------------------------------------------------------*
	*  Esta chamada a EMGet_UF nao tem efeito logico e sim
	* estrutural forcando o instanciamento de EMPRESA evitando
	* que este estaciamento ocorra em um nivel mais profundo do
	* aninhamento de rotinas o que estava provocando o erro
	* (DO nesting too deep). Se forcamos a criacao nesti nivel
	* evitamos o erro
	*-----------------------------------------------------------*

	=W_DEFPROC("empresa.spr")
	=EMVerifyInst()

	=W_DEFPROC("grfiscal.spr")
	=GFVerifyInst()

	=W_DEFPROC("notaite.spr")
	=IEVerifyInst()

	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	STORE "" TO LSret1_cita, LSret2_cita
	*------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "Nao Foi Possivel Localizar Orcamento."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE tipooper
	SET ORDER TO TAG tipo
	SEEK 's'+orcament.tipo
	IF !FOUND()
		SEEK 'S'+orcament.tipo
	ENDIF
	IF !FOUND()
		DO OBJ_MENS.SPR WITH ;
	   		"Nao foi possivel classificar a OPERACAO. PROCURE SUPORTE..."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------------*
	*	Reposiciona clienc
	*------------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcamentoi,6)
	IF !FOUND()
		WAIT WINDOW "Dados do Cliente Referente Orcamento ";
				+STR(LNorcamento,6)+" Nao Estao Disponiveis."	
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF


	*------------------------------------------------------------------*
	*	Validar Dados
	*------------------------------------------------------------------*
	PRIVATE LFvldDados
	LFvldDados = .t.

    if LNemp <> 10  AND clienc.tp_pessoa = 2 AND EMPTY(clienc.e_mail_nfe)
		WAIT WINDOW "Informar Email Nfe para PessoaJuridica "
		LFvldDados = .f.
	ENDIF


    if EMPTY(clienc.endereco)
		WAIT WINDOW "Preencher Endereco do cliente "
		LFvldDados = .f.
	ENDIF


	=W_DEFPROC("ESTADOS.SPR")
    if !UFVld_Estado(clienc.estado)
		WAIT WINDOW "Informar UF.."
		LFvldDados = .f.
	ENDIF



	=W_DEFPROC("MUNICPIO.SPR")
	IF !MNVld_Municipio(clienc.estado,clienc.cidade)
		WAIT WINDOW ;
	  	   "Cidade do cliente nao Cadastrada em municipios"
		LFvldDados = .f.
	ENDIF


	=W_DEFPROC("CEP.SPR")
	IF !CPVld_CEP(INT(VAL(clienc.CEP)))
		WAIT WINDOW ;
	  	   "CEP Invalido"
		LFvldDados = .f.
	ENDIF



    IF   not ( "@" $ clienc.e_mail) ;
       OR ;
         not ( "@" $ clienc.e_mail_nfe)
		WAIT WINDOW "E-mail invalido. Informe email corretamente. <ENTER>"
		LFvldDados = .f.
	ENDIF		
	
	
    IF   LEN(ALLTRIM(CLIENC.fone)) > 10 or LEN(ALLTRIM(CLIENC.fone)) < 10
		WAIT WINDOW ;
		    "Telefone invalido. Informe 10(2=DDD+8=numero) digitos. <ENTER>"
		LFvldDados = .f.
	ENDIF		
	
	
	
    IF ALLTRIM(STR(INT(val(left(clienc.fone,10))))) <> clienc.FONE
		WAIT WINDOW ;
		    "Telefone invalido. Informe Telefone corretamente. <ENTER>"
		LFvldDados = .f.
	ENDIF		



	*------------------------------------------------------------------*
	IF LFvldDados = .f.
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF



	*------------------------------------------------------------------*

	=W_DEFPROC("CLIENTES.SPR")
	IF !CLVld_CPF_CNPJ( clienc.cliente )
		WAIT WINDOW "CPF/CNPJ Invalido <ENTER>"
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF


	*------------------------------------------------------------------*
	*     Vendas em CHEQUE A PRAZO (3) OU DUPLICATA (4) o cliente deve
	* ser cadasatrado
	*------------------------------------------------------------------*
	SELE clientes
	SET ORDER TO TAG cliente
	SEEK clienc.cliente

	*--------------------------------------------------------------*
	*  Vendas Parceladas no Cartao Sao Liberadas Sem Cadastro      *
	*			 orcament.tp_parcela <> 4						   *
	*--------------------------------------------------------------*
	IF !FOUND()
		IF orcament.tp_parcela > 1 and orcament.tp_parcela <> 4 and ;
								   orcament.tp_parcela <> 5
			WAIT WINDOW "Cliente deve ser Cadastrado . Execute <Cad> "
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.F.)
		ENDIF
	ENDIF


*-----------------------------------*

	IF orcament.tp_parcela = 6 && VENDOR


		IF LSsolicitante = "IMPORTACAO"	
			m.dt_emi = orcament.dt_fat
		ELSE
			m.dt_emi = wp_dtoper
		ENDIF

		=W_DEFPROC("duplicat.spr")
		IF !CRVerifTxsVendor(orcament.Empresa,;
							 m.Dt_Emi,;
							 orcament.Prazo)
			WAIT WINDOW ;
				"Taxas de Vendor nao Cadastradas <ENTER>  "
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.F.)
		ENDIF
	ENDIF



	IF FOUND()
		IF clientes.cliente = 0
			WAIT WINDOW ";
			  Existe Cadastro Cliente com CPF = 0.<Tente Novamente!>  "
	
			=REGLOCK(.T.)
			=edithand('APAGA')
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.F.)
		ENDIF
	ENDIF



	SELE orcatmp
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	SET NEAR OFF
	IF orcament.empresa <> orcatmp.empresa ;
		OR orcament.orcamento <> orcatmp.orcamento
		DO OBJ_MENS.SPR WITH ;
	   		"Nao foi possivel Localizar Itens para Faturar.."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*********************************************************	
	m.FCHvlr     = 0		&& P/ CONFERIR FECHAMENTO
	m.FCHqtde    = 0        && P/ CONFERIR FECHAMENTO
	LFservico	= .F.		&& CASO EXISTA SERVICO (TP_MERCAD = 7)
	LFproduto 	= .F.		&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
	LFIPI    	= .F.		&& CASO EXISTA IPI
    LSchq_CFO   = ""        && Se os Itens nao Apresentarem variacao
                            && de CFO => este e transportado para
                            && campo padrao
	m.Vlr_Subst = 0        && Verifica Destaque de ICMS substituicao FECHAMENTO

	*********************************************************


	DO WHILE !eof() AND LNorcamento = orcatmp.orcamento ;
					AND LNemp 		= orcatmp.empresa

        LSchq_CFO   = orcatmp.cfo


		***  VERIFICA SE CANCELAMENTO FOI INCLUIDO NA DESCRICAO

		IF LEFT(orcatmp.situacao,1) $ "Yy" ;
           and  !("CANCELA" $ UPPER(orcatmp.descricao))

		    DO OBJ_ALER.SPR WITH ;
			   "Existem itens com cancelamento incompleto. Verifique" +;
			   CHR(13)+" <ENTER>  "
			LFretorno	=	.F.

			EXIT
		ENDIF



		***  NAO PROCESSAR ITENS CANCELADOS, ALEM DO FECHAMENTO

		IF LEFT(orcatmp.situacao,1) $ "YykeZ"
			SKIP
			LOOP
		ENDIF



		IF EMPTY(ALLTRIM(orcatmp.cst))
		    DO OBJ_ALER.SPR WITH ;
			   "Existem itens sem CST (Codigo de Situacao Tributaria.)" +;
			   CHR(13)+;
			   "Verificar Tabela de Situacao Tributaria <ENTER>  "
			LFretorno	=	.F.
			EXIT
		ENDIF

		IF "CANCELA" $ UPPER(orcatmp.descricao)
		    DO OBJ_ALER.SPR WITH ;
			   "Existem itens com cancelamento incompleto. Verifique" +;
			   CHR(13)+" <ENTER>  "
			LFretorno	=	.F.
			EXIT
		ENDIF


*		IF (LSsolicitante = "VENDEDOR" 			AND !(Ltmpst $ "M"))
*		   	WAIT WINDOW "Os itens apresentam irregularidades. "
*			LFretorno	=	.F.
*			EXIT
*		ENDIF
*

		IF (LSsolicitante = "CAIXA" AND !("o" $ orcatmp.situacao ))
		   	WAIT WINDOW "Os itens apresentam irregularidades. "
			LFretorno	=	.F.
			EXIT
		ENDIF


*
*		***** SO SERA PROCESSADO QDO TODOS OS ITENS SE ENCONTRAREM EM
*		***** SITUACAO DE CANCELAMENTO OU PRONTOS P/ FATURAR
*		Ltmpst = LEFT(orcatmp.situacao,1)
*
*		IF (LSsolicitante = "FATURISTA RESERVA" AND !(Ltmpst $ "I")) OR ;
*		   (LSsolicitante = "FATURISTA SIMPLES" AND !(Ltmpst $ "A")) OR ;
*		   (LSsolicitante = "IMPORTACAO"		AND !(Ltmpst $ "A"))
*			LFretorno	=	.F.
*			EXIT
*		ENDIF
*

		m.FCHvlr  = m.FCHvlr  + orcatmp.precofinal
		m.FCHqtde = m.FCHqtde + orcatmp.qtde
		IF orcatmp.tp_mercad = 7		&& EXISTE SERVICO
			LFservico	= .T.		&& CASO EXISTA SERVICO (TP_MERCAD = 7)
		ELSE
			LFproduto	= .T.		&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
		ENDIF
		IF orcatmp.vlripi > 0
			LFipi = .t.
		ENDIF
		********************************************************


		*----------------------------------------------------------*
		*  		A situacao "O" indica que o item ja foi faturado
		*  A permissao de reprocessar visa corrigir problemas por
		*  interrupcao de faturamento anterior (TRANSACAO)
		*----------------------------------------------------------*
	    IF !ULbaixa_Saldo(LSsolicitante) ;
	    	AND !(LEFT(orcatmp.situacao,1) $ "O")
			LFretorno	=	.F.
			EXIT
		ENDIF


		SELE orcatmp
		SKIP
	ENDDO

  	SELECT orcament
	=REGLOCK(.T.)
	REPLACE orcament.cfo with LSchq_CFO



	m.LNfch  = m.FCHvlr + (m.FCHqtde / 100)

	DO CASE
		CASE !LFretorno
		   	WAIT WINDOW "Os itens apresentam irregularidades.  <ENTER> "
		CASE  LNfch <> orcament.fecha
	   		WAIT WINDOW ;
	   				"Os itens nao batem com valor de fechamento.  <ENTER> "
			LFretorno	=	.F.
	ENDCASE
	*--------------------------------------------------------------*


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2DV           NF_02NroNota VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    6    º
*       º Variable:            NF_02NroNota                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      61                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2dv     &&  NF_02NroNota VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NF_02NroNota
PARAMETERS LNemp,LStp_process,LNnroNF, LNNfServico,;
			 LNCtrlCupom,LNNFCop, LNnfSrvCop, LNcupom, LNNroRPS

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LNnotaAnterior
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*

	DO  CASE
		CASE !("REC." $ LStp_proces)

			LNnroNF         = empresa.nota

			IF UPPER(empresa.emite_NFe) = "S"
				LNnroNF = LNnroNF + 3000000
			ENDIF



			LNNfServico  = empresa.ult_nfsrvc
            LNNroRPS     = empresa.ult_RPS + 1

			IF UPPER(empresa.emite_NFSe) = "S"
				LNNfServico = LNNfServico + 4000000

			ELSE
				IF LNNfServico < 2000000
					LNNfServico = LNNfServico + 2000000
				ENDIF
			ENDIF

			LNCtrlCupom = empresa.ult_cupom
			IF LNCtrlCupom < 1000000
				LNCtrlCupom = LNCtrlCupom + 1000000
			ENDIF

			LNcupom = 0
		OTHERWISE
			DO OBJ_3FAT.SPR WITH LNnroNF,LNNfServico,;
				LNCtrlCupom,LNNFCop,LNnfSrvCop,LNcupom,LStp_proces

			IF "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
				LNnroNF = LNnroNF - 1
			ENDIF
			IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
				LNNfServico = LNNfServico - 1
			ENDIF
			IF "CUPOM" $ LStp_proces
				LNCtrlCupom = LNCtrlCupom - 1
			ENDIF
	ENDCASE
	*--------------------------------------------------------------*


	IF "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
		SELE nota
		SET ORDER TO TAG nota
		SEEK STR(LNemp,3)+STR(LNnroNF+1,7)  && VER SE PROXIMO NUM JA GRAVADO
		IF FOUND()
		   	WAIT WINDOW "No. Nota ja emitida. "+STR(LNnroNF+1,7)
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
		ENDIF


		IF (LNnroNF > 1 AND LNnroNF <= 999999);
		   OR  ;
		   (LNnroNF > 3000001 AND LNnroNF <= 3999999)

			LNnotaAnterior = VAL(SUBS(STR(LNnroNF-1,7),2))
			SEEK STR(LNemp,3)+STR(LNnroNF-1,7) &&VER SE ULT NRO JA GRAVADO
			IF (LNnotaAnterior > 0) AND !FOUND()
			   	WAIT WINDOW "No. Nota anterior nao gravada. ";
							+STR(LNnroNF-1,7)
				IF !EMPTY(LSalias) AND USED(LSalias)
					SELECT &LSalias
				ENDIF
				RETURN(.f.)
			ENDIF
		ENDIF

	ENDIF

	IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
		SELE nota
		SET ORDER TO TAG nota
		SEEK STR(LNemp,3)+STR(LNNfServico+1,7)
		IF FOUND()
		   	WAIT WINDOW "No.NF Servico ja emitida. "+STR(LNNfServico+1,7)
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
		ENDIF

		IF (LNNfServico > 2000001 AND LNNfServico <= 2999999) ;
		  OR ;
		   (LNNfServico > 4000001 AND LNNfServico <= 4999999)
			LNnotaAnterior = VAL(SUBS(STR(LNNfServico-1,7),2))
			SEEK STR(LNemp,3)+STR(LNNfServico-1,7)
			IF (LNnotaAnterior) > 0 AND !FOUND()
		   		WAIT WINDOW "No.Anterior NF Servico nao gravado. "+;
								STR(LNNfServico-1,7)
				IF !EMPTY(LSalias) AND USED(LSalias)
					SELECT &LSalias
				ENDIF
				RETURN(.f.)
			ENDIF
		ENDIF
	ENDIF
	IF "CUPOM" $ LStp_proces
		SELE nota
		SET ORDER TO TAG nota
		SEEK STR(LNemp,3)+STR(LNCtrlCupom+1,7)
		IF FOUND()
		   	WAIT WINDOW "No. Cupom ja emitido. "+STR(LNCtrlCupom+1,7)
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
		ENDIF
		
		IF (LNCtrlCupom > 1000001 AND LNCtrlCupom <= 1999999)
			LNnotaAnterior = VAL(SUBS(STR(LNCtrlCupom-1,7),2))
			SEEK STR(LNemp,3)+STR(LNCtrlCupom-1,7)
			IF (LNnotaAnterior) >0 AND !FOUND()
			   	WAIT WINDOW "No.Anterior Cupom nao gravado emitido. "+;
					STR(LNCtrlCupom-1,7)
				IF !EMPTY(LSalias) AND USED(LSalias)
					SELECT &LSalias
				ENDIF
				RETURN(.f.)
			ENDIF
		ENDIF
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2E7           NFFatura VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    7    º
*       º Variable:            NFFatura                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      62                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2e7     &&  NFFatura VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFFatura
PARAMETERS 	LNemp,;
  			LNosi,;
  			LNnroNF,;
  			LNcupom,;
  			LStp_proces,;
  			LDdtnf,;
  			LShoranf,;
			LSsolicitante,;
			LNnffim,;
			PrmOrientacao,PrmRPS
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar o Faturamento
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNosi..........: Nro da OSI para Faturar
	*		LNnroNF........: Numero  Inicial para Nota Fiscal
	*		LNcupom........: Numero do Cupo Relacionado a Nota
	*						No caso recuperacao ja vem informado
	*						caso contrario e determinado na
	*						abertura da nota
	*		LStp_process...: Processo definido em NFDefProcess
	*
	*              Antes de 15/03/2006
	*					LStp_proces	= "NOTA/CUPOM"
	*					LStp_proces	= "CUPOM"
	*					LStp_proces	= "NOTA"
	*					LStp_proces	= "REC.NOTA/CUPOM"
	*					LStp_proces	= "REC.CUPOM"
	*					LStp_proces	= "REC.NOTA"
	*              apos 15/03/2006
	*					LStp_proces	= "CUPOM"
	*					LStp_proces	= "CUPOM/COPIA EM NOTA"
	*					LStp_proces	= "CUPOM/COPIA EM NF SERVICO"
	*					LStp_proces	= "CUPOM/COPIA EM NOTA/NF SERVICO"
	*					LStp_proces	= "NOTA"
	*					LStp_proces	= "NF SERVICO"
	*					LStp_proces	= "NOTA/NF SERVICO"
	*					LStp_proces	= "REC.CUPOM"
	*					LStp_proces	= "REC.NOTA"
	*					LStp_proces	= "REC.NF SERVICO"
	*					LStp_proces	= "REC.NOTA/NF SERVICO"
	*					LStp_proces	= "COPIA CUPOM EM NOTA"
	*					LStp_proces	= "COPIA CUPOM EM NF SERVICO"
	*
	*		LDdtnf.........: Data para Registrar a Nota
	*		LShoranf.......: Hora para Registrar a Nota
	*		LSsolicitante..: Informacao ultizada para orientar
	*						a Baixa de saldo indicando se
	*						deve ser cancelada reservas e......
	*			   		LSsolicitante = "VENDEDOR"
	*					LSsolicitante = "CAIXA"
	*					LSsolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					LSsolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					LSsolicitante = "IMPORTACAO"		&& SCGC201A
	*			OBS: ("IMPORTACAO" tem comportamento igual a
	*				"FATURISTA SIMPLES", como a passagem de
	*				parametro ‚ por valor LSsolicitante pode
	*				ser alterado para  "FATURISTA SIMPLES" para
	*				evitar mudancas em subrotinas para tratar
	*				"IMPORTACAO"
	*	    	PrmOrientacao..: Devido a exigencia de prefeituras como a de
	*                Varzea Grande para emitir sevico em formulario proprio
	*                este processo passou a ter tres orientacoes
	*               "PRODUTO/SERVICO" => Fatura todos itens sem filtro
	*               "PRODUTO"         => Fatura so itens ref a produtos
	*               "SERVICO"         => Fatura so itens ref a servicos
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNnffim........: Numero da Ultima Nota
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LNctritens
	PRIVATE LFretorno		
	PRIVATE LNsoma_vlr,;
			LNbs_iss,LNvl_iss,LNvl_issrtd,LNbs_icms,LNvl_icms,LNbs_sbbrt,;
			LNbs_subs,LNvl_subs,LNbs_isent,LNbs_outr,LNbs_isipi,;
			LNbs_isipi,LNbs_ipi,LNvl_ipi
	PRIVATE LNpneus,LNcamaras,LNrodas,LNacessorios,LNmatborrach,;
			LNrecauchuta,LNalinhament,LNbalanceame,LNconserto,LNoutras

	PRIVATE LNpeso
	PRIVATE LNvlr_item

	IF TYPE ("LNecf") = "U"
		private LNecf
		LNecf = 0	&& NO CASO DE IMPORTACAO LNecf nao existe
	ENDIF
	*-----------------------------------------------------------*

	IF LSsolicitante = "IMPORTACAO"
		LSsolicitante = "FATURISTA SIMPLES"	&& SCGC201A		
	ENDIF
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*------------------------------------------------------------*
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
   		WAIT WINDOW "Empresa Localizada."+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE orcament

	*--------*  FORCA DESLOCAMENTO DA PAGINACAO DE INDICE
	
	GO BOTT
	GO TOP
	
	*-------*

	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
   		WAIT WINDOW "Orcamento Nao Localizado."+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	IF !REGLOCK()
   		WAIT WINDOW "Orcamento em uso em outro ponto. Tente novamente."+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	*--------*  FORCA DESLOCAMENTO DA PAGINACAO DE INDICE
	
	GO BOTT
	GO TOP
	
	*-------*
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
   		WAIT WINDOW "Anexo de Orcamento Nao Localizado."+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)  nowait
	ENDIF


	SELE clienc
	*--------*  FORCA DESLOCAMENTO DA PAGINACAO DE INDICE
	
	GO BOTT
	GO TOP
	
	*-------*
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
   		WAIT WINDOW "Dados do Cliente  Nao Localizado  (CLIENC). "+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------*

	=W_DEFPROC("clientes.spr")
	=CLSetUltAtendimento(Clienc.Cliente,Clienc.Inscricao, LDdtnf)

	*---------------------------------------------------------*

	SELE orcatmp
	*--------*  FORCA DESLOCAMENTO DA PAGINACAO DE INDICE
	
	GO BOTT
	GO TOP
	
	*-------*
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNosi,6)
	SET NEAR OFF
	IF orcament.empresa <> orcatmp.empresa ;
		OR orcament.orcamento <> orcatmp.orcamento
   		WAIT WINDOW "Itens do Orcamento Nao Localizados."+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELECT tipooper
	*--------*  FORCA DESLOCAMENTO DA PAGINACAO DE INDICE
	
	GO BOTT
	GO TOP
	
	*-------*
	SET ORDER TO TAG tipo
	SEEK 's'+orcament.tipo
	IF !FOUND()
		SEEK 'S'+orcament.tipo
	ENDIF
	IF !FOUND()
   		WAIT WINDOW "Tipo de Operacao  Nao Localizado."+;
		   		STR(LNemp,3)+" - "+STR(LNosi,6)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*

	SELE orcatmp

    *--------------------------------------------------------------*
    *   SUBTRAI 1 EM LNnroNF PARA COMPENSAR A SOMA NO INICIO DO
    * COMANDO (DO WHILE)  A SEGUIR
    *--------------------------------------------------------------*

	m.vlrfrete  = orcament.vlrfrete
	m.vlrseguro = orcament.vlrseguro





	LNnroNF  = LNnroNF 	- 1       &&

	DO WHILE !eof() AND LNosi = orcatmp.orcamento ;
					AND LNemp = orcatmp.empresa

		IF LEFT(orcatmp.situacao,1) $ "YykeZO"
			***  NAO PROCESSAR ITENS CANCELADOS
			SKIP
			LOOP
		ENDIF

		DO CASE
			CASE PrmOrientacao = "PRODUTO/SERVICO"
		        STORE .T. TO LFGerNF   && SINALIZA QUE FOI GERADA
		                               && NOTA SERIE UNICA
			CASE PrmOrientacao = "PRODUTO"
				IF orcatmp.tp_mercad = 7 && SERVICO
					SKIP
					LOOP
				ENDIF
		        STORE .T. TO LFGerNF   && SINALIZA QUE FOI GERADA
		                               && NOTA SERIE UNICA
			CASE PrmOrientacao = "SERVICO"
				IF orcatmp.tp_mercad <> 7 && NAO SERVICO
					SKIP
					LOOP
				ENDIF
		        STORE .T. TO LFGerNFS   && SINALIZA QUE FOI GERADA
		                                && NOTA FISCAL DE SERVICO
		ENDCASE

		LNnroNF  = LNnroNF 	+ 1

		*-----------------<<<<<<<<<<    >>>>>>>>>--------------------*

		
		m.serie 	=	"U"

		m.serie 	=	NFSerie(empresa.empresa,;
		                        empresa.muni_ibge,;
		                        LNnroNF)




		m.referencia = 	orcament.orcamento
		m.cgc_emit	= 	empresa.cgc
		LTmp        =   "empresa.insc_"+empresa.estado
		m.insc_emit	= 	&LTmp
		m.insc_muni =	empresa.insc_munic
		m.uf		=	clienc.estado
		m.favorecido=	clienc.cliente
		***********************************************
		m.inscsubst		= 	empresa.insc_&uf
		m.aliq_iss		= 	empresa.aliq_iss

		IF tipooper.ch_opera = "1" ;
			AND (orcament.tp_parcela = 4 OR orcament.tp_parcela = 5)
			m.natureza		=	"VENDA CARTAO"
		ELSE
			m.natureza		=	tipooper.descricao
		ENDIF

		IF  PrmOrientacao = "SERVICO"
			m.natureza		=	"PRESTACAO DE SERVICO"
		ENDIF
		



		m.cod_cita		=	tipooper.citacao
		IF 	!EMPTY(ALLTRIM(orc_anex.mens1)) ;
			AND !EMPTY(ALLTRIM(orc_anex.mens2))
			m.citacao 	= LEFT(ALLTRIM(orc_anex.mens1)+";";
						      +ALLTRIM(orc_anex.mens2),64)
			m.citacao1 	= SUBS(ALLTRIM(orc_anex.mens1)+";";
							  +ALLTRIM(orc_anex.mens2),65)
		ELSE
			m.citacao 	= 	" "
			m.citacao1 	= 	" "
		ENDIF
		m.citacao3 	= orc_anex.mens3

		*-----> BUSCA NUMERO DA NOTA FISCAL


		**** LNnroNF  = LNnroNF 	+ 1

		m.nota   = LNnroNF 	
		m.cupom  = LNcupom
		m.rps    = PrmRPS
		
		m.operacao = "S"		&& NOTA FISCAL DE SAIDA
		m.data = LDdtnf
		m.hora = LShoranf
		m.dtorcament = orcament.data
		m.hrorcament = orcament.hora		
		m.orcamento  = orcament.orcamento
		m.status = 1
		*---------------------------------------------------------*
		=W_DEFPROC("NOTA.SPR")
		IF !NFAbreNota(orcament.empresa,LFabrecupom,(LStp_process),;
					(m.nota),m.cupom,m.operacao,;
					m.data,m.hora,m.status,wp_tipoecf,LNecf)
	   		WAIT WINDOW "Comando para Abertura do Reg. Nota nao foi " +;
	   			" Acatado."
			LFretorno = .F.
			EXIT
		ENDIF
		LNcupom = m.cupom	
		*---------------------------------------------------------*
		M.FLAGPROCES	=	1	&& GRAVACAO DA CAPA DA NOTA
		******************************************************
		*	ATENCAO : FIM  DE FASE CRITICA
		*				A- O CUPOM ABERTO
		*				B- JA EXISTE REGISTRO EQUIVALENTE NO SISTEMA
		*					P/ ORIENTAR UM POSSIVEL CANCELAMENTO CASO
		*				    O SISTEMA CAIA APARTIR DESTE PONTO
		******************************************************
		*---------------------------------------------------------*

		IF  LSsolicitante <> "IMPORTACAO" AND !("REC." $ LStp_proces)
			SELECT empresa
			SET ORDER TO tag empresa
			=REGLOCK(.T.)
			DO CASE
				CASE PrmOrientacao = "SERVICO"
					REPLACE empresa.Ult_NFsrvc WITH empresa.Ult_NFsrvc + 1
					REPLACE empresa.ult_RPS    WITH empresa.ult_RPS + 1

					REPLACE FLAGIMPSRV 	WITH 1
				CASE "NOTA" = LStp_proces ;
					AND PrmOrientacao = "PRODUTO/SERVICO"
						REPLACE empresa.nota WITH empresa.nota + 1
						REPLACE FLAGIMPNF 	WITH 1
				CASE "NOTA/CUPOM" = LStp_proces
						REPLACE empresa.nota WITH empresa.nota + 1
						REPLACE FLAGIMPNF 	WITH 1
				CASE "NOTA" = LStp_proces AND PrmOrientacao = "PRODUTO"
					REPLACE empresa.nota WITH empresa.nota + 1
					REPLACE FLAGIMPNF 	WITH 1
				CASE "NOTA/NF SERVICO" = LStp_proces ;
				   AND PrmOrientacao = "PRODUTO"
					REPLACE empresa.nota WITH empresa.nota + 1
					REPLACE FLAGIMPNF 	WITH 1
				CASE "NOTA/NF SERVICO" = LStp_proces ;
				   AND PrmOrientacao = "SERVICO"
					REPLACE empresa.Ult_NFsrvc WITH empresa.Ult_NFsrvc + 1
					REPLACE empresa.ult_RPS    WITH empresa.ult_RPS + 1

					REPLACE FLAGIMPSRV 	WITH 1
				CASE "NF SERVICO" = LStp_proces
					REPLACE empresa.Ult_NFsrvc WITH empresa.Ult_NFsrvc + 1
					REPLACE empresa.ult_RPS    WITH empresa.ult_RPS + 1


					REPLACE FLAGIMPSRV 	WITH 1
				CASE "CUPOM" $ LStp_proces
					REPLACE empresa.ult_cupom  WITH empresa.ult_cupom + 1
					REPLACE FLAGIMPCPM 	WITH 1
			ENDCASE
		ENDIF
		*---------------------------------------------------------*
		* 		  Processo para evitar duplicacoes de itens provocada por
    	* 	falha durante possivel faturamento anterior
		*   Processo adotado para compensar a transacao
		*---------------------------------------------------------*
		=W_DEFPROC("NOTA.SPR")
		=NFDelItensNf(orcament.empresa,(m.nota))
		*---------------------------------------------------------*
		=UNFmarcanf(2) 	&& CAPA GRAVADA E ITENS VERIFICADOS
		=UNFempmarca(2,LStp_proces,PrmOrientacao)
		*---------------------------------------------------------*


		SELE NOTA
		STORE 0 TO LNsoma_vlr,;
			LNbs_iss,LNvl_iss,LNvl_issrtd,LNbs_icms,LNvl_icms,LNbs_sbbrt,;
			LNbs_subs,LNvl_subs,LNbs_isent,LNbs_outr,LNbs_isipi,;
			LNbs_isipi,LNbs_ipi,LNvl_ipi

		STORE 0 TO LNsoma_vlr,;
			LNpneus,LNcamaras,LNrodas,LNacessorios,LNmatborrach,;
			LNrecauchuta,LNalinhament,LNbalanceame,LNconserto,LNoutras
		STORE 0 TO LNpeso
		*---------------------------------------------------------*


		LNctritens = 0
		SELECT  orcatmp
	    DO WHILE !eof() AND LNosi = orcatmp.orcamento ;
    				AND LNemp = orcatmp. empresa



			*---------------------------------------------------*
			*  A PARTIR DE 10/09/2008 SE O NUMERO DE ITENS OCUPAR
			* MAIS DE UM FORMULARIO SERAMANTIDO O MESMO NUMERO DE
			* NF E A TATALIZACAO DAIMPRESSAO OCORRERA NA ULTIMA NF
			*------> REQUISICAO ? JOAO NUNES CONTADOR
			*---------------------------------------------------*
			IF LDdtnf < {28.09.2008}
				IF  LNnroNF < 1000000 OR  LNnroNF > 2000000
					IF  LNctritens >= 11
						EXIT
					ENDIF
				ENDIF
			ENDIF


			***  NAO PROCESSAR ITENS CANCELADOS

			IF LEFT(orcatmp.situacao,1) $ "YykeZO"
				SKIP
				LOOP
			ENDIF
			DO CASE
				CASE PrmOrientacao = "PRODUTO"
					IF orcatmp.tp_mercad = 7 && SERVICO
						SKIP
						LOOP
					ENDIF
				CASE PrmOrientacao = "SERVICO"
					IF orcatmp.tp_mercad <> 7 && NAO SERVICO
						SKIP
						LOOP
					ENDIF
			ENDCASE
			*-----------------------------------------------------*
			wp_msg = "Faturando OSI: "+STR(LNosi,6)+" - Item : "+;
					STR(orcatmp.ordem,2)+" - "+orcatmp.codigo
			WAIT WINDOW wp_msg NOWAIT
			*-----------------------------------------------------*
		    IF ULbaixa_Saldo(LSsolicitante)
		    	SELECT orcatmp
				IF REGLOCK()

            * um erro nao identificado do sistema estava atribuindo 0

                     if m.nota <> LNnroNF
                        m.nota   = LNnroNF 	
                    ENDIF

                    if m.nota = 0
                       =W_DEFPROC("rotinas.spr")
                       =UPerrosys;
            ("Nota com numero = 0 - Informe suporte <Enter>(Nffatura) ")
                    endif
				
				
					*--------------------------------------------------*
					=W_DEFPROC("NOTA.SPR")
					=NFFat_Item(orcament.empresa,(m.nota),(LDdtnf),;
										(LShoranf))
					*--------------------------------------------------*


			    	SELECT orcatmp
					IF tipooper.ch_opera $ "4/2" && devolucao / transf
				        LNvlr_item = (orcatmp.vlrvenda)
					ELSE
				        LNvlr_item = (orcatmp.vlrvenda - orcatmp.vlripi)
					ENDIF


			        LNsoma_vlr = LNsoma_vlr + LNvlr_item


					=W_DEFPROC("grupo.spr")
					LNpeso      = LNpeso + ;
					     GRGetPeso(orcatmp.codigo) * orcatmp.qtde

					LNbs_iss	= 	LNbs_iss	+	orcatmp.base_iss
					LNvl_iss	= 	LNvl_iss	+	orcatmp.vlr_iss
					LNvl_issrtd =   LNvl_issrtd +   orcatmp.vlr_issrtd
					LNbs_icms	= 	LNbs_icms	+	orcatmp.base_calc
					LNvl_icms	=	LNvl_icms	+	orcatmp.vlr_icms
					LNbs_sbbrt	=	LNbs_sbbrt	+	orcatmp.base_sbbrt					
					LNbs_subs 	=	LNbs_subs 	+	orcatmp.base_subs 					
					LNvl_subs 	=	LNvl_subs 	+	orcatmp.icms_subs 					
					LNbs_isent	=	LNbs_isent	+	orcatmp.base_isent					
					LNbs_outr 	=	LNbs_outr 	+	orcatmp.base_outr 					
					LNbs_isipi	=	LNbs_isipi	+	orcatmp.base_isipi					
					LNbs_ipi  	=	LNbs_ipi  	+	orcatmp.base_ipi  					
					LNvl_ipi  	=	LNvl_ipi  	+	orcatmp.vlripi   					
					*--------------------------------------------------*
					IF tipooper.ch_opera = "1"
						SELE grupo
						SET ORDER TO TAG codigo
						SEEK orcatmp.codigo
						SELE orcatmp

						*-----> APURA VALORES P/ RESUMO ANEXO SO PARA VENDAS
						DO CASE
							CASE LEFT(grupo.classifica,2) = "00"
								LNpneus		= 	LNpneus + LNvlr_item
							CASE LEFT(grupo.classifica,2) = "01"
								LNcamaras	=	LNcamaras + LNvlr_item
							CASE LEFT(grupo.classifica,2) = "02"
								LNrodas   	= 	LNrodas  + LNvlr_item
							CASE LEFT(grupo.classifica,2) = "04"
								LNacessorios= LNacessorios+ LNvlr_item
							CASE LEFT(grupo.classifica,2) = "05"
								LNmatborrach= LNmatborrach+ LNvlr_item
							CASE LEFT(grupo.classifica,5) = "09094"
								LNrecauchuta= LNrecauchuta+ LNvlr_item
							CASE LEFT(grupo.classifica,5) = "09091"
								LNalinhament= LNalinhament+ LNvlr_item
							CASE LEFT(grupo.classifica,5) = "09092"
								LNbalanceame= LNbalanceame+ LNvlr_item
							CASE LEFT(grupo.classifica,5) = "09093"
								LNconserto  = LNconserto + LNvlr_item
							OTHERWISE
								LNoutras	= LNoutras   + LNvlr_item
						ENDCASE
				    	SELECT orcatmp
					ENDIF
				ELSE
			   		WAIT WINDOW ;
			   			"Registro de Item do Orcamento Esta Bloqueado"
					LFretorno = .F.
					EXIT
				ENDIF
			ELSE
		   		WAIT WINDOW  "Foi Negada a Baixa no Estoque."
				LFretorno = .F.
				EXIT
			ENDIF
			SELECT  orcatmp
			SKIP
			LNctritens = LNctritens + 1
		ENDDO
		IF LNctritens = 0
	   		WAIT WINDOW  "Nenhum Item Faturado."
			LFretorno = .F.
			EXIT
		ENDIF
		IF !LFretorno
			EXIT
		ENDIF			

		SELE orcament
		SCATTER MEMVAR FIELDS banco,agencia


		m.nome		=	clienc.nome
		m.endereco	=	clienc.endereco
		m.bairro	=	clienc.bairro
		m.cidade	=	clienc.cidade
		m.MUNI_IBGE	=	clienc.MUNI_IBGE
		m.uf		=	clienc.estado
		m.cep		=	clienc.cep
		m.fone		=	clienc.fone
		m.regiao 	= 	clienc.regiao
		m.revendedor=	clienc.revendedor
		m.natu_cli	=	clienc.natu_cli
		m.tp_pessoa	=	clienc.tp_pessoa
		m.tp_inscr	=	clienc.tp_inscr
		m.inscricao	=	clienc.inscricao
		m.e_mail    =	clienc.e_mail
		m.e_mail_nfe=	clienc.e_mail_nfe
		m.im_tomador=   clienc.im_tomador


		SELE tipooper
		SCATTER MEMVAR FIELDS ch_opera,ch_produ, ;
						ch_motiv,ch_desti,ch_contr,ch_condi
		SELE nota
		m.operacao = "S"		&& NOTA FISCAL DE SAIDA
		m.data = LDdtnf
		m.hora = LShoranf
		m.orcamento = orcament.orcamento
		m.status = 1
		
		*-------------------------------------------------------------*
		m.serv_1     = orcament.operador

		STORE 0 TO   serv_2,serv_3,serv_4,serv_5,serv_6,;
				 serv_7,serv_8,serv_9,serv_10,serv_11,;
				 serv_12
		STORE "" TO  mens1,mens2

		SELE orc_anex
		SET ORDER TO TAG orcamento
		SEEK STR(orcament.EMPRESA,3)+STR(orcament.ORCAMENTO,6)
		IF FOUND()
			SCATTER MEMVAR FIELDS mens1,mens2,;
								  serv_2,serv_3,serv_4,serv_5,serv_6,;
								  serv_7,serv_8,serv_9,serv_10,serv_11,;
								  serv_12
		ENDIF
		*-------------------------------------------------------------*
		SELE nota
		m.negociacao = orcament.negociacao

		*-----------------------------------------------*


		IF orcament.tp_parcela = 1
			m.tp_pgto   =   1   && A Vista
		ELSE
			m.tp_pgto   =   3 	&& Parcelado
		ENDIF



		m.pes_brt   =   LNpeso
		m.pes_liq   =   LNpeso
		
	 	m.base_iss	=	LNbs_iss
		m.aliq_iss	=	empresa.aliq_iss
		m.vlr_iss	=	ROUND(m.base_iss * ROUND(m.aliq_iss  / 100,4),2)


        m.vlr_issrtd = 	LNvl_issrtd

		m.totservico=	LNbs_iss

		m.base_icms	=	LNbs_icms
		m.aliq_icms	= 	ORCAMENT.aliq_icms
		m.vlr_icms	=	m.base_icms * m.aliq_icms / 100

		m.vlr_icms	=	LNvl_icms


		m.base_sbbrt= 	LNbs_sbbrt
		m.base_subs	=	LNbs_subs
		m.icms_subs	=	LNvl_subs

		m.base_isipi=	LNbs_isipi
		m.base_ipi	=	LNbs_ipi
		m.vlr_ipi	=	LNvl_ipi


		m.base_isent=	LNbs_isent
		m.base_outr	=	LNbs_outr

		m.totservico =	LNbs_iss
		m.totproduto =  LNsoma_vlr - m.totservico
		m.total_nota =	LNsoma_vlr + m.icms_subs + ;
						m.vlrfrete + m.vlrseguro + ;
						m.vlr_ipi
		m.status = 1
		M.FLAGPROCES	=	3	&& NOTA E ITENS FATURADOS NORMALMENTE
							&& FALTANDO A IMPRESSAO

		SELE nota

        * um erro nao identificado do sistema estava atribuindo 0

        if m.nota <> LNnroNF
 		   m.nota   = LNnroNF 	
        ENDIF

        if m.nota = 0
	      =W_DEFPROC("rotinas.spr")
          =UPerrosys;
            ("Nota com numero = 0 - Informe suporte <Enter>(Nffatura) ")
         endif




		=edithand('REGRAVA')
		*************  RODANDO A NUMERACAO E MARCANDO O FLAG  **************
		=UNFempmarca(3,LStp_proces,PrmOrientacao)
		***************************************************************	**
		SELE nf_anexo
		m.pneus			= LNpneus
		m.camaras		= LNcamaras
		m.rodas			= LNrodas
		m.acessorios    = LNacessorios
		m.matborrach	= LNmatborrach
		m.recauchuta	= LNrecauchuta
		m.alinhament	= LNalinhament
		m.balanceame	= LNbalanceame
		m.conserto		= LNconserto
	    =edithand('SAVE')
		SELE orcatmp
		m.vlrfrete = 0    && valor apenas na primeira nota
		m.vlrseguro =0    && valor apenas na primeira nota

	    IF eof() OR orcament.orcamento <> orcatmp.orcamento ;
    		OR LNemp <> orcatmp. empresa
			EXIT
		ENDIF
	ENDDO
	*-----------------------------------------------------*
	wp_msg = "Fechado Faturamento Itens OSI: "+STR(LNosi,6)
	WAIT WINDOW wp_msg NOWAIT
	*-----------------------------------------------------*
	m.LNnffim      = LNnroNF 	
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2F5           NFAbreNota VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    8    º
*       º Variable:            NFAbreNota                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      63                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2f5     &&  NFAbreNota VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFAbreNota
PARAMETERS LNemp,LFabrecupom,LStp_process,m.nota,m.cupom,m.operacao,;
			m.data,m.hora,m.status,wp_tipoecf,LNecf

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Abrir o Registro de Nota no Arquivo com os
	*		dados Basicos
	*	
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LFabrecupom....: Indica Necessidade de Abrir Cupom ECF
	*		LStp_process...: Processo definido em NFDefProcess
	*		m.nota,m.cupom,m.operacao,m.data,m.hora,m.status
	*						,wp_tipoecf,LNecf  DADOS PARA GRAVACAO
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSstatus
	PRIVATE LSnronf,LSnrocp,LNnrocpAnt
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	LNnrocpAnt = 0

	IF m.nota = 0
      WAIT WINDOW "O sistema tentou atribuir 0(Zero) ao Abrir nota <enter>"
			LFretorno = .F.
  	  IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
	   ENDIF
	   RETURN(.f.)
	ENDIF


	IF LFabrecupom EMPRESA.EMITE_CFE $ "N"

		LFabrecupom = .F. 		&& NAO TENTAR ABRIR DE NOVO
		******************************************************
		*	ATENCAO : INICIO DE FASE CRITICA
		*				A- O CUPOM SERA ABERTO
		*				B- NAO EXISTE REGISTRO EQUIVALENTE NO SISTEMA
		*					P/ ORIENTAR UM POSSIVEL CANCELAMENTO CASO
		*				    O SISTEMA CAIA ANTES DA GRAVACAO DA CAPA
		*					NO REGISTRO DE NOTAS
		******************************************************

		IF "CUPOM" $ LStp_proces
			IF !("REC." $ LStp_proces)
				=W_DEFPROC("ECF.SPR")
				LNnrocpAnt = INT(ECFnrocupom())
			ENDIF
		ELSE
				LNnrocpAnt = 0
		ENDIF


		=W_DEFPROC("ECF.SPR")
		LSstatus = ECFabrecupom()

		IF SUBS(LSstatus,7,1) = "E"
			LSnronf    = empresa.ult_cupom 						 				
			IF LSnronf < 1000000
				LSnronf = LSnronf + 1000000
			ENDIF
			=W_DEFPROC("ECF.SPR")
			LSnrocp = STR(INT(ECFnrocupom()),7)
			LSnronf = STR(LSnronf,7)
			DO OBJ_MENS.SPR WITH "   ATENCAO !!! " +CHR(13)+CHR(13)+;
				" Nao Foi Possivel Abrir CUPOM FISCAL. Faturamento Nao "+;
				"Iniciado. "+CHR(13)+;
				" CUPOM ANTERIOR [ REGISTRO nro: "+LSnronf+;
				" CUPOM nro : "+LSnrocp +"]  CONTINUA ABERTO."+;
				" Cancele Este Registro."
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.F.)
		ENDIF			

		*------ aguarda atualizacao do nro cupom pela ecf ------*

		IF "CUPOM" $ LStp_proces
			IF !("REC." $ LStp_proces)
			    LFcotinua = .T.
				DO WHILE LFcotinua

		 		    =W_DEFPROC("ECF.SPR")
					LSmarca = ECFGetPropVT("TIPOECF")
					IF  LSmarca = "TESTE"
						EXIT
					ENDIF

		 		    =W_DEFPROC("ECF.SPR")
					LSstatus=ECFsituacao()
					IF ("CUPOM ABERTO" $ UPPER(LSstatus))
						=W_DEFPROC("ECF.SPR")
						m.cupom = INT(ECFnrocupom())

						
						IF  m.cupom <> LNnrocpAnt  AND m.cupom <> 0
							EXIT
						ENDIF
					ENDIF

					WAIT WINDOW ;
					"Aguardando Atualizacao do Nro do Cupom na ECF" nowait
					=INKEY(1)
					IF LASTKEY() = 27
					   LFcotinua = .f.
					ENDIF
				ENDDO
			    IF LFcotinua = .f.
					DO OBJ_MENS.SPR WITH "  ATENCAO !!! " +CHR(13)+CHR(13)+;
						" Nao Foi Possivel Obter Numero do CUPOM FISCAL."
					IF !EMPTY(LSalias) AND USED(LSalias)
						SELECT &LSalias
					ENDIF
					RETURN(.F.)
				ENDIF
			ENDIF
		ELSE
			m.cupom = 0
		ENDIF
	ENDIF

    if m.nota = 0
	  =W_DEFPROC("rotinas.spr")
      =UPerrosys("Nota com numero = 0 - Informe suporte <Enter>(Abrenota) ")
    endif



	SELE nota
	m.empresa = LNemp
	=edithand('SAVE')
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
	    SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2FH           NFFat_Item VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:    9    º
*       º Variable:            NFFat_Item                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      64                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2fh     &&  NFFat_Item VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFFat_Item
PARAMETERS LNemp,LNnota,LDdtfat,LShorafat
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Realiza todo circuito para Fturar um item
	*				CANCELAR RESERVA/REGISTRAR MOV/ATULIZAR SALDO
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNnota.........: Nro da Nota para eliminar itens
	*		LDdtfat........: Data de Faturamento
	*		LShorafat......: Hora do Faturamento
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE  LFfoundres   && f=> NAO ENCONTROU REGISTRO DE RESERVA
   	PRIVATE LNfatreg
	*------------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT orcatmp

	SELE grupo
	SET ORDER TO TAG codigo
	SEEK orcatmp.codigo
	

	*-----------------  CANCELAR AS RESERVAS --------------------*
    LFfoundres = .f.   && f=> NAO ENCONTROU REGISTRO DE RESERVA
	*------------------------------------------------------------*

   	SELECT itemmov
   	SET ORDER TO TAG itensosi
   	SEEK STR(LNemp,3)+"R"+STR(orcatmp.orcamento,7)+;
					   			orcatmp.codigo+STR(orcatmp.ordem,3)

   	IF FOUND()
	    LFfoundres = .T.   && f=> ENCONTROU REGISTRO DE RESERVA
	    SET ORDER TO TAG movimento
		=REGLOCK(.T.)
		REPLACE operacao WITH "****"   && faz o reg ser ignorado no saldo
									   && anulando seu efeito
		***********************************************************
		SELE itemmov
		LNregmov = RECNO()

		SELE itemmov
	   	=W_DEFPROC("moviment.spr")
		=MVatu_cmd(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e

		SELE itemmov
		GO LNregmov
		***********************************************************
	    SET ORDER TO TAG movimento
		=REGLOCK(.T.)
   	ENDIF
	******************** FIM CNCELAR AS RESERVAS ************************

   	SELECT orcatmp
	*-------------------------------------------------------------*
	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(orcatmp.EMPRESA,3)+STR(orcatmp.ORCAMENTO,6)
   	m.negociacao = orc_anex.negociacao  && RECUPERA O VALOR DO CAMPO
   									    && ALTERADO PELO SCATTER
	*-------------------------------------------------------------*
   	DO CASE
		CASE FOUND("GRUPO") AND grupo.TP_CONTROL = 9
	    	  m.operacao = 'SINF'   && MERA INFORMACAO SEM EFEITO ESTOQUE
		CASE tipooper.movestq = "N"
	    	  m.operacao = 'SINF'   && MERA INFORMACAO SEM EFEITO ESTOQUE
		CASE orcament.natu_oper = 1
		   IF LEFT(orcatmp.situacao,1) $ 'I'  && BAIXA REZERVA E SALDO
	    	  m.operacao = 'SVPS'   && SAIDA/VENDA/PROCESSADA/COM RESERVA
		   ELSE
    		  m.operacao = 'SVPN'   && SAIDA/VENDA/PROCESSADA/SEM RESERVA
		   ENDIF
		CASE orcament.natu_oper = 2
		   IF LEFT(orcatmp.situacao,1) $ 'I'  && BAIXA REZERVA E SALDO
		      m.operacao = 'STPS'   && SAIDA/COMERCIAL/PROC/COM RESERVA
		   ELSE
		      m.operacao = 'STPN'   && SAIDA/COMERCIAL/PROCE/SEM RESERVA
		   ENDIF
		CASE orcament.natu_oper = 3
		   IF LEFT(orcatmp.situacao,1) $ 'I'  && BAIXA REZERVA E SALDO
		      m.operacao = 'SRPS'   && SAIDA/REMESSA/PROCESSADA/COM RESERVA
		   ELSE                                && BAIXA SALDO SEM REZERVA
		      m.operacao = 'SRPN'   && SAIDA/REMESSA/PROCESSADA/SEM RESERVA
		   ENDIF
 		CASE orcament.natu_oper = 4
		   IF LEFT(orcatmp.situacao,1) $ 'I'  && BAIXA REZERVA E SALDO
		      m.operacao = 'SDPS'   && SAIDA/COMERCIAL/PROC/COM RESERVA
		   ELSE
		      m.operacao = 'SDPN'   && SAIDA/COMERCIAL/PROCE/COM RESERVA
		   ENDIF
 		CASE orcament.natu_oper = 7
	       m.operacao = 'SOPS'   && SAIDA/COMERCIAL/PROC/COM RESERVA

   	ENDCASE
	*---------------------------------------------------------------*
	* 	LSprograma ‚ uma variavel publica recebida como parametro em
	* SVD2 e que identifica a forma de operacao do sistema de
	* faturamento
	*	 	LSprograma = "VENDA"
	*		LSprograma = "BALCAO"
	*		LSprograma = "BALCAO-2"
	*---------------------------------------------------------------*
	*		LSsolicitante..: Identifica os Pontos em que esta
	*				 rotina pode ser chamada
	*			   		LSsolicitante = "VENDEDOR"
	*					LSsolicitante = "CAIXA"
	*					LSsolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					LSsolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					LSsolicitante = "IMPORTACAO"		&& SCGC008
	IF  LSsolicitante $  "VENDEDOR/CAIXA"
		m.situacao 	= "O"+RIGHT(orcatmp.situacao,1)
   	ELSE
		m.situacao 	= "OC" && FAT. PELO FAT.RISTA SEM OSI
   	ENDIF
   	m.nota 		= LNnota



    if m.nota = 0

	  =W_DEFPROC("rotinas.spr")
      =UPerrosys("Nota com numero = 0 - Informe suporte <Enter>(FatItem) ")
    endif


   	m.dtfat 	= LDdtfat
   	SELECT orcatmp
	*------------------------------------------------------------*
	SET FIELDS TO dtregis, hregis, usrregis,deletado
    SET FIELDS TO situacao
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------*
   	SELECT itemmov
   	m.sld_estq = 0
   	m.vlr_estq = 0

	m.empresa 	=	orcatmp.empresa

*	m.serie 	=	"UN"

   	m.dtfat 	= 	LDdtfat
  	m.data     	= 	LDdtfat
   	m.hora     	= 	LShorafat
	m.orcamento	=	orcatmp.orcamento
	m.operador	=	orcament.operador
	m.motivo	=	orcament.motivo

	SELE TIPOOPER
	SCATTER MEMVAR FIELDS;
		 CH_OPERA,CH_PRODU,CH_MOTIV,CH_DESTI,CH_CONTR,CH_CONDI,TIPO

	m.FAVORECIDO  =    clienc.cliente
	m.NATU_CLI    =    clienc.NATU_CLI
	m.CODFORN     =    0
	m.PRAZOMEDIO  =    orcament.PRAZOMEDIO
	m.TP_parcela  =    orcament.TP_parcela
	m.TAXA        =    orcament.TAXA
	m.DESCONTO    =    orcatmp.DESCONTO
	m.DESC_ALT    =    orcatmp.DESC_ALT
	m.USR_DALT    =    orcatmp.USR_DALT
	m.NEGOCIACAO  =    orcament.NEGOCIACAO

	IF FOUND("GRUPO") AND grupo.TP_CONTROL = 9
		m.MOVESTQ     =    "N"
	ELSE
		m.MOVESTQ     =    tipooper.MOVESTQ
	ENDIF
	m.MOVVALOR    =    tipooper.MOVVALOR
	m.MOVCUSTO    =    tipooper.MOVCUSTO
	m.INFO_VLR    =    tipooper.INFO_VLR
	m.INFO_ICMS   =    tipooper.INFO_ICMS
	m.INFO_BASE   =    tipooper.INFO_BASE


	m.ORDEM       =    orcatmp.ORDEM
	m.CODIGO      =    orcatmp.CODIGO
	m.CLASSIFICA  =    grupo.CLASSIFICA
	m.UNIDADE     =    orcatmp.UNIDADE
	m.DESCRICAO   =    orcatmp.DESCRICAO
	m.DESCRCOMPL  =    orcatmp.DESCRCOMPL
	m.INFO_COMPL  =    orcatmp.INFO_COMPL

	m.TP_MERCAD   =    orcatmp.TP_MERCAD

	=W_DEFPROC("GRUPO.SPR")
	m.peso = GRGetPeso(orcatmp.codigo)

*************************************
*  m.PESO        =    orcatmp.PESO  *
*************************************

	m.IVA         =    orcatmp.IVA
	m.CLAS_CMS    =    orcatmp.CLAS_CMS
	m.CFO         =    orcatmp.CFO
	m.ORIGEM      =    orcatmp.ORIGEM
	m.CST         =    orcatmp.CST
	m.BASE_ISS    =    orcatmp.BASE_ISS
	m.ALIQ_ISS    =    orcatmp.ALIQ_ISS
	m.VLR_ISS     =    orcatmp.VLR_ISS
	m.VLR_ISSRTD  =    orcatmp.VLR_ISSRTD
	m.BSBR_ICMS   =    orcatmp.BSBR_ICMS
	m.ALIQ_RDU    =    orcatmp.ALIQ_RDU
	m.BASE_CALC   =    orcatmp.BASE_CALC
	m.ALIQ_ICMS   =    orcatmp.ALIQ_ICMS
	m.VLR_ICMS    =    orcatmp.VLR_ICMS
	m.BASE_SBBRT  =    orcatmp.BASE_SBBRT
	m.BASE_SUBS   =    orcatmp.BASE_SUBS
	m.ICMS_SUBS   =    orcatmp.ICMS_SUBS
	m.BASE_ISENT  =    orcatmp.BASE_ISENT
	m.BASE_OUTR   =    orcatmp.BASE_OUTR
	m.BASE_ISIPI  =    orcatmp.BASE_ISIPI
	m.BASE_IPI    =    orcatmp.BASE_IPI
	m.ALIQ_IPI    =    orcatmp.ALIQ_IPI
	m.VLRIPI      =    orcatmp.VLRIPI
	m.PRECO       =    orcatmp.PRECO
	m.PRECOFINAL  =    orcatmp.PRECOFINAL
	m.QTDE        =    orcatmp.QTDE


	IF tipooper.ch_opera $ "4/2" && devolucao / transf
        LNvlr_item = (orcatmp.vlrvenda)
	ELSE
        LNvlr_item = (orcatmp.vlrvenda - orcatmp.vlripi)
	ENDIF


	m.VLRVENDA    =    LNvlr_item


	m.DESC_ADICI  =	   orcatmp.DESC_ADICI

	m.SLD_ESTQ    =    0
	m.VLR_ESTQ    =    0
	m.SLD_RESE    =    0

	
   * um erro nao identificado do sistema estava atribuindo 0
    if m.nota <> LNnota
       	m.nota 		= LNnota
    endif
    if m.nota = 0
		=W_DEFPROC("rotinas.spr")
    	=UPerrosys("Nota com numero = 0 - Informe suporte <Enter> ")
    endif


   	SELECT itemmov
	IF !(LFfoundres)
	   	=edithand('SAVE')
	ELSE
        =REGLOCK(.T.)
	   	=edithand('REGRAVA')
	ENDIF
	SET ORDER TO TAG movimento

   	=W_DEFPROC("moviment.spr")
	=MVatu_cmd(itemmov.empresa,;
				itemmov.codigo,;
				itemmov.classifica,;
				itemmov.data,;
				itemmov.hora,;
				itemmov.tipo,;
				itemmov.nota,;
				itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2FX           NFinfo_Nf VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   10    º
*       º Variable:            NFinfo_Nf                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      65                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2fx     &&  NFinfo_Nf VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFinfo_Cobr
PARAMETERS  LNemp,LNnronota,LNserie
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Fornece Numero,DataVenc. e Valor de Duplicata
	*			Formatados para RELNFS
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNnronota......: Nro da Nata p/ busca de dados
	*		LNserie........: Ordem do Doc. a ser Buscado (1,2,3..)
	*------------------------------------------------------------*
	*  RETORNO.....:   NUMERODUP+ DT.VENC + VLR.DUP
	*					99999-99 dd.mm.aa  999999,99
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA RELNFS
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSretorno
	PRIVATE LNNroDup
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LSretorno	=	REPLICATE("-",44)
	*------------------------------------------------------------*
*	IF LNemp <> 10
*		LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
*								  CHRTRAN(STR(LNserie,1)," ","0")+;
*								  STR(LNemp,1)))   && 1 => DUPLICATA
*	ELSE
*		LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
*								  CHRTRAN(STR(LNserie,1)," ","0")+;
*								  "0"))   && 1 => DUPLICATA
*	ENDIF

	LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA

	SELE duplicat
	SET ORDER TO TAG doc
	SEEK STR(LNemp,3)+STR(LNNroDup,9)


	*--------------------------------------------------------------------*
	*    Serao retornados dados para doc com :
	*			Forma de Pagamento =  3  (CHEQUE EM GARANTIA)
	*			Forma de Pagamento =  4  (DUPLICATA)
	*
	*--------------------------------------------------------------------*
	IF FOUND() AND (duplicat.tp_parcela = 2 OR duplicat.tp_parcela = 3 )

		LSretorno = TRANSF(duplicat.duplicata,"@r 999999999")
		LSretorno = LSretorno + " "+;
			   	    TRANSF(duplicat.vlr_doc,"@r 99,999.99");
				   +SPACE(1)


		IF (duplicat.dt_venc - duplicat.dt_emi) < 8
			LSretorno = LSretorno + "C/APRES."	
		ELSE



			LStmp = ;
			    STR(DAY(duplicat.dt_venc),2);
			    +"/";
			    +RIGHT(STR(MONTH(duplicat.dt_venc),2),2) ;
			    +"/";
			    +STR(YEAR(duplicat.dt_venc),4)


			LStmp =	CHRTRAN(LStmp," ","0")			

			LSretorno = LSretorno + LSTmp
			
			
		ENDIF
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2FY           NFinfoCbrSrv VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   11    º
*       º Variable:            NFinfoCbrSrv                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      66                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2fy     &&  NFinfoCbrSrv VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFinfoCbrSrv
PARAMETERS  LNemp,LNnronota,LNserie
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Fornece Numero,DataVenc. e Valor de Duplicata
	*			Formatados para RELNFS
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNnronota......: Nro da Nata p/ busca de dados
	*		LNserie........: Ordem do Doc. a ser Buscado (1,2,3..)
	*------------------------------------------------------------*
	*  RETORNO.....:   NUMERODUP+ DT.VENC + VLR.DUP
	*					99999-99 dd.mm.aa  999999,99
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA RELNFS
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSretorno
	PRIVATE LNNroDup
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LSretorno	=	REPLICATE("-",44)
	*------------------------------------------------------------*
	IF LNemp <> 10
		LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  STR(LNemp,1)))   && 1 => DUPLICATA
	ELSE
		LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  "0"))   && 1 => DUPLICATA
	ENDIF
	SELE duplicat
	SET ORDER TO TAG doc
	SEEK STR(LNemp,3)+STR(LNNroDup,9)
	*--------------------------------------------------------------------*
	*    Serao retornados dados para doc com :
	*			Forma de Pagamento =  3  (CHEQUE EM GARANTIA)
	*			Forma de Pagamento =  4  (DUPLICATA)
	*
	*--------------------------------------------------------------------*
	IF FOUND() AND (duplicat.tp_parcela = 2 OR duplicat.tp_parcela = 3 )
		LSretorno = TRANSF(duplicat.duplicata,"@r 999999999")+SPACE(1)
		IF (duplicat.dt_venc - duplicat.dt_emi) < 8
			LSretorno = LSretorno + "C/APRES."+SPACE(4)
		ELSE
			LSretorno = LSretorno + DTOC(duplicat.dt_venc)+SPACE(4)
		ENDIF

		LSretorno = LSretorno + ;
				TRANSF(duplicat.vlr_doc,"@r 999,999.99")
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2GE           NFinfoSrvCbr VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   12    º
*       º Variable:            NFinfoSrvCbr                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      67                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2ge     &&  NFinfoSrvCbr VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFinfoSrvCbr
PARAMETERS  LNemp,LNnronota,LNserie
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Fornece Numero,DataVenc. e Valor de Duplicata
	*			Formatados para RELNFS
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNnronota......: Nro da Nata p/ busca de dados
	*		LNserie........: Ordem do Doc. a ser Buscado (1,2,3..)
	*------------------------------------------------------------*
	*  RETORNO.....:   NUMERODUP+ DT.VENC + VLR.DUP
	*					99999-99 dd.mm.aa  999999,99
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA RELNFS
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSretorno
	PRIVATE LNNroDup
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LSretorno	=	REPLICATE("-",44)
	*------------------------------------------------------------*
	IF LNemp <> 10
		LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  STR(LNemp,1)))   && 1 => DUPLICATA
	ELSE
		LNNroDup = INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  "0"))   && 1 => DUPLICATA
	ENDIF
	SELE duplicat
	SET ORDER TO TAG doc
	SEEK STR(LNemp,3)+STR(LNNroDup,9)
	*--------------------------------------------------------------------*
	*    Serao retornados dados para doc com :
	*			Forma de Pagamento =  3  (CHEQUE EM GARANTIA)
	*			Forma de Pagamento =  4  (DUPLICATA)
	*
	*--------------------------------------------------------------------*
	IF FOUND() AND (duplicat.tp_parcela = 2 OR duplicat.tp_parcela = 3 )
		LSretorno = TRANSF(duplicat.duplicata,"@r 999999999")+SPACE(1)
		IF (duplicat.dt_venc - duplicat.dt_emi) < 8
			LSretorno = LSretorno + "C/APRES."+SPACE(9)
		ELSE
			LSretorno = LSretorno + DTOC(duplicat.dt_venc)+SPACE(9)
		ENDIF

		LSretorno = LSretorno + ;
				TRANSF(duplicat.vlr_doc,"@r 999,999.99")
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2GM           UNFmarcanf VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   13    º
*       º Variable:            UNFmarcanf                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      68                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2gm     &&  UNFmarcanf VALID
#REGION 3
RETURN

FUNCTION UNFmarcanf
	PARAMETERS LNflag
	SELE nota
	=REGLOCK(.T.)
	REPLACE FLAGPROCES	WITH 	LNflag	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2GS           UNFEmpMarcanf VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   14    º
*       º Variable:            UNFEmpMarcanf                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      69                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2gs     &&  UNFEmpMarcanf VALID
#REGION 3
RETURN

FUNCTION UNFempmarca
	PARAMETERS PrmFlag,PrmTp_Process,PrmOrientacao
	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)
	
	DO CASE

		* CASES ANTIGOS ==> ANTES 15/03/2006

		CASE PrmOrientacao  = "SERVICO"
			REPLACE FLAGIMPSRV 	WITH PrmFlag	

		CASE PrmTp_Process = "NOTA" OR PrmTp_Process = "NOTA/CUPOM"
			REPLACE FLAGIMPNF 	WITH PrmFlag	

		CASE PrmTp_Process = "CUPOM"
			REPLACE FLAGIMPCPM 	WITH PrmFlag	


		* CASE NOVOS ==> APOS 15/03/2006


		CASE "CUPOM" $ Prmtp_proces
			REPLACE FLAGIMPCPM 	WITH PrmFlag	

		CASE "NOTA" = Prmtp_proces ;
			AND PrmOrientacao = "PRODUTO/SERVICO"
			REPLACE FLAGIMPNF 	WITH PrmFlag	

		CASE "NOTA" = Prmtp_proces AND PrmOrientacao = "PRODUTO"
			REPLACE FLAGIMPNF 	WITH PrmFlag	

		CASE "NOTA/NF SERVICO" = Prmtp_proces ;
		   AND PrmOrientacao = "PRODUTO"
			REPLACE FLAGIMPNF 	WITH PrmFlag	

		CASE "NOTA/NF SERVICO" = Prmtp_proces ;
		   AND PrmOrientacao = "SERVICO"
			REPLACE FLAGIMPSRV 	WITH PrmFlag	

		CASE "NF SERVICO" = Prmtp_proces
			REPLACE FLAGIMPSRV 	WITH PrmFlag	


		CASE "COPIA EM NOTA" $ Prmtp_proces
			REPLACE FLAGIMPNF 	WITH PrmFlag	


		CASE "COPIA EM NF SERVICO" = Prmtp_proces
			REPLACE FLAGIMPSRV 	WITH PrmFlag	




	ENDCASE
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2GZ           ULbaixa_Saldo VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   15    º
*       º Variable:            ULbaixa_Saldo                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      70                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2gz     &&  ULbaixa_Saldo VALID
#REGION 3
RETURN

PROCEDURE ULbaixa_saldo  && VERIFICA POSSIBILIDADE DE  BAIXA  NO ESTOQUE
PARAMETERS LSsolicitante
	*----------------------------------------------------------*
   	PRIVATE LFlockReg
	PRIVATE LFabreAuto
   	LFlockReg	= .t.	&& BLOQUEAR REGISTRO
    LFabreAuto	= .f. 	&& NAO ABRIR CONTROLE AUTOMATICAMENTE
	=W_DEFPROC("ESTOQUE.SPR")
	IF !ESversaldo(orcatmp.empresa,orcatmp.codigo ,;
					wp_dtoper,orcatmp.qtde,orcatmp.qtderes,LFabreAuto,;
					LFlockReg,"SAIDA",orcament.hora_fat,tipooper.movestq)
     	RETURN .F.
   	ENDIF
	*----------------------------------------------------------*
RETURN .T.



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2H5           NFNfSrvExstCop VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   16    º
*       º Variable:            NFNfSrvExstCop                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      71                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2h5     &&  NFNfSrvExstCop VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFNfSrvExstCop
PARAMETER PrmEmpresa,PrmNota

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*-----------------------------------------------------------*
	PRIVATE LStipo,LNnf, LNcopiaNF
    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO
	PRIVATE LNemp,LNosi


	SET NEAR ON
	SELE nota
	SET ORDER TO TAG referencia
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	SET NEAR OFF


	DO WHILE !EOF() AND nota.referencia = PrmNota
		IF   (nota.nota > 2000000 and nota.nota < 3000000) ;
		  OR (nota.nota > 4000000 and nota.nota < 5000000)
			IF nota.STATUS <> 2
				IF !EMPTY(LSalias) AND USED(LSalias)
					SELECT &LSalias
				ENDIF
				RETURN(.T.)
			ENDIF
		ENDIF
		SKIP
	ENDDO
	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.F.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2HC           NFNfN1ExstCop VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   17    º
*       º Variable:            NFNfN1ExstCop                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      72                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2hc     &&  NFNfN1ExstCop VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFNfN1ExstCop
PARAMETER PrmEmpresa,PrmNota

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*-----------------------------------------------------------*
	PRIVATE LStipo,LNnf, LNcopiaNF
    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO
	PRIVATE LNemp,LNosi


	SET NEAR ON
	SELE nota
	SET ORDER TO TAG referencia
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	SET NEAR OFF

	DO WHILE !EOF() AND nota.referencia = PrmNota
		IF nota.nota < 1000000 ;
		  OR (nota.nota > 3000000 and nota.nota < 4000000)
			IF nota.STATUS <> 2
				IF !EMPTY(LSalias) AND USED(LSalias)
					SELECT &LSalias
				ENDIF
				RETURN(.T.)
			ENDIF
		ENDIF
		SKIP
	ENDDO
	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.F.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2HJ           NFProcessCopia VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   18    º
*       º Variable:            NFProcessCopia                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      73                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2hj     &&  NFProcessCopia VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFProcessCopia
PARAMETER ;
	PrmEmpresa,;
	PrmNota,;
	PrmSolicitante,;
	PrmChamadoPor,;
	PrmCopySrvAutoriza,;
	PrmCopyN1Autoriza



	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*-----------------------------------------------------------*

	PRIVATE FlgImpFatura

	FlgImpFatura = .t.

	PRIVATE LStipo,LNnf, LNcopiaNF
    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO
	PRIVATE LNemp,LNosi

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)

	IF !FOUND() OR nota.nota < 1000000 && < 1000000 nao e cupom
	   WAIT WINDOW ;
   		" Item selecionado nao e um Cumpom <ENTER>"
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SCATTER MEMVAR
	*-------------------------------------------------------------------*
	LNCtrlCupomIni = m.nota
	LNCtrlCupomFim = m.nota


	IF TYPE("LStp_proces") = "U" OR !("REC." $ LStp_proces)
	    LNnfInicio     = 0
	    LNnfFim        = 0
	    LNnfsrvIni     = 0
	    LNnfsrvFim     = 0
		LNnfCopInicio  = 0
		LNnfCopFim	   = 0
		LNSrvCopIni  = 0
		LNSrvCopFim  = 0
        LNNroRPS     = 0
	ENDIF

	LNemp        = m.empresa
	LNosi        = m.referencia
	*-------------------------------------------------------------------*
	*----------  				INICIA COPIA DO CUPOM			--------*
	*-------------------------------------------------------------------*



	LFipi = .f.
	LFproduto = .f.
	LFservico = .f.
	IF nota.totproduto > 0
		LFproduto = .T.
	ENDIF
	IF nota.totservico >0
		LFservico = .T.
	ENDIF
	IF nota.vlr_ipi > 0
		LFipi = .T.
	ENDIF


	*-----------------------------------------------------------------*
	*  DefProcessCopia - Define Processao para  emissao da copia
	*-----------------------------------------------------------------*
	*-----------------------------------------------------------*
	PRIVATE LSemi_NF,LSemi_NFe,LSemi_NFS,LSemi_NFSe,LSemi_ECF
	PRIVATE LSscr_NF,LSscr_NFe,LSscr_NFS,LSscr_NFSe,LSscr_ECF

	*------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NF = EMGetFieldValue(PrmEmpresa,"EMITE_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFe = EMGetFieldValue(PrmEmpresa,"EMITE_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFS = EMGetFieldValue(PrmEmpresa,"EMITE_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFSe = EMGetFieldValue(PrmEmpresa,"EMITE_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_ecf = EMGetFieldValue(PrmEmpresa,"EMITE_ECF")

	*------------------------------------------------------------*

	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NF = EMGetFieldValue(PrmEmpresa,"ESCRT_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFS = EMGetFieldValue(PrmEmpresa,"ESCRT_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFSe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ecf = EMGetFieldValue(PrmEmpresa,"ESCRT_ECF")


	*------------------------------------------------------------*

	*------------------------------------------------------------*

	LStp_process = ""


 	*----------------------------------------*
 	**  SE HOUVER COPIA EM NOTA N1
 	*----------------------------------------*
	IF PrmCopyN1Autoriza
		DO CASE		&& DEFINE SE HAVERA COPIA EM NOTA

			CASE  LFipi= .T.
				LStp_proces	= LStp_proces+"/COPIA EM NOTA"

			CASE  LFproduto = .T.
				LStp_proces	= LStp_proces+"/COPIA EM NOTA"

			CASE  LFservico = .T. ;
				  AND (LSemi_NFS = "N" AND LSemi_NFSe = "N")
				LStp_proces	= LStp_proces+"/COPIA EM NOTA"

		ENDCASE
	ENDIF


 	*----------------------------------------*
 	**  SE HOUVER COPIA EM NOTA SERVICO
 	*----------------------------------------*
	IF LSemi_NFS = "S" OR  LSemi_NFSe = "S"
		IF	PrmCopySrvAutoriza
			IF LFservico = .T.
					LStp_proces	= LStp_proces+"/COPIA EM NF SERVICO"
			ENDIF
		ENDIF
		*-----------------------------------------
	ENDIF


	*-----------------------------------------------------------*
	

	PrmObjetivo = "NAO INTEGRAR"

	
	DO CASE
		CASE (PrmSolicitante $ "IMPORTACAO/RECUPERACAO")


			IF "COPIA EM NF SERVICO" $ LStp_proces
				DO CASE
					CASE LSemi_NFS = "S" OR LSemi_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE
			ENDIF


			IF  "COPIA EM NOTA" $ LStp_proces
				DO CASE
					CASE LSemi_NF = "S" OR LSemi_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE

			ENDIF



		CASE (PrmSolicitante $ "RECUPERACAO")

			IF "COPIA EM NF SERVICO" $ LStp_proces
				DO CASE
					CASE LSemi_NFS = "S" OR LSemi_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE
			ENDIF


			IF  "COPIA EM NOTA" $ LStp_proces
				DO CASE
					CASE LSemi_NF = "S" OR LSemi_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE
	
			ENDIF

		OTHERWISE

			IF "COPIA EM NF SERVICO" $ LStp_proces
				DO CASE
					CASE LSemi_NFS = "S" OR LSemi_NFSe = "S" 				
		 				PrmObjetivo = "EMISSAO"

					CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE
			ENDIF


			IF  "COPIA EM NOTA" $ LStp_proces
				DO CASE
					CASE LSemi_NF = "S" OR LSemi_NFe = "S" 				
		 				PrmObjetivo = "EMISSAO"

					CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
		 				PrmObjetivo = "ESCRITURACAO"

					OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
				ENDCASE

			ENDIF
		

	ENDCASE


	*--------------------------------------------------------------*

	*--------------------------------------------------------------*

	*-----------------------------------------------------------------*
	*  GeraDocCopia - Gera Documento Fiscal de Copia
	*-----------------------------------------------------------------*


	IF  "COPIA EM NOTA" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"

		IF  "NF SERVICO" $ LStp_proces OR nota.empresa = 6
			LsOrientacao = "PRODUTO"
		ENDIF
		*--------------------------------------------*
		IF !NFGerCopia(nota.empresa,LNCtrlCupomIni,;
  	     "NOTA",LNnfCopInicio,LNnfCopFim,LSOrientacao,;
  	     (PrmSolicitante),LStp_proces,0)
			SELE orcament
			RETURN(.F.)
		ENDIF	

	ENDIF
		
		

	IF "COPIA EM NF SERVICO" $ LStp_proces
		LsOrientacao = "SERVICO"
		*--------------------------------------------*
		IF !NFGerCopia(nota.empresa,LNCtrlCupomIni,;
		 "NF SERVICO",LNSrvCopIni,LNSrvCopFim,LSOrientacao,;
			(PrmSolicitante),LStp_proces,LNNroRPS)
			SELE orcament
			RETURN(.F.)
		ENDIF	
	ENDIF

	*---------------------------------------------------------------*
	* PARA NFe GERAR DOCFISCA E DOCFISIT
	*---------------------------------------------------------------*



	*---------------------------------------------------------------*
	* PARA IMPORTACAO E RECUPERACAO NAO FAZER IMPRESSAO NEM XML NFe
	*---------------------------------------------------------------*
	=W_DEFPROC("NOTA.SPR")
	IF  PrmSolicitante $ "IMPORTACAO - RECUPERACAO"
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		=UNFempmarca(4,"COPIA EM NOTA","")
		=UNFempmarca(4,"COPIA EM NF SERVICO","")
		wp_msg = "Faturamento Concluido "
		WAIT WINDOW wp_msg NOWAIT
	    RETURN(.T.)
	ENDIF


    WAIT WINDOW "Aguarde a Impressao." NOWAIT

	*---------------------------------------------------------------*
	*   INICIO - IMPRIMIR
	*---------------------------------------------------------------*
	IF "COPIA EM NF SERVICO" $ LStp_proces
		DO CASE
  			CASE   LNemp = 8 ;
   				OR LNemp = 7 ;
   				OR LNemp = 9

				FlgImpFatura =  NFPrtCpSrvico(;
					(LNemp),(LStp_process),;
					(LNSrvCopIni))			
	
			OTHERWISE
	
				FlgImpFatura =  NF_CopNFSrvImprime(;
					(LNemp),(LNosi),(LStp_process),;
					(wp_TipoEcf),(LNecf),(LNCtrlCupomIni),;
					 (LNCtrlCupomFim),;
					(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
					(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),;
					(LNSrvCopFim))
	
		ENDCASE
	ENDIF

	IF  "COPIA EM NOTA" $ LStp_proces
	
		IF FlgImpFatura  = .T.
			FlgImpFatura =  NF_CopNF_Imprime(;
				(LNemp),(LNosi),(LStp_process),;
					(wp_TipoEcf),(LNecf),(LNCtrlCupomIni),;
					 (LNCtrlCupomFim),;
				(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))
		ENDIF
	ENDIF




	*----------------------------------------------------------------*
	PRIVATE LSobjetivo


	IF "COPIA EM NF SERVICO" $ LStp_proces
		LsOrientacao = "SERVICO"
		LSobjetivo = NFDefEnvDFis((LNemp),(LNSrvCopIni))

		IF FlgImpFatura  = .T.
			IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"
				IF !(NF_GeraDFis((LNemp),(LNSrvCopIni),LSobjetivo,;
							LsOrientacao ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao acatou"+;
					" Emissao."+;
				     " Repita o processo e se persistir a negacao entre "+;
			    	 " em contato com suporte"
				   SELE orcament
				   RETURN(.f.)
				ENDIF
			ENDIF			
		ENDIF
	ENDIF





	IF  "COPIA EM NOTA" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces OR nota.empresa = 6
			LsOrientacao = "PRODUTO"
		ENDIF
		LSobjetivo = NFDefEnvDFis((LNemp),(LNnfCopInicio))
		IF FlgImpFatura  = .T.
			IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"
				IF !(NF_GeraDFis((LNemp),(LNnfCopInicio),LSobjetivo,;
							LsOrientacao ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais nao acatou"+;
					" Emissao."+;
				     " Repita o processo e se persistir a negacao entre "+;
			    	 " em contato com suporte"
				   SELE orcament
				   RETURN(.f.)
				ENDIF
			ENDIF			
		ENDIF
	ENDIF



	=W_DEFPROC("rotinas.spr")

	*---------------------------------------------------------------*
	IF !FlgImpFatura
			
	    	WAIT WINDOW "Houve Falha no Impressao do Doc.Fiscal!!!!"
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
	ELSE
			=NF_aviso(LNEMP,LNnfCopInicio,LNCtrlCupomIni,;
						PrmSolicitante,LStp_proces)

	ENDIF
	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2I8           NFGerCopia VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   19    º
*       º Variable:            NFGerCopia                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      74                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2i8     &&  NFGerCopia VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFGerCopia
PARAMETERS PrmEmpresa,PrmCupom,PrmTpCopia,PrmCopInicio,PrmCopFim,;
           PrmOrientacao,PrmSolicitante,Prmtp_proces,PrmNroRPS
*	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno

	PRIVATE LNnotaAnterior
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*------------------------------------------------------------*
	PRIVATE LStipo,LNnf, LNcopiaNF
    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO

	**********************************************************************
	LFIMPDESCT = .F.

	******>>>> INICIO CONTROLE ARQUIVOS

	
	IF  PrmSolicitante = "IMPORTACAO"
		SELE &LSalias
	    RETURN(.T.)
	ENDIF

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmCupom,7)

	IF !FOUND() OR  nota.nota < 1000000 && < 1000000 nao e cupom
	   WAIT WINDOW ;
   		" Item selecionado nao e um Cumpom <ENTER>"
		SELE &LSalias
	    RETURN(.F.)
	ENDIF
	IF nota.status = 2
	   WAIT WINDOW ;
   		" Cupom selecionado esta Cancelado <ENTER>"
		SELE &LSalias
	    RETURN(.F.)
	ENDIF
	SCATTER MEMVAR
	*-------------------------------------------------------------------*
	*-------				INICIA COPIA DO CUPOM				--------*
	*-------------------------------------------------------------------*
	SELECT empresa
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK m.empresa				&& EMPRESA OPERADORA DO SISTEMA

	IF !FOUND()
	   WAIT WINDOW ;
   		" Recadastrar a Empresa Gereciadora do Sistema <Suporte Sistema>"
		SELE orcament
		RETURN(.f.)
	ENDIF
	IF !REGLOCK()
	   	WAIT WINDOW "Nao foi possivel bloquear reg. Empresa p/ parametros"
	   	SELE orcament
		RETURN(.f.)
	ENDIF
	SELE empresa
	m.datanf		= wp_dtoper      && REGISTRA A DATA DA GERACAO DA NF
	m.horanf		= time()		 && REGISTRA A HORA
	*------------
	m.dtfat		   = m.datanf
	m.data		   = m.datanf
	m.hora 		   = m.horanf
	*------------


	DO CASE
		CASE PrmTpCopia = "NF SERVICO"
			IF PrmCopInicio > 0
				m.nota          = PrmCopInicio
				m.rps           = PrmNroRPS

			ELSE
				m.nota          = empresa.ult_nfsrvc + 1
				m.rps           = empresa.ult_RPS + 1
			ENDIF

			IF UPPER(empresa.emite_NFSe) = "S"
				m.nota   = m.nota  + 4000000
			ENDIF

			IF m.nota < 2000000
				m.nota = m.nota + 2000000
			ENDIF
			PrmCopInicio   	= m.nota
			PrmCopFim    	= m.nota
		CASE PrmTpCopia = "NOTA"
			IF PrmCopInicio > 0
				m.nota          = PrmCopInicio
				m.rps           = 0
			ELSE
				m.nota     		= empresa.nota + 1
				m.rps           = 0

				IF UPPER(empresa.emite_NFe) = "S"
					m.nota   = m.nota  + 3000000
				ENDIF

			ENDIF


			PrmCopInicio   	= m.nota
			PrmCopFim    	= m.nota

	ENDCASE
	m.doc_cobr 		= doc_cobr
	m.referencia	= nota.nota		&& O cupom e a referencia da nota



	DO CASE
		CASE PrmTpCopia = "NF SERVICO"
			IF (m.nota > 2000001 AND m.nota <= 2999999) ;
			   OR  ;
			   (m.nota > 4000001 AND m.nota <= 5999999)
				LNnotaAnterior = VAL(SUBS(STR(m.nota - 1,7),2))
				SELE nota
				SEEK STR(m.empresa,3)+STR(m.nota - 1,7)
				IF !FOUND()
			       WAIT WINDOW ;
			        "Nro Anterior Doc Indicado"+;
			           " para Copia nao emitido. "+STR(m.nota-1,7)
				   SELE orcament
				   RETURN(.f.)
				ENDIF
		    ENDIF




		CASE PrmTpCopia = "NOTA"

			IF (m.nota > 1 AND m.nota <= 999999);
			   OR  ;
			   (m.nota > 3000001 AND m.nota <= 3999999)
				LNnotaAnterior = VAL(SUBS(STR(m.nota - 1,7),2))
				SELE nota
				SEEK STR(m.empresa,3)+STR(m.nota - 1,7)
				IF !FOUND()
			       WAIT WINDOW ;
			        "Nro Anterior Doc Indicado"+;
			           " para Copia nao emitido. "+STR(m.nota-1,7)
				   SELE orcament
			       RETURN(.f.)
			    ENDIF
		    ENDIF

	ENDCASE





	SELE nota
	SEEK STR(m.empresa,3)+STR(m.nota,7)
	IF FOUND()
       WAIT WINDOW "Nro Doc Indicado para Copia ja emitido. "+STR(m.nota,7)
	   SELE orcament
	   RETURN(.f.)
	ENDIF



	LFflgtrans = .t.


	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(PrmEmpresa,3)+STR(PrmCupom,7)

	SELE itemmov
	SET ORDER TO TAG NOTA
	SEEK STR(PrmEmpresa,3)+LEFT(m.operacao,1)+STR(PrmCupom,7)	
    ******************************************************************
   	DO WHILE !eof() AND PrmEmpresa    = itemmov.empresa ;
    				AND PrmCupom      = itemmov.nota ;
    				AND nota.operacao = LEFT(itemmov.operacao,1)
		LNctritens = 0

  		STORE 0 TO	LNsoma_vlr,LNbs_iss,LNvl_iss,LNbs_icms,;
  				LNvl_icms,LNbs_sbbrt,LNbs_subs,LNvl_subs,;
  				LNbs_isent,LNbs_outr,LNbs_isipi,LNbs_ipi,;
  				LNvl_ipi

		SELECT  itemmov



		*---------------------------------------------------*
		*  A PARTIR DE 10/09/2008 SE O NUMERO DE ITENS OCUPAR
		* MAIS DE UM FORMULARIO SERAMANTIDO O MESMO NUMERO DE
		* NF E A TATALIZACAO DAIMPRESSAO OCORRERA NA ULTIMA NF
		*------> REQUISICAO ? JOAO NUNES CONTADOR
		*---------------------------------------------------*
	
    	DO WHILE !eof() AND PrmEmpresa    = itemmov.empresa ;
    				AND PrmCupom          = itemmov.nota ;
    				AND nota.operacao = LEFT(itemmov.operacao,1)



			*---------------------------------------------------*
			*  A PARTIR DE 10/09/2008 SE O NUMERO DE ITENS OCUPAR
			* MAIS DE UM FORMULARIO SERAMANTIDO O MESMO NUMERO DE
			* NF E A TATALIZACAO DAIMPRESSAO OCORRERA NA ULTIMA NF
			*------> REQUISICAO ? JOAO NUNES CONTADOR
			*---------------------------------------------------*
			IF m.dtfat < {28.09.2008}
				IF  LNctritens >= 11
					EXIT
				ENDIF
			ENDIF
			*---------------------------------------------------*

			IF !(LEFT(itemmov.situacao,1) $ "O")
				SKIP
				LOOP
			ENDIF
			DO CASE
				CASE PrmOrientacao = "PRODUTO"
					IF itemmov.tp_mercad = 7 && SERVICO
						SKIP
						LOOP
					ENDIF
				CASE PrmOrientacao = "SERVICO"
					IF itemmov.tp_mercad <> 7 && NAO SERVICO
						SKIP
						LOOP
					ENDIF
			ENDCASE
			*-----------------------------------------------------*
			=RLOCK()
			replace  itemmov.NF_COPIA with m.nota
			*-----------------------------------------------------*
			
    		
*	        LNsoma_vlr = LNsoma_vlr + (vlrvenda - vlripi)

	        LNsoma_vlr = LNsoma_vlr + vlrvenda



    		
			LNbs_iss	= 	LNbs_iss	+	itemmov.base_iss
			LNvl_iss	= 	LNvl_iss	+	itemmov.vlr_iss
			LNbs_icms	= 	LNbs_icms	+	itemmov.base_calc
			LNvl_icms	=	LNvl_icms	+	itemmov.vlr_icms
			LNbs_sbbrt	=	LNbs_sbbrt	+	itemmov.base_sbbrt					
			LNbs_subs 	=	LNbs_subs 	+	itemmov.base_subs 					
			LNvl_subs 	=	LNvl_subs 	+	itemmov.icms_subs 					
			LNbs_isent	=	LNbs_isent	+	itemmov.base_isent					
			LNbs_outr 	=	LNbs_outr 	+	itemmov.base_outr 					
			LNbs_isipi	=	LNbs_isipi	+	itemmov.base_isipi					
			LNbs_ipi  	=	LNbs_ipi  	+	itemmov.base_ipi  					
			LNvl_ipi  	=	LNvl_ipi  	+	itemmov.vlripi   					
			*--------------------------------------------------*
			SELECT  itemmov
			SKIP
			LNctritens = LNctritens + 1
		ENDDO
		******************************************************************
		
	 	m.base_iss	=	LNbs_iss
		m.aliq_iss	=	empresa.aliq_iss
		m.vlr_iss	=	ROUND(m.base_iss * ROUND(m.aliq_iss  / 100,4),2)
		m.totservico=	LNbs_iss

		m.base_icms	=	LNbs_icms
		m.aliq_icms	= 	ORCAMENT.aliq_icms
		m.vlr_icms	=	m.base_icms * m.aliq_icms / 100

		m.base_sbbrt= 	LNbs_sbbrt
		m.base_subs	=	LNbs_subs
		m.icms_subs	=	LNvl_subs

		m.base_isipi=	LNbs_isipi
		m.base_ipi	=	LNbs_ipi
		m.vlr_ipi	=	LNvl_ipi


		m.base_isent=	LNbs_isent
		m.base_outr	=	LNbs_outr

		m.totservico =	LNbs_iss
		m.totproduto =  LNsoma_vlr - m.totservico
		m.total_nota =	LNsoma_vlr + m.icms_subs + ;
						m.vlrfrete + m.vlrseguro + ;
						m.vlr_ipi

		******************************************************************



		m.serie 	=	"U"

		m.serie 	=	NFSerie(empresa.empresa,;
		                        empresa.muni_ibge,;
		                        m.nota)





		m.tipo  		= "CPM"   		&& COPIA DE CUPOM
		m.status 		= 1
		m.operacao 		= "C"			&& COPIA
		SELE nota
		m.orcamento = NOTA.orcamento

		=edithand('SAVE')
		SELE nota
		SET ORDER TO TAG nota
		SEEK STR(PrmEmpresa,3)+STR(PrmCupom,7)

		SELECT  itemmov

		STORE 0 TO 	m.vlrfrete, m.vlrseguro
		m.nota  		= m.nota + 1

	ENDDO
	m.nota  		= m.nota - 1

	*--------------------------------------------------------*
	* AJUSTA DUPLICATAS PARA REFERNCIAREM A NF COPIA DO CUPOM
	*--------------------------------------------------------*
	IF  PrmTpCopia = "NOTA"
		=W_DEFPROC("DUPLICAT.SPR")
		=CRAlteraFatura((m.empresa),(m.referencia),(m.nota))
	ENDIF


	*--------------------------------------------------------*


	SELE empresa					&& altera parametros em empresa

	DO CASE
		CASE PrmSolicitante = "IMPORTACAO"
			m.nota          = PrmCopInicio
			PrmCopFim    	= m.nota

		CASE PrmTpCopia = "NF SERVICO"
			IF !("REC." $ Prmtp_proces)
				*---------------------------------------------------------*
				=UNFempmarca(3,"COPIA EM NF SERVICO","")
				*---------------------------------------------------------*
				DO CASE

					CASE m.nota > 2000000 and m.nota < 3000000
						REPLACE empresa.ult_nfsrvc WITH m.nota - 2000000
						REPLACE empresa.ult_RPS WITH m.RPS

					CASE m.nota > 4000000 and m.nota < 5000000
						REPLACE empresa.ult_nfsrvc WITH m.nota - 4000000
						REPLACE empresa.ult_RPS WITH m.RPS
				ENDCASE
			ENDIF

		CASE PrmTpCopia = "NOTA"
			IF !("REC." $ Prmtp_proces)
				*---------------------------------------------------------*
				=UNFempmarca(3,"COPIA EM NOTA","")
				*---------------------------------------------------------*
				REPLACE empresa.nota WITH empresa.nota + 1
			ENDIF

	ENDCASE





	PrmCopFim    	= m.nota
	*******************************************************
	*LNcopiaNF		= m.nota		&& INDICA NRO P/ RELNFS
	*******************************************************
	*---------------------------------------------------------------*
	* 				Fim  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2IR           NFverClasOSI VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   20    º
*       º Variable:            NFverClasOSI                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      75                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2ir     &&  NFverClasOSI VALID
#REGION 3
return

*---------------------------------------------------------------*


FUNCTION NFverClasOSI
PARAMETERS PrmEmpresa,PrmOrcamento

	*---------------------------------------------------------*
	*=================>>>  VERIFICA CLASSIFICACAO
	*=================>>>  SE O CLIENTES TIVER SIDO ALTERADO
	*---------------------------------------------------------*

	PRIVATE  LFretorno
	LFretorno = .t.


	LStpantnfrot = orcament.tipo   && A Rotina de Atualizcao
								   && pode alterar o tipo
								
	=W_DEFPROC("ORCAMENT.SPR")
	=ORAtlz_Clie(PrmEmpresa,PrmOrcamento)

	*---------------------------------------------------------*
	*  EM IMPORTACAO NAO RECALCULA ITENS
	*---------------------------------------------------------*
	IF LStpantnfrot <> orcament.tipo
  			wp_msg = "Atencao!!! "+CHR(13)+;
   			"  Devido a Alteracoes do Cadasto do Cliente a Operacao "+;
  				chr(13)+;
 				"Foi Reclassificada Para "+orcament.tipo+chr(13)+chr(13)+;
  				" Podendo Afetar o Valor. Verrifique e Repita a Operacao."
		=UPbeeps(.f.,wp_msg)
		SELE ORCAMENT

		*---------------------------------------------------------*
		=W_DEFPROC("ORCAMENT.SPR")
		=ORrecalc_OSI((PrmEmpresa),(PrmOrcamento))
		*---------------------------------------------------------*
		RETURN(.F.)
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2IY           NFchqLiberCred VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   21    º
*       º Variable:            NFchqLiberCred                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      76                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2iy     &&  NFchqLiberCred VALID
#REGION 3
return

*---------------------------------------------------------------*


FUNCTION NFchqLiberCred
PARAMETERS PrmEmpresa,PrmOrcamento


		*---------------------------------------------------*

		LSl = LEFT(orcament.situacao,1)
		LSr = RIGHT(orcament.situacao,1)



		IF  LSr $ "Do" AND (orcament.tp_parcela > 1)
			WAIT WINDOW ;
			"O orcamento aguarda Liberacao. Execute <Lib.Credito> "
			RETURN(.F.)
		ENDIF

		IF  LSr $ "F"
			WAIT WINDOW ;
				"O orcamento Com Credito Bloqueado. Execute <Lib.Credito> "
			RETURN(.F.)
		ENDIF

		IF LSr $ "D"
			WAIT WINDOW "OSI. Aguardando Liberacao de Credito. "
			RETURN(.F.)
		ENDIF

		*---------------------------------------------------*

	    SELE liberaco
		SET ORDER TO TAG liberacao
		SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
		IF !FOUND() OR liberaco.situacao <> "LIBE"
			WAIT WINDOW ;
				"NÆo Consta Libera‡Æo de Credito Para OSI"
			RETURN(.F.)
		ENDIF
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2J5           NFinfoCompl VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   22    º
*       º Variable:            NFinfoCompl                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      77                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2j5     &&  NFinfoCompl VALID
#REGION 3
return

*---------------------------------------------------------------*

FUNCTION NFinfoCompl
PARAMETERS PrmEmpresa,PrmOrcamento

	*****************************************************************
	* 				Inicio Informacoes Complementares
	*****************************************************************
	*------------------------------------------------------------------*
	LFretorno = .t.  		&& CASO SEJA CANCELADO VOLTA .F.
	HIDE WINDOW ALL
	*---------------------------------------------------------------*

	DO OBJFATU2.SPR WITH PrmEmpresa,PrmOrcamento,LFretorno

	*---------------------------------------------------------------*

RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2J6           FCHrot_fat VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   23    º
*       º Variable:            FCHrot_fat                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      78                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2j6     &&  FCHrot_fat VALID
#REGION 3
return

*---------------------------------------------------------------*

PROCEDURE FCHrot_fat
	=UP_fecha("orcament" ,LForcament)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("clientes" ,LFclientes)
	=UP_fecha("liberaco" ,LFliberacao)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	POP KEY 			&& reabilita teclas de atalho def. anteriormente
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2JH           NFEnvioParaFat VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   24    º
*       º Variable:            NFEnvioParaFat                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      79                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2jh     &&  NFEnvioParaFat VALID
#REGION 3
return

*---------------------------------------------------------------*

FUNCTION  NFEnvioParaFat
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()

	PRIVATE LSsitRequerida  &&   Armazena a SITUACAO requrida para
							&& a operacao e repassa a ORloc_orc

	PRIVATE LForcament,LFclienc,LFclientes,LFliberacao
	PRIVATE LSalias

	*------------------------------------------------------------*
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFclientes		= NetArq("clientes")
	LFliberacao		= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFclienc+LFclientes) > 100000  && HOUVE FALHA ABERT
		DO FCHrot_fat
		RETURN(.f.)
	ENDIF



	*****************************************************************
	* 				Inicio Verificacao de Requisitos				*
	*****************************************************************
	IF TYPE("LNecf") = "U"
		LNecf	=	0
	ENDIF

	LSsitRequerida =  "M"

	CLEAR TYPEAHEAD

	SELE orcament
	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH LSsitRequerida
	*------------------------------------------------------------*
	IF  LASTKEY() = 27
		DO FCHrot_fat
		RETURN(.f.)
	ENDIF
	CLEAR TYPEAHEAD




	LNregvolta = RECNO()


	IF orcament.valor = 0
		IF !fox_alert("Orcamento com VALOR = 0. [ Continua ? ]")
			DO FCHrot_fat
			RETURN(.f.)
		ENDIF
	ENDIF



	*---------------------------------------------------------*

	=W_DEFPROC("NOTA.SPR")
	IF !NFchq_Final((orcament.empresa),(orcament.orcamento),;
				("VENDEDOR"),.F.,.F.)
		DO FCHrot_fat
		RETURN(.F.)
	ENDIF


	*----------------------------------------------------------------*
	IF !NFverClasOSI(orcament.empresa,orcament.orcamento)
		DO FCHrot_fat
		RETURN(.F.)
	ENDIF
	*----------------------------------------------------------------*

	IF !NFchqLiberCred(orcament.empresa,orcament.orcamento)
		DO FCHrot_fat
		RETURN(.F.)
	ENDIF

	*----------------------------------------------------------------*


	IF !NFinfoCompl(orcament.empresa,orcament.orcamento)
		DO FCHrot_fat
		RETURN(.F.)
	ENDIF



	SELE orcament

	*****************************************************************
	LFretorno = .t.
	LFretorno = NFregEnvioFat(orcament.empresa, orcament.orcamento)

	DO FCHrot_fat
	UNLOCK ALL

RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2JQ           NFRecuperaFat VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   26    º
*       º Variable:            NFRecuperaFat                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      80                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2jq     &&  NFRecuperaFat VALID
#REGION 3
return

*---------------------------------------------------------------*

FUNCTION  NFRecuperaFat
	PARAMETERS  LSsolicitante,LSemcaminhar
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()

	PRIVATE LStp_proces		&& = "CUPOM", "NOTA", "NOTA/CUPOM",
							&&   "RECUP.CUPOM", "RECUP.NOTA",
							&&			 "RECUP.NOTA/CUPOM"
	PRIVATE LFservico		&&   INDICA SE EXISTE SERVICO P/ FATURAR
	PRIVATE LFflagtrans		&&   INDICA SITUACAO DE CONCLUSAO DO PROCESSO
	PRIVATE LSsitRequerida  &&   Armazena a SITUACAO requrida para
							&& a operacao e repassa a ORloc_orc

	PRIVATE LForcament,LFclienc,LFclientes,LFliberacao
	PRIVATE LSalias

	*------------------------------------------------------------*
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFclientes		= NetArq("clientes")
	LFliberacao		= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFclienc+LFclientes) > 100000  && HOUVE FALHA ABERT
		DO FCHrot_fat
		RETURN(.f.)
	ENDIF



	*****************************************************************
	* 				Inicio Verificacao de Requisitos				*
	*****************************************************************
	IF TYPE("LNecf") = "U"
		LNecf	=	0
	ENDIF
	LSsitRequerida = ""

	LSsitRequerida =  "AIMo"


	CLEAR TYPEAHEAD

	SELE orcament
	IF !EMPTY(LSsitRequerida)
		*------------------------------------------------------------*
		=W_DEFPROC("ORCAMENT.SPR")
		DO ORloc_orc WITH LSsitRequerida
		*------------------------------------------------------------*
		IF  LASTKEY() = 27
			DO FCHrot_fat
			RETURN(.f.)
		ENDIF
	ENDIF
	CLEAR TYPEAHEAD

	LNregvolta = RECNO()



	IF orcament.valor = 0
		IF !fox_alert("Orcamento com VALOR = 0. [ Continua ? ]")
			DO FCHrot_fat
			RETURN(.f.)
		ENDIF
	ENDIF




	*----------------------------------------------------------------*
	IF !NFverClasOSI(orcament.empresa,orcament.orcamento)
		DO FCHrot_fat
		RETURN(.F.)
	ENDIF

	*----------------------------------------------------------------*


	*----------------------------------------------------------------*


	SELE orcament

	*****************************************************************
	* 				Fim Informacoes Complementares
	*****************************************************************
	LFretorno = .t.




	DO SVD0205.spr with;
			 orcament.empresa,orcament.orcamento,LFretorno


	IF LFretorno
		LFretorno = NFProcessFat(orcament.empresa,;
					 orcament.orcamento,LSsolicitante)
	ENDIF


	DO FCHrot_fat
	UNLOCK ALL
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2K0           ULGerCupom VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   27    º
*       º Variable:            ULGerCupom                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      81                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2k0     &&  ULGerCupom VALID
#REGION 3
return
*---------------------------------------------------------------*
FUNCTION ULGerCupom
PARAMETERS LsOrientacao

	LNCtrlCpmIni = LNCtrlCpmIni

	IF !("REC." $ LStp_proces)
		LFabrecupom = .T. 					
	ELSE
		LFabrecupom = .F. 					
	ENDIF

	=W_DEFPROC("NOTA.SPR")
	IF !NFFatura(orcament.empresa,;
		orcament.orcamento,(LNCtrlCpmIni),(LNcupom),;
			(LStp_proces),(m.datanf),;
			(m.horanf),(PrmSolicitante),LNCtrlCpmFim,;
			(LsOrientacao),0)       && 0 = RPS
		********************************************
		SELE nota
		********************************************
		IF wp_dtsys = wp_dtoper
			IF 	!UPtransacao("ABORTAR")
				WAIT WINDOW ;
					"TRANSACAO NAO PODE SER DESFEITA"+;
					". VER SUPORTE."
			ENDIF			
		ENDIF
		SELE orcament
		RETURN(.F.)
	ENDIF

	*----------------------------------------------------------------*
	LNCtrlCpmFim = LNCtrlCpmIni

RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2K8           ULGerNFSU VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   28    º
*       º Variable:            ULGerNFSU                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      82                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2k8     &&  ULGerNFSU VALID
#REGION 3
return
*---------------------------------------------------------------*
FUNCTION ULGerNFSU
PARAMETERS LsOrientacao

	PRIVATE LNNroDocFiscal


	LNnfinicio 	   = LNnfinicio
	LNNroDocFiscal = LNnfinicio

	LFabrecupom = .F. 					
	=W_DEFPROC("NOTA.SPR")
	IF !NFFatura(orcament.empresa,;
		orcament.orcamento,(LNnfinicio),(LNcupom),;
			(LStp_proces),(m.datanf),;
			(m.horanf),(PrmSolicitante),LNnffim,;
			(LsOrientacao),0)   && 0 = RPS
		********************************************
		SELE nota
		********************************************
		IF wp_dtsys = wp_dtoper
			IF 	!UPtransacao("ABORTAR")
				WAIT WINDOW ;
					"TRANSACAO NAO PODE SER DESFEITA"+;
					". VER SUPORTE."
			ENDIF			
		ENDIF
		SELE orcament
		RETURN(.F.)
	ENDIF

	*-----------------------------------------------------------*
	LNnffim       = LNnffim
	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2KE           ULGerServicoNf VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   29    º
*       º Variable:            ULGerServicoNf                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      83                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2ke     &&  ULGerServicoNf VALID
#REGION 3
return
*---------------------------------------------------------------*
FUNCTION ULGerServicoNf
PARAMETERS LsOrientacao

	LsOrientacao = "SERVICO"

	LNnfsrvIni = LNnfsrvIni
	LFabrecupom = .F. 					
	*----------------------------------------------*
	=W_DEFPROC("NOTA.SPR")
	IF !NFFatura(orcament.empresa,orcament.orcamento,;
		(LNnfsrvIni),(LNcupom),(LStp_proces),(m.datanf),;
		(m.horanf),(PrmSolicitante),LNnfsrvFim,;
		LsOrientacao,LNNroRPS)
		***************************************
		SELE nota
		****************************************
		IF wp_dtsys = wp_dtoper
			IF 	!UPtransacao("ABORTAR")
				WAIT WINDOW ;
					"TRANSACAO NAO PODE SER"+;
					" DESFEITA. VER SUPORTE."
			ENDIF			
		ENDIF
		SELE orcament
		RETURN(.F.)
	ENDIF
	*----------------------------------------------------------------*


	LNnfsrvFim = LNnfsrvFim
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2KL           NFBloqEmpresa VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   30    º
*       º Variable:            NFBloqEmpresa                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      84                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2kl     &&  NFBloqEmpresa VALID
#REGION 3
return
*---------------------------------------------------------------*
FUNCTION NFBlocEmpresa
PARAMETERS PrmEmpresa,PrmSolicitante
	SELE empresa
	SET ORDER TO TAG empresa

	*********** SINALEIRO PARA NUMERO DA NOTA FISCAL
	*===============>>>>>  funciona como um sinaleiro
	SELECT empresa
	SET ORDER TO TAG empresa
	SEEK orcament.empresa				&& EMPRESA OPERADORA DO SISTEMA
	IF !FOUND()
	   WAIT WINDOW ;
	   	" Recadastrar a Empresa Gereciadora do Sistema <Suporte Sistema>"
	    SELE orcament
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*
	*		Importacao nao controla numero de nota pelo registro
	*	de EMPRESA portanto nao e necessario fazer bloqueio
	*---------------------------------------------------------------*



	IF PrmSolicitante <> "IMPORTACAO"
		IF !REGLOCK()
		   WAIT WINDOW ;
		   			"Nao foi possivel bloquear reg. Empresa p/ parametros"
		    SELE orcament
			RETURN(.F.)
		ENDIF
		IF empresa.FLAGIMPNF <> 4 OR empresa.FLAGIMPCPM <> 4 ;
		   empresa.FLAGIMPSRV <> 4

			DO CASE
				CASE empresa.FLAGIMPNF <> 4
					LSnronf = STR(empresa.nota,6)
					DO OBJ_MENS.SPR WITH ;
					"   ATENCAO !!! " +CHR(13)+CHR(13)+;
					" O Faturamento Anterior Gerou a Capa da NF. "+LSnronf+;
					" mas nao Concluiu com a impressao. CANCELE A"+;
					" NF."+LSnronf+;
					" e CANCELE O FORMULARIO P/ MANTER SEQUENCIA NUMERACAO"
				CASE empresa.FLAGIMPCPM <> 4
					LSnronf    = empresa.ult_cupom 						 				
					IF LSnronf < 1000000
						LSnronf = LSnronf + 1000000
					ENDIF
					LSnronf = STR(LSnronf,6)
					DO OBJ_MENS.SPR WITH ;
						"   ATENCAO !!! " +CHR(13)+CHR(13)+;
					" O Faturamento Anterior Gerou a Capa do REGISTRO "+;
							"DE CUPOM "+;
							" [NF.] Numero "+LSnronf+;
							" mas nao Concluiu com a impressao. CANCELE "+;
							"O REGISTRO"+LSnronf+" Para Proceguir."
				CASE empresa.FLAGIMPSRV <> 4
					LSnronf    = empresa.ult_nfsrvc 						 				
					IF LSnronf < 2000000
						LSnronf = LSnronf + 2000000
					ENDIF
					LSnronf = STR(LSnronf,6)
					DO OBJ_MENS.SPR WITH ;
						"   ATENCAO !!! " +CHR(13)+CHR(13)+;
					" O Faturamento Anterior Gerou a Capa do REGISTRO "+;
							"DE NF. SERVICO "+;
							" [NF.] Numero "+LSnronf+;
							" mas nao Concluiu com a impressao. CANCELE "+;
							"O REGISTRO"+LSnronf+" Para Proceguir."
			ENDCASE
    		SELE orcament
			RETURN(.F.)
		ENDIF
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2KM           NFatlzOrcament VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   32    º
*       º Variable:            NFatlzOrcament                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      85                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2km     &&  NFatlzOrcament VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFatlzOrcament

	SELECT orcament
	=REGLOCK(.T.)

	IF PrmSolicitante = "VENDEDOR" OR PrmSolicitante = "CAIXA"
		m.situacao 	= "O"+RIGHT(orcament.situacao,1)
	ELSE
		m.situacao 	= "OC"
	ENDIF



	DO CASE
    	CASE "CUPOM" $ LStp_process
			REPLACE nota     	WITH LNCtrlCpmIni
			IF "NF SERVICO" $ LStp_process
				REPLACE nfservico  	WITH LNnfsrvIni
			ELSE
				REPLACE nfservico  	WITH 0
			ENDIF
    	CASE "NOTA" $ LStp_process
			REPLACE nota     	WITH LNnfinicio
			IF "NF SERVICO" $ LStp_process
				REPLACE nfservico  	WITH LNnfsrvIni
			ELSE
				REPLACE nfservico  	WITH 0
			ENDIF
    	CASE "NF SERVICO" $ LStp_process
			REPLACE nota     	WITH LNnfsrvIni
			REPLACE nfservico  	WITH LNnfsrvIni
	ENDCASE
	
	REPLACE cupom 		WITH m.cupom
	REPLACE dt_fat 		WITH m.datanf
	REPLACE	hora_fat 	WITH m.horanf
	REPLACE qtdnfgerad 	WITH LNnffim - LNnfinicio + 1 && Nro. de NF GERADAS
	***************************
	SET FIELDS TO situacao,dtregis, hregis, usrregis,deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF

RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2L0           NF_02ImpCopia VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   34    º
*       º Variable:            NF_02ImpCopia                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      86                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2l0     &&  NF_02ImpCopia VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NF_02ImpCopia
PARAMETER PrmSolicitante, PrmCupomCopiar
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNregMarca
	PRIVATE LFcopySrvAutoriza
	PRIVATE LFcopyN1Autoriza
	PRIVATE LNEmpSelec,LNNotaSelec

	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	*------------------------------------------------------------*
	PRIVATE LSdbant, LNregvolta

	*------------------------------------------------------------*
	LFIMPDESCT = .F.


	LSdbant = ALIAS()

	LNregMarca = 0
	IF TYPE("PrmCupomCopiar") <> "N"
		PrmCupomCopiar = 0
	ENDIF

	
	IF PrmCupomCopiar = 0
		LNregMarca = NFView(" and (nota > 1000000 AND nota < 2000000)")
	ENDIF


	IF LNregMarca  > 0 or PrmCupomCopiar > 0   && SELECIONOU UMA NOTA

		SELE nota
		IF PrmCupomCopiar = 0        && selecionou no browse
			LNregMarca = recno()
			LNEmpSelec = nota.empresa
			LNNotaSelec = nota.Nota

		ELSE
			LNEmpSelec  = wp_empresa
			LNNotaSelec = PrmCupomCopiar
			
		ENDIF



		SELE nota
		SET ORDER TO TAG nota
		SEEK STR(LNEmpSelec,3)+STR(LNNotaSelec,7)

		IF !FOUND() ;
		    OR nota.nota < 1000000 ;
		    OR nota.nota > 2000000
		
		    * TESTA SE E  cupom

		   WAIT WINDOW ;
   			" Item selecionado nao e um Cumpom <ENTER>"
			IF !EMPTY(LSalias) AND USED(LSalias)	
				SELECT &LSalias
			ENDIF
			RETURN(.F.)
		ENDIF


		LFcopySrvAutoriza= .F.
		LFcopyN1Autoriza = .F.

		IF nota.totservico >0
			LFcopySrvAutoriza= !NFNfSrvExstCop(LNEmpSelec,LNNotaSelec)
		ENDIF
		
		LFcopyN1Autoriza = !NFNfN1ExstCop(LNEmpSelec,LNNotaSelec)


        IF (LFcopySrvAutoriza OR LFcopyN1Autoriza)
			    LFretorno = ;
		    	 NFProcessCopia(LNEmpSelec,LNNotaSelec, PrmSolicitante,;
		        	"ROTINA DE COPIA",LFcopySrvAutoriza, LFcopyN1Autoriza)
		ELSE
				WAIT WINDOW "Existem Copias Ativas. <ENTER>"
		ENDIF

	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2L9           NFAjustTmpItens VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   35    º
*       º Variable:            NFAjustTmpItens                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      87                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2l9     &&  NFAjustTmpItens VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFAjustTmpItens
PARAMETERS  PrmArqTmp,PrmEmpresa,PrmNota

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSretorno
	PRIVATE LNNroDup
	PRIVATE LMaxDim
	PRIVATE CtrLinhas
	PRIVATE CtrOrdem
	
	LSalias		= 	ALIAS()
	*-----------------------------------------------------------*



	SELE  &PrmArqTmp
	LMaxDim = Fcount()
    PRIVATE DIMENSION VTItem[LMaxDim]
*	INDEX ON nota,tp_mercad,ordem   TAG nota ADDITIVE
	go top

	COPY TO L:\TMP\TMITProd FOR tp_mercad <> 7

	COPY TO L:\TMP\TMITServ FOR tp_mercad = 7

	SELE 0
	USE L:\TMP\TMITProd alias TMITProd
	

	SELE 0
	USE L:\TMP\TMITServ alias TMITServ
	
	SELE  &PrmArqTmp
	zap
	pack
	
		
	*--------------------------------------------------------------*
	CtrOrdem = 1
	CtrLinhas = 0

	DO WHILE !EOF("TMITProd") OR !EOF("TMITServ")



		*-----------------------------------------
		*--> PREENCHE 21 LINHAS PARA PRODUTO
		*-----------------------------------------
		SELE TMITProd
		CtrLinhas = 0


		DO WHILE !EOF() AND CtrLinhas < 15
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1

			SCATTER TO VTItem
			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem

			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem
			REPLACE CENTROCUST   WITH "PRODUT"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas
			SELE TMITProd
			skip
		ENDDO

		SELE TMITProd
		SCATTER TO VTItem BLANK

		DO WHILE CtrLinhas  < 15
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1
			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem

			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem
			REPLACE CENTROCUST   WITH "PRODUT"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas

		
		ENDDO




		*-----------------------------------------
		*--> PREENCHE 3 LINHAS PARA Menssagem
		*-----------------------------------------
		
		SELE  &PrmArqTmp
		x=1

		FOR X = 1 TO 3
			APPEND BLANK
			GATHER FROM  VTItem

			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem

			DO CASE
				CASE X= 1
					REPLACE CENTROCUST   WITH "MSG-01"
				CASE X= 2
					REPLACE CENTROCUST   WITH "MSG-02"
				CASE X= 3
					REPLACE CENTROCUST   WITH "MSG-03"
			ENDCASE
			REPLACE Cst         WITH "*"    && linha de espaco
			CtrOrdem = CtrOrdem + 1
		NEXT
		
		
		
		*-----------------------------------------
		*--> PREENCHE 3 LINHAS PARA intervalo
		*-----------------------------------------


		SELE  &PrmArqTmp
		x=1

		FOR X = 1 TO 3
			APPEND BLANK
			GATHER FROM  VTItem

			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem
			REPLACE CENTROCUST   WITH "ESPACO"    && linha de espaco

			REPLACE Cst         WITH "*"    && linha de espaco

	
			CtrOrdem = CtrOrdem + 1
		NEXT

		*-----------------------------------------
		*--> PREENCHE 12 LINHAS PARA SERVICO
		*-----------------------------------------
		SELE TMITServ
		CtrLinhas = 0

		DO WHILE !EOF() AND CtrLinhas < 11
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1

			SCATTER TO VTItem
			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem


			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem
			REPLACE CENTROCUST   WITH "SERVIC"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas

			SELE TMITServ
			skip
		ENDDO


		SELE TMITServ
		SCATTER TO VTItem BLANK

		DO WHILE CtrLinhas  < 11
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1

			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem

			REPLACE empresa  WITH PrmEmpresa
			REPLACE nota     WITH PrmNota
			REPLACE nf_copia WITH PrmNota
			REPLACE ordem    WITH CtrOrdem
			REPLACE CENTROCUST   WITH "SERVIC"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas

		ENDDO
	ENDDO

	SELE TMITProd
	use
	SELE TMITServ
	use


	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2LM           NFLinhaProd VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   36    º
*       º Variable:            NFLinhaProd                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      88                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2lm     &&  NFLinhaProd VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFLinhaProd
PARAMETERS PrmLinha



PRIVATE Linha,LScodigo,LsDescricao,LNQtde,LNvlrUnit,LNAlqIPI


LScodigo    = IIF(LEFT(itnfstmp.codigo,5)="99999",;
              SPACE(8), LEFT(itnfstmp.codigo,8))


IF !EMPTY(itnfstmp.descrcompl)

	LsDescricao = (UPClasNbm((wp_empresa),(itnfstmp.codigo), ;
		 	  (itnfstmp.origem) ,;
		 	  (RTRIM(itnfstmp.descrcompl));
		 	  ))
ELSE

	LsDescricao = (UPClasNbm((wp_empresa),(itnfstmp.codigo), ;
		 	  (itnfstmp.origem) ,;
		 	  (RTRIM(itnfstmp.descricao)+RTRIM(itnfstmp.descrcompl));
		 	  ))
ENDIF

LsDescricao = LEFT(LsDescricao+SPACE(31),31)

LNQtde      = IIF(tipooper.ch_opera = "1" AND ;
              tipooper.ch_motiv = "3" ,0,itnfstmp.qtde)

IF itnfstmp.qtde = 0
	LNvlrUnit   = 0
ELSE
	LNvlrUnit   = itnfstmp.vlrvenda/ itnfstmp.qtde
	LNvlrUnit   = INT(LNvlrUnit * 100)/100
ENDIF


LNAlqICMS   = IIF(itnfstmp.cst $ "012",INT(itnfstmp.aliq_icms),0)
LNAlqIPI    = IIF(itnfstmp.vlripi > 0,INT(itnfstmp.aliq_ipi),0)



LSCst = IIF(EMPTY(itnfstmp.cst),"   ","0"+CHRTRAN(itnfstmp.cst," ","0")+"0")



DO CASE

	CASE itnfstmp.CENTROCUST  = "PRODUT" && LINHA DA GRID  DE PRODUTO
		Linha = ;
			LScodigo;
		   +space(1);
		   +LsDescricao;
		   +space(1);
		   +itnfstmp.cfo;
		   +space(3);
		   +LSCst;
		   +space(2);
		   +itnfstmp.unidade;
		   +space(6);
		   +TRANSFORM(LNqtde,"@Z 99999") ;
		   +space(2);
		   +TRANSFORM(LNvlrUnit,"@Z 99,999.99") ;
		   +space(5);
		   +TRANSFORM(itnfstmp.vlrvenda,"@Z 999,999.99")
		
		Linha = Linha ;
		   +space(1);
		   +TRANSFORM(LNAlqICMS,"@Z 99") ;
		   +space(4);
		   +TRANSFORM(LNAlqIPI,"@Z 99")

	CASE itnfstmp.CENTROCUST  = "MSG-01"
		Linha = ;
			orc_anex.mens3
	CASE itnfstmp.CENTROCUST  = "MSG-02"
		Linha = ;
			orc_anex.mens1
	CASE itnfstmp.CENTROCUST  = "MSG-03"
		Linha = ;
			orc_anex.mens2
	CASE itnfstmp.CENTROCUST  = "SERVIC" && LINHA DA GRID  DESERVICO
	
		Linha = ;
			LScodigo;
		   +space(1);
		   +LsDescricao;
		   +space(15);
		   +itnfstmp.cfo;
		   +space(2);
		   +LSCst;
		   +space(3);
		   +itnfstmp.unidade;
		   +space(3);
		   +TRANSFORM(LNqtde,"@Z 99999") ;
		   +space(2);
		   +TRANSFORM(LNvlrUnit,"@Z 99,999.99")

		Linha = Linha ;
		   +space(3);
		   +TRANSFORM(itnfstmp.vlrvenda,"@Z 999,999.99")

	OTHERWISE
		LINHA = " "
ENDCASE


RETURN(Linha)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2LV           NFGeraXML_NOTA VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   38    º
*       º Variable:            NFGeraXML_NOTA                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      89                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2lv     &&  NFGeraXML_NOTA VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFGeraXML_NOTA
PARAMETERS PrmEmpresa, PrmNota

	PRIVATE NFAlias

	PRIVATE  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc



	=W_DEFPROC("NOTA.SPR")
	NFAlias = NFGetAlias()


	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NF nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	PrmSerie   		= &NFAlias .Serie
	PrmTipo    		= &NFAlias .Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""
	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,RtnNro_Doc,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFGerXMLDocFiscal(PrmEmpresa,RtnMod_Doc,RtnCOD_IDFORN,;
		  PrmNota,RtnSerie_Doc )

	  	WAIT WINDOW "Nao foi possivel gerar XML EFD. <ENTER>"
		RETURN(.f.)
	ENDIF

RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2M3           NFEnviaNfe_NOTA VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   39    º
*       º Variable:            NFEnviaNfe_NOTA                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      90                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2m3     &&  NFEnviaNfe_NOTA VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFEnviaNfe_NOTA
PARAMETERS PrmEmpresa, PrmNota

	PRIVATE NFAlias

	PRIVATE  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc



	=W_DEFPROC("NOTA.SPR")
	NFAlias = NFGetAlias()


	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NF nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	PrmSerie   		= &NFAlias .Serie
	PrmTipo    		= &NFAlias .Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""
	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFGerXMLDocFiscal(PrmEmpresa,RtnMod_Doc,RtnCOD_IDFORN,;
		  RtnNro_Doc,RtnSerie_Doc )

	  	WAIT WINDOW "Nao foi possivel gerar XML EFD. <ENTER>"
		RETURN(.f.)
	ENDIF




	=W_DEFPROC("DOCFISCA.SPR")
	IF !(DFEnviaNFeXML(PrmEmpresa,RtnMod_Doc,RtnNro_Doc))
	  	WAIT WINDOW "Nao foi possivel copiar XML para NFe. <ENTER>"
		RETURN(.f.)
	ENDIF


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2M4           NFRtrnoNfe_NOTA VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   40    º
*       º Variable:            NFRtrnoNfe_NOTA                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      91                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2m4     &&  NFRtrnoNfe_NOTA VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFRtrnoNfe_NOTA
PARAMETERS PrmEmpresa, PrmNota, PrmEspera

	PRIVATE NFAlias

	PRIVATE  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc


	PRIVATE  ;
     PrmOrcamento

	IF TYPE("PrmEspera") <> "C" OR EMPTY(PrmEspera)
		PrmEspera = "ESPERA"
	ENDIF


	=W_DEFPROC("NOTA.SPR")
	NFAlias = NFGetAlias()


	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NF nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	PrmSerie   		= &NFAlias .Serie
	PrmTipo    		= &NFAlias .Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

    PrmOrcamento	= &NFAlias .referencia
	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	*-------------------------------------------------------------*

	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc




	=W_DEFPROC("DOCFISCA.SPR")

		LSstatus = (DFRespostaNFe;
		      (;
				PrmEmpresa,;
	   			RtnMod_Doc,;
	   			RtnNro_Doc,;
			     PrmEspera,;
				  RtnStatus,;
				  RtnRecibo,;
			      RtnProtocolo,;
		          RtnChvNFe,;
		          RtnJstfCanc,;
		          RtnPrtcCanc;
			  );
			)




	IF  "ERRO" $ LSstatus
		WAIT WINDOW LSstatus  NOWAIT
	ENDIF

	IF PrmTipo <> "CPM"

		=W_DEFPROC("ORCAMENT.SPR")
		IF ORLerRegistro(PrmEmpresa, PrmOrcamento)
	  	    	
    		=ORSetPropVT("NFE_STATUS",RtnStatus)
			=ORSetPropVT("NFE_RECIBO",RtnRecibo)
			=ORSetPropVT("NFE_PROTOC",RtnProtocolo)
			=ORSetPropVT("NFE_CHV",RtnChvNFe)
			=ORSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=ORSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
			=ORSalvarRegistro()
		ENDIF

	ENDIF


	IF NFLerRegistro(PrmEmpresa,PrmNota)
  	    	
	    	=NFSetPropVT("NFE_STATUS",RtnStatus)
			=NFSetPropVT("NFE_RECIBO",RtnRecibo)
			=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
			=NFSetPropVT("NFE_CHV",RtnChvNFe)
			=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)

			=NFSalvarRegistro()
	ENDIF



	=W_DEFPROC("DOCFISCA.SPR")
	IF (DFLerRegistro(PrmEmpresa,RtnMod_Doc,RtnCOD_IDFORN,;
			  RtnNRO_DOC,RtnSerie_Doc ))

 	    	=DFSetPropVT("DFISSTATUS",RtnStatus)
 	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
			=DFSetPropVT("NFE_RECIBO",RtnRecibo)
			=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
			=DFSetPropVT("NFE_CHV",RtnChvNFe)
			=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)

			=DFSalvarRegistro()
	ENDIF

RETURN






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2MM           ANTNFProcessFat VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   41    º
*       º Variable:            ANTNFProcessFat                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      92                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2mm     &&  ANTNFProcessFat VALID
#REGION 3
return
*---------------------------------------------------------------*
FUNCTION ANTNFProcessFat
PARAMETERS PrmEmpresa,LNorcamento,PrmSolicitante
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Controle o Processo de Faturamento
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		PrmEmpresa......:
	*		LNorcamento:
	*		PrmSolicitante..: Identifica os Pontos em que esta
	*				 rotina pode ser chamada
	*			   		PrmSolicitante = "VENDEDOR"
	*					PrmSolicitante = "CAIXA"
	*					PrmSolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					PrmSolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					PrmSolicitante = "IMPORTACAO"		&& SCGC008
	* 					PrmSolicitante = "RECUPERACAO"
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	*********************************************************
	*---->   (Preparacao para controle de SATUS DO PROCESSO
	*********************************************************	

	PRIVATE FlgImpFatura

	PRIVATE LNnfinicio    , LNnffim
	PRIVATE LNnfsrvIni    , LNnfsrvFim
	PRIVATE LNCtrlCpmIni, LNCtrlCpmFim
	PRIVATE LNnfCopInicio , LNnfCopFim
	PRIVATE LNSrvCopIni , LNSrvCopFim
	PRIVATE LNNroRPS


	PRIVATE LNnroNF, LNNfServico, LNCtrlCpm
	PRIVATE LNNFCop, LNnfSrvCop


    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO
	PRIVATE LNcupom
	PRIVATE LStp_process
	PRIVATE datanf,horanf,LsOrientacao
	PRIVATE LFabrecupom				&& FLAG PARA MANDAR ABIR CUPOM
	PRIVATE LFservico				&& CASO EXISTA SERVICO (TP_MERCAD = 7)
	PRIVATE LFproduto 				&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
	PRIVATE LFipi    				&& CASO EXISTA IPI > 0

	*********************************************************	
	PRIVATE LFretorno
	LFretorno = .T.

	STORE 0  TO LNnfinicio ,LNnffim
	STORE 0  TO LNnfsrvIni ,LNnfsrvFim
	STORE 0  TO LNCtrlCpmIni, LNCtrlCpmFim
	STORE 0  TO LNnfCopInicio , LNnfCopFim
	STORE 0  TO LNSrvCopIni , LNSrvCopFim
	STORE 0  TO LNnroNF, LNNfServico, LNCtrlCpm
	STORE 0  TO LNNFCop, LNnfSrvCop
	STORE 0  TO LNNroRPS
	

	STORE 0  TO LNcupom
	STORE "" TO LStp_process
	STORE {} TO datanf
	STORE "" TO horanf,LsOrientacao
    STORE .F. TO LFGerNF,LFGerNFS


	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(PrmEmpresa,3)+STR(LNorcamento,6)

	IF orcament.flgtransac = .f.
		DO OBJ_MENS.SPR WITH " O orcamento Selecionado Sofreu" +;
		" Alteracoes que Afetam Valores e Nao Foi Recalculado." +;
		CHR(13)+;
		" Reedite os Itens e Grave para Forcar o Calculo."
		RETURN(.f.)
	ENDIF
	*----------------------------------------------------------------*
	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+orcament.tipo
	IF !FOUND()
		SEEK 's'+orcament.tipo
	ENDIF
	IF !found()
		SELECT orcament
		RETURN(.f.)
	ENDIF
	*---------------------------------------------------------*
	*   (Fim Preparacao para controle de SATUS DO PROCESSO
	*---------------------------------------------------------*

    SET STEP ON

	LFservico	= .F.		&& CASO EXISTA SERVICO (TP_MERCAD = 7)
	LFproduto 	= .F.		&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
	LFIPI    	= .F.		&& CASO EXISTA IPI > 0
	*---------------------------------------------------------*

	=W_DEFPROC("NOTA.SPR")
	IF !NFchq_Final((orcament.empresa),(orcament.orcamento),;
				(PrmSolicitante),LFservico,LFproduto)
	    SELE orcament
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*
	* 				Inicio  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*

	
	IF !NFBlocEmpresa(orcament.empresa,PrmSolicitante)
	    SELE orcament
		RETURN(.F.)
	ENDIF


	*---------------------------------------------------------------*

	LFflgtrans 		= .t.
	m.LNalqicms 	= 0		&& aliquota de icms
	m.tot_fatura 	= 0		&& acumula valore de varias notas pra duplicatas


	m.nota   = 0   && utilizados para atualizar Orcamento
	m.cupom  = 0   && utilizados para atualizar Orcamento

	*---------------------------------------------------------------*
	* 		No trecho seguinte sao definidor DATA,HORA,NUMERO DE NOTA
	*	E NUMERO DE CUPOM sendo que estes dados ja vem definido no
	*	registro do orcamento quando esta IMPORTANDO ja no processo
	*	operacional normal rotinas sao ativadas para atribuir valores
	*	a estes dados
	*---------------------------------------------------------------*
	

	IF !NF_DefFat(PrmSolicitante)
   		SELE orcament
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*
	* INICIO - GERAR REGISTROS DO FATURAMENTO EM NOTA
	*--------------------------------------------------------------*


	IF  "CUPOM" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		*--------------------------------------------*
		IF !ULGerCupom(LsOrientacao)
			RETURN(.F.)
		ENDIF

	ENDIF



	IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
		LsOrientacao = "SERVICO"
		*--------------------------------------------*
		IF !ULGerServicoNf(LsOrientacao)
			RETURN(.F.)
		ENDIF


	ENDIF


	IF  "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF
		*--------------------------------------------*
		IF !ULGerNFSU(LsOrientacao)
			RETURN(.F.)
		ENDIF
	ENDIF
	=NFatlzOrcament()

	*---------------------------------------------------------------*
	* 				Fim  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*



	*---------------------------------------------------------------*
	* 				Inicio - GERAR DUPLICATAS
	*---------------------------------------------------------------*
	*----------------------------------------------------------------*
	*     O ajuste no sistema para registrar duplicatas para opera‡äes
	*  A VISTA e Para CARTåES.
	*    Como a Implanta‡Æo da VersÆo nas Filiais ocorre de maneira
	*  gradativa ‚ necess rio direcionar para rotina adequada a situa‡Æo
	*  da filial sendo:
	*    FILIAL ATUALIZADA   => CRgeradupl
	*    FILIAL N.ATUALIZADA => CRnrmgeradupl
	*----------------------------------------------------------------*

 	=W_DEFPROC("DUPLICAT.spr")

	DO CASE

		CASE  orcament.empresa = 10
			IF  dt_fat < {26.03.2008}
				DO  CRidlate26geradupl WITH;
					 (orcament.empresa),(orcament.orcamento)
			ELSE
			
				DO  CRIDLApos26geradupl WITH ;
				    (orcament.empresa),(orcament.orcamento)
			ENDIF

		CASE dt_fat >= {12.03.2008}
				DO  CRgeraDE12MAR08 WITH ;
				    (orcament.empresa),(orcament.orcamento)

		CASE dt_fat >= {10.03.2008} AND ;
			(orcament.empresa = 01 or orcament.empresa = 02)		
				DO  CRgeraDE12MAR08 WITH ;
				    (orcament.empresa),(orcament.orcamento)
		otherwise
			DO  CRgeraATE10MAR08 WITH ;
			     (orcament.empresa),(orcament.orcamento)
	ENDCASE

	*----------------------------------------------------*
    *     Registrar Comando para sistema de Caixa
	*----------------------------------------------------*
	IF !(PrmSolicitante $ "IMPORTACAO/RECUPERACAO")
		DO CASE
    		CASE "CUPOM" $ LStp_process
				=NFRgAvisoCaixa((PrmEmpresa), (LNCtrlCpmIni))
	    	CASE "NOTA" $ LStp_process
				=NFRgAvisoCaixa((PrmEmpresa), (LNnfinicio))
	    	CASE "NF SERVICO" $ LStp_process
				=NFRgAvisoCaixa((PrmEmpresa), (LNnfsrvIni))
		ENDCASE
	ENDIF
	*----------------------------------------------------------------*
	SELECT orcament
	IF wp_dtsys = wp_dtoper
		IF 	!UPtransacao("TERMINAR")
			WAIT WINDOW "TRANSACAO PERMANECEU ABERTA. VER SUPORTE."
		ENDIF			
	ENDIF

	*---------------------------------------------------------------*
	* 	Inicio - VERIFICA SE PROCESSO GERA IMPRESSAO ou DFIS
	*---------------------------------------------------------------*

	LFretorno = .T.
	IF  PrmSolicitante = "IMPORTACAO"

		=UNFempmarca(4,LStp_proces,LSOrientacao)

		wp_msg = "Faturamento Concluido "
		WAIT WINDOW wp_msg NOWAIT
	    RETURN(.T.)
	ENDIF
	IF  PrmSolicitante = "RECUPERACAO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		IF  "COPIA" $ LStp_proces
	       LFretorno = ;
		    	NFProcessCopia(orcament.empresa,LNCtrlCpmIni,;
		    	    PrmSolicitante,"ROTINA FATURAMENTO",.T.,.T.)
		ENDIF
	    RETURN(LFretorno)

	ENDIF

	*---------------------------------------------------------------*
	* 				Inicio ---- IMPRESSAO
	*---------------------------------------------------------------*
	*----------------------------------------------------------------*
	wp_msg = "Imprimindo Formularios Refrente OSI: "+;
							 STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*


	FlgImpFatura = .t.   &&
	*-------------------------------------------------------------*

    SET STEP ON
	IF "CUPOM" $ LStp_proces

		FlgImpFatura =  NF_ImpCupomFiscal(;
				(orcament.empresa),(orcament.orcamento),(LStp_process),;
				(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
				(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			
	ENDIF
	*-------------------------------------------------------------*
	IF FlgImpFatura
		IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)

			DO CASE
			
				CASE    orcament.empresa = 8 ;
				     OR orcament.empresa = 7 ;
				     OR orcament.empresa = 17 ;
				     OR orcament.empresa = 9

					FlgImpFatura =  NFPrtSrvico(;
					(orcament.empresa),(LStp_process),;
					(LNnfsrvIni))			

				OTHERWISE

					FlgImpFatura =  NF_ImpNFSrvico(;
					(orcament.empresa),(orcament.orcamento),(LStp_process),;
					(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
					(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			
			ENDCASE
		ENDIF
	ENDIF

	*-------------------------------------------------------------*

	IF FlgImpFatura
		IF "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)

			FlgImpFatura =  NF_ImpNFFiscal(;
				(orcament.empresa),(orcament.orcamento),(LStp_process),;
				(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
				(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			
		ENDIF
	ENDIF


	*---------------------------------------------------------------*
	* 				Inicio ---- GERAR DFIS + NFe + ..
	*---------------------------------------------------------------*
	*----------------------------------------------------------------*
	wp_msg = "Gerando Doc Fiscal Refrente OSI: "+;
							 STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*

***	SET STEP ON
	IF "CUPOM" $ LStp_proces
		IF FlgImpFatura
			LsOrientacao = "PRODUTO/SERVICO"
			PRIVATE LSobjetivo
			LSobjetivo = NFDefEnvDFis(PrmEmpresa,LNCtrlCpmIni)

			IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"
				IF !(NF_GeraDFis(PrmEmpresa,;
                             LNCtrlCpmIni,LSobjetivo,(LsOrientacao)))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais"+;
					" nao acatou o Emissao."+;
			     	" Repita o processo e se persistir a negacao entre "+;
		    	 	" em contato com suporte"
			   		SELE orcament
			   		FlgImpFatura = .f.
				ENDIF
			ENDIF			
		ENDIF
	ENDIF

	*-------------------------------------------------------------*
	IF FlgImpFatura
		IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
				LsOrientacao = "SERVICO"
				PRIVATE LSobjetivo
				LSobjetivo = NFDefEnvDFis(PrmEmpresa,LNnfsrvFim)

			IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"

				 IF !(NF_GeraDFis(PrmEmpresa,LNnfsrvFim,;
                                      LSobjetivo,LsOrientacao ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais"+;
					" nao acatou o Emissao."+;
			     	" Repita o processo e se persistir a negacao entre "+;
		    	 	" em contato com suporte"
			   		SELE orcament
			   		FlgImpFatura = .f.
				 ENDIF
		    ENDIF			
		ENDIF
	ENDIF
	*-------------------------------------------------------------*

	IF FlgImpFatura
		IF "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
			*--------------------------------------------------------*
			LsOrientacao = "PRODUTO/SERVICO"
			IF  "NF SERVICO" $ LStp_proces
				LsOrientacao = "PRODUTO"
			ENDIF

			PRIVATE LSobjetivo
			LSobjetivo = NFDefEnvDFis(PrmEmpresa,LNnffim)

			IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"

			 	IF !(NF_GeraDFis(PrmEmpresa,LNnffim,;
                                     LSobjetivo,LsOrientacao ))
			   		DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais"+;
					" nao acatou o Emissao."+;
		     		" Repita o processo e se persistir a negacao entre "+;
	    	 		" em contato com suporte"
		   			SELE orcament
		   			FlgImpFatura = .f.
			 	ENDIF
		    ENDIF			

			*-----------------------------------------------------*
		ENDIF
		*--------------------------------------------------------*

	ENDIF

	*---------------------------------------------------------------*
	* 	Inicio - *  DEFINIR SOLICITACAO DE COPIA
	*---------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	IF FlgImpFatura
		IF  "COPIA" $ LStp_proces
	      LFretorno = ;
	    	NF_02ImpCopia(PrmSolicitante,LNCtrlCpmIni)

		ELSE
			=NF_aviso(orcament.Empresa,LNNfinicio,LNCtrlCpmIni,;
						PrmSolicitante,LStp_proces)
		ENDIF
	ELSE

    	WAIT WINDOW "Houve Falha no Impressao do Doc.Fiscal!!!!"
		LFretorno = .F.

	ENDIF
	*----------------------------------------------------------------*
	wp_msg = " ** Faturamento Concluido ** "
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*

RETURN(LFretorno)







*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2NA           NF_ImpCupomFiscal VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   42    º
*       º Variable:            NF_ImpCupomFiscal                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      93                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2na     &&  NF_ImpCupomFiscal VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NF_ImpCupomFiscal
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------

	*--> EMITIR CUPOM SOMENTE SE NAO EMITITIR CUPOM ELETRONICO
	
	IF  EMPRESA.EMITE_CFE $ "N" ;
	    "CUPOM" $ LStp_proces

		LsOrientacao = "PRODUTO/SERVICO"
		SELE nota
		SET ORDER TO TAG NOTA
		SEEK STR(LNemp,3)+STR(LNCtrlCupomIni,7)

		SELE itemmov
		SET ORDER TO TAG itensnota
		SET NEAR ON
		SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
		SET NEAR OFF			
		*------------------------------------------------------------*
		*  INICIA GERACAO DE ARQUIVO TEMPORARIO
		*------------------------------------------------------------*
		LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
		LSaliastmp 	= "TMP" 		&&     TMP001
		LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
		IF EMPTY(LSaliastmp)
			WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
			LOOP
	 	ENDIF		

	   	=up_fecha("ITNFSTMP")
		WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
		SELE itemmov
		COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND itemmov.nota	<= LNCtrlCupomFim


		SELE 0
		USE  &LSarqtmp  ALIAS ITNFSTMP EXCL
		INDEX ON nota   TAG nota ADDITIVE
		go top
		*----------------------------------------------------------*
		SELE nota

		SET RELATION TO  operador INTO usuario
		***************************************************

		=W_DEFPROC("ECF.SPR")
		LSstatus =ECFctrlimpcupom((LNCtrlCupomIni),;
		       (LNCtrlCupomFim),(LNvalor), nota.total_nota)


		*-----------------------------------------------------------*
		*   Se nao houve erro "E" e o processo emite so "CUPOM"
		* faz a marca (4) fechando o faturamento
		*-----------------------------------------------------------*

		IF SUBS(LSstatus,7,1) = "E"

		   	=up_fecha("ITNFSTMP")
		  	SELECT &LSalias
			*--------------------------------------------------*
			DO CASE
				CASE "NCN - EXECUTADO" $ UPPER(LSstatus)
					IF !NFCancNCN(LNemp,LNCtrlCupomIni)
						wp_msg = "Cupom "+STR(LNCtrlCupomIni,7)+;
						 " nao foi cacelado. Comande Cancelamento < ENTER >"
						WAIT WINDOWS wp_msg
					   	RETURN(.f.)
					ELSE
						=UNFempmarca(4,LStp_proces,LSOrientacao)
					   	RETURN(.f.)
					ENDIF
				OTHERWISE
					IF !NFCancCupom(LNemp,LNCtrlCupomIni)
						wp_msg = "Cupom "+STR(LNCtrlCupomIni,7)+;
						 " nao foi cacelado. Comande Cancelamento < ENTER >"
						WAIT WINDOWS wp_msg
					   	RETURN(.f.)
					ELSE
						=UNFempmarca(4,LStp_proces,LSOrientacao)
					   	RETURN(.f.)
					ENDIF
					*--------------------------------------------------*
			ENDCASE
		  	SELECT &LSalias
		   	RETURN(.F.)
		ENDIF



		*----------------------------------------------------*
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		*----------------------------------------------------*

	   	=up_fecha("ITNFSTMP")
	ENDIF




	=W_DEFPROC("rotinas.spr")



	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2NP           NF_ImpNFFiscal VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   43    º
*       º Variable:            NF_ImpNFFiscal                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      94                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2np     &&  NF_ImpNFFiscal VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NF_ImpNFFiscal
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------

	*--------------------------------------------------------*
	*  IMPRESSAO DE NOTA CONVENCIONAL  (NAO NFe)
	*--------------------------------------------------------*
    *----------------------------------------------------------*
    * Se houver impressao hibrida da
    *   (NF Convencional e NFe)
    *    LNnfInicio  deve ser restaurado apos a
    *   impressao convencional
    *----------------------------------------------------------*
	LNBkpnfInicio  = LNnfInicio


	*--> N=NAO H=HOMOLOGACAO
	IF      EMPRESA.EMITE_NFE $ "NH" ;
	    AND "NOTA" $ LStp_proces ;
	    AND !("COPIA" $ LStp_proces) ;
	
	
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF

		DO WHILE LNnfinicio  <= LNnffim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfinicio,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itensnota
			SET NEAR ON
			SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

		   	=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
					WHILE nota.empresa = itemmov.empresa ;
						  AND nota.nota	= itemmov.nota
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nota   TAG nota ADDITIVE


			*-------------------------------------------------*
			*>>>   NOVO LAYOUT COM GRID PARA PRODUTO E OUTRA PARA SERV
			*-------------------------------------------------*
			=NFAjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

			*-------------------------------------------------*

			LNimpressao = RECCOUNT()
			go top

			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP

			DO CASE
				CASE   nota.empresa = 2 ;
					OR nota.empresa = 3 ;
					OR nota.empresa = 4 ;
			        OR nota.empresa = 6

					REPORT FORM relnfs6A ;
							WHILE nota.nota = LNnfinicio AND;
	  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

				OTHERWISE
					REPORT FORM relnfs6 ;
							WHILE nota.nota = LNnfinicio AND;
	  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 							NOCONSOLE TO PRINTER
			ENDCASE

			IF      EMPRESA.EMITE_NFE $ "N"
				*----------------------------------------------------*
				=UNFempmarca(4,LStp_proces,LSOrientacao)
				*----------------------------------------------------*

			ENDIF
		   	=up_fecha("ITNFSTMP")

			LNnfinicio	= LNnfinicio + 1

		ENDDO
	ENDIF

 	*--> N=NAO H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFE $ "S"
		*----------------------------------------------------*
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		*----------------------------------------------------*
	ENDIF
    *----------------------------------------------------------*

    *----------------------------------------------------------*
	LNnfInicio  = LNBkpnfInicio



	=W_DEFPROC("rotinas.spr")



	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2O8           NF_ImpNFSrvico VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   44    º
*       º Variable:            NF_ImpNFSrvico                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      95                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2o8     &&  NF_ImpNFSrvico VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NF_ImpNFSrvico
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------


	*---------- IMPRESSAO DE NOTA FISCAL DE SERVICO ------------*
	*****************************************************************
	*--> Redireciona impressora de NOTA FISCAL DE SERVICO
	* APROVEITA CAMPO WP_IMPORC que nao teve  aplicacao no sistema
	*****************************************************************


	LNBkpnfInicio  = LNnfSrvIni

	*--> N=NAO H=HOMOLOGACAO
	IF      (EMPRESA.EMITE_NFS = "S" or EMPRESA.PRINT_NFS = "S");
	    AND "NF SERVICO" $ LStp_proces ;
	    AND !("COPIA" $ LStp_proces)
		LsOrientacao = "SERVICO"
		IF !(EMPTY(ALLTRIM(wp_imporc)))
			LNmtmp =UPnometmp("tmp",2)
			DELETE FILE &LNmtmp
			RUN &wp_imporc > &LNmtmp
		ELSE
			SET PRINTER TO &wp_prtorc
		ENDIF
		*************************************************************
		*--------------------------------------------------
		DO WHILE LNnfSrvIni  <= LNnfSrvFim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfsrvIni,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itensnota
			SET NEAR ON
			SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

			=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp  FOR nota.tipo = itemmov.tipo ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND nota.nota	= itemmov.nota


			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nota   TAG nota ADDITIVE



			*-------------------------------------------------*
			*>>>   NOVO LAYOUT COM GRID PARA PRODUTO E OUTRA PARA SERV
			*-------------------------------------------------*
			=NFAjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)



			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP



			DO CASE
			
				CASE wp_dtoper < {01.05.2006}

					REPORT FORM relnfsrv ;
						WHILE nota.nota = LNnfsrvIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
							NOCONSOLE TO PRINTER
				

				CASE nota.empresa = 17
				
					REPORT FORM relnfs17 ;
						WHILE nota.nota = LNnfsrvIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

				CASE nota.empresa = 9
				
					REPORT FORM relnfs7 ;
						WHILE nota.nota = LNnfsrvIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER


				CASE nota.empresa <> 6
				
					REPORT FORM relnfs6 ;
						WHILE nota.nota = LNnfsrvIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

			

				OTHERWISE

					REPORT FORM relsrv02 ;
						WHILE nota.nota = LNnfsrvIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

			ENDCASE
	
	
	
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*

		   	=up_fecha("ITNFSTMP")
			LNnfsrvIni	= LNnfsrvIni + 1
			
		ENDDO
	ENDIF


	 LNnfSrvIni = LNBkpnfInicio

 	IF      EMPRESA.EMITE_NFSE $ "S"
		*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
		*----------------------------------------------------*
	ENDIF



	=W_DEFPROC("rotinas.spr")



	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2OR           NF_CopNF_Imprime VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   45    º
*       º Variable:            NF_CopNF_Imprime                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      96                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2or     &&  NF_CopNF_Imprime VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NF_CopNF_Imprime
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*



	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF






	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------


	*--------------------------------------------------------*
	*  IMPRESSAO CONVENCIONAL DE COPIA DE CUPOM (NAO NFe)
	*--------------------------------------------------------*


    *----------------------------------------------------------*
    * Se houver impressao hibrida sda copia
    *   (NF Convencional e NFe)
    *    LNnfCopInicio  deve ser restaurado apos a
    *   impressao convencional
    *----------------------------------------------------------*
	LNBkpnfCopInicio  = LNnfCopInicio



 	*--> N=NAO H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFE $ "NH" ;
		AND "COPIA EM NOTA" $ LStp_proces
		
		
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF

		DO WHILE LNnfCopInicio  <= LNnfCopFim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfCopInicio,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itenscopia
			SET NEAR ON
			SEEK STR(nota.empresa,3)+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		


		   	=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp FOR LEFT(itemmov.operacao,1) = "S" ;
					WHILE nota.empresa = itemmov.empresa ;
						  AND nota.nota	= itemmov.nf_copia
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nf_copia   TAG nota ADDITIVE

			*-------------------------------------------------*
			*>>>   NOVO LAYOUT COM GRID PARA PRODUTO E OUTRA PARA SERV
			*-------------------------------------------------*
			=NFAjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

			*-------------------------------------------------*

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP

			DO CASE
				CASE   nota.empresa = 2 ;
					OR nota.empresa = 3 ;
					OR nota.empresa = 4 ;
			        OR nota.empresa = 6

					REPORT FORM relnfs6A ;
						WHILE nota.nota = LNnfCopInicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

				OTHERWISE
					REPORT FORM relnfs6 ;
						WHILE nota.nota = LNnfCopInicio AND;
	  					nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
			ENDCASE


			IF      EMPRESA.EMITE_NFE $ "N"
				*----------------------------------------------------*
				=UNFempmarca(4,LStp_proces,LSOrientacao)
				*----------------------------------------------------*

			ENDIF

		   	=up_fecha("ITNFSTMP")

			LNnfCopInicio  = LNnfCopInicio + 1

		ENDDO
	ENDIF


 	*--> N=NAO H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFE $ "S" ;
		=UNFempmarca(4,"COPIA EM NOTA","")
	ENDIF
    *----------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")


	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2P8           NF_CopNFSrvImprime VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   46    º
*       º Variable:            NF_CopNFSrvImprime                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      97                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2p8     &&  NF_CopNFSrvImprime VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NF_CopNFSrvImprime
PARAMETERS ;
	LNemp,;
	LNorcament,;
	LStp_process,;
	wp_TipoEcf,;
	LNecf,;
	LNCtrlCupomIni,;
	LNCtrlCupomFim,;
	LNnfinicio,;
	LNnffim,;
	LNnfsrvIni,;
	LNnfsrvFim,;
	LNnfCopInicio,;
	LNnfCopFim,;
	LNSrvCopIni,;
	LNSrvCopFim
			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*------------------------------------------------------------*
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------

	LNBkpnfCopInicio  = LNSrvCopIni


 	*--> N=NAO H=HOMOLOGACAO
	IF      (EMPRESA.EMITE_NFS = "S" or EMPRESA.PRINT_NFS = "S");
		AND "COPIA EM NF SERVICO" $ LStp_proces

		LsOrientacao = "SERVICO"
		IF !(EMPTY(ALLTRIM(wp_imporc)))
			LNmtmp =UPnometmp("tmp",2)
			DELETE FILE &LNmtmp
			RUN &wp_imporc > &LNmtmp
		ELSE
			SET PRINTER TO &wp_prtorc
		ENDIF
		*************************************************************
		*--------------------------------------------------
		DO WHILE LNSrvCopIni  <= LNSrvCopFim

			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNSrvCopIni,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

			SELE itemmov
			SET ORDER TO TAG itenscopia
			SET NEAR ON
			SEEK STR(nota.empresa,3)+STR(nota.NOTA,7)
			SET NEAR OFF			
			*------------------------------------------------------------*

			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

	   		=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp FOR LEFT(itemmov.operacao,1) = "S" ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND nota.nota	= itemmov.nf_copia
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nf_copia   TAG nota ADDITIVE

			*-------------------------------------------------*
			*>>>   NOVO LAYOUT COM GRID PARA PRODUTO E OUTRA PARA SERV
			*-------------------------------------------------*
			=NFAjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

			*-------------------------------------------------*

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco

			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP


			DO CASE
			
				CASE wp_dtoper < {01.05.2006}

					REPORT FORM relnfsrv ;
						WHILE nota.nota = LNSrvCopIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
				

				CASE nota.empresa <> 6
				
					REPORT FORM relnfs6 ;
						WHILE nota.nota = LNSrvCopIni  AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
			

				OTHERWISE

					REPORT FORM relsrv02 ;
						WHILE nota.nota = LNSrvCopIni  AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

			ENDCASE
	

			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		   	=up_fecha("ITNFSTMP")

			LNSrvCopIni	= LNSrvCopIni + 1
		ENDDO
	ENDIF



 	*--> N=NAO H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFSE $ "S" ;
		=UNFempmarca(4,"COPIA EM NF SERVICO","")
	ENDIF


	LNSrvCopIni = LNBkpnfCopInicio
	
	=W_DEFPROC("rotinas.spr")




	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2PQ           NFAtlzDadosNFe VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   48    º
*       º Variable:            NFAtlzDadosNFe                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      98                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2pq     &&  NFAtlzDadosNFe VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFAtlzDadosNFe
PARAMETER PrmEmp,PrmDtIni,PrmDtFim




    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTA")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	=DFVerifyInst()



	SELE &ALSNota
	SET ORDER TO TAG DATA
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() AND &ALSNota .empresa = PrmEmp ;
				AND &ALSNota .data >= PrmDtIni ;
    	        AND &ALSNota .data <= PrmDtFim ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

	DO WHILE !EOF() ;
					AND	LFsegue = .t. ;
					AND &ALSNota .empresa = PrmEmp ;
					AND &ALSNota .data >= PrmDtIni ;
	                AND &ALSNota .data <= PrmDtFim
		
		=UPtermo()

		LPrmNota = &ALSNota .Nota


		if LPrmNota >= 3000000 and LPrmNota < 4000000
			
			=NFRtrnoNfe_NOTA(PrmEmp,  LPrmNota, "NAO ESPERA")

		ENDIF


		SELE  &ALSNota
		SKIP
		CTR = 	CTR + 1
	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2PZ           NFVrfSeqNroNotas VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   49    º
*       º Variable:            NFVrfSeqNroNotas                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      99                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2pz     &&  NFVrfSeqNroNotas VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFVrfSeqNroNotas
PARAMETER PrmEmp,PrmDtIni,PrmDtFim, PrmArquivoLog




    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTA")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	=DFVerifyInst()



	SELE &ALSNota
	SET ORDER TO TAG DATA
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI



	SET TALK ON
	SELECT NF.NOTA,NF.DATA ;
	FROM &ALSNota NF;
	WHERE   NF.empresa = PrmEmp ;
		AND NF.data >= PrmDtIni ;
    	AND NF.data <= PrmDtFim ;
    INTO CURSOR NFselec;
    ORDER BY NF.NOTA
	SET TALK OFF




	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	GO TOP
	LNregistro = RECNO()

	SELE NFselec

	COUNT  TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*


   	PRIVATE LSfileXML,LNroIDfileXML, LSnomeArqXml

	IF TYPE("PrmArquivoLog") = "U" OR EMPTY(PrmArquivoLog)
		LSnomeArqXml = "\TMP\SEQ_NOTA.TXT"
	ELSE
		LSnomeArqXml = PrmArquivoLog
	ENDIF
   	LSfileXML	= LSnomeArqXml



  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return
   	endif


	*---------------------------------------------------*
	PRIVATE LctrSeq, LString
	LctrSeq = NFselec.nota

	LString = "Inicio Verificacao"

	=fPuts(LNroIDfileXML,LString,LEN(LString))


	SELE NFselec
	DO WHILE !EOF() AND	LFsegue = .t.
		
		=UPtermo()

		IF 	LctrSeq <> NFselec.nota

			LString = "      "
			=fPuts(LNroIDfileXML,LString,LEN(LString))

			LString = "       -Faltam nro entre: "+;
			          STR(LctrSeq,7) +;
					  " e "+;	
			          STR( NFselec.nota ,7) +;
					  " de "+;	
			          DTOC( NFselec.data )
			
			
			=fPuts(LNroIDfileXML,LString,LEN(LString))

			LString = "      "
			=fPuts(LNroIDfileXML,LString,LEN(LString))

			LctrSeq = NFselec.nota

		ELSE

			LString = STR(LctrSeq,7) +;
					  " OK "+;
					  " de "+;	
			          DTOC( NFselec.data )

			=fPuts(LNroIDfileXML,LString,LEN(LString))
		ENDIF


		SELE  NFselec
		SKIP

		LctrSeq  = LctrSeq + 1

	ENDDO

	SELE NFselec
	USE

	LString = "Final Verificacao"

	=fPuts(LNroIDfileXML,LString,LEN(LString))

    =fclose(LNroIDfileXML)

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF






	*****************************************
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
						_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"

	******************************************

	KEYBOARD "{CTRL-F10}"
	MODIF COMM &LSnomeArqXml   NOEDIT

	*****************************************
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	HIDE MENU _MSYSMENU
	*****************************************


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2QC           NF_02DefProcess VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   50    º
*       º Variable:            NF_02DefProcess                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      100                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2qc     &&  NF_02DefProcess VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NF_02DefProcess
PARAMETERS PrmEmpresa,LStipo,LFproduto,LFservico,LFipi,;
		LDdatanf,LStp_process,PrmTpPessoa,PrmTpInscr,PrmInscricao,;
	     PrmSolicitante


	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Definir o processo que orienta o faturamento
	*		em relacao a NOTA e ou ECF
	*------------------------------------------------------------*
	* COMENTARIO..: Exitem diferencas de tratamento do ECF/NOTA
	*			entre as filiais que implicam na emissao ou nao
	*			de CUPOM ou NOTA
	*		LStp_process...: Processo definido em NF_02DefProcess
	*				LStp_proces	= "CUPOM"
	*				LStp_proces	= "CUPOM/COPIA EM NOTA"
	*				LStp_proces	= "CUPOM/COPIA EM NF SERVICO"
	*				LStp_proces	= "CUPOM/COPIA EM NOTA/COPIA EM NF SERVICO"
    *
	*				LStp_proces	= "NOTA"
	*
	*				LStp_proces	= "NF SERVICO"
	*
	*				LStp_proces	= "NOTA/NF SERVICO"
    *
	*				LStp_proces	= "REC.CUPOM"
	*				LStp_proces	= "REC.NOTA"
	*				LStp_proces	= "REC.NF SERVICO"
	*				LStp_proces	= "REC.NOTA/REC.NF SERVICO"
	*   Existem dois pocessos extras definidos na rotina que solicita
	*  copia de cupom.
	*					LStp_proces	= "COPIA CUPOM EM NOTA"
	*					LStp_proces	= "COPIA CUPOM EM NF SERVICO"
	**********************************************************************
	*  INICIO DESCRICAO DE PASSOS
	*	WP_ECF = [S]	= ECF CONECTADO EM PROCESSO NORMAL
	*			 [R]	= ECF CONECTADO EM PROCESSO DE RECUPERACAO DE DADOS	
	*
	*			 [I]	= ECF CONECTADO SEM AUTORIZACAO P/ SERVICO
	*			 [Q]	= ECF CONECTADO SEM AUTORIZACAO P/ SERVICO EM
	*						 RECUPERACAO DADOS
	*
	*			 [N]	= ECF NAO CONECTADO
	*			 [E]	= ECF NAO CONECTADO EM PROCESSO DE RECUPERACAO DADOS
	*	
	* 		Se for imprimir CUPOM (FOR (VENDA INTERNA A CONTRIBUITE
	*				ESTADUAL(1) OU INSCRITO(2) OU NAO INSCRITO(3))  OU VENDA
	*				EXTERNA PARA CONTRIBUINTE NAO INSCRITO(3))
	*	=> LER NUMERO DO CUPOM ; LER ULTIMO REGISTRO DE CUPOM (EMPRESA) ;
	*	   	DIFERENCIAR NRO. REGISTRO DO CUPOM DO NRO DE NF . COM + 100000
	**********************************************************************
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNtipo.........: Tipo da Operacao
	*		LFproduto......: Flag indicando existencia de produto
	*		LFservico......: Flag indicando existencia de servico
	*						para faturar
	*						.T. => Sera faturado servico
	*						.F. => Nao Sera faturado servico
	*------------------------------------------------------------*
	*  RETORNO.....:
	*			LStp_process : Identificacao do processo
	*
	*					FUNCAO RETORNA .T. ou .F.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSecf
	PRIVATE LSmarca

	*-----------------------------------------------------------*
	PRIVATE  LNCheque1Vlr,LNCheque2Vlr,LNCheque3Vlr,;
				 LNDinheiroVlr, LNCartaoVlr,LNTicketVlr,LNDuplicatVlr
	STORE 0 TO   LNCheque1Vlr,LNCheque2Vlr,LNCheque3Vlr,;
				 LNDinheiroVlr, LNCartaoVlr,LNTicketVlr,LNDuplicatVlr

	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	SELE parametr
	SET ORDER TO TAG EMPRESA
	SEEK PrmEmpresa
	IF !FOUND()
		GO TOP
	ENDIF
	LSecf		= parametr.usa_ecf
	LSmarca		= parametr.tipo_ecf

	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 's'+LStipo
	IF !FOUND()
		SEEK 'S'+LStipo  	
	ENDIF
	IF !FOUND()
		DO OBJ_MENS.SPR WITH ;
	   		"Nao foi possivel Localizar Tipo de Operacao (TIPOOPER)."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	*<<<<<<<<<<<<<<< DEFININDO MODELO DO PROCESSO FATURAMENTO >>>>>>>>>>>>>
	*-----------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	=ORVlr_e_FormPgto(PrmEmpresa,;
		  orcament.orcamento,;
		  LNCheque1Vlr,;
		  LNDinheiroVlr,;
		  LNCartaoVlr,;
		  LNDuplicatVlr)

	=W_DEFPROC("ORCAMENT.SPR")
	LDORDtOrca=ORGetFieldValue(PrmEmpresa,orcament.orcamento,"DATA")



	*-----------------------------------------------------------*
    * 1-DEFININE DOCUMENTO FISCAL PRINCIPAL
	*-----------------------------------------------------------*
	DO CASE
		CASE LSecf $ "I/Q/S/R"	
			DO CASE
				CASE LNCartaoVlr > 0
					LStp_proces	= "CUPOM"
				CASE tipooper.ch_opera <> "1"
					LStp_proces	= "NOTA"


				CASE PrmTpPessoa <> 2 and  LDORDtOrca > {20.05.2013} 	
					LStp_proces	= "CUPOM"

  		 * REGRA DA PESSOA FISICA FOI INCLUIDA EM 13-05-2013 PQ TEM
		 * CLIENTES CLASIFICADOS COMO REVENDA + Q SAO PES. FISICA.
         * E AO ESTAVA SENDO IMPRESSO O CUPOM PARA ESTS


				CASE PrmTpPessoa = 2	&& JURIDICA
					LStp_proces	= "NOTA"

				CASE PrmTpInscr  = 1   && ESTADUAL
					LStp_proces	= "NOTA"
				CASE tipooper.ch_contr $ "13"
					LStp_proces	= "CUPOM"
				CASE tipooper.ch_contr $ "4"    && REVENDEDOR
					LStp_proces	= "NOTA"
				CASE tipooper.ch_desti = "2" AND tipooper.ch_contr $ "2"
					LStp_proces	= "NOTA"
				OTHERWISE
					LStp_proces	= "NOTA"
			ENDCASE			
		CASE LSecf $ "N"	
			LStp_proces	= "NOTA"
		OTHERWISE
			DO OBJ_MENS.SPR WITH " Nao esta definido Parametro para " +;
				"Forma de tratamento do ECF/FATURAMENTO"
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
			
	ENDCASE

	*-----------------------------------------------------------*
    * 2-DEFININE DOCUMENTOS AUXILIARES (COPIA) / NF.SERVICO
	*-----------------------------------------------------------*
	*---------------------------------------------------------*
	* AS CAPAS DAS COPIAS SAO IMPORTADAS JUNTO COM AS CAPAS
	* DAS NOTAS CANCELADAS. SENDO ASSIM NA IMPORTACAO NAO SERA
	* FEITA GERACAO DE COPIAS PELA RORINA FATURAMENTO
	*---------------------------------------------------------*
	*-----------------------------------------------------------*
	PRIVATE LSemi_NFe,LSemi_NFS,LSemi_NFSe
	
	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFe = EMGetFieldValue(PrmEmpresa,"EMITE_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFS = EMGetFieldValue(PrmEmpresa,"EMITE_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFSe = EMGetFieldValue(PrmEmpresa,"EMITE_NFSE")

	*------------------------------------------------------------*


	DO CASE
			CASE LStp_proces	= "CUPOM"


				IF PrmSolicitante <> "IMPORTACAO"

					IF  LFipi= .T. OR LFproduto = .T.
						LStp_proces	= LStp_proces+"/COPIA EM NOTA"
					ENDIF


					IF  LFservico .T. ;
					  AND (LSemi_NFS = "S" OR  LSemi_NFSe = "S")
					      LStp_proces = LStp_proces+"/COPIA EM NF SERVICO"
					ENDIF


				ENDIF

			CASE LStp_proces	= "NOTA"

				IF LSemi_NFS = "S" OR LSemi_NFSe = "S"
					DO CASE

						CASE LFservico = .T. AND LFproduto = .T.
							LStp_proces	= LStp_proces+"/NF SERVICO"

						CASE LFservico = .T. AND LFproduto = .F.
							LStp_proces	= "NF SERVICO"

					ENDCASE
				ENDIF
	ENDCASE
	*--------------------------------------------------------------*
	IF LSecf $ "Q/R/E"	OR 	PrmSolicitante $ "RECUPERACAO"
		LStp_proces	= "REC."+LStp_proces
	ENDIF



	*---------------------------------------------------------------*
	*  NA IMPORTACAO NAO HA COMO SABER A SITUACAO DOS PARAMETROS
	* NO MOMENTO DO FATURAMENTO,SENDO ASSIM A DEFINICAO DO PROCESSO
	* E FEITA CONFORME O TIPO DE DOCUMENTO GERADO NO FATURAMENTO
	*---------------------------------------------------------------*
	* NO CASO DE COPIA ELAS SAO IMPORTAS JUNTO COM AS NOTAS CANCELADAS
	* E SOMENTE AS CAPAS
	*---------------------------------------------------------------*
	

	IF PrmSolicitante $ "IMPORTACAO"

		DO CASE
			CASE  orcament.nota >= 3000000 ;
			  AND orcament.nota <= 3999999
					LStp_proces	= "NOTA"

					IF   orcament.NFSERVICO >= 2000000 ;
					 AND orcament.NFSERVICO <  3000000
					   LStp_proces	= LStp_proces+"/NF SERVICO"
					ENDIF

					IF   orcament.NFSERVICO >= 4000000 ;
					 AND orcament.NFSERVICO <  5000000
					   LStp_proces	= LStp_proces+"/NF SERVICO"
					ENDIF




			CASE  orcament.nota < 1000000  && 0 ---> 999999
					LStp_proces	= "NOTA"

					IF   orcament.NFSERVICO >= 2000000 ;
					 AND orcament.NFSERVICO <  3000000
					   LStp_proces	= LStp_proces+"/NF SERVICO"
					ENDIF

					IF   orcament.NFSERVICO >= 4000000 ;
					 AND orcament.NFSERVICO <  5000000
					   LStp_proces	= LStp_proces+"/NF SERVICO"
					ENDIF


			CASE  orcament.nota < 2000000  && 1000000 ---> 2000000
					LStp_proces	= "CUPOM"

			OTHERWISE
					LStp_proces	= "NF SERVICO"
		ENDCASE
		LStp_proces	= "REC."+LStp_proces
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2QR           NFSerie VALID                      º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   51    º
*       º Variable:            NFSerie                            º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      101                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2qr     &&  NFSerie VALID
#REGION 3
return

*---------------------------------------------------------------*
FUNCTION NFSerie
PARAMETER PrmEmpresa,PrmMuni_ibge,PrmNroNF

PRIVATE LSSerie





	DO CASE

		CASE PrmNroNF <=  999999   && NOTAS
		   LSserie = "U"
		
		   =W_DEFPROC("EMPRESA.SPR")
		   LSserie = EMGetFieldValue(PrmEmpresa,"SERIE_NF")

		CASE PrmNroNF <= 1999999   && CUPONS
		   LSserie = "U"

		CASE PrmNroNF <= 2999999   && NF SERVICO
		   LSserie = "U"

		
		   =W_DEFPROC("EMPRESA.SPR")
		   LSserie = EMGetFieldValue(PrmEmpresa,"SERIE_NFS")


		CASE PrmNroNF <= 3999999   && NFe
		   LSserie = "1"

		
		   =W_DEFPROC("EMPRESA.SPR")
		   LSserie = EMGetFieldValue(PrmEmpresa,"SERIE_NFE")


		CASE PrmNroNF <= 4999999 && and PrmEmpresa = 6  && NFSe CGB VARZEA
		
		   LSserie = "8"

		   =W_DEFPROC("EMPRESA.SPR")
		   LSserie = EMGetFieldValue(PrmEmpresa,"SERIE_NFSE")


		OTHERWISE

		   LSserie = "1"
	ENDCASE

RETURN(LSserie)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2QZ           NF_GeraDFis VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   54    º
*       º Variable:            NF_GeraDFis                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      102                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2qz     &&  NF_GeraDFis VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NF_GeraDFis
PARAMETERS PrmEmpresa, PrmNota,PrmObjetivo,PrmOrientacao,PrmExibeMsg



	IF !(PrmObjetivo $ "ESCRITURACAO/EMISSAO/CANCELAMENTO")
	    RETURN(.T.)
	ENDIF



	IF type("PrmExibeMsg") = "U"
		PrmExibeMsg	 = "SIM"
	ENDIF

	IF type("PrmExibeMsg") <> "C"
		PrmExibeMsg	 = "SIM"
	ENDIF


	PRIVATE NFAlias

	PRIVATE LSAlias
	LSalias		= 	ALIAS()




	=W_DEFPROC("NOTA.SPR")
	NFAlias = NFGetAlias()


	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NF nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"

		IF PrmExibeMsg	 = "SIM"

			WAIT WINDOW MSG

		ENDIF


	   *-----<<<< CONSIDERA A NFe MESMO COM ERRO >>>>*------						
	   RETURN(.T.)
	   *----------------------------------------------------

		RETURN(.F.)
	ENDIF


	*-->>>>>>>>>>>>>     PARA ENVIO NFE
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= &NFAlias .Serie
	PrmTipo    		= &NFAlias .Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*

	*-->>>>>>>>>>>       PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc,;
			  RtnDocEletro



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc,;
			  RtnDocEletro
	*----------------------------------------------------*

	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc,RtnDocEletro)



	IF     (PrmObjetivo $ "ESCRITURACAO") ;
	   AND "55"  $ RtnMod_Doc

       && DOCUMENTOS ELETRONICOS JA DEVEM CONSTAR NO BD
       && NAO JUSTIFICA UMA ESCRITURACAO QUE PODE
       && DUPLICAR O REGISTRO

		=W_DEFPROC("rotinas.spr")

		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF

	    RETURN(.T.)
	ENDIF






    PRIVATE LFOk_NFe

	LFOk_NFe = .T.

	=W_DEFPROC("DOCFISCA.SPR")
	LFOk_NFe = DFConvrtNFDocFiscal(PrmEmpresa,PrmNota,PrmOrientacao)



	PRIVATE LSXMLObjetivo

	LSXMLObjetivo = PrmObjetivo

	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		LFOk_NFe =(DFGerXMLDocFiscal(PrmEmpresa,;
									RtnMod_Doc,;
 						            RtnCOD_IDFORN,;
		 							RtnNro_Doc,;
		 							RtnSerie_Doc,;
		 							LSXMLObjetivo ))
	ENDIF



	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe
*--------------------------------------------------------
*   altarada para permitir a subrotina verifica se existe duplicata para o
*    doc fiscal informado
*---------------------------------------------------------
*	   LFOk_NFe = (DFEnviaNFeXML(;
*	   					PrmEmpresa,;
*	   					RtnMod_Doc,;
*	   					RtnNro_Doc))
*---------------------------------------------------------
		LFOk_NFe =(DFEnviaNFeXML(PrmEmpresa,;
									RtnMod_Doc,;
 						            RtnCOD_IDFORN,;
		 							RtnNro_Doc,;
		 							RtnSerie_Doc,;
		 							LSXMLObjetivo ))





	ENDIF

	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe
*--------------------------------------------------------
*   altarada para permitir a subrotina verifica se existe duplicata para o
*    doc fiscal informado
*---------------------------------------------------------
*		LSstatus = (DFRespostaNFe;
*		      (;
*				PrmEmpresa,;
*				RtnMod_Doc,;
*	   			RtnNro_Doc,;
*			     "ESPERA",;
*				  RtnStatus,;
*				  RtnRecibo,;
*			      RtnProtocolo,;
*		          RtnChvNFe,;
*		          RtnJstfCanc,;
*		          RtnPrtcCanc;
*			  );
*			)
*
		LSstatus = (DFRespostaNFe;
		      (;
				PrmEmpresa,;
				RtnMod_Doc,;
                RtnCOD_IDFORN,;
	   			RtnNro_Doc,;
	   			RtnSerie_Doc,;
			     "ESPERA",;
				  RtnStatus,;
				  RtnRecibo,;
			      RtnProtocolo,;
		          RtnChvNFe,;
		          RtnJstfCanc,;
		          RtnPrtcCanc;
			  );
			)




		IF "ERRO" $ LSstatus

			LSMSG = LEFT(str(PrmNota,7)+ "-" + LSstatus,225)

			IF	PrmExibeMsg	 = "SIM"

				=fox_alert(LSmsg,.t.)

			ENDIF
			
		    LFOk_NFe = .F.
		
		ENDIF

	    IF PrmObjetivo $ "EMISSAO"   AND "CANCELADA" $ LSstatus
			LSMSG = LEFT(str(PrmNota,7)+ "-" + LSstatus,225)

			IF	PrmExibeMsg	 = "SIM"

				=fox_alert(LSmsg,.t.)

			ENDIF
			
		    LFOk_NFe = .F.
        ENDIF

	ENDIF


	IF LFOk_NFe ;
     	OR (PrmObjetivo $ "EMISSAO"   AND "CANCELADA" $ LSstatus )

	
		=W_DEFPROC("NOTA.SPR")
		IF NFLerRegistro(PrmEmpresa, PrmNota)
  	    	=NFSetPropVT("NFE_STATUS",RtnStatus)
			=NFSetPropVT("NFE_RECIBO",RtnRecibo)
			=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
			=NFSetPropVT("NFE_CHV",RtnChvNFe)
			=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)

            IF RtnMod_Doc = "2D"
   			   =NFSetPropVT("CUPOM",INT(VAL(RtnRecibo)))
            ENDIF



			=NFSalvarRegistro()
		ENDIF
	ENDIF


	IF LFOk_NFe ;
     	OR (PrmObjetivo $ "EMISSAO"   AND "CANCELADA" $ LSstatus )

		=W_DEFPROC("DOCFISCA.SPR")
		IF (DFLerRegistro(PrmEmpresa,RtnMod_Doc,;
		      RtnCOD_IDFORN,;
			  RtnNro_Doc,RtnSerie_Doc ))
	  	
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)


                IF RtnMod_Doc = "2D"
   	  		       =DFSetPropVT("NRO_SERECF",RtnChvNFe)
   	  		       =DFSetPropVT("MODELO_ECF",RtnProtocolo)
   	  		       =DFSetPropVT("NRO_CPMECF",RtnRecibo)
   	  		       =DFSetPropVT("NRO_CX_ECF",RtnJstfCanc)
                ENDIF




				=DFSalvarRegistro()
		ENDIF
	ENDIF


	=W_DEFPROC("rotinas.spr")


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF


 *-----<<<< CONSIDERA A NFe MESMO COM ERRO >>>>*------						
 *  RETURN(.T.)
 *----------------------------------------------------


	*--------------------------------------------------------------*
RETURN(LFOk_NFe)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2RS           antNFDefEnvDFis VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   56    º
*       º Variable:            antNFDefEnvDFis                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      103                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2rs     &&  antNFDefEnvDFis VALID
#REGION 3
return
*---------------------------------------------------------------*

********************
FUNCTION antNFDefEnvDFis
PARAMETERS PrmEmpresa,PrmNota


	*-->>>>>>>>>>>>>     PARA ENVIO NFE
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= ""
	PrmTipo    		= ""
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*



	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	*----------------------------------------------------*

	*-----------------------------------------------------------*
	PRIVATE LSemi_NF,LSemi_NFe,LSemi_NFS,LSemi_NFSe,LSemi_ECF,LSemi_CFe
	PRIVATE LSscr_NF,LSscr_NFe,LSscr_NFS,LSscr_NFSe,LSscr_ECF,LSscr_CFe

	*------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NF = EMGetFieldValue(PrmEmpresa,"EMITE_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFe = EMGetFieldValue(PrmEmpresa,"EMITE_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFS = EMGetFieldValue(PrmEmpresa,"EMITE_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFSe = EMGetFieldValue(PrmEmpresa,"EMITE_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_ecf = EMGetFieldValue(PrmEmpresa,"EMITE_ECF")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_CFE = EMGetFieldValue(PrmEmpresa,"EMITE_CFE")

	*------------------------------------------------------------*

	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NF = EMGetFieldValue(PrmEmpresa,"ESCRT_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFS = EMGetFieldValue(PrmEmpresa,"ESCRT_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFSe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ecf = EMGetFieldValue(PrmEmpresa,"ESCRT_ECF")


	=W_DEFPROC("EMPRESA.SPR")
	LSscr_cfe = EMGetFieldValue(PrmEmpresa,"ESCRT_CFE")


	*------------------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "NAO INTEGRAR"



	DO CASE
	





		CASE  RtnMOD_DOC    =   "2D"  && CUPOM

			DO CASE

				CASE LSemi_CFe  = "S"
	 				PrmObjetivo = "EMISSAO"

				CASE LSscr_CFe  = "S"
	 				PrmObjetivo = "EMISSAO"

				CASE LSscr_ECF = "S"
	 				PrmObjetivo = "EMISSAO"

				OTHERWISE
					PrmObjetivo = "NAO INTEGRAR"
			ENDCASE

		CASE  RtnMOD_DOC    $   "03/77"  && NF SERVICO
			DO CASE
				CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
	 				PrmObjetivo = "EMISSAO"

				OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
			ENDCASE

		CASE  RtnMOD_DOC    $   "01/55"  && NF/NFe
			DO CASE
				CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
	 				PrmObjetivo = "EMISSAO"

				OTHERWISE
					PrmObjetivo = "NAO INTEGRAR"
			ENDCASE

		OTHERWISE			
				PrmObjetivo = "NAO INTEGRAR"

		ENDCASE





RETURN(PrmObjetivo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2S4           NFReenvNFe VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   57    º
*       º Variable:            NFReenvNFe                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      104                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2s4     &&  NFReenvNFe VALID
#REGION 3
RETURN

FUNCTION NFReenvNFe
PARAMETERS PrmNFFiltro

* PrmNFFiltro => EX:" and (nota < 1000000 or nota > 3000000)"

	=W_DEFPROC("NOTA.SPR")
	LNregistro = NFView(PrmNFFiltro)

	IF LNregistro > 0
	   sele nota
	   go lnregistro


		*----------------------------------------------------------------*
		DO CASE
			CASE Nota.Nota > 2000000 AND  Nota.Nota < 3000000
				LsOrientacao = "SERVICO"

			CASE Nota.Nota > 4000000 AND  Nota.Nota < 5000000
				LsOrientacao = "SERVICO"

			CASE  Nota.totservico > 0 AND Nota.totproduto > 0
				LsOrientacao = "PRODUTO/SERVICO"

			CASE  Nota.totservico > 0
				LsOrientacao = "SERVICO"

			CASE   Nota.totproduto > 0
				LsOrientacao = "PRODUTO"
			OTHERWISE
				LsOrientacao = "PRODUTO/SERVICO"

			
		ENDCASE



		*----------------------------------------------------------------*
		PRIVATE LSobjetivo, LNT,LEMP

        LNT = nota.nota
        LEMP = nota.empresa

		LSobjetivo = NFDefEnvDFis(nota.empresa,nota.nota)

		IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"
			IF !(NF_GeraDFis(nota.empresa,nota.nota,LSobjetivo,;
			      LsOrientacao ))
			   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				"  O Emissor de Documentos Fiscais nao acatou o Emissao."+;
			     " Repita o processo e se persistir a negacao entre "+;
			     " em contato com suporte"
			ENDIF
		ENDIF			
      	SELE nota
        SET ORDER TO TAG nota

        SEEK STR(LEMP,3)+STR(LNT,7)

        IF nota.nfe_status = "CANCELADA"
             =W_DEFPROC("nota.spr")
             =NFCTRLcancFatura((nota.empresa),(nota.nota),"NORMAL")
        ENDIF



	ENDIF
	=W_DEFPROC("rotinas.SPR")
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2S5           NFEscriturar VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   58    º
*       º Variable:            NFEscriturar                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      105                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2s5     &&  NFEscriturar VALID
#REGION 3
RETURN

FUNCTION NFEscriturar
PARAMETERS PrmAliasNF

	PRIVATE LsOrientacao


	   IF TYPE("PrmAliasNF") <>"C" 	
			
		 PrmAliasNF = "NOTA"
		
	   ENDIF

	   sele &PrmAliasNF


		*----------------------------------------------------------------*
		DO CASE
			CASE     &PrmAliasNF .Nota > 2000000 ;
			    AND  &PrmAliasNF .Nota < 3000000
				LsOrientacao = "SERVICO"

			CASE     &PrmAliasNF .Nota > 4000000 ;
			    AND  &PrmAliasNF .Nota < 5000000
				LsOrientacao = "SERVICO"

			CASE    &PrmAliasNF .totservico > 0 ;
			    AND &PrmAliasNF .totproduto > 0
				LsOrientacao = "PRODUTO/SERVICO"

			CASE  &PrmAliasNF .totservico > 0
				LsOrientacao = "SERVICO"

			CASE   &PrmAliasNF .totproduto > 0
				LsOrientacao = "PRODUTO"
			OTHERWISE
				LsOrientacao = "PRODUTO/SERVICO"

			
		ENDCASE



		*----------------------------------------------------------------*
		PRIVATE LSobjetivo
		LSobjetivo = "ESCRITURACAO"
        LSexibeMsg = "NAO"

		IF !(NF_GeraDFis( &PrmAliasNF .empresa, &PrmAliasNF .nota, ;
		               LSobjetivo, LsOrientacao,LSexibeMsg))

          IF LSexibeMsg = "SIM"
		   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o Emissao."+;
		     " Repita o processo e se persistir a negacao entre "+;
		     " em contato com suporte"
		  ENDIF
		ENDIF


	=W_DEFPROC("rotinas.SPR")
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2SM           NFDefMod_Doc VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   59    º
*       º Variable:            NFDefMod_Doc                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      106                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2sm     &&  NFDefMod_Doc VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFDefMod_Doc
PARAMETERS ;
	 PrmEmpresa,;
	 PrmNota,;
     PrmSerie,;
	 PrmTipo

	PRIVATE RtnMod_Doc
    RtnMod_Doc    = ""
	DO CASE

		CASE PrmNota < 1000000
		    RtnMOD_DOC    =   "01"  && CUPOM
		CASE PrmNota > 1000000 AND PrmNota < 2000000
		    RtnMOD_DOC    =   "2D"  && CUPOM
		CASE PrmNota > 2000000 AND PrmNota < 3000000
		    RtnMOD_DOC    =   "03"  && NF SERVICO
		CASE PrmNota > 3000000 AND PrmNota < 4000000
		    RtnMOD_DOC    =   "55"  && NFe
		CASE PrmNota > 4000000 AND PrmNota < 5000000
		    RtnMOD_DOC    =   "03"  && NFSe
		OTHERWISE			
			=W_DEFPROC("TIPOOPER.SPR")
			LFieldTmp    = ;
				TPGetFieldValue("S",  PrmTipo ,"Cod_Mod_Rf")
		    RtnMOD_DOC    = LFieldTmp
	ENDCASE
	

RETURN(RtnMod_Doc)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2ST           NFPrtSrvico VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   60    º
*       º Variable:            NFPrtSrvico                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      107                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2st     &&  NFPrtSrvico VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFPrtSrvico
PARAMETERS ;
	LNemp,;
	LStp_process,;
	LNNota
			
	*------------------------------------------------------------*

	



	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*


	SELE nota
	SET ORDER TO TAG NOTA
	SEEK STR(LNemp,3)+STR(LNNota,7)

	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*


	LNorcament = nota.orcamento

	*------------------------------------------------------------*


	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------


	*---------- IMPRESSAO DE NOTA FISCAL DE SERVICO ------------*
	*****************************************************************
	*--> Redireciona impressora de NOTA FISCAL DE SERVICO
	* APROVEITA CAMPO WP_IMPORC que nao teve  aplicacao no sistema
	*****************************************************************


	LNBkpnfInicio  = LNNota

    LNnfsrvIni   = LNNota
	LNnfSrvFim   = LNNota

	*--> N=NAO H=HOMOLOGACAO
	IF      (EMPRESA.EMITE_NFS = "S" or EMPRESA.PRINT_NFS = "S");
	    AND "NF SERVICO" $ LStp_proces ;
	    AND !("COPIA" $ LStp_proces)
		LsOrientacao = "SERVICO"
		IF !(EMPTY(ALLTRIM(wp_imporc)))
			LNmtmp =UPnometmp("tmp",2)
			DELETE FILE &LNmtmp
			RUN &wp_imporc > &LNmtmp
		ELSE
			SET PRINTER TO &wp_prtorc
		ENDIF
		*************************************************************
		*--------------------------------------------------
		DO WHILE LNnfSrvIni  <= LNnfSrvFim
			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNnfsrvIni,7)



			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF




			*-------------------------------------------------*


			SELE itemmov
			SET ORDER TO TAG itensnota
			SET NEAR ON
			SEEK STR(nota.empresa,3)+nota.OPERACAO+STR(nota.NOTA,7)
			SET NEAR OFF			


			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO de ITENS
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

			=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp  ;
			    FOR nota.tipo = itemmov.tipo ;
				    AND itemmov.tp_mercad = 7 ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND nota.nota	= itemmov.nota



			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nota   TAG nota ADDITIVE



			*-------------------------------------------------*
			*>>>   NOVO LAYOUT COM GRID PARA PRODUTO E OUTRA PARA SERV
			*-------------------------------------------------*

			DO CASE


			   CASE nota.empresa = 17 && ABO
					=NFABOAjustItens("ITNFSTMP",nota.empresa,nota.nota)

			   CASE nota.empresa = 8 && ARG
					=NFARGAjustItens("ITNFSTMP",nota.empresa,nota.nota)
	


				CASE nota.empresa = 7

					=NFV3AjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

				CASE nota.empresa = 9
					=NFV3AjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

			   OTHERWISE
				=NFAjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

			ENDCASE



			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco


			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP



			DO CASE
			
				CASE wp_dtoper < {01.05.2006}

					REPORT FORM relnfsrv ;
						WHILE nota.nota = LNnfsrvIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
							NOCONSOLE TO PRINTER
				

				
				CASE nota.empresa  = 17  && ABO
				
					REPORT FORM relnfs17 ;
						WHILE nota.nota = LNnfsrvIni AND;
  					   	      nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

				CASE nota.empresa  = 8  && ARG
				
					REPORT FORM relnfs7 ;
						WHILE nota.nota = LNnfsrvIni AND;
  					   	      nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

				CASE    nota.empresa = 7 ;
				     OR nota.empresa = 9
				
					REPORT FORM relnfs8 ;
						WHILE nota.nota = LNnfsrvIni AND;
  					   	      nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER


				CASE nota.empresa <> 6
				
					REPORT FORM relnfs6 ;
						WHILE nota.nota = LNnfsrvIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

			

				OTHERWISE

					REPORT FORM relsrv02 ;
						WHILE nota.nota = LNnfsrvIni AND;
  						    nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

			ENDCASE
	
	
	
			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*

		   	=up_fecha("ITNFSTMP")
			LNnfsrvIni	= LNnfsrvIni + 1
			
		ENDDO
	ENDIF


	 LNnfSrvIni = LNBkpnfInicio

 	IF      EMPRESA.EMITE_NFSE $ "S"
		*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
		*----------------------------------------------------*
	ENDIF



	=W_DEFPROC("rotinas.spr")



	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2TD           NFPrtCpSrvico VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   61    º
*       º Variable:            NFPrtCpSrvico                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      108                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2td     &&  NFPrtCpSrvico VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION NFPrtCpSrvico
PARAMETERS ;
	LNemp,;
	LStp_process,;
	LNNota

			
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar impressao NOTA/CUPOM
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LNorcament.....: Nro da OSI para Faturar
	*		LNNfInicio.....: Numero  Inicial de Nota para Impressao
	*		LNNfFim........: Numero  Final de Nota para Impressao
	*		LStp_process...: Processo definido em NF_02DefProcess
	*		wp_TipoEcf.....: Parametro Repassado para ECF
	*		LNecf..........: Parametro Repassado para ECF
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias,LFretorno
	PRIVATE LNvalor
	PRIVATE LScupom	
	PRIVATE LFcpm
	PRIVATE LSstatus
	PRIVATE LRtrnFileNfe



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc


    *--> PARA CONTROLE QUANDO HOUVER IMPRESSAO HIBRIDA
    * NOTA CONVENCIONAL + NFe
    *
	*------------------------------------------------------------*
    PRIVATE LNBkpnfInicio,LNBkpnfCopInicio


	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	LSstatus    = ""
	LRtrnFileNfe = ""
	*------------------------------------------------------------*
	*------------------------------------------------------------*


	IF "REC." $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		LsOrientacao = "SERVICO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	
	
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	*------------------------------------------------------------*


	SELE nota
	SET ORDER TO TAG NOTA
	SEEK STR(LNemp,3)+STR(LNNota,7)

	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*


	LNorcament = nota.orcamento

	*------------------------------------------------------------*

	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	SELE orc_anex
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*****************************************************************
	* 				Inicio ---- Impressao  ----
	*****************************************************************
	IF !(EMPTY(ALLTRIM(wp_impfat)))
		LNmtmp =UPnometmp("tmp",2)
		DELETE FILE &LNmtmp
		RUN &wp_impfat > &LNmtmp
	ELSE
		SET PRINTER TO &wp_prtfat
	ENDIF
	*****************************************************************



	SELE empresa					&& altera parametros em empresa
	=REGLOCK(.T.)

	IF NOT USED("TAB002")
		=NetArq("TAB002") && REABR
	ENDIF
	SELE TAB002
	SET ORDER TO TAG codigo

	SELE usuario
	SET ORDER TO TAG usuario
	SELE transprt
	SET ORDER TO TAG CGC

	SET POINT TO ","
	SET SEPARATOR  TO "."
	m.sOldError=ON('error')
	ON ERROR *
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------
	*   O cupom ‚ processado em primeiro lugar por poder agregar
	* um numero idefinido de itens
	*-----------------------------------------------------
	*--------------------------------------------------
	LNvalor = orcament.valor  && REPASSADO PARA FECHAMENTO DO CUPOM
	*--------------------------------------------------

	LNBkpnfCopInicio  = LNNota

	LNSrvCopIni  = LNNota
	LNSrvCopFim  = LNNota


 	*--> N=NAO H=HOMOLOGACAO
	IF      (EMPRESA.EMITE_NFS = "S" or EMPRESA.PRINT_NFS = "S");
		AND "COPIA EM NF SERVICO" $ LStp_proces

		LsOrientacao = "SERVICO"
		IF !(EMPTY(ALLTRIM(wp_imporc)))
			LNmtmp =UPnometmp("tmp",2)
			DELETE FILE &LNmtmp
			RUN &wp_imporc > &LNmtmp
		ELSE
			SET PRINTER TO &wp_prtorc
		ENDIF
		*************************************************************
		*--------------------------------------------------
		DO WHILE LNSrvCopIni  <= LNSrvCopFim

			SELE nota
			SET ORDER TO TAG NOTA
			SEEK STR(LNemp,3)+STR(LNSrvCopIni,7)

			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+nota.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF





			SELE itemmov
			SET ORDER TO TAG ORCAMENTO
			SET NEAR ON
			SEEK STR(nota.empresa,3)+STR(nota.orcamento,6)
			SET NEAR OFF			
			*------------------------------------------------------------*

			*------------------------------------------------------------*
			*  INICIA GERACAO DE ARQUIVO TEMPORARIO
			*------------------------------------------------------------*
			LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
			LSaliastmp 	= "TMP" 		&&     TMP001
			LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
			IF EMPTY(LSaliastmp)
				WAIT WINDOWS " Nao Foi Gerado Arq TMP. <ENTER> Continua"
				LOOP
		 	ENDIF		

	   		=up_fecha("ITNFSTMP")
			WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
			SELE itemmov
			COPY TO &LSarqtmp ;
			    FOR LEFT(itemmov.operacao,1) = "S" ;
				    AND itemmov.tp_mercad = 7 ;
				WHILE nota.empresa = itemmov.empresa ;
					  AND nota.orcamento = itemmov.orcamento
			SELE 0
			USE &LSarqtmp   ALIAS ITNFSTMP EXCL
			INDEX ON nf_copia   TAG nota ADDITIVE

			*-------------------------------------------------*
			*>>>   NOVO LAYOUT COM GRID PARA PRODUTO E OUTRA PARA SERV
			*-------------------------------------------------*

			DO CASE

			   CASE nota.empresa = 17 && ABO
					=NFABOAjustItens("ITNFSTMP",nota.empresa,nota.nota)


				CASE nota.empresa = 8 && ARG
					=NFARGAjustItens("ITNFSTMP",nota.empresa,nota.nota)
	
				CASE nota.empresa = 7

					=NFV3AjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

				CASE nota.empresa = 9
					=NFV3AjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)

				OTHERWISE
					=NFAjustTmpItens("ITNFSTMP",nota.empresa,nota.nota)
			ENDCASE


			*-------------------------------------------------*

			LNimpressao = RECCOUNT()
			go top
			*----------------------------------------------------------*
			IF NOT USED("BANCO")
				=NetArq("BANCO") && REABR
			ENDIF

			SELE banco
			SET ORDER TO TAG banco



			SELE nota
			SET RELATION TO NOTA INTO ITNFSTMP
			SET RELATION TO  operador INTO usuario 		 ADDITIVE
			SET RELATION TO  banco INTO banco  			 ADDITIVE

			SET SKIP TO ITNFSTMP



			DO CASE
			
				CASE wp_dtoper < {01.05.2006}

					REPORT FORM relnfsrv ;
						WHILE nota.nota = LNSrvCopIni AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
				



				CASE nota.empresa = 17 && ABO
								
					REPORT FORM relnfs17 ;
						WHILE nota.nota = LNSrvCopIni  AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

				CASE nota.empresa = 8 && = ARG
				
					REPORT FORM relnfs7 ;
						WHILE nota.nota = LNSrvCopIni  AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER





				CASE    nota.empresa = 7 ;
				     OR nota.empresa = 9
				
					REPORT FORM relnfs8 ;
						WHILE nota.nota = LNSrvCopIni  AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER



				CASE nota.empresa <> 6
				
					REPORT FORM relnfs6 ;
						WHILE nota.nota = LNSrvCopIni  AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER
			

				OTHERWISE

					REPORT FORM relsrv02 ;
						WHILE nota.nota = LNSrvCopIni  AND;
  						nota.empresa = LNemp AND UNFmarcanf(4) ;
	 						NOCONSOLE TO PRINTER

			ENDCASE
	







			*----------------------------------------------------*
			=UNFempmarca(4,LStp_proces,LSOrientacao)
			*----------------------------------------------------*
		   	=up_fecha("NFSTMP")
		   	=up_fecha("ITNFSTMP")

			LNSrvCopIni	= LNSrvCopIni + 1
		ENDDO
	ENDIF



 	*--> N=NAO H=HOMOLOGACAO
 	IF      EMPRESA.EMITE_NFSE $ "S" ;
		=UNFempmarca(4,"COPIA EM NF SERVICO","")
	ENDIF


	LNSrvCopIni = LNBkpnfCopInicio
	
	=W_DEFPROC("rotinas.spr")




	SELE NOTA
	SET RELATION TO
	ON ERROR &sOldError

	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("ost",2)
		DELETE FILE &LNmtmp
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2TE           NFARGAjustItens VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   62    º
*       º Variable:            NFARGAjustItens                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      109                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2te     &&  NFARGAjustItens VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFARGAjustItens
PARAMETERS  PrmArqTmp,PrmEmpresa,PrmNota

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSretorno
	PRIVATE LNNroDup
	PRIVATE LMaxDim
	PRIVATE CtrLinhas
	PRIVATE CtrOrdem
	
	LSalias		= 	ALIAS()
	*-----------------------------------------------------------*



	SELE  &PrmArqTmp
	LMaxDim = Fcount()
    PRIVATE DIMENSION VTItem[LMaxDim]
*	INDEX ON nota,tp_mercad,ordem   TAG nota ADDITIVE
	go top


	COPY TO L:\TMP\TMITServ FOR tp_mercad = 7


	SELE 0
	USE L:\TMP\TMITServ alias TMITServ
	
	SELE  &PrmArqTmp
	zap
	pack
	
		
	*--------------------------------------------------------------*
	CtrOrdem = 1
	CtrLinhas = 0

	DO WHILE !EOF("TMITServ")



		*-----------------------------------------
		*--> PREENCHE 12 LINHAS PARA SERVICO
		*-----------------------------------------
		SELE TMITServ
		CtrLinhas = 0

		DO WHILE !EOF() AND CtrLinhas < 11
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1

			SCATTER TO VTItem
			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem


			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem
			REPLACE CENTROCUST   WITH "SERVIC"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas

			SELE TMITServ
			skip
		ENDDO


		SELE TMITServ
		SCATTER TO VTItem BLANK

		DO WHILE CtrLinhas  < 11
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1

			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem

			REPLACE empresa  WITH PrmEmpresa
			REPLACE nota     WITH PrmNota
			REPLACE nf_copia WITH PrmNota
			REPLACE ordem    WITH CtrOrdem
			REPLACE CENTROCUST   WITH "SERVIC"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas

		ENDDO
	ENDDO

	SELE TMITServ
	use


	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2U9           NFARGLinhaSRVC VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   63    º
*       º Variable:            NFARGLinhaSRVC                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      110                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2u9     &&  NFARGLinhaSRVC VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFARGLinhaSRVC
PARAMETERS PrmLinha



PRIVATE Linha,LScodigo,LsDescricao,LNQtde,LNvlrUnit,LNAlqIPI


LScodigo    = IIF(LEFT(itnfstmp.codigo,5)="99999",;
              SPACE(8), LEFT(itnfstmp.codigo,8))


IF !EMPTY(itnfstmp.descrcompl)

	LsDescricao = (UPClasNbm((wp_empresa),(itnfstmp.codigo), ;
		 	  (itnfstmp.origem) ,;
		 	  (RTRIM(itnfstmp.descrcompl));
		 	  ))
ELSE

	LsDescricao = (UPClasNbm((wp_empresa),(itnfstmp.codigo), ;
		 	  (itnfstmp.origem) ,;
		 	  (RTRIM(itnfstmp.descricao)+RTRIM(itnfstmp.descrcompl));
		 	  ))
ENDIF

LsDescricao = LEFT(LsDescricao+SPACE(31),31)

LNQtde      = IIF(tipooper.ch_opera = "1" AND ;
              tipooper.ch_motiv = "3" ,0,itnfstmp.qtde)

IF itnfstmp.qtde = 0
	LNvlrUnit   = 0
ELSE
	LNvlrUnit   = itnfstmp.vlrvenda/ itnfstmp.qtde
	LNvlrUnit   = INT(LNvlrUnit * 100)/100
ENDIF


LNAlqICMS   = IIF(itnfstmp.cst $ "012",INT(itnfstmp.aliq_icms),0)
LNAlqIPI    = IIF(itnfstmp.vlripi > 0,INT(itnfstmp.aliq_ipi),0)
LNAlqISS    = INT(itnfstmp.aliq_iss)



LSCst = IIF(EMPTY(itnfstmp.cst),"   ","0"+CHRTRAN(itnfstmp.cst," ","0")+"0")



DO CASE

	CASE itnfstmp.CENTROCUST  = "PRODUT" && LINHA DA GRID  DE PRODUTO
		Linha = ;
			LScodigo;
		   +space(1);
		   +LsDescricao;
		   +space(1);
		   +itnfstmp.cfo;
		   +space(3);
		   +LSCst;
		   +space(2);
		   +itnfstmp.unidade;
		   +space(6);
		   +TRANSFORM(LNqtde,"@Z 99999") ;
		   +space(2);
		   +TRANSFORM(LNvlrUnit,"@Z 99,999.99") ;
		   +space(5);
		   +TRANSFORM(itnfstmp.vlrvenda,"@Z 999,999.99")
		
		Linha = Linha ;
		   +space(1);
		   +TRANSFORM(LNAlqICMS,"@Z 99") ;
		   +space(4);
		   +TRANSFORM(LNAlqIPI,"@Z 99")

	CASE itnfstmp.CENTROCUST  = "MSG-01"
		Linha = ;
			orc_anex.mens3
	CASE itnfstmp.CENTROCUST  = "MSG-02"
		Linha = ;
			orc_anex.mens1
	CASE itnfstmp.CENTROCUST  = "MSG-03"
		Linha = ;
			orc_anex.mens2
	CASE itnfstmp.CENTROCUST  = "SERVIC" && LINHA DA GRID  DESERVICO
	
		Linha = ;
			LScodigo;
		   +space(7);
		   +TRANSFORM(LNqtde,"@Z 999") ;
		   +space(3);
		   +LsDescricao;
		   +space(17);
		   +TRANSFORM(LNAlqISS,"@Z 99") ;
		   +space(5);
		   +TRANSFORM(LNvlrUnit,"@Z 99,999.99") ;
		   +space(3);
		   +TRANSFORM(itnfstmp.vlrvenda,"@Z 999,999.99")

	OTHERWISE
		LINHA = " "
ENDCASE


RETURN(Linha)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2UJ           NFProcEcrtDt VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   64    º
*       º Variable:            NFProcEcrtDt                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      111                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2uj     &&  NFProcEcrtDt VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFProcEcrtDt
PARAMETER PrmEmp,PrmDtIni,PrmDtFim



	PRIVATE  LNregistro

	PRIVATE LN_NFregistro

    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTA")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	=DFVerifyInst()



	SELE &ALSNota
	SET ORDER TO TAG DATA
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT  WHILE !EOF() AND &ALSNota .empresa = PrmEmp ;
				AND &ALSNota .data >= PrmDtIni ;
    	        AND &ALSNota .data <= PrmDtFim ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0

    BKregistro  = LNregistro
    BKimpressos = LNimpressos
    BKimpressao = LNimpressao


	*----------------------------------------------------*

	DO WHILE !EOF() ;
					AND	LFsegue = .t. ;
					AND &ALSNota .empresa = PrmEmp ;
					AND &ALSNota .data >= PrmDtIni ;
	                AND &ALSNota .data <= PrmDtFim
		

		DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	    LNregistro  = BKregistro
    	LNimpressos = BKimpressos
	    LNimpressao = BKimpressao


		=UPtermo()

	    BKregistro  = LNregistro
    	BKimpressos = LNimpressos
	    BKimpressao = LNimpressao



***		IF !( ALLTRIM( &ALSNota .nfe_status) $ "PROCESSADA/CANCELADA")

			LPrmNota = &ALSNota .Nota
	
			LN_NFregistro = RECNO()
	
			=NFEscriturar(ALSNota)

			SELE  &ALSNota
  		    SET ORDER TO TAG DATA
			GO LN_NFregistro
***		ENDIF

 		SKIP
		CTR = 	CTR + 1
	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2US           NFV3AjustTmpItens VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   69    º
*       º Variable:            NFV3AjustTmpItens                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      112                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2us     &&  NFV3AjustTmpItens VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFV3AjustTmpItens
PARAMETERS  PrmArqTmp,PrmEmpresa,PrmNota

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSretorno
	PRIVATE LNNroDup
	PRIVATE LMaxDim
	PRIVATE CtrLinhas
	PRIVATE CtrOrdem
	
	LSalias		= 	ALIAS()
	*-----------------------------------------------------------*



	SELE  &PrmArqTmp
	LMaxDim = Fcount()
    PRIVATE DIMENSION VTItem[LMaxDim]
*	INDEX ON nota,tp_mercad,ordem   TAG nota ADDITIVE
	go top


	COPY TO L:\TMP\TMITServ FOR tp_mercad = 7


	SELE 0
	USE L:\TMP\TMITServ alias TMITServ
	
	SELE  &PrmArqTmp
	zap
	pack
	
		
	*--------------------------------------------------------------*
	CtrOrdem = 1
	CtrLinhas = 0

	DO WHILE !EOF("TMITServ")



		*-----------------------------------------
		*--> PREENCHE 12 LINHAS PARA SERVICO
		*-----------------------------------------
		SELE TMITServ
		CtrLinhas = 0

		DO WHILE !EOF() AND CtrLinhas < 18
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1

			SCATTER TO VTItem
			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem


			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem
			REPLACE CENTROCUST   WITH "SERVIC"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas

			SELE TMITServ
			skip
		ENDDO



		SELE TMITServ
		SCATTER TO VTItem BLANK

		DO WHILE CtrLinhas  < 18
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1

			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem

			REPLACE empresa  WITH PrmEmpresa
			REPLACE nota     WITH PrmNota
			REPLACE nf_copia WITH PrmNota
			REPLACE ordem    WITH CtrOrdem
			REPLACE CENTROCUST   WITH "SERVIC"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas

		ENDDO

		*-----------------------------------------
		*--> PREENCHE 3 LINHAS PARA Menssagem
		*-----------------------------------------
		
		SELE  &PrmArqTmp
		x=1

		FOR X = 1 TO 3
			APPEND BLANK
			GATHER FROM  VTItem

			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem

			DO CASE
				CASE X= 1
					REPLACE CENTROCUST   WITH "MSG-01"
				CASE X= 2
					REPLACE CENTROCUST   WITH "MSG-02"
				CASE X= 3
					REPLACE CENTROCUST   WITH "MSG-03"
			ENDCASE
			REPLACE Cst         WITH "*"    && linha de espaco
			CtrOrdem = CtrOrdem + 1
		NEXT
		




	ENDDO

	SELE TMITServ
	use


	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2V4           NFV3LinhaProd VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   70    º
*       º Variable:            NFV3LinhaProd                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      113                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2v4     &&  NFV3LinhaProd VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFV3LinhaProd
PARAMETERS PrmLinha




PRIVATE Linha,LScodigo,LsDescricao,LNQtde,LNvlrUnit,LNAlqIPI


LScodigo    = IIF(LEFT(itnfstmp.codigo,5)="99999",;
              SPACE(8), LEFT(itnfstmp.codigo,8))


IF !EMPTY(itnfstmp.descrcompl)

	LsDescricao = (UPClasNbm((wp_empresa),(itnfstmp.codigo), ;
		 	  (itnfstmp.origem) ,;
		 	  (RTRIM(itnfstmp.descrcompl));
		 	  ))
ELSE

	LsDescricao = (UPClasNbm((wp_empresa),(itnfstmp.codigo), ;
		 	  (itnfstmp.origem) ,;
		 	  (RTRIM(itnfstmp.descricao)+RTRIM(itnfstmp.descrcompl));
		 	  ))
ENDIF

LsDescricao = LEFT(LsDescricao+SPACE(31),31)

LNQtde      = IIF(tipooper.ch_opera = "1" AND ;
              tipooper.ch_motiv = "3" ,0,itnfstmp.qtde)

IF itnfstmp.qtde = 0
	LNvlrUnit   = 0
ELSE
	LNvlrUnit   = itnfstmp.vlrvenda/ itnfstmp.qtde
	LNvlrUnit   = INT(LNvlrUnit * 100)/100
ENDIF


LNAlqICMS   = IIF(itnfstmp.cst $ "012",INT(itnfstmp.aliq_icms),0)
LNAlqIPI    = IIF(itnfstmp.vlripi > 0,INT(itnfstmp.aliq_ipi),0)
LNAlqISS    = INT(itnfstmp.aliq_iss)



LSCst = IIF(EMPTY(itnfstmp.cst),"   ","0"+CHRTRAN(itnfstmp.cst," ","0")+"0")



DO CASE


	CASE itnfstmp.CENTROCUST  = "MSG-01"
		Linha = ;
			"Matriz: Av. Anhanguera,7206,Qd.P69, Lts 1 ao 6"
	CASE itnfstmp.CENTROCUST  = "MSG-02"
		Linha = ;
			"   Setor dos Funcionarios -Goiania-Go"
	CASE itnfstmp.CENTROCUST  = "MSG-03"
		Linha = ;
			"IM: 012.806-6 ; CNPJ 01.536.085/0001-90 IE:10.004.994.0"
	CASE itnfstmp.CENTROCUST  = "SERVIC" && LINHA DA GRID  DESERVICO
	
		Linha = ;
			LScodigo;
		   +space(7);
		   +TRANSFORM(LNqtde,"@Z 999") ;
		   +space(5);
		   +LsDescricao;
		   +space(19);
		   +space(15);
		   +TRANSFORM(LNvlrUnit,"@Z 99,999.99") ;
		   +space(6);
		   +TRANSFORM(itnfstmp.vlrvenda,"@Z 999,999.99")

	OTHERWISE
		LINHA = " "
ENDCASE


RETURN(Linha)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2VD           NFPendEcrtDt VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   71    º
*       º Variable:            NFPendEcrtDt                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      114                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2vd     &&  NFPendEcrtDt VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NFPendEcrtDt
PARAMETER PrmEmp,PrmDtIni,PrmDtFim



	PRIVATE  LNregistro

	PRIVATE LN_NFregistro

    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTA")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	=DFVerifyInst()



	SELE &ALSNota
	SET ORDER TO TAG DATA
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI


    SET TALK ON

    SELECT ;
        NT.EMPRESA, ;
        NT.NOTA, ;
        NT.DATA ;
    FROM &ALSNota NT ;
    WHERE ;
	        NT.empresa = PrmEmp ;
	    AND NT.data >= PrmDtIni ;
        AND NT.data <= PrmDtFim ;
		AND !( ALLTRIM( NT.nfe_status) $ "PROCESSADA/CANCELADA") ;
	INTO TABLE C:\NFe\pendSai;
	ORDER BY ;
        NT.DATA, ;
        NT.NOTA

	sele pendsai
	brows  TITLE  "C:\NFe\pendSai.dbf"
	use

    SET TALK OFF

	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF



RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2VL           NFABOAjustItens VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   72    º
*       º Variable:            NFABOAjustItens                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      115                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2vl     &&  NFABOAjustItens VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFABOAjustItens
PARAMETERS  PrmArqTmp,PrmEmpresa,PrmNota

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSretorno
	PRIVATE LNNroDup
	PRIVATE LMaxDim
	PRIVATE CtrLinhas
	PRIVATE CtrOrdem
	
	LSalias		= 	ALIAS()
	*-----------------------------------------------------------*



	SELE  &PrmArqTmp
	LMaxDim = Fcount()
    PRIVATE DIMENSION VTItem[LMaxDim]
*	INDEX ON nota,tp_mercad,ordem   TAG nota ADDITIVE
	go top


	COPY TO L:\TMP\TMITServ FOR tp_mercad = 7


	SELE 0
	USE L:\TMP\TMITServ alias TMITServ
	
	SELE  &PrmArqTmp
	zap
	pack
	
		
	*--------------------------------------------------------------*
	CtrOrdem = 1
	CtrLinhas = 0

	DO WHILE !EOF("TMITServ")



		*-----------------------------------------
		*--> PREENCHE 5 LINHAS PARA SERVICO
		*-----------------------------------------
		SELE TMITServ
		CtrLinhas = 0

		DO WHILE !EOF() AND CtrLinhas < 5
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1

			SCATTER TO VTItem
			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem


			REPLACE empresa      WITH PrmEmpresa
			REPLACE nota         WITH PrmNota
			REPLACE nf_copia     WITH PrmNota
			REPLACE ordem        WITH CtrOrdem
			REPLACE CENTROCUST   WITH "SERVIC"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas

			SELE TMITServ
			skip
		ENDDO


		SELE TMITServ
		SCATTER TO VTItem BLANK

		DO WHILE CtrLinhas  < 5
			CtrOrdem = CtrOrdem + 1
			CtrLinhas= CtrLinhas + 1

			SELE  &PrmArqTmp
			APPEND BLANK

			GATHER FROM  VTItem

			REPLACE empresa  WITH PrmEmpresa
			REPLACE nota     WITH PrmNota
			REPLACE nf_copia WITH PrmNota
			REPLACE ordem    WITH CtrOrdem
			REPLACE CENTROCUST   WITH "SERVIC"    && linha de espaco
*			REPLACE vlrvenda     WITH CtrLinhas

		ENDDO
	ENDDO

	SELE TMITServ
	use


	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2VU           NFABOLinhaSRVC VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   73    º
*       º Variable:            NFABOLinhaSRVC                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      116                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2vu     &&  NFABOLinhaSRVC VALID
#REGION 3
return
*---------------------------------------------------------------*


FUNCTION NFABOLinhaSRVC
PARAMETERS PrmLinha



PRIVATE Linha,LScodigo,LsDescricao,LNQtde,LNvlrUnit,LNAlqIPI


LScodigo    = IIF(LEFT(itnfstmp.codigo,5)="99999",;
              SPACE(8), LEFT(itnfstmp.codigo,8))


IF !EMPTY(itnfstmp.descrcompl)

	LsDescricao = (UPClasNbm((wp_empresa),(itnfstmp.codigo), ;
		 	  (itnfstmp.origem) ,;
		 	  (RTRIM(itnfstmp.descrcompl));
		 	  ))
ELSE

	LsDescricao = (UPClasNbm((wp_empresa),(itnfstmp.codigo), ;
		 	  (itnfstmp.origem) ,;
		 	  (RTRIM(itnfstmp.descricao)+RTRIM(itnfstmp.descrcompl));
		 	  ))
ENDIF

LsDescricao = LEFT(LsDescricao+SPACE(31),31)

LNQtde      = IIF(tipooper.ch_opera = "1" AND ;
              tipooper.ch_motiv = "3" ,0,itnfstmp.qtde)

IF itnfstmp.qtde = 0
	LNvlrUnit   = 0
ELSE
	LNvlrUnit   = itnfstmp.vlrvenda/ itnfstmp.qtde
	LNvlrUnit   = INT(LNvlrUnit * 100)/100
ENDIF


LNAlqICMS   = IIF(itnfstmp.cst $ "012",INT(itnfstmp.aliq_icms),0)
LNAlqIPI    = IIF(itnfstmp.vlripi > 0,INT(itnfstmp.aliq_ipi),0)
LNAlqISS    = INT(itnfstmp.aliq_iss)



LSCst = IIF(EMPTY(itnfstmp.cst),"   ","0"+CHRTRAN(itnfstmp.cst," ","0")+"0")



DO CASE

	CASE itnfstmp.CENTROCUST  = "PRODUT" && LINHA DA GRID  DE PRODUTO
		Linha = ;
			LScodigo;
		   +space(1);
		   +LsDescricao;
		   +space(1);
		   +itnfstmp.cfo;
		   +space(3);
		   +LSCst;
		   +space(2);
		   +itnfstmp.unidade;
		   +space(6);
		   +TRANSFORM(LNqtde,"@Z 99999") ;
		   +space(2);
		   +TRANSFORM(LNvlrUnit,"@Z 99,999.99") ;
		   +space(5);
		   +TRANSFORM(itnfstmp.vlrvenda,"@Z 999,999.99")
		
		Linha = Linha ;
		   +space(1);
		   +TRANSFORM(LNAlqICMS,"@Z 99") ;
		   +space(4);
		   +TRANSFORM(LNAlqIPI,"@Z 99")

	CASE itnfstmp.CENTROCUST  = "MSG-01"
		Linha = ;
			orc_anex.mens3
	CASE itnfstmp.CENTROCUST  = "MSG-02"
		Linha = ;
			orc_anex.mens1
	CASE itnfstmp.CENTROCUST  = "MSG-03"
		Linha = ;
			orc_anex.mens2
	CASE itnfstmp.CENTROCUST  = "SERVIC" && LINHA DA GRID  DESERVICO
	
		Linha = ;
		    space(4);
		   +TRANSFORM(LNqtde,"@Z 999") ;
		   +space(3);
		   +LScodigo;
		   +space(3);
		   +LsDescricao;
		   +space(44);
		   +TRANSFORM(LNvlrUnit,"@Z 99,999.99") ;
		   +space(11);
		   +TRANSFORM(itnfstmp.vlrvenda,"@Z 999,999.99") ;
		   +space(3);
		   +TRANSFORM(LNAlqISS,"@Z 99")

	OTHERWISE
		LINHA = " "
ENDCASE


RETURN(Linha)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2W4           NFProcessFat VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   74    º
*       º Variable:            NFProcessFat                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      117                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2w4     &&  NFProcessFat VALID
#REGION 3
return
*---------------------------------------------------------------*
FUNCTION NFProcessFat
PARAMETERS PrmEmpresa,LNorcamento,PrmSolicitante,PrmTrataBoleto
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Controle o Processo de Faturamento
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		PrmEmpresa......:
	*		LNorcamento:
	*		PrmSolicitante..: Identifica os Pontos em que esta
	*				 rotina pode ser chamada
	*			   		PrmSolicitante = "VENDEDOR"
	*					PrmSolicitante = "CAIXA"
	*					PrmSolicitante = "FATURISTA SIMPLES"	&& SCGC201A
	*					PrmSolicitante = "FATURISTA RESERVA"	&& SCGC201A
	*					PrmSolicitante = "IMPORTACAO"		&& SCGC008
	* 					PrmSolicitante = "RECUPERACAO"
	*       PrmTrataBoleto
	*                         = "EMITIR BOLETO"
	*                         = "SEM BOLETO" OU .F.
	*
	*
	*
	*------------------------------------------------------------*
	*  RETORNO.....: .f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	*********************************************************
	*---->   (Preparacao para controle de SATUS DO PROCESSO
	*********************************************************	

	PRIVATE FlgImpFatura

	PRIVATE LNnfinicio    , LNnffim
	PRIVATE LNnfsrvIni    , LNnfsrvFim
	PRIVATE LNCtrlCpmIni, LNCtrlCpmFim
	PRIVATE LNnfCopInicio , LNnfCopFim
	PRIVATE LNSrvCopIni , LNSrvCopFim
	PRIVATE LNNroRPS


	PRIVATE LNnroNF, LNNfServico, LNCtrlCpm
	PRIVATE LNNFCop, LNnfSrvCop


    PRIVATE LFGerNF,LFGerNFS  && INDICADORES QUE FOI GERADO
	PRIVATE LNcupom
	PRIVATE LStp_process
	PRIVATE datanf,horanf,LsOrientacao
	PRIVATE LFabrecupom				&& FLAG PARA MANDAR ABIR CUPOM
	PRIVATE LFservico				&& CASO EXISTA SERVICO (TP_MERCAD = 7)
	PRIVATE LFproduto 				&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
	PRIVATE LFipi    				&& CASO EXISTA IPI > 0

	*********************************************************	
	PRIVATE LFretorno
	LFretorno = .T.

	STORE 0  TO LNnfinicio ,LNnffim
	STORE 0  TO LNnfsrvIni ,LNnfsrvFim
	STORE 0  TO LNCtrlCpmIni, LNCtrlCpmFim
	STORE 0  TO LNnfCopInicio , LNnfCopFim
	STORE 0  TO LNSrvCopIni , LNSrvCopFim
	STORE 0  TO LNnroNF, LNNfServico, LNCtrlCpm
	STORE 0  TO LNNFCop, LNnfSrvCop
	STORE 0  TO LNNroRPS
	

	STORE 0  TO LNcupom
	STORE "" TO LStp_process
	STORE {} TO datanf
	STORE "" TO horanf,LsOrientacao
    STORE .F. TO LFGerNF,LFGerNFS



    FlgImpFatura = .T.



	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(PrmEmpresa,3)+STR(LNorcamento,6)

	IF orcament.flgtransac = .f.
		DO OBJ_MENS.SPR WITH " O orcamento Selecionado Sofreu" +;
		" Alteracoes que Afetam Valores e Nao Foi Recalculado." +;
		CHR(13)+;
		" Reedite os Itens e Grave para Forcar o Calculo."
		RETURN(.f.)
	ENDIF
	*----------------------------------------------------------------*
	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+orcament.tipo
	IF !FOUND()
		SEEK 's'+orcament.tipo
	ENDIF
	IF !found()
		SELECT orcament
		RETURN(.f.)
	ENDIF
	*---------------------------------------------------------*
	*   (Fim Preparacao para controle de SATUS DO PROCESSO
	*---------------------------------------------------------*


	LFservico	= .F.		&& CASO EXISTA SERVICO (TP_MERCAD = 7)
	LFproduto 	= .F.		&& CASO EXISTA PRODUTO (TP_MERCAD <> 7)
	LFIPI    	= .F.		&& CASO EXISTA IPI > 0
	*---------------------------------------------------------*

	=W_DEFPROC("NOTA.SPR")
	IF !NFchq_Final((orcament.empresa),(orcament.orcamento),;
				(PrmSolicitante),LFservico,LFproduto)
	    SELE orcament
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*
	* 				Inicio  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*

	
	IF !NFBlocEmpresa(orcament.empresa,PrmSolicitante)
	    SELE orcament
		RETURN(.F.)
	ENDIF


	*---------------------------------------------------------------*

	LFflgtrans 		= .t.
	m.LNalqicms 	= 0		&& aliquota de icms
	m.tot_fatura 	= 0		&& acumula valore de varias notas pra duplicatas


	m.nota   = 0   && utilizados para atualizar Orcamento
	m.cupom  = 0   && utilizados para atualizar Orcamento

	*---------------------------------------------------------------*
	* 		No trecho seguinte sao definidor DATA,HORA,NUMERO DE NOTA
	*	E NUMERO DE CUPOM sendo que estes dados ja vem definido no
	*	registro do orcamento quando esta IMPORTANDO ja no processo
	*	operacional normal rotinas sao ativadas para atribuir valores
	*	a estes dados
	*---------------------------------------------------------------*
	

	IF !NF_DefFat(PrmSolicitante)
   		SELE orcament
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------------*
	* INICIO - GERAR REGISTROS DO FATURAMENTO EM NOTA
	*--------------------------------------------------------------*


	IF  "CUPOM" $ LStp_proces
		LsOrientacao = "PRODUTO/SERVICO"
		*--------------------------------------------*
		IF !ULGerCupom(LsOrientacao)
			RETURN(.F.)
		ENDIF

	ENDIF



	IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
		LsOrientacao = "SERVICO"
		*--------------------------------------------*
		IF !ULGerServicoNf(LsOrientacao)
			RETURN(.F.)
		ENDIF


	ENDIF


	IF  "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
		LsOrientacao = "PRODUTO/SERVICO"
		IF  "NF SERVICO" $ LStp_proces
			LsOrientacao = "PRODUTO"
		ENDIF
		*--------------------------------------------*
		IF !ULGerNFSU(LsOrientacao)
			RETURN(.F.)
		ENDIF
	ENDIF
	=NFatlzOrcament()

	*---------------------------------------------------------------*
	* 				Fim  ---- F A T U R A M E N T O  ----
	*---------------------------------------------------------------*



	*---------------------------------------------------------------*
	* 				Inicio - GERAR DUPLICATAS
	*---------------------------------------------------------------*
	*----------------------------------------------------------------*
	*     O ajuste no sistema para registrar duplicatas para opera‡äes
	*  A VISTA e Para CARTåES.
	*    Como a Implanta‡Æo da VersÆo nas Filiais ocorre de maneira
	*  gradativa ‚ necess rio direcionar para rotina adequada a situa‡Æo
	*  da filial sendo:
	*    FILIAL ATUALIZADA   => CRgeradupl
	*    FILIAL N.ATUALIZADA => CRnrmgeradupl
	*----------------------------------------------------------------*

 	=W_DEFPROC("DUPLICAT.spr")




	DO CASE

        *------- JUN/2012 ---------------------------------------*
        * CRIADO COM A IMPLEMENTACAO DO EMISSO DO BOLETO VIA DFIS
        *-------------------------------------------------------*
		CASE  orcament.empresa <> 10 ;
		    AND TYPE("PrmTrataBoleto") = "C" ;
		    AND (PrmTrataBoleto = "EMITIR BOLETO";
		        OR ;
		        PrmTrataBoleto = "SEM BOLETO"  )
			DO  CRgeraDE01JUL12 WITH ;
				    (orcament.empresa),;
				    (orcament.orcamento),;
				    PrmTrataBoleto
        *--------------------------------

		CASE  orcament.empresa = 10
			IF  dt_fat < {26.03.2008}
				DO  CRidlate26geradupl WITH;
					 (orcament.empresa),(orcament.orcamento)
			ELSE
			
				DO  CRIDLApos26geradupl WITH ;
				    (orcament.empresa),(orcament.orcamento)
			ENDIF

        *--------------------------------
        *--------------------------------



		CASE dt_fat >= {12.03.2008}
				DO  CRgeraDE12MAR08 WITH ;
				    (orcament.empresa),(orcament.orcamento)

		CASE dt_fat >= {10.03.2008} AND ;
			(orcament.empresa = 01 or orcament.empresa = 02)		
				DO  CRgeraDE12MAR08 WITH ;
				    (orcament.empresa),(orcament.orcamento)
		otherwise
			DO  CRgeraATE10MAR08 WITH ;
			     (orcament.empresa),(orcament.orcamento)
	ENDCASE

	*----------------------------------------------------*
    *     Registrar Comando para sistema de Caixa
	*----------------------------------------------------*
	IF !(PrmSolicitante $ "IMPORTACAO/RECUPERACAO")
		DO CASE
    		CASE "CUPOM" $ LStp_process
				=NFRgAvisoCaixa((PrmEmpresa), (LNCtrlCpmIni))
	    	CASE "NOTA" $ LStp_process
				=NFRgAvisoCaixa((PrmEmpresa), (LNnfinicio))
	    	CASE "NF SERVICO" $ LStp_process
				=NFRgAvisoCaixa((PrmEmpresa), (LNnfsrvIni))
		ENDCASE
	ENDIF



	
	IF FlgImpFatura = .F.
		RETURN(.F.)
	ENDIF

	*----------------------------------------------------------------*
	SELECT orcament
	IF wp_dtsys = wp_dtoper
		IF 	!UPtransacao("TERMINAR")
			WAIT WINDOW "TRANSACAO PERMANECEU ABERTA. VER SUPORTE."
		ENDIF			
	ENDIF

	*---------------------------------------------------------------*
	* 	Inicio - VERIFICA SE PROCESSO GERA IMPRESSAO ou DFIS
	*---------------------------------------------------------------*

	LFretorno = .T.
	IF  PrmSolicitante = "IMPORTACAO"

		=UNFempmarca(4,LStp_proces,LSOrientacao)

		wp_msg = "Faturamento Concluido "
		WAIT WINDOW wp_msg NOWAIT
	    RETURN(.T.)
	ENDIF
	IF  PrmSolicitante = "RECUPERACAO"
		=UNFempmarca(4,LStp_proces,LSOrientacao)
		IF  "COPIA" $ LStp_proces
	       LFretorno = ;
		    	NFProcessCopia(orcament.empresa,LNCtrlCpmIni,;
		    	    PrmSolicitante,"ROTINA FATURAMENTO",.T.,.T.)
		ENDIF
	    RETURN(LFretorno)

	ENDIF

	*---------------------------------------------------------------*
	* 				Inicio ---- IMPRESSAO
	*---------------------------------------------------------------*
	*----------------------------------------------------------------*
	wp_msg = "Imprimindo Formularios Refrente OSI: "+;
							 STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*



	FlgImpFatura = .t.   &&

	*-------------------------------------------------------------*
    * IMPRESSAO CUPOM FISCAL  CONVENCIONAL
    *-------------------------------------------------------------*
	IF "CUPOM" $ LStp_proces

		FlgImpFatura =  NF_ImpCupomFiscal(;
				(orcament.empresa),(orcament.orcamento),(LStp_process),;
				(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
				(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			
	ENDIF

	*-------------------------------------------------------------*
    * IMPRESSAO/EMISSAO CUPOM FISCAL  ELETRONICO
    *-------------------------------------------------------------*

	IF "CUPOM" $ LStp_proces
		IF FlgImpFatura
			LsOrientacao = "PRODUTO/SERVICO"

			PRIVATE LSobjetivo, LCemp, LCCupom

			LCemp      = PrmEmpresa
			LCCupom    = LNCtrlCpmIni
			
			LSobjetivo = NFDefEnvDFis(PrmEmpresa,LNCtrlCpmIni)

			IF LSobjetivo = "EMISSAO"
				IF !(NF_GeraDFis(PrmEmpresa,;
                             LNCtrlCpmIni,LSobjetivo,(LsOrientacao)))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais"+;
					" nao acatou o Emissao."+;
			     	" Repita o processo e se persistir a negacao entre "+;
		    	 	" em contato com suporte"
			   		SELE orcament
			   		FlgImpFatura = .f.
           *---------------------------------------
           * o cancelamento automatico estava criando inconsistencias
           * o operador devera comandar o cancelamento do cupo caso haja
           * falha na emissÆo
           *---------------------------------------
           *      	SELE nota
	       *         SET ORDER TO TAG nota
	       *         SEEK STR(LCemp,3)+STR(LCCupom,7)
	       *         IF found()
           *     	  =W_DEFPROC("nota.spr")
		   *           IF NFCTRLcancFatura((nota.empresa),;
           *                               (nota.nota),;
           *                               "NORMAL")
           *              =UNFempmarca(4,LStp_proces,LSOrientacao)
           *           ENDIF
           *         ENDIF
                ELSE
                    =UNFempmarca(4,LStp_proces,LSOrientacao)
				ENDIF
			ENDIF			
		ENDIF
	ENDIF


		

	*-------------------------------------------------------------*
	IF FlgImpFatura
		IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)

			DO CASE
			
				CASE    orcament.empresa = 8 ;
				     OR orcament.empresa = 7 ;
				     OR orcament.empresa = 17 ;
				     OR orcament.empresa = 9

					FlgImpFatura =  NFPrtSrvico(;
					(orcament.empresa),(LStp_process),;
					(LNnfsrvIni))			

				OTHERWISE

					FlgImpFatura =  NF_ImpNFSrvico(;
					(orcament.empresa),(orcament.orcamento),(LStp_process),;
					(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
					(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			
			ENDCASE
		ENDIF
	ENDIF

	*-------------------------------------------------------------*

	IF FlgImpFatura
		IF "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)

			FlgImpFatura =  NF_ImpNFFiscal(;
				(orcament.empresa),(orcament.orcamento),(LStp_process),;
				(wp_TipoEcf),(LNecf),(LNCtrlCpmIni), (LNCtrlCpmFim),;
				(LNnfinicio),(LNnffim),(LNnfsrvIni),(LNnfsrvFim),;
				(LNnfCopInicio),(LNnfCopFim),(LNSrvCopIni),(LNSrvCopFim))			
		ENDIF
	ENDIF


	*---------------------------------------------------------------*
	* 				Inicio ---- GERAR DFIS + NFe + ..
	*---------------------------------------------------------------*
	*----------------------------------------------------------------*
	wp_msg = "Gerando Doc Fiscal Refrente OSI: "+;
							 STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*


	*-------------------------------------------------------------*
	IF FlgImpFatura
		IF "NF SERVICO" $ LStp_proces AND !("COPIA" $ LStp_proces)
				LsOrientacao = "SERVICO"
				PRIVATE LSobjetivo
				LSobjetivo = NFDefEnvDFis(PrmEmpresa,LNnfsrvFim)

			IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"

				 IF !(NF_GeraDFis(PrmEmpresa,LNnfsrvFim,;
                                      LSobjetivo,LsOrientacao ))
				   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais"+;
					" nao acatou o Emissao."+;
			     	" Repita o processo e se persistir a negacao entre "+;
		    	 	" em contato com suporte"
			   		SELE orcament
			   		FlgImpFatura = .f.
				 ENDIF
		    ENDIF			
		ENDIF
	ENDIF
	*-------------------------------------------------------------*

	IF FlgImpFatura
		IF "NOTA" $ LStp_proces AND !("COPIA" $ LStp_proces)
			*--------------------------------------------------------*
			LsOrientacao = "PRODUTO/SERVICO"
			IF  "NF SERVICO" $ LStp_proces
				LsOrientacao = "PRODUTO"
			ENDIF

			PRIVATE LSobjetivo
			LSobjetivo = NFDefEnvDFis(PrmEmpresa,LNnffim)

			IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"

			 	IF !(NF_GeraDFis(PrmEmpresa,LNnffim,;
                                     LSobjetivo,LsOrientacao ))
			   		DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
					"  O Emissor de Documentos Fiscais"+;
					" nao acatou o Emissao."+;
		     		" Repita o processo e se persistir a negacao entre "+;
	    	 		" em contato com suporte"
		   			SELE orcament
		   			FlgImpFatura = .f.
			 	ENDIF
		    ENDIF			

			*-----------------------------------------------------*
		ENDIF
		*--------------------------------------------------------*

	ENDIF


	*---------------------------------------------------------------*
	* 	ENCERRA SOLICITACAO DE CREDITO
	*---------------------------------------------------------------*

	IF FlgImpFatura
 	    =W_DEFPROC("rotinas.spr")
        =ORXMLFatPede_p_Liberar(PrmEmpresa,LNorcamento)
    ENDIF


	*---------------------------------------------------------------*
	* 	Inicio - *  DEFINIR SOLICITACAO DE COPIA
	*---------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	IF FlgImpFatura
		IF  "COPIA" $ LStp_proces
	      LFretorno = ;
	    	NF_02ImpCopia(PrmSolicitante,LNCtrlCpmIni)

		ELSE
			=NF_aviso(orcament.Empresa,LNNfinicio,LNCtrlCpmIni,;
						PrmSolicitante,LStp_proces)
		ENDIF
	ELSE

    	WAIT WINDOW "Houve Falha no Impressao do Doc.Fiscal!!!!"
		LFretorno = .F.
        FlgImpFatura = .F.
	ENDIF






	*----------------------------------------------------*
    *     Registrar Duplicata para Servico Financeiro-ORION sistema de Caixa
	*----------------------------------------------------*

    *---------------------------------------------------------------*
    * Rotina substituida por chamada em
    *    DFGerXMLDocFiscal-Gera XML DocFiscal Por Doc Fiscal informado
    *  em conjunto com a exportacao do xml de cobranca do doc fiscal
    *---------------------------------------------------------------*
*---------------------------------------------------------------------*
*	=W_DEFPROC("EMPRESA.SPR")
*	LSemi_Fncr = EMGetFieldValue(PrmEmpresa,"EMITE_FNCR")
*
*
*   IF FlgImpFatura = .T. AND LSemi_Fncr = "S"
*		=W_DEFPROC("DUPLICAT.SPR")
*		DO CASE
*	    		CASE "CUPOM" $ LStp_process
*					FlgImpFatura = ;
*					   CRDuplDFisExpDuplicata((PrmEmpresa), ;
*					   (LNCtrlCpmIni), ;
*					   "REGISTRAR")
*
*
*		    	CASE "NOTA" $ LStp_process
*					FlgImpFatura = ;
*					   CRDuplDFisExpDuplicata((PrmEmpresa),;
*					    (LNnfinicio),;
*					   "REGISTRAR")
*
*		    	CASE "NF SERVICO" $ LStp_process
*					FlgImpFatura = ;
*					   CRDuplDFisExpDuplicata((PrmEmpresa),;
*					    (LNnfsrvIni),;
*					   "REGISTRAR")
*
*				CASE "COPIA" $ LStp_proces
*					FlgImpFatura = ;
*					   CRDuplDFisExpDuplicata((PrmEmpresa),;
*					    (LNCtrlCpmIni),;
*					   "REGISTRAR")
*		ENDCASE
*
*
*		IF !FlgImpFatura
 *   		WAIT WINDOW "Houve Falha no Registro Financeiro ORION !!!!"
*			LFretorno = .F.
*
*		ENDIF
*
*	ENDIF
*

	*----------------------------------------------------------------*
	wp_msg = " ** Faturamento Concluido ** "
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*

RETURN(LFretorno)







*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2WX           NFEmitPrdReenvNFe VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   75    º
*       º Variable:            NFEmitPrdReenvNFe                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      118                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2wx     &&  NFEmitPrdReenvNFe VALID
#REGION 3
RETURN

FUNCTION NFEmitPrdReenvNFe
PARAMETER PrmEmp,PrmDtIni,PrmDtFim



	PRIVATE  LNregistro

	PRIVATE LN_NFregistro

    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTA")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	=DFVerifyInst()



	SELE &ALSNota
	SET ORDER TO TAG DATA
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT  WHILE !EOF() AND &ALSNota .empresa = PrmEmp ;
				AND &ALSNota .data >= PrmDtIni ;
    	        AND &ALSNota .data <= PrmDtFim ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0

    BKregistro  = LNregistro
    BKimpressos = LNimpressos
    BKimpressao = LNimpressao


	*----------------------------------------------------*

	DO WHILE !EOF() ;
					AND	LFsegue = .t. ;
					AND &ALSNota .empresa = PrmEmp ;
					AND &ALSNota .data >= PrmDtIni ;
	                AND &ALSNota .data <= PrmDtFim
		

		DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	    LNregistro  = BKregistro
    	LNimpressos = BKimpressos
	    LNimpressao = BKimpressao

        MSG = " Inicio:"+HINI + " EMITIDAS: "+ STR(CTR-1,6)

		=UPtermo()

	    BKregistro  = LNregistro
    	BKimpressos = LNimpressos
	    BKimpressao = LNimpressao




		LPrmNota = &ALSNota .Nota
	
		LN_NFregistro = RECNO()
		*----------------------------------------------------------------*
		DO CASE
				CASE Nota.Nota > 2000000 AND  Nota.Nota < 3000000
					LsOrientacao = "SERVICO"

				CASE Nota.Nota > 4000000 AND  Nota.Nota < 5000000
					LsOrientacao = "SERVICO"

				CASE  Nota.totservico > 0 AND Nota.totproduto > 0
					LsOrientacao = "PRODUTO/SERVICO"

				CASE  Nota.totservico > 0
					LsOrientacao = "SERVICO"

				CASE   Nota.totproduto > 0
					LsOrientacao = "PRODUTO"
				OTHERWISE
					LsOrientacao = "PRODUTO/SERVICO"

			
		ENDCASE



		*----------------------------------------------------------------*
		PRIVATE LSobjetivo, LNT,LEMP

   	    LNT = nota.nota
		LEMP = nota.empresa

		LSobjetivo = NFDefEnvDFis(nota.empresa,nota.nota)

		IF LSobjetivo = "EMISSAO" OR LSobjetivo = "ESCRITURACAO"
			IF !(NF_GeraDFis(nota.empresa,nota.nota,LSobjetivo,;
		      LsOrientacao ))
		   	DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
			"  O Emissor de Documentos Fiscais nao acatou o Emissao."+;
			     " Repita o processo e se persistir a negacao entre "+;
			     " em contato com suporte"
			ENDIF
		ENDIF			


		SELE  &ALSNota
	    SET ORDER TO TAG DATA
		GO LN_NFregistro


 		SKIP
		CTR = 	CTR + 1


	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)








*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2X9           NFDefEnvDFis VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         NOTA_B,     Record Number:   76    º
*       º Variable:            NFDefEnvDFis                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      119                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2x9     &&  NFDefEnvDFis VALID
#REGION 3
return
*---------------------------------------------------------------*

********************
FUNCTION NFDefEnvDFis
PARAMETERS PrmEmpresa,PrmNota


	*-->>>>>>>>>>>>>     PARA ENVIO NFE
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= ""
	PrmTipo    		= ""
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*



	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)


	*----------------------------------------------------*

	*-----------------------------------------------------------*
	PRIVATE LSemi_NF,LSemi_NFe,LSemi_NFS,LSemi_NFSe,LSemi_ECF,LSemi_CFe
	PRIVATE LSscr_NF,LSscr_NFe,LSscr_NFS,LSscr_NFSe,LSscr_ECF,LSscr_CFe
    PRIVATE LSprt_nfs

	*------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NF = EMGetFieldValue(PrmEmpresa,"EMITE_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFe = EMGetFieldValue(PrmEmpresa,"EMITE_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFS = EMGetFieldValue(PrmEmpresa,"EMITE_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_NFSe = EMGetFieldValue(PrmEmpresa,"EMITE_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_ecf = EMGetFieldValue(PrmEmpresa,"EMITE_ECF")

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_CFE = EMGetFieldValue(PrmEmpresa,"EMITE_CFE")

	*------------------------------------------------------------*

	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NF = EMGetFieldValue(PrmEmpresa,"ESCRT_NF")
	
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFS = EMGetFieldValue(PrmEmpresa,"ESCRT_NFS")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_NFSe = EMGetFieldValue(PrmEmpresa,"ESCRT_NFSE")

	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ecf = EMGetFieldValue(PrmEmpresa,"ESCRT_ECF")


	=W_DEFPROC("EMPRESA.SPR")
	LSscr_cfe = EMGetFieldValue(PrmEmpresa,"ESCRT_CFE")


	*------------------------------------------------------------*



	=W_DEFPROC("EMPRESA.SPR")
	LSprt_nfs = EMGetFieldValue(PrmEmpresa,"PRINT_NFS")


	*------------------------------------------------------------*








	PRIVATE PrmObjetivo

	PrmObjetivo = "NAO INTEGRAR"



	DO CASE
	





		CASE  RtnMOD_DOC    =   "2D"  && CUPOM

			DO CASE

				CASE LSemi_CFe  = "S"
	 				PrmObjetivo = "EMISSAO"

				CASE LSscr_CFe  = "S"
	 				PrmObjetivo = "ESCRITURACAO"

				CASE LSscr_ECF = "S"
	 				PrmObjetivo = "ESCRITURACAO"

				OTHERWISE
					PrmObjetivo = "NAO INTEGRAR"
			ENDCASE

		CASE  RtnMOD_DOC    $   "03/77"  && NF SERVICO
			DO CASE

                *-------------------------------------------
                * 27/8/13 - a cgb processa a NFSe normalmente at‚ o
                * envio para o DFis onde se estiver habilitado a
                *  impressao NFS, esta indica o usuario lanca a nota
                *  no site e o sistema escritura no defis
                *-------------------------------------------


				CASE LSprt_nfs = "S"
	 				PrmObjetivo = "ESCRITURACAO"


				CASE LSemi_NFS = "S" OR LSemi_NFSe = "S" 				
	 				PrmObjetivo = "EMISSAO"


				CASE LSscr_NFS = "S" OR LSscr_NFSe = "S" 				
	 				PrmObjetivo = "ESCRITURACAO"


				OTHERWISE
						PrmObjetivo = "NAO INTEGRAR"
			ENDCASE

		CASE  RtnMOD_DOC    $   "01/55"  && NF/NFe
			DO CASE
				CASE LSemi_NF = "S" OR LSemi_NFe = "S" 				
	 				PrmObjetivo = "EMISSAO"

				CASE LSscr_NF = "S" OR LSscr_NFe = "S" 				
	 				PrmObjetivo = "ESCRITURACAO"

				OTHERWISE
					PrmObjetivo = "NAO INTEGRAR"
			ENDCASE

		OTHERWISE			
				PrmObjetivo = "NAO INTEGRAR"

		ENDCASE





RETURN(PrmObjetivo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2XM           MVAtu_Cmd VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:    2  º
*       º Variable:            MVAtu_Cmd                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      120                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2xm     &&  MVAtu_Cmd VALID
#REGION 4
RETURN

******---------------------------------
* APOS A GRAVACAO DO NOVO REGISTRO DE ITEMMOV GERADO POR ENTRADAS,
*	 ESTA ROTINA E ATIVADA  //  ou // PARA CORRECAO DO ESTOQUE
*
*   - VOLTA UM REGISTRO
*	- CAPTURA CUSTO MEDIO ANTERIOR
*	- LOOP NO MOVIMENTO DO PRODUTO
*		-AVANCA UM REGISTRO
*		-RECALCULA CUSTO MEDIO
*
*	- FIM LOOP
*   - ATULIZA VALORES NO CONTROLE DA SALDOS DOS MESES AFETADOS
****************************************
PROCEDURE MVatu_cmd		&& ATUALIZA CUSTO MEDIO COM BASE NO ITEMMOV
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata,;
			PRMhora,;
			PRMtipo,;
			PRMnota,;
			PRMordem

*	IF PRMcodigo = "13010719"
*		set step on
*	endif

    = W_DEFPROC("rotinas.spr")

	SELE Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)


	*------------------------------------------------------------------*
	*   Inicio Efetivo da Rotina Apos o Posicionamento
	*------------------------------------------------------------------*

	PRIVATE sld_ante, vlr_ante, res_ante
	PRIVATE sld_atu, vlr_atu, dt_entrada, dt_saida

	PRIVATE	LNredutor   &&    Indice de reducao de icms em entrada
						&& Transf Internas
	PRIVATE	LSoperacao  &&    Indica a operacao "*" ou "/" que envolvera
						&& o LNredudor

    && Valores Basicos  Saldo

	PRIVATE LNvlratu	&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNsldatu	&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNcstmedio  && CUSTO MEDIO DO PRODUTO
	PRIVATE LNreserva   && saldo em reserva


    && Valores de Detalhementos de Saldo
	PRIVATE m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	

	store 0 to  sld_ante, vlr_ante, res_ante, sld_atu, vlr_atu
	store {} to dt_entrada, dt_saida

			
	store 0 to m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	



	LNvlratu	= 0		&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	LNsldatu	= 0		&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	LNcstmedio  = 0     && CUSTO MEDIO DO PRODUTO
	LNreserva   = 0     && saldo em reserva


    =MVBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)


    =MVObterSaldos( m.sld_ante, m.vlr_ante, m.res_ante,;
                  m.dt_entrada, m.dt_saida,;
    			  LNsldatu, LNvlratu, LNreserva,;
    	          m.qtd_compra, m.vlr_compra, ;
   	              m.qtd_venda , m.vlr_venda , ;
   	              m.qtd_e_tran, m.vlr_e_tran, ;
   	              m.qtd_e_outr, m.vlr_e_outr, ;
   	              m.qtd_s_tran, m.vlr_s_tran, ;
		          m.qtd_s_outr, m.vlr_s_outr, ;
				  m.ven_tab, m.ven_contab, m.ven_enc, ;
	 			  m.reserva)


	************************************************************
	=MVprocessaMvto(PRMempresa,;
					PRMcodigo,;
					PRMclasse,;
					PRMdata,;
					PRMhora,;
					PRMtipo,;
					PRMnota,;
					PRMordem)


	***************************
	****************	ATUALIZANDA SALDOS ABERTOS EM MESES FUTUROS
	****************
    =MVDesBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)
	
	SELE ITEMMOV
	SET ORDER TO TAG movimento
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2XX           MVCancelMvto VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:    3  º
*       º Variable:            MVCancelMvto                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      121                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2xx     &&  MVCancelMvto VALID
#REGION 4
RETURN

******---------------------------------
****************************************
PROCEDURE MVCancelMvto
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata,;
			PRMhora,;
			PRMtipo,;
			PRMnota,;
			PRMordem

    = W_DEFPROC("rotinas.spr")

	SELE Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)




	PRIVATE sld_ante, vlr_ante, res_ante
	PRIVATE sld_atu, vlr_atu, dt_entrada, dt_saida

	PRIVATE	LNredutor   &&    Indice de reducao de icms em entrada
						&& Transf Internas
	PRIVATE	LSoperacao  &&    Indica a operacao "*" ou "/" que envolvera
						&& o LNredudor

    && Valores Basicos  Saldo

	PRIVATE LNvlratu	&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNsldatu	&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNcstmedio  && CUSTO MEDIO DO PRODUTO
	PRIVATE LNreserva   && saldo em reserva


    && Valores de Detalhementos de Saldo
	PRIVATE m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	

	store 0 to  sld_ante, vlr_ante, res_ante, sld_atu, vlr_atu
	store {} to dt_entrada, dt_saida

			
	store 0 to m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	



	LNvlratu	= 0		&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	LNsldatu	= 0		&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	LNcstmedio  = 0     && CUSTO MEDIO DO PRODUTO
	LNreserva   = 0     && saldo em reserva

    =MVBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)

    =MVObterSaldos( m.sld_ante, m.vlr_ante, m.res_ante,;
	              m.dt_entrada, m.dt_saida,;
    			  LNsldatu, LNvlratu, LNreserva,;
    	          m.qtd_compra, m.vlr_compra, ;
   	              m.qtd_venda , m.vlr_venda , ;
   	              m.qtd_e_tran, m.vlr_e_tran, ;
   	              m.qtd_e_outr, m.vlr_e_outr, ;
   	              m.qtd_s_tran, m.vlr_s_tran, ;
		          m.qtd_s_outr, m.vlr_s_outr, ;
				  m.ven_tab, m.ven_contab, m.ven_enc, ;
	 			  m.reserva)
	************************************************************

	*----------------------------------------------------------------*
	*    Efetiva Cancelamento do Registro de Movimento
	*----------------------------------------------------------------*
	
    SELE itemmov
    =edithand('APAGA')

	SELE itmanexo
	SET ORDER TO TAG movanexo
	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)
	IF FOUND()
		=REGLOCK(.T.)
		=edithand('APAGA')
		UNLOCK
	ENDIF

    SELE itemmov
	*----------------------------------------------------------------*


	=MVprocessaMvto(PRMempresa,;
					PRMcodigo,;
					PRMclasse,;
					PRMdata,;
					PRMhora,;
					PRMtipo,;
					PRMnota,;
					PRMordem)

	***************************
	****************	ATUALIZANDA SALDOS ABERTOS EM MESES FUTUROS
	****************
    =MVDesBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)
	
	SELE ITEMMOV
	SET ORDER TO TAG movimento
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2YB           MVBlqSaldo VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:    4  º
*       º Variable:            MVBlqSaldo                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      122                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2yb     &&  MVBlqSaldo VALID
#REGION 4
RETURN

******---------------------------------

FUNCTION MVBlqSaldo		&& Bloquear Reg de Saldo
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata

 	SELE saldo	

	************ POSICIONA SALDO CASO NAO TENHA SIDO FEITO ANTES ******
    SET ORDER TO TAG clas_saldo
    SEEK STR(PRMempresa,3)+PRMclasse+;
         STR(YEAR(PRMdata),4)+;
         STR(MONTH(PRMdata),2)

    IF !FOUND()

        =MVIniRegSaldos(PRMempresa,;
        			    PRMdata, ;
        			 	PRMcodigo,;
        			 	m.sld_atu,;
        			 	m.vlr_atu,;
        			 	m.reserva)

 		SELE SALDO
	    SET ORDER TO TAG clas_saldo
        SEEK STR(PRMempresa,3)+PRMclasse+;
    		 STR(YEAR(PRMdata),4)+;
             STR(MONTH(PRMdata),2)
   		IF !FOUND()
			=uperrosys()
			 WAIT WINDOW "ERRO. REG.SALDO NAO LOCALIZADO. <ENTER>..."
			 CLOSE ALL
			 QUIT
		ENDIF
	ENDIF
	*************************************************************

RETURN(reglock(.T.)) 	&& CONFIRMA O BLOQUEIO DO SALDO


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2YC           MVDesBlqSaldo VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:    5  º
*       º Variable:            MVDesBlqSaldo                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      123                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2yc     &&  MVDesBlqSaldo VALID
#REGION 4
RETURN

******---------------------------------

FUNCTION MVDesBlqSaldo		&& Bloquear Reg de Saldo
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata

 	SELE saldo	

	************ POSICIONA SALDO CASO NAO TENHA SIDO FEITO ANTES ******
    SET ORDER TO TAG clas_saldo
    SEEK STR(PRMempresa,3)+PRMclasse+;
         STR(YEAR(PRMdata),4)+;
         STR(MONTH(PRMdata),2)

    IF FOUND()
	   UNLOCK
	ENDIF

RETURN(reglock(.T.)) 	&& CONFIRMA O BLOQUEIO DO SALDO


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2YO           MVObterSaldos VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:    6  º
*       º Variable:            MVObterSaldos                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      124                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2yo     &&  MVObterSaldos VALID
#REGION 4
RETURN

******---------------------------------

PROCEDURE MVObterSaldos

********************   INICIO DA BUSCA DE SALDOS  **********************
PARAMETERS        m.sld_ante, m.vlr_ante, m.res_ante,;
                  m.dt_entrada, m.dt_saida,;
				  LNsldatu, LNvlratu, LNreserva,;
    	          qtd_compra, vlr_compra, ;
   	              qtd_venda , vlr_venda , ;
   	              qtd_e_tran, vlr_e_tran, ;
   	              qtd_e_outr, vlr_e_outr, ;
   	              qtd_s_tran, vlr_s_tran, ;
		          qtd_s_outr, vlr_s_outr, ;
				  ven_tab, ven_contab, ven_enc, ;
	 			  reserva

    ARQ_Itemmov  = NetArqAgain("ITEMMOV")
    ALS_Itemmov  = Alias()


    ARQ_ItmAnexo  = NetArqAgain("ITMANEXO")
    ALS_ItmAnexo  = Alias()

    ARQ_Saldo    = NetArqAgain("SALDO")
    ALS_Saldo   = Alias()


	* Captar Saldo Inicial do Mes

    SELE &ALS_Saldo
  	SET ORDER TO TAG clas_saldo
    SEEK STR(itemmov.empresa,3)+itemmov.classifica+;
    	    STR(YEAR(itemmov.data),4)+;
            STR(MONTH(itemmov.data),2)
	IF FOUND()
		m.sld_ante 	= &ALS_Saldo .sld_ante
	   	m.vlr_ante 	= &ALS_Saldo .vlr_ante
	   	m.res_ante 	= &ALS_Saldo .res_ante
		m.dt_entrada= &ALS_Saldo .dt_entrada
		m.dt_saida	= &ALS_Saldo .dt_saida

	ELSE
		m.sld_ante = 0	
	   	m.vlr_ante = 0
	   	m.res_ante 	= 0
		m.dt_entrada= {}
		m.dt_saida	= {}
	ENDIF




	SELE &ALS_Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SET NEAR ON

	SEEK STR(itemmov.EMPRESA,3) + itemmov.CODIGO   +;
		 DTOS(itemmov.DATA)     + itemmov.HORA     +;
		 itemmov.TIPO           + STR(itemmov.NOTA,7)      +;
		 STR(itemmov.ORDEM,3)

	SET NEAR OFF


	IF !(BOF() AND EOF())       && ITEMMOV ESTA VAZIO
		SKIP -1
		********************************************************
		* INICIO : ESTE BLOCO DE COMANDO FOI COLOCADO PARA EVITAR
		*          QUE QUANDO UMA RESERVA ESTIVER SENDO CANCELADA
		*          E OUTRO USUARIO INICIAR A ROTINA ATU_CMD O
		*          REGISTRO DE RESERVA QUE ESTA EM PROCESSO "****"
		*		   NAO INTERFIRA NO SALDO PROVOCANDO A MANUTENCAO
		*			DE SALDO DE RESERVA SENDO QUE A MESMA JA SAIU
		********************************************************
		DO WHILE !BOF()
		  IF &ALS_Itemmov .codigo  <> ITEMMOV.CODIGO ;
             OR &ALS_Itemmov .empresa <> ITEMMOV.EMPRESA
				EXIT
		  ENDIF

		  IF SUBS(&ALS_Itemmov .operacao,2,3) <> "***"
				EXIT
		  ENDIF
		  SKIP -1
		ENDDO
		***********************************************************
		* FIM DO BLOCO
		***********************************************************
	ENDIF
	IF BOF() ;
           OR &ALS_Itemmov .codigo      <> ITEMMOV.CODIGO ;
           OR &ALS_Itemmov .empresa     <> ITEMMOV.EMPRESA ;
		   OR YEAR(&ALS_Itemmov .data)  <> YEAR(ITEMMOV.data) ;
 		   OR MONTH(&ALS_Itemmov .data) <> MONTH(ITEMMOV.data)
						

			LNsldatu  = &ALS_Saldo .sld_ante
			LNvlratu  = &ALS_Saldo .vlr_ante
			LNreserva = &ALS_Saldo .res_ante
			m.res_ant = &ALS_Saldo .res_ante
	        STORE 0  TO  qtd_compra, vlr_compra, ;
     	                 qtd_venda , vlr_venda , ;
   	                     qtd_e_tran, vlr_e_tran, ;
   	                     qtd_e_outr, vlr_e_outr, ;
   	                     qtd_s_tran, vlr_s_tran, ;
		                 qtd_s_outr, vlr_s_outr, ;
 			 	         ven_tab, ven_contab, ven_enc, ;
	 			         reserva
	ELSE
		m.sld_ante = &ALS_Saldo .sld_ante
		m.vlr_ante = &ALS_Saldo .vlr_ante
		m.res_ante = &ALS_Saldo .res_ante

		LNsldatu  = &ALS_Itemmov .sld_estq
		LNvlratu  = &ALS_Itemmov .vlr_estq
		LNreserva = &ALS_Itemmov .sld_rese

		SELE &ALS_ItmAnexo
		SET ORDER TO TAG movanexo
		SEEK  STR(&ALS_Itemmov .empresa,3)+;
		          &ALS_Itemmov .codigo+;
			 DTOS(&ALS_Itemmov .data)+;
			      &ALS_Itemmov .hora+;
			      &ALS_Itemmov .tipo+;
			  STR(&ALS_Itemmov .nota,7)+;
			  STR(&ALS_Itemmov .ordem,3)

		IF !FOUND()
			m.qtd_compra = 0
			m.vlr_compra = 0
			m.qtd_venda  = 0
			m.vlr_venda  = 0
			m.qtd_e_tran = 0
			m.vlr_e_tran = 0
			m.qtd_e_outr = 0
			m.vlr_e_outr = 0
			m.qtd_s_tran = 0
			m.vlr_s_tran = 0
			m.qtd_s_outr = 0
			m.vlr_s_outr = 0
			m.ven_tab    = 0
			m.ven_contab = 0
			m.ven_enc    = 0
		ELSE
	        m.qtd_compra	= &ALS_ItmAnexo .q_compra
    	    m.vlr_compra	= &ALS_ItmAnexo .v_compra
        	m.qtd_venda 	= &ALS_ItmAnexo .q_venda
	        m.vlr_venda 	= &ALS_ItmAnexo .v_venda
	        m.qtd_e_tran	= &ALS_ItmAnexo .qe_tran
	        m.vlr_e_tran	= &ALS_ItmAnexo .ve_tran
	        m.qtd_e_outr	= &ALS_ItmAnexo .qe_outr
	        m.vlr_e_outr	= &ALS_ItmAnexo .ve_outr
	        m.qtd_s_tran	= &ALS_ItmAnexo .qs_tran
	        m.vlr_s_tran	= &ALS_ItmAnexo .vs_tran
	        m.qtd_s_outr	= &ALS_ItmAnexo .qs_outr
	        m.vlr_s_outr	= &ALS_ItmAnexo .vs_outr
	        m.ven_tab		= &ALS_ItmAnexo .v_tab
	        m.ven_contab	= &ALS_ItmAnexo .v_contab
	        m.ven_enc		= &ALS_ItmAnexo .v_enc
		ENDIF
	ENDIF

    =up_fecha("&ALS_Itemmov")
    =up_fecha("&ALS_ItmAnexo")
    =up_fecha("&ALS_Saldo")

	SELE itemmov

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2YZ           MVIniRegSaldos VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:    7  º
*       º Variable:            MVIniRegSaldos                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      125                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2yz     &&  MVIniRegSaldos VALID
#REGION 4
RETURN

******---------------------------------

PROCEDURE  MVIniRegSaldos   && Inicializa Registro de Saldos
PARAMETER 	LNempresa, LD_data, LScodigo, ;
            SLD_Abertura,;
            VLR_abertura, ;
            SLD_Reserva


        SELE GRUPO
        SET ORDER TO TAG CODIGO
        SEEK LScodigo
        IF !FOUND()
			=uperrosys()
			 WAIT WINDOW "ERRO. REG.PRODUTO NAO LOCALIZADO. <ENTER>..."
			 CLOSE ALL
			 QUIT
        ENDIF

        LSclassifica = Grupo.classifica

		SELE SALDO
		SET ORDER TO TAG emp_mes	
 		SEEK 	STR(LNempresa,3)+;
  			    STR(YEAR(LD_data),4)+;
			    STR(MONTH(LD_data),2)+;
			    LSclassifica
		**************************
	    m.empresa    = LNempresa
	    m.codigo     = LScodigo
	    m.classifica = LSclassifica
	    m.sld_ante   = SLD_Abertura
	    m.vlr_ante   = VLR_abertura
        m.res_ante   = SLD_Reserva
        m.reserva    = SLD_Reserva
		m.qtd_compra = 0
		m.vlr_compra = 0
		m.qtd_venda  = 0
		m.vlr_venda  = 0
		m.qtd_e_tran = 0
		m.vlr_e_tran = 0
		m.qtd_e_outr = 0
		m.vlr_e_outr = 0
		m.qtd_s_tran = 0
		m.vlr_s_tran = 0
		m.qtd_s_outr = 0
		m.vlr_s_outr = 0
		m.ven_tab    = 0
		m.ven_contab = 0
		m.ven_enc    = 0
	    m.status     = 'A'
	    IF FOUND()
	    	=REGLOCK(.T.)
			=edithand('REGRAVA')
	    ELSE
		    m.dtabert    = LD_data
			=edithand('SAVE')
	    ENDIF
	    UNLOCK
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2Z6           MVprocessaMvto VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:    8  º
*       º Variable:            MVprocessaMvto                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      126                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls2z6     &&  MVprocessaMvto VALID
#REGION 4
RETURN


FUNCTION MVprocessaMvto		&& ATUALIZA CUSTO MEDIO COM BASE NO ITEMMOV
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata,;
			PRMhora,;
			PRMtipo,;
			PRMnota,;
			PRMordem


	************************************************************

	SELE Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SET NEAR ON

	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)


	SET NEAR OFF
	
	DO WHILE !EOF() ;
			AND PRMCodigo = itemmov.codigo ;
		    AND PRMEmpresa  = itemmov.empresa
		*-----------------------------------------------------------------*
		*  A condicao :
 		*   (PRMCodigo = itemmov.codigo OR PRMClasse= itemmov.classifica) ;
		*   foicolocada em substituicao a:
 		*   (PRMClasse = itemmov.classifica) ;
 		* POR MOTIVO DE  UMA CORRUPCAO NO CAMPO classifica do itemmov
 		* que provocava a saida do laco e nao processava os movimentos
 		* posteriores ao itemmov danificado. Como o codigo estava intacto
 		* esta condicao permite uma tolerancia a corrupcao do campo
 		* mesmo nao resolvendo o problema
		*-----------------------------------------------------------------*
		MsgStep = STR(PRMempresa,3)+"-"+itemmov.codigo+"-"+;
		          DTOS(itemmov.data)+"-"+itemmov.hora+"-"+;
		          itemmov.tipo+"-"+STR( itemmov.nota,7)+"-"+;
				STR(itemmov.ordem,3)
		wait window MsgStep nowait
 		
		

		SELE itemmov
		=REGLOCK(.T.)		&& BLOQ. ITEMMOV P/ ATUALIZAR

		IF YEAR(saldo.dtabert)  <> YEAR(itemmov.data) or ;
		   MONTH(saldo.dtabert) <> MONTH(itemmov.data)

				****** TESTA MOTIVO DO CHAMADO A ROTINA ********
				***********************************************

			    =MVAtlzSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
						    m.sld_ante, 		m.vlr_ante, ;
						    m.res_ante,;
			    			LNsldatu, 			LNvlratu, ;
							m.qtd_compra, 		m.vlr_compra, ;
  			 				m.qtd_venda , 		m.vlr_venda , ;
 			  				m.qtd_e_tran, 		m.vlr_e_tran, ;
  			  				m.qtd_e_outr, 		m.vlr_e_outr, ;
  			  				m.qtd_s_tran, 		m.vlr_s_tran, ;
  			  				m.qtd_s_outr, 		m.vlr_s_outr)

				* Rotina complementar em funcao do excesso de parametros
				* para MVAtlzSaldos impedir o uso de uma so procedure

			    =MVAtlzComplSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
				  				m.ven_tab, ;
				  				m.ven_contab, ;
								m.ven_enc, ;
				  				m.dt_entrada, ;
				  				m.dt_saida, ;
			  					LNreserva )



				*----------------------------------------------------*
				*   O movimento Passou para uma data fora do mes
				* em que o registro de saldo estava posicionado,
				* entao o reg. de saldo deve ser inicializado no
				* mes seguite mesmo que o movimento tenha saltado
				* mais de um mes, ou seja, pode haver um mes sem
				* REGISTRO DE MOVIMENTO mas nao sem REGISTRO DE SALDO
				*----------------------------------------------------*

				LD_nvdata = GOMONTH(saldo.dtabert,1)


		        =MVIniRegSaldos( saldo.empresa,;
		        			     LD_nvdata,;
		        			     saldo.codigo,;
		        			     LNsldatu,;
		        			     LNvlratu,;
		        			     LNreserva)

				SELE itemmov

				LOOP
		ENDIF




		PRIVATE tipo,operacao, qtde, tp_mercad, cst
		PRIVATE aliq_icms, vlrvenda,base_calc, vlripi, custo_ind
        PRIVATE icms_subs
		PRIVATE preco, ch_opera, ch_desti, codigo, classifica

		PRIVATE movfin,movestq,movvalor,movcusto
		PRIVATE orcamento,codforn


		SCATTER MEMVAR MEMO FIELDS tipo,operacao, qtde, tp_mercad, cst,;
			aliq_icms, vlrvenda,base_calc, vlripi, custo_ind, preco,;
            icms_subs,	ch_opera, ch_desti, codigo, classifica,;
			movfin,movestq,movvalor,movcusto,orcamento,codforn

*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
*>>>>>>>>>>>>>>>>>>>>>>>>>>   MOVIMENTACAO DE SALDOS AUXILIARES
*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		SET DECIMALS TO 8

        =MVGetCustMedio((operacao), (movcusto),LNcstmedio, ;
         							 LNsldatu, LNvlratu)

		*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		LNredutor   = 0
		LSoperacao  = "/"		&& => DIVISAO PELO LNredutor

        =MVGetIndRedutor((operacao), LNredutor,LSoperacao)

		IF LEFT(m.operacao,1) = "E"
			m.dt_entrada  = itemmov.data
		ELSE
			IF LEFT(m.operacao,1) = "S"
					m.dt_saida  = itemmov.data
			ENDIF			
		ENDIF

		*----------------------------------------------------------*
	*	PRIVATE LSUfOrigem
	*	PRIVATE LSUfDestino
		PRIVATE LNcusto

		IF LEFT(itemmov.operacao,1) = "E"		&& ENTRADAS
			=W_DEFPROC("notaite.spr")
			LNcusto= IEGetCusto( itemmov.Empresa, ;
					         itemmov.Favorecido,;
							 itemmov.orcamento , ;					
							 itemmov.ordem)
		ELSE
			LNcusto = 0
		ENDIF

		*----------------------------------------------------------*



		DO MVSetSldEntradas WITH LNcusto

		DO MVSetSldSaida
		
		DO MVSetSaldos WITH PrmEmpresa, LNcusto



		*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		*>>>>>>>>>>>>>>>>>>>>> FIM DOS TESTES DE CONTROLE DE MOVIMENTACAO
		*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		SET DECIMALS TO 2



		SELE itmanexo
		*****************************************************
        =MVSincrItmAnexo(m.qtd_compra, m.vlr_compra, m.qtd_venda,;
        				m.vlr_venda,  m.qtd_e_tran,    m.vlr_e_tran, ;
        				m.qtd_e_outr, m.vlr_e_outr, m.qtd_s_tran,;
        				m.vlr_s_tran, m.qtd_s_outr, m.vlr_s_outr,;
        				m.ven_tab	, m.ven_contab, m.ven_enc)
		*****************************************************
		m.sld_estq	= LNsldatu
		IF m.sld_estq = 0 OR LNvlratu = 0
		   m.vlr_estq = LNcstmedio && ULTIMO CUSTO
		   LNvlratu	  =  LNcstmedio
		ELSE
		    m.vlr_estq  = LNvlratu
		ENDIF
        IF LNreserva < 0	&& caso de interf. do usua.no reg. de res.
			LNreserva = 0
		ENDIF
		m.sld_rese  = LNreserva

		

		SELE itemmov
		SET FIELDS TO dtregis, hregis, usrregis,deletado
	    SET FIELDS TO sld_estq, vlr_estq, sld_rese
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		*****************************************************
		UNLOCK
		SKIP
	ENDDO

 	SELECT SALDO

	=MVAtlzSaldos(saldo.empresa,saldo.classifica,;
			    			 saldo.dtabert,;
						    m.sld_ante,	m.vlr_ante, ;
                            m.res_ante,;
			    			LNsldatu, 			LNvlratu, ;
							m.qtd_compra, 		m.vlr_compra, ;
   			 				m.qtd_venda , 		m.vlr_venda , ;
   			  				m.qtd_e_tran, 		m.vlr_e_tran, ;
   			  				m.qtd_e_outr, 		m.vlr_e_outr, ;
   			  				m.qtd_s_tran, 		m.vlr_s_tran, ;
   			  				m.qtd_s_outr, 		m.vlr_s_outr)

				* Rotina complementar em funcao do excesso de parametros
				* para MVAtlzSaldos impedir o uso de uma so procedure

    =MVAtlzComplSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
				  				m.ven_tab, ;
				  				m.ven_contab, ;
								m.ven_enc, ;
				  				m.dt_entrada, ;
				  				m.dt_saida, ;
			  					LNreserva )



	PRMdata = saldo.dtabert

 	SELECT SALDO
	UNLOCK
	=MVSldFuturo(PRMempresa,;
				 PRMclasse,;
				 PRMdata,;
				 LNsldatu,;
				 LNvlratu,;
				 LNreserva)

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2ZL           MVSincrItmAnexo VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:    9  º
*       º Variable:            MVSincrItmAnexo                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      127                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2zl     &&  MVSincrItmAnexo VALID
#REGION 4
RETURN

******---------------------------------

PROCEDURE MVSincrItmAnexo
PARAMETERS  m.q_compra, m.v_compra,  m.q_venda, m.v_venda,;
			m.qe_tran , m.ve_tran ,  m.qe_outr, m.ve_outr,;
			m.qs_tran , m.vs_tran ,  m.qs_outr, m.vs_outr,;
			m.v_tab   , m.v_contab,  m.v_enc

			


********************  INICIO DA BUSCA DE SALDOS **********************
	SELE itmanexo
	SET ORDER TO TAG movanexo
	SEEK STR(itemmov.empresa,3)+itemmov.codigo+;
			 DTOS(itemmov.data)+itemmov.hora+itemmov.tipo+;
			 STR(itemmov.nota,7)+STR(itemmov.ordem,3)
	IF !FOUND()
		SELE itmanexo
		SET ORDER TO TAG movanexo
		m.empresa 	= itemmov.empresa
		m.codigo 	= itemmov.codigo
	    m.classifica = itemmov.classifica
		m.data		= itemmov.data
		m.hora		= itemmov.hora
		m.tipo		= itemmov.tipo
		m.nota		= itemmov.nota
		m.ordem		= itemmov.ordem

		=edithand('SAVE')
    ELSE
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO ;
  	           	q_compra, v_compra,q_venda, v_venda, qe_tran, ve_tran,;
				qe_outr,ve_outr,qs_tran, vs_tran, qs_outr,vs_outr,;
				v_tab, v_contab, v_enc	
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2ZS           MVAtlzSaldos VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:   10  º
*       º Variable:            MVAtlzSaldos                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      128                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2zs     &&  MVAtlzSaldos VALID
#REGION 4
RETURN

******---------------------------------

PROCEDURE MVAtlzSaldos

PARAMETERS   	PRempresa,			PRclassifica,;
				PRdata,;
			    m.sld_ante, 		m.vlr_ante, ;
                m.res_ante,;
	   			m.sld_atu, 			m.vlr_atu, ;
				m.qtd_compra, 		m.vlr_compra, ;
    			m.qtd_venda , 		m.vlr_venda , ;
    			m.qtd_e_tran, 		m.vlr_e_tran, ;
    			m.qtd_e_outr, 		m.vlr_e_outr, ;
    			m.qtd_s_tran, 		m.vlr_s_tran, ;
    			m.qtd_s_outr, 		m.vlr_s_outr


	IF m.sld_atu = 0
		m.sld_atu = 0
		m.vlr_atu = 0
*	ELSE
*        IF m.reserva < 0	&& caso de interf. do usua.no reg. de res.
*			m.reserva = 0
*		ENDIF
	ENDIF




    ARQ_Saldo    = NetArqAgain("SALDO")
    ALS_Saldo    = Alias()

   	SELE &ALS_Saldo
  	SET ORDER TO TAG clas_saldo
    SEEK STR(PRempresa,3)+PRclassifica+;
    		STR(YEAR(PRdata),4)+;
        	STR(MONTH(PRdata),2)

	***************************
	SET FIELDS TO dtregis, hregis, usrregis,deletado
    SET FIELDS TO sld_ante, vlr_ante, ;
                  res_ante,;
			      sld_atu, vlr_atu, qtd_compra, vlr_compra, ;
    			  qtd_venda , vlr_venda , ;
    			  qtd_e_tran, vlr_e_tran, ;
    			  qtd_e_outr, vlr_e_outr, ;
    			  qtd_s_tran, vlr_s_tran, ;
    			  qtd_s_outr, vlr_s_outr, ;
				  ven_tab, ven_contab, ven_enc, ;
				  dt_entrada,dt_saida, reserva

     IF FOUND()
		=edithand('REGRAVA')
	 ELSE
		=edithand('SAVE')
   	 ENDIF	
	CLEAR FIELDS
	SET FIELDS OFF
    UNLOCK
    =up_fecha("&ALS_Saldo")

	***************************

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS2ZT           MVAtlzComplSaldos VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:   11  º
*       º Variable:            MVAtlzComplSaldos                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      129                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls2zt     &&  MVAtlzComplSaldos VALID
#REGION 4
RETURN

******---------------------------------

* Rotina complementar em funcao do excesso de parametros
* para MVAtlzSaldos

PROCEDURE MVAtlzComplSaldos

PARAMETERS   	PRempresa,			PRclassifica,;
				PRdata,;
				m.ven_tab, 			m.ven_contab, ;
				m.ven_enc, ;
				m.dt_entrada, 		m.dt_saida, ;
				m.reserva

    ARQ_Saldo    = NetArqAgain("SALDO")
    ALS_Saldo    = Alias()

   	SELE &ALS_Saldo
  	SET ORDER TO TAG clas_saldo
    SEEK STR(PRempresa,3)+PRclassifica+;
    		STR(YEAR(PRdata),4)+;
        	STR(MONTH(PRdata),2)

	***************************
    SET FIELDS TO  ven_tab, ven_contab, ven_enc, ;
				  dt_entrada,dt_saida, reserva

     IF FOUND()
		=edithand('REGRAVA')
	 ELSE
		=edithand('SAVE')
   	 ENDIF	
	CLEAR FIELDS
	SET FIELDS OFF
    UNLOCK
    =up_fecha("&ALS_Saldo")

	***************************

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS306           MVGetCustMedio VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:   12  º
*       º Variable:            MVGetCustMedio                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      130                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls306     &&  MVGetCustMedio VALID
#REGION 4
RETURN

******---------------------------------

PROCEDURE MVGetCustMedio

PARAMETERS  m.operacao, movcusto, LNcstmedio, LNsldatu, LNvlratu

        LNcstmedio = 0
		DO CASE
			CASE  (m.movcusto = "N" 	AND LNsldatu = 0)
		   	   LNcstmedio = LNvlratu  && ASSUME ULTIMO CUSTO ANTES DE ZERAR
			
			CASE  LEFT(m.operacao,1) = "S" AND ;
				  m.movcusto <> "N"  AND LNsldatu = 0

			*-------- ATENDE ex: VLG = COMPLEM DE PRECO EM PRODUTO ZERADO
		   	   LNcstmedio = LNvlratu  && ASSUME ULTIMO CUSTO ANTES DE ZERAR
									  && P/REGISTRAR VLR.DA OPERACAO
									  && DO CONTRARIO SERIA VLR=0 DEVIDO
									  && AO SALDO 0

			CASE  LEFT(m.operacao,1) = "E" AND ;
				  m.movcusto = "S" AND LNsldatu = 0
		       LNcstmedio = 0
		   	   LNvlratu   = 0         && ASSUME NOVO CUSTO A PARTIR DO ZERO
			CASE LNsldatu > 0 	
			   LNcstmedio = LNvlratu / LNsldatu   && ASSUME CUSTO ATUAL
		ENDCASE

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS30C           MVGetIndRedutor VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:   13  º
*       º Variable:            MVGetIndRedutor                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      131                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls30c     &&  MVGetIndRedutor VALID
#REGION 4
RETURN

******---------------------------------

PROCEDURE MVGetIndRedutor

PARAMETERS  m.operacao, LNredutor, LSoperacao

		**************************************
		*   Aplicando o INDICE DE REDUCAO AO VLRVENDA provoca-se a
		* retirada do do VALOR DE ICMS que esta agregada ao valor
		* da mercadoria
		**************************************

		IF itemmov.data   < CTOD("01.05.2003")
		   do ind_ate010503
		ELSE
		   do ind_dep010503
		ENDIF

RETURN


PROCEDURE ind_dep010503

		LNredutor   = 1
		LSoperacao  = "*"		&& => no novo calculo de custo evista
		IF LEFT(m.operacao,1) = "E"
			m.dt_entrada  = itemmov.data
			IF m.tp_mercad <> 2
				LNredutor = 1-(m.aliq_icms /100)  && Extrair ICMS do custo
			ENDIF
		ENDIF
RETURN

PROCEDURE ind_ate010503

		LNredutor   = 0
		LSoperacao  = "/"	&& =>PARA MANTER COERENCIA ANTIGA
		IF LEFT(m.operacao,1) = "E"
			m.dt_entrada  = itemmov.data
			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************
			*********************************************************
			*    Inicio de tratamento nao parametrizavel ( ESPECIFICO)
			*		Para PNEUS Ind,Caminhao,Tratores,Agric,Terrapl
			*	> "00448"  e < "00800"	
			**********************************************************
			IF itemmov.data      >= CTOD("11.10.1997") AND ;
					   m.ch_opera   = "2" AND m.ch_desti   = "1" AND ;
					   m.tp_mercad = 2
					    IF LEFT(itemmov.classifica,5) > "00448" AND ;
						   LEFT(itemmov.classifica,5) < "00800"
							LNredutor = 1.24
						ELSE
							LNredutor = 1.26
						ENDIF				
			ELSE
				IF itemmov.data  >= CTOD("01.09.1999")
					LNredutor = 1-(m.aliq_icms /100)
					LSoperacao  = "*"	&& => MULTIPLICACAO PELO LNredutor
				ELSE
					LNredutor = 1+(m.aliq_icms /100)
					LSoperacao  = "/"	&& =>PARA MANTER COERENCIA ANTIGA
				ENDIF
			ENDIF
			**************************************
			* FIM APLICA INDICE DE REDUCAO AO VLRVENDA
			**************************************
		ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS30K           MVSetSldEntradas VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:   14  º
*       º Variable:            MVSetSldEntradas                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      132                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls30k     &&  MVSetSldEntradas VALID
#REGION 4
RETURN

******---------------------------------

PROCEDURE MVSetSldEntradas
PARAMETERS LNcusto

		DO CASE
			CASE itemmov.data   < CTOD("01.05.2003")
				   do ste_ate010503
			CASE itemmov.data   < CTOD("01.07.2003") && CTOD("20.08.2003")
													 && CTOD("22.07.2003")
				   do ste_dep010503
			OTHERWISE
				   do ste_nvocst
		ENDCASE
RETURN


PROCEDURE ste_nvocst   && INCORPORA ICMS_SUBS AO CUSTO

   		DO CASE
			* ---------------> ENTRADAS PROCESSADAS
			CASE m.operacao = 'ECP.' 	 && ENTRADA\COMPRA\PROCESSADA
 			   	 m.qtd_compra = m.qtd_compra + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S" OR (m.movcusto = "N" AND LNvlratu = 0)
				   	 m.vlr_compra = m.vlr_compra + LNcusto
				 ELSE
				   	 m.vlr_compra = m.vlr_compra  + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ETP.'     &&  ENTRADA\TRANSF.\PROCESSADA
		   		 m.qtd_e_tran = m.qtd_e_tran + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S" OR (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_tran = m.vlr_e_tran + LNcusto
				 ELSE
			   		 m.vlr_e_tran = m.vlr_e_tran + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ERP.' OR ;
			     m.operacao = 'EDP.' OR ;
			     m.operacao = 'EOP.'      &&  ENTRADA\OUTRAS\PROCESSADA
		   		 m.qtd_e_outr = m.qtd_e_outr + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S" OR (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_outr = m.vlr_e_outr + LNcusto
				 ELSE
			   		 m.vlr_e_outr = m.vlr_e_outr + (m.qtde * LNcstmedio)
				 ENDIF

		ENDCASE
RETURN



PROCEDURE ste_dep010503   && INCORPORA ICMS_SUBS AO CUSTO

   		DO CASE
			* ---------------> ENTRADAS PROCESSADAS
			CASE m.operacao = 'ECP.' 	 && ENTRADA\COMPRA\PROCESSADA
 			   	 m.qtd_compra = m.qtd_compra + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
					IF m.ch_desti = "3"		&& ignora ICMS (NAO EMBUTIDO)
					   	 m.vlr_compra = m.vlr_compra ;
				   	 	+ m.vlrvenda + m.vlripi + m.custo_ind +	m.icms_subs
					ELSE
					   	 m.vlr_compra = m.vlr_compra ;
						   	 	+ (m.vlrvenda &LSoperacao LNredutor) ;
				   	 			+ m.vlripi + m.custo_ind + m.icms_subs
					ENDIF
				 ELSE
				   	 m.vlr_compra = m.vlr_compra ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ETP.'     &&  ENTRADA\TRANSF.\PROCESSADA
		   		 m.qtd_e_tran = m.qtd_e_tran + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_tran = m.vlr_e_tran ;
							+ (m.vlrvenda &LSoperacao LNredutor) ;
							+ m.vlripi + m.custo_ind + m.icms_subs
				 ELSE
			   		 m.vlr_e_tran = m.vlr_e_tran ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ERP.' OR ;
			     m.operacao = 'EDP.' OR ;
			     m.operacao = 'EOP.'      &&  ENTRADA\OUTRAS\PROCESSADA
		   		 m.qtd_e_outr = m.qtd_e_outr + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_outr = m.vlr_e_outr ;
				   		 			+ (m.vlrvenda &LSoperacao LNredutor) ;
				   		 			+ m.vlripi + m.custo_ind + m.icms_subs
				 ELSE
			   		 m.vlr_e_outr = m.vlr_e_outr ;
			   		 		+ (m.qtde * LNcstmedio)
				 ENDIF

		ENDCASE
RETURN

PROCEDURE ste_ate010503

   		DO CASE
			* ---------------> ENTRADAS PROCESSADAS
			CASE m.operacao = 'ECP.' 	 && ENTRADA\COMPRA\PROCESSADA
 			   	 m.qtd_compra = m.qtd_compra + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
					IF m.ch_desti = "3"		&& ignora ICMS (NAO EMBUTIDO)
					   	 m.vlr_compra = m.vlr_compra ;
				   	 	+ m.vlrvenda + m.vlripi + m.custo_ind
					ELSE
					   	 m.vlr_compra = m.vlr_compra ;
						   	 	+ (m.vlrvenda &LSoperacao LNredutor) ;
				   	 			+ m.vlripi + m.custo_ind
					ENDIF
				 ELSE
				   	 m.vlr_compra = m.vlr_compra ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ETP.'     &&  ENTRADA\TRANSF.\PROCESSADA
		   		 m.qtd_e_tran = m.qtd_e_tran + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_tran = m.vlr_e_tran ;
							+ (m.vlrvenda &LSoperacao LNredutor) ;
							+ m.vlripi + m.custo_ind
				 ELSE
			   		 m.vlr_e_tran = m.vlr_e_tran ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ERP.' OR ;
			     m.operacao = 'EDP.' OR ;
			     m.operacao = 'EOP.'      &&  ENTRADA\OUTRAS\PROCESSADA
		   		 m.qtd_e_outr = m.qtd_e_outr + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_outr = m.vlr_e_outr ;
				   		 			+ (m.vlrvenda &LSoperacao LNredutor) ;
				   		 			+ m.vlripi + m.custo_ind
				 ELSE
			   		 m.vlr_e_outr = m.vlr_e_outr ;
			   		 		+ (m.qtde * LNcstmedio)
				 ENDIF

		ENDCASE
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS30X           MVSetSldSaidas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:   15  º
*       º Variable:            MVSetSldSaidas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      133                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls30x     &&  MVSetSldSaidas VALID
#REGION 4
RETURN

******---------------------------------

PROCEDURE MVSetSldSaidas


		DO CASE

************CASE  m.tp_mercad = 7 AND  LEFT(m.operacao,1) = 'S' && SAIDA

			*-- SERVICO/SAIDA/VENDA/NAO NF DE ENTRADA--------------*
			CASE  m.tp_mercad = 7 AND LEFT(m.operacao,1) = 'S' AND ;
				  m.ch_opera = "1" AND m.tipo <> "ENT"

				 IF m.movestq = "S"
					 m.qtd_venda  = m.qtd_venda  + m.qtde
					 m.vlr_venda = m.vlr_venda   + m.vlrvenda + m.vlripi
				 ENDIF

			*-- SAIDA/VENDA/NAO NF DE ENTRADA--------------*

			CASE  LEFT(m.operacao,1) = 'S' AND ;
				  m.ch_opera = "1" AND m.tipo <> "ENT"
				 IF m.movestq = "S"
					 m.qtd_venda  = m.qtd_venda  + m.qtde
					 m.vlr_venda  = m.vlr_venda  + (LNcstmedio * m.qtde)
			   		 m.ven_contab = m.ven_contab + (m.qtde * LNcstmedio)
				 ENDIF

				 IF m.movvalor <> "N" 	&& Nos 1os MOVIMENTOS o Sim = ESPACO BRANCO
			   		 m.ven_tab 	  = m.ven_tab    + (m.qtde * m.preco)
					 m.ven_enc    = m.ven_enc +  m.vlrvenda	 + m.vlripi
					            && VEND.NO.PRECO FIN.c/ENCARG.
				 ENDIF
	 			 *---- O VALOR DA VENDA COM ENCARGOS = VLRVENDA --*
			CASE LEFT(m.operacao,3) = 'STP' && SAIDA\TRANSF.\PROCESSADAS
				 IF m.movestq = "S"
			   		 m.qtd_s_tran = m.qtd_s_tran + m.qtde
					 *---- CALCULO ESPECIAL PARA TRANSFERENCIAS ------*
					*----------------------------------------------------*
					*      O uso da fun‡Æo UPcustotransf foi desativado em
					* 27/12/2000 por ser redundante. O custo  apurado na
					* funcÆo equivale ao custo normal que e calculado de
					* forma direta.
					*     O calculo usado na funcao parte do valor
					* registrado na nota de saida e que nao ‚ corrigido
					* quando o custo ‚ alterado pela corre‡Æo de uma entrada
					* anterior a tranf. EX:
					*     Na filial SIA foi dada entrada de produto em
					* codigo trocado o que elevou o custo deste e logo em
					* seguida foi feita transf. com custo errado. quando
					* a entrada foi corrigida o custo medio ficou correto
					* mas a transf nao foi ajusta.
					*----------------------------------------------------*
					* m.vlr_s_tran = m.vlr_s_tran+(m.qtde * UPcustotrasf())
					*----------------------------------------------------*
			   		 m.vlr_s_tran = m.vlr_s_tran + (m.qtde * LNcstmedio)
				 ENDIF
			CASE LEFT(m.operacao,1) = 'S' AND ;
			     SUBS(m.operacao,3,1) = 'P'	&& SAIDA\? OUTRAS ?\PROCESSADAS
				 IF m.movestq = "S"
			   		 m.qtd_s_outr = m.qtd_s_outr + m.qtde
			   		 m.vlr_s_outr = m.vlr_s_outr + (m.qtde * LNcstmedio)
				 ENDIF
		ENDCASE
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS315           MVSetSaldos VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:   16  º
*       º Variable:            MVSetSaldos                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      134                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls315     &&  MVSetSaldos VALID
#REGION 4
RETURN

******---------------------------------

PROCEDURE MVSetSaldos
PARAMETERS 	PRMempresa, LNcusto
	
	LSalias	= ALIAS()
    PRIVATE ARQ_Empresa,ALS_Empresa

	LSalias	= ALIAS()
	*-----------------------------------------------------------*


    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa

	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE SALDO ESTOQUE			*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF m.movestq = "S"
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
				IF SUBS(m.operacao,3,1) = "P" && SAIDA PROCESSADA
							LNsldatu   = LNsldatu - m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
				IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
						LNsldatu = LNsldatu + m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "R" AND m.operacao <> "R***"
				LNreserva  = LNreserva + m.qtde
		ENDCASE
	ENDIF


	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE VALOR ESTOQUE		*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA

		DO CASE
			CASE itemmov.data   < CTOD("01.05.2003")
					do Set_ate010503     && usado antes de  01/05/2003

			CASE itemmov.data   < CTOD("01.07.2003") && CTOD("20.08.2003")
													 && CTOD("22.07.2003")
					do Set_dep010503	 && usado depois de  01/05/2003
			OTHERWISE
				    do set_nvocst
		ENDCASE

    ENDIF

    =UP_Fecha("&ALS_Empresa")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN

PROCEDURE set_nvocst

	 DO CASE
		CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
			LNvlratu	= LNcstmedio * LNsldatu

		CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
			*--------------------------------------------------*
			IF m.movcusto = "S" OR (LNvlratu = 0)
				LNvlratu = LNvlratu + LNcusto
			ELSE
				LNvlratu	= LNcstmedio * LNsldatu
			ENDIF
			*-------------------------------------------------------*
	 ENDCASE
RETURN

*--------------------------------------------*
PROCEDURE Set_ate010503

	 DO CASE
		CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
			LNvlratu	= LNcstmedio * LNsldatu

		CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
			*--------------------------------------------------*
			IF m.movcusto = "S" OR (LNvlratu = 0)
				DO CASE
					CASE m.ch_desti = "3"	&& ignora ICMS (NAO
										&& EMBUTIDO) INTERNACIONAL
						LNvlratu = LNvlratu + m.vlrvenda ;
							 + m.vlripi + m.custo_ind
					OTHERWISE
						LNvlratu = LNvlratu ;
							+ (m.vlrvenda &LSoperacao LNredutor) ;
						 	+ m.vlripi + m.custo_ind
				ENDCASE
			ELSE
				LNvlratu	= LNcstmedio * LNsldatu
			ENDIF
			*-------------------------------------------------------*
	 ENDCASE
RETURN

*------------------------------------------------*
PROCEDURE Set_dep010503

	 DO CASE
		CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
			LNvlratu	= LNcstmedio * LNsldatu

		CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
			*--------------------------------------------------*
			IF m.movcusto = "S" OR (LNvlratu = 0)
				DO CASE
					CASE m.ch_desti = "3"	&& ignora ICMS (NAO
										&& EMBUTIDO) INTERNACIONAL
						LNvlratu = LNvlratu + m.vlrvenda ;
							 + m.vlripi + m.custo_ind
					OTHERWISE
						IF m.tp_mercad = 2	&& Regime Substituicao
							LNvlratu = LNvlratu + m.vlrvenda ;
								+ m.vlripi + m.custo_ind + m.icms_subs
						ELSE
							LNvlratu = LNvlratu ;
								+ (m.vlrvenda &LSoperacao LNredutor) ;
							 	+ m.vlripi + m.custo_ind + m.icms_subs
						ENDIF
				ENDCASE
			ELSE
				LNvlratu	= LNcstmedio * LNsldatu
			ENDIF
				*-------------------------------------------------------*
	 ENDCASE
RETURN
*------------------------------------------------*



PROCEDURE ANT2MVSetSaldos
	

	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE SALDO ESTOQUE			*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF m.movestq = "S"
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
				IF SUBS(m.operacao,3,1) = "P" && SAIDA PROCESSADA
							LNsldatu   = LNsldatu - m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
				IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
						LNsldatu = LNsldatu + m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "R" AND m.operacao <> "R***"
				LNreserva  = LNreserva + m.qtde
		ENDCASE
	ENDIF


	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE VALOR ESTOQUE		*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS

				LNvlratu	= LNcstmedio * LNsldatu

			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS

				*-------------------------------------------------------*
				IF m.movcusto = "S" OR (LNvlratu = 0)
					IF m.ch_desti = "3"		&& ignora ICMS (NAO EMBUTIDO) INTERNACIONAL
						LNvlratu = LNvlratu + m.vlrvenda ;
									 + m.vlripi + m.custo_ind
					ELSE
									
						LNvlratu = LNvlratu ;
								+ (m.vlrvenda &LSoperacao LNredutor) ;
								 	+ m.vlripi + m.custo_ind

					ENDIF
				ELSE
					LNvlratu	= LNcstmedio * LNsldatu
				ENDIF

				*-------------------------------------------------------*


		ENDCASE
	ENDIF

RETURN

*--------------------------------------------------*
* PROCESSO ANTIGO
*--------------------------------------------------*

PROCEDURE AntgMVSetSaldos
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
				DO CASE
					CASE SUBS(m.operacao,3,1) = "P" && SAIDA PROCESSADA
						 IF m.movestq = "S"
								LNsldatu   = LNsldatu - m.qtde
						 ENDIF
						&& CALCULA CUSTO MEDIO ATUAL
						&& ATUALIZA VALOR ESTOQUE
						LNvlratu	= LNcstmedio * LNsldatu
				ENDCASE
			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
				DO CASE
					CASE SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
						LNsldatu = LNsldatu + m.qtde
						*----------------------------------------------*
						IF m.movcusto = "S" OR (LNvlratu = 0)


							IF m.ch_desti = "3"	&& ignora ICMS (NAO
												&& EMBUTIDO) INTERNACIONAL
							    LNvlratu = LNvlratu + m.vlrvenda ;
									 + m.vlripi + m.custo_ind
							ELSE
								LNvlratu = LNvlratu ;
									+ (m.vlrvenda &LSoperacao LNredutor) ;
									 	+ m.vlripi + m.custo_ind
							ENDIF

						ELSE
							LNvlratu	= LNcstmedio * LNsldatu
						ENDIF

						*----------------------------------------------*

				ENDCASE

			CASE  LEFT(m.operacao,1) = "R" AND m.operacao <> "R***"
				LNreserva  = LNreserva + m.qtde
		ENDCASE


RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS31I           MVSldFuturo VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         MOVIMENT,     Record Number:   17  º
*       º Variable:            MVSldFuturo                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      135                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls31i     &&  MVSldFuturo VALID
#REGION 4
RETURN

******---------------------------------

FUNCTION MVSldFuturo		&& Bloquear Reg de Saldo
PARAMETERS PRMempresa, ;
			PRMclassifica, ;
			PRMdata, ;
			PRMsldatu, ;
			PRMvlratu, ;
			PRMreserva

 	SELECT SALDO
	SET ORDER TO TAG clas_saldo

    SEEK STR(PRMempresa,3)+PRMclassifica+;
    	    STR(YEAR(PRMdata),4)+;
            STR(MONTH(PRMdata),2)

	IF !EOF()
		SKIP
		m.sld_ante   = PRMsldatu
		m.vlr_ante   = PRMvlratu
        m.res_ante   = PRMreserva
		m.sld_atu 	 = PRMsldatu
		m.vlr_atu    = PRMvlratu
		m.reserva	 = PRMreserva
		m.qtd_compra = 0
		m.vlr_compra = 0
		m.qtd_venda  = 0
		m.vlr_venda  = 0
		m.qtd_e_tran = 0
		m.vlr_e_tran = 0
		m.qtd_e_outr = 0
		m.vlr_e_outr = 0
		m.qtd_s_tran = 0
		m.vlr_s_tran = 0
		m.qtd_s_outr = 0
		m.vlr_s_outr = 0
		m.ven_tab    = 0
		m.ven_contab = 0
		m.ven_enc    = 0
	    m.status     = 'A'
		DO WHILE !EOF() AND PRMclassifica = saldo.classifica ;
						AND PRMempresa	  = saldo.empresa
			=MVAtlzSaldos(saldo.empresa,saldo.classifica,;
			    			 saldo.dtabert,;
						    m.sld_ante, 		m.vlr_ante, ;
						    m.res_ante,;
			    			m.sld_atu, 			m.vlr_atu, ;
							m.qtd_compra, 		m.vlr_compra, ;
   			 				m.qtd_venda , 		m.vlr_venda , ;
   			  				m.qtd_e_tran, 		m.vlr_e_tran, ;
   			  				m.qtd_e_outr, 		m.vlr_e_outr, ;
   			  				m.qtd_s_tran, 		m.vlr_s_tran, ;
   			  				m.qtd_s_outr, 		m.vlr_s_outr)


				* Rotina complementar em funcao do excesso de parametros
				* para MVAtlzSaldos impedir o uso de uma so procedure

			    =MVAtlzComplSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
				  				m.ven_tab, ;
				  				m.ven_contab, ;
				  				m.ven_enc, ;
				  				m.dt_entrada, ;
				  				m.dt_saida, ;
				  				m.reserva )

			***************************
			SELE SALDO
			SKIP
		ENDDO
	ENDIF
	SET ORDER TO TAG emp_mes

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS31R           PRVlrSaida VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:    2     º
*       º Variable:            PRVlrSaida                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      136                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls31r     &&  PRVlrSaida VALID
#REGION 5
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRVlrSaida
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto, PrmEspecifico

	=W_DEFPROC("rotinas.spr")
	PRIVATE LNvalor
	PRIVATE LSalias

	PRIVATE LNtp_mercad
	
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_orcamento,ALS_orcamento
    PRIVATE ARQ_clienc,ALS_clienc
    PRIVATE ARQ_tipooper,ALS_tipooper
    PRIVATE ARQ_grupo,ALS_grupo
    PRIVATE ARQ_saldo,ALS_saldo
    PRIVATE ARQ_Preco,ALS_Preco




	LSalias = ALIAS()
	LNvalor = 0

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_orcamento     = NetArqAgain("ORCAMENTO")
    ALS_Orcamento     = Alias()

    ARQ_clienc     = NetArqAgain("clienc")
    ALS_clienc     = Alias()


    ARQ_Tipooper     = NetArqAgain("TIPOOPER")
    ALS_Tipooper     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Saldo     = NetArqAgain("SALDO")
    ALS_Saldo     = Alias()

    ARQ_Preco     = NetArqAgain("PRECO")
    ALS_Preco     = Alias()


	IF (ARQ_Empresa + ARQ_Orcamento+ARQ_tipooper+;
		ARQ_grupo+ARQ_Saldo+ARQ_Preco+Arq_clienc) > 100000
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF
	*---------------------------------------------------------*
    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

	SELECT &ALS_Clienc
	SET ORDER TO tag emporca
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF


	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

	*------------------------------------------------------------*
	=W_DEFPROC("TRIBUTAR.SPR")

	DO CASE

        *------------------------------------------------------------*
        * A venda bonificacao deve sair com mesmo valor aplicado as  *
        * transferencias                                             *
        *------------------------------------------------------------*
		Case TYPE("PrmEspecifico") = "C"
		    DO CASE
			  CASE PrmEspecifico = "VENDA BONIFICACAO"
				LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
					ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)
		    ENDCASE

		CASE &ALS_tipooper .ch_opera = "2" && TRANSFERENCIAS
			LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
				ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)

		CASE &ALS_tipooper .tipo = "RDO" && REMESP DEPO.FECHADO
			LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
				ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)

		CASE left( &ALS_tipooper .tipo,1) = "R" && REMESSAS EM GERAL
			LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
				ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)


		OTHERWISE
			LNvalor = PRVlrVenda(PrmEmpresa, PrmOrcamento, PrmProduto,;
	 			ALS_Empresa,ALS_Orcamento,ALS_Preco)

	ENDCASE

	*------------------------------------------------------------*

    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Orcamento")
    =up_fecha("&ALS_Tipooper")
    =up_fecha("&ALS_Grupo")
    =up_fecha("&ALS_Saldo")
    =up_fecha("&ALS_Preco")
    =up_fecha("&ALS_Clienc")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNvalor)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS324           PRVlrTransf VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:    3     º
*       º Variable:            PRVlrTransf                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      137                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls324     &&  PRVlrTransf VALID
#REGION 5
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRVlrTransf
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto,;
		ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo


	=W_DEFPROC("rotinas.spr")
	PRIVATE LNvalor
	PRIVATE LSalias

	PRIVATE LNtp_mercad
	

	LSalias = ALIAS()
	LNvalor = 0

	*---------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF


    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF


	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

	*------------------------------------------------------------*
**    IF &ALS_tipooper .ch_opera = "2" && TRANSFERENCIAS


        DO CASE

		  CASE &ALS_Orcamento .data < CTOD("01.05.2003")
			DO trf_ate010503

		  CASE &ALS_Orcamento .data < CTOD("01.09.2012")
			DO trf_dep010503
          OTHERWISE

			DO trf_dep010912

        ENDCASE



				
****  ENDIF
	*------------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNvalor)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS32D           PRVlrVenda VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:    4     º
*       º Variable:            PRVlrVenda                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      138                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _43a0ls32d     &&  PRVlrVenda VALID
#REGION 5
return
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Pre‡o de Tabela do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*					- TABELA EM VIGOR : Conforme a data passada
	*				como parametro;
	*
	*					- EMPRESA DE REFERENCIA : Duas Empresas podem
	*				usar uma tabela comum para evitar redundancia de
	*				informa‡äes ;
	*					EX : SIA usa tabela 2 (EMPTAB = 2)
	*						 W-3 refere a mesma (EMPTAB = 2)
	*
	*					- PRECO DIFERENCIADO PARA :
	*						Transferencia
	*						Vendas E Outras
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LSnatu_oper....: Indicativo da Natureza da Opercao
	*							(2) = 	Transferencia
	*							(<>2)	=	Outras Operacoes
	*						  Alteram a forma de definir o preco
	*		LSTpOper.......: TIPO Identificador da Operacao Comercial
	*		LScodigo..........: Codigo do produto
    *       LDdata.........: Data para Refereciar a tabela em Vigor
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNpreco........: Preco Localizado
	*		LSclascms......: Grupo de Comissao 		
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRVlrVenda
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto,;
 			ALS_Empresa,ALS_Orcamento,ALS_Preco

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LNpreco
	PRIVATE LNtbVigor, LSsrVigor

	*-----------------------------------------------------------*

	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LNpreco 	= 0
	STORE 0  TO LNtbVigor
	STORE "" TO LSsrVigor

	*-----------------------------------------------------------*
	*-----------------------------------------------------------*
	*--------------------------------------------------------

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF
	

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	*------------------------------------------------------------*

	IF !PRtabvigor(( &ALS_Orcamento .data ),LNtbVigor, LSsrVigor)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	*------------------------------------------------------------*
    SELECT &ALS_preco
   	SET ORDER TO TAG tabela
    IF SEEK(STR( &ALS_empresa .emptab,3);
           +STR( LNtbVigor ,3)+ LSsrVigor + PrmProduto)
       LNpreco 		=   &ALS_preco .preco
    ELSE
        LNpreco 	=	0
	ENDIF
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNpreco)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS32N           PRClas_Cms VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:    5     º
*       º Variable:            PRClas_Cms                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      139                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _43a0ls32n     &&  PRClas_Cms VALID
#REGION 5
return
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Pre‡o de Tabela do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*					- TABELA EM VIGOR : Conforme a data passada
	*				como parametro;
	*
	*					- EMPRESA DE REFERENCIA : Duas Empresas podem
	*				usar uma tabela comum para evitar redundancia de
	*				informa‡äes ;
	*					EX : SIA usa tabela 2 (EMPTAB = 2)
	*						 W-3 refere a mesma (EMPTAB = 2)
	*
	*					- PRECO DIFERENCIADO PARA :
	*						Transferencia
	*						Vendas E Outras
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LSnatu_oper....: Indicativo da Natureza da Opercao
	*							(2) = 	Transferencia
	*							(<>2)	=	Outras Operacoes
	*						  Alteram a forma de definir o preco
	*		LSTpOper.......: TIPO Identificador da Operacao Comercial
	*		LScodigo..........: Codigo do produto
    *       LDdata.........: Data para Refereciar a tabela em Vigor
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LSclascms........: Preco Localizado
	*		LSclascms......: Grupo de Comissao 		
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRClas_Cms
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LSclascms
	PRIVATE LNtbVigor, LSsrVigor


    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Preco,ALS_Preco



	*-----------------------------------------------------------*

	LSalias	= ALIAS()
	*-----------------------------------------------------------*

	LSclascms 	= ""
	STORE 0  TO LNtbVigor
	STORE "" TO LSsrVigor

	*-----------------------------------------------------------*
	*-----------------------------------------------------------*
    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Preco     = NetArqAgain("PRECO")
    ALS_Preco     = Alias()

	*--------------------------------------------------------
    IF (ARQ_Empresa + ARQ_Orcamento + ARQ_Preco) > 100000
								    && HOUVE FALHA ABERT
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF

	*--------------------------------------------------------

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF
	

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF


	*------------------------------------------------------------*

	IF !PRtabvigor(( &ALS_Orcamento .data ),LNtbVigor, LSsrVigor)
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF

	*------------------------------------------------------------*
    SELECT &ALS_preco
   	SET ORDER TO TAG tabela
    IF SEEK(STR( &ALS_empresa .emptab,3);
           +STR( LNtbVigor ,3)+ LSsrVigor + PrmProduto)
       LSclascms 		=   &ALS_preco .clas_cms
	ENDIF
	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_Preco")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSclascms)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS32X           PRCusto VALID                      º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:    6     º
*       º Variable:            PRCusto                            º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      140                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls32x     &&  PRCusto VALID
#REGION 5
return

FUNCTION  PRCusto
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn,;
				PrmCUSTO_IND

	PRIVATE LNcusto, LNRtdoSaida, LNRtdoEntrada
	PRIVATE LNtp_mercad
	PRIVATE LNaliq_icms, LNicms
	LNcusto = 0
		

	=W_DEFPROC("tributar.spr")
	LNRtdoSaida = TRRtdoSaida(LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNRtdoEntrada = TRRtdoEntrada(LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn)
	
	=W_DEFPROC("tributar.spr")
	LNaliq_icms = TRAlqIcmInUF(LSufDestino)

	=W_DEFPROC("tributar.spr")
	LNtp_mercad = TRRegTrbMercadoria(LSufDestino,LSproduto)


	LNicms = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicms = TRicmNormal (LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn)
	*---------------------------------------------------------*

	IF LNtp_mercad = 1  && TRIBUTADA
		LNcusto = LNvlrMercadoria + LNvlrIPI + PrmCUSTO_IND+;
				LNRtdoEntrada + LNRtdoSaida	 - LNicms
	ELSE
		LNcusto = LNvlrMercadoria + LNvlrIPI + PrmCUSTO_IND+;
				LNRtdoEntrada + LNRtdoSaida	
	ENDIF

	*---------------------------------------------------------*



RETURN(LNcusto)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS32Y           PRtabvigor VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:    7     º
*       º Variable:            PRtabvigor                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      141                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls32y     &&  PRtabvigor VALID
#REGION 5
RETURN

FUNCTION PRtabvigor
	PARAMETER LDdata,LNtabela,LSserie
    =W_DEFPROC("rotinas.spr")
    PRIVATE LSalias
	PRIVATE LFcadtab

	LNtabela = 0
   	LSserie  = ""

    LSalias	    = ALIAS()
    LFcadtab	= NetArq("cadtab")
    IF (LFcadtab) > 100000 && HOUVE FALHA ABERT
		=UP_fecha("cadtab" ,LFcadtab)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
    	RETURN(.f.)
    ENDIF
	SELE cadtab
	SET ORDER TO TAG tabela
	GO TOP
	DO WHILE !EOF()
		IF LDdata < cadtab.dtinicio or LDdata > cadtab.dtfim
			skip
			LOOP
		ENDIF
		LNtabela = cadtab.tabela
    	LSserie  = cadtab.serie
		EXIT
	ENDDO
	IF EOF()
	   DO OBJ_ALER.SPR WITH ;
		  "Nao foi encontrada nenhuma Tabela que vigor nesta data "+ ;
		    DTOC(LDdata)
	ENDIF
	=UP_fecha("cadtab" ,LFcadtab)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNtabela <> 0)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS33C           PRdesconto VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:    8     º
*       º Variable:            PRdesconto                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      142                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls33c     &&  PRdesconto VALID
#REGION 5
RETURN

FUNCTION PRdesconto
    PARAMETER LNemp,LSCodigo,LDdata,LNnat_clie,LNdesconto,LNerro, ;
        PrmVendedor

    = W_DEFPROC("rotinas.spr")
    PRIVATE LSalias
    PRIVATE LFpreco,LFprod_cms,LFempresa
	PRIVATE LNtabela,LSserie
    PRIVATE LFvertab
    PRIVATE LNFuncaoComissao

	LNdesconto  = 0
    LNERRO      = 0
	LNtabela	= 0
	LSserie 	= ""

	IF TYPE("PrmVendedor") = "N"
    	=W_DEFPROC("USUARIO.SPR")
		LNFuncaoComissao = USGetComissFuncao(PrmVendedor)
	ELSE

		LNFuncaoComissao = 0
	ENDIF

    LSalias	    = ALIAS()
    LFpreco     = NetArq("preco")
    LFprod_cms  = NetArq("prod_cms")
    LFempresa   = NetArq("empresa")
    IF (LFpreco+LFprod_cms) > 100000 && HOUVE FALHA ABERT
	    DO ULFchDesconto
	    LNERRO = 99         && OUTRAS FALHAS
    	RETURN(.F.)
    ENDIF
    IF !Prtabvigor(LDdata,LNtabela,LSserie)
	    DO ULFchDesconto
		LNERRO = 1         && NAO HA TABELA EM VIGOR NESTE PERIODO
    	RETURN(.F.)
    ENDI
    IF !Prpromocao(LNemp,LScodigo,LNnat_clie,LDdata,{},0,LNdesconto)
	   SELE empresa
	   SET ORDER TO TAG empresa 	
	   SEEK LNemp
	   IF !FOUND()
	       DO ULFchDesconto
		   LNERRO = 99         && OUTRAS FALHAS
    	   RETURN(.F.)
	   ENDIF
       SELE Preco
       SET ORDE TO tabela
       seek str(empresa.emptab,3)+STR(LNtabela,3)+LSserie+LSCodigo

       IF !FOUND()
		  DO ULFchDesconto
		  LNERRO = 4         && PRODUTO NAO CADASTRO EM TABELA PRECO
          RETURN(.F.)
       ENDI

       LSclas_cms = Preco.clas_cms

       SELE Prod_cms
       SET ORDE TO tabela



	   *--------------------------------------------------------------*	
	   *    O controle de desonto por funcao nao e viavel sendo assim
	   * a comissao fica vinculada a funcao mas o desconto sera o que
	   * estiver cadastrado no nivel padrao = 00
	   *--------------------------------------------------------------*	
       *seek str(LNemp,3)+STR(LNtabela,3)+LSserie+;
       *       LSClas_cms+str(LNFuncaoComissao,2)
       *IF !FOUND()
	   *    seek str(LNemp,3)+STR(LNtabela,3)+LSserie+LSClas_cms+str(0,2)
       *   IF !FOUND()
	   *	  DO ULFchDesconto
	   *      LNERRO = 1   && PRODUTO NAO CADASTRADO NA TABELA PROD_CMS
	   *      RETURN(.F.)
       *   ENDI
       * ENDIF
	   *--------------------------------------------------------------*	

       seek str(LNemp,3)+STR(LNtabela,3)+LSserie+LSClas_cms+str(0,2)
   	   IF !FOUND()
		  DO ULFchDesconto
          LNERRO = 1   && PRODUTO NAO CADASTRADO NA TABELA PROD_CMS
          RETURN(.F.)
   	   ENDI



       Do Case
          Case LNnat_clie = 0
               LNdesconto = prod_cms.desc_varej
          Case LNnat_clie = 1
               LNdesconto = prod_cms.desc_reven
          Case LNnat_clie = 2
               LNdesconto = prod_cms.desc_ppubl
          Case LNnat_clie = 3
               LNdesconto = prod_cms.desc_frota
       EndC
    ENDI

	DO ULFchDesconto

    IF LNdesconto=0
       LNERRO = 2
      ELSE
       LNERRO = 3
    ENDI
RETURN(LNdesconto<>0)

PROCEDURE ULFchDesconto
    =UP_fecha("preco"    ,LFpreco)
	=UP_fecha("prod_cms" ,LFprod_cms)
	=UP_fecha("empresa" ,LFempresa)
	IF !EMPTY(LSalias) AND USED(LSalias)
	   SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS33M           PRbrow_tab VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:    9     º
*       º Variable:            PRbrow_tab                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      143                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls33m     &&  PRbrow_tab VALID
#REGION 5
RETURN

FUNCTION PRbrow_Tab
PARAMETERS LNemp,LNempTab,LNtab,LSserie,LDdtsaldo,LScodigo,LSclassifica
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Visualizar Tabela de Precos,Saldos e Reservas
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite visualizar a TABELA DE PRECOS
	*			demontrando SALDO e REZERVAS DE CADA PRODUTO
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LNemptab.......: Empresa de Referencia Para Tabela de Precos
	*		LNtab..........: Codigo da Tabela de Precos
	*		LSserie........: Serie da Tabela de Precos
	*		LDdtsaldo......: Data de Referencia para Consultar
	*						tabela de SALDOS
	*		LScodigo.......: Codigo do Produto que se quer
	*						 Posicionar ou Aproximar ou retornar
	*						 para rotina chamadora
	*		LSclassifica...: Classificao do Produto que se quer
	*						 Posicionar ou Aproximar ou retornar
	*						 para rotina chamadora
	*------------------------------------------------------------*
	*  RETORNO.....:- REGISTRO DO PRODUTO e PRECO POSICIONADO para
	*					ser tratado na rotina
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSemptmp

	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente



	*------------------------------------------------------------*

	=W_DEFPROC("AUTOPROC.SPR")
	=APTempGeral()

	*------------------------------------------------------------*

	SELE preco
	SET ORDER TO TAG tabela
	SET NEAR ON
	SEEK STR(LNempTab,3)+;
	     STR(LNtab,3)+;
	     LSserie+;
         ALLTRIM(LScodigo)
	SET NEAR OFF


    SELECT saldo
    SET ORDER TO TAG clas_saldo
    SELECT grupo
    SET ORDER TO TAG codigo
    SEEK preco.codigo
		
    SET ORDER TO TAG ordem

    SET RELATION TO STR(LNempTab,3)+STR(LNtab,3)+LSserie+;
                            grupo.codigo INTO preco ADDITIVE
    SET RELATION TO STR(LNemp,3)+grupo.classifica+;
        STR(YEAR(LDdtsaldo),4)+STR(MONTH(LDdtsaldo),2) ;
        	INTO saldo ADDITIVE
*--------
    LSemptmp =  STRTRAN(STR(LNemp,3),' ','0')

	KEYBOARD "{CTRL-F10}"

 	DO loc_dlog WITH .T.,;
		  " grupo.FLG_DESCRI = 'S' OR ;
		  (('&LSemptmp' $ grupo.tab_preco OR grupo.tp_mercad = 7)) ;
		    AND (!EMPTY(preco.codigo) OR ;
			 grupo.cdg_tipo <> 4) ","","B","ULtabres"

	CLEAR FIELDS
	SET FIELDS OFF
    SET ORDER TO TAG classifica
	SET RELATION TO
	*--------------------------------------------------------------*
	POP KEY 	&& reabilita teclas de atalho def. anteriormente
	*-----------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS33U           PRpromocao VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:   10     º
*       º Variable:            PRpromocao                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      144                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls33u     &&  PRpromocao VALID
#REGION 5
RETURN

FUNCTION PRPROMOCAO
PARAMETERS LNemp,LScod,LNNatuclie,LDFIM,LDINICIO,LNPRECO,LNDesconto

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Pre‡o Promocional
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite informar preco e desconto
	*			    promocional atraves de parametros
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....: PROMOCAO
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LScod..........: Codigo do produto
    *       LNNotclie......: Tipo do Cliente
    *                        0 - Varejo
    * 						 1 - Revenda
    *     					 2 - Poder Publico
    *						 3 - Frota
	*		LDFim..........: Data Final da Promocao
	*       LDInicio.......: Data Inicial da Promocao
	*       LNPreco........: Preco Promocao
    *       LNDesconto.....: Desconto conforme tipo do cliente
    *       LFretorno......: .t.  => Tem Promocao na data informada
    *                        .f.  => Nao Tem Promocao na data informada
	*------------------------------------------------------------*
	*  RETORNO.....: LFretorno
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno, LFpromocao
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LFpromocao		= NetArq("promocao")
	IF (LFpromocao) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("promocao" ,LFpromocao)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF

	LFretorno 	= .f.

    SELE PROMOCAO
    SET ORDE TO PROMOCAO
    SET NEAR ON
    SEEK STR(LNemp,3)+LScod+DTOS(LDfim)
    SET NEAR OFF
    IF promocao.empresa <> LNemp ;
    	OR promocao.codigo <> LScod ;
    	OR LDfim < promocao.dt_inicio ;
    	OR LDfim > promocao.Dt_fim
    	
       LFretorno = .f.
      else
       LFretorno = .t.
	   LDFim 	=  promocao.dt_fim
	   LDInicio =  promocao.dt_inicio
	   LNPreco  =  promocao.preco
	   	Do Case
	    	Case LNNatuclie = 0
	           LNDesconto = promocao.desc_varej
	     	Case LNNatuclie = 1
   	           LNDesconto = promocao.desc_reven
	      	Case LNNatuclie = 2
   	           LNDesconto = promocao.desc_ppubl
	      	Case LNNatuclie = 3
   	           LNDesconto = promocao.desc_frota
   	  	EndC
   	ENDI
	IF LNdesconto = 0
       LFretorno = .f.
	ENDIF
	
	=UP_fecha("promocao" ,LFpromocao)
   IF !EMPTY(LSalias) AND USED(LSalias)
      SELECT &LSalias
   ENDIF
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS343           PRVlrTabVgr VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:   11     º
*       º Variable:            PRVlrTabVgr                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      145                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _43a0ls343     &&  PRVlrTabVgr VALID
#REGION 5
return
	*------------------------------------------------------------*

FUNCTION PRVlrTabVgr
PARAMETERS PrmEmpresa, PrmData,PrmProduto

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LNpreco
	PRIVATE LNtbVigor, LSsrVigor
	PRIVATE LNEmpTab

	*-----------------------------------------------------------*

	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LNpreco 	= 0
	STORE 0  TO LNtbVigor
	STORE "" TO LSsrVigor

	*-----------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	LNEmpTab = EMGetFieldValue(PrmEmpresa,"EMPTAB")

	*------------------------------------------------------------*

	IF !PRtabvigor(PrmData, LNtbVigor, LSsrVigor)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	*------------------------------------------------------------*
    SELECT preco
   	SET ORDER TO TAG tabela
    IF SEEK(STR( LNEmpTab, 3);
           +STR( LNtbVigor ,3)+ LSsrVigor + PrmProduto)
       LNpreco 		=   preco .preco
    ELSE
        LNpreco 	=	0
	ENDIF
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNpreco)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS34A           PRVlrTransf VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:   12     º
*       º Variable:            PRVlrTransf                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      146                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls34a     &&  PRVlrTransf VALID
#REGION 5
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*



PROCEDURE trf_dep010912

		PRIVATE LSUFdestino


		=W_DEFPROC("TRIBUTAR.SPR")
	   	LNtp_mercad = TRDef_TpMercad(PrmEmpresa,PrmOrcamento,PrmProduto)

		*------------------------------------------------------------*
		SELECT &ALS_Saldo
	   	SET ORDER TO TAG clas_saldo
	   	SEEK STR(PrmEmpresa,3)+ &ALS_grupo .classifica+;
    	    	STR(YEAR( &ALS_Orcament .data ),4)+;
    	    	STR(MONTH( &ALS_Orcament .data ),2)

	   	IF FOUND()

			IF &ALS_saldo .sld_atu = 0
		        LNvalor		=	&ALS_saldo .vlr_atu / 1
			else
		        LNvalor		=	&ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
			ENDIF

			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************

			IF &ALS_tipooper .ch_desti = "1"  && INTERNAS

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2
							LNvalor = LNvalor
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE

			ELSE

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2

						=W_DEFPROC("CLIENC.SPR")
						LSUFdestino = CNGetUFDestino(PrmEmpresa,;
													PrmOrcamento)

						=W_DEFPROC("TRIBUTAR.SPR")
						LNiva = TRGet_IVA(  &als_empresa .estado, ;
								            PrmProduto,;
								            LSUFdestino ,;
								            &ALS_Orcament .data )

						*=W_DEFPROC("TRIBUTAR.SPR")
						*LNiva=TRGet_IVA( &als_empresa .estado, PrmProduto)

						DO CASE
							CASE LNiva = 1.32
								LNvalor = LNvalor * 0.8945
							CASE LNiva = 1.42
								LNvalor = LNvalor * 0.8803
							CASE LNiva = 1.45
								LNvalor = LNvalor * 0.8761
							OTHERWISE							
								LNvalor = LNvalor
						ENDCASE
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE
			ENDIF
	   ENDIF
RETURN





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS34I           PRVlrTransf VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:   13     º
*       º Variable:            PRVlrTransf                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      147                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls34i     &&  PRVlrTransf VALID
#REGION 5
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*



PROCEDURE trf_dep010503

		PRIVATE LSUFdestino


		=W_DEFPROC("TRIBUTAR.SPR")
	   	LNtp_mercad = TRDef_TpMercad(PrmEmpresa,PrmOrcamento,PrmProduto)

		*------------------------------------------------------------*
		SELECT &ALS_Saldo
	   	SET ORDER TO TAG clas_saldo
	   	SEEK STR(PrmEmpresa,3)+ &ALS_grupo .classifica+;
    	    	STR(YEAR( &ALS_Orcament .data ),4)+;
    	    	STR(MONTH( &ALS_Orcament .data ),2)

	   	IF FOUND()

			IF &ALS_saldo .sld_atu = 0
		        LNvalor		=	&ALS_saldo .vlr_atu / 1
			else
		        LNvalor		=	&ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
			ENDIF

			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************

			IF &ALS_tipooper .ch_desti = "1"  && INTERNAS

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2
							LNvalor = LNvalor
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE

			ELSE

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2

						=W_DEFPROC("CLIENC.SPR")
						LSUFdestino = CNGetUFDestino(PrmEmpresa,;
													PrmOrcamento)

						=W_DEFPROC("TRIBUTAR.SPR")
						LNiva = TRGet_IVA(  &als_empresa .estado, ;
								            PrmProduto,;
								            LSUFdestino ,;
								            &ALS_Orcament .data )

						*=W_DEFPROC("TRIBUTAR.SPR")
						*LNiva=TRGet_IVA( &als_empresa .estado, PrmProduto)

						DO CASE
							CASE LNiva = 1.32
								LNvalor = LNvalor * 0.9055
							CASE LNiva = 1.42
								LNvalor = LNvalor * 0.8917
							CASE LNiva = 1.45
								LNvalor = LNvalor * 0.8877
							OTHERWISE							
								LNvalor = LNvalor
						ENDCASE
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE
			ENDIF
	   ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS34T           PRVlrTransf VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         PRECO,     Record Number:   14     º
*       º Variable:            PRVlrTransf                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      148                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls34t     &&  PRVlrTransf VALID
#REGION 5
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*

PROCEDURE trf_ate010503

		=W_DEFPROC("TRIBUTAR.SPR")
	   	LNtp_mercad = TRDef_TpMercad(PrmEmpresa,PrmOrcamento,PrmProduto)

		*------------------------------------------------------------*
		SELECT &ALS_Saldo
	   	SET ORDER TO TAG clas_saldo
	   	SEEK STR(PrmEmpresa,3)+ &ALS_grupo .classifica+;
    	    	STR(YEAR( &ALS_Orcament .data ),4)+;
    	    	STR(MONTH( &ALS_Orcament .data ),2)
	   	IF FOUND()
			IF &ALS_saldo .sld_atu = 0
		        LNvalor		=	&ALS_saldo .vlr_atu / 1
			else
		        LNvalor		=	&ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
			ENDIF
			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************
			IF &ALS_tipooper .ch_desti = "1"
				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2
						************************************************
						*    Inicio de tratamento nao parametrizavel
						*	( ESPECIFICO)
						*	Para PNEUS Ind,Caminhao,Tratores,Agric,	
						*	Terrapl > "00448"  e < "00800"	
						************************************************
						IF LEFT( &ALS_grupo .classifica,5) > "00448" AND ;
						   LEFT( &ALS_grupo .classifica,5) < "00800"
						        LNvalor = LNvalor * 1.24
						ELSE
						        LNvalor = LNvalor * 1.26
						ENDIF				
					OTHERWISE
						LNvalor = LNvalor
				ENDCASE
			ELSE
		        LNvalor = LNvalor / ((100 - &ALS_tipooper .aliq_icms) / 100)
			ENDIF
	   ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS354           ESPsq_Produtos VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:    4   º
*       º Variable:            ESPsq_Produtos                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      149                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls354     &&  ESPsq_Produtos VALID
#REGION 6
RETURN
PROCEDURE ESPsq_Produtos
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Pesquisar Produtos em uma Lista
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: GRUPO
	*------------------------------------------------------------*
	* PARAMETROS..:
	*             LScodigo : Codigo do Produto - Pode Ser Utiliza
	*                  para posicionamento parcial
	*------------------------------------------------------------*
	* CHAMADAS.............:
	*------------------------------------------------------------*
	PARAMETERS LScodigo

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_grupo, ALS_grupo

    LSalias      = Alias()
    ARQ_grupo    = NetArqAgain("GRUPO")
    ALS_grupo    = Alias()



	SELE &ALS_grupo
	SET ORDER TO TAG codigo
	SET NEAR ON
	SEEK ALLTRIM(LScodigo)
	SET NEAR OFF
	*----------------------------------------------------------*
	ON KEY LABEL ESCAPE

	SET ORDER TO TAG ordem
	ON KEY LABEL ESCAPE
	DO loc_dlog WITH .T.

	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	IF LASTKEY() <> 27
	   LScodigo = &ALS_grupo .codigo
	ELSE
	   SEEK ALLTRIM(LScodigo)
	   IF !FOUND()
		   LScodigo = ""
	   ENDIF
	ENDIF

	=UP_fecha(ALS_GRUPO)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScodigo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS35F           ESAbresaldo VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:    5   º
*       º Variable:            ESAbresaldo                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      150                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls35f     &&  ESAbresaldo VALID
#REGION 6
RETURN
PROCEDURE ESAbresaldo

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Abrir Registro de Controles de saldo
	* 			do produto informado no periodo informado
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: SALDO, ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Que se quer abrir o Saldo
	*		LSclass........: Classificaso do Produto
	*		LSclass........: Classificaso do Produto
	*		LDdtini........: Referencia do mes inicial
	*		LDdtfim........: Referencia do mes final
	*------------------------------------------------------------*
	* CHAMADAS.............:
	*------------------------------------------------------------*
	PARAMETERS LNemp,LScod,LSclass,LDdtini,LDdtfim

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFsaldo,LFitemmov
	PRIVATE LDdtincrementa, LDdtencerra

	*--------------------------------------------------------------*
	PRIVATE m.sld_ante,m.sld_atu,m.vlr_ante,m.vlr_atu
	PRIVATE m.empresa,m.codigo, m.classifica
	PRIVATE m.qtd_compra,m.vlr_compra,m.qtd_venda,m.vlr_venda,;
			m.qtd_e_tran,m.vlr_e_tran,m.qtd_e_outr,m.vlr_e_outr,;
			m.qtd_s_tran,m.vlr_s_tran,m.qtd_s_outr,m.vlr_s_outr,;
			m.ven_tab,m.ven_contab,m.ven_enc,m.dtabert,m.status
	*--------------------------------------------------------------*
	LSalias			= ALIAS()
	LFsaldo			= NetArq("saldo")
	LFitemmov			= NetArq("itemmov")
	IF (LFsaldo+LFitemmov) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("saldo" ,LFsaldo)
		=UP_fecha("itemmov" ,LFitemmov)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*----------------------------------------------------------------*
	* Redimensiona as datas para permitir o controle do incremento de
	* 1 mes na data inicial dentro do laco
	*----------------------------------------------------------------*
	LDdtincrementa	= LDdtini - DAY(LDdtini) + 1 && 1o DIA DO MES
	LDdtencerra		= LDdtfim -	DAY(LDdtfim) + 1 && 1o DIA DO MES

   	m.sld_ante   = 0
   	m.vlr_ante   = 0

	DO WHILE LDdtincrementa <= LDdtencerra
   		SELECT saldo
	   	SET ORDER TO TAG clas_saldo
   		SET NEAR ON
   		SEEK STR(LNemp,3)+LSclass+;
	        	STR(YEAR(LDdtincrementa),4)+;
    	    	STR(MONTH(LDdtincrementa),2)
	   	SET NEAR OFF

	   	IF  FOUND()
			SKIP -1			&& TESTE SE EXISTE REGISTRO ANTERIOR
	      	IF !BOF() ;
	      		AND saldo.empresa  = LNemp ;
	      		AND saldo.classifica = LSclass
			    	m.sld_ante   = saldo.sld_atu
			    	m.vlr_ante   = saldo.vlr_atu
			ELSE
				SELE itemmov
				SET ORDER TO TAG movsimples
				SET NEAR ON
				SEEK STR(LNemp,3)+LScod+DTOS(LDdtincrementa)
				SET NEAR OFF
				*-------------------------------------------------*
				* PROCURANDO MOVIMENTO ANTERIOR A DATA
				*-------------------------------------------------*
				SKIP -1
				DO WHILE !BOF() ;
						AND itemmov.empresa  = LNemp ;
						AND itemmov.codigo   = LScod ;
						AND itemmov.data >= LDdtincrementa
	
					SKIP -1
				ENDDO
				IF !BOF() 	AND itemmov.empresa  = LNemp ;
							AND itemmov.codigo   = LScod ;
						AND itemmov.data < LDdtincrementa
					* ENCONTROU MOV ANTERIOR

			    	m.sld_ante   = itemmov.sld_estq
			    	m.vlr_ante   = itemmov.vlr_estq
				ENDIF
			ENDIF	
			SELE SALDO
	   		SEEK STR(LNemp,3)+LSclass+;
	        	STR(YEAR(LDdtincrementa),4)+;
    	    	STR(MONTH(LDdtincrementa),2)

			SET FIELDS TO dtregis, hregis, usrregis,deletado
		    SET FIELDS TO sld_ante, vlr_ante
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF

	   	ELSE
			SKIP -1			&& TESTE SE EXISTE REGISTRO ANTERIOR
	      	IF !BOF() ;
	      		AND saldo.empresa  = LNemp ;
	      		AND saldo.classifica = LSclass
			    	m.sld_ante   = saldo.sld_atu
			    	m.vlr_ante   = saldo.vlr_atu
			ELSE
				SELE itemmov
				SET ORDER TO TAG movsimples
				SET NEAR ON
				SEEK STR(LNemp,3)+LScod+DTOS(LDdtincrementa)
				SET NEAR OFF
				*-------------------------------------------------*
				* PROCURANDO MOVIMENTO ANTERIOR A DATA
				*-------------------------------------------------*
				SKIP -1
				DO WHILE !BOF() ;
						AND itemmov.empresa  = LNemp ;
						AND itemmov.codigo   = LScod ;
						AND itemmov.data >= LDdtincrementa
	
					SKIP -1
				ENDDO
				IF !BOF() 	AND itemmov.empresa  = LNemp ;
							AND itemmov.codigo   = LScod ;
						AND itemmov.data < LDdtincrementa
					* ENCONTROU MOV ANTERIOR

			    	m.sld_ante   = itemmov.sld_estq
			    	m.vlr_ante   = itemmov.vlr_estq
				ENDIF
			ENDIF	
	    	m.sld_atu    = m.sld_ante
	    	m.vlr_atu    = m.vlr_ante

   			m.empresa    = LNemp
	    	m.codigo     = LScod
		    m.classifica = LSclass

			STORE 0 TO 	m.qtd_compra,m.vlr_compra,m.qtd_venda,m.vlr_venda,;
					m.qtd_e_tran,m.vlr_e_tran,m.qtd_e_outr,m.vlr_e_outr,;
					m.qtd_s_tran,m.vlr_s_tran,m.qtd_s_outr,m.vlr_s_outr,;
					m.ven_tab,m.ven_contab,m.ven_enc

			m.dtabert   = LDdtincrementa
		    m.status    = 'A'
			SELE SALDO
			=edithand('SAVE')
	
		ENDIF
		LDdtincrementa	= GOMONTH(LDdtincrementa,1) && PROXIMO 1o DIA DO MES
	ENDDO

	=UP_fecha("saldo" ,LFsaldo)
	=UP_fecha("itemmov" ,LFitemmov)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS35R           ESversaldo VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:    6   º
*       º Variable:            ESversaldo                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      151                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls35r     &&  ESversaldo VALID
#REGION 6
RETURN

FUNCTION ESversaldo
	PARAMETERS LNemp,LScod,LDdata,LNqtde,LNJaReserv,;
				LFabreAuto,LFlockreg,LSoperacao,LShora,;
				LSmovEstq

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Verificar Saldo Para  atender solicitacao
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....:
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdata.........: Data na Qual se quer o saldo
	*		LNqtde.........: Qtde Solicitada
	*		LNJaReserv.....: Qtde ja Reservada Anteriormente desta
	*						propria Solicitacao
	*						Ex: SOLICITA 10 mas JA TEM 3 RESERVADO
	*						ATERIORMENTE => TEM QUE ATENDEDER 7
	*						esta qu
	*		LFAbreAuto.....: .f. Nao abre Controle quando nao Existe
	*						 .t. Abre Registro de Saldo para Mes
	*		LSoperacao.....: Indica qual opercao esta originando a
	*						chamada a rotina ex:
	*					"RESERVA" => Processo de Reserva ex: SCGC2.PRG
	*
	*
	*					"SAIDA" => Processo de Saida ex: SCGC2.PRG
	*					"ENTRADA"=>Processo de Entrada ex: SCGC210.SCR
	*							(Para entradas so ‚ necessario localizar
	*							registro de SALDO  e bloquear nao
	*							sendo verificados saldos
	*		LShora.........: Perimite verificar o saldo pelo
	*					movimento (ITEMMOV) localizando o  movimento
	*					anterior do item na data e hora informada
	*					so esta sendo utilizado para REQUISICOES
	*					de saida que podem ser lancadas em datas
	*					anteriores e devem considerar o saldo do
	*					momento (OBS: No caso de recuperacao de
	*							NFS e possivel utilizar esta
	*							tecnica , ver futuro)
	*		LSmovEstq.......: "N"= Operacao nao movimentara estoque
	*								so deseja localiza/block REG.SALDO					
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LFretorno......: .F. ou .T.
	*
	* CHAMADAS.....: SCGC2.PRG,OBJ_ITOR.SCR,SCGCF201
	*				 SCGC210.SCR			
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFsaldo
	PRIVATE LFgrupo
	PRIVATE LFempresa
    PRIVATE LNreal_saldo
 	PRIVATE LNbloq_saldo
	PRIVATE LFgrfiscal
	*------------------------------------------------------------*
	LSalias			= ALIAS()
	LFsaldo			= NetArq("saldo")
	LFgrfiscal		= NetArq("grfiscal")
	LFempresa		= NetArq("empresa")
	LFgrupo			= NetArq("grupo")
	*------------------------------------------------------------*
	IF (LFsaldo+LFgrfiscal+LFempresa+LFgrupo) > 100000
		DO ESver_fecha
      	WAIT WINDOW "(ESversaldo)- Falha Abertura de Tabelas.<ENTER>"
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		DO ESver_fecha
      	WAIT WINDOW ;
      		"(ESversaldo)- Registro de Empresa Nao Localizado. <ENTER>"
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	SELECT grupo
	SET ORDER TO TAG codigo
	SEEK LScod
	IF !FOUND()
		DO ESver_fecha
      	WAIT WINDOW ;
      		"(ESversaldo)- Registro de Produto Nao Localizado.<ENTER>"
		RETURN(.f.)
	ENDIF
	IF  grupo.tp_control = 9   && PRODUTO SEM CONTROLE DA ESTOQUE
		DO ESver_fecha
		RETURN(.T.)
	ENDIF

	*------------------------------------------------------------*
	SELECT GRfiscal
	SET ORDER TO TAG tributacao
	SEEK empresa.estado+LEFT(grupo.classifica,5)
	IF !FOUND()
		SET ORDER TO TAG tributacao
		SEEK empresa.estado+LEFT(grupo.classifica,2)
		IF !FOUND()
			DO ESver_fecha
    	  	WAIT WINDOW ;
			"(ESversaldo)- Registro Fiscal de Produto "+ALLTRIM(LScod)+;
					"  Nao Localizado.<ENTER>"
			RETURN(.f.)
		ENDIF
	ENDIF
	IF  grfiscal.tp_mercad =  7
		DO ESver_fecha
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
    SELECT saldo
    SET ORDER TO TAG clas_saldo
    SEEK STR(LNemp,3)+grupo.classifica+;
        STR(YEAR(LDdata),4)+;
        STR(MONTH(LDdata),2)
    IF !FOUND()
		IF !LFAbreAuto OR;
		   !ESAbresaldo((LNemp),(LScod),(grupo.classifica),;
					(LDdata), (LDdata))
	      	WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
    	           " nao foi aberto para movimentacao. Solicite abertura."
			DO ESver_fecha
			RETURN(.f.)
		ENDIF
    ENDIF

    IF LScod   <> saldo.codigo OR ;
   	   grupo.classifica <> saldo.classifica
		    DO OBJ_ALER.SPR WITH ;
	   		"Os dados do Item "+LScod+chr(13)+;
			"Estao irregulares. Reedite a Doc e verifique o Item."
			DO ESver_fecha
			RETURN(.f.)
    ENDIF
	
	*-----------------------------------------------------------------*
	IF LSmovEstq <> "N" AND !ULatendeOper(LSoperacao)
		DO ESver_fecha
      	WAIT WINDOW  "(ESversaldo)- Estoque Insuficiente. <ENTER>"
		RETURN(.f.)
	ENDIF
	*----------------------------------------------------------------*
	IF LFlockreg		&& BLOQUEAR REGISTRO PARA PROCESSO
	   IF !REGLOCK()
	      	WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
                 " nao pode ser bloqueado para efetivar reserva."
			DO ESver_fecha
			RETURN(.f.)
	   ENDIF
	ENDIF
	*------------------------------------------------------------*
	DO ESver_fecha
RETURN(.T.)


PROCEDURE ESver_fecha
	=UP_fecha("saldo"    ,LFsaldo)
	=UP_fecha("grfiscal" ,LFgrfiscal)
	=UP_fecha("empresa"  ,LFempresa)
	=UP_fecha("grupo"    ,LFgrupo)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



FUNCTION ULatendeOper
PARAMETERS LSoperacao
	*-----------------------------------------------------------------*
	*	Esta Rotina Permite Tratar individualmente o saldo de acordo
	*	com a operacao "RESERVA", "SAIDA" ou "ENTRADA"
	*-----------------------------------------------------------------*
	PRIVATE LFretorno
	LFretorno = .T.	
	DO CASE
		CASE LSoperacao = "RESERVA"
		    LNbloq_saldo = saldo.sld_atu - saldo.reserva + LNJaReserv
			IF LNqtde > LNbloq_saldo
				      WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
			        " ESTOQUE (-) RESERVA =>> "+ALLTRIM(STR(LNbloq_saldo,7))
					LFretorno = .F.	
			ENDIF
		
		CASE LSoperacao = "SAIDA"
		    LNreal_saldo = saldo.sld_atu
		    LNbloq_saldo = saldo.sld_atu - saldo.reserva + LNJaReserv

			DO CASE
				CASE LNqtde > LNreal_saldo
			       WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
			          " ESTOQUE =>> "+ALLTRIM(STR(LNreal_saldo,7))
					LFretorno = .F.	

				CASE LNqtde > LNbloq_saldo
				      WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
			        " ESTOQUE (-) RESERVA =>> "+ALLTRIM(STR(LNbloq_saldo,7))
					LFretorno = .F.	
			ENDCASE
		CASE LSoperacao = "ENTRADA"
			LFretorno = .T.	
	ENDCASE
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS35S           ESsaldo VALID                      º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:    7   º
*       º Variable:            ESsaldo                            º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      152                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls35s     &&  ESsaldo VALID
#REGION 6
RETURN
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar saldo em momento  solicitado
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*						LNemp = 999  faz com que a rotina le-
	*						vante os dados de todas empresas regis-
	*						tradas no arq. empresa
	*		LScod..........: Codigo do Produto
	*		LSclass........: Classificaso do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LNqtde.........: Referencia p/ Retorno
	*		LNcusto........: Referencia p/ Retorno
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*		LNreserva......: Qtde Reservada
	*------------------------------------------------------------*
	*	CHAMADA............: NEsoma_Saldo
	*
	*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNqtde.........: Saldo Total do Estoque na Data
	*		LNcusto........: Valor do Estoque  total
	*		LNreserva......: Parte do Saldo que esta Reservada
	*------------------------------------------------------------*



FUNCTION ESsaldo
	PARAMETERS LNemp,LScod,LSclass,LDdtbase,LNqtde,LNcusto, LShora,;
				LNreserva

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFsaldo,LFitemmov,LFempresa
	PRIVATE TMPcusto

	LNqtde  	= 0
	LNcusto 	= 0
	LNreserva 	= 0

	IF TYPE("LShora") <> "C" or EMPTY(LShora)
		LShora = "99:99:99"			&&  FORCA PESQUISA NO FINAL DO DIA
	ELSE
		LShora = LEFT(LShora,6)+"60" && FORCA PESQUISA NO PROXIMO MINUTO
	ENDIF
	LSalias			= ALIAS()
	LFempresa		= NetArq("empresa")
	LFsaldo			= NetArq("saldo")
	LFitemmov		= NetArq("itemmov")
	IF (LFempresa+LFsaldo+LFitemmov) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("empresa" ,LFempresa)
		=UP_fecha("saldo" ,LFsaldo)
		=UP_fecha("itemmov" ,LFitemmov)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE empresa
	SET ORDER TO TAG empresa
	IF LNemp = 999
		GO TOP
	ELSE
		SEEK LNemp
	ENDIF
	DO WHILE !EOF() AND (LNemp = 999 OR LNemp = empresa.empresa)
		SELECT  itemmov
		SET ORDER TO TAG movimento
		SET NEAR ON
		SEEK STR(empresa.empresa,3)+LScod+dtos(LDdtbase)+LShora
										&& POSICIONA A FRENTE PARA
										&& VOLTAR E PEGAR SALDO DE
										&& FECHAMENTO OU ATUAL DO DIA
		SET NEAR OFF
		IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
			=UP_fecha("empresa" ,LFempresa)
			=UP_fecha("saldo" ,LFsaldo)
			=UP_fecha("itemmov" ,LFitemmov)
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(0)
		ELSE
			SKIP -1
		ENDIF


		IF BOF() OR LScod <> itemmov.codigo ;
			OR empresa.empresa <> itemmov.empresa

		   	SELE saldo
		   	SET ORDER TO TAG emp_mes
	 		SEEK STR(empresa.empresa,3)+STR(YEAR(LDdtbase),4)+;
					STR(MONTH(LDdtbase),2)+LSclass
			IF FOUND()
		   		LNqtde    = LNqtde  + saldo.sld_ante
		   		LNcusto   = LNcusto + saldo.vlr_ante
				LNreserva = LNreserva + saldo.reserva
			ELSE
				SELECT  itemmov
				SKIP				&& avanca p/ pegar dat di 1o lancamento
				IF !BOF() AND LScod = itemmov.codigo AND ;
				  		  empresa.empresa = itemmov.empresa)
				   SELE saldo
				   SEEK STR(empresa.empresa,3)+;
		   	   			STR(YEAR(itemmov.data),4)+;
						STR(MONTH(itemmov.data),2)+LSclass
				   IF FOUND()
		  			    LNqtde    = LNqtde + saldo.sld_ante
					    LNcusto   = LNcusto + saldo.vlr_ante
						LNreserva = LNreserva + saldo.reserva
					ELSE
						&& NAO ENCONTROU NENUMA REFERENCIA ANTERIOR
						&& RECOMPOE A SALDO ANTERIOR ANULANDO OPERACAO
					    TMPcusto = 0
						IF itemmov.sld_estq = 0
						    TMPcusto   = itemmov.vlr_estq
						ELSE						
						    TMPcusto   = itemmov.vlr_estq / itemmov.sld_estq
						ENDIF
						DO CASE
							CASE LEFT(itemmov.operacao,1) = "S"
						    	LNqtde  = LNqtde + itemmov.sld_estq + ;
				    						 itemmov.qtde
								LNreserva = LNreserva + itemmov.sld_rese
							CASE LEFT(itemmov.operacao,1) = "E"
						    	LNqtde  = LNqtde + itemmov.sld_estq - ;
				    						 itemmov.qtde
						ENDCASE	
			    	    LNcusto   = LNcusto + (LNqtde * TMPcusto)
				   ENDIF
				ENDIF
			ENDIF
		ELSE
			IF itemmov.sld_estq > 0	
		    	LNqtde    = LNqtde + itemmov.sld_estq
		    	LNcusto   = LNcusto + itemmov.vlr_estq
				LNreserva = LNreserva + itemmov.sld_rese
			ENDIF
		ENDIF


		IF LNqtde = 0	&& EM ITEMMOV O ULTIMO CUSTO FICA REGISTRADO
						&& QDO O ESTOQUE ZERA PORTANTO DEVE SER ZARADO
						&& POIS A ROTINA DEVE REORNAR O CUSTO ESTOCADO
		    LNcusto   = 0
		ENDIF	
		IF LNemp <> 999		&& PESQUISA SO NA EMPRESA INFORMADA
			EXIT				&& EVITA DESLOCAR REGISTRO DE EMPRESA
								&& QUE ESTA SENDO CONTROLADO EM SCGC800
								&& UPregprevisao
		ENDIF
		SELE EMPRESA
		SKIP
	ENDDO
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("saldo" ,LFsaldo)
	=UP_fecha("itemmov" ,LFitemmov)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNqtde)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS36H           EScustoMedio VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:    8   º
*       º Variable:            EScustoMedio                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      153                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls36h     &&  EScustoMedio VALID
#REGION 6
RETURN
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Custo M‚dio do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNcusto........: Custo M‚dio do Produto no Momento
	*						(Custo Total / Saldo )
	*
	*------------------------------------------------------------*
	*	CHAMADA............: NEsoma_Saldo
	*
	*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNcusto........: Custo M‚dio do Produto no Momento
	*						(Custo Total / Saldo )
	*------------------------------------------------------------*

FUNCTION EScustoMedio
	PARAMETERS LNemp,LScod,LDdtbase, LShora, LNcusto

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_saldo    , ALS_saldo
	PRIVATE ARQ_itemmov  , ALS_itemmov
	

	PRIVATE TMPcusto

	LNsaldo  	= 0
	LNcusto 	= 0
	LNreserva 	= 0

	IF TYPE("LShora") <> "C" or EMPTY(LShora)
		LShora = "99:99:99"			&&  FORCA PESQUISA NO FINAL DO DIA
	ELSE
		LShora = LEFT(LShora,6)+"60" && FORCA PESQUISA NO PROXIMO MINUTO
	ENDIF


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_saldo  	= NetArqAgain("SALDO")
    ALS_saldo  	= Alias()

    ARQ_itemmov	= NetArqAgain("ITEMMOV")
    ALS_itemmov	= Alias()


	IF (ARQ_grupo+ARQ_empresa+ARQ_saldo+ARQ_itemmov) > 100000
						 && HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*------------------------

	SELECT  &ALS_itemmov
	SET ORDER TO TAG movimento
	SET NEAR ON
	SEEK STR( &ALS_empresa .empresa,3)+LScod+dtos(LDdtbase)+LShora
									&& POSICIONA A FRENTE PARA
									&& VOLTAR E PEGAR SALDO DE
									&& FECHAMENTO OU ATUAL DO DIA
	SET NEAR OFF
	IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ELSE
		SKIP -1
		DO WHILE !BOF() AND &ALS_itemmov .sld_estq = 0 ;
		                AND LScod = &ALS_itemmov .codigo ;
		                AND &ALS_empresa .empresa = &ALS_itemmov .empresa
			SKIP -1
		ENDDO
	ENDIF
	
	IF BOF() OR LScod <> &ALS_itemmov .codigo ;
			 OR &ALS_empresa .empresa <> &ALS_itemmov .empresa

		SELE &ALS_grupo
		SET ORDER TO TAG codigo

	   	SELE &ALS_saldo
	   	SET ORDER TO TAG emp_mes
 		SEEK STR( &ALS_empresa .empresa,3)+STR(YEAR(LDdtbase),4)+;
					STR(MONTH(LDdtbase),2)+ &ALS_grupo .classifica
		IF FOUND()
	   		LNsaldo    = &ALS_saldo .sld_ante
	   		LNcusto    = &ALS_saldo .vlr_ante
		ELSE
			SELECT  &ALS_itemmov
			SKIP		&& avanca p/ pegar data do 1o lancamento

			IF !BOF() AND LScod = &ALS_itemmov .codigo AND ;
				  		  &ALS_empresa .empresa = &ALS_itemmov .empresa)
			   SELE &ALS_saldo
			   SEEK STR( &ALS_empresa .empresa,3)+;
	   	   			STR(YEAR( &ALS_itemmov .data),4)+;
					STR(MONTH( &ALS_itemmov .data),2)+;
					&ALS_grupo .classifica

			   IF FOUND()
	  			    LNsaldo   = &ALS_saldo .sld_ante
				    LNcusto   = &ALS_saldo .vlr_ante
				ELSE
					&& NAO ENCONTROU NENUMA REFERENCIA ANTERIOR
					&& RECOMPOE A SALDO ANTERIOR ANULANDO OPERACAO

				    TMPcusto = 0
					IF &ALS_itemmov .sld_estq = 0
					    TMPcusto   = &ALS_itemmov .vlr_estq
					ELSE						
					    TMPcusto   = &ALS_itemmov .vlr_estq / ;
					                        &ALS_itemmov .sld_estq
					ENDIF

					DO CASE
						CASE LEFT( &ALS_itemmov .operacao,1) = "S"
					    	LNsaldo  = &ALS_itemmov .sld_estq + ;
					    				 &ALS_itemmov .qtde
						CASE LEFT( &ALS_itemmov .operacao,1) = "E"
					    	LNsaldo  = &ALS_itemmov .sld_estq - ;
					    				&ALS_itemmov .qtde
					ENDCASE	
		    	    LNcusto   = LNcusto + (LNsaldo * TMPcusto)
			   ENDIF
			ENDIF
		ENDIF
	ELSE
    	LNsaldo   = &ALS_itemmov .sld_estq
    	LNcusto   = &ALS_itemmov .vlr_estq
	ENDIF

	*-------------------------------------------------------------*
	
	IF LNsaldo = 0	&& EM ITEMMOV O ULTIMO CUSTO FICA REGISTRADO
					&& QDO O ESTOQUE ZERA PORTANTO DEVE SER ZARADO
					&& POIS A ROTINA DEVE REORNAR O CUSTO ESTOCADO
	    LNcusto   = 0
	ELSE
    	LNcusto   = LNcusto / LNsaldo
	ENDIF	


    =up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
	=up_fecha("&ALS_saldo")
    =up_fecha("&ALS_itemmov")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNcusto)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS36U           EScustoEstq VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:    9   º
*       º Variable:            EScustoEstq                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      154                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls36u     &&  EScustoEstq VALID
#REGION 6
RETURN
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Custo M‚dio do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNcusto........: Custo M‚dio do Produto no Momento
	*						(Custo Total / Saldo )
	*
	*------------------------------------------------------------*
	*	CHAMADA............: NEsoma_Saldo
	*
	*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNcusto........: Custo M‚dio do Produto no Momento
	*						(Custo Total / Saldo )
	*------------------------------------------------------------*

FUNCTION EScustoEstq
	PARAMETERS LNemp,LScod,LDdtbase, LShora

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_saldo    , ALS_saldo
	PRIVATE ARQ_itemmov  , ALS_itemmov
	

	PRIVATE TMPcusto,LNcusto

	LNsaldo  	= 0
	LNcusto 	= 0

	IF TYPE("LShora") <> "C" or EMPTY(LShora)
		LShora = "99:99:99"			&&  FORCA PESQUISA NO FINAL DO DIA
	ELSE
		LShora = LEFT(LShora,6)+"60" && FORCA PESQUISA NO PROXIMO MINUTO
	ENDIF


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_saldo  	= NetArqAgain("SALDO")
    ALS_saldo  	= Alias()

    ARQ_itemmov	= NetArqAgain("ITEMMOV")
    ALS_itemmov	= Alias()


	IF (ARQ_grupo+ARQ_empresa+ARQ_saldo+ARQ_itemmov) > 100000
						 && HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*------------------------

	SELECT  &ALS_itemmov
	SET ORDER TO TAG movimento
	SET NEAR ON
	SEEK STR( &ALS_empresa .empresa,3)+LScod+dtos(LDdtbase)+LShora
									&& POSICIONA A FRENTE PARA
									&& VOLTAR E PEGAR SALDO DE
									&& FECHAMENTO OU ATUAL DO DIA
	SET NEAR OFF
	IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ELSE
		SKIP -1
		DO WHILE !BOF() AND &ALS_itemmov .sld_estq = 0 ;
		                AND LScod = &ALS_itemmov .codigo ;
		                AND &ALS_empresa .empresa = &ALS_itemmov .empresa
			SKIP -1
		ENDDO
	ENDIF
	
	IF BOF() OR LScod <> &ALS_itemmov .codigo ;
			 OR &ALS_empresa .empresa <> &ALS_itemmov .empresa

		SELE &ALS_grupo
		SET ORDER TO TAG codigo

	   	SELE &ALS_saldo
	   	SET ORDER TO TAG emp_mes
 		SEEK STR( &ALS_empresa .empresa,3)+STR(YEAR(LDdtbase),4)+;
					STR(MONTH(LDdtbase),2)+ &ALS_grupo .classifica
		IF FOUND()
	   		LNsaldo    = &ALS_saldo .sld_ante
	   		LNcusto    = &ALS_saldo .vlr_ante
		ELSE
			SELECT  &ALS_itemmov
			SKIP		&& avanca p/ pegar data do 1o lancamento

			IF !BOF() AND LScod = &ALS_itemmov .codigo AND ;
				  		  &ALS_empresa .empresa = &ALS_itemmov .empresa)
			   SELE &ALS_saldo
			   SEEK STR( &ALS_empresa .empresa,3)+;
	   	   			STR(YEAR( &ALS_itemmov .data),4)+;
					STR(MONTH( &ALS_itemmov .data),2)+;
					&ALS_grupo .classifica

			   IF FOUND()
	  			    LNsaldo   = &ALS_saldo .sld_ante
				    LNcusto   = &ALS_saldo .vlr_ante
				ELSE
					&& NAO ENCONTROU NENUMA REFERENCIA ANTERIOR
					&& RECOMPOE A SALDO ANTERIOR ANULANDO OPERACAO

				    TMPcusto = 0
					IF &ALS_itemmov .sld_estq = 0
					    TMPcusto   = &ALS_itemmov .vlr_estq
					ELSE						
					    TMPcusto   = &ALS_itemmov .vlr_estq / ;
					                        &ALS_itemmov .sld_estq
					ENDIF

					DO CASE
						CASE LEFT( &ALS_itemmov .operacao,1) = "S"
					    	LNsaldo  = &ALS_itemmov .sld_estq + ;
					    				 &ALS_itemmov .qtde
						CASE LEFT( &ALS_itemmov .operacao,1) = "E"
					    	LNsaldo  = &ALS_itemmov .sld_estq - ;
					    				&ALS_itemmov .qtde
					ENDCASE	
		    	    LNcusto   = LNcusto + (LNsaldo * TMPcusto)
			   ENDIF
			ENDIF
		ENDIF
	ELSE
    	LNsaldo   = &ALS_itemmov .sld_estq
    	LNcusto   = &ALS_itemmov .vlr_estq
	ENDIF

	*-------------------------------------------------------------*
	
	IF LNsaldo = 0	&& EM ITEMMOV O ULTIMO CUSTO FICA REGISTRADO
					&& QDO O ESTOQUE ZERA PORTANTO DEVE SER ZARADO
					&& POIS A ROTINA DEVE REORNAR O CUSTO ESTOCADO
	    LNcusto   = 0
	ENDIF	


    =up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
	=up_fecha("&ALS_saldo")
    =up_fecha("&ALS_itemmov")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNcusto)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS377           EScustoAgregado VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   10   º
*       º Variable:            EScustoAgregado                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      155                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls377     &&  EScustoAgregado VALID
#REGION 6
RETURN

FUNCTION EScustoAgregado
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Informar Custo M‚dio do Produto Recomposto
	*             da Tributa‡Æo que implicara no custo desembolso
	*			  CUSTO + ICMS + RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNvlrdesembolso.: Custo M‚dio do Produto no Momento
	*                       Agregado de Tributos => Custo desembolso
	*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNvlrdesembolso.: Custo M‚dio do Produto no Momento
	*                       Agregado de Tributos => Custo desembolso
	*------------------------------------------------------------*
	PARAMETERS LNemp,LScod,LDdtbase, LShora, LNvlrdesembolso

	=W_DEFPROC("rotinas.spr")

	PRIVATE LNcusto
	PRIVATE LNvlrdesembolso

	*--------------------------------------------------------------------*
	* 	Calculo do Custo M‚dio Agregando Tributos + Valore Que o Tornam
	* a Representa‡Æo do Valor Desembolsado
	*			LNCUSTO + LNicms + LNretido
	*--------------------------------------------------------------------*
	LNcusto = 0

	LNcusto	= EScustoMedio(LNemp,LScod,LDdtbase, LShora, LNcusto)

	*--------------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*

	*** LNvlrdesembolso =  ESAgregarTrbt(LNemp,LScod, LNCusto)

	LNvlrdesembolso =  LNcusto



RETURN(LNvlrdesembolso)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS37E           ESAgregarTrbt VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   11   º
*       º Variable:            ESAgregarTrbt                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      156                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls37e     &&  ESAgregarTrbt VALID
#REGION 6
RETURN

FUNCTION ESAgregarTrbt
	PARAMETERS LNemp,LScod, LNCusto

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Recompor ao valor informado a
	*             Tributa‡Æo que implicara no custo desembolso
	*			  CUSTO + ICMS + RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNvlrdesembolso.: Custo M‚dio do Produto no Momento
	*                       Agregado de Tributos => Custo desembolso
	*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNvlrdesembolso.: Custo Informad do Produto
	*                       Agregado de Tributos => Custo desembolso
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal

	PRIVATE LNipi, LNicms

	PRIVATE LNbaseicms,LNicms,LNretido
	PRIVATE LNvlrdesembolso
	PRIVATE LNaliq_icms


	LNipi		=	0	
	LNicms		=	0



	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_grfiscal+ARQ_grfiscal) > 100000 ;
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	
	SELE &ALS_grupo
	SET ORDER TO TAG codigo

	SEEK LScod
	if not found()
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	endif

	SELE &ALS_grfiscal
	SET ORDER TO TAG tributacao
	SEEK &ALS_empresa .estado+LEFT( &ALS_grupo .classifica,5)

	LNaliq_icms		= 	7	&& % ver possibilidade de pasar em parametro
							&& A aliq_icms esta fixa em 7% porque
							&& os fornecedores sao de Sao Paulo
							&& mas deve ser feito um modelo que
							&& atenda a essa necessidade
							
	LNvlrdesembolso	=	LNcusto
	LNaliq_ipi		=	&ALS_grupo .aliq_ipi

	LNiva			=	&ALS_grfiscal .iva
	LNtpmercad		=	&ALS_grfiscal .tp_mercad

	*************************************************************


	LNbaseicms = (LNcusto*100) / (100+LNaliq_ipi-LNaliq_icms)

	LNicms	   = (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	LNipi	   = (LNbaseicms * LNaliq_ipi)/100

	LNretido   = 0


	IF LNtpmercad = 2 AND LNiva > 0
		LNretido   = (LNbaseicms + LNipi) * LNiva * 0.17 - LNicms
	ENDIF

	LNvlrdesembolso  = LNcusto + LNicms + LNretido


	*----------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNvlrdesembolso)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS37F           ESprc_compra VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   12   º
*       º Variable:            ESprc_compra                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      157                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls37f     &&  ESprc_compra VALID
#REGION 6
RETURN

**********************************************************************
*	Rotina para calculo do preco de compra e venda
*	chamado por SCGC807 SCGC800A E SCGC240A
**********************************************************************
* PARAMETROS
*
*	LNqtde		: Quantidade solicitada
*	LNtab		: Preco de tabela
*	LNdesc		: Desconto total (Normal ou Com Vendor ja aplicado)
*	LNalqipi	: Aliquota de IPI
*   LNalqfrt	: Taxa de Frete
*	LNicmralq	: Aliquota do retido
*	LNiva		: IVA ou MARCKUP
*	LNicmcalq	: Aliquota do ICM de Credito
*
* VARIAVEIS LOCAIS
*	LNliq		: Preco de Tabela Aplicado o Desconto
*	LNipi		: Valor do IPI sobre preco liquido
*	LNcti		: Custo inicial
*	LNfret		: Valor do frete
*	LNadic		: Adicional
*	LNicmc		: Valor ICM de Credito
*	LNicmr		: Valor ICM Retido
*	LNcto		: Custo Total
*	LNpis		: Aliquota do PIS
*	LNcofins	: Aliquota de Cofins
*	LNpcomra 	: Preco de Compra
*	LNpvd		: Preco de Venda
*
*******************************************************************

PROCEDURE ESprc_compra
	PARAMETERS LNqtde,LNtab,LNdesc,LNalqipi,LNalqfrt,LNicmralq,;
			   LNiva, LNicmcalq, LNvendor,LNliq,LNipi,;
			   LNcti,LNfret,LNadic,;
			   LNicmc, LNicmr, LNcto,;
			   LNpis,LNcofins,LNmargem;
			   LNpcompra,LNpvd

	PRIVATE ALL

	STORE 0 TO   LNliq,LNipi,LNcti,LNfret,LNadic,LNicmc,LNicmr,LNcto

	LNliq 		= ((LNtab * (1 - LNdesc/100)) * LNqtde ) * LNvendor
	LNipi 		= LNliq * (LNalqipi /100)
	LNcti 		= (LNliq + LNipi)
	LNfret		= LNcti * (LNalqfrt / 100)

	LNadic		= (LNicmralq /100) * ;
					LNcti * (1+(LNiva /100))

	LNicmc		= LNliq * (LNicmcalq / 100)

	LNicmr		= LNadic - LNicmc
	LNcto 		= (LNcti + LNadic + LNfret) - LNicmc
	LNpcompra 	= LNliq
	LNpvd	 	= LNcto / (1- (LNpis/100 + LNcofins/100 + LNmargem/100 ))

RETURN




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS37W           EScrtcestq VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   13   º
*       º Variable:            EScrtcestq                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      158                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls37w     &&  EScrtcestq VALID
#REGION 6
RETURN

**********************************************************************
*******************************************************************

PROCEDURE EScrtcestq
	PARAMETERS PrmDiasAcima
	
	=W_DEFPROC("rotinas.spr")
    PRIVATE LNpeso

	PRIVATE LSalias
	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_prvitstq , ALS_prvitstq

	LSalias			= ALIAS()


    ARQ_empresa  	= NetArqAgain("EMPRESA")
    ALS_empresa  	= Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_prvitstq  	= NetArqAgain("prvitstq")
    ALS_prvitstq  	= Alias()



	SELECT  IT.regional,IT.filial,lj.sigla,IT.codigo,;
		GR.descricao, 	IT.saldo,;
        IT.RVgiromedi AS giromedio, ;
        INT(IIF(IT.RVgiromedi > 0,IT.saldo /IT.RVgiromedi, ;
        			 IIF(IT.saldo>0,9999.00,0.00)))	 as duracao,;
        INT((IT.RVgiromedio*30)) as consumo, ;
        INT(((IT.RVgiromedio*30) - IT.saldo)) as ajuste ;
   	FROM &ALS_empresa LJ,;
   		 &ALS_grupo GR,;
         c:\tmp\prvitstq IT;
   	WHERE       	LJ.empresa = IT.regional ;
   		 and  	GR.codigo  = IT.CODIGO ;
         and 	((IT.saldo > 0 and IT.RVgiromedio = 0) ;
    	 or 	(IT.RVgiromedio > 0));
         and 	IT.filial = 999;
   	ORDER BY  filial, duracao ;
   	into cursor tmp1
   	
	SELECT * FROM tmp1 ;
        WHERE  duracao > PrmDiasAcima  ;
             AND not EMPTY(descricao) ;
	   	ORDER BY  regional,duracao

	REPORT FORM RES1110 TO FILE l:\TMP\PRT0001A.REL

   	=up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
   	=up_fecha("&ALS_prvitstq")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS385           EScrtcestq VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   14   º
*       º Variable:            EScrtcestq                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      159                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls385     &&  EScrtcestq VALID
#REGION 6
RETURN

**********************************************************************
*******************************************************************

PROCEDURE EScrtcestq
	PARAMETERS PrmDiasAcima
	
	=W_DEFPROC("rotinas.spr")
    PRIVATE LNpeso

	PRIVATE LSalias
	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_prvitstq , ALS_prvitstq

	LSalias			= ALIAS()


    ARQ_empresa  	= NetArqAgain("EMPRESA")
    ALS_empresa  	= Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_prvitstq  	= NetArqAgain("prvitstq")
    ALS_prvitstq  	= Alias()



	SELECT  GR.codigo, GR.descricao,;
	 	IT.saldo,;
        IT.RVgiromedi AS giromedio, ;
        INT(IIF(IT.RVgiromedi > 0,IT.saldo /IT.RVgiromedi, ;
        			 IIF(IT.saldo>0,9999.00,0.00)))	 as duracao,;
        INT((IT.RVgiromedio*30)) as consumo, ;
        INT(((IT.RVgiromedio*30) - IT.saldo)) as ajuste ;
   	FROM &ALS_empresa LJ,;
   		 &ALS_grupo GR,;
         c:\tmp\prvitstq IT;
   	WHERE       	LJ.empresa = IT.regional ;
   		 and  	GR.codigo  = IT.CODIGO ;
         and 	((IT.saldo > 0 and IT.RVgiromedio = 0) ;
    	 or 	(IT.RVgiromedio > 0));
         and 	IT.filial = 999;
   	ORDER BY  filial, duracao ;
   	into cursor tmp1
   	
	SELECT * FROM tmp1 ;
        WHERE  duracao > PrmDiasAcima  ;
             AND not EMPTY(descricao) ;
	   	ORDER BY  regional,duracao

	REPORT FORM RES1110 TO FILE l:\TMP\PRT0001A.REL

   	=up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
   	=up_fecha("&ALS_prvitstq")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS38C           ESextrato VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   15   º
*       º Variable:            ESextrato                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      160                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls38c     &&  ESextrato VALID
#REGION 6
RETURN

FUNCTION ESextrato
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	store "" to ARQ_tmp,ALS_tmp



	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*


	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF


	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	ALS_tmp = ALIAS()


	SELECT  data, ;
			left(hora,5) AS HORA,;
			LEFT(IIF(nota <> 0,"NF"+STR(nota,7),;
			    LEFT(TIPO,2)+STR(orcamento,6))+SPACE(10),10) as doc,;
			operacao, ;
			tipo,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			sld_estq  AS SALDO, ;
			sld_rese  AS SALDORES,;
			IIF(sld_estq > 0,vlr_estq / sld_estq,0000.00) AS cst_medio,;
			ULgetvlrUni(OPERACAO,EMPRESA,FAVORECIDO,;
			    ORCAMENTO,ORDEM,vlrvenda,QTDE) as VALOR_UNI, ;
			(icms_subs/qtde) AS ICMS_SUBS, ;
			(custo_ind/qtde) AS CUSTO_IND,;
			ESOrigDest(favorecido) AS ORIGEM,;
			IIF(negociacao = 2,"S"," ") AS vdcasada,;
			LEFT(RTRIM(DESCRICAO)+"-"+RTRIM(DESCRCOMPL)+"-"+INFO_COMPL,100) AS descricao;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)


	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			DOC			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			SALDO    	:H="SALDO"	:P="@r ####9" :R,;
			SALDORES 	:H="RES"	:P="@r ####9" :R, ;
			CST_MEDIO	:H="CST.M"	:P="@r ####9.99" :R, ;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			icms_subs	:H="R$.Sbst"	:P="@r ####9.99" :R, ;
			custo_ind	:H="Cust.Ind"	:P="@r ####9.99" :R, ;
			ORIGEM		:H="O/D"    :P="AAA" :R, ;
			vdcasada    :H="ENCOMENDA" :R,;
			descricao   :H="DESCRICAO";
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
    =up_fecha("TMPEXT")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF
	
RETURN


FUNCTION ULgetvlrUni
PARAMETERS PrmOperacao, PrmEmp, PrmFavorecido, ;
              PrmBoletim, PrmOrdem,PrmVlrVenda,PrmQtde

	PRIVATE LNVALOR_UNI

	LNVALOR_UNI = 00000000
	if LEFT(PrmOperacao,1) = "E"
		=W_DEFPROC("notaite.spr")
		LNVALOR_UNI=;
		  IEGetCusto(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem) / PrmQtde
	ELSE
		LNVALOR_UNI= PrmVlrVenda / PrmQtde
	ENDIF

RETURN(LNVALOR_UNI)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS38O           ESimpext VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   16   º
*       º Variable:            ESimpext                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      161                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls38o     &&  ESimpext VALID
#REGION 6
RETURN


PROCEDURE ESimpext
PARAMETERS PrmRel
	DO UPPreImpressao WITH  PrmRel, .F. , .F., .F.
	CLEAR TYPEAHEAD
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS38U           ESextRess VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   17   º
*       º Variable:            ESextRess                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      162                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls38u     &&  ESextRess VALID
#REGION 6
RETURN

FUNCTION ESextRess
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	store "" to ARQ_tmp,ALS_tmp


	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*


	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF


	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
        FOR  LEFT(OPERACAO,1) $ "E/S" ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo ;
		      AND DATA   <= PrmDtFim
		
	SELE 0
	USE &ARQ_tmp
	ALS_tmp = ALIAS()

	SELECT  data, ;
			dtfat AS dataemi,;
			operacao,;
			tipo,;
			IIF(nota <> 0,"NF"+STR(nota,7),LEFT(TIPO,2)+STR(orcamento,6)) as doc,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			IIF(qtde > 0,vlrvenda / Qtde,vlrvenda)   AS VALOR_UNI, ;
			(vlripi * 100 / vlrvenda) AS Aliqipi,;
			iva,;
			ESOrigDest(favorecido) AS ORIGEM;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)

	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407A"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ EXTRATO APOIO AO RESSARCIMENTO MANUAL ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
		BROWSE  FIELDS ;
				DATA		:H="DT.ENT" :R,;
				DATAEMI		:H="DT.EMI" :R,;
				QTDE     	:H="QTDE"	:P="@r ####9" :R,;
				DOC			:H="DOC" :R,;
				VALOR_UNI	:H="R$.UNI"	:P="@r #,##9.99" :R, ;
				ALIQIPI    	:H="IPI"	:P="@r ##" :R,;
				IVA     	:H="IVA"	:P="@r 9.99" :R,;
				TIPO     	:H="TIPO"	  :R,;
				OPERACAO   	:H="OPERACAO"  :R;
				TITLE "[ EXTRATO P/ RESSARCIMENTO ]";
				COLOR SCHEME 10 ;
				  NODELETE NOAPPEND NORMAL  NOEDIT;
			    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	
	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF

RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS394           ESOrigDest VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   18   º
*       º Variable:            ESOrigDest                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      163                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls394     &&  ESOrigDest VALID
#REGION 6
RETURN

FUNCTION ESOrigDest
PARAMETERS PrmCGC
	PRIVATE LSalias,LSsigla
	LSalias = Alias()
	IF EMPTY(PrmCGC)
		RETURN("   ")
	ENDIF

	SELECT &ALS_empresa
	SET ORDER TO TAG CGC
	SEEK PrmCGC
	IF FOUND()
		LSsigla = &ALS_empresa .sigla
	else
		LSsigla = "   "
	ENDIF	
	SELE &LSalias
RETURN(LSsigla)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS39B           ESextEntradas VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   19   º
*       º Variable:            ESextEntradas                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      164                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls39b     &&  ESextEntradas VALID
#REGION 6
RETURN

FUNCTION ESextEntradas
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	PRIVATE LNsaldo
	
	store "" to ARQ_tmp,ALS_tmp
	LNsaldo = 0


	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*


	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF


	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		FOR     LEFT(operacao,1) = "E" ;
		    AND CH_OPERA = "1" ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	go top
	ALS_tmp = ALIAS()
	LNsaldo = 0
	LNctr   = 0

	SELECT  data, ;
			left(hora,5) AS HORA,;
			IIF(nota <> 0,"NF"+STR(nota,7),LEFT(TIPO,2)+STR(orcamento,6)) as doc,;
			operacao, ;
			tipo,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			ULESextrEnt(qtde,movestq,operacao) AS SALDO, ;
			sld_rese  AS SALDORES,;
			IIF(sld_estq > 0,vlr_estq / sld_estq,0) AS cst_medio,;
			IIF(qtde > 0,vlrvenda / Qtde,vlrvenda) as VALOR_UNI, ;
			ESOrigDest(favorecido) AS ORIGEM,;
			IIF(negociacao = 2,"S"," ") AS vdcasada;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			DOC			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			SALDO    	:H="SALDO"	:P="@r ####9" :R,;
			SALDORES 	:H="RES"	:P="@r ####9" :R, ;
			CST_MEDIO	:H="CST.M"	:P="@r ###9.99" :R, ;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			ORIGEM		:H="O/D"    :P="AAA" :R, ;
			vdcasada    :H="ENCOMENDA" :R;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	
	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF

RETURN


FUNCTION ULESextrEnt
PARAMETERS PrmQtde,PrmMovestq,PrmOperacao
	PRIVATE LnRetorno
	IF LNctr   = 0
		LNctr = 1
		RETURN(000000)
	ENDIF

	DO CASE
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "E"
			 LNsaldo = LNsaldo + PrmQtde
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "S"
			 LNsaldo = LNsaldo - PrmQtde
	ENDCASE	
	LnRetorno	 = LNsaldo
RETURN(LnRetorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS39N           ESextTrasf VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   20   º
*       º Variable:            ESextTrasf                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      165                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls39n     &&  ESextTrasf VALID
#REGION 6
RETURN

FUNCTION ESextTrasf
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	PRIVATE LNsaldo
	
	store "" to ARQ_tmp,ALS_tmp
	LNsaldo = 0


	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*

	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF

	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		FOR     LEFT(operacao,1) = "E" ;
		    AND CH_OPERA = "2" ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	go top
	ALS_tmp = ALIAS()
	LNsaldo = 0
	LNctr   = 0

	SELECT  data, ;
			left(hora,5) AS HORA,;
			IIF(nota <> 0,"NF"+STR(nota,7),LEFT(TIPO,2)+STR(orcamento,6)) as doc,;
			operacao, ;
			tipo,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			ULESextrEnt(qtde,movestq,operacao) AS SALDO, ;
			sld_rese  AS SALDORES,;
			IIF(sld_estq > 0,vlr_estq / sld_estq,0) AS cst_medio,;
			IIF(qtde > 0,vlrvenda / Qtde,vlrvenda) as VALOR_UNI, ;
			ESOrigDest(favorecido) AS ORIGEM,;
			IIF(negociacao = 2,"S"," ") AS vdcasada;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			DOC			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			SALDO    	:H="SALDO"	:P="@r ####9" :R,;
			SALDORES 	:H="RES"	:P="@r ####9" :R, ;
			CST_MEDIO	:H="CST.M"	:P="@r ###9.99" :R, ;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			ORIGEM		:H="O/D"    :P="AAA" :R, ;
			vdcasada    :H="ENCOMENDA" :R;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF
	
RETURN


FUNCTION ULESextrEnt
PARAMETERS PrmQtde,PrmMovestq,PrmOperacao
	PRIVATE LnRetorno
	IF LNctr   = 0
		LNctr = 1
		RETURN(000000)
	ENDIF

	DO CASE
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "E"
			 LNsaldo = LNsaldo + PrmQtde
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "S"
			 LNsaldo = LNsaldo - PrmQtde
	ENDCASE	
	LnRetorno	 = LNsaldo
RETURN(LnRetorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS39Z           ESVld_Produto VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   21   º
*       º Variable:            ESVld_Produto                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      166                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls39z     &&  ESVld_Produto VALID
#REGION 6
RETURN
PROCEDURE ESVld_Produto
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Pesquisar Produtos em uma Lista
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: GRUPO
	*------------------------------------------------------------*
	* PARAMETROS..:
	*             LScodigo : Codigo do Produto - Pode Ser Utiliza
	*                  para posicionamento parcial
	*------------------------------------------------------------*
	* CHAMADAS.............:
	*------------------------------------------------------------*
	PARAMETERS LScodigo

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_grupo, ALS_grupo
  	PRIVATE LFretorno

    LSalias      = Alias()
    ARQ_grupo    = NetArqAgain("GRUPO")
    ALS_grupo    = Alias()

	SELE &ALS_grupo
	SET ORDER TO TAG codigo
	SEEK ALLTRIM(LScodigo)
	IF !FOUND()
	   LFretorno= .f.
	ELSE
	   LFretorno= .T.
	ENDIF

	=UP_fecha(ALS_GRUPO)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3A6           ESGet_Origem VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   22   º
*       º Variable:            ESGet_Origem                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      167                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3a6     &&  ESGet_Origem VALID
#REGION 6
RETURN
FUNCTION ESGet_Origem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	PARAMETERS LScodigo,PrmOrigem

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_grupo, ALS_grupo
  	PRIVATE LFretorno

    LSalias      = Alias()
    ARQ_grupo    = NetArqAgain("GRUPO")
    ALS_grupo    = Alias()

	SELE &ALS_grupo
	SET ORDER TO TAG codigo
	SEEK ALLTRIM(LScodigo)
	IF FOUND()
	   PrmOrigem= 	&Als_Grupo .origem
	   LFretorno= 	.t.
	ELSE
	   PrmOrigem= 	0
	   LFretorno= .f.
	ENDIF

	=UP_fecha(ALS_GRUPO)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3AE           ORExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:    3  º
*       º Variable:            ORExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      168                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ae     &&  ORExiste VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ANTORExiste
PARAMETERS PrmEmp,PrmOrcamento
	Private FlgExiste
	FlgExiste=ORChk_Identidade(PrmEmp,PrmOrcamento)

RETURN(Lexiste)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3AK           ORGetValor VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:    4  º
*       º Variable:            ORGetValor                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      169                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ak     &&  ORGetValor VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORGetValor
PARAMETERS PrmEmp,PrmOrcamento

	=ORChk_Identidade(PrmEmp,PrmOrcamento)

RETURN(ORGetPropVT("VALOR"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3AL           ORGetDt_Fat VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:    5  º
*       º Variable:            ORGetDt_Fat                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      170                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3al     &&  ORGetDt_Fat VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORGetDt_fat
PARAMETERS PrmEmp,PrmOrcamento

	=ORChk_Identidade(PrmEmp,PrmOrcamento)

RETURN(ORGetPropVT("DT_FAT"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3AV           ORView VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:    6  º
*       º Variable:            ORView                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      171                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3av     &&  ORView VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORView
PARAMETERS PrmEmpresa
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE Lretorno
    PRIVATE ARQ_Clienc,ALS_Clienc


	LSalias		= 	ALIAS()

	=ORVerifyInst()
	*--------------------------------------------------------------*

    ARQ_Clienc  = NetArqAgain("CLIENC")
    ALS_Clienc  = Alias()
	*--------------------------------------------------------------*


	Lretorno = ""
    SELECT  ;
		 OR.empresa,;
		 OR.orcamento,;
		 OR.operador,;
		 OR.situacao,;
		 OR.data,;
		 cl.fone,;
		 OR.valor,;
		 cl.nome,;
		 OR.veiculo,;
		 OR.dtregis,;
		 OR.hregis,;
		 OR.usrregis ;
    	 FROM  &ALS_Clienc CL, &PBOrcamentAlias OR;
	WHERE OR.EMPRESA = PrmEmpresa ;
	      AND CL.EMPRESA = OR.EMPRESA ;
	      AND CL.ORCAMENTO = OR.ORCAMENTO ;
    ORDER BY OR.ORCAMENTO;
    INTO CURSOR ORVIEW


	ON KEY LABEL ESCAPE
  	DO loc_dlog WITH .T.,.F.,.F., .F., .F.,.F., "ORCABROW"
   	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	LNkey 	= LASTKEY()   && PERMITIR TRATAMENTO DA DESISTENCIA
							  && NA ROTINA CHAMADORA
	IF LASTKEY() <> 27
		Lretorno = ORVIEW.Orcamento
		=OR_Refresh(PrmEmpresa,Lretorno)
	ELSE
		Lretorno = 0
	ENDIF
	SELE ORVIEW
	USE
		
	*--------------------------------------------------------------*
   	=up_fecha("&ALS_Clienc")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(Lretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3B3           ORVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:    7  º
*       º Variable:            ORVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      172                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3b3     &&  ORVerifyInst VALID
#REGION 7
return
*---------------------------------------------------------------*



FUNCTION ORVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Orcament")


	DO CASE

		CASE TYPE("PBOrcamentAlias") = "U" ;
		   		OR EMPTY(PBOrcamentAlias) ;
		   		OR !USED(PBOrcamentAlias)
			=ORCreate()					

		CASE !("ORCAMENT.DBF" $ DBF(PBOrcamentAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBOrcamentAlias
			=ORCreate()					


		CASE  !(LSPath $ DBF(PBOrcamentAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=ORDestroi()				
			=ORCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3B9           ORCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:    8  º
*       º Variable:            ORCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      173                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3b9     &&  ORCreate VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBOrcamentAlias") <> "U" ;
	   		AND !EMPTY(PBOrcamentAlias) ;
	   		AND USED(PBOrcamentAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBOrcamentAlias

	IF USED("Orcament")
	     =NetArqAgain("Orcament")
	     PBOrcamentAlias     = Alias()
	ELSE
	     =NetArqAgain("Orcament")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Orcament")
	     PBOrcamentAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBOrcamentAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTOrcament[LMaxDim]&& VETOR PARA CAMPOS DA TABELA
    PUBLIC DIMENSION VDOrcament[2,3]	&& VETOR PARA CAMPOS DERIVADAS
    PUBLIC DIMENSION VFOrcament[1]      && VETOR CABECALHO DOS CAMPOS
    PUBLIC DIMENSION VCOrcament[8,3]	&& VETOR PARA CONFIGURACOES


	=AFIELDS(VFOrcament)



	*-----------------------------------------------------------*
	=ORReadProperty()
	=ORSetDerivadas()
	=ORSetConfig()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3BH           ORDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:    9  º
*       º Variable:            ORDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      174                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3bh     &&  ORDestroi VALID
#REGION 7
return
*---------------------------------------------------------------*


FUNCTION ORDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBOrcamentAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBOrcamentAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBOrcamentAlias
	*  3- Se aplicar um FECHAMENTO a PBOrcamentAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBOrcamentAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBOrcamentAlias)) OR ;
	   !("ORCAMENT.DBF" $ DBF(PBOrcamentAlias))

		RELEASE PBOrcamentAlias
    	RELEASE VTOrcament
	    RELEASE VDOrcament
		RELEASE VFOrcament
		RELEASE VCOrcament
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBOrcamentAlias) AND USED(PBOrcamentAlias)
		SELECT &PBOrcamentAlias
		USE
	ENDIF	
	RELEASE PBOrcamentAlias
    RELEASE VTOrcament
    RELEASE VDOrcament
	RELEASE VFOrcament
	RELEASE VCOrcament

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3BO           ORReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   10  º
*       º Variable:            ORReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      175                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3bo     &&  ORReadProp VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBOrcamentAlias
	SCATTER TO VTOrcament
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3BU           ORSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   11  º
*       º Variable:            ORSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      176                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3bu     &&  ORSetDerivadas VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDOrcament(1,1) = "NAOINFORMADO"	&& TITULO	
   	VDOrcament(1,2) = 0					&& VALOR
   	VDOrcament(1,3) = .F.				&& FLAG .T. => FOI CARREGADO
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3C2           ORSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   12  º
*       º Variable:            ORSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      177                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3c2     &&  ORSetPropVT VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBOrcamentAlias,;
						    VTOrcament,;
						    VDOrcament,;
						    VFOrcament,;
						    VCOrcament)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3C3           ORGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   13  º
*       º Variable:            ORGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      178                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3c3     &&  ORGetPropVT VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBOrcamentAlias,;
	            VTOrcament,;
	            VDOrcament,;
			    VFOrcament,;
			    VCOrcament)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3CF           ORChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   14  º
*       º Variable:            ORChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      179                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3cf     &&  ORChk_Identidade VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORChk_Identidade
PARAMETERS PrmEmpresa,PrmOrcamento

	PRIVATE LFretorno
	LFretorno = .t.

	=ORVerifyInst()

    =ORSetPropVT("EMPRESA",PrmEmpresa)
    =ORSetPropVT("ORCAMENTO",PrmOrcamento)

	LFretorno=ORFind()
RETURN(LFretorno)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3CL           ORFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   15  º
*       º Variable:            ORFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      180                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3cl     &&  ORFind VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORFind


	PRIVATE LEmpresa,LOrcamento
	PRIVATE LFreturn
	PRIVATE LSchaveAcesso


	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=ORVerifyInst()


	SELE &PBOrcamentAlias
	LSchaveAcesso  =ORGetPropVT("CHAVE DE LEITURA")


    LEmpresa =ORGetPropVT("EMPRESA")
    LOrcamento=ORGetPropVT("ORCAMENTO")



	SELE &PBOrcamentAlias
	DO CASE
		CASE UPPER(LSchaveAcesso) = "?????"
			SELE &PBOrcamentAlias

		OTHERWISE
			SET ORDER TO TAG geral
			SEEK STR(Lempresa,3)+STR(Lorcamento,6)	

	ENDCASE
	IF FOUND()
		=ORReadProperty()
		=ORSetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3CR           ORGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   16  º
*       º Variable:            ORGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      181                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3cr     &&  ORGetFieldValue VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORGetFieldValue
PARAMETERS PrmEmp,PrmOrcamento,	PrmField

	=ORChk_Identidade(PrmEmp,PrmOrcamento)

RETURN(ORGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3CX           OR_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   17  º
*       º Variable:            OR_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      182                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3cx     &&  OR_Refresh VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION OR_Refresh
PARAMETERS PrmEmpresa,PrmOrcamento

	PRIVATE LFretorno
	LFretorno = .t.
	
	=ORVerifyInst()
	*----------------------------------------------------------------*
	
    =ORSetPropVT("EMPRESA",PrmEmpresa)
    =ORSetPropVT("ORCAMENTO",PrmOrcamento)
	LFretorno=ORFind()
	
RETURN(LFretorno)







*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3D3           ORWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   18  º
*       º Variable:            ORWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      183                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3d3     &&  ORWriteProp VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBOrcamentAlias
	=RLOCK()
	GATHER FROM  VTOrcament
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3D9           ORGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   19  º
*       º Variable:            ORGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      184                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3d9     &&  ORGetAlias VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORGetAlias

	=ORVerifyInst()

RETURN(PBOrcamentAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3DF           ORSetConfig VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   20  º
*       º Variable:            ORSetConfig                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      185                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3df     &&  ORSetConfig VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORSetConfig

	*--------------------------------------------------------------*
    VCOrcament(1,1) = "REG_STATE" && INSERT/EDICAO/BROWSER/
   	VCOrcament(1,2) = ""
   	VCOrcament(1,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(2,1) = "CHV_LER" && p/ leitura do ultimo reg + 1
   	VCOrcament(2,2) = ""
   	VCOrcament(2,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(3,1) = "CHV_COMPARA" && p/ leitura do ultimo reg + 1
   	VCOrcament(3,2) = ""
   	VCOrcament(3,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(4,1) = "CHV_BROW" && p/ leitura do ultimo reg + 1
   	VCOrcament(4,2) = ""
   	VCOrcament(4,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(5,1) = "ISEDITING" && p/ leitura do ultimo reg + 1
   	VCOrcament(5,2) = .F.
   	VCOrcament(5,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(6,1) = "ISADDING" && p/ leitura do ultimo reg + 1
   	VCOrcament(6,2) = .F.
   	VCOrcament(6,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(7,1) = "ISREADING" && p/ leitura do ultimo reg + 1
   	VCOrcament(7,2) = .F.
   	VCOrcament(7,3) = .T.
	*--------------------------------------------------------------*
    VCOrcament(8,1) = "CHAVE DE LEITURA" && TAG DO CHAVE USADA EM FIND
   	VCOrcament(8,2) = "ORCAMENTO"
   	VCOrcament(8,3) = .T.
	*--------------------------------------------------------------*
	
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3DL           ORTrtChv VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   21  º
*       º Variable:            ORTrtChv                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      186                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3dl     &&  ORTrtChv VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORTrtChv
PARAMETERS PrmEmpresa,PrmOrcamento

	PRIVATE LFretorno
	LFretorno = .t.

	=ORVerifyInst()


    =ORSetPropVT("EMPRESA",PrmEmpresa)
    =ORSetPropVT("ORCAMENTO",PrmOrcamento)
	*--------------------------------------------------------------*

	LFretorno=ORFind()

	SELE &PBOrcamentAlias
RETURN(UPtratachv())





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3DM           ORScatter VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   23  º
*       º Variable:            ORScatter                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      187                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3dm     &&  ORScatter VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORScatter

	PRIVATE LFretorno
	LFretorno = .t.

	=ORVerifyInst()
	SELE &PBOrcamentAlias
	SCATTER MEMVAR MEMO
RETURN(.T.)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3DX           ORLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   27  º
*       º Variable:            ORLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      188                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3dx     &&  ORLerRegistro VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORLerRegistro
PARAMETERS PrmEmpresa,PrmOrcamento



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = ORChk_Identidade(PrmEmpresa,PrmOrcamento)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3E4           ORSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   28  º
*       º Variable:            ORSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      189                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3e4     &&  ORSalvarRegistro VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORSalvarRegistro

	=ORVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !ORExiste()
		SELE &PBOrcamentAlias
		APPEND BLANK
		LFretorno=ORWriteProp()
	ELSE
		SELE &PBOrcamentAlias
		LFretorno=ORWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3EA           ORExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   29  º
*       º Variable:            ORExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      190                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ea     &&  ORExiste VALID
#REGION 7
return
*---------------------------------------------------------------*

FUNCTION ORExiste


	PRIVATE LEmpresa,LOrcamento
	PRIVATE LFreturn
	PRIVATE LSchaveAcesso


	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=ORVerifyInst()


	SELE &PBOrcamentAlias
	LSchaveAcesso  =ORGetPropVT("CHAVE DE LEITURA")


    LEmpresa =ORGetPropVT("EMPRESA")
    LOrcamento=ORGetPropVT("ORCAMENTO")



	SELE &PBOrcamentAlias
	DO CASE
		CASE UPPER(LSchaveAcesso) = "?????"
			SELE &PBOrcamentAlias

		OTHERWISE
			SET ORDER TO TAG geral
			SEEK STR(Lempresa,3)+STR(Lorcamento,6)	

	ENDCASE
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3EH           ORBtnVal VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   30  º
*       º Variable:            ORBtnVal                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      191                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3eh     &&  ORBtnVal VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CLBtnVal
PARAMETERS PrmTecla

	PRIVATE Lchv_Ler
	PRIVATE Lchv_Compara
	PRIVATE Lchv_Brow
	PRIVATE LOrcamento


	=ORVerifyInst()

	Lchv_ler    = ORGetPropVT("CHV_LER")
	Lchv_compara= ORGetPropVT("CHV_COMPARA")
	Lchv_brow   = ORGetPropVT("CHV_BROW")

	
	SELE &PBOrcamentAlias
	DO CASE
	
		CASE PrmTecla = "LOCATE"

			LOrcamento     = ORGetPropVT("ORCAMENTO")

			=ORView(LOrcamento)
			SELE &PBOrcamentAlias
			SCATTER MEMVAR MEMO

			
		OTHERWISE

		    DO btn_val with PrmTecla,;
	   			       Lchv_ler,;
	   			       Lchv_compara,;
	   			       Lchv_brow,;
	   			       .T.,;
	   			       .T.
	   			
	ENDCASE
	   			
	=ORSetPropVT("ISEDITING",ISEDITING)
	=ORSetPropVT("ISADDING",ISADDING)
	=ORSetPropVT("ISREADING",ISREADING)
	   			
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3EO           ORView VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   31  º
*       º Variable:            ORView                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      192                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3eo     &&  ORView VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3EV           ORLOCATE VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   32  º
*       º Variable:            ORLOCATE                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      193                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ev     &&  ORLOCATE VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3F1           ORGeraBTS VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   34  º
*       º Variable:            ORGeraBTS                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      194                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3f1     &&  ORGeraBTS VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORGeraBTS
PARAMETERS  PrmEmp,;
			PrmOrcamento,;
			PrmFile,;
			PrmNroIDFile


	PRIVATE LAliasOR
	PRIVATE LAliasEmpresa
	PRIVATE LAliasClienc


	PRIVATE Ltmp


	IF !ORLerRegistro(PrmEmp,PrmOrcamento)
	      wait "Nao foi localizado OSI :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "OSI: "+STR(PrmOrcamento,6)
    	  return(.F.)
	ENDIF




	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinha

	*-------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	=EMLerRegistro(PrmEmp)


	=W_DEFPROC("CLIENC.SPR")
	=CNLerRegistro(PrmEmp,PrmOrcamento)


	LAliasOR=ORGetAlias()

	=W_DEFPROC("CLIENC.SPR")
	LAliasClienc = CNGetAlias()


	=W_DEFPROC("EMPRESA.SPR")
	LAliasEmpresa = EMGetAlias()


	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("CGC")
    UNEM_CNPJ    =  STR(LFieldTmp,14)


	*-------------------------------------------------------*

	LSLinha = 'REG01'
	*--> CODIGO IDENTIFCADOR DA BTS
	LSLinha = LSLinha+'027399'

	*--> CODIGO IDENTIFCADOR DA BTS
	LSLinha = LSLinha+CHRTRAN(STR(PrmOrcamento,6)," ","0") +SPACE(24)


    set centu off
	Ltmp    = CHRTRAN(DTOC( &LAliasOR .data),".","")
    set centu on


	LSLinha = LSLinha+Ltmp

	LSLinha = LSLinha+ &LAliasOR .hora
	LSLinha = LSLinha+ "1"    && 1-VENDA BALCAO
	LSLinha = LSLinha+ "5"    && SITUACAO 5-FATURADA
	


	=W_DEFPROC("EMPRESA.SPR")
	Ltmp = EMGetFieldValue(PrmEmp,"GRTREL_BTS")
	LSLinha = LSLinha+LEFT(Ltmp+SPACE(50),50)



	IF &LAliasOR .prazomedio = 0
		LSLinha = LSLinha+LEFT("A VISTA"+SPACE(50),50)
	ELSE	
		LSLinha = LSLinha+LEFT("A PRAZO"+SPACE(50),50)
	ENDIF

	LSLinha = LSLinha+ &LAliasOR .placa

	LSLinha = LSLinha+ LEFT( &LAliasOR .montadora+SPACE(50),50)
	LSLinha = LSLinha+ LEFT( &LAliasOR .veiculo+SPACE(50),50)
	LSLinha = LSLinha+ LEFT( &LAliasOR .conf_veic+SPACE(5),5)
	LSLinha = LSLinha+ CHRTRAN(STR( &LAliasOR .anofabveic ,4)," ","0")
	LSLinha = LSLinha+ LEFT( &LAliasOR .cor_veic+SPACE(30),30)
	LSLinha = LSLinha+ SPACE(50) && CARROCERIA
	LSLinha = LSLinha+ LEFT( &LAliasOR .LICENCA_TX+SPACE(30),30)


	IF &LAliasClienc .tp_pessoa = 1    && PESSOA FISICA
		Ltmp = CHRTRAN(STR( &LAliasClienc .CLIENTE,11)," ","0")
	ELSE	
		Ltmp = ""
	ENDIF
	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(20),20)

	IF &LAliasClienc .tp_pessoa = 2    && PESSOA JURIDICA
		Ltmp = CHRTRAN(STR( &LAliasClienc .CLIENTE,14)," ","0")
	ELSE	
		Ltmp = ""
	ENDIF
	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(20),20)

	LSLinha = LSLinha+ LEFT( &LAliasClienc .NOME+SPACE(60),60)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .CEP+SPACE(8),8)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .ENDERECO+SPACE(200),200)
	LSLinha = LSLinha+ SPACE(10)    && TIPO LOGRADOURO
	LSLinha = LSLinha+ SPACE(100)   && DESCRICAO LOGRADOURO
	LSLinha = LSLinha+ SPACE(10)    && NUMERO LOGRADOURO
	LSLinha = LSLinha+ SPACE(50)    && COMPLEMENTO
	LSLinha = LSLinha+ LEFT( &LAliasClienc .BAIRRO+SPACE(40),40)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .CIDADE+SPACE(40),40)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .ESTADO+SPACE(2),2)
	IF EMPTY( &LAliasClienc .PAIS)
		LSLinha = LSLinha+ LEFT( "BRASIL"+SPACE(10),10)
	ELSE
		LSLinha = LSLinha+ LEFT( &LAliasClienc .PAIS+SPACE(10),10)
	ENDIF
	
	LSLinha = LSLinha+ LEFT( &LAliasClienc .CX_POSTAL+SPACE(10),10)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .E_MAIL+SPACE(100),100)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .RAMO_TRAB+SPACE(30),30)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .DSCRREGIAO+SPACE(30),30)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .DDD+SPACE(10),10)
	LSLinha = LSLinha+ LEFT( &LAliasClienc .FONE+SPACE(20),20)

	LSLinha = LSLinha+ SPACE(50)    && NOME CONDUTOR

	Ltmp = CHRTRAN(STR( &LAliasOR .HODOM,6)," ","0")

	LSLinha = LSLinha+ LEFT( Ltmp +SPACE(10),10)

	=fPuts(PrmNroIDFile,LSLinha,LEN(LSLinha))



RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3F2           ORGerBTS1 VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   35  º
*       º Variable:            ORGerBTS1                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      195                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3f2     &&  ORGerBTS1 VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORGerBTS1
PARAMETER PrmEmpresa,PrmDtIni,PrmDtFim




	PRIVATE LSalias
	
	PRIVATE PrmAlsOrcament
	PRIVATE PrmAlsTmpOrca
	
	LSalias = ALIAS()


	=W_DEFPROC("ORCATMP.SPR")
	PrmAlsOrcament = ORGetAlias()

	LSalias = ALIAS()

	=W_DEFPROC("ORCATMP.SPR")
	PrmAlsTmpOrca = OTGetAlias()




	*-------------------------------------------------------*

   	PRIVATE LSfileTXT,LNroIDfileTXT

   	LSfileTXT	= "\SCGC\EXPORTA\BTS.TXT"
  	LNroIDfileTXT 		=fcreate(LSfileTXT)
   	if LNroIDfileTXT<0
      =fclose(LNroIDfileTXT)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileTXT+'- <ENTER> ' window
      return
   	endif


	*---------------------------------------------------*

	SELE &PrmAlsOrcament
	SET ORDER TO TAG DATA_FAT
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+DTOS(PrmDtIni)
	SET NEAR OFF

	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() ;
	        AND PrmEmpresa =  &PrmAlsOrcament .empresa;
	        AND PrmDtIni   <= &PrmAlsOrcament .dt_fat ;
	        AND PrmDtFim   >= &PrmAlsOrcament .dt_fat ;
         TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*



	SELE &PrmAlsOrcament
	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa =  &PrmAlsOrcament .empresa;
	        AND PrmDtIni   <= &PrmAlsOrcament .dt_fat ;
	        AND PrmDtFim   >= &PrmAlsOrcament .dt_fat

		=UPtermo()
		LRegOrcamento = RECNO()

		IF LEFT( &PrmAlsOrcament .SITUACAO,1) = "O"  ;
		   AND &PrmAlsOrcament .E_OSI_BTS = 1    && OSI BTS FATURADA

			=ORGeraBTS(;
				&PrmAlsOrcament .Empresa,;
				&PrmAlsOrcament .Orcamento,;
				LSfileTXT,;
				LNroIDfileTXT)

	
			SELE &PrmAlsTmpOrca
			SET ORDER TO TAG orcamento
			SET NEAR ON
			SEEK STR(PrmEmpresa,3)+STR( &PrmAlsOrcament .Orcamento,6)
			SET NEAR OFF
	
			
			DO WHILE !EOF() ;
				AND	LFsegue = .t. ;
	        	AND PrmEmpresa =  &PrmAlsTmpOrca .empresa;
		        AND &PrmAlsOrcament .Orcamento = &PrmAlsTmpOrca .orcamento
	
				LRegItemOrcamento = RECNO()

				IF LEFT( &PrmAlsTmpOrca .SITUACAO,1) = "O"  ;
		
					IF &PrmAlsTmpOrca .tp_mercad = 7
						=ORGeraSrvcBTS(;
							&PrmAlsTmpOrca .Empresa,;
							&PrmAlsTmpOrca .Orcamento,;
							&PrmAlsTmpOrca .Ordem,;
							LSfileTXT,;
							LNroIDfileTXT)
					ELSE
						=ORGeraProdBTS(;
							&PrmAlsTmpOrca .Empresa,;
							&PrmAlsTmpOrca .Orcamento,;
							&PrmAlsTmpOrca .Ordem,;
							LSfileTXT,;
							LNroIDfileTXT)
	
					ENDIF
				ENDIF
				SELE &PrmAlsTmpOrca
				SET ORDER TO TAG orcamento
				GO LRegItemOrcamento
				SKIP
			ENDDO
		ENDIF

		
		SELE &PrmAlsOrcament
		SET ORDER TO TAG DATA_FAT
		GO LRegOrcamento
		SKIP
	ENDDO


	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileTXT)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3FZ           ORGeraProdBTS VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   36  º
*       º Variable:            ORGeraProdBTS                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      196                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3fz     &&  ORGeraProdBTS VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORGeraProdBTS
PARAMETERS  PrmEmp,;
			PrmOrcamento,;
			PrmOrdem,;
			PrmFile,;
			PrmNroIDFile



	PRIVATE PrmAlsTmpOrca




	PRIVATE Ltmp


	=W_DEFPROC("ORCATMP.SPR")
	IF !OTLerRegistro(PrmEmp,PrmOrcamento,PrmOrdem)
	      wait "Nao foi localizado OSI :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "OSI: "+STR(PrmOrcamento,6)+;
		      "ITEM: "+STR(PrmOrdem,2)
    	  return(.F.)
	ENDIF


	=W_DEFPROC("ORCATMP.SPR")
	PrmAlsTmpOrca = OTGetAlias()



	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinha

	*-------------------------------------------------------*


	*-------------------------------------------------------*

	LSLinha = 'REG02'
	*--> CODIGO IDENTIFCADOR DA BTS
	LSLinha = LSLinha+'027399'


	*--> CODIGO IDENTIFCADOR DA BTS
	LSLinha = LSLinha+CHRTRAN(STR(PrmOrcamento,6)," ","0") +SPACE(24)


	*--> CODIGO DO PRODUTO NO BTS
	LSLinha = LSLinha+ LEFT( &PrmAlsTmpOrca .codigo+SPACE(50),50)

	*--> CODIGO DO PRODUTO FABRICANTE
	=W_DEFPROC("GRUPO.SPR")
	Ltmp = GRGetFieldValue( &PrmAlsTmpOrca .codigo, ;
	                                  "CDG_NO_FBR")

	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(50),50)




	*--> CODIGO DE BARRA DO PRODUTO NO BTS
	Ltmp    = ""
	LSLinha = LSLinha+ LEFT( Ltmp +SPACE(50),50)


	*--> DESCRICAO DO PRODUTO NO BTS
	LSLinha = LSLinha+ LEFT( &PrmAlsTmpOrca .descricao+SPACE(100),100)


	*--> APLICACAO DO PRODUTO
	=W_DEFPROC("GRUPO.SPR")
	Ltmp = GRGetFieldValue( &PrmAlsTmpOrca .codigo, ;
	                                  "APLICACAO")

	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(50),50)


	*--> QTDE
	Ltmp    = STR( &PrmAlsTmpOrca .qtde ,15,5)
	Ltmp    = CHRTRAN(Ltmp," ","0")
	Ltmp    = CHRTRAN(Ltmp,".","")
	Ltmp    = CHRTRAN(Ltmp,",","")
	LSLinha = LSLinha+Ltmp


	*--> VLR UNITARIO
	Ltmp    = STR( &PrmAlsTmpOrca .vlrvenda / &PrmAlsTmpOrca .qtde ,15,5)
	Ltmp    = CHRTRAN(Ltmp," ","0")
	Ltmp    = CHRTRAN(Ltmp,".","")
	Ltmp    = CHRTRAN(Ltmp,",","")
	LSLinha = LSLinha+Ltmp


	*--> PROD ENTREGUE
	Ltmp    = "S"
	LSLinha = LSLinha+Ltmp


	*--> PROD TEXTO
	Ltmp    = SPACE(2000)
	LSLinha = LSLinha+Ltmp


	=W_DEFPROC("GRUPO.SPR")
	Ltmp = GRGetNomeFab( &PrmAlsTmpOrca .codigo)
	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(50),50)


	*--> CODIGO NCM
	=W_DEFPROC("GRUPO.SPR")
	Ltmp = GRGetFieldValue( &PrmAlsTmpOrca .codigo, ;
	                                  "COD_NCM")
	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(10),10)

	*---------------------------------------------*

	=fPuts(PrmNroIDFile,LSLinha,LEN(LSLinha))



RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3G9           ORGeraSrvcBTS VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   37  º
*       º Variable:            ORGeraSrvcBTS                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      197                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3g9     &&  ORGeraSrvcBTS VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORGeraSrvcBTS
PARAMETERS  PrmEmp,;
			PrmOrcamento,;
			PrmOrdem,;
			PrmFile,;
			PrmNroIDFile



	PRIVATE PrmAlsTmpOrca , 	LAliasOR





	PRIVATE Ltmp




	IF !ORLerRegistro(PrmEmp,PrmOrcamento)
	      wait "Nao foi localizado OSI :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "OSI: "+STR(PrmOrcamento,6)
    	  return(.F.)
	ENDIF




	=W_DEFPROC("ORCATMP.SPR")
	IF !OTLerRegistro(PrmEmp,PrmOrcamento,PrmOrdem)
	      wait "Nao foi localizado OSI :"+;
		      "FILIAL: "+STR(PrmEMPRESA,3)+;
		      "OSI: "+STR(PrmOrcamento,6)+;
		      "ITEM: "+STR(PrmOrdem,2)
    	  return(.F.)
	ENDIF


	=W_DEFPROC("ORCATMP.SPR")
	PrmAlsTmpOrca = OTGetAlias()



	=W_DEFPROC("ORCAMENT.SPR")
	LAliasOR=ORGetAlias()





	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinha

	*-------------------------------------------------------*


	*-------------------------------------------------------*

	LSLinha = 'REG03'

	*--> CODIGO IDENTIFCADOR DA BTS
	LSLinha = LSLinha+'027399'

	*--> CODIGO IDENTIFCADOR DA ORDEM SERVICO BTS
	LSLinha = LSLinha+CHRTRAN(STR(PrmOrcamento,6)," ","0") +SPACE(24)


	*--> CODIGO DO PRODUTO NO BTS
	LSLinha = LSLinha+ LEFT( &PrmAlsTmpOrca .codigo+SPACE(50),50)

	*--> DESCRICAO DO PRODUTO NO BTS
	LSLinha = LSLinha+ LEFT( &PrmAlsTmpOrca .descricao+SPACE(100),100)



	*--> DATA EXECUCAO
    set centu off
	Ltmp    = CHRTRAN(DTOC( &LAliasOR .dt_fat),".","")
    set centu on

	LSLinha = LSLinha+Ltmp





	*--> TEMPO EXECUCAO

	**** Ltmp    = CHRTRAN( &PrmAlsTmpOrca .Tempo_exec, ":","")

	Ltmp = UPtempopas( &LAliasOR .dt_res , ;
	             &LAliasOR .dt_fat , ;
	             &LAliasOR .hora_res ,;
	             &LAliasOR .hora_fat )


    Ltmp=UPFrmtaTempo(Ltmp)

	LSLinha = LSLinha+ LEFT( LEFT(Ltmp,2)+subs(ltmp,4,2)+SPACE(6),6)

	*--> NOME EXECUTOR
	=W_DEFPROC("USUARIO.SPR")
	Ltmp    = USGetNomeUsr( &PrmAlsTmpOrca .executante)


	LSLinha = LSLinha+ LEFT( Ltmp+SPACE(100),100)

*------------------------------->

	*--> VLR SERVICO
	Ltmp    = STR( &PrmAlsTmpOrca .vlrvenda,15,2)
	Ltmp    = CHRTRAN(Ltmp," ","0")
	Ltmp    = CHRTRAN(Ltmp,".","")
	Ltmp    = CHRTRAN(Ltmp,",","")
	LSLinha = LSLinha+Ltmp


	*--> STATUS SERVICO
	Ltmp    = "F"
	LSLinha = LSLinha+Ltmp


	*---------------------------------------------*

	=fPuts(PrmNroIDFile,LSLinha,LEN(LSLinha))



RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3GJ           ORGerBTS2 VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   38  º
*       º Variable:            ORGerBTS2                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      198                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3gj     &&  ORGerBTS2 VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORGerBTS2
PARAMETER PrmEmpresa,PrmOSI




	PRIVATE LSalias
	
	PRIVATE PrmAlsOrcament
	PRIVATE PrmAlsTmpOrca
	
	LSalias = ALIAS()


	=W_DEFPROC("ORCATMP.SPR")
	PrmAlsOrcament = ORGetAlias()

	LSalias = ALIAS()

	=W_DEFPROC("ORCATMP.SPR")
	PrmAlsTmpOrca = OTGetAlias()



	SET STEP ON

	*---------------------------------------------------*

	SELE &PrmAlsOrcament
	SET ORDER TO TAG GERAL
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmOSI,6)
	SET NEAR OFF

   	if !FOUND()
      wait 'OSI nao localizada- <ENTER> ' window
  	  SELECT &LSalias
      return
   	endif

	IF LEFT( &PrmAlsOrcament .SITUACAO,1) <> "O"
      wait 'OSI nao faturada- <ENTER> ' window
 * 	  SELECT &LSalias
 *     return
   	endif


	IF &PrmAlsOrcament .E_OSI_BTS = 1    && OSI BTS FATURADA
      wait 'OSI nao definida como BTS- <ENTER> ' window
  	  SELECT &LSalias
      return
   	endif


	*-------------------------------------------------------*

   	PRIVATE LSfileTXT,LNroIDfileTXT

   	LSfileTXT	= "\SCGC\EXPORTA\OS"+STR(PrmOSI,6)+".TXT"
   	LSfileTXT   = CHRTRAN(LSfileTXT," ","0")

  	LNroIDfileTXT 		=fcreate(LSfileTXT)
   	if LNroIDfileTXT<0
      =fclose(LNroIDfileTXT)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileTXT+'- <ENTER> ' window
      return
   	endif


	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

    LNimpressao = 1
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*



	SELE &PrmAlsOrcament

	=UPtermo()
	LRegOrcamento = RECNO()


	=ORGeraBTS(;
			&PrmAlsOrcament .Empresa,;
			&PrmAlsOrcament .Orcamento,;
			LSfileTXT,;
			LNroIDfileTXT)


    *-----------------------------------*
    *---> GERAR REGISTROS TIPO 2 PRODUTOS
    *-----------------------------------*
	
	SELE &PrmAlsTmpOrca
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR( &PrmAlsOrcament .Orcamento,6)
	SET NEAR OFF
	
			
	DO WHILE !EOF() ;
		AND	LFsegue = .t. ;
       	AND PrmEmpresa =  &PrmAlsTmpOrca .empresa;
        AND &PrmAlsOrcament .Orcamento = &PrmAlsTmpOrca .orcamento
	
		LRegItemOrcamento = RECNO()
		IF !(LEFT( &PrmAlsTmpOrca .SITUACAO,1) $ "yY")
		

				IF &PrmAlsTmpOrca .tp_mercad <> 7
					=ORGeraProdBTS(;
						&PrmAlsTmpOrca .Empresa,;
						&PrmAlsTmpOrca .Orcamento,;
						&PrmAlsTmpOrca .Ordem,;
						LSfileTXT,;
						LNroIDfileTXT)

				ENDIF

		ENDIF
		SELE &PrmAlsTmpOrca
		SET ORDER TO TAG orcamento
		GO LRegItemOrcamento
		SKIP
	ENDDO
		

    *-----------------------------------*
    *---> GERAR REGISTROS TIPO 3 SERVICOS
    *-----------------------------------*

	SELE &PrmAlsTmpOrca
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR( &PrmAlsOrcament .Orcamento,6)
	SET NEAR OFF
	
			
	DO WHILE !EOF() ;
		AND	LFsegue = .t. ;
       	AND PrmEmpresa =  &PrmAlsTmpOrca .empresa;
        AND &PrmAlsOrcament .Orcamento = &PrmAlsTmpOrca .orcamento
	
		LRegItemOrcamento = RECNO()
		IF !(LEFT( &PrmAlsTmpOrca .SITUACAO,1) $ "yY")
		

				IF &PrmAlsTmpOrca .tp_mercad = 7
					=ORGeraSrvcBTS(;
						&PrmAlsTmpOrca .Empresa,;
						&PrmAlsTmpOrca .Orcamento,;
						&PrmAlsTmpOrca .Ordem,;
						LSfileTXT,;
						LNroIDfileTXT)
				ENDIF

		ENDIF
		SELE &PrmAlsTmpOrca
		SET ORDER TO TAG orcamento
		GO LRegItemOrcamento
		SKIP
	ENDDO
		
    *-----------------------------------*


	SELE &PrmAlsOrcament
	SET ORDER TO TAG DATA_FAT
	GO LRegOrcamento
	SKIP


	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileTXT)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3GK           OREditaBTS VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMENT,     Record Number:   39  º
*       º Variable:            OREditaBTS                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      199                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3gk     &&  OREditaBTS VALID
#REGION 7
RETURN

FUNCTION OREditaBTS
	PARAMETERS  LNemp,LNorca
	*---------------------------------------------------------*
	*	Objetivo : Chamar Rotina para Informar Dados do Cliente
	*---------------------------------------------------------*
	SELE orcament
	LNregistro	=	RECNO()

	DO SVD0200A.SPR with LNemp, LNorca

	GO LNregistro
	CLEAR TYPEAHEAD

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3H1           ORimp_osi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:    2  º
*       º Variable:            ORimp_osi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      200                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3h1     &&  ORimp_osi VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------------------------------------------*

PROCEDURE ORloc_orc		&& sist. localizacao de orcamentos
PARAMETERS LSsit, LScompl, LSorigem

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Visualisar Orcamentos que atendam aos parametros
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		PARAMETERS LSsit, LScompl, LSorigem
	*			LSsit   => indica as situacoes que devem ser relacionadas
	*			LScompl => indica os complementos de situacoes solicitados
	*		 	LSorigem=> indica qual operacao solicitou ex: RESERVA,
	*						LIBERA
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*

	PRIVATE 	LFdestrava

	ON KEY LABEL ESCAPE
	CLEAR TYPEAHEAD
    SELECT orcament

	IF TYPE("LScompl") <> "C"
		LScompl = ""
	ENDIF

	IF TYPE("LSorigem") <> "C"
		LSorigem = ""
	ENDIF

	IF TYPE("ver") <> "N"
		m.ver = 2   && ver todos
	ENDIF





	LNreg = RECNO()     && permite reposicionar registro

	LNemp = orcament.empresa
	LNorca= orcament.orcamento
	SET ORDER TO tag situacao
	SET NEAR ON
	SEEK STR(wp_empresa,3)+LEFT(LSsit,1)    &&posic. na 1a sit.strig
	SET NEAR OFF
	IF EOF() OR wp_empresa <> orcament.empresa OR ;
			!(LEFT(orcament.situacao,1) $ LSsit)
		wp_msg = "Nao existem orcamentos para esta opcao. <ENTER>"
		=UPbeeps(.F.,wp_msg)
		UNLOCK
	    m.sOldError=ON('error')
		ON ERROR *
		GO LNreg
		ON ERROR &sOldError
		KEYBOARD CHR(27)		
		=INKEY(0)
 		RETURN
	ENDIF
************************>
	wl_arqtmp = ""
	LNtmp     = 65		&& TABELA ASCII A = 65
	IF !UPabretmp("orc")
		wp_flgfecha = .t.
	ENDIF
	IF wp_flgfecha
		KEYBOARD "{ESCAPE}"
		RETURN
	ENDIF
	SET SAFET OFF
	LStmp = "&wp_dirtmp"+"&wl_arqtmp"
*****************************>
	SELE clienc
	SET ORDER TO TAG emporca

	SELE orcament
	LFdestrava = .f.
	IF LSorigem = "LIBERAR"	&& devem ser mostrados reg.protegidos
		LFdestrava = .t.
	ENDIF
	SET RELATION TO STR(EMPRESA,3)+STR(ORCAMENTO,6) INTO clienc


	
	DO CASE

		CASE ("A" $ LSsit OR "F" $ LSsit OR "G" $ LSsit OR "I" $ LSsit)  ;
		 	  AND (m.ver <> 1 OR lMaster)

				&& RESERVA E CANC. DE RESERVA P/ VER ORCAMENTO COM
				&& RESERVAS PELO ESTOQUE

			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome,veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
	   	    FOR ;
				(  !orcament.protegido ;
					OR lMaster;
					OR LFdestrava ;
					OR ;
				     (     orcament.protegido ;
				       AND orcament.operador = wl_vendedor;
				     );
				) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
			    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl) ;
	 			WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX

		CASE ("A" $ LSsit OR "F" $ LSsit OR "G" $ LSsit OR "I" $ LSsit)  ;
		 	  AND (m.ver = 1 OR lMaster)

				&& RESERVA E CANC. DE RESERVA P/ VER ORCAMENTO COM
				&& RESERVAS PELO ESTOQUE
			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome,veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
		   	    FOR ;
   		        (orcament.operador = wl_vendedor) AND ;
	   		    LEFT(orcament.situacao,1) $ LSsit     AND ;
	   	    	(EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl) ;
	    		WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX

		CASE WPprgativo = "SCGC201A" OR m.ver <> 1 && ver alem proprios
	
			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome, veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
	   	    FOR ;
				(!orcament.protegido OR lMaster OR LFdestrava OR ;
				(orcament.protegido AND orcament.operador = wl_vendedor)) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
		   	    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl);
	    		WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX
		OTHERWISE
			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome,veiculo,placa, ;
					dt_fat,nota,dtregis,hregis,usrregis ;
   	        FOR ;
				(lMaster OR orcament.operador = wl_vendedor) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
		   	    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl) ;
    			WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX
	ENDCASE
	SET RELATION TO

    SELE 0
    USE &LStmp EXCLU ALIAS ORCABROW
	INDEX ON NOME TAG nome_todos ADDITIVE

*-----------------------> FIM PREPARACAO ARQ. TEMPORARIO	
	IF EOF() AND BOF()
		wp_msg = "Nao existem orcamentos para esta opcao. <ENTER>"
		=UPbeeps(.F.,wp_msg)
		KEYBOARD CHR(27)		
		=INKEY(0)
	    SELECT orcament
		GO LNreg
	ELSE
		Lpar1 = ""
		Lpar2 = ""
		SET ORDER TO TAG nome_todos
		GO TOP

		DO ORLoc_Browse WITH .T., Lpar1, Lpar2, "B"


	    SELECT orcament
		SET ORDER TO tag orcamento
		SET RELATION TO
*------------------------------------- posiciona orcamento
		SEEK STR(orcabrow.empresa,3)+STR(orcabrow.orcamento,6)
*------------------------------------ encerra secao orcabrow
		IF !FOUND() OR LASTKEY() = 27
			KEYBOARD CHR(27)		
			GO LNreg
		ENDIF
	ENDIF
	SELECT orcabrow
	USE
	SELECT orcament
    SCATTER MEMVAR MEMO
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3HD           ORLoc_Browse VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:    3  º
*       º Variable:            ORLoc_Browse                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      201                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3hd     &&  ORLoc_Browse VALID
#REGION 8
RETURN
PROCEDURE ORLoc_Browse
   PARAMETERS wl_indice, wl_for1, wl_key, wl_frmato
	*********************************************************************			
	* wl_indice   => .t. => Nao selecionar indice (assumir corrente)
	*				 .f. => Selecionar indice em PSQCDX.SPR
	* wl_for	  => Condicao de listagem no browse
	*
	* wl_frmato	  => Permite escolha do formato armazenado no arq
	*			 FORMATO.DBF
	*
	*
	*********************************************************************			

	=W_DEFPROC("rotinas.spr")

				
	PUSH KEY CLEAR
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()

	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
						_MED_FINDA

	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	HIDE MENU _MSYSMENU

	DEFINE WINDOW wzlocate ;
		FROM 1, 1 ;
		TO 12,79 ;
		TITLE "REGISTROS" ;
		FLOAT ;
        GROW;
		CLOSE ;
		SHADOW ;
		MINIMIZE ;
        ZOOM;
		SYSTEM ;
		COLOR SCHEME 10


    wl_for 		= wl_for1
    VLlocctag 	= tag()


    IF !wl_indice
    	DO psqcdx.spr
		IF LASTKEY()  =  27
		    ON KEY LABEL ENTER
    		SET FORMAT TO
    		set order to  tag &VLlocctag
			RELEASE WINDOW wzlocate
			POP KEY 			&& reabilita teclas de atalho def. anteriormente
			POP MENU _MSYSMENU
			SET SYSMENU OFF
			RETURN
		ENDIF
    ENDIF


    ON KEY LABEL ENTER KEYBOARD CHR(23)
    IF !EMPTY(wl_for)
       wl_for = " FOR "+wl_for
	   IF !EOF()
		   SKIP
	   ENDIF
	   SKIP -1	
    ELSE
       wl_for = " "
    ENDIF


    IF !EMPTY(wl_key)
	   wl_key1 = "'"+&wl_key+"','"+&wl_key+"'"
       wl_key2 = " KEY "+wl_key1
    ELSE
       wl_key2 = " "
    ENDIF

	*----------------------------------------------------*
	*	 SUB. ROTINAS
	*----------------------------------------------------*
	
	ON KEY LABEL F12    DO OBJ_CALC.SPR


    Lusrtmp	= nUsr
    ON KEY LABEL L 		DO LORCABRO.SPR
    ON KEY LABEL CTRL-L DO LORCABRO.SPR
	ON ERROR WAIT WINDOW "O AUXILIAR DE BUSCA NAO ESTA DISPONIVEL."

********************  FORMATACAO *******************

	SET FIELDS TO
	LSaliasant = ALIAS()
	LStagtmp   = TAG()

	IF TYPE("wl_frmato") $ "UL" OR EMPTY(wl_frmato)
		SELE indice
		SET ORDER TO TAG dbf_tag
		SEEK "ORCABROW"+LStagtmp
		IF FOUND()
			LSvaria = indice.variacao
		ELSE
			LSvaria = 'A'
		ENDIF	
	ELSE
		LSvaria = wl_frmato     && FORMATO SOLICITADO NA CHAMDA DA ROTINA
	ENDIF
**	
    SELE formato
    SET ORDER TO TAG formato
	SEEK "ORCABROW"+LSvaria
	IF FOUND()
		LFforma = RTRIM(formato.mascara)  && POSSUI FORMATO DEFINIDO
	ELSE
		LFforma = ""                      && NAO POSSUI FORMATO DEFINIDO
    ENDIF		
	SELE &LSaliasant
****************************************************


    SET FORMAT TO
*	KEYBOARD "L"
	DO WHILE .T.
	*    BROWSE &LFforma WINDOW wzlocate &wl_for REST &wl_key2 ;
  	*			NOAPPEND NODELETE NOEDIT VALID :F btn_val('ATUALIZA') ;
	*		&wp_timeout COLOR SCHEME 10
    *
	    BROWSE &LFforma WINDOW wzlocate &wl_for REST &wl_key2 ;
  				NOAPPEND NODELETE NOEDIT   ;
			&wp_timeout COLOR SCHEME 10
		IF READKEY() <> 20
			EXIT
		ENDIF
		=W_DEFPROC("rotinas.spr")
		DO UPprotege	&& ATIVA PROTECAO DE TELA
	ENDDO
	SET COLOR OF SCHEME 10 TO ,,,,,,W+/B
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	HIDE MENU _MSYSMENU

	ON ERROR DO UPerrosys

    ON KEY LABEL CTRL-L
    ON KEY LABEL L
    ON KEY LABEL ENTER
    SET FORMAT TO
	SET FIELDS TO
    set order to  tag &VLlocctag
	RELEASE WINDOW wzlocate
	POP KEY 			&& reabilita teclas de atalho def. anteriormente
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3HO           ORadOrcament VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:    4  º
*       º Variable:            ORadOrcament                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      202                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ho     &&  ORadOrcament VALID
#REGION 8
RETURN

FUNCTION ORadOrcament
PARAMETERS LNemp,LNorcamento
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Cria um  Registro de Orcamento padrao
	*          para agilizar abertura de uma venda
	*------------------------------------------------------------*
	* COMENTARIO..: Varia Vendas sao Negociadas a Principio com
	*           caracteristas Padronizadas e so no Decorrer da Nego-
	*           ciacao Sao Informadoas a Caracteristicas Especificas
	*           da Operacao
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNorcamento....: Numero Osi Aberta
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*
	*	=ORadOrcament((wp_empresa),m.orcamento)
	*
	*
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFempresa, LForcament, LFclienc
	LSalias = ALIAS()

	LFempresa  = NetArq("empresa")
	LForcament = NetArq("orcament")
	LFclienc   = NetArq("clienc")
	IF (LFempresa+LForcament+LFclienc) > 100000 && HOUVE FALHA DE ABERTURA
		DO ORFchadOrcament
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		DO ORFchadOrcament
		RETURN(.F.)
	ENDIF
	SELE orcament
	SCATTER MEMVAR BLANK
	
  	m.data = wp_dtoper	
	m.hora = TIME()
	m.natu_oper = 1           	&& VENDA
	m.motivo	= 1           	&& NORMAL
	m.situacao 	= "A "			&& ABERTO
	m.empresa  	= LNemp			&& EMPRESA CHAMADORA DA ROTINA
	m.tab_cst	= empresa.tab_cst   && indica tabela CST

*----> CLIENTE PADRAO
	m.cliente   = 0
	m.nome		=""
	m.tp_pessoa = 1
	m.natu_cli	= 0
	m.estado	= empresa.estado
	m.inscricao = 'ISENTO'
	m.tp_inscr	= 2
	m.nome_inscr ="ISENTO"
	m.revendedor= "N"
    m.endereco  = " "
	m.bairro	= " "
	m.cidade	= empresa.cidade
	m.cep       = " "
	m.fone  	= " "
	m.veiculo	= " "
	m.placa     = " "
	m.hodom		= 0
*----> OUTROS
	m.nota 		= 0
	m.dt_fat	= {}
	m.tp_parcela= 1
	m.moeda 	= 1
	
	m.prazo 	= "000/000/000/000/000/"
    m.prazomedio= 0
	m.taxa      = 0
	m.vias_osi = 1
	m.vlr_ent  = 0
	m.vlrfrete = 0
	m.vlrseguro = 0
	m.lim_libera = 0
	m.lim_prazo  = 0
	m.lmt_parcel  = "N"
	m.usr_libera = 0
	m.protegido  = .f.
	m.operador   = nUsr
	m.negociacao = 1
	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	LNorcamento = ORnro_OSI((LNemp),"INCREMENTAR SEQUENCIA",0)
	IF LNorcamento = 0
		DO ORFchadOrcament
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	IF "BALCAO" $ LSprograma
		m.juromes   = 0     &&empresa.juromes
	ELSE
		m.juromes   = 0     && faturista opera com juro = 0
	ENDIF
	*------------------------------------------------------------*
	DO WHILE .T.
		DO OBJ_VDOR.SPR WITH LNemp,LNorcamento,m.operador
		IF LASTKEY() = 27 OR m.operador <> 0
			EXIT
		ENDIF
	ENDDO
	SELE orcament
	IF LASTKEY() = 27
		DO ORFchadOrcament
		RETURN(.F.)
	ENDIF
	*---------------------------------------------------------*
	SELECT orcament
	*---------------------------------------------------------*
	* Devido a posibilidade de 2 vendedores alterarem o numeros
	* sugeridos para um numero inexistente porem igual nos dois
	* casos, o sistema faz nova checagem no momento da gravacao
	*----------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	SET ORDER TO TAG orcamento
	IF FOUND()
		WAIT WINDOW  "Numero de Orcamento ja Cadastrado.  <ENTER>"
		DO ORFchadOrcament
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	m.orcamento = LNorcamento	
	m.tipo		= "???"
	=edithand('SAVE')
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	IF !FOUND()
		=edithand('SAVE')
	ELSE
		=edithand('REGRAVA')
	ENDIF
	SELE orcament
	IF !ORnewclas_oper((LNemp),(LNorcamento))
		   	wp_msg = "Atencao!!! "+CHR(13)+;
	   			"     Nao Foi Possivel Classificar a Operacao."
		=UPbeeps(.f.,wp_msg)
	ENDIF
	*------------------------------------------------------------*
	DO ORFchadOrcament
RETURN(.T.)


PROCEDURE ORFchadOrcament
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("orcament" ,LForcament)
	=UP_fecha("clienc" ,LFclienc)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3I0           ORnro_OSI VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:    5  º
*       º Variable:            ORnro_OSI                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      203                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3i0     &&  ORnro_OSI VALID
#REGION 8
RETURN

FUNCTION ORnro_OSI
PARAMETERS LNemp,LSprocesso,LNnumero
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar um numero disponivel para OSI
	*------------------------------------------------------------*
	* COMENTARIO..: Para Controlar a numeracao de O.S.I e utiliza-
	*			do um artificio envolvendo os campos EMPRESA,
	*			ORCAMENTO e NOTA para criar um registro de CONTROLE
	*			EX:
	*				 EMPRESA   = 0 (ZERO) - REGISTRO DE CONTROLE
	*				 ORCAMENTO = 001  	  - Referente a Empresa 001
	*					    ou = 002      -   //      //  //    002
	*				 NOTA      = 002651   - Ultimo Numero de ORCAMENTO
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LSprocesso.....: Indica qual o processo que se deseja
	*						realizar, podendo ser:
	*			 1 - "ALTERAR SEQUENCIA" = Alterar o NUMERO conforme
	*					o parametro LNnumero
	*			 2 - "INCREMENTAR SEQUENCIA" = Usada para controlar
	*					a insercao de OSI
	*			 3 - "INFORMAR SEQUENCIA"
	*
	*		LNnumero.......: Para processo de ALTERAR SEQUENCIA
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*				- LNnro = Numero disponivel para a O.S.I
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*
	*	m.orcamento = ORnro_OSI((wp_empresa),"INCREMENTAR SEQUENCIA",0)
	*
	*	=ORnro_OSI((wp_empresa),"ALTERAR SEQUENCIA",(m.orcamento))
	*
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LNnro
	PRIVATE LForcament
	PRIVATE m.empresa, m.orcamento,m.nota,m.situacao

	LSalias = ALIAS()

	LForcament = NetArq("orcament")
	IF (LForcament) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("orcament" ,LForcament)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*------------------------------------------------------------*
	LNnro 	= 0
	*------------------------------------------------------------*
	SELECT orcament
	SET ORDER TO TAG geral
	SEEK STR(0,3)+STR(LNemp,6)
	IF !FOUND()
		SET NEAR ON
		SEEK STR(LNemp+1,3)
		SET NEAR OFF
		DO WHILE !BOF() AND orcament.empresa > LNemp
			SKIP -1
		ENDDO
		IF BOF() OR orcament.empresa <> LNemp
			m.nota = 1      && NAO EXISTE OSI LANCADAS PARA EMPRESA

			DO OBJ_MENS.SPR WITH ;
				"  Nao foi Possivel Localizar o Controle"+;
			  	" de Numeracao de ORCAMENTOS..=> "+chr(13)+" <<<<<        Sera ATRIBUIDO Nro 1         >>>>"+chr(13)+chr(13)+;
			  	", Para Alterar Edit o Campo Ultimo Orcamento em  Cadastro de Empresas."

			*------------------------------------------------------------*
			*DO OBJ_MENS.SPR WITH ;
			*	"  Nao foi Possivel Localizar o Controle"+;
			*  	" de Numeracao de ORCAMENTOS.."
			*=UP_fecha("orcament" ,LForcament)
			*IF !EMPTY(LSalias) AND USED(LSalias)
			*	SELECT &LSalias
			*ENDIF
			*RETURN(LNnro)
			*------------------------------------------------------------*
		ELSE
			m.nota = orcament.orcamento
		ENDIF
		m.empresa	= 	0
		m.orcamento	=	LNemp
		=edithand('SAVE')
	ENDIF
	*------------------------------------------------------------*
	DO CASE
		CASE LSprocesso = "ALTERAR SEQUENCIA"
			=REGLOCK(.T.)
			REPLACE orcament.nota WITH LNnumero
			LNnro 	= orcament.nota
		CASE LSprocesso = "INCREMENTAR SEQUENCIA"
			=REGLOCK(.T.)
			IF orcament.nota > 999999 && O CAMPO NOTA POSSUI 7 DIGT
									  &&ESSE TESTE GARANTE O REINICIO
									  && POIS O CAMPO ORCAMENTO TEM 6 DIGT
				REPLACE orcament.nota WITH 1
			ELSE
				REPLACE orcament.nota WITH orcament.nota + 1
			ENDIF
			LNnro 	= orcament.nota
		CASE LSprocesso = "INFORMAR SEQUENCIA"
			LNnro 	= orcament.nota
	ENDCASE
	UNLOCK
	*------------------------------------------------------------*
	=UP_fecha("orcament" ,LForcament)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNnro)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3IA           ORValEntClie VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:    6  º
*       º Variable:            ORValEntClie                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      204                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ia     &&  ORValEntClie VALID
#REGION 8
RETURN

FUNCTION ORValEntClie
PARAMETERS LNemp,LNkey,LNcliente,LSch_opera,LStipo,;
			m.natu_cli,m.tp_pessoa, m.cliente, m.nome, ;
			m.fone, m.estado, m.inscricao,;
			m.tp_inscr, m.revendedor, m.endereco,;
			m.bairro, m.cidade, m.cep, m.regiao,;
			m.banco,m.nome_inscr,m.nome_natu
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Localizar e Validar a entrada de um cliente
	*			no orcamento
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite fazer verificacoes proprias
	*			do campo de informacao do CGC/CPF do cliente para
	*			orcamento
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LNkey..........: Codigo da Tecla de Saida do Campo
	*		LNcliente......: Codigo do Cliente
	*		LSch_opera.....: Operacao definida para o orcamento
	*		LStipo.........: Tipo da classificacao da operacao
	*		m.inscricao....: Permite a distinca
		*    <> Demais parametro sao variaveis de memoria para retor-
	*	   nar a rotina
	*------------------------------------------------------------*
	*  RETORNO.....:- REGISTRO DO CLIENTE  POSICIONADO para
	*					ser tratado na rotina
	*				- .F. Para codigo nao localizado ou nao aceito
	*				- .T. Para codigo Localizado
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	LSalias = ALIAS()

	IF !ORValid_Clie((wp_empresa),LNkey,m.cliente,(m.ch_opera),(m.tipo),;
			m.inscricao)
		RETURN(.F.)
	ENDIF
	m.cgccliente = str(m.cliente,14)
	SHOW GET m.cgccliente

	*-----------------------------------------------------------*
	*	PESQUISAR DADOS EM POSSIVEL VENDA A VISTA	GRAVADOS    *
	* NA NOTA FISCAL											*
	*-----------------------------------------------------------*
	IF m.cliente > 0 AND !FOUND("CLIENTES")
		SELE nota
		SET ORDER TO TAG favorecido
		SET NEAR ON
		SEEK STR(m.cliente + 1,14)		&& POSICIONAR UM A FRENTE
		SET NEAR OFF
		SKIP -1
	ENDIF	
	*---------------------------------------------------------*
	*	Atribuir valores defaut caso nao encontre cliente no
	* CADASTRO E NEM EM NOTAS
	*-----------------------------------------------------------*
	IF m.cliente = 0 OR (!FOUND("CLIENTES")  ;
						  AND nota.favorecido <> m.cliente)
	   IF  EMPTY(m.nome)
			m.natu_cli  = 0		&& varejo
			m.tp_pessoa = 1
			m.cidade	= empresa.cidade
			m.estado	= empresa.estado
			m.inscricao = 'ISENTO'
			m.tp_inscr	= 2
			m.nome_inscr ="OUTROS"
			m.revendedor= "N"
			m.fone 		= "(   )-   -    "
		ENDIF
		SHOW GET m.estado
		SHOW GET m.cidade
		SHOW GET m.inscricao
		SHOW GET m.tp_inscr
		SHOW GET m.nome_inscr
		SHOW GET m.revendedor
		SHOW GET m.tp_pessoa
		SHOW GET m.fone
		m.cgccliente = str(m.cliente,14)
		SHOW GET m.cgccliente
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN .T.
	ENDIF
	DO CASE
		CASE FOUND("CLIENTES")
			m.natu_cli = clientes.natureza
			SCATTER MEMVAR FIELDS ;
				clientes.tp_pessoa, clientes.cliente, clientes.nome, ;
				clientes.fone, clientes.estado, clientes.inscricao,;
				clientes.tp_inscr, clientes.revendedor, clientes.endereco,;
				clientes.bairro, clientes.cidade, clientes.cep, ;
				clientes.regiao  MEMO
			*---------------------------------------------------------*
			*	Determinar o Banco de Cobranca Conforme Cidade
			*---------------------------------------------------------*
			m.banco  = UPdefbanco(clientes.cbcidade, clientes.cbestado)	
			m.regiao = clientes.regiao	
		CASE nota.favorecido = m.cliente
			SELE nota
			m.cliente 	= nota.favorecido
			m.estado	= nota.uf
			SCATTER MEMVAR FIELDS ;
				nota.tp_pessoa, nota.nome, ;
				nota.fone, nota.inscricao,;
				nota.tp_inscr, nota.revendedor, nota.endereco,;
				nota.bairro, nota.cidade, nota.cep, ;
				nota.regiao  MEMO
	ENDCASE

	IF m.revendedor <> "S"
		m.revendedor = "N"
	ENDIF   		

	SELE tab1
	SEEK 'INS'+str(m.tp_inscr,1)
	m.nome_inscr = tab001.descricao

	SEEK 'NTZ'+CHRTRAN(STR(m.natu_cli,1)," ","0")
	m.nome_natu = tab001.descricao

	SELECT &LSalias
	SHOW GET m.cliente
	SHOW GET m.nome
	SHOW GET m.endereco
	SHOW GET m.bairro
	SHOW GET m.cidade
	SHOW GET m.estado
	SHOW GET m.cep
	SHOW GET m.fone
	SHOW GET m.inscricao
	SHOW GET m.tp_inscr
	SHOW GET m.nome_inscr
	SHOW GET m.natu_cli
	SHOW GET m.tp_pessoa
	m.cgccliente = str(m.cliente,14)
	SHOW GET m.cgccliente
	SHOW GET m.nome_natu
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN .T.

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	
	
	

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3IM           ORValid_Clie VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:    7  º
*       º Variable:            ORValid_Clie                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      205                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3im     &&  ORValid_Clie VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORValid_Clie
PARAMETERS LNemp,LNkey,LNcliente,LSch_opera,LStipo,LSinscricao
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Localizar e Validar um cliente para orcamento
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite localizar um cliente ou
	*			filial e validar sua atribuicao ao orcamento
	*			de acordo com as caracteristicas da operacao
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LNkey..........: Codigo da Tecla de Saida do Campo
	*		LNcliente......: Codigo do Cliente
	*		LSch_opera.....: Operacao definida para o orcamento
	*		LStipo.........: Tipo da classificacao da operacao
	*		LSinscricao....: Campo para diferenciar clientes com
	*						duas inscricoes (Ocorre com fazendas)
	*						dois cadastros com mesmo CPF e inscricao
	*						e enderecos diferentes
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:- REGISTRO DO CLIENTE  POSICIONADO para
	*					ser tratado na rotina
	*				- .F. Para codigo nao localizado ou nao aceito
	*				- .T. Para codigo Localizado
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFretorno
	PRIVATE LSmsg
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	IF !USED("CLIENTES")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	SELECT clientes
	SET ORDER TO TAG cliente
	IF LNkey = 9
	   	ON KEY LABEL ESCAPE
	   	DO loc_dlog WITH .T.
	   	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	   	IF LASTKEY() <> 27
		   	LNcliente	= 	clientes.cliente
			LSinscricao	=	clientes.inscricao
		ENDIF	
	ENDIF
	*-----------------------------------------------------------*
   	IF LASTKEY() <> 27
		SET NEAR ON
		SEEK LNcliente
		SET NEAR OFF
	    IF FOUND() AND !EMPTY(LSinscricao)
			DO WHILE !EOF() AND LNcliente = clientes.cliente
				IF LSinscricao = clientes.inscricao
					EXIT
				ENDIF
			    SKIP	&& VERIFICA SE E DUPLICADO E CHECA A INSCRICAO
			ENDDO
			IF EOF() OR LNcliente <> clientes.cliente OR ;
		  			LSinscricao <> clientes.inscricao
					SKIP -1			  && PEGAR DADOS DO REG. LOCALIZADP
			ENDIF				  && PRIMEIRO
		ENDIF
	ENDIF
	*-----------------------------------------------------------*
	*	Critica a tecla
	*-----------------------------------------------------------*
	IF LASTKEY() = 27
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*-----------------------------------------------------------*
	*	Critica a validade CPF/CGC informado
	*-----------------------------------------------------------*
	IF  Calc_cgc(LNcliente) = "3"	&& INVALIDO
		=UPbeeps(.F.,"Numero de Doc. Invalido. <ENTER>")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	*-----------------------------------------------------------*
	*	Critica a localizacao do registro
	*-----------------------------------------------------------*
	IF (LNcliente = 0 OR !FOUND() )
		IF (LNcliente <> 0 AND !FOUND() )
			LSmsg = "Cliente nao cadastrado. Informe "+;
						"dados ou Solicite cadastro. <ENTER>"
			=UPbeeps(.F.,LSmsg)
		ENDIF
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF
	*----------------------------------------------------------*
	*   Validacao do Registro de Cliente X Operacao Orcamento
	*----------------------------------------------------------*
	*   Nao aceitar operacao de venda para outra filial
	*-----------------------------------------------------------------*
	SELE EMPRESA
	SET ORDER TO TAG EMPRESA
	SEEK LNemp

	*---------------------------------------------------------------*
	*	Retorno a area anterior
	*---------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	*---------------------------------------------------------------*
	IF LSch_opera = "1"	&& CHECAGEM PARA NAO VENDER PARA FILIAL
		IF LNcliente <> empresa.cgc	   && VER SE NAO E UMA FILIAL
			IF LEFT(str(LNcliente,14),10) = LEFT(str(empresa.cgc,14),10)
				LSmsg = "Operacao nao Aceita Filial. <ENTER>"
				=UPbeeps(.F.,LSmsg)
				RETURN(.F.)
			ENDIF
		ENDIF
	ENDIF
	*-----------------------------------------------------------------*
	*  Nao aceitar operacao de transferencia que nao seja para filial
	*-----------------------------------------------------------------*
	IF LSch_opera = "2"	&& CHECAGEM PARA NAO TRANSF PARA CLIENTES
		LSempcgc =  str(empresa.cgc,14)
		IF 	LNcliente = empresa.cgc	;
			OR LEFT(str(LNcliente,14),10) <> LEFT(str(empresa.cgc,14),10)
				LSmsg = "Operacao Exige Filial. <ENTER>"
				=UPbeeps(.F.,LSmsg)
				RETURN(.F.)
		ENDIF
	ENDIF
	*----------------------------------------------------------*
RETURN(.T.)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3IW           ORAtlz_Clie VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:    8  º
*       º Variable:            ORAtlz_Clie                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      206                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3iw     &&  ORAtlz_Clie VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORAtlz_Clie
PARAMETERS LNemp,LNorca
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Verificar se Houve Atualiza‡Æo do Cadastro
	* 			do Cliente Relacionado ao Orcamento e Providenciar
	*           a transferencia de Valores e Reclassifica‡Æo da
	*           operacao
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao e ativada antes de efetivar o fatura
	*			mento ou quando o programa de cadastro ‚ acessado
	*			pelo programa de orcamento
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LNorca....: Codigo da Tecla de Saida do Campo
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFretorno
	PRIVATE LSmsg
	PRIVATE LFclientes, LFclienc,LForcament
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	LFclienc	= NetArq("clienc")
	LFclientes	= NetArq("clientes")
	LForcament	= NetArq("orcament")
	IF (LFclientes+LFclienc+LForcament) > 100000
		DO ORfchAtlz_Clie
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	SELECT orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNorca,6)
	IF !FOUND()
		DO ORfchAtlz_Clie
		RETURN(.T.)
	ENDIF

	SELECT clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNorca,6)
	IF !FOUND()
		DO ORfchAtlz_Clie
		RETURN(.T.)
	ENDIF

	SELECT clientes
	SET ORDER TO TAG cliente
	SEEK clienc.cliente
	IF !FOUND()
		DO ORfchAtlz_Clie
		RETURN(.T.)
	ENDIF
	
 	DO WHILE !EOF() AND clienc.cliente = clientes.cliente
		IF clienc.inscricao = clientes.inscricao
			EXIT
		ENDIF
		SKIP	&& VERIFICA SE E DUPLICADO E CHECA A INSCRICAO
	ENDDO
	IF EOF() OR clienc.cliente <> clientes.cliente OR ;
			clienc.inscricao <> clientes.inscricao
		SKIP -1			  && PEGAR DADOS DO REG. LOCALIZADP
	ENDIF				  && PRIMEIRO
	*----------------------------------------------------------*
	IF (clienc.tp_pessoa <> clientes.tp_pessoa OR ;
					clienc.cliente <> clientes.cliente OR ;
					clienc.estado <> clientes.estado OR ;
					clienc.inscricao <> clientes.inscricao OR ;
					clienc.tp_inscr <> clientes.tp_inscr OR ;
					clienc.revendedor <> clientes.revendedor)
		SCATTER MEMVAR FIELDS tp_pessoa, cliente, nome, fone, estado,;
				 inscricao,tp_inscr, revendedor MEMO
		IF m.revendedor <> "S"
			m.revendedor = "N"
		ENDIF   		
		SELE  clienc
		=REGLOCK(.T.)
		=edithand('REGRAVA')
		SELE orcament
		=RLOCK()
		
		REPLACE orcament.lmt_parcela  WITH clientes.lmt_parcela
		*----------------------------------------------------------*
		*  Ajustar Classifica‡Æo do Orcamento					   *
		*----------------------------------------------------------*
		LStipoAnt	= orcament.tipo
		m.tipo 		= orcament.tipo
		=W_DEFPROC("orcament.spr")
		IF !ORnewclas_oper((LNemp),(LNorca))
		   	wp_msg = "Atencao!!! "+CHR(13)+;
					"     Nao Foi Possivel Classificar a Operacao."
			=UPbeeps(.f.,wp_msg)
		ELSE
			IF m.tipo <> LStipoAnt
			   	wp_msg = "Atencao!!! "+CHR(13)+;
	   					"     Devido a Alteracoes do Cadasto "+;
   						"do Cliente a Operacao "+;
			   			chr(13)+;
				   	"Foi Reclassificada Para "+m.tipo+chr(13)+chr(13)+;
		  				" Podendo Afetar o Valor. Verrifique."
				=UPbeeps(.f.,wp_msg)
				*---------------------------------------------------*
				=W_DEFPROC("ORCAMENT.SPR")
				=ORrecalc_OSI((LNemp),(LNorca))
				*----------------------------------------------------*
			ENDIF			
		ENDIF
	ENDIF
	*----------------------------------------------------------*

	*----------------------------------------------------------*
	DO ORfchAtlz_Clie
RETURN(.T.)

PROCEDURE ORfchAtlz_Clie
		=UP_fecha("orcament" ,LForcament)
		=UP_fecha("clienc" ,LFclienc)
		=UP_fecha("clientes" ,LFclientes)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
RETURN
****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3J6           ORclas_oper VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:    9  º
*       º Variable:            ORclas_oper                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      207                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3j6     &&  ORclas_oper VALID
#REGION 8
RETURN

FUNCTION ORclas_oper
	PARAMETERS LNemp,LNnatuOper,LNmotivo,LSUFdestino,LNtp_inscr,LNnatu_cli,;
		LNtp_pgto,LStipo,;
		LSch_opera,LSch_produ,LSch_motiv,LSch_desti,LSch_contr,LSch_condi

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Classificar a operacao comercial permitindo
	*			a atribuicao do TIPO
	*------------------------------------------------------------*
	* COMENTARIO..: Todas operacoes realizadas tem uma classificacao
	*			que servira DE ORIENTACAO para todos processos reali-
	*			zados, como TRIBUTACAO, BAIXA ESTOQUE, RESERVA, FATU-
	*			RAMENTO .....
	*				Esta CLASSIFICAO permite a orientacao do processo
	*			a ser realizado....
	*				A classificacao leva em consideracao as caracteris-
	*			ticas da :
	*					-OPERACAO(venda,transferenci,..)
	*					-CLIENTE(contribuinte,destino,...)
	*					-COMERCIAL(prazo,...)
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LNnatuOper.....: Indica Natureza da Operacao
	*							1-Venda ou Compra
	*							2-Transferencia
	*							3-S.Remessa
	*							4-Devolucao
	*							5-Requisicao
	*							6-NF.Entrada
	*							7-Outras
	*		LNmotivo.......: Conforme a Natureza
	*                         Ver vetor VTLmotivo em SCGC2.PRG
	*		LSUFdestino....: UF do Cliente
	*					
	*		LNtp_inscr.....: Tipo de Inscricao do Cliente
	*						1=ISENTO
	*						2=INSCRITO
	*		LNnatu_cli.....: Natureza do Cliente
	*						0= VAREJO
	*						1= REVENDA
	*						3= P.PUBLICO
	*						4= FROTA
	*		LNtp_pgto......: Tipo de Pagamento Proposto
	*						1= A VISTA
	*						2= C.APRESENTACAO
	*						3= A PRESA
	*		LStipo.........: Tipo Informado Diretamente para
	*						completar a classificacao
	*
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*	LSch_opera,LSch_produ,LSch_motiv,LSch_desti,LSch_contr,LSch_condi
	*------------------------------------------------------------*
	* EXEMPLO : SCGC2.PRG
	*			OBJ_ITOR.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LFretorno
	PRIVATE LSalias
	LSalias = ALIAS()
	*------------------------------------------------------------*
	IF (LNnatuOper = 1 AND LNmotivo = 8) OR ;
	   (LNnatuOper = 2 AND LNmotivo = 5) OR ;
	   (LNnatuOper = 3 AND LNmotivo = 6) OR ;
	   (LNnatuOper = 4 AND LNmotivo = 8) OR ;
	   (LNnatuOper = 5) OR   (LNnatuOper = 7)
		SELECT tipooper
		SET ORDER TO TAG tipo
		SEEK 's'+LStipo
		IF !FOUND()
			SEEK 'S'+LStipo  	
		ENDIF
	ELSE
	  DO CASE
		CASE LNnatuOper = 1
			STORE "1"     TO LSch_opera  && 1=VENDA 		
			STORE "1"     TO LSch_produ  && 1=PROD.E SERV COMERCIAL
			STORE STR(LNmotivo,1)  TO LSch_motiv    && 1=NORMAL  2=RECLAMADA
											&& 3=COMPLEMENTO 4=ENTRGA FUTU.		
			SELE empresa
			SET ORDER TO TAG empresa
			SEEK LNemp
			IF empresa.estado = LSUFdestino
				LSch_desti = "1"   && ESTADUAL
				LSch_contr = "1"   && CONSUMIDOR ESTADUAL				
			ELSE
				LSch_desti = "2"   && ITERESTADUAL
				IF LNtp_inscr = 1
					LSch_contr = "2"
				ELSE
					LSch_contr = "3"
				ENDIF			
			ENDIF
			IF LNnatu_cli =  1		&& REVENDEDOR
				LSch_contr = "4"
			ENDIF	
			IF LSch_motiv = "4"  && VENDA P/ ENTREGA FUTURA
				LSch_condi = "3"
			ELSE
			    IF LNtp_pgto > 1		&& 2=C/APRES e 3= A PRAZO
					LSch_condi = "2"
				ELSE
					LSch_condi = "1"
				ENDIF
			ENDIF
		**------>>> para IMOBILIZADO // CARCACA E SUCATA
			IF LNmotivo > 4    && 5=IMOBIL // 6=CARAC // 7= SUCATA
				STORE "1"  TO LSch_motiv    && 1=NORMAL
				STORE "3"  TO LSch_condi    && 3=CONDICAO NULA DE PGTO
				STORE "5"  TO LSch_contr    && 5=CONTRIBUINTE NULO
			ENDIF
			DO CASE
				CASE LNmotivo = 5
					STORE "2"     TO LSch_produ  && 2=IMOBILIZADO		
				CASE LNmotivo = 6
					STORE "3"     TO LSch_produ  && 3=CARCACA
				CASE LNmotivo = 7
					STORE "4"     TO LSch_produ  && 4=SUCATA
			ENDCASE
		CASE LNnatuOper = 2
			STORE "2"     TO LSch_opera  && 2=TRANSFERENCIA
			STORE "5"     TO LSch_contr  && 5=CONTR. NULO SEM EFEITO NA
			STORE "3"	  TO LSch_condi  && 3=CONDICAO NULA SEM EFEITO OPER.
			STORE "1"     TO LSch_motiv  && 1=TRANSFERENCIA NORMAL
			STORE STR(LNmotivo,1)  TO LSch_produ && VALIDO P/ OPCAO 1 e 2
			IF LNmotivo = 3
			   STORE "5"  TO LSch_produ    && 5=MAT.DE USO SERVICO
		    ELSE
				IF LNmotivo = 4
				   STORE "6"  TO LSch_produ    && 6=MAT.DE CONSUMO
				ENDIF
			ENDIF
		
			SELE empresa
			SEEK LNemp          && EMPRESA NO PAPEL DE PARAMETRO
			IF empresa.estado = LSUFdestino
				LSch_desti = "1"   && ESTADUAL
			ELSE
				LSch_desti = "2"   && ITERESTADUAL
			ENDIF
		CASE LNnatuOper = 3
			STORE "3"     TO LSch_opera  && 3=REMESSA
			STORE "5"     TO LSch_contr  && 5=CONTR. NULO SEM EFEITO OPER
			STORE "3"	  TO LSch_condi  && 3=CONDICAO NULA SEM EFEITO OPER.
		    STORE "1"  	  TO LSch_produ  && 1=CONSIDERA SEMPRE MERCADORIA

			DO CASE
				CASE LNmotivo = 1
					STORE "5"     TO LSch_motiv  && 5=CONSIGNACAO
		    	CASE LNmotivo = 2
					STORE "6"  TO LSch_motiv    && 6=DEMONSTRACAO
				CASE LNmotivo = 3
					STORE "2"  TO LSch_motiv    && 2=RECLAMADA
				CASE LNmotivo = 4
					STORE "4"  TO LSch_motiv    && 4=ENTREGA FUTURA
				CASE LNmotivo = 5
					STORE "7"  TO LSch_motiv    && 7=CONSERTO
				CASE LNmotivo = 6
					STORE "8"  TO LSch_motiv    && 8=OUTRAS
			ENDCASE
			SELE empresa
			SEEK LNemp
			IF empresa.estado = LSUFdestino
				LSch_desti = "1"   && ESTADUAL
			ELSE
				LSch_desti = "2"   && ITERESTADUAL
			ENDIF
		CASE LNnatuOper = 4
			STORE "4"     TO LSch_opera  && 4=DEVOLUCAO
			STORE "5"     TO LSch_contr  && 5=CONTR. NULO SEM EFEITO NA OPE
			STORE "3"	  TO LSch_condi  && 3=CONDICAO NULA SEM EFEITO OPER.
		    STORE "1"  	  TO LSch_motiv  &&1=NOR EXCETO P/CONSIG(2)DEMONS(3)
			DO CASE
				CASE LNmotivo < 4
					STORE "1"     TO LSch_produ  && 1=MERCADORIA
					IF LNmotivo = 2
						STORE "5"  	  TO LSch_motiv  && 5=CONSIGNACAO
					ELSE
						IF LNmotivo = 3
							STORE "6"  	  TO LSch_motiv  && 6=DEMONSTRACAO
						ENDIF
					ENDIF
		    	CASE LNmotivo = 4
					STORE "5"  TO LSch_produ    && 5=MAT. USO SERVICO
				CASE LNmotivo = 5
					STORE "6"  TO LSch_produ    && 6=MAT. CONSUMO
				CASE LNmotivo = 6
					STORE "2"  TO LSch_produ    && 2=IMOILIZADO
				CASE LNmotivo = 7
					STORE "7"  TO LSch_produ    && 7=ICMS P/ REEMBOLSO
				CASE LNmotivo = 8
					STORE "8"  TO LSch_produ    && 8=OUTRAS
				CASE LNmotivo = 9
					STORE "1"  TO LSch_produ    && 1=MERC.COMERCIAL
					STORE "6"  TO LSch_contr    && 6=CONS.INSC.REG.ACORDO
			ENDCASE
			SELE empresa
			SEEK LNemp
			IF empresa.estado = LSUFdestino
				LSch_desti = "1"   && ESTADUAL
			ELSE
				LSch_desti = "2"   && ITERESTADUAL
			ENDIF
			SELECT tipooper
	  ENDCASE
 	  SELECT tipooper
	  SET ORDER TO tpopera
	  SEEK 'S'+LSch_opera+LSch_produ+LSch_motiv+;
				  LSch_desti+LSch_contr+LSch_condi
	ENDIF
	IF !FOUND()
		WAIT WINDOW ;
		"A OPERACAO NAO PODE SER CLASSIFICADA. CHAME SUPORTE...<<ENTER>>"
		LFretorno	= 	.f.
		LStipo = "???"
	ELSE
		LFretorno	= 	.t.
		LSch_opera	=	tipooper.ch_opera
		LSch_produ	=	tipooper.ch_produ
		LSch_motiv	=	tipooper.ch_motiv
		LSch_desti	=	tipooper.ch_desti
		LSch_contr	=	tipooper.ch_contr
		LSch_condi	=	tipooper.ch_condi
		LStipo		=	tipooper.tipo
	ENDIF
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3JL           ORnewclas_oper VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   10  º
*       º Variable:            ORnewclas_oper                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      208                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3jl     &&  ORnewclas_oper VALID
#REGION 8
RETURN

FUNCTION ORnewclas_oper
	PARAMETERS LNemp, LNosi

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Classificar a operacao comercial permitindo
	*			a atribuicao do TIPO
	*------------------------------------------------------------*
	* COMENTARIO..: Todas operacoes realizadas tem uma classificacao
	*			que servira DE ORIENTACAO para todos processos reali-
	*			zados, como TRIBUTACAO, BAIXA ESTOQUE, RESERVA, FATU-
	*			RAMENTO .....
	*				Esta CLASSIFICAO permite a orientacao do processo
	*			a ser realizado....
	*				A classificacao leva em consideracao as caracteris-
	*			ticas da :
	*					-OPERACAO(venda,transferenci,..)
	*					-CLIENTE(contribuinte,destino,...)
	*					-COMERCIAL(prazo,...)
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*	Dados do Orcamento Trabalhados na Classifica‡Æo	
	*		Eempresa..........: Empresa em operacao
	*		Natu_Oper.........: Indica Natureza da Operacao
	*							1-Venda ou Compra
	*							2-Transferencia
	*							3-S.Remessa
	*							4-Devolucao
	*							5-Requisicao
	*							6-NF.Entrada
	*		Motivo...........: Conforme a Natureza
	*                         Ver vetor VTLmotivo em SCGC2.PRG
	*		EXEMPLO
	*	CASE m.natu_oper = 1
	*		VTLmotivo(1) = "Normal         "
	*		VTLmotivo(2) = "Reclamada      "
	*		VTLmotivo(3) = "Complemento    "
	*		VTLmotivo(4) = "Entrega Futura "
	*		VTLmotivo(5) = "Imobilizado    "
	*		VTLmotivo(6) = "Carcacas       "
	*		VTLmotivo(7) = "Sucatas        "
	*		VTLmotivo(8) = "Outras         "
	*		VTLmotivo(9) = "               "
	*	CASE m.natu_oper = 2
	*		VTLmotivo(1) = "Mercadoria Comercial  "
	*		VTLmotivo(2) = "Bens Imobilizados     "
	*----------------------------------------------------------------*
	*		Estado(Destino)..: UF do Cliente
	*					
	*		Tp_Inscr.........: Tipo de Inscricao do Cliente
	*						1=ISENTO
	*						2=INSCRITO
	*		Natu_cli.....: Natureza do Cliente
	*						0= VAREJO
	*						1= REVENDA
	*						3= P.PUBLICO
	*						4= FROTA
	*		Tp_parcela......: Tipo de Parcelamento Proposto
	*						1= A VISTA
	*						2= PARCELADO NO CHEQUE
	*						3= PARCELADO NO DUPLICATA
	*						4= PARCELADO NO CARTAO
	*		Tipo.........: Tipo Informado Diretamente para
	*						completar a classificacao
	*
	*
	*------------------------------------------------------------*
	*  RETORNO.....:  TIPO DEFINIDO + Grava Classifica‡Æo no Proprio
	*              Orcamento Indicado Pelo Parametro
	*------------------------------------------------------------*
	* EXEMPLO : SCGC2.PRG
	*			OBJ_ITOR.SCR
	*			=W_DEFPROC("ORCAMENT.spr")
	*			=ORnewclas_oper(EMPRESA,ORCAMENTO)
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	PRIVATE LNnatuOper,LNmotivo,;
	    LSUFdestino,LNtp_inscr,LNnatu_cli,;
		LNTp_parcela,;
		LSch_opera,LSch_produ,LSch_motiv,LSch_desti,LSch_contr,LSch_condi
	PRIVATE LSalias
	PRIVATE	LFempresa,LForcamento,LFtipooper,LFclienc

	LSalias = ALIAS()

	*--------------------------------------------------------
	LFempresa		= NetArq("empresa")
	LForcamento		= NetArq("orcament")
	LFtipooper		= NetArq("tipooper")
	LFclienc		= NetArq("clienc")
	*--------------------------------------------------------
    IF (LFempresa+LForcamento+LFtipooper+LFclienc) > 100000
		DO OBJ_MENS.SPR WITH;
		   Chr(13)+"  Houve Falha na Abertura de Tabelas"+;
		   " para Classificar Orcamento "+STR(LNosi,6)+chr(13)+chr(13)+;
		   "       CLASSIFICACAO NAO EFETUADA."
	    DO ULFchclas_oper
		RETURN(.f.)
	ENDIF
	SELE orcament
	SET ORDER TO TAG geral
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
		DO OBJ_MENS.SPR WITH ;
			Chr(13)+"  Orcamento "+STR(LNosi,6)+;
			" Nao Foi Localizado."+chr(13)+chr(13)+;
			"       CLASSIFICACAO NAO EFETUADA."
	    DO ULFchclas_oper
		RETURN(.f.)
	ENDIF
	IF !REGLOCK()
		DO OBJ_MENS.SPR WITH ;
			Chr(13)+"Nao Foi Possivel Bloquer Orcamento "+STR(LNosi,6)+;
			" Para Processo."+chr(13)+chr(13)+;
			"       CLASSIFICACAO NAO EFETUADA."
	    DO ULFchclas_oper
		RETURN(.f.)
	ENDIF
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
		DO OBJ_MENS.SPR WITH ;
			Chr(13)+"  Dados do Cliente (CLIENC) "+STR(LNosi,6)+;
			" Nao Foram Localizadoa."+chr(13)+chr(13)+;
			"       CLASSIFICACAO NAO EFETUADA."
	    DO ULFchclas_oper
		RETURN(.f.)
	ENDIF

		
	*------------------------------------------------------------*
	LNnatuOper  = orcament.natu_oper
	LNmotivo 	= orcament.motivo
    LSUFdestino = clienc.estado
    LNtp_inscr  = clienc.tp_inscr
    LNnatu_cli  = clienc.natu_cli
    LNTp_parcela   = orcament.Tp_parcela
    LStipo      = "???"
	*------------------------------------------------------------*

	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp

	DO CASE

		CASE (LNnatuOper = 1 AND LNmotivo = 8) OR ;
		   (LNnatuOper = 2 AND LNmotivo = 5) OR ;
		   (LNnatuOper = 3 AND LNmotivo = 6) OR ;
		   (LNnatuOper = 4 AND LNmotivo = 8) OR ;
		   (LNnatuOper = 5) OR (LNnatuOper = 7)
			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+orcament.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo
			ENDIF

		*CASE clienc.seguimento = 2  ;
		*     AND empresa.estado $ "BA/GO/MA/MS/PB/PA/PE/RN/SE/DF/" ;
		*     AND clienc.estado $ "BA/GO/MA/MS/PB/PA/PE/RN/SE/DF/" ;
		*     AND clienc.estado <> empresa.estado
		*	 SELECT tipooper
 		*	 SET ORDER TO TAG tipo
		*	 SEEK 'S'+"VCI"
		*	 IF !FOUND()
		*		SEEK 's'+"VCI"
		*	 ENDIF
		*  em 19/01/2007 incluiu AL/MT

		CASE clienc.seguimento = 2  and orcament.data > {30.08.2007} ;
		     AND empresa.estado $ ;
		        "BA/GO/MA/MS/PB/PA/PE/RN/SE/DF/AL/MT/RJ/RS/TO/RO" ;
		     AND clienc.estado $  ;
		        "BA/GO/MA/MS/PB/PA/PE/RN/SE/DF/AL/MT/RJ/RS/TO/RO" ;
		     AND clienc.estado <> empresa.estado

			 SELECT tipooper
 			 SET ORDER TO TAG tipo
			 SEEK 'S'+"VCI"
			 IF !FOUND()
				SEEK 's'+"VCI"
			 ENDIF


		CASE clienc.seguimento = 2  ;
		     AND empresa.estado $ "BA/GO/MA/MS/PB/PA/PE/RN/SE/DF/AL/MT" ;
		     AND clienc.estado $  "BA/GO/MA/MS/PB/PA/PE/RN/SE/DF/AL/MT" ;
		     AND clienc.estado <> empresa.estado

			 SELECT tipooper
 			 SET ORDER TO TAG tipo
			 SEEK 'S'+"VCI"
			 IF !FOUND()
				SEEK 's'+"VCI"
			 ENDIF
	
		OTHERWISE
		  	DO CASE
				CASE LNnatuOper = 1
					STORE "1"     TO LSch_opera  && 1=VENDA 		
					STORE "1"     TO LSch_produ  && 1=PROD.E SERV COMERCIAL
					STORE STR(LNmotivo,1)  TO LSch_motiv
											&& 1=NORMAL 2=RECLAMADA
											&& 3=COMPLEMENTO 4=ENTRGA FUTU.		

					IF empresa.estado = LSUFdestino
						LSch_desti = "1"   && ESTADUAL
						LSch_contr = "1"   && CONSUMIDOR ESTADUAL				
					ELSE
						LSch_desti = "2"   && ITERESTADUAL
						IF LNtp_inscr = 1
							LSch_contr = "2"
						ELSE
							LSch_contr = "3"
						ENDIF			
					ENDIF
					IF LNnatu_cli =  1		&& REVENDEDOR
						LSch_contr = "4"
					ENDIF	
					IF LSch_motiv = "4"  && VENDA P/ ENTREGA FUTURA
						LSch_condi = "3"
					ELSE
					    IF LNTp_parcela > 1		&& >1 => PARCELADO
						    IF LNTp_parcela = 6		&& 6 = VENDOR = A VISTA
								LSch_condi = "1"
							ELSE
								LSch_condi = "2"
							ENDIF
						ELSE
							LSch_condi = "1"
						ENDIF
					ENDIF
				**------>>> para IMOBILIZADO // CARCACA E SUCATA
					IF LNmotivo > 4    && 5=IMOBIL // 6=CARAC // 7= SUCATA
						STORE "1"  TO LSch_motiv && 1=NORMAL
						STORE "3"  TO LSch_condi && 3=CONDICAO NULA DE PGTO
						STORE "5"  TO LSch_contr    && 5=CONTRIBUINTE NULO
					ENDIF
				DO CASE
					CASE LNmotivo = 5
						STORE "2"     TO LSch_produ  && 2=IMOBILIZADO		
					CASE LNmotivo = 6
						STORE "3"     TO LSch_produ  && 3=CARCACA
					CASE LNmotivo = 7
						STORE "4"     TO LSch_produ  && 4=SUCATA
				ENDCASE

			CASE LNnatuOper = 2
				STORE "2" TO LSch_opera  && 2=TRANSFERENCIA
				STORE "5" TO LSch_contr  && 5=CONTR. NULO SEM EFEITO NA
				STORE "3" TO LSch_condi  && 3=CONDICAO NULA SEM EFEITO OPER.
				STORE "1" TO LSch_motiv  && 1=TRANSFERENCIA NORMAL
				STORE STR(LNmotivo,1) TO LSch_produ && VALIDO P/ OPCAO 1 e 2
				IF LNmotivo = 3
				   STORE "5"  TO LSch_produ    && 5=MAT.DE USO SERVICO
			    ELSE
					IF LNmotivo = 4
					   STORE "6"  TO LSch_produ    && 6=MAT.DE CONSUMO
					ENDIF
				ENDIF
		
				SELE empresa
				SET ORDER TO TAG empresa
				SEEK LNemp          && EMPRESA NO PAPEL DE PARAMETRO
				IF empresa.estado = LSUFdestino
					LSch_desti = "1"   && ESTADUAL
				ELSE
					LSch_desti = "2"   && ITERESTADUAL
				ENDIF
			CASE LNnatuOper = 3
				STORE "3" TO LSch_opera  && 3=REMESSA
				STORE "5" TO LSch_contr  && 5=CONTR. NULO SEM EFEITO OPER
				STORE "3" TO LSch_condi  && 3=CONDICAO NULA SEM EFEITO OPER.
			    STORE "1" TO LSch_produ  && 1=CONSIDERA SEMPRE MERCADORIA

				DO CASE
					CASE LNmotivo = 1
						STORE "5"     TO LSch_motiv  && 5=CONSIGNACAO
		    		CASE LNmotivo = 2
						STORE "6"  TO LSch_motiv    && 6=DEMONSTRACAO
					CASE LNmotivo = 3
						STORE "2"  TO LSch_motiv    && 2=RECLAMADA
					CASE LNmotivo = 4
						STORE "4"  TO LSch_motiv    && 4=ENTREGA FUTURA
					CASE LNmotivo = 5
						STORE "7"  TO LSch_motiv    && 7=CONSERTO
					CASE LNmotivo = 6
						STORE "8"  TO LSch_motiv    && 8=OUTRAS
				ENDCASE
				SELE empresa
				SET ORDER TO TAG empresa
				SEEK LNemp
				IF empresa.estado = LSUFdestino
					LSch_desti = "1"   && ESTADUAL
				ELSE
					LSch_desti = "2"   && ITERESTADUAL
				ENDIF
			CASE LNnatuOper = 4
				STORE "4" TO LSch_opera  && 4=DEVOLUCAO
				STORE "5" TO LSch_contr  && 5=CONTR. NULO SEM EFEITO NA OPE
				STORE "3" TO LSch_condi  && 3=CONDICAO NULA SEM EFEITO OPER.
			    STORE "1" TO LSch_motiv  &&1=NOR EXCETO P/CONSIG(2)DEMONS(3)
				DO CASE
					CASE LNmotivo < 4
						STORE "1"     TO LSch_produ  && 1=MERCADORIA
						IF LNmotivo = 2
							STORE "5"  	  TO LSch_motiv  && 5=CONSIGNACAO
						ELSE
							IF LNmotivo = 3
								STORE "6"  TO LSch_motiv  && 6=DEMONSTRACAO
							ENDIF
						ENDIF
			    	CASE LNmotivo = 4
						STORE "5"  TO LSch_produ    && 5=MAT. USO SERVICO
					CASE LNmotivo = 5
						STORE "6"  TO LSch_produ    && 6=MAT. CONSUMO
					CASE LNmotivo = 6
						STORE "2"  TO LSch_produ    && 2=IMOILIZADO
					CASE LNmotivo = 7
						STORE "7"  TO LSch_produ    && 7=ICMS P/ REEMBOLSO
					CASE LNmotivo = 8
						STORE "8"  TO LSch_produ    && 8=OUTRAS
					CASE LNmotivo = 9
						STORE "1"  TO LSch_produ && 1=MERC.COMERCIAL
						STORE "6"  TO LSch_contr && 6=CONS.INSC.REG.ACORDO
				ENDCASE
				SELE empresa
				SET ORDER TO TAG empresa
				SEEK LNemp
				IF empresa.estado = LSUFdestino
					LSch_desti = "1"   && ESTADUAL
				ELSE
					LSch_desti = "2"   && ITERESTADUAL
				ENDIF
				SELECT tipooper
		  ENDCASE
	 	  SELECT tipooper
		  SET ORDER TO tpopera
		  SEEK 'S'+LSch_opera+LSch_produ+LSch_motiv+;
				  LSch_desti+LSch_contr+LSch_condi
	ENDCASE

	IF !FOUND()
		WAIT WINDOW ;
		"A OPERACAO NAO PODE SER CLASSIFICADA. CHAME SUPORTE...<<ENTER>>"
		LFretorno	= 	.f.
		LStipo = "???"
	ELSE
		LFretorno	= 	.t.
		LSch_opera	=	tipooper.ch_opera
		LSch_produ	=	tipooper.ch_produ
		LSch_motiv	=	tipooper.ch_motiv
		LSch_desti	=	tipooper.ch_desti
		LSch_contr	=	tipooper.ch_contr
		LSch_condi	=	tipooper.ch_condi
		LStipo		=	tipooper.tipo
	ENDIF
	*------------------------------------------------------------*
	SELE orcament
    m.tipo		= 	LStipo
	*----------------------------------------------------------*
	*     Ajuste das Informa‡äes do Orcamento Vinculadas ao TIPO
	* e Que Pode Sofrer Altera‡Æo ao se Alterar o TIPO
	*----------------------------------------------------------*
	*    Caso o Tipo da Opera‡Æo NÆo Aceite Informar a Aliq. ICMS
	* Ser  assumida a Aliq. Determinada No Tipo. Caso Contrario
	* ser  Considerada a Aliq. Informada no Orcamento
	*----------------------------------------------------------*
	IF m.tipo = "???" OR tipooper.info_icms = "N"
		m.aliq_icms = tipooper.aliq_icms
	ELSE
		m.aliq_icms = orcament.aliq_icms
	ENDIF			
	IF m.tipo <> orcament.tipo OR m.aliq_icms <> orcament.aliq_icms
		*---------------------------------------------------------*
		*     Devido a mudaca de tipo, condicoes ou dados do cliente
		*  a OSI deve ser recalculada. Para indicar esta necessidade
		* FLGTRASAC = .f. .  Este artificio evita que a OSI seja
		* recalculada durante a edicao dos itens onde serao recalcu-
		* lados os itens do arq. TEMPORARIO em edicao, evitando perda
		* de tempo.
		*     A OSI nao deve sofrer nehum tipo de processo enquato
		* o FLGTRANSAC = .F. com excessao da edicao dos itens que
		* obrigara o recalculo e convertera o FLGTRANSAC = .T.
		*     As rotinas de RESERVA,IMPOSI,ENV.P/FAT,FATURAMENTO,
		* LIBERACAO,CANC OSI NAO PODEM SER EXECUTADAS COM
		* FLGTRANSAC = .F. .
		*     Na entrada da edicao dos itens o flag e verificado
		* e se necessario recalcula a OSI.
		*     Na saida dos itens por gravacao o flag ASSUME .T. pois
		* os itens do arq. temporario que esta sendo gravado ja estao
		* reprocessados
		*---------------------------------------------------------*
		m.flgtransac = .F.
		*---------------------------------------------------------*
	ELSE
		m.flgtransac = orcament.flgtransac
	ENDIF


	*------------------------------------------------------------*
	SET FIELDS TO dtregis, hregis, usrregis,deletado
    SET FIELDS TO tipo,aliq_icms,flgtransac
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------*
	DO ULFchclas_oper
RETURN(LFretorno)

PROCEDURE ULFchclas_oper
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("orcament" ,LForcament)
	=UP_fecha("tipooper" ,LFtipooper)
	=UP_fecha("clienc" ,LFclienc)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3K5           ORdef_tribut VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   11  º
*       º Variable:            ORdef_tribut                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      209                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _43a0ls3k5     &&  ORdef_tribut VALID
#REGION 8
RETURN

FUNCTION ORdef_tribut
	PARAMETERS LNemp,LSCdgProduto,LNorcament,;
			LNalq_icms,LNalq_ipi,LNalq_iss,LNalq_rdu,;
			LScfo,LScst,LNtp_mercad,LNiva
	*------------------------------------------------------------*
	* obs: Esta Rotina Esta Trabalhando co Parametros Desnecessarios
	* apartire dom momento que a reestrutura‡Æo de ORCAMENT E ORCATMP
	* forem ao ar
	* ex: Chamada em SCD0400.SPR
	*			=ORdef_tribut((orcament.empresa),(tmpitem.codigo),;
	*					(orcament.orcamento),;
	*					m.aliq_icms,m.aliq_ipi,m.aliq_iss,;
	*				    m.cfo,m.cst,m.tp_mercad,m.iva)
	*   Os Parametros com (0) SÆo desnecessarios
	*         Anota‡Æo feita em 21/08/2000
	*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Definir as caracteristicas TRIBUTARIAS E
	*			OPERACIONAIS para um produto
	*------------------------------------------------------------*
	* COMENTARIO..: Os itens apresentam caracteristicas que devem
	*			ser reconhecidas durante os processos. Esta rotina
	*			identifica estas caracteristicas.
	*               Outro ponto e que apartir de alteracoes da
	*            imlementadas apartir de 07/2000, os itens de um
	*            mesmo orcamento podem apresentar CFOs diferentes
	*            Como esta rotina e ativada para cada item que esta
	*			 sendo processado ‚ possivel tratar o CFO diferenciado
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa em operacao
	*		LSCdgProduto...: Codigodo Produto em Questao
	*		LNorcament.....: Orcamento
	*------------------------------------------------------------*
	*  RETORNO.....:
	*			LNalq_icms,LNalq_ipi,LNalq_iss,LNalq_rdu,
	*			LScfo,LScst,LNtp_mercad,LNiva
	*------------------------------------------------------------*
	* EXEMPLO : OBJ_ITOR
	*		 	ORrecalc_item
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
    PRIVATE LSalias

	LSalias = ALIAS()
	*------------------------------------------------------------*
	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*

	=W_DEFPROC("tributar.spr")

    =TRpct_trib(LNemp, LNorcament, LSCdgProduto, ;
	    LNiva, LNalq_ipi, LNtp_mercad, LScst,;
    	LNalq_iss, LNalq_rdu, LNalq_icms, LScfo)

		



	*=W_DEFPROC("tributar.spr")
    *LNtp_mercad = TRDef_TpMercad((LNemp),(LNorcament),(LSCdgProduto))

	*=W_DEFPROC("tributar.spr")
    *LScfo = TRGet_CFO((LNemp),(LNorcament),(LSCdgProduto))

	*=W_DEFPROC("tributar.spr")
    *LNalq_icms  = TRGet_IcmsAlq((LNemp),(LNorcament))

	*=W_DEFPROC("tributar.spr")
	*LNalq_rdu   = TRGet_rduIcms((LNemp),(LNorcament))

	*=W_DEFPROC("tributar.spr")
	*LNalq_iss = TRGet_ISSAlq((LNemp))


	*=W_DEFPROC("tributar.spr")
    *LNiva     = TRGet_IVA((LNemp),(LSCdgProduto))

	*=W_DEFPROC("tributar.spr")
    *LNalq_ipi = TRGet_IpiAlq((LNemp),(LNorcament),(LSCdgProduto))

	*=W_DEFPROC("tributar.spr")
    *LScst     = TRGet_CST((LNemp),(LNorcament),(LSCdgProduto),(LScst))

	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.t.)


****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3KI           ORprzmedio VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   12  º
*       º Variable:            ORprzmedio                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      210                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ki     &&  ORprzmedio VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
FUNCTION ORprzmedio
	PARAMETER LSprazo,LNjuromes,LNnumpgt, LNprazomedio,LNtaxa

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Calcular o Numero de Pagamentos, Prazo Medio
	*          e a Taxa de Juros
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*     EM 22/08/2000 foi Criada ORprzmedio Que Deve Substituir
	* UAprzmedio em SCGC2.PRG e cuja principal diferenca e retornar
	* os valore nos parametros
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LSprazo.......: STRING "000/030/060" BASE P/ PROCESSO
	*		LNjuromes.....: JUROS MENSSAIS
	*
	*						
	*------------------------------------------------------------*
	*  RETORNO.....:
	*				-LNnumpgt......:
	*				-LNprazomedio..:
	*               -LNtaxa........:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SVD0400.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*-----------------------------------------------------------*
	PRIVATE	LNocorrenc,LNposic,LNdias,LNinicio,LNprzacm

	LNocorrenc   = 1
    LNposic      = 0
	LNdias	     = 0
    LNinicio     = 1
    LNprzacm     = 0
    LNnumpgt   	 = 0
	LNprazomedio = 0
	LNtaxa		 = 0

	DO WHILE .t.
        LNposic = AT("/",LSprazo, LNocorrenc)
        LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))

   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
			EXIT
		ENDIF

		IF LNdias = 0 AND LNnumpgt > 0
	        LNnumpgt   = LNnumpgt
		ELSE
	        LNnumpgt   = LNnumpgt + 1
		ENDIF
        LNprzacm   = LNprzacm  + INT(VAL(SUBS(LSprazo,LNinicio,3)))
		LNocorrenc = LNocorrenc + 1
        LNinicio   = LNposic + 1
	ENDDO
	IF LNnumpgt <> 0
	    LNprazomedio = LNprzacm / LNnumpgt
	ENDIF
	

	IF LNjuromes = 0 OR LNprazomedio = 0
    	LNtaxa = 0
    ELSE
       	LNtaxa = ROUND((LNjuromes / 30) *LNprazomedio,2)
	ENDIF
	
	*----------------------------------------------------------*
RETURN(.T.)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3KQ           ORcalc_vlres VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   13  º
*       º Variable:            ORcalc_vlres                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      211                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3kq     &&  ORcalc_vlres VALID
#REGION 8
RETURN

FUNCTION ORcalc_vlres
	PARAMETERS LNpreco,LNqtde,LNdesc,LNdscAdicional,;
			LNtaxa, LNprc_final,LNvlrvenda,	LSinformado
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Calcular Valores Comerciais  TRIBUTARIAS E
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*			LNpreco......: Preco em Tabela
	*			LNqtde.......:
	*			LNdesc.......: Desconto
	*			LNdscAdicional: Valor disponivel para injetar como
	*							desconto. Exemplo valor de bonus
	*                           (‚ alterado retornado com o valor
	*							efetivamente usado para desconto
	*							uma vez que o disponivel pode ser
	*							superior ao valor da operacao)
	*			LNtaxa.......: Taxa de Juros
	*			LNvlrvenda...: Valor atual
	*			LSinformado..: Indica quais dados Informados
	*------------------------------------------------------------*
	*  RETORNO.....:
	*			LNprc_final,LNvlrvenda
	*------------------------------------------------------------*
	* EXEMPLO : OBJ_ITOR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LNauxVlr
	PRIVATE LNtmpdif
	*------------------------------------------------------------*
	DO CASE
		CASE LSinformado ="DADO PRECO e DESCONTO"
		     LNauxVlr = ;
		     	ROUND((LNpreco-ROUND(LNpreco * LNdesc / 100,2))*LNqtde,2)
		     LNauxVlr = ;
		     		LNauxVlr+ROUND(LNauxVlr* ROUND(LNtaxa / 100,4),2)
			*------------------------------------------------------------*
			*   Qdo a diferenca do valor anterior p/ o novo for so questao
			* de arredondamento (<= 0.02) nao considerar novo calculo
			* MOTIVO : Os vendedores arredondam os precos e o recalculo do
			*		sistema os forcaria a redigitar os precos
			*------------------------------------------------------------*
			 LNtmpdif = ABS(LNvlrvenda  - LNauxVlr)

	
			 IF LNtmpdif > 0.50	OR  (LNauxVlr <= 1 AND LNtmpdif > 0.02)

			 *IF LNtmpdif > 0.50	OR  LNauxVlr  = 0
			     LNvlrvenda  = LNauxVlr
				 IF LNqtde > 0
					 LNprc_final= ROUND(LNauxVlr / LNqtde,2)
					 LNvlrvenda = LNprc_final * LNqtde	&& calc.arredondado
				 ELSE
					 LNprc_final  = LNauxVlr
				 ENDIF
			ENDIF

		CASE LSinformado ="DADO PRECO FINAL (PRECOFINAL)"
		     LNauxVlr  = LNpreco
		     LNauxVlr  = LNauxVlr + ROUND(LNauxVlr * ROUND(LNtaxa/ 100,4),2)
		     LNperct   = LNauxVlr - LNprc_final
			 IF LNauxVlr <> 0
			     LNdesc = ROUND(ROUND(LNperct * 100,2) / LNauxVlr,2)
				 IF LNpreco < 0.20
					LNdesc 	= 0
					LNpreco  	= LNprc_final
				 ENDIF
			 ELSE
			     LNdesc = 0
			     LNpreco    = LNprc_final
			 ENDIF
			 *--==============================>>> CALC. DESCONTO REAL
			 LNvlrvenda  = LNprc_final * LNqtde

		CASE LSinformado ="DADO VALOR FINAL (VLRVENDA)"
			 DO OBJ_ALER.SPR WITH "Opcao Desativada."
			 =uperrosys()

	ENDCASE
	*----------------------------------------------------------------*
	*  Aplicacao do Desconto Adicional
	*----------------------------------------------------------------*


	*----------------------------------------------------------------*
RETURN(.T.)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3KZ           ORrecalc_OSI VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   14  º
*       º Variable:            ORrecalc_OSI                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      212                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3kz     &&  ORrecalc_OSI VALID
#REGION 8
RETURN

PROCEDURE ORrecalc_OSI
	PARAMETERS LNemp,LNorcament
	*------------------------------------------------------------*
	*  CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	*  OBJETIVO.......: Reclassificar, Recalcular e Retributar itens
	*				de um orcamento que sofreu  alteracoes
	*------------------------------------------------------------*
	*  COMENTARIO.....:
	*------------------------------------------------------------*
	*  OBS............:
	*------------------------------------------------------------*
	*  TABELAS.......:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LNorcamento:
	*		LFobriga...:
	*					 .F. => Nao obriga o Recalculo se nao houver
	*							diferencas
	*					 .T. => Obriga Recalculo Independednte de
	*							haver diferencas
	*-------------------------------------------------------------*
	*		
	*		LSinformado..: Assume PADRAO "DADO PRECO e DESCONTO"
	*                   entre as opcoes abaixo
	*		
	*						"DADO PRECO e DESCONTO"
	*						"DADO PRECO FINAL (PRECOFINAL)"
	*						"DADO VALOR FINAL (VLRVENDA)"
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*
	*------------------------------------------------------------*
	* CHAMADAS : ORatlz_clie
	*			 SCGC2.PRG   - (BTN_VAL2) / (UArotfat)
	*			 SCGC201.SCR - (CAD_BTN) / (PREP_FAT)
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	
	*------------------------------------------------------------*
	PRIVATE LSalias
	PRIVATE LForcament,LForcatmp

	LSalias = ALIAS()
	PRIVATE LNbs_TRIBUTAR		&& BASE PARA TIBUTAR
	PRIVATE LDdtpesq			&& PARA PESQUISA DE BASE IPI TRANSD

	LForcament		= NetArq("orcament")
	LForcatmp		= NetArq("orcatmp")
	*--------------------------------------------------------
    IF (LForcamento+LForcatmp) > 100000
	    DO FCHrecalc_osi
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	SELE orcament
	SET ORDER TO orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)	
	IF !FOUND()	  OR 	(LEFT(orcament.situacao,1) $ "OZ"))
		DO FCHrecalc_osi
		RETURN(.f.)
	ENDIF

	SELECT  orcatmp
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	SET NEAR OFF
	IF LNemp <> orcatmp.empresa OR LNorcament <> orcatmp.orcamento
		DO FCHrecalc_osi
		RETURN(.t.)				&& NAO EXISTEM ITENS GRAVADOS => OK
	ENDIF

    WAIT WINDOW "Os itens serao RECALCULADOS !!!!!!.  <ENTER>"

	*----------------------------------------------------------*
	*		Atualizar ORCATMP com dados alterados
	*----------------------------------------------------------*
    SELE orcatmp
	**************	PARA RECALCULAR VALORES ************
	*--------------------------------------------------------------*
	*  Este laco grava nos itens os dados que podem ter sido altera-
	* dos e que podem ter implicado em alteracao da classificaca
	*		ex: CODIGO  NAO E ALTERADO
	*			TIPO    PODE TER SIDO ALTERADO
	*			NATU_CLI .....
	*-------------------------------------------------------------*
	*-------    VARIAVEIS SERAO REDEFINIDAS NESTA ROTINA  ----*
	*---------------------------------------------------------*
	DO WHILE !EOF() AND LNemp  = orcatmp.empresa;
					 AND LNorcament	= orcatmp.orcamento
		*----------------------------------------------------------*
		=W_DEFPROC("ORCAMENT.SPR")
		=ORrecalc_item((LNemp),(LNorcament),(orcatmp.codigo),;
					 (orcatmp.ordem))
		*----------------------------------------------------------*
		SELE orcatmp
		SKIP
	ENDDO
	*-----------------------------------------------------------------*
	=ORsoma_orc(LNemp,LNorcament)
	*-----------------------------------------------------------------*
	DO FCHrecalc_osi
RETURN(.T.)


PROCEDURE FCHrecalc_osi
	=UP_fecha("orcament",LForcament)
	=UP_fecha("orcatmp" ,LForcatmp)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3L8           ORrecalc_item VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   15  º
*       º Variable:            ORrecalc_item                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      213                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3l8     &&  ORrecalc_item VALID
#REGION 8
RETURN

FUNCTION ORrecalc_item
	PARAMETERS  LNemp,LNorcament,LScdgprod,LNordem,LSinformado

	*------------------------------------------------------------*
	*  CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	*  OBJETIVO.......: Reclassificar, Recalcular e Retributar um
	*				item do orcamento que sofreu  alteracoes
	*------------------------------------------------------------*
	*  COMENTARIO.....:
	*------------------------------------------------------------*
	*  OBS............:
	*------------------------------------------------------------*
	*  TABELAS.......:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LNorcament.:
	*		LScdgprod..:
	*		LNordem....:
	*------------------------------------------------------------*
	*		LSinformado..: Indica quais dados Informados para orientar
	*						o calculo
	*----------------------------------------------------------*
	*  LSinformado	= "DADO PRECO e DESCONTO"  && Esta opcao em que
	* este era valor assumido independente de ser ou nao uma importacao
	* foi desativada em 30/12/2000 em funcao de servi‡os da IDL em que
	* o desconto vem conrrompido. por isso passou-se a adotar o
	* calculo a partir do preco final
	*----------------------------------------------------------*
	*		
	*		NA IMPORTACAO
	*				LSinformado..:
	*					Assume PADRAO "DADO PRECO FINAL (PRECOFINAL)"
	*                   	entre as opcoes pois o preco ja vem definido
	*                       desta forma o preco final deve ser mantido e
	*                       ajuste ocorre em relacao ao desconto
	*
	*
	*
	*
	*		NA OPERACAO NORMAL DE REGISTRO DE OSI
	*
	*		LSinformado..: Assume PADRAO "DADO PRECO e DESCONTO"
	*                   	entre as opcoes neste caso o juros e prazo
	*						afetam o calculo preco final
	*		
	*						"DADO PRECO e DESCONTO"
	*						"DADO PRECO FINAL (PRECOFINAL)"
	*						"DADO VALOR FINAL (VLRVENDA)"
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* CHAMADAS : ORrecalc_OSI
	*			 SCGC008.PRG - IMPORTACAO DADOS
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*

	*  ALGUMAS ROTINAS DE REGISTRO DA VENDA NAO FORAM AJUSTDAS PARA
	* PASSAR PARAMETROS SENDO ASSIM ASSUME "DADO PRECO e DESCONTO"
	
	IF TYPE("LSinformado") <> "C"
			LSinformado = "DADO PRECO e DESCONTO"
	ENDIF
	PRIVATE LSalias
	PRIVATE LForcament, LForcatmp, LFclienc
	LSalias = ALIAS()
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LForcatmp		= NetArq("orcatmp")
	LFclienc		= NetArq("clienc")
	LFtipooper		= NetArq("tipooper")
	*--------------------------------------------------------
    IF (LForcamento+LForcatmp+LFclienc+LFtipooper) > 100000
	    DO FCHitemrecalc
		RETURN(.f.)
	ENDIF

	SELE orcament
	SET ORDER TO orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)	

	STORE 0  TO  m.tp_parcela,m.prazomedio,m.taxa

	STORE 0  TO m.aliq_icms,m.aliq_ipi,m.aliq_rdu
	STORE 0  TO m.aliq_iss, m.tp_mercad, m.iva
	STORE "" TO m.cfo



***	STORE "" TO m.cst

    IF TYPE("m.cst") = "U"
  	   STORE "" TO m.cst
  	ENDIF



	*---------------------------------------------------------*


	SCATTER MEMVAR FIELDS aliq_icms,aliq_ipi,aliq_rdu

	SELE clienc
	SET ORDER TO emporca
	SEEK STR(LNemp,3)+STR(LNorcament,6)	

	SELECT tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+orcament.tipo
	IF !FOUND()
			SEEK 's'+orcament.tipo
	ENDIF

	SELE ORCATMP
	SET ORDER TO TAG orcacodigo
	SEEK STR(LNemp,3)+STR(LNorcament,6)+LScdgprod+STR(LNordem,2)

	=REGLOCK(.T.)
	GATHER MEMVAR FIELDS aliq_icms,aliq_ipi,aliq_rdu

	m.aliq_icms  =  orcament.aliq_icms	&& GERAL INFORMADA
	m.aliq_ipi   =  orcament.aliq_ipi	&& GERAL INFORMADA
	m.aliq_rdu   =  orcament.aliq_rdu
	*----------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	=ORdef_tribut((LNemp),(orcatmp.codigo),;
		(orcament.orcamento),m.aliq_icms,;
		m.aliq_ipi,m.aliq_iss,m.aliq_rdu,m.cfo,m.cst,m.tp_mercad,m.iva)

	*----------------------------------------------------*
	m.preco 	= orcatmp.preco
	m.clas_cms 	= orcatmp.clas_cms

	*----------------------------------------------------------*
	SELE orcatmp
	GATHER MEMVAR FIELDS aliq_icms,aliq_ipi,aliq_iss,aliq_rdu,;
                   cfo,cst,preco,clas_cms
	*-----------------------------------------------------*
	m.preco		= orcatmp.PRECO
	m.desconto	= orcatmp.DESCONTO
	m.precofinal= orcatmp.PRECOFINAL
	m.vlrvenda  = orcatmp.VLRVENDA
	m.desc_adici= orcatmp.DESC_ADICI
	*----------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	=ORcalc_vlres(m.preco,(orcatmp.qtde),m.DESCONTO,m.desc_adici,;
			(orcament.taxa),m.precofinal,m.vlrvenda,LSinformado)
	SELE orcatmp
	GATHER MEMVAR FIELDS preco,desconto,desc_adici,precofinal,vlrvenda
	*----------------------------------------------------------*
	STORE 0 TO m.base_iss,m.vlr_iss,m.base_calc,;
		m.vlr_icms,m.base_isent,m.base_sbbrt,m.base_subs,;
		m.icms_subs,m.base_outr,m.base_ipi,m.vlripi,m.base_isipi,;
		m.bsbr_icms
	*----------------------------------------------------------*
    *    O Numero maximo de parametros passados a uma UDF e 24
    * o vTParam aplia essa condicao (mas por questoes de facilidade o
    * vetor so e utilizado para completar os parametros excedentes)
	*----------------------------------------------------------*

	dimension vTParam[ 7 ]
	vTParam[01] = m.base_ipi
	vTParam[02] = m.vlripi
	vTParam[03] = m.base_isipi
	vTParam[04] = m.bsbr_icms
	vTParam[05] = clienc.seguimento
	vTParam[06] = m.vlr_issrtd
	vTParam[07] = clienc.subst_iss




	=W_DEFPROC("TRIBUTAR.SPR")
	=TRcalc_tribu((LNemp),(orcament.tipo),(cst),(vlrvenda),(tp_mercad),;
		(aliq_iss),(aliq_icms),(aliq_ipi),(aliq_rdu),(iva),(data),;
		(clienc.estado),(qtde),(orcatmp.codigo),;
		m.base_iss,m.vlr_iss,m.base_calc,;
		m.vlr_icms,m.base_isent,m.base_sbbrt,m.base_subs,;
		m.icms_subs,m.base_outr, vTParam)

	m.base_ipi   = vTParam[01]
	m.vlripi     = vTParam[02]
	m.base_isipi = vTParam[03]
	m.bsbr_icms  = vTParam[04]
	m.vlr_issrtd = vTParam[06]

	*----------------------------------------------------------*

	SELE orcatmp
	GATHER MEMVAR FIELDS base_iss,vlr_iss,base_calc,;
		vlr_icms,base_isent,base_sbbrt,base_subs,;
		icms_subs,base_outr,base_ipi,vlripi,base_isipi,bsbr_icms,;
		vlr_issrtd
	*----------------------------------------------------------*
    DO FCHitemrecalc
RETURN(.T.)



PROCEDURE FCHitemrecalc
	=UP_fecha("orcament" ,LForcament)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("orcatmp" ,LForcatmp)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3LP           ORsoma_orc VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   16  º
*       º Variable:            ORsoma_orc                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      214                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3lp     &&  ORsoma_orc VALID
#REGION 8
RETURN

PROCEDURE ORsoma_orc
	PARAMETERS LNemp,LNorcament,;
    		 LNvalor,LNiss,LNicms,LNipi,LNsubs,LNtot,;
    		         LNbsiss,LNbsicms,LNbsipi,LNbssubs,;
         			 LNbsisent,LNbsoutr	

	*------------------------------------------------------------*
	*  CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	*  OBJETIVO.......: Totaliza Valores do Orcamento e atribui
	*				ao Orcamento (GRAVA)
	*------------------------------------------------------------*
	*  COMENTARIO.....:
	*------------------------------------------------------------*
	*  OBS............:
	*------------------------------------------------------------*
	*  TABELAS.......:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LSorcamento:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* CHAMADAS : SCGC2.PRG - (BTN_VAL2) / (UArotfat)
	*			 SCGC201.SCR - (CAD_BTN) / (PREF_FAT)
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LSalias
	LSalias = ALIAS()
	PRIVATE LNbs_TRIBUTAR		&& BASE PARA TIBUTAR
	PRIVATE LDdtpesq			&& PARA PESQUISA DE BASE IPI TRANSD
	PRIVATE LForcament,LForcatmp
	LForcament		= NetArq("orcament")
	LForcatmp		= NetArq("orcatmp")
	*--------------------------------------------------------
    IF (LForcamento+LForcatmp) > 100000
		DO FCHsoma_osi
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
    STORE 0 TO LNvalor,LNiss,LNicms,LNipi,LNsubs,LNtot
	STORE 0 TO LNbsiss,LNbsicms,LNbsipi,LNbssubs
	STORE 0 TO LNbsisent,LNbsoutr	
	*------------------------------------------------------------*
	SELE orcament
	SET ORDER TO orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)	
	IF !FOUND() OR (LEFT(orcament.situacao,1) $ "OZ")) OR !REGLOCK()
		DO FCHsoma_osi
		RETURN(.F.)
	ENDIF

	SELECT  orcatmp
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcament,6)
	IF !FOUND()
		DO FCHsoma_osi
		RETURN(.F.)
	ENDIF

	*---------------------------------------------------------*
	DO WHILE !EOF() AND LNemp = orcatmp.empresa;
					AND LNorcament	= orcatmp.orcamento
					
		IF !left(orcatmp.situacao,1) $ "YykeZ"
			IF ORCAMENT.CH_OPERA = "1"
				LNvalor	= 	LNvalor + orcatmp.vlrvenda - orcatmp.vlripi
			ELSE
				LNvalor	= 	LNvalor + orcatmp.vlrvenda
			ENDIF			
			
			LNbsiss		=	LNbsiss	+	orcatmp.base_iss
			LNbsicms	=	LNbsicms+	orcatmp.base_calc
			LNbsipi		=	LNbsipi	+	orcatmp.base_ipi
			LNbssubs	=	LNbssubs+	orcatmp.base_subs
			LNbsisent	=	LNbsisent+	orcatmp.base_isent
			LNbsoutr	=	LNbsoutr+	orcatmp.base_outr
			

			LNiss   	= 	LNiss   + orcatmp.vlr_iss
			LNicms		=   LNicms  + orcatmp.vlr_icms
			LNipi		=   LNipi   + orcatmp.vlripi
			LNsubs		=   LNsubs  + orcatmp.icms_subs
		ENDIF
        skip
    ENDDO
	LNtot  = LNvalor + m.LNsubs + orcament.vlrfrete + ;
	 					orcament.vlrseguro + LNipi
	*------------------------------------------------------------*
	SELE orcament
	REPLACE orcament.valor 	WITH LNtot
	*------------------------------------------------------------*
	DO FCHsoma_osi
RETURN(.T.)

PROCEDURE FCHsoma_osi
	=UP_fecha("orcament",LForcament)
	=UP_fecha("orcatmp" ,LForcatmp)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3LZ           ORSelimp_osi VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   17  º
*       º Variable:            ORSelimp_osi                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      215                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3lz     &&  ORSelimp_osi VALID
#REGION 8
RETURN

FUNCTION ORSelimp_osi
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Selecional OSI que Sera  Impressa
	*------------------------------------------------------------*
	* COMENTARIO..: Serve para agregar as chamadas para
	*			  reservas feitas em SCGC201 e SCGC201A
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LForcament,LFclienc,LFclientes,LFliberacao
	PRIVATE LSalias
	LFind_cop   = .F.  && INDICA QUE A OSI E UMA COPIA
	LFalt_sit	= .f.  && INDICA A ULreg_osi se a sit ja pode ser alterada
	LFind_imp 	= .f.  && INDICA se houve impr.de itens p/ que atualiza no
					   && vias
	LFind_can 	= .f.  && INDICA que a osi esta sendo cancelada

	*------------------------------------------------------------*
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()
	*------------------------------------------------------------*

	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFclientes		= NetArq("clientes")
	LFliberacao		= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFclienc+LFclientes+LFliberacao) > 100000  && HOUVE FALHA ABERT
		DO FCHSelimp_osi
		RETURN
	ENDIF
	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH "IL", "E"	 && SITUACOES EM ORDEM										&& CRESCENTE
	*------------------------------------------------------------*
	IF LASTKEY() = 27
		DO FCHSelimp_osi
		RETURN
	ENDIF
	CLEAR TYPEAHEAD


	*----------------------------------------------------------*
	* POR CONTA DO PROJETO SPED-FISCAL NAO SERA ACEITO
	* CLIENTE SEM CPF/CNPJ E SEM MUNICIPIO VALIDO
	*----------------------------------------------------------*
	

	LValida = .t.
	=W_DEFPROC("CLIENC.SPR")
	IF CNVldaCPFCNPJ(orcament.empresa,orcament.orcamento) <> .t.
		=UPbeeps;
		(.F.,"Deve ser Informado CPF ou CNPJ Valido na OSI. <ENTER>")
		LValida = .f.
	ENDIF


	=W_DEFPROC("CLIENC.SPR")
	IF CNVldaMunicipio(orcament.empresa,orcament.orcamento) <> .t.
		=UPbeeps;
		(.F.,"Deve ser Informado MUNICIPIO-UF Valido na OSI. <ENTER>")
		LValida = .f.
	ENDIF


	=W_DEFPROC("CLIENC.SPR")
	IF CNVldaMunicipio(orcament.empresa,orcament.orcamento) <> .t.
		=UPbeeps;
		(.F.,"Deve ser Informado MUNICIPIO-UF Valido na OSI. <ENTER>")
		LValida = .f.
	ENDIF


	=W_DEFPROC("CLIENC.SPR")
	IF CNIBGENaoCadastrado(orcament.empresa,orcament.orcamento) <> .t.
		=UPbeeps;
		(.F.,"Deve ser Informado Municipio com COIGO IBGE Valido. <ENTER>")
		LValida = .f.
	ENDIF



	*----------------------------------------------------------*


	IF orcament.flgtransac = .f.
		DO OBJ_MENS.SPR WITH " O orcamento Selecionado Sofreu" +;
		" Alteracoes que Afetam Valores e Nao Foi Recalculado." +;
		CHR(13)+;
		" Reedite os Itens e Grave para Forcar o Calculo."
		LValida = .f.
	ENDIF

	IF RIGHT(orcament.situacao,1) = "F"
		WAIT WINDOW "Orc.com cred. bloq..Nao aceita esta operacao."
		LValida = .f.
	ENDIF


	IF RIGHT(orcament.situacao,1) = "D"
		WAIT WINDOW "OSI. Aguardando Liberacao de Credito. "
		LValida = .f.
	ENDIF
	IF RIGHT(orcament.situacao,1) = "H"
		WAIT WINDOW ;
			"Liberacao em outras Condicoes de Credito. Ver <8-Lib.CR>"
		LValida = .f.
	ENDIF


	IF LValida = .f.
		DO FCHSelimp_osi
		RETURN(.F.)
	ENDIF




    SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(orcament.empresa,3)+STR(orcament.orcamento,6)
	IF !FOUND() OR liberaco.situacao <> "LIBE"
		WAIT WINDOW ;
			"NÆo Conta Libera‡Æo de Credito Para OSI"
		DO FCHSelimp_osi
		RETURN
	ENDIF

	SELE orcament

	*================>>>> FICA BLOQUEADO ATE FTURAMENTO COMPLETAR .
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(orcament.empresa,3)+STR(orcament.orcamento,6)

	SELE clientes
	SET ORDER TO TAG cliente
	SEEK clienc.cliente
	IF (orcament.tp_parcela > 1 ) AND ;
		(clienc.cliente = 0 OR !FOUND("CLIENTES"))
		*------------------------------------------------------------*
		*   NÆo Serao aceitas vendas Parcelado CHEQUE ou DUPLICATA
		*	sem cadastro do cliente
		*------------------------------------------------------------*
		IF orcament.empresa <> 1 OR orcament.tp_parcela = 2 ;
			OR orcament.tp_parcela = 3
			WAIT WINDOW "Solicite o Cadastramento do Cliente .<ENTER> "
		**  SO AVISAR MAS EMITIR OSI
		**	DO FCHSelimp_osi
		**	RETURN
		ENDIF
	ENDIF

	SELE orcament

	*******************************************************************
	*        2o  - IMPRIME OSI
	*******************************************************************

	=W_DEFPROC("ORCAMENT.SPR")
	=ORimp_osi((orcament.empresa),(orcament.orcamento),"EMISSAO NORMAL OSI")
	DO FCHSelimp_osi
	UNLOCK ALL
RETURN

PROCEDURE FCHSelimp_osi
	=UP_fecha("orcament" ,LForcament)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("clientes" ,LFclientes)
	=UP_fecha("liberaco" ,LFliberacao)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	POP KEY 			&& reabilita teclas de atalho def. anteriormente
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3MC           ORimp_osi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   18  º
*       º Variable:            ORimp_osi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      216                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3mc     &&  ORimp_osi VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------------------------------------------*
* FUNCTION ORimp_osi && IMPRESSAO DA OSI
* FUNCTION ORreg_osi && REGISTRA A IMPRESSAO DA OSI PARA O ITEM
*------------------------------------------------------------*

FUNCTION ORimp_osi
	PARAMETERS LNemp,LNorcamento,LSmotivo
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Imprimir OSI
	*------------------------------------------------------------*
	* COMENTARIO..: Imprime OSI NORMAL como O CANCELAMENTO
	*			 		-O processo inclui :
	*						-IMPRESSA DA OSI
	*						-ALTERACAO DA SITUACAO DOS ITENS
	*						CONFORME A OPERACAO (EMISS/CANCELA)
	*						-ALTERACAO DA SITUACAO DA CAPA DO
	*						ORCAMENTO
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LNorcamento....: Numero do Orcamento para Processar
	*		LSmotivo.......: Motivo da Impressao da OSI
	*			LSmotivo = "EMISSAO NORMAL OSI"
	*			LSmotivo = "CANCELAMENTO OSI"
	*			LSmotivo = "COPIA OSI"
	*------------------------------------------------------------*
	*  RETORNO.....: .T.	OSI IMPRESSA
	*				 .F.	PROBLEMAS NAS IMPRESSAO DA OSI
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LFimp_Ok    && Flag para indicar se houve falha ao tentar
						&& mudar a situacao do item que ‚ feita no
						&& comando REPORT relosi2

	PRIVATE LFalt_sit 	&& PARM p/ ROTINA ORreg_osi INDICA PROC NORMA P/
						&& SITUACAO
	PRIVATE LFind_canc	&& PARA /p ROTINA ORreg_osi INDICA PROC DE
						&& CANCELAMENTO
	PRIVATE LFind_cop   && INDICA QUE A OSI E OU NAO E UMA COPIA

	PRIVATE LSsituacao  && STRING COM AS SITUACOES QUE DEVEM SER ENGLOBADAS
						&& NA IMPRESSAO DOS ITENS

	PRIVATE LForcament,LForcatmp,LFclienc,LFusuario,LFtransprt,LFtipooper

	*-----------------------------------------------------------*
	LFimp_Ok	= .t.
	LFind_cop 	= .F.  && INDICA QUE A OSI E UMA COPIA
	LFalt_sit 	= .f.  && INDICA A ULreg_osi se a sit ja pode ser alterada
	LFind_canc 	= .f.  && INDICA que a osi esta sendo cancelada
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LForcatmp		= NetArq("orcatmp")
	LFclienc		= NetArq("clienc")
	LFusuario		= NetArq("usuario")
	LFtransprt		= NetArq("transprt")
	LFtipooper		= NetArq("tipooper")
	LFgrupo			= NetArq("grupo")
	*--------------------------------------------------------
    IF (LForcament+LForcatmp+LFclienc+LFusuario+LFtransprt) > 100000
		DO FCHimp_osi
		RETURN(.f.)
	ENDIF

    IF (LFtipooper+LFgrupo) > 100000
		DO FCHimp_osi
		RETURN(.f.)
	ENDIF

	*-----------------------------------------------------------*
	DO CASE
		CASE LSmotivo = "EMISSAO NORMAL OSI"
			LFalt_sit  = .T.   && ROT. ORreg_osi deve alterar campo situacao
			LFind_canc = .F.   && nao e processo de cancelamento
			LFind_cop   = .F.  && INDICA QUE A OSI NAO E UMA COPIA
			LSsituacao	= "Ik"
		CASE LSmotivo = "CANCELAMENTO OSI"
			LFalt_sit  = .T.   && ROT. ORreg_osi deve alterar campo situacao
			LFind_canc = .T.   && nao e processo de cancelamento
			LFind_cop   = .F.  && INDICA QUE A OSI NAO E UMA COPIA
			LSsituacao	= "Ik"
		CASE LSmotivo = "COPIA OSI"
			LFalt_sit  = .T.   && ROT. ORreg_osi deve alterar campo situacao
			LFind_canc = .T.   && nao e processo de cancelamento
			LFind_cop   = .T.  && INDICA QUE A OSI E UMA COPIA
			LSsituacao	= "MY"
	ENDCASE

	*--------------------------------------------------------------------*
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		LNmtmp =UPnometmp("tmp",2)
		RUN &wp_imposi > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtosi
	*--------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	IF !FOUND()
		WAIT WINDOW "No OSI nao Localizado Para Impressao.. <ENTER>"
		DO FCHimp_osi
		RETURN(.F.)
	ENDIF
	IF !REGLOCK()
	   WAIT WINDOW "Orcamento em uso em outro ponto. Tente novamente."
	   DO FCHimp_osi
	   RETURN(.f.)
	ENDIF

	SELE tipooper
	SET ORDER TO TAG tipo
	SEEK "S"+orcament.tipo
	IF !FOUND()
		SEEK "s"+orcament.tipo
	ENDIF

	SELE clienc
	SET ORDER TO TAG emporca
	

	SELE usuario
	SET ORDER TO TAG usuario

	SELE transprt
	SET ORDER TO TAG CGC

	SELE grupo
	SET ORDER TO TAG codigo
	
	SELE orcatmp
	SET ORDER TO TAG ORCAMENTO
	SET RELATION TO  codigo  INTO grupo

	*********************************
	SELE orcatmp
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNorcamento,6)
	SET NEAR OFF
	*********************************
	*------------------------------------------------------------*
	*  INICIA GERACAO DE ARQUIVO TEMPORARIO
	*------------------------------------------------------------*
	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "TMP" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
		DO FCHimp_osi
		RETURN(.F.)
 	ENDIF		
	WAIT WINDOW ;
		"AGUARDE. Gerando Arq. Temporario.<TECLADO> = Interrompe " NOWAIT
	SELE orcatmp
	**********************************************************************
	*	SITUACAO :
	*           I => RESERVADO AGUARDAND IMPRESSAO
	*           k => FOI CANCELADA A RESERVA MAS NAO EMITIU OSI
	*  TODOS SAO ENVOLVIDOS PARA PERMITIR QUE MESMO SE O PROCESSO FOR INTER_
	*  ROMPIDO, A PROXIMA EXECUCAO FIQUE INTEGRA
	**********************************************************************
	COPY TO &LSarqtmp  FIELDS empresa,orcament.tipo, orcamento,codigo,;
					  grupo.classifica,qtde,;
					  descricao,descrcompl,ordem, ;
					  orcament.hodom,tipooper.movestq,SITUACAO ;
				FOR  (LEFT(orcatmp.situacao,1) $ LSsituacao) ;
				WHILE LNorcamento = orcatmp.orcamento ;
							AND LNemp = orcatmp.empresa
	SELE 0
	USE &LSarqtmp   ALIAS LARQtmp EXCL
	INDEX ON orcamento TAG orcamento ADDITIVE

	*------------------------------------------------------------*
	*    O numero de itens a osi (12) e completado para forcar o
	* relatorio RELOSI a passar em todas as linhas detalhe e
	* permitir a impressao de dados adicionas que acompanham estas
	* linhas (EX:  NRO.OSI/DATA/VEICULO/PLACA/ODOM/OBS)
	*------------------------------------------------------------*
	LNtot_reg = reccount()
	LNlimite  = CEILING(LNtot_reg / 12) * 12  && PROXIMO INTEIRO
	DO WHILE LNtot_reg < LNlimite
		APPEND BLANK
		=REGLOCK(.T.)
		REPLACE ORCAMENTO WITH LNorcamento && FORCA O REGISTRO PARA FICAR
									       && APOS OS REGISTROS REAIS
		LNtot_reg = LNtot_reg + 1
	ENDDO
	GO TOP
	*********************************
	SELE orcament
	SET ORDER TO TAG ORCAMENTO
	SET RELATION TO  ORCAMENTO INTO LARQtmp
	SET RELATION TO  OPERADOR INTO USUARIO ADDITIVE
	SET RELATION TO  TRANSP INTO TRANSPRT  ADDITIVE
	SET RELATION TO  STR(EMPRESA,3)+STR(ORCAMENTO,6) INTO CLIENC ADDITIVE

	SET SKIP TO LARQtmp

	SET POINT TO ","
	SET SEPARATOR  TO "."

	LNreginicio = RECNO()

	*---------------------------------------------------------------*
	ON ERROR
	REPORT FORM relosi2 ;
				WHILE orcament.orcamento = LNorcamento  AND ;
				ORreg_osi(LFimp_Ok,LFalt_sit,LFind_can) ;
					   NOCONSOLE TO PRINTER
	ON ERROR DO UPerrosys

	*--------------------------------------------------------------*
	*	Alterar situacao dos itens
	*--------------------------------------------------------------*
	SELECT orcament
	GO LNreginicio
	*---------------------------------------------------------------*
	SELE LARQtmp
	USE
	SELE orcament
	*---------------------------------------------------------------*
	****  SO PARA FECHAR ARQUIVO P/ IMP

	IF !(EMPTY(ALLTRIM(wp_impestq)))
		LNmtmp =UPnometmp("tpm",2)
		RUN &wp_impestq > &LNmtmp
	ENDIF
	SET PRINTER TO &wp_prtestq
	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO
	**************                          ************************
	SELECT orcament
	GO LNreginicio
	********
	IF LFimp_Ok = .t.
		=REGLOCK(.T.)
		DO CASE
			CASE  LSmotivo = "EMISSAO NORMAL OSI" ;
			   OR LSmotivo = "COPIA OSI"
					REPLACE situacao with "M "
			CASE LSmotivo = "CANCELAMENTO OSI"
				REPLACE situacao with "Y "   	&& OSI CANCELADA
				REPLACE dt_fat   WITH wp_dtoper	&& FICA COMO DT CANCELAMENTO
		ENDCASE
		REPLACE vias_osi WITH orcament.vias_osi + 1
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
	ENDIF
	***************************
	*------------------------------------------------------------*
	DO FCHimp_osi
	KEYBOARD CHR(4)
RETURN(.T.)

*----------------------------------------------------------*

FUNCTION ORreg_osi		&& REGISTRA A IMPRESSAO DA OSI PARA O ITEM
PARAMETERS LFimp_Ok,LFalt_sit, LFind_can

	PRIVATE LSalias
	PRIVATE LFretorno

	LFretorno   = .t.
	LFimp_Ok	= .t.
	IF EMPTY(LARQtmp.codigo) 	&& LINHA DE PREENCHIMENTO PARA COMPLETAR
								&& 12 LINHA POR OSI(APPEND  BLANK)
								&& DA ROTINA ORimp_osi
		RETURN(.T.)				
	ENDIF

	IF LFalt_sit		&& = .T. altere a sit. p/ evitar dupla impressao
		LSalias = alias()
    	SELECT orcatmp
		SET ORDER TO orcacodigo
		SEEK STR(LARQtmp.empresa,3) +;
		     STR(LARQtmp.orcamento,6) + LARQtmp.codigo + ;
		     STR(LARQtmp.ordem,2)
		IF FOUND()
			=REGLOCK(.T.)
			DO CASE
				CASE LFind_can = .t. OR LEFT(LARQtmp.situacao,1) = "k"
					REPLACE orcatmp.situacao with "Y"
				OTHERWISE
					REPLACE orcatmp.situacao with "M "
			ENDCASE
			REPLACE imp_via WITH orcament.vias_osi
			LFretorno 	= .t.
		ELSE
			LFretorno 	= .f.
			LFimp_Ok	= .F.
		ENDIF
		SELE &LSalias
	ENDIF
RETURN(LFretorno)

PROCEDURE FCHimp_osi
	=UP_fecha("orcament",LForcament)
	=UP_fecha("orcatmp" ,LForcatmp)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("usuario" ,LFusuario)
	=UP_fecha("transprt" ,LFtransprt)
	=UP_fecha("tipooper" ,LFtipooper)
	=UP_fecha("grupo" ,LFgrupo)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3MS           ORgrvavisolib VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   19  º
*       º Variable:            ORgrvavisolib                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      217                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ms     &&  ORgrvavisolib VALID
#REGION 8
return
*---------------------------------------------------------------*
FUNCTION ORgrvavisolib
	PARAMETERS LNorcamento
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Gravar em Arq. TMP o numero do orcamento que
	*			deve ser avisado a carteira para liberar credito
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNorcamento....: Nro do Orcamento para registrar Aviso
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LSfile			&& NOME DO ARQ. QUE CONTEM A HORA DA
							&& ULTIMA LIBERACAO
	PRIVATE LNctrl			&& NUMERO DO ARQ. DADO PELO S.Operacional

	LSfile = wp_dirtmp+"CTRLLIBE.TXT"
	LNctrl = FOPEN(LSfile,2)
	IF LNctrl = -1
		LNctrl = FCREATE(LSfile,0)
	ENDIF
	IF LNctrl <> -1
		LStmplib = FSEEK(LNctrl,0,0)
		LStmplib = FWRITE(LNctrl,STR(LNorcamento,6))
		=FCLOSE(LNctrl)
	ENDIF
RETURN(.t.)


****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3MT           ORleravisolib VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   20  º
*       º Variable:            ORleravisolib                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      218                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3mt     &&  ORleravisolib VALID
#REGION 8
return
*---------------------------------------------------------------*
FUNCTION ORleravisolib
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: LER em Arq. TMP o numero do orcamento que
	*			deve ser avisado a carteira para liberar credito
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*				LNnro_orc...: NUMERO DO ORCAMENTO PARA LIBERAR
	*------------------------------------------------------------*
	* EXEMPLO .....: FUNCAO UPprotege em ROTINAS.SPR
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LSfile			&& NOME DO ARQ. QUE CONTEM A HORA DA
							&& ULTIMA LIBERACAO
	PRIVATE LNctrl			&& NUMERO DO ARQ. DADO PELO S.Operacional
	PRIVATE LStmpmsg	
	PRIVATE LNnro_orc
	*------------------------------------------------------------*
	LNnro_orc	= 0

	LSfile = wp_dirtmp+"CTRLLIBE.TXT"
	LNctrl = FOPEN(LSfile,2)
	IF LNctrl = -1
		LNctrl = FCREATE(LSfile,0)
	ENDIF
	IF LNctrl <> -1
		LStmplib = FSEEK(LNctrl,0,0)
		LStmplib = FGETS(LNctrl,6)
		IF LStmplib <> "999999"
			LSmsg = "Orcamento Aguadando Liberacao ......["+LStmplib+"]"
			LNnro_orc	= INT(VAL(LStmplib))

			LStmplib = FSEEK(LNctrl,0,0)
			LStmplib = FWRITE(LNctrl,"999999")
			=FCLOSE(LNctrl)
			=UPbeeps(.T.,LSmsg,2,600)
		ENDIF
	ENDIF
	=FCLOSE(LNctrl)
RETURN(LNnro_orc)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3N8           ORTenta_Liberar VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   21  º
*       º Variable:            ORTenta_Liberar                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      219                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3n8     &&  ORTenta_Liberar VALID
#REGION 8
RETURN

FUNCTION ORTenta_Liberar
	PARAMETERS LNemp,LNosi



	=W_DEFPROC("EMPRESA.SPR")
	LSCnsltCrdt = EMGetFieldValue(wp_empresa,"CNSLT_CRDT")


    IF LSCnsltCrdt = "S"   && USAR NOVA ROTINA XML

        =ORXMLTenta_Liberar(LNemp,LNosi)

        RETURN(.T.)
    ENDIF








	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Verificar Condicoes de Credito do Cliente
	*------------------------------------------------------------*
	* COMENTARIO..: Apos a edicao dos itens e na reserva as condi-
	*			coes do orcamento sao avaliadas com objetivo de
	*			liberara a venda atraves do campo SITUACAO
	*
	* 	&& usada para prever mudanca de situacao na reserva e
	*	&& no retorno da edicao dos itens
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp.......: Empresa em questao
	*		LNosi.......: Nro do Orcamento em questao
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*
	PRIVATE LDdt_libera		&& Retorna a Data de liberacao
	PRIVATE LNlim_libera	&& Retorna o valor a praso liberado
	PRIVATE LNlmt_parcela	&& Retorna se Existe Limitacao para Duplcat
	PRIVATE LNlim_prazo		&& Retorna o usuario (neste caso o SISTEMA=0)
	PRIVATE LSsit			&& Retorna a situacao Definida pelo Processo
	PRIVATE LNtp_parcela
	
	PRIVATE LSalias
	PRIVATE LForcament,LFclienc
	*-----------------------------------------------------------*
	LSalias	= ALIAS()

	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFliberacoes	= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFclienc+LFliberacoes) > 100000
		DO FCHtenta_lib
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHtenta_lib
		RETURN(.F.)
	ENDIF
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
		DO FCHtenta_lib
		RETURN(.F.)
	ENDIF

	SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(LNemp,3)+STR(LNosi,6)

	LSsit = orcament.situacao
	*------------------------------------------------------------*
	*	Condicoes de Liberacao :
	*						a - Imediata
	*						b - Conforme Informacoes
	*
	*------------------------------------------------------------*
	DO CASE
		CASE RIGHT(LSsit,1) = "F"
			*-------------------------------------------------*
			* Situacao = "F" && CREDITO BLOQUEADO SO SERA TRATADO
			*	 DIRETAMENTE PELA OCAO <8-Lib.Cred> e nao
			* automaticamente
			*-------------------------------------------------*
		CASE orcament.tp_parcela = 1 	&& A Vista
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO

		CASE orcament.tp_parcela = 4
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO
									  	 &&  Vendas em cartao sao liberadas
									  	 && sem verificacao
		CASE FOUND("liberaco") ;
			AND orcament.valor 		<= liberaco.limite ;
			AND orcament.prazomedio	<= liberaco.prazomedio ;
			AND orcament.tp_parcela = liberaco.tp_parcela
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO
									  	 &&  Permanecendo as mesmas
									  	 && condicoes da ultima liberacao

		CASE (orcament.lmt_parcela = "S" AND orcament.tp_parcela = 3)
			LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Existe Restricao a venda
									  	 && com duplicata

		CASE ORVer_credito(clienc.cliente,  ;
				orcament.valor - orcament.vlr_ent, 0, 0,;
				    clienc.inscricao) = 0
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO
									  	 &&  NÆo havendo restricoes ao
										 && credito
		OTHERWISE
			LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Nao Existe Dados
									  	 && para liberacao
	ENDCASE

	*------------------------------------------------------------------*
	*	A rotina ORVer_credito desloca os registros de orcament para
	*	pesquisar o debito formado por osis em aberto , por isso e
	*  nescessario reposicionar o orcamento para regravar as codicoes
	*  de liberacao
	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHtenta_lib
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------------*

	SELE liberaco
	IF  RIGHT(LSsit,1) = "E"  && FOI LIBERADO
		m.data 		= 	wp_dtoper
		m.liberador =	0		&& SISTEMA
		m.tp_parcela= 	orcament.tp_parcela
		m.validade	=	wp_dtoper + 30
		m.situacao  =  "LIBE"
		m.limite 	=   orcament.valor - orcament.vlr_ent		
		m.prazomedio=   orcament.prazomedio


		IF FOUND("liberaco")
			IF liberaco.limite > orcament.valor - orcament.vlr_ent		
				m.limite 	= 	liberaco.limite
			ENDIF
			IF liberaco.prazomedio >   orcament.prazomedio
				m.prazomedio=   liberaco.prazomedio
			ENDIF
			=edithand('REGRAVA')
		ELSE
			m.empresa 	= 	orcament.empresa
			m.orcamento	=	orcament.orcamento
			m.limite 	= 	orcament.valor - orcament.vlr_ent		
			m.prazomedio=   orcament.prazomedio
			=edithand('SAVE')
		ENDIF
	ELSE
		m.situacao  =  "BLOQ"
		IF FOUND("liberaco")

			SET FIELDS TO situacao	&& SO ALTERAR CAMPO SITUACAO
									&& OS DEMAIS PERMANECEM
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
		ENDIF
	ENDIF

	SELE orcament
	m.situacao   = LSsit
	SET FIELDS TO situacao, dtregis, hregis, usrregis, deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------------*
	DO FCHtenta_lib

RETURN(.T.)


PROCEDURE FCHtenta_lib
	=UP_fecha("orcament",LForcament)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("liberaco" ,LFliberacoes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3NL           ORimp_orca VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   22  º
*       º Variable:            ORimp_orca                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      220                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3nl     &&  ORimp_orca VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION ORimp_orca
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Relacao dos itens de OSI
	*------------------------------------------------------------*
	* COMENTARIO..:  Relaciona itens da OSI
	*				Util no caso de OSIs DE CONTROLE INTERNO
	*				TIPO MERCADORIA DANIFICADA E OUTROS
	*
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LNorcamento....: Numero do Orcamento para Processar
	*------------------------------------------------------------*
	*  RETORNO.....: .T.	OSI IMPRESSA
	*				 .F.	PROBLEMAS NAS IMPRESSAO DA OSI
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*------------------------------------------------------------*
	LFalt_sit	= .f.  && INDICA A ULreg_osi se a sit ja pode ser alterada
	LFind_imp 	= .f.  && INDICA se houve impr.de itens p/ que

	PRIVATE LForcament,LForcatmp,LFclienc,LFusuario,LFtransprt
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	*--------------------------------------------------------
    IF (LForcament) > 100000
		DO FCHimp_orca
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH "ABCDEFGHIJKLMNOPQRSTUVXWYZ",.F.
							 && SITUACOES EM ORDEM
							 && CRESCENTE
	*------------------------------------------------------------*

	IF LASTKEY() = 27 OR EOF()
		DO FCHimp_orca
		RETURN(.F.)
	ENDIF
	
	IF m.valor = 0
		IF !fox_alert("Orcamento com VALOR = 0. [ Continua ? ]")
			DO FCHimp_orca
			RETURN(.F.)
		ENDIF
	ENDIF

	LForcatmp		= NetArq("orcatmp")
	LFclienc		= NetArq("clienc")
	LFusuario		= NetArq("usuario")
	LFtransprt		= NetArq("transprt")

	*--------------------------------------------------------*

    IF (LForcatmp+LFclienc+LFusuario+LFtransprt) > 100000
		DO FCHimp_orca
		RETURN(.f.)
	ENDIF

	SELE orcament
	***************  IMPRESSAO OSI  **********************
	IF !(EMPTY(ALLTRIM(wp_imporc)))
		RUN &wp_imporc > \TMP\SAIDA.TXT
	ENDIF
	SET PRINTER TO &wp_prtorc

	SELE clienc
	SET ORDER TO TAG emporca

	SELE transprt
	SET ORDER TO TAG CGC

	SELE orcatmp
	SET ORDER TO TAG ORCAMENTO
	******>>>> INICIO CONTROLE ARQUIVOS
	wl_arqtmp = ""
	LNtmp     = 65		&& TABELA ASCII A = 65
	IF !UPabretmp("tmp")
		WAIT WINDOW "Nao Foi Possivel Abrir Arq. Temporario. <ENTER>"
		DO FCHimp_orca
		RETURN(.F.)
	ENDIF
	******>>>> INICIO CONTROLE LOCAL

	SELECT  orcatmp
	SET ORDER TO TAG  orcamento
	SET NEAR ON
	IF "TIPO" $ KEY()
		SEEK STR(orcament.empresa,3)+LEFT(orcament.tipo,1);
				+STR(orcament.orcamento,6)
	ELSE
		SEEK STR(orcament.empresa,3)+STR(orcament.orcamento,6)
	ENDIF
	SET NEAR OFF
	***
	SET SAFET OFF
	LStmp = "\TMP\"+"&wl_arqtmp"
	COPY TO &LStmp 	WHILE  orcament.empresa = orcatmp.empresa ;
						AND orcament.orcamento = orcatmp.orcamento
	SELE 0
	USE "\TMP\"+"&wl_arqtmp" ALIAS TMPORCA exclu
	INDEX ON STR(EMPRESA,3)+STR(ORCAMENTO,6)  TAG orcamento ADDITIVE
	*-----------------------------------------------------------------*
	*   PREPARAR MODO DE SELECAO
	*-----------------------------------------------------------------*

	SELE orcament
	SET ORDER TO TAG ORCAMENTO
	SET RELATION TO  STR(EMPRESA,3)+STR(ORCAMENTO,6) INTO tmporca
	SET RELATION TO  TRANSP INTO TRANSPRT ADDITIVE
	SET RELATION TO  STR(EMPRESA,3)+STR(ORCAMENTO,6) INTO CLIENC ADDITIVE

	SET SKIP TO tmporca
	SET POINT TO ","
	SET SEPARATOR  TO "."

	LNreginicio = RECNO()
	m.ordem = "A"
	ON ERROR
	REPORT FORM relorca ;
			  WHILE orcament.orcamento = m.orcamento ;
			  AND orcament.empresa = wp_empresa NOCONSOLE TO PRINTER
	ON ERROR DO UPerrosys
	GO LNreginicio
	******************************************************
	SELE tmporca
	use
	SELE orcament
	****  SO PARA FECHAR ARQUIVO P/ IMP
	IF !(EMPTY(ALLTRIM(wp_imposi)))
		RUN &wp_imposi > \TMP\SAIDA.TXT
	ENDIF
	SET PRINTER TO &wp_prtosi

	SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO

	*********************************************************
	SELECT orcament
	GO LNreginicio
	DO FCHimp_orca
	*------------------------------------------------------------*
RETURN(.T.)

PROCEDURE FCHimp_orca
	=UP_fecha("orcament",LForcament)
	=UP_fecha("orcatmp" ,LForcatmp)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("usuario" ,LFusuario)
	=UP_fecha("transprt" ,LFtransprt)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3NV           ORVer_credito VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   23  º
*       º Variable:            ORVer_credito                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      221                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3nv     &&  ORVer_credito VALID
#REGION 8
RETURN

FUNCTION ORVer_credito	&& FUNCAO PARA VERIFICACAO DE CREDITO DO CLIENTES
	PARAMETER LNcgc, LNvlr, LNvlrdb, LNvlrorca,PrmInscricao
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Verificar Condicoes de Credito do Cliente
	*------------------------------------------------------------*
	* COMENTARIO..: Apura o saldo da crteira de Cobranca
	*				Apura o valor de orcamentos em aberto para
	*			o cliente sem considerar valores avista ou entradas
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*			LNcgc....: Cliente para Pesquisa
	*			LNvlr....: Valor do Orcamento que se quer atender
	*			LNvlrdb..: Para Retorna Debito em Cobranca
	*			LNvlrorca: Para Retorna Vlr de Orcamentos pendentes
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*			LNretorno = 0 && 0=> Sem Restricoes
	*			LNretorno = 1 && 1=> Consulta nao realizada
	*			LNretorno = 2 && 2=> Sem movimento a + de 12 meses
	*			LNretorno = 3 && 3=> Credito insuficiente
	*			LNretorno = 4 && 4=> Titulo Vencido a Mais de 5 dias
	*			LNretorno = 5 && 5=> Med. Atrazo > 15 dias nas ult.10
	*			LNretorno = 6 && 6=> Orc.abertos + deb superam limite
	*			LNretorno = 7 && 7=> Atualizar Cadastro
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
		=W_DEFPROC("rotinas.spr")

		PRIVATE LSalias



		PRIVATE	LFclientes,LFclienc,LFduplicat,LForcament	
		PRIVATE	LNretorno
		PRIVATE	LN_numdp,LN_dias,LN_med,LN_saldo_dp,LN_ultima10
		PRIVATE LNregosi	&& Nro do registro do orcamento na
							&& entrada da rotina e antes de deslocar
							&& os orcamentos para apurar o valor
							&& de osis em aberto
		PRIVATE LStmp
		
		LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
		*--------------------------------------------------------
		LNretorno 		= 0 && 0=> Sem restricoes
		LNvlrorca 		= 0  && ORCAMENTOS APROVADOS				
		LNvlrdb 		= 0	&& DEBITO ACUMULADO
		*--------------------------------------------------------
		LN_numdp 		= 0	&& NUMERO DE TITULOS
		LN_dias  		= 0    && ACM. DE DIAS DE ATRAZO
		LN_med	 		= 0	&& MEDIA DE ATRAZO POR DUP
		LN_saldo_dp 	= 0	&& SALDO RESTANTE DA DUPLICATA
		LN_ultima10 	= 0 && CONTA AS ULTIMAS 10 DUPLICATAS
		LN_diasAtlzCad  = 0 && Dias da Atualiza‡Æo do cadastro
		*--------------------------------------------------------


		LNregosi = 0

		LFclientes		= NetArq("clientes")
		LFduplicat		= NetArq("duplicat")
		LForcament		= NetArq("orcament")
		LFclienc		= NetArq("clienc")

		IF (LFclientes+LFclienc+LFduplicat+LForcament) > 100000
			LNretorno = 1 && 1=> Consulta nao realizada
			DO 	ORfchVer_credito
			RETURN(LNretorno)
		ENDIF
		*--------------------------------------------------------
		SELE orcament
		LNregosi = RECNO()
		*--------------------------------------------------------
		SELE clientes
		SET ORDER TO TAG clie_inscr
		SEEK STR(LNcgc,14)+PrmInscricao
		IF !FOUND()
			LNretorno = 1 && 1=> Consulta nao realizada
			DO 	ORfchVer_credito
			RETURN(LNretorno)
		ENDIF
		*--------------------------------------------------------
		IF EMPTY(clientes.dtliberacd)
			LN_diasAtlzCad = 999999
		ELSE
			LN_diasAtlzCad = date() - clientes.dtliberacd
		ENDIF
		*--------------------------------------------------------

		*--------------------------------------------------------

		SELE duplicat
		SET ORDER TO TAG doc_clie
		SET NEAR ON
		SEEK STR(LNcgc + 1  ,14)  && 1a do proximo cliente
		SET NEAR OFF
		IF EOF()
			GO BOTT
		ELSE
			SKIP -1
		ENDIF
		*--------------------------------------------------------
		*   DETERMINA O VALOR COMPROMETIDO EM ORCAMENTOS
		*--------------------------------------------------------

		SELE orcament
		SET ORDER TO TAG orcamento

		SELE clienc
		SET ORDER TO TAG cliente
		SET NEAR ON
		SEEK LNcgc+1
		SET NEAR OFF
		IF clienc.cliente <>  LNcgc
			SKIP -1
		ENDIF		


		IF clienc.cliente =  LNcgc
			DO WHILE !BOF() AND LNcgc = clienc.cliente

				IF clienc.inscricao = PrmInscricao
					SELE orcament
					SET ORDER TO TAG orcamento
					SEEK STR(clienc.empresa,3)+STR(clienc.orcamento,6)
					IF FOUND() AND !(LEFT(orcament.situacao,1) $ "AOZY")
						LStmp = CHRTRAN(STR(orcament.tp_parcela,2)," ","0")
						IF LStmp $ ("02/03/")  && CHQ.A PRAZO / DUPLICATA
						   LNvlrorca=LNvlrorca+;
						      (orcament.valor-orcament.vlr_ent)
						ENDIF
					ENDIF
				ENDIF
				SELE clienc
				SKIP -1
			ENDDO
		ENDIF
		*--------------------------------------------------------
		SELE duplicat
		DO WHILE !EOF() AND !BOF() AND LNcgc = cliente

			IF EMPTY(DT_PGTO) AND ((wp_dtoper - DT_VENC) > 5)
				LNretorno = 4 && 4=> Titulos vencidos em aberto
			ENDIF

			LN_saldo_dp =vlr_doc - abatimento - desconto - vlr_pgto

			IF !EMPTY(DT_PGTO)		
				IF  LN_ultima10 < 10   && VALIDO P/ ULTIMAS 10 PGAS
					LN_ultima10 = LN_ultima10  + 1	
					LN_numdp= LN_numdp + 1	
					LN_dias = LN_dias + dt_pgto - dt_venc
					LN_med  = LN_dias / LN_numdp
				ENDIF
			ELSE
				LNvlrdb = LNvlrdb + LN_saldo_dp
			ENDIF
			SKIP -1
		ENDDO
		*--------------------------------------------------------
		DO CASE

			CASE clientes.natureza = 0 AND LN_diasAtlzCad > 360
			    && varejo  12 meses
				LNretorno = 7 && 7=> Atualizar Cadastro
			CASE clientes.natureza = 1 AND LN_diasAtlzCad > 90
			    && REVENDA 3 meses


				LNretorno = 7 && 7=> Atualizar Cadastro
			CASE clientes.natureza = 2 AND LN_diasAtlzCad > 180
			    && P PUBLICO 6 meses
				LNretorno = 7 && 7=> Atualizar Cadastro
			CASE clientes.natureza = 3 AND LN_diasAtlzCad > 180
			    && FROTA 6 meses
				LNretorno = 7 && 7=> Atualizar Cadastro


			CASE (wp_dtoper - clientes.ult_atend) > 365
				LNretorno = 2 && 2=> Sem movimento a + de 12 meses

			CASE LNretorno = 4 && 4=> Titulos vencidos em aberto
				LNretorno = 4 && 4=> Titulos vencidos em aberto
			CASE LNvlr > clientes.credito
				LNretorno = 3 && 3=> Credito insuficiente
			CASE LNvlrdb + LNvlr > clientes.credito
				LNretorno = 3 && 3=> Credito insuficiente
			CASE LNvlrdb + LNvlr + LNvlrorca > clientes.credito
				LNretorno = 6 && 6=> Orc.abertos + deb superam limite
			CASE LN_med > 15
				LNretorno = 5 && 5=> Med. Atrazo > 15 dias nas ult.10
		ENDCASE
		*---------------------------------------------------------*
		DO 	ORfchVer_credito
	RETURN(LNretorno)

	PROCEDURE ORfchVer_credito
		SELE orcament
		IF LNregosi > 0
			GO LNregosi
		ENDIF
		=UP_fecha("clientes" ,LFclientes)
		=UP_fecha("clienc" ,LFclienc)
		=UP_fecha("duplicat" ,LFduplicat)
		=UP_fecha("orcament" ,LForcament)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
	RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3O8           ORSelreserva VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   24  º
*       º Variable:            ORSelreserva                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      222                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3o8     &&  ORSelreserva VALID
#REGION 8
RETURN

FUNCTION ORSelreserva
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Selecional OSI que Sera  Reservada
	*------------------------------------------------------------*
	* COMENTARIO..: Serve para agregar as chamadas para
	*			  reservas feitas em SCGC201 e SCGC201A
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")


	PRIVATE LValida
	PRIVATE LSorcament
	PRIVATE LSalias

	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	*--------------------------------------------------------
    IF (LForcament) > 100000  && HOUVE FALHA ABERT
		DO FCHSelReserva
		RETURN
	ENDIF
	*------------------------------------------------------------*

	*------------------------------------------------------------*

	=W_DEFPROC("AUTOPROC.SPR")
	=APTempGeral()

	*------------------------------------------------------------*

	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH "AEFG"	 && SITUACOES EM ORDEM										&& CRESCENTE
	*------------------------------------------------------------*
	IF LASTKEY() <> 27
	

		*----------------------------------------------------------*
	
		CLEAR TYPEAHEAD
		IF RIGHT(orcament.situacao,1) = "F"
			WAIT WINDOW "Orc.com cred. bloq..Nao aceita esta operacao."
		ELSE
			IF orcament.flgtransac = .f.
				DO OBJ_MENS.SPR WITH " O orcamento Selecionado Sofreu" +;
				" Alteracoes que Afetam Valores e Nao Foi Recalculado." +;
				CHR(13)+;
				" Reedite os Itens e Grave para Forcar o Calculo."
			ELSE
				IF fox_alert('Confirma a Reserva de Mercadoria.' )
					*----------------------------------------------------*
					=ORreserva(orcament.empresa,orcament.orcamento)
					*----------------------------------------------------*
				ENDIF
			ENDIF
		ENDIF
	ENDIF
	DO FCHSelReserva
RETURN

PROCEDURE FCHSelReserva
	=UP_fecha("orcament" ,LForcament)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	POP KEY 			&& reabilita teclas de atalho def. anteriormente
	UNLOCK ALL
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3O9           ORSelcancreserva VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   25  º
*       º Variable:            ORSelcancreserva                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      223                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3o9     &&  ORSelcancreserva VALID
#REGION 8
RETURN

FUNCTION ORSelcancr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Selecional OSI que tera a reserva Cancelada
	*------------------------------------------------------------*
	* COMENTARIO..: Serve para agregar as chamadas para cancelamento
	*			de  reservas feitas em SCGC201 e SCGC201A
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias, LForcament
	
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	*--------------------------------------------------------
    IF (LForcament) > 100000  && HOUVE FALHA ABERT
		DO FCHSelCancReserva
		RETURN
	ENDIF
	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH "GI" && SITUACOES EM ORDEM CRESCENTE
	*------------------------------------------------------------*
	IF LASTKEY() <> 27
		CLEAR TYPEAHEAD
		IF fox_alert('Confirma Cancelamento de Reserva ? ')
			*------------------------------------------------------------*
			=ORcancreserva(orcament.empresa,orcament.orcamento)
			*------------------------------------------------------------*
		ENDIF
	ENDIF
	*------------------------------------------------------------*
	DO FCHSelCancReserva
RETURN

PROCEDURE FCHSelCancReserva
	=UP_fecha("orcament" ,LForcament)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	UNLOCK ALL
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3OP           ORreserva VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   26  º
*       º Variable:            ORreserva                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      224                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3op     &&  ORreserva VALID
#REGION 8
RETURN
FUNCTION ORreserva
	PARAMETER LNemp,LNosi
	*------------------------------------------------------------*
	* CLASSIFICACAO:  []
	*------------------------------------------------------------*
	* OBJETIVO....: Controla o Processo de  Reserva
	*			de Uma OSI
	*------------------------------------------------------------*
	* COMENTARIO..: Conforme os parameros passados esta rotina
	*			posiciona no orcaento e controla a reserva
	*			dos itens da osi informada
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*			LNemp.......:  Empresa em Processo
	*			LNosi.......:  Orcamento Originario da Reserva
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias, LForcament, LForcatmp, LFtipooper
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LForcatmp		= NetArq("orcatmp")
	LFtipooper		= NetArq("tipooper")
	*--------------------------------------------------------
    IF (LForcament+LForcatmp+LFtipooper) > 100000  && HOUVE FALHA ABERT
		DO FCHReserva
		RETURN(.F.)
	ENDIF

	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
		DO FCHReserva
		RETURN(.F.)
	ENDIF

	IF !REGLOCK()
	   WAIT WINDOW "Orcamento em uso em outro ponto. Tente novamente."
		DO FCHReserva
		RETURN(.F.)
	ENDIF


	SELECT  orcatmp
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(orcament.empresa,3)+STR(orcament.orcamento,6)
	SET NEAR OFF

	IF orcament.empresa <> orcatmp.empresa ;
		OR orcament.orcamento <> orcatmp.orcamento
		DO FCHReserva
		RETURN(.F.)
	ENDIF

	LFflgtrans = .t.
	LFflgreser = .t. 	&& ALTERAR STATUS P/ D=RESERVA
	LFflgretod = .t. 	&& IGNORA CONFIRMACOES POR ITEM
	LFflgretod = .t.    && antes tinha opc.t. e.f.fox_alert
						&& ("Reservar todos ?")
	LNordemmenos = 0    && reordena os itens que ficam abaixo de item
						&& ELIMINADO


	****  && LIBERACAO DE CRED
	SELE orcament
	LNregorc = RECNO()  	&& PARA REPOSICIONAR EM ORCAMENTO
	*---------------------------------------------------------------*
	* 	LSprograma ‚ uma variavel publica recebida como parametro em
	* SVD2 e que identifica a forma de operacao do sistema de
	* faturamento
	*	 	LSprograma = "VENDA"
	*		LSprograma = "BALCAO"
	*		LSprograma = "BALCAO-2"
	*---------------------------------------------------------------*
	IF ("BALCAO" $ LSprograma)  && FATURISTA NAO TESTA CREDITO DO CLIENTE
		*---------------------------------------------------------------*
		=W_DEFPROC("orcament.spr")
		IF !ORTenta_Liberar(orcament.empresa,orcament.orcamento)
			*-----------------------------------------------------*
		   	WAIT WINDOW ;
		   	"Nao foi possivel verificar criterios de liberacao."+;
		   		" Tente novamente."
			DO FCHReserva
			RETURN(.F.)
		ENDIF
	ENDIF
	*-------------------------------------------------------------------*
	* REPOSICIONA ORCAMENT POR CAUSA DE DESLOCAMENTO DE REGST. EM VER_CR
	*-------------------------------------------------------------------*

	SELE orcament
	SET ORDER TO tag orcamento
	GO LNregorc
	IF !REGLOCK()
	   	WAIT WINDOW "Orcamento em uso em outro ponto. Tente novamente."
		DO FCHReserva
		RETURN(.F.)
	ENDIF
	****************************************
	SELECT  orcatmp
	DO WHILE !eof() AND orcament.orcamento = orcatmp.orcamento ;
					AND orcament.empresa  = orcatmp.empresa

	   WAIT WINDOW "ITEM => "+STR(orcatmp.ordem,2) NOWAIT
		************************************************************
		*   SITUACAO :												*
		*		A = > RESERVAR ITEM NOVO							*
		*		y = > ITEM CANCELADO 								*
		*		E = > ALTERAR A RESERVA ANTERIOR					*
		*		e = > ELIMINAR ITEM COM RESERVA DO ORCAMENTO		*
		************************************************************

	   IF LEFT(orcatmp.situacao,1) $ 'AyEeI' 		&& aprov
		  wp_msg = 'Reservar => '+STR(orcatmp.qtde,5)+" "+;
			  		alltrim(orcatmp.codigo)+" "+orcatmp.descricao
		  IF LFflgretod OR fox_alert(wp_msg)
			*----------------------------------------------------------*
		   	PRIVATE LFlockReg
			PRIVATE LFabreAuto
		   	LFlockReg	= .T.	&& BLOQUEAR REGISTRO
		    LFabreAuto	= .F. 	&& NAO ABRIR CONTROLE AUTOMATICAMENTE
			SELE tipooper
			SELECT tipooper
			SET ORDER TO TAG tipo
			SEEK 'S'+orcament.tipo
			IF !FOUND()
				SEEK 's'+orcament.tipo  	
			ENDIF

			SELE orcament						
			=W_DEFPROC("ESTOQUE.SPR")
			IF ESversaldo(orcatmp.empresa,orcatmp.codigo ,;
				wp_dtoper,orcatmp.qtde,orcatmp.qtderes,LFabreAuto,;
				LFlockReg,"RESERVA",orcament.hora_fat,tipooper.movestq)
				*------------------------------------------------------*
    		     SELECT orcatmp
        		 IF REGLOCK()
					LSprocesso	= 	""
					DO CASE
						CASE LEFT(orcatmp.situacao,1) $ 'e'
		            		LSprocesso		=  "ELIMINA"
							LNordemmenos = LNordemmenos + 1
						CASE LEFT(orcatmp.situacao,1) $ 'y'
			            	LSprocesso		=	"ANULA"
						CASE LEFT(orcatmp.situacao,1) $ 'I'
						    IF  LNordemmenos > 0
			    	        	LSprocesso	=	"RESERVA"
							ENDIF
						OTHERWISE
			            	LSprocesso	=  "RESERVA"
					ENDCASE
					IF !EMPTY(LSprocesso)
						*------------------------------------------*
						=W_DEFPROC("ORCAMENT.SPR")
						IF !ORprocreserva_item(orcatmp.empresa,;
							orcament.tipo,orcatmp.orcamento,;
							orcatmp.codigo,orcatmp.ordem, LSprocesso)

							LFflgtrans = .F.

	 					ENDIF
						*------------------------------------------*
					ENDIF
    	    	 ELSE
					LFflgtrans = .F.
					*EXIT
	 			 ENDIF
	    	  ELSE
				LFflgtrans = .F.
				*EXIT
	    	  ENDIF
    	  ENDIF
		  UNLOCK
	   ENDIF
       SELECT  orcatmp
	   SET ORDER TO TAG orcamento
	   SKIP
	ENDDO
	WAIT WINDOW " OK !" NOWAIT

	IF LFflgtrans = .F.
		SELE orcament
		IF LEFT(orcament.situacao,1) $ "AG"
		 	m.situacao 	= "G"+RIGHT(orcament.situacao,1)
		 	                     && Aguarda Res Complementar
			SET FIELDS TO dtregis, hregis, usrregis,deletado
			SET FIELDS TO situacao, dt_res, hora_res
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
		ENDIF		
		DO OBJ_MENS.SPR WITH chr(13)+;
				"    Houve falha no Processo de Reserva."+chr(13)+chr(13)+;
				"           Repita o Comando."

		*--------------------------------------------------------
		DO FCHReserva
		UNLOCK ALL
		RETURN(.F.)
	ENDIF

	SELECT orcament
	DO CASE
		CASE LEFT(orcament.situacao,1) = "F"  && aguard res. osi comple.
	 		m.situacao 	= "L"+RIGHT(orcament.situacao,1)
	 		                                  && aguard imp. osi comple

		CASE LEFT(orcament.situacao,1) $ "EGA"  && aguard res. comple.
		 	m.situacao 	= "I"+RIGHT(orcament.situacao,1)
		 	                                  && reserva integral
	ENDCASE
	m.dt_res   	= wp_dtoper
	m.hora_res 	= time()
	IF !(RIGHT(orcament.situacao,1)) $ "DF"		
	                                 && CREDITO LIBERADO..........
		IF orcament.usr_libera = 9999 OR (EMPTY(orcament.lim_libera);
				 AND EMPTY(orcament.dt_libera))
			m.dt_libera  = wp_dtoper
			m.lim_libera = orcament.valor
			m.lim_prazo  = orcament.prazomedio
			m.usr_libera = 9999
		ENDIF
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO   situacao, dt_res, hora_res, dt_libera, ;
					lim_libera,lim_prazo,usr_libera
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ELSE
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO situacao, dt_res, hora_res
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		*------------------------------------------------------------*
		=W_DEFPROC("ORCAMENT.SPR")
		=ORgrvavisolib(orcament.orcamento)	&& AVISAR PARA LIBERAR
		*------------------------------------------------------------*
	ENDIF
	*--------------------------------------------------------
	DO FCHReserva
	UNLOCK ALL
RETURN(.T.)


PROCEDURE FCHReserva
	=UP_fecha("orcament" ,LForcament)
	=UP_fecha("orcatmp" ,LForcatmp)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3P3           ORcancreserva VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   27  º
*       º Variable:            ORcancreserva                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      225                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3p3     &&  ORcancreserva VALID
#REGION 8
RETURN

FUNCTION ORcancreserva
	PARAMETER LNemp,LNosi
	*------------------------------------------------------------*
	* CLASSIFICACAO:  []
	*------------------------------------------------------------*
	* OBJETIVO....: Controla o Processo de Cancelamento de Reserva
	*			de Uma OSI
	*------------------------------------------------------------*
	* COMENTARIO..: Conforme os parameros passados esta rotina
	*			posiciona no orcaento e controla o cancelamento
	*			dos itens da osi informada
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*			LNemp.......:  Empresa em Processo
	*			LNosi.......:  Orcamento Originario da Reserva
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF

	IF !REGLOCK()
	   WAIT WINDOW "Orcamento em uso em outro ponto. Tente novamente."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
	    RETURN(.f.)
	ENDIF

	SELECT  orcatmp
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(orcament.empresa,3)+STR(orcament.orcamento,6)
	SET NEAR OFF
	IF orcament.empresa <> orcatmp.empresa ;
		OR orcament.orcamento <> orcatmp.orcamento
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
	    RETURN
	ENDIF

	LFflgtrans = .t.
	LFflgreser = .t.
	LFflgretod = .t.	&& IGNORA CONFIRMACOES POR ITEM
	LFflgretod = fox_alert("Cancelar Reservas de todos itens ?")

	LNordemmenos = 0  && reordena os itens que ficam abaixo de item
					  &&  ELIMINADO
	DO WHILE !eof() AND orcament.orcamento 	= orcatmp.orcamento ;
					AND orcament.empresa 	= orcatmp.empresa
   		WAIT WINDOW "ITEM => "+STR(orcatmp.ordem,2) NOWAIT

		IF LEFT(orcatmp.situacao,1) $ 'GI' 			&& possui.res

			  wp_msg = 'Cacela Reserva de => '+STR(orcatmp.qtde,5)+" "+;
				  		alltrim(orcatmp.codigo)+" "+orcatmp.descricao
		  IF LFflgretod or fox_alert(wp_msg)
			*----------------------------------------------------------*
		   	PRIVATE LFlockReg
			PRIVATE LFabreAuto
		   	LFlockReg	= .T.	&& BLOQUEAR REGISTRO
		    LFabreAuto	= .F. 	&& NAO ABRIR CONTROLE AUTOMATICAMENTE

	   	     SELECT orcatmp
        	 IF REGLOCK()
				*------------------------------------------*
				=W_DEFPROC("ORCAMENT.SPR")
				IF !ORprocreserva_item(orcatmp.empresa,;
					orcament.tipo,orcatmp.orcamento,;
					orcatmp.codigo,orcatmp.ordem, "CANCELA")
					LFflgtrans = .F.
					EXIT
 				ENDIF
				*------------------------------------------*
	         ELSE
				LFflgtrans = .F.
				EXIT
	 		 ENDIF
		  ELSE
			  LFflgreser = .F.   && MANTER O ESTATUS DE RESERVA
		  ENDIF
	   ENDIF
   	   SELECT  orcatmp
	   SET ORDER TO TAG orcamento
	   SKIP
	ENDDO
	WAIT WINDOW " OK ! " NOWAIT

	SELECT orcament
	IF LFflgtrans AND  LFflgreser
		REPLACE situacao WITH "A "
		REPLACE dt_res   WITH CTOD('  .  .  ')
		REPLACE hora_res WITH '        '
	ELSE
		WAIT WINDOW "Processo NAO FOI concluido."
	ENDIF
	*--------------------------------------------------------
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	unlock all
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3PD           ORprocreserva_item VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   28  º
*       º Variable:            ORprocreserva_item                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      226                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3pd     &&  ORprocreserva_item VALID
#REGION 8
RETURN

FUNCTION ORprocreserva_item
	PARAMETER LNemp,LStipo,LNosi,LScodigo,LNordem, LSoperacao
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Processar Insercao ou Cancelamento de Reservas
	*------------------------------------------------------------*
	* COMENTARIO..: Antiga ( UAreserva ) Esta rotina localiza o
	*			registro de ITEMMOV equivalente a RESERVA que esta
	*			sendo inserida ou excluida e processa adequadamente
	*           conforme a solicitacao
	*				A rotina trabalha nas tabelas ITEMMOV e ORCATMP
	*			conforme o parametro da operacao solicitada
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*			LNemp.......:  Empresa em Processo
	*			LStipo......:  Tipo da Operacao
	*			LNosi.......:  Orcamento Originario da Reserva
	*			LScodigo....:  Codigo do Produto p/ montar chave
	*			LNordem.....:  Ordem do Produto em orcatmp
	*			LSoperacao..:  Processo solicitado
	*				"RESERVA"...: Processar Reserva
	*				"CANCELA"...: Cancela Reserva mas mantem registro em
	*								ORCATMP e em SITUACAO = "A"
	*									(QUANDO OSI NAO  FOI EMITIDA
	*									ESTANDO SOMENTE EM RESERVA OSI)
	*				"ELIMINA"...: Cancela Reserva e Elimina registro em
	*								ORCATMP (QUANDO PROGRAMA PARA DESABILI
	*								TAR RESERVA NAO LOCALIZA A CAPA DO
	*								ORCAMENTO ELE ORDENA A ELIMINACAO DO
	*								ITEM
	*				"ANULA".....: Quando osi foi emitida e o item deve
	*								permanecer registrado mas com situacao
	*								de cancelamento
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR

	*--------------------------------------------------------
	SELECT orcatmp
	SET ORDER TO TAG orcacodigo
	SEEK STR(LNemp,3)+STR(LNosi,6)+LScodigo+STR(LNordem,2)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF	

	SELE grupo
	SET ORDER TO TAG codigo
	SEEK orcatmp.codigo

	SELECT itemmov
   	SET ORDER TO TAG itensosi
  	SEEK STR(LNemp,3)+"R"+STR(LNosi,7)+orcatmp.codigo+STR(LNordem,3)
    IF FOUND()
	    SET ORDER TO TAG movimento
		=REGLOCK(.T.)
		*-----------------------------------------------------------*
		*   Se houver falha durante o processo o registro aida fica
		* sob o controle da rotina SCGC204.PRG para processar a
		* baixa da reserva . A chave BX_RESERVA exige o 1§ caracter
		* igual a "R"
		*-----------------------------------------------------------*		
		REPLACE operacao WITH "R***"   && faz o reg ser ignorado no saldo
									   && anulando seu efeito
		REPLACE dlibreserv WITH wp_dtsys
		REPLACE hlibreserv WITH time()
		***********************************************************
		SELE itemmov
		LNregmov = RECNO()

		SELE itemmov
	   	=W_DEFPROC("moviment.spr")
		=MVCancelMvto(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e

		SELE itemmov
	ENDIF




   	DO CASE
   		CASE LSoperacao = "ELIMINA"      && APAGA ITEM COM RESERVA
			   SELECT orcatmp
				=REGLOCK(.T.)
				=edithand('APAGA')
				RETURN(.t.)
   		CASE LSoperacao = "CANCELA"      && CANCELA RESERVAS
		      m.situacao = 'A '
    		  m.operacao = 'RVCS'   && RESERVA/VENDA/CANCELADA/
 			  m.qtderes	 =  0
   		CASE LSoperacao = "RESERVA"      && CANCELA RESERVAS
		      m.situacao = 'I'+RIGHT(m.situacao,1)
    		  m.operacao = 'RVPS'   && RESERVA/VENDA/PROCESSADA/
 			  m.qtderes	 =  orcatmp.qtde
   		CASE LSoperacao = "ANULA"      && ANULANDO ITEM
		      m.situacao = 'k'+RIGHT(m.situacao,1) && P/ CANC. EM OSI
    		  m.operacao = 'RVCS'   && RESERVA/VENDA/CANCELADA/
 			  m.qtderes	 =  0
  	ENDCASE


   	SELECT orcatmp

   	m.ordem = orcatmp.ordem - LNordemmenos
   	REPLACE situacao WITH m.situacao
   	REPLACE qtderes  WITH m.qtderes
   	REPLACE ordem    WITH m.ordem

   	m.qtde = orcatmp.qtde		&& NO ITEMMOV PODERIA HAVER OUTRA QTDE
								&& CASOS DE ALTERACAO DE RESERVA
	SELECT itemmov
  	SET ORDER TO TAG movimento
	*------------------------------------------------------------------*
   	*	ITENS COM QTDE = 0 NAO SAO PROCESSADOS
	*	orcatmp.tp_mercad = 7  && SERVICO NAO NECESSITA SALDO
	*	LEFT(orcatmp.codigo,4) = "9999"  && COMENTARIO NAO NECESSITA SALDO
	*------------------------------------------------------------------*
   	IF orcatmp.qtde  <> 0  	 ;
   		AND orcatmp.tp_mercad <> 7

		IF m.operacao = 'RVPS'   && RESERVA/VENDA/PROCESSADA/
			m.data = wp_dtoper
 			m.hora = time()
		 	m.sld_estq = 0
		 	m.vlr_estq = 0
			W_FULTDT = DATE()
			W_FULTH = "00:00"
			***************************************
			SELECT usuario
			SET ORDER TO TAG usuario
			SEEK m.operador
			***************************************
			SELECT itemmov
			IF usuario.temp_res = 99999
				m.dlibreserv = CTOD("12.12.9999")
				m.hlibreserv = "99:99"
			ELSE		
				do UPtempmais with m.data, m.hora, usuario.temp_res
				m.dlibreserv = W_FULTDT
				m.hlibreserv = LEFT(W_FULTH,5)		
			ENDIF
			*-------------------------------------------------------*
		   	m.sld_estq = 0
		   	m.vlr_estq = 0

			m.empresa 	=	orcatmp.empresa
			m.serie 	=	" "
		   	m.dtfat 	=   {}
			m.data 		=   wp_dtoper
		   	m.hora     	= 	orcament.hora
			m.orcamento	=	orcatmp.orcamento
			m.operador	=	orcament.operador
			m.motivo	=	orcament.motivo
			SELE TIPOOPER
			SCATTER FIELDS ;
				 CH_OPERA,CH_PRODU,CH_MOTIV,CH_DESTI,CH_CONTR,CH_CONDI,;
					TIPO TO MEMVAR

			m.FAVORECIDO  =    clienc.cliente
			m.NATU_CLI    =    clienc.NATU_CLI
			m.CODFORN     =    0
			m.PRAZOMEDIO  =    orcament.PRAZOMEDIO
			m.TP_parcela  =    orcament.TP_parcela
			m.TAXA        =    orcament.TAXA
			m.DESCONTO    =    orcatmp.DESCONTO
			m.DESC_ALT    =    orcatmp.DESC_ALT
			m.USR_DALT    =    orcatmp.USR_DALT
			m.NEGOCIACAO  =    orcament.NEGOCIACAO

			IF FOUND("GRUPO") AND grupo.TP_CONTROL = 9
				m.MOVESTQ     =    "N"
			ELSE
				m.MOVESTQ     =    tipooper.MOVESTQ
			ENDIF
			m.MOVVALOR    =    tipooper.MOVVALOR
			m.MOVCUSTO    =    tipooper.MOVCUSTO
			m.INFO_VLR    =    tipooper.INFO_VLR
			m.INFO_ICMS   =    tipooper.INFO_ICMS
			m.INFO_BASE   =    tipooper.INFO_BASE

			m.ORDEM       =    orcatmp.ORDEM
			m.CODIGO      =    orcatmp.CODIGO
			m.CLASSIFICA  =    grupo.CLASSIFICA
			m.UNIDADE     =    orcatmp.UNIDADE
			m.DESCRICAO   =    orcatmp.DESCRICAO
			m.TP_MERCAD   =    orcatmp.TP_MERCAD
			m.PESO        =    orcatmp.PESO
			m.IVA         =    orcatmp.IVA
			m.CLAS_CMS    =    orcatmp.CLAS_CMS
			m.CFO         =    orcatmp.CFO
			m.ORIGEM      =    orcatmp.ORIGEM
			m.CST         =    orcatmp.CST
			m.BASE_ISS    =    orcatmp.BASE_ISS
			m.ALIQ_ISS    =    orcatmp.ALIQ_ISS
			m.VLR_ISS     =    orcatmp.VLR_ISS
			m.BASE_CALC   =    orcatmp.BASE_CALC
			m.ALIQ_ICMS   =    orcatmp.ALIQ_ICMS
			m.VLR_ICMS    =    orcatmp.VLR_ICMS
			m.BASE_SBBRT  =    orcatmp.BASE_SBBRT
			m.BASE_SUBS   =    orcatmp.BASE_SUBS
			m.ICMS_SUBS   =    orcatmp.ICMS_SUBS
			m.BASE_ISENT  =    orcatmp.BASE_ISENT
			m.BASE_OUTR   =    orcatmp.BASE_OUTR
			m.BASE_ISIPI  =    orcatmp.BASE_ISIPI
			m.BASE_IPI    =    orcatmp.BASE_IPI
			m.ALIQ_IPI    =    orcatmp.ALIQ_IPI
			m.VLRIPI      =    orcatmp.VLRIPI
			m.PRECO       =    orcatmp.PRECO
			m.PRECOFINAL  =    orcatmp.PRECOFINAL
			m.QTDE        =    orcatmp.QTDE
			m.VLRVENDA    =    orcatmp.VLRVENDA

			m.SLD_ESTQ    =    0
			m.VLR_ESTQ    =    0
			m.SLD_RESE    =    0
			*-------------------------------------------------------*
			SELE ITEMMOV
		   =edithand('SAVE')
		   =W_DEFPROC("moviment.spr")
		   =MVatu_cmd(itemmov.empresa,;
					itemmov.codigo,;
					itemmov.classifica,;
					itemmov.data,;
					itemmov.hora,;
					itemmov.tipo,;
					itemmov.nota,;
					itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e

		ENDIF
	ENDIF
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3PR           ORVTmotivos VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   29  º
*       º Variable:            ORVTmotivos                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      227                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3pr     &&  ORVTmotivos VALID
#REGION 8
RETURN

PROCEDURE ORVTmotivos

	STORE SPACE(15)   TO VTLmotivo
	DO CASE
		CASE m.natu_oper = 1
			VTLmotivo(1) = "Normal         "
			VTLmotivo(2) = "Reclamada      "
			VTLmotivo(3) = "Complemento    "
			VTLmotivo(4) = "Entrega Futura "
			VTLmotivo(5) = "Imobilizado    "
			VTLmotivo(6) = "Carcacas       "
			VTLmotivo(7) = "Sucatas        "
			VTLmotivo(8) = "Outras         "
			VTLmotivo(9) = "               "
		CASE m.natu_oper = 2
			VTLmotivo(1) = "Mercadoria Comercial  "
			VTLmotivo(2) = "Bens Imobilizados     "
			VTLmotivo(3) = "Mat. de Uso em Servico"
			VTLmotivo(4) = "Material de Consumo   "
			VTLmotivo(5) = "Outros                "
			VTLmotivo(6) = "                      "
			VTLmotivo(7) = "                      "
			VTLmotivo(8) = "                      "
			VTLmotivo(9) = "               "
		CASE m.natu_oper = 3
			VTLmotivo(1) = "Consignacao    "
			VTLmotivo(2) = "Demonstracao   "
			VTLmotivo(3) = "Reclamacao     "
			VTLmotivo(4) = "Entrega Futura "
			VTLmotivo(5) = "Conserto       "
			VTLmotivo(6) = "Outras         "
			VTLmotivo(7) = "               "
			VTLmotivo(8) = "               "
			VTLmotivo(9) = "               "
		CASE m.natu_oper = 4
			VTLmotivo(1) = "Mercadoria Comercial   "
			VTLmotivo(2) = "Remessa em Consignacao "
			VTLmotivo(3) = "Remessa em Demonstracao"
			VTLmotivo(4) = "Mat. Uso Servico       "
			VTLmotivo(5) = "Mat. Consumo           "
			VTLmotivo(6) = "Compra de Imobilizado  "
			VTLmotivo(7) = "ICMS p/ Reembolso      "
			VTLmotivo(8) = "Outros                 "
			VTLmotivo(9) = "Merc.Com.Regime Acordo "
		CASE m.natu_oper = 5
			VTLmotivo(1) = "Mercadoria Danificada  "
			VTLmotivo(2) = "Reserva P/Fat.Futuro   "
			VTLmotivo(3) = "                       "
			VTLmotivo(4) = "                       "
			VTLmotivo(5) = "                       "
			VTLmotivo(6) = "                       "
			VTLmotivo(7) = "                       "
			VTLmotivo(8) = "                       "
			VTLmotivo(9) = "               "
	ENDCASE
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3PS           ORVlr_e_FormPgto VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   30  º
*       º Variable:            ORVlr_e_FormPgto                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      228                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ps     &&  ORVlr_e_FormPgto VALID
#REGION 8
RETURN

PROCEDURE ORVlr_e_FormPgto
PARAMETERS PrmEmpresa,PrmOrcamento,;
			PrmChequeVlr,;
			PrmDinheiroVlr,;
			PrmCartaoVlr,;
			PrmVlrDuplicata

	PRIVATE LForca_pgt
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	*------------------------------------------------------------*
	LForca_pgt		= NetArq("orca_pgt")
	*--------------------------------------------------------
    IF (LForca_pgt) > 100000  && HOUVE FALHA ABERT
		=UP_fecha("LForca_pgt" ,LFLForca_pgt)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN
	ENDIF

	*--------------------------------------------------------------*
	SELE orca_pgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	SET NEAR OFF

	store 0 to PrmChequeVlr,PrmDinheiroVlr,PrmCartaoVlr,PrmVlrDuplicata

	DO WHILE !EOF() ;
			AND orca_pgt.empresa = PrmEmpresa ;
			AND orca_pgt.orcamento = PrmOrcamento
		DO CASE
			CASE orca_pgt.moeda = 1
				PrmDinheiroVlr = PrmDinheiroVlr + orca_pgt.Vlr_Pgto
			CASE orca_pgt.moeda = 2 OR orca_pgt.banco = 857 ;
				OR orca_pgt.banco = 858
				PrmChequeVlr = PrmChequeVlr + orca_pgt.Vlr_Pgto
			CASE orca_pgt.moeda = 3 ;
			   OR orca_pgt.banco = 859 ;
			   OR orca_pgt.banco = 860
			
				PrmVlrDuplicata = PrmVlrDuplicata + orca_pgt.Vlr_Pgto
			CASE orca_pgt.moeda = 4 OR  orca_pgt.moeda = 5
				PrmCartaoVlr = PrmCartaoVlr + orca_pgt.Vlr_Pgto
			OTHERWISE
				PrmDinheiroVlr = PrmDinheiroVlr + orca_pgt.Vlr_Pgto
		ENDCASE
		SKIP
	ENDDO

	*--------------------------------------------------------------*
	=UP_fecha("LForca_pgt" ,LForca_pgt)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3Q9           ORlog VALID                        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   31  º
*       º Variable:            ORlog                              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      229                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3q9     &&  ORlog VALID
#REGION 8
RETURN

FUNCTION ORlog
PARAMETERS PrmEmpresa,PrmOrcamento

	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PRIVATE LSAlias
	PRIVATE ARQ_LogOrca,ALS_LogOrca
	store "" to ARQ_tmp,ALS_tmp

	*-------------------------------------------------------------*
	*-------------------------------------------------------------*

	LSAlias = Alias()

    ARQ_LogOrca     = NetArqAgain("Log_Orca")
    ALS_LogOrca     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_LogOrca
	SET ORDER TO TAG emporca

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmOrcamento <> orcamento
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND ORCAMENTO = PrmOrcamento
	SELE 0
	USE &ARQ_tmp
	ALS_tmp = ALIAS()

	KEYBOARD CHR(13)
	=INKEY(1)

	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
*	ON KEY LABEL P      DO ESimpext WITH "REL407"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ LOG ORCAMENTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF

	BROWSE  FIELDS ;
			DTREGIS		:H="DATA" :R,;
			USRREGIS	:H="Usr"  :R,;
			OCORRENCIA   :H="OCORRENCIA";
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_LogOrca")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3QJ           ORCanc_Libera VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   32  º
*       º Variable:            ORCanc_Libera                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      230                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3qj     &&  ORCanc_Libera VALID
#REGION 8
RETURN

FUNCTION ORCanc_Libera
	PARAMETERS LNemp,LNosi




	=W_DEFPROC("EMPRESA.SPR")
	LSCnsltCrdt = EMGetFieldValue(wp_empresa,"CNSLT_CRDT")


    IF LSCnsltCrdt = "S"   && USAR NOVA ROTINA XML

        =ORXMLCanc_Libera(LNemp,LNosi)

        RETURN(.T.)
    ENDIF




	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: cancela liberacao
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp.......: Empresa em questao
	*		LNosi.......: Nro do Orcamento em questao
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*
	PRIVATE LDdt_libera		&& Retorna a Data de liberacao
	PRIVATE LNlim_libera	&& Retorna o valor a praso liberado
	PRIVATE LNlmt_parcela	&& Retorna se Existe Limitacao para Duplcat
	PRIVATE LNlim_prazo		&& Retorna o usuario (neste caso o SISTEMA=0)
	PRIVATE LSsit			&& Retorna a situacao Definida pelo Processo
	PRIVATE LNtp_parcela
	
	PRIVATE LSalias
	PRIVATE LForcament,LFliberacoes
	*-----------------------------------------------------------*
	LSalias	= ALIAS()

	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFliberacoes	= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFliberacoes) > 100000
		DO FCHCanc_lib
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHCanc_lib
		RETURN(.F.)
	ENDIF

	SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(LNemp,3)+STR(LNosi,6)

	LSsit = orcament.situacao
	LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Existe Restricao a venda
									  	 && com duplicata
	*------------------------------------------------------------------*

	SELE liberaco
	m.empresa 	= 	orcament.empresa
	m.orcamento	=	orcament.orcamento
	m.data 		= 	wp_dtoper
	m.liberador =	0		&& SISTEMA
	m.tp_parcela= 	orcament.tp_parcela
	m.validade	=	wp_dtoper + 30
	m.situacao  =  "BLOQ"
	m.limite 	=   0
	m.prazomedio=   0
	IF FOUND("liberaco")
		=edithand('REGRAVA')
	ELSE
		=edithand('SAVE')
	ENDIF
	SELE orcament
	m.situacao   = LSsit
	SET FIELDS TO situacao, dtregis, hregis, usrregis, deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------------*
	DO FCHCanc_lib

RETURN(.T.)


PROCEDURE FCHCanc_lib
	=UP_fecha("orcament",LForcament)
	=UP_fecha("liberaco" ,LFliberacoes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3QT           ORSelParaFat VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   33  º
*       º Variable:            ORSelParaFat                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      231                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3qt     &&  ORSelParaFat VALID
#REGION 8
RETURN

FUNCTION ORSelParaFat

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSorcament
	PRIVATE LSalias
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	*--------------------------------------------------------
    IF (LForcament) > 100000  && HOUVE FALHA ABERT
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*

	*------------------------------------------------------------*

	=W_DEFPROC("AUTOPROC.SPR")
	=APTempGeral()

	*------------------------------------------------------------*

	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH "o"	 && SITUACOES EM ORDEM										&& CRESCENTE
	*------------------------------------------------------------*
	IF LASTKEY() = 27
		*---------------------------------------------------------*
		CLEAR TYPEAHEAD
		=INKEY(0.01)
		RETURN(.F.)
	ENDIF
	CLEAR TYPEAHEAD
	=INKEY(0.01)

RETURN(.T.)





****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3R0           ORSelPFatDireto VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   34  º
*       º Variable:            ORSelPFatDireto                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      232                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3r0     &&  ORSelPFatDireto VALID
#REGION 8
RETURN

FUNCTION ORSelPFatDireto

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSorcament
	PRIVATE LSalias
	LSalias  		= ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*------------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
	ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()
	*------------------------------------------------------------*
	LForcament		= NetArq("orcament")
	*--------------------------------------------------------
    IF (LForcament) > 100000  && HOUVE FALHA ABERT
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*

	*------------------------------------------------------------*

	=W_DEFPROC("AUTOPROC.SPR")
	=APTempGeral()

	*------------------------------------------------------------*

	*------------------------------------------------------------*
	=W_DEFPROC("ORCAMENT.SPR")
	DO ORloc_orc WITH "AIMo"	 && SITUACOES EM ORDEM										&& CRESCENTE
	*------------------------------------------------------------*
	IF LASTKEY() = 27
		*---------------------------------------------------------*
		CLEAR TYPEAHEAD
		=INKEY(0.01)
		RETURN(.F.)
	ENDIF
	CLEAR TYPEAHEAD
	=INKEY(0.01)

RETURN(.T.)





****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3R8           ORimp_osi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   35  º
*       º Variable:            ORimp_osi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      233                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3r8     &&  ORimp_osi VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------------------------------------------*

PROCEDURE ORSleOrFinFat		&& sist. localizacao de orcamentos
PARAMETERS LSsit, LScompl, LSorigem

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Visualisar Orcamentos que atendam aos parametros
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		PARAMETERS LSsit, LScompl, LSorigem
	*			LSsit   => indica as situacoes que devem ser relacionadas
	*			LScompl => indica os complementos de situacoes solicitados
	*		 	LSorigem=> indica qual operacao solicitou ex: RESERVA,
	*						LIBERA
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*

	PRIVATE 	LFdestrava

	ON KEY LABEL ESCAPE
	CLEAR TYPEAHEAD
    SELECT orcament

	IF TYPE("LScompl") <> "C"
		LScompl = ""
	ENDIF

	IF TYPE("LSorigem") <> "C"
		LSorigem = ""
	ENDIF

	IF TYPE("ver") <> "N"
		m.ver = 2   && ver todos
	ENDIF





	LNreg = RECNO()     && permite reposicionar registro

	LNemp = orcament.empresa
	LNorca= orcament.orcamento
	SET ORDER TO tag situacao
	SET NEAR ON
	SEEK STR(wp_empresa,3)+LEFT(LSsit,1)    &&posic. na 1a sit.strig
	SET NEAR OFF
	IF EOF() OR wp_empresa <> orcament.empresa OR ;
			!(LEFT(orcament.situacao,1) $ LSsit)
		wp_msg = "Nao existem orcamentos para esta opcao. <ENTER>"
		=UPbeeps(.F.,wp_msg)
		UNLOCK
	    m.sOldError=ON('error')
		ON ERROR *
		GO LNreg
		ON ERROR &sOldError
		KEYBOARD CHR(27)		
		=INKEY(0)
 		RETURN
	ENDIF
************************>
	wl_arqtmp = ""
	LNtmp     = 65		&& TABELA ASCII A = 65
	IF !UPabretmp("orc")
		wp_flgfecha = .t.
	ENDIF
	IF wp_flgfecha
		KEYBOARD "{ESCAPE}"
		RETURN
	ENDIF
	SET SAFET OFF
	LStmp = "&wp_dirtmp"+"&wl_arqtmp"
*****************************>

	SELE clienc
	SET ORDER TO TAG emporca




	SELE orcament
	LFdestrava = .f.
	IF LSorigem = "LIBERAR"	&& devem ser mostrados reg.protegidos
		LFdestrava = .t.
	ENDIF
	SET RELATION TO STR(EMPRESA,3)+STR(ORCAMENTO,6) INTO clienc


	
	
	COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome, veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
	   	    FOR ;
				(!orcament.protegido OR lMaster OR LFdestrava OR ;
				(orcament.protegido AND orcament.operador = wl_vendedor)) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
		   	    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl);
	    		WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX


	SET RELATION TO

    SELE 0
    USE &LStmp EXCLU ALIAS ORCABROW
	INDEX ON NOME TAG nome_todos ADDITIVE

*-----------------------> FIM PREPARACAO ARQ. TEMPORARIO	
	IF EOF() AND BOF()
		wp_msg = "Nao existem orcamentos para esta opcao. <ENTER>"
		=UPbeeps(.F.,wp_msg)
		KEYBOARD CHR(27)		
		=INKEY(0)
	    SELECT orcament
		GO LNreg
	ELSE
		Lpar1 = ""
		Lpar2 = ""
		SET ORDER TO TAG nome_todos
		GO TOP

		DO ORLoc_Browse WITH .T., Lpar1, Lpar2, "B"


	    SELECT orcament
		SET ORDER TO tag orcamento
		SET RELATION TO
*------------------------------------- posiciona orcamento
		SEEK STR(orcabrow.empresa,3)+STR(orcabrow.orcamento,6)
*------------------------------------ encerra secao orcabrow
		IF !FOUND() OR LASTKEY() = 27
			KEYBOARD CHR(27)		
			GO LNreg
		ENDIF
	ENDIF
	SELECT orcabrow
	USE
	SELECT orcament
    SCATTER MEMVAR MEMO
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3R9           ORimp_osi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   36  º
*       º Variable:            ORimp_osi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      234                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3r9     &&  ORimp_osi VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------------------------------------------*

PROCEDURE ORSleOrNFinFat		&& sist. localizacao de orcamentos
PARAMETERS LSsit, LScompl, LSorigem

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Visualisar Orcamentos que atendam aos parametros
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		PARAMETERS LSsit, LScompl, LSorigem
	*			LSsit   => indica as situacoes que devem ser relacionadas
	*			LScompl => indica os complementos de situacoes solicitados
	*		 	LSorigem=> indica qual operacao solicitou ex: RESERVA,
	*						LIBERA
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*

	PRIVATE 	LFdestrava

	ON KEY LABEL ESCAPE
	CLEAR TYPEAHEAD
    SELECT orcament

	IF TYPE("LScompl") <> "C"
		LScompl = ""
	ENDIF

	IF TYPE("LSorigem") <> "C"
		LSorigem = ""
	ENDIF

	IF TYPE("ver") <> "N"
		m.ver = 2   && ver todos
	ENDIF





	LNreg = RECNO()     && permite reposicionar registro

	LNemp = orcament.empresa
	LNorca= orcament.orcamento
	SET ORDER TO tag situacao
	SET NEAR ON
	SEEK STR(wp_empresa,3)+LEFT(LSsit,1)    &&posic. na 1a sit.strig
	SET NEAR OFF
	IF EOF() OR wp_empresa <> orcament.empresa OR ;
			!(LEFT(orcament.situacao,1) $ LSsit)
		wp_msg = "Nao existem orcamentos para esta opcao. <ENTER>"
		=UPbeeps(.F.,wp_msg)
		UNLOCK
	    m.sOldError=ON('error')
		ON ERROR *
		GO LNreg
		ON ERROR &sOldError
		KEYBOARD CHR(27)		
		=INKEY(0)
 		RETURN
	ENDIF
************************>
	wl_arqtmp = ""
	LNtmp     = 65		&& TABELA ASCII A = 65
	IF !UPabretmp("orc")
		wp_flgfecha = .t.
	ENDIF
	IF wp_flgfecha
		KEYBOARD "{ESCAPE}"
		RETURN
	ENDIF
	SET SAFET OFF
	LStmp = "&wp_dirtmp"+"&wl_arqtmp"
*****************************>
	SELE clienc
	SET ORDER TO TAG emporca

	SELE orcament
	LFdestrava = .f.
	IF LSorigem = "LIBERAR"	&& devem ser mostrados reg.protegidos
		LFdestrava = .t.
	ENDIF
	SET RELATION TO STR(EMPRESA,3)+STR(ORCAMENTO,6) INTO clienc


	
	DO CASE

		CASE ("A" $ LSsit OR "F" $ LSsit OR "G" $ LSsit OR "I" $ LSsit)  ;
		 	  AND (m.ver <> 1 OR lMaster)

				&& RESERVA E CANC. DE RESERVA P/ VER ORCAMENTO COM
				&& RESERVAS PELO ESTOQUE

			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome,veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
	   	    FOR ;
				(  !orcament.protegido ;
					OR lMaster;
					OR LFdestrava ;
					OR ;
				     (     orcament.protegido ;
				       AND orcament.operador = wl_vendedor;
				     );
				) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
			    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl) ;
	 			WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX

		CASE ("A" $ LSsit OR "F" $ LSsit OR "G" $ LSsit OR "I" $ LSsit)  ;
		 	  AND (m.ver = 1 OR lMaster)

				&& RESERVA E CANC. DE RESERVA P/ VER ORCAMENTO COM
				&& RESERVAS PELO ESTOQUE
			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome,veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
		   	    FOR ;
   		        (orcament.operador = wl_vendedor) AND ;
	   		    LEFT(orcament.situacao,1) $ LSsit     AND ;
	   	    	(EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl) ;
	    		WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX

		CASE WPprgativo = "SCGC201A" OR m.ver <> 1 && ver alem proprios
	
			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome, veiculo,placa,;
					dt_fat,nota,dtregis,hregis,usrregis ;
	   	    FOR ;
				(!orcament.protegido OR lMaster OR LFdestrava OR ;
				(orcament.protegido AND orcament.operador = wl_vendedor)) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
		   	    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl);
	    		WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX
		OTHERWISE
			COPY TO &LStmp FIELDS empresa, orcamento,operador,situacao,;
					data,clienc.fone,valor,clienc.nome,veiculo,placa, ;
					dt_fat,nota,dtregis,hregis,usrregis ;
   	        FOR ;
				(lMaster OR orcament.operador = wl_vendedor) AND ;
		   	    LEFT(orcament.situacao,1) $ LSsit     AND ;
		   	    (EMPTY(LScompl) OR RIGHT(orcament.situacao,1) $ LScompl) ;
    			WHILE wp_empresa = orcament.empresa AND ;
		   	    LEFT(orcament.situacao,1) <= RIGHT(LSsit,1) WITH CDX
	ENDCASE
	SET RELATION TO

    SELE 0
    USE &LStmp EXCLU ALIAS ORCABROW
	INDEX ON NOME TAG nome_todos ADDITIVE

*-----------------------> FIM PREPARACAO ARQ. TEMPORARIO	
	IF EOF() AND BOF()
		wp_msg = "Nao existem orcamentos para esta opcao. <ENTER>"
		=UPbeeps(.F.,wp_msg)
		KEYBOARD CHR(27)		
		=INKEY(0)
	    SELECT orcament
		GO LNreg
	ELSE
		Lpar1 = ""
		Lpar2 = ""
		SET ORDER TO TAG nome_todos
		GO TOP

		DO ORLoc_Browse WITH .T., Lpar1, Lpar2, "B"


	    SELECT orcament
		SET ORDER TO tag orcamento
		SET RELATION TO
*------------------------------------- posiciona orcamento
		SEEK STR(orcabrow.empresa,3)+STR(orcabrow.orcamento,6)
*------------------------------------ encerra secao orcabrow
		IF !FOUND() OR LASTKEY() = 27
			KEYBOARD CHR(27)		
			GO LNreg
		ENDIF
	ENDIF
	SELECT orcabrow
	USE
	SELECT orcament
    SCATTER MEMVAR MEMO
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3RV           ORCancPdLiberacaoXML VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   38  º
*       º Variable:            ORCancPdLiberacaoXML               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      235                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3rv     &&  ORCancPdLiberacaoXML VALID
#REGION 8
RETURN

FUNCTION ORCancPdLiberacaoXML
	PARAMETERS LNemp,LNosi

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: cancela liberacao
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp.......: Empresa em questao
	*		LNosi.......: Nro do Orcamento em questao
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*
	PRIVATE LDdt_libera		&& Retorna a Data de liberacao
	PRIVATE LNlim_libera	&& Retorna o valor a praso liberado
	PRIVATE LNlmt_parcela	&& Retorna se Existe Limitacao para Duplcat
	PRIVATE LNlim_prazo		&& Retorna o usuario (neste caso o SISTEMA=0)
	PRIVATE LSsit			&& Retorna a situacao Definida pelo Processo
	PRIVATE LNtp_parcela
	
	PRIVATE LSalias
	PRIVATE LForcament,LFliberacoes
	*-----------------------------------------------------------*
	LSalias	= ALIAS()

	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFliberacoes	= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFliberacoes) > 100000
		DO FCHCanc_lib
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHCanc_lib
		RETURN(.F.)
	ENDIF

	SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(LNemp,3)+STR(LNosi,6)

	LSsit = orcament.situacao
	LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Existe Restricao a venda
									  	 && com duplicata
	*------------------------------------------------------------------*

	SELE liberaco
	m.empresa 	= 	orcament.empresa
	m.orcamento	=	orcament.orcamento
	m.data 		= 	wp_dtoper
	m.liberador =	0		&& SISTEMA
	m.tp_parcela= 	orcament.tp_parcela
	m.validade	=	wp_dtoper + 30
	m.situacao  =  "BLOQ"
	m.limite 	=   0
	m.prazomedio=   0
	IF FOUND("liberaco")
		=edithand('REGRAVA')
	ELSE
		=edithand('SAVE')
	ENDIF
	SELE orcament
	m.situacao   = LSsit
	SET FIELDS TO situacao, dtregis, hregis, usrregis, deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------------*
	DO FCHCanc_lib

RETURN(.T.)


PROCEDURE FCHCanc_lib
	=UP_fecha("orcament",LForcament)
	=UP_fecha("liberaco" ,LFliberacoes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3S4           ORConsPdLiberacaoXML VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   39  º
*       º Variable:            ORConsPdLiberacaoXML               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      236                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3s4     &&  ORConsPdLiberacaoXML VALID
#REGION 8
RETURN

FUNCTION ORConsPdLiberacaoXML
	PARAMETERS LNemp,LNosi

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: cancela liberacao
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp.......: Empresa em questao
	*		LNosi.......: Nro do Orcamento em questao
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*
	PRIVATE LDdt_libera		&& Retorna a Data de liberacao
	PRIVATE LNlim_libera	&& Retorna o valor a praso liberado
	PRIVATE LNlmt_parcela	&& Retorna se Existe Limitacao para Duplcat
	PRIVATE LNlim_prazo		&& Retorna o usuario (neste caso o SISTEMA=0)
	PRIVATE LSsit			&& Retorna a situacao Definida pelo Processo
	PRIVATE LNtp_parcela
	
	PRIVATE LSalias
	PRIVATE LForcament,LFliberacoes
	*-----------------------------------------------------------*
	LSalias	= ALIAS()

	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFliberacoes	= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFliberacoes) > 100000
		DO FCHCanc_lib
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHCanc_lib
		RETURN(.F.)
	ENDIF

	SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(LNemp,3)+STR(LNosi,6)

	LSsit = orcament.situacao
	LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Existe Restricao a venda
									  	 && com duplicata
	*------------------------------------------------------------------*

	SELE liberaco
	m.empresa 	= 	orcament.empresa
	m.orcamento	=	orcament.orcamento
	m.data 		= 	wp_dtoper
	m.liberador =	0		&& SISTEMA
	m.tp_parcela= 	orcament.tp_parcela
	m.validade	=	wp_dtoper + 30
	m.situacao  =  "BLOQ"
	m.limite 	=   0
	m.prazomedio=   0
	IF FOUND("liberaco")
		=edithand('REGRAVA')
	ELSE
		=edithand('SAVE')
	ENDIF
	SELE orcament
	m.situacao   = LSsit
	SET FIELDS TO situacao, dtregis, hregis, usrregis, deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------------*
	DO FCHCanc_lib

RETURN(.T.)


PROCEDURE FCHCanc_lib
	=UP_fecha("orcament",LForcament)
	=UP_fecha("liberaco" ,LFliberacoes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3SD           ORGraXMLPddCredito VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   41  º
*       º Variable:            ORGraXMLPddCredito                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      237                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3sd     &&  ORGraXMLPddCredito VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORGraXMLPddCredito
PARAMETER PrmEmpresa,;
		  PrmNro_Orca,;
		  PrmSerie_Doc,;
   		  PrmTipoOperacao && REGISTRAR,CANCELAR,CONSULTAR,ENCERRAR


	PRIVATE LSalias
	
	PRIVATE PrmAlsOR
	PRIVATE LNrecOrca
	
	PRIVATE LNosiReferencia   && relaciona as duplicatas pelo
	                          && orcamento de referencia

	

	LSalias  = ALIAS()
	PrmAlsOR = ORGetAlias()



	*-------------------------------------------------------*
	=ORMdlPddCrdtRefXML()

	*-------------------------------------------------------*

   	PRIVATE LSfileXML,LNroIDfileXML




   	LSfileXML	= ORNmFileXMLPddCr(PrmEmpresa,PrmNro_Orca)
   	LSfileXML	= "C:\NFE\TMP\"+LSfileXML


  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return
   	endif





	*---------------------------------------------------*

	SELE &PrmAlsOR
	SET ORDER TO TAG GERAL
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmNro_Orca,6)
	SET NEAR OFF




	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.


    IF !EOF()
		LNregistro = RECNO()

		COUNT  WHILE !EOF() ;
			AND PrmEmpresa    = &PrmAlsOR .empresa;
	        AND PrmNro_Orca   = &PrmAlsOR .orcamento ;
         TO LNimpressao
		GO LNregistro
	
	ENDIF
	
	LNimpressos = 0
	*----------------------------------------------------*


	=ORIniPddCrdtXML(LSfileXML,LNroIDfileXML)


	SET POINT TO ','


	SELE &PrmAlsOR
	DO WHILE !EOF() ;
	        AND PrmEmpresa       = &PrmAlsOR .empresa;
	        AND PrmNro_Orca       = &PrmAlsOR .orcamento

******* =UPtermo()



		LNrecOrca = RECNO()



		=ORGrvXMLPddCrdt(;
 				PrmEmpresa,;
		  		PrmNro_Orca,;
		  		PrmSerie_Doc,;
                PrmTipoOperacao,;
				LSfileXML,;
				LNroIDfileXML;
				)


		SELE &PrmAlsOR
		SET ORDER TO TAG GERAL

		GO LNrecOrca
		SKIP
	ENDDO

	=ORFinPddCrdtXML(LSfileXML,LNroIDfileXML)


	SET POINT TO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3SO           ORNmFileXMLPddCr VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   42  º
*       º Variable:            ORNmFileXMLPddCr                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      238                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3so     &&  ORNmFileXMLPddCr VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORNmFileXMLPddCr
PARAMETER PrmEmpresa,PrmNro_Doc

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*



	LSnomeArqXml = "SC"+;
				   STR(PrmNro_Doc,6)
				
	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")


   	LSfileXML	= LSnomeArqXml+".XML"
	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3SV           ORIniPddCrdtXML VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   43  º
*       º Variable:            ORIniPddCrdtXML                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      239                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3sv     &&  ORIniPddCrdtXML VALID
#REGION 8
RETURN

FUNCTION ORIniPddCrdtXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML



   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\XMLPDDCR
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND XMLPDDCR.XML_ORDEM < 9999999999901
	
		LSLinhaXML = XMLPDDCR.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE XMLPDDCR
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3SW           ORFinPddCrdtXML VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   44  º
*       º Variable:            ORFinPddCrdtXML                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      240                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3sw     &&  ORFinPddCrdtXML VALID
#REGION 8
RETURN

FUNCTION ORFinPddCrdtXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\XMLPDDCR
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF XMLPDDCR.XML_ORDEM > 9999999999900
			LSLinhaXML = XMLPDDCR.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE XMLPDDCR
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3T8           ORGrvXMLPddCrdt VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   45  º
*       º Variable:            ORGrvXMLPddCrdt                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      241                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3t8     &&  ORGrvXMLPddCrdt VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION ORGrvXMLPddCrdt
PARAMETERS  	PrmEmpresa,;
		  		PrmNro_Doc,;
                PrmSerie_Doc,;
		  		PrmTipoOperacao,;
				PrmFileXML,;
				PrmNroIDfileXML


 && REGISTRAR,CANCELAR,CONSULTAR,ENCERRAR


	PRIVATE LSAlsOR   && ORCAMENT
	PRIVATE LSAlsCN   && CLIENC
	

	LSAlsOR = ORGetAlias()


	IF !ORLerRegistro(PrmEmpresa,;
			PrmNro_Doc)
	      wait "Nao foi localizado Orcamento :"+;
		      "FILIAL: "+STR(PrmEmpresa,3)+;
		      "NRO.  : "+STR(PrmNro_Doc,9)
   	  return(.F.)
    ENDIF





	=W_DEFPROC("CLIENC.SPR")
	LSAlsCN = CNGetAlias()


	=W_DEFPROC("CLIENC.SPR")
	IF !CNLerRegistro(PrmEmpresa,PrmNro_Doc)
	      wait "Nao foi localizado Cliente (CLIENC) do Orcamento :"+;
		      "FILIAL: "+STR(PrmEmpresa,3)+;
		      "NRO.  : "+STR(PrmNro_Doc,9)
   	  return(.F.)
    ENDIF


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_Crd
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*

	=W_DEFPROC("EMPRESA.SPR")
	=EMLerRegistro(PrmEmpresa)

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("CGC")
	UNEM_CNPJ    =  STR(LFieldTmp,14)
	UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")

	SET POINT TO ","
	SET SEPARATOR  TO "."

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('<ROW UNEM_CPFCNPJ="'+UNEM_CNPJ+'"')

 	  =W_DEFPROC("DOCFISCA.SPR")
	  =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("INSCRICAO")

	=W_DEFPROC("DOCFISCA.SPR")
	LFieldTmp = DFLimpaString(LFieldTmp)

	LFieldTmp = chrtran(LFieldTmp,'.','')
	LFieldTmp = chrtran(LFieldTmp,'-','')




	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('UNEM_IE="'+LFieldTmp+'"')

 	  =W_DEFPROC("DOCFISCA.SPR")
	  =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*==========================================================*
	*  IDENTIFICACAO DA SOLICITACAO DE CREDITO - ORCAMENTO
	*==========================================================*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_TIPO_OPERACAO="'+;
	             PrmTipoOperacao +;
	             '"')

	  =W_DEFPROC("DOCFISCA.SPR")
      =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
	*----------------------------------------------------------*



	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_NUMERO="'+;
	             STR(PrmNro_Doc,7) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_SERIE="'+;
	             PrmSerie_Doc +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*==========================================================*
	*  PARTICIPANTE
	*==========================================================*
	private LNcpfcnpjc,LNie,LNnome


	LNcpfcnpjc  =  chrtran(str( &LSAlsCN .cliente,14)," ","0")
	LNie        =  &LSAlsCN .inscricao

	=W_DEFPROC("DOCFISCA.SPR")
    LNie        =  DFLimpaString(LNie)


    LNie_UF     =  &LSAlsCN .estado
	LNnome	    =  &LSAlsCN .nome


	*----------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_CPFCNPJ="'+;
	             LNcpfcnpjc+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_IE="'+;
	             LNie+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_IE_UF="'+;
	             LNie_UF+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = DFLimpaString(LNnome)

	=W_DEFPROC("DOCFISCA.SPR")
  	    LSLinhaXML = ('SLCR_NOME="'+;
	             LSLinhaXML+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*==========================================================*
	*  DADOS DA SOLICITACAO
	*==========================================================*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_DATA="'+;
	             DTOC( &LSAlsOR .DATA) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_HORA="'+;
	              &LSAlsOR .HORA +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_NOME_SOLICITANTE="'+;
	              wp_nmusr +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_LIMITE_SOLICITADO="'+;
	             STR( &LSAlsOR .VALOR ;
	                 -;
	                   &LSAlsOR .VLR_ENT ;
	             ,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*----------------------------------------------------------------------*

	DO CASE

			CASE     &LSAlsOR .TP_PARCELA = 1

				LScodigo    = "01"
				LSdescricao = "Dinheiro"


			CASE     &LSAlsOR .TP_PARCELA = 2
				LScodigo    = "02"
				LSdescricao = "Cheque A Vista"


			CASE     &LSAlsOR .TP_PARCELA = 3
				LScodigo    = "03"
				LSdescricao = "Cheque A Prazo"

			CASE     &LSAlsOR .TP_PARCELA = 4
				LScodigo    = "04"
				LSdescricao = "Duplicata"


			CASE     &LSAlsOR .TP_PARCELA = 5
				LScodigo    = "05"
				LSdescricao = "Cheque Eletronico"


			CASE     &LSAlsOR .TP_PARCELA = 6
			
				LScodigo    = "06"
				LSdescricao = "Cartao Rotativo"

			CASE     &LSAlsOR .TP_PARCELA = 7

				LScodigo    = "07"
				LSdescricao = "Cartao Parcelado Administradora"

			CASE     &LSAlsOR .TP_PARCELA = 8
			
				LScodigo    = "08"
				LSdescricao = "Cartao Parcelado Loja"

	ENDCASE


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_FORMA_PGTO="'+;
	        		     LScodigo +;
				             '"')
   	   =W_DEFPROC("DOCFISCA.SPR")
	   =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_FORMA_PGTO_DESCRICAO="'+;
	        		     LSdescricao +;
				             '"')
	   =W_DEFPROC("DOCFISCA.SPR")
	   =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

    *----------------------------------------------------------------------*


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_PRAZO_MEDIO="'+;
	             STR( &LSAlsOR .PRAZOMEDIO,5,0) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*-------------------------------------------------------*
	*-------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_STATUS="'+;
	             '' +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('SLCR_JUSTIFICATIVA="'+;
	             '' +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*-------------------------------------------------------*
	LSLinhaXML = ULtratalinha('/>')
				=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3TP           ORMdlPddCrdtRefXML VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   46  º
*       º Variable:            ORMdlPddCrdtRefXML                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      242                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3tp     &&  ORMdlPddCrdtRefXML VALID
#REGION 8
RETURN

FUNCTION ORMdlPddCrdtRefXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\XMLPDDCR.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\XMLPDDCR EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE XMLPDDCR


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3TW           ORNmPddCrdtLngFileXMLCREDT VALID   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   47  º
*       º Variable:            ORNmPddCrdtLngFileXMLCREDT         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      243                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3tw     &&  ORNmPddCrdtLngFileXMLCREDT VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ORNmPddCrdtLngFileXMLCREDT
PARAMETER PrmEmpresa,PrmNro_Doc

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
    PRIVATE LSPrefixo,LSTpDoc,LSNrDoc,LSNrEmp

	
	*----------------------------------------------------------*
    LSPrefixo = "CRDT"
    LSTpDoc   = ""
    LSNrDoc   = CHRTRAN(STR(PrmNro_Doc,6)," ","0")
    LSNrEmp   = CHRTRAN(STR(PrmEmpresa,3)," ","0")



	LSnomeArqXml = LSPrefixo+LSNrEmp+LSTpDoc+LSNrDoc+".XML"

   	LSfileXML	= LSnomeArqXml
	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3U3           ORXMLRegPede_p_Liberar VALID       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   50  º
*       º Variable:            ORXMLRegPede_p_Liberar             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      244                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3u3     &&  ORXMLRegPede_p_Liberar VALID
#REGION 8
RETURN

FUNCTION ORXMLRegPede_p_Liberar
	PARAMETERS PrmEmp,PrmOsi,PrmSerie


   *------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSCnsltCrdt = EMGetFieldValue(wp_empresa,"CNSLT_CRDT")


    IF LSCnsltCrdt <> "S"   && USAR NOVA ROTINA XML

        RETURN(.T.)
    ENDIF

   *------------------------------------------*


	
   IF TYPE("PrmSerie") <> "C"
      PrmSerie = "001"
   ENDIF

   PRIVATE LSTipoOperacao

   LSTipoOperacao = "REGISTRO"  && REGISTRAR,CANCELAR,CONSULTAR,FATURAR


   =ORGraXMLPddCredito( ;
          PrmEmp,;
		  PrmOsi,;
		  PrmSerie,;
   		  LSTipoOperacao)


   =OREnvXMPddCr(PrmEmp,PrmOsi,PrmSerie)


RETURN(.T.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3U9           ORXMLCanPede_p_Liberar VALID       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   51  º
*       º Variable:            ORXMLCanPede_p_Liberar             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      245                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3u9     &&  ORXMLCanPede_p_Liberar VALID
#REGION 8
RETURN

FUNCTION ORXMLCanPede_p_Liberar
	PARAMETERS PrmEmp,PrmOsi,PrmSerie
	



   *------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSCnsltCrdt = EMGetFieldValue(wp_empresa,"CNSLT_CRDT")


    IF LSCnsltCrdt <> "S"   && USAR NOVA ROTINA XML

        RETURN(.T.)
    ENDIF

   *------------------------------------------*



   IF TYPE("PrmSerie") <> "C"
      PrmSerie = "001"
   ENDIF

   PRIVATE LSTipoOperacao

   LSTipoOperacao = "CANCELAMENTO"  && REGISTRAR,CANCELAR,CONSULTAR,FATURAR


   =ORGraXMLPddCredito( ;
          PrmEmp,;
		  PrmOsi,;
		  PrmSerie,;
   		  LSTipoOperacao)


   =OREnvXMPddCr(PrmEmp,PrmOsi,PrmSerie)


RETURN(.T.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3UG           ORXMLCnstPede_p_Liberar VALID      º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   52  º
*       º Variable:            ORXMLCnstPede_p_Liberar            º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      246                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ug     &&  ORXMLCnstPede_p_Liberar VALID
#REGION 8
RETURN

FUNCTION ORXMLCnstPede_p_Liberar
	PARAMETERS PrmEmp,PrmOsi,PrmSerie
	


   *------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSCnsltCrdt = EMGetFieldValue(wp_empresa,"CNSLT_CRDT")


    IF LSCnsltCrdt <> "S"   && USAR NOVA ROTINA XML

        RETURN(.T.)
    ENDIF

   *------------------------------------------*

   IF TYPE("PrmSerie") <> "C"
      PrmSerie = "001"
   ENDIF

   PRIVATE LSTipoOperacao

   LSTipoOperacao = "CONSULTA"  && REGISTRAR,CANCELAR,CONSULTAR,FATURAR


   =ORGraXMLPddCredito( ;
          PrmEmp,;
		  PrmOsi,;
		  PrmSerie,;
   		  LSTipoOperacao)


   =OREnvXMPddCr(PrmEmp,PrmOsi,PrmSerie)



RETURN(.T.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3UN           ORXMLFatPede_p_Liberar VALID       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   53  º
*       º Variable:            ORXMLFatPede_p_Liberar             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      247                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3un     &&  ORXMLFatPede_p_Liberar VALID
#REGION 8
RETURN

FUNCTION ORXMLFatPede_p_Liberar
	PARAMETERS PrmEmp,PrmOsi,PrmSerie
	


   *------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LSCnsltCrdt = EMGetFieldValue(wp_empresa,"CNSLT_CRDT")


    IF LSCnsltCrdt <> "S"   && USAR NOVA ROTINA XML

        RETURN(.T.)
    ENDIF

   *------------------------------------------*


   IF TYPE("PrmSerie") <> "C"
      PrmSerie = "001"
   ENDIF

   PRIVATE LSTipoOperacao

   LSTipoOperacao = "ENCERRAMENTO"  && REGISTRAR,CANCELAR,CONSULTAR,FATURAR


   =ORGraXMLPddCredito( ;
          PrmEmp,;
		  PrmOsi,;
		  PrmSerie,;
   		  LSTipoOperacao)


   =OREnvXMPddCr(PrmEmp,PrmOsi,PrmSerie)


RETURN(.T.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3UU           ORRtrnoCnstXMLPddCr VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   54  º
*       º Variable:            ORRtrnoCnstXMLPddCr                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      248                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3uu     &&  ORRtrnoCnstXMLPddCr VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION ORRtrnoCnstXMLPddCr
PARAMETERS PrmEmpresa, PrmOSI,PrmEspera, RtnStatus, Rtrn_Vlr_liberado





	IF TYPE("PrmEspera") <> "C" OR EMPTY(PrmEspera)
		PrmEspera = "NAO ESPERA"
	ENDIF

	*-------------------------------------------------------------*
	*--> PARA DADOS RETORNO



	STORE "" TO 	  RtnStatus




	=W_DEFPROC("ORCAMENT.SPR")

		LSstatus = ORRespXMLPddCR;
		      (;
				PrmEmpresa,;
	   			PrmOSI,;
  			    RtnStatus, ;
  			    Rtrn_Vlr_liberado,;
  			    PrmEspera)




	IF  "ERRO" $ LSstatus
		WAIT WINDOW LSstatus  NOWAIT
	ENDIF

RETURN(LSstatus)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3V1           OREsperaRspPddCR VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   55  º
*       º Variable:            OREsperaRspPddCR                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      249                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3v1     &&  OREsperaRspPddCR VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION OREsperaRspPddCR
PARAMETERS PrmEmpresa, PrmNroDoc,Rtrn_Vlr_liberado




	*-------------------------------------------------------*
	PRIVATE LSstatus
	PRIVATE CtrAguarda

	LSstatus = ""
    Rtrn_Vlr_liberado = 0

    CtrAguarda = 0

	DO WHILE LSstatus = ""


	    LSmsg = STR(LNctr,3)+;
	            "-Aguarda Solicitacao Credito - <ESC>=Sai ";
	            +LSFile
	


		LSstatus=ORBuscaRspPddCR(PrmEmpresa, PrmNroDoc,Rtrn_Vlr_liberado)


		WAIT WINDOW LSmsg NOWAIT
		TECLA=INKEY(3)
		LNctr = LNctr + 1

		IF TECLA = 27 OR LASTKEY() = 27
			IF fox_alert("Interrompe Espera NFe ? ")
				LSstatus = "ERRO ! Espera interrompida por usr"
			ENDIF
		ENDIF


	ENDDO


    LSmsg = "Concluido leitura XML............ "
	WAIT WINDOW LSmsg NOWAIT

RETURN(LSstatus)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3V8           ORBuscaRspPddCR VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   56  º
*       º Variable:            ORBuscaRspPddCR                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      250                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3v8     &&  ORBuscaRspPddCR VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION ORBuscaRspPddCR
PARAMETERS PrmEmpresa,PrmNro_Doc,Rtrn_Vlr_liberado

	*-------------------------------------------------------*

	PRIVATE LSnroDoc
	PRIVATE LNfile
	PRIVATE LSstatus,LSFile,LNctr,TECLA
    PRIVATE LNLimite_Liberado


    PRIVATE LSCampo
	PRIVATE LSConteudo


	*-------------------------------------------------------*
	*  obter o MOD_DOC
	*-------------------------------------------------------*



	*----------------------------------------------------------*

	LSstatus = ""
	LNfile = 0



	LSnroDoc  = CHRTRAN(STR(PrmNro_Doc,6)," ","")

	*--------------------------------------------------*

	=W_DEFPROC("PARAMETR.SPR")

	LSPathDestino   = PMGetFieldValue(PrmEmpresa,"DIR_DFIS")



    IF TYPE("LSPathDestino") <> "C" or EMPTY(LSPathDestino)
         LSPathDestino = "C:\NFE\"
	else
         LSPathDestino = ALLTRIM(LSPathDestino)
    ENDIF


	*--------------------------------------------------*



	LSFile    = LSPathDestino+"SC"+LSnroDoc+".TXT"



	LNctr = 0

	CLEAR TYPEAHEAD

    LNLimite_Liberado = 0
    LSstatus = ""





	DO CASE

		CASE !FILE(LSFile)

			LSstatus = ""

		OTHERWISE		
			TECLA=INKEY(3)
			LNfile=FOPEN(LSFile)	
			IF LNfile > 0
				LSstatus=""
				DO WHILE !FEOF(LNfile)


					LScampo    = RTRIM(UPPER(fgets(LNfile,255)))
	                IF FEOF(LNfile)
	                   EXIT
	                ENDIF
					LSconteudo = RTRIM(UPPER(fgets(LNfile,255)))


                    DO CASE
                       CASE  UPPER(LScampo) = "SLCR_LIMITE_LIBERADO"
                             LNLimite_Liberado = INT(VAL(LSconteudo))

                       CASE  UPPER(LScampo) = "SLCR_STATUS"
                             LSStatus      = LSconteudo
                   ENDCASE
				
				ENDDO

				=FCLOSE(LNfile)



				**---- > RENOMEIA ????????.??K  =>  K de ok
				LSnewFile =  ;
					    STRtran(LSFile,".TXT",".K"+PrmMod_Doc)

			ELSE
				LSstatus = "ERRO ! Nao houve retorno do comando"


				**---- > RENOMEIA ????????.??E  =>  E de Erro
				LSnewFile =  ;
				    STRtran(LSFile,".TXT",".E"+PrmMod_Doc)

			ENDIF



			IF FILE(LSnewFile)
		   		delete file &LSnewFile
			ENDIF
			RENAME &LSFile TO &LSnewFile


	ENDCASE

    Rtrn_Vlr_liberado = LNLimite_Liberado

	*---------------------------------------------------*


RETURN(LSstatus)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3VI           ORRespXMLPddCR VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   57  º
*       º Variable:            ORRespXMLPddCR                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      251                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3vi     &&  ORRespXMLPddCR VALID
#REGION 8
return
*---------------------------------------------------------------*
*		   PrmEsperaResposta,;
*		       && "ESPERA" ou "NAO ESPERA"
*
*---------------------------------------------------------------*

FUNCTION ORRespXMLPddCR

PARAMETER  PrmEmpresa,;
		   PrmNro_Doc,;
		   RtnStatus,;
		   Rtrn_Vlr_liberado,;
		   PrmEsperaResposta
		

	*-------------------------------------------------------*

	PRIVATE LSalias
	PRIVATE PrmAlsDF

	LSalias = ALIAS()
		
		
		
	*-------------------------------------------------------*
	PRIVATE LSstatus,LSstatus2
	LSstatus = ""
    LSstatus2 = ""

	IF PrmEsperaResposta = "ESPERA"
	   LSstatus=OREsperaRspPddCR(PrmEmpresa,PrmNro_Doc,Rtrn_Vlr_liberado)
	ELSE
	   LSstatus=ORBuscaRspPddCR(PrmEmpresa,PrmNro_Doc,Rtrn_Vlr_liberado)
	ENDIF


	*-------------------------------------------------------*


	DO CASE

		CASE LSstatus = "ERRO ! Nao houve retorno do comando"
				RtnStatus = LSstatus
		OTHERWISE
				RtnStatus = LSstatus
	
	ENDCASE


   IF !EMPTY(LSalias) AND USED(LSalias)
	  SELECT &LSalias
   ENDIF


RETURN(LSstatus)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3VQ           ORXMLTenta_Liberar VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   58  º
*       º Variable:            ORXMLTenta_Liberar                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      252                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3vq     &&  ORXMLTenta_Liberar VALID
#REGION 8
RETURN

FUNCTION ORXMLTenta_Liberar
	PARAMETERS LNemp,LNosi

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Verificar Condicoes de Credito do Cliente
	*------------------------------------------------------------*
	* COMENTARIO..: Apos a edicao dos itens e na reserva as condi-
	*			coes do orcamento sao avaliadas com objetivo de
	*			liberara a venda atraves do campo SITUACAO
	*
	* 	&& usada para prever mudanca de situacao na reserva e
	*	&& no retorno da edicao dos itens
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp.......: Empresa em questao
	*		LNosi.......: Nro do Orcamento em questao
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*
	PRIVATE LDdt_libera		&& Retorna a Data de liberacao
	PRIVATE LNlim_libera	&& Retorna o valor a praso liberado
	PRIVATE LNlmt_parcela	&& Retorna se Existe Limitacao para Duplcat
	PRIVATE LNlim_prazo		&& Retorna o usuario (neste caso o SISTEMA=0)
	PRIVATE LSsit			&& Retorna a situacao Definida pelo Processo
	PRIVATE LNtp_parcela
	
	PRIVATE LSalias
	PRIVATE LForcament,LFclienc
	*-----------------------------------------------------------*
	LSalias	= ALIAS()

	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFclienc		= NetArq("clienc")
	LFliberacoes	= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFclienc+LFliberacoes) > 100000
		DO FCHtenta_lib
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHtenta_lib
		RETURN(.F.)
	ENDIF
	SELE clienc
	SET ORDER TO TAG emporca
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND()
		DO FCHtenta_lib
		RETURN(.F.)
	ENDIF

	SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(LNemp,3)+STR(LNosi,6)

	LSsit = orcament.situacao
	*------------------------------------------------------------*
	*	Condicoes de Liberacao :
	*						a - Imediata
	*						b - Conforme Informacoes
	*
	*------------------------------------------------------------*



	PRIVATE  PrmEmpresa,PrmOSI,PrmSerie,RtnStatus,Rtrn_Vlr_liberado
	PrmEmpresa = LNEmp
	PrmOSI     = LNOSI
	PrmSerie   = "000"
	RtnStatus  = ""
	Rtrn_Vlr_liberado = 0
	





	DO CASE
		CASE RIGHT(LSsit,1) = "F"
			*-------------------------------------------------*
			* Situacao = "F" && CREDITO BLOQUEADO SO SERA TRATADO
			*	 DIRETAMENTE PELA OCAO <8-Lib.Cred> e nao
			* automaticamente
			*-------------------------------------------------*
		CASE orcament.tp_parcela = 1 	&& A Vista
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO

		CASE orcament.tp_parcela = 4
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO
									  	 &&  Vendas em cartao sao liberadas
									  	 && sem verificacao
		CASE FOUND("liberaco") ;
			AND orcament.valor 		<= liberaco.limite ;
			AND orcament.prazomedio	<= liberaco.prazomedio ;
			AND orcament.tp_parcela = liberaco.tp_parcela
			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO
									  	 &&  Permanecendo as mesmas
									  	 && condicoes da ultima liberacao

		CASE (orcament.lmt_parcela = "S" AND orcament.tp_parcela = 3)
			LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Existe Restricao a venda
									  	 && com duplicata


*---------------------------------------------
*****  >>>> MUDANCA EM RELACAO AO MODELO FOX PARA MODELO SERVICO XML
*---------------------------------------------
*		CASE ORVer_credito(clienc.cliente,  ;
*				orcament.valor - orcament.vlr_ent, 0, 0,;
*				    clienc.inscricao) = 0
*-----------------------------------------------------------



		CASE ORXMLVer_credito(PrmEmpresa,PrmOSI,PrmSerie,;
                              RtnStatus,Rtrn_Vlr_liberado) = 0





			LSsit 	= LEFT(LSsit,1) +"E" && LIBERADO
									  	 &&  NÆo havendo restricoes ao
										 && credito
		OTHERWISE
			LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Nao Existe Dados
									  	 && para liberacao
	ENDCASE

	*------------------------------------------------------------------*
	*	A rotina ORVer_credito desloca os registros de orcament para
	*	pesquisar o debito formado por osis em aberto , por isso e
	*  nescessario reposicionar o orcamento para regravar as codicoes
	*  de liberacao
	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHtenta_lib
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------------*

	SELE liberaco
	IF  RIGHT(LSsit,1) = "E"  && FOI LIBERADO
		m.data 		= 	wp_dtoper
		m.liberador =	0		&& SISTEMA
		m.tp_parcela= 	orcament.tp_parcela
		m.validade	=	wp_dtoper + 30
		m.situacao  =  "LIBE"
		m.limite 	=   orcament.valor - orcament.vlr_ent		
		m.prazomedio=   orcament.prazomedio


		IF FOUND("liberaco")
			IF liberaco.limite > orcament.valor - orcament.vlr_ent		
				m.limite 	= 	liberaco.limite
			ENDIF
			IF liberaco.prazomedio >   orcament.prazomedio
				m.prazomedio=   liberaco.prazomedio
			ENDIF
			=edithand('REGRAVA')
		ELSE
			m.empresa 	= 	orcament.empresa
			m.orcamento	=	orcament.orcamento
			m.limite 	= 	orcament.valor - orcament.vlr_ent		
			m.prazomedio=   orcament.prazomedio
			=edithand('SAVE')
		ENDIF
	ELSE
		m.situacao  =  "BLOQ"
		IF FOUND("liberaco")

			SET FIELDS TO situacao	&& SO ALTERAR CAMPO SITUACAO
									&& OS DEMAIS PERMANECEM
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
		ENDIF
	ENDIF

	SELE orcament
	m.situacao   = LSsit
	SET FIELDS TO situacao, dtregis, hregis, usrregis, deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	*------------------------------------------------------------------*
	DO FCHtenta_lib

RETURN(.T.)


PROCEDURE FCHtenta_lib
	=UP_fecha("orcament",LForcament)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("liberaco" ,LFliberacoes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3VR           ORXMLVer_credito VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   59  º
*       º Variable:            ORXMLVer_credito                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      253                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3vr     &&  ORXMLVer_credito VALID
#REGION 8
RETURN

FUNCTION ORXMLVer_credito
	PARAMETER PrmEmpresa,PrmOSI,PrmSerie,RtnStatus,Rtrn_Vlr_liberado
	



    IF TYPE("PrmSerie") <> "C"
      PrmSerie = "000"
    ENDIF
	


    PrmEspera = "NAO ESPERA"
    RtnStatus = ""


    PRIVATE LSstatus
    LSstatus = ""

    LSstatus=ORRtrnoCnstXMLPddCr(PrmEmpresa, PrmOSI,PrmEspera, RtnStatus, ;
                         Rtrn_Vlr_liberado)

    IF "APROVADO" $ RtnStatus
       LNretorno = 0
    ELSE
       LNretorno = 999
    ENDIF


    IF LSstatus = ""   && nao houve retorno revio
   	   =W_DEFPROC("rotinas.spr")
       =ORXMLRegPede_p_Liberar(PrmEmpresa,PrmOSI,PrmSerie)
    ENDIF




RETURN(LNretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3WA           ORXMLCanc_Libera VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   60  º
*       º Variable:            ORXMLCanc_Libera                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      254                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3wa     &&  ORXMLCanc_Libera VALID
#REGION 8
RETURN

FUNCTION ORXMLCanc_Libera
	PARAMETERS LNemp,LNosi

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: cancela liberacao
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp.......: Empresa em questao
	*		LNosi.......: Nro do Orcamento em questao
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------------*
	PRIVATE LDdt_libera		&& Retorna a Data de liberacao
	PRIVATE LNlim_libera	&& Retorna o valor a praso liberado
	PRIVATE LNlmt_parcela	&& Retorna se Existe Limitacao para Duplcat
	PRIVATE LNlim_prazo		&& Retorna o usuario (neste caso o SISTEMA=0)
	PRIVATE LSsit			&& Retorna a situacao Definida pelo Processo
	PRIVATE LNtp_parcela
	
	PRIVATE LSalias
	PRIVATE LForcament,LFliberacoes
	*-----------------------------------------------------------*
	LSalias	= ALIAS()

	*-----------------------------------------------------------*
	LForcament		= NetArq("orcament")
	LFliberacoes	= NetArq("liberaco")
	*--------------------------------------------------------
    IF (LForcament+LFliberacoes) > 100000
		DO FCHCanc_lib
		RETURN(.f.)
	ENDIF

	*------------------------------------------------------------------*
	SELE orcament
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNosi,6)
	IF !FOUND() OR !REGLOCK()
		DO FCHCanc_lib
		RETURN(.F.)
	ENDIF

	SELE liberaco
	SET ORDER TO TAG liberacao
	SEEK STR(LNemp,3)+STR(LNosi,6)

	LSsit = orcament.situacao
	LSsit 	= LEFT(LSsit,1) +"H" && AGUARDA LIBERACAO
									  	 &&   Existe Restricao a venda
									  	 && com duplicata
	*------------------------------------------------------------------*


	IF ORXMLCanc_credito(PrmEmpresa,PrmOSI,PrmSerie,;
                              RtnStatus,Rtrn_Vlr_liberado) = 0
		SELE liberaco
		m.empresa 	= 	orcament.empresa
		m.orcamento	=	orcament.orcamento
		m.data 		= 	wp_dtoper
		m.liberador =	0		&& SISTEMA
		m.tp_parcela= 	orcament.tp_parcela
		m.validade	=	wp_dtoper + 30
		m.situacao  =  "BLOQ"
		m.limite 	=   0
		m.prazomedio=   0
		IF FOUND("liberaco")
			=edithand('REGRAVA')
		ELSE
			=edithand('SAVE')
		ENDIF
		SELE orcament
		m.situacao   = LSsit
		SET FIELDS TO situacao, dtregis, hregis, usrregis, deletado
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
	ENDIF
	*------------------------------------------------------------------*
	DO FCHCanc_lib

RETURN(.T.)


PROCEDURE FCHCanc_lib
	=UP_fecha("orcament",LForcament)
	=UP_fecha("liberaco" ,LFliberacoes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

****** TODO METODO DEVECONTER ESTA LINHA DE  MARCACAO FINAL *********
******        CASO CONTRARIO PODE HAVER PERDA DE CODIGO *************	


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3WK           ORXMLCanc_credito VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   61  º
*       º Variable:            ORXMLCanc_credito                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      255                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls3wk     &&  ORXMLCanc_credito VALID
#REGION 8
RETURN

FUNCTION ORXMLCanc_credito
	PARAMETER PrmEmpresa,PrmOSI,PrmSerie,RtnStatus,Rtrn_Vlr_liberado
	


    IF TYPE("PrmSerie") <> "C"
      PrmSerie = "000"
    ENDIF
	
	
	=W_DEFPROC("rotinas.spr")
    =ORXMLCanPede_p_Liberar(PrmEmpresa,PrmOSI,PrmSerie)



    PrmEspera = "ESPERA"
    RtnStatus = ""


    =ORRtrnoCnstXMLPddCr(PrmEmpresa, PrmOSI,PrmEspera, RtnStatus, ;
                         Rtrn_Vlr_liberado)


    IF "CANCELADO" $ RtnStatus
       LNretorno = 0
    ELSE
       LNretorno = 999
    ENDIF

RETURN(LNretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3WR           OREnvXMPddCr VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ORCAMNTA,     Record Number:   62  º
*       º Variable:            OREnvXMPddCr                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      256                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3wr     &&  OREnvXMPddCr VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION OREnvXMPddCr
   PARAMETERS PrmEmp,PrmOsi,PrmSerie
	
   IF TYPE("PrmSerie") <> "C"
      PrmSerie = "001"
   ENDIF


   	PRIVATE LSfileXML
   	PRIVATE LSPathOrigem,LSNomeOrigem,LSfileOrigem
   	PRIVATE LSPathDestino,LSNomeDestino,LSfileDestinoOrigem
   	
	*-----------------------------------------------*
	=W_DEFPROC("DUPLICAT.SPR")
   	LSNomeOrigem	= ORNmFileXMLPddCr(PrmEmp,PrmOsi)
	LSPathOrigem    = "C:\NFE\TMP\"
    LSfileOrigem    = LSPathOrigem + LSNomeOrigem

	IF !FILE(LSfileOrigem)
	   RETURN(.F.)
	ENDIF
	*-----------------------------------------------*

   	LSNomeDestino   = LSNomeOrigem

	=W_DEFPROC("PARAMETR.SPR")
	LSPathDestino   = PMGetFieldValue(PrmEmp,"DIR_DFIS")

    IF TYPE("LSPathDestino") <> "C" or EMPTY(LSPathDestino)
         LSPathDestino = "C:\NFE\"
	else
         LSPathDestino = ALLTRIM(LSPathDestino)
    ENDIF


	*--------------------------------------------------*


    LSfileDestino   = LSPathDestino + LSNomeDestino

	*-----------------------------------------------*
			
	=W_DEFPROC("DOCFISCA.SPR")
	=DFCOPYLongo(LSFileOrigem,LSFileDestino)


	IF FILE(LSFileOrigem)
		DELETE FILE &LSFileOrigem
	ENDIF

	*--------------------------------------------------*



RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3WY           CRComandText VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    2  º
*       º Variable:            CRComandText                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      257                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3wy     &&  CRComandText VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRComandText
PARAMETER PrmCommand

	PRIVATE LSalias
	LSalias		= 	ALIAS()
	=CRVerifyInst()
	*--------------------------------------------------------------*
	
	&PrmCommand

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3X4           CRVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    3  º
*       º Variable:            CRVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      258                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3x4     &&  CRVerifyInst VALID
#REGION 9
return
*---------------------------------------------------------------*



FUNCTION CRVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Duplicat")


	DO CASE

		CASE TYPE("PBDuplicatAlias") = "U" ;
		   		OR EMPTY(PBDuplicatAlias) ;
		   		OR !USED(PBDuplicatAlias)
			=CRCreate()					

		CASE !("DUPLICAT.DBF" $ DBF(PBDuplicatAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBDuplicatAlias
			=CRCreate()					


		CASE  !(LSPath $ DBF(PBDuplicatAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=CRDestroi()				
			=CRCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3XA           CRCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    4  º
*       º Variable:            CRCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      259                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3xa     &&  CRCreate VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBDuplicatAlias") <> "U" ;
	   		AND !EMPTY(PBDuplicatAlias) ;
	   		AND USED(PBDuplicatAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBDuplicatAlias

	IF USED("Duplicat")
	     =NetArqAgain("Duplicat")
	     PBDuplicatAlias     = Alias()
	ELSE
	     =NetArqAgain("Duplicat")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Duplicat")
	     PBDuplicatAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBDuplicatAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTDuplicat[LMaxDim]
    PUBLIC DIMENSION VDDuplicat[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFDuplicat[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFDuplicat)



	*-----------------------------------------------------------*
	=CRReadProperty()
	=CRSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3XI           CRDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    5  º
*       º Variable:            CRDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      260                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3xi     &&  CRDestroi VALID
#REGION 9
return
*---------------------------------------------------------------*


FUNCTION CRDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBDuplicatAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBDuplicatAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBDuplicatAlias
	*  3- Se aplicar um FECHAMENTO a PBDuplicatAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBDuplicatAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBDuplicatAlias)) OR ;
	   !("DUPLICAT.DBF" $ DBF(PBDuplicatAlias))

		RELEASE PBDuplicatAlias
    	RELEASE VTDuplicat
	    RELEASE VDDuplicat
		RELEASE VFDuplicat
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBDuplicatAlias) AND USED(PBDuplicatAlias)
		SELECT &PBDuplicatAlias
		USE
	ENDIF	
	RELEASE PBDuplicatAlias
    RELEASE VTDuplicat
    RELEASE VDDuplicat
	RELEASE VFDuplicat

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3XQ           CRReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    6  º
*       º Variable:            CRReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      261                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3xq     &&  CRReadProp VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBDuplicatAlias
	SCATTER TO VTDuplicat
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3XW           CRSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    7  º
*       º Variable:            CRSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      262                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3xw     &&  CRSetDerivadas VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDDuplicat(1,1) = "NAOINFORMADO"
   	VDDuplicat(1,2) = 0
   	VDDuplicat(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3Y2           CRSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    8  º
*       º Variable:            CRSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      263                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3y2     &&  CRSetPropVT VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBDuplicatAlias,;
						    VTDuplicat,;
						    VDDuplicat,;
						    VFDuplicat)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3YA           CRGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:    9  º
*       º Variable:            CRGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      264                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ya     &&  CRGetPropVT VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBDuplicatAlias,;
	            VTDuplicat,;
	            VDDuplicat,;
	            VFDuplicat)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3YG           CRChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   10  º
*       º Variable:            CRChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      265                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3yg     &&  CRChk_Identidade VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRChk_Identidade
PARAMETERS PrmEmpresa, PrmDuplicata
	PRIVATE LFreturn
	=CRVerifyInst()
	*----------------------------------------------------------------*
	LFreturn = .T.
	
    =CRSetPropVT("EMPRESA",PrmEmpresa)
    =CRSetPropVT("DUPLICATA",PrmDuplicata)
	LFreturn=CRFind()
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3YM           CRFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   11  º
*       º Variable:            CRFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      266                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ym     &&  CRFind VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRFind
	PRIVATE Lempresa, Lduplicata
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=CRVerifyInst()

	Lempresa    = CRGetPropVT("EMPRESA")
	Lduplicata  = CRGetPropVT("DUPLICATA")
	

	SELE &PBDuplicatAlias
	SET ORDER TO TAG doc
	SEEK STR(Lempresa,3)+STR(Lduplicata,9)

	IF FOUND()
		=CRReadProperty()
		=CRSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3YS           CRGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   12  º
*       º Variable:            CRGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      267                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3ys     &&  CRGetFieldValue VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRGetFieldValue
PARAMETERS PrmEmpresa, PrmDuplicata,PrmField			


	IF !CRChk_Identidade(PrmEmpresa, PrmDuplicata)
					
		DO WHILE .T.
			=UPerrosys("Chamada GetFieldValue para Reg. Inexistente!")
		ENDDO
	ENDIF				


RETURN(CRGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3YY           CR_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   13  º
*       º Variable:            CR_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      268                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3yy     &&  CR_Refresh VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*




FUNCTION CR_Refresh
PARAMETERS PrmEmpresa, PrmDuplicata


	PRIVATE LFreturn

	=CRVerifyInst()


    =CRSetPropVT("EMPRESA",PrmEmpresa)
    =CRSetPropVT("DUPLICATA",PrmDuplicata)
	LFreturn=CRFind()
RETURN(LFreturn)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3YZ           CRLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   15  º
*       º Variable:            CRLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      269                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3yz     &&  CRLerRegistro VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRLerRegistro
PARAMETERS PrmEmpresa, PrmDuplicata



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = CRChk_Identidade(PrmEmpresa, PrmDuplicata)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3ZB           CRWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   16  º
*       º Variable:            CRWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      270                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3zb     &&  CRWriteProp VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBDuplicatAlias
	=RLOCK()
	GATHER FROM  VTDuplicat
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3ZG           CRSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   17  º
*       º Variable:            CRSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      271                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3zg     &&  CRSalvarRegistro VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRSalvarRegistro

	=CRVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !CRExiste()
		SELE &PBDuplicatAlias
		APPEND BLANK
		LFretorno=CRWriteProp()
	ELSE
		SELE &PBDuplicatAlias
		LFretorno=CRWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3ZN           CRExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   18  º
*       º Variable:            CRExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      272                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3zn     &&  CRExiste VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRExiste
	PRIVATE Lempresa, Lduplicata
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=CRVerifyInst()

	Lempresa    = CRGetPropVT("EMPRESA")
	Lduplicata  = CRGetPropVT("DUPLICATA")
	

	SELE &PBDuplicatAlias
	SET ORDER TO TAG doc
	SEEK STR(Lempresa,3)+STR(Lduplicata,9)

	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS3ZV           CRGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   20  º
*       º Variable:            CRGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      273                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls3zv     &&  CRGetAlias VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRGetAlias

	=CRVerifyInst()

RETURN(PBDuplicatAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS400           CRFaxinaDados VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   21  º
*       º Variable:            CRFaxinaDados                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      274                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls400     &&  CRFaxinaDados VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRFaxinaDados

	PRIVATE LSAlias, TOTAL, CTR

	=CRVerifyInst()

	LSAlias = CRGetAlias()
	
	SELE &LSAlias

	COUNT TO TOTAL
	CTR = 0

	GO TOP
	DO WHILE !EOF()
		=RLOCK()


		CTR = 	CTR + 1
		MSG = STR(CTR,7)+" DE "+STR(TOTAL,7)
		WAIT WINDOW MSG NOWAIT


		REPLACE NOME WITH UPLimpaString(NOME)


		SKIP
	ENDDO
	


RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS407           CRGerXMLDpDocFiscal VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   22  º
*       º Variable:            CRGerXMLDpDocFiscal                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      275                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls407     &&  CRGerXMLDpDocFiscal VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRGerXMLDpDocFiscal
PARAMETER PrmEmpresa,;
		  PrmNro_Orca,;
		  PrmNro_Doc,;
		  PrmMod_doc,;
		  PrmSerie_Doc,;
		  PrmTP_Mov


	PRIVATE LSalias
	
	PRIVATE PrmAlsCR
	PRIVATE LNrecDupl
	
	PRIVATE LNosiReferencia   && relaciona as duplicatas pelo
	                          && orcamento de referencia

	

	LSalias  = ALIAS()
	PrmAlsCR = CRGetAlias()



	*-------------------------------------------------------*
	=CRModeloRefXML()

	*-------------------------------------------------------*

   	PRIVATE LSfileXML,LNroIDfileXML


   	LSfileXML	= CRNmFileXMLDocFiscal(PrmEmpresa,PrmMod_doc,PrmNro_Doc)
   	LSfileXML	= "C:\NFE\TMP\"+LSfileXML


  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return
   	endif





	*---------------------------------------------------*

	SELE &PrmAlsCR
	SET ORDER TO TAG REFR_ORCA
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmNro_Orca,6)
	SET NEAR OFF



	go bott
	go top
	

	SELE &PrmAlsCR
	SET ORDER TO TAG REFR_ORCA
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmNro_Orca,6)
	SET NEAR OFF




	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.


    IF !EOF()
		LNregistro = RECNO()

		COUNT  WHILE !EOF() ;
			AND PrmEmpresa    = &PrmAlsCR .empresa;
	        AND PrmNro_Orca   = &PrmAlsCR .orcamento ;
         TO LNimpressao
		GO LNregistro
	
	ENDIF
	
	LNimpressos = 0
	*----------------------------------------------------*


	=CRInicioXML(LSfileXML,LNroIDfileXML)


	SET POINT TO ','


	SELE &PrmAlsCR
	DO WHILE !EOF() ;
			AND PrmTP_Mov = "SAIDA" ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa       = &PrmAlsCR .empresa;
	        AND PrmNro_Orca       = &PrmAlsCR .orcamento

		=UPtermo()

		IF PrmMod_doc $ "77/03"
		   SKIP
		   LOOP
		ENDIF


		LNrecDupl = RECNO()



		=CRGravaXMLDpDocFiscal(;
 				PrmEmpresa,;
		  		PrmNro_Doc,;
			 	PrmMod_doc,;
			  	PrmSerie_Doc,;
				&PrmAlsCR .Duplicata,;
				LSfileXML,;
				LNroIDfileXML;
				)


		SELE &PrmAlsCR
		SET ORDER TO TAG refr_orca

		GO LNrecDupl
		SKIP
	ENDDO

	=CRFinalXML(LSfileXML,LNroIDfileXML)


	SET POINT TO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =fclose(LNroIDfileXML)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS40I           CRNmFileXMLDocFiscal VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   24  º
*       º Variable:            CRNmFileXMLDocFiscal               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      276                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls40i     &&  CRNmFileXMLDocFiscal VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRNmFileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*



	LSnomeArqXml = "DFISCB"+;
				   PrmMod_Doc
	LSnomeArqXml = CHRTRAN(LSnomeArqXml," ","0")


   	LSfileXML	= LSnomeArqXml+".XML"
	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS40J           CRInicioXML VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   25  º
*       º Variable:            CRInicioXML                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      277                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls40j     &&  CRInicioXML VALID
#REGION 9
RETURN

FUNCTION CRInicioXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML



   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDCCBR
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND xmlDCCBR.XML_ORDEM < 9999999999901
	
		LSLinhaXML = xmlDCCBR.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE xmlDCCBR
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS40V           CRFinalXML VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   26  º
*       º Variable:            CRFinalXML                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      278                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls40v     &&  CRFinalXML VALID
#REGION 9
RETURN

FUNCTION CRFinalXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDCCBR
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF xmlDCCBR.XML_ORDEM > 9999999999900
			LSLinhaXML = xmlDCCBR.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE xmlDCCBR
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS415           CRGravaXMLDpDocFiscal VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   27  º
*       º Variable:            CRGravaXMLDpDocFiscal              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      279                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls415     &&  CRGravaXMLDpDocFiscal VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRGravaXMLDpDocFiscal
PARAMETERS  	PrmEmpresa,;
		  		PrmNro_Doc,;
			 	PrmMod_doc,;
			  	PrmSerie_Doc,;
				PrmDuplicata,;
				PrmFileXML,;
				PrmNroIDfileXML

	PRIVATE LSAlsCR   && DUPLICATAS
	PRIVATE LSAlsCL   && CLIENTES
	PRIVATE LSAlsCL   && CLIENC
    PRIVATE LSalsNF   && NOTA
	

	LSAlsCR = CRGetAlias()

	=W_DEFPROC("CLIENTES.SPR")
	LSAlsCL = CLGetAlias()

	=W_DEFPROC("CLIENC.SPR")
	LSAlsCN = CNGetAlias()


	IF !CRLerRegistro(PrmEmpresa,;
			PrmDuplicata)
	      wait "Nao foi localizado Duplicata :"+;
		      "FILIAL: "+STR(PrmEmpresa,3)+;
		      "NRO.  : "+STR(PrmDuplicata,9)
   	  return(.F.)
    ENDIF



	=W_DEFPROC("NOTA.SPR")
    LSalsNF = NFGetAlias()

	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*

	=W_DEFPROC("EMPRESA.SPR")
	=EMLerRegistro(PrmEmpresa)

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("CGC")
	UNEM_CNPJ    =  STR(LFieldTmp,14)
	UNEM_CNPJ    =  chrtran(UNEM_CNPJ, " ","0")

	SET POINT TO ","
	SET SEPARATOR  TO "."

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('<ROW UNEM_CNPJ="'+UNEM_CNPJ+'"')

		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("EMPRESA.SPR")
	LFieldTmp    =  EMGetPropVT("INSCRICAO")

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('UNEM_IE="'+LFieldTmp+'"')

		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*==========================================================*
	*  IDENTIFICACAO DO DFIS
	*==========================================================*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFIS_MOD_DOCUMENTO="'+;
	             DFGetPropVT("MOD_DOC") +;
	             '"')

		=W_DEFPROC("DOCFISCA.SPR")
        =DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	
	*----------------------------------------------------------*

	IF PrmNro_Doc > 3000000 AND PrmNro_Doc < 4000000

		PrmNro_Doc = PrmNro_Doc - 3000000

	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFIS_NRO_DOCUMENTO="'+;
	             STR(PrmNro_Doc,7) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFIS_SERIE="'+;
	             PrmSerie_Doc +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFIS_CPF="'+;
	             "" +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFIS_CNPJ="'+;
	             "" +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TIPO_COBRANCA="'+;
	             "00" +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




*----------------------------------------------------------------------*

	DO CASE
			CASE     &LSAlsCR .moeda = 2 ;
			      OR &LSAlsCR .banco = 857 ;
				  OR &LSAlsCR .banco = 858

				LScodigo    = "02"
				LSdescricao = "cheque"

			CASE     &LSAlsCR .moeda = 3 ;
			      OR &LSAlsCR .banco = 859 ;
				  OR &LSAlsCR .banco = 860
			
				LScodigo    = "07"
				LSdescricao = "outra"

			CASE  &LSAlsCR .moeda = 4

				LScodigo    = "06"
				LSdescricao = "Cartao Debito"

			CASE  &LSAlsCR .moeda = 5
			
				LScodigo    = "05"
				LSdescricao = "Cartao Credito"

			OTHERWISE

				LScodigo    = "01"
				LSdescricao = "Dinheiro"

	ENDCASE


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_FORMA_PGTO_CODIGO="'+;
	        		     LScodigo +;
				             '"')
	=W_DEFPROC("DOCFISCA.SPR")
	=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_FORMA_PGTO_DESCRICAO="'+;
	        		     LSdescricao +;
				             '"')
	=W_DEFPROC("DOCFISCA.SPR")
	=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

*----------------------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DESCRICAO="'+;
	             "DUPLICATA" +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_NUMERO="'+;
	             ALLTRIM(STR(PrmDuplicata,9)) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_VLR_COBRANCA="'+;
	             STR( &LSAlsCR .VLR_DOC,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*-------------------------------------------------------*
	*-------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_CAIXA="'+;
	             '001' +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*-------------------------------------------------------*
    * AVISO BANCARIO - IDENTIFICACAO DO BANCO PORTADOR INICIAL DA COBRANCA
	*-------------------------------------------------------*

    m.Carteira = ""
    m.Variacao = ""
    m.convenio = ""
    m.conta    = ""
    m.conta_dv = ""
    m.agencia  = 0
    m.agencia_dv= ""

    =CRdefcarteira( &LSAlsCR .Empresa,;
                    &LSAlsCR .PORTADOR,;
                    &LSAlsCR .Tp_Parcela,;
                    "GERADOR DUPLICATA", ;
                    m.Carteira,;
                    m.Variacao,;
			        m.convenio,;
			        m.conta,;
			        m.conta_dv,;
			        m.agencia,;
			        m.agencia_dv)



	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_PORTADOR_BANCO="'+;
	             STR( &LSAlsCR .PORTADOR,3) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")

	LSLinhaXML =  CHRTRAN(STR( m.agencia,4)," ","0") +;
	  	            + ALLTRIM(m.agencia_dv)
	LSLinhaXML =  ALLTRIM( LSLinhaXML)

	LSLinhaXML = ULtratalinha('DFCB_PORTADOR_AGENCIA="'+;
	             LSLinhaXML +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

    *----> DEFINIR ??????

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_PORTADOR_CONTA_CORRENTE="'+;
	             ALLTRIM( m.conta )+;
	             ALLTRIM( m.conta_dv)+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_PORTADOR_CARTEIRA="'+;
	              m.Carteira +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_PORTADOR_VARIACAO="'+;
	              m.Variacao +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_PORTADOR_CONVENIO="'+;
	              m.convenio +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*-------------------------------------------------------*
    * AVISO BANCARIO - IDENTIFICACAO DO BANCO DESTINO DA COBRANCA
	*-------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DESTINO_BANCO="'+;
	             STR( &LSAlsCR .BANCO,3) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	LSLinhaXML =  CHRTRAN(STR( &LSAlsCR .AGENCIA ,4)," ","0") +;
	  	            + ALLTRIM( &LSAlsCR .agencia_dv)
	LSLinhaXML =  ALLTRIM( LSLinhaXML)

	LSLinhaXML = ULtratalinha('DFCB_DESTINO_AGENCIA="'+;
	             LSLinhaXML +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DESTINO_CONTA_CORRENTE="'+;
	             ALLTRIM( &LSAlsCR .conta)+;
	             ALLTRIM( &LSAlsCR .conta_dv)+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DESTINO_CARTEIRA="'+;
	              &LSAlsCR .CARTEIRA +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DESTINO_VARIACAO="'+;
	              ALLTRIM( &LSAlsCR .VARIACAO) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DESTINO_CONVENIO="'+;
	              ALLTRIM( &LSAlsCR .CONVENIO) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*-------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TIPO_AVISO="'+;
	             'VENDAS DO DIA' +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

    LNnroAviso =  chrtran(STR(YEAR(  &LSAlsCR .DT_EMI),4), " ","0");
                + chrtran(STR(MONTH( &LSAlsCR .DT_EMI),2), " ","0");
                + chrtran(STR(DAY( &LSAlsCR .DT_EMI),2), " ","0")

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_NUMERO_AVISO="'+;
	             LNnroAviso +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DT_AVISO="'+;
	             DTOC( &LSAlsCR .DT_EMI) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*-------------------------------------------------------*
    * ITENS  DO DOCUMENTO FINANCEIRO - IDENTIFICACAO DO TITULO
	*-------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TITULO_NUMERO="'+;
	             ALLTRIM(STR(PrmDuplicata,9)) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TITULO_NOSSO_NUMERO="'+;
	              &LSAlsCR .NUM_NO_BCO +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TITULO_CODIGO="'+;
	              &LSAlsCR .CODPARCELA +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_SEQUENCIA_TITULO="'+;
	              STR( &LSAlsCR .SEQUENCIA ,6) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TOTAL_TITULOS="'+;
	             STR( &LSAlsCR .QTPARCELAS ,6) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))







	*-------------------------------------------------------*
    *  IDENTIFICACAO DOS DOCUMENTOS REFERENCIADOS NO TITULO
	*-------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_FATURA_NUMERO="'+;
	             STR( &LSAlsCR .NOTA,7) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_NUMERO_RECIBO="'+;
	             STR( 0,7) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_PEDIDO_NUMERO="'+;
	             STR( &LSAlsCR .ORCAMENTO,7) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*-------------------------------------------------------*
    *  INFORMACOES DA NEGOCIACAO
	*-------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_IND_OPERACAO="'+;
	             'RECEBER'+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



    IF &LSAlsCR .DT_VENC = &LSAlsCR .DT_EMI
		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = ULtratalinha('DFCB_TIPO_PARCELA="'+;
		             'ENTRADA'+;
		             '"')

	ELSE
		=W_DEFPROC("DOCFISCA.SPR")
		LSLinhaXML = ULtratalinha('DFCB_TIPO_PARCELA="'+;
		             'PARCELAS'+;
		             '"')
	ENDIF

		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*-------------------------------------------------------*
    private LSmddoc, LScpmref
	=W_DEFPROC("DOCFISCA.SPR")
	LSmddoc =  DFGetPropVT("MOD_DOC")

	=W_DEFPROC("DOCFISCA.SPR")
	LScpmref=  DFGetPropVT("NRO_CPMECF")
	LScpmref=  val(LScpmref)

	IF LScpmref = 0 OR  LSmddoc = "2D"
	      LSLinhaXML = "SIM"
    ELSE
	      LSLinhaXML = "NAO"
	ENDIF
	

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_IMPRIMIR_BOLETO="'+;
	             LSLinhaXML +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DATA_EMISSAO="'+;
	             DTOC( &LSAlsCR .DT_EMI) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DATA_VENCIMENTO="'+;
	             DTOC( &LSAlsCR .DT_VENC) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DATA_DESCONTO="'+;
	             DTOC( &LSAlsCR .DT_P_DESCT) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DATA_COBRARMORAJUROS="'+;
	             DTOC( &LSAlsCR .DT_CBR_JRS) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DATA_PROTESTAR="'+;
	             DTOC( &LSAlsCR .DT_PROTEST) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*---------------------------------------------------*			
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_VLR_DESCONTO="'+;
	             STR( &LSAlsCR .VLR_DSCT,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_VLR_MORA="'+;
	             STR( &LSAlsCR .VLR_MORA,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_VLR_JUROS="'+;
	             STR( &LSAlsCR .VLR_JUROS,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_VLR_ISS_RETIDO="'+;
	             STR( &LSAlsCR .VLR_ISSRTD,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_VLR_DOCUMENTO="'+;
	             STR( &LSAlsCR .VLR_DOC,18,4) +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))






	*---------------------------------------------------*			
	private LNcpfcnpjc,LNim,LNie,LNnome,LNrazao,LNendereco
	private LNbairro,LNcidade,LNestado,	LNcep,LNibge
	private LNe_mail,LNddd,LNfone,LNobs



	LNcpfcnpjc = chrtran(str( &LSAlsCR .cliente,14)," ","0")
	LNim       =  &LSAlsCL .im_tomador
	LNie       =  &LSAlsCL .inscricao

	=W_DEFPROC("CLIENTES.SPR")
	IF CLLerRegistro( &LSAlsCR .CLIENTE)

		IF EMPTY(ALLTRIM( &LSAlsCL .cbnome)) OR ;
		   EMPTY(ALLTRIM( &LSAlsCL .cbendereco))
			LNnome	    =  &LSAlsCL .nome
			LNrazao	    =  &LSAlsCL .nome
			LNendereco 	=  &LSAlsCL .endereco
			LNbairro	=  &LSAlsCL .bairro
			LNcidade	=  &LSAlsCL .cidade
			LNestado	=  &LSAlsCL .estado
			LNcep		=  &LSAlsCL .cep
			LNibge      =  STR( &LSAlsCL .muni_ibge ,11)
			LNe_mail    =  &LSAlsCL .e_mail
			LNddd       = left( &LSAlsCL .fone,2)
			LNfone      = left( subs( &LSAlsCL .fone ,3),8)
		ELSE
			LNnome	    =  &LSAlsCL .CBnome
			LNrazao	    =  &LSAlsCL .CBnome
			LNendereco 	=  &LSAlsCL .CBendereco
			LNbairro	=  &LSAlsCL .CBbairro
			LNcidade	=  &LSAlsCL .CBcidade
			LNestado	=  &LSAlsCL .CBestado
			LNcep		=  &LSAlsCL .CBcep
			LNibge      =  STR( &LSAlsCL .muni_ibge , 11)
			LNe_mail    =  &LSAlsCL .e_mail
			LNddd       = left( &LSAlsCL .cbfone,2)
			LNfone      = left( subs( &LSAlsCL .cbfone ,3),8)
		ENDIF
		*---------------------------------------------------*			
	ELSE
*----------- A BUSCA NO CLIENC ESTVA DIFICULTANDO A CORRECAO QDO HAVIA
*        PROBLEMAS COM ESTA ALTERACAO E POSSIVEL CORRIGIR NA NOTA E REEMITIR
*------------------------------------------------------------------
*  	    =W_DEFPROC("CLIENC.SPR")
*		IF CNLerRegistro( &LSAlsCR .Empresa ,  &LSAlsCR .Orcamento)
*			LNnome	    =  &LSAlsCN .nome
*			LNrazao	    =  &LSAlsCN .nome
*			LNendereco 	=  &LSAlsCN .endereco
*			LNbairro	=  &LSAlsCN .bairro
*			LNcidade	=  &LSAlsCN .cidade
*			LNestado	=  &LSAlsCN .estado
*			LNcep		=  &LSAlsCN .cep
*			LNibge      =  STR( &LSAlsCN .muni_ibge ,11)
*			LNe_mail    =  &LSAlsCN .e_mail
*			LNddd       = left( &LSAlsCN .fone,2)
*			LNfone      = left( subs( &LSAlsCN .fone ,3),8)
*------------------------------------------------------------------
*			

		=W_DEFPROC("NOTA.SPR")
		IF NFLerRegistro( &LSAlsCR .Empresa ,  &LSAlsCR .NOTA )

			LNnome	    =  &LSalsNF .nome
			LNrazao	    =  &LSalsNF .nome
			LNendereco 	=  &LSalsNF .endereco
			LNbairro	=  &LSalsNF .bairro
			LNcidade	=  &LSalsNF .cidade
			LNestado	=  &LSalsNF .UF

*****   	LNcep		=  &LSalsNF .cep


            LNcep		=  CHRTRAN(str( &LSalsNF .cep ,8)," ","0")
			
			LNibge      =  STR( &LSalsNF .muni_ibge ,11)
			LNe_mail    =  &LSalsNF .e_mail
			LNddd       = left( &LSalsNF .fone,2)
			LNfone      = left( subs( &LSalsNF .fone ,3),8)

		ELSE
			LNnome	    =  'CONSUMIDOR'
			LNrazao	    =  ''
			LNendereco 	=  ''
			LNbairro	=  ''
			LNcidade	=  ''
			LNestado	=  ''
			LNcep		=  ''
			LNibge      =  ''
			LNe_mail    =  ''
			LNddd       =  ''
			LNfone      =  ''
		ENDIF

	ENDIF


	IF "NAO@INFORMADO" $ UPPER(LNe_mail)
       	LNe_mail    =  ''
    ENDIF



	*-------------------------------------------------------*
    *  INFORMACOES DA PARTICIPANTE
	*-------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_CPFCNPJ="'+;
	             LNcpfcnpjc+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_FISICO_JURIDICO="'+;
	             ''+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_UF="'+;
	             LNestado+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_IM="'+;
	             LNim+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_IE="'+;
	             LNie+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*----------------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = CRLimpaString(LNnome)


	=W_DEFPROC("DOCFISCA.SPR")
  	    LSLinhaXML = ('DFCB_NOME="'+;
	             LSLinhaXML+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*----------------------------------------------------------------*


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = CRLimpaString(LNrazao)


	LSLinhaXML = ('DFCB_RAZAO_SOCIAL="'+;
	             LSLinhaXML +;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


*----------------------------------------------------------------*


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_TP_LOGRADOURO="'+;
	             ''+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_LOGRADOURO="'+;
	             LNendereco+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_NRO_LOGRADOURO="'+;
	             ''+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_COMPL_LOGRADOURO="'+;
	             ''+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_CEP="'+;
	             LNcep+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_IBGE="'+;
	             LNibge+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_MUNI_NOME="'+;
	             LNcidade+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_BAIRRO="'+;
	             LNbairro+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_CODIGO_PAIS="'+;
	             '1058'+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_NOME_PAIS="'+;
	             'BRASIL'+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_DDD="'+;
	             LNddd+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_FONE="'+;
	             LNfone+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_E_MAIL="'+;
	             LNe_mail+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

    *--------------------------------------------------------*
    *----- INSTRUCOES
    *--------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_INSTRUCOES_LOCAL_PAGAMENTO="'+;
	             "PAGAVEL EM QUALQUER BANCO ATE O VENCIMENTO"+;
	             '"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




    *--------------------------------------------------------*
    *----- ABERTURA DO CAMPO OBSERVACAO
    *--------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('DFCB_OBSERVACAO="')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *--------------------------------------------------------*
	LNobs       =  RTRIM( &LSAlsCR .OBS ) + ";"
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha(LNobs)
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

*----->
	IF  &LSAlsCR .DT_PROTEST <> {}
		LSLinhaXML = "Protestar em "+dtoc( &LSAlsCR .DT_PROTEST  )+ ";"
	ELSE
		LSLinhaXML = ""
	ENDIF
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha(LSLinhaXML)
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*----->
	IF  &LSAlsCR .vlr_mora > 0
		LSLinhaXML="Cobrar juros de R$ "
		tmpvalor = ;
		   strtran(str(  &LSAlsCR .vlr_mora ,10,2),".",",")
		tmpvalor = strtran(tmpvalor," ","")
		LSLinhaXML = LSLinhaXML + tmpvalor
		LSLinhaXML = LSLinhaXML + " para pagamento apos ";
		         + DTOC( &LSAlsCR .dt_venc )+ ";"
		
	ELSE
		LSLinhaXML = ";"
	ENDIF
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha(LSLinhaXML)
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*----->
*----->
	LSLinhaXML = ""
	IF  &LSAlsCR .nota > 0
		LSLinhaXML="Boleto Ref. N.F. Nro - "+STR( &LSAlsCR .nota,8)
	ENDIF
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha(LSLinhaXML)
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*----->
	IF  &LSAlsCR .vlr_issrtd  > 0

		LSLinhaXML = "ISS Retido no valor de R$ "
			
		tmpvalor = ;
		   strtran(str(   &LSAlsCR .vlr_issrtd ,10,2),".",",")
		tmpvalor = strtran(tmpvalor," ","")
		LSLinhaXML = LSLinhaXML + tmpvalor
	ELSE
		LSLinhaXML = ""
	ENDIF
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha(LSLinhaXML)
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*----->
	IF   &LSAlsCR .tp_parcela = 7		
		LSLinhaXML = "PARC:"+;
		   ALLTRIM(  &LSAlsCR .CODPARCELA)+;
		" - "+STR(  &LSAlsCR .sequencia,3)+;
	   	" de "+STR(  &LSAlsCR .qtparcelas,3)
	ELSE
		LSLinhaXML = ""
	ENDIF
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha(LSLinhaXML)
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
*----->

    *--------------------------------------------------------*
    *----- FECHAMENTO DO CAMPO OBSERVACAO
    *--------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('"')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *--------------------------------------------------------*

	*-------------------------------------------------------*
	=W_DEFPROC("DOCFISCA.SPR")
	LSLinhaXML = ULtratalinha('/>')
		=W_DEFPROC("DOCFISCA.SPR")
		=DF_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))



	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS42B           CRModeloRefXML VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   28  º
*       º Variable:            CRModeloRefXML                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      280                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls42b     &&  CRModeloRefXML VALID
#REGION 9
RETURN

FUNCTION CRModeloRefXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\DOCCOBR.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\xmlDCCBR EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE xmlDCCBR


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS42I           CRExpCapaRetLegado VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   29  º
*       º Variable:            CRExpCapaRetLegado                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      281                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls42i     &&  CRExpCapaRetLegado VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRExpCapaRetLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	PRIVATE LSAlsCobr    && Cobranca
	PRIVATE LSAlsAviso   && RetornBC
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()

	SELE COBRANCA
	LSAlsCobr = alias()


	SELE RETORNBC
	LSAlsAviso = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."
	

	LSLinhaXML  = chrtran(STR( &LSAlsEmp .CGC ,14), " ","0")
	LSLinhaXML  = CRtratalinha('<ROW UNEM_CNPJ="'+LSLinhaXML+'"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LFieldTmp   =  &LSAlsEmp .INSCRICAO
	LSLinhaXML  = CRtratalinha('UNEM_IE="'+LFieldTmp+'"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	*----------------------------------------------------------*

	LSLinhaXML  =  "001"
	LSLinhaXML  = CRtratalinha('DFIN_CAIXA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	if &LSAlsAviso .banco = 990
		LSLinhaXML  =  "Registro"
	else
		LSLinhaXML  =  "Retorno"
	endif


	LSLinhaXML  = CRtratalinha('DFIN_TIPO_AVISO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsAviso .AVISO ,8), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_NUMERO_AVISO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsAviso .DTAVISO ), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_DT_AVISO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsAviso .DTPROCESSO ), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_DT_PROCESSAMENTO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsAviso .REG_TOTAL ,3), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_QTDE_ITENS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsAviso .TOT_DOC ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_VLR_DOCUMENTOS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  "Processado"
	LSLinhaXML  = CRtratalinha('DFIN_STATUS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsAviso .REG_PROCES ,3), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_QTDE_ITENS_PROCESSADOS="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsAviso .REG_REJEIT ,3), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_QTDE_ITENS_REJEITADOS="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsAviso .REG_DESCAR ,3), " ","0")
	LSLinhaXML  = CRtratalinha('DFIN_QTDE_ITENS_COM_ERRO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS42S           CRAvsExpNro VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   30  º
*       º Variable:            CRAvsExpNro                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      282                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls42s     &&  CRAvsExpNro VALID
#REGION 9
RETURN

FUNCTION CRAvsExpNro
	PARAMETERS ;
	    PrmEmp,PrmBanco,PrmCarteira,PrmVariacao,PrmAviso

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFmvretorn,LFbcretorn,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBanco
	PRIVATE LNCtrItens

    PRIVATE PrmData

	LSalias = ALIAS()

	LFempresa		= NetArq("empresa")
	LFbcretorn		= NetArq("retornbc")
	LFmvretorn		= NetArq("retornmv")
	LFcobranca		= NetArq("cobranca")
	LFBanco 		= NetArq("banco")
	LFduplicat		= NetArq("duplicat")
	LFclienc		= NetArq("clienc")
	LFclintes		= NetArq("clientes")
	
	LFNota   		= NetArq("nota")
	IF (LFEmpresa+LFmvretorn+LFbcretorn+LFduplicat+LFBanco+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHProcBaixa
		RETURN(.f.)
	ENDIF



    SELE Empresa
    SET ORDER TO TAG empresa
    SEEK PrmEmp
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Empresa : "+;
				STR(PrmEmp,3)
      	DO  FCHProcExpAviso
		RETURN(.F.)
	ENDIF


	SELE retornbc
	SET ORDER TO TAG aviso
	SEEK STR(PrmEmp,3)+STR(PrmBanco,3)+;
	   PrmCarteira+PrmVariacao+STR(PrmAviso,8)
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Aviso : "+;
				STR(PrmAviso,8)+" do Banco : "+ STR(PrmBanco,3)
      	DO  FCHProcExpAviso
		RETURN(.F.)
	ENDIF

    IF empty(retornbc.dtaviso)
		DO OBJ_MENS.SPR WITH ;
			"    Data do Aviso Deve ser Preenchida "+;
				STR(LNaviso,8)+" do Banco : "+ STR(LNbanco,3)
      	DO  FCHProcExpAviso
		RETURN(.F.)
	ENDIF

    SELE cobranca
    SET ORDER TO TAG CARTEIRA
    SEEK STR(PrmEmp,3)+STR(PrmBanco,3)+ PrmCarteira+PrmVariacao
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar COBRANCA : ";
		        +"Aviso:"   +STR(PrmAviso,8);
				+" Banco:"	+ STR(PrmBanco,3);
				+" Carteira:"	+ PrmCarteira;
				+" Variacao:"	+ PrmVariacao
      	DO  FCHProcExpAviso
		RETURN(.F.)
	ENDIF



	SELE banco
	SET ORDER TO TAG BANCO
	SEEK PrmBanco
	IF !FOUND()
			DO OBJ_MENS.SPR WITH ;
			"    Nao Foi Possivel Localizar BANCO : ";
		        +"Aviso:"   +STR(PrmAviso,8);
				+" Banco:"	+ STR(PrmBanco,3);
				+" Carteira:"	+ PrmCarteira;
				+" Variacao:"	+ PrmVariacao
		    SELE &LSAlsPeriodo
		    SKIP
		    LOOP
	ENDIF




	*-------------------------------------------------------*
	=CRAvsModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML


    PrmData   =  retornbc.dtaviso

*-----------------------------------------------------*
*   	LSfileXML	= CRAvsNmXMLExpt(PrmEmp, PrmData)
*   	LSfileXML	= "C:\DUPL\TMP\"+LSfileXML
*-----------------------------------------------------*



    *-----------------------------------------------*
    *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
    *-----------------------------------------------*
   	LSfileXML	= CRAvsNmXMLExpt(PrmEmp, PrmData)
   	LSdirtmpXML	= CRPthTmpDup(PrmEmp)

  	LSfileXML	= LSdirtmpXML    +    LSfileXML

    *-----------------------------------------------*


  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return
   	endif

	*---------------------------------------------------*
	=CRAvsIniXML(LSfileXML,LNroIDfileXML)
	*----------------------------------------------------*

    LNCtrItens = 0

	SELECT  retornmv
	SET ORDER TO TAG aviso
	SEEK STR(PrmEmp,3)+STR(PrmBanco,3)+;
	     PrmCarteira+PrmVariacao+STR(PrmAviso,8)


	DO WHILE  !EOF() AND ;
	    PrmAviso     = retornmv.aviso AND ;
		PrmBanco     = retornmv.banco AND ;
		PrmCarteira = retornmv.carteira AND ;
		PrmVariacao = retornmv.Variacao AND ;
		PrmEmp 	    = retornmv.empresa
		
        LNCtrItens = LNCtrItens + 1


        *------------------------------------------------*
        *  aqui chamada geracao do xml do capa do aviso   *------------------------------------------------*
        =CRExpCapaRetLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

        *------------------------------------------------*
        *  aqui chamada geracao do xml do ilocal cobranca
        *------------------------------------------------*
        =CRExpLccbrCapaRetLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

		SELE duplicat
		SET ORDER TO TAG doc
		SEEK STR(PrmEmp,3)+STR(retornmv.duplicata,9)
		IF FOUND()



            *------------------------------------------------*
            *  aqui chamada geracao do xml da duplicata            *------------------------------------------------*
            =CRExpItemRetLegado(LNCtrItens,;
                                LSfileXML,LNroIDfileXML)

            *------------------------------------------------*
            *  aqui chamada geracao do xml das duplicatas            *------------------------------------------------*
            =CRExpDuplRetLegado(LSfileXML,LNroIDfileXML)



            *------------------------------------------------*
            *  aqui chamada geracao do xml do clienc            *------------------------------------------------*
            =CRExpClieDupLegado(LSfileXML,LNroIDfileXML)

			SELE retornmv
		ENDIF
		*------------------------------------------------------*
		SELE retornmv
		SKIP
	ENDDO


	=CRAvsFinML(LSfileXML,LNroIDfileXML)

    =fclose(LNroIDfileXML)


    =CRAvsEnviaXML(PrmEmp,PrmData)

  	
	***************************

	DO  FCHProcExpAviso

	UNLOCK
RETURN(.T.)

PROCEDURE FCHProcExpAviso
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("cobranca" ,LFcobranca)
	=UP_fecha("retornbc" ,LFbcretorn)
	=UP_fecha("banco" ,LFbanco)
	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("nota" ,LFnota)
	=UP_fecha("clientes" ,LFclintes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS435           CRAvsModeloXML VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   31  º
*       º Variable:            CRAvsModeloXML                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      283                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls435     &&  CRAvsModeloXML VALID
#REGION 9
RETURN

FUNCTION CRAvsModeloXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\xmlDFin.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\xmlDFin EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE xmlDFin


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS43C           CRAvsIniXML VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   32  º
*       º Variable:            CRAvsIniXML                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      284                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls43c     &&  CRAvsIniXML VALID
#REGION 9
RETURN

FUNCTION CRAvsIniXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML



   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDFin
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND xmlDFin.XML_ORDEM < 9999999999901
	
		LSLinhaXML = xmlDFin.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE xmlDFin
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS43J           CRAvsFinML VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   33  º
*       º Variable:            CRAvsFinML                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      285                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls43j     &&  CRAvsFinML VALID
#REGION 9
RETURN

FUNCTION CRAvsFinML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDFin
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF xmlDFin.XML_ORDEM > 9999999999900
			LSLinhaXML = xmlDFin.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE xmlDFin
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS43K           CRExpItemRetLegado VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   34  º
*       º Variable:            CRExpItemRetLegado                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      286                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls43k     &&  CRExpItemRetLegado VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRExpItemRetLegado
PARAMETERS 	PrmCtrItem,;
			PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsItem    && RetornMV
	

	AlsANT = ALIAS()


	SELE RETORNMV
	LSAlsItem = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."

	*==========================================================*
	*  ITENS DO DOC FINANCEIRO - IDENTIFICACAO DO TITULO
	*==========================================================*
	LSLinhaXML  = chrtran(STR( PrmCtrItem ,3), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_SEQUENCIA_ITEM="';
	    + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	LSLinhaXML  = chrtran(STR( &LSAlsItem .OCORRENCIA ,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_OCORRENCIA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
          CASE &LSAlsItem .EFEITO = 01
            LSLinhaXML  = "15"      && Registro de Titulo -
          CASE &LSAlsItem .EFEITO = 02
            LSLinhaXML  = "01"      && Baixa Total
          CASE &LSAlsItem .EFEITO = 03
            LSLinhaXML  = "02"      && Baixa Parcial
          CASE &LSAlsItem .EFEITO = 04
            LSLinhaXML  = "11"      && Devolucao
          CASE &LSAlsItem .EFEITO = 05
            LSLinhaXML  = "12"      && Incobravel
          CASE &LSAlsItem .OCORRENCIA = 02
            LSLinhaXML  = "07"      && Registro de Entrada
          CASE &LSAlsItem .OCORRENCIA = 09
            LSLinhaXML  = "16"      && Baixa de Cobranca Banco
          CASE &LSAlsItem .OCORRENCIA = 10
            LSLinhaXML  = "16"      && Baixa de Cobranca Banco
          otherwise
            LSLinhaXML  = "00"      && Nao fazer nada / sem efeito

    ENDCASE
	LSLinhaXML  = CRtratalinha('ITDFIN_EFEITO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
          CASE &LSAlsItem .OCORRENCIA = 02
            LSLinhaXML  = "Registro de Entrada"
          CASE &LSAlsItem .OCORRENCIA = 09
            LSLinhaXML  = "Baixa de Cobranca Banco"
          CASE &LSAlsItem .OCORRENCIA = 10
            LSLinhaXML  = "Baixa de Cobranca Banco"
          CASE &LSAlsItem .EFEITO = 01
            LSLinhaXML  = "Registro de Titulo"
          CASE &LSAlsItem .EFEITO = 02
            LSLinhaXML  = "Baixa Total"
          CASE &LSAlsItem .EFEITO = 03
            LSLinhaXML  = "Baixa Parcial"
          CASE &LSAlsItem .EFEITO = 04
            LSLinhaXML  = "Devolucao"
          CASE &LSAlsItem .EFEITO = 05
            LSLinhaXML  = "Incobravel"
          otherwise
            LSLinhaXML  = "Nao fazer nada"

    ENDCASE
	LSLinhaXML  = CRtratalinha('ITDFIN_EFEITO_DESCRICAO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsItem .MOTIVOS )
	LSLinhaXML  = CRtratalinha('ITDFIN_MOTIVOS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsItem .NUM_NO_BCO )
	LSLinhaXML  = CRtratalinha('ITDFIN_NOSSO_NUMERO="'+;
	          LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .BANCO_COBR ,3), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_BANCO_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .AGENC_COBR ,5), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_AGENCIA_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .DSP_COBR ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_DESPESAS_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .OUT_DESP ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_OUTRAS_DESPESAS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .JUROS ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_JUROS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .IOF ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_IOF="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .ABATIMENTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_ABATIMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .DESCONTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_DESCONTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .MORA ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_MORA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .OUT_CREDT ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_OUTROS_CREDITOS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


    DO CASE
		CASE  &LSAlsItem .ocorrencia = 19 && INSTR. PROTESTO CONFIRMADO
			LSLinhaXML 	=  	"Sim"
		CASE retornmv.ocorrencia = 20 && INSTR. PROTESTO CANCELAD 					
			LSLinhaXML 	=  	"Nao"
		CASE retornmv.ocorrencia = 23 && ENTRADA CARTORIO
			LSLinhaXML 	=  	"Sim"
		CASE retornmv.ocorrencia = 34 && ENTRADA CARTORIO
			LSLinhaXML 	=  	"Sim"
        OTHERWISE
			LSLinhaXML 	=  	"Nao"

    ENDCASE
	LSLinhaXML  = CRtratalinha('ITDFIN_ENVIADA_CARTORIO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsItem .DTOCORRENC ), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_DT_OCORRENCIA="';
	          + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsItem .VLR_PGTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('ITDFIN_VLR_PGTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
        CASE &LSAlsItem .STATUS = "AP"
         	LSLinhaXML  = "Processar"
        CASE &LSAlsItem .STATUS = "PR"
         	LSLinhaXML  = "Processado"
        CASE &LSAlsItem .STATUS = "RJ"
         	LSLinhaXML  = "Rejeitado"
        otherwise
         	LSLinhaXML  = &LSAlsItem .STATUS
    ENDCASE

	LSLinhaXML  = CRtratalinha('ITDFIN_STATUS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS443           CRExpDuplRetLegado VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   35  º
*       º Variable:            CRExpDuplRetLegado                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      287                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls443     &&  CRExpDuplRetLegado VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRExpDuplRetLegado
PARAMETERS	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsDupl    && Duplicat
	PRIVATE LSAlsEmp    && Duplicat
	

	AlsANT = ALIAS()


	SELE EMPRESA
	LSAlsEmp = alias()


	SELE DUPLICAT
	LSAlsDupl = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."

	*==========================================================*
	*  TITULO - DADOS DO TITULO NAO RELACIONADOS A OCORRENCIA
	*==========================================================*

	LSLinhaXML  = chrtran(STR( &LSAlsDupl .PORTADOR ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_PORTADOR_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .PAGA_EM ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_RECEBEDOR_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .BANCO ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_CEDENTE_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = &LSAlsDupl .CARTEIRA
	LSLinhaXML  = CRtratalinha('TTL_CEDENTE_CARTEIRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = &LSAlsDupl .VARIACAO
	LSLinhaXML  = CRtratalinha('TTL_CEDENTE_VARIACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML = chrtran(ALLTRIM(STR( &LSAlsDupl .DUPLICATA ,15)), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = ALLTRIM(  &LSAlsDupl .CODPARCELA )
	LSLinhaXML  = CRtratalinha('TTL_CODIGO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = ALLTRIM( &LSAlsDupl .NUM_NO_BCO )
	LSLinhaXML  = CRtratalinha('TTL_NOSSO_NUMERO="'+;
	          LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .SEQUENCIA ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_NUMERO_PARCELA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .QTPARCELAS ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_QTDE_PARCELAS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(STR(  &LSAlsDupl .vlrparcini ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_INICIAL_DOCUMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


	LSLinhaXML  = chrtran(STR(  &LSAlsDupl .VLR_DOC ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DOCUMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_EMI ), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_EMISSAO="';
	          + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_VENC ), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_VENCIMENTO="';
	          + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsDupl .COD_BARRA
	LSLinhaXML  = CRtratalinha('TTL_COD_BARRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	PRIVATE  ;
    	    PrmEmpresa;
        	PrmNota
	PRIVATE  ;
    		PrmSerie,;
	 		PrmTipo,;
     		RtnNro_Doc,;
	 		RtnMod_Doc,;
	 		RtnCOD_IDFORN,;
	 		RtnSerie_Doc


    SELE nota
    set order to tag nota

    SEEK STR(  &LSAlsDupl .EMPRESA,3)+STR(  &LSAlsDupl .NOTA,7)
    IF FOUND()

    	    PrmEmpresa      = nota.empresa
        	PrmNota         = nota.nota
			PrmSerie   		= nota.Serie
			PrmTipo    		= nota.Tipo
			RtnNro_Doc 		= 0
		 	RtnMod_Doc		= ""
			RtnCOD_IDFORN	= ""
			RtnSerie_Doc	= ""
	
			=W_DEFPROC("DOCFISCA.SPR")
			=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)
    ELSE
    	    PrmEmpresa      = &LSAlsDupl .empresa
        	PrmNota         = &LSAlsDupl .NOTA
			PrmSerie   		= "001"
			PrmTipo    		= ""
			RtnNro_Doc 		= 0
		 	RtnMod_Doc		= ""
			RtnCOD_IDFORN	= ""
			RtnSerie_Doc	= ""

			=W_DEFPROC("DOCFISCA.SPR")
			=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)

    ENDIF
	*----------------------------------------------------------*
	LSLinhaXML  = RtnMod_Doc
	LSLinhaXML  = CRtratalinha('TTL_DOC_FISCAL_MODELO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( RtnNro_Doc,7), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DOC_FISCAL_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = RtnSerie_Doc
	LSLinhaXML  = CRtratalinha('TTL_DOC_FISCAL_SERIE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .NOTA ,7), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_FATURA_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .ORCAMENTO ,7), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_PEDIDO_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

    IF &LSAlsDupl .BANCO = 900
		LSLinhaXML  = "Pagar"
     ELSE
		LSLinhaXML  = "Receber"
	ENDIF

	LSLinhaXML  = CRtratalinha('TTL_IND_OPERACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    IF &LSAlsDupl .DT_EMI = &LSAlsDupl .DT_VENC
	      LSLinhaXML  = "Entrada"
	ELSE
	      LSLinhaXML  = "Parcelas"
	ENDIF
	LSLinhaXML  = CRtratalinha('TTL_TIPO_PARCELA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsDupl .TP_COBRANC ,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_TP_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
          CASE  &LSAlsDupl .TP_COBRANC = 01
            LSLinhaXML  = "Simples"
          CASE  &LSAlsDupl .TP_COBRANC = 06
            LSLinhaXML  = "Vendor"
          CASE  &LSAlsDupl .TP_COBRANC = 88
            LSLinhaXML  = "Cartorio"
          CASE  &LSAlsDupl .TP_COBRANC = 99
            LSLinhaXML  = "Incobravel"
          OTHERWISE = 01
            LSLinhaXML  = "N/Informado"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_TP_COBRANCA_DESCRICAO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
        CASE &LSAlsDupl .MOEDA = 00
              LSLinhaXML  = "Dinheiro"
        CASE &LSAlsDupl .MOEDA = 01
              LSLinhaXML  = "Dinheiro"
        CASE &LSAlsDupl .MOEDA = 02
              LSLinhaXML  = "Cheque"
        CASE &LSAlsDupl .MOEDA = 03
              LSLinhaXML  = "Duplicata"
        CASE &LSAlsDupl .MOEDA = 04
              LSLinhaXML  = "Cartao Debito"
        CASE &LSAlsDupl .MOEDA = 05
              LSLinhaXML  = "Cartao Credito"
        OTHERWISE
              LSLinhaXML  = "Dinheiro"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_FORMA_PGTO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
        CASE &LSAlsDupl .Natu = 00
              LSLinhaXML  = "Varejo"
        CASE &LSAlsDupl .Natu = 01
              LSLinhaXML  = "Revenda"
        CASE &LSAlsDupl .Natu = 02
              LSLinhaXML  = "Poder Publico"
        CASE &LSAlsDupl .Natu = 03
              LSLinhaXML  = "Frota"
        OTHERWISE
              LSLinhaXML  = "Varejo"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_NATUREZA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

    IF &LSAlsDupl .CONFNROBCO = .t.
        LSLinhaXML  = "Sim"
    else
        LSLinhaXML  = "Nao"
    ENDIF
	LSLinhaXML  = CRtratalinha('TTL_CONFIRMADO_NRO_BANCO="';
	    + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = "Nao"
	LSLinhaXML  = CRtratalinha('TTL_IMPRIMIR_BOLETO="';
	    + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    IF  &LSAlsDupl .TP_COBRANC = 88
			LSLinhaXML 	=  	"Sim"
	ELSE
			LSLinhaXML 	=  	"Nao"
	ENDIF
	LSLinhaXML  = CRtratalinha('TTL_ENVIADA_CARTORIO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_PGTO), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_PGTO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_BAIXA), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_BAIXA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .VLR_ISSRTD ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_ISS_RETIDO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .ABATIMENTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_ABATIMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .DESCONTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DESCONTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .DEVOLUCAO,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DEVOLUCAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .OUT_CREDT ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_OUTROS_CREDITOS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(STR( &LSAlsDupl .DSP_COBR ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DESPESAS_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .OUT_DESP ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_OUTRAS_DESPESAS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .IOF ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_IOF="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    IF EMPTY( &LSAlsDupl .dt_pgto )
        LNdiasAtraso =  0
    ELSE
        LNdiasAtraso =  &LSAlsDupl .dt_pgto -  &LSAlsDupl .dt_venc
    ENDIF

    IF LNdiasAtraso = 2 AND DOW(  &LSAlsDupl .dt_venc ) = 7
       LNdiasAtraso = 0
    ENDIF

    IF LNdiasAtraso = 1 AND DOW(  &LSAlsDupl .dt_venc ) = 1
       LNdiasAtraso = 0
    ENDIF

    IF &LSAlsDupl .dt_pgto <  &LSAlsDupl .dt_venc
       LNdiasAtraso = 0
    ENDIF

	LSLinhaXML  = chrtran(STR( LNdiasAtraso ,15,0), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DIAS_ATRASO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsEmp .multa ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_TAXA_MULTA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsEmp .mora ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_TAXA_MORA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNvlrMultaCalc
    LNvlrMultaCalc = 0

	IF LNdiasAtraso > 0
	    LNvlrMultaCalc =  &LSAlsDupl .vlr_doc * empresa.multa/100
	ENDIF

	LSLinhaXML  = chrtran(STR( LNvlrMultaCalc ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MULTA_CALCULADA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNvlrMoraCalc
    LNvlrMoraCalc = 0

	IF LNdiasAtraso > 0
	    LNvlrMoraCalc =  ;
	    &LSAlsDupl .vlr_doc * empresa.mora * LNdiasAtraso /100
	ENDIF
	

	LSLinhaXML  = chrtran(STR( LNvlrMoraCalc ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MORA_CALCULADA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNvlrMulta

    LNvlrMulta = 0
	LSLinhaXML  = chrtran(STR( LNvlrMulta ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MULTA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .MORA ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MORA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .JUROS ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_JUROS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    PRIVATE LNVlrDevido
    IF EMPTY( &LSAlsDupl .dt_pgto )
        LNVlrDevido =  0
    ELSE
        LNVlrDevido =   &LSAlsDupl .VLR_DOC;
                  + LNvlrMultaCalc;
                  + LNvlrMoraCalc;
                  - &LSAlsDupl .DEVOLUCAO;
                  - &LSAlsDupl .OUT_CREDT;
                  - &LSAlsDupl .ABATIMENTO;
                  - &LSAlsDupl .DESCONTO;
                  + &LSAlsDupl .out_desp
    ENDIF

	LSLinhaXML  = chrtran(STR( LNVlrDevido ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DEVIDO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .VLR_PGTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_PGTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNVlrDifDevido
    IF EMPTY( &LSAlsDupl .dt_pgto )
        LNVlrDifDevido =  0
    ELSE
        LNVlrDifDevido = &LSAlsDupl .VLR_PGTO - LNVlrDevido
    ENDIF

	LSLinhaXML  = chrtran(STR( LNVlrDevido ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DIF_PAGO_DEVIDO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .PARC_PGTO,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_PGTO_PARCIAL="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsDupl .OBS
	LSLinhaXML  = CRtratalinha('TTL_OBSERVACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*


	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS44S           CRAvsNmXMLExpt VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   36  º
*       º Variable:            CRAvsNmXMLExpt                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      288                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls44s     &&  CRAvsNmXMLExpt VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRAvsNmXMLExpt
PARAMETER PrmEmpresa,PrmData

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml

    PRIVATE LSnro	
	*----------------------------------------------------------*

    LSnro = SUBS(DTOS(PrmData),6)
    LSnro = CHRTRAN(LSnro," ","0")
	LSnomeArqXml = "AV"+LSnro

    LSnro = STR(PrmEmpresa,3)
    LSnro = CHRTRAN(LSnro," ","0")

  	LSfileXML	= LSnomeArqXml+LSnro+".XML"

	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS44Y           CRtratalinha VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   37  º
*       º Variable:            CRtratalinha                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      289                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls44y     &&  CRtratalinha VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRtratalinha
PARAMETERS LSLINHA

	LSLINHA = UPPER(LSLINHA)
	LSLINHA = RTRIM(LSLINHA)


    LSLINHA =   strtran(LSLINHA,'&AMP;','&amp;')


RETURN(LSLINHA)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS454           CRLimpaString VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   38  º
*       º Variable:            CRLimpaString                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      290                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls454     &&  CRLimpaString VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRLimpaString
PARAMETERS PrmString
	*-------------------------------------------------------*
	PRIVATE LSstatus
	LSstatus = ""
	*-------------------------------------------------------*
	*PRMString = UPPER(PRMString)

	PRMString = chrtran(PRMString,"€","C")       && 01
	PRMString = chrtran(PRMString,"‡","c")       && 02
	PRMString = chrtran(PRMString,"¦","-")       && 04
	PRMString = chrtran(PRMString,"§","-")       && 05
	PRMString = chrtran(PRMString,"°",'')        && 06
	PRMString = chrtran(PRMString,"º",'')        && 07
	PRMString = chrtran(PRMString,"",'E')       && 08
	PRMString = chrtran(PRMString,"‚",'e')       && 09
	PRMString = chrtran(PRMString,"Ç",'A')       && 10
	PRMString = chrtran(PRMString,"Æ",'a')       && 11
	PRMString = chrtran(PRMString,"ø",'')        && 12
	PRMString = chrtran(PRMString,chr(0),'')     && 13
	PRMString = chrtran(PRMString,'"','')        && 14
	PRMString = chrtran(PRMString,'Ã','A')        && 14
	PRMString = chrtran(PRMString,'>',' ')        && 14
	PRMString = chrtran(PRMString,'<',' ')        && 14

	PRMString = strtran(PRMString,"&","&amp;")       && 03


RETURN(PrmString)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS45C           CR_Fputs VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   39  º
*       º Variable:            CR_Fputs                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      291                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls45c     &&  CR_Fputs VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CR_Fputs
PARAMETERS ;
			PrmNroIDfileXML,;
			PrmString,;
			PrmLEN

	PRIVATE LFretorno

	PrmString = CR_FputsLimpa(PrmString)

	LFretorno =fPuts(PrmNroIDfileXML,PrmString,LEN(PrmString))

RETURN(LFretorno)

*----------------------------------------------------------*



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS45I           CRExpLccbrCapaRetLegado VALID      º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   40  º
*       º Variable:            CRExpLccbrCapaRetLegado            º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      292                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls45i     &&  CRExpLccbrCapaRetLegado VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRExpLccbrCapaRetLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	PRIVATE LSAlsCobr    && Cobranca
	PRIVATE LSAlsAviso   && RetornBC
	PRIVATE LSAlsBanco   && Banco
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()

	SELE COBRANCA
	LSAlsCobr = alias()



	SELE BANCO
	LSAlsBanco = alias()



	SELE RETORNMV
	LSAlsAviso = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	SET POINT TO ","
	SET SEPARATOR  TO "."


	*==========================================================*
	*  AVISO BANCARIO - IDENTIFICACAO DO AVISO
	*==========================================================*
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .Banco ,3), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia )
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_AGENCIA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia_DG )
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_AGENCIA_DV="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_AVISO_CONTA_CORRENTE="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta_DG )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_AVISO_CONTA_CORRENTE_DV="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Carteira )
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_CARTEIRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Variacao )
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_VARIACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .Banco_Nome
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_NOME_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	IF ALLTRIM( &LSAlsBanco .Tp_Lancame) = "CAIXA"
    	LSLinhaXML  =  "Caixa"
	ELSE
    	LSLinhaXML  =  "Banco"
	ENDIF
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_TP_LANCAMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQINI ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_BOLETO_INICIAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQATU ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_BOLETO_ATUAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQFIM ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_BOLETO_FINAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CODCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_CODIGO_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .DIGCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_DV_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CONVENIO
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_CONVENIO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_ESCRIT
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_COD_ESCRITURAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_EMPRES
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_COD_EMPRESA="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	IF  ALLTRIM( &LSAlsCobr .TP_INSCR )  $ "01/02/03/98/99/"
    	LSLinhaXML  =  &LSAlsCobr .TP_INSCR
    ELSE
   	    LSLinhaXML  =  "98"  && 98 NAO TEM
    ENDIF

	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_TP_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .NUM_INSCR
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .GRAVACAO
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_GRAVACAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .IDENT_SIS
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_IDENT_SIS="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_A
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_INSTRUCAO_A="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_B
	LSLinhaXML  = CRtratalinha('LCCBR_AVISO_INSTRUCAO_B="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS45U           CRExpClieDupLegado VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   41  º
*       º Variable:            CRExpClieDupLegado                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      293                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls45u     &&  CRExpClieDupLegado VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRExpClieDupLegado
PARAMETERS 		PrmFileXML,;
				PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsDupl    && Duplicat
	

	AlsANT = ALIAS()


	SELE DUPLICAT
	LSAlsDupl = alias()


	SELE CLIENTES
	LSAlsClt = alias()

	SELE CLIENC
	LSAlsClie = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."



    SELE Clienc
    SET ORDER TO TAG CLIENTE

	set near on
    SEEK &LSAlsDupl .cliente + 1
    SKIP -1
	SET NEAR OFF


    IF BOF() OR &LSAlsDupl .cliente <> &LSAlsClie .cliente

       sele clientes
       set order to tag cliente
       SEEK &LSAlsDupl .cliente
       IF FOUND()
	       m.cliente  =   STR( &LSAlsClt .cliente,14)
	       m.nome     =   &LSAlsDupl .nome
	       m.razao    =   &LSAlsClt .nome
	       m.uf       =   &LSAlsClt .estado
	       m.ie       =   &LSAlsClt .inscricao
	       m.im       =   &LSAlsClt .im_tomador
	       m.logr     =   &LSAlsClt .endereco
	       m.nro_logr =   &LSAlsClt .nro_logr
	       m.compllogr=   ""
	       m.cep      =   &LSAlsClt .cep
	       m.muni_ibge=   LEFT(ALLTRIM( STR( &LSAlsClt .muni_ibge ,11)),7)
	       m.muni_nome=   &LSAlsClt .cidade
	       m.bairro   =   &LSAlsClt .bairro
	       m.codpais  =   ""

           m.pais     =   "Brasil"
	       m.ddd      =   ""
	       m.fone     =   &LSAlsClt .fone
	       m.email    =   &LSAlsClt .e_mail


       ELSE
	       m.cliente  =   STR( &LSAlsDupl .cliente,14)
	       m.nome     =   &LSAlsDupl .nome
	       m.razao    =   &LSAlsDupl .nome
	       m.uf       =   ""
	       m.ie       =   ""
	       m.im       =   ""
	       m.tp_logr  =   ""
	       m.logr     =   ""
	       m.nro_logr =   ""
	       m.compllogr=   ""
	       m.cep      =   ""
	       m.muni_ibge=   ""
	       m.muni_nome=   ""
	       m.bairro   =   ""
	       m.codpais  =   ""
	       m.pais     =   "Brasil"
	       m.ddd      =   ""
	       m.fone     =   ""
	       m.email    =   ""
	   endif
    ELSE
       m.cliente  =   STR( &LSAlsClie .cliente,14)
       m.nome     =   &LSAlsDupl .nome
       m.razao    =   &LSAlsClie .nome
       m.uf       =   &LSAlsClie .estado
       m.ie       =   &LSAlsClie .inscricao
       m.im       =   &LSAlsClie .im_tomador
       m.logr     =   &LSAlsClie .endereco
       m.nro_logr =   &LSAlsClie .nro_logr
       m.compllogr=   ""
       m.cep      =   &LSAlsClie .cep
       m.muni_ibge=   LEFT(ALLTRIM( STR( &LSAlsClie .muni_ibge ,11)),7)
       m.muni_nome=   &LSAlsClie .cidade
       m.bairro   =   &LSAlsClie .bairro
       m.codpais  =   ""

       if empty( &LSAlsClie .pais )
          m.pais     =   "Brasil"
       ELSE
          m.pais     =   &LSAlsClie .pais
       endif
       m.ddd      =   &LSAlsClie .ddd
       m.fone     =   &LSAlsClie .fone
       m.email    =   &LSAlsClie .e_mail
    ENDIF

	IF "NAO@INFORMADO" $ UPPER(m.email)
       	m.email    =  ''
    ENDIF


	*==========================================================*
	*  CADASTRO
	*==========================================================*
	LSLinhaXML  = m.cliente
	LSLinhaXML  = CRtratalinha('CDSTR_CPFCNPJ="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = ""
	LSLinhaXML  = CRtratalinha('CDSTR_FISICO_JURIDICO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.nome
	LSLinhaXML  = CRLimpaString('CDSTR_NOME="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.nome
	LSLinhaXML  = CRLimpaString('CDSTR_RAZAO_SOCIAL="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.uf
	LSLinhaXML  = CRtratalinha('CDSTR_UF="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.ie
	LSLinhaXML  = CRtratalinha('CDSTR_IE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.im
	LSLinhaXML  = CRtratalinha('CDSTR_IM="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = ""
	LSLinhaXML  = CRtratalinha('CDSTR_TP_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.logr
	LSLinhaXML  = CRtratalinha('CDSTR_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.nro_logr
	LSLinhaXML  = CRtratalinha('CDSTR_NRO_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.compllogr
	LSLinhaXML  = CRtratalinha('CDSTR_COMPL_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.cep
	LSLinhaXML  = CRtratalinha('CDSTR_CEP="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.muni_ibge
	LSLinhaXML  = CRtratalinha('CDSTR_MUNI_IBGE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.muni_nome
	LSLinhaXML  = CRtratalinha('CDSTR_MUNI_NOME="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.bairro
	LSLinhaXML  = CRtratalinha('CDSTR_BAIRRO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.codpais
	LSLinhaXML  = CRtratalinha('CDSTR_CODIGO_PAIS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.pais
	LSLinhaXML  = CRtratalinha('CDSTR_NOME_PAIS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.ddd
	LSLinhaXML  = CRtratalinha('CDSTR_DDD="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.fone
	LSLinhaXML  = CRtratalinha('CDSTR_FONE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.email
	LSLinhaXML  = CRtratalinha('CDSTR_E_MAIL="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  ""
	LSLinhaXML  = CRtratalinha('CDSTR_OBSERVACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  ""
	LSLinhaXML  = CRtratalinha('/>')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS466           CRAvsEnviaXML VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   42  º
*       º Variable:            CRAvsEnviaXML                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      294                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls466     &&  CRAvsEnviaXML VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRAvsEnviaXML
PARAMETERS PrmEmp,PrmData


   	PRIVATE LSfileXML
   	PRIVATE LSPathOrigem,LSNomeOrigem,LSfileOrigem
   	PRIVATE LSPathDestino,LSNomeDestino,LSfileDestinoOrigem
   	
	*-----------------------------------------------*
	=W_DEFPROC("DUPLICAT.SPR")
   	LSNomeOrigem	= CRAvsNmXMLExpt(PrmEmp,PrmData)

*	LSPathOrigem    = "C:\Dupl\TMP\"
	LSPathOrigem    = CRPthTmpDup(PrmEmp)

    LSfileOrigem    = LSPathOrigem + LSNomeOrigem

	IF !FILE(LSfileOrigem)
	   RETURN(.F.)
	ENDIF
	
	
	
	*-----------------------------------------------*

   	LSNomeDestino   = LSNomeOrigem

*---------------------------------------------------------*
*	=W_DEFPROC("PARAMETR.SPR")
*	LSPathDestino   = PMGetFieldValue(PrmEmp,"DIR_DFIN")
*
*   IF TYPE("LSPathDestino") <> "C" or EMPTY(LSPathDestino)
*         LSPathDestino = "C:\Dupl\"
*	else
*         LSPathDestino = ALLTRIM(LSPathDestino)
*   ENDIF
*---------------------------------------------------------*

	*--------------------------------------------------*
    LSPathDestino =CRPthDstnDupDIR_DEFIN(PrmEmp)


    LSfileDestino   = LSPathDestino + LSNomeDestino

	*-----------------------------------------------*
			
	=CRCOPYLongo(LSFileOrigem,LSFileDestino)


	IF FILE(LSFileOrigem)
		DELETE FILE &LSFileOrigem
	ENDIF

	*--------------------------------------------------*



RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS46G           CRDuplNroExpDuplicata VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   44  º
*       º Variable:            CRDuplNroExpDuplicata              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      295                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls46g     &&  CRDuplNroExpDuplicata VALID
#REGION 9
RETURN

FUNCTION CRDuplNroExpDuplicata
	PARAMETERS ;
	    PrmEmp,PrmDuplicata,PrmMotivo

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBanco,LFclintes
	PRIVATE LNCtrItens

	LSalias = ALIAS()

	LFempresa		= NetArq("empresa")
	LFcobranca		= NetArq("cobranca")
	LFduplicat		= NetArq("duplicat")
	LFbanco   		= NetArq("banco")
	LFclienc		= NetArq("clienc")
	LFclintes		= NetArq("clientes")
	LFNota   		= NetArq("nota")
	IF (LFEmpresa+LFduplicat+LFBanco+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF





    SELE Empresa
    SET ORDER TO TAG empresa
    SEEK PrmEmp
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Empresa : "+;
				STR(PrmEmp,3)
      	DO  FCHExpDuplicata
		RETURN(.F.)
	ENDIF




	*-------------------------------------------------------*
	=CRDuplModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML

*   	LSfileXML	= CRNmDuplXMLExpt(PrmEmp,PrmDUPLICATA)
*   	LSfileXML	= "C:\DUPL\TMP\"+LSfileXML

    *-----------------------------------------------*
    *   DEFINE PATH E NOME DE ARQUIVO REMPORARIO
    *-----------------------------------------------*
  	LSfileXML	= CRNmDuplXMLExpt(PrmEmp,PrmDUPLICATA)
   	LSdirtmpXML	= CRPthTmpDup(PrmEmp)


   	LSfileXML	= LSdirtmpXML    +    LSfileXML

    *-----------------------------------------------*




  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      	DO  FCHExpDuplicata
      return
   	endif

	*---------------------------------------------------*
	=CRDuplIniXML(LSfileXML,LNroIDfileXML)
	*----------------------------------------------------*

	SELE duplicat
	SET ORDER TO TAG DOC
	SEEK STR(PrmEmp,3)+STR(PrmDUPLICATA,9)
    SET NEAR OFF

	DO WHILE  !EOF() AND ;
	    PrmDuplicata = duplicat.duplicata;
		PrmEmp 	    = duplicat.empresa
		

        *------------------------------------------------*
        =CRDuplMotivoLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplIedentLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplCedenteLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplPortadorLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplRecebedorLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplClieLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

		*------------------------------------------------------*
		SELE DUPLICAT
		SKIP
	ENDDO
	=CRDuplFinXML(LSfileXML,LNroIDfileXML)

    =fclose(LNroIDfileXML)

*----------------------------------------------------
*    =CRDupEnviaXML(PrmEmp,Date())
*----------------------------------------------------

    =CRDupEnviaXML(PrmEmp,PrmDUPLICATA)
  	
	***************************

  	DO  FCHExpDuplicata

	UNLOCK
RETURN(.T.)

PROCEDURE FCHExpDuplicata
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("cobranca" ,LFcobranca)
	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("banco" ,LFbanco)
	=UP_fecha("nota" ,LFnota)
	=UP_fecha("clientes" ,LFclintes)

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS46H           CRDuplModeloXML VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   45  º
*       º Variable:            CRDuplModeloXML                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      296                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls46h     &&  CRDuplModeloXML VALID
#REGION 9
RETURN

FUNCTION CRDuplModeloXML


	PRIVATE LSFDocXML
	
	LSFDocXML = "\scgc\loja\automatc\xmlDupl.XML"
	IF !FILE(LSFDocXML)
		RETURN(.T.)
	ENDIF


	SELE 0
	USE  \scgc\comum\xmlDupl EXCL
	ZAP
	PACK

	*------------------------------------------------------------*
	* ESTE COMANDO SERVA PARA ELIMINAR CARACTERES INDESEJADOS
	* DO CABECALHO XML
	*-----------------------------------------------------------*
	SELE xmlDupl


	APPEND FROM &LSFDocXML TYPE SDF


	
	REPLACE ALL XML_LINHA WITH chrtran(XML_LINHA,chr(9),chr(32))
	REPLACE ALL XML_ORDEM WITH RECNO()
	GO BOTT
	SKIP -1
	REPLACE XML_ORDEM WITH 9999999999901
	SKIP	
	REPLACE XML_ORDEM WITH 9999999999902
	USE

	IF FILE(LSFDocXML)
		DELETE FILE &LSFDocXML
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS46Z           CRDuplIniXML VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   46  º
*       º Variable:            CRDuplIniXML                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      297                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls46z     &&  CRDuplIniXML VALID
#REGION 9
RETURN

FUNCTION CRDuplIniXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML



   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDupl
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF() AND xmlDupl.XML_ORDEM < 9999999999901
	
		LSLinhaXML = xmlDupl.XML_LINHA
		=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		SKIP
	ENDDO
	SELE xmlDupl
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS475           CRDuplIedentLegado VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   47  º
*       º Variable:            CRDuplIedentLegado                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      298                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls475     &&  CRDuplIedentLegado VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplIedentLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."
	

	LSLinhaXML  = chrtran(STR( &LSAlsEmp .CGC ,14), " ","0")
	LSLinhaXML  = CRtratalinha('UNEM_CNPJ="'+LSLinhaXML+'"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	LFieldTmp   =  &LSAlsEmp .INSCRICAO
	LSLinhaXML  = CRtratalinha('UNEM_IE="'+LFieldTmp+'"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS47D           CRDuplCedenteLegado VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   48  º
*       º Variable:            CRDuplCedenteLegado                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      299                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls47d     &&  CRDuplCedenteLegado VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplCedenteLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	PRIVATE LSAlsCobr    && Cobranca
	PRIVATE LSAlsDupl    && Duplicat
	PRIVATE LSAlsBanco   && Banco
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()

	SELE DUPLICAT
	LSAlsDupl = alias()


	SELE Banco
	LSAlsBanco = alias()

    SET ORDE TO TAG BANCO
    SEEK  &LSAlsDupl .BANCO


	SELE COBRANCA
	LSAlsCobr = alias()

    SET ORDE TO TAG CARTEIRA
    SEEK STR( &LSAlsDupl .empresa,3);
        +STR( &LSAlsDupl .BANCO,3);
        +  &LSAlsDupl .CARTEIRA;
        +  &LSAlsDupl .VARIACAO

    IF !FOUND()
        SET ORDE TO TAG COBRANCA
        SEEK STR( &LSAlsDupl .empresa,3);
             +STR( &LSAlsDupl .BANCO,3)
       IF !FOUND()
          RETURN
       ENDIF
    ENDIF



	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	SET POINT TO ","
	SET SEPARATOR  TO "."




	*==========================================================*
	*  CEDENTE BANCARIO - IDENTIFICACAO DO AVISO
	*==========================================================*
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .Banco ,3), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia )
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_AGENCIA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia_DG )
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_AGENCIA_DV="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_CEDENTE_CONTA_CORRENTE="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta_DG )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_CEDENTE_CONTA_CORRENTE_DV="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Carteira )
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_CARTEIRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Variacao )
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_VARIACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .Banco_Nome
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_NOME_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
	IF ALLTRIM( &LSAlsBanco .Tp_Lancame) = "CAIXA"
    	LSLinhaXML  =  "Caixa"
	ELSE
    	LSLinhaXML  =  "Banco"
	ENDIF
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_TP_LANCAMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQINI ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_BOLETO_INICIAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQATU ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_BOLETO_ATUAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQFIM ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_BOLETO_FINAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CODCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_CODIGO_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .DIGCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_DV_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CONVENIO
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_CONVENIO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_ESCRIT
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_COD_ESCRITURAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_EMPRES
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_COD_EMPRESA="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	IF  ALLTRIM( &LSAlsCobr .TP_INSCR )  $ "01/02/03/98/99/"
    	LSLinhaXML  =  &LSAlsCobr .TP_INSCR
    ELSE
   	    LSLinhaXML  =  "98"  && 98 NAO TEM
    ENDIF


	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_TP_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .NUM_INSCR
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .GRAVACAO
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_GRAVACAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .IDENT_SIS
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_IDENT_SIS="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_A
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_INSTRUCAO_A="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_B
	LSLinhaXML  = CRtratalinha('LCCBR_CEDENTE_INSTRUCAO_B="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS47Q           CRDuplPortadorLegado VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   49  º
*       º Variable:            CRDuplPortadorLegado               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      300                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls47q     &&  CRDuplPortadorLegado VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplPortadorLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	PRIVATE LSAlsCobr    && Cobranca
	PRIVATE LSAlsDupl    && Duplicat
	PRIVATE LSAlsBanco   && Banco
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()

	SELE DUPLICAT
	LSAlsDupl = alias()


	SELE Banco
	LSAlsBanco = alias()

    SET ORDE TO TAG BANCO
    SEEK  &LSAlsDupl .BANCO



	SELE COBRANCA
	LSAlsCobr = alias()

    SET ORDE TO TAG CARTEIRA
    SEEK STR( &LSAlsDupl .empresa,3);
        +STR( &LSAlsDupl .PORTADOR,3);
        +  &LSAlsDupl .CARTEIRA;
        +  &LSAlsDupl .VARIACAO

    IF !FOUND()
        SET ORDE TO TAG COBRANCA
        SEEK STR( &LSAlsDupl .empresa,3);
             +STR( &LSAlsDupl .PORTADOR,3)
       IF !FOUND()
          RETURN
       ENDIF
    ENDIF



	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	SET POINT TO ","
	SET SEPARATOR  TO "."




	*==========================================================*
	*  CEDENTE BANCARIO - IDENTIFICACAO DO AVISO
	*==========================================================*
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .Banco ,3), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia )
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_AGENCIA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia_DG )
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_AGENCIA_DV="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_PRTD_CONTA_CORRENTE="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta_DG )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_PRTD_CONTA_CORRENTE_DV="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Carteira )
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_CARTEIRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Variacao )
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_VARIACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .Banco_Nome
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_NOME_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	IF ALLTRIM( &LSAlsBanco .Tp_Lancame) = "CAIXA"
    	LSLinhaXML  =  "Caixa"
	ELSE
    	LSLinhaXML  =  "Banco"
	ENDIF
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_TP_LANCAMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*


	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQINI ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_BOLETO_INICIAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQATU ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_BOLETO_ATUAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQFIM ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_BOLETO_FINAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CODCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_CODIGO_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .DIGCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_DV_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CONVENIO
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_CONVENIO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_ESCRIT
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_COD_ESCRITURAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_EMPRES
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_COD_EMPRESA="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	IF  ALLTRIM( &LSAlsCobr .TP_INSCR )  $ "01/02/03/98/99/"
    	LSLinhaXML  =  &LSAlsCobr .TP_INSCR
    ELSE
   	    LSLinhaXML  =  "98"  && 98 NAO TEM
    ENDIF


	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_TP_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .NUM_INSCR
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .GRAVACAO
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_GRAVACAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .IDENT_SIS
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_IDENT_SIS="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_A
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_INSTRUCAO_A="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_B
	LSLinhaXML  = CRtratalinha('LCCBR_PRTD_INSTRUCAO_B="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS483           CRDuplRecebedorLegado VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   50  º
*       º Variable:            CRDuplRecebedorLegado              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      301                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls483     &&  CRDuplRecebedorLegado VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplRecebedorLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	PRIVATE LSAlsCobr    && Cobranca
	PRIVATE LSAlsDupl    && Duplicat
	PRIVATE LSAlsBanco   && Banco
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()

	SELE DUPLICAT
	LSAlsDupl = alias()


	SELE Banco
	LSAlsBanco = alias()

    SET ORDE TO TAG BANCO
    SEEK  &LSAlsDupl .BANCO


	SELE COBRANCA
	LSAlsCobr = alias()

    SET ORDE TO TAG CARTEIRA
    SEEK STR( &LSAlsDupl .empresa,3);
        +STR( &LSAlsDupl .PAGA_EM,3);
        +  &LSAlsDupl .CARTEIRA;
        +  &LSAlsDupl .VARIACAO

    IF !FOUND()
        SET ORDE TO TAG COBRANCA
        SEEK STR( &LSAlsDupl .empresa,3);
             +STR( &LSAlsDupl .PAGA_EM,3)
       IF !FOUND()
          RETURN
       ENDIF
    ENDIF



	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc

	SET POINT TO ","
	SET SEPARATOR  TO "."




	*==========================================================*
	*  CEDENTE BANCARIO - IDENTIFICACAO DO AVISO
	*==========================================================*
	*----------------------------------------------------------*
    if empty( &LSAlsDupl .dt_pgto )
  	     LSLinhaXML  = ""
    else
     	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .Banco ,3), " ","0")
    endif
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia )
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_AGENCIA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Agencia_DG )
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_AGENCIA_DV="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_RCBD_CONTA_CORRENTE="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Conta_DG )
	LSLinhaXML  = ;
	   CRtratalinha('LCCBR_RCBD_CONTA_CORRENTE_DV="'+LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Carteira )
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_CARTEIRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = ALLTRIM( &LSAlsCobr .Variacao )
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_VARIACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .Banco_Nome
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_NOME_BANCO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
	IF ALLTRIM( &LSAlsBanco .Tp_Lancame) = "CAIXA"
    	LSLinhaXML  =  "Caixa"
	ELSE
    	LSLinhaXML  =  "Banco"
	ENDIF
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_TP_LANCAMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQINI ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_BOLETO_INICIAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQATU ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_BOLETO_ATUAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsCobr .BLT_SEQFIM ,15), " ","0")
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_BOLETO_FINAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CODCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_CODIGO_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .DIGCEDENTE
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_DV_CEDENTE="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .CONVENIO
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_CONVENIO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_ESCRIT
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_COD_ESCRITURAL="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .COD_EMPRES
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_COD_EMPRESA="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	IF  ALLTRIM( &LSAlsCobr .TP_INSCR )  $ "01/02/03/98/99/"
    	LSLinhaXML  =  &LSAlsCobr .TP_INSCR
    ELSE
   	    LSLinhaXML  =  "98"  && 98 NAO TEM
    ENDIF
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_TP_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .NUM_INSCR
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_INSCRICAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .GRAVACAO
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_GRAVACAO="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .IDENT_SIS
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_IDENT_SIS="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_A
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_INSTRUCAO_A="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsCobr .INSTRUC_B
	LSLinhaXML  = CRtratalinha('LCCBR_RCBD_INSTRUCAO_B="';
	              + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS48H           CRDuplLegado VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   51  º
*       º Variable:            CRDuplLegado                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      302                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls48h     &&  CRDuplLegado VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplLegado
PARAMETERS	PrmFileXML,;
			PrmNroIDfileXML,;
			PrmMotivo




	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsDupl    && Duplicat

    PRIVATE LSAlsEmp	

	AlsANT = ALIAS()


    SELE EMPRESA
	LSAlsEmp = alias()


	SELE DUPLICAT
	LSAlsDupl = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."

	*==========================================================*
	*  TITULO - DADOS DO TITULO NAO RELACIONADOS A OCORRENCIA
	*==========================================================*

	*----------------------------------------------------------*
	LSLinhaXML = chrtran(ALLTRIM(STR( &LSAlsDupl .DUPLICATA ,15)), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = ALLTRIM(  &LSAlsDupl .CODPARCELA )
	LSLinhaXML  = CRtratalinha('TTL_CODIGO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = ALLTRIM( &LSAlsDupl .NUM_NO_BCO )
	LSLinhaXML  = CRtratalinha('TTL_NOSSO_NUMERO="'+;
	          LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .SEQUENCIA ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_NUMERO_PARCELA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .QTPARCELAS ,3), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_QTDE_PARCELAS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(STR(  &LSAlsDupl .vlrparcini ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_INICIAL_DOCUMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(STR(  &LSAlsDupl .VLR_DOC ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DOCUMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_EMI ), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_EMISSAO="';
	          + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_VENC ), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_VENCIMENTO="';
	          + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsDupl .COD_BARRA
	LSLinhaXML  = CRtratalinha('TTL_COD_BARRA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	PRIVATE  ;
    	    PrmEmpresa;
        	PrmNota
	PRIVATE  ;
    		PrmSerie,;
	 		PrmTipo,;
     		RtnNro_Doc,;
	 		RtnMod_Doc,;
	 		RtnCOD_IDFORN,;
	 		RtnSerie_Doc


    SELE nota
    set order to tag nota

    SEEK STR(  &LSAlsDupl .EMPRESA,3)+STR(  &LSAlsDupl .NOTA,7)
    IF FOUND()

    	    PrmEmpresa      = nota.empresa
        	PrmNota         = nota.nota
			PrmSerie   		= nota.Serie
			PrmTipo    		= nota.Tipo
			RtnNro_Doc 		= 0
		 	RtnMod_Doc		= ""
			RtnCOD_IDFORN	= ""
			RtnSerie_Doc	= ""
	
			=W_DEFPROC("DOCFISCA.SPR")
			=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)
    ELSE
    	    PrmEmpresa      = &LSAlsDupl .empresa
        	PrmNota         = &LSAlsDupl .NOTA
			PrmSerie   		= "001"
			PrmTipo    		= ""
			RtnNro_Doc 		= 0
		 	RtnMod_Doc		= ""
			RtnCOD_IDFORN	= ""
			RtnSerie_Doc	= ""

			=W_DEFPROC("DOCFISCA.SPR")
			=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)

    ENDIF
	*----------------------------------------------------------*
	LSLinhaXML  = RtnMod_Doc
	LSLinhaXML  = CRtratalinha('TTL_DOC_FISCAL_MODELO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( RtnNro_Doc,7), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DOC_FISCAL_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = RtnSerie_Doc
	LSLinhaXML  = CRtratalinha('TTL_DOC_FISCAL_SERIE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .NOTA ,7), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_FATURA_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .ORCAMENTO ,7), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_PEDIDO_NUMERO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    IF &LSAlsDupl .BANCO = 900
		LSLinhaXML  = "Pagar"
     ELSE
		LSLinhaXML  = "Receber"
	ENDIF

	LSLinhaXML  = CRtratalinha('TTL_IND_OPERACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    IF &LSAlsDupl .DT_EMI = &LSAlsDupl .DT_VENC
	      LSLinhaXML  = "Entrada"
	ELSE
	      LSLinhaXML  = "Parcelas"
	ENDIF
	LSLinhaXML  = CRtratalinha('TTL_TIPO_PARCELA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR(  &LSAlsDupl .TP_COBRANC ,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_TP_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    LSLinhaXML  = ""

    DO CASE
          CASE  &LSAlsDupl .TP_COBRANC = 01
            LSLinhaXML  = "Simples"
          CASE  &LSAlsDupl .TP_COBRANC = 06
            LSLinhaXML  = "Vendor"
          CASE  &LSAlsDupl .TP_COBRANC = 88
            LSLinhaXML  = "Cartorio"
          CASE  &LSAlsDupl .TP_COBRANC = 99
            LSLinhaXML  = "Incobravel"
          OTHERWISE
            LSLinhaXML  = "Simples"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_TP_COBRANCA_DESCRICAO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
        CASE &LSAlsDupl .MOEDA = 00
              LSLinhaXML  = "Dinheiro"
        CASE &LSAlsDupl .MOEDA = 01
              LSLinhaXML  = "Dinheiro"
        CASE &LSAlsDupl .MOEDA = 02
              LSLinhaXML  = "Cheque"
        CASE &LSAlsDupl .MOEDA = 03
              LSLinhaXML  = "Duplicata"
        CASE &LSAlsDupl .MOEDA = 04
              LSLinhaXML  = "Cartao Debito"
        CASE &LSAlsDupl .MOEDA = 05
              LSLinhaXML  = "Cartao Credito"
        OTHERWISE
              LSLinhaXML  = "Dinheiro"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_FORMA_PGTO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    DO CASE
        CASE &LSAlsDupl .Natu = 00
              LSLinhaXML  = "Varejo"
        CASE &LSAlsDupl .Natu = 01
              LSLinhaXML  = "Revenda"
        CASE &LSAlsDupl .Natu = 02
              LSLinhaXML  = "Poder Publico"
        CASE &LSAlsDupl .Natu = 03
              LSLinhaXML  = "Frota"
        OTHERWISE
              LSLinhaXML  = "Varejo"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_NATUREZA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

    IF &LSAlsDupl .CONFNROBCO = .t.
        LSLinhaXML  = "Sim"
    else
        LSLinhaXML  = "Nao"
    ENDIF
	LSLinhaXML  = CRtratalinha('TTL_CONFIRMADO_NRO_BANCO="';
	    + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	IF TYPE("PrmMotivo") <> "C"
        PrmMotivo = "REGISTRAR"
    ENDIF

	DO CASE
	   CASE ("IMPRIMIR" $ PrmMotivo)
            LSLinhaXML  = "Sim"
	   CASE ("CANCELAR" $ PrmMotivo)
            LSLinhaXML  = "Nao"
	   CASE ("EXPORTAR" $ PrmMotivo)
            LSLinhaXML  = "Nao"
       OTHERWISE     && "REGISTRAR"
        	LSLinhaXML  = "Sim"
    ENDCASE
	LSLinhaXML  = CRtratalinha('TTL_IMPRIMIR_BOLETO="';
	    + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    IF  &LSAlsDupl .TP_COBRANC = 88
			LSLinhaXML 	=  	"Sim"
	ELSE
			LSLinhaXML 	=  	"Nao"
	ENDIF
	LSLinhaXML  = CRtratalinha('TTL_ENVIADA_CARTORIO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_PGTO), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_PGTO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(DTOC( &LSAlsDupl .DT_BAIXA), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DT_BAIXA="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
    *----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .VLR_ISSRTD ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_ISS_RETIDO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .ABATIMENTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_ABATIMENTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .DESCONTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DESCONTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .DEVOLUCAO,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DEVOLUCAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .OUT_CREDT ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_OUTROS_CREDITOS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(STR( &LSAlsDupl .DSP_COBR ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DESPESAS_COBRANCA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .OUT_DESP ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_OUTRAS_DESPESAS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .IOF ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_IOF="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	*----------------------------------------------------------*
    IF EMPTY( &LSAlsDupl .dt_pgto )
        LNdiasAtraso =  0
    ELSE
        LNdiasAtraso =  &LSAlsDupl .dt_pgto -  &LSAlsDupl .dt_venc
    ENDIF

    IF LNdiasAtraso = 2 AND DOW(  &LSAlsDupl .dt_venc ) = 7
       LNdiasAtraso = 0
    ENDIF

    IF LNdiasAtraso = 1 AND DOW(  &LSAlsDupl .dt_venc ) = 1
       LNdiasAtraso = 0
    ENDIF

    IF &LSAlsDupl .dt_pgto <  &LSAlsDupl .dt_venc
       LNdiasAtraso = 0
    ENDIF

	LSLinhaXML  = chrtran(STR( LNdiasAtraso ,15,0), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_DIAS_ATRASO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsEmp .multa ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_TAXA_MULTA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsEmp .mora ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_TAXA_MORA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNvlrMultaCalc
    LNvlrMultaCalc = 0

	IF LNdiasAtraso > 0
	    LNvlrMultaCalc =  &LSAlsDupl .vlr_doc * empresa.multa/100
	ENDIF

	LSLinhaXML  = chrtran(STR( LNvlrMultaCalc ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MULTA_CALCULADA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNvlrMoraCalc
    LNvlrMoraCalc = 0

	IF LNdiasAtraso > 0
	    LNvlrMoraCalc =  ;
	    &LSAlsDupl .vlr_doc * empresa.mora * LNdiasAtraso /100
	ENDIF
	

	LSLinhaXML  = chrtran(STR( LNvlrMoraCalc ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MORA_CALCULADA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
    PRIVATE LNvlrMulta

    LNvlrMulta = 0
	LSLinhaXML  = chrtran(STR( LNvlrMulta ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MULTA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*

	LSLinhaXML  = chrtran(STR( &LSAlsDupl .MORA ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_MORA="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .JUROS ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_JUROS="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))





	*----------------------------------------------------------*
    PRIVATE LNVlrDevido
    IF EMPTY( &LSAlsDupl .dt_pgto )
        LNVlrDevido =  0
    ELSE
        LNVlrDevido =   &LSAlsDupl .VLR_DOC;
                  + LNvlrMultaCalc;
                  + LNvlrMoraCalc;
                  - &LSAlsDupl .DEVOLUCAO;
                  - &LSAlsDupl .OUT_CREDT;
                  - &LSAlsDupl .ABATIMENTO;
                  - &LSAlsDupl .DESCONTO;
                  + &LSAlsDupl .out_desp
    ENDIF

	LSLinhaXML  = chrtran(STR( LNVlrDevido ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DEVIDO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*


	LSLinhaXML  = chrtran(STR( &LSAlsDupl .VLR_PGTO ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_PGTO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    PRIVATE LNVlrDifDevido
    IF EMPTY( &LSAlsDupl .dt_pgto )
        LNVlrDifDevido =  0
    ELSE
        LNVlrDifDevido = &LSAlsDupl .VLR_PGTO - LNVlrDevido
    ENDIF

	LSLinhaXML  = chrtran(STR( LNVlrDevido ,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_DIF_PAGO_DEVIDO="';
	     + LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))

	*----------------------------------------------------------*
	LSLinhaXML  = chrtran(STR( &LSAlsDupl .PARC_PGTO,15,2), " ","0")
	LSLinhaXML  = CRtratalinha('TTL_VLR_PGTO_PARCIAL="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	LSLinhaXML  =  &LSAlsDupl .OBS
	LSLinhaXML  = CRtratalinha('TTL_OBSERVACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))


	*----------------------------------------------------------*


	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS48I           CRDuplClieLegado VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   52  º
*       º Variable:            CRDuplClieLegado                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      303                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls48i     &&  CRDuplClieLegado VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplClieLegado
PARAMETERS 		PrmFileXML,;
				PrmNroIDfileXML

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsDupl    && Duplicat
	

	AlsANT = ALIAS()


	SELE DUPLICAT
	LSAlsDupl = alias()


	SELE CLIENTES
	LSAlsClt = alias()

	SELE CLIENC
	LSAlsClie = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."







    SELE Clienc
    SET ORDER TO TAG CLIENTE

	set near on
    SEEK &LSAlsDupl .cliente + 1
    SKIP -1
	SET NEAR OFF

    IF BOF() OR &LSAlsDupl .cliente <> &LSAlsClie .cliente
       sele clientes
       set order to tag cliente
       SEEK &LSAlsDupl .cliente
       IF FOUND()
	       m.cliente  =   STR( &LSAlsClt .cliente,14)
	       m.nome     =   &LSAlsClt .nome
	       m.razao    =   &LSAlsClt .nome
	       m.uf       =   &LSAlsClt .estado
	       m.ie       =   &LSAlsClt .inscricao
	       m.im       =   &LSAlsClt .im_tomador
	       m.logr     =   &LSAlsClt .endereco
	       m.nro_logr =   &LSAlsClt .nro_logr
	       m.compllogr=   ""
	       m.cep      =   &LSAlsClt .cep
	       m.muni_ibge=   LEFT( ALLTRIM( STR( &LSAlsClt .muni_ibge ,11)),7)
	       m.muni_nome=   &LSAlsClt .cidade
	       m.bairro   =   &LSAlsClt .bairro
	       m.codpais  =   ""

           m.pais     =   "Brasil"
	       m.ddd      =   ""
	       m.fone     =   &LSAlsClt .fone
	       m.email    =   &LSAlsClt .e_mail

       ELSE
	       m.cliente  =   STR( &LSAlsDupl .cliente,14)
    	   m.nome     =   &LSAlsDupl .nome
	       m.razao    =   &LSAlsDupl .nome
	       m.uf       =   ""
	       m.ie       =   ""
	       m.im       =   ""
	       m.tp_logr  =   ""
	       m.logr     =   ""
	       m.nro_logr =   ""
	       m.compllogr=   ""
	       m.cep      =   ""
	       m.muni_ibge=   ""
	       m.muni_nome=   ""
	       m.bairro   =   ""
	       m.codpais  =   ""
	       m.pais     =   "Brasil"
	       m.ddd      =   ""
	       m.fone     =   ""
	       m.email    =   ""
       endif
    ELSE
       m.cliente  =   STR( &LSAlsClie .cliente,14)
       m.nome     =   &LSAlsClie .nome
       m.razao    =   &LSAlsClie .nome
       m.uf       =   &LSAlsClie .estado
       m.ie       =   &LSAlsClie .inscricao
       m.im       =   &LSAlsClie .im_tomador
       m.logr     =   &LSAlsClie .endereco
       m.nro_logr =   &LSAlsClie .nro_logr
       m.compllogr=   ""
       m.cep      =   &LSAlsClie .cep
       m.muni_ibge=   LEFT(ALLTRIM( STR( &LSAlsClie .muni_ibge ,11)),7)
       m.muni_nome=   &LSAlsClie .cidade
       m.bairro   =   &LSAlsClie .bairro
       m.codpais  =   ""

       if empty( &LSAlsClie .pais )
          m.pais     =   "Brasil"
       ELSE
          m.pais     =   &LSAlsClie .pais
       endif
       m.ddd      =   &LSAlsClie .ddd
       m.fone     =   &LSAlsClie .fone
       m.email    =   &LSAlsClie .e_mail
    ENDIF

	IF "NAO@INFORMADO" $ UPPER(m.email)
       	m.email    =  ''
    ENDIF


	*==========================================================*
	*  CADASTRO
	*==========================================================*
	LSLinhaXML  = m.cliente
	LSLinhaXML  = CRtratalinha('CDSTR_CPFCNPJ="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = ""
	LSLinhaXML  = CRtratalinha('CDSTR_FISICO_JURIDICO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


    LSLinhaXML  = CRLimpaString(m.nome)
	LSLinhaXML  = CRtratalinha('CDSTR_NOME="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = CRLimpaString(m.razao)
	LSLinhaXML  = CRtratalinha('CDSTR_RAZAO_SOCIAL="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))




	*----------------------------------------------------------*
    LSLinhaXML  = m.uf
	LSLinhaXML  = CRtratalinha('CDSTR_UF="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.ie
	LSLinhaXML  = CRtratalinha('CDSTR_IE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.im
	LSLinhaXML  = CRtratalinha('CDSTR_IM="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = ""
	LSLinhaXML  = CRtratalinha('CDSTR_TP_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.logr
	LSLinhaXML  = CRtratalinha('CDSTR_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  = m.nro_logr
	LSLinhaXML  = CRtratalinha('CDSTR_NRO_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.compllogr
	LSLinhaXML  = CRtratalinha('CDSTR_COMPL_LOGRADOURO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.cep
	LSLinhaXML  = CRtratalinha('CDSTR_CEP="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.muni_ibge
	LSLinhaXML  = CRtratalinha('CDSTR_MUNI_IBGE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.muni_nome
	LSLinhaXML  = CRtratalinha('CDSTR_MUNI_NOME="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.bairro
	LSLinhaXML  = CRtratalinha('CDSTR_BAIRRO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.codpais
	LSLinhaXML  = CRtratalinha('CDSTR_CODIGO_PAIS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.pais
	LSLinhaXML  = CRtratalinha('CDSTR_NOME_PAIS="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.ddd
	LSLinhaXML  = CRtratalinha('CDSTR_DDD="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.fone
	LSLinhaXML  = CRtratalinha('CDSTR_FONE="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  m.email
	LSLinhaXML  = CRtratalinha('CDSTR_E_MAIL="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  ""
	LSLinhaXML  = CRtratalinha('CDSTR_OBSERVACAO="'+ LSLinhaXML + '"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
    LSLinhaXML  =  ""
	LSLinhaXML  = CRtratalinha('/>')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*


	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS48S           CRDuplFinXML VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   53  º
*       º Variable:            CRDuplFinXML                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      304                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls48s     &&  CRDuplFinXML VALID
#REGION 9
RETURN

FUNCTION CRDuplFinXML
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML

	*-------------------------------------------------------*

	SELE 0
	USE  \scgc\comum\xmlDupl
	SET ORDER TO TAG XML_ORDEM
	GO TOP
	
	DO WHILE !EOF()
	    IF xmlDupl.XML_ORDEM > 9999999999900
			LSLinhaXML = xmlDupl.XML_LINHA
			=fPuts(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
		ENDIF
		SKIP
	ENDDO
	SELE xmlDupl
	USE
		

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS48Y           CRDupEnviaXML VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   54  º
*       º Variable:            CRDupEnviaXML                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      305                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls48y     &&  CRDupEnviaXML VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRDupEnviaXML
PARAMETERS PrmEmp,PrmNroRef
	


   	PRIVATE LSfileXML
   	PRIVATE LSPathOrigem,LSNomeOrigem,LSfileOrigem
   	PRIVATE LSPathDestino,LSNomeDestino,LSfileDestinoOrigem
   	
	*-----------------------------------------------*
	=W_DEFPROC("DUPLICAT.SPR")

*--------------------------------------------------*
*** LSNomeOrigem	= CRNmDuplXMLExpt(PrmEmp,PrmNroRef)
***	LSPathOrigem    = "C:\Dupl\TMP\"
*--------------------------------------------------*


    *-----------------------------------------------*
    *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
    *-----------------------------------------------*
  	LSNomeOrigem	= CRNmDuplXMLExpt(PrmEmp,PrmNroRef)


	LSPathOrigem  = CRPthTmpDup(PrmEmp)

    LSfileOrigem    = LSPathOrigem + LSNomeOrigem

	IF !FILE(LSfileOrigem)
	   RETURN(.F.)
	ENDIF
	*-----------------------------------------------*



*-----------------------------------------------------------*
*	=W_DEFPROC("PARAMETR.SPR")
*	LSPathDestino   = PMGetFieldValue(PrmEmp,"DIR_DFIN")
*
*   IF TYPE("LSPathDestino") <> "C" or EMPTY(LSPathDestino)
*        LSPathDestino = "C:\Dupl\"
*	else
*         LSPathDestino = ALLTRIM(LSPathDestino)
*    ENDIF
*-----------------------------------------------------------*

    LSPathDestino =CRPthDstnDupDIR_DEFIN(PrmEmp)


	*--------------------------------------------------*

   	LSNomeDestino   = "DP"+LSNomeOrigem

    LSfileDestino   = LSPathDestino + LSNomeDestino

	*-----------------------------------------------*
			
	=CRCOPYLongo(LSFileOrigem,LSFileDestino)


	IF FILE(LSFileOrigem)
		DELETE FILE &LSFileOrigem
	ENDIF

	*--------------------------------------------------*



RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4AS           CRNmDuplXMLExpt VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   55  º
*       º Variable:            CRNmDuplXMLExpt                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      306                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4as     &&  CRNmDuplXMLExpt VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRNmDuplXMLExpt
PARAMETER PrmEmpresa,PrmNroRef

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml

    PRIVATE LSnro	
	*----------------------------------------------------------*
    IF TYPE("PrmNroRef") = "D"
         LSnro = SUBS(DTOS(PrmNroRef),3)
    ELSE
         LSnro = ALLTRIM(STR(PrmNroRef,9))
         LSnro = SUBS(LSnro,2)

    ENDIF



    LSnro = CHRTRAN(LSnro," ","0")


***	LSnomeArqXml = "DP"+LSnro
	LSnomeArqXml = LSnro



  	LSfileXML	= LSnomeArqXml+".XML"

	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4AZ           CRDuplExpPeriodoDupl VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   56  º
*       º Variable:            CRDuplExpPeriodoDupl               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      307                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4az     &&  CRDuplExpPeriodoDupl VALID
#REGION 9
RETURN

FUNCTION CRDuplExpPeriodoDupl
	PARAMETERS ;
	    PrmEmp,PrmDTInicio, PrmDTFinal,PrmMotivo

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBnaco,LFclintes
	PRIVATE LNCtrItens

	LSalias = ALIAS()

	LFempresa		= NetArq("empresa")
	LFcobranca		= NetArq("cobranca")
	LFbanco  		= NetArq("banco")
	LFduplicat		= NetArq("duplicat")
	LFclienc		= NetArq("clienc")
	LFNota   		= NetArq("nota")
	LFclintes		= NetArq("clientes")

	IF (LFEmpresa+LFduplicat+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF



    SELE Empresa
    SET ORDER TO TAG empresa
    SEEK PrmEmp
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Empresa : "+;
				STR(PrmEmp,3)
      	DO  FCHExpDuplicata
		RETURN(.F.)
	ENDIF












	SELE duplicat
	SET ORDER TO TAG EMISSAO
    SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtInicio)
    SET NEAR OFF

	IF EOF()
      	DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF

	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT  WHILE !EOF()  ;
   	             AND duplicat.dt_emi <= PrmDtFinal  ;
		         AND duplicat.empresa  = PrmEmp ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0

    BKregistro  = LNregistro
    BKimpressos = LNimpressos
    BKimpressao = LNimpressao


	*----------------------------------------------------*

	*-------------------------------------------------------*
	=CRDuplModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML

	DO WHILE       !EOF() ;
		  	  AND  LFsegue = .t. ;
	          AND  duplicat.dt_emi     <= PrmDtFinal;
		      AND  duplicat.empresa    = PrmEmp
		


        LDDt_Ant  = duplicat.dt_emi
        LDMesAnt  = MONTH(duplicat.dt_emi)
        LDAnoAnt  = YEAR(duplicat.dt_emi)


*
*	   	LSfileXML	= CRNmDuplXMLExpt(PrmEmp,LDDt_Ant)
*	   	LSfileXML	= "C:\DUPL\TMP\"+LSfileXML
*


        *-----------------------------------------------*
        *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
        *-----------------------------------------------*
      	LSfileXML	= CRNmDuplXMLExpt(PrmEmp,LDDt_Ant)
       	LSdirtmpXML	= CRPthTmpDup(PrmEmp)


       	LSfileXML	= LSdirtmpXML    +    LSfileXML

        *-----------------------------------------------*




	  	LNroIDfileXML 		=fcreate(LSfileXML)
	   	if LNroIDfileXML<0
     	   =fclose(LNroIDfileXML)
	        wait 'ERRO cria‡Æo arquivo tempor rio ';
	             +LSfileXML+'- <ENTER> ' window
      	     DO  FCHExpDuplicata
             EXIT
    	endif


 	    *---------------------------------------------------*
	    =CRDuplIniXML(LSfileXML,LNroIDfileXML)
        *----------------------------------------------------*

	    DO WHILE   !EOF() ;
		  	  AND  LFsegue = .t. ;
	          AND  MONTH(duplicat.dt_emi)      = LDMesAnt;
              AND  YEAR(duplicat.dt_emi)       = LDAnoAnt;
              AND  duplicat.dt_emi            <= PrmDtFinal ;
		      AND  duplicat.empresa            = PrmEmp
		
			=UPtermo()




	        *------------------------------------------------*
    	    =CRDuplMotivoLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        	*------------------------------------------------*

	        *------------------------------------------------*
    	    =CRDuplIedentLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*

	        *------------------------------------------------*
    	    =CRDuplCedenteLegado(LSfileXML,LNroIDfileXML)
        	*------------------------------------------------*


	        *------------------------------------------------*
    	    =CRDuplPortadorLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*


	        *------------------------------------------------*
    	    =CRDuplRecebedorLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*
	
	        *------------------------------------------------*
    	    =CRDuplLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        	*------------------------------------------------*

	        *------------------------------------------------*
	        =CRDuplClieLegado(LSfileXML,LNroIDfileXML)
    	    *------------------------------------------------*

			*------------------------------------------------------*
			SELE DUPLICAT
			SKIP
		ENDDO

		=CRDuplFinXML(LSfileXML,LNroIDfileXML)

        =fclose(LNroIDfileXML)

        =CRDupEnviaXML(PrmEmp,LDDt_Ant)

	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
  	
	***************************

  	DO  FCHExpDuplicata

	UNLOCK
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4B0           CRAvsExpPeriodo VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   57  º
*       º Variable:            CRAvsExpPeriodo                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      308                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4b0     &&  CRAvsExpPeriodo VALID
#REGION 9
RETURN

FUNCTION CRAvsExpPeriodo
	PARAMETERS ;
	    PrmEmp,PrmDtInicio,PrmDtFinal

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*

    PRIVATE LSAlsPeriodo
	PRIVATE ;
	    PrmEmp,PrmBanco,PrmCarteira,PrmVariacao,PrmAviso


	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFmvretorn,LFbcretorn,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBanco,LFclintes
	PRIVATE LNCtrItens

	LSalias = ALIAS()

	LFempresa		= NetArq("empresa")
	LFbcretorn		= NetArq("retornbc")
	LFmvretorn		= NetArq("retornmv")
	LFcobranca		= NetArq("cobranca")
	LFbanco   		= NetArq("banco")
	LFduplicat		= NetArq("duplicat")
	LFclintes		= NetArq("clientes")


	LFclienc		= NetArq("clienc")
	LFNota   		= NetArq("nota")
	IF (LFEmpresa+LFmvretorn+LFbcretorn+LFbanco+LFduplicat+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHProcBaixa
		RETURN(.f.)
	ENDIF




    =NetArqAgain("Retornbc")
    LSAlsPeriodo    = Alias()


    SET NEAR ON
    SELE &LSAlsPeriodo
    SET ORDER TO TAG DT_AVISO
    SEEK STR(PrmEmp,3)+DTOS(PrmDtInicio)
    SET NEAR OFF

	IF EOF()
		DO  FCHProcBaixa
		RETURN(.f.)
	ENDIF



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT  WHILE !EOF()  ;
   	             AND &LSAlsPeriodo .DTAVISO <= PrmDtFinal  ;
		         AND &LSAlsPeriodo .empresa  = PrmEmp ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0

    BKregistro  = LNregistro
    BKimpressos = LNimpressos
    BKimpressao = LNimpressao


	*----------------------------------------------------*




	*-------------------------------------------------------*
	=CRAvsModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML

*  	LSfileXML	= CRAvsNmXMLExpt(PrmEmp,PrmDtInicio)
*  	LSfileXML	= "C:\DUPL\TMP\"+LSfileXML



    *-----------------------------------------------*
    *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
    *-----------------------------------------------*
   	LSfileXML	= CRAvsNmXMLExpt(PrmEmp,PrmDtInicio)
   	LSdirtmpXML	= CRPthTmpDup(PrmEmp)

  	LSfileXML	= LSdirtmpXML    +    LSfileXML

    *-----------------------------------------------*





  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      return
   	endif

	*---------------------------------------------------*
	=CRAvsIniXML(LSfileXML,LNroIDfileXML)
	*----------------------------------------------------*

    SELE &LSAlsPeriodo
    SET ORDER TO TAG DT_AVISO


	DO WHILE  !EOF() AND ;
		    &LSAlsPeriodo .empresa = PrmEmp;
		AND &LSAlsPeriodo .DTAVISO <= PrmDtFinal

		=UPtermo()


        PrmEmp         = PrmEmp
        PrmBanco       = &LSAlsPeriodo .BANCO
        PrmCarteira    = &LSAlsPeriodo .CARTEIRA
        PrmVariacao    = &LSAlsPeriodo .VARIACAO
        PrmAviso       = &LSAlsPeriodo .AVISO

*--------------------------------------------------------------*
	    SELE cobranca
	    SET ORDER TO TAG CARTEIRA
	    SEEK STR(PrmEmp,3)+STR(PrmBanco,3)+ PrmCarteira+PrmVariacao
		IF !FOUND()
			DO OBJ_MENS.SPR WITH ;
			"    Nao Foi Possivel Localizar COBRANCA : ";
		        +"Aviso:"   +STR(PrmAviso,8);
				+" Banco:"	+ STR(PrmBanco,3);
				+" Carteira:"	+ PrmCarteira;
				+" Variacao:"	+ PrmVariacao
		    SELE &LSAlsPeriodo
		    SKIP
		    LOOP
		ENDIF

	    SELE banco
	    SET ORDER TO TAG BANCO
	    SEEK PrmBanco
		IF !FOUND()
			DO OBJ_MENS.SPR WITH ;
			"    Nao Foi Possivel Localizar BANCO : ";
		        +"Aviso:"   +STR(PrmAviso,8);
				+" Banco:"	+ STR(PrmBanco,3);
				+" Carteira:"	+ PrmCarteira;
				+" Variacao:"	+ PrmVariacao
		    SELE &LSAlsPeriodo
		    SKIP
		    LOOP
		ENDIF






	    SELE Empresa
	    SET ORDER TO TAG empresa
	    SEEK PrmEmp
		IF !FOUND()
			DO OBJ_MENS.SPR WITH ;
			    "    Nao Foi Possivel Localizar Empresa : "+;
					STR(PrmEmp,3)
		    SELE &LSAlsPeriodo
		    SKIP
		    LOOP
		ENDIF


		SELE retornbc
		SET ORDER TO TAG aviso
		SEEK STR(PrmEmp,3)+STR(PrmBanco,3)+;
		   PrmCarteira+PrmVariacao+STR(PrmAviso,8)
		IF !FOUND()
			DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Aviso : "+;
				STR(PrmAviso,8)+" do Banco : "+ STR(PrmBanco,3)
		    SELE &LSAlsPeriodo
		    SKIP
		    LOOP
		ENDIF



	    LNCtrItens = 0

		SELECT  retornmv
		SET ORDER TO TAG aviso
		SEEK STR(PrmEmp,3)+STR(PrmBanco,3)+;
		     PrmCarteira+PrmVariacao+STR(PrmAviso,8)


		DO WHILE  !EOF() AND ;
		    PrmAviso     = retornmv.aviso AND ;
			PrmBanco     = retornmv.banco AND ;
			PrmCarteira = retornmv.carteira AND ;
			PrmVariacao = retornmv.Variacao AND ;
			PrmEmp 	    = retornmv.empresa
		
	        LNCtrItens = LNCtrItens + 1


        	*------------------------------------------------*
		    *  aqui chamada geracao do xml do capa do aviso   	
			*------------------------------------------------*
    	    =CRExpCapaRetLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*

	        *------------------------------------------------*
	        *  aqui chamada geracao do xml do ilocal cobranca
    	    *------------------------------------------------*
	        =CRExpLccbrCapaRetLegado(LSfileXML,LNroIDfileXML)
    	    *------------------------------------------------*

			SELE duplicat
			SET ORDER TO TAG doc
			SEEK STR(PrmEmp,3)+STR(retornmv.duplicata,9)
			IF FOUND()



            	*------------------------------------------------*
            	*  aqui chamada geracao do xml da duplicata            	
				*------------------------------------------------*
	            =CRExpItemRetLegado(LNCtrItens,;
                                LSfileXML,LNroIDfileXML)

    	        *------------------------------------------------*
	            *  aqui chamada geracao do xml das duplicatas           	
                *------------------------------------------*
	            =CRExpDuplRetLegado(LSfileXML,LNroIDfileXML)

            	*------------------------------------------------*
            	*  aqui chamada geracao do xml do clienc
            	*------------------------------------------------*
    	        =CRExpClieDupLegado(LSfileXML,LNroIDfileXML)
	
				SELE retornmv
			ENDIF
			*------------------------------------------------------*
			SELE retornmv
			SKIP
		ENDDO
		*---------------------------------------------------------------*
		SELE &LSAlsPeriodo
		SKIP
	ENDDO
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*

    SELE &LSAlsPeriodo
    USE

	=CRAvsFinML(LSfileXML,LNroIDfileXML)

    =fclose(LNroIDfileXML)

    =CRAvsEnviaXML(PrmEmp,PrmDtInicio)

  	
	***************************

	DO  FCHProcExpAviso

	UNLOCK
RETURN(.T.)

PROCEDURE FCHProcExpAviso
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("cobranca" ,LFcobranca)
	=UP_fecha("retornbc" ,LFbcretorn)
	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("banco" ,LFbanco)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("nota" ,LFnota)
	=UP_fecha("clientes" ,LFclintes)
	
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4B1           CRNmLongoFileXMLDocFiscal VALID    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   58  º
*       º Variable:            CRNmLongoFileXMLDocFiscal          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      309                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4b1     &&  CRNmLongoFileXMLDocFiscal VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRNmLongoFileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
    PRIVATE LSPrefixo,LSTpDoc,LSNrDoc,LSNrEmp

	
	*----------------------------------------------------------*
    LSPrefixo = "DFISCB"
    LSTpDoc   = PrmMod_Doc
    LSNrDoc   = CHRTRAN(STR(PrmNro_Doc,7)," ","0")
    LSNrEmp   = CHRTRAN(STR(PrmEmpresa,3)," ","0")



	LSnomeArqXml = LSPrefixo+LSNrEmp+LSTpDoc+LSNrDoc+".XML"

   	LSfileXML	= LSnomeArqXml
	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4B2           DFCopyLongo VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   59  º
*       º Variable:            DFCopyLongo                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      310                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4b2     &&  DFCopyLongo VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRCopyLongo
PARAMETERS PrmArqOrigem,PrmArqDestino

    ! copyfox.exe &PrmArqOrigem &PrmArqDestino


RETURN(.T.)

*----------------------------------------------------------*


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4B3           CRDuplExpVencPeriodoDupl VALID     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   60  º
*       º Variable:            CRDuplExpVencPeriodoDupl           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      311                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4b3     &&  CRDuplExpVencPeriodoDupl VALID
#REGION 9
RETURN

FUNCTION CRDuplExpVencPeriodoDupl
	PARAMETERS ;
	    PrmEmp,PrmDTInicio, PrmDTFinal,PrmMotivo

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBnaco,LFclintes
	PRIVATE LNCtrItens

	LSalias = ALIAS()

	LFempresa		= NetArq("empresa")
	LFcobranca		= NetArq("cobranca")
	LFbanco  		= NetArq("banco")
	LFduplicat		= NetArq("duplicat")
	LFclienc		= NetArq("clienc")
	LFclintes		= NetArq("clientes")

	LFNota   		= NetArq("nota")
	IF (LFEmpresa+LFduplicat+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF



    SELE Empresa
    SET ORDER TO TAG empresa
    SEEK PrmEmp
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Empresa : "+;
				STR(PrmEmp,3)
      	DO  FCHExpDuplicata
		RETURN(.F.)
	ENDIF






	SELE duplicat
	SET ORDER TO TAG RL_VENC
    SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtInicio)
    SET NEAR OFF

	IF EOF()
      	DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF
	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT  WHILE !EOF()  ;
   	             AND duplicat.dt_venc <= PrmDtFinal  ;
		         AND duplicat.empresa  = PrmEmp ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0

    BKregistro  = LNregistro
    BKimpressos = LNimpressos
    BKimpressao = LNimpressao


	*----------------------------------------------------*

	*-------------------------------------------------------*
	=CRDuplModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML



	*---------------------------------------------------*
	=CRDuplIniXML(LSfileXML,LNroIDfileXML)
	*----------------------------------------------------*

	DO WHILE       !EOF() ;
		  	  AND  LFsegue = .t. ;
	          AND  duplicat.dt_venc     <= PrmDtFinal;
		      AND  duplicat.empresa    = PrmEmp

		
        LDDt_Ant  = duplicat.dt_venc
        LDMesAnt  = MONTH(duplicat.dt_venc)
        LDAnoAnt  = YEAR(duplicat.dt_venc)




       *-----------------------------------------------*
       *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
       *-----------------------------------------------*
      	LSfileXML	= CRNmDuplXMLExpt(PrmEmp,LDDt_Ant)
      	LSdirtmpXML	= CRPthTmpDup(PrmEmp)

    	LSfileXML	= LSdirtmpXML    +    LSfileXML

       *-----------------------------------------------*

    	LNroIDfileXML 		=fcreate(LSfileXML)

    	if LNroIDfileXML<0
           =fclose(LNroIDfileXML)
            wait 'ERRO cria‡Æo arquivo tempor rio ';
              +LSfileXML+'- <ENTER> ' window
      	    DO  FCHExpDuplicata
            EXIT
   	    endif

        *------------------------------------------------*
   	    =CRDuplMotivoLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*
	    DO WHILE   !EOF() ;
		  	  AND  LFsegue = .t. ;
	          AND  MONTH(duplicat.dt_venc)      = LDMesAnt;
              AND  YEAR(duplicat.dt_venc)       = LDAnoAnt;
              AND  duplicat.dt_venc            <= PrmDtFinal ;
		      AND  duplicat.empresa            = PrmEmp
		
			=UPtermo()



	        *------------------------------------------------*
    	    =CRDuplMotivoLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        	*------------------------------------------------*

	        *------------------------------------------------*
    	    =CRDuplIedentLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*

	        *------------------------------------------------*
    	    =CRDuplCedenteLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*


	        *------------------------------------------------*
    	    =CRDuplPortadorLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*


	        *------------------------------------------------*
    	    =CRDuplRecebedorLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*

	        *------------------------------------------------*
    	    =CRDuplLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
	        *------------------------------------------------*

	        *------------------------------------------------*
    	    =CRDuplClieLegado(LSfileXML,LNroIDfileXML)
	        *------------------------------------------------*

			*------------------------------------------------------*
			SELE DUPLICAT
			SKIP
		ENDDO
		=CRDuplFinXML(LSfileXML,LNroIDfileXML)

	    =fclose(LNroIDfileXML)

	    =CRDupEnviaXML(PrmEmp,LDDt_Ant)

	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*



  	
	***************************

  	DO  FCHExpDuplicata

	UNLOCK
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4CH           FCHExpDuplicata VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   61  º
*       º Variable:            FCHExpDuplicata                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      312                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4ch     &&  FCHExpDuplicata VALID
#REGION 9
RETURN


PROCEDURE FCHExpDuplicata
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("cobranca" ,LFcobranca)
	=UP_fecha("banco" ,LFbanco)
	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("nota" ,LFnota)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4CP           CRDuplDFisExpDuplicata VALID       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   62  º
*       º Variable:            CRDuplDFisExpDuplicata             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      313                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4cp     &&  CRDuplDFisExpDuplicata VALID
#REGION 9
RETURN

FUNCTION CRDuplDFisExpDuplicata
	PARAMETERS ;
	    PrmEmpresa,PrmNota,PrmMotivo

    * PrmMotivo  (RIMPRIMIR,EGISTRAR,CANCELAR,EXPORTAR)	

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBanco,LFclintes
	PRIVATE LNCtrItens
	PRIVATE LForcamento


    PRIVATE LFRetorno
	PRIVATE LSStatus


*--------------------------------------------------------*
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc


	*----------------------------------------------------*

	*-->>>>>>>>>>>       PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc,;
			  RtnDocEletro



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc,;
			  RtnDocEletro
*--------------------------------------------------------*


	LSalias = ALIAS()




	LForcamento     = NetArq("Orcament")
	LFempresa		= NetArq("empresa")
	LFcobranca		= NetArq("cobranca")
	LFduplicat		= NetArq("duplicat")
	LFbanco   		= NetArq("banco")
	LFclienc		= NetArq("clienc")
	LFclintes		= NetArq("clientes")
	LFNota   		= NetArq("nota")
	IF (LForcamento+LFEmpresa+LFduplicat+LFBanco+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF



    SELE nota
    SET ORDE TO nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !found()
		DO  FCHExpDuplicata
		RETURN(.T.)
	ENDIF



    SELE orcament
    SET ORDE TO geral
    SEEK STR(PrmEmpresa,3)+STR(nota.Orcamento,6)
	IF !FOUND() ;
	     OR orcament.natu_oper <> 1

		   	&& So Gerar Duplicatas para
		    && operacoes de Venda

		DO  FCHExpDuplicata
		RETURN(.T.)
	ENDIF



    SELE Empresa
    SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Empresa : "+;
				STR(PrmEmpresa,3)
      	DO  FCHExpDuplicata
		RETURN(.F.)
	ENDIF




	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
	*  ALGORITIMO DE GERACAO DO NUMERO DE DUPLICATA - CRgeradupl
	*----------------------------------------------------------------*
	*
	*	IF LNemp <> 10
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  STR(m.empresa,1)))   && 1 => DUPLICATA
	*	else
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  "0"))   && 1 => DUPLICATA
	*	ENDIF
	*-------------------------------------------------------------------*

    PRIVATE LSnota
    PRIVATE LNdup
    PRIVATE LNnroReC

	LSnota  = STR(PrmNota,7)
	LNdup	= PrmNota * 100		


	SET NEAR ON

	SELE Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(LNdup,9)

    SET NEAR OFF


    LNnroReC = RECNO()



	*-------------------------------------------------------*
	=CRDuplModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML




*----------------------------------------------------*
	PrmSerie   		= nota.Serie
	PrmTipo    		= nota.Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc,RtnDocEletro)


*--------------------------------------------------------*



*--------------------------------------------------------
*--------------------------------------------------------
*  	LSfileXML	= CRNmDuplXMLExpt(PrmEmpresa,RtnNro_Doc)
*
*
*  	LSfileXML	= "C:\DUPL\TMP\"+LSfileXML
*--------------------------------------------------------

   *-----------------------------------------------*
   *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
   *-----------------------------------------------*
   	LSfileXML	= CRNmDuplXMLExpt(PrmEmpresa,RtnNro_Doc)
   	LSdirtmpXML	= CRPthTmpDup(PrmEmpresa)


   	LSfileXML	= LSdirtmpXML    +    LSfileXML
   *-----------------------------------------------*


  	LNroIDfileXML 		=fcreate(LSfileXML)




   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      	DO  FCHExpDuplicata
      return(.f.)
   	endif

	*---------------------------------------------------*
	=CRDuplIniXML(LSfileXML,LNroIDfileXML)
	*----------------------------------------------------*





	SET NEAR OFF
	DO WHILE !EOF() ;
	    AND LSnota  = LEFT(STR( Duplicat.duplicata,9) ,7);
		AND PrmEmpresa 	=  Duplicat.empresa
		



        *------------------------------------------------*
        =CRDuplMotivoLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplIedentLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*



        *------------------------------------------------*
        =CRDuplCedenteLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplPortadorLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplRecebedorLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplClieLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

		*------------------------------------------------------*
		SELE DUPLICAT
		SKIP
	ENDDO
	=CRDuplFinXML(LSfileXML,LNroIDfileXML)

    =fclose(LNroIDfileXML)

*------------------------------------------*
*    =CRDupEnviaXML(PrmEmpresa,LNnroReC)
*------------------------------------------*
    =CRDupEnviaXML(PrmEmpresa,RtnNro_Doc)


    LFRetorno = .t.
	LSStatus = CRRespostaDup(PrmEmpresa, RtnNro_Doc, "NAO ESPERA")
	IF "ERRO" $ LSStatus
       LFRetorno = .f.
    ENDIF
  	
	***************************

  	DO  FCHExpDuplicata

	UNLOCK
RETURN(LFRetorno)

PROCEDURE FCHExpDuplicata
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("cobranca" ,LFcobranca)
	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("banco" ,LFbanco)
	=UP_fecha("nota" ,LFnota)
	=UP_fecha("clientes" ,LFclintes)

    IF TYPE("LForcamento") <> "U"
     	=UP_fecha("orcament" ,LForcamento)
    ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4CQ           CREsperaRspDup VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   63  º
*       º Variable:            CREsperaRspDup                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      314                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4cq     &&  CREsperaRspDup VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CREsperaRspDup
PARAMETERS PrmEmpresa, PrmNroDoc


	*-------------------------------------------------------*
	PRIVATE LSstatus
	PRIVATE CtrAguarda

	LSstatus = ""

    CtrAguarda = 0
	LFlgEspera = .t.

	DO WHILE LFlgEspera


		LSstatus=CRBuscaRspDup(PrmEmpresa, PrmNroDoc)

		DO CASE
 		 	CASE "ERRO ! Espera interrompida por usr" $ LSstatus
				LFlgEspera = .F.
		
			CASE "ERRO ! Nao houve retorno do comando" $ LSstatus
				LFlgEspera = .T.

			CASE "PROCESSADO" $ LSstatus
				LFlgEspera = .F.


			CASE "ERRO" $ LSstatus
				LFlgEspera = .F.

		ENDCASE
	ENDDO
    LSmsg = "Concluido leitura XML............ "
	WAIT WINDOW LSmsg NOWAIT

RETURN(LSstatus)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4CR           CRBuscaRspDup VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   64  º
*       º Variable:            CRBuscaRspDup                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      315                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4cr     &&  CRBuscaRspDup VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CRBuscaRspDup
PARAMETERS PrmEmpresa,PrmNro_Doc

	*-------------------------------------------------------*

	PRIVATE LSnroDoc
	PRIVATE LNfile
	PRIVATE LSstatus,LSFile,LNctr,TECLA


	*-------------------------------------------------------*
	*  obter o MOD_DOC
	*-------------------------------------------------------*



	*----------------------------------------------------------*

	LSstatus = ""
	LNfile = 0




	*--------------------------------------------------*

*----------------------------------------------------------*
*	=W_DEFPROC("PARAMETR.SPR")
*
*
*	LSPathDestino   = PMGetFieldValue(PrmEmpresa,"DIR_DFIN")
*
*    IF TYPE("LSPathDestino") <> "C" or EMPTY(LSPathDestino)
*         LSPathDestino = "C:\Dupl\"
*	else
*         LSPathDestino = ALLTRIM(LSPathDestino)
*    ENDIF
*----------------------------------------------------------*



    LSPathDestino =CRPthDstnDupDIR_DEFIN(PrmEmp)


	*--------------------------------------------------*


	=W_DEFPROC("DUPLICAT.SPR")
   	LSFile	= CRNmDuplXMLExpt(PrmEmpresa,PrmNro_Doc)

    LSFileOk  = LSPathDestino+strtran(LSFile,".XML",".$$$")
    LSFileErr = LSPathDestino+strtran(LSFile,".XML",".ERR")

    LSFileBKP = LSPathDestino+"\BKP\"+strtran(LSFile,".XML",".ERR")
    	
	*-----------------------------------------------------*

	LNctr = 0

	CLEAR TYPEAHEAD


	DO WHILE !(FILE(LSFileOk)) and !(FILE(LSFileErr))

	    LSmsg = STR(LNctr,3)+"-Aguarda- <ESC>=Sai ";
	    +LSFileOK+" ou "+LSFileErr

		WAIT WINDOW LSmsg NOWAIT
		TECLA=INKEY(3)
		LNctr = LNctr + 1
		IF  LNctr > 60
			EXIT
		ENDIF
		IF TECLA = 27 OR LASTKEY() = 27
			IF fox_alert("Interrompe Espera NFe ? ")
				LSstatus = "ERRO ! Espera interrompida por usr"
				EXIT
			ENDIF
		ENDIF

	ENDDO

	DO CASE
		CASE LSstatus = "ERRO ! Espera interrompida por usr"
 		 	LSstatus = "ERRO ! Espera interrompida por usr"

		CASE !(FILE(LSFileOk)) and !(FILE(LSFileErr))
			LSstatus = "ERRO ! Nao houve retorno do comando"

		OTHERWISE		
			TECLA=INKEY(3)


			IF (FILE(LSFileOk))
				LSstatus="PROCESSADO !- Financeiro Registrado"
			ELSE
				LSstatus="ERRO ! - Financeiro Nao Registrado"
            ENDIF



			IF (FILE(LSFileOk))
		   		delete file &LSFileOk
			ENDIF
			
			IF (FILE(LSFileErr))
                =CRCopyLongo(LSFileErr,LSFileBKP)
		   		delete file &LSFileErr
			ENDIF


	ENDCASE

	*---------------------------------------------------*
	* as barrar fornecem uma orientacao para se tratar
	* o retorno quando nao sao informados todos os
	* parametros de retorno.
	* A rotina (DFRespostaNFe ) que trata o staus identifique o
	* os parametro nao retornados com
	*---------------------------------------------------*
	LSstatus = LSstatus + "||||||||||||||||||||||||||||||"


RETURN(LSstatus)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4DM           CRRespostaDup VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   65  º
*       º Variable:            CRRespostaDup                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      316                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4dm     &&  CRRespostaDup VALID
#REGION 9
return
*---------------------------------------------------------------*
*		   PrmEsperaResposta,;
*		       && "ESPERA" ou "NAO ESPERA"
*
*---------------------------------------------------------------*

FUNCTION CRRespostaDup
PARAMETERS ;
		   PrmEmpresa,;	
		   PrmNroDoc,;
		   PrmEsperaResposta
	*-------------------------------------------------------*
	PRIVATE LSstatus
	LSstatus = ""


	IF PrmEsperaResposta = "ESPERA"
		LSstatus=CREsperaRspDup(PrmEmpresa,PrmNroDoc)
	ELSE
		LSstatus=CRBuscaRspDup(PrmEmpresa,PrmNroDoc)
	ENDIF


	*-------------------------------------------------------*


RETURN(LSstatus)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4DV           CRDuplMotivoLegado VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   66  º
*       º Variable:            CRDuplMotivoLegado                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      317                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4dv     &&  CRDuplMotivoLegado VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*



FUNCTION CRDuplMotivoLegado
PARAMETERS 	PrmFileXML,;
			PrmNroIDfileXML,;
			PrmMotivo
			

	PRIVATE AlsANT       && Alias Anterior
	PRIVATE LSAlsEmp     && Empresa
	

	AlsANT = ALIAS()

	SELE EMPRESA
	LSAlsEMP = alias()


	*-------------------------------------------------------*

   	PRIVATE lErro
   	PRIVATE LSLinhaXML
	PRIVATE LSEmite_NFe
	PRIVATE LNNro_Doc


	*-----  IDENTIFICACAO DO CONTRIBUINTE  -----------------------*
	SET POINT TO ","
	SET SEPARATOR  TO "."


	IF TYPE("PrmMotivo") <> "C"
        PrmMotivo = "REGISTRAR"
    ENDIF
	

	DO CASE

	   CASE ("CANCELAR" $ PrmMotivo)
        	LSLinhaXML  = "CANCELAR"

	   CASE ("IMPRIMIR" $ PrmMotivo)
        	LSLinhaXML  = "IMPRIMIR"


	   CASE ("EXPORTAR" $ PrmMotivo)

**        	LSLinhaXML  = "EXPORTAR"   && WARQUIA MANTEVE O REGISTRAR
        	LSLinhaXML  = "REGISTRAR"

       OTHERWISE
        	LSLinhaXML  = "REGISTRAR"
    ENDCASE


    LSLinhaXML  = CRtratalinha('<ROW XML_MOTIVO="'+LSLinhaXML+'"')
    =CR_Fputs(PrmNroIDfileXML,LSLinhaXML,LEN(LSLinhaXML))
	*----------------------------------------------------------*
	*----------------------------------------------------------*

	SET POINT TO
	SET SEPARATOR  TO


RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4E8           CRGer2XMLDpDocFiscal VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   70  º
*       º Variable:            CRGer2XMLDpDocFiscal               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      318                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4e8     &&  CRGer2XMLDpDocFiscal VALID
#REGION 9
RETURN

FUNCTION CRGer2XMLDpDocFiscal

PARAMETER PrmEmpresa,;
		  PrmNro_Orca,;
		  PrmNro_Doc,;
		  PrmMod_doc,;
		  PrmSerie_Doc,;
		  PrmTP_Mov, ;
		  PrmNota,;
		  PrmMotivo



    * PrmMotivo  (IMPRIMIR,REGISTRAR,CANCELAR,EXPORTAR)	

	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca,LFBanco,LFclintes
	PRIVATE LNCtrItens
	PRIVATE LForcamento


    PRIVATE LFRetorno
	PRIVATE LSStatus


	LSalias = ALIAS()

	LForcamento     = NetArq("Orcament")
	LFempresa		= NetArq("empresa")
	LFcobranca		= NetArq("cobranca")
	LFduplicat		= NetArq("duplicat")
	LFbanco   		= NetArq("banco")
	LFclienc		= NetArq("clienc")
	LFclintes		= NetArq("clientes")
	LFNota   		= NetArq("nota")
	IF (LForcamento+LFEmpresa+LFduplicat+LFBanco+;
	              LFclienc+LFCobranca+LFNota+LFclintes) > 100000
		DO  FCHExpDuplicata
		RETURN(.f.)
	ENDIF






    SELE nota
    SET ORDE TO nota
    SEEK STR(PrmEmpresa,3)+STR(PrmNota,7)
	IF !found()
		DO  FCHExpDuplicata
		RETURN(.T.)
	ENDIF



    SELE orcament
    SET ORDE TO geral
    SEEK STR(PrmEmpresa,3)+STR(nota.Orcamento,6)
	IF !FOUND() ;
	     OR orcament.natu_oper <> 1

		   	&& So Gerar Duplicatas para
		    && operacoes de Venda

		DO  FCHExpDuplicata
		RETURN(.T.)
	ENDIF



    SELE Empresa
    SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Empresa : "+;
				STR(PrmEmpresa,3)
      	DO  FCHExpDuplicata
		RETURN(.F.)
	ENDIF




	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
	*  ALGORITIMO DE GERACAO DO NUMERO DE DUPLICATA - CRgeradupl
	*----------------------------------------------------------------*
	*
	*	IF LNemp <> 10
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  STR(m.empresa,1)))   && 1 => DUPLICATA
	*	else
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  "0"))   && 1 => DUPLICATA
	*	ENDIF
	*-------------------------------------------------------------------*
    PRIVATE LSnota
    PRIVATE LNdup
    PRIVATE LNnroReC

	LSnota  = STR(PrmNota,7)
	LNdup	= PrmNota * 100		



	SET NEAR ON

	SELE Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(LNdup,9)

    SET NEAR OFF


    LNnroReC = RECNO()




	*-------------------------------------------------------*
	=CRDuplModeloXML()
	*-------------------------------------------------------*
   	PRIVATE LSfileXML,LNroIDfileXML


	*-------------------------------------------------------*
*  	LSfileXML	= CRNm2FileXMLDocFiscal(PrmEmpresa,PrmMod_doc,PrmNro_Doc)
*  	LSfileXML	= "C:\DUPL\TMP\"+LSfileXML
	*-------------------------------------------------------*

   *-----------------------------------------------*
   *   DEFINE PATH E NOME DE ARQUIVO TEMPORARIO
   *-----------------------------------------------*
   	LSfileXML	= CRNm2FileXMLDocFiscal(PrmEmpresa,PrmMod_doc,PrmNro_Doc)
   	LSdirtmpXML	= CRPthTmpDup(PrmEmpresa)


   	LSfileXML	= LSdirtmpXML    +    LSfileXML
   *-----------------------------------------------*



  	LNroIDfileXML 		=fcreate(LSfileXML)
   	if LNroIDfileXML<0
      =fclose(LNroIDfileXML)
      wait 'ERRO cria‡Æo arquivo tempor rio '+LSfileXML+'- <ENTER> ' window
      	DO  FCHExpDuplicata
      return(.f.)
   	endif

	*---------------------------------------------------*
	=CRDuplIniXML(LSfileXML,LNroIDfileXML)
	*----------------------------------------------------*





	SET NEAR OFF
	DO WHILE !EOF() ;
	    AND LSnota  = LEFT(STR( Duplicat.duplicata,9) ,7);
		AND PrmEmpresa 	=  Duplicat.empresa
		



        *------------------------------------------------*
        =CRDuplMotivoLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplIedentLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*



        *------------------------------------------------*
        =CRDuplCedenteLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplPortadorLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*


        *------------------------------------------------*
        =CRDuplRecebedorLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplLegado(LSfileXML,LNroIDfileXML,PrmMotivo)
        *------------------------------------------------*

        *------------------------------------------------*
        =CRDuplClieLegado(LSfileXML,LNroIDfileXML)
        *------------------------------------------------*

		*------------------------------------------------------*
		SELE DUPLICAT
		SKIP
	ENDDO
	=CRDuplFinXML(LSfileXML,LNroIDfileXML)

    =fclose(LNroIDfileXML)

    LFRetorno = .t.
	***************************

******************************PROCEDURE FCHExpDuplicata
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("cobranca" ,LFcobranca)
	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("clienc" ,LFclienc)
	=UP_fecha("banco" ,LFbanco)
	=UP_fecha("nota" ,LFnota)
	=UP_fecha("clientes" ,LFclintes)

    IF TYPE("LForcamento") <> "U"
     	=UP_fecha("orcament" ,LForcamento)
    ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
*********************************RETURN

RETURN(LFRetorno)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4E9           CRNm2FileXMLDocFiscal VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   74  º
*       º Variable:            CRNm2FileXMLDocFiscal              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      319                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4e9     &&  CRNm2FileXMLDocFiscal VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRNm2FileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc

	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*




   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
    PRIVATE LSPrefixo,LSTpDoc,LSNrDoc,LSNrEmp

	
	*----------------------------------------------------------*
    LSPrefixo = "DP"
    LSNrDoc   = CHRTRAN(STR(PrmNro_Doc,7)," ","0")
    LSNrEmp   = CHRTRAN(STR(PrmEmpresa,3)," ","0")



	LSnomeArqXml = LSPrefixo+subs(LSNrDoc,3)+".XML"

   	LSfileXML	= LSnomeArqXml
	
	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4EA           CRNm2LongoFileXMLDocFiscal VALID   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   75  º
*       º Variable:            CRNm2LongoFileXMLDocFiscal         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      320                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4ea     &&  CRNm2LongoFileXMLDocFiscal VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRNm2LongoFileXMLDocFiscal
PARAMETER PrmEmpresa,PrmMod_Doc,PrmNro_Doc

	*-------------------------------------------------------*
*
*   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
*    PRIVATE LSPrefixo,LSTpDoc,LSNrDoc,LSNrEmp

	
	*----------------------------------------------------------*
*    LSPrefixo = "DP"
*    LSTpDoc   = PrmMod_Doc
*    LSNrDoc   = CHRTRAN(STR(PrmNro_Doc,7)," ","0")
*    LSNrEmp   = CHRTRAN(STR(PrmEmpresa,3)," ","0")
*
*
*
*	LSnomeArqXml = LSPrefixo+LSNrEmp+LSTpDoc+LSNrDoc+".XML"
*
*   	LSfileXML	= LSnomeArqXml



	*-------------------------------------------------------*

   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
	
	*----------------------------------------------------------*




   	PRIVATE LSfileXML, LNroIDfileXML, LSnomeArqXml
    PRIVATE LSPrefixo,LSTpDoc,LSNrDoc,LSNrEmp

	
	*----------------------------------------------------------*
    LSPrefixo = "DP"
    LSNrDoc   = CHRTRAN(STR(PrmNro_Doc,7)," ","0")
    LSNrEmp   = CHRTRAN(STR(PrmEmpresa,3)," ","0")



	LSnomeArqXml = LSPrefixo+subs(LSNrDoc,3)+".XML"

   	LSfileXML	= LSnomeArqXml
	
	
RETURN(LSfileXML)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4EB           CRDFis_Tem_Duplicata VALID         º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   76  º
*       º Variable:            CRDFis_Tem_Duplicata               º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      321                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4eb     &&  CRDFis_Tem_Duplicata VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRDFis_Tem_Duplicata
PARAMETER PrmEmpresa,;
		  PrmNro_Orca


	PRIVATE LSalias
	
	PRIVATE PrmAlsCR
	

	LSalias  = ALIAS()
	PrmAlsCR = CRGetAlias()


	*---------------------------------------------------*

	SELE &PrmAlsCR

	go bott
	go top
	

	SELE &PrmAlsCR
	SET ORDER TO TAG REFR_ORCA
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmNro_Orca,6)
	SET NEAR OFF



    IF   eof() ;
       or PrmEmpresa   <> &PrmAlsCR .empresa;
	   or PrmNro_Orca   <> &PrmAlsCR .orcamento

       LFRetorno = .F.

    ELSE

       LFRetorno = .T.
	
	ENDIF
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(LFRetorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4F9           CR_Fputs VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   77  º
*       º Variable:            CR_Fputs                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      322                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4f9     &&  CR_Fputs VALID
#REGION 9
return
*---------------------------------------------------------------*

FUNCTION CR_FputsLimpa
PARAMETERS PrmString

	PRMString = chrtran(PRMString,"€","C")       && 01
	PRMString = chrtran(PRMString,"‡","c")       && 02
	PRMString = chrtran(PRMString,"¦","-")       && 04
	PRMString = chrtran(PRMString,"§","-")       && 05
	PRMString = chrtran(PRMString,"°",'')        && 06
	PRMString = chrtran(PRMString,"º",'')        && 07
	PRMString = chrtran(PRMString,"",'E')       && 08
	PRMString = chrtran(PRMString,"‚",'e')       && 09
	PRMString = chrtran(PRMString,"Ç",'A')       && 10
	PRMString = chrtran(PRMString,"Æ",'a')       && 11
	PRMString = chrtran(PRMString,"ø",'')        && 12
	PRMString = chrtran(PRMString,chr(0),'')     && 13

** nao 	PRMString = chrtran(PRMString,'"','')        && 14

RETURN(PrmString)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4FF           CRMntaStrgInfoCobranca VALID       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   78  º
*       º Variable:            CRMntaStrgInfoCobranca             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      323                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4ff     &&  CRMntaStrgInfoCobranca VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRMntaStrgInfoCobranca
PARAMETER PrmEmpresa,;
		  PrmNro_Orca


	PRIVATE LSalias
	
	PRIVATE PrmAlsCR
	PRIVATE LNrecDupl
	
	PRIVATE LNosiReferencia   && relaciona as duplicatas pelo
	                          && orcamento de referencia


	PRIVATE LsTmp  && String com detalhamento de Duplicatas
	

	LSalias  = ALIAS()
	PrmAlsCR = CRGetAlias()


	*---------------------------------------------------*

	SELE &PrmAlsCR
	SET ORDER TO TAG REFR_ORCA
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmNro_Orca,6)
	SET NEAR OFF



	go bott
	go top
	

	SELE &PrmAlsCR
	SET ORDER TO TAG REFR_ORCA
	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+STR(PrmNro_Orca,6)
	SET NEAR OFF




	*----------------------------------------------------*

	LFsegue = .t.



	SET POINT TO ','

	LStmp = ""

	SELE &PrmAlsCR
	DO WHILE !EOF() ;
			AND	LFsegue = .t. ;
	        AND PrmEmpresa       = &PrmAlsCR .empresa;
	        AND PrmNro_Orca       = &PrmAlsCR .orcamento




		LNrecDupl = RECNO()

		*------------------------------------------------------------*
		LSdt  =  STR(DAY( &PrmAlsCR .dt_venc),2)+"/";
			   	+STR(MONTH( &PrmAlsCR .dt_venc),2)
		LSdt  = CHRTRAN(LSdt," ","0")
		
		LStmp = LStmp + ;
   				  TRANSF( &PrmAlsCR .duplicata,"@Z 999999999")+"-"+;
				  TRANSF( &PrmAlsCR .vlr_doc,"@Z 999999.99")+"-"+LSdt+" "


		*------------------------------------------------------------*		


		SELE &PrmAlsCR
		SET ORDER TO TAG refr_orca

		GO LNrecDupl
		SKIP
	ENDDO


	SET POINT TO

	*-----------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	
RETURN(LStmp)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4FP           CRPthTmpDup VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   81  º
*       º Variable:            CRPthTmpDup                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      324                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4fp     &&  CRPthTmpDup VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRPthTmpDup
PARAMETER PrmEmp

	*-------------------------------------------------------*


	*-----------------------------------------------*


	=W_DEFPROC("PARAMETR.SPR")
	LSPathTmp   = PMGetFieldValue(PrmEmp,"DIR_DFIN")

    IF TYPE("LSPathTmp") <> "C" or EMPTY(LSPathTmp)
         LSPathTmp = "Q:\XMLS\Dupl\"
	else
         LSPathTmp = ALLTRIM(LSPathTmp)
    ENDIF

    LSPathTmp = ALLTRIM(LSPathTmp)+"TMP\"



   *----   testar o diretorio ---

    PRIVATE LSfileXML, LNroIDfileXML

    LSfileXML	= LSPathTmp+"TESTE.TXT"


    LNroIDfileXML 		=fcreate(LSfileXML)

   	if LNroIDfileXML<0
          =fclose(LNroIDfileXML)
           wait 'ERRteste diretorio tempor rio ';
              +LSfileXML+'- <ENTER> ' window
    endif
    =fclose(LNroIDfileXML)



	
RETURN(LSPathTmp)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4FQ           CRPthDstnDupDIR_DEFIN VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLICAT,     Record Number:   82  º
*       º Variable:            CRPthDstnDupDIR_DEFIN              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      325                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4fq     &&  CRPthDstnDupDIR_DEFIN VALID
#REGION 9
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION CRPthDstnDupDIR_DEFIN
PARAMETER PrmEmp

	*-------------------------------------------------------*


	*-----------------------------------------------*


	=W_DEFPROC("PARAMETR.SPR")
	LSPathTmp   = PMGetFieldValue(PrmEmp,"DIR_DFIN")

    IF TYPE("LSPathTmp") <> "C" or EMPTY(LSPathTmp)
         LSPathTmp = "Q:\XMLS\Dupl\"
	else
         LSPathTmp = ALLTRIM(LSPathTmp)
    ENDIF



   *----   testar o diretorio ---

    PRIVATE LSfileXML, LNroIDfileXML

    LSfileXML	= LSPathTmp+"TESTE.TXT"


    LNroIDfileXML 		=fcreate(LSfileXML)

   	if LNroIDfileXML<0
          =fclose(LNroIDfileXML)
           wait 'ERRteste diretorio tempor rio ';
              +LSfileXML+'- <ENTER> ' window
    endif
    =fclose(LNroIDfileXML)


	
RETURN(LSPathTmp)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4FR           CRGetNome VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    3  º
*       º Variable:            CRGetNome                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      326                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4fr     &&  CRGetNome VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CRGetNome
PARAMETERS PrmEmpresa, PrmDuplicata

	PRIVATE LFreturn
	PRIVATE LSNome

	*----------------------------------------------------------------*
	LFreturn = CRChk_Identidade(PrmEmpresa, PrmDuplicata)
	*----------------------------------------------------------------*
	LSNome = SPACE(45)
	IF LFreturn = .T.
		LSNome = CRGetPropVT("NOME")
	ENDIF

RETURN(LSNome)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4FS           CRsld_dup VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    4  º
*       º Variable:            CRsld_dup                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      327                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4fs     &&  CRsld_dup VALID
#REGION 10
RETURN

FUNCTION CRsld_dup
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Retornar o Saldo de uma Duplicata na Data
	*				Solicitada
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao utiliza-se da data e da movimentacao
	*				de duplicatas para recompor a saldo na  data
	*				solicitada
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNdup..........: Numero da Duplicata a ser verificada
	*		LDt_Refer......: Data em que se deve apurar o saldo
	*       LDt_emidp......: Data da emissao da duplicata
	*       LDt_BXdup......: Data da baixa da duplicata
	*					se esta data for menor que a data de LDt_Refer
	*					entao o saldo e (ZERO)
	*		LNvlrdup.......: Valor Total do Documento
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o saldo da duplicata
	*------------------------------------------------------------*
	*  EXEMPLO.....: SCGC518
	*
	*   =W_DEFPROC("DUPLICAT.SPR")
	*   LNvlr = CRsld_dup(&wl_arqtmp .DUPLICATA,m.dt_inicio,;
	* 		 &wl_arqtmp .dt_emi,&wl_arqtmp .DT_BAIXA, &wl_arqtmp .vlr_doc )
	*------------------------------------------------------------*

PARAMETERS  PrmEmpresa,LNdup, LDt_Refer, LDt_emidp ,LDt_BXdup, LNvlrdup
	PRIVATE LSalias
	PRIVATE LNsaldo
	PRIVATE LFretornmv

	LSalias			= ALIAS()
	=W_DEFPROC("rotinas.spr")

	IF LDt_emidp > LDt_Refer && DUP. EMIT APOS A DATA DE CONSULTA
		RETURN(0)
	ENDIF

	IF !EMPTY(LDt_BXdup) ;
		AND LDt_BXdup <= LDt_Refer && DUP. BAIXADA ANTES DA DATA DE CONSULTA
			RETURN(0)
	ENDIF


	LFretornmv		= NetArq("retornmv")
	IF (LFretornmv) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("retornmv" ,LFretornmv)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*-------------------------------------------------------------*
	LNsaldo  	=   LNvlrdup
	*-------------------------------------------------------------*
	* BAIXAR VALORES DE PGTO => (EFEITO = 2,3,4,5)
	*						2-PGTO TOTAL
	*						3-PGTO PARCIAL
	*						4-DEVOLUCAO
	*						5-INCOBRAVEL
	*-------------------------------------------------------------*
	SELE retornmv
	SET ORDER TO TAG doc_ocor
	SET NEAR ON
	SEEK str(PrmEmpresa,3)+STR(LNdup,9) 	
	SET NEAR OFF
	DO WHILE !EOF() AND LNdup = retornmv.duplicata ;
	                AND PrmEmpresa = retornmv.empresa
		IF  retornmv.efeito < 2 OR retornmv.status <> "PR"
			SKIP
			LOOP
		ENDIF
		************** JUROS EM PGTO PARCIAL ***************
		* NO CASO DE PGTO PARCIAL COM PARTE TRANSFORMADA EM
		* JUROS, ESTE JUROS NAO PODE SER ABATIDO DO SALDO DA
		* DUPLICATA => COMO JA HOUVE A SUBTRACAO DO JUROS
		* QUANDO  SUBTRAIU O PAGO PARCIAL QUE ESTA INCLUINDO
		* O JUROS E FEITA A COMPENSSACAO AGORA AO SOMAR O
		* JUROS
		***************************************************
		IF retornmv.dtprocesso <= LDt_Refer
			 LNsaldo = LNsaldo - retornmv.vlr_pgto+;
			 				retornmv.JUROS + retornmv.MORA			
		ENDIF
		SKIP
	ENDDO
	=UP_fecha("retornmv" ,LFretornmv)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNsaldo)
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4FT           CRdb_Cobr VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    5  º
*       º Variable:            CRdb_Cobr                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      328                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4ft     &&  CRdb_Cobr VALID
#REGION 10
RETURN

FUNCTION CRdb_Cobr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Retornar o Debito  da Cobranca
	*			em um periodo especifico
	*------------------------------------------------------------*
	* COMENTARIO..: DEBITO - Duplicatas emitidas no periodo
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Filial em que se deve apurar o debito
	*		LDt_ini........: Data inicial que se deve apurar o debito
	*		LDt_fim........: Data inicial que se deve apurar o debito
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o DEBITO da COBRANCA
	*------------------------------------------------------------*
	*  EXEMPLO.....:
	*------------------------------------------------------------*

PARAMETERS  LNemp, LDt_ini, LDt_fim
	PRIVATE LNdebito, LSalias
	PRIVATE LFduplicat
	LSalias			= ALIAS()
		
	=W_DEFPROC("rotinas.spr")
	LFduplicat	= NetArq("duplicat")
	IF (LFduplicat) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("duplicat" ,LFduplicat)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*---------------------------------------------------------------*	
	*	DEBITO  DE CARTEIRA	 = DUPLICATAS EMITIDAS NO DIA
	*---------------------------------------------------------------*	
	LNdebito  = 0
	sele duplicat
	SET ORDER TO TAG emissao
	SET NEAR ON
	SEEK STR(LNemp,3)+DTOS(LDt_ini)
	SET NEAR OFF
	DO WHILE !EOF() AND duplicat.dt_emi  <= LDt_fim ;
					AND duplicat.empresa  = LNemp

			LNdebito 	=  LNdebito + duplicat.vlr_doc
			SKIP
	ENDDO

	=UP_fecha("duplicat" ,LFduplicat)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNdebito)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4GR           CRcr_Cobr VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    6  º
*       º Variable:            CRcr_Cobr                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      329                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4gr     &&  CRcr_Cobr VALID
#REGION 10
RETURN

FUNCTION CRcr_Cobr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Retornar o Credito  da Cobranca
	*			em um periodo especifico
	*------------------------------------------------------------*
	* COMENTARIO..: CREDITO - Duplicatas baixadas  no periodo
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Filial em que se deve apurar o credito
	*		LDt_ini........: Data inicial que se deve apurar o credito
	*		LDt_fim........: Data inicial que se deve apurar o credito
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o CREDITO da COBRANCA
	*------------------------------------------------------------*
	*  EXEMPLO.....:
	*------------------------------------------------------------*

PARAMETERS  LNemp, LDt_ini, LDt_fim
	PRIVATE LNcredito, LSalias
	PRIVATE LFretornmv
	LSalias			= ALIAS()

	=W_DEFPROC("rotinas.spr")
	LFretornmv	= NetArq("retornmv")
	IF (LFretornmv) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("retornmv" ,LFretornmv)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*---------------------------------------------------------------*	
	*	CREDITO DE CARTEIRA  = DUPLICATAS RECEBIDAS NO DIA
	*---------------------------------------------------------------*	
	LNcredito = 0
	SELE retornmv
	SET ORDER TO TAG dtprocesso
	SEEK	STR(LNemp,3)+DTOS(LDt_ini)  && PROCURAR BAIXAS

	DO WHILE !EOF() AND retornmv.dtprocesso <= LDt_fim ;
					AND retornmv.empresa	= LNemp

		IF  retornmv.status 	   <> "PR" 	&&  PROCESSADA
			SKIP
			LOOP
		ENDIF
		IF retornmv.ocorrencia = 6 OR ;
			   retornmv.ocorrencia = 7 OR ;
			   retornmv.ocorrencia = 15 OR ;
			   retornmv.ocorrencia = 17 OR ;
			   retornmv.ocorrencia = 81 OR ;
			   retornmv.ocorrencia = 80 OR ;
			   retornmv.ocorrencia = 84 OR ;
			   retornmv.ocorrencia = 86 OR ;
			   retornmv.ocorrencia = 83    && BAIXA PARCIAL PROCESSADA
			   LNcredito =  LNcredito + retornmv.vlr_pgto - ;
				 				retornmv.JUROS - retornmv.MORA			
		ENDIF
		SKIP
	ENDDO
	*------------------------------------------------------*
	=UP_fecha("retornmv" ,LFretornmv)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNcredito)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4GY           CRsld_dup VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    7  º
*       º Variable:            CRsld_dup                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      330                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4gy     &&  CRsld_dup VALID
#REGION 10
RETURN

FUNCTION CRsld_Cobr
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Retornar o SALDO   da Cobranca
	*			em data especifico
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Filial em que se deve apurar o saldo
	*		LDt_REF........: Data que se deve apurar o saldo
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o SALDO da COBRANCA
	*------------------------------------------------------------*
	*  EXEMPLO.....:
	*------------------------------------------------------------*

PARAMETERS  LNemp, LDt_ref
	PRIVATE LNsaldo, LSalias
	PRIVATE LFduplicat
	
	LSalias			= ALIAS()
	=W_DEFPROC("rotinas.spr")

	LFDuplicat		= NetArq("duplicat")
	IF (LFduplicat) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("duplicat" ,LFduplicat)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF
	*---------------------------------------------------------------*	
	*	SALDO DE CARTEIRA
	*---------------------------------------------------------------*	
	LNsaldo   = 0
	sele duplicat
	SET ORDER TO TAG r_dtbaixa
	SET NEAR ON
	SEEK STR(LNemp,3)+DTOS(LDt_ref+1)
	SET NEAR OFF
	LNDPANT =  duplicat.duplicata
	
	DO WHILE !EOF() AND (duplicat.dt_baixa > LDt_ref;
					OR  EMPTY(duplicat.dt_baixa))  ;
			 		AND duplicat.empresa = LNemp ;
			 		AND !UPinterrompe(.F.)
		WAIT WINDOW " Apurando Saldo Duplicat : "+STR(DUPLICATA,9) + ;
					" <ESC>-Interrompe " NOWAIT

		IF duplicat.dt_emi > LDt_ref
			SKIP
			IF DUPLICAT.DUPLICATA = 9998921
				SET STEP ON
			ENDIF
			LOOP
		ENDIF
		=W_DEFPROC("DUPLICAT.SPR")
		LNsaldo   	=  LNsaldo + ;
			CRsld_dup(LNemp,(duplicat.DUPLICATA),;
		       (LDt_ref),(duplicat.dt_emi),(duplicat.dt_baixa),;
					       (duplicat.vlr_doc))
		SELE duplicat
		LNDPANT =  duplicat.duplicata
		SKIP
			IF DUPLICAT.DUPLICATA = 9998921
				SET STEP ON
			ENDIF

	ENDDO

	KEYBOARD CHR(4)			&& APAGA MENSSAGEM WAIT
	=INKEY(0.1)
	*------------------------------------------------------*
	=UP_fecha("duplicat" ,LFduplicat)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNsaldo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4H7           CRidlate26geradupl VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    8  º
*       º Variable:            CRidlate26geradupl                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      331                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4h7     &&  CRidlate26geradupl VALID
#REGION 10
RETURN
*********************************************************************
*  CRgeradupl.....: Gera duplicatas Para filiais que ainda nao registram
*              duplicatas para operacoes a vista e nao tratam a TABELA
* 				ORCA_PGT (Implantados pela Reestrutura‡Æo em Jan/01)
*           Ap¢s a Atualiza‡Æo do Sistema Na Filial a Gera‡Æo de Duplicatas
*           Ser  Realizada Pela Rotina Homonima  CRgeradupl
*
*********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Duplicat
*                   Empresa
*                   Orcament
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.: do CRgeradupl with LNemp,LNorcamento
*---------------------------------------------------------------

PROCEDURE CRidlate26geradupl		&& USADA EM SCGC201, SCGCF201, SCGC201A
	
	PARAMETERS LNEmp,LNOrcamento
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE nota	&& O NUMERO DA NOTA DEVE SER O DA 1a NOTA CASO
					&& TENHAM SIDO GERADAS DUAS COM BASE NO MESMO ORCAMENTO
					&& PARA EVITAR INFLUENCIA NO AMBENTE NOTA E PRIVATE

	PRIVATE 	LNocorrenc, LNposic, LNinicio, LNnumpgt, LNdias, LNserie
	PRIVATE 	CVSTR1,CVSTR2,LNvlrdupl,LNdifere

	PRIVATE	empresa,duplicata,dt_emi,multa_prv,mora_prv,bonus_prv,;
			prem_pont,vlr_fatura,portador,tp_cobranc,;
			desconto,regiao,natu,nome,tp_cobranc

	PRIVATE dt_venc, dtproxproc
	PRIVATE LNtmp,banco

   	PRIVATE LNTp_Parcela,LNbanco,LNvlrent,LSprazo,LDdtemi,LNmulta,LNmora
  	PRIVATE LNbonus,LNPremPont,LNRegiao,LNnatureza,LSnome,LNvlrfatura	
    PRIVATE LNnronota	

	PRIVATE LFduplicata,LFempresa,LForcamento,LFclienc
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFduplicata	= NetArq("duplicat")
	LFempresa   = NetArq("Empresa" )
	LForcamento = NetArq("Orcament")
	LFclienc    = NetArq("clienc")
	IF (LFduplicata+LFempresa+LForcamento) > 100000
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)


	IF orcament.natu_oper <> 1		&& So Gerar Duplicatas para
									&& operacoes de Venda
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF

	*----------------------------------------------------------------*
	wp_msg = "Gerando Duplicatas OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	LNcliente	= clienc.cliente	
   	LNTp_parcela= orcament.tp_parcela
   	LNbanco		= orcament.banco
   	LNvlrent	= orcament.vlr_ent
   	LSprazo		= orcament.prazo
   	LDdtemi		= orcament.dt_fat
  	LNmulta		= empresa .multa
  	LNmora		= empresa .mora
  	LNbonus		= empresa .bonus
  	LNPremPont	= empresa .prem_pont
  	LNRegiao	= clienc.regiao
	LNnatureza	= clienc.natu_cli
	LSnome		= clienc.nome
	LNvlrfatura	= orcament.valor
	LNnronota	= orcament.nota
	SELECT &LSalias

*************

	*-----------------------------------------------------------*

	=CRcancdupl((LNemp),(LNnronota))
	
	*---------------------------------------------------------------*
	*    Venda a Vista ou Parcelada no Cartao nao geram duplicatas
	*---------------------------------------------------------------*

	IF LNtp_parcela = 1   && VENDA A VISTA
		RETURN
	ENDIF
*
	LNocorrenc 	= 1
    LNposic    	= 0
    LNinicio   	= 1
    LNnumpgt   	= 0
	LNdias	   	= 0
	LNserie	   	= 1
		
	DO WHILE .t.
        LNposic = AT("/",LSprazo, LNocorrenc)
        LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
******************************************************************
   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
			EXIT
		ENDIF
******************************************************************
		IF LNdias = 0 AND LNnumpgt > 0
	        LNnumpgt   = LNnumpgt
		ELSE			
	        LNnumpgt   = LNnumpgt + 1
		ENDIF
		LNocorrenc = LNocorrenc + 1
        LNinicio   = LNposic + 1
	ENDDO

	SET DECIMALS TO 6
	
	IF LNvlrent > 0 AND LNnumpgt > 1
	   CVSTR1    = STR((LNvlrfatura - LNvlrent) / (LNnumpgt - 1) ,25,11)
	   CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
	   LNdifere  = LNvlrfatura - (LNvlrdupl * (LNnumpgt - 1) + LNvlrent)
    ELSE
	   CVSTR1    = STR((LNvlrfatura) / (LNnumpgt) ,25,11)
	   CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
	   LNdifere  = LNvlrfatura - (LNvlrdupl * LNnumpgt)
	ENDIF

	**>>>>>

	m.empresa	= LNemp
	m.nota		= LNnronota						
	m.duplicata	= LNnronota
	m.cliente	= LNcliente
	m.dt_emi	= LDDtemi
	m.multa_prv	= LNmulta
	m.mora_prv	= LNmora
	m.bonus_prv	= LNbonus
	m.prem_pont	= LNPremPont
	m.vlr_fatura= LNvlrfatura
	m.vlr_pgto  =   0
	
	DO CASE
		CASE LNbanco = 898
			m.portador = 898
		CASE LNbanco >= 850 AND  LNbanco <= 857     &&CARTAO
			m.portador = LNbanco	
		OTHERWISE
			m.portador	= 0
	ENDCASE


    && A IDL NAO POSSUI CONTROLE DE FATURAMENTO COM INFORMACOES
    && SUFICIENTES PARA ORCAPGTO
		
	m.tp_parcela=  	3
	m.moeda 	=	3

	m.tp_cobranc= 01
	m.desconto  = 0
	m.regiao    = LNregiao
	m.natu      = LNnatureza
	m.nome      = LSnome
	m.tp_cobranc= 01 		  && COB. SIMPLES

	**>>>>>

	LNocorrenc = 1
    LNposic    = 0
    LNinicio   = 1
	LNdias		= 0

	DO WHILE .t.
        LNposic = AT("/",LSprazo, LNocorrenc)
        LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
		**************************************************

   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
			EXIT
		ENDIF

		**************************************************
		IF m.empresa <> 10
			m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  STR(m.empresa,1)))   && 1 => DUPLICATA
		else
			m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  "0"))   && 1 => DUPLICATA
		ENDIF
		IF LNvlrent > 0 AND LNnumpgt > 1
			m.vlr_doc 	 = LNvlrent
			LNvlrent = 0
		ELSE
			m.vlr_doc  = LNvlrdupl + LNdifere
			LNdifere   = 0
		ENDIF
		m.dt_venc  = m.dt_emi + LNdias
		m.dtproxproc  = m.dt_venc
		m.obs =""

		*---------------------------------------------------*		
		* 		EM COMPRAS A PRAZO COM A 1a DUPLICATA A
		* 	VISTA OU CONTA APRESENTACAO, ESTA 1a E
		* 	DIRECIONADA P/ A CARTEIRA E A DEMAIS
		* 	P/ O BANCO SOLICITADO. LNbanco GUARDO O
		* 	BANCO SOLICITADO P/ USO APOS GERAR A 1a
		*---------------------------------------------------*


		LNtmp  = m.dt_venc - m.dt_emi
	    if  LNtmp <= 7  AND LNbanco <> 900 AND LNbanco <> 898 ;
			 AND LNbanco <> 851 AND  LNbanco <> 852;
			 AND LNbanco <> 853 AND  LNbanco <> 854;
			 AND LNbanco <> 855 AND  LNbanco <> 856;
			 AND LNbanco <> 857 AND  LNbanco <> 858
	    						     && CONTA APRESENTACAO
			m.banco = 0			     && DIRECIONA P/ CARTEIRA
		ELSE
			m.banco = LNbanco   && DIRECIONA P/ BANCO SOLICITADO	
		ENDIF

		SELE  duplicat
		=edithand('SAVE')
		SELE orcament

		LNserie    = LNserie + 1
		LNocorrenc = LNocorrenc + 1
        LNinicio   = LNposic + 1
	ENDDO
	SET DECIMALS TO 2
	=UP_fecha("duplicat"  ,LFduplicata )
	=UP_fecha("empresa"   ,LFempresa   )
	=UP_fecha("orcamento" ,LForcamento )
	=UP_fecha("clienc" ,LFclienc )
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4H8           CRNroIDdupl VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:    9  º
*       º Variable:            CRNroIDdupl                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      332                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4h8     &&  CRNroIDdupl VALID
#REGION 10
RETURN
*---------------------------------------------------------------
*  CRNroIDdupl.....: Montar nro para ID duplicatas
*---------------------------------------------------------------
*  CLASSIFICACAO..: [******]
*---------------------------------------------------------------
*  OBJETIVO.......:
*--------------------------------------------------------------*
*   Permite obter o numero de Identificacao para duplicatas do
* sistema com  base na Empresa, Nota e Ordem da Diplicata(1,2..n)
*
*---------------------------------------------------------------
*  COMENTARIO.....:
*  Obs: Existe uma convencao em relacao a ordem das duplicatas
*   em funcao de caracteristicas de controle do sistema. Sendo?
*
*       LNordemDup             Sequencia de Controle
*     Nro. Ordem Logica   <---> Nro.Ordem Real
*      Duplicata 1        <--->      0
*      Duplicata 2        <--->      1
*      Duplicata 3        <--->      2
*      Duplicata 4        <--->      3
*
*---------------------------------------------------------------
*  TABELAS........: NOTA
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNNota     = Numero do NFs
*---------------------------------------------------------------
* RETORNO.........: Numero ID para Duplicata
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

FUNCTION CRNroIDdupl		&& USADA EM SCGC201, SCGCF201, SCGC201A
	
	PARAMETERS LNEmp,LNnota,LNordemDup
    PRIVATE LNduplicata
    PRIVATE LSalias
	LSalias = alias()
	=W_DEFPROC("rotinas.spr")

	*-----------------------------------------------------------*
*    IF LNordemDup < 1
*    	LNordemDup = 0
*    ELSE
*		LNordemDup = LNordemDup - 1
*	ENDIF
*	*-----------------------------------------------------------*
*	=W_DEFPROC("rotinas.spr")
*
*	IF LNemp <> 10
*		LNduplicata	= INT( VAL(   CHRTRAN(STR(LNnota,7)," ","0")+;
*								  CHRTRAN(STR(LNordemDup,1)," ","0")+;
*								  STR(LNemp,1)))   && 1 => DUPLICATA
*	else
*		LNduplicata	= INT( VAL(   CHRTRAN(STR(LNnota,7)," ","0")+;
*								  CHRTRAN(STR(LNordemDup,1)," ","0")+;
*								  "0"))   && 1 => DUPLICATA
*	ENDIF

	LNduplicata	= INT( VAL(   CHRTRAN(STR(LNnota,7)," ","0")+;
								  CHRTRAN(STR(LNordemDup,2)," ","0");
								  ))   && 1 => DUPLICATA


	*-----------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNduplicata)
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4H9           CRajustaVenc VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   10  º
*       º Variable:            CRajustaVenc                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      333                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4h9     &&  CRajustaVenc VALID
#REGION 10
RETURN
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......: Ajustar uma data (de Vencimento) evitando Sabados,
*				 Domingos e Feriados
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........:
*---------------------------------------------------------------
*  PARAMETROS.....:
*				LDdata			= Data a Ser Ajustada
*				LStipoajuste	= "+" Preferencia por Prorrogar data
*								= "-" Preferencia por Antecipar data
*---------------------------------------------------------------
* RETORNO.........: LDdata ajustada
*---------------------------------------------------------------
* CHAMADA EXEMPLO.:
*---------------------------------------------------------------

FUNCTION CRajustaVenc
	PARAMETERS LDdata, LStipoajuste
	=W_DEFPROC("rotinas.spr")
	
	DO While .t.
		IF DOW(LDdata) <> 1 AND DOW(LDdata) <> 7
			EXIT
		ENDIF
		IF LStipoajuste = "+"
			LDdata = LDdata + 1
		ELSE			
			LDdata = LDdata - 1
		ENDIF
	ENDDO
RETURN(LDdata)
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4HA           CRAlteraFatura VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   11  º
*       º Variable:            CRAlteraFatura                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      334                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4ha     &&  CRAlteraFatura VALID
#REGION 10
RETURN

FUNCTION  CRAlteraFatura
PARAMETERS PRemp,PRanteFatura,PRnovaFatura
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	EX:
	*				Quando um cupom e emitido as duplicatas
	*               levam como numero de fatura o nro do cupom.
	*				Porem, quando e feita uma NF copia do Cupom
	*				e necessario ajustar o nro da fatura para o
	*				numero da NF. COPIA DO CUPOM
	*
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNdup
	SELE duplicat
	SET ORDER TO TAG doc
	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
	LNdup	= PRanteFatura * 100		
	SET NEAR ON
	SEEK STR(PRemp,3)+STR(LNdup,9)
	SET NEAR OFF
	DO WHILE !EOF() AND PRanteFatura = duplicat.nota
		=REGLOCK(.T.)
		replace duplicat.nota with PRnovaFatura
		SKIP
	ENDDO
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4HB           CRcancdupl VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   12  º
*       º Variable:            CRcancdupl                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      335                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4hb     &&  CRcancdupl VALID
#REGION 10
RETURN

FUNCTION  CRcancdupl

PARAMETERS LNemp,LNnota
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNdup

	PRIVATE LSnota      && STRING COM NUMERO DA NOTA PARA COMPARACAO
	PRIVATE LSnotaDaDup && STRING COM NUMERO DA NOTA RETIRADO DO NUMERO
						&& DA DUPLICATA

	PRIVATE ARQ_CtrlRefn,ALS_CtrlRefn

    ARQ_CtrlRefn     = NetArqAgain("CtrlRefn")
    ALS_CtrlRefn     = Alias()

	SELE duplicat
	SET ORDER TO TAG doc
	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
	*  ALGORITIMO DE GERACAO DO NUMERO DE DUPLICATA - CRgeradupl
	*----------------------------------------------------------------*
	*
	*	IF LNemp <> 10
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  STR(m.empresa,1)))   && 1 => DUPLICATA
	*	else
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  "0"))   && 1 => DUPLICATA
	*	ENDIF
	*-------------------------------------------------------------------*


	LSnota  = STR(LNnota,7)

	LNdup	= LNnota * 100		
	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNdup,9)
	SET NEAR OFF
	DO WHILE !EOF() AND LSnota = LEFT( STR(duplicat.duplicata,9) ,7)
		SELE &ALS_CtrlRefn
		SET ORDER TO TAG duplicatas
		SEEK STR(LNemp,3)+STR(duplicat.duplicata,9)
		DO WHILE !EOF() ;
		    AND duplicat.empresa = &ALS_CtrlRefn .empresa ;
		    AND duplicat.duplicata = &ALS_CtrlRefn .duplicata
			=REGLOCK(.T.)
			=edithand('APAGA')
			SKIP
		ENDDO		
		SELE duplicat
		=REGLOCK(.T.)
		=edithand('APAGA')
		SKIP
	ENDDO
    =up_fecha("&ALS_CtrlRefn")
	SELE DUPLICAT	
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4IG           CRProcBaixa VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   13  º
*       º Variable:            CRProcBaixa                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      336                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4ig     &&  CRProcBaixa VALID
#REGION 10
RETURN

FUNCTION CRProcBaixa
	PARAMETERS LNemp,LNbanco,PrmCarteira,PrmVariacao,LNaviso,LDdtprocesso

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Processar Comandos de Carteira
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao processa os comandos de Carteira de
	*				cobranca para a empresa e aviso passado em
	*				parametro
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa de referencia do Aviso
	*		LNbanco .......: Banco de referencia do Aviso
	*       LNaviso........: Numero do Aviso
	*		LDdtprocesso...: Data para Lancamento do Processo
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o saldo da duplicata
	*------------------------------------------------------------*
	*  EXEMPLO.....: SCGC504  e SCGC008 , SCGC003A
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFmvretorn,LFbcretorn,LFduplicat

	LSalias = ALIAS()

	LFbcretorn		= NetArq("retornbc")
	LFmvretorn		= NetArq("retornmv")
	LFduplicat		= NetArq("duplicat")
	IF (LFmvretorn+LFbcretorn+LFduplicat) > 100000
		DO  FCHProcBaixa
		RETURN(.f.)
	ENDIF

	LNctrproc		= 0		&& CONTADOR DE INSTR. PROCESSADAS
	LNctrreje		= 0		&& CONTADOR DE INSTR. REJEITADAS
	LNctrdesc		= 0		&& CONTADOR DE INSTR. DESCARTADAS
	LFprocessa		= .f.	&& INDICA SE O REGISTRO FOI ACEITO NO PROCESSO
	m.dtprocesso 	= LDdtprocesso


	SELE retornbc
	SET ORDER TO TAG aviso
	SEEK STR(LNemp,3)+STR(LNbanco,3)+;
	   PrmCarteira+PrmVariacao+STR(LNaviso,8)
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Aviso : "+;
				STR(LNaviso,8)+" do Banco : "+ STR(LNbanco,3)
		DO  FCHProcBaixa
		RETURN(.F.)
	ENDIF

    IF empty(retornbc.dtaviso)
		DO OBJ_MENS.SPR WITH ;
			"    Data do Aviso Deve ser Preenchida "+;
				STR(LNaviso,8)+" do Banco : "+ STR(LNbanco,3)
		DO  FCHProcBaixa
		RETURN(.F.)
	ENDIF



	=REGLOCK(.T.)

	SELECT  retornmv
	SET ORDER TO TAG aviso
	SEEK STR(LNemp,3)+STR(LNbanco,3)+;
	     PrmCarteira+PrmVariacao+STR(LNaviso,8)
	DO WHILE  !EOF() AND ;
	    LNaviso = retornmv.aviso AND ;
		LNbanco = retornmv.banco AND ;
		PrmCarteira = retornmv.carteira AND ;
		PrmVariacao = retornmv.Variacao AND ;
		LNemp 	= retornmv.empresa
		
		
		IF retornmv.status $ "PR/RJ"     && EVITA PROCESSO REDUNDANTE
			IF retornmv.status $ "PR"
				LNctrproc = LNctrproc + 1
			ELSE
				LNctrreje = LNctrreje + 1
			ENDIF
			SELE retornmv
			SKIP
			LOOP
		ENDIF
		SELE duplicat
		SET ORDER TO TAG doc
		SEEK STR(LNemp,3)+STR(retornmv.duplicata,9)
		IF FOUND()
			=REGLOCK(.T.)
			SCATTER MEMVAR MEMO


			SELE retornmv
			=REGLOCK(.T.)

			************* TRATAMENTO DAS OCORRENCIAS ************
			* OBS: Melhor tratar ocorrencias por banco
			*      Consirerar para projeto novo
			*---------------------------------------------------*
			LFprocessa	=	.t.
		    m.efeito	 = 0		&&  NULO (indica efeto no Contas a Rec)

			=CRProcantigo()
			*DO CASE
			*	CASE LNbanco = 001
			*	   =CRProc001()
			*	CASE LNbanco = 237
			*	   =CRProc237()
			*	OTHERWISE
			*	   =CRProc237()
			*ENDCASE
			
			*---------------------------------------------------*
			* Motivos <> "00" => Justificativa para uma rejeicao
			*---------------------------------------------------*
			IF LEFT(retornmv.motivos,2) = "00" OR LFprocessa
				IF DATE() >= CTOD("12/09/00")
					IF retornmv.ocorrencia = 02
						m.dsp_cobr	= 	m.dsp_cobr + retornmv.dsp_cobr
					   ELSE
						m.out_desp	= 	m.out_desp + retornmv.out_desp + ;
								    retornmv.dsp_cobr
					ENDI
				   ELSE
						m.dsp_cobr	= 	m.dsp_cobr + retornmv.dsp_cobr
						m.out_desp	= 	m.out_desp + retornmv.out_desp
				ENDI
				m.iof  		= 	m.iof      + retornmv.iof
			ENDIF


			*---------------------------------------------------------*
			*  VERIFICACAO DA INTEGRIDATE VALORED DUPLICATA
			*---------------------------------------------------------*

			DO CASE
			
				CASE     duplicat.tp_cobranc = 06 ;
  			         AND retornmv.ocorrencia = 06
					*-----------------------------------------------*
					* Cobranca Vendor => Critica a serem implementadas
					*-----------------------------------------------*
					LFprocessa	=	LFprocessa  	

				CASE    retornmv.ocorrencia <> 81 ;
			        AND retornmv.ocorrencia <> 86 ;
			        AND retornmv.ocorrencia <> 50

					IF (;
						    (M.dt_pgto = {} ;
						           AND (M.vlr_pgto <> M.parc_pgto);
						    );
					    OR (;
							 (M.dt_pgto > {} ;
						   	AND abs(M.vlr_pgto - ;
						   	         (M.vlr_doc + M.mora + M.juros + ;
						   	             M.out_credt - M.devolucao - ;
						   	             M.abatimento - M.desconto   ;
  	      					   	     );
		      				   	   ) > 2;
					     	 );
			           	   );
		    	       )
	
						DO OBJ_MENS.SPR WITH ;
				   				" Verifique DUPLICATA : "+;
										STR(retornmv.duplicata,9)+CHR(13)+;
			   					"           BANCO     : "+;
			    						STR(LNbanco,3)+CHR(13)+;
			   					"           AVISO     : "+;
				   						STR(LNaviso,8)+CHR(13)+;
				   						+CHR(13)+CHR(13)+;
   				    		" VALORES INCONSISTENTES = > PROCESSO REJEITADO"

						LFprocessa	=	.F.  	&& rejeita processamento
					ENDIF
			ENDCASE

			
			SELE retornmv
*------------------------------------------------------------------*
***			IF LEFT(retornmv.motivos,2) = "00" OR LFprocessa
*------------------------------------------------------------------*
* condicao mudada pq almir disse q o sistema nao estava rejeitando
* qdo havia baixa duplicada
*alterada em 15/2/13
*------------------------------------------------------------------*
			IF LFprocessa

				SELE duplicat
				=edithand('REGRAVA')
				SELE retornmv
				REPLACE tp_cobranc WITH m.tp_cobranc
				REPLACE dtprocesso WITH m.dtprocesso
				REPLACE efeito 	   WITH m.efeito
  				REPLACE status 	   WITH "PR"  && PROCESSADO
				LNctrproc = LNctrproc + 1
			ELSE
				REPLACE tp_cobranc WITH m.tp_cobranc
  				REPLACE status 	   WITH "RJ"  && PROCESSADO
				LNctrreje = LNctrreje + 1
			ENDIF
			***************************
			SET FIELDS TO dtregis, hregis, usrregis,deletado
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
			***************************
		ELSE
			LNctrdesc = LNctrdesc + 1
		ENDIF
		*------------------------------------------------------*
		*  Registrar Movimento para sistema de Caixa
		*------------------------------------------------------*
		=CRRgAvisoCaixa(retornmv.Empresa,retornmv.Banco,;
		        retornmv.carteira,retornmv.variacao,;
				retornmv.Aviso,retornmv.Duplicata, retornmv.Ocorrencia)
		*------------------------------------------------------*
		SELE retornmv
		SKIP
	ENDDO
	SELE retornbc
	REPLACE status 	   WITH "PR"  && PROCESSADO
	REPLACE reg_proces WITH LNctrproc
	REPLACE reg_descar WITH LNctrdesc
	REPLACE reg_rejeit WITH LNctrreje
	REPLACE dtprocesso WITH m.dtprocesso	
	***************************
	SET FIELDS TO dtregis, hregis, usrregis,deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	***************************
	DO  FCHProcBaixa
	UNLOCK
RETURN(.T.)

PROCEDURE FCHProcBaixa
	=UP_fecha("retornmv" ,LFmvretorn)
	=UP_fecha("retornbc" ,LFbcretorn)
	=UP_fecha("duplicat" ,LFduplicat)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4IV           CRCancProcBaixa VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   14  º
*       º Variable:            CRCancProcBaixa                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      337                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4iv     &&  CRCancProcBaixa VALID
#REGION 10
RETURN

FUNCTION CRCancProcBaixa
	PARAMETERS LNemp,LNbanco,PrmCarteira,PrmVariacao,LNaviso

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Cancelar Processamento de Comandos de Carteira
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa de referencia do Aviso
	*		LNbanco .......: Banco de referencia do Aviso
	*       LNaviso........: Numero do Aviso
	*------------------------------------------------------------*
	*  RETORNO.....:    Retorna o saldo da duplicata
	*------------------------------------------------------------*
	*  EXEMPLO.....: SCGC504  e SCGC008 , SCGC003A
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFmvretorn,LFbcretorn,LFduplicat

	LSalias = ALIAS()

	LFbcretorn		= NetArq("retornbc")
	LFmvretorn		= NetArq("retornmv")
	LFduplicat		= NetArq("duplicat")
	IF (LFmvretorn+LFbcretorn+LFduplicat) > 100000
		DO  FCHCancProcBaixa
		RETURN(.f.)
	ENDIF

	LNctrproc		= 0		&& CONTADOR DE INSTR. PROCESSADAS
	LNctrreje		= 0		&& CONTADOR DE INSTR. REJEITADAS
	LNctrdesc		= 0		&& CONTADOR DE INSTR. DESCARTADAS
	LFprocessa		= .f.	&& INDICA SE O REGISTRO FOI ACEITO NO PROCESSO


	SELE retornbc
	SET ORDER TO TAG aviso
	SEEK STR(LNemp,3)+STR(LNbanco,3)+;
	     PrmCarteira+PrmVariacao+STR(LNaviso,8)
	IF !FOUND()
		DO OBJ_MENS.SPR WITH "    Nao Foi Possivel Localizar Aviso : "+;
				STR(LNaviso,8)+" do Banco : "+ STR(LNbanco,3)
		DO  FCHCancProcBaixa
		RETURN(.F.)
	ENDIF

	=REGLOCK(.T.)

	SELECT  retornmv
	SET ORDER TO TAG aviso
	SEEK STR(LNemp,3)+STR(LNbanco,3)+;
	     PrmCarteira+PrmVariacao+STR(LNaviso,8)
	DO WHILE !EOF() AND ;
	    LNaviso = retornmv.aviso AND ;
		LNbanco = retornmv.banco AND ;
		PrmCarteira = retornmv.carteira AND ;
		PrmVariacao = retornmv.variacao AND ;
		LNemp 	= retornmv.empresa
		
		IF retornmv.status $ "AP"     && EVITA PROCESSO REDUNDANTE
			SELE retornmv
			SKIP
			LOOP
		ENDIF
		SELE duplicat
		SET ORDER TO TAG doc
		SEEK STR(LNemp,3)+STR(retornmv.duplicata,9)
		IF FOUND()
			=REGLOCK(.T.)
			SCATTER MEMVAR MEMO
			SELE retornmv
			=REGLOCK(.T.)
			LFprocessa	=	.t.

 		    m.efeito	 = 0		&&  NULO (indica efeto no Contas a Rec)

			IF DATE() >= CTOD("12/09/00")
				IF retornmv.ocorrencia = 02
					m.dsp_cobr	= 	m.dsp_cobr - retornmv.dsp_cobr
				   ELSE
					m.out_desp	= 	m.out_desp - retornmv.out_desp - ;
								    retornmv.dsp_cobr
				ENDI
			   ELSE
				m.dsp_cobr	= 	m.dsp_cobr - retornmv.dsp_cobr
				m.out_desp	= 	m.out_desp - retornmv.out_desp
			ENDI
			m.iof  		= 	m.iof      - retornmv.iof

					   && processa ocor 02/06/07/09/10/12/13/14/17/19/
					  && 		  20/23/27/28/34/80/81/82/83/84/85/86
				      &&   E  03/24/27/30/32/   && REJEICOES

			DO CASE
				CASE retornmv.status $ "RJ"  && ANULA PROCERSSO
						LFprocessa	=	.F.
				CASE retornmv.ocorrencia = 02
					 if duplicat.moeda = 3 ;
					    AND m.ConfNroBco  = .f. ;
					    AND m.efeito <> 1
									&& SO DOCUMENTOS EM :
									&&     MOEDA =(3-DUPLICATA)
									&&  ( E  )
									&& QUE NAO TENHAM CONFIRMADA ENTRDA BCO
									&&    (ConfNroBco  = .T.)
									&&  ( E  )
									&& QUE NAO SEJAM REG DE FATURAMENTO
									&&    (EFEITO = 1)
                                    &&
									&& PODEM RETORNAR AO PORTADOR CARTEIRA
						 m.portador  = 0
   					     m.ConfNroBco  = .f.
					 ENDIF
					 m.agencia   = retornmv.agenc_cobr



				CASE duplicat.tp_cobranc = 06  AND ;
  					 retornmv.ocorrencia = 06
					 *----------------------------------------------*
					 *=> Pagamento de titulo VENDOR
					 *----------------------------------------------*

		  		     m.efeito	 = 2		  &&  PGTO TOTAL
					*******************   CRITICA *******************
					 IF EMPTY(m.dt_pgto)  && PROCESSO NAO INDICADO
						LFprocessa	=	.F.
					 ELSE
						 STORE 0 TO  juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto
						 m.vlr_pgto = m.vlr_pgto - duplicat.vlr_doc
						 m.dtocorrenc= CTOD(" .  .  ")
						 m.dt_pgto   = CTOD(" .  .  ")
						 m.dt_baixa  = CTOD(" .  .  ")
					 ENDIF


				CASE retornmv.ocorrencia = 06  OR ;
  					 retornmv.ocorrencia = 15  OR ;
  					 retornmv.ocorrencia = 83  OR ;
  					 retornmv.ocorrencia = 17  && LIQUIDACAO DO TITULO
		  		     m.efeito	 = 2		  &&  PGTO TOTAL
					*******************   CRITICA *******************
					 IF EMPTY(m.dt_pgto)  && PROCESSO NAO INDICADO
						LFprocessa	=	.F.
					 ELSE
						 STORE 0 TO  juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto
						 m.vlr_pgto = m.vlr_pgto - retornmv.vlr_pgto
						 m.dtocorrenc= CTOD(" .  .  ")
						 m.dt_pgto   = CTOD(" .  .  ")
						 m.dt_baixa  = CTOD(" .  .  ")
					 ENDIF
				CASE retornmv.ocorrencia = 07  && ESPECIFICO DO BFB
					*					LIQUIDACAO PARCIAL
		  		     m.efeito	 = 3		&&  PGTO PARCIAL
					 STORE 0 TO  juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto
					 m.vlr_pgto = m.vlr_pgto - retornmv.vlr_pgto
					 m.parc_pgto = m.parc_pgto - retornmv.vlr_pgto
					 m.dtocorrenc= CTOD(" .  .  ")
				CASE retornmv.ocorrencia = 09 OR ;
					 retornmv.ocorrencia = 10 && BAIXADOS
					 if duplicat.moeda <> 4 AND duplicat.moeda <> 5
									&& CARTAO E CHQ. ELETR NAO MUDA
					 				&& PORTADOR 4/5
						 m.portador	= retornbc.banco
					 ENDIF
					 m.agencia  = retornmv.agenc_cobr
				CASE retornmv.ocorrencia = 12 && ABATIMENTO CONCEDIDO
					m.abatimento= 	0
				CASE retornmv.ocorrencia = 13 && ABATIMENTO CANCELADO
					m.abatimento= 	retornmv.abatimento
				CASE retornmv.ocorrencia = 14 && VENCIMENTO ALTERADO
					m.dt_venc	=	retornmv.vencimento
				CASE retornmv.ocorrencia = 19 && INSTR. PROTESTO CONFIRMADO
					m.trf_cart 	=  	""
				CASE retornmv.ocorrencia = 20 && INSTR. PROTESTO CANCELADA
					m.trf_cart 	=  	""
				CASE retornmv.ocorrencia = 23 && ENTRADA CARTORIO
					m.tp_cobranc=   01    && COBRANCA EM CARTORIO
					m.trf_cart 	=  	retornmv.trf_cart
				CASE retornmv.ocorrencia = 34 && ENTRADA CARTORIO
					m.tp_cobranc=   88    && COBRANCA SIMPLES
					m.trf_cart 	=  	retornmv.trf_cart

				******** INSTRUCOES DE CARTEIRA

				CASE retornmv.ocorrencia = 85 && ALTERCACAO DE VLR DE DUPL.

					 m.vlr_doc =  retornmv.vlr_dup

				CASE   retornmv.ocorrencia = 80 ;
				    OR retornmv.ocorrencia = 84 ;
				    OR retornmv.ocorrencia = 50
			 		 m.efeito	 = 4		&&  DEVOLUCAO
					*******************   CRITICA *******************
					 && 80 = LIQUID. POR DEVOL.
					 && 50 = LIQUID. POR DEVOL. cancelamento contrato
					
					 IF retornmv.ocorrencia = 80 or retornmv.ocorrencia = 50

						*******************   CRITICA *******************

						 IF EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
							LFprocessa	=	.F.
						 ELSE
							 STORE 0 TO juros, iof,abatimento, desconto, ;
									mora, out_credt, form_pgto
							 m.dtocorrenc= CTOD(" .  .  ")
							 m.devolucao = m.devolucao - retornmv.vlr_pgto
							 m.dt_pgto  = CTOD(" .  .  ")
							 m.dt_baixa = CTOD(" .  .  ")
						 ENDIF
					 ELSE
							 m.devolucao = m.devolucao - retornmv.vlr_pgto
					 ENDIF
				&& 81 DUPLICATA INCOBRAVEL
				&& 86 SALDO DE DUPLICATA IMCOBRAVEL
				CASE retornmv.ocorrencia = 81  OR ;
  					 retornmv.ocorrencia = 86
			 		 m.efeito	 = 5		&&  INCOBRAVEL
					*******************   CRITICA *******************
					 IF EMPTY(m.dt_pgto)  && PROCESSO NAO INDICADO
						LFprocessa	=	.F.
					 ELSE
	 				 	 m.tp_cobranc=   1    && INCOBRAVEL
						 m.dt_pgto  = CTOD(" .  .  ")
						 m.dt_baixa = CTOD(" .  .  ")
						 m.status = "I"
					ENDIF
				CASE retornmv.ocorrencia = 82  && ALTERA DIRECIONA. COBRANCA
			 		 * m.banco      =  0
					 m.agencia    = retornmv.agenc_cobr
				OTHERWISE   && 03/24/27/30/32/   && REJEICOES
					LFprocessa	=	.F.
			ENDCASE			
			SELE duplicat
			=edithand('REGRAVA')
	 		* m.banco      =  retornmv.banco  &&

			*------------------------------------------------------*
			*  Registrar Movimento para sistema de Caixa
			*------------------------------------------------------*
			=CRCnAvisoCaixa(retornmv.Empresa,retornmv.Banco,;
		        retornmv.carteira,retornmv.variacao,;
				retornmv.Aviso,retornmv.Duplicata, retornmv.Ocorrencia)
			*-----------------------------------------------------*

			SELE retornmv
			REPLACE dtprocesso WITH CTOD(" .  .  ")
			REPLACE efeito 	   WITH m.efeito
			REPLACE status 	   WITH "AP"  && AGUARDA PROCESSO
			***************************
			SET FIELDS TO dtregis, hregis, usrregis,deletado
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
			***************************
		ENDIF
		SELE retornmv
		SKIP
	ENDDO
	SELE retornbc
	REPLACE status 	   WITH "AP"  && AGUARDA PROCESSADO
	REPLACE reg_proces WITH 0
	REPLACE reg_descar WITH 0
	REPLACE reg_rejeit WITH 0
	REPLACE dtprocesso WITH CTOD(" .  .  ")
	***************************
	SET FIELDS TO dtregis, hregis, usrregis,deletado
	=edithand('REGRAVA')
	CLEAR FIELDS
	SET FIELDS OFF
	***************************
	DO  FCHCancProcBaixa
	UNLOCK
RETURN(.T.)

PROCEDURE FCHCancProcBaixa
	=UP_fecha("retornmv" ,LFmvretorn)
	=UP_fecha("retornbc" ,LFbcretorn)
	=UP_fecha("duplicat" ,LFduplicat)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4IW           CRRgAvisoCaixa VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   15  º
*       º Variable:            CRRgAvisoCaixa                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      338                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4iw     &&  CRRgAvisoCaixa VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CRRgAvisoCaixa
  PARAMETER PrmEmpresa,PrmBanco,;
                  PrmCarteira,PrmVariacao,;
                  PrmAviso,PrmDuplicata, PrmOcorrencia
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Lancamento
	*              no Sistema de Caixa
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*      Qdo PrmBanco = 993 (Caixa ) o registro para caixa
	*   ja foi gerado no proprio faturamento nao podendo gerar
	*   novo registro quando a carteira registrar a baixa das
	*   ENTRADAS
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias

	PRIVATE ARQ_Retornmv,ALS_Retornmv
    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_LancaCx,ALS_LancaCx

    LSAlias      = Alias()


	IF PrmBanco = 993     && Entradas em Caixa
		RETURN(.T.)	
	endif

    ARQ_Retornmv = NetArqAgain("RETORNMV")
    ALS_Retornmv     = Alias()

    ARQ_Duplicat = NetArqAgain("DUPLICAT")
    ALS_Duplicat = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()


	* Captar Saldo Inicial do Mes

    SELE &ALS_Retornmv
  	SET ORDER TO TAG lancamento
    SEEK STR(PrmEmpresa,3)+STR(PrmBanco,3)+PrmCarteira+PrmVariacao+;
            STR(PrmAviso,8)+STR(PrmDuplicata,9)+STR(PrmOcorrencia,2)

	IF !FOUND()
	    =up_fecha("&ALS_Retornmv")
    	=up_fecha("&ALS_Duplicat")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	IF  &ALS_Retornmv .status = "RJ"
	    =up_fecha("&ALS_Retornmv")
    	=up_fecha("&ALS_Duplicat")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.T.)
	ENDIF

    SELE &ALS_Duplicat
  	SET ORDER TO TAG doc
    SEEK STR(PrmEmpresa,3)+STR(PrmDuplicata,9)

	IF !FOUND()
	    =up_fecha("&ALS_Retornmv")
    	=up_fecha("&ALS_Duplicat")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF



	DO CASE
		CASE &ALS_Retornmv .ocorrencia = 06  OR ;
				 &ALS_Retornmv .ocorrencia = 15  OR ;
				 &ALS_Retornmv .ocorrencia = 83  OR ;
				 &ALS_Retornmv .ocorrencia = 81  OR ;
				 &ALS_Retornmv .ocorrencia = 86  OR ;
				 &ALS_Retornmv .ocorrencia = 17  && LIQUIDACAO DO TITULO
	  		     m.efeito	 = 2		  &&  PGTO TOTAL
				*******************   CRITICA *******************
		CASE &ALS_Retornmv .ocorrencia = 07  && ESPECIFICO DO BFB
				*					LIQUIDACAO PARCIAL
	  		     m.efeito	 = 3		&&  PGTO PARCIAL
 		CASE retornmv.ocorrencia = 80 OR retornmv.ocorrencia = 84
				&& LIQ. POR DEVOLUCAO // DEVOL. PARCIAL
		 		 m.efeito	 = 4		&&  DEVOLUCAO

		OTHERWISE
		    =up_fecha("&ALS_Retornmv")
    		=up_fecha("&ALS_Duplicat")
    		=up_fecha("&ALS_LancaCx")
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
	        RETURN(.F.)
	ENDCASE


    m.EMPRESA 	= PrmEmpresa
    m.TIPO_DOC  = 2            && Codigo Tabela Padrao para DUPLICATA
    m.NUM_DOC   = STR(PrmDuplicata,15)


    m.PORTADOR  = PrmBanco
	m.NOME      = &ALS_Duplicat .nome
    m.data      = &ALS_Retornmv .dtprocesso
    m.valor     = &ALS_Retornmv .vlr_pgto - ;
                     ( &ALS_Retornmv .juros + &ALS_Retornmv .mora ) ;
                     + &ALS_Retornmv .desconto
    m.JUROS     = &ALS_Retornmv .juros + &ALS_Retornmv .mora
    m.DESCONTOS = &ALS_Retornmv .desconto
    m.PROCESSADO   = "N"
    m.OPERACAO     = "LANCAR"
    m.LOG_LANCA    = "Lanc. Aut.Rec.Carteira."

    sele &ALS_LancaCx
	SET ORDER TO TAG chave_pk
	SEEK 	STR(M.EMPRESA,3)+STR(M.TIPO_DOC,3)+M.NUM_DOC
	IF !FOUND()
	    =edithand('SAVE')
	ELSE
	    =edithand('REGRAVA')
	ENDIF
	*---------------------------------------------------------------*
    =up_fecha("&ALS_Retornmv")
    =up_fecha("&ALS_Duplicat")
   	=up_fecha("&ALS_LancaCx")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4IX           CRCnAvisoCaixa VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   16  º
*       º Variable:            CRCnAvisoCaixa                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      339                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4ix     &&  CRCnAvisoCaixa VALID
#REGION 10
return
*---------------------------------------------------------------*

FUNCTION CRCnAvisoCaixa
  PARAMETER PrmEmpresa,PrmBanco,PrmCarteira,PrmVariacao,;
           PrmAviso,PrmDuplicata, PrmOcorrencia
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Criar Registro de Controle para Cancelar
	*			Lancamento no Sistema de Caixa
	*------------------------------------------------------------*
	* COMENTARIO..: 	
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
    PRIVATE LFretorno
    PRIVATE LSalias

    PRIVATE ARQ_Retornmv,ALS_Retornmv
    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_LancaCx,ALS_LancaCx

    LSAlias      = Alias()

	IF PrmBanco = 993     && Entradas em Caixa
		RETURN(.T.)	
	endif


    ARQ_Retornmv = NetArqAgain("RETORNMV")
    ALS_Retornmv     = Alias()

    ARQ_Duplicat = NetArqAgain("DUPLICAT")
    ALS_Duplicat = Alias()

    ARQ_LancaCx  = NetArqAgain("LANCACX")
    ALS_LancaCx  = Alias()


	* Captar Saldo Inicial do Mes

    SELE &ALS_Retornmv
  	SET ORDER TO TAG lancamento
    SEEK STR(PrmEmpresa,3)+STR(PrmBanco,3)+;
         PrmCarteira+PrmVariacao+;
          STR(PrmAviso,8)+STR(PrmDuplicata,9)+STR(PrmOcorrencia,2)

	IF !FOUND()
	    =up_fecha("&ALS_Retornmv")
    	=up_fecha("&ALS_Duplicat")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	IF  &ALS_Retornmv .status = "RJ"
	    =up_fecha("&ALS_Retornmv")
    	=up_fecha("&ALS_Duplicat")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.T.)
	ENDIF

    SELE &ALS_Duplicat
  	SET ORDER TO TAG doc
    SEEK STR(PrmEmpresa,3)+STR(PrmDuplicata,9)

	IF !FOUND()
	    =up_fecha("&ALS_Retornmv")
    	=up_fecha("&ALS_Duplicat")
    	=up_fecha("&ALS_LancaCx")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(.F.)
	ENDIF

	DO CASE
		CASE &ALS_Retornmv .ocorrencia = 06  OR ;
				 &ALS_Retornmv .ocorrencia = 15  OR ;
				 &ALS_Retornmv .ocorrencia = 83  OR ;
				 &ALS_Retornmv .ocorrencia = 81  OR ;
				 &ALS_Retornmv .ocorrencia = 86  OR ;
				 &ALS_Retornmv .ocorrencia = 17  && LIQUIDACAO DO TITULO
	  		     m.efeito	 = 2		  &&  PGTO TOTAL
				*******************   CRITICA *******************
		CASE &ALS_Retornmv .ocorrencia = 07  && ESPECIFICO DO BFB
				*					LIQUIDACAO PARCIAL
	  		     m.efeito	 = 3		&&  PGTO PARCIAL
		OTHERWISE
		    =up_fecha("&ALS_Retornmv")
    		=up_fecha("&ALS_Duplicat")
    		=up_fecha("&ALS_LancaCx")
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
	        RETURN(.F.)
	ENDCASE


    m.EMPRESA 	= PrmEmpresa
    m.TIPO_DOC  = 2            && Codigo Tabela Padrao para DUPLICATA
    m.NUM_DOC   = STR(PrmDuplicata,15)


    m.PORTADOR  = PrmBanco
	m.NOME      = &ALS_Duplicat .nome
    m.data      = &ALS_Retornmv .dtprocesso
    m.valor     = &ALS_Retornmv .vlr_pgto - ;
                     ( &ALS_Retornmv .juros + &ALS_Retornmv .mora ) ;
                     + &ALS_Retornmv .desconto
    m.JUROS     = &ALS_Retornmv .juros + &ALS_Retornmv .mora

    m.DESCONTOS = &ALS_Retornmv .desconto
    m.PROCESSADO   = "N"
    m.OPERACAO     = "CANCELAR"
    m.LOG_LANCA    = "** Cancel. Lanc. Aut.Rec.Carteira."

    sele &ALS_LancaCx
	SET ORDER TO TAG chave_pk
	SEEK 	STR(M.EMPRESA,3)+STR(M.TIPO_DOC,3)+M.NUM_DOC
	IF FOUND()
	    =edithand('APAGA')
	ENDIF
	*---------------------------------------------------------------*
    =up_fecha("&ALS_Retornmv")
    =up_fecha("&ALS_Duplicat")
   	=up_fecha("&ALS_LancaCx")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(.t.)
	






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4JW           CRRefinanciamento VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   17  º
*       º Variable:            CRRefinanciamento                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      340                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4jw     &&  CRRefinanciamento VALID
#REGION 10
RETURN

******************************************************************
*   O CRRefinanciamento - Refinanciamento  simples de uma Duplicata
* permite a alteracao do valor de uma duplicata para menor sondo
* o residuo refinanciado em uma nova duplicata
******************************************************************


FUNCTION  CRRefinanciamento

PARAMETERS LNemp, LNdup, LNNovo_Valor,LNAntigo_Valor
	=W_DEFPROC("rotinas.spr")

	*------------------------------------------*


	PRIVATE LNnvSequencia
	PRIVATE LNnfGeradora  && NF ou Cupom Geradora das Duplicatas
						  && esta contida no numero da duplicata
						  && sendo que qdo e emitida copia do cupom
						  && o campo nota da duplicata e alterado
						  && para o numero do nf copia do cupom
						  && entao o nf geradora incicial fica
						  && domento nas 7 primeiras posicoes
						  && do numero da duplicata
	PRIVATE LSmsg
    PRIVATE ARQ_CtrlRefn,ALS_CtrlRefn
    PRIVATE ARQ_Duplicat,ALS_Duplicat

    LSAlias      = Alias()

    ARQ_CtrlRefn     = NetArqAgain("CtrlRefn")
    ALS_CtrlRefn     = Alias()

    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()

	
	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(LNemp,3)+STR(LNdup,9)
	IF !FOUND()
		LSmsg = "Nao foi possivel realizar refinanciamento. " +;
				"Doc. "+STR(LNdup,9)+" Nao localizado. "
		=fox_alert(LSmsg,.t.)

	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)

	ENDIF
	IF &ALS_Duplicat .vlr_doc <= LNNovo_Valor
		LSmsg = "Nao foi possivel realizar refinanciamento. " +;
				"Novo Valor Deve ser Menor que o Valor Atual da Dupl"
		=fox_alert(LSmsg,.t.)

	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	IF &ALS_Duplicat .vlr_doc <> LNAntigo_Valor
		LSmsg = "Nao foi possivel realizar refinanciamento. " +;
				"Valor da Dupl Nao Corresponde ao Informado"
		=fox_alert(LSmsg,.t.)

	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF



	IF not empty ( &ALS_Duplicat .dt_pgto)
		LSmsg = "Nao se refinancia Duplicata Paga."
		=fox_alert(LSmsg,.t.)

	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*------------------------------------------------------------------*
	wp_msg = "Confirma Solicitacao de Reparcelamento  "
	IF !fox_alert(wp_msg)
	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	wp_msg = "Voce esta reparcelando a Dup.:"+;
	           str( &ALS_Duplicat .duplicata,9 )+"-"+;
	           &ALS_Duplicat .nome +"- de "+;
	           STR( &ALS_Duplicat .vlr_doc,12,2)+" Para "+;
	           STR( LNNovo_Valor,12,2)

	IF !fox_alert(wp_msg)
	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	LNusuario = nUsr
	BTMP   =  'usuario.usuario = LNusuario '
	LNusr_ret = 0

	DO obj_prmt.SPR WITH   wp_msg , Btmp

	IF LNusr_ret =  0
	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	*------------------------------------------------------------------*
	SCATTER MEMVAR
**	LNAntigo_Valor = &ALS_Duplicat .vlr_doc
	*------------------------------------------------------------------*
	LNnfGeradora = int(val(LEFT(str(LNdup,9),7)))


	=W_DEFPROC("duplicat.spr")

 	LNnvSequencia  =  CRUltSeqdupl(LNemp, LNnfGeradora )
    LNnvSequencia  = LNnvSequencia + 2

	=W_DEFPROC("duplicat.spr")
	LNnovadup  = CRNroIDdupl(LNemp, LNnfGeradora ,LNnvSequencia)


	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(LNemp,3)+STR(LNnovadup,9)
	IF FOUND()
		LSmsg = "Nao foi possivel realizar refinanciamento. " +;
				"Todas sequencias 0-9 ocupadas."
		=fox_alert(LSmsg,.t.)

	    =up_fecha("&ALS_CtrlRefn")
	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	*--------------------------------------------------------------*
	*    PERSISTENCIA
	*--------------------------------------------------------------*
	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(LNemp,3)+STR(LNdup,9)

	=RLOCK()

    REPLACE obs WITH  "Dupl.reparcelada gerando Dupl:"+STR(LNnovadup,9)
	REPLACE vlr_doc with LNNovo_Valor
    REPLACE dtregis with date()

	m.duplicata = LNnovadup
	m.vlr_doc   = LNAntigo_Valor - LNNovo_Valor

	m.num_no_bco = ""
	m.banco     = 0
	m.portador  = 0
	m.out_desp  = 0
	m.dsp_cobr  = 0
	m.IOF       = 0
	m.devolucao = 0
	m.mora      = 0
	m.juros     = 0
	m.out_credt = 0
	m.abatimento= 0
	m.desconto  = 0
	m.parc_pgto = 0
	m.vlr_pgto  = 0
    m.flg_refin = .t.
    m.obs = "duplicata original reparcelada = "+ STR(LNdup,9)
	=edithand("SAVE")

    m.flg_refin = .f.
    m.obs = ""
	IF !("CENTRAL" $ UPPER(DBF()))
		select &ALS_CtrlRefn
	    m.empresa    = LNemp
	    m.data       = wp_dtoper
	    m.duplicata  = LNdup
		m.dupnova	 = LNnovadup
		m.antg_valor = LNAntigo_Valor
		m.novo_valor = LNNovo_Valor
		m.status     = "PR"
		=edithand("SAVE")
	ENDIF
	*------------------------------------------------------------------*
    =up_fecha("&ALS_CtrlRefn")
    =up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	LSmsg = "Refinanciamento Realizado com Sucesso."
	=fox_alert(LSmsg,.t.)

RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4KA           CRUltSeqdupl VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   18  º
*       º Variable:            CRUltSeqdupl                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      341                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4ka     &&  CRUltSeqdupl VALID
#REGION 10
RETURN

******************************************************************
*   Em casos de refinanciamento uma nova duplicata sera gerado
* e o numero de sequencia sera incrementado sendo necessario buscar
* a ultima sequencia gerada
******************************************************************


FUNCTION  CRUltSeqdupl

PARAMETERS LNemp,LNnota
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNseqDuplicat
	PRIVATE LNduplicata

    PRIVATE ARQ_Duplicat,ALS_Duplicat

    LSAlias      = Alias()

    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()


	SELE &ALS_Duplicat
	SET ORDER TO TAG doc

	=W_DEFPROC("duplicat.spr")

	LNduplicata = CRNroIDdupl(LNemp,LNnota,0)
	
	LNseqDuplicat = 0

	SET NEAR ON
	SEEK STR(LNemp,3)+STR(LNduplicata,9)
	SET NEAR OFF
	
	DO WHILE !EOF() AND ;
	       LNnota = INT(VAL(LEFT( STR( &ALS_Duplicat .duplicata,9) ,7)))
		LNseqDuplicat = ;
		   int(val(LEFT(RIGHT(str( &ALS_Duplicat .duplicata ),2),2)))
		SKIP
	ENDDO
    =up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNseqDuplicat)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4KB           CRChkp_FilDupl VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   19  º
*       º Variable:            CRChkp_FilDupl                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      342                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4kb     &&  CRChkp_FilDupl VALID
#REGION 10
RETURN

PROCEDURE  CRChkp_FilDupl

PARAMETERS LNemp, LDdt_emi

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE  ARQ_Duplicat, ALS_Duplicat, alias_ant

	ALIAS_ANT = ALIAS()


    ARQ_Duplicat  = NetArqAgain("DUPLICAT")
    ALS_Duplicat  = Alias()

	SELE &ALS_Duplicat
	SET ORDER TO TAG emissao
	*----------------------------------------------------------------*


	SELECT empresa,duplicata,dt_emi,dt_pgto,vlr_doc,vlr_pgto,;
	       ((vlr_pgto - (vlr_doc + mora + juros + out_credt ;
	      				- devolucao - abatimento - desconto))) as DIFERENCA,;
    	    mora,juros,out_credt, ;
       		devolucao,abatimento , desconto, nome ;
		FROM  &ALS_Duplicat ;
		WHERE  ;
				   dt_emi >= LDdt_emi AND empresa = LNemp ;
		       AND ;
		       (;
				    (dt_pgto = {} ;
				       AND (vlr_pgto <> parc_pgto);
				    );
			    OR (;
					 (dt_pgto > {} ;
					   AND abs(vlr_pgto - (vlr_doc + mora + juros + out_credt ;
	      				- devolucao - abatimento - desconto)) > 2;
				     );
		           );
		        );
		 ORDER BY empresa, dt_emi;
		INTO CURSOR DPL_BUG

	*----------------------------------------------------------------*
    SELE &ALS_Duplicat
	SET ORDER TO TAG DOC


	SELECT DPL_BUG
	GO TOP
	DO WHILE !EOF()
	    SELE &ALS_Duplicat
		SEEK STR(DPL_BUG.EMPRESA,3)+STR(DPL_BUG.DUPLICATA,9)
		IF FOUND()
			SET PROCEDURE TO DUPLICAT.SPR
			m.pago = CRobtvlrpg(DPL_BUG.EMPRESA,DPL_BUG.DUPLICATA)

		    SELE &ALS_Duplicat
			=rlock()
			REPLACE vlr_pgto WITH m.pago
		ENDIF		
		SELE DPL_BUG
		SKIP
	ENDDO

    =up_fecha("DPL_BUG")
    =up_fecha("&ALS_Duplicat")
    IF USED(ALIAS_ANT)
		SELE 	&ALIAS_ANT
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4KC           CRChkp_AllDupl VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   20  º
*       º Variable:            CRChkp_AllDupl                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      343                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4kc     &&  CRChkp_AllDupl VALID
#REGION 10
RETURN

PROCEDURE  CRChkp_AllDupl

PARAMETERS LDdt_emi

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE  ARQ_Duplicat, ALS_Duplicat, alias_ant

	ALIAS_ANT = ALIAS()


    ARQ_Duplicat  = NetArqAgain("DUPLICAT")
    ALS_Duplicat  = Alias()

	SELE &ALS_Duplicat
	SET ORDER TO TAG emissao
	*----------------------------------------------------------------*


	SELECT empresa,duplicata,dt_emi,dt_pgto,vlr_doc,vlr_pgto,;
	       ((vlr_pgto - (vlr_doc + mora + juros + out_credt ;
	      				- devolucao - abatimento - desconto))) as DIFERENCA,;
    	    mora,juros,out_credt, ;
       		devolucao,abatimento , desconto, nome ;
		FROM  &ALS_Duplicat ;
		WHERE  ;
			   dt_emi >= LDdt_emi;
		       AND ;
		       (;
				    (dt_pgto = {} ;
				       AND (vlr_pgto <> parc_pgto);
				    );
			    OR (;
					 (dt_pgto > {} ;
					   AND abs(vlr_pgto - (vlr_doc + mora + juros + out_credt ;
	      				- devolucao - abatimento - desconto)) > 2;
				     );
		           );
		        );
		 ORDER BY empresa, dt_emi;
		INTO CURSOR DPL_BUG

	*----------------------------------------------------------------*
    SELE &ALS_Duplicat
	SET ORDER TO TAG DOC


	SELECT DPL_BUG
	GO TOP
	DO WHILE !EOF()
	    SELE &ALS_Duplicat
		SEEK STR(DPL_BUG.EMPRESA,3)+STR(DPL_BUG.DUPLICATA,9)
		IF FOUND()
			SET PROCEDURE TO DUPLICAT.SPR
			m.pago = CRobtvlrpg(DPL_BUG.EMPRESA,DPL_BUG.DUPLICATA)

		    SELE &ALS_Duplicat
			=rlock()
			REPLACE vlr_pgto WITH m.pago
		ENDIF		
		SELE DPL_BUG
		SKIP
	ENDDO

    =up_fecha("DPL_BUG")
    =up_fecha("&ALS_Duplicat")
    IF USED(ALIAS_ANT)
		SELE 	&ALIAS_ANT
	ENDIF

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4KD           CRobtvlrpg VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   21  º
*       º Variable:            CRobtvlrpg                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      344                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4kd     &&  CRobtvlrpg VALID
#REGION 10
RETURN

FUNCTION  CRobtvlrpg

PARAMETERS LNemp,LNduplicata

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE  ARQ_RetornMv, ALS_RetornMv, alias_ant
    PRIVATE  LNvlr_pago;

	ALIAS_ANT = ALIAS()

    ARQ_RetornMv  = NetArqAgain("RETORNMV")
    ALS_RetornMv  = Alias()

	SELE &ALS_RetornMv
	SET ORDER TO TAG doc_ocor
	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
    LNvlr_pago   = 0

	SET NEAR ON
*	SEEK STR(LNemp,3)+STR(LNduplicata,9)
	SEEK STR(LNduplicata,9)

	SET NEAR OFF

    LNvlr_pago   = 0
	DO WHILE !EOF() ;
				 AND LNemp       = &ALS_RetornMv .empresa ;
	             AND LNduplicata = &ALS_RetornMv .duplicata

		IF &ALS_RetornMv .dtprocesso <> {}
	        LNvlr_pago = LNvlr_pago + &ALS_RetornMv .vlr_pgto
		ENDIF
		SKIP
	ENDDO
    =up_fecha("&ALS_RetornMv")
    IF USED(ALIAS_ANT)
		SELE 	&ALIAS_ANT
	ENDIF

RETURN(LNvlr_pago)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4KE           CRgetNvVlrDup VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   22  º
*       º Variable:            CRgetNvVlrDup                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      345                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4ke     &&  CRgetNvVlrDup VALID
#REGION 10
RETURN

FUNCTION CRgetNvVlrDup

  PARAMETERS PRMempresa, PRMduplicata, PRMvalor

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSmsg
	PRIVATE LSalias
    PRIVATE ARQ_Duplicat,ALS_Duplicat
	PRIVATE LNDiasatr
	PRIVATE LNVlrmulta
	PRIVATE LNVlrjuros
	PRIVATE LNVlrDesp
	PRIVATE LNVlrReceb
	PRIVATE LNVlrLiq
    PRIVATE	LNnovoVlr


    LSAlias      = Alias()

    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()

	*------------------------------------------------------------*

	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(PrmDuplicata,9)
	IF !FOUND()
		LSmsg = "Nao foi possivel calcular valo parcela refinanciamento. ";
				 + "Doc. "+STR(LNdup,9)+" Nao localizado. "
		=fox_alert(LSmsg,.t.)

	    =up_fecha("&ALS_Duplicat")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF


	LNDiasatr  = 0
	LNVlrmulta = 0
	LNVlrjuros = 0
	LNVlrDesp  = 0
	LNVlrReceb = 0
	LNVlrLiq   = 0
    LNnovoVlr  = 0

	SELE EMPRESA
	SET ORDER TO TAG EMPRESA
	SEEK duplicat.empresa

	SELE DUPLICAT
	LNMULTA    = empresa.multa
	LNJUROS    = empresa.mora

	DO ocr0001.spr WITH ;
			&ALS_Duplicat .duplicata,;
			&ALS_Duplicat .cliente,;
			&ALS_Duplicat .nome,;
			&ALS_Duplicat .dt_venc,;
			&ALS_Duplicat .dt_pgto,;
			&ALS_Duplicat .vlr_doc,;
			LNMulta,LNJuros,;
        	LNDiasatr,LNVlrmulta,LNVlrjuros,LNVlrDesp,LNVlrReceb,LNVlrLiq,;
          	&ALS_Duplicat .dsp_cobr,;
          	&ALS_Duplicat .out_desp,;
          	&ALS_Duplicat .abatimento,;
          	&ALS_Duplicat .desconto,;
          	&ALS_Duplicat .parc_pgto,;
          	LNnovoVlr

	*------------------------------------------------------------*

    =up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNnovoVlr)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4LC           CRNv_VlrDup VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   23  º
*       º Variable:            CRNv_VlrDup                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      346                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4lc     &&  CRNv_VlrDup VALID
#REGION 10
RETURN

FUNCTION CRNv_VlrDup

PARAMETERS PrmVlrDup,PrmTotalaPagar,PrmDtPgto, PrmDtVenc, PrmTaxaJuros,;
           PrmOutDespeas,PrmVlrDesconto, PrmVlrabat, PrmVlrdev,;
           PrmVlrpgparcial

	=W_DEFPROC("rotinas.spr")
	PRIVATE LNDiasatr
	PRIVATE	LNVlrParcela
	PRIVATE LNjuros
	PRIVATE LNVlrjuros
	PRIVATE LNvlrFinal

	*------------------------------------------*

	IF PrmTotalaPagar < PrmVlrpgparcial
		WAIT WINDOW ;
			"Total a Pagar deve ser Maior ou Igual ao Pg.Parcial <Enter>"
		RETURN
	ENDIF


	IF EMPT(PrmDtPgto) OR EMPT(PrmDtVenc)
	   LNDiasatr  = 0
	  ELSE
	   LNDiasatr  = PrmDtPgto - PrmDtVenc
	ENDI



	LNdespesas    =  PrmOutDespeas
*
*	LNdescontos   =  PrmVlrdev +  PrmVlrabat + PrmVlrDesconto +;
* 	                   PrmVlrpgparcial
*
*	LNvlrFinal = PrmTotalaPagar + LNdescontos - LNdespesas
*

	LNdescontos   =  PrmVlrdev +  PrmVlrabat + PrmVlrDesconto
  	

	LNvlrFinal = PrmTotalaPagar + LNdescontos - LNdespesas
	


	LNVlrParcela = 0
	LNjuros      = 0
	LNVlrjuros   = 0




	DO WHILE LNVlrParcela + LNVlrjuros + PrmVlrpgparcial <= ;
	           LNvlrFinal +  PrmVlrpgparcial
		LNVlrParcela = LNVlrParcela + 1
		IF LNVlrParcela > PrmVlrpgparcial
			LNVlrmulta=((LNVlrParcela - PrmVlrpgparcial) * PrmTaxaJuros)/100
		ENDIF
		LNjuros      = (LNVlrmulta/30)
		LNVlrjuros   = LNjuros * LNDiasatr
	ENDDO

	LNVlrParcela = LNVlrParcela - 1

	DO WHILE LNVlrParcela + LNVlrjuros + PrmVlrpgparcial  < ;
	           LNvlrFinal +  PrmVlrpgparcial
	
		LNVlrParcela = LNVlrParcela + 0.01
		IF LNVlrParcela > PrmVlrpgparcial
			LNVlrmulta=((LNVlrParcela - PrmVlrpgparcial) * PrmTaxaJuros)/100
		ENDIF
		LNjuros      = (LNVlrmulta/30)
		LNVlrjuros   = LNjuros * LNDiasatr
	ENDDO


RETURN(LNVlrParcela)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4LL           CR_001geraNssNro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   24  º
*       º Variable:            CR_001geraNssNro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      347                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4ll     &&  CR_001geraNssNro VALID
#REGION 10
RETURN

FUNCTION  CR_001geraNssNro

PARAMETERS PrmEmpresa,PrmBanco,PrmCarteira,PrmVariacao
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*

	PRIVATE LSnossoNro
	PRIVATE LSalias
    PRIVATE ARQ_Cobranca,ALS_Cobranca
	

    LSAlias      = Alias()


    ARQ_Cobranca     = NetArqAgain("Cobranca")
    ALS_Cobranca     = Alias()

	SELE &ALS_Cobranca

	SET ORDER TO TAG operacao
	seek str(PrmEmpresa,3) + STR(PrmBanco,3) + "BOLETO EMPRESA"
		
	=RLOCK()

*----------------------------------------------------*
*REGRA SUBSTITUIDA EM 29/11/2011
*----------------------------------------------------*
*	IF LEN(ALLTRIM( &ALS_Cobranca .convenio )) = 7
*		LSnossoNro = ALLTRIM( &ALS_Cobranca .convenio )+ ;
*	           STRTRAN(STR( &ALS_Cobranca .BLT_SEQATU,4), " ","0")
*
*----------------------------------------------------*


	IF LEN(ALLTRIM( &ALS_Cobranca .convenio )) = 7
		LSnossoNro = ALLTRIM( &ALS_Cobranca .convenio )+ ;
	           STRTRAN(STR( &ALS_Cobranca .BLT_SEQATU,10), " ","0")




       *----------------------------------------------------------*
       *REGRA SUBSTITUIDA EM 08/05/2014 (VOLTANDO NSSO NRO SEM O DV)
       *----------------------------------------------------------*
  	   *LSnossoNro = LSnossoNro+ CR_001_17DIGITO_NSSNRO(LSnossoNro)

   	    LSnossoNro = LSnossoNro


	ELSE

		LSnossoNro = ALLTRIM( &ALS_Cobranca .convenio )+ ;
	           STRTRAN(STR( &ALS_Cobranca .BLT_SEQATU,5), " ","0")

  	    LSnossoNro = LSnossoNro+ CR_001DIGITO_NSSNRO(LSnossoNro)

	ENDIF



	REPLACE  &ALS_Cobranca .BLT_SEQATU WITH ;
			  &ALS_Cobranca .BLT_SEQATU + 1
    =up_fecha("&ALS_Cobranca")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LSnossoNro)


FUNCTION CR_001DIGITO_NSSNRO
PARAMETERS PrmNumero

   PRIVATE LsNro_aux
   PRIVATE LnSoma
   PRIVATE Lnresto
   PRIVATE LnDigito_1
   PRIVATE LsDigito_1
   if type("PrmNumero") = "N"
	   LsNro_aux  = strtran(str(PrmNumero,11)," ","0")
   ELSE
	   LsNro_aux  = strtran(LEFT(PrmNumero,11)," ","0")
   ENDIF
   LnSoma  = 0
   Lnresto    = 0
   LnDigito_1 = 0
   LnPosicao     = 0
   LnPeso   = 7

   for LnPosicao = 1 to 11
       LnSoma = LnSoma + val(subs(LsNro_aux,LnPosicao,1))*LnPeso
       LnPeso = LnPeso + 1
       if LnPeso = 10
	       LnPeso = 2
	   endif
   next
   Lnresto = mod(LnSoma,11)

   DO CASE
		CASE Lnresto  < 10
			LsDigito_1 = STRTRAN(STR(LnResto,1)," ","0")
		CASE Lnresto  = 10
			LsDigito_1 = "X"
   ENDCASE

RETURN(LSdigito_1)

FUNCTION CR_001_17DIGITO_NSSNRO
PARAMETERS PrmNumero

   PRIVATE LsNro_aux
   PRIVATE LnSoma
   PRIVATE Lnresto
   PRIVATE LnDigito_1
   PRIVATE LsDigito_1
   if type("PrmNumero") = "N"
	   LsNro_aux  = strtran(str(PrmNumero,17)," ","0")
   ELSE
	   LsNro_aux  = strtran(LEFT(PrmNumero,17)," ","0")
   ENDIF
   LnSoma  = 0
   Lnresto    = 0
   LnDigito_1 = 0
   LnPosicao     = 0
   LnPeso   = 9

   for LnPosicao = 1 to 17
       LnSoma = LnSoma + val(subs(LsNro_aux,LnPosicao,1))*LnPeso
       LnPeso = LnPeso + 1
       if LnPeso = 10
	       LnPeso = 2
	   endif
   next
   Lnresto = mod(LnSoma,11)

   DO CASE
		CASE Lnresto  < 10
			LsDigito_1 = STRTRAN(STR(LnResto,1)," ","0")
		CASE Lnresto  = 10
			LsDigito_1 = "X"
   ENDCASE

RETURN(LSdigito_1)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4LW           CR_237geraNssNro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   25  º
*       º Variable:            CR_237geraNssNro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      348                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4lw     &&  CR_237geraNssNro VALID
#REGION 10
RETURN

FUNCTION  CR_237geraNssNro

PARAMETERS PrmEmpresa,PrmBanco,PrmCarteira,PrmVariacao
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*

	PRIVATE LSnossoNro
	PRIVATE LSalias
    PRIVATE ARQ_Cobranca,ALS_Cobranca
	

    LSAlias      = Alias()


    ARQ_Cobranca     = NetArqAgain("Cobranca")
    ALS_Cobranca     = Alias()

	SELE &ALS_Cobranca

	SET ORDER TO TAG operacao
	seek str(PrmEmpresa,3) + STR(PrmBanco,3) + "BOLETO EMPRESA"
		
	=RLOCK()


	LSnossoNro =  ;
	           STRTRAN(STR( &ALS_Cobranca .BLT_SEQATU,11), " ","0")


	LSnossoNro = LSnossoNro+ ;
  	       CR_237DIGITO_NSSNRO( &ALS_Cobranca .carteira ,LSnossoNro)
  	



	REPLACE  &ALS_Cobranca .BLT_SEQATU WITH ;
			  &ALS_Cobranca .BLT_SEQATU + 1
    =up_fecha("&ALS_Cobranca")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LSnossoNro)


FUNCTION CR_237DIGITO_NSSNRO
PARAMETERS PrmCarteira , PrmNumero

   PRIVATE LsNro_aux
   PRIVATE LnSoma
   PRIVATE Lnresto
   PRIVATE LnDigito_1
   PRIVATE LsDigito_1
   if type("PrmNumero") = "N"
	   LsNro_aux  = strtran(str(PrmNumero,11)," ","0")
   ELSE
	   LsNro_aux  = strtran(LEFT(PrmNumero,11)," ","0")
   ENDIF
   LsNro_aux   = PrmCarteira + LsNro_aux


   LnSoma  = 0
   Lnresto    = 0
   LnDigito_1 = 0
   LnPosicao     = 0
   LnPeso   = 2

   for LnPosicao = 1 to 13
       LnSoma = LnSoma + val(subs(LsNro_aux,LnPosicao,1))*LnPeso
       LnPeso = LnPeso - 1
       if LnPeso = 1
	       LnPeso = 7
	   endif
   next
   Lnresto = mod(LnSoma,11)


   DO CASE
		CASE  Lnresto  > 1
			LsDigito_1 = STRTRAN(STR( 11 - LnResto ,1)," ","0")
		CASE  Lnresto = 1
			LsDigito_1 = "P"
		CASE  Lnresto = 0
			LsDigito_1 = "0"
   ENDCASE

RETURN(LSdigito_1)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4LX           CRProc237 VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   26  º
*       º Variable:            CRProc237                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      349                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4lx     &&  CRProc237 VALID
#REGION 10
RETURN

FUNCTION CRProc237

	DO CASE
	   CASE retornmv.ocorrencia = 02  && ENTRADA CONFIRMADA
		    m.portador    = retornbc.banco
		 	m.agencia     = retornmv.agenc_cobr
		 	m.num_no_bco  = retornmv.num_no_bco
			m.ConfNroBco  = .t.
	   CASE retornmv.ocorrencia = 03   && ENTRADA REJEITADA
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia = 06 && LIQUIDACAO DO NORMAL
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia = 09  && BAIXADO AUT. VIA ARQUIVO
			 m.portador	=	0      && inf. carteira CR e Cobranca
			 m.agencia  =   0
	   CASE retornmv.ocorrencia = 10 && BAIXADOS CONF INST AGENC
			 m.portador	=	0      && inf. carteira CR e Cobranca
			 m.agencia  =   0
		CASE retornmv.ocorrencia = 12 && ABATIMENTO CONCEDIDO
			m.abatimento= 	retornmv.abatimento
		CASE retornmv.ocorrencia = 13 && ABATIMENTO CANCELADO
			m.abatimento= 	0
		CASE retornmv.ocorrencia = 14 && VENCIMENTO ALTERADO
			m.dt_venc	=	retornmv.vencimento
	   CASE retornmv.ocorrencia = 15 && LIQUIDACAO EM CARTORIO
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia = 17 && LIQUIDACAO APOS BX OU TIT NAO REG
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia  = 19 && INSTR. PROTESTO CONFIRMADO
			m.trf_cart 	=  	retornmv.trf_cart
	   CASE retornmv.ocorrencia  = 20 && INSTR. PROTESTO CANCELADA
			m.trf_cart 	=  	retornmv.trf_cart
  	   CASE retornmv.ocorrencia = 23 && ENTRADA CARTORIO
			m.tp_cobranc=   88    && COBRANCA EM CARTORIO
			m.trf_cart 	=  	retornmv.trf_cart
	   CASE retornmv.ocorrencia  = 24   && REJ. CEP IRREGULAR
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia  = 27   && BAIXA REJ
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia  = 28 && Debito de Tarifas/Custas
			IF LEFT(retornmv.motivos,2) = "08" && CUSTAS DE PROTESTO
				m.tp_cobranc=   89    && PROTESTADA
			ENDIF			
			LFprocessa	=	.T.
	   CASE retornmv.ocorrencia  = 30   && REJ. ALT DE OUTROS DADOS
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia  = 32   && INSTRUCAO REJ.
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia = 33   && ENTRADA REJEITADA
			LFprocessa	=	.T.
       CASE retornmv.ocorrencia = 34 &&ALTERACAO DADOS CONF
			m.tp_cobranc=   1    && COBRANCA SIMPLES
			m.trf_cart 	=  	retornmv.trf_cart
	ENDCASE			
RETURN(.T.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4LY           CRProc001 VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   27  º
*       º Variable:            CRProc001                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      350                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4ly     &&  CRProc001 VALID
#REGION 10
RETURN

FUNCTION CRProc001

	LFprocessa	=	.t.
    m.efeito	 = 0		&&  NULO (indica efeto no Contas a Rec)
	DO CASE
	   CASE retornmv.ocorrencia = 02  && ENTRADA CONFIRMADA
		    m.portador    = retornbc.banco
		 	m.agencia     = retornmv.agenc_cobr
		 	m.num_no_bco  = retornmv.num_no_bco
			m.ConfNroBco  = .t.
	   CASE retornmv.ocorrencia = 03   && ENTRADA REJEITADA
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia = 05 && LIQUIDACAO sem registro
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia = 06 && LIQUIDACAO DO NORMAL
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF

	   CASE retornmv.ocorrencia = 07 && LIQUIDACAO por conta
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia = 08 && LIQUIDACAO por saldo
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia = 09  && BAIXADO AUT. VIA ARQUIVO
			 m.portador	=	0      && inf. carteira CR e Cobranca
			 m.agencia  =   0
	    CASE retornmv.ocorrencia = 10 && BAIXADOS CONF INST AGENC
			 m.portador	=	0      && inf. carteira CR e Cobranca
			 m.agencia  =   0
		CASE retornmv.ocorrencia = 12 && ABATIMENTO CONCEDIDO
			m.abatimento= 	retornmv.abatimento
		CASE retornmv.ocorrencia = 13 && ABATIMENTO CANCELADO
			m.abatimento= 	0
		CASE retornmv.ocorrencia = 14 && VENCIMENTO ALTERADO
			m.dt_venc	=	retornmv.vencimento
	    CASE retornmv.ocorrencia = 15 && LIQUIDACAO EM CARTORIO
  		     m.efeito	 = 2		  &&  PGTO TOTAL
			*******************   CRITICA *******************
			 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
				LFprocessa	=	.F.
			 ELSE
				 SCATTER FIELDS juros, iof,abatimento, desconto, ;
						mora, out_credt, form_pgto, ;
						dtocorrenc  MEMVAR
				 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
				 m.dt_pgto  = m.dtocorrenc
				 m.dt_baixa = m.dtprocesso
				 m.paga_em  = retornmv.banco
			ENDIF
	   CASE retornmv.ocorrencia  = 19 && INSTR. PROTESTO CONFIRMADO
			m.trf_cart 	=  	retornmv.trf_cart
  	   CASE retornmv.ocorrencia = 23 && ENTRADA CARTORIO
			m.tp_cobranc=   88    && COBRANCA EM CARTORIO
			m.trf_cart 	=  	retornmv.trf_cart
	   CASE retornmv.ocorrencia  = 27   && BAIXA REJ
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia  = 30   && REJ. ALT DE OUTROS DADOS
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia  = 32   && INSTRUCAO REJ.
			LFprocessa	=	.F.
	   CASE retornmv.ocorrencia  = 96 && Debito de Tarifas/Custas
			m.tp_cobranc=   89    && PROTESTADA
			LFprocessa	=	.T.

	ENDCASE			
RETURN(.T.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4LZ           CRProcantigo VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   28  º
*       º Variable:            CRProcantigo                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      351                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4lz     &&  CRProcantigo VALID
#REGION 10
RETURN

FUNCTION CRProcantigo


			LFprocessa	=	.t.
 		    m.efeito	 = 0		&&  NULO (indica efeto no Contas a Rec)
			DO CASE   && processa ocor 02/06/07/09/10/12/13/14/17/19/
					  && 	   20/23/28/34/80/81/82/83/84/85/86/87/88
				      &&   E  03/24/27/30/32/   && REJEICOES
				CASE retornmv.ocorrencia = 02	&& ENTRADA EM COBRANCA

					*-----------------------------------------------*
					*   (ANTES)
					*    So Aceitar Registro de Entrada em Cobranca
					* Bancaria se o Portador for CARTEIRA(0)
					*-----------------------------------------------*
					*   09/08/20001
					*    Com implanta‡Æo do controle de cartäes
					* os erros dos operadores exigiam a mudan‡a do
					* portador conforme detectado na filial SIA
					* para evitar transtornos da conexÆo para altera‡Æo
					* de portador com pessoa do cpd liberamos a trava
					*--------------------------------------------------*
					
					IF EMPTY(duplicat.DT_PGTO)
					    m.portador    = retornbc.banco
					 	m.agencia     = retornmv.agenc_cobr
					ENDIF
				 	m.num_no_bco  = retornmv.num_no_bco
					m.ConfNroBco  = .t.
			 		 	***** m.banco      = retornmv.banco
					*-------------------------------------------------*
				CASE duplicat.tp_cobranc = 06  AND ;
  					 retornmv.ocorrencia = 06
					 *----------------------------------------------*
					 *=> Pagamento de titulo VENDOR
					 *----------------------------------------------*
	
		  		     m.efeito	 = 2		  &&  PGTO TOTAL
					*******************   CRITICA *******************
					 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
						LFprocessa	=	.F.
					 ELSE
						 SCATTER FIELDS juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto, ;
								dtocorrenc  MEMVAR
						 m.vlr_pgto = duplicat.vlr_doc
						 m.dt_pgto  = m.dtocorrenc
						 m.dt_baixa = m.dtprocesso
						 m.paga_em  = retornmv.banco
					ENDIF
				CASE retornmv.ocorrencia = 06  OR ;
  					 retornmv.ocorrencia = 05  OR ;
  					 retornmv.ocorrencia = 15  OR ;
  					 retornmv.ocorrencia = 83  OR ;
  					 retornmv.ocorrencia = 17  && LIQUIDACAO DO TITULO
		  		     m.efeito	 = 2		  &&  PGTO TOTAL
					*******************   CRITICA *******************
					 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
						LFprocessa	=	.F.
					 ELSE
						 SCATTER FIELDS juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto, ;
								dtocorrenc  MEMVAR
						 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
						 m.dt_pgto  = m.dtocorrenc
						 m.dt_baixa = m.dtprocesso
						 m.paga_em  =	 retornmv.banco
					ENDIF
				CASE retornmv.ocorrencia = 07  && ESPECIFICO DO BFB
					*			LIQUIDACAO PARCIAL
					***************************************************
					* VIZUALIZAR CRITICA
					*************************************************
		  		     m.efeito	 = 3		&&  PGTO PARCIAL
					 SCATTER FIELDS juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto, ;
								dtocorrenc  MEMVAR
					 *-------------------------------------------------*
					 * Ocorrencia 7 nao pode ser usada para saldar o valor
					 * da duplicata. Neste caso deve-se usar 83 (Liq.Saldo)
					 *-------------------------------------------------*
					 IF (m.vlr_pgto + retornmv.vlr_pgto) >= duplicat.vlr_doc
						LFprocessa	=	.F.
					 ELSE
						 m.vlr_pgto = m.vlr_pgto + retornmv.vlr_pgto
						 m.parc_pgto = m.parc_pgto + retornmv.vlr_pgto
						 m.paga_em  =	 retornmv.banco
					ENDIF
				CASE retornmv.ocorrencia = 09 OR ;
					 retornmv.ocorrencia = 10 && BAIXADOS
					 m.portador	=	0      && inf. carteira CR e Cobranca
					 m.agencia  =   0
				CASE retornmv.ocorrencia = 12 && ABATIMENTO CONCEDIDO
					m.abatimento= 	retornmv.abatimento
				CASE retornmv.ocorrencia = 13 && ABATIMENTO CANCELADO
					m.abatimento= 	0
				CASE retornmv.ocorrencia = 14 && VENCIMENTO ALTERADO
					m.dt_venc	=	retornmv.vencimento
				CASE retornmv.ocorrencia = 19 && INSTR. PROTESTO CONFIRMADO
					m.trf_cart 	=  	retornmv.trf_cart
				CASE retornmv.ocorrencia = 20 && INSTR. PROTESTO CANCELADA
					m.trf_cart 	=  	retornmv.trf_cart
				CASE retornmv.ocorrencia = 23 && ENTRADA CARTORIO
					m.tp_cobranc=   88    && COBRANCA EM CARTORIO
					m.trf_cart 	=  	retornmv.trf_cart

				CASE retornmv.ocorrencia = 24 && Sust Prot
					LFprocessa	=	.T.


				CASE retornmv.ocorrencia = 28 && Debito de Tarifas/Custas
					 LFok = .T.
				CASE retornmv.ocorrencia = 34 && ENTRADA CARTORIO
					m.tp_cobranc=   1    && COBRANCA SIMPLES
					m.trf_cart 	=  	retornmv.trf_cart

				******** INSTRUCOES DE CARTEIRA

				CASE retornmv.ocorrencia = 85 && ALTERCACAO DE VLR DE DUPL.

					 m.vlr_doc =  retornmv.vlr_pgto

				CASE   retornmv.ocorrencia = 80 ;
				    OR retornmv.ocorrencia = 84 ;
				    OR retornmv.ocorrencia = 50

	*			CASE    retornmv.ocorrencia = 50
	
					&& LIQ. POR DEVOLUCAO // DEVOL. PARCIAL
			 		 m.efeito	 = 4		&&  DEVOLUCAO
					 SCATTER FIELDS juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto, ;
								dtocorrenc  MEMVAR
    				
    				 && 80 - LIQUID. POR DEVOL.
    				 && 50 - LIQUID. POR DEVOL. cancela contrato

					 IF retornmv.ocorrencia = 80 or retornmv.ocorrencia = 50
	
						*******************   CRITICA *******************
						 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
							LFprocessa	=	.F.
						 ELSE
							 m.devolucao = m.devolucao + retornmv.vlr_pgto
							 m.dt_pgto  = m.dtocorrenc
							 m.dt_baixa = m.dtprocesso
							 m.paga_em  = retornmv.banco
						 ENDIF
					 ELSE
							 m.devolucao = m.devolucao + retornmv.vlr_pgto
					 ENDIF

				&& 81 DUPLICATA INCOBRAVEL
				&& 86 SALDO DE DUPLICATA IMCOBRAVEL
				CASE retornmv.ocorrencia = 81  OR ;
  					 retornmv.ocorrencia = 86

					*******************   CRITICA *******************
					 SCATTER FIELDS juros, iof,abatimento, desconto, ;
								mora, out_credt, form_pgto, ;
								dtocorrenc  MEMVAR

					 IF !EMPTY(m.dt_pgto)  && DUP JA ESTA BAIXADA
						LFprocessa	=	.F.
					 ELSE
				 		 m.efeito	 = 5		&&  INCOBRAVEL
 					 	 m.tp_cobranc=   99    && INCOBRAVEL
						 m.dt_pgto  = m.dtocorrenc
						 m.dt_baixa = m.dtprocesso
						 m.paga_em  =	 retornmv.banco
						 m.status = "I"
					 ENDIF
*				CASE retornmv.ocorrencia = 82  && ALTERA DIRECIONA. COBRANCA
*					IF EMPTY(duplicat.DT_PGTO)
*					    m.portador    = retornbc.banco
*					 	m.agencia     = retornmv.agenc_cobr
*					ENDIF
*

				CASE retornmv.ocorrencia = 87 && DESPESAS C/ VIAGENS
					 LFok = .T.
				CASE retornmv.ocorrencia = 88 && OUTRAS DESPESAS
					 LFok = .T.

				CASE retornmv.ocorrencia = 00 && Lanc em cc depositante
					LFprocessa	=	.T.

				CASE retornmv.ocorrencia = 96 && desp ped baixa prot
					LFprocessa	=	.T.

				CASE retornmv.ocorrencia = 97 && sust prot
					LFprocessa	=	.T.


				CASE retornmv.ocorrencia = 98 && custas cart
					LFprocessa	=	.T.

				OTHERWISE   && 03/24/27/30/32/   && REJEICOES
					LFprocessa	=	.F.
			ENDCASE			
RETURN(.T.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4MZ           CRgeraVdor VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   29  º
*       º Variable:            CRgeraVdor                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      352                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4mz     &&  CRgeraVdor VALID
#REGION 10
RETURN

PROCEDURE CRgeraVdor		&& USADA EM SCGC201, SCGCF201, SCGC201A
	PARAMETERS LNEmp,LNOrcamento
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE nota	&& O NUMERO DA NOTA DEVE SER O DA 1a NOTA CASO
					&& TENHAM SIDO GERADAS DUAS COM BASE NO MESMO ORCAMENTO
					&& PARA EVITAR INFLUENCIA NO AMBENTE NOTA E PRIVATE

	PRIVATE 	LNocorrenc, LNposic, LNinicio, LNnumpgt, LNdias, LNserie
	PRIVATE 	CVSTR1,CVSTR2,LNvlrdupl,LNdifere

	PRIVATE	empresa,duplicata,dt_emi,multa_prv,mora_prv,bonus_prv,;
			prem_pont,vlr_fatura,portador,tp_cobranc,;
			desconto,regiao,natu,nome,tp_cobranc

	PRIVATE dt_venc, dtproxproc
	PRIVATE LNtmp,banco

   	PRIVATE LNTp_parcela,LNbanco,LNvlrent,LSprazo,LDdtemi,LNmulta,LNmora
  	PRIVATE LNbonus,LNPremPont,LNRegiao,LNnatureza,LSnome,LNvlrfatura	
    PRIVATE LNnronota	

	PRIVATE LFduplicata,LFempresa,LForcamento,LFclienc,LFvendor
	PRIVATE LFclientes
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFduplicata	= NetArq("duplicat")
	LFempresa   = NetArq("Empresa" )
	LForcamento = NetArq("Orcament")
	LFvendor    = NetArq("Vendor")
	LFclienc    = NetArq("clienc")
	LFclientes  = NetArq("clientes")
	IF (LFduplicata+LFempresa+LForcamento+LFvendor) > 100000 OR ;
		(LFclientes+LFclienc) > 100000
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" 	  ,LFclienc )
		=UP_fecha("Vendor"  ,LFvendor )
		=UP_fecha("clientes"  ,LFclientes )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

	*----------------------------------------------------------------*
	wp_msg = "Gerando Vendor: "+STR(orcament.nota,7)
	WAIT WINDOW wp_msg NOWAIT



	*----------------------------------------------------------------*
	DO ULgeraDupl
	*----------------------------------------------------------------*
	*-----------------------------------------------------------*
	SET DECIMALS TO 2
	=UP_fecha("duplicat"  ,LFduplicata)
	=UP_fecha("empresa"   ,LFempresa)
	=UP_fecha("orcamento" ,LForcamento)
	=UP_fecha("clienc"    ,LFclienc)
	=UP_fecha("vendor"    ,LFvendor)
	=UP_fecha("clientes"  ,LFclientes)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN




	*----------------------------------------------------------------*
PROCEDURE ULgeraDupl

	LNcliente	= clienc.cliente	
  	LNmulta		= empresa .multa
  	LNmora		= empresa .mora
  	LNbonus		= empresa .bonus
  	LNPremPont	= empresa .prem_pont
  	LNRegiao	= clienc.regiao
	LNnatureza	= clienc.natu_cli
	LSnome		= clienc.nome

	SELECT &LSalias
	*-----------------------------------------------------------*
	*   Garante a Elimina‡Æo de Registros de Duplicatas Deixados
	* por falha
	*-----------------------------------------------------------*
	SELE vendor
	SET ORDER TO TAG orcamento
	SET NEAR ON
	SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

	=CRcancdupl((LNemp),(vendor.nota))
	*-----------------------------------------------------------*

	m.empresa	= LNemp
	m.nota		= vendor.nota
	m.duplicata	= vendor.nota
	m.cliente	= LNcliente
	m.multa_prv	= LNmulta
	m.mora_prv	= LNmora
	m.bonus_prv	= LNbonus
	m.prem_pont	= LNPremPont


	m.tp_cobranc= 01

	m.desconto  = 0
	m.regiao    = LNregiao
	m.natu      = LNnatureza
	m.nome      = LSnome
	m.tp_cobranc= 01 		  && COB. SIMPLES

	*-----------------------------------------------------------*
	*   Tratando os Registro Referentes a Entradas (MODO_PGTO = 1)
	*-----------------------------------------------------------*

	SELE vendor
	DO WHILE !EOF() AND LNemp       = vendor.empresa ;
					AND LNorcamento = vendor.orcamento

		m.duplicata =   vendor.duplicata
		m.tp_parcela=  	6
		m.moeda 	=	6
		m.dt_emi	= 	vendor.dt_emi
		m.vlr_fatura=   vendor.vlr_Compra
		m.vlr_encarg=   vendor.vlr_encarg
		m.vlr_ioffnc=   vendor.vlr_ioffnc
		m.portador 	=   vendor.banco
		m.tx_jurosvd=   vendor.tx_jurosvd
		m.tx_juroscp=   vendor.tx_juroscp
		m.iof_fin   =   vendor.iof_fin

		m.banco 	 =	vendor.banco
		m.vlr_doc	 =	vendor.vlr_doc
		m.vlr_pgto   =   0
		m.dt_venc	 =	vendor.dt_venc
		m.flg_vendor = .t.
		m.obs =""

		SELE  duplicat
		=edithand('SAVE')
		SELE vendor
		SKIP
	ENDDO

RETURN
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4NB           CRtxsVendor VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   30  º
*       º Variable:            CRtxsVendor                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      353                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4nb     &&  CRtxsVendor VALID
#REGION 10
RETURN

FUNCTION CRtxsVendor
PARAMETERS PrmEmpresa,PrmData,PrmVenc,PrmTp_Pessoa,;
  		Rtn_AIA,;
  		Rtn_AIOF,;
  		Rtn_d,;
  		Rtn_iC_comprador,;
  		Rtn_iC_vendor


	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*

	PRIVATE LNprazo,LFretorno
    PRIVATE ARQ_DxVendor,ALS_TxVendor

    LSAlias      = Alias()

    ARQ_TxVendor  = NetArqAgain("TxVendor")
    ALS_TxVendor  = Alias()

	LNprazo = 	PrmVenc - PrmDaTa
	LFretorno = .f.

	SET NEAR ON
	SELE &ALS_TxVendor
	SET ORDER TO TAG data
	SEEK DTOS(PrmData)+STR(LNprazo,3)
	SET NEAR OFF

	*-------------------------------------------------*

	DO WHILE !BOF()
		DO CASE
			CASE &ALS_TxVendor .data < PrmData
				WAIT WINDOW ;
				  "Nao foram cadastradas Taxa para "+;
				    DTOC(PrmData)+"-"+STR(LNprazo,3)+" dias <ENTER>"
				EXIT
			CASE &ALS_TxVendor .data > PrmData
				SKIP -1
			CASE &ALS_TxVendor .de > LNprazo
				SKIP -1
			CASE &ALS_TxVendor .de <= LNprazo

				Rtn_AIA		= &ALS_TxVendor .AIA
				IF PrmTp_Pessoa = 1		
			    	Rtn_AIOF = &ALS_TxVendor .AIF
				ELSE
			    	Rtn_AIOF = &ALS_TxVendor .AIJ
				ENDIF

				Rtn_d = LNprazo
				IF Rtn_d > 365
					Rtn_d= 365
				ENDIF

			
				Rtn_iC_vendor 	= &ALS_TxVendor .Tx_Vendor

				**  Rtn_iC_comprador= &ALS_TxVendor .Tx_comprad


				** majoracao de 30% sobre a taxa do banco

				Rtn_iC_comprador= Rtn_iC_vendor * 1.30


				LFretorno = .t.

				EXIT
		ENDCASE				
	ENDDO	

    =up_fecha("&ALS_TxVendor")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4NC           CRcalcVendor VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   31  º
*       º Variable:            CRcalcVendor                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      354                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4nc     &&  CRcalcVendor VALID
#REGION 10
RETURN

FUNCTION  CRcalcVendor
PARAMETERS 	PrmEmpresa,;
			PrmVlrSolicitado,;
			PrmDtEmi,;
			PrmDtVenc,;
			PrmTp_Pessoa,;
        	PrmFlgEmbuteIOF,;
        	RtnEncargo,;
        	RtnIOF,;
        	RtnValor,;
        	RtnBcoEncargo
        	
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*



	PRIVATE LNdup

	PRIVATE LSnota      && STRING COM NUMERO DA NOTA PARA COMPARACAO
	PRIVATE LSnotaDaDup && STRING COM NUMERO DA NOTA RETIRADO DO NUMERO
						&& DA DUPLICATA


	PRIVATE LSmsg
	PRIVATE LSalias
    PRIVATE LNBol_ordem
	PRIVATE LScarteira
	PRIVATE LSvariacao


	PRIVATE AIA,AIOF,d,iC_comprador,iC_vendor
	STORE 0 TO  AIA,AIOF,d,iC_comprador,iC_vendor

	*-----------------  CALCULO ------------------------*

	set decimals to 5
	=CRtxsVendor(PrmEmpresa,PrmDtEmi,PrmDtVenc,PrmTp_Pessoa,;
  		AIA,;
  		AIOF,;
  		d,;
  		iC_comprador,;
  		iC_vendor)


*	iC =  iC_comprador


	*----------------------------------------------------*
	* 1) Calculo do IOF nao embutido
	*----------------------------------------------------*

	VS 		= PrmVlrSolicitado

	INE = VS * (AIA + (d * AIOF)/100)

	*----------------------------------------------------*
	* 2) Calculo do IOF  embutido
	*----------------------------------------------------*

	IOFE  = (VS * INE) / (VS - INE)



	*----------------------------------------------------*
	* 3) Calculo do Valor a ser Financiado
	*----------------------------------------------------*
	
	IF PrmFlgEmbuteIOF = .F.
		VF =  VS
	ELSE
		VF = VS + IOFE
	ENDIF
	

	*----------------------------------------------------*
	* 4) Calculo dos Encargos do Comprador
	*----------------------------------------------------*
	potencia = d/30

	JC = (VF * ((1+iC_comprador/100)**(potencia)-1))
	
	* TRUNCANDO O VALOR
	JC = INT(JC*100)/100
	

	*----------------------------------------------------*
	* 5) Calculo do valor de liquidacao do titulo no venc
	*    Com encargos do Comprador
	*----------------------------------------------------*

	VL = VF + JC






	*----------------------------------------------------*
	* 4.1) Calculo dos Encargos do BANCO
	*----------------------------------------------------*
	potencia = d/30

	JBco = (VF * ((1+iC_vendor/100)**(potencia)-1))
	
	* TRUNCANDO O VALOR
	JBco = INT(JBco*100)/100
	

	*----------------------------------------------------*
	* 5.1) Calculo do valor de liquidacao do titulo no venc
	*    Com encargos do BANCO
	*----------------------------------------------------*

	VLBco = VF + JBco

	*----------------------------------------------------*



   	RtnEncargo = JC
   	RtnValor = VL

    RtnBcoEncargo = JBco

	IF PrmFlgEmbuteIOF = .F.
		RtnIOF =  INE
	ELSE
	   	RtnIOF = IOFE
	ENDIF


	set decimals to 2

RETURN(VL)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4ND           CRConfigParcelas VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   32  º
*       º Variable:            CRConfigParcelas                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      355                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4nd     &&  CRConfigParcelas VALID
#REGION 10
RETURN

FUNCTION  CRConfigParcelas
*-----------------------------------*
*PARAMETERS ;
*		PrmEmpresa,;
*		PrmDtEmi,;
*		PrmPrazo,;
*		PrmVlrEnt,;
*		PrmValor
*-----------------------------------*


PARAMETERS PrmEmpresa,;
		PrmTp_Parcela,;
		PrmOrcamento,;
		PrmDtEmi,;
		PrmPrazo,;
		PrmVlrEnt,;
		PrmValorTotal,;
		PrmIof_fin,;
		PrmTp_Pessoa,;
		RtnTvlr_encarg, ;
    	RtnTvlr_ioffnc,;
    	RtnTvlr_Total



		*--------------------------------------------------*
		PRIVATE m.tx_jurosvd,m.tx_juroscp,;
    			m.dias

		PRIVATE AIA,AIOF,d,	m.TX_JUROSCP,m.TX_JUROSVD
		STORE 0 TO  AIA,AIOF,d,m.TX_JUROSCP,m.TX_JUROSVD

	    =W_DEFPROC("rotinas.spr")
       	RtnTvlr_encarg 	= 0
    	RtnTvlr_ioffnc	= 0
      	RtnTvlr_Total	= 0

		
	    M.EMPRESA  	= PrmEmpresa
		m.ORCAMENTO = PrmOrcamento
  		m.NOTA  	= 0
  		m.ORDEM 	= 0
    	m.DUPLICATA = PrmOrcamento*10
    	m.TP_PARCELA= PrmTp_Parcela
    	m.MOEDA		= 0
    	m.BANCO		= 0
  		m.DT_EMI	= PrmDtEmi
		m.dt_venc	= m.dt_emi
		
       	m.vlr_encarg= 0
    	m.vlr_ioffnc= 0
       	m.vlr_doc	= 0
		m.Iof_fin   = PrmIof_fin

		IF PrmIof_fin = 1
			FlgImbuteIOF = .T.
		ELSE
			FlgImbuteIOF = .F.
		ENDIF
		

		*--------------------------------------------------*
		
		PRIVATE LNqtdeParcelas,LNdias

    	PRIVATE ARQ_Parcelas,ALS_Parcelas
		PRIVATE LSalias

		PRIVATE m.parcela,m.dt_emi,m.dt_venc,m.dias,m.dia_semana,m.valor


    	LSAlias      = Alias()

    	ARQ_Parcelas  = NetArqAgain("VENDOR")
    	ALS_Parcelas  = Alias()
    	

	    =W_DEFPROC("rotinas.spr")
		ARQ_tmp=UPnometmp("EXT")


		SELE &ALS_parcelas
		COPY STRU TO  &ARQ_tmp
	    =up_fecha("&ALS_Parcelas")


		SELE 0
		USE &ARQ_tmp ALIAS TMPVD

		

		=W_DEFPROC("duplicat.spr")
		LNqtdeParcelas= CRQtdeParcelas(PrmPrazo)


		IF PrmTp_Parcela = 6
			=CRVendorGeraSimulacao()
		ELSE
			=CRParcelasGeraSimulacao()
		ENDIF
	
		ON ERROR
		ON KEY LABEL ENTER
		ON KEY
		


	    =up_fecha("&ALS_Parcelas")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		
RETURN("TMPVD")



FUNCTION CRParcelasGeraSimulacao

		FOR X = 1 TO LNqtdeParcelas
			m.parcela = X
			m.dt_emi  = PrmDtEmi

			=W_DEFPROC("duplicat.spr")
			LNdias= CRDiasParcela(X,PrmPrazo)

			m.dt_venc = m.dt_emi + LNdias
			m.dias = LNdias
			
			m.dia_semana = CRDiaSemana(m.dt_venc)

			m.vlr_doc =;
				 ULclcParcela(X,LNqtdeParcelas,PrmVlrEnt,PrmValortOTAL)


      		RtnTvlr_Total	= RtnTvlr_Total  + m.vlr_doc


	    	m.DUPLICATA = m.DUPLICATA + 1


			SELE TMPVD
		    =edithand('SAVE')
		NEXT
RETURN

FUNCTION ULclcParcela
PARAMETERS PrmParcela,PrmQtdeParcelas,PrmVlrEnt,PrmValorTotal

	PRIVATE RtnVlrParcela
	PRIVATE LNdiferenca,LNvlrSemEntrada,LnVlrParcelas,LNdiferenca
	

	DO CASE
		CASE PrmQtdeParcelas = 1
			RtnVlrParcela = PrmValorTotal
		
		CASE PrmParcela = 1 AND PrmVlrEnt > 0
			RtnVlrParcela = PrmVlrEnt
		
		CASE PrmParcela > 1 AND PrmVlrEnt > 0
			LNvlrSemEntrada = (PrmValorTotal - PrmVlrEnt)

			LnVlrParcelas	= LNvlrSemEntrada / (PrmQtdeParcelas-1)

			LnVlrParcelas	= (INT(LnVlrParcelas*100))/100

			LNdiferenca     =  LNvlrSemEntrada -;
								 LnVlrParcelas*(PrmQtdeParcelas-1)
			
			IF  PrmParcela = 2
				RtnVlrParcela = LnVlrParcelas + LNdiferenca
			ELSE
				RtnVlrParcela = LnVlrParcelas
			ENDIF
		OTHERWISE

			LnVlrParcelas	= PrmValorTotal / (PrmQtdeParcelas)

			LnVlrParcelas	= (INT(LnVlrParcelas*100))/100

			LNdiferenca     =  PrmValorTotal - ;
								 LnVlrParcelas*(PrmQtdeParcelas)
			
			IF  PrmParcela = 1
				RtnVlrParcela = LnVlrParcelas + LNdiferenca
			ELSE
				RtnVlrParcela = LnVlrParcelas
			ENDIF
	ENDCASE
RETURN(RtnVlrParcela)



FUNCTION CRVendorGeraSimulacao


		LNDiferenca = PrmValorTotal - ;
		              ROUND((PrmValorTotal / LNqtdeParcelas),2);
										   * LNqtdeParcelas

		FOR X = 1 TO LNqtdeParcelas
			

			=W_DEFPROC("duplicat.spr")
			m.dias= CRDiasParcela(X,PrmPrazo)

			m.dt_venc = m.dt_emi + m.dias 		
			=W_DEFPROC("duplicat.spr")
			m.dt_venc=CRajustaVenc(m.dt_venc,"+")


			=W_DEFPROC("duplicat.spr")
			IF !CRtxsVendor(PrmEmpresa,PrmDtEmi,m.dt_venc,PrmTp_Pessoa,;
			  		AIA,;
			  		AIOF,;
			  		d,;
			  		m.TX_JUROSCP,;
			  		m.TX_JUROSVD)

				STORE 0 TO 	AIA,AIOF,m.TX_JUROSCP,m.TX_JUROSVD
			ENDIF


 			m.VLR_COMPRA = PrmValorTotal

		*
 		*	m.VLR_DOC = ROUND((PrmValorTotal/LNqtdeParcelas),2);
 		*					+LNDiferenca
		*


			m.vlr_doc =;
				 ULclcParcela(X,LNqtdeParcelas,PrmVlrEnt,PrmValortOTAL)

			m.totvlvendr = 0
			
			=W_DEFPROC("duplicat.spr")
			=CRcalcVendor(m.Empresa,;
				m.VLR_DOC,;
				m.dt_emi,;
				m.dt_venc,;
				PrmTp_Pessoa,;
	   	    	m.FlgImbuteIOF,;
	        	m.vlr_encarg,;
    	    	m.vlr_ioffnc,;
	        	m.totvlvendr)

			RtnTvlr_encarg 	= RtnTvlr_encarg + m.vlr_encarg
    		RtnTvlr_ioffnc	= RtnTvlr_ioffnc + m.vlr_ioffnc
      		RtnTvlr_Total	= RtnTvlr_Total  + m.totvlvendr



	    	m.DUPLICATA = m.DUPLICATA + 1
			SELE TMPVD
		    =edithand('SAVE')
		NEXT
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4NE           CRQtdeParcelas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   33  º
*       º Variable:            CRQtdeParcelas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      356                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4ne     &&  CRQtdeParcelas VALID
#REGION 10
RETURN

FUNCTION  CRQtdeParcelas
PARAMETERS ;
		PrmPrazo
		PRIVATE LNQtdeParcelas
		LNQtdeParcelas = 1
		LSstring = ""
		*-----------------------------------------------------------*
		DO WHILE .t.

			LSdias = SUBS(PrmPrazo,LNQtdeParcelas*4+1,3)
			IF LSdias = "   "
				EXIT
			ENDIF
			LNQtdeParcelas=LNQtdeParcelas+1
		ENDDO
		
RETURN(LNQtdeParcelas)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4OG           CRDiasParcela VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   34  º
*       º Variable:            CRDiasParcela                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      357                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4og     &&  CRDiasParcela VALID
#REGION 10
RETURN

FUNCTION  CRDiasParcela
PARAMETERS PrmParcela,PrmPrazo

	PRIVATE LNPos,LNdias

		LNPos = ((PrmParcela-1) * 4) + 1

		LNdias = INT(VAL(SUBS(PrmPrazo,LNpos,3)))			

RETURN(LNdias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4OM           CRViewParcelas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   35  º
*       º Variable:            CRViewParcelas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      358                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4om     &&  CRViewParcelas VALID
#REGION 10
RETURN

FUNCTION  CRViewParcelas
PARAMETERS PtmTp_Parcela,PrmPrazo

	PRIVATE LSprazo

	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"

	ON KEY LABEL END KEYBOARD "{CTRL-W}"
	ON KEY LABEL ENTER KEYBOARD "{DNARROW}"
	ON KEY LABEL ESCAPE KEYBOARD "{UPARROW}"


	DEFINE WINDOW OUTPUT ;
		FROM 13, 0 ;
		TO 25,79 ;
		TITLE  "[ Configuracao Parcelas ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	ON KEY LABEL TAB
	ON KEY LABEL ESCAPE KEYBOARD "{UPARROW}"
	ON KEY LABEL ENTER  KEYBOARD "{DNARROW}"



	DO CASE
		CASE PtmTp_Parcela <> 6	   && NAO VENDOR
			BROWSE  FIELDS ;
				PARCELA		:H="Parc." :W=.F.,;
				DT_VENC		:H="Dt.Venc" :W=.F.,;
				DIAS	:H="Prazo" ;
					:V=ULVL_DATA();
					:F,;
				VLR_DOC	:H="Vlr.Parcela"	:P="@r ####9.99" :W=.F.,;
				DIA_SEMANA	:H="Dia" :W=.F., ;
				VLR_COMPRA	:H="Vlr.Compra"	:P="@r ####9.99" :W=.F.,;
				VLR_ENCARG	:H="Encargos"	:P="@r ####9.99" :W=.F.,;
				VLR_IOFFNC	:H="IOF"	:P="@r ####9.99" :W=.F.;
			TITLE "Informe novo Prazo para Cada Parcela // <END>=ENCERRA"  ;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL ;
		    WINDOW OUTPUT
		CASE PtmTp_Parcela = 6	   && VENDOR
			BROWSE  FIELDS ;
				PARCELA		:H="Parc." :W=.F.,;
				DT_VENC		:H="Dt.Venc" :W=.F.,;
				DIAS	:H="Prazo" ;
					:V=ULVL_DATA();
					:F,;
				TOTVLVENDR  :H="Vlr.Parcela"	:P="@r ####9.99" :W=.F.,;
				DIA_SEMANA	:H="Dia" :W=.F., ;
				VLR_DOC  	:H="Financiado"	:P="@r ####9.99" :W=.F.,;
				VLR_ENCARG	:H="Encargos"	:P="@r ####9.99" :W=.F.,;
				VLR_IOFFNC	:H="IOF"	:P="@r ####9.99" :W=.F.;
			TITLE "Informe novo Prazo para Cada Parcela // <END>=ENCERRA"  ;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL ;
		    WINDOW OUTPUT

	ENDCASE


	RELEASE WINDOW OUTPUT
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	ON KEY LABEL END DO ULsair

	*-------------------------------------------------*
	GO TOP
	PrmPrazo = ""

	DO WHILE !EOF()
		LSprazo = CHRTRAN(STR(dt_venc - Dt_emi,3)," ","0")
		PrmPrazo = PrmPrazo + LSprazo +"/"
		SKIP
	ENDDO

RETURN(PrmPrazo)

FUNCTION ULVL_DATA
		REPLACE DT_VENC WITH DT_EMI + DIAS
		
		REPLACE dia_semana WITH  CRDiaSemana(dt_venc)

RETURN(.T.)

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4OU           CRDiaSemana VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   36  º
*       º Variable:            CRDiaSemana                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      359                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4ou     &&  CRDiaSemana VALID
#REGION 10
RETURN

FUNCTION  CRDiaSemana
PARAMETERS ;
		PrmData
		PRIVATE LSdiaSemana

		DO CASE
			CASE DOW(PrmData) = 1
				LSdiaSemana	= "Domingo"
			CASE DOW(PrmData) = 2
				LSdiaSemana	= "Segunda"
			CASE DOW(PrmData) = 3
				LSdiaSemana	= "Terca"
			CASE DOW(PrmData) = 4
				LSdiaSemana	= "Quarta"
			CASE DOW(PrmData) = 5
				LSdiaSemana	= "Quinta"
			CASE DOW(PrmData) = 6
				LSdiaSemana	= "Sexta"
			CASE DOW(PrmData) = 7
				LSdiaSemana	= "Sabado"
		ENDCASE
RETURN(LSdiaSemana)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4OV           CRVerifTxsVendor VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   37  º
*       º Variable:            CRVerifTxsVendor                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      360                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4ov     &&  CRVerifTxsVendor VALID
#REGION 10
RETURN

FUNCTION  CRVerifTxsVendor
*-----------------------------------*
PARAMETERS PrmEmpresa,;
		   PrmDtEmi,;
		   PrmPrazo


	PRIVATE LFretorno
	PRIVATE m.dias
	PRIVATE m.dt_venc,m.Tp_Pessoa,m.AIA,m.AIOF,m.d,m.TX_JUROSCP,m.TX_JUROSVD
	
	m.dt_venc = {}
	m.Tp_Pessoa = 1
	m.AIA = 0
	m.AIOF= 0
	m.d   = 0
	m.TX_JUROSCP=0
	m.TX_JUROSVD=0
	LFretorno = .t.
	*--------------------------------------------------*

	=W_DEFPROC("duplicat.spr")
	LNqtdeParcelas= CRQtdeParcelas(PrmPrazo)

	*--------------------------------------------------*


	FOR X = 1 TO LNqtdeParcelas
			

		=W_DEFPROC("duplicat.spr")
		m.dias= CRDiasParcela(X,PrmPrazo)

		m.dt_venc = PrmDtEmi + m.dias 		
		=W_DEFPROC("duplicat.spr")
		m.dt_venc=CRajustaVenc(m.dt_venc,"+")


		=W_DEFPROC("duplicat.spr")
		IF !CRtxsVendor(PrmEmpresa,PrmDtEmi,m.dt_venc,m.Tp_Pessoa,;
		  		AIA,;
		  		AIOF,;
		  		d,;
		  		m.TX_JUROSCP,;
		  		m.TX_JUROSVD)

			LFretorno = .f.
		ENDIF
	NEXT

RETURN(LFretorno)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4OW           CRgeraDE12MAR08 VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   38  º
*       º Variable:            CRgeraDE12MAR08                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      361                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4ow     &&  CRgeraDE12MAR08 VALID
#REGION 10
RETURN
*********************************************************************
*  CRgeradupl.....: Gera duplicatas
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Duplicat
*                   Empresa
*                   Orcament
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.: do CRgeradupl with LNemp,LNorcamento
*---------------------------------------------------------------

PROCEDURE CRgeraDE12MAR08		&& USADA EM SCGC201, SCGCF201, SCGC201A
	
	PARAMETERS LNEmp,LNOrcamento, PrmImpBoleto
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE nota	&& O NUMERO DA NOTA DEVE SER O DA 1a NOTA CASO
					&& TENHAM SIDO GERADAS DUAS COM BASE NO MESMO ORCAMENTO
					&& PARA EVITAR INFLUENCIA NO AMBENTE NOTA E PRIVATE

	PRIVATE 	LNocorrenc, LNposic, LNinicio, LNnumpgt, LNdias, LNserie
	PRIVATE 	CVSTR1,CVSTR2,LNvlrdupl,LNdifere

	PRIVATE	empresa,duplicata,dt_emi,multa_prv,mora_prv,bonus_prv,;
			prem_pont,vlr_fatura,portador,tp_cobranc,;
			desconto,regiao,natu,nome,tp_cobranc

	PRIVATE dt_venc, dtproxproc
	PRIVATE LNtmp,banco

   	PRIVATE LNTp_parcela,LNbanco,LNvlrent,LSprazo,LDdtemi,LNmulta,LNmora
  	PRIVATE LNbonus,LNPremPont,LNRegiao,LNnatureza,LSnome,LNvlrfatura	
    PRIVATE LNnronota	

	PRIVATE LFduplicata,LFempresa,LForcamento,LFclienc,LForca_pgt
	PRIVATE LFclientes
	PRIVATE LSalias


	PRIVATE LNvl_issrtd
	*-----------------------------------------------------------*
	PRIVATE AIA,AIOF,d
	STORE 0 TO 	AIA,AIOF,D,m.TX_JUROSCP,m.TX_JUROSVD
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFduplicata	= NetArq("duplicat")
	LFempresa   = NetArq("Empresa" )
	LForcamento = NetArq("Orcament")
	LForca_pgt  = NetArq("orca_pgt")
	LFclienc    = NetArq("clienc")
	LFclientes  = NetArq("clientes")
	IF (LFduplicata+LFempresa+LForcamento+LForca_pgt) > 100000 OR ;
		(LFclientes+LFclienc) > 100000
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" 	  ,LFclienc )
		=UP_fecha("orca_pgt"  ,LForca_pgt )
		=UP_fecha("clientes"  ,LFclientes )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)


    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

	SELE orcament
*------------------------------------------------------------------*
* Condicao que evitava a geracao de duplicatas para vendas a vista
* retiradda em marco de 2012 pelo sergio para viabilizar a integracao
* dfis x dfin x paf e tabm facilitar a formacao do fluxo financeiro
* baseado nos titulos a receber e a pagar
*-------------------------------------------------------------------*
*	IF orcament.natu_oper <> 1  OR ;
*	   orcament.TP_PARCELA = 1 	&& So Gerar Duplicatas para
*								&& operacoes de Venda e Que
*								&&  Sejam a Prazo
 *
*-----------------------------------------------------------------*
	IF orcament.natu_oper <> 1
	   	&& So Gerar Duplicatas para
								&& operacoes de Venda

		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		=UP_fecha("orca_pgt"  ,LForca_pgt )
		=UP_fecha("clientes"  ,LFclientes )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF

	*----------------------------------------------------------------*
	wp_msg = "Gerando Duplicatas OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	LNcliente	= clienc.cliente	
   	LNTp_parcela= orcament.tp_parcela
   	LNbanco		= orcament.banco
   	LNvlrent	= orcament.vlr_ent
   	LSprazo		= orcament.prazo
   	LDdtemi		= orcament.dt_fat
  	LNmulta		= empresa.multa
  	LNmora		= empresa.mora
  	LNbonus		= empresa.bonus
  	LNPremPont	= empresa.prem_pont
  	LNRegiao	= clienc.regiao
	LNnatureza	= clienc.natu_cli
	m.tp_pessoa = clienc.tp_pessoa	
	m.FlgImbuteIOF = orcament.FlgImbuteI
	LSnome		= clienc.nome
	LNvlrfatura	= orcament.valor
	LNnronota	= orcament.nota


	LNvl_issrtd = orcament.vlr_issrtd



	SELECT &LSalias

	*-----------------------------------------------------------*
	*   Garante a Elimina‡Æo de Registros de Duplicatas Deixados
	* por falha
	*-----------------------------------------------------------*
	=CRcancdupl((LNemp),(LNnronota))
	*-----------------------------------------------------------*
	m.empresa	= LNemp
	m.nota		= LNnronota						
	m.duplicata	= LNnronota
	m.cliente	= LNcliente
	m.dt_emi	= LDDtemi
	m.multa_prv	= LNmulta
	m.mora_prv	= LNmora
	m.bonus_prv	= LNbonus
	m.prem_pont	= LNPremPont
	m.vlr_fatura= LNvlrfatura

	m.vlr_encarg = 0
	m.vlr_encbco = 0
    m.vlr_ioffnc = 0
	m.TotVlVendr = 0


	IF m.FlgImbuteIOF = .T.
		m.iof_fin = 1
	ELSE
		m.iof_fin = 1
	ENDIF


	DO CASE
		CASE LNTp_parcela = 6
			m.tp_cobranc	= 06	&& VENDOR
			m.flg_vendor    = 	.T.
		OTHERWISE
			m.tp_cobranc= 01	&& SIMPLES
			m.flg_vendor    = 	.F.
	ENDCASE


	m.desconto  = 0
	m.regiao    = LNregiao
	m.natu      = LNnatureza
	m.nome      = LSnome

	*-----------------------------------------------------------*
	*   Tratando os Registro Referentes a Entradas (MODO_PGTO = 1)
	*-----------------------------------------------------------*

	LNserie	   	= 1		&& Diferenciador do Numero da Duplicata
						&& 0 a 9
	SELE orca_pgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(LNEmp,3)+STR(LNOrcamento,6)
	SET NEAR OFF

	DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
					AND LNorcamento = orca_pgt.orcamento;
					AND orca_pgt.modo_pgto = 1

		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA


		IF LNemp = 10
		
		    && A IDL NAO POSSUI CONTROLE DE FATURAMENTO COM INFORMACOES
		    && SUFICIENTES PARA ORCAPGTO
		
			m.tp_parcela=  	3
			m.moeda 	=	3
		else
			m.tp_parcela=  	orca_pgt.tp_parcela
			m.moeda 	=	orca_pgt.moeda
		ENDIF

		IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
		               && Carteira e esta remete para
		               && Banco
			m.portador 	=  0   && CARTEIRA
		ELSE
			m.portador 	= orca_pgt.banco
		ENDIF

		m.banco 	=	orca_pgt.banco
		m.carteira  = ""
		m.variacao  = ""
		m.convenio  = ""
		m.conta     = ""
		m.conta_dv  = ""
		m.agencia   = 0
		
		
		*-----------------------------------------------*
        IF PrmImpBoleto = .F.
		    =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			   "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			     m.convenio,m.conta,m.conta_dv,;
			     m.agencia)
        ELSE
           =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			   "EMISSOR BOLETO", m.Carteira,m.Variacao,;
			     m.convenio,m.conta,m.conta_dv,;
			     m.agencia)
        ENDIF
		*-----------------------------------------------*

		
		m.vlr_doc	 =	orca_pgt.vlr_pgto - LNvl_issrtd
		m.vlr_issrtd =  LNvl_issrtd
		LNvl_issrtd  =  0
		m.dt_venc	=	m.dt_emi		
		m.obs =""


		m.vlr_pgto  =   0
   		m.dt_baixa  =   {}
   		m.dt_pgto   =   {}


		DO CASE
			CASE m.moeda = 4  &&	-Cheque Eletronico  : 	1 dia
				m.dt_venc	=	m.dt_emi + 1		
			CASE m.moeda = 5  &&	-CartÆo Rotativo 	:  31 dias	
				m.dt_venc	=	m.dt_emi + 31		
*------  a baixa sera feita no processo importacao caixa e processamento
*            OTHERWISE
*
 *         		m.vlr_pgto  =   m.vlr_doc
  *        		m.dt_baixa  =   m.dt_emi
   *       		m.dt_pgto   =   m.dt_emi
   *--------------------------------------------

		ENDCASE


		IF TYPE("orcament.AJSTFIMSEM") = "U"
			=CRajustaVenc(m.dt_venc,"+")
		ELSE
			IF orcament.AJSTFIMSEM <> "N"
				=CRajustaVenc(m.dt_venc,"+")
			ENDIF
		ENDIF

		

		SELE  duplicat
        SET ORDER TO TAG DOC
        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
        IF !FOUND()
			=edithand('SAVE')
		ENDIF

		
		
		LNserie    = LNserie + 1
		SELE orca_pgt
		SKIP
	ENDDO
	*-----------------------------------------------------------*
	*   Diferenciar Tratando das Parcelas de Acordo Com o Tipo de
	*  Parcelamento :
	*
	*		TP_PARCELA = 1 (A Vista)
	*			OBS: Neste Caso o Pgto com Cheque Eletronico ou
	*				CartÆo Rotativo SÆo Considerados A Prazo e
	*				Assumem Prazos Fixos Sendo:
	*					-Cheque Eletronico  : 	1 dia
	*					-CartÆo Rotativo 	:  31 dias	
	*
	*		TP_PARCELA <> 1 (Parcelados)		
	* 			OBS: Em Opera‡äes Realmente de Origem Parcelada os
	*               Registro Seguem o Prazo Que Estiver Estipulado
	*               no Campo Prazo da OSI e a Entrada (000/...) ‚
	*               Desconsiderada Por j  Ter Sido Tratada
	*					-Cheque          	:  ???/???/???/??? dias	
	*					-Duplicata          :  ???/???/???/??? dias	
	*					-CartÆo Parcelado	:  ???/???/???/??? dias	
	*
	*-----------------------------------------------------------*
	* Tratando os Registro Referentes a Parcelas (MODO_PGTO = 2)
	*-----------------------------------------------------------*
	* Determinando o Numero de Parcelas Especificadas (LNnumpgt)
	* Ex: "000/030/060/090/000/000 => 3 Parcelas (A Entrada ‚
	*                                              Desprezada)
	* Ex: "030/000/000/000/000/000 => 1 Parcela Sem Entrada
	*
	* Ex: "000/000/000/000/000/000 => 1 Parcela (Conta Apresenta‡Æo)
	*-----------------------------------------------------------*
	DO CASE
		CASE 	orcament.TP_PARCELA = 1 ;
			OR  orcament.TP_PARCELA = 5  && (A Vista / A Vista Com CartÆo)

			SELE orca_pgt
			SET ORDER TO TAG orca_pgto
			DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
					AND LNorcamento = orca_pgt.orcamento;
					AND orca_pgt.modo_pgto = 2

				m.duplicata	= ;
						INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
							  CHRTRAN(STR(LNserie,2)," ","0");
							  ))   && 1 => DUPLICATA

				m.tp_parcela=  	orca_pgt.tp_parcela
				m.moeda 	=	orca_pgt.moeda
				IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
				               && Carteira e esta remete para
				               && Banco
					m.portador 	=  0   && CARTEIRA
				ELSE
					m.portador 	= orca_pgt.banco
				ENDIF
				m.banco 	=	orca_pgt.banco

				m.vlr_doc	 =	orca_pgt.vlr_pgto - LNvl_issrtd
				m.vlr_issrtd =  LNvl_issrtd
				LNvl_issrtd  =  0



				m.vlr_pgto  =   0
				m.dt_venc	=	m.dt_emi		
				m.obs =""

				DO CASE
					CASE m.banco = 860  &&	Ticket CAR:prox 2F + 30dias
						Ctrdias = 0
						DO While dow(m.dt_emi+Ctrdias) <> 2
							Ctrdias = Ctrdias + 1
						ENDDO
						m.dt_venc	=	m.dt_emi + 30 + Ctrdias		
					CASE m.moeda = 4  &&	-Cheque Eletronico  : 	1 dia
						m.dt_venc	=	m.dt_emi + 1		
					CASE m.moeda = 5  &&	-CartÆo Rotativo 	:  31 dias	
						m.dt_venc	=	m.dt_emi + 31		
				ENDCASE

				IF TYPE("orcament.AJSTFIMSEM") = "U"
					=CRajustaVenc(m.dt_venc,"+")
				ELSE
					IF orcament.AJSTFIMSEM <> "N"
						=CRajustaVenc(m.dt_venc,"+")
					ENDIF
				ENDIF
				

				m.carteira  = ""
				m.variacao  = ""
				m.convenio  = ""
		        m.conta     = ""
		        m.conta_dv  = ""
		        m.agencia   = 0
				*-----------------------------------------------*

                IF PrmImpBoleto = .F.
		           =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			         "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			         m.convenio,m.conta,m.conta_dv,;
			         m.agencia)
                ELSE
                   =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
                     "EMISSOR BOLETO", m.Carteira,m.Variacao,;
			         m.convenio,m.conta,m.conta_dv,;
			         m.agencia)
                ENDIF

				*-----------------------------------------------*

				SELE  duplicat
		        SET ORDER TO TAG DOC
		        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
		        IF !FOUND()
					=edithand('SAVE')
				ENDIF


				LNserie    = LNserie + 1
				SELE orca_pgt
				SKIP
			ENDDO

		CASE	TP_PARCELA <> 1 		&& (Parcelados)		

			LNocorrenc 	= 1		&& 1¦,2¦,3¦... Ocorrencia do Char "/"
		    LNposic    	= 0     && Qual Posi‡Æo da Str Oocorre "/" 3,7,...
		    LNnumpgt   	= 0		&& Quantidade de Parcelas Fora Entrada
			LNdias	   	= 0		&& Dias de Prazo da Parcela
			LNproximodias	= 0  && Permite Diferenciar o
							 && Pgto com Entrada (000/031/000/000)
							 && do Pgto Conta Apresent‡Æo
							 && (000/000/000/...). No Primeiro Caso Quando
							 && LNdias = 0 (ou ser  a Entrada ou Invalido)
							 && e  nÆo ser  gerada Duplicatas. J  no
							 && Segundo Caso deve Ser Gerada Uma Dupl.
							 && Conta Apresenta‡Æo
		    LNinicio   	= 1
			*-----------------------------------------------------------*

			DO WHILE .t.
		        LNinicio   	= LNposic + 1
			    LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
				LNproximodias= INT(VAL(SUBS(LSprazo,LNinicio+4,3)))

	    		LNposic 	= AT("/",LSprazo, LNocorrenc)
				*-----------------------------------------------*
	  			IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
					EXIT
				ENDIF
				*-----------------------------------------------*
				*-----------------------------------------------*
				* LNdias = 0 AND LNproximodias => Conta Apresenta‡Æo
				*-----------------------------------------------*
				* 000/000/000/...  Conta Apresenta‡Æo
				*				LNnumpgt = 1
				*-----------------------------------------------*
				*-----------------------------------------------*
				IF LNdias = 0 AND LNproximodias > 0 && Descarte da
													&&  Entrada
					LNocorrenc 	= LNocorrenc + 1
				ELSE
					LNocorrenc 	= LNocorrenc + 1
			       	LNnumpgt   	= LNnumpgt + 1
				ENDIF
			ENDDO

			*-----------------------------------------------*
			SELE orca_pgt
			DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
							AND LNorcamento = orca_pgt.orcamento;
							AND orca_pgt.modo_pgto = 2
				SET DECIMALS TO 6
				*---------------------------------------------------*
				* Calculo de Diferenca Provocada na DivisÆo e Que ‚ Lan‡ada
				* na 1¦ Parcela
				*---------------------------------------------------*
			   	CVSTR1    = STR((orca_pgt.vlr_pgto) / (LNnumpgt) ,25,11)
			   	CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   			LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
			   	LNdifere  = orca_pgt.vlr_pgto - (LNvlrdupl * LNnumpgt)
				*---------------------------------------------------*
				LNocorrenc 		= 1
			    LNposic    		= 0
				LNdias			= 0
				LNproximodias	= 0  && Permite Diferenciar o
							 && Pgto com Entrada (000/031/000/000)
							 && do Pgto Conta Apresent‡Æo
							 && (000/000/000/...). No Primeiro Caso Quando
							 && LNdias = 0 (ou ser  a Entrada ou Invalido)
							 && e  nÆo ser  gerada Duplicatas. J  no
							 && Segundo Caso deve Ser Gerada Uma Dupl.
							 && Conta Apresenta‡Æo
			    LNinicio   	= 1

				DO WHILE .t.
					LNinicio = LNposic + 1										
			        LNdias       = INT(VAL(SUBS(LSprazo,LNinicio,3)))
					LNproximodias= INT(VAL(SUBS(LSprazo,LNinicio+4,3)))

			        LNposic = AT("/",LSprazo, LNocorrenc)  && PASSA PARA
			        									 && PROXIMA POSICAO
			        									 && DE INICIO DA
			        									 && DIA
					*-----------------------------------------------*
			   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
						EXIT
					ENDIF

					*-----------------------------------------------*
					* LNdias = 0 AND LNproximodias => Conta Apresenta‡Æo
					*-----------------------------------------------*
					IF LNdias = 0 AND LNproximodias > 0 && Descarte da
														&&  Entrada
						LNocorrenc = LNocorrenc + 1
						LOOP
					ENDIF
					**************************************************




					m.duplicata	= ;
					   INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
							  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA





					m.tp_parcela= orca_pgt.tp_parcela
					m.moeda 	= orca_pgt.moeda

					IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
					               && Carteira e esta remete para
					               && Banco
						m.portador 	=  0   && CARTEIRA
					ELSE
						m.portador 	= orca_pgt.banco
					ENDIF



					***m.vlr_doc  	= LNvlrdupl + LNdifere


					m.vlr_doc	 =	LNvlrdupl - LNvl_issrtd + LNdifere

					m.vlr_issrtd =  LNvl_issrtd
					LNvl_issrtd  =  0



					m.vlr_pgto  = 0
					LNdifere   	= 0			&& Proxima nÆo agrega Diferen‡a
					m.dt_venc  	= m.dt_emi + LNdias


					IF TYPE("orcament.AJSTFIMSEM") = "U"
						=CRajustaVenc(m.dt_venc,"+")
					ELSE
						IF orcament.AJSTFIMSEM <> "N"
							=CRajustaVenc(m.dt_venc,"+")
						ENDIF
					ENDIF

					*--------------------------------------------------*
					*CALCULO  VENDOR--*
					*--------------------------------------------------*
		 			m.VLR_COMPRA = orcament.valor

					m.vlr_encarg = 0
				    m.vlr_ioffnc = 0
					m.TotVlVendr = 0

					IF m.tp_parcela = 6   && VENDOR


						=W_DEFPROC("duplicat.spr")
						IF !CRtxsVendor(m.Empresa,m.Dt_Emi,;
								m.dt_venc,m.Tp_Pessoa,;
						  		AIA,;
						  		AIOF,;
						  		d,;
						  		m.TX_JUROSCP,;
						  		m.TX_JUROSVD)

							STORE 0 TO 	AIA,AIOF,m.TX_JUROSCP,m.TX_JUROSVD
						ENDIF


			 			
						=W_DEFPROC("duplicat.spr")
						=CRcalcVendor(m.Empresa,;
							m.vlr_doc,;
							m.dt_emi,;
							m.dt_venc,;
							m.Tp_Pessoa,;
	   			    		m.FlgImbuteIOF,;
			        		m.vlr_encarg,;
    			    		m.vlr_ioffnc,;
	        				m.TotVlVendr,;
	        				m.vlr_encbco)
					ENDIF

					*--------------------------------------------------*
					*--------------------------------------------------*
					*--------------------------------------------------*


					m.obs =""
					m.dtproxproc= m.dt_venc
					*---------------------------------------------------*		
					* EM COMPRAS A PRAZO COM A 1a DUPLICATA (TP_PARCELA = 3)
					*   COMO CONTA APRESENTACAO, ESTA 1a E
					* 	DIRECIONADA P/ A CARTEIRA E A DEMAIS
					* 	P/ O BANCO SOLICITADO. LNbanco GUARDO O
					* 	BANCO SOLICITADO P/ USO APOS GERAR A 1a
					*---------------------------------------------------*
					LNtmp  = m.dt_venc - m.dt_emi
				    IF  LNtmp <= 7  AND orca_pgt.tp_parcela = 3
	    						    && DUPLICATA CONTA APRESENTACAO
						m.banco = 0		 	&& DIRECIONA P/ CARTEIRA
					ELSE
						m.banco = orca_pgt.banco
										 && DIRECIONA P/ BANCO SOLICITADO	
					ENDIF

					m.carteira  = ""
					m.variacao  = ""
					m.convenio  = ""
		            m.conta     = ""
		            m.conta_dv  = ""
                    m.agencia   = 0
					*-----------------------------------------------*

                    IF PrmImpBoleto = .F.
	  	              =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			           "GERADOR DUPLICATA",;
			                m.Carteira,m.Variacao,;
			                m.convenio,m.conta,m.conta_dv,m.agencia)
                    ELSE
                      =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
                       "EMISSOR BOLETO", m.Carteira,m.Variacao,;
			                m.convenio,m.conta,m.conta_dv,m.agencia)
                    ENDIF

					*-----------------------------------------------*


					SELE  duplicat
			        SET ORDER TO TAG DOC
			        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
			        IF !FOUND()
						=edithand('SAVE')
					ENDIF

					LNserie    = LNserie + 1
					LNocorrenc = LNocorrenc + 1
				ENDDO
				SELE orca_pgt
				SKIP
			ENDDO

	ENDCASE

	*-----------------------------------------------------------*
	SET DECIMALS TO 2
	=UP_fecha("duplicat"  ,LFduplicata )
	=UP_fecha("empresa"   ,LFempresa   )
	=UP_fecha("orcamento" ,LForcamento )
	=UP_fecha("clienc" ,LFclienc )
	=UP_fecha("orca_pgt"  ,LForca_pgt )
	=UP_fecha("clientes"  ,LFclientes )
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4Q2           CRIDLApos26geradupl VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   39  º
*       º Variable:            CRIDLApos26geradupl                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      362                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4q2     &&  CRIDLApos26geradupl VALID
#REGION 10
RETURN
*********************************************************************
*  CRgeradupl.....: Gera duplicatas Para filiais que ainda nao registram
*              duplicatas para operacoes a vista e nao tratam a TABELA
* 				ORCA_PGT (Implantados pela Reestrutura‡Æo em Jan/01)
*           Ap¢s a Atualiza‡Æo do Sistema Na Filial a Gera‡Æo de Duplicatas
*           Ser  Realizada Pela Rotina Homonima  CRgeradupl
*
*********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Duplicat
*                   Empresa
*                   Orcament
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.: do CRgeradupl with LNemp,LNorcamento
*---------------------------------------------------------------

PROCEDURE CRIDLApos26geradupl		&& USADA EM SCGC201, SCGCF201, SCGC201A
	
	PARAMETERS LNEmp,LNOrcamento
	
	=W_DEFPROC("rotinas.spr")

	PRIVATE nota	&& O NUMERO DA NOTA DEVE SER O DA 1a NOTA CASO
					&& TENHAM SIDO GERADAS DUAS COM BASE NO MESMO ORCAMENTO
					&& PARA EVITAR INFLUENCIA NO AMBENTE NOTA E PRIVATE

	PRIVATE 	LNocorrenc, LNposic, LNinicio, LNnumpgt, LNdias, LNserie
	PRIVATE 	CVSTR1,CVSTR2,LNvlrdupl,LNdifere

	PRIVATE	empresa,duplicata,dt_emi,multa_prv,mora_prv,bonus_prv,;
			prem_pont,vlr_fatura,portador,tp_cobranc,;
			desconto,regiao,natu,nome,tp_cobranc

	PRIVATE dt_venc, dtproxproc
	PRIVATE LNtmp,banco

   	PRIVATE LNTp_Parcela,LNbanco,LNvlrent,LSprazo,LDdtemi,LNmulta,LNmora
  	PRIVATE LNbonus,LNPremPont,LNRegiao,LNnatureza,LSnome,LNvlrfatura	
    PRIVATE LNnronota	

	PRIVATE LFduplicata,LFempresa,LForcamento,LFclienc
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFduplicata	= NetArq("duplicat")
	LFempresa   = NetArq("Empresa" )
	LForcamento = NetArq("Orcament")
	LFclienc    = NetArq("clienc")
	IF (LFduplicata+LFempresa+LForcamento) > 100000
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)


	IF orcament.natu_oper <> 1		&& So Gerar Duplicatas para
									&& operacoes de Venda
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF

	*----------------------------------------------------------------*
	wp_msg = "Gerando Duplicatas OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	LNcliente	= clienc.cliente	
   	LNTp_parcela= orcament.tp_parcela
   	LNbanco		= orcament.banco
   	LNvlrent	= orcament.vlr_ent
   	LSprazo		= orcament.prazo
   	LDdtemi		= orcament.dt_fat
  	LNmulta		= empresa .multa
  	LNmora		= empresa .mora
  	LNbonus		= empresa .bonus
  	LNPremPont	= empresa .prem_pont
  	LNRegiao	= clienc.regiao
	LNnatureza	= clienc.natu_cli
	LSnome		= clienc.nome
	LNvlrfatura	= orcament.valor
	LNnronota	= orcament.nota
	SELECT &LSalias

*************

	*-----------------------------------------------------------*

	=CRcancdupl((LNemp),(LNnronota))
	
	*---------------------------------------------------------------*
	*    Venda a Vista ou Parcelada no Cartao nao geram duplicatas
	*---------------------------------------------------------------*

	IF LNtp_parcela = 1   && VENDA A VISTA
		RETURN
	ENDIF
*
	LNocorrenc 	= 1
    LNposic    	= 0
    LNinicio   	= 1
    LNnumpgt   	= 0
	LNdias	   	= 0
	LNserie	   	= 1
		
	DO WHILE .t.
        LNposic = AT("/",LSprazo, LNocorrenc)
        LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
******************************************************************
   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
			EXIT
		ENDIF
******************************************************************
		IF LNdias = 0 AND LNnumpgt > 0
	        LNnumpgt   = LNnumpgt
		ELSE			
	        LNnumpgt   = LNnumpgt + 1
		ENDIF
		LNocorrenc = LNocorrenc + 1
        LNinicio   = LNposic + 1
	ENDDO

	SET DECIMALS TO 6
	
	IF LNvlrent > 0 AND LNnumpgt > 1
	   CVSTR1    = STR((LNvlrfatura - LNvlrent) / (LNnumpgt - 1) ,25,11)
	   CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
	   LNdifere  = LNvlrfatura - (LNvlrdupl * (LNnumpgt - 1) + LNvlrent)
    ELSE
	   CVSTR1    = STR((LNvlrfatura) / (LNnumpgt) ,25,11)
	   CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
	   LNdifere  = LNvlrfatura - (LNvlrdupl * LNnumpgt)
	ENDIF

	**>>>>>

	m.empresa	= LNemp
	m.nota		= LNnronota						
	m.duplicata	= LNnronota
	m.cliente	= LNcliente
	m.dt_emi	= LDDtemi
	m.multa_prv	= LNmulta
	m.mora_prv	= LNmora
	m.bonus_prv	= LNbonus
	m.prem_pont	= LNPremPont
	m.vlr_fatura= LNvlrfatura
	m.vlr_pgto  =   0
	
	DO CASE
		CASE LNbanco = 898
			m.portador = 898
		CASE LNbanco >= 850 AND  LNbanco <= 857     &&CARTAO
			m.portador = LNbanco	
		OTHERWISE
			m.portador	= 0
	ENDCASE


    && A IDL NAO POSSUI CONTROLE DE FATURAMENTO COM INFORMACOES
    && SUFICIENTES PARA ORCAPGTO
		
	m.tp_parcela=  	3
	m.moeda 	=	3

	m.tp_cobranc= 01
	m.desconto  = 0
	m.regiao    = LNregiao
	m.natu      = LNnatureza
	m.nome      = LSnome
	m.tp_cobranc= 01 		  && COB. SIMPLES

	**>>>>>

	LNocorrenc = 1
    LNposic    = 0
    LNinicio   = 1
	LNdias		= 0

	DO WHILE .t.
        LNposic = AT("/",LSprazo, LNocorrenc)
        LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
		**************************************************

   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
			EXIT
		ENDIF

		**************************************************
		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA
		IF LNvlrent > 0 AND LNnumpgt > 1
			m.vlr_doc 	 = LNvlrent
			LNvlrent = 0
		ELSE
			m.vlr_doc  = LNvlrdupl + LNdifere
			LNdifere   = 0
		ENDIF
		m.dt_venc  = m.dt_emi + LNdias
		m.dtproxproc  = m.dt_venc
		m.obs =""

		*---------------------------------------------------*		
		* 		EM COMPRAS A PRAZO COM A 1a DUPLICATA A
		* 	VISTA OU CONTA APRESENTACAO, ESTA 1a E
		* 	DIRECIONADA P/ A CARTEIRA E A DEMAIS
		* 	P/ O BANCO SOLICITADO. LNbanco GUARDO O
		* 	BANCO SOLICITADO P/ USO APOS GERAR A 1a
		*---------------------------------------------------*


		LNtmp  = m.dt_venc - m.dt_emi
	    if  LNtmp <= 7  AND LNbanco <> 900 AND LNbanco <> 898 ;
			 AND LNbanco <> 851 AND  LNbanco <> 852;
			 AND LNbanco <> 853 AND  LNbanco <> 854;
			 AND LNbanco <> 855 AND  LNbanco <> 856;
			 AND LNbanco <> 857 AND  LNbanco <> 858;
			 AND LNbanco <> 861 AND  LNbanco <> 862;
			 AND LNbanco <> 863 AND  LNbanco <> 865

	    						     && CONTA APRESENTACAO
			m.banco = 0			     && DIRECIONA P/ CARTEIRA
		ELSE
			m.banco = LNbanco   && DIRECIONA P/ BANCO SOLICITADO	
		ENDIF

		
		SELE  duplicat
        SET ORDER TO TAG DOC
        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
        IF !FOUND()
			=edithand('SAVE')
		ENDIF

		SELE orcament

		LNserie    = LNserie + 1
		LNocorrenc = LNocorrenc + 1
        LNinicio   = LNposic + 1
	ENDDO
	SET DECIMALS TO 2
	=UP_fecha("duplicat"  ,LFduplicata )
	=UP_fecha("empresa"   ,LFempresa   )
	=UP_fecha("orcamento" ,LForcamento )
	=UP_fecha("clienc" ,LFclienc )
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4QI           CRAtrzcancdupl VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   40  º
*       º Variable:            CRAtrzcancdupl                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      363                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4qi     &&  CRAtrzcancdupl VALID
#REGION 10
RETURN

FUNCTION  CRAtrzcancdupl

PARAMETERS LNemp,LNorcamento
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LFretorno


	PRIVATE ARQ_CtrlRefn,ALS_CtrlRefn

	LFretorno = .t.

	SELE duplicat

	SET ORDER TO REFR_ORCA
	SEEK STR(LNemp,3)+STR(LNorcamento,6)

	DO WHILE !EOF() AND LNorcamento = duplicat.orcamento

		IF not empty(duplicat.vlr_pgto)
			LFretorno = .F.
			EXIT
		ENDIF
		SELE duplicat
		SKIP
	ENDDO
	SELE DUPLICAT	
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4QJ           CRdefcarteira VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   41  º
*       º Variable:            CRdefcarteira                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      364                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4qj     &&  CRdefcarteira VALID
#REGION 10
RETURN

FUNCTION  CRdefcarteira

PARAMETERS PrmEmpresa,PrmBanco,PrmTp_Parcela,PrmChamada,;
           RtnCarteira,RtnVariacao,RtnConvenio,;
           RtnConta,RtnConta_dv,RtnAgencia,RtnDv_Agencia

	*------------------------------------------*
	*  PrmChamada deve informar um dos valres
	* abaixo:
	*         "GERADOR DUPLICATA"
	*         "EMISSOR BOLETO"
	*------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSmsg
	PRIVATE LSalias


    PRIVATE ARQ_Cobranca,ALS_Cobranca
	
    LSAlias      = Alias()


    ARQ_Cobranca     = NetArqAgain("Cobranca")
    ALS_Cobranca     = Alias()

	*------------------------------------------------------------*
	DO CASE
		CASE PrmChamada = "GERADOR DUPLICATA"


			SELE &ALS_Cobranca
			SET ORDER TO TAG operacao
			IF  PrmTP_PARCELA = 6  && VENDOR
		
				IF PrmEMPRESA = 1
					seek str(PrmEmpresa,3) + STR(PrmBANCO,3) + ;
		        	"BOLETO BANCO  "
				ELSE
					seek str(PrmEmpresa,3) + STR( PrmBANCO,3) + ;
	        		"BOLETO VENDOR "
				ENDIF	
		
			ELSE
				seek str(PrmEmpresa,3) + STR(PrmBANCO,3) + ;
		        "BOLETO BANCO"
			ENDIF		


		OTHERWISE   && => PrmChamada = "EMISSOR BOLETO"

			SELE &ALS_Cobranca
			SET ORDER TO TAG operacao
			IF  PrmTP_PARCELA = 6  && VENDOR
		
				IF PrmEMPRESA = 1
					seek str(PrmEmpresa,3) + STR(PrmBANCO,3) + ;
		        	"BOLETO EMPRESA"
				ELSE
					seek str(PrmEmpresa,3) + STR( PrmBANCO,3) + ;
	        		"BOLETO VENDOR "
				ENDIF	
		
			ELSE
				seek str(PrmEmpresa,3) + STR(PrmBANCO,3) + ;
	        	"BOLETO EMPRESA"
			ENDIF		
	ENDCASE

    IF !FOUND()
	   SET ORDER TO TAG COBRANCA
	   seek str(PrmEmpresa,3) + STR(PrmBANCO,3)
    ENDIF

	if FOUND()
		RtnCarteira  = &ALS_Cobranca .carteira
		RtnVariacao  = &ALS_Cobranca .variacao
		RtnConvenio  = &ALS_Cobranca .convenio
        RtnConta     = &ALS_Cobranca .conta
        RtnConta_dv  = &ALS_Cobranca .conta_dg 		
        RtnAgencia   = ALLTRIM( &ALS_Cobranca .agencia)
        RtnAgencia   = int(val(RtnAgencia))

        RtnDv_Agencia= ALLTRIM( &ALS_Cobranca .agencia_dg)
	ELSE
		RtnCarteira  = ""
		RtnVariacao  = ""
		RtnConvenio  = ""
        RtnConta     = ""
        RtnConta_dv  = ""
        RtnAgencia   = 0

        RtnDv_Agencia= ""
    ENDIF

    =up_fecha("&ALS_Cobranca")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4QK           CRDupgeraboleto VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   42  º
*       º Variable:            CRDupgeraboleto                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      365                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4qk     &&  CRDupgeraboleto VALID
#REGION 10
RETURN

FUNCTION  CRDupgeraboleto
PARAMETERS PrmEmpresa,PrmDuplicata

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*



	PRIVATE LNBol_ordem

    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_Boleto  ,ALS_Boleto

    LSAlias      = Alias()

    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()


    ARQ_Boleto       = NetArqAgain("Boleto",.T.) && EXCLUSIVO
    ALS_Boleto       = Alias()


	*------------------------------------------------------------*
	SELE &ALS_Boleto
	DELETE ALL FOR BOL_ORDEM > 96 AND BOL_ORDEM < 9998
	PACK
	REINDEX
	*------------------------------------------------------------*
	

	LNBol_ordem = 97
	
	IF CRGrvBoleto(PrmEmpresa,PrmDuplicata,LNBol_ordem)
		SELE &ALS_Boleto
		COPY FIELDS bol_linha ;
	       TO "L:\TMP\PRTBOLET.XML" ;
		      TYPE SDF
	ENDIF



	*------------------------------------------------------------*

    =up_fecha("&ALS_Duplicat")
    =up_fecha("&ALS_boleto")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4QL           CRGrvBoleto VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   43  º
*       º Variable:            CRGrvBoleto                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      366                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4ql     &&  CRGrvBoleto VALID
#REGION 10
RETURN

FUNCTION  CRGrvBoleto
PARAMETERS PrmEmpresa,PrmDuplicata, LNBol_ordem



	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNdup

	PRIVATE LSnota      && STRING COM NUMERO DA NOTA PARA COMPARACAO
	PRIVATE LSnotaDaDup && STRING COM NUMERO DA NOTA RETIRADO DO NUMERO
						&& DA DUPLICATA


	PRIVATE LSmsg
	PRIVATE LSalias
	PRIVATE LScarteira
	PRIVATE LSvariacao


    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Clientes,ALS_Clientes
    PRIVATE ARQ_Cobranca,ALS_Cobranca

***    PRIVATE ARQ_Boleto  ,ALS_Boleto  && VEM DA ROTINA CHAMADORA
	

    LSAlias      = Alias()


    ARQ_Empresa      = NetArqAgain("Empresa")
    ALS_Empresa      = Alias()

    ARQ_Clientes     = NetArqAgain("Clientes")
    ALS_Clientes     = Alias()

    ARQ_Cobranca     = NetArqAgain("Cobranca")
    ALS_Cobranca     = Alias()




	SELE &ALS_Empresa
	SET ORDER TO TAG empresa
	SEEK PrmEmpresa


	*------------------------------------------------------------*
	
	
	



	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(PrmDuplicata,9)
	IF FOUND()
		LFdados = .t.
		
		SELE &ALS_Clientes
		SET ORDER TO TAG cliente
		SEEK  &ALS_Duplicat .cliente


		SELE &ALS_Cobranca
		SET ORDER TO TAG operacao
		IF  &ALS_dUPLICAT .TP_PARCELA = 6  && VENDOR
		
			IF &ALS_dUPLICAT .EMPRESA = 1
				seek str(PrmEmpresa,3) + STR( &ALS_dUPLICAT .BANCO,3) + ;
		        	"BOLETO EMPRESA"
			ELSE
				seek str(PrmEmpresa,3) + STR( &ALS_dUPLICAT .BANCO,3) + ;
		        	"BOLETO VENDOR "
			ENDIF	
	
		ELSE
			seek str(PrmEmpresa,3) + STR( &ALS_dUPLICAT .BANCO,3) + ;
		        "BOLETO EMPRESA"
		ENDIF		
		


		if !FOUND() OR EMPTY( &ALS_Cobranca .DT_VIGOR) ;
		    OR wp_dtoper < &ALS_Cobranca .DT_VIGOR

           LSmsg = STR( &ALS_dUPLICAT .BANCO,3)
		   DO OBJ_ALER.SPR WITH ;
		   "EmissÆo de Boleto nao esta em vigor para banco "+ LSmsg
			SELE &ALS_Duplicat
			RETURN(.F.)
*			SKIP
*			LOOP
		ENDIF

		=RLOCK()




		*---------------------------------*
		* APLICACAO DE REAJUSTE INCC
		*---------------------------------*

		IF &ALS_Duplicat .tp_parcela =  7 && AJUSTE INCC

			PRIVATE RtnvlrCorrigido
			RtnvlrCorrigido = 0
			
			=W_DEFPROC("TABINCC.SPR")
			IF !NCAplicaINCC( &ALS_Duplicat .dt_emi,;
						   &ALS_Duplicat .dt_venc,;
	                       &ALS_Duplicat .vlrparcini,;
						   RtnvlrCorrigido)

			   DO OBJ_ALER.SPR WITH ;
			   "Falaha calculo INCC "
				RETURN(.F.)
*				SKIP
*				LOOP
			ENDIF

			REPLACE &ALS_Duplicat .VLR_DOC   WITH RtnvlrCorrigido
						
		ENDIF



		*---------------------------------------------------*

		LScarteira	= 	&ALS_cobranca .carteira
		LSvariacao  =	&ALS_cobranca .variacao

		*---------------------------------------------------*

		SELE &ALS_Boleto
		*------------------ preenchimento ------------------*

		m.bol_ordem = LNbol_ordem

		if empty(alltrim(&ALS_Duplicat .NUM_NO_BCO))

			DO CASE
				CASE &ALS_Duplicat .BANCO = 001
				 LSnossoNumero = ;
					 CR_001geraNssNro(PrmEmpresa, 001,LScarteira,LSvariacao)
				CASE &ALS_Duplicat .BANCO = 237
				  LSnossoNumero = ;
				     CR_237geraNssNro(PrmEmpresa, 237,LScarteira,LSvariacao)
			ENDCASE
		ELSE		
			LSnossoNumero = &ALS_Duplicat .NUM_NO_BCO
		ENDIF


		LSnossoNumero = CHRTRAN(LSnossoNumero," ","0")

		m.bol_linha = ;
		    '<ROW NossoNumero="'+LEFT(LSnossoNumero,11) +'"'+chr(13)

		SELE &ALS_Boleto

		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1

		*---------------------------------------------------*			
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' NumeroDocumento="'+;
		    STR( &ALS_Duplicat .duplicata,13)+'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' EspecieDocumento="edDuplicataMercantil"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' AceiteDocumento="adNao"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		m.bol_ordem = LNbol_ordem

		m.bol_linha = ;
			' Carteira="'+ ;
			&ALS_cobranca .carteira + ;
			&ALS_cobranca .variacao +   '"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1

		*------------------  CEDENTE -----------------------*			


		m.bol_ordem = LNbol_ordem
	
		DO CASE
				CASE &ALS_Duplicat .BANCO = 001
					m.bol_linha = ;
				    ' LocalPagamento=;
	        		 "PAGAVEL EM QUALQUER BANCO ATE O VENCIMENTO"'+chr(13)

				CASE &ALS_Duplicat .BANCO = 237
					m.bol_linha = ;
				    ' LocalPagamento=;
					"ATE O VENCIMENTO PREFERENCIALMENTE NO"+;
					" BRADESCO.VENCIDO, SOMENTE NO BRADESCO"'+chr(13)
		ENDCASE

		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem


		LScgc = TRANSFORM(STR(&ALS_empresa .CGC,14),"@R 99.999.999/9999.99")
		m.bol_linha = ;
	     ' Cdnt_Nome="'+ ALLTRIM( &ALS_empresa .nome );
					+'-'+ALLTRIM( &ALS_empresa .sigla );
					+'-'+LScgc;
		     +'"'+chr(13)


		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' CodigoCedente="'+  &ALS_cobranca .codcedente +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ' Cdnt_DigitoCodigoCedente="'+;
		          &ALS_cobranca .digcedente +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Cdnt_BancoCodigo="'+STR(  &ALS_cobranca .banco,3) +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Cdnt_CodigoAgencia="'+  &ALS_cobranca .agencia +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Cdnt_DigitoAgencia="'+  &ALS_cobranca .agencia_dg +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Cdnt_NumeroConta="'+  &ALS_cobranca .conta +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Cdnt_DigitoConta="'+  &ALS_cobranca .conta_dg +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.cpf_cgc = chrtran(str( &ALS_Clientes .cliente,14)," ","0")
		IF EMPTY(ALLTRIM( &ALS_Clientes .cbnome)) OR ;
		   EMPTY(ALLTRIM( &ALS_Clientes .cbendereco))
			m.nome	    =  &ALS_Clientes .nome
			m.endereco 	=  &ALS_Clientes .endereco
			m.bairro	=  &ALS_Clientes .bairro
			m.cidade	=  &ALS_Clientes .cidade
			m.estado	=  &ALS_Clientes .estado
			m.cep		=  &ALS_Clientes .cep
		ELSE
			m.nome	    =  &ALS_Clientes .CBnome
			m.endereco 	=  &ALS_Clientes .CBendereco
			m.bairro	=  &ALS_Clientes .CBbairro
			m.cidade	=  &ALS_Clientes .CBcidade
			m.estado	=  &ALS_Clientes .CBestado
			m.cep		=  &ALS_Clientes .CBcep
		ENDIF

		IF  &ALS_Clientes .tp_pessoa = 1
			LScgc = "-"+;
				TRANSFORM(STR( &ALS_Clientes .cliente ,14),;
							"@R 99.999.999/9999.99")
		ELSE
			LScgc = "-"+;
				TRANSFORM(STR( &ALS_Clientes .cliente ,14),;
							"@R 999.999.999.999-99")
		ENDIF

		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_Nome="'+m.nome+LScgc+'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_NumeroCPFCGC="'+m.cpf_cgc +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		IF &ALS_Clientes .tp_pessoa = 1
			m.bol_linha = ;
		    ' Scdo_TipoInscricao="tiPessoaFisica"'+chr(13)
		ELSE
			m.bol_linha = ;
			    ' Scdo_TipoInscricao="tiPessoaJuridica"'+chr(13)
		ENDIF


		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_Bairro="'+ m.bairro +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_CEP="'+ m.CEP +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_Cidade="'+ m.cidade +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_Complemento=" "'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_email= " "'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_Estado="'+ m.estado +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Scdo_Rua="'+ m.endereco +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*-------------------- datas ---------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' DataAbatimento="00000000"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

	*	m.bol_ordem = LNbol_ordem
	*	m.bol_linha = ;
	*	    ' DataAbatimento="00000000"'+chr(13)
	*	=edithand('SAVE')
	*	LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' DataDesconto="00000000"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem

		Ldata = CHRTRAN(DTOC( &ALS_Duplicat .DT_EMI),".","")
		Ldata = CHRTRAN(Ldata,"/","")

		m.bol_linha = ;
		    ' DataDocumento="'+Ldata+'"'+chr(13)


		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem


		Ldata = CHRTRAN(DTOC( &ALS_Duplicat .DT_VENC+1),".","")
		Ldata = CHRTRAN(Ldata,"/","")

		m.bol_linha = ;
		    ' DataMoraJuros="'+Ldata+'"'+chr(13)
		=edithand('SAVE')
		
		
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem


		LNdias = 0
		Ldata =  &ALS_Duplicat .DT_VENC
		DO WHILE LNdias < 5
		    Ldata =  Ldata + 1
			IF dow(Ldata) <> 1 AND dow(Ldata) <> 7
				LNdias = LNdias + 1
			ENDIF
		ENDDO

		Ldata = CHRTRAN(DTOC( Ldata ),".","")
		Ldata = CHRTRAN(Ldata,"/","")

		
		IF  &ALS_Duplicat .EMPRESA = 16 && SPE
			m.bol_linha = ;
			    ' DataProtesto="00000000"'+chr(13)
		ELSE

			m.bol_linha = ;
		    ' DataProtesto="'+Ldata+'"'+chr(13)
		ENDIF

		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem

		Ldata = CHRTRAN(DTOC( &ALS_Duplicat .DT_VENC),".","")
		Ldata = CHRTRAN(Ldata,"/","")

		m.bol_linha = ;
		    ' DataVencimento="'+Ldata+'"'+chr(13)

		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' ValorAbatimento= "'+;
		      CHRTRAN( STR( 0,13), " ","0")+'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' ValorDesconto="'+;
		      CHRTRAN(STR( 0,13)," ","0")+'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		
		
		IF &ALS_Duplicat .tp_parcela = 6   && VENDOR
			m.bol_linha = ;
			    ' ValorDocumento=" '+;
			      CHRTRAN(STR(  &ALS_Duplicat .totvlvendr *100,13)," ","0");
	      				+'"'+chr(13)
		ELSE
			m.bol_linha = ;
			    ' ValorDocumento=" '+;
			      CHRTRAN(STR(  &ALS_Duplicat .vlr_doc *100,13)," ","0");
	      				+'"'+chr(13)
		ENDIF
		=edithand('SAVE')
		
		
		
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		IF &ALS_Duplicat .tp_parcela = 6   && VENDOR

			m.moradiaria = ;
			    &ALS_Duplicat .totvlvendr * &ALS_empresa .mora / 100
		ELSE

			m.moradiaria = ;
			    &ALS_Duplicat .vlr_doc * &ALS_empresa .mora / 100

		ENDIF

		
		m.bol_ordem = LNbol_ordem

		m.bol_linha = ;
		    ' ValorMoraJuros="'+;
		      CHRTRAN(STR(  m.moradiaria *100,13)," ","0");
	      			+'"'+chr(13)



		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1

		*---------------------------------------------------*			
		
		DO CASE
			CASE &ALS_Duplicat .empresa = 16
				DO  ULmsgBltSPE

			CASE &ALS_Duplicat .tp_parcela <> 6
				DO  ULmsgBoleto
	
	
			OTHERWISE
				DO  ULmsgVendor
		ENDCASE

		*---------------------------------------------------*			

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    '/>'+chr(13)

		=edithand('SAVE')
		*---------------------------------------------------*			
		SELE &ALS_Duplicat

		
     	m.ConfNroBco  = &ALS_Duplicat .ConfNroBco
		LSnossoNumero = CHRTRAN(LSnossoNumero," ","0")

		IF empty(alltrim(&ALS_Duplicat .NUM_NO_BCO))
			m.ConfNroBco = .f.
		ENDIF
        =RLOCK()
		LScarteira	= 	&ALS_cobranca .carteira
		LSvariacao  =	&ALS_cobranca .variacao

		REPLACE &ALS_Duplicat .carteira   WITH LScarteira
		REPLACE &ALS_Duplicat .variacao   WITH LSvariacao
		REPLACE &ALS_Duplicat .ConfNroBco WITH m.ConfNroBco
		REPLACE &ALS_Duplicat .NUM_NO_BCO WITH LSnossoNumero

	ENDIF

    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Clientes")
    =up_fecha("&ALS_Cobranca")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)


PROCEDURE ULmsgBoleto
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes1="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""

		IF  &ALS_duplicat .nota > 0

			LSmensagem="Boleto Ref. N.F. Nro - "+STR( &ALS_duplicat .nota,8)

		ENDIF

		LSmensagem = LEFT(LSmensagem + SPACE(40),40)

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes2="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		IF &ALS_duplicat .vlr_issrtd  > 0

			LSmensagem = "ISS Retido no valor de R$ "
			
			tmpvalor = ;
			   strtran(str(  &ALS_duplicat .vlr_issrtd ,10,2),".",",")
			tmpvalor = strtran(tmpvalor," ","")
			LSmensagem = LSmensagem + tmpvalor
		ELSE
			LSmensagem = ""
		ENDIF
		
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)


		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes3="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		IF  &ALS_Duplicat .tp_parcela = 7		
			LSmensagem = "PARC:"+;
			   ALLTRIM( &ALS_Duplicat .CODPARCELA)+;
			" - "+STR( &ALS_Duplicat .sequencia,3)+;
		   	" de "+STR( &ALS_Duplicat .qtparcelas,3)
		ELSE
			LSmensagem = ""
		ENDIF



		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes4="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes5="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes6="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes7="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes8="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
RETURN

PROCEDURE ULmsgVendor
		* "Boleto Ref. N.F. Nro - "+STR( &ALS_duplicat .nota,8)
		* "Titulo Negociado-BB Vendor.Apos vencido"
		* "cobrar comissao permanecia.            "
		* "Pgto antecipado proporcional so no BB. "
		* "Vlr.Compra  :"+TRANSF(duplicat.vlr_doc,"@Z *,***,**9.99")
		* "Vlr.Encargo :"+TRANSF(duplicat.vlr_encargo,"@Z *,***,**9.99")
		* "Vlr.Iof Financ: :"+TRANSF(duplicat.vlr_ioffnx,"@Z *,***,**9.99")

		*---------------------------------------------------*			
		LSmensagem = ""

		IF  &ALS_duplicat .nota > 0

			LSmensagem="Boleto Ref. N.F. Nro - "+STR( &ALS_duplicat .nota,8)

		ENDIF

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes1="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Titulo Negociado-BB Vendor.Apos vencido"
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes2="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			


		LSmensagem = "cobrar comissao permanecia.            "
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes3="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Pgto antecipado proporcional so no BB. "
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes4="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Vlr.Compra  :"+;
		               TRANSF(&ALS_Duplicat .vlr_doc,"@Z *,***,**9.99")
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes5="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Vlr.Encargo :"+;
						TRANSF(&ALS_Duplicat .vlr_encargo,"@Z *,***,**9.99")
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes6="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Vlr.Iof Financ: :"+;
						TRANSF(&ALS_Duplicat .vlr_ioffnc,"@Z *,***,**9.99")
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes7="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "PARC:"+;
		   ALLTRIM( &ALS_Duplicat .CODPARCELA)+;
		   STR( &ALS_Duplicat .sequencia,3)+;
		   "/"+;
		   STR( &ALS_Duplicat .qtparcelas,3)
		
		
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes8="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
RETURN(LFdados)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4QM           CRgeraboleto VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   44  º
*       º Variable:            CRgeraboleto                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      367                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4qm     &&  CRgeraboleto VALID
#REGION 10
RETURN

FUNCTION  CRGeraBoleto

PARAMETERS PrmEmpresa,PrmNota,PrmSistema
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNdup

	PRIVATE LNBol_ordem


    IF TYPE("PrmSistema") <> "C"
      PrmSistema = "FOX"
    ENDIF


	PRIVATE LSnota      && STRING COM NUMERO DA NOTA PARA COMPARACAO
	PRIVATE LSnotaDaDup && STRING COM NUMERO DA NOTA RETIRADO DO NUMERO
						&& DA DUPLICATA



    PRIVATE ARQ_Duplicat,ALS_Duplicat
    PRIVATE ARQ_Boleto  ,ALS_Boleto

    LSAlias      = Alias()

    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()


    ARQ_Boleto       = NetArqAgain("Boleto",.T.) && EXCLUSIVO
    ALS_Boleto       = Alias()



	*------------------------------------------------------------*
	SELE &ALS_Boleto
	DELETE ALL FOR BOL_ORDEM > 96 AND BOL_ORDEM < 9998
	PACK
	REINDEX
	
	
	*----------------------------------------------------------------*
	*  O numero da duplicata e composto do numero da nota acrescido de
	* dois digitos para identicar a filiar e a ordem da duplicata
	* => (* 100) cria um numero imediatamento iferior a 1a duplicata
	*----------------------------------------------------------------*
	*  ALGORITIMO DE GERACAO DO NUMERO DE DUPLICATA - CRgeradupl
	*----------------------------------------------------------------*
	*
	*	IF LNemp <> 10
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  STR(m.empresa,1)))   && 1 => DUPLICATA
	*	else
	*		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
	*							  CHRTRAN(STR(LNserie,1)," ","0")+;
	*							  "0"))   && 1 => DUPLICATA
	*	ENDIF
	*-------------------------------------------------------------------*

	LFdados = .f.

	LSnota  = STR(PrmNota,7)

	LNdup	= PrmNota * 100		



	LNBol_ordem = 97



	SET NEAR ON

	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(LNdup,9)

	SET NEAR OFF
	DO WHILE !EOF() AND LSnota = LEFT(STR( &ALS_Duplicat .duplicata,9) ,7)


	
		IF CRGrvBoleto(PrmEmpresa, ;
		             &ALS_Duplicat .duplicata,;
		             LNBol_ordem)
			LFdados = .t.
		ENDIF		
		*---------------------------------------------------*			
		SELE &ALS_Duplicat
		SKIP
	ENDDO


    IF TYPE("PrmSistema") <> "C"
      PrmSistema = "FOX"
    ENDIF


	if LFdados AND  PrmSistema = "FOX"

		SELE &ALS_Boleto
		COPY FIELDS bol_linha ;
	       TO "L:\TMP\PRTBOLET.XML" ;
		      TYPE SDF
	endif

	=W_DEFPROC("EMPRESA.SPR")
	LSemi_Fncr = EMGetFieldValue(wp_empresa,"EMITE_FNCR")


    IF  LSemi_Fncr = "S"
		IF PrmSistema = "ORION"

			*---------------------------------------------------------*
			=W_DEFPROC("DUPLICAT.SPR")
			=CRDuplDFisExpDuplicata(PrmEmpresa,PrmNota,"IMPRIMIR")
			*---------------------------------------------------------*

	    ENDIF
	ENDIF
	
    =up_fecha("&ALS_Duplicat")
    =up_fecha("&ALS_boleto")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4QV           CRreplicaDupl VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   46  º
*       º Variable:            CRreplicaDupl                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      368                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4qv     &&  CRreplicaDupl VALID
#REGION 10
RETURN

FUNCTION  CRreplicaDupl
PARAMETERS PrmEmpresa,PrmDuplicata,PrmQtdReplicas

	=W_DEFPROC("rotinas.spr")
	*------------------------------------------*
	PRIVATE LNdup


    PRIVATE ARQ_Duplicat,ALS_Duplicat

    LSAlias      = Alias()

    ARQ_Duplicat     = NetArqAgain("Duplicat")
    ALS_Duplicat     = Alias()

	*------------------------------------------------------------*
	SELE &ALS_Duplicat
	SET ORDER TO TAG doc
	SEEK STR(PrmEmpresa,3)+STR(PrmDuplicata,9)

	IF FOUND()

	   SCATTER MEMVAR	
	   FOR X = 1 TO PrmQtdReplicas


		  IF DAY(m.dt_venc) >= 28 AND MONTH(m.dt_venc) = 2
		      m.dt_venc = GOMONTH(m.dt_venc,2)
		      m.dt_venc = m.dt_venc - DAY(m.dt_venc)

		  ELSE
		      m.dt_venc = GOMONTH(m.dt_venc,1)
		  ENDIF

		  IF DAY(m.dt_venc) = 31
		      m.dt_venc = m.dt_venc - 1
		  ENDIF


	      APPEND BLANK
		  =RLOCK()

	      m.duplicata  = RECNO()
	      m.codparcela = ALLTRIM(STR(VAL(m.codparcela)+1,15))
	      m.sequencia  = m.sequencia + 1
		  GATHER MEMVAR		

	   NEXT 	
	ENDIF

    =up_fecha("&ALS_Duplicat")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4R3           ULmsgBoleto VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   47  º
*       º Variable:            ULmsgBoleto                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      369                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4r3     &&  ULmsgBoleto VALID
#REGION 10
RETURN



PROCEDURE ULmsgBoleto
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes1="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""

		IF  &ALS_duplicat .nota > 0

			LSmensagem="Boleto Ref. N.F. Nro - "+STR( &ALS_duplicat .nota,8)

		ENDIF

		LSmensagem = LEFT(LSmensagem + SPACE(40),40)

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes2="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		IF &ALS_duplicat .vlr_issrtd  > 0

			LSmensagem = "ISS Retido no valor de R$ "
			
			tmpvalor = ;
			   strtran(str(  &ALS_duplicat .vlr_issrtd ,10,2),".",",")
			tmpvalor = strtran(tmpvalor," ","")
			LSmensagem = LSmensagem + tmpvalor
		ELSE
			LSmensagem = ""
		ENDIF
		
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)


		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes3="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		IF  &ALS_Duplicat .tp_parcela = 7		
			LSmensagem = "PARC:"+;
			   ALLTRIM( &ALS_Duplicat .CODPARCELA)+;
			" - "+STR( &ALS_Duplicat .sequencia,3)+;
		   	" de "+STR( &ALS_Duplicat .qtparcelas,3)
		ELSE
			LSmensagem = ""
		ENDIF



		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes4="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes5="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes6="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes7="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes8="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4RC           ULmsgVendor VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   48  º
*       º Variable:            ULmsgVendor                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      370                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4rc     &&  ULmsgVendor VALID
#REGION 10
RETURN


PROCEDURE ULmsgVendor
		* "Boleto Ref. N.F. Nro - "+STR( &ALS_duplicat .nota,8)
		* "Titulo Negociado-BB Vendor.Apos vencido"
		* "cobrar comissao permanecia.            "
		* "Pgto antecipado proporcional so no BB. "
		* "Vlr.Compra  :"+TRANSF(duplicat.vlr_doc,"@Z *,***,**9.99")
		* "Vlr.Encargo :"+TRANSF(duplicat.vlr_encargo,"@Z *,***,**9.99")
		* "Vlr.Iof Financ: :"+TRANSF(duplicat.vlr_ioffnx,"@Z *,***,**9.99")

		*---------------------------------------------------*			
		LSmensagem = ""

		IF  &ALS_duplicat .nota > 0

			LSmensagem="Boleto Ref. N.F. Nro - "+STR( &ALS_duplicat .nota,8)

		ENDIF

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes1="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Titulo Negociado-BB Vendor.Apos vencido"
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes2="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			


		LSmensagem = "cobrar comissao permanecia.            "
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes3="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Pgto antecipado proporcional so no BB. "
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes4="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Vlr.Compra  :"+;
		               TRANSF(&ALS_Duplicat .vlr_doc,"@Z *,***,**9.99")
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes5="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Vlr.Encargo :"+;
						TRANSF(&ALS_Duplicat .vlr_encargo,"@Z *,***,**9.99")
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes6="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "Vlr.Iof Financ: :"+;
						TRANSF(&ALS_Duplicat .vlr_ioffnc,"@Z *,***,**9.99")
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes7="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "PARC:"+;
		   ALLTRIM( &ALS_Duplicat .CODPARCELA)+;
		   STR( &ALS_Duplicat .sequencia,3)+;
		   "/"+;
		   STR( &ALS_Duplicat .qtparcelas,3)
		
		
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes8="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
RETURN(LFdados)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4T3           ULmsgBltSPE VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   49  º
*       º Variable:            ULmsgBltSPE                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      371                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4t3     &&  ULmsgBltSPE VALID
#REGION 10
RETURN



PROCEDURE ULmsgBltSPE
		*---------------------------------------------------*			
		LSmensagem = ""


		
		LSmensagem = CHRTRAN(LSmensagem,".",",")

		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes1="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""



		tmpvalor = &ALS_duplicat .vlr_doc * &ALS_empresa .multa / 100

   		Ldata = DTOC( &ALS_Duplicat .DT_VENC+1)
		Ldata = CHRTRAN(Ldata,".","/")

		LSmensagem = "Multa de R$ ";
				   + ALLTRIM(str( tmpvalor ,10,2))
	
		LSmensagem = CHRTRAN(LSmensagem,".",",")

		LSmensagem = LSmensagem+" apos " + Ldata

		LSmensagem = LEFT(LSmensagem + SPACE(40),40)

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes2="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			

		LSmensagem = ""
		


		LSmensagem = LEFT(LSmensagem + SPACE(40),40)


		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes3="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = "CONTROLE:"+;
			   ALLTRIM( &ALS_Duplicat .CODPARCELA)

		LSmensagem = LEFT(LSmensagem + SPACE(40),40)

		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes4="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes5="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""

		LSmensagem="FONE MALDI = (62)3240-5423"

		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes6="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes7="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
		*---------------------------------------------------*			
		LSmensagem = ""
		LSmensagem = LEFT(LSmensagem + SPACE(40),40)
		m.bol_ordem = LNbol_ordem
		m.bol_linha = ;
		    ' Instrucoes8="'+ LSmensagem +'"'+chr(13)
		=edithand('SAVE')
		LNbol_ordem	= LNbol_ordem + 1
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4TC           CRAplicaINCC VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   50  º
*       º Variable:            CRAplicaINCC                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      372                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4tc     &&  CRAplicaINCC VALID
#REGION 10
RETURN

FUNCTION CRAplicaINCC
	*------------------------------------------------------------*

	PARAMETERS  LNemp

	PRIVATE LNdebito, LSalias
	PRIVATE LFduplicat
	LSalias			= ALIAS()
		
	=W_DEFPROC("rotinas.spr")
	LFduplicat	= NetArq("duplicat")
	IF (LFduplicat) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("duplicat" ,LFduplicat)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*---------------------------------------------------------------*	
	LNdebito  = 0
	sele duplicat
	SET ORDER TO TAG emissao
	SET NEAR ON
	SEEK STR(LNemp,3)
	SET NEAR OFF



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() ;
	        AND LNemp    = duplicat.empresa ;
         TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

    msg = ""

	DO WHILE !EOF();
			AND	LFsegue = .t. ;
			AND duplicat.empresa  = LNemp

		=UPtermo()
		WAIT WINDOW  msg NOWAIT

		*---------------------------------*
		* APLICACAO DE REAJUSTE INCC
		*---------------------------------*
		* tp_parcela =  7 && AJUSTE INCC
		*---------------------------------*
		
		IF Duplicat.tp_parcela =  7 and EMPTY(Duplicat.DT_PGTO)

			PRIVATE RtnvlrCorrigido
			RtnvlrCorrigido = 0
			=W_DEFPROC("TABINCC.SPR")
			IF !NCAplicaINCC(Duplicat.dt_emi,;
						  Duplicat.dt_venc,;
	                      Duplicat.vlrparcini,;
						   RtnvlrCorrigido)
			  msg = "Falha calculo INCC Dupl" + ;
				    STR(Duplicat.duplicata,9)
			ELSE
			  msg = "Ok - Calculado INCC Dupl" + ;
				    STR(Duplicat.duplicata,9)
				sele duplicat
				=rlock()		
				REPLACE Duplicat.VLR_DOC   WITH RtnvlrCorrigido
				unlock
			ENDIF
		else
			  msg = " Lida " + ;
				    STR(Duplicat.duplicata,9)
		ENDIF
		sele duplicat
		SET ORDER TO TAG emissao
	
		SKIP
	ENDDO
	
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO

	=UP_fecha("duplicat" ,LFduplicat)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4TD           CRAplicaIGPM VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   51  º
*       º Variable:            CRAplicaIGPM                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      373                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4td     &&  CRAplicaIGPM VALID
#REGION 10
RETURN

FUNCTION CRAplicaIGPM
	*------------------------------------------------------------*

	PARAMETERS  LNemp

	PRIVATE LNdebito, LSalias
	PRIVATE LFduplicat
	LSalias			= ALIAS()
		
	=W_DEFPROC("rotinas.spr")
	LFduplicat	= NetArq("duplicat")
	IF (LFduplicat) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("duplicat" ,LFduplicat)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*---------------------------------------------------------------*	
	LNdebito  = 0
	sele duplicat
	SET ORDER TO TAG emissao
	SET NEAR ON
	SEEK STR(LNemp,3)
	SET NEAR OFF



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()
	*LNimpressao = RECCOUNT()

	COUNT  WHILE !EOF() ;
	        AND LNemp    = duplicat.empresa ;
         TO LNimpressao
	GO LNregistro
	LNimpressos = 0
	*----------------------------------------------------*

    msg = ""

	DO WHILE !EOF();
			AND	LFsegue = .t. ;
			AND duplicat.empresa  = LNemp

		=UPtermo()
		WAIT WINDOW  msg NOWAIT

		*---------------------------------*
		* APLICACAO DE REAJUSTE IGPM
		*---------------------------------*
		* tp_parcela =  8 && AJUSTE IGPM
		*---------------------------------*
		
		IF Duplicat.tp_parcela =  8 and EMPTY(Duplicat.DT_PGTO)

			PRIVATE RtnvlrCorrigido
			RtnvlrCorrigido = 0
			=W_DEFPROC("TABIGPM.SPR")
			IF !IGAplicaIGPM(Duplicat.dt_emi,;
						  Duplicat.dt_venc,;
	                      Duplicat.vlrparcini,;
						   RtnvlrCorrigido)
			  msg = "Falha calculo IGPM Dupl" + ;
				    STR(Duplicat.duplicata,9)
			ELSE
			  msg = "Ok - Calculado IGPM Dupl" + ;
				    STR(Duplicat.duplicata,9)
				sele duplicat
				=rlock()		
				REPLACE Duplicat.VLR_DOC   WITH RtnvlrCorrigido
				unlock
			ENDIF
		else
			  msg = " Lida " + ;
				    STR(Duplicat.duplicata,9)
		ENDIF
		sele duplicat
		SET ORDER TO TAG emissao
	
		SKIP
	ENDDO
	
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO

	=UP_fecha("duplicat" ,LFduplicat)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4TE           CRfatimporta VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   53  º
*       º Variable:            CRfatimporta                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      374                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4te     &&  CRfatimporta VALID
#REGION 10
RETURN

FUNCTION CRfatimporta      && REGISTRO DUP FATURADAS
PARAMETER PrmEmp,PrmNomeEmp,PrmData,PrmBanco


    m.empresa = PrmEmp
    m.dtaviso = PrmData
    LDdtinicio= PrmData
    m.banco   = PrmBanco
    m.carteira= ""
    m.variacao = ""

    *-----------------------------*
 	m.cod_empres = m.empresa
	m.dtaviso	 = UPValData(m.dtaviso)  && bug 2000
	m.aviso 	 = INT(VAL((DTOS(m.dtaviso))))
	m.nome_emp	 = PrmNomeEmp

	m.dtaviso  	 = LDdtinicio
	m.dtprocesso = LDdtinicio
	m.status 		= "PR"    && AGUARDANDO PROCESSAMENTO


	LNctrreg	= 0			&& TOTAL DE REGISTROS DE INSTRUCAO
	LNacmvlr	= 0			&& VALOR TOTAL DOS DOCUMENTOS
	LNacmpgt	= 0			&& VALOR TOTAL DOS PAGAMENTOS
    *-----------------------------*

	SELE retornbc
	SET ORDER TO TAG aviso



	IF SEEK(STR(m.empresa,3)+STR(m.banco,3)+;
	   m.carteira+m.variacao+STR(m.aviso,8))
 	   RETURN
	ENDIF
	=edithand('SAVE')
	=REGLOCK(.T.)

	SELE retornmv
	SET ORDER TO TAG lancamento
	SELE duplicat
	SET ORDER TO TAG emissao
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(m.dtaviso)
	SET NEAR OFF
	DO WHILE !EOF() AND PrmEmp = duplicat.empresa ;
					AND m.dtaviso  = duplicat.dt_emi

		m.duplicata	= duplicat.duplicata
		m.ocorrencia= 02	&&  REGISTRO CONFIRMADO
		m.efeito	= 1		&&  FATURAMENTO
		m.motivos   = ""
		m.vlr_dup	= duplicat.vlr_doc
		m.vlr_pgto  = 0
		LNctrreg	= LNctrreg + 1
		LNacmvlr	= LNacmvlr + m.vlr_dup
		LNacmpgt	= LNacmpgt + m.vlr_pgto

		SELE retornmv
		IF SEEK(STR(m.empresa,3)+STR(m.banco,3)+;
		    m.carteira+m.variacao+STR(m.aviso,8)+;
		 		STR(m.duplicata,9)+STR(m.ocorrencia,2))
			SELE duplicat
			SKIP
			LOOP
		ENDIF
		m.num_no_bco= " "
		m.vencimento= duplicat.dt_venc
		m.banco_cobr= duplicat.banco
		m.agenc_cobr= duplicat.agencia
		m.dsp_cobr  = 0
		m.out_desp  = 0
		m.juros     = 0
		m.iof       = 0
		m.abatimento= 0
		m.desconto  = 0
		m.mora      = 0
		m.out_credt = 0
		m.form_pgto = 0
		m.trf_cart  = " "
		m.dtocorrenc= m.dtaviso
		=edithand('SAVE')
		SELE duplicat
		SKIP
		LOOP

	ENDDO

    IF LNctrreg > 0
		SELE retornbc
		m.reg_total = LNctrreg
		m.reg_proces= 0
		m.reg_descar= 0
		m.tot_doc   = LNacmvlr
		m.tot_pgto  = LNacmpgt
	
		=edithand('REGRAVA')
		UNLOCK
	endif

RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4TF           CRGerfatPeriodo VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   54  º
*       º Variable:            CRGerfatPeriodo                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      375                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls4tf     &&  CRGerfatPeriodo VALID
#REGION 10
RETURN

FUNCTION CRGerfatPeriodo      && REGISTRO DUP FATURADAS BANCO 990
PARAMETER PrmEmp,PrmNomeEmp,PrmDtIni,PrmDtFinal,PrmBanco

	*------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFduplicat,LFClienc,LFNota
	PRIVATE LFcobranca
	PRIVATE LNCtrItens

	LSalias = ALIAS()

	LFduplicat		= NetArq("duplicat")
	LFretornbc		= NetArq("retornbc")
	LFretornmv		= NetArq("retornmv")




	IF (LFduplicat+LFretornbc+LFretornmv) > 100000
		DO  FCHCRGerfatPeriodo
		RETURN(.f.)
	ENDIF


	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

    LNregistro = 0

    LNimpressao = PrmDtFinal - PrmDtIni

	LNimpressos = 0

    BKregistro  = LNregistro
    BKimpressos = LNimpressos
    BKimpressao = LNimpressao


	*----------------------------------------------------*


	DO WHILE PrmDtIni <= PrmDtFinal and LFsegue = .t.

		=UPtermo()

        =CRfatimporta(PrmEmp,PrmNomeEmp,PrmDtIni,PrmBanco)
		
        PrmDtIni = PrmDtIni + 1

	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*


	DO  FCHCRGerfatPeriodo


RETURN


PROCEDURE FCHCRGerfatPeriodo

	=UP_fecha("duplicat" ,LFduplicat)
	=UP_fecha("retornbc" ,LFretornbc)
	=UP_fecha("retornmv" ,LFretornmv)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4TG           CRgeraDE01JUL12 VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         DUPLIC_A,     Record Number:   55  º
*       º Variable:            CRgeraDE01JUL12                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      376                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4tg     &&  CRgeraDE01JUL12 VALID
#REGION 10
RETURN
*********************************************************************
*  CRgeradupl.....: Gera duplicatas
********************************************************************
*---------------------------------------------------------------
*  CLASSIFICACAO..: [***]
*---------------------------------------------------------------
*  OBJETIVO.......:
*---------------------------------------------------------------
*  COMENTARIO.....:
*
*---------------------------------------------------------------
*  TABELAS........: Duplicat
*                   Empresa
*                   Orcament
*---------------------------------------------------------------
*  PARAMETROS.....:
*                   LNemp      = Empresa que se deseja a informacao
*                   LNorcamento= Numero do Orcamento
*---------------------------------------------------------------
* RETORNO.........: nao ha retorno
*---------------------------------------------------------------
* CHAMADA EXEMPLO.: do CRgeradupl with LNemp,LNorcamento
*---------------------------------------------------------------

PROCEDURE CRgeraDE01JUL12		&& USADA EM SCGC201, SCGCF201, SCGC201A
	
	PARAMETERS LNEmp,LNOrcamento, PrmImpBoleto
	
    *--------------------------------------------------------------
    *       PrmImpBoleto
	*                         = "EMITIR BOLETO"
	*                         = "SEM BOLETO" OU .F.
    *--------------------------------------------------------------

    IF TYPE("PrmImpBoleto") = "U"
         PrmImpBoleto = "SEM BOLETO"
    ENDIF




	
	=W_DEFPROC("rotinas.spr")

	PRIVATE nota	&& O NUMERO DA NOTA DEVE SER O DA 1a NOTA CASO
					&& TENHAM SIDO GERADAS DUAS COM BASE NO MESMO ORCAMENTO
					&& PARA EVITAR INFLUENCIA NO AMBENTE NOTA E PRIVATE

	PRIVATE 	LNocorrenc, LNposic, LNinicio, LNnumpgt, LNdias, LNserie
	PRIVATE 	CVSTR1,CVSTR2,LNvlrdupl,LNdifere

	PRIVATE	empresa,duplicata,dt_emi,multa_prv,mora_prv,bonus_prv,;
			prem_pont,vlr_fatura,portador,tp_cobranc,;
			desconto,regiao,natu,nome,tp_cobranc

	PRIVATE dt_venc, dtproxproc
	PRIVATE LNtmp,banco

   	PRIVATE LNTp_parcela,LNbanco,LNvlrent,LSprazo,LDdtemi,LNmulta,LNmora
  	PRIVATE LNbonus,LNPremPont,LNRegiao,LNnatureza,LSnome,LNvlrfatura	
    PRIVATE LNnronota	

	PRIVATE LFduplicata,LFempresa,LForcamento,LFclienc,LForca_pgt
	PRIVATE LFclientes
	PRIVATE LSalias


	PRIVATE LNvl_issrtd
	*-----------------------------------------------------------*
	PRIVATE AIA,AIOF,d
	STORE 0 TO 	AIA,AIOF,D,m.TX_JUROSCP,m.TX_JUROSVD
	*-----------------------------------------------------------*
	LSalias	    = ALIAS()
	LFduplicata	= NetArq("duplicat")
	LFempresa   = NetArq("Empresa" )
	LForcamento = NetArq("Orcament")
	LForca_pgt  = NetArq("orca_pgt")
	LFclienc    = NetArq("clienc")
	LFclientes  = NetArq("clientes")
	IF (LFduplicata+LFempresa+LForcamento+LForca_pgt) > 100000 OR ;
		(LFclientes+LFclienc) > 100000
		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" 	  ,LFclienc )
		=UP_fecha("orca_pgt"  ,LForca_pgt )
		=UP_fecha("clientes"  ,LFclientes )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
    SELE EMPRESA
    SET ORDE TO empresa
    SEEK LNemp

    SELE clienc
    SET ORDE TO emporca
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)


    SELE orcament
    SET ORDE TO geral
    SEEK STR(LNEmp,3)+STR(LNOrcamento,6)

	SELE orcament
*------------------------------------------------------------------*
* Condicao que evitava a geracao de duplicatas para vendas a vista
* retiradda em marco de 2012 pelo sergio para viabilizar a integracao
* dfis x dfin x paf e tabm facilitar a formacao do fluxo financeiro
* baseado nos titulos a receber e a pagar
*-------------------------------------------------------------------*
*	IF orcament.natu_oper <> 1  OR ;
*	   orcament.TP_PARCELA = 1 	&& So Gerar Duplicatas para
*								&& operacoes de Venda e Que
*								&&  Sejam a Prazo
*
*-----------------------------------------------------------------*
	IF orcament.natu_oper <> 1
	   	&& So Gerar Duplicatas para
								&& operacoes de Venda

		=UP_fecha("duplicat"  ,LFduplicata )
		=UP_fecha("empresa"   ,LFempresa   )
		=UP_fecha("orcamento" ,LForcamento )
		=UP_fecha("clienc" ,LFclienc )
		=UP_fecha("orca_pgt"  ,LForca_pgt )
		=UP_fecha("clientes"  ,LFclientes )
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.T.)
	ENDIF

	*----------------------------------------------------------------*
	wp_msg = "Gerando Duplicatas OSI: "+STR(orcament.orcamento,6)
	WAIT WINDOW wp_msg NOWAIT
	LNcliente	= clienc.cliente	
   	LNTp_parcela= orcament.tp_parcela
   	LNbanco		= orcament.banco
   	LNvlrent	= orcament.vlr_ent
   	LSprazo		= orcament.prazo
   	LDdtemi		= orcament.dt_fat
  	LNmulta		= empresa.multa
  	LNmora		= empresa.mora
  	LNbonus		= empresa.bonus
  	LNPremPont	= empresa.prem_pont
  	LNRegiao	= clienc.regiao
	LNnatureza	= clienc.natu_cli
	m.tp_pessoa = clienc.tp_pessoa	
	m.FlgImbuteIOF = orcament.FlgImbuteI
	LSnome		= clienc.nome
	LNvlrfatura	= orcament.valor
	LNnronota	= orcament.nota


	LNvl_issrtd = orcament.vlr_issrtd



	SELECT &LSalias

	*-----------------------------------------------------------*
	*   Garante a Elimina‡Æo de Registros de Duplicatas Deixados
	* por falha
	*-----------------------------------------------------------*
	=CRcancdupl((LNemp),(LNnronota))
	*-----------------------------------------------------------*
	m.empresa	= LNemp
	m.nota		= LNnronota						
	m.duplicata	= LNnronota
	m.cliente	= LNcliente
	m.dt_emi	= LDDtemi
	m.multa_prv	= LNmulta
	m.mora_prv	= LNmora
	m.bonus_prv	= LNbonus
	m.prem_pont	= LNPremPont
	m.vlr_fatura= LNvlrfatura

	m.vlr_encarg = 0
	m.vlr_encbco = 0
    m.vlr_ioffnc = 0
	m.TotVlVendr = 0


	IF m.FlgImbuteIOF = .T.
		m.iof_fin = 1
	ELSE
		m.iof_fin = 1
	ENDIF


	DO CASE
		CASE LNTp_parcela = 6
			m.tp_cobranc	= 06	&& VENDOR
			m.flg_vendor    = 	.T.
		OTHERWISE
			m.tp_cobranc= 01	&& SIMPLES
			m.flg_vendor    = 	.F.
	ENDCASE


	m.desconto  = 0
	m.regiao    = LNregiao
	m.natu      = LNnatureza
	m.nome      = LSnome

	*-----------------------------------------------------------*
	*   Tratando os Registro Referentes a Entradas (MODO_PGTO = 1)
	*-----------------------------------------------------------*

	LNserie	   	= 1		&& Diferenciador do Numero da Duplicata
						&& 0 a 9
	SELE orca_pgt
	SET ORDER TO TAG orca_pgto
	SET NEAR ON
	SEEK STR(LNEmp,3)+STR(LNOrcamento,6)
	SET NEAR OFF

	DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
					AND LNorcamento = orca_pgt.orcamento;
					AND orca_pgt.modo_pgto = 1

		m.duplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA


		IF LNemp = 10
		
		    && A IDL NAO POSSUI CONTROLE DE FATURAMENTO COM INFORMACOES
		    && SUFICIENTES PARA ORCAPGTO
		
			m.tp_parcela=  	3
			m.moeda 	=	3
		else
			m.tp_parcela=  	orca_pgt.tp_parcela
			m.moeda 	=	orca_pgt.moeda
		ENDIF

		IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
		               && Carteira e esta remete para
		               && Banco
			m.portador 	=  0   && CARTEIRA
		ELSE
			m.portador 	= orca_pgt.banco
		ENDIF

		m.banco 	=	orca_pgt.banco
		m.carteira  = ""
		m.variacao  = ""
		m.convenio  = ""
		m.conta     = ""
		m.conta_dv  = ""
		m.agencia   = 0
		m.agencia_dv= ""
		
		
		*-----------------------------------------------*
        *--------------------------------------------------------------
        *       PrmImpBoleto
     	*                         = "EMITIR BOLETO"
	    *                         = "SEM BOLETO" OU .F.
        *--------------------------------------------------------------
	    m.NUM_NO_BCO = ""
        IF PrmImpBoleto = "SEM BOLETO"
		    =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			   "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			     m.convenio,m.conta,m.conta_dv,;
			     m.agencia,m.agencia_dv)
        ELSE
           =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
			   "EMISSOR BOLETO", m.Carteira,m.Variacao,;
			     m.convenio,m.conta,m.conta_dv,;
			     m.agencia,m.agencia_dv)
		   DO CASE
				CASE m.BANCO = 001
				 m.NUM_NO_BCO = ;
					 CR_001geraNssNro(m.Empresa, 001,m.carteira,m.variacao)
				CASE m.BANCO = 237
				  m.NUM_NO_BCO = ;
				     CR_237geraNssNro(m.Empresa, 237,m.carteira,m.variacao)
			ENDCASE
		    m.NUM_NO_BCO = CHRTRAN(m.NUM_NO_BCO," ","0")
		ENDIF

		*-----------------------------------------------*

		
		m.vlr_doc	 =	orca_pgt.vlr_pgto - LNvl_issrtd
		m.vlr_issrtd =  LNvl_issrtd
		LNvl_issrtd  =  0
		m.dt_venc	=	m.dt_emi		
		m.obs =""


		m.vlr_pgto  =   0
   		m.dt_baixa  =   {}
   		m.dt_pgto   =   {}


		DO CASE
			CASE m.moeda = 4  &&	-Cheque Eletronico  : 	1 dia
				m.dt_venc	=	m.dt_emi + 1		
			CASE m.moeda = 5  &&	-CartÆo Rotativo 	:  31 dias	
				m.dt_venc	=	m.dt_emi + 31		
*------  a baixa sera feita no processo importacao caixa e processamento
*            OTHERWISE
*
 *         		m.vlr_pgto  =   m.vlr_doc
  *        		m.dt_baixa  =   m.dt_emi
   *       		m.dt_pgto   =   m.dt_emi
   *--------------------------------------------

		ENDCASE


		IF TYPE("orcament.AJSTFIMSEM") = "U"
			=CRajustaVenc(m.dt_venc,"+")
		ELSE
			IF orcament.AJSTFIMSEM <> "N"
				=CRajustaVenc(m.dt_venc,"+")
			ENDIF
		ENDIF

        *--------------------------------------------------*		
        m.dt_p_desct = m.dt_venc
        m.dt_cbr_jrs = m.dt_venc

		LNdias = 0
		m.dt_protest =  m.dt_venc
		DO WHILE LNdias < 5
		    m.dt_protest =  m.dt_protest + 1
			IF dow(m.dt_protest) <> 1 AND dow(m.dt_protest) <> 7
				LNdias = LNdias + 1
			ENDIF
		ENDDO
		m.vlr_mora = m.vlr_doc * empresa.mora / 100
        m.vlr_juros = 0
        m.vlr_dsct  = 0
        *--------------------------------------------------*		
		SELE  duplicat
		
		
		SELE  duplicat
        SET ORDER TO TAG DOC
        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
        IF !FOUND()
			=edithand('SAVE')
		ENDIF
		
		LNserie    = LNserie + 1
		SELE orca_pgt
		SKIP
	ENDDO
	*-----------------------------------------------------------*
	*   Diferenciar Tratando das Parcelas de Acordo Com o Tipo de
	*  Parcelamento :
	*
	*		TP_PARCELA = 1 (A Vista)
	*			OBS: Neste Caso o Pgto com Cheque Eletronico ou
	*				CartÆo Rotativo SÆo Considerados A Prazo e
	*				Assumem Prazos Fixos Sendo:
	*					-Cheque Eletronico  : 	1 dia
	*					-CartÆo Rotativo 	:  31 dias	
	*
	*		TP_PARCELA <> 1 (Parcelados)		
	* 			OBS: Em Opera‡äes Realmente de Origem Parcelada os
	*               Registro Seguem o Prazo Que Estiver Estipulado
	*               no Campo Prazo da OSI e a Entrada (000/...) ‚
	*               Desconsiderada Por j  Ter Sido Tratada
	*					-Cheque          	:  ???/???/???/??? dias	
	*					-Duplicata          :  ???/???/???/??? dias	
	*					-CartÆo Parcelado	:  ???/???/???/??? dias	
	*
	*-----------------------------------------------------------*
	* Tratando os Registro Referentes a Parcelas (MODO_PGTO = 2)
	*-----------------------------------------------------------*
	* Determinando o Numero de Parcelas Especificadas (LNnumpgt)
	* Ex: "000/030/060/090/000/000 => 3 Parcelas (A Entrada ‚
	*                                              Desprezada)
	* Ex: "030/000/000/000/000/000 => 1 Parcela Sem Entrada
	*
	* Ex: "000/000/000/000/000/000 => 1 Parcela (Conta Apresenta‡Æo)
	*-----------------------------------------------------------*
	DO CASE
		CASE 	orcament.TP_PARCELA = 1 ;
			OR  orcament.TP_PARCELA = 5  && (A Vista / A Vista Com CartÆo)

			SELE orca_pgt
			SET ORDER TO TAG orca_pgto
			DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
					AND LNorcamento = orca_pgt.orcamento;
					AND orca_pgt.modo_pgto = 2

				m.duplicata	= ;
						INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
							  CHRTRAN(STR(LNserie,2)," ","0");
							  ))   && 1 => DUPLICATA

				m.tp_parcela=  	orca_pgt.tp_parcela
				m.moeda 	=	orca_pgt.moeda
				IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
				               && Carteira e esta remete para
				               && Banco
					m.portador 	=  0   && CARTEIRA
				ELSE
					m.portador 	= orca_pgt.banco
				ENDIF
				m.banco 	=	orca_pgt.banco

				m.vlr_doc	 =	orca_pgt.vlr_pgto - LNvl_issrtd
				m.vlr_issrtd =  LNvl_issrtd
				LNvl_issrtd  =  0



				m.vlr_pgto  =   0
				m.dt_venc	=	m.dt_emi		
				m.obs =""

				DO CASE
					CASE m.banco = 860  &&	Ticket CAR:prox 2F + 30dias
						Ctrdias = 0
						DO While dow(m.dt_emi+Ctrdias) <> 2
							Ctrdias = Ctrdias + 1
						ENDDO
						m.dt_venc	=	m.dt_emi + 30 + Ctrdias		
					CASE m.moeda = 4  &&	-Cheque Eletronico  : 	1 dia
						m.dt_venc	=	m.dt_emi + 1		
					CASE m.moeda = 5  &&	-CartÆo Rotativo 	:  31 dias	
						m.dt_venc	=	m.dt_emi + 31		
				ENDCASE

				IF TYPE("orcament.AJSTFIMSEM") = "U"
					=CRajustaVenc(m.dt_venc,"+")
				ELSE
					IF orcament.AJSTFIMSEM <> "N"
						=CRajustaVenc(m.dt_venc,"+")
					ENDIF
				ENDIF
				

				m.carteira  = ""
				m.variacao  = ""
				m.convenio  = ""
		        m.conta     = ""
		        m.conta_dv  = ""
		        m.agencia   = 0
                m.agencia_dv= ""
				*-----------------------------------------------*


	    	    m.NUM_NO_BCO = ""
	            IF PrmImpBoleto = "SEM BOLETO"
			        =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    			   "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			    	     m.convenio,m.conta,m.conta_dv,;
			    	     m.agencia,m.agencia_dv)
	            ELSE
        	       =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    			   "EMISSOR BOLETO", m.Carteira,m.Variacao,;
			    	     m.convenio,m.conta,m.conta_dv,;
			    	     m.agencia,m.agencia_dv)
	    		   DO CASE
			    		CASE m.BANCO = 001
					     m.NUM_NO_BCO = ;
	    					 CR_001geraNssNro(m.Empresa,;
	    					  001,m.carteira,m.variacao)
	    				CASE m.BANCO = 237
			    		  m.NUM_NO_BCO = ;
					         CR_237geraNssNro(m.Empresa,;
					          237,m.carteira,m.variacao)
	    			ENDCASE
			        m.NUM_NO_BCO = CHRTRAN(m.NUM_NO_BCO," ","0")
	    		ENDIF
				*-----------------------------------------------*
                m.dt_p_desct = m.dt_venc
                m.dt_cbr_jrs = m.dt_venc

        		LNdias = 0
        		m.dt_protest =  m.dt_venc
        		DO WHILE LNdias < 5
        		    m.dt_protest =  m.dt_protest + 1
        			IF dow(m.dt_protest) <> 1 AND dow(m.dt_protest) <> 7
        				LNdias = LNdias + 1
        			ENDIF
        		ENDDO
        		m.vlr_mora = m.vlr_doc * empresa.mora / 100
                m.vlr_juros = 0
                m.vlr_dsct  = 0
				*-----------------------------------------------*

				SELE  duplicat


				SELE  duplicat
		        SET ORDER TO TAG DOC
		        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
		        IF !FOUND()
					=edithand('SAVE')
				ENDIF

				LNserie    = LNserie + 1
				SELE orca_pgt
				SKIP
			ENDDO

		CASE	TP_PARCELA <> 1 		&& (Parcelados)		

			LNocorrenc 	= 1		&& 1¦,2¦,3¦... Ocorrencia do Char "/"
		    LNposic    	= 0     && Qual Posi‡Æo da Str Oocorre "/" 3,7,...
		    LNnumpgt   	= 0		&& Quantidade de Parcelas Fora Entrada
			LNdias	   	= 0		&& Dias de Prazo da Parcela
			LNproximodias	= 0  && Permite Diferenciar o
							 && Pgto com Entrada (000/031/000/000)
							 && do Pgto Conta Apresent‡Æo
							 && (000/000/000/...). No Primeiro Caso Quando
							 && LNdias = 0 (ou ser  a Entrada ou Invalido)
							 && e  nÆo ser  gerada Duplicatas. J  no
							 && Segundo Caso deve Ser Gerada Uma Dupl.
							 && Conta Apresenta‡Æo
		    LNinicio   	= 1
			*-----------------------------------------------------------*

			DO WHILE .t.
		        LNinicio   	= LNposic + 1
			    LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
				LNproximodias= INT(VAL(SUBS(LSprazo,LNinicio+4,3)))

	    		LNposic 	= AT("/",LSprazo, LNocorrenc)
				*-----------------------------------------------*
	  			IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
					EXIT
				ENDIF
				*-----------------------------------------------*
				*-----------------------------------------------*
				* LNdias = 0 AND LNproximodias => Conta Apresenta‡Æo
				*-----------------------------------------------*
				* 000/000/000/...  Conta Apresenta‡Æo
				*				LNnumpgt = 1
				*-----------------------------------------------*
				*-----------------------------------------------*
				IF LNdias = 0 AND LNproximodias > 0 && Descarte da
													&&  Entrada
					LNocorrenc 	= LNocorrenc + 1
				ELSE
					LNocorrenc 	= LNocorrenc + 1
			       	LNnumpgt   	= LNnumpgt + 1
				ENDIF
			ENDDO

			*-----------------------------------------------*
			SELE orca_pgt
			DO WHILE !EOF() AND LNemp       = orca_pgt.empresa ;
							AND LNorcamento = orca_pgt.orcamento;
							AND orca_pgt.modo_pgto = 2
				SET DECIMALS TO 6
				*---------------------------------------------------*
				* Calculo de Diferenca Provocada na DivisÆo e Que ‚ Lan‡ada
				* na 1¦ Parcela
				*---------------------------------------------------*
			   	CVSTR1    = STR((orca_pgt.vlr_pgto) / (LNnumpgt) ,25,11)
			   	CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
	   			LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
			   	LNdifere  = orca_pgt.vlr_pgto - (LNvlrdupl * LNnumpgt)
				*---------------------------------------------------*
				LNocorrenc 		= 1
			    LNposic    		= 0
				LNdias			= 0
				LNproximodias	= 0  && Permite Diferenciar o
							 && Pgto com Entrada (000/031/000/000)
							 && do Pgto Conta Apresent‡Æo
							 && (000/000/000/...). No Primeiro Caso Quando
							 && LNdias = 0 (ou ser  a Entrada ou Invalido)
							 && e  nÆo ser  gerada Duplicatas. J  no
							 && Segundo Caso deve Ser Gerada Uma Dupl.
							 && Conta Apresenta‡Æo
			    LNinicio   	= 1

				DO WHILE .t.
					LNinicio = LNposic + 1										
			        LNdias       = INT(VAL(SUBS(LSprazo,LNinicio,3)))
					LNproximodias= INT(VAL(SUBS(LSprazo,LNinicio+4,3)))

			        LNposic = AT("/",LSprazo, LNocorrenc)  && PASSA PARA
			        									 && PROXIMA POSICAO
			        									 && DE INICIO DA
			        									 && DIA
					*-----------------------------------------------*
			   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
						EXIT
					ENDIF

					*-----------------------------------------------*
					* LNdias = 0 AND LNproximodias => Conta Apresenta‡Æo
					*-----------------------------------------------*
					IF LNdias = 0 AND LNproximodias > 0 && Descarte da
														&&  Entrada
						LNocorrenc = LNocorrenc + 1
						LOOP
					ENDIF
					**************************************************




					m.duplicata	= ;
					   INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
							  CHRTRAN(STR(LNserie,2)," ","0");
								  ))   && 1 => DUPLICATA





					m.tp_parcela= orca_pgt.tp_parcela
					m.moeda 	= orca_pgt.moeda

					IF m.moeda = 3 && Se Duplicata Direcionar 1§ para
					               && Carteira e esta remete para
					               && Banco
						m.portador 	=  0   && CARTEIRA
					ELSE
						m.portador 	= orca_pgt.banco
					ENDIF



					***m.vlr_doc  	= LNvlrdupl + LNdifere


					m.vlr_doc	 =	LNvlrdupl - LNvl_issrtd + LNdifere

					m.vlr_issrtd =  LNvl_issrtd
					LNvl_issrtd  =  0



					m.vlr_pgto  = 0
					LNdifere   	= 0			&& Proxima nÆo agrega Diferen‡a
					m.dt_venc  	= m.dt_emi + LNdias


					IF TYPE("orcament.AJSTFIMSEM") = "U"
						=CRajustaVenc(m.dt_venc,"+")
					ELSE
						IF orcament.AJSTFIMSEM <> "N"
							=CRajustaVenc(m.dt_venc,"+")
						ENDIF
					ENDIF

					*--------------------------------------------------*
					*CALCULO  VENDOR--*
					*--------------------------------------------------*
		 			m.VLR_COMPRA = orcament.valor

					m.vlr_encarg = 0
				    m.vlr_ioffnc = 0
					m.TotVlVendr = 0

					IF m.tp_parcela = 6   && VENDOR


						=W_DEFPROC("duplicat.spr")
						IF !CRtxsVendor(m.Empresa,m.Dt_Emi,;
								m.dt_venc,m.Tp_Pessoa,;
						  		AIA,;
						  		AIOF,;
						  		d,;
						  		m.TX_JUROSCP,;
						  		m.TX_JUROSVD)

							STORE 0 TO 	AIA,AIOF,m.TX_JUROSCP,m.TX_JUROSVD
						ENDIF


			 			
						=W_DEFPROC("duplicat.spr")
						=CRcalcVendor(m.Empresa,;
							m.vlr_doc,;
							m.dt_emi,;
							m.dt_venc,;
							m.Tp_Pessoa,;
	   			    		m.FlgImbuteIOF,;
			        		m.vlr_encarg,;
    			    		m.vlr_ioffnc,;
	        				m.TotVlVendr,;
	        				m.vlr_encbco)
					ENDIF

					*--------------------------------------------------*
					*--------------------------------------------------*
					*--------------------------------------------------*


					m.obs =""
					m.dtproxproc= m.dt_venc
					*---------------------------------------------------*		
					* EM COMPRAS A PRAZO COM A 1a DUPLICATA (TP_PARCELA = 3)
					*   COMO CONTA APRESENTACAO, ESTA 1a E
					* 	DIRECIONADA P/ A CARTEIRA E A DEMAIS
					* 	P/ O BANCO SOLICITADO. LNbanco GUARDO O
					* 	BANCO SOLICITADO P/ USO APOS GERAR A 1a
					*---------------------------------------------------*
					LNtmp  = m.dt_venc - m.dt_emi
				    IF  LNtmp <= 7  AND orca_pgt.tp_parcela = 3
	    						    && DUPLICATA CONTA APRESENTACAO
						m.banco = 0		 	&& DIRECIONA P/ CARTEIRA
					ELSE
						m.banco = orca_pgt.banco
										 && DIRECIONA P/ BANCO SOLICITADO	
					ENDIF

					m.carteira  = ""
					m.variacao  = ""
					m.convenio  = ""
		            m.conta     = ""
		            m.conta_dv  = ""
                    m.agencia   = 0
                    m.agencia_dv= ""
					*-----------------------------------------------*


	 	    	    m.NUM_NO_BCO = ""
	     	        IF PrmImpBoleto = "SEM BOLETO"
			 	        =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    			 	   "GERADOR DUPLICATA", m.Carteira,m.Variacao,;
			    	 	     m.convenio,m.conta,m.conta_dv,;
			    	     	 m.agencia,m.agencia_dv)
	 	            ELSE
     	    	       =CRdefcarteira(m.Empresa,m.banco,m.Tp_Parcela,;
	    	 			   "EMISSOR BOLETO", m.Carteira,m.Variacao,;
	  			    	     m.convenio,m.conta,m.conta_dv,;
		 		    	     m.agencia,m.agencia_dv)
	 	    		   DO CASE
		 		    		CASE m.BANCO = 001
			 			     m.NUM_NO_BCO = ;
	    		 				 CR_001geraNssNro(m.Empresa,;
	    			 			  001,m.carteira,m.variacao)
	 	    				CASE m.BANCO = 237
		 		    		  m.NUM_NO_BCO = ;
			 			         CR_237geraNssNro(m.Empresa,;
				 		          237,m.carteira,m.variacao)
	 	    			ENDCASE
	 			        m.NUM_NO_BCO = CHRTRAN(m.NUM_NO_BCO," ","0")
	 	    		ENDIF
					*-----------------------------------------------*
  				    *-----------------------------------------------*
                    m.dt_p_desct = m.dt_venc
                    m.dt_cbr_jrs = m.dt_venc

        		    LNdias = 0
        		    m.dt_protest =  m.dt_venc
        		    DO WHILE LNdias < 5
        		        m.dt_protest =  m.dt_protest + 1
        			    IF dow(m.dt_protest) <> 1 AND dow(m.dt_protest) <> 7
        			    	LNdias = LNdias + 1
        			    ENDIF
        		    ENDDO
        		    m.vlr_mora = m.vlr_doc * empresa.mora / 100
                    m.vlr_juros = 0
                    m.vlr_dsct  = 0
				    *-----------------------------------------------*


					SELE  duplicat
			        SET ORDER TO TAG DOC
			        SEEK STR(m.EMPRESA,3)+STR(m.DUPLICATA,9)
			        IF !FOUND()
						=edithand('SAVE')
					ENDIF



					LNserie    = LNserie + 1
					LNocorrenc = LNocorrenc + 1
				ENDDO
				SELE orca_pgt
				SKIP
			ENDDO

	ENDCASE

	*-----------------------------------------------------------*
	SET DECIMALS TO 2
	=UP_fecha("duplicat"  ,LFduplicata )
	=UP_fecha("empresa"   ,LFempresa   )
	=UP_fecha("orcamento" ,LForcamento )
	=UP_fecha("clienc" ,LFclienc )
	=UP_fecha("orca_pgt"  ,LForca_pgt )
	=UP_fecha("clientes"  ,LFclientes )
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4TW           EMGet_UF VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    2   º
*       º Variable:            EMGet_UF                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      377                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4tw     &&  EMGet_UF VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_UF
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("ESTADO"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4U6           EMGet_Juro VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    3   º
*       º Variable:            EMGet_Juro                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      378                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4u6     &&  EMGet_Juro VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Juro
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("JUROMES"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4UF           verif VALID                        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    4   º
*       º Variable:            verif                              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      379                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4uf     &&  verif VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION UVerifEmp
PARAMETERS LNemp,LSnome,LNkey
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFempresa
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	LFempresa		= NetArq("empresa")
	IF (LFempresa) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("empresa" ,LFempresa)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	SELECT empresa
	SET ORDER TO TAG empresa
	IF LNkey = 9
	   ON KEY LABEL ESCAPE
	   DO loc_dlog WITH .F.
	   ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	   LNemp	  = empresa.empresa
	ENDIF

	SET NEAR ON
	SEEK LNemp
   	IF LASTKEY() = 27 OR !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LFretorno = .F.
	ELSE
		LSnome  = empresa.sigla
		LFretorno = .T.
	ENDIF
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	=UP_fecha("empresa" ,LFempresa)
RETURN(LFretorno)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4W7           EMrodanroNF VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    5   º
*       º Variable:            EMrodanroNF                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      380                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4w7     &&  EMrodanroNF VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION EMrodanroNF
PARAMETERS LNemp,LStp_process
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Incrementar Numeracao de Nota/Cupom
	*	
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LStp_process...: Processo definido em NFDefProcess
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	=REGLOCK(.T.)
	DO CASE
		CASE LStp_proces = "NOTA" OR LStp_proces = "NOTA/CUPOM"
			REPLACE empresa.nota WITH empresa.nota + 1 && ULTIMA NOTA GERADA
			REPLACE FLAGIMPNF 	WITH 1
		CASE LStp_proces = "CUPOM"
			REPLACE empresa.ult_cupom  WITH ult_cupom + 1
			REPLACE FLAGIMPCPM 	WITH 1
		CASE LStp_proces = "NF.SERVICO"
			REPLACE empresa.Ult_NFsrvc WITH empresa.Ult_NFsrvc + 1
			REPLACE FLAGIMPSRV 	WITH 1

	ENDCASE
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4WF           EMGet_Mora VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    6   º
*       º Variable:            EMGet_Mora                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      381                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4wf     &&  EMGet_Mora VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Mora
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("MORA"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4WL           EMGet_Sigla VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    7   º
*       º Variable:            EMGet_Sigla                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      382                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4wl     &&  EMGet_Sigla VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Sigla
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("SIGLA"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4WM           EMGet_ECFSerie VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    8   º
*       º Variable:            EMGet_ECFSerie                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      383                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4wm     &&  EMGet_ECFSerie VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_ECFSerie
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("ECF_SERIE"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4WN           EMGet_Municipio VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:    9   º
*       º Variable:            EMGet_Municipio                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      384                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4wn     &&  EMGet_Municipio VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Municipio
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("CIDADE"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4WO           EMGet_TabCst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   10   º
*       º Variable:            EMGet_TabCst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      385                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4wo     &&  EMGet_TabCst VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_TabCst
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("TAB_CST"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4WP           EMLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   11   º
*       º Variable:            EMLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      386                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4wp     &&  EMLerRegistro VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMLerRegistro
PARAMETERS  PrmEmp



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = EMChk_Identidade(PrmEmp)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4WQ           EMSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   12   º
*       º Variable:            EMSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      387                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4wq     &&  EMSalvarRegistro VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMSalvarRegistro

	=EMVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !EMExiste()
		SELE &PBEmpresaAlias
		APPEND BLANK
		LFretorno=EMWriteProp()
	ELSE
		SELE &PBEmpresaAlias
		LFretorno=EMWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4XK           EMExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   13   º
*       º Variable:            EMExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      388                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4xk     &&  EMExiste VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION EMExiste
	PRIVATE LEmpresa

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=EMVerifyInst()

	LEmpresa    = EMGetPropVT("Empresa")


	SELE &PBEmpresaAlias
	SET ORDER TO TAG empresa
	SEEK Lempresa

	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4XQ           EMVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   14   º
*       º Variable:            EMVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      389                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4xq     &&  EMVerifyInst VALID
#REGION 11
return
*---------------------------------------------------------------*



FUNCTION EMVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Empresa")


	DO CASE

		CASE TYPE("PBEmpresalias") = "U" ;
		   		OR EMPTY(PBEmpresaAlias) ;
		   		OR !USED(PBEmpresaAlias)
			=EMCreate()					

		CASE !("EMPRESA.DBF" $ DBF(PBEmpresaAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBEmpresaAlias
			=EMCreate()					


		CASE  !(LSPath $ DBF(PBEmpresaAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=EMDestroi()				
			=EMCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4XX           EMCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   15   º
*       º Variable:            EMCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      390                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4xx     &&  EMCreate VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION EMCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBEmpresaAlias") <> "U" ;
	   		AND !EMPTY(PBEmpresaAlias) ;
	   		AND USED(PBEmpresaAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBEmpresaAlias

	IF USED("Empresa")
	     =NetArqAgain("Empresa")
	     PBEmpresaAlias     = Alias()
	ELSE
	     =NetArqAgain("Empresa")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Empresa")
	     PBEmpresaAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBEmpresaAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTEmpresa[LMaxDim]
    PUBLIC DIMENSION VDEmpresa[2,3]			&& VETOR PARA PROPRIEDADES
	*-----------------------------------------------------------*
	=EMReadProperty()
	=EMSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4Y3           EMDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   16   º
*       º Variable:            EMDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      391                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4y3     &&  EMDestroi VALID
#REGION 11
return
*---------------------------------------------------------------*


FUNCTION EMDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBEmpresaAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBDocFiscaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBDocFiscaAlias
	*  3- Se aplicar um FECHAMENTO a PBDocFiscaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBDocFiscaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBEmpresaAlias)) OR ;
	   !("EMPRESA.DBF" $ DBF(PBEmpresaAlias))

		RELEASE PBEmpresaAlias
    	RELEASE VTEmpresa
	    RELEASE VDEmpresa
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBEmpresaAlias) AND USED(PBEmpresaAlias)
		SELECT &PBEmpresaAlias
		USE
	ENDIF	
	RELEASE PBEmpresaAlias
    RELEASE VTEmpresa
    RELEASE VDEmpresa

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4Y4           EMReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   17   º
*       º Variable:            EMReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      392                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4y4     &&  EMReadProp VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION EMReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=EMVerifyInst()

	SELE &PBEmpresaAlias
	SCATTER TO VTEmpresa
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4Y5           EMSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   18   º
*       º Variable:            EMSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      393                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4y5     &&  EMSetDerivadas VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION EMSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

**	=EMVerifyInst()
	*--------------------------------------------------------------*
    VDEmpresa(1,1) = "NAOINFORMADO"
   	VDEmpresa(1,2) = 0
   	VDEmpresa(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4Y6           EMSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   19   º
*       º Variable:            EMSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      394                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4y6     &&  EMSetPropVT VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION EMSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

**	=EMVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,PrmValue,;
						    PBEmpresaAlias,VTEmpresa,VDEmpresa)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4Y7           EMGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   20   º
*       º Variable:            EMGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      395                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4y7     &&  EMGetPropVT VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION EMGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

**	=DFVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,PBEmpresaAlias,VTEmpresa,VDEmpresa)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4Y8           EMChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   21   º
*       º Variable:            EMChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      396                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4y8     &&  EMChk_Identidade VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMChk_Identidade
PARAMETERS  PrmEmp


	PRIVATE LFretorno
	LFretorno = .t.



	=EMVerifyInst()

    =EMSetPropVT("EMPRESA",PrmEmp)
	LFretorno=EMFind()

RETURN(LFretorno)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4Z8           EMFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   22   º
*       º Variable:            EMFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      397                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4z8     &&  EMFind VALID
#REGION 11
return
*---------------------------------------------------------------*
FUNCTION EMFind

	PRIVATE Lcodigo
	PRIVATE LFreturn

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=EMVerifyInst()

	Lcodigo   = EMGetPropVT("EMPRESA")

	SELE &PBEmpresaAlias
	SET ORDER TO TAG empresa
	SEEK Lcodigo

	IF FOUND()
		=EMReadProperty()
		=EMSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)






*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4ZF           EMGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   23   º
*       º Variable:            EMGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      398                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4zf     &&  EMGetFieldValue VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION EMGetFieldValue
PARAMETERS  PrmEmp,PrmField			


	IF !EMChk_Identidade(PrmEmp)
		DO WHILE .T.
			=UPerrosys("Chamada GetFieldValue para Reg. Inexistente!")
		ENDDO
	ENDIF				

RETURN(EMGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4ZK           EM_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   24   º
*       º Variable:            EM_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      399                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4zk     &&  EM_Refresh VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EM_Refresh
PARAMETERS  PrmEmpresa
	

	PRIVATE LFreturn

	=EMVerifyInst()


	= EMSetPropVT("Empresa"   ,PrmEmpresa)

	*----------------------------------------------------------------*


	=EMFind()
	
RETURN(.t.)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4ZL           EMWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   26   º
*       º Variable:            EMWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      400                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4zl     &&  EMWriteProp VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION EMWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=EMVerifyInst()

	SELE &PBEmpresaAlias
	=RLOCK()
	GATHER FROM  VTEmpresa
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4ZM           EMGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   28   º
*       º Variable:            EMGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      401                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4zm     &&  EMGetAlias VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION EMGetAlias

	=EMVerifyInst()

RETURN(PBEmpresaAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4ZN           EMMarcaFlgNF VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   30   º
*       º Variable:            EMMarcaFlgNF                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      402                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4zn     &&  EMMarcaFlgNF VALID
#REGION 11
return
*---------------------------------------------------------------*

FUNCTION EMMarcaFlgNF
PARAMETERS LNemp,PrmNivelProcesso
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Incrementar Flag Nota/Cupom
	*	
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	=REGLOCK(.T.)

	REPLACE FLAGIMPNF 	WITH PrmNivelProcesso

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4ZO           EMGet_ECFModelo VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         EMPRESA,     Record Number:   31   º
*       º Variable:            EMGet_ECFModelo                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      403                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4zo     &&  EMGet_ECFModelo VALID
#REGION 11
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_ECFModelo
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("TIPO_ECF"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS4ZP           TRGet_IPIProd VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    4  º
*       º Variable:            TRGet_IPIProd                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      404                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls4zp     &&  TRGet_IPIProd VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IPIProd
PARAMETERS PrmProduto

    PRIVATE LNipialq

	=W_DEFPROC("GRUPO.SPR")
	LNipialq =GRGetFieldValue(PrmProduto,"ALIQ_IPI")

RETURN(LNipialq)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS50M           TRGet_ISSAlq VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    5  º
*       º Variable:            TRGet_ISSAlq                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      405                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls50m     &&  TRGet_ISSAlq VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_ISSAlq
PARAMETERS PrmEmpresa


    PRIVATE LNaliq_iss

	=W_DEFPROC("EMPRESA.SPR")
	LNaliq_iss =EMGetFieldValue(PrmEmpresa,"ALIQ_ISS")

RETURN(LNaliq_iss)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS50S           TRdefcst VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    6  º
*       º Variable:            TRdefcst                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      406                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _43a0ls50s     &&  TRdefcst VALID
#REGION 12
RETURN

FUNCTION TRdefcst
	PARAMETERS Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto,PrmCst

	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_tab_cst,ALS_tab_cst
	LSalias = ALIAS()

    ARQ_Tab_Cst     = NetArqAgain("TAB_CST")
    ALS_Tab_Cst     = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()



	IF ( ARQ_Tab_Cst)+ ARQ_Tipooper > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ PrmTipo
	IF !FOUND()
		SEEK 's'+  PrmTipo
	ENDIF
	IF !FOUND()
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF



	LScst = " "
	DO CASE
		CASE &Als_tipooper .ch_opera = "4"  && DEVOLUCAO
			LScst =  PrmCST
		OTHERWISE
			SELECT &Als_tab_cst
			SET ORDER TO TAG cst
			SEEK STR(Prmtab_cst,2)+PrmTipo+STR(Prmtp_mercad,1)
			IF !FOUND()
				IF tipooper.ch_opera = "3"
					LScst =  "4"
				ENDIF
			ELSE
				LScst =  RIGHT( &Als_tab_cst .cst,1)
			ENDIF
	ENDCASE
	*------------------------------------------------------------*
    =up_fecha("&ALS_Tab_cst")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS50Z           TRAlqIcmInUF VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    7  º
*       º Variable:            TRAlqIcmInUF                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      407                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls50z     &&  TRAlqIcmInUF VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRAlqIcmInUF
PARAMETERS PrmUF

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    LSAlias      = Alias()
    LNaliq_icms = 0
	*--------------------------------------------------------*
	DO CASE
		CASE PrmUF $ "MG/RJ/SP/PR/SC"
		    LNaliq_icms = 18
		OTHERWISE
		    LNaliq_icms = 17
	ENDCASE
	*--------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS516           TRAlqIcmOuUF VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    8  º
*       º Variable:            TRAlqIcmOuUF                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      408                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls516     &&  TRAlqIcmOuUF VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRAlqIcmOuUF
PARAMETERS PrmUF, PrmOrigemMercadoria

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    LSAlias      = Alias()
    LNaliq_icms = 0


    IF TYPE("PrmOrigemMercadoria") = "L"   && NAO FOI REPASSADO PARAMETRO -
                                           && CHAMADA ROTINA ANTIGA
		PrmOrigemMercadoria = 0

    ENDIF





	*--------------------------------------------------------*

	DO CASE
		CASE PrmOrigemMercadoria = 2
		    LNaliq_icms = 4

		CASE PrmUF $ "MG/RJ/SP/PR/SC"
		    LNaliq_icms = 7
		OTHERWISE
		    LNaliq_icms = 12
	ENDCASE
	*--------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS517           TRCFO VALID                        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    9  º
*       º Variable:            TRCFO                              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      409                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls517     &&  TRCFO VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRCFO
PARAMETERS PrmEmpresa, PrmTipo, PrmTp_mercad,PrmOperacao

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*

	*------------------------------------------------------------*

    PRIVATE LScfo
    PRIVATE LSalias
    PRIVATE PrmTp_mercad

    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()


	STORE 0 TO ARQ_Tipooper
	*--------------------------------------------------------
	IF TYPE("TRtipooperALIAS") = "U" OR !USED(TRtipooperALIAS)
		PUBLIC TRtipooperALIAS
	    ARQ_Tipooper     = NetArqAgain("TIPOOPER")
	    TRtipooperALIAS  = Alias()
	ENDIF
    ALS_Tipooper     = TRtipooperALIAS


    LScfo = SPACE(5)
	*--------------------------------------------------------*

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	IF UPPER(PrmOperacao) = "SAIDA"
		SEEK 'S'+ PrmTipo
		IF !FOUND()
			SEEK 's'+  PrmTipo
		ENDIF
	ELSE
		SEEK 'E'+ PrmTipo
		IF !FOUND()
			SEEK 'e'+  PrmTipo
		ENDIF
	ENDIF

	*--------------------------------------------------------*

	IF !FOUND()
   		*=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF

		IF  PrmTipo = "CPM"
		   LScfo = "5.929"
		ENDIF
		
        RETURN(LScfo)
	ENDIF


	*------------------------------------------------------*

	DO CASE


		CASE  PrmTipo = "CPM"
		   LScfo = "5.929"


		CASE PrmTp_mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs


		CASE     PrmTp_mercad = 7 ;
		  	 AND UPPER(PrmOperacao) = "SAIDA" ;
			 AND &Als_tipooper .ch_opera = "1"  && Venda/Compra SERVICO


		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO

		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE

	LScfo = LEFT(ALLTRIM(LScfo)+"   ",5)

	*------------------------------------------------------------*
	*=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LScfo)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS518           TRGet_IPIAlq VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   10  º
*       º Variable:            TRGet_IPIAlq                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      410                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls518     &&  TRGet_IPIAlq VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IpiAlq
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto

	=W_DEFPROC("rotinas.spr")

    PRIVATE LNipialq
    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNipialq = 0
	*--------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA

	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
		RETURN(LNipialq)
	ENDIF


    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF
	*------------------------------------------------------------*

	DO CASE
		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA
		CASE &Als_Grupo .origem = 1

			LNipialq   =  TRGet_IPIProd(PrmProduto)

		OTHERWISE
			LNipialq   =	0
	ENDCASE

	*------------------------------------------------------------*

    DO TRFch_IPIAlqFecha

RETURN(LNipialq)

PROCEDURE TRFch_IPIAlqFecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS519           TRGet_cst VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   11  º
*       º Variable:            TRGet_cst                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      411                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls519     &&  TRGet_cst VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_cst
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto,PrmCST

	=W_DEFPROC("rotinas.spr")

    PRIVATE LScst
    PRIVATE LSalias

    PRIVATE LNtab_cst
    PRIVATE LNtp_mercad

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Orcamento,ALS_Orcamento

    LSAlias      = Alias()

    *----------------------------------------------------*
	LScst		= " "		&& ASSUME 0

    *----------------------------------------------------*

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()


    LScst  = " "

	LNtab_cst = 0

	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF

	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

 	LNtab_cst = &ALS_empresa .tab_cst

	*--------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF

	*------------------------------------------------------------*


    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)
	*---------------------------------------------------------------*
	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto)


	*------------------------------------------------------------*

    DO TRFch_CSTFecha

RETURN(LScst)

PROCEDURE TRFch_CSTFecha
	IF LScst = " "
		WP_MSG = "ATENCAO :  Nao foi Encontrada TABELA de C.S.T p/ "+;
			"[ Tab:"+STR(LNtab_cst,2)+;
			" Tipo:"+ &ALS_orcamento .tipo +" Mercad"+;
			STR(LNtp_mercad,1)+chr(13)+;
			"SOLICITE CADASTRO URGENTE !!!!!!."
			DO OBJ_ALER.SPR WITH WP_MSG
	ENDIF

    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Orcamento")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS528           TRDef_tpMercad VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   12  º
*       º Variable:            TRDef_tpMercad                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      412                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls528     &&  TRDef_tpMercad VALID
#REGION 12
RETURN


*--------------------------------------------------------------------*
* ESTA ROTINA ESTA VINCULADA AO ITEM DO ORCAMENTO E DEVE SER DESATIVADA
* EM (TRIBUTAR) QDO FOR MIGRADA PARA ITEM DE (ORCAMENTO OU ITEMMOV)
* COMENTARIO EM 14/05/2009
*---------------------------------------------------------------------*



FUNCTION TRDef_TpMercad
	PARAMETER PrmEmpresa,PrmOrcamento,PrmProduto


	=W_DEFPROC("rotinas.spr")

	PRIVATE LUFEmpresa
	PRIVATE	LNtp_mercad

	=W_DEFPROC("EMPRESA.SPR")
	LUFEmpresa = EMGetFieldValue(PrmEmpresa,"ESTADO")


	*--------------------------------------------------------


	LNtp_mercad	= 99999   && INVALIDO


	LNtp_mercad=;
		TRDef_RgTrbMercad( LUFEmpresa ,PrmProduto)

	*--------------------------------------------------------


RETURN(LNtp_mercad)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS52F           TRGet_rduIcms VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   13  º
*       º Variable:            TRGet_rduIcms                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      413                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls52f     &&  TRGet_rduIcms VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_rduIcms
PARAMETERS PrmEmpresa, PrmOrcamento

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
    *     Definir melhor as regras de reducao de base de ICMS
    * Por enquanto :
    *   FILIAL ARG => Usa reducao informada no registro da empresa
    *   Outras situacaoes ocorrem conforme a operacao e o indice
    *   deve ser informado no tipooper e atribuido ao orcamento
	*------------------------------------------------------------*

    PRIVATE LNaliq_rdu
    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNaliq_rdu = 0
	*--------------------------------------------------------*


    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF


	*------------------------------------------------------------*

	LNalq_rdu    =  0
	IF &Als_empresa .REDUZ_BASE = 0
		LNalq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNalq_rdu = &Als_empresa .REDUZ_BASE
		ELSE
			LNalq_rdu = &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA

		endif
	ENDIF

	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_rdu)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS52O           TRGet_IcmsAlq VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   14  º
*       º Variable:            TRGet_IcmsAlq                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      414                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls52o     &&  TRGet_IcmsAlq VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IcmsAlq
PARAMETERS PrmEmpresa, PrmOrcamento

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    PRIVATE ARQ_Empresa   , ALS_Empresa
    PRIVATE ARQ_Orcamento , ALS_Orcamento
    PRIVATE ARQ_Tipooper  , ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNaliq_icms = 0
	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF


	*------------------------------------------------------------*

	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms  =  &Als_orcament .aliq_icms && USAR ALIQUOTA INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA INFORMADA
	ENDIF

	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS52P           TRGet_CFO VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   15  º
*       º Variable:            TRGet_CFO                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      415                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls52p     &&  TRGet_CFO VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_CFO
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*

	*------------------------------------------------------------*

    PRIVATE LScfo
    PRIVATE LSalias
    PRIVATE LNtp_mercad

    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()


    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LScfo = ""
	*--------------------------------------------------------*



	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LScfo)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LScfo)
	ENDIF


	*------------------------------------------------------*


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)

	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE PrmTp_mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE


	*------------------------------------------------------------*
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LScfo)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS52Q           TRcalc_tribu VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   16  º
*       º Variable:            TRcalc_tribu                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      416                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls52q     &&  TRcalc_tribu VALID
#REGION 12
RETURN

FUNCTION TRcalc_tribu
	PARAMETERS LNemp,LStipo,LScst,LNvlrvenda,LNtp_mercad;
				LNalq_iss,LNalq_icms,LNalq_ipi,LNalq_rdu,;
				LNiva,;
				LDdata,;
				LSufdesti,;
				LNqtde,;
				LScodprd,;
				LNbsIss,LNvlrIss,;
				LNbsIcms,LNvlrIcms,LNbsIsent,;
				LNbsSbBrt,LNbsSubs,LNicmSub,LNbsOutr,;
		        vTParam

	LNbsIpi      = vTParam[01]
	LNvlrIpi     = vTParam[02]
	LNbsIsIpi    = vTParam[03]
	LNbsbrIcms   = vTParam[04]
    PrmSeg       = vTParam[05]
    LNissrtd     = vTParam[06]
    PrmSbstISS   = vTParam[07]


	*----------------------------------------------------------*
    *    O Numero maximo de parametros passados a uma UDF e 24
    * o vTParam aplia essa condicao (mas por questoes de facilidade o
    * vetor so e utilizado para completar os parametros excedentes)
	*----------------------------------------------------------*


	*------------------------------------------------------------*
	*  CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	*  OBJETIVO.......: Calcular Valores TRIBUTARIAS E FISCAIS
	*------------------------------------------------------------*
	*  COMENTARIO.....:
	*------------------------------------------------------------*
	*  OBS............:
	*------------------------------------------------------------*
	*  TABELAS.......:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LStipo.....:
	*		LScst......: Codigo Situacao Tributaria
	*		LNvlrvenda.: Valor da Venda (Movimentacao)
	*		LNtp_mercad:
	*		LNalq_iss..:
	*		LNalq_icms.:
	*		LNalq_ipi..:
	*		LNalq_rdu..:
	*		LNiva......:
	*		LDdata.....:
	*		LSufdesti..:
	*		LNqtde.....: Para atendeder necessidade no calc base IPI
	*					 da transferencia
	*		LScodprd...: As Rotinas Novas > 22/08/2000 passam o
	*                  Codigo do Produto LEN(LScodprd) = 11 e as
	*                  antigas , que devem ser substituidas usam
	*                  a Classifica‡Æo LEN(LScodprd) > 11
	*                  => Quando Vier o Codigo => Ler Grupo e Achar a
	*                  Classifica‡Æo para uso interno desta Rotina
	*
	*	Para atendeder necessidade no calc base IPI
	*					 da transferencia
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNbsIss....:
	*		LNvlrIss...:
	*		LNbsIcms...:
	*		LNvlrIcms..:
	*		LNbsIsent..:
	*		LNbsSbBrt..:
	*		LNbsSubs...:
	*		LNbsOutr...:
	*		LNbsIpi....:
	*		LNvlrIpi...:
	*		LNbsIsIpi..:
	*		LNbsbrIcms.:
	*------------------------------------------------------------*
	* CHAMADAS : OBJ_ITOR.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LNbs_TRIBUTAR		&& BASE PARA TIBUTAR
	PRIVATE LDdtpesq			&& PARA PESQUISA DE BASE IPI TRANSD
	PRIVATE LSclasprd


    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_Saldo,ALS_Saldo

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Saldo  = NetArqAgain("SALDO")
    ALS_Saldo  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

	*------------------------------------------------------------*
	IF LEN(LScodprd) > 11
		LSclasprd = LScodprd
	ELSE
		SELE &ALS_grupo
		SET ORDER TO TAG codigo
		SEEK LScodprd
		IF !FOUND()
			LSclasprd = ""
		ELSE	
			LSclasprd = &ALS_grupo .classifica
		ENDIF
	ENDIF
	*------------------------------------------------------------*
	SELECT &ALS_tipooper
	SET ORDER TO tag tipo
	SEEK "S"+LStipo
	IF !FOUND()
		SEEK "s"+LStipo
		IF !FOUND()
		    DO TRcalc_Fecha
			RETURN(.f.)
		ENDIF
	ENDIF
	*------------------------------------------------------------*
	SELECT &ALS_empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
	    DO TRcalc_Fecha
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	STORE 0 TO LNbsIss,LNvlrIss,LNbsIcms,LNvlrIcms,LNbsIsent,;
			LNbsSbBrt,LNbsSubs,LNbsOutr,LNbsIpi,LNvlrIpi,LNbsIsIpi
			
	STORE 0 TO LNissrtd
	
	*------------------------------------------------------------*
	*		TRIBUTOS INDEPENDENTES DA SITUACAO TRIBUTARIA
	*------------------------------------------------------------*
	*	Calculo envolvendo ISS
	*		-tp_mercad= 7 => SERVICO
	*------------------------------------------------------------*
	LNbsIss		=	0
	LNvlrIss	=	0
	IF LNtp_mercad = 7
		LNbsIss	 =	LNvlrvenda
		LNvlrIss =  ROUND(LNbsIss * ROUND(LNalq_iss  / 100,4),2)
	ENDIF
	
	*------------------------------------------------------------*
	*	Calculo envolvendo ISS RETIDO
	*------------------------------------------------------------*
	LNIssRtd	=	0
	IF PrmSbstISS = 1  && se = 1 segumento retem iss
		LNIssRtd = LNvlrIss
	ENDIF
	
	*------------------------------------------------------------*
	*	Calculo envolvendo IPI
	*		-Devolucao:		A base do IPI e o proprio vlrvenda
	*		-Outras   : 	O IPI ja esta embutido no valor de
	*				de venda. Por isso e necessario retira-lo
	*				para determinar a base Original
	*------------------------------------------------------------*
	LNbsIpi 	= 	0
	LNvlripi 	= 	0
	LNbsIsIp	=	LNvlrvenda
	IF LNalq_Ipi > 0
		DO CASE
			CASE &ALS_tipooper .ch_opera = "4" 	&& DEVOLUCAO
				LNbsIpi  = LNvlrvenda
			CASE &ALS_tipooper .ch_opera = "2" 	&& TRANSFERENCIA
				*----------------------------------------------------*
				*  CASO DAS IMPORTACOES INICIADAS EM 2006
				*----------------------------------------------------*
				LNbsIpi  = LNvlrvenda
			CASE &ALS_tipooper .ch_opera = "2" 	&& TRANSFERENCIA
				*----------------------------------------------------*
				*  CASO ANTIGO QDO AS IMPORTACOES FORAM TRATADAS
				* DE FORMA ERRADA
				*----------------------------------------------------*
				*    	Determina o Ultimo dia do mes Anterior para
				*   data de pesquisa E MES ANTERIOR P/ O REGISTRO DO
				*   SALDO
				*     MOTIVO : A base do ipi nas transferencias
				*			e a media do valor de venda nos meses
				*			anteriores
				*----------------------------------------------------*
				LDdtpesq   = LDdata - DAY(LDdata)
				SELE &ALS_SALDO
				SEEK STR(LNemp,3)+LSclasprd+;
							STR(YEAR(LDdata),4)+;
						 	 STR(MONTH(LDdata),2)
				*----------------------------------------------------*
				*    Caso nao seja possivel determinar a media
				*  sera considerado o custo medio ANTERIOR OU ATUAL
				*	(ULTIMO CASO)
				*----------------------------------------------------*
				DO CASE
					CASE FOUND() AND &ALS_saldo .sld_ante > 0
					   LNbsipi = &ALS_saldo .vlr_ante / &ALI_saldo .sld_ante
					CASE FOUND() AND &ALS_saldo .sld_atu  > 0
					   LNbsipi = &ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
				ENDCASE					
				*----------------------------------------------------*
				DO WHILE LDdtpesq > {31.12.1994}
					SEEK STR(LNemp,3)+LSclasprd+;
							STR(YEAR(LDdtpesq),4)+;
						 	 STR(MONTH(LDdtpesq),2)
					IF !FOUND() OR &ALS_SALDO .qtd_venda = 0
	   					LDdtpesq   = GOMONTH(LDdtpesq,-1)
						LOOP
					ENDIF					
					LNbsipi = &ALS_SALDO .ven_enc / &ALS_SALDO .qtd_venda
					IF LDdata <= {24.06.1998}
						LNbsipi	= LNbsipi * 0.70
					ELSE
						LNbsipi	= LNbsipi * 0.90
					ENDIF						
					EXIT
				ENDDO			
				LNbsipi = LNbsipi * LNqtde
			OTHERWISE
				LNbsIpi  = ROUND(LNvlrvenda/(1+LNalq_ipi/100),2)
		ENDCASE
		LNvlripi 	= ROUND(LNbsIpi * ROUND(LNalq_ipi  / 100,4),2)
		LNbsIsIp	= 0
	ENDIF
	LNvlripi = TRcalc_Difer(LNvlripi,LNqtde,2)
	
	*------------------------------------------------------------*
	*		TRIBUTOS PELA SITUACAO TRIBUTARIA
	*------------------------------------------------------------*
	*  BASE DE INCIDENCIA DE TRIBUTOS
	*    - EM DEVOLUCOES O IPI COMPOE A BASE DE TRIBUTACAO
	*    - NAS OUTRAS OPERACOES O IPI E RETIRADO PARA COMPOR A
	*     BASE
	*------------------------------------------------------------*
	IF &ALS_tipooper .ch_opera $ "4/2" 	&& DEVOLUCAO/TRANSF
		LNbs_TRIBUTAR	= LNvlrvenda
	ELSE
		IF LDdata > {01.01.2000}
			*-----------------------------------------------------*
			&&    O IPI so passou a ser calculado nas saidas a partir
			&& de 01.01.2000 e mesmo assim conssideramos o ipi
			&& como sendo imbutido no valor particado
			&& por isso ele ‚ retirado para compor a tributacao
			&&    Uma checagem mais detalhada indicara uma diferenca
			&& nas notas anteriores a esta data pois o ipi foi calculado
			&& apos a emissÆo das notas(Contador PEDRO) e nao foi
			&& considerado para tributa‡Æo
			*----------------------------------------------------*
			LNbs_TRIBUTAR	= LNvlrvenda - LNvlrIpi
		ELSE
			LNbs_TRIBUTAR	= LNvlrvenda
		ENDIF
	ENDIF										
	*------------------------------------------------------------*
	*------>>> BASE BRUTA DE ICMS SEM CONSIDERAR REDUCOES
	DO CASE
		CASE LScst $ "0/1/2/7"		&& ENVOLVE MERCAD TRIBUTADA NORMAL
			LNbsbrIcms	= LNbs_TRIBUTAR
        OTHERWISE
   			LNbsbrIcms	= 0
	ENDCASE

	*------>>> BASE LIQUIDA  DE ICMS CONSIDERANDO  REDUCOES----*
    *    As reducoes podem ser em funcao da operacao = "0/1"
    *  ou em funcao da empresa CST = "2/7"
	*  OBS: As reducoes em funcao da operacao foram introduzidas
	*     apos mudancas no recolhimento de PIS/COFINS em que as NF
	*  da firestone vinham com reducao na base do icms e que em caso
	*  de devolucoes deveriam operar com reducao da base.....
    *----------------------------------------------------------*
	DO CASE
		CASE LScst $ "0/1"		&& ENVOLVE MERCAD TRIBUTADA NORMAL
			LNbsIcms	= LNbsbrIcms - ;
		             ROUND(LNbsbrIcms * LNalq_rdu/100,2)
		CASE LScst $ "2/7"		&& REDUZIR BASE DO ICMS
			LNbsIcms	= LNbsbrIcms - ;
		             ROUND(LNbsbrIcms * LNalq_rdu/100,2)
	ENDCASE

	*------------------------------------------------------------*
	*----------------->>> BASE SUBSTITUICAO <<<------------------*
	*------------------------------------------------------------*



	IF LScst $ "1/3/7/"		
		LNbsSbBrt	= LNbs_TRIBUTAR + LNvlrIpi
		*----> INTERESTADUAL  e CONSUMIDOR INSCRITO
		
		DO CASE

			CASE &ALS_tipooper .ch_desti = "2" ;
			     AND &ALS_tipooper .ch_contr = "2";
			     AND LDdata < CTOD("01.10.11")
                *--------------------------------------------*
                * regra anterior ao protocolo 21/2011 *
                *--------------------------------------------*
	
				LNbssubs = LNbs_TRIBUTAR + LNvlrIpi


			CASE &ALS_tipooper .ch_desti = "2"  ;
			     AND ;
			     (     &ALS_tipooper .ch_contr = "1";
			        OR &ALS_tipooper .ch_contr = "2";
			        OR &ALS_tipooper .ch_contr = "3";
			     )
				 *------------------------------------------------------*
	             * PROTOCOLO INTERESTADUAL 21/2011 CONFAZ EM VIGOR DESDE
    	         * junho/2011 equipara
    	         *  (1) - CONSUMIDOR ESTADUAL
    	         *  (2) - CONSUMIDOR INSCRITO
    	         *  (3) - CONSUMIDOR NAO INSCRITO
	             *  nas operacoes interestaduais
				 *-----------------------------------------------------*

				LNbssubs = LNbs_TRIBUTAR + LNvlrIpi







			CASE LScst $ "1/7" AND LDdata < CTOD("01.01.97")
				LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi) *  1.45)

			CASE LScst $ "3" AND &ALS_tipooper .ch_desti = "1"
				LNbssubs = ((LNbs_TRIBUTAR+LNvlrIpi)   *  1.225)
				*  qualquer situacao de retencao interna sera
				*	 entendida como reem bolso 1.225
				*	 (DEFINIDO COM PEDRO EM 17/04/97)

			CASE LScst $ "3" AND LDdata < CTOD("01.01.97")
				LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi) *  1.225)

			CASE &ALS_tipooper .ch_opera = "4"

				DO CASE
	               CASE LEFT(LSclasprd,2) $ "00/01"  ;
	                    OR LEFT(LSclasprd,5) $ "04042"
						*----------------------------------------------*
    	            	* REGRA TRATAR REDUCAO PIS COFIS PARA PNEUS
    	            	* CAMARAS E PROTETORES
						* Oliveira 21/09/2004 => Em fun‡Æo da altera‡Æo
						* do convenio 10/03 a redu‡Æo (PIS/COFINS) passa
						* a insidir sobre a base de substitui‡Æo
						*----------------------------------------------*
						IF LDdata < {05.03.2007}
						    LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
						    LNbssubs	= LNbssubs - ;
					             ROUND(LNbssubs * LNalq_rdu/100,2)
						ELSE
					    	LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
					    	LNbssubs	= LNbssubs - ;
			            	 ROUND((LNbs_TRIBUTAR*LNiva) * LNalq_rdu/100,2)

						ENDIF


				   OTHERWISE
						*----------------------------------------------*
    	        	    * REGRA TRATAR REUCAO ICMS PA PECAS
						* Oliveira 21/09/2004 => Em fun‡Æo da altera‡Æo
						* do convenio 10/03 a redu‡Æo (PIS/COFINS) passa
						* a insidir sobre a base de substitui‡Æo
						*----------------------------------------------*

				    	LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
					ENDCASE

			OTHERWISE
			    LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
		ENDCASE
	ENDIF
	*------------------------------------------------------------*
	*--------------------->>> OUTRAS <<<-------------------------*
	*------------------------------------------------------------*
	DO CASE
		CASE LScst = "0"		&& COM REDUCAO BASE CALCULO ICMS
		                        && atribuido apos mudanca pis cofins
			LNbsisent 	= LNbsbrIcms - LNbsicms
		CASE LScst = "1"		&& COM REDUCAO BASE CALCULO ICMS
		                        && BASICAMENT EM DEVOLUCOE
		                        && TRIBUTADA E COM SUBSTITUICAO
			LNbsisent 	= LNbsbrIcms - LNbsicms
		CASE LScst = "2"		&& COM REDUCAO BASE CALCULO ICMS
			LNbsisent 	= LNbs_TRIBUTAR - LNbsicms
		CASE LScst = "3"		&& ISENT. OU N. TRIB. E COM SUBST. TRIB
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "4"		&& ISENT. OU N. TRIB. E COM SUBST. TRIB
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "5"		&& COM SUSPENSAO OU DIFERIMENTO
			LNbsoutr 	= LNbs_TRIBUTAR
		CASE LScst = "6"		&& ICMS CABRADO ANTES POR SUBSTITUICAO
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "7"		&& COM REDUCAO BASE CALCULO ICMS POR SUBS
			LNbsisent 	= LNbs_TRIBUTAR - LNbsicms
	ENDCASE
	*---------------------- CALCULANDO VALORES ------------------*
	LNvlricms 	= LNbsicms * LNalq_icms / 100

	IF LNbssubs > 0
		IF LSufdesti $ "MG/SP/RJ" AND &ALS_tipooper .ch_opera <> "4"			
			*------ ALIQUOTA INTERNA 18 % ----*
			LNicmSub = ;
			 ((LNbssubs) * 0.18) - (LNbsIcms * LNalq_icms / 100)
		ELSE
        	LNicmSub = ;
        	 ((LNbssubs) * 0.17) - (LNbsIcms * LNalq_icms / 100)
		ENDIF
	ENDIF
	*------------------------------------------------------------*
    DO TRcalc_Fecha

	*------------------------------------------------------------*

	vTParam[01] = LNbsIpi
	vTParam[02] = LNvlrIpi
	vTParam[03] = LNbsIsIpi
	vTParam[04] = LNbsbrIcms
    vTParam[06] = LNissrtd


	*------------------------------------------------------------*
RETURN(.T.)


PROCEDURE TRcalc_Fecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Saldo")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS53R           CSTENT VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   17  º
*       º Variable:            CSTENT                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      417                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls53r     &&  CSTENT VALID
#REGION 12
RETURN

PROCEDURE TXMP


           * A ROTINA A SER DESENVOLVIDA DEVE SUBSTITUIR TRECHO DE
           * PROGRAMA ESCRITO EM SCT0310 QUE GERA O SINTEGRA E CORRIGE
           * O CST


			*---------------------------------------------------*			
			*  ATENCAO : Definir Regra para Informar corretamente
			*           CST em NOTAS DE ENTRADA
			*---------------------------------------------------*			

			IF itemmov.cst <> " "
				LScst   = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
					  LIVROENT.cst+ "0"
			ELSE
				DO CASE
					CASE LIVROENT.tp_mercad = 1 ;
					    and LIVROENT.base_calc > 0 ;
					    and LIVROENT.base_calc <> LIVROENT.vlrvenda
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
					CASE LIVROENT.tp_mercad = 1 and LIVROENT.base_calc > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "0"  + "0"
					CASE LIVROENT.tp_mercad = 1 and LIVROENT.base_calc = 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
					CASE   LIVROENT.tp_mercad = 2 ;
					   and LIVROENT.icms_subs > 0 ;
					   and LIVROENT.base_calc > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "1"  + "0"
					CASE LIVROENT.tp_mercad = 2 and LIVROENT.icms_subs > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "6"  + "0"
					CASE LEFT(LIVROENT.codigo,5) = "99999"
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "9"  + "0"
					OTHERWISE
						LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
				ENDCASE
			ENDIF
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS53Z           TRRtdoSaida VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   18  º
*       º Variable:            TRRtdoSaida                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      418                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls53z     &&  TRRtdoSaida VALID
#REGION 12
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser 
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido ‚ calculado conforme a f¢rmula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda nÆo trata de forma parametrizada
	*					 a aliquota interna e at‚ que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa‡Æo atual
	*					 em termos de Pneulƒndia
	*------------------------------------------------------------------*						

FUNCTION TRRtdoSaida
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNicms,LNbase_Icms,LNbase_Rtdo

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNicmsOrigem       && Aliquota Externa no Estado Origem
	PRIVATE LNicmsDestino      && Aliquota Interna no Estado Destino
 	
    LSAlias      = Alias()

	LNicms = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) &&
	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmInUF(LSufDestino) &&

	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNbase_Rtdo = TREbsRtdoCIVA(LSproduto,;
							LSufOrigem,;
							LSufDestino,;
							LNvlrMercadoria,;
							LNvlrIPI,;
							LNcdg_Forn)


	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2

  		   LNicms =  (LNbase_Rtdo * LNicmsDestino/100)-;
   	    	         (LNbase_Icms  * LNicmsOrigem/100)

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNicms)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS540           TRRtdoEntrada VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   19  º
*       º Variable:            TRRtdoEntrada                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      419                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls540     &&  TRRtdoEntrada VALID
#REGION 12
RETURN

FUNCTION TRRtdoEntrada
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn

	=W_DEFPROC("rotinas.spr")
				
	PRIVATE LSalias,LNicms,LNbase_Icms,LNbase_Rtdo

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNicmsOrigem       && Aliquota Externa no Estado Origem
	PRIVATE LNicmsDestino      && Aliquota Interna no Estado Destino
	PRIVATE LNiva			   &&
 	
	LNicms = 0.00
    LSAlias      = Alias()

	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) &&
	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmInUF(LSufDestino) &&
	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNbase_Rtdo = TREbsRtdoCIVA(LSproduto,;
							LSufOrigem,;
							LSufDestino,;
							LNvlrMercadoria,;
							LNvlrIPI,;
							LNcdg_Forn)



	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*


	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 1 and LNRgTrbDestino = 2

  		   LNicms =  (LNbase_Rtdo * LNicmsDestino/100)-;
   	    	         (LNbase_Icms  * LNicmsOrigem/100)


	    ENDIF
	ENDIF


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNicms)

*--------------   descartado em 6/10/2003
*  		   LNicms =  ((LNvlrMercadoria + LNvlrIPI);
*	   			 * LNiva * LNicmsDestino/100)-;
*	             (LNbase_Icms  * LNicmsOrigem/100)
*----------------

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS541           TRicmNormal VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   20  º
*       º Variable:            TRicmNormal                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      420                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls541     &&  TRicmNormal VALID
#REGION 12
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION UITicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula o ICMS NORMAL no Item de Entrada :
	*				-Sera Calculado para TP_MERCAD = 1
	*					(Mercadoria Tributada)
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*-------------------------------------------------------------------*						

FUNCTION TRicmNormal
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
				
	=W_DEFPROC("rotinas.spr")


	PRIVATE LSalias,LNicms,LNbase_Icms
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples

	LNicms = 0.00
    LSAlias      = Alias()

	
	*--------------------------------------------------------*
	=W_DEFPROC("forneced.spr")
	LNRgFiscFornecedor = FRrgm_Fisc(LNcdg_Forn)

    IF 	LSufOrigem = LSufDestino
		=W_DEFPROC("tributar.spr")
		LNicmsOrigem    =	TRAlqIcmInUF(LSufOrigem) && Aliquota Interna
	ELSE
		=W_DEFPROC("tributar.spr")
		LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) && Aliquota Externa
	ENDIF


	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)


	**** IF LNRgTrbOrigem = 1  AND LNRgTrbDestino = 1

	IF LNRgTrbDestino = 1 AND LNRgFiscFornecedor = 0
	    LNicms =  LNbase_Icms * LNicmsOrigem/100
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNicms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS542           TREnbsicmNormal VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   21  º
*       º Variable:            TREnbsicmNormal                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      421                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls542     &&  TREnbsicmNormal VALID
#REGION 12
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION Ubsicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula a Base ICMS NORMAL no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION TREnbsicmNormal
	PARAMETERS 	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
				
	=W_DEFPROC("rotinas.spr")


	PRIVATE LSalias,LNbase_Icms

    LSAlias      = Alias()

	LNbase_Icms = 0.00

	*--------------------------------------------------------*

    IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 	LNbase_Icms = LNvlrMercadoria - (LNvlrMercadoria * (4.9/100))
	ELSE
	 	LNbase_Icms = LNvlrMercadoria
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNbase_Icms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS543           TREbsRtdoCIVA VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   22  º
*       º Variable:            TREbsRtdoCIVA                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      422                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls543     &&  TREbsRtdoCIVA VALID
#REGION 12
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser 
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido ‚ calculado conforme a f¢rmula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda nÆo trata de forma parametrizada
	*					 a aliquota interna e at‚ que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa‡Æo atual
	*					 em termos de Pneulƒndia
	*------------------------------------------------------------------*						

FUNCTION TREbsRtdoCIVA
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNbase_Retido

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNiva			   &&
 	
    LSAlias      = Alias()

	LNbase_Retido = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")

	LNiva = TRGet_IVA( LSufOrigem,;
			            LSproduto,;
			            LSUFdestino ,;
			            wp_dtoper )

	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2
  	
  		  LNbase_Retido =  (LNvlrMercadoria + LNvlrIPI)

		  IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (4.9/100))
		  ENDIF

		  IF LNcdg_Forn = 2
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (5.19/100))
		  ENDIF

          LNbase_Retido = LNbase_Retido *  LNiva

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNbase_Retido)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS559           TREbsRtdoSIVA VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   23  º
*       º Variable:            TREbsRtdoSIVA                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      423                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls559     &&  TREbsRtdoSIVA VALID
#REGION 12
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser 
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido ‚ calculado conforme a f¢rmula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda nÆo trata de forma parametrizada
	*					 a aliquota interna e at‚ que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa‡Æo atual
	*					 em termos de Pneulƒndia
	*------------------------------------------------------------------*						

FUNCTION TREbsRtdoSIVA
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNbase_Retido

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
 	
    LSAlias      = Alias()

	LNbase_Retido = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2
  	
  		  LNbase_Retido =  (LNvlrMercadoria + LNvlrIPI)

		  IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (4.9/100))
		  ENDIF

		  IF LNcdg_Forn = 2
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (5.19/100))
		  ENDIF

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNbase_Retido)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS55I           TRcalc_Difer VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   28  º
*       º Variable:            TRcalc_Difer                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      424                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls55i     &&  TRcalc_Difer VALID
#REGION 12
RETURN

FUNCTION TRcalc_Difer
	PARAMETERS LNValorTotal,LNqtde,Lncasas
	*------------------------------------------------------------*
	PRIVATE LNajuste
	LNajuste = ROUND(LNValorTotal/LNqtde,Lncasas)*LNqtde
RETURN(LNajuste)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS55J           TRVincTipo VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   30  º
*       º Variable:            TRVincTipo                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      425                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _43a0ls55j     &&  TRVincTipo VALID
#REGION 12
RETURN

FUNCTION TRVincTipo
	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_TipoOper,ALS_TipoOper
    PRIVATE ARQ_ClasFisc,ALS_ClasFisc
	LSalias = ALIAS()

    ARQ_TipoOper     = NetArqAgain("TIPOOPER")
    ALS_TipoOper     = Alias()

    ARQ_ClasFisc     = NetArqAgain("CLASFISC")
    ALS_ClasFisc     = Alias()

	IF ( ARQ_TipoOper + ARQ_ClasFisc) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&Als_TipoOper")
        =up_fecha("&Als_ClasFisc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = " "
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*


	*-----------------------------------------------*
	*CRIAR CODIGO DA CLASSIFICACAO <CODCLASSIF>
	*-----------------------------------------------*



	SELE &ALS_ClasFisc
	SET ORDER TO TAG CFOP
	GO TOP

	CTRCFOP = 1
	QBRCFOP = CFOP
	DO WHILE !EOF()
		m.CODCLASSIF = INT(VAL(CHRTRAN(CFOP,".","")))*10+CTRCFOP
		=RLOCK()
		REPLACE CODCLASSIF WITH m.CODCLASSIF
		QBRCFOP = CFOP
		SKIP

		IF QBRCFOP = CFOP
			CTRCFOP = CTRCFOP + 1
		ELSE
			CTRCFOP = 1
		ENDIF
	
	ENDDO



	*-----------------------------------------------*
	*ATRIBUIR CODIGO DA CLASSIFICACAO A TABELA TIPOOPER (FOX)
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFO


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODOPERA   WITH &ALS_ClasFisc .CODOPERA
		REPLACE &Als_TipoOper .CODCLASSIF WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO
		


	*-----------------------------------------------*
	*  OPERACOE VICULADAS A CFO SUBSTITUICAO
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFOSUBS


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODCLSSUBS WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO
		

	*-----------------------------------------------*
	*  OPERACOE VICULADAS A CFO SERVICO
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFOSERVICO


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODCLSERVC WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO


	*-----------------------------------------------*
	*  ATRIBUICAO CST
	*-----------------------------------------------*





	*------------------------------------------------------------*
    =up_fecha("&Als_TipoOper")
    =up_fecha("&Als_ClasFisc")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)

*BROWS FIELDS CL.CODOPERA,CL.CODCLASSIF,CL.CFOP,;
*         TP.CFO,TP.CFOSUBS,TP.CFOSERVICO,TP.TIPO,TP.CODOPERA,;
*         TP.CODCLASSIF,TP.CODCLSSUBS,TP.CODCLSERVC


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS55K           TRGet_IVA VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   31  º
*       º Variable:            TRGet_IVA                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      426                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls55k     &&  TRGet_IVA VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TRGet_IVA
PARAMETERS 	PrmUFOrigem,;
			PrmProduto, ;
			PrmUFDestino,;
			PrmData,;
    		PrmPrdtOrigem,;
    		PrmAlsNF,;
    		PrmAlsIT
    		
    		


	=W_DEFPROC("rotinas.spr")


	IF TYPE("PrmPrdtOrigem") <> "N"
	   PrmPrdtOrigem  = 0   && ASSUME NACIONAL
	ENDIF


	IF TYPE("PrmUFDestino") <> "C"
	    DO OBJ_ALER.SPR WITH ;
		   "ERRO -> CHAMADA DA FUNCAO TRget_IVA NAO FOI ADAPTADA ";
		         +CHR(13)+CHR(13)+;
			   "   <ENTER>  "
				SET STEP ON
	ENDIF

    PRIVATE LNiva
    PRIVATE LSalias
	PRIVATE LSuf

	PRIVATE LNalq_externaUForg, LNalq_internaUFDst


    PRIVATE ALS_Grupo
    PRIVATE ARQ_tab_iva,ALS_tab_iva

    LSAlias      = Alias()


	STORE 0 TO ARQ_Grupo, ARQ_tab_iva
	*--------------------------------------------------------

	=W_DEFPROC("GRUPO.SPR")
    ALS_Grupo    = GRGetAlias()

	*--------------------------------------------------------


	IF TYPE("TRtab_IvaALIAS") = "U" OR !USED(TRtab_IvaALIAS)
		PUBLIC TRtab_IvaALIAS
	    ARQ_tab_iva     = NetArqAgain("TAB_IVA")
	    TRtab_IvaALIAS  = Alias()
	ENDIF

    ALS_tab_iva  = TRtab_IvaALIAS

    LNiva = 0
	*--------------------------------------------------------*

	
	LSuf = PrmUFDestino

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
        DO TRFcht_IVAFecha
        RETURN(LNiva)
	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para Produto  especifico
	*------------------------------------------------------------*

	SELE &ALS_tab_iva
	SET ORDER TO TAG subgrupo
	SEEK LSuf + LEFT( &Als_Grupo .classifica,5)+PrmProduto
    IF !FOUND()
		SEEK "BR"+ LEFT( &Als_Grupo .classifica,5)+PrmProduto
	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para SubGrupo do Produto
	*------------------------------------------------------------*

	IF FOUND()
	    LNiva		= 	&Als_tab_iva .iva
	ELSE
		SELE &ALS_tab_iva
		SEEK LSuf + LEFT( &Als_Grupo .classifica,5)+""
    	IF !FOUND()
			SEEK "BR" + LEFT( &Als_Grupo .classifica,5)+""
		ENDIF

	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para SubGrupo do Produto
	*------------------------------------------------------------*

	IF FOUND()
	    LNiva		= 	&Als_tab_iva .iva
	ELSE
		SELE &ALS_tab_iva
		SEEK LSuf + LEFT( &Als_Grupo .classifica,2)+SPACE(3)
    	IF !FOUND()
			SEEK "BR" + LEFT( &Als_Grupo .classifica,2)+SPACE(3)
		ENDIF

		IF FOUND()
		    LNiva		= 	&Als_tab_iva .iva
		ENDIF
	ENDIF

    *-------------------------------------------------------------*
    * Regras para definicao de IVA Ajustada
	*-------------------------------------------------------------*
	*--ANTIGA---------------------------------------------------*
	*		IF (PrmUFOrigem $ "MT/DF" OR PrmUFDestino  $ "MT/DF");
	*		    	and PrmUFOrigem <> PrmUFDestino ;
	*		    	and PrmData >= {01.06.2008} ;
	*		    	and PrmData <  {01.09.2012}
	*
	*            LNiva = TR_TOIVAAjustada(LNiva)
	*       ENDIF
	*-----------------------------------------------------------*

    LNiva =  TR_InternaIVAAjustada(LNiva)

    LNiva = TR_ICM49IVAjustada(LNiva)

    LNiva = TR_ICM62IVAjustada(LNiva)

    LNiva = TR_ICM92IVAjustada(LNiva)




	*------------------------------------------------------------*

    DO TRFcht_IVAFecha

RETURN(LNiva)

PROCEDURE TRFcht_IVAFecha
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS55L           TRCFOPServico VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   33  º
*       º Variable:            TRCFOPServico                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      427                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls55l     &&  TRCFOPServico VALID
#REGION 12
RETURN

*-------------------------------------------------------*
*-----> DEFINECFOP PARA SERVICO
*-------------------------------------------------------*

FUNCTION TRCFOPServico
PARAMETERS PrmUFOrgn, ;
           PrmMuniOrgn,;
           PrmUFDstn,;
           PrmMuniDstn,;
           PrmTp_mercad,;
           PrmOperacao

PRIVATE LScfps

	DO CASE
		CASE PrmTp_mercad <> 7   && nao e servico
			LScfps  = "0000"		
		CASE PrmUFOrgn = PrmUFDstn
			LScfps  = "5933"		
		CASE PrmUFOrgn <> PrmUFDstn
			LScfps  = "6933"		
		OTHERWISE
			LScfps  = "0000"		


    *-------------------------------------------------------------*
    *----> lembrar porque foram colocador os codigos abaixo
    *--> este codegos estava dando erro na NFr
    *-------------------------------------------------------------*
    *
  	*	CASE PrmUFOrgn = PrmUFDstn AND PrmMuniOrgn = PrmMuniDstn
	*		LScfps  = "9101"		
	*	CASE PrmUFOrgn = PrmUFDstn AND PrmMuniOrgn <> PrmMuniDstn
	*		LScfps  = "9102"		
	*	CASE PrmUFOrgn <> PrmUFDstn
	*		LScfps  = "9103"		
	*	OTHERWISE
	*		LScfps  = "0000"		
	ENDCASE
RETURN(LScfps)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS56O           TRCST_IPI VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   34  º
*       º Variable:            TRCST_IPI                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      428                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls56o     &&  TRCST_IPI VALID
#REGION 12
RETURN

FUNCTION TRCST_IPI
PARAMETERS PrmVlrIPI,PrmOperacao
	PRIVATE LScstIPI

*---------------------------------------------------------*
* ROTINA ERRADA ATE SET/11
*---------------------------------------------------------*
*	DO CASE
*		CASE PrmOperacao = "SAIDA" AND PrmVlrIPI > 0
*			LScstIPI  = "50"		
*		CASE PrmOperacao = "SAIDA" AND PrmVlrIPI = 0
*			LScstIPI  = "53"		
*		CASE PrmOperacao = "ENTRADA" AND PrmVlrIPI > 0
*			LScstIPI  = "50"		
*		CASE PrmOperacao = "ENTRADA" AND PrmVlrIPI = 0
*			LScstIPI  = "53"		
*		OTHERWISE
*			LScstIPI  = "53"		
*	ENDCASE
*---------------------------------------------------------*


	DO CASE
		CASE PrmOperacao = "SAIDA"
	***		LScstIPI  = "99"		
			LScstIPI  = "53"		
		OTHERWISE
	***		LScstIPI  = "49"		
			LScstIPI  = "03"		
	ENDCASE
	
RETURN(LScstIPI)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS56U           TRCST_ISS VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   35  º
*       º Variable:            TRCST_ISS                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      429                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls56u     &&  TRCST_ISS VALID
#REGION 12
RETURN

FUNCTION TRCST_ISS
PARAMETERS PrmVlrISS,PrmOperacao
PRIVATE LScstISS

	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlrISS > 0   &&  servico
			LScstISS  = "00"		
		CASE PrmOperacao = "SAIDA" AND PrmVlrISS = 0   && nao e servico
			LScstISS  = "07"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlrISS > 0   &&  servico
			LScstISS  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlrISS = 0   && nao e servico
			LScstISS  = "07"		
		OTHERWISE
			LScstISS  = "07"		
	ENDCASE
RETURN(LScstISS)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS570           TRGenero VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   36  º
*       º Variable:            TRGenero                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      430                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls570     &&  TRGenero VALID
#REGION 12
RETURN

FUNCTION TRGenero
PARAMETERS PrmTp_mercad,PrmClassifica,PrmOperacao
PRIVATE LSgenero

	DO CASE
		CASE PrmTp_mercad = 7
			LSgenero  = "00"		
		CASE LefT(Prmclassifica,2) $ "00/01"
			LSgenero  = "40"		
		OTHERWISE
			LSgenero  = "87"		
	ENDCASE
RETURN(LSgenero)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS576           TRcst_Icms VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   37  º
*       º Variable:            TRcst_Icms                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      431                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _43a0ls576     &&  TRcst_Icms VALID
#REGION 12
RETURN

FUNCTION TRcst_Icms
	PARAMETERS Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto,PrmCst


	PRIVATE Lcst
	

	=W_DEFPROC("GRUPO.SPR")
	LSCst =  GRGetOrigem(PrmProduto)

	LSCst =  STR( LSCst,1)
	
	
	LSCst =  LScst + ;
			 TRdefcst(Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto,PrmCst) + ;
			 "0"
	LSCst = CHRTRAN(LSCst," ","0")

RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS577           TRCST_PIS VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   38  º
*       º Variable:            TRCST_PIS                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      432                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls577     &&  TRCST_PIS VALID
#REGION 12
RETURN

FUNCTION TRCST_PIS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "07"		
	ENDCASE
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS578           TRCST_COFINS VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   39  º
*       º Variable:            TRCST_COFINS                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      433                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls578     &&  TRCST_COFINS VALID
#REGION 12
RETURN

FUNCTION TRCST_COFINS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "01"	   && ANTES "00"	
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "04"      && ANTES "00"
	ENDCASE
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS579           TRCST_IR VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   40  º
*       º Variable:            TRCST_IR                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      434                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls579     &&  TRCST_IR VALID
#REGION 12
RETURN

FUNCTION TRCST_IR
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "07"		
	ENDCASE
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS57A           TRDef_RgTrbMercad VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   42  º
*       º Variable:            TRDef_RgTrbMercad                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      435                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls57a     &&  TRDef_RgTrbMercad VALID
#REGION 12
RETURN

FUNCTION TRDef_RgTrbMercad
	PARAMETER PrmUF,PrmProduto,PrmFormaRetorno
	
	
	
	*-----------------------------------------------------------------*	
	*--> PrmFormaRetorno = 'RETORNAR STRING'
	*   RETORNAR EM FORMATO STRIG (USADO EM DOC FISCAL - EFD E NFe )
	*-----------------------------------------------------------------*	
	




	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE	LSClassifica
	PRIVATE	LNtp_mercad
	LNtp_mercad	= 99999   && INVALIDO
	
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*--------------------------------------------------------

	=W_DEFPROC("GRUPO.spr")
	LSClassifica=GRGetFieldValue(PrmProduto,"CLASSIFICA")


	=W_DEFPROC("GRFISCAL.spr")
	LNtp_mercad	= GFGetTp_Mercadoria(PrmUF, LSClassifica)



*	*--------------------------------------------------------------------*
*	* Rotina estava perdida  em TRIBUTAR TRpct_trib
*	* transcrevi em 06/09/2012 e precisa de uma reavaliacao
*	* para decidir se continua
*	*--------------------------------------------------------------------*
*	*----------------------------------------------------------------*
*	*		Identificar mercadorias em regime de substituicao ESTADUAL
*	*	em caso de operacao ITERESTADUAIS com consumidor INSCRITO(2)/
*	*	REVENDA(4) ou DEVOLUCOES passa mercadoria para regime tributado
*	*----------------------------------------------------------------*
*
*	IF LNtp_mercad = 2	AND &Als_tipooper .ch_desti = "2"
*		IF     left(LSClassifica,5) > "02000" ;
*		   AND left(LSClassifica,5) < "99999" ;
*		   AND left(LSClassifica,5) <> "04042"
*			DO CASE
*				*----------------------------------------------------*
*				* TODAS OPERACOES DIFERENTES DE VENDAS
*				*----------------------------------------------------*
*				CASE &Als_tipooper .ch_opera <> "1" && TODAS OPER DIFERE
*				                                    && DE VENDA
*					LNtp_mercad	= 	1
*				*----------------------------------------------------*
*				* TODAS VENDAS Q NAO FOREM PARA 1-CONSSUMIDOR  OU
*				*                               3-CONTR NAO ISCRITO
*				*----------------------------------------------------
*				CASE !( &Als_tipooper .ch_contr $ "3/1" )
*					LNtp_mercad	= 	1
*			ENDCASE
*		ENDIF
*	ENDIF
*

	*-------------------------------------------------------------*

	IF TYPE('PrmFormaRetorno') = "C" ;
	   AND  PrmFormaRetorno = 'RETORNAR STRING'
	
		DO CASE

			CASE LNtp_mercad = 7
				LNtp_mercad	= "SERVICO"		

			CASE LNtp_mercad = 2
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			CASE LNtp_mercad = 8
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			OTHERWISE
				LNtp_mercad	= "ICMS NORMAL"		

		ENDCASE


	ENDIF





	*-------------------------------------------------------------*


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNtp_mercad)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS57B           TRpct_trib VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   43  º
*       º Variable:            TRpct_trib                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      436                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _43a0ls57b     &&  TRpct_trib VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRpct_trib
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto, ;
    LNiva, LNipialq, LNtp_mercad, LScst, ;
    LNaliq_iss, LNaliq_rdu, LNaliq_icms, LScfo


	=W_DEFPROC("rotinas.spr")


	PRIVATE LSEmpEstado
	PRIVATE LSClassifica
	PRIVATE LSProdOrigem
	PRIVATE LNtab_cst
	PRIVATE LNEmpReduzBase



    PRIVATE LSalias

    PRIVATE ARQ_GrFiscal,ALS_GrFiscal
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper
	PRIVATE LSUForigem, LSUFdestino

    LSAlias      = Alias()

	
    LNiva = 0
    LNipialq = 0
	LNtp_mercad	= 99999   && INVALIDO
*-*	LScst		= " "		&& ASSUME 0
    LNaliq_iss = 0
    LNaliq_rdu = 0
    LNaliq_icms = 0
    LScfo = ""




    ARQ_GrFiscal  = NetArqAgain("GRFISCAL")
    ALS_GrFiscal  = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()


    LNiva = 0
	*--------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	IF !EMLerRegistro(PrmEmpresa)
	    do TRFcht_Fecha
		RETURN
	ENDIF


	=W_DEFPROC("GRUPO.SPR")
	IF !GRLerRegistro(PrmProduto)
	    do TRFcht_Fecha
		RETURN
	ENDIF




	*---------------------------------------------------------------*


	=W_DEFPROC("EMPRESA.SPR")
	LSEmpEstado = EMGet_UF(PrmEmpresa)

	=W_DEFPROC("GRUPO.SPR")
	LSClassifica = GRGetClassifica(PrmProduto)


	=W_DEFPROC("GRUPO.SPR")
	LSProdOrigem = GRGetOrigem(PrmProduto)




	SELE &Als_GRfiscal
	SET ORDER TO trb_classe
	SEEK LSEmpEstado + LEFT( LSClassifica,5)
	IF !FOUND()
		SET ORDER TO trb_sbgrpo
		SEEK LSEmpEstado + LEFT( LSClassifica,8)
	ENDIF

	*---------------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF


	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    *=========>>>>>>>   OBTER IVA    <<<<<<



	=W_DEFPROC("CLIENC.SPR")
	LSUFdestino = CNGetUFDestino(PrmEmpresa,PrmOrcamento)


	=W_DEFPROC("EMPRESA.SPR")
	LSUForigem = EMGet_UF(PrmEmpresa)


	=W_DEFPROC("TRIBUTAR.SPR")
	LNiva = TRGet_IVA( LSUForigem,;
			            PrmProduto,;
			            LSUFdestino ,;
			            &ALS_Orcament .data )




    *=========>>>>>>>   OBTER ALIQ IPI    <<<<<<

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA
	DO CASE

		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA

		CASE LSProdOrigem = 1
			=W_DEFPROC("GRUPO.SPR")
			LNipialq   =  GRGetFieldValue(PrmProduto,"ALIQ_IPI")

		OTHERWISE
			LNipialq   =	0
	ENDCASE


    *=========>>>>>>>   OBTER TP_MERCAD    <<<<<<

    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)

*    *-----------------------------------------------------------------*
*    * A ROTINA ABAIXO FOI DESATIVADA E TRANSFERIDA PARA
*    * FUNCTION TRDef_RgTrbMercad EM 06/09/2012
*	* PARAMETER PrmUF,PrmProduto,PrmFormaRetorno
*    *-----------------------------------------------------------------*
*
*	*----------------------------------------------------------------*
*	*		Identificar mercadorias em regime de substituicao ESTADUAL
*	*	em caso de operacao ITERESTADUAIS com consumidor INSCRITO(2)/
*	*	REVENDA(4) ou DEVOLUCOES passa mercadoria para regime tributado
*	*----------------------------------------------------------------*
*
*
*	*IF LNtp_mercad = 2	AND &Als_tipooper .ch_desti = "2"
*		IF     &Als_grfiscal .subgrupo > "02000" ;
*		   AND &Als_grfiscal .subgrupo < "99999" ;
*		   AND &Als_grfiscal .subgrupo <> "04042"
*			DO CASE
*				*----------------------------------------------------*
*				* TODAS OPERACOES DIFERENTES DE VENDAS
*				*----------------------------------------------------*
*				CASE &Als_tipooper .ch_opera <> "1" && TODAS OPER DIFERE
*				                                    && DE VENDA
*					LNtp_mercad	= 	1
*				*----------------------------------------------------*
*				* TODAS VENDAS Q NAO FOREM PARA 1-CONSSUMIDOR  OU
*				*                               3-CONTR NAO ISCRITO
*				*----------------------------------------------------
*				CASE !( &Als_tipooper .ch_contr $ "3/1" )
*					LNtp_mercad	= 	1
*			ENDCASE
*		ENDIF
*	ENDIF
    *=========>>>>>>>   OBTER CST    <<<<<<


	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LNtab_cst = EMGet_TabCst(PrmEmpresa)


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
	*---------------------------------------------------------------*

	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto,LScst)

    *=========>>>>>>>   OBTER ALIQ ISS    <<<<<<


	=W_DEFPROC("EMPRESA.SPR")
	LNaliq_iss = EMGetFieldValue(PrmEmpresa,"ALIQ_ISS")


    *=========>>>>>>>   OBTER ALIQ reducao icms   <<<<<<
	=W_DEFPROC("EMPRESA.SPR")
	LNEmpReduzBase = EMGetFieldValue(PrmEmpresa,"REDUZ_BASE")


	LNaliq_rdu    =  0


	IF LNEmpReduzBase = 0
		LNaliq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNaliq_rdu   = LNEmpReduzBase  && USAR ALIQUOTA
			                                        && INFORMADA
		endif
	ENDIF

    *=========>>>>>>>   OBTER ALIQ icms   <<<<<<
	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms = &Als_orcament .aliq_icms && USAR ALIQUOTA
											   && INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA
												     && INFORMADA
	ENDIF
    *=========>>>>>>>   OBTER CFO   <<<<<<


	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE LNTp_Mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE




	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
    do TRFcht_Fecha

RETURN

PROCEDURE TRFcht_Fecha
   	=up_fecha("&ALS_GrFiscal")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS58K           TRCnvrt_RgTrbMercad VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   44  º
*       º Variable:            TRCnvrt_RgTrbMercad                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      437                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls58k     &&  TRCnvrt_RgTrbMercad VALID
#REGION 12
RETURN

FUNCTION TRCnvrt_RgTrbMercad
	PARAMETER PrmTpMercad
	
	
	
	*-----------------------------------------------------------------*	
	*--> PrmFormaRetorno = 'RETORNAR STRING'
	*   RETORNAR EM FORMATO STRIG (USADO EM DOC FISCAL - EFD E NFe )
	*-----------------------------------------------------------------*	
	




	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE	LSClassifica
	PRIVATE	LNtp_mercad
	LNtp_mercad	= 99999   && INVALIDO
	
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*--------------------------------------------------------
	LNtp_mercad	= PrmTpMercad

	*-------------------------------------------------------------*

	
		DO CASE

			CASE LNtp_mercad = 7
				LNtp_mercad	= "SERVICO"		

			CASE LNtp_mercad = 2
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			CASE LNtp_mercad = 8
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			OTHERWISE
				LNtp_mercad	= "ICMS NORMAL"		

		ENDCASE



	*-------------------------------------------------------------*


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNtp_mercad)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS58S           TRcst_Entrada VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   45  º
*       º Variable:            TRcst_Entrada                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      438                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _43a0ls58s     &&  TRcst_Entrada VALID
#REGION 12
RETURN

FUNCTION TRcst_Entrada
PARAMETERS PrmCst,PrmOrigem,PrmTp_Mercad,Prmbase_calc,PrmVlrvenda,;
		Prmicms_subs, PrmProduto, Prmtipo



    Prmtab_cst = 3



	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_tab_cst,ALS_tab_cst
	LSalias = ALIAS()

    ARQ_Tab_Cst     = NetArqAgain("TAB_CST")
    ALS_Tab_Cst     = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()



	IF ( ARQ_Tab_Cst)+ ARQ_Tipooper > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'E'+ PrmTipo
	IF !FOUND()
		SEEK 'e'+  PrmTipo
	ENDIF
	IF !FOUND()
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF



	LScst = " "
	DO CASE
		CASE &Als_tipooper .ch_opera = "4"  && DEVOLUCAO
*****			LScst =  PrmCST
	     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  PrmCST  + "0"
		OTHERWISE
			SELECT &Als_tab_cst
			SET ORDER TO TAG cst
			SEEK STR(Prmtab_cst,2)+PrmTipo+STR(Prmtp_mercad,1)
			IF !FOUND()
				IF tipooper.ch_opera = "3"
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"

				ENDIF
			ELSE
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  LEFT( &Als_tab_cst .cst,1)  + "0"
			ENDIF
	ENDCASE
	*------------------------------------------------------------*
	* EXCECOES
	*------------------------------------------------------------*
    DO CASE
		CASE PrmTipo = "CLA" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "2"  + "0"
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
				CASE Prmicms_subs = 0 AND Prmbase_calc = 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"
			ENDCASE

		CASE PrmTipo = "CLB" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "2"  + "0"

				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
				CASE Prmicms_subs = 0 AND Prmbase_calc = 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"
			ENDCASE
			
		CASE PrmTipo = "CFA" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "7"  + "0"
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE
			
		CASE PrmTipo = "CFB" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "7"  + "0"
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE

		CASE PrmTipo = "CFM" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE
			
		CASE PrmTipo = "CFS" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE

    ENDCASE


	*------------------------------------------------------------*

    =up_fecha("&ALS_Tab_cst")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS58T           TR_InternaIVAAjustada VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   46  º
*       º Variable:            TR_InternaIVAAjustada              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      439                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls58t     &&  TR_InternaIVAAjustada VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_InternaIVAAjustada
PARAMETERS LNiva




    *-------------------------------------------------------------
    * conforme solicitacao do Celio Repassada pelo almir foi revgada
    * a instrucao anterior para DF e GO retornando o IVA interno
    * para ser orientada pelo cadastro na tabela TAB_IVA e
    * ignorar regras internas do programa
    *
    *-------------------------------------------------------------
     IF 1 =  1
        RETURN(LNIva)
     ENDIF



	*------------------------------------------------------------*
	* IVA TERMO DE ACORDO TO/DF/GO
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra para termo de acordo
    *   revenda INTERNA DE pecas no TO
    *   => PECAS
    *      => TO / DF / GO
	*------------------------------------------------------------*
		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*
        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*





 		IF LEFT( &Als_Grupo .classifica,2) = "04" ;
 		   AND 	PrmData >= {01.06.2008} ;
		   AND  PrmData <  {01.01.2013}

	        DO CASE
				CASE (PrmUFOrigem $ "TO" AND PrmUFDestino  $ "TO")
					LNiva = 1.265				

				CASE (PrmUFOrigem $ "DF" AND PrmUFDestino  $ "DF")
					LNiva = 1.596				

				CASE (PrmUFOrigem $ "GO" AND PrmUFDestino  $ "GO")
					LNiva = 1.596				

        	ENDCASE
		ENDIF


        *-------------------------------------------------------------
        * conforme solicitacao do Celio Repassada pelo almir foi revgada
        * a instrucao anterior para DF e GO retornando o IVA interno
        * para 1.400 apartir de 01/01/2012
        *-------------------------------------------------------------

 		IF LEFT( &Als_Grupo .classifica,2) = "04" ;
 		   AND PrmData >=  {01.01.2013}

	        DO CASE
				CASE (PrmUFOrigem $ "TO" AND PrmUFDestino  $ "TO")
					LNiva = 1.265				

				CASE (PrmUFOrigem $ "DF" AND PrmUFDestino  $ "DF")
					LNiva = 1.400				

				CASE (PrmUFOrigem $ "GO" AND PrmUFDestino  $ "GO")
					LNiva = 1.400				
        	ENDCASE
		ENDIF



RETURN(LNIva)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS58U           TR_ICM49IVAjustada VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   47  º
*       º Variable:            TR_ICM49IVAjustada                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      440                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls58u     &&  TR_ICM49IVAjustada VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_ICM49IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PECAS
    *      => MT e DF
	*------------------------------------------------------------*

		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*
		DO CASE

			CASE (PrmUFOrigem $ "DF") ;
			    	and PrmUFOrigem <> PrmUFDestino ;
			    	and PrmData >= {01.06.2008} ;
			    	and PrmData <  {01.09.2012}
				*---------------------------------------------------*
				* PROTOCOLO ICMS 49 -8 DE MAI DE 2008 IVA AJUSTAS DF/MT
				*-----------------------------------------------------*
				LFajustaIVA = LFajustaIVA
							&& SO PARA JUSTIFICAR IF AFIRMATIVO

			CASE (PrmUFOrigem $ "MT");
			    	and PrmUFOrigem <> PrmUFDestino ;
			    	and PrmData >= {01.06.2008} ;
			    	and PrmData <  {01.09.2012}
				*------------------------------------------------*
				* PROTOCOLO ICMS 49 -8 DE MAI DE 2008 IVA AJUSTAS DF/MT
				*----------------------------------------------------*
				LFajustaIVA = LFajustaIVA
							&& SO PARA JUSTIFICAR IF AFIRMATIVO
			OTHERWISE
				RETURN(LNIva)
		ENDCASE
		
        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*

	 	DO CASE
			*--------------------------------------------*
			* PECAS E ACESSORIOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "04"
	 		   IF LEFT( &Als_Grupo .classifica,5)  $ "04041/04042/04043"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF

			*--------------------------------------------*
			* PESOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) = "07075"
	 		   IF SUBS( &Als_Grupo .classifica,6,3)  $ "599/699/799/899/999"
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
			*--------------------------------------------*
			* MATERIAL BORRACHARIA
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "05"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
 	
	 	ENDCASE

		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)


			do case
				case LNiva = 1.265				
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.417				
								case LNalq_internaUFDst = 18
									LNiva = 1.435				
								case LNalq_internaUFDst = 19
									LNiva = 1.452			
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.341				
								case LNalq_internaUFDst = 18
									LNiva = 1.358			
								case LNalq_internaUFDst = 19
									LNiva = 1.374			
		                    endcase
					endcase
				case LNiva = 1.400				
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.569				
								case LNalq_internaUFDst = 18
									LNiva = 1.588				
								case LNalq_internaUFDst = 19
									LNiva = 1.607				
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.484				
								case LNalq_internaUFDst = 18
									LNiva = 1.502				
								case LNalq_internaUFDst = 19
									LNiva = 1.521			
		                    endcase
					endcase
			endcase
		ENDIF


RETURN(LNIva)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS58V           TR_ICM62IVAjustada VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   48  º
*       º Variable:            TR_ICM62IVAjustada                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      441                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls58v     &&  TR_ICM62IVAjustada VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_ICM62IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PECAS
	*------------------------------------------------------------*

		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*

		IF ;
		   (PrmUFOrigem $ ;
		      "DF/AC/AL/AP/BA/GO/MA/MT/PB/PR/PE/PI/RN/RR/SC/SE/TO");
		    	and PrmUFOrigem <> PrmUFDestino ;
		    	and PrmData >=  {01.09.2012}
			*------------------------------------------------------------*
			* PROTOCOLO ICMS 62 -22 DE JUN DE 2012 IVA AJUSTAS
			*------------------------------------------------------------*
			LFajustaIVA = LFajustaIVA && SO PARA JUSTIFICAR IF AFIRMATIVO
		ELSE
			RETURN(LNIva)
		ENDIF




        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*

	 	DO CASE
			*--------------------------------------------*
			* PECAS E ACESSORIOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "04"
	 		   IF LEFT( &Als_Grupo .classifica,5)  $ "04041/04042/04043"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF

			*--------------------------------------------*
			* PESOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) = "07075"
	 		   IF SUBS( &Als_Grupo .classifica,6,3)  $ "599/699/799/899/999"
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
			*--------------------------------------------*
			* MATERIAL BORRACHARIA
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "05"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
 	
	 	ENDCASE

		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem,PrmPrdtOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)


			do case
				case LNiva = 1.400	OR LNiva = 1.5960
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.7883				
								case LNalq_internaUFDst = 18
									LNiva = 1.8101			
								case LNalq_internaUFDst = 19
									LNiva = 1.8324				
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.6921				
								case LNalq_internaUFDst = 18
									LNiva = 1.7128				
								case LNalq_internaUFDst = 19
									LNiva = 1.7339			
		                    endcase
					endcase
			endcase
		ENDIF

RETURN(LNIva)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS59U           TR_ICM92IVAjustada VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   49  º
*       º Variable:            TR_ICM92IVAjustada                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      442                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls59u     &&  TR_ICM92IVAjustada VALID
#REGION 12
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*
* em 18 de janeiro incorporamos o tratamento da aliquota de 4%



FUNCTION TR_ICM92IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PNEUMATICOS
	*------------------------------------------------------------*

		LFajustaIVA = .f.


        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*

		IF  PrmUFOrigem <> PrmUFDestino ;
		   	and PrmData >=  {01.09.2012}
			*------------------------------------------------------------*
			* PROTOCOLO ICMS 62 -22 DE JUN DE 2012 IVA AJUSTAS
			*------------------------------------------------------------*
			LFajustaIVA = LFajustaIVA && SO PARA JUSTIFICAR IF AFIRMATIVO
		ELSE
			RETURN(LNIva)
		ENDIF

        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*


	 	DO CASE
			*--------------------------------------------*
			* PNEUMATICOS - PNEUS/CAMARAS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) $ "00/01"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA

			*--------------------------------------------*
			* PROTETORES
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) $ "04042"
	 		   IF LEFT( &Als_Grupo .classifica,8)  $ "04042920"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
	 	ENDCASE


		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem,PrmPrdtOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)


			do case
				case LNiva = 1.42				
					do case
						case LNalq_externaUForg	= 4
							LNiva = 1.6424				
						case LNalq_externaUForg	= 7
							LNiva = 1.5911				
						case LNalq_externaUForg	= 12
							LNiva = 1.5055				
					endcase
				case LNiva = 1.32				
					do case
						case LNalq_externaUForg	= 4
							LNiva = 1.5267				
						case LNalq_externaUForg	= 7
							LNiva = 1.479				
						case LNalq_externaUForg	= 12
							LNiva = 1.3995				
					endcase
				case LNiva = 1.45				
					do case
						case LNalq_externaUForg	= 4
							LNiva = 1.6771				
						case LNalq_externaUForg	= 7
							LNiva = 1.6247				
						case LNalq_externaUForg	= 12
							LNiva = 1.5373				
					endcase
			endcase
		ENDIF

RETURN(LNIva)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5A4           FRGet_UF VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    2  º
*       º Variable:            FRGet_UF                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      443                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5a4     &&  FRGet_UF VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRGet_UF
PARAMETERS Prmfornece
	=FRChk_Identidade(Prmfornece)
RETURN(FRGetPropVT("ESTADO"))




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5AB           FRrgm_Fisc VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    3  º
*       º Variable:            FRrgm_Fisc                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      444                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5ab     &&  FRrgm_Fisc VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRrgm_Fisc
PARAMETERS Prmfornece

	=FRChk_Identidade(Prmfornece)

RETURN(FRGetPropVT("RGMEFISCAL"))
	



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5AC           FRVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    4  º
*       º Variable:            FRVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      445                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5ac     &&  FRVerifyInst VALID
#REGION 13
return
*---------------------------------------------------------------*



FUNCTION FRVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Fornece")


	DO CASE

		CASE TYPE("PBForneceAlias") = "U" ;
		   		OR EMPTY(PBForneceAlias) ;
		   		OR !USED(PBForneceAlias)
			=FRCreate()					

		CASE !("FORNECE.DBF" $ DBF(PBForneceAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBForneceAlias
			=FRCreate()					


		CASE  !(LSPath $ DBF(PBForneceAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=FRDestroi()				
			=FRCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5AD           FRCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    5  º
*       º Variable:            FRCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      446                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5ad     &&  FRCreate VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION FRCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBForneceAlias") <> "U" ;
	   		AND !EMPTY(PBForneceAlias) ;
	   		AND USED(PBForneceAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBForneceAlias

	IF USED("Fornece")
	     =NetArqAgain("Fornece")
	     PBForneceAlias     = Alias()
	ELSE
	     =NetArqAgain("Fornece")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Fornece")
	     PBForneceAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBForneceAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTFornece[LMaxDim]
    PUBLIC DIMENSION VDFornece[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFFornece[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFFornece)



	*-----------------------------------------------------------*
	=FRReadProperty()
	=FRSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5AE           FRDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    6  º
*       º Variable:            FRDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      447                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5ae     &&  FRDestroi VALID
#REGION 13
return
*---------------------------------------------------------------*


FUNCTION FRDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBForneceAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBForneceAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBForneceAlias
	*  3- Se aplicar um FECHAMENTO a PBForneceAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBForneceAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBForneceAlias)) OR ;
	   !("FORNECE.DBF" $ DBF(PBForneceAlias))

		RELEASE PBForneceAlias
    	RELEASE VTFornece
	    RELEASE VDFornece
		RELEASE VFFornece
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBForneceAlias) AND USED(PBForneceAlias)
		SELECT &PBForneceAlias
		USE
	ENDIF	
	RELEASE PBForneceAlias
    RELEASE VTFornece
    RELEASE VDFornece
	RELEASE VFFornece

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5AF           FRReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    7  º
*       º Variable:            FRReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      448                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5af     &&  FRReadProp VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION FRReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBForneceAlias
	SCATTER TO VTFornece
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5AG           FRSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    8  º
*       º Variable:            FRSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      449                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5ag     &&  FRSetDerivadas VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION FRSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDFornece(1,1) = "NAOINFORMADO"
   	VDFornece(1,2) = 0
   	VDFornece(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5BD           FRSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:    9  º
*       º Variable:            FRSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      450                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5bd     &&  FRSetPropVT VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION FRSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBForneceAlias,;
						    VTFornece,;
						    VDFornece,;
						    VFFornece)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5BJ           FRGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   10  º
*       º Variable:            FRGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      451                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5bj     &&  FRGetPropVT VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION FRGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBForneceAlias,;
	            VTFornece,;
	            VDFornece,;
	            VFFornece)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5BP           FRChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   11  º
*       º Variable:            FRChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      452                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5bp     &&  FRChk_Identidade VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRChk_Identidade
PARAMETERS Prmfornece

	PRIVATE LFretorno
	LFretorno = .t.

	=FRVerifyInst()
	=FRSetPropVT("CODIGO",Prmfornece)

	LFretorno=FRFind()
RETURN(LFretorno)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5BV           FRFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   12  º
*       º Variable:            FRFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      453                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5bv     &&  FRFind VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION FRFind

	PRIVATE Lcodigo
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=FRVerifyInst()

	Lcodigo   = FRGetPropVT("CODIGO")

	SELE &PBForneceAlias
	SET ORDER TO TAG CODIGO
	SEEK Lcodigo

	IF FOUND()
		=FRReadProperty()
		=FRSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5BW           FRGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   13  º
*       º Variable:            FRGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      454                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5bw     &&  FRGetFieldValue VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION FRGetFieldValue
PARAMETERS Prmfornece,PrmField

	=FRChk_Identidade(Prmfornece)

RETURN(FRGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5BX           FR_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   14  º
*       º Variable:            FR_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      455                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5bx     &&  FR_Refresh VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FR_Refresh
PARAMETERS Prmfornece
			
	
	


	PRIVATE LFretorno


	=FRVerifyInst()
	=FRSetPropVT("CODIGO",Prmfornece)

	LFretorno=FRFind()
RETURN(LFretorno)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5BY           FRLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   16  º
*       º Variable:            FRLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      456                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5by     &&  FRLerRegistro VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRLerRegistro
PARAMETERS Prmfornece



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = FRChk_Identidade(Prmfornece)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5BZ           FRWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   17  º
*       º Variable:            FRWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      457                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5bz     &&  FRWriteProp VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION FRWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBForneceAlias
	=RLOCK()
	GATHER FROM  VTFornece
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5C0           FRSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   18  º
*       º Variable:            FRSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      458                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5c0     &&  FRSalvarRegistro VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRSalvarRegistro

	=FRVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !FRExiste()
		SELE &PBForneceAlias
		APPEND BLANK
		LFretorno=FRWriteProp()
	ELSE
		SELE &PBForneceAlias
		LFretorno=FRWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5CV           FRExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   19  º
*       º Variable:            FRExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      459                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5cv     &&  FRExiste VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION FRExiste

	PRIVATE Lcodigo

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=FRVerifyInst()

	Lcodigo   = FRGetPropVT("CODIGO")

	SELE &PBForneceAlias
	SET ORDER TO TAG CODIGO
	SEEK Lcodigo

	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5D3           FRGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   21  º
*       º Variable:            FRGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      460                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5d3     &&  FRGetAlias VALID
#REGION 13
return
*---------------------------------------------------------------*

FUNCTION FRGetAlias

	=FRVerifyInst()

RETURN(PBForneceAlias)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5D9           FRGet_Nome VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   22  º
*       º Variable:            FRGet_Nome                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      461                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5d9     &&  FRGet_Nome VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRGet_NOME
PARAMETERS Prmfornece
	=FRChk_Identidade(Prmfornece)
RETURN(FRGetPropVT("NOME"))




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5DA           FRGet_Inscr VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         FORNECED,     Record Number:   23  º
*       º Variable:            FRGet_Inscr                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      462                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5da     &&  FRGet_Inscr VALID
#REGION 13
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION FRGet_Inscr
PARAMETERS Prmfornece
	=FRChk_Identidade(Prmfornece)
RETURN(FRGetPropVT("INSCRICAO"))




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5DB           GFGetTp_Mercadoria VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    3  º
*       º Variable:            GFGetTp_Mercadoria                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      463                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5db     &&  GFGetTp_Mercadoria VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFGetTp_Mercadoria
PARAMETERS PrmUF, PrmClassifica


	PRIVATE LFOUND
	PRIVATE LMsgErro


	LFOUND = GFChk_Identidade(PrmUF, LEFT( PrmClassifica,12))
	
	IF !LFOUND
	  LFOUND = GFChk_Identidade("BR", LEFT( PrmClassifica,12))
	ENDIF
	
	IF !LFOUND
	  LFOUND = GFChk_Identidade(PrmUF, LEFT(PrmClassifica,8)+SPACE(4))
	ENDIF
	
	IF !LFOUND
	  LFOUND = GFChk_Identidade("BR", LEFT(PrmClassifica,8)+SPACE(4))
	ENDIF
	




	IF !LFOUND
	  LFOUND = GFChk_Identidade(PrmUF, LEFT(PrmClassifica,5)+SPACE(7))
	ENDIF

	IF !LFOUND
	  LFOUND = GFChk_Identidade("BR", LEFT(PrmClassifica,5)+SPACE(7))
	ENDIF


	IF !LFOUND
	  LFOUND = GFChk_Identidade(PrmUF, LEFT(PrmClassifica,2)+SPACE(10))
	ENDIF
	
	IF !LFOUND
	  LFOUND = GFChk_Identidade("BR", LEFT(PrmClassifica,2)+SPACE(10))
	ENDIF


	
	IF !LFOUND

		LMsgErro =   "Situacao Tributaria nao prevista para:";
						+ CHR(13);
						+ CHR(13);
					    + PrmUF;
						+ ': Produto:';
						+  PrmClassifica ;
						+ CHR(13);
						+ CHR(13);
						+ " <ENTER>  "

		=UPerrosys(LMsgErro)
	ENDIF



RETURN(GFGetPropVT("TP_MERCAD"))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5DC           GFVerifyInst VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    4  º
*       º Variable:            GFVerifyInst                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      464                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5dc     &&  GFVerifyInst VALID
#REGION 14
return
*---------------------------------------------------------------*



FUNCTION GFVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("GRFiscal")


	DO CASE

		CASE TYPE("PBGRFiscalAlias") = "U" ;
		   		OR EMPTY(PBGRFiscalAlias) ;
		   		OR !USED(PBGRFiscalAlias)
			=GFCreate()					

		CASE !("GRFISCAL.DBF" $ DBF(PBGRFiscalAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBGRFiscalAlias
			=GFCreate()					


		CASE  !(LSPath $ DBF(PBGRFiscalAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=GFDestroi()				
			=GFCreate()					
	ENDCASE

	
RETURN(.t.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5DD           GFCreate VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    5  º
*       º Variable:            GFCreate                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      465                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5dd     &&  GFCreate VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBGRFiscalAlias") <> "U" ;
	   		AND !EMPTY(PBGRFiscalAlias) ;
	   		AND USED(PBGRFiscalAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBGRFiscalAlias

	IF USED("GRFiscal")
	     =NetArqAgain("GRFiscal")
	     PBGRFiscalAlias     = Alias()
	ELSE
	     =NetArqAgain("GRFiscal")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("GRFiscal")
	     PBGRFiscalAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBGRFiscalAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTGRFiscal[LMaxDim]
    PUBLIC DIMENSION VDGRFiscal[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFGRFiscal[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFGRFiscal)



	*-----------------------------------------------------------*
	=GFReadProperty()
	=GFSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5DE           GFDestroi VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    6  º
*       º Variable:            GFDestroi                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      466                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5de     &&  GFDestroi VALID
#REGION 14
return
*---------------------------------------------------------------*


FUNCTION GFDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBGRFiscalAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBGRFiscalAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBGRFiscalAlias
	*  3- Se aplicar um FECHAMENTO a PBGRFiscalAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBGRFiscalAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBGRFiscalAlias)) OR ;
	   !("GRFISCAL.DBF" $ DBF(PBGRFiscalAlias))

		RELEASE PBGRFiscalAlias
    	RELEASE VTGRFiscal
	    RELEASE VDGRFiscal
		RELEASE VFGRFiscal
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBGRFiscalAlias) AND USED(PBGRFiscalAlias)
		SELECT &PBGRFiscalAlias
		USE
	ENDIF	
	RELEASE PBGRFiscalAlias
    RELEASE VTGRFiscal
    RELEASE VDGRFiscal
	RELEASE VFGRFiscal

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5EE           GFReadProp VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    7  º
*       º Variable:            GFReadProp                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      467                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5ee     &&  GFReadProp VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBGRFiscalAlias
	SCATTER TO VTGRFiscal
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5EK           GFSetDerivadas VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    8  º
*       º Variable:            GFSetDerivadas                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      468                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5ek     &&  GFSetDerivadas VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDGRFiscal(1,1) = "NAOINFORMADO"
   	VDGRFiscal(1,2) = 0
   	VDGRFiscal(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5EQ           GFSetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:    9  º
*       º Variable:            GFSetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      469                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5eq     &&  GFSetPropVT VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBGRFiscalAlias,;
						    VTGRFiscal,;
						    VDGRFiscal,;
						    VFGRFiscal)

RETURN(Lvalue)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5EW           GFGetPropVT VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   10  º
*       º Variable:            GFGetPropVT                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      470                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5ew     &&  GFGetPropVT VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBGRFiscalAlias,;
	            VTGRFiscal,;
	            VDGRFiscal,;
	            VFGRFiscal)

RETURN(Lvalue)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5EX           GFChk_Identidade VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   11  º
*       º Variable:            GFChk_Identidade                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      471                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5ex     &&  GFChk_Identidade VALID
#REGION 14
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
FUNCTION GFChk_Identidade
PARAMETERS PrmUF, PrmClassifica
	PRIVATE LFretorno
	LFretorno = .t.

	=GFVerifyInst()
    =GFSetPropVT("UF",PrmUF)
    =GFSetPropVT("SUBGRUPO",PrmClassifica)
	LFretorno=GFFind()
RETURN(LFretorno)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5EY           GFFind VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   12  º
*       º Variable:            GFFind                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      472                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5ey     &&  GFFind VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFFind
	PRIVATE LUF
	PRIVATE LSubGrupo  && SubGrupo da Classificacao do Produto

	PRIVATE LFreturn
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=GFVerifyInst()
	LUF           = GFGetPropVT("UF")
	LSubGrupo     = GFGetPropVT("SUBGRUPO")

	SELE &PBGrFiscalAlias
	SET ORDER TO TAG TRB_ITEM
	SEEK Luf+LSubGrupo

	IF FOUND()
		=GFReadProperty()
		=GFSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5EZ           GFGetFieldValue VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   13  º
*       º Variable:            GFGetFieldValue                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      473                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5ez     &&  GFGetFieldValue VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFGetFieldValue
PARAMETERS PrmUF, PrmClassifica, PrmField


	=GFChk_Identidade(PrmUF, PrmClassifica)

RETURN(GFGetPropVT(PrmField))


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5F0           GF_Refresh VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   14  º
*       º Variable:            GF_Refresh                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      474                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5f0     &&  GF_Refresh VALID
#REGION 14
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION GF_Refresh
PARAMETERS PrmUF, PrmClassifica



	PRIVATE LFretorno
	LFretorno = .t.

	=GFVerifyInst()
    =GFSetPropVT("UF",PrmUF)
    =GFSetPropVT("SUBGRUPO",PrmClassifica)
	LFretorno=GFFind()
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5F1           GFLerRegistro VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   16  º
*       º Variable:            GFLerRegistro                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      475                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5f1     &&  GFLerRegistro VALID
#REGION 14
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION GFLerRegistro
PARAMETERS PrmUF, PrmClassifica



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = GFChk_Identidade(PrmUF, PrmClassifica)
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5FX           GFWriteProp VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   17  º
*       º Variable:            GFWriteProp                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      476                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5fx     &&  GFWriteProp VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBGRFiscalAlias
	=RLOCK()
	GATHER FROM  VTGRFiscal
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5G3           GFSalvarRegistro VALID             º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   18  º
*       º Variable:            GFSalvarRegistro                   º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      477                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5g3     &&  GFSalvarRegistro VALID
#REGION 14
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION GFSalvarRegistro

	=GFVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !GFExiste()
		SELE &PBGRFiscalAlias
		APPEND BLANK
		LFretorno=GFWriteProp()
	ELSE
		SELE &PBGRFiscalAlias
		LFretorno=GFWriteProp()
	ENDIF

RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5GA           GFExiste VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   19  º
*       º Variable:            GFExiste                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      478                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5ga     &&  GFExiste VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFExiste

	PRIVATE LUF
	PRIVATE LSubGrupo  && SubGrupo da Classificacao do Produto

	PRIVATE LFreturn
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=GFVerifyInst()

	LUF           = GFGetPropVT("UF")
	LSubGrupo     = GFGetPropVT("SUBGRUPO")

	SELE &PBGrFiscalAlias
	SET ORDER TO TAG TRIBUTACAO
	SEEK Luf+LSubGrupo

	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _43A0LS5GG           GFGetAlias VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         GRFISCAL,     Record Number:   21  º
*       º Variable:            GFGetAlias                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      479                                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _43a0ls5gg     &&  GFGetAlias VALID
#REGION 14
return
*---------------------------------------------------------------*

FUNCTION GFGetAlias

	=GFVerifyInst()

RETURN(PBGRFiscalAlias)
SSSSS
