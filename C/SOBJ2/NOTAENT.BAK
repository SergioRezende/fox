*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        06/14/13             NOTAENT.SPR               16:42:17 
*                                                                
*       픔컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        Author's Name                                           
*                                                                
*        Copyright (c) 2013 Company Name                         
*        Address                                                 
*        City,     Zip                                           
*                                                                
*        Description:                                            
*        This program was automatically generated by GENSCRN.    
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                       MS-DOS Window definitions                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                 ESTOQUE/MS-DOS Setup Code - SECTION 2          
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 4
RETURN

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                  PRECO/MS-DOS Setup Code - SECTION 2           
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 6
return

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                     NOTAENT/MS-DOS Screen Layout               
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 1
@ 23,2 GET NEGetFieldValue ;
	PICTURE "@*HN NEGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _3t40zsypw()
@ 25,2 GET NEGetUFOrigem ;
	PICTURE "@*HN NEGetUFOrigem - Retorna UFs (Origem da NFE)" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _3t40zsypx()
@ 26,2 GET NEGetUFDestino ;
	PICTURE "@*HN NEGetUFDestino - Retorna UFs (Destino da NFE)" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _3t40zsypy()
@ 27,2 GET NEGetRetidoDestacado ;
	PICTURE "@*HN NEGetRetidoDestacado - Retido Destacado na NFE" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _3t40zsypz()
@ 4,7 GET NEVerifyInst ;
	PICTURE "@*HN NEVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyq0()
@ 5,10 GET NECreate ;
	PICTURE "@*HN NECreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyq1()
@ 13,10 GET NEDestroi ;
	PICTURE "@*HN NEDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyq2()
@ 7,13 GET NEReadProp ;
	PICTURE "@*HN NEReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyq3()
@ 10,15 GET NESetDerivadas ;
	PICTURE "@*HN NESetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyq4()
@ 8,15 GET NESetPropVT ;
	PICTURE "@*HN NESetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyq5()
@ 9,15 GET NEGetPropVT ;
	PICTURE "@*HN NEGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyq6()
@ 3,2 GET NEChk_Identidade ;
	PICTURE "@*HN NEChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyq7()
@ 2,2 GET NEFind ;
	PICTURE "@*HN NEFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyq8()
@ 15,2 GET NEGetFieldValue ;
	PICTURE "@*HN NEGetFieldValue - Retorna o valor do Campo informado" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyq9()
@ 14,2 GET NE_Refresh ;
	PICTURE "@*HN NE_Refresh - Forca Atualiza놹o Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqa()
@ 17,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 19,2 GET NELerRegistro ;
	PICTURE "@*HN NELerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqb()
@ 11,13 GET NEWriteProp ;
	PICTURE "@*HN NEWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqc()
@ 20,2 GET NESalvarRegistro ;
	PICTURE "@*HN NESalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqd()
@ 18,2 GET NEExiste ;
	PICTURE "@*HN NEExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqe()
@ 21,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 16,2 GET NEGetAlias ;
	PICTURE "@*HN NEGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqf()
@ 1,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 29,2 GET NEVerPendencias ;
	PICTURE "@*HN NEVerPendencias - Ver se exitem NFent c status (c) Pendente envio XML" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqg()




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                     NOTAENTA/MS-DOS Screen Layout              
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 2
@ 0,0 GET NEReg_Trans ;
	PICTURE "@*HN NEReg_Trans  - Registra Transito Para Nota de Entrada" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqh()
@ 1,0 GET NECanc_Trans ;
	PICTURE "@*HN NECanc_Trans  - Cancela Transito Para Nota de Entrada" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqj()
@ 3,0 GET NEReg_Entrada ;
	PICTURE "@*HN NEReg_Entrada- Processa Entrada de Mercadorias" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyql()
@ 22,2 GET NEsoma_Saldo ;
	PICTURE "@*HN NEsoma_Saldo- Posiciona Saldo p./ Aoiar Proceso de Entrada" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqm()
@ 23,2 GET NElocaRegSld ;
	PICTURE "@*HN NElocaRegSld- Checa Item e Apoia Processo de Entrada" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqn()
@ 25,2 GET NEfatura ;
	PICTURE "@*HN NEfatura- Efetiva Entrada do Item em Apoia Processo de Entrada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqo()
@ 27,5 GET NEDef_CFO ;
	PICTURE "@*VN NEDef_CFO - Define CFO para Item em Funcao de TP_MERCAD " ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqp()
@ 47,5 GET NEClcDiretoCusto ;
	PICTURE "@*HN NEClcDiretoCusto - Calc Custo Direto Agregando ao Valor Merc Unit na NFE " ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyqq()
@ 28,5 GET ant0613NEClcICMS ;
	PICTURE "@*HN ant0613NEClcICMS - Calc ICMS no item da NFE" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyrq() ;
	DISABLE
@ 30,5 GET ant0613NEIcmsOper ;
	PICTURE "@*HN ant0613NEIcmsOper - Calc ICMS sobre opercao no item da NFE" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyrs() ;
	DISABLE
@ 31,5 GET ant0613NEBsBrRetido ;
	PICTURE "@*HN ant0613NEBsBrRetido - Calc Base Bruta do ICMS RETIDO" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyrv() ;
	DISABLE
@ 40,5 GET NEBsRetido ;
	PICTURE "@*HN NEBsRetido - Calc Base Normal do ICMS RETIDO" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyrx()
@ 41,5 GET NEClcRetido ;
	PICTURE "@*HN NEClcRetido - Calc ICMS RETIDO no item da NFE" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _3t40zsys0()
@ 42,5 GET NEBsEntBrRetido ;
	PICTURE "@*HN NEBsEntBrRetido - Calc Base Bruta do ICMS RETIDO na Entrada" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _3t40zsys2()
@ 43,5 GET NEBsEntRetido ;
	PICTURE "@*HN NEBsEntRetido - Calc Base Normal do ICMS RETIDO na Entrada" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _3t40zsys5()
@ 44,5 GET NEClcEntRetido ;
	PICTURE "@*HN NEClcEntRetido - Calc ICMS RETIDO no item da NFE na Entrada" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _3t40zsys8()
@ 48,5 GET NEClcIndiretoCusto ;
	PICTURE "@*HN NEClcIndiretoCusto - Calculo do Custo Indireto Alocado ao Item" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _3t40zsys9()
@ 50,0 GET NECanc_Entrada ;
	PICTURE "@*HN NECanc_Entrada- Cancela Processo Entrada de Mercadorias" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _3t40zsysb()
@ 51,2 GET NEDesfatura ;
	PICTURE "@*HN NEDesfatura- Cancela Entrada do Item em Apoia Processo de Entrada" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyse()
@ 53,1 GET antNEVerifCustoDistocido ;
	PICTURE "@*HN antNEVerifCustoDistocido - Verifica Distorcao entre Custo Atual e Nova Entrada" ;
	SIZE 1,80,1 ;
	DEFAULT 1 ;
	VALID _3t40zsysf()
@ 55,2 GET NeAjustGru ;
	PICTURE "@*HN NeAjustGrupoNE - Ajuste grupo dene - rotina temporaria" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _3t40zsysi()
@ 56,5 GET NEAjustNE ;
	PICTURE "@*HN NeAjustNE - Ajuste ne - rotina temporaria" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _3t40zsysk()
@ 57,7 GET NEAjustITe ;
	PICTURE "@*HN NEAjustITe- Ajusta Campos Criados Para atender custos" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _3t40zsysl()
@ 26,1 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 49,1 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 45,7 GET antDIConvrtNEDocFiscal ;
	PICTURE "@*HN antDIConvrtNEDocFiscal - Converte um item de NOTA Ent. em item de DOCFISCA" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyso() ;
	DISABLE
@ 29,9 GET xxNEBCIcmsOper ;
	PICTURE "@*HN xxNEBCIcmsOper - Calc base ICMS sobre opercao no item da NFE" ;
	SIZE 1,66,1 ;
	DEFAULT 1 ;
	VALID _3t40zsysx() ;
	DISABLE
@ 14,8 GET NEGeraXML_NOTA ;
	PICTURE "@*HN NEGeraXML_NOTA-Gera XML do DocFiscal ref a NF informada " ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _3t40zsysy()
@ 15,8 GET NEEnviaNfe_NOTA ;
	PICTURE "@*HN NEEnviaNfe_NOTA-Envia XML do DocFiscal para NFe ref a NF informada " ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _3t40zsysz()
@ 16,8 GET NERtrnoNfe_NOTA ;
	PICTURE "@*HN NERtrnoNfe_NOTA-Busca retorno NFe do DocFiscal ref a NF informada " ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyt0()
@ 4,3 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 13,8 GET NEDefIDNFDocFiscal ;
	PICTURE "@*HN NEDefIDNFDocFiscal - Gera ID DocFiscal Refente a NOTA ENT informada" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyt1()
@ 10,6 GET NF_CancDFis ;
	PICTURE "@*HN NF_CancDFis - Cancela Documento Fiscal (NF/NFS/NFe/NFSe/CUPOM)" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyt6()
@ 7,6 GET NEDefCancDFis ;
	PICTURE "@*HN NEDefCancDFis - Define Objetivo Canc DFis (ESCRITURACAO/CANCELAMENTO)" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyt9()
@ 6,6 GET NEDefEnvDFis ;
	PICTURE "@*HN NEDefEnvDFis - Define Objetivo Envio DFis (ESCRITURACAO/CANCELAMENTO)" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyta()
@ 5,3 GET NEEscriturar ;
	PICTURE "@*HN NEEscriturar- Escritura NF Entrada Gerando DFis apos 01/03/2011" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _3t40zsytb()
@ 11,3 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 2,1 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 18,3 SAY "-----------------------------------------------------------------------" ;
	SIZE 1,71, 0
@ 12,5 GET NEGeraDFIS ;
	PICTURE "@*HN NEGeraDFIS-Gera Documento fiscal Para nota de Entrada" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _3t40zsytd()
@ 19,5 GET NEProcEcrtDt ;
	PICTURE "@*HN NEProcEcrtDt - Processa Escrituracao de Saida por Periodo" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyth()
@ 20,5 GET NEPendEcrtDt ;
	PICTURE "@*HN NEPendEcrtDt - Consulta Pendencias Para Escrituracao de Entrada por Periodo" ;
	SIZE 1,77,1 ;
	DEFAULT 1 ;
	VALID _3t40zsytj()
@ 37,5 GET NEClcICMS ;
	PICTURE "@*HN NEClcICMS - Calc ICMS no item da NFE" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _3t40zsytl()
@ 38,5 GET NEIcmsOper ;
	PICTURE "@*HN NEIcmsOper - Calc ICMS sobre opercao no item da NFE" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyto()
@ 39,5 GET NEBsBrRetido ;
	PICTURE "@*HN NEBsBrRetido - Calc Base Bruta do ICMS RETIDO" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _3t40zsytq()
@ 24,2 GET ant0613NEfatura ;
	PICTURE "@*HN ant0613NEfatura- Efetiva Entrada do Item em Apoia Processo de Entrada" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _3t40zsytt() ;
	DISABLE
@ 32,5 GET ant0613NEBsRetido ;
	PICTURE "@*HN ant0613NEBsRetido - Calc Base Normal do ICMS RETIDO" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _3t40zsytx() ;
	DISABLE
@ 33,5 GET antNEClcRetido ;
	PICTURE "@*HN antNEClcRetido - Calc ICMS RETIDO no item da NFE" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _3t40zsytz() ;
	DISABLE
@ 34,5 GET antNEBsEntBrRetido ;
	PICTURE "@*HN antNEBsEntBrRetido - Calc Base Bruta do ICMS RETIDO na Entrada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyu2() ;
	DISABLE
@ 35,5 GET antNEBsEntRetido ;
	PICTURE "@*HN antNEBsEntRetido - Calc Base Normal do ICMS RETIDO na Entrada" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyu5() ;
	DISABLE
@ 36,5 GET antNEClcEntRetido ;
	PICTURE "@*HN antNEClcEntRetido - Calc ICMS RETIDO no item da NFE na Entrada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyu8() ;
	DISABLE




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                     NOTAITE/MS-DOS Screen Layout               
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 3
@ 3,1 SAY "====> Com Uso de pseudo OO" ;
	SIZE 1,26, 0
@ 32,1 SAY "Metodos de Acesso aos Valores das Propriedades" ;
	SIZE 1,46, 0
@ 22,1 SAY "Metodos Chamados ao Executar IESetDerivadas - Nao devem ser Chamados Por Outro" ;
	SIZE 1,78, 0
@ 2,0 GET IETeste ;
	PICTURE "@*HN IETeste - Testes" ;
	SIZE 1,18,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyua()
@ 7,6 GET IEVerifyInst ;
	PICTURE "@*HN IEVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyub()
@ 8,6 GET IECreate ;
	PICTURE "@*HN IECreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyuc()
@ 9,6 GET IEDestroi ;
	PICTURE "@*HN IEDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyue()
@ 10,6 GET IEReadProp ;
	PICTURE "@*HN IEReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyuf()
@ 11,6 GET IESetDerivadas ;
	PICTURE "@*HN IESetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyug()
@ 12,10 GET IESetPropVT ;
	PICTURE "@*HN IESetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyuh()
@ 13,10 GET IEGetPropVT ;
	PICTURE "@*HN IEGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyui()
@ 14,6 GET IEChk_Identidade ;
	PICTURE "@*HN IEChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyuj()
@ 15,6 GET IE_Refresh ;
	PICTURE "@*HN IE_Refresh - Forca Atualiza놹o Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyuk()
@ 16,6 GET IEFind ;
	PICTURE "@*HN IEFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyul()
@ 17,6 GET IEComandText ;
	PICTURE "@*HN IEComandText - Executa Comando em Parametro" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyum()
@ 21,0 GET IECheq_Relacao ;
	PICTURE "@*HN IECheq_Relacao - Verifica Integridade NotaEnt X NotaIte" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyun()
@ 23,4 GET IEcalcicmNormal ;
	PICTURE "@*HN 01-IEcalcIcmNormal - Calcula Valores ICMS Normal Entrada" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyuo()
@ 24,4 GET IEclcIcmSOper ;
	PICTURE "@*HN 01B-IEclcIcmSOper - Calcula Valores ICMS sobre operacao" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyur()
@ 25,4 GET IEcalcIcmSubs ;
	PICTURE "@*HN 02-IEcalcIcmSubs - Calcula Valores ICMS Substituicao Tributaria" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyut()
@ 29,4 GET IECalcCusto ;
	PICTURE "@*HN 03-IECalcCusto - Calcula Custo do Item na Operacao" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyux()
@ 33,3 GET IEGetCusto ;
	PICTURE "@*HN IEGetCusto - Retorna Custo do Item" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyuy()
@ 34,3 GET IEGetBaseCalc ;
	PICTURE "@*HN IEGetBaseCalc - Retorna Base Calculo ICMS" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyuz()
@ 35,3 GET IEGetBsIcmSO ;
	PICTURE "@*HN IEGetBsIcmSO - Retorna BASE ICMS SOBRE OPERACAO" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyv0()
@ 36,3 GET IEGetBsSbBrt ;
	PICTURE "@*HN IEGetBsSbBrt - Retorna BASE_SBBRT" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyv1()
@ 37,3 GET IEGetBsSubs ;
	PICTURE "@*HN IEGetBsSubs - Retorna BASE_SBBRT" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyv2()
@ 38,3 GET IERtdoSaida ;
	PICTURE "@*HN IERtdoSaida - Ret.Vlr.ICM Retido na Saida" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyv3()
@ 39,3 GET IERtdoEntrada ;
	PICTURE "@*HN IERtdoEntrada - Ret.Vlr.ICM Retido na Entrada" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyv4()
@ 40,3 GET IEicmNormal ;
	PICTURE "@*HN IEicmNormal - Ret.Vlr.ICM Normal" ;
	SIZE 1,34,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyv5()
@ 41,3 GET IEicmsSO ;
	PICTURE "@*HN IEicmsSO - Ret.Vlr.ICM Sobre Opera눯o" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyv6()
@ 45,3 GET IEGetIPI ;
	PICTURE "@*HN IEGetIPI - Retorna Valor do IPI no item" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyv7()
@ 46,3 GET IEVerifCustoDistocido ;
	PICTURE "@*HN IEVerifCustoDistocido - Verifica Distorcao entre Custo Atual e Nova Entrada" ;
	SIZE 1,77,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyv8()
@ 47,3 GET IEDisplCusto ;
	PICTURE "@*HN IEDisplCusto - Visualiza Distorcao entre Custo Atual e Nova Entrada" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyv9()
@ 49,3 GET IEExtrato ;
	PICTURE "@*HN IEExtrato - Extrato de Situaca de entrada de itens" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyva()
@ 52,4 GET AIEcalcIcmSubs ;
	PICTURE "@*HN 02-IEcalcIcmSubs - SUBSTITUIDA EM 18/10/2006" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvc() ;
	DISABLE
@ 30,7 GET IEformulaCusto ;
	PICTURE "@*HN 03-IEformulaCusto -" ;
	SIZE 1,21,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvf()
@ 27,4 GET IEcalcPis ;
	PICTURE "@*HN 02-IEcalcPis - Calcula PIS" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvg()
@ 28,4 GET IEcalcCOFINS ;
	PICTURE "@*HN 02-IEcalcCOFINS- Calcula COFINS" ;
	SIZE 1,33,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvh()
@ 42,3 GET IECST ;
	PICTURE "@*HN IECST - Ret.CST" ;
	SIZE 1,17,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvi()
@ 1,38 GET IEatrb_path ;
	SIZE 1,21 ;
	DEFAULT " "
@ 1,1 SAY "1-Path definido para abertura do fbf" ;
	SIZE 1,36, 0
@ 5,6 GET IEDefnPath ;
	PICTURE "@*HN IEDefnPath - Define Pasta de localizacao do dbf referencia" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvj()
@ 19,0 GET IEGetAlias ;
	PICTURE "@*HN IEGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvk()
@ 43,3 GET PrdtOrigem ;
	PICTURE "@*HN IEPrdtOrigem - Ret.ORIGEM do Produto no item 1/2/3/4/5/6/7 (compoe CST)" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvl()




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                     ESTOQUE/MS-DOS Screen Layout               
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 4
@ 10,0 SAY "----------------------   REDEFICAO DE REGRAS   ----------------------------" ;
	SIZE 1,75, 0
@ 19,1 SAY "-------------------------   CONSULTAS   ----------------------------------" ;
	SIZE 1,74, 0
@ 1,3 GET ESPsq_Produtos ;
	PICTURE "@*HN ESPsq_Produtos - Abre Pesquisa de Produto Order Tabela Ret. CODIGO" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvm()
@ 7,0 GET ESAbresaldo ;
	PICTURE "@*HN ESAbresaldo-Abre Reg.de Controle de Saldo " ;
	SIZE 1,44,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvn()
@ 8,0 GET ESversaldo ;
	PICTURE "@*HN ESversaldo -Verificar se Existe Saldo Para Atender/Abre Controle " ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvq()
@ 9,0 GET ESsaldo ;
	PICTURE "@*HN obs * ESsaldo    -Informa Saldo Momento Informado Considara DATA e HORA" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvt()
@ 12,0 GET EScustoMedio ;
	PICTURE "@*HN EScustoMedio - Custo M괺io do Produto na Empresa X e na Data X" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvx()
@ 13,0 GET EScustoEstq ;
	PICTURE "@*HN obs * EScustoEstq - Custo do Estoque Produto na Empresa X e na Data X" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvy()
@ 15,0 GET EScustoAgregado ;
	PICTURE "@*HN EScustoAgregado -Custo M괺io Agregado de Tributacao , etc" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyvz()
@ 16,3 GET ESAgregarTrbt ;
	PICTURE "@*HN ESAgregarTrbt -Agrega Tributos ao Valor Passado Como Custo" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyw0()
@ 17,0 GET ESprc_compra ;
	PICTURE "@*HN ESprc_compra" ;
	SIZE 1,14,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyw1()
@ 20,0 GET EScrtcestq ;
	PICTURE "@*HN antEScrtcestq  - SQL sobre pedido p/ critica de estocagem" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyw9()
@ 21,0 GET EScrtcestq ;
	PICTURE "@*HN EScrtcestq  - SQL sobre pedido p/ critica de estocagem" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _3t40zsywa()
@ 22,0 GET ESextrato ;
	PICTURE "@*HN ESextrato - Extrato de Movimentacao de Estoque" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _3t40zsywc()
@ 23,7 GET ESimpext ;
	PICTURE "@*HN ESimpext - Sub rotina para Impressao Extrato " ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _3t40zsywf()
@ 24,0 GET ESextRess ;
	PICTURE "@*HN ESextRess - Extrato de Ressarcimento" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _3t40zsywg()
@ 25,7 GET ESOrigDest ;
	PICTURE "@*HN ESOrigDest - Funcao de Apoio aos Extratos" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _3t40zsywi()
@ 26,0 GET ESextEntradas ;
	PICTURE "@*HN ESextEntradas - Extrato de Movimentacao de Entrada" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _3t40zsywj()
@ 27,0 GET ESextTrasf ;
	PICTURE "@*HN ESextTrasf - Extrato de Movimentacao de Entrada por Transferencia" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _3t40zsywm()
@ 2,3 GET ESVld_Produto ;
	PICTURE "@*HN ESVld_Produto - Verifica Validade do Produto Informado" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _3t40zsywp()
@ 3,3 GET ESGet_Origem ;
	PICTURE "@*HN ESGet_Origem - Origem Importado ou Nacional" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _3t40zsywr()




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                     MOVIMENT/MS-DOS Screen Layout              
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 5
@ 3,0 GET MVAtu_Cmd ;
	PICTURE "@*HN MVAtu_Cmd  - Atualiza de Saldos Fisicos e Financeiros com Base em ITEMMOV" ;
	SIZE 1,75,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyws()
@ 4,0 GET MVCancelMvto ;
	PICTURE "@*HN MVCancelMvto - Clancela Item do Movimento" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _3t40zsywu()
@ 6,5 GET MVBlqSaldo ;
	PICTURE "@*HN MVBlqSaldo - Bloquear Reg. Saldo  com Base em ITEMMOV" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _3t40zsywy()
@ 7,5 GET MVDesBlqSaldo ;
	PICTURE "@*HN MVDesBlqSaldo - Desbloqueia Bloquear Reg. Saldo  com Base em ITEMMOV" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _3t40zsywz()
@ 10,3 GET MVObterSaldos ;
	PICTURE "@*HN MVObterSaldos - Obter Saldos Base para Processar Movimento" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyx0()
@ 11,8 GET MVIniRegSaldos ;
	PICTURE "@*HN MVIniRegSaldos - Inicializa Registro de Saldos" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyx2()
@ 13,3 GET MVprocessaMvto ;
	PICTURE "@*HN MVprocessaMvto - Processa o Movimento Com Base no Registro Informado" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyx4()
@ 14,6 GET MVSincrItmAnexo ;
	PICTURE "@*HN MVSincrItmAnexo  - Sincronizar Saldos de ItmAnexo Com Itemmov" ;
	SIZE 1,63,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyx8()
@ 15,6 GET MVAtlzSaldos ;
	PICTURE "@*HN MVAtlzSaldos - Atualiza Saldos a Partir da Data do Movimento" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyx9()
@ 16,8 GET MVAtlzComplSaldos ;
	PICTURE "@*HN MVAtlzComplSaldos - Complementa Atualizacao de Saldos " ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyxa()
@ 18,6 GET MVGetCustMedio ;
	PICTURE "@*HN MVGetCustMedio - Obter o Custo Medio Para Operacao em Andamento" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyxb()
@ 19,6 GET MVGetIndRedutor ;
	PICTURE "@*HN MVGetIndRedutor - Obter o Indice de Reducao Oper(/OU*) 1.26 ou 1.24" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyxc()
@ 20,8 GET MVSetSldEntradas ;
	PICTURE "@*HN MVSetSldEntradas - Opera Var(Ambientais) P/ Movim de Entr" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyxe()
@ 21,8 GET MVSetSldSaidas ;
	PICTURE "@*HN MVSetSldSaidas - Opera Var(Ambientais) P/ Movim de Saidas" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyxh()
@ 22,8 GET MVSetSaldos ;
	PICTURE "@*HN MVSetSaldos - Atualiza <Saldo Atual> e <Vlr Atual> => NO CUSTO MEDIO" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyxi()
@ 23,6 GET MVSldFuturo ;
	PICTURE "@*HN MVSldFuturo - Ajusta Registros de Saldo alem da Data Movimento" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyxj()




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                      PRECO/MS-DOS Screen Layout                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 6
@ 1,0 GET PRVlrSaida ;
	PICTURE "@*HN PRVlrSaida - Obert Valor para Operacao de saida" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyxk()
@ 2,3 GET PRVlrTransf ;
	PICTURE "@*HN PRVlrTransf   - Obter Valor para Transferencias" ;
	SIZE 1,49,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyxs()
@ 8,4 GET PRVlrVenda ;
	PICTURE "@*HN PRVlrVenda -Preco Vendas Para OSI Informada" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyxv()
@ 11,4 GET PRClas_Cms ;
	PICTURE "@*HN PRClas_Cms - Obter a Classificao de Grupo de Comissao para Produto" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyy1()
@ 12,0 GET PRCusto ;
	PICTURE "@*HN PRCusto - Obter Custo do Produto" ;
	SIZE 1,34,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyy8()
@ 13,0 GET PRtabvigor ;
	PICTURE "@*HN PRtabvigor" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyb()
@ 14,0 GET PRdesconto ;
	PICTURE "@*HN PRdesconto" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyye()
@ 15,0 GET PRbrow_tab ;
	PICTURE "@*HN PRbrow_tab" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyg()
@ 16,0 GET PRpromocao ;
	PICTURE "@*HN PRpromocao" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyi()
@ 9,7 GET PRVlrTabVgr ;
	PICTURE "@*HN PRVlrTabVgr -Preco em Vigor na Dt Informada" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyk()
@ 3,5 GET PRVlrTransf ;
	PICTURE "@*HN trf_dep010912 - aux de PRVlrTransf - para Orcamentos apos 01-09-2012" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyl()
@ 4,5 GET PRVlrTransf ;
	PICTURE "@*HN trf_dep010503 - aux de PRVlrTransf - para Orcamentos apos 01-05-2003" ;
	SIZE 1,70,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyn()
@ 5,5 GET PRVlrTransf ;
	PICTURE "@*HN trf_ate010503 - aux de PRVlrTransf - para Orcamentos antes de 01-05-2003" ;
	SIZE 1,74,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyp()




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                     TRIBUTAR/MS-DOS Screen Layout              
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 7
@ 36,0 SAY "ROTINAS AINDA VINCULADAS AO ORCAMENTO (AINDA DEPEDEM DO NRO ORCAMENTO)" ;
	SIZE 1,70, 0
@ 3,0 SAY "ROTINAS GERAIS - COM PARAMETROS MAIS INDEPENDENTES E ESPECIFICOS" ;
	SIZE 1,64, 0
@ 12,3 GET TRGet_IPIProd ;
	PICTURE "@*HN TRGet_IPIProd - Obtem a Aliquota de IPI do Produto" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyq()
@ 13,3 GET TRGet_ISSAlq ;
	PICTURE "@*HN TRGet_ISSAlq - Obtem Aliquota de ISS" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyr()
@ 15,6 GET TRdefcst ;
	PICTURE "@*HN TRdefcst - Define CST para Item do Orcamento" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyys()
@ 28,3 GET TRAlqIcmInUF ;
	PICTURE "@*HN TRAlqIcmInUF - Obetem Aliquota Interna de ICMS na UF informada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyt()
@ 29,3 GET TRAlqIcmOuUF ;
	PICTURE "@*HN TRAlqIcmOuUF - Obetem Aliquota Externa de ICMS na UF informada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyu()
@ 25,3 GET TRCFO ;
	PICTURE "@*HN TRCFO  - Obtem CFO Pela OPERACAO E TIPO MERCADORIA" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyw()
@ 37,0 GET ANTTRpct_trib ;
	PICTURE "@*HN ANTTRpct_trib - SUBSTITUIDA EM 10/06/2009" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyy() ;
	DISABLE
@ 41,6 GET TRGet_IPIAlq ;
	PICTURE "@*HN 02-TRGet_IPIAlq - Obtem a Aliquota de IPI do produto para o orcamento" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyyz()
@ 42,6 GET TRGet_cst ;
	PICTURE "@*HN 03-TRGet_cst - Obtem CST para o produto no orcamento" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyz0()
@ 30,3 GET TRDef_tpMercad ;
	PICTURE "@*HN TRDef_tpMercad- DESVIO COMPATIBILIZA COM TRDef_RgTrbMercad (DESCARTAR FUTURO)" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyz1()
@ 43,6 GET TRGet_rduIcms ;
	PICTURE "@*HN 06-TRGet_rduIcms - Obtem Aliquota de Reducao do ICMS" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyz2()
@ 44,6 GET TRGet_IcmsAlq ;
	PICTURE "@*HN 07-TRGet_IcmsAlq - Obtem Aliquota de ICMS para Orcamento" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyz3()
@ 45,6 GET TRGet_CFO ;
	PICTURE "@*HN 08-TRGet_CFO  - Obtem CFO" ;
	SIZE 1,27,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyzb()
@ 39,2 GET TRcalc_tribu ;
	PICTURE "@*HN TRcalc_tribu- Calcula Valores Tributarios Fiscais" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyzc()
@ 49,3 GET CSTENT ;
	PICTURE "@*HN ?? - Define CST NF Entrada" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyzk()
@ 50,4 GET TRRtdoSaida ;
	PICTURE "@*HN 15-TRRtdoSaida - Ret.Vlr.ICM Retido na Saida" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyzl()
@ 51,4 GET TRRtdoEntrada ;
	PICTURE "@*HN 16-TRRtdoEntrada - Ret.Vlr.ICM Retido na Entrada" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyzn()
@ 52,4 GET TRicmNormal ;
	PICTURE "@*HN 17-TRicmNormal - Ret.Vlr.ICM Normal" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyzo()
@ 53,4 GET TREnbsicmNormal ;
	PICTURE "@*HN 18-TREnbsicmNormal - Ret.Base ICMS Norma Entrada" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyzq()
@ 54,4 GET TREbsRtdoCIVA ;
	PICTURE "@*HN 19-TREbsRtdoCIVA - Ret.Base ICMS Retido Entrada (Com IVA)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyzs()
@ 55,4 GET TREbsRtdoSIVA ;
	PICTURE "@*HN 20-TREbsRtdoSIVA - Ret.Base ICMS Retido Entrada (Sem IVA)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyzt()
@ 1,6 GET TRgrupoALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,17 GET TRgrfiscalALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,28 GET TRtab_IvaALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,39 GET TRtipooperALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 40,4 GET TRcalc_Difer ;
	PICTURE "@*HN 11-TRcalc_Difer- Ajusta Diferanca geradas nos tributo percentuais" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyzv()
@ 46,0 SAY "ROTINAS PARA NOVA PLANILHA TRIBUTARIA (OPERCMRC e CLASFISC)" ;
	SIZE 1,59, 0
@ 47,4 GET TRVincTipo ;
	PICTURE "@*HN 16-TRVincTipo - Vincula TIPOOPER a OPERCMRC e A CLASFISC" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyzw()
@ 4,3 GET TRGet_IVA ;
	PICTURE "@*HN TRGet_IVA - Obtem o IVA Ajustada proprio do produto (Pecas)" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _3t40zsyzz()
@ 48,1 SAY "ROTINAS PARA ENTRADA JA USADAS EM SCGC245 (CONTAB NOTAS ENTRADA)" ;
	SIZE 1,64, 0
@ 26,3 GET TRCFOPServico ;
	PICTURE "@*HN TRCFOPServico - Define CFOP para Servico" ;
	SIZE 1,42,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _3t40zsz01()
@ 20,3 GET TRCST_IPI ;
	PICTURE "@*HN TRCST_IPI - Codigo de Situacao Tributaria para IPI" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _3t40zsz02()
@ 21,3 GET TRCST_ISS ;
	PICTURE "@*HN TRCST_ISS - Codigo Sit Tributaria ISS" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _3t40zsz03()
@ 35,3 GET TRGenero ;
	PICTURE "@*HN TRGenero - Define Genero do Produto" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _3t40zsz04()
@ 18,3 GET antTRCST_Entrada ;
	PICTURE "@*HN antTRCST_Entrada- Antes do oliveira criar tabela 3 cst < 31/12/2011" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _3t40zsz05() ;
	DISABLE
@ 14,3 GET TRcst_Icms ;
	PICTURE "@*HN TRcst_Icms - Define CST completo com 3 digitos" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz07()
@ 22,3 GET TRCST_PIS ;
	PICTURE "@*HN TRCST_PIS - Desenvolver" ;
	SIZE 1,25,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _3t40zsz08() ;
	DISABLE
@ 23,3 GET TRCST_COFINS ;
	PICTURE "@*HN TRCST_COFINS - Desenvolver" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _3t40zsz09() ;
	DISABLE
@ 24,3 GET TRCST_IR ;
	PICTURE "@*HN TRCST_IR - Desenvolver" ;
	SIZE 1,24,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _3t40zsz0a() ;
	DISABLE
@ 0,0 SAY "ALIASES" ;
	SIZE 1,7, 0
@ 31,5 GET TRDef_RgTrbMercad ;
	PICTURE "@*HN TRDef_RgTrbMercad - Retorna o Regime Tributario da Merc. na UF" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0b()
@ 38,0 GET TRpct_trib ;
	PICTURE "@*HN TRpct_trib - (01 a 09) em Pacote de Tributos - Acelera processo" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0c()
@ 32,5 GET TRCnvrt_RgTrbMercad ;
	PICTURE "@*HN TRCnvrt_RgTrbMercad - Converte Codigo Reg Trib em String" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0h()
@ 17,3 GET TRcst_Entrada ;
	PICTURE "@*HN TRcst_Entrada - Define CST para Item do Orcamento" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0i()
@ 6,5 GET TR_InternaIVAAjustada ;
	PICTURE "@*HN TR_InternaIVAAjustada - AUX. IVA IVA interna (PECAS) TERMO DE ACORDO TO/DF/GO" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0j()
@ 7,5 GET TR_ICM49IVAjustada ;
	PICTURE "@*HN TR_ICM49IVAjustada - AUX. (PECAS) -PROT.ICMS 49-8/5/2008 IVA AJUSTAS DF/MT" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0k()
@ 9,5 GET TR_ICM62IVAjustada ;
	PICTURE "@*HN TR_ICM62IVAjustada - AUX. (PECAS) -PROT.ICMS 62-22/6/2012 IVA AJUSTAS" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0l()
@ 8,5 GET TR_ICM92IVAjustada ;
	PICTURE "@*HN TR_ICM92IVAjustada - AUX.(PNEUM)-CONV.ICMS 92-30/9/2011 IVA AJUSTAS" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0m()




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                     EMPRESA/MS-DOS Screen Layout               
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 8
@ 21,2 GET EMGet_UF ;
	PICTURE "@*HN EMGet_UF - Obter UF da Loja" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0t()
@ 23,2 GET EMGet_Juro ;
	PICTURE "@*HN EMGet_Juro - Obter Juro Mes da Loja" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0u()
@ 29,2 GET verif ;
	PICTURE "@*HN Verificar Codigo de Empresa" ;
	SIZE 1,29,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0v()
@ 30,2 GET EMrodanroNF ;
	PICTURE "@*HN EMrodanroNF - Roda Numeracao de Nota " ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0w()
@ 24,2 GET EMGet_Mora ;
	PICTURE "@*HN EMGet_Mora - Obter Mora diaria" ;
	SIZE 1,32,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0x()
@ 25,2 GET EMGet_Sigla ;
	PICTURE "@*HN EMGet_Sigla - Obter Sigla da empresa" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0y()
@ 26,2 GET EMGet_ECFSerie ;
	PICTURE "@*HN EMGet_ECFSerie - Obter Nro Serie Ecf" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz0z()
@ 22,2 GET EMGet_Municipio ;
	PICTURE "@*HN EMGet_Municipio - Obter UF da Loja" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz10()
@ 28,2 GET EMGet_TabCst ;
	PICTURE "@*HN EMGet_TabCst - Obter Tab_CST" ;
	SIZE 1,30,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz11()
@ 17,2 GET EMLerRegistro ;
	PICTURE "@*HN EMLerRegistro - Le Registro e Carrega OBJ" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz12()
@ 18,2 GET EMSalvarRegistro ;
	PICTURE "@*HN EMSalvarRegistro - Salva Registro" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz13()
@ 16,2 GET EMExiste ;
	PICTURE "@*HN EMExiste - Le Registro nao carrega o OBJ e Retorna se existe" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz14()
@ 2,7 GET EMVerifyInst ;
	PICTURE "@*HN EMVerifyInst - Verifica Instancia" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz15()
@ 3,10 GET EMCreate ;
	PICTURE "@*HN EMCreate - Instancia" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz16()
@ 11,10 GET EMDestroi ;
	PICTURE "@*HN EMDestroi - Desinstancia" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz17()
@ 5,13 GET EMReadProp ;
	PICTURE "@*HN EMReadProp - Carga do Vetor com Base na Tabela" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz18()
@ 8,15 GET EMSetDerivadas ;
	PICTURE "@*HN EMSetDerivadas - Carga de Propriedades Derivadas" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz19()
@ 6,15 GET EMSetPropVT ;
	PICTURE "@*HN EMSetPropVT - Set o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz1a()
@ 7,15 GET EMGetPropVT ;
	PICTURE "@*HN EMGetPropVT - Get o Valor de uma Propriedade do Vetor" ;
	SIZE 1,55,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz1b()
@ 1,2 GET EMChk_Identidade ;
	PICTURE "@*HN EMChk_Identidade - Checagem de Identidade do Objeto" ;
	SIZE 1,53,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz1c()
@ 0,2 GET EMFind ;
	PICTURE "@*HN EMFind - Localiza Registro Com Base nas Propriedades" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz1d()
@ 13,2 GET EMGetFieldValue ;
	PICTURE "@*HN EMGetFieldValue -Rtrn vlr Campo p/ reg.existente-(erro se chave n existir)" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz1e()
@ 12,2 GET EM_Refresh ;
	PICTURE "@*HN EM_Refresh - Forca Atualiza놹o Objeto" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz1f()
@ 15,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 9,13 GET EMWriteProp ;
	PICTURE "@*HN EMWriteProp - Grava do Vetor para Base na Tabela" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz1g()
@ 19,2 SAY "*-------------------------------------------------------------------*" ;
	SIZE 1,69, 0
@ 14,2 GET EMGetAlias ;
	PICTURE "@*HN EMGetAlias - Retorna Alias da area em que foi abertaa tabela" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz1h()
@ 31,1 SAY "*-----------------------------------------------------------*" ;
	SIZE 1,61, 0
@ 32,2 GET EMMarcaFlgNF ;
	PICTURE "@*HN EMMarcaFlgNF - Marca flag de controle etapa faturamento NF" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz1i()
@ 27,2 GET EMGet_ECFModelo ;
	PICTURE "@*HN EMGet_ECFModelo - Obter Nro Serie Ecf" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	VALID _3t40zsz1j()



READ


#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                      ESTOQUE/MS-DOS Cleanup Code               
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 4

RETURN








********************************------------***************************
* ROTINAS COPIADAS DA BIBLIOTECA ROTESTOQ
*----------------------------------------------------------------------*
*****************************************************************

********************************************************************
*	UEvendas => Rotina para Verificacao das vendas de um produto
*				solicitado em um periodo
*
*	CHAMADO por SCGC800 : Verificacao de Previsao X Venda Real
*				OBJ_ROL1: Apuracao de Venda real no Periodo
*
********************************************************************

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*                       PRECO/MS-DOS Cleanup Code                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 6
return


*****
************************************
********************



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*          ESTOQUE/MS-DOS Supporting Procedures and Functions    
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

#REGION 4
FUNCTION UEvendas
	PARAMETERS LNempresa,LSclas,LScodigo,LDdtini,LDdtfim,LNemdias,;
				LNqtvenda,LNqtentra,LNvlrvenda
	
	=W_DEFPROC("rotinas.SPR")
	*********************************************************************
	PRIVATE ALL
	LSalias 	= ALIAS()

	LNqtvenda   = 0
	LNqtentra	= 0
	LNvlrvenda  = 0

	LNacmqtvenda   	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO
	LNacmqtentra	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO
	LNacmvlrvenda  	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO

	*********************>>> REGISTRO DE SAIDAS <<<*********************
	*
	*   O saldo formado no so e considerado ate a 2/3 do
	* do periodo devido a pouca influencia nas vendas do periodo
	* das entradas do 1/3 restante
	*
	********************************************************************
	LDdtfimsld = LDdtini 		 		&& data para referenciar saldo apuradao
	LNdiassld  = INT(LNemdias / 3)* 2  && para apurar o saldo formado
							 			&& ate metade do periodo
	LNctrdias = 0
	DO WHILE LNctrdias <= LNdiassld
		IF DOW(LDdtfimsld) <> 1
			LNctrdias = LNctrdias +1
		ENDIF
		LDdtfimsld = LDdtfimsld + 1
	ENDDO
	*******************************************************************
	DO UEvervendas WITH LDdtini,LDdtfim, LNempresa, LScodigo,;
			LDdtfimsld,LNqtvenda,LNqtentra,LNvlrvenda

	LNacmqtvenda   	= LNqtvenda
	LNacmqtentra	= LNqtentra
	LNacmvlrvenda  	= LNvlrvenda

	*******************************************************************
	SELE grupoanx
	SET ORDER TO TAG classifica
	SEEK LSclas
	IF FOUND()
		*******************************************************************
		DO UEvervendas WITH LDdtini,LDdtfim, LNempresa,;
				grupoanx.codanx,;
				LDdtfimsld,LNqtvenda,LNqtentra,LNvlrvenda
		LNacmqtvenda   	= LNacmqtvenda  + LNqtvenda
		LNacmqtentra	= LNacmqtentra  + LNqtentra
		LNacmvlrvenda  	= LNacmvlrvenda + LNvlrvenda
		*******************************************************************
	ENDIF	
	LNqtvenda 	=	LNacmqtvenda
	LNqtentra	=	LNacmqtentra
	LNvlrvenda	=	LNacmvlrvenda

	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

********************************************************************

PROCEDURE UEvervendas
	PARAMETERS  LDdtini,LDdtfim, LNempresa, LScodigo,LDdtfimsld,;
				LNqtvenda,LNqtentra,LNvlrvenda,LFdevolucao
	******************************************************************
	*	LFdevolucao	= .F. => Processa as devolucoes abatendo nas vendas
	*	              .T. => Nao abate devolucoes nas vendas
	*
	*	LNempresa 	= 999 => FAZ COM QUE A ROTINA LEVANDE  DADOS DE TODAS
	*						EMPRESAS REGISTRADAS NO ARQ. EMPRESA
	*******************************************************************
	=W_DEFPROC("rotinas.SPR")
	PRIVATE ALL
	LSalias 	= ALIAS()
	LNqtvenda   = 0
	LNqtentra	= 0
	LNvlrvenda  = 0

	SELE empresa
	SET ORDER TO TAG empresa
	IF LNempresa = 999
		GO TOP
	ELSE
		SEEK LNempresa
	ENDIF
	DO WHILE !EOF() AND (LNempresa = 999 OR LNempresa = empresa.empresa)
		SELE itemmov
		SET ORDER TO TAG movimento
		SET NEAR ON
		SEEK STR(empresa.empresa,3)+LScodigo+DTOS(LDdtini)
		SET NEAR OFF
		DO WHILE itemmov.data <= LDdtfim AND ;
				 itemmov.empresa = empresa.empresa AND ;
				 itemmov.codigo  = LScodigo
			IF LEFT(itemmov.operacao,1) = 'S' AND itemmov.ch_opera = "1" 	
			 	LNvlrvenda = LNvlrvenda + itemmov.vlrvenda
				IF itemmov.movestq = "S"
				 	LNqtvenda  = LNqtvenda  + itemmov.qtde
				ENDIF
			ENDIF
			IF !LFdevolucao  && ABATER DEVOLUCOES
				IF LEFT(itemmov.operacao,1) = 'E' AND itemmov.ch_opera = "4" AND ;
				    itemmov.movestq = "S"
				 	LNvlrvenda = LNvlrvenda - itemmov.vlrvenda
					IF (LNqtvenda  - itemmov.qtde) >=  0
				 		LNqtvenda  = LNqtvenda  - itemmov.qtde
					ENDIF
				ENDIF
			ENDIF
		IF itemmov.data <= LDdtfimsld AND LEFT(itemmov.operacao,1) = 'E' ;
				AND itemmov.ch_opera <> "4" AND itemmov.movestq = "S"
				 	LNqtentra  = LNqtentra  + itemmov.qtde
		ENDIF
			***********************************************************
			*  CASO A MERCADORIA SAI POR TRANSFERENCIA OU POR MOV. QUE NAO
			* SEJA VENDA ELA E DESCONSIDERADA
			* DAS ENTRADAS POIS NAO ESTA DESTINADA AO ESTOQUE DE VENDA
			***********************************************************
			IF LEFT(itemmov.operacao,1) = 'S' AND ;
					itemmov.ch_opera <> "1"	&& SAIDAS DEVERSAS DA VENDA
				 IF itemmov.movestq = "S"
					 	LNqtentra  = LNqtentra  - itemmov.qtde
				 ENDIF
				 IF LNqtentra < 0
				 	LNqtentra = 0
				 ENDIF
			ENDIF
			SKIP
		ENDDO	
		IF LNempresa <> 999		&& PESQUISA SO NA EMPRESA INFORMADA
			EXIT
		ENDIF
		SELE empresa
		SKIP
	ENDDO
	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(0)




**********************************************************************
* FUNCTION UEleanexado : Retorna o Codigo ou Codigo Anexado ao Codigo
*						Passado em Parametro
*		LSclas		=>	Codigo a Ser Verificado
*		LSresposta	=>  Indica qual a resposta desejad
*					"ANEXO" = Responder se o Produto Possui algum item
*							Anexado a ele
*					"ANEXADO" = Responder se o Produto esta ANEXADO a
*							outro
*					"QUALQUER"= Responder se existe vinculo em qualqer
*							sentido
***********************************************************************

FUNCTION UEleanexado
PARAMETERS LSclas,LSpergunta
	PRIVATE LSalias, LSresposta

	=W_DEFPROC("rotinas.SPR")

	PRIVATE LFerro
	LSalias = ALIAS()

	LSresposta = ""
    SELE grupoanx
	DO CASE
		CASE LSpergunta = "ANEXO"
			SET ORDER TO TAG classifica
			SEEK LSclas
			IF FOUND()
				LSresposta = grupoanx.codanx	&& E ANEXO DO CODIGO INFORMADO
			ENDIF
		CASE LSpergunta = "ANEXADO"
			SET ORDER TO TAG clasanx
			SEEK LSclas
			IF FOUND()
				LSresposta = grupoanx.codanx	&& E ANEXO DO CODIGO INFORMADO
			ENDIF
		CASE LSpergunta = "QUALQUER"
			LSresposta = UEleanexado(LSclas,"ANEXO")
			IF EMPTY(LSresposta)
				LSresposta = UEleanexado(LSclas,"ANEXADO")
			ENDIF
	ENDCASE
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSresposta)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYPW           NEGetFieldValue VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    2   
*        Variable:            NEGetFieldValue                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      1                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsypw     &&  NEGetFieldValue VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NEGetFieldValue
PARAMETERS PrmEmp,PrmBoletim,PrmForn,PrmField

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT(PrmField))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYPX           NEGetUFOrigem VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    3   
*        Variable:            NEGetUFOrigem                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      2                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsypx     &&  NEGetUFOrigem VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NEGetUFOrigem
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT("UF"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYPY           NEGetUFDestino VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    4   
*        Variable:            NEGetUFDestino                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      3                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsypy     &&  NEGetUFDestino VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NEGetUFDestino
PARAMETERS PrmEmp,PrmBoletim,PrmForn
	PRIVATE Lvalue


	=W_DEFPROC("empresa.spr")
	Lvalue = EMGet_UF(PrmEmp)

RETURN(Lvalue)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYPZ           NEGetRetidoDestacado VALID         
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    5   
*        Variable:            NEGetRetidoDestacado               
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      4                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsypz     &&  NEGetRetidoDestacado VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NEGetRetidoDestacado
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT("ICMS_SUBS"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQ0           NEVerifyInst VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    6   
*        Variable:            NEVerifyInst                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      5                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyq0     &&  NEVerifyInst VALID
#REGION 1
return
*---------------------------------------------------------------*



FUNCTION NEVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("NOTAENT")


	DO CASE

		CASE TYPE("PBNotaEntAlias") = "U" ;
		   		OR EMPTY(PBNotaEntAlias) ;
		   		OR !USED(PBNotaEntAlias)
			=NECreate()					

		CASE !("NOTAENT.DBF" $ DBF(PBNotaEntAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBNotaEntAlias
			=NECreate()					


		CASE  !(LSPath $ DBF(PBNotaEntAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=NEDestroi()				
			=NECreate()					
	ENDCASE

	
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQ1           NECreate VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    7   
*        Variable:            NECreate                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      6                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyq1     &&  NECreate VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NECreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBNotaEntAlias") <> "U" ;
	   		AND !EMPTY(PBNotaEntAlias) ;
	   		AND USED(PBNotaEntAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBNotaEntAlias

	IF USED("NotaEnt")
	     =NetArqAgain("NotaEnt")
	     PBNotaEntAlias     = Alias()
	ELSE
	     =NetArqAgain("NotaEnt")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("NotaEnt")
	     PBNotaEntAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBNotaEntAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTNotaEnt[LMaxDim]
    PUBLIC DIMENSION VDNotaEnt[2,3]	&& VETOR PARA PROPRIEDADES
    PUBLIC DIMENSION VFNotaEnt[1]      && VETOR CABECALHO DOS CAMPOS
	=AFIELDS(VFNotaEnt)



	*-----------------------------------------------------------*
	=NEReadProperty()
	=NESetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQ2           NEDestroi VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    8   
*        Variable:            NEDestroi                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      7                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyq2     &&  NEDestroi VALID
#REGION 1
return
*---------------------------------------------------------------*


FUNCTION NEDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBNotaEntAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBNotaEntAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBNotaEntAlias
	*  3- Se aplicar um FECHAMENTO a PBNotaEntAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBNotaEntAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBNotaEntAlias)) OR ;
	   !("NOTAENT.DBF" $ DBF(PBNotaEntAlias))

		RELEASE PBNotaEntAlias
    	RELEASE VTNotaEnt
	    RELEASE VDNotaEnt
		RELEASE VFNotaEnt
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBNotaEntAlias) AND USED(PBNotaEntAlias)
		SELECT &PBNotaEntAlias
		USE
	ENDIF	
	RELEASE PBNotaEntAlias
    RELEASE VTNotaEnt
    RELEASE VDNotaEnt
	RELEASE VFNotaEnt

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQ3           NEReadProp VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:    9   
*        Variable:            NEReadProp                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      8                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyq3     &&  NEReadProp VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NEReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBNotaEntAlias
	SCATTER TO VTNotaEnt
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQ4           NESetDerivadas VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   10   
*        Variable:            NESetDerivadas                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      9                                  
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyq4     &&  NESetDerivadas VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NESetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	*--------------------------------------------------------------*
    VDNotaEnt(1,1) = "UF DESTINO"
   	VDNotaEnt(1,2) = 0
   	VDNotaEnt(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQ5           NESetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   11   
*        Variable:            NESetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      10                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyq5     &&  NESetPropVT VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NESetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,;
							PrmValue,;
						    PBNotaEntAlias,;
						    VTNotaEnt,;
						    VDNotaEnt,;
						    VFNotaEnt)

RETURN(Lvalue)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQ6           NEGetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   12   
*        Variable:            NEGetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      11                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyq6     &&  NEGetPropVT VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NEGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,;
	            PBNotaEntAlias,;
	            VTNotaEnt,;
	            VDNotaEnt,;
	            VFNotaEnt)

RETURN(Lvalue)





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQ7           NEChk_Identidade VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   13   
*        Variable:            NEChk_Identidade                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      12                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyq7     &&  NEChk_Identidade VALID
#REGION 1
return
*---------------------------------------------------------------*


FUNCTION NEChk_Identidade
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	PRIVATE LFretorno
	LFretorno = .t.

	=NEVerifyInst()

    =NESetPropVT("EMPRESA",PrmEmp)
    =NESetPropVT("REFERENCIA",PrmBoletim)
    =NESetPropVT("CODFORN",PrmForn)

	LFretorno=NEFind()
RETURN(LFretorno)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQ8           NEFind VALID                       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   14   
*        Variable:            NEFind                             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      13                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyq8     &&  NEFind VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NEFind

	PRIVATE LEmpresa, LReferencia, LCodForn
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NEVerifyInst()


	LEmpresa    = NEGetPropVT("Empresa")
	LReferencia = NEGetPropVT("Referencia")
	LCodForn    = NEGetPropVT("CodForn")


	SELE &PBNotaentAlias
	SET ORDER TO TAG BOLETIM
	SEEK STR(LEmpresa,3)+STR(LReferencia,6)+STR(LCodForn,5)
	IF FOUND()
		=NEReadProperty()
		=NESetDerivadas()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQ9           NEGetFieldValue VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   15   
*        Variable:            NEGetFieldValue                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      14                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyq9     &&  NEGetFieldValue VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NEGetFieldValue
PARAMETERS PrmEmp,PrmBoletim,PrmForn,PrmField

	=NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)

RETURN(NEGetPropVT(PrmField))



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQA           NE_Refresh VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   16   
*        Variable:            NE_Refresh                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      15                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqa     &&  NE_Refresh VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
FUNCTION NE_Refresh
PARAMETERS PrmEmp,PrmBoletim,PrmForn

	PRIVATE LFreturn
	
	=NEVerifyInst()
	*----------------------------------------------------------------*
	
    =NESetPropVT("EMPRESA",PrmEmp)
    =NESetPropVT("REFERENCIA",PrmBoletim)
    =NESetPropVT("CODFORN",PrmForn)
	=NEFind()
	
RETURN(.t.)






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQB           NELerRegistro VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   18   
*        Variable:            NELerRegistro                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      16                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqb     &&  NELerRegistro VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NELerRegistro
PARAMETERS PrmEmp,PrmBoletim,PrmForn



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = NEChk_Identidade(PrmEmp,PrmBoletim,PrmForn)
RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQC           NEWriteProp VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   19   
*        Variable:            NEWriteProp                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      17                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqc     &&  NEWriteProp VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NEWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()


	SELE &PBNotaEntAlias
	=RLOCK()
	GATHER FROM  VTNotaEnt
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQD           NESalvarRegistro VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   20   
*        Variable:            NESalvarRegistro                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      18                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqd     &&  NESalvarRegistro VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NESalvarRegistro

	=NEVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !NEExiste()
		SELE &PBNotaEntAlias
		APPEND BLANK
		LFretorno=NEWriteProp()
	ELSE
		SELE &PBNotaEntAlias
		LFretorno=NEWriteProp()
	ENDIF

RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQE           NEExiste VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   21   
*        Variable:            NEExiste                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      19                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqe     &&  NEExiste VALID
#REGION 1
return
*---------------------------------------------------------------*
FUNCTION NEExiste

	PRIVATE LEmpresa, LReferencia, LCodForn
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=NEVerifyInst()


	LEmpresa    = NEGetPropVT("Empresa")
	LReferencia = NEGetPropVT("Referencia")
	LCodForn    = NEGetPropVT("CodForn")


	SELE &PBNotaentAlias
	SET ORDER TO TAG BOLETIM
	SEEK STR(LEmpresa,3)+STR(LReferencia,6)+STR(LCodForn,5)
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQF           NEGetAlias VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   23   
*        Variable:            NEGetAlias                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      20                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqf     &&  NEGetAlias VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NEGetAlias

	=NEVerifyInst()

RETURN(PBNotaEntAlias)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQG           NEVerPendencias VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENT,     Record Number:   25   
*        Variable:            NEVerPendencias                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      21                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqg     &&  NEVerPendencias VALID
#REGION 1
return
*---------------------------------------------------------------*

FUNCTION NEVerPendencias
PARAMETERS PrmEmp
    PRIVATE LSRetorno

	PRIVATE LSalias
	LSalias		= 	ALIAS()



	=W_DEFPROC("NOTAENT.SPR")
	NFAlias = NEGetAlias()

    SELECT NOTA FROM &NFAlias;
     WHERE empresa = PrmEmp ;
     and situacao = "c" ;
     INTO CURSOR NFEntTmp

   SELE NFEntTmp
   GO TOP
   IF EOF()
      LSretorno = 0
   ELSE
      LSretorno = NFEntTmp.nota
   ENDIF
   USE

   IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
   ENDIF


RETURN(LSretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQH           NEReg_Trans VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:    2  
*        Variable:            NEReg_Trans                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      22                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqh     &&  NEReg_Trans VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEReg_Trans
PARAMETERS LNemp,LNboletim,LNforn
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar o Registro de Transito
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		.f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA
	*		SCGC210.spr
	*		SCGCF211.PRG
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.

	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	=NE_Refresh(LNemp,LNboletim,LNforn);

	*--------------------------------------------------------------*
	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)
	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)
	    WAIT WINDOW "ITEM => "+STR(notaite.ordem,2) NOWAIT
		IF LEFT(notaite.situacao,1) $ "A"
   			SELECT notaite
			IF !ULregItTrans()
				LFretorno = .F.
				EXIT
			ENDIF		
		ENDIF
		SELECT notaite
		SKIP
	ENDDO

	*----------------------------------------------------------*
	=W_DEFPROC("PEDIDO.SPR")
	=PDstat_pedd(notaent.empresa,notaent.pedido)
	*----------------------------------------------------------*
	SELE notaent
	IF LFretorno
		WAIT WINDOW " OK ! " NOWAIT
		SELECT notaent
		m.situacao  =   "B"+RIGHT(situacao,1)
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO situacao
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)

*-----------------------------------------------------------------*
*  Rotina de apoio para manipular o item atual da nota de entrada
*------------------------------------------------------------------*
FUNCTION  ULregItTrans
	IF !REGLOCK()
		RETURN(.F.)
	ENDIF

   	SCATTER MEMVAR MEMO
   	m.operacao = 'TRM.'   && TRANSITO / MERCADORIA
   	LNcstind  = 0
   	SET DECIMALS TO 2
   	m.situacao 	=  'B'+RIGHT(m.situacao,1)
   	m.nota 		=  notaent.nota
   	m.dtfat 	=  notaent.data_emi
    IF notaent.pedido > 0 ;
    	AND LEFT(m.codigo,7) <> "9999999";
	   	AND notaite.movestq = "S" ;
	   	AND notaite.movfin = "S"
		*----------------------------------------------------------*
		*-----------------------------------------------------------*
		*    So tratar pedido nos diretorios LOJA ou CENTRAL ou
		* para datas com superiores a 2000
		*-----------------------------------------------------------*
		IF notaent.data >= {01.01.2000}
		 =W_DEFPROC("PEDIDO.SPR")
		 IF !PDregistra_qte(notaent.empresa,notaent.pedido,notaite.codigo,;
							notaite.qtde,"REG.TRANSITO")
			RETURN(.F.)
		 ENDIF
		ENDIF
		*----------------------------------------------------------*
   	ENDIF
   	SELECT notaite
    =edithand('REGRAVA')
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQJ           NECanc_Trans VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:    3  
*        Variable:            NECanc_Trans                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      23                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqj     &&  NECanc_Trans VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NECanc_Trans
PARAMETERS LNemp,LNboletim,LNforn
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Controlar o Cancelamento de Transito
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		.f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA
	*		SCGC210.spr
	*		SCGCF211.PRG
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.

	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	IF !REGLOCK()
	    WAIT WINDOW "Documento nao poder ser bloqueado para o processo."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*--------------------------------------------------------------*
	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)
	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)
	    WAIT WINDOW "ITEM => "+STR(notaite.ordem,2) NOWAIT
		IF LEFT(notaite.situacao,1) $ "B"
   			SELECT notaite
			IF !ULCancItTrans()
				LFretorno = .F.
				EXIT
			ENDIF		
		ENDIF
		SELECT notaite
		SKIP
	ENDDO
	*----------------------------------------------------------*
	=W_DEFPROC("PEDIDO.SPR")
	=PDstat_pedd(notaent.empresa,notaent.pedido)
	*----------------------------------------------------------*
	SELE notaent
	IF LFretorno
		WAIT WINDOW " OK ! " NOWAIT
		SELECT notaent
		m.situacao  =   "A"+RIGHT(situacao,1)
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO situacao
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)

*-----------------------------------------------------------------*
*  Rotina de apoio para manipular o item atual da nota de entrada
*------------------------------------------------------------------*
FUNCTION  ULCancItTrans
	IF !REGLOCK()
		RETURN(.F.)
	ENDIF

   	SCATTER MEMVAR MEMO
   	m.operacao = 'TRM.'   && TRANSITO / MERCADORIA
   	LNcstind  = 0
   	SET DECIMALS TO 2
   	m.nota 		=  notaent.nota
   	m.dtfat 	=  notaent.data_emi
    IF notaent.pedido > 0 ;
    	AND LEFT(m.codigo,7) <> "9999999";
	   	AND notaite.movestq = "S" ;
	   	AND notaite.movfin = "S"
		*----------------------------------------------------------*
		*-----------------------------------------------------------*
		*    So tratar pedido nos diretorios LOJA ou CENTRAL ou
		* para datas com superiores a 2000
		*-----------------------------------------------------------*
		IF notaent.data >= {01.01.2000}
		 =W_DEFPROC("PEDIDO.SPR")
		 IF !PDregistra_qte(notaent.empresa,notaent.pedido,notaite.codigo,;
							notaite.qtde,"CANC.TRANSITO")
			RETURN(.F.)
		 ENDIF
		ENDIF
		*----------------------------------------------------------*
   	ENDIF
   	m.situacao 	=  'A'+RIGHT(notaent.situacao,1)
   	SELECT notaite
    =edithand('REGRAVA')
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQL           NEReg_Entrada VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:    4  
*        Variable:            NEReg_Entrada                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      24                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyql     &&  NEReg_Entrada VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEReg_Entrada
PARAMETERS LNemp,LNboletim,LNforn,PrmSolicitante
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Processr Entradas
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		.f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA
	*		SCGC210.spr
	*		SCGCF211.PRG
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.

	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	IF !REGLOCK()
	    WAIT WINDOW "Documento nao poder ser bloqueado para o processo."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	=NE_Refresh(LNemp,LNboletim,LNforn);

	*--------------------------------------------------------------*

	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)

	*---------------------------------------------------------------*
	* Verificacao do itens para liberar entrada
	*---------------------------------------------------------------*
	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)

		IF  notaite.vlrvenda = 0
		    WAIT WINDOW "Entrada "+STR(notaent.referencia,6)+;
			    	" Possui Item sem Valor Lancado."
			LFretorno = .F.
			EXIT
		ENDIF

		IF notaite.movestq = "S" AND (LEFT(notaite.situacao,1) $ "B")
		    IF !NEsoma_Saldo()
				LFretorno = .F.
				EXIT
			ENDIF
		ENDIF

		**  TESTAR PEDIDO NO PERIODO ACIMA DE 1998
		IF  notaent.data > {01.05.99} ;
		        AND (notaent.codforn = 1 or notaent.codforn = 2) ;
		        AND (notaent.empresa = 1 OR "CENTRAL" $ wp_dirdat) ;
		        AND notaite.ch_opera = "1" ;
				AND LEFT(notaite.classifica,2) $ "00/01" ;
				AND notaent.pedido = 0
				
			    WAIT WINDOW "Entrada "+STR(notaent.referencia,6)+;
			    	" sem Nro.Pedido."
				LFretorno = .F.
				EXIT
		ENDIF
	    IF notaent.pedido > 0 AND notaent.data > {01.01.2000}
			*----------------------------------------------------------*
			=W_DEFPROC("PEDIDO.SPR")
			IF !PDloc_item(notaent.empresa,;
						notaent.pedido,;
						notaite.codigo,.T.)
				LFretorno = .F.
				EXIT
   			ENDIF
			*----------------------------------------------------------*
		ENDIF
		SELE notaite
		SKIP
	ENDDO
	SELE notaite
	IF !LFretorno   && OPERACAO ABORTADA
    	WAIT WINDOW " Os Itens estao irregulares. Tente Novamente.  <ENTER>"
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF			

	*---------------------------------------------------------------*

	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)

	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)

		LSmsg = "Cancelando Emp.: "+STR(notaent.empresa,3);
							+" NE: "+STR(notaent.nota,6);
							+" DT: "+DTOC(notaent.data) ;
							+"ITEM => "+STR(notaite.ordem,2)
		WAIT WINDOWS LSmsg NOWAIT

		IF LEFT(notaite.situacao,1) $ "B"
   			SELECT notaite
			IF !ULEntrait()
				LFretorno = .F.
				EXIT
			ENDIF		
		ENDIF
		SELECT notaite
		SKIP
	ENDDO
	*----------------------------------------------------------*
	=W_DEFPROC("PEDIDO.SPR")
	=PDstat_pedd(notaent.empresa,notaent.pedido)
	*----------------------------------------------------------*
	*----------------------------------------------------------*
	=W_DEFPROC("PEDIDO.SPR")
	LFretorno=PDstat_pedd(notaent.empresa,notaent.pedido)
	*----------------------------------------------------------*




	SELE notaent
	IF LFretorno
		WAIT WINDOW " OK ! " NOWAIT
		SELECT notaent

        IF PrmSolicitante =  "IMPORTACAO"
			m.situacao  = "C"+RIGHT(situacao,1)   && AGUARDANDO ESCRITURACAO
		ELSE
			m.situacao  = "c"+RIGHT(situacao,1)   && AGUARDANDO ESCRITURACAO
		ENDIF

		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO situacao
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ENDIF
	*--------------------------------------------------------------*

    IF PrmSolicitante <> "IMPORTACAO"

		PRIVATE LSobjetivo,LSexibmsg

		LSexibmsg = "SIM"

		=W_DEFPROC("NOTAENT.SPR")
		LSobjetivo = ;
		   NEDefEnvDFis(  Notaent.Empresa, Notaent.nf_mod_doc )


		=W_DEFPROC("NOTAENT.SPR")
		IF NEGeraDFIS(Notaent.Empresa,Notaent.Nota,;
		              notaent.CodForn,;
		              LSexibmsg,;
		              LSobjetivo)

			WAIT WINDOW " OK ! " NOWAIT
			SELECT notaent

			m.situacao  =   "C"+RIGHT(situacao,1)   && ESCRITURACAO

	        * DENTRO DO NEGeraDfis coloquei uma replicacao desta instrucao

			***************************
			SET FIELDS TO dtregis, hregis, usrregis,deletado
			SET FIELDS TO situacao
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF
			***************************
		ENDIF
	ENDIF


	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)

*-----------------------------------------------------------------*
*  Rotina de apoio para manipular o item atual da nota de entrada
*------------------------------------------------------------------*
FUNCTION ULEntrait
	PRIVATE LFretorno
	LFretorno = .t.
	*-------------------------------------------------------------*
   	IF notaite.movestq = "S"
	    IF NEsoma_Saldo()
    		SELECT notaite
			IF REGLOCK()

				IF !NEfatura()     && ****

					LFretorno = .F.
					EXIT
				ENDIF
			ELSE
				LFretorno = .F.
				EXIT
			ENDIF
		ELSE
			LFretorno = .F.
			EXIT
		ENDIF
		SELECT  notaite
	ELSE
   		SELECT notaite
		IF REGLOCK()
			m.situacao = 'C'+RIGHT(m.situacao,1)
			m.dtfat = wp_dtoper
			=edithand('REGRAVA')
		ELSE
			LFretorno = .F.
			EXIT
		ENDIF
	ENDIF
	*-------------------------------------------------------------*
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQM           NEsoma_Saldo VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:    5  
*        Variable:            NEsoma_Saldo                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      25                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqm     &&  NEsoma_Saldo VALID
#REGION 2
return

*---------------------------------------------------------------*
FUNCTION NEsoma_Saldo  && VERIFICA POSSIB. SOMA ESTOQUE  (proces)
	PRIVATE LNsaldo,LNqtde,LNcusto,LNreserva

	store 0 to  LNsaldo,LNqtde,LNcusto,LNreserva
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
    IF notaent.natu_oper = 6	&& REQUISICAO DE SAIDA
		*----------------------------------------------------------*
		*=W_DEFPROC("ESTOQUE.SPR")
		*=ESsaldo(notaent.empresa	,notaite.codigo ,;
		*		 notaite.classifica , notaent.data,;
		*		 LNqtde	, LNcusto	,notaent.hora	,LNreserva)
		*----------------------------------------------------------*
		=W_DEFPROC("ESTOQUE.SPR")
		IF NOT ESversaldo(notaent.empresa  ,notaite.codigo ,;
			notaent.data, notaite.qtde, LNreserva,;
					.T.,.F.,"SAIDA",notaent.hora,notaite.movestq)
			wp_msg = RTRIM(transform(notaite.codigo,'@R &masc_codi'))+;
	       			" Possui Saldo Insuficiente = "+STR(saldo.sld_atu,6)
    	  	WAIT WINDOW wp_msg+" <ENTER> "
			RETURN .F.
		ENDIF

        *-----------------------------------------------------------*
		*LNsaldo = LNqtde - LNreserva
	    *IF notaite.qtde > LNsaldo
	    *	wp_msg = RTRIM(transform(notaite.codigo,'@R &masc_codi'))+;
        *          	" Possui Saldo Insuficiente = "+STR(saldo.sld_atu,6)
		*	      	WAIT WINDOW wp_msg+" <ENTER> "
		*	RETURN .F.
		*ENDIF
        *-----------------------------------------------------------*
   ENDIF
RETURN(NElocaRegSld())





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQN           NElocaRegSld VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:    6  
*        Variable:            NElocaRegSld                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      26                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqn     &&  NElocaRegSld VALID
#REGION 2
return

*---------------------------------------------------------------*
FUNCTION NElocaRegSld
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LFretorno
	LFretorno	=  .t.
	*----------------------------------------------------------*
   	PRIVATE LFlockReg
	PRIVATE LFabreAuto
	PRIVATE LNJaReserv	
	LFlockReg	= .T.	&& BLOQUEAR REGISTRO
    LFabreAuto	= .F. 	&& ABRIR CONTROLE AUTOMATICAMENTE
	LNJaReserv	= 0		&& QTDE JA RESERVADA DESTE ITEM NESTE DOC
	=W_DEFPROC("ESTOQUE.SPR")
	IF !ESversaldo(notaent.empresa,notaite.codigo, notaent.data,;
				notaite.qtde,LNJaReserv,LFabreAuto,;
				LFlockReg,"ENTRADA",;
				notaent.hora,notaite.movestq)
		LFretorno	=  .F.
	ENDIF
	*----------------------------------------------------------*
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQO           NEfatura VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:    7  
*        Variable:            NEfatura                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      27                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqo     &&  NEfatura VALID
#REGION 2
return

*---------------------------------------------------------------*
FUNCTION NEfatura
	PRIVATE vlr_icms, m.icms_subs
	
	PRIVATE LFretorno
	LFretorno	=  .t.
	*----------------------------------------------------------*
  	SELECT notaite
   	LNnota = m.nota     && EVITA APAGAR N. NOTA
   	SCATTER MEMVAR MEMO
   	DO CASE
		CASE m.natu_oper = 1
		   m.operacao = 'ECP.'   && ENTRADA/COMPRA/PROCESSADA
		CASE m.natu_oper = 2
		   m.operacao = 'ETP.'   && ENTRADA/TRANSFERENCIA/PROCESSADA
		CASE m.natu_oper = 3
		   m.operacao = 'ERP.'   && ENTRADA/REMESSA/PROCESSADA
		CASE m.natu_oper = 4
		   m.operacao = 'EDP.'   && ENTRADA/DEVOLUCAO/PROCESSADA
		CASE m.natu_oper = 5
		   m.operacao = 'EOP.'   && ENTRADA/OUTRAS OPER/PROCESSADA
		CASE m.natu_oper = 6
		   m.operacao = 'SOP.'   && SAIDA/OUTRAS OPER / PROCESSADA
   	ENDCASE

	*---------------------------------------------------------------*
	*  CALCULO DO CUSTO INDIRETO
	*---------------------------------------------------------------*
	
	LNcstind = NEClcIndiretoCusto( ;
					notaent.data_emi, ;
					notaent.totproduto, notaent.vlr_ipi, ;
					notaent.vlrFrete, notaent.vlrdespes, ;
					notaent.vlrseguro,;
					notaite.vlrvenda, notaite.vlripi)

	**********************************
   	m.situacao 	= 'C'+RIGHT(m.situacao,1)
   	m.nota 	   	=  notaent.nota
   	m.dtfat 	=  notaent.data_emi
   	m.custo_ind =  LNcstind



    *-------------- ICMS NORMAL -------------*

    IF m.origem = 1		&& importado
	     m.bsbr_icms  = m.vlrvenda + m.VLRIPI
	ELSE
	     m.bsbr_icms  = m.vlrvenda
	ENDIF

	m.aliq_rdu = 0
	
    IF notaent.reduc_icms > 0
       m.aliq_rdu = notaent.reduc_icms
    ENDIF

	DO CASE
		CASE m.aliq_rdu > 0
		   m.base_calc = m.bsbr_icms * m.aliq_rdu

		CASE notaent.codforn = 1 OR notaent.codforn = 1130
		      m.base_calc = m.bsbr_icms  - ;
			 				(m.bsbr_icms * (4.9/100))
			  m.aliq_rdu  = 4.9/100

		CASE notaent.codforn = 2
		      m.base_calc = m.bsbr_icms  - ;
			 				(m.bsbr_icms * (5.19/100))
			  m.aliq_rdu  = 5.19/100

		OTHERWISE
			m.base_calc = m.bsbr_icms
	ENDCASE	

**    SET STEP ON

	m.vlr_icms = NEClcICMS(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,;
							notaite.origem,;
							recno("NOTAITE"))

    *-------------- ICMS SOBRE OPERACAO -------------*

    m.bsbricmso  = 0
    m.baseicmso  = 0
	m.icmssoper  = 0


	if notaent.icmssoper > 0

		DO CASE
			CASE m.origem = 1		&& importado
			     m.bsbricmso  = m.vlrvenda + m.VLRIPI + m.custo_ind
			CASE m.tp_mercad = 8		&& importado
			     m.bsbricmso  = m.vlrvenda
			OTHERWISE	
		         m.bsbricmso  = m.vlrvenda  &&  + m.custo_ind
		ENDCASE
	
		DO CASE
			CASE m.aliq_rdu > 0

			 m.baseicmso  = m.bsbricmso * m.aliq_rdu

		     **** m.baseicmso = m.bsbricmso  - ;
				 				(m.bsbricmso * m.aliq_rdu)

			CASE notaent.codforn = 1 OR notaent.codforn = 1130
		      m.baseicmso = m.bsbricmso  - ;
				 				(m.bsbricmso * (4.9/100))


			CASE notaent.codforn = 2
		      m.baseicmso = m.bsbricmso  - ;
				 				(m.bsbricmso * (5.19/100))



			OTHERWISE
				m.baseicmso = m.bsbricmso
		ENDCASE	
	
		m.icmssoper = NEIcmsOper(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,;
							notaite.origem,;
							recno("NOTAITE"))

	endif
	*---------------------------------------------------*


	m.Base_sbbrt = NEBsBrRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,  ;
							notaite.vlripi,    ;
							recno("NOTAITE"),;
							notaite.origem)
				
	m.Base_subs  = NEBsRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.Base_sbbrt,    ;
							recno("NOTAITE"),;
							notaite.origem)


	m.icms_subs  = NEClcRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.vlr_icms,m.Base_subs,;
							m.icmssoper,    ;
							recno("NOTAITE") ,;
							notaite.origem)


	m.BsEntsbbrt = NEBsEntBrRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,  ;
							notaite.vlripi,    ;
							notaite.custo_ind, ;
							recno("NOTAITE") ,;
							notaite.origem)
							
	m.BsEntSubs  = NEBsEntRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.BsEntsbbrt, ;
							recno("NOTAITE"), ;
							notaite.origem)

	m.IcmsEntsub = NEClcEntRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.vlr_icms,m.BsEntSubs,;
							m.icmssoper,    ;
							recno("NOTAITE"),;
							notaite.origem)





   	IF m.pedido > 0 and LEFT(m.codigo,7) <> "9999999"
		*-----------------------------------------------------------*
		*    So tratar pedido nos diretorios LOJA ou CENTRAL ou
		* para datas com superiores a 2000
		*-----------------------------------------------------------*
		IF notaent.data >= {01.01.2000}
		  *----------------------------------------------------------*
		  =W_DEFPROC("PEDIDO.SPR")
		  IF !PDregistra_qte(notaent.empresa,notaent.pedido,notaite.codigo,;
							notaite.qtde,"REG.ENTRADA")
			RETURN(.F.)
		  ENDIF
		ENDIF
 		 *----------------------------------------------------------*
   ENDIF
**
   SELECT notaite
	=edithand('REGRAVA')

    =W_DEFPROC("NOTAITE.SPR")
	=IE_Refresh(m.empresa,m.orcamento,m.favorecido,m.ordem)


    SELECT itemmov
	m.data = notaent.data
	m.hora = notaent.hora
	m.sld_estq = 0
	m.vlr_estq = 0
	************************************************************
	*    - GARANTIA CONTRA DUPLICACAO							*
	************************************************************
	SET ORDER TO TAG movimento
	SEEK STR(m.empresa,3) + m.codigo + DTOS(m.data) + m.hora +;
			 		 + m.tipo + STR(m.nota,7) + STR(m.ordem,2)
	IF FOUND()
   		=edithand('REGRAVA')
	ELSE
   		=edithand('SAVE')
	ENDIF
   	=W_DEFPROC("moviment.spr")
	=MVatu_cmd(itemmov.empresa,;
				itemmov.codigo,;
				itemmov.classifica,;
				itemmov.data,;
				itemmov.hora,;
				itemmov.tipo,;
				itemmov.nota,;
				itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e
	*----------------------------------------------------------*
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQP           NEDef_CFO VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:    8  
*        Variable:            NEDef_CFO                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      28                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyqp     &&  NEDef_CFO VALID
#REGION 2
RETURN

FUNCTION NEDef_CFO
	PARAMETER LStipo,LNTp_Mercad,LScfo
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Identificar o CFO Adequado a
	*               Conforme o Tipo de Mercadoria
	*------------------------------------------------------------*
	* COMENTARIO..:
    *   Com as Mudan豫s nas Formas de Tributa豫o Foram Criadas Situa寤es em
    * que o CFO passou a Ser Definido em Fun豫o da OPERA플O COMERCIAL e DA
    * NATUREZA FISCAL DA MERCADORIA (Substitu豫o ou Tributada) e
    * Considerando  Aspectos  em Que Os Itens de Um Orcamento Mesclam
    * Mercadorias TRIBUTADAS e COM SUBSTITUI플O . Deveramos :
    *
    *         1-    Emitir uma Nota para Cada Grupo de Itens Com Mesmo CFO
    *         OU
    *          2-   Emitir Uma Nota Idependente do Grupo de CFO Porm
    *    Legendando Cada Item Para Permitir a Identifica豫o do CFO Adequado
    *
	*       Optou-se Pela 2a Auternativa
	*			
	*			
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*			LStipo.....: Tipo Associado a Opera눯o Comercial
	*			LNTp_Mercad: Tipo de Mercadoria
	*				
	*------------------------------------------------------------*
	*  RETORNO.....:
	*			LSCFO....: CFO Definido
	*------------------------------------------------------------*
	* EXEMPLO :
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
    PRIVATE ARQ_Tipooper ,ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Tipooper     = NetArqAgain("Tipooper")
    ALS_Tipooper     = Alias()

	*--------------------------------------------------------
	*--------------------------------------------------------
	
	SELE &ALS_Tipooper
	SET ORDER TO TAG tipo
	SEEK "E"+LStipo
	IF !FOUND()
   	    SEEK "e"+LStipo
		IF !FOUND()
		   	=up_fecha("&ALS_Tipooper")
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(.f.)
		ENDIF
	ENDIF

	*------------------------------------------------------*
    LScfo = &ALS_Tipooper .cfo					&& CFO DEFAULT
	*------------------------------------------------------*

	IF LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
	   LScfo = &ALS_Tipooper .cfosubs
	ENDIF		
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYQQ           NEClcDiretoCusto VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:    9  
*        Variable:            NEClcDiretoCusto                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      29                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyqq     &&  NEClcDiretoCusto VALID
#REGION 2
RETURN

FUNCTION NEClcDiretoCusto
	PARAMETERS LNemp,LScod, LNvlrMercadoria
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor Unitario de um item de
	*             NFE itegrando ao valor da mercadoria o :
	*					IPI
	*					RETIDO
	*					CUSTO_IND
	*			  O ICMS ja esta embutido no valor da mercadoria
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LNvlrMercadoria........: Valor da Mercadoria
	*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNvlrdesembolso.: Custo Total Considerando os Tributos
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal

	PRIVATE LNipi, LNicms

	PRIVATE LNbaseicms,LNicms,LNretido
	PRIVATE LNvlrdesembolso
	PRIVATE LNaliq_icms


	LNipi		=	0	
	LNicms		=	0



	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_grfiscal+ARQ_grfiscal) > 100000 ;
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	
	SELE &ALS_grupo
	SET ORDER TO TAG codigo

	SEEK LScod
	if not found()
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	endif

	SELE &ALS_grfiscal
	SET ORDER TO TAG tributacao
	SEEK &ALS_empresa .estado+LEFT( &ALS_grupo .classifica,5)

	LNaliq_icms		= 	7	&& % ver possibilidade de pasar em parametro
							&& A aliq_icms esta fixa em 7% porque
							&& os fornecedores sao de Sao Paulo
							&& mas deve ser feito um modelo que
							&& atenda a essa necessidade
							
	LNvlrdesembolso	=	LNvlrMercadoria
	LNaliq_ipi		=	&ALS_grupo .aliq_ipi

	LNiva			=	&ALS_grfiscal .iva
	LNtpmercad		=	&ALS_grfiscal .tp_mercad

	*************************************************************


	LNbaseicms = LNvlrMercadoria

	LNicms	   = (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	LNipi	   = (LNbaseicms * LNaliq_ipi)/100

	LNretido   = 0

	IF LNtpmercad = 2 AND LNiva > 0
		LNretido   = (LNbaseicms + LNipi) * LNiva * 0.17 - LNicms
	ENDIF


	*----------------------------------------------------------*

	LNvlrdesembolso  = LNvlrMercadoria + LNretido + LNipi

	*----------------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNvlrdesembolso)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYRQ           ant0613NEClcICMS VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   10  
*        Variable:            ant0613NEClcICMS                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      30                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyrq     &&  ant0613NEClcICMS VALID
#REGION 2
RETURN

FUNCTION ant0613NEClcICMS
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria, ;
		PrmPrdtOrigem

	
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal


	PRIVATE LNbaseicms,LNicms
	PRIVATE LNaliq_icms

	PRIVATE LNUFOrigem
	PRIVATE LNUFDestino


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()


    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_grfiscal+ARQ_grfiscal) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	LNUFOrigem	 = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	LNUFDestino  = NEGetUFDestino(LNemp,LNboletim,LNforn)

	IF LNUFOrigem = LNUFDestino
		=W_DEFPROC("TRIBUTAR.SPR")
		LNaliq_icms  = TRAlqIcmInUF(LNUFOrigem)
	ELSE
		=W_DEFPROC("TRIBUTAR.SPR")
		LNaliq_icms  = TRAlqIcmOuUF(LNUFOrigem,PrmPrdtOrigem)
	ENDIF


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	LNicms		=	0


*--------------------------------------------------------*
*   REGRA SUBSTITUIDA EM 29/11/2011
*--------------------------------------------------------*
*	if &ALS_notaent .vlr_icms	> 0
*-------------------------------------------------------*
*	IF &ALS_notaent .icms_subs = 0
*-------------------------------------------------------*

	IF     &ALS_notaent .vlr_icms > 0 ;
	    OR &ALS_notaent .base_icms > 0 ;
	    OR &ALS_notaent .icms_subs > 0



		LNbaseicms    = LNvlrMercadoria

		*-------------------------------------------------------------*
		*  A base de ICMS e reduzida em 4.90% quando o fornecedor for
		* firestone em funcao da mudanca na cobranca de PIS e COFINS
		* que passaram a ser retidos.
		*-------------------------------------------------------------*

		*-------------------------------------------------------------*
		* "02/07/ " cst com reducao da base de calculo
		*--------------------------------------------------------------*
		
		
		
		if &ALS_notaent .reduc_icms > 0
			LNbaseicms  = LNvlrMercadoria * &ALS_notaent .reduc_icms
		ELSE
			if &ALS_notaent .codforn = 1
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.049
			endif

			if &ALS_notaent .codforn = 2
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.0519
			endif


		ENDIF

		LNicms	= (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	ENDIF

***	LNicms	= ROUND(LNicms,2)
	

	
	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNicms)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYRS           ant0613NEIcmsOper VALID            
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   11  
*        Variable:            ant0613NEIcmsOper                  
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      31                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyrs     &&  ant0613NEIcmsOper VALID
#REGION 2
RETURN

FUNCTION ant0613NEIcmsOper
	PARAMETERS LNemp,LNboletim,LNforn, LScod, ;
	     LNvlrMercadoria, PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal


	PRIVATE LNbaseicms,LNicms
	PRIVATE LNaliq_icms

	PRIVATE LNUFOrigem
	PRIVATE LNUFDestino


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()


    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_grfiscal+ARQ_grfiscal) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF







	LNUFOrigem	 = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	LNUFDestino  = NEGetUFDestino(LNemp,LNboletim,LNforn)

	IF LNUFOrigem = LNUFDestino
		=W_DEFPROC("TRIBUTAR.SPR")
		LNaliq_icms  = TRAlqIcmInUF(LNUFOrigem)
	ELSE
		=W_DEFPROC("TRIBUTAR.SPR")
		LNaliq_icms  = TRAlqIcmOuUF(LNUFOrigem , PrmPrdtOrigem)
	ENDIF



	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	LNicms		=	0

*--------------------------------------------------------*
*   REGRA SUBSTITUIDA EM 29/11/2011
*--------------------------------------------------------*
*	if &ALS_notaent .icmssoper	> 0
*-------------------------------------------------------*
	IF  &ALS_notaent .icms_subs > 0



		LNbaseicms    = LNvlrMercadoria


		*-------------------------------------------------------------*
		*  A base de ICMS e reduzida em 4.90% quando o fornecedor for
		* firestone em funcao da mudanca na cobranca de PIS e COFINS
		* que passaram a ser retidos.
		*-------------------------------------------------------------*
		
		if &ALS_notaent .reduc_icms > 0
			LNbaseicms  = LNvlrMercadoria * &ALS_notaent .reduc_icms
		ELSE
			if &ALS_notaent .codforn = 1
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.049
			endif

			if &ALS_notaent .codforn = 2
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.0519
			endif

		ENDIF

		LNicms	= (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	ENDIF
	
**	LNicms	= ROUND(LNicms,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNicms)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYRV           ant0613NEBsBrRetido VALID          
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   12  
*        Variable:            ant0613NEBsBrRetido                
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      32                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyrv     &&  ant0613NEBsBrRetido VALID
#REGION 2
RETURN

FUNCTION ant0613NEBsBrRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria,;
	 LNipi,Notaite_PK, PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Bruta ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite

	PRIVATE LNicms
	PRIVATE LSufOrigem, LSufDestino

	PRIVATE LNBsBrRetido

	LNBsBrRetido = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()


	IF (ARQ_empresa+ARQ_notaen+ ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	SELE &ALS_notaite
	GO Notaite_PK


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)



    *----------------------------------------------------------*
    * NAO ATUALIZAR O IVA SE O IVA FOR INFORMADO OU SE A ENTRADA
    * JA ESTIVER PROCESSADA
    *----------------------------------------------------------*
	IF (           &ALS_notaent .informaiva  = "S" ;
	      OR LEFT( &ALS_notaent .situacao,1) = "C" ;
	   ) ;
	   OR ;
	   (  DATE() - &ALS_notaent .data > 10 AND &ALS_notaite .IVA > 0)
		LNiva= 	&ALS_notaite .IVA
	ELSE

		=W_DEFPROC("TRIBUTAR.spr")
		LNiva= TRGet_IVA( LSufOrigem  ,LScod, LSufDestino, ;
		         &ALS_notaent .data , PrmPrdtOrigem)
	ENDIF
	*************************************************************


	LNBsBrRetido   = 0
	

	IF &ALS_notaent .icms_subs	> 0

		*-------------------------------------------------------------*
*****   IF (LNtpmercad = 2 or LNtpmercad = 8) AND LNiva > 0

        IF &ALS_notaite .CST $ "1/2/7"
			DO CASE

		  		CASE LNtpmercad = 8  && REDUTOR NAAAO AFETA BASE DO RETIDO
					LNBsBrRetido  = (LNvlrMercadoria + LNipi)

		  		CASE LSufOrigem =  LSufDestino
		  		                    && REDUTOR NAAAO AFETA BASE DO RETIDO
					LNBsBrRetido  = (LNvlrMercadoria + LNipi)

                *------------------------------------------*
                * REGRA REVIZADA COM OLIVEIRA EM 25/11/2011
                * PARA ACERTA TRIBUTACAO NOTA 7605 DE 13/10/2010
                * FORNECEDOR LEXUS IMPORTACAO
                *------------------------------------------*
				CASE &ALS_notaent .reduc_icms > 0
						LNBsBrRetido  = (LNvlrMercadoria  ;
				                * &ALS_notaent .reduc_icms) +  LNipi
				

               *------------------------------------------*
               * REGRA SUBSTITUIDA PELA REGRA ACIMA
               *------------------------------------------*
			   *CASE &ALS_notaent .reduc_icms > 0
			   *			LNBsBrRetido  = (LNvlrMercadoria + LNipi) ;
			   *	                * &ALS_notaent .reduc_icms
               *------------------------------------------------

				CASE &ALS_notaent .reduc_icms = 0
					if &ALS_notaent .data >= {01.11.2006}
						DO CASE
							CASE &ALS_notaent .codforn = 1
								LNBsBrRetido    = ;
								(LNvlrMercadoria + LNipi)-;
									(LNvlrMercadoria)*0.049

							CASE &ALS_notaent .codforn = 2
								LNBsBrRetido    = ;
								(LNvlrMercadoria + LNipi)-;
									(LNvlrMercadoria)*0.0519


							OTHERWISE
								LNBsBrRetido   = (LNvlrMercadoria + LNipi)
							
						ENDCASE

					ELSE


						DO CASE
							CASE  &ALS_notaent .codforn = 1
								LNBsBrRetido    = ;
									(LNvlrMercadoria + LNipi)-;
									(LNvlrMercadoria + LNipi)*0.049
									
							CASE  &ALS_notaent .codforn = 2
								LNBsBrRetido    = ;
									(LNvlrMercadoria + LNipi)-;
								    ((LNvlrMercadoria + LNipi)*0.0519)
									
							OTHERWISE
								LNBsBrRetido   = (LNvlrMercadoria + LNipi)
						ENDCASE
					ENDIF
			ENDCASE

		ENDIF
	ENDIF

	LNBsBrRetido = LNBsBrRetido
	
	*----------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsBrRetido)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYRX           NEBsRetido VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   13  
*        Variable:            NEBsRetido                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      33                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyrx     &&  NEBsRetido VALID
#REGION 2
RETURN

FUNCTION NEBsRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, ;
	           LNBsBrRetido,Notaite_PK,;
	           PrmPrdtOrigem
	
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Normal ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite
	

	PRIVATE LNipi, LNicms

	PRIVATE LNBsRetido

	PRIVATE LSufOrigem, LSufDestino

	LNBsRetido  = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()



	IF (ARQ_empresa+ARQ_notaent+ ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")

		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaite
	GO Notaite_PK


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)


	LNiva= 	&ALS_notaite .IVA



	*************************************************************


	IF &ALS_notaent .icms_subs	> 0

        IF &ALS_notaite .CST $ "1/2/7"

			LNBsRetido   = (LNBsBrRetido) * LNiva

		ENDIF
	ENDIF



	*----------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsRetido)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYS0           NEClcRetido VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   14  
*        Variable:            NEClcRetido                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      34                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsys0     &&  NEClcRetido VALID
#REGION 2
RETURN

FUNCTION NEClcRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNicms, LNbaseRetido,;
	        LNicmssoper,Notaite_PK,PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite
	


	PRIVATE LNretido
	PRIVATE LNaliq_icms

	PRIVATE LSufOrigem, LSufDestino

	LSalias			= ALIAS()


    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()



	IF (ARQ_empresa+ARQ_notaent +ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
	
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaite
	GO Notaite_PK

	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	*************************************************************



	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)

	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)


	LNiva= 	&ALS_notaite .IVA


	LNretido   = 0
	
	IF &ALS_notaent .icms_subs	> 0

        IF &ALS_notaite .CST $ "1/2/7"


			LNretido   = LNbaseRetido * 0.17
			LNretido   = LNretido - LNicms     && - LNicmssoper

		ENDIF
	ENDIF
	*----------------------------------------------------------*

	LNRetido = ROUND(LNRetido,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNretido)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYS2           NEBsEntBrRetido VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   15  
*        Variable:            NEBsEntBrRetido                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      35                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsys2     &&  NEBsEntBrRetido VALID
#REGION 2
RETURN

FUNCTION NEBsEntBrRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria, LNipi, ;
	             LNCustoIndireto,Notaite_PK, PrmPrdtOrigem

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Bruta ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite

	PRIVATE LNicms
	PRIVATE LSufOrigem, LSufDestino

	PRIVATE LNBsBrRetido

	LNBsBrRetido = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()


	IF (ARQ_empresa+ARQ_notaen+ ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaite
	GO Notaite_PK



	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp



	=W_DEFPROC("TRIBUTAR.spr")
	LNOriTpmercad	= TRDef_RgTrbMercad(  &ALS_notaent .uf  ,LScod)

	=W_DEFPROC("TRIBUTAR.spr")
	LNDstTpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)


	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)




    *----------------------------------------------------------*

    *----------------------------------------------------------*
    PRIVATE LNreducao
    LNreducao   = &ALS_notaite .alq_rdu
	LNiva       = 	&ALS_notaite .IVA
    *----------------------------------------------------------*


	*************************************************************


	LNBsBrRetido   = 0
	

	IF &ALS_notaent .icmsentsub	> 0

		*-------------------------------------------------------------*


		IF LNOriTpmercad <> 2 AND LNDstTpmercad = 2 AND LNiva > 0

			DO CASE
				


				CASE &ALS_notaent .reduc_icms > 0
						LNBsBrRetido  = (LNvlrMercadoria + LNipi) ;
			                *  LNreducao


				CASE &ALS_notaent .reduc_icms = 0

					if &ALS_notaent .data >= {01.11.2006}
						DO CASE
							CASE &ALS_notaent .codforn = 1
								LNBsBrRetido    = ;
									(LNvlrMercadoria + LNipi)-;
									((LNvlrMercadoria)*0.049)

							CASE &ALS_notaent .codforn = 2
								LNBsBrRetido    = ;
									(LNvlrMercadoria + LNipi)-;
									((LNvlrMercadoria)*0.0519)
						
							OTHERWISE
								LNBsBrRetido   = (LNvlrMercadoria + LNipi)
						ENDCASE

					ELSE
						if &ALS_notaent .codforn = 1
							LNBsBrRetido    = (LNvlrMercadoria + LNipi)-;
								((LNvlrMercadoria + LNipi)*0.049)
						ELSE	
							LNBsBrRetido   = (LNvlrMercadoria + LNipi)
						ENDIF
					ENDIF
			ENDCASE

			LNBsBrRetido = LNBsBrRetido + LNCustoIndireto

		ENDIF
	ENDIF

	
	
	*----------------------------------------------------------*

	LNBsBrRetido = LNBsBrRetido

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsBrRetido)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYS5           NEBsEntRetido VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   16  
*        Variable:            NEBsEntRetido                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      36                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsys5     &&  NEBsEntRetido VALID
#REGION 2
RETURN

FUNCTION NEBsEntRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNBsBrRetido,;
	   Notaite_PK, PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Normal ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite

	PRIVATE LNipi, LNicms

	PRIVATE LNBsRetido
	PRIVATE LSufOrigem, LSufDestino

	LNBsRetido  = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaite
	GO Notaite_PK



	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)


	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)


    *----------------------------------------------------------*
	LNiva= 	&ALS_notaite .IVA

	*************************************************************


	IF &ALS_notaent .icmsentsubs	> 0
		IF LNtpmercad = 2 AND LNiva > 0
			LNBsRetido   = (LNBsBrRetido) * LNiva
		ENDIF
	ENDIF


	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsRetido)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYS8           NEClcEntRetido VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   17  
*        Variable:            NEClcEntRetido                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      37                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsys8     &&  NEClcEntRetido VALID
#REGION 2
RETURN

FUNCTION NEClcEntRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNicms, LNbaseRetido,;
	   LNicmssoper,Notaite_PK, PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite

	PRIVATE LSufOrigem, LSufDestino


	PRIVATE LNretido
	PRIVATE LNaliq_icms


	LSalias			= ALIAS()


    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
	
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	SELE &ALS_notaite
	GO Notaite_PK

	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	*************************************************************


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)



	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)




	LNiva= 	&ALS_notaite .IVA


	
	LNretido   = 0
	
	IF &ALS_notaent .icmsentsubs	> 0
		IF LNtpmercad = 2 AND LNiva > 0


			LNretido   = LNbaseRetido * 0.17
			LNretido   = LNretido - LNicms     && - LNicmssoper


		ENDIF
	ENDIF
	*----------------------------------------------------------*

	LNRetido = ROUND(LNRetido,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNretido)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYS9           NEClcIndiretoCusto VALID           
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   18  
*        Variable:            NEClcIndiretoCusto                 
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      38                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsys9     &&  NEClcIndiretoCusto VALID
#REGION 2
RETURN

FUNCTION NEClcIndiretoCusto
PARAMETERS  NEdata_emi, ;
			NEtotproduto, NEvlr_ipi,;
			NEvlrFrete, NEvlrdespes, NEvlrseguro,;
			ITvlrMercad, ITvlripi


	*---------------------------------------------------------------*
	*  CALCULO DO CUSTO INDIRETO
	*---------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")

	

   	SET DECIMALS TO 6
	IF NEdata_emi < {01.09.1999} &&
   		TMP_totnf 	= 	NEtotproduto 	
   									&& NAO INCLUI O IPI =>
   									&& RATEIA COM O VALOR DA MERCADORIO
   									&& VLRVENDA
   		TMP_frete 	= 	STR(( NEvlrfrete;
   			    			+ NEvlrdespes ;
   			    			+ NEvlrseguro) / TMP_totnf,20,11)

   		TMP_frt   = SUBS(TMP_frete,1,LEN(TMP_frete)-8)
   		TMP_frete = VAL(CHRTRAN(TMP_FRT,",","."))

		*----->>>>>>>>   RATEIO   <<<<<<------*
   		TMP_rateio 	= STR((TMP_frete * ITvlrMercad),20,8) && ipi item
   		TMP_rt   	= SUBS(TMP_rateio,1,LEN(TMP_rateio)-6)
   		TMP_rateio  = VAL(CHRTRAN(TMP_RT,",","."))
	ELSE
   		TMP_rateio  = 	(	( ;
   									NEvlrfrete ;
   								+  	NEvlrdespes ;
   								+  	NEvlrseguro;
   							) ;
   							*     (ITvlrMercad+ITvlripi);
   						) ;
   						/;
			   		   (NEtotproduto + NEvlr_ipi)

	ENDIF
	if (NEtotproduto + NEvlr_ipi) = 0
		TMP_rateio = 0
	endif
	
	LNcstind  = TMP_rateio

  	SET DECIMALS TO 2

RETURN(LNcstind)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYSB           NECanc_Entrada VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   19  
*        Variable:            NECanc_Entrada                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      39                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsysb     &&  NECanc_Entrada VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NECanc_Entrada
PARAMETERS LNemp,LNboletim,LNforn
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: 	Cancelar Processo Entrada
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		.f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA
	*		SCGC210.spr
	*		SCGCF211.PRG
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	IF !REGLOCK()
	    WAIT WINDOW "Documento nao poder ser bloqueado para o processo."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*--------------------------------------------------------------*

	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)

	*---------------------------------------------------------------*
	* Verificacao do itens para liberar entrada
	*---------------------------------------------------------------*
	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)
		IF notaite.movestq = "S" AND (LEFT(notaite.situacao,1) $ "Cc")
		    IF !NElocaRegSld()
				LFretorno = .F.
				EXIT
			ENDIF
		ENDIF
		SELE notaite
		SKIP
	ENDDO
	SELE notaite
	IF !LFretorno   && OPERACAO ABORTADA
    	WAIT WINDOW " Os Itens estao irregulares. Tente Novamente.  <ENTER>"
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF			

	*---------------------------------------------------------------*

	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)

	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)
	    WAIT WINDOW "ITEM => "+STR(notaite.ordem,2) NOWAIT
		IF LEFT(notaite.situacao,1) $ "Cc"
   			SELECT notaite
			IF !ULCancEntrait()
				LFretorno = .F.
				EXIT
			ENDIF		
		ENDIF
		SELECT notaite
		SKIP
	ENDDO
	*----------------------------------------------------------*
	=W_DEFPROC("PEDIDO.SPR")
	=PDstat_pedd(notaent.empresa,notaent.pedido)
	*----------------------------------------------------------*
	SELE notaent
	IF LFretorno
		WAIT WINDOW " OK ! " NOWAIT
		SELECT notaent
		m.situacao  =   "B"+RIGHT(notaent.situacao,1)
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO situacao
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)

*-----------------------------------------------------------------*
*  Rotina de apoio para manipular o item atual da nota de entrada
*------------------------------------------------------------------*
FUNCTION ULCancEntrait
	PRIVATE LFretorno
	LFretorno = .t.
	*-------------------------------------------------------------*
   	IF notaite.movestq = "S"
	    IF NElocaRegSld()
    		SELECT notaite
			IF REGLOCK()
				IF !NEDesfatura()
					LFretorno = .F.
				ENDIF
			ELSE
				LFretorno = .F.
			ENDIF
		ELSE
			LFretorno = .F.
		ENDIF
		SELECT  notaite
	ELSE
   		SELECT notaite
		IF REGLOCK()
			m.situacao = 'B'+RIGHT(notaite.situacao,1)
			m.dtfat = wp_dtoper
			=edithand('REGRAVA')
		ELSE
			LFretorno = .F.
		ENDIF
	ENDIF
	*-------------------------------------------------------------*
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYSE           NEDesfatura VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   20  
*        Variable:            NEDesfatura                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      40                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyse     &&  NEDesfatura VALID
#REGION 2
return

*---------------------------------------------------------------*
FUNCTION NEDesfatura
	PRIVATE LFretorno
	LFretorno	=  .t.
	*----------------------------------------------------------*
    SELECT notaite
    SCATTER MEMVAR MEMO
    DO CASE
		CASE notaent.natu_oper = 1
		   m.operacao = 'ECC.'   && ENTRADA/COMPRA/CANCELADA
		CASE notaent.natu_oper = 2
		   m.operacao = 'ETC.'   && ENTRADA/TRANSF/CANCELADA
		CASE notaent.natu_oper = 3
		   m.operacao = 'ERC.'   && ENTRADA/REMESSA/CANCELADA
		CASE notaent.natu_oper = 4
		   m.operacao = 'EDC.'   && ENTRADA/DEVOLUCAO/CANCELADA
		CASE notaent.natu_oper = 5
		   m.operacao = 'EOC.'   && ENTRADA/OUTRAS OPER / CANCE
		CASE notaent.natu_oper = 6
		   m.operacao = 'SOC.'   && SAIDA/OUTRAS OPER / CANCE
    ENDCASE
    LNcstind  = 0
    SET DECIMALS TO 2
    m.situacao 	= 'B'+RIGHT(notaent.situacao,1)
    m.nota 		= notaent.nota
	
	
    m.dtfat 	   	=  notaent.data_emi
    IF notaent.pedido > 0 and LEFT(notaite.codigo,7) <> "9999999"
		*-----------------------------------------------------------*
		*    So tratar pedido nos diretorios LOJA ou CENTRAL ou
		* para datas com superiores a 2000
		*-----------------------------------------------------------*
		IF notaent.data >= {01.01.2000}
		  *----------------------------------------------------------*
		  =W_DEFPROC("PEDIDO.SPR")
		  IF !PDregistra_qte(notaent.empresa,notaent.pedido,notaite.codigo,;
							notaite.qtde,"CANC.ENTRADA")
			RETURN(.F.)
		   ENDIF
		   *----------------------------------------------------------*
	    ENDIF
    ENDIF
    SELECT notaite
	=edithand('REGRAVA')
    IF LEFT(codigo,7) = "9999999"   && NAO REG. EM SALD OU ITEM COMENTA.
	  RETURN
    ENDIF
    SELECT itemmov
    SET ORDER TO TAG movimento
	m.data = notaent.data
	m.hora = notaent.hora
	m.sld_estq = 0
	m.vlr_estq = 0
	m.custo_ind =  LNcstind
	SEEK STR(notaite.empresa,3)+notaite.codigo+;
			DTOS(notaent.data)+notaent.hora+notaent.tipo+;
			STR(notaent.nota,7)+STR(notaite.ordem,3)
	IF !FOUND()
		WAIT WINDOW "O registro de movimento no estoque nao foi encontrado"
		RETURN
	ELSE
	    SET ORDER TO TAG movimento
		=REGLOCK(.T.)
		REPLACE operacao WITH "****"   && faz o reg ser ignorado no saldo
									   && anulando seu efeito
		***********************************************************
		SELE itemmov
		LNregmov = RECNO()


	   	=W_DEFPROC("moviment.spr")
		=MVCancelMvto(itemmov.empresa,;
				itemmov.codigo,;
				itemmov.classifica,;
				itemmov.data,;
				itemmov.hora,;
				itemmov.tipo,;
				itemmov.nota,;
				itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e


		SELE itemmov
		GO LNregmov
	ENDIF
	*----------------------------------------------------------*
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYSF           antNEVerifCustoDistocido VALID     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   21  
*        Variable:            antNEVerifCustoDistocido           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      41                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsysf     &&  antNEVerifCustoDistocido VALID
#REGION 2
return

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Verificar distorcao entre custo atual
	*    registrado no sistema e custo que esta sendo informado
	*------------------------------------------------------------*
	* COMENTARIO..: A rotina permite detectar erros no lancamento
	*               como codigo e ou valores errados
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*

FUNCTION antNEVerifCustoDistocido
	PARAMETERS PrmEmpresa,PrmBoletim,PrmForn,PrmProduto,;
							 PrmVlrMercadoria, PrmVlrIPI,PrmQtde


	=W_DEFPROC("rotinas.spr")

	PRIVATE LNAtualCusto		&& Custo no estoque atual
	PRIVATE LDdtCusto
	PRIVATE LNCustoEntrada		&& Custo na entrada
	PRIVATE LSUfOrigem,	LSUfDestino
	PRIVATE	NEdata_emi, NEtotproduto, NEvlr_ipi, ;
				NEvlrFrete, NEvlrdespes, NEvlrseguro
	PRIVATE LNCusto_Ind
	PRIVATE LNDeltaCusto
	PRIVATE LNPercentual
	

	PRIVATE LSalias
    LSAlias      = Alias()

    ARQ_Notaent     = NetArqAgain("Notaent")
    ALS_Notaent     = Alias()
	


	*-----------------------------------------------------------*
	SELE &Als_notaent
	SET ORDER TO TAG boletim
	SEEK STR(PrmEmpresa,3)+STR(PrmBoletim,6)+STR(PrmForn,5)
	IF !FOUND()
		LSmsg = "Nao foi possivel verificar distorcao de custo . " +;
				"Doc. "+STR(PrmBoletim,6)+" Nao localizado. "
		=fox_alert(LSmsg,.t.)
	   	=up_fecha("&ALS_notaent")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF

	LDdtCusto 		= &Als_notaent .DATA
	NEdata_emi 		= &Als_notaent .DATA_EMI
	NEtotproduto	= &Als_notaent .TOTPRODUTO
	NEvlr_ipi		= &Als_notaent .VLR_IPI
	NEvlrFrete		= &Als_notaent .VLRFRETE
	NEvlrdespes		= &Als_notaent .VLRDESPES
	NEvlrseguro		= &Als_notaent .VLRSEGURO

	=W_DEFPROC("notaent.spr")
	LNCusto_Ind = NEClcIndiretoCusto( ;
			NEdata_emi, ;
			NEtotproduto, NEvlr_ipi,;
			NEvlrFrete, NEvlrdespes, NEvlrseguro,;
			PrmVlrMercadoria, PrmVlrIPI)


	
	
	=W_DEFPROC("notaent.spr")
	LSUfOrigem = NEGetUFOrigem(PrmEmpresa, PrmBoletim, PrmForn)

	=W_DEFPROC("notaent.spr")
	LSUfDestino = NEGetUFDestino(PrmEmpresa)



	*-----------------------------------------------------------*
	=W_DEFPROC("preco.spr")
	LNCustoEntrada = (PRCusto(PrmProduto,;
							LSufOrigem,;
							LSufDestino,;
							PrmVlrMercadoria,;
							PrmVlrIPI,;
							PrmForn,;
							LNCusto_Ind))/ PRMqtde
	=W_DEFPROC("estoque.spr")
	LNAtualCusto = EScustoMedio(PrmEmpresa,PrmProduto ,LDdtCusto)

	*--------------------------------------------------------------*
	LNDeltaCusto = abs(LNCustoEntrada - LNAtualCusto)
	LNPercentual = int((LNDeltaCusto/LNAtualCusto)*100)	

	IF LNPercentual > 10
		IF LNDeltaCusto	< 0
			LNPercentual = LNPercentual * -1
		ENDIF
		LSmsg = "Atencao : Variacao de Custo na Ordem de : "+;
				STR(LNPercentual,6)+" % "+chr(13)+;
				" Custo Registrado = "+STR(LNAtualCusto,10,2)+chr(13)+;
				" Custo Neste Doc  = "+STR(LNCustoEntrada,10,2)
				
		=fox_alert(LSmsg,.t.)
	ENDIF
	*--------------------------------------------------------------*
   	=up_fecha("&ALS_notaent")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYSI           NeAjustGru VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   22  
*        Variable:            NeAjustGru                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      42                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsysi     &&  NeAjustGru VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION NeAjustGru
  PARAMETERS A

	IF !USED("empresa")
		IF ! NetUse("empresa")
			WAIT WINDOW " ERRO !"
			RETURN
		ENDIF
	ENDIF

	IF !USED("notaent")
		IF ! NetUse("notaent")
			WAIT WINDOW " ERRO !"
			RETURN
		ENDIF
	ENDIF
	IF !USED("notaite")
		IF ! NetUse("notaite")
			WAIT WINDOW " ERRO !"
			RETURN
		ENDIF
	ENDIF

	IF !USED("itemmov")
		IF ! NetUse("itemmov")
			WAIT WINDOW " ERRO !"
			RETURN
		ENDIF
	ENDIF




	SELE notaent

*		=NEAjustNE(1,4272,1)
*		=NEAjustNE(1,1655,1)
*		=NEAjustNE(1,1675,1)
*		=NEAjustNE(1,1678,1)
*		=NEAjustNE(1,1686,1)
*		=NEAjustNE(1,929,1)
*		=NEAjustNE(1,947,1)
*		=NEAjustNE(1,3005,1)
*		=NEAjustNE(1,3022,1)
*		=NEAjustNE(1,3024,1)
*		=NEAjustNE(1,2924,1)
*		=NEAjustNE(1,8369,1)
*		=NEAjustNE(1,9735,1)
*		=NEAjustNE(1,10456,1)
*		=NEAjustNE(1,10463,1)
*		=NEAjustNE(1,12838,1)
*		=NEAjustNE(1,12850,1)
*		=NEAjustNE(1,12895,1)


    SELE notaent
    set order to tag dt_geral

	go bott
	set escape on
	

	DO WHILE !bof()
		SCATTER MEMVAR
		
		A = STR(EMPRESA,3)+" - " +DTOS(DATA)+ " - "+STR(NOTA,6)
		wait windows a nowait
				
		oreg_e = RECNO()
		=NEAjustNE(NOTAENT.EMPRESA, ;
		            NOTAENT.referencia,;
		              NOTAENT.codforn)
		SELE notaent
	    set order to tag dt_geral
		GO oreg_e
		SKIP -1
	ENDDO
	=UP_fecha("itemmov")
	=UP_fecha("notaent")
	=UP_fecha("notaite")
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYSK           NEAjustNE VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   23  
*        Variable:            NEAjustNE                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      43                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsysk     &&  NEAjustNE VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEAjustNE
PARAMETERS LNemp,LNboletim,LNforn
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Ajustar campos criados com novas implementa뉏es
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		.f. ou .t.
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA
	*		SCGC210.spr
	*		SCGCF211.PRG
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias		= 	ALIAS()
	LFretorno	=	.t.

	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*------------------------------------------------------------*
	SELE notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	IF !REGLOCK()
	    WAIT WINDOW "Documento nao poder ser bloqueado para o processo."
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*--------------------------------------------------------------*

	SELECT  notaite
	SET ORDER TO TAG orcamento
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)+;
		STR(notaent.nota,6)+notaent.serie+LEFT(notaent.tipo,1)

	*---------------------------------------------------------------*
	* Verificacao do itens para liberar entrada
	*---------------------------------------------------------------*
	DO WHILE !eof() AND LNemp			= EMPRESA ;
					AND LNboletim 		= orcamento ;
					AND LNforn 	 		= codforn ;
					AND notaent.nota 	= nota ;
					AND notaent.serie	= serie ;
					AND LEFT(notaent.tipo,1)  = LEFT(tipo,1)

		=NEAjustITe()
		SELE notaite
		SKIP
	ENDDO
	SELE notaent
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYSL           NEAjustITe VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   24  
*        Variable:            NEAjustITe                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      44                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsysl     &&  NEAjustITe VALID
#REGION 2
return

*---------------------------------------------------------------*
FUNCTION NEAjustITe
	PRIVATE vlr_icms, m.icms_subs
	
	PRIVATE LFretorno
	LFretorno	=  .t.
	*----------------------------------------------------------*
  	SELECT notaite
   	LNnota = m.nota     && EVITA APAGAR N. NOTA
   	SCATTER MEMVAR MEMO
   	DO CASE
		CASE m.natu_oper = 1
		   m.operacao = 'ECP.'   && ENTRADA/COMPRA/PROCESSADA
		CASE m.natu_oper = 2
		   m.operacao = 'ETP.'   && ENTRADA/TRANSFERENCIA/PROCESSADA
		CASE m.natu_oper = 3
		   m.operacao = 'ERP.'   && ENTRADA/REMESSA/PROCESSADA
		CASE m.natu_oper = 4
		   m.operacao = 'EDP.'   && ENTRADA/DEVOLUCAO/PROCESSADA
		CASE m.natu_oper = 5
		   m.operacao = 'EOP.'   && ENTRADA/OUTRAS OPER/PROCESSADA
		CASE m.natu_oper = 6
		   m.operacao = 'SOP.'   && SAIDA/OUTRAS OPER / PROCESSADA
   	ENDCASE

	*---------------------------------------------------------------*
	*  CALCULO DO CUSTO INDIRETO
	*---------------------------------------------------------------*
	
	LNcstind = NEClcIndiretoCusto( ;
					notaent.data_emi, ;
					notaent.totproduto, notaent.vlr_ipi, ;
					notaent.vlrFrete, notaent.vlrdespes, ;
					notaent.vlrseguro,;
					notaite.vlrvenda, notaite.vlripi)

	**********************************
   	m.nota 	   	=  notaent.nota
   	m.dtfat 	=  notaent.data_emi
   	m.custo_ind =  LNcstind


    IF m.origem = 1		&& importado
	     m.bsbr_icms  = m.vlrvenda + m.VLRIPI
	ELSE
	     m.bsbr_icms  = m.vlrvenda
	ENDIF

    IF notaent.reduc_icms > 0
       m.aliq_rdu = notaent.reduc_icms
    ENDIF



	if m.reduc_icms > 0
	   m.base_calc = m.bsbr_icms * m.reduc_icms

	else
	   IF notaent.codforn = 1 OR notaent.codforn = 1130
	      m.base_calc = m.bsbr_icms  - ;
			 				(m.bsbr_icms * (4.9/100))
		  m.aliq_rdu  = 4.9/100
	   ENDIF

	   IF notaent.codforn = 2
	      m.base_calc = m.bsbr_icms  - ;
			 				(m.bsbr_icms * (5.19/100))
		  m.aliq_rdu  = 5.19/100
	   ENDIF


	endif
	

	m.vlr_icms = NEClcICMS(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda)


	m.Base_sbbrt = NEBsBrRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,  ;
							notaite.vlripi)
							
	m.Base_subs = NEBsRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.Base_sbbrt)

	m.icms_subs = NEClcRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.vlr_icms,m.Base_subs)


**
   SELECT notaite
	=edithand('REGRAVA')

    SELECT itemmov
	m.data = notaent.data
	m.hora = notaent.hora
	m.sld_estq = 0
	m.vlr_estq = 0
	************************************************************
	*    - GARANTIA CONTRA DUPLICACAO							*
	************************************************************
	SET ORDER TO TAG movimento
	SEEK STR(m.empresa,3) + m.codigo + DTOS(m.data) + m.hora +;
			 		 + m.tipo + STR(m.nota,7) + STR(m.ordem,3)
	IF FOUND()
		=RLOCK()

		REPLACE bsbr_icms with m.bsbr_icms
		REPLACE aliq_rdu  with m.aliq_rdu
		REPLACE base_calc with m.base_calc
		REPLACE vlr_icms  with m.vlr_icms
		REPLACE base_subs with m.base_subs
		REPLACE base_sbbrt with m. base_sbbrt
		REPLACE icms_subs with m.icms_subs

	ENDIF
	*----------------------------------------------------------*
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYSO           antDIConvrtNEDocFiscal VALID       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   27  
*        Variable:            antDIConvrtNEDocFiscal             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      45                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyso     &&  antDIConvrtNEDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION antDIConvrtNEDocFiscal
PARAMETERS PrmEmpresa,PrmNota,PrmFornCod

	PRIVATE PrmAlsNE,PrmAlsIT

	*--------------------------------------------------*
	PRIVATE LNCod_Mod_Rf,LaliqOrg
	
	PRIVATE LOperacao

	PRIVATE LUFDstn

	PRIVATE LMunDstn

	PRIVATE LUFOrig
	PRIVATE LMunOrig
	PRIVATE LTab_Cst

	*--------------------------------------------------*


	=W_DEFPROC("NOTAENT.SPR")
	PrmAlsNE = NEGetAlias()

*------------------------------*
*	=W_DEFPROC("ITEMMOV.SPR")
*	PrmAlsIT = IMGetAlias()
*------------------------------*

	=W_DEFPROC("NOTAITE.SPR")
	PrmAlsIT = IEGetAlias()



	=W_DEFPROC("NOTAENT.SPR")
	IF !NELerRegistro(PrmEmpresa,PrmNota,PrmFornCod)
		WAIT WINDOW "NFs nao localizada  <ENTER> " NOWAIT
		RETURN(.F.)
	ENDIF



	=W_DEFPROC("TIPOOPER.SPR")
	LNCod_Mod_Rf  	= TPGetFieldValue("E",  &PrmAlsNE .tipo ,"Cod_Mod_Rf")


	LOperacao = "ENTRADA"

	=W_DEFPROC("EMPRESA.SPR")
	LTab_Cst  = EMGet_TabCst(  &PrmAlsNE .EMPRESA )

	=W_DEFPROC("EMPRESA.SPR")
	LUFDstn   = EMGet_UF(  &PrmAlsNE .EMPRESA )

	=W_DEFPROC("EMPRESA.SPR")
	LMunDstn  = EMGet_Municipio(  &PrmAlsNE .EMPRESA )

	LUFOrig  = &PrmAlsNE .UF
	LMunOrig = &PrmAlsNE .CIDADE


	=W_DEFPROC("TRIBUTAR.SPR")
	LaliqOrg = TRAlqIcmOuUF(LUFOrig)  && ALIQ. EXTERNA DA UF ORIGEM


	=W_DEFPROC("TRIBUTAR.SPR")
	LaliqDst = TRAlqIcmInUF(LUFDstn)  && ALIQ. Interna DA UF DESTINO

	*---------------------------------------------------*

	SELE &PrmAlsIT
	SET ORDER TO TAG ITEMNOTA
	SET NEAR ON
	SEEK STR( &PrmAlsNE .Empresa,3)+;
		LEFT( &PrmAlsNE .TIPO ,1)+;
		STR(  &PrmAlsNE .CODFORN ,5)+;
		STR(  &PrmAlsNE .NOTA ,6)
	SET NEAR OFF

		

	DO WHILE !EOF() ;
	        AND PrmEmpresa     = &PrmAlsIT .empresa;
	        AND &PrmAlsNE .favorecido = &PrmAlsIT .Favorecido;
	        AND PrmNota    	   = &PrmAlsIT .nota ;
	        AND &PrmAlsNE .TIPO = &PrmAlsIT .tipo



		IF  &PrmAlsIT .qtde = 0
			SKIP
			LOOP
		
		ENDIF

	
		=W_DEFPROC("NOTAENT.SPR")
		LNVlrICMS =  NEClcICMS( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , &PrmAlsIT .vlrvenda)

		=W_DEFPROC("NOTAENT.SPR")
		LNVlrICMSSO =  NEIcmsOper( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , &PrmAlsIT .vlrvenda)


		=W_DEFPROC("NOTAENT.SPR")
		LNBsBrRetido =  NEBsBrRetido( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , ;
		        &PrmAlsIT .vlrvenda,;
   		        &PrmAlsIT .vlripi)

		=W_DEFPROC("NOTAENT.SPR")
		LNBsRetido =  NEBsBrRetido( PrmEmpresa,PrmNota,PrmFornCod,;
		        &PrmAlsIT .codigo , ;
   		        LNBsBrRetido)

		=W_DEFPROC("NOTAENT.SPR")
		LNRetido =  NEClcRetido( PrmEmpresa,PrmNota,PrmFornCod,;
		        LNVlrICMS , ;
   		        LNBsRetido,;
   		        LNVlrICMSSO)


		
		IF  &PrmAlsNE .tp_pessoa = 1
			LFieldTmp = CHRTRAN(STR(  &PrmAlsNE .Favorecido,11)," ","0")
		ELSE
			LFieldTmp = CHRTRAN(STR(  &PrmAlsNE .Favorecido,14)," ","0")
		ENDIF

	    M.COD_IDFORN   =   LFieldTmp



	    M.EMPRESA   =  &PrmAlsIT .Empresa
	    M.TIPO   	=  &PrmAlsIT .tipo
	    M.NRO_DOC   =  &PrmAlsIT .nota
	    M.SERIE_DOC =  LEFT( &PrmAlsIT .Serie +"   ",3)

		IF EMPTY(m.serie_doc)
		    m.SERIE_DOC  =     LEFT( "01   ",3)
		endif


	    M.DT_DOC   	=  &PrmAlsNE .data_EMI
    	M.DT_ENTSAI =  &PrmAlsNE .Data

		*----------------------------------------------------*
		*  DADOS GERAIS DO ITEM NO REGISTRO
		*----------------------------------------------------*


	    M.MOD_DOC  	= LNCod_Mod_Rf
	    M.NRO_ITEM 	= &PrmAlsIT .Ordem
    	M.PRODCODIGO= &PrmAlsIT .Codigo
	    M.PRODDESCR = DFLimpaString( &PrmAlsIT .Descricao )
	    M.UNIDADE   = &PrmAlsIT .Unidade

		IF EMPTY(M.UNIDADE)
			M.UNIDADE = "UN"
		ENDIF

		IF EMPTY(M.UNIDADE)
			m.UNIDTRIBUT = "UN"
		ENDIF


    	M.PRECO_TAB    =    &PrmAlsIT .Preco
    	M.PRECOMAXTB   =    0
	    M.PRECOMINTB   =    0
	    M.PRECO_UNIT   =    &PrmAlsIT .Preco
	    M.QTDE   	   =    &PrmAlsIT .Qtde
	    M.VLR_DESCTO   =    0
	    M.PRC_DESCTO   =    0
    	M.VLRDESPFIN   =    0
	    M.VLRDESPOUT   =    0
    	M.VLR_FRETE    =    0
	    M.VLR_SEGURO   =    0
    	M.VLR_FINAL    =    &PrmAlsIT .VlrVenda +;
					    	&PrmAlsIT .vlripi+;
					    	&PrmAlsIT .ICMS_SUBS
    	
    	
    	
		IF &PrmAlsIT .MovEstq = "S"
		    M.IND_MOVEST   =     "SIM"
		ELSE
		    M.IND_MOVEST   =     "NAO"
		ENDIF
    	M.LT_QTITENS   =    0
	    M.LT_NRO   	   =    ""
    	M.LT_DT_FABR   =    {}
	    M.LT_VALIDAD   =    {}
	    M.CLSCOMNC     =    "00"
    	M.CLSGAS       =    "00"
	    M.CLSAGUA      =    "00"
    	M.CLSENRG      =    "00"


		*----------------------------------------------------*
		*  DADOS TRIBUTARIOS DO REGISTRO
		*----------------------------------------------------*
		
	    M.VLRATRIBUT   =     &PrmAlsIT .VlrVenda
    	M.CUSTONAOPE   =     0
	    M.CUSTOMEDAN   =     0

	*--------
	*    M.SALDO_ATU   =    &PrmAlsIT .Sld_estq
	*--------

	*--------
	*    IF  &PrmAlsIT .Sld_estq > 0
	*	    M.CUSTOMEDAT   =    ;
	*              &PrmAlsIT .Vlr_estq  /  &PrmAlsIT .Sld_estq
    *
	*	ELSE
	*	    M.CUSTOMEDAT   =    &PrmAlsIT .Vlr_estq
	*   ENDIF
	*--------
	    M.SALDO_ATU   =    0
	    M.CUSTOMEDAT   =    0

	*----------
    *	IF  &PrmAlsIT .MovEstq = "S"
	*	    IF  LEFT( &PrmAlsIT .Operacao,1) = "S"
	*		    M.SALDO_ANT   =    ;
	*	               &PrmAlsIT .Sld_estq +  &PrmAlsIT .Qtde
	*		ELSE
	*		    M.SALDO_ANT   =    ;
	*              &PrmAlsIT .Sld_estq -  &PrmAlsIT .Qtde
    *
	*		ENDIF
	*	ELSE
	*	    M.SALDO_ANT   =   &PrmAlsIT .Sld_estq
    *	ENDIF
	*----------

	    M.SALDO_ANT    =   0
	    M.CUSTOCONTB   =   0




		LTipo       = &PrmAlsIT .Tipo
		LProduto    = &PrmAlsIT .codigo
		LTp_mercad  = &PrmAlsIT .tp_mercad



*---------
*   	IF &PrmAlsIT .tp_mercad = 7   && SERVICO
*
*			LScfop =DICFOPS(LUFOrig, ;
*					          LMunOrig,;
*					          LUFDstn,;
*					          LMunDstn,;
*					          LTp_mercad,;
*					          LOperacao)
*		    M.CFOP   =   LScfop
*		ELSE
*--------

			=W_DEFPROC("TRIBUTAR.SPR")
			M.CFOP = TRCFO(&PrmAlsIT .Empresa, ;
		              &PrmAlsIT .Tipo,;
		              &PrmAlsIT .tp_mercad,;
		              "ENTRADA")
*--------
*		ENDIF



	    m.CFOP = ALLTRIM(CHRTRAN(m.CFOP,".",""))


		m.origemmrcd = chrtran(str( &PrmAlsIT .origem ,1)," ","0")



		LSCst = DICST_IPI(  &PrmAlsIT .VlrIPI, LOperacao)
    	M.CST_IPI   =   LSCst

	    IF &PrmAlsIT .tp_mercad = 7   && SERVICO
			LSCst = DICST_ISS(  &PrmAlsIT .VlrVenda, LOperacao)
		ELSE
			LSCst = DICST_ISS(  0, LOperacao)
		ENDIF
    	M.CST_ISS   =   LSCst

		LSCst = DICST_PIS(  0, LOperacao)
    	M.CST_PIS   =   LSCst

		LSCst = DICST_COFINS(  0, LOperacao)
    	M.CST_COFINS   =   LSCst

		LSCst = DICST_IR(  0, LOperacao)
    	M.CST_IR   =   LSCst


		*-------------   ICMS ----------------
*--------
*		LSCst = DICST_ICMS(LTab_cst,LTipo,Ltp_mercad,LProduto)
*  		M.CST_ICMS   =   LSCst
*--------

	    M.ALQICMORIG   =   LaliqOrg
	    M.ALQICMDEST   =   LaliqDst

*"CLG/CLH/CFG/CFH/CFM/CID/CLC/CLD/CFC/CFD/CIB/CLE/CLF/CFS/CFE/"
*"CFF/CIC/CLJ/CFL/ASC/CEE/ASI/CFJ/CFK/TAB/TBB/TAC/TBC/TAD/TBD/"
*"RBV/RBU/RBF/RBH/RBJ/RBM/RBN/RBG/RBI/RBL/RBO/RAC/RBC/RIB/RAA/"
*"RBR/RAE/RBE/RID/RBP/RBQ/RCA/RDA/DAF/DBF/DAC/DBC/DBD/DAE/DBE/"
*"DAG/DBG/"


		DO CASE
			CASE;
			 &PrmAlsNE .tipo $ ;
 			 "CLG/CLH/CFG/CFH/CFM/CID/CLC/CLD/CFC/CFD/CIB/CLE/CLF/CFS/CFE/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "CFF/CIC/CLJ/CFL/ASC/CEE/ASI/CFJ/CFK/TAB/TBB/TAC/TBC/TAD/TBD/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "RBV/RBU/RBF/RBH/RBJ/RBM/RBN/RBG/RBI/RBL/RBO/RAC/RBC/RIB/RAA/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "RBR/RAE/RBE/RID/RBP/RBQ/RCA/RDA/DAF/DBF/DAC/DBC/DBD/DAE/DBE/";
 			 OR ;
			 &PrmAlsNE .tipo $ ;
 			 "DAG/DBG/"
	   		    M.CST_ICMS     =   m.origemmrcd+"90"

		   		M.BC_ICMS         = &PrmAlsIT .base_calc

			    IF &PrmAlsIT .BsBr_Icms >= &PrmAlsIT .base_calc  	
  			      M.BCBRUTAICM    =   &PrmAlsIT .BsBr_Icms
			    ELSE
  		    	  M.BCBRUTAICM    =   &PrmAlsIT .base_calc
		   		ENDIF
      	   		M.VLR_ICMS   	  =   &PrmAlsIT .Vlr_Icms

			    M.BCBRTRTD_S   =   0
			    M.BC_RTD_S     =   0
		    	M.ALQICMRTDS   =   0
		    	M.ICM_RTD_S    =    0


			CASE    LNBsRetido = 0 ;
				AND &PrmAlsIT .vlr_icms = 0 ;
				AND &PrmAlsIT .tp_mercad = 2


	   		    M.CST_ICMS     =   m.origemmrcd+"60"
			    M.BCBRUTAICM   =   0
    			M.IND_REDUCA   =   0
		    	M.BC_ICMS      =   0
    	  		M.VLR_ICMS     =   0

			    M.BCBRTRTD_S   =   &PrmAlsIT .Base_sbbrt
			    M.BC_RTD_S     =   LNBsRetido
		    	M.ALQICMRTDS   =   &PrmAlsIT .Aliq_Icms
		    	M.ICM_RTD_S    =   &PrmAlsIT .ICMS_Subs


			*--------------------------
			*CASE    &PrmAlsIT .BASE_SUBS > 0 ;
			*	AND (&PrmAlsIT .icmssoper > 0 OR &PrmAlsIT .vlr_icms > 0)
			*--------------------------

			CASE    LNBsRetido > 0 ;
				AND (LNVlrICMSSO > 0 ;
				     OR &PrmAlsIT .vlr_icms > 0)

				IF &PrmAlsIT .vlr_icms = 0
			   		M.BC_ICMS    =   &PrmAlsIT .baseicmso
	      	   		M.VLR_ICMS   =   LNVlrICMSSO
				ELSE
			   		M.BC_ICMS    =   &PrmAlsIT .base_calc
	      	   		M.VLR_ICMS   =   &PrmAlsIT .Vlr_Icms
				ENDIF


	   		    M.CST_ICMS        =   m.origemmrcd+"10"

			    IF &PrmAlsIT .BsBr_Icms >= &PrmAlsIT .base_calc  	
  			      M.BCBRUTAICM   =   &PrmAlsIT .BsBr_Icms
			    ELSE
  		    	  M.BCBRUTAICM   =   &PrmAlsIT .base_calc
		   		ENDIF


			    M.BCBRTRTD_S   =   &PrmAlsIT .Base_sbbrt
			    M.BC_RTD_S     =   &PrmAlsIT .Base_subs
		    	M.ALQICMRTDS   =   &PrmAlsIT .Aliq_Icms
		    	M.ICM_RTD_S    =   &PrmAlsIT .ICMS_Subs


    	  	OTHERWISE
	  		    M.CST_ICMS        = m.origemmrcd+ &PrmAlsIT .cst + "0"
		   		M.BC_ICMS         =   &PrmAlsIT .base_calc

			    IF &PrmAlsIT .BsBr_Icms >= &PrmAlsIT .base_calc  	
  			      M.BCBRUTAICM   =   &PrmAlsIT .BsBr_Icms
			    ELSE
  		    	  M.BCBRUTAICM   =   &PrmAlsIT .base_calc
		   		ENDIF
      	   		M.VLR_ICMS   =   &PrmAlsIT .Vlr_Icms

			    M.BCBRTRTD_S   =   0
			    M.BC_RTD_S     =   0
		    	M.ALQICMRTDS   =   0
		    	M.ICM_RTD_S   =    0

      	ENDCASE

		M.IVA          =   &PrmAlsIT .Iva
		
		DO CASE
			CASE SUBS(M.CST_ICMS,2,2) $ "30/40/41/50/60"
			    M.ALIQ_ICMS    =   0
		    	M.BC_ICMS      =   0
    	  		M.VLR_ICMS     =   0
			OTHERWISE			
			    M.ALIQ_ICMS  =   &PrmAlsIT .Aliq_Icms
		ENDCASE




		Laliq  = ABS(LaliqOrg - LaliqDst)
    	M.DIF_ALIQ   =   Laliq



		=W_DEFPROC("TRIBUTAR.SPR")
		LRgmTrb = TRDef_RgTrbMercad(LUFOrig,;
		                           &PrmAlsIT .Codigo,;
						 'RETORNAR STRING' )

	    M.RGTRIBORIG   =   LRgmTrb

		=W_DEFPROC("TRIBUTAR.SPR")
		LRgmTrb = TRDef_RgTrbMercad(LUFDstn,;
					  &PrmAlsIT .Codigo,;
						 'RETORNAR STRING' )

	    m.RGTRIBDEST   =   LRgmTrb

	  	IF &PrmAlsNE .BASE_ISENT = 0
		    M.BASE_ISENT   =   0
		ELSE
		    M.BASE_ISENT   =   ;
		    				M.VLR_FINAL ;
						    - ( &PrmAlsIT .vlripi;
					    	+   &PrmAlsIT .ICMS_SUBS)
		ENDIF
		
		
	  	IF &PrmAlsNE .BASE_OUTR = 0
	    	M.BASE_OUTR    =   0
	    ELSE
		    M.BASE_OUTR   =   &PrmAlsIT .base_outr
	    ENDIF



	    M.BCBRTRTD_E   =   0
    	M.BC_RTD_E   =   0
	    M.ICM_RTD_E   =   0

	    M.INDAPURIPI   =   "1"


		IF m.origemmrcd = "1"   && IMPORTADA
		    M.BC_IPI    =   &PrmAlsIT .vlrvenda
	    	M.ALIQ_IPI  =   &PrmAlsIT .aliq_ipi
		    M.VLR_IPI   =   &PrmAlsIT .vlripi
		ELSE
		    M.BC_IPI    =   0
	    	M.ALIQ_IPI  =   0
		    M.VLR_IPI   =   0
		ENDIF		
		




	    M.BC_ISS   =   &PrmAlsIT .base_iss
	    M.ALIQ_ISS   =   &PrmAlsIT .aliq_iss
    	M.VLR_ISS   =   &PrmAlsIT .vlr_iss

	*---------
	*    IF &PrmAlsIT .vlr_issrtd > 0
	*    	M.BC_ISS_RTD   =   &PrmAlsIT .base_iss
	*	    M.ALIQ_ISSRT   =   &PrmAlsIT .aliq_iss
	*	    M.VLR_ISSRTD   =   &PrmAlsIT .vlr_issrtd
	*	ELSE
	*   	M.BC_ISS_RTD   =   0
	*	    M.ALIQ_ISSRT   =   0
	*	    M.VLR_ISSRTD   =   0
	*	ENDIF
    *--------------
    	M.BC_ISS_RTD   =   0
	    M.ALIQ_ISSRT   =   0
	    M.VLR_ISSRTD   =   0

	    M.BC_PIS   	 =   0
    	M.ALIQ_PIS   =   0
	    M.QTDBASEPIS =   0
    	M.VLR_PIS    =   0
	    M.PIS_RTD    =   0
    	M.BC_COFINS  =   0
	    M.ALIQCOFINS =   0
    	M.QTDBASECOF =   0
	    M.VLR_COFINS =   0
    	M.COFINS_RTD =   0
    	M.VLRALQCFRT =   0
	    M.BC_IR   	 =   0
	    M.ALIQ_IR    =   0
	    M.VLR_IR     =   0
    	M.IR_RTD     =   0
	    M.BC_CSLL    =   0
    	M.ALIQ_CSLL  =   0
	    M.VLR_CSLL   =   0
    	M.ADNTA_CSLL =   0
	    M.LANC_AUTO  =   "SIM"

***		=DISalvarRegistro()


		LEmpresa    = m.Empresa
		LMod_Doc    = m.Mod_Doc
		LCod_IdForn = m.Cod_IdForn
		LNro_Doc    = m.Nro_Doc
		LSerie_Doc  = m.Serie_Doc
		LNro_Item   = m.Nro_Item


		SELE &PBDocFisItAlias
		SET ORDER TO TAG ITEM
		SEEK STR(Lempresa,3)+Lmod_Doc+LCod_IdForn+;
	      STR(LNro_Doc,7)+LSerie_Doc+STR(LNro_Item,5)
	
		IF !found()
			APPEND BLANK
		ENDIF
		=RLOCK()
		GATHER MEMVAR
		UNLOCK

		SELE &PrmAlsIT
		SKIP
	ENDDO
	*---------------------------------------------------*
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYSX           xxNEBCIcmsOper VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   28  
*        Variable:            xxNEBCIcmsOper                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      46                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsysx     &&  xxNEBCIcmsOper VALID
#REGION 2
RETURN

FUNCTION xxNEBCIcmsOper
	PARAMETERS LNemp,LNboletim,LNforn, LScod, ;
	      LNvlrMercadoria, PrmPrdtOrigem




	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal


	PRIVATE LNbaseicms,LNicms
	PRIVATE LNaliq_icms



	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()


    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_grfiscal+ARQ_grfiscal) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	LNicms		=	0
	LNbaseicms  = 0

*--------------------------------------------------------*
*   REGRA SUBSTITUIDA EM 29/11/2011
*--------------------------------------------------------*
*	if &ALS_notaent .icmssoper	> 0
*-------------------------------------------------------*




	IF  &ALS_notaent .icms_subs > 0

*************	LNaliq_icms	  = &ALS_notaent .aliq_icms

	    LNUFOrigem	 = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	    LNUFDestino  = NEGetUFDestino(LNemp,LNboletim,LNforn)

	   IF LNUFOrigem = LNUFDestino
		  =W_DEFPROC("TRIBUTAR.SPR")
		  LNaliq_icms  = TRAlqIcmInUF(LNUFOrigem)
	   ELSE
		  =W_DEFPROC("TRIBUTAR.SPR")
		  LNaliq_icms  = TRAlqIcmOuUF(LNUFOrigem,PrmPrdtOrigem)
	   ENDIF


		LNbaseicms    = LNvlrMercadoria

                             ** retirado ==> + &ALS_notaent .vlrfrete


		*-------------------------------------------------------------*
		*  A base de ICMS e reduzida em 4.90% quando o fornecedor for
		* firestone em funcao da mudanca na cobranca de PIS e COFINS
		* que passaram a ser retidos.
		*-------------------------------------------------------------*
		

		if &ALS_notaent .reduc_icms > 0
			LNbaseicms  = LNvlrMercadoria * &ALS_notaent .reduc_icms
		ELSE
			if &ALS_notaent .codforn = 1
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.049
			endif

			if &ALS_notaent .codforn = 2
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.0519
			endif

		ENDIF

		LNicms	= (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	ENDIF
	
	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNbaseicms)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYSY           NEGeraXML_NOTA VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   29  
*        Variable:            NEGeraXML_NOTA                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      47                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsysy     &&  NEGeraXML_NOTA VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGeraXML_NOTA
PARAMETERS PrmEmpresa,PrmBoletim,PrmForn


PRIVATE ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc


STORE 0 TO  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc



	=W_DEFPROC("NOTAENT.SPR")
	=NEDefIDNFDocFiscal(PrmEmpresa,PrmBoletim,PrmForn,;
						PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						RtnSerie_Doc)

	*---------------------------------------------------

	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFGerXMLDocFiscal(PrmEmpresa,RtnMod_Doc,RtnCOD_IDFORN,;
		  RtnNro_Doc,RtnSerie_Doc )

	  	WAIT WINDOW "Nao foi possivel gerar XML EFD/NFe. <ENTER>"
		RETURN(.f.)
	ENDIF


RETURN(.T.)

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYSZ           NEEnviaNfe_NOTA VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   30  
*        Variable:            NEEnviaNfe_NOTA                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      48                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsysz     &&  NEEnviaNfe_NOTA VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEEnviaNfe_NOTA
PARAMETERS PrmEmpresa,PrmBoletim,PrmForn


PRIVATE ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc


STORE 0 TO  ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc

	=W_DEFPROC("NOTAENT.SPR")
	=NEDefIDNFDocFiscal(PrmEmpresa,PrmBoletim,PrmForn,;
						PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						RtnSerie_Doc)

	*---------------------------------------------------

	=W_DEFPROC("DOCFISCA.SPR")
	IF !DFGerXMLDocFiscal(PrmEmpresa,RtnMod_Doc,RtnCOD_IDFORN,;
		  RtnNro_Doc,RtnSerie_Doc )

	  	WAIT WINDOW "Nao foi possivel gerar XML EFD/NFe. <ENTER>"
		RETURN(.f.)
	ENDIF



	=W_DEFPROC("DOCFISCA.SPR")
	IF !(DFNeEnvNFeXML(PrmEmpresa,RtnMod_Doc,RtnNro_Doc))
	  	WAIT WINDOW "Nao foi possivel copiar XML para NFe. <ENTER>"
		RETURN(.f.)
	ENDIF


RETURN(.t.)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYT0           NERtrnoNfe_NOTA VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   31  
*        Variable:            NERtrnoNfe_NOTA                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      49                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyt0     &&  NERtrnoNfe_NOTA VALID
#REGION 2
return
*---------------------------------------------------------------*


FUNCTION NERtrnoNfe_NOTA
PARAMETERS PrmEmpresa,PrmBoletim,PrmForn, PrmEspera



PRIVATE ;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc


	=W_DEFPROC("NOTAENT.SPR")
	=NEDefIDNFDocFiscal(PrmEmpresa,PrmBoletim,PrmForn,;
						PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						RtnSerie_Doc)


	IF TYPE("PrmEspera") <> "C" OR EMPTY(PrmEspera)
		PrmEspera = "ESPERA"
	ENDIF



	*-------------------------------------------------------------*



	*--> PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc





	=W_DEFPROC("DOCFISCA.SPR")

		LSstatus = (DFRespostaNFe;
		      (;
				PrmEmpresa,;
	   			RtnMod_Doc,;
	   			RtnNro_Doc,;
			     PrmEspera,;
				  RtnStatus,;
				  RtnRecibo,;
			      RtnProtocolo,;
		          RtnChvNFe,;
		          RtnJstfCanc,;
		          RtnPrtcCanc;
			  );
			)




	IF  "ERRO" $ LSstatus
		WAIT WINDOW LSstatus  NOWAIT
	ENDIF


	=W_DEFPROC("NOTAENT.SPR")
	IF NELerRegistro(PrmEmpresa,PrmBoletim,PrmForn)
  	    	
	    	=NESetPropVT("NFE_STATUS",RtnStatus)
			=NESetPropVT("NFE_RECIBO",RtnRecibo)
			=NESetPropVT("NFE_PROTOC",RtnProtocolo)
		*****	=NESetPropVT("NFE_CHV",RtnChvNFe)
			=NESetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=NESetPropVT("NFEPRTCCAN",RtnPrtcCanc)

			=NESalvarRegistro()
	ENDIF




	=W_DEFPROC("DOCFISCA.SPR")
	IF (DFLerRegistro(PrmEmpresa,RtnMod_Doc,RtnCOD_IDFORN,;
			  RtnNRO_DOC,RtnSerie_Doc ))

 	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
			=DFSetPropVT("NFE_RECIBO",RtnRecibo)
			=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
			=DFSetPropVT("NFE_CHV",RtnChvNFe)
			=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)

			=DFSalvarRegistro()
	ENDIF

RETURN






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYT1           NEDefIDNFDocFiscal VALID           
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   33  
*        Variable:            NEDefIDNFDocFiscal                 
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      50                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyt1     &&  NEDefIDNFDocFiscal VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NEDefIDNFDocFiscal
PARAMETERS PrmEmpresa,PrmBoletim,PrmForn,;
     PrmSerie,;
	 PrmTipo,;
     RtnNro_Doc,;
	 RtnMod_Doc,;
	 RtnCOD_IDFORN,;
	 RtnSerie_Doc,;
	 RtnDocEletro


	PRIVATE NFAlias

	PRIVATE  ;
	 PrmNota
	
	PRIVATE LNtp_pessoa


    PrmNota = PrmBoletim




	=W_DEFPROC("NOTAENT.SPR")
	NFAlias = NEGetAlias()


	=W_DEFPROC("NOTAENT.SPR")
	IF !NELerRegistro(PrmEmpresa,PrmBoletim,PrmForn)

		MSG = "NF Entrada nao localizada ";
		     +str(PrmBoletim,7);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	PrmTipo    		= &NFAlias .Tipo

    PrmSerie  =     LEFT( &NFAlias .Serie +"   ",3)

	IF EMPTY(PrmSerie)
	    PrmSerie  =     LEFT( "01   ",3)
	endif





	=W_DEFPROC("CLIENTES.SPR")
	LNtp_pessoa =  CLDef_TipoPessoa(  &NFAlias .Favorecido)


	=W_DEFPROC("CLIENTES.SPR")
	LNtp_pessoa =  CLDef_TipoPessoa( &NFAlias .Favorecido)


*	IF  LNtp_pessoa = 1
*		 RtnCOD_IDFORN = CHRTRAN(STR(  &NFAlias .Favorecido,11)," ","0")
*	ELSE
		 RtnCOD_IDFORN = CHRTRAN(STR(  &NFAlias .Favorecido,14)," ","0")
*	ENDIF

	RtnSerie_Doc  = PrmSerie
    RtnNro_Doc    =  PrmNota


 *------------------------------------------------------------------*
 * em maio de 2013 o campo notareal foi criado para atender notas de
 * entrada com mais de seis digitos no numero. N hora de gerar para
 * o dfis enviamos o numero real que pode ter + de 6 digitos
 *------------------------------------------------------------------*

    RtnNro_Doc    =   &NFAlias .notareal



	DO CASE

		CASE ALLTRIM( &NFAlias .nf_mod_doc) <> ""

			RtnMod_Doc   =   &NFAlias .nf_mod_doc
		    m.MOD_DOC    =   &NFAlias .nf_mod_doc

		CASE PrmBoletim > 1000000 AND PrmBoletim < 2000000
			RtnMod_Doc   =   "2D"  && CUPOM
		    m.MOD_DOC    =   "2D"  && CUPOM

			RtnDocEletro = "NAO"

		CASE PrmBoletim > 3000000 AND PrmBoletim < 4000000
			RtnMod_Doc   =   "55"  && NFe
		    m.MOD_DOC    =   "55"  && NFe


			RtnSerie_Doc  = "00 "


			RtnDocEletro = "SIM"
		
		OTHERWISE			
			=W_DEFPROC("TIPOOPER.SPR")
			RtnMod_Doc    = ;
			   TPGetFieldValue("E",  &NFAlias .tipo ,"Cod_Mod_Rf")
		    m.MOD_DOC    = RtnMod_Doc

			RtnDocEletro = "NAO"

	ENDCASE
	






RETURN(.t.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYT6           NF_CancDFis VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   34  
*        Variable:            NF_CancDFis                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      51                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyt6     &&  NF_CancDFis VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NF_CancDFis
PARAMETERS PrmEmpresa, PrmNota, PrmObjetivo




	PRIVATE NFAlias


	PRIVATE LSAlias
	LSalias		= 	ALIAS()


	=W_DEFPROC("NOTA.SPR")
	NFAlias = NFGetAlias()



	=W_DEFPROC("NOTA.SPR")
	IF !NFLerRegistro(PrmEmpresa,PrmNota)

		MSG = "NF nao localizada ";
		     +str(PrmNota,7);
		     +" <ENTER>"
		WAIT MSG
		RETURN(.F.)
	ENDIF


	*-->>>>>>>>>>>>>     PARA ENVIO NFE
	PRIVATE  ;
		     PrmSerie,;
			 PrmTipo,;
		     RtnNro_Doc,;
			 RtnMod_Doc,;
			 RtnCOD_IDFORN,;
			 RtnSerie_Doc

	PrmSerie   		= &NFAlias .Serie
	PrmTipo    		= &NFAlias .Tipo
	RtnNro_Doc 		= 0
 	RtnMod_Doc		= ""
	RtnCOD_IDFORN	= ""
	RtnSerie_Doc	= ""

	*----------------------------------------------------*

	*-->>>>>>>>>>>       PARA DADOS RETORNO NFE
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc
	*----------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	=DFDefIDNFDocFiscal(PrmEmpresa,PrmNota,PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						 RtnSerie_Doc)





	IF  RtnMOD_DOC    <>   "55"
		RETURN(.T.)
	ENDIF

	RETURN(.T.)


    PRIVATE LFOk_NFe

	LFOk_NFe = .T.
*
*	=W_DEFPROC("DOCFISCA.SPR")
*	LFOk_NFe = DFConvrtNFDocFiscal(PrmEmpresa,PrmNota)
*


	PRIVATE LSXMLObjetivo

	LSXMLObjetivo = "CANCELAMENTO"

	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		LFOk_NFe =(DFGerXMLDocFiscal(PrmEmpresa,;
									RtnMod_Doc,;
 						            RtnCOD_IDFORN,;
		 							RtnNro_Doc,;
		 							RtnSerie_Doc,;
		 							LSXMLObjetivo ))
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe
	   LFOk_NFe = (DFEnviaNFeXML(;
	   					PrmEmpresa,;
	   					RtnMod_Doc,;
	   					RtnNro_Doc))
	ENDIF

	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe
		LSstatus = (DFRespostaNFe;
		      (;
				PrmEmpresa,;
				RtnMod_Doc,;
	   			RtnNro_Doc,;
			     "ESPERA",;
				  RtnStatus,;
				  RtnRecibo,;
			      RtnProtocolo,;
		          RtnChvNFe,;
		          RtnJstfCanc,;
		          RtnPrtcCanc;
			  );
			)
		IF "ERRO" $ LSstatus
			 LFOk_NFe = .F.
		ENDIF
		IF !("CANCELADA" $ LSstatus)
			 LFOk_NFe = .F.
		ENDIF

	ENDIF


	IF LFOk_NFe
		=W_DEFPROC("NOTA.SPR")
		IF NFLerRegistro(PrmEmpresa, PrmNota)
  	    	=NFSetPropVT("NFE_STATUS",RtnStatus)
			=NFSetPropVT("NFE_RECIBO",RtnRecibo)
			=NFSetPropVT("NFE_PROTOC",RtnProtocolo)
			=NFSetPropVT("NFE_CHV",RtnChvNFe)
			=NFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
			=NFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
			=NFSalvarRegistro()
		ENDIF
	ENDIF

	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		IF (DFLerRegistro(PrmEmpresa,RtnMod_Doc,;
		      RtnCOD_IDFORN,;
			  RtnNro_Doc,RtnSerie_Doc ))
	  	    	=DFSetPropVT("NFE_STATUS",RtnStatus)
				=DFSetPropVT("NFE_RECIBO",RtnRecibo)
				=DFSetPropVT("NFE_PROTOC",RtnProtocolo)
				=DFSetPropVT("NFE_CHV",RtnChvNFe)
				=DFSetPropVT("NFEJSTFCAN",RtnJstfCanc)
				=DFSetPropVT("NFEPRTCCAN",RtnPrtcCanc)
				=DFSalvarRegistro()
		ENDIF
	ENDIF


	=W_DEFPROC("rotinas.spr")


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	*--------------------------------------------------------------*
RETURN(LFOk_NFe)






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYT9           NEDefCancDFis VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   35  
*        Variable:            NEDefCancDFis                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      52                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyt9     &&  NEDefCancDFis VALID
#REGION 2
return
*---------------------------------------------------------------*

********************
FUNCTION NEDefCancDFis
PARAMETERS PrmEmpresa



	*----------------------------------------------------*

	*----------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "CANCELAMENTO"


RETURN(PrmObjetivo)


FUNCTION NEWNEDefCancDFis

	*-----------------------------------------------------------*
	PRIVATE LSscr_ENT

	*------------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ENT = EMGetFieldValue(PrmEmpresa,"ESCRT_ENT")


	*------------------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "NAO INTEGRAR"



	IF LSscr_ENT = "S"
		PrmObjetivo = "ESCRITURACAO"

	ENDIF

RETURN(PrmObjetivo)






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYTA           NEDefEnvDFis VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   36  
*        Variable:            NEDefEnvDFis                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      53                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyta     &&  NEDefEnvDFis VALID
#REGION 2
return
*---------------------------------------------------------------*

********************
FUNCTION NEDefEnvDFis
PARAMETERS PrmEmpresa,PrmModDoc


	*----------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "ESCRITURACAO"


	*-----------------------------------------------------------*
	PRIVATE LSscr_ENT


	*------------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	LSscr_ENT = EMGetFieldValue(PrmEmpresa,"ESCRT_ENT")

	*------------------------------------------------------------*
	PRIVATE PrmObjetivo

	PrmObjetivo = "NAO INTEGRAR"



	IF LSscr_ENT = "S"
		PrmObjetivo = "ESCRITURACAO"

	ENDIF

    IF TYPE("PrmModDoc")  <> "C"
       PrmModDoc = ""
    endif
   	IF LSscr_ENT = "C"     && C =>CONSULTAR DOC ELETRONICO
       IF PrmModDoc $  "55/57"
		   PrmObjetivo = "CONSULTAR"
       ENDIF
    ENDIF




RETURN(PrmObjetivo)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYTB           NEEscriturar VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   37  
*        Variable:            NEEscriturar                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      54                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsytb     &&  NEEscriturar VALID
#REGION 2
return
*---------------------------------------------------------------*
FUNCTION NEEscriturar
PARAMETERS PrmAlias,LSExibeMsg


	PRIVATE LSExibeMsg
	IF TYPE("LSExibeMsg") <> "C"
		LSExibeMsg = "SIM"
	ENDIF


	*-------------------------------------------------------------*
    * GERANDO DFIS
	*-------------------------------------------------------------*
	PRIVATE LSobjetivo

	LSobjetivo = NEDefEnvDFis(  &PrmAlias .Empresa, &PrmAlias .nf_mod_doc )

	IF  LSobjetivo $ "ESCRITURACAO/CONSULTAR"

		=W_DEFPROC("NOTAENT.SPR")
		IF !(NEGeraDFIS( &PrmAlias .Empresa,;
			             &PrmAlias .Nota,;
			             &PrmAlias .CodForn,;
			             LSExibeMsg,;
			             PrmObjetivo))
			IF LSExibeMsg = "SIM"

	   			DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				"  O Emissor de Documentos Fiscais"+;
				" nao acatou a Escrituracao."+;
     			" Repita o processo e se persistir a negacao entre "+;
   	 			" em contato com suporte"
			ENDIF
			
   			SELE notaent

   			RETURN(.f.)
	 	ENDIF
	ENDIF


	*---------------------------------------------------------------*


	*----------------------------------------------------------------*
	wp_msg = " ** Faturamento Concluido ** "
	WAIT WINDOW wp_msg NOWAIT
	*----------------------------------------------------------------*

RETURN(.T.)







*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYTD           NEGeraDFIS VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   41  
*        Variable:            NEGeraDFIS                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      55                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsytd     &&  NEGeraDFIS VALID
#REGION 2
return
*---------------------------------------------------------------*

FUNCTION NEGeraDFIS
PARAMETERS PrmEmpresa,PrmBoletim,PrmForn,PrmExibeMsg,PrmObjetivo
	*-----------------------------------------------*
	*---> Notaent.Empresa -> PrmEmpresa
	*---> Notaent.Nota    -> PrmBoletim
	*---> Notaent.CodForn -> PrmForn
	*-----------------------------------------------*


	PRIVATE PrmObjetivo
	*-----------------------------------------------------*

	PRIVATE PrmAlias

	PRIVATE LSalias

	*--------------------------------------------------*

	PRIVATE ;
    	 PrmSerie,;
		 PrmTipo,;
    	 RtnNro_Doc,;
		 RtnMod_Doc,;
		 RtnCOD_IDFORN,;
		 RtnSerie_Doc,;
		 RtnDocEletro
	*--------------------------------------------------*
	*----------------------------------------------------*

	*-->>>>>>>>>>>       PARA DADOS RETORNO DO CONTROLADOR DFis
	PRIVATE	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc



	STORE "" TO 	  RtnStatus,;
			  RtnRecibo,;
		      RtnProtocolo,;
	          RtnChvNFe,;
	          RtnJstfCanc,;
	          RtnPrtcCanc
	*----------------------------------------------------*

	LSalias = ALIAS()
	
	*-----------------------------------------------*

    IF TYPE("PrmObjetivo") <> "C"
		PrmObjetivo = "ESCRITURACAO"
	ENDIF

	IF type("PrmExibeMsg") $ "C"
		PrmExibeMsg	 = "SIM"
	ENDIF


	=W_DEFPROC("NOTAENT.SPR")
	PrmAlias = NEGetAlias()


	=W_DEFPROC("NOTAENT.SPR")
	IF !NELerRegistro(PrmEmpresa,PrmBoletim,PrmForn)
		MSG = "NEnt nao localizada ";
		     +str(PrmNota,7);
		     +"Forn:"+str(PrmFornCOD,14);
		     +" <ENTER>"
		WAIT MSG NOWAIT
		RETURN(.F.)
	ENDIF


	* SITUACAO = c PROCESSADA AGUARDA ESCRITURACAO
	*          = C PROCESSADA E ESCRITURADA

	IF  !(LEFT( &PrmAlias .SITUACAO,1) $ "cC")

		* NAO PROCESSAR ENTRADAS NAO EFETIVADAS
		
		RETURN(.T.)
	ENDIF


	IF   &PrmAlias .tipo $ "QLA/SCA"
		* NAO PROCESSAR AJUSTES DE ESTOQUE
				
		RETURN(.T.)
	ENDIF


	*---------------------------------------------------*
	
	*---------------------------------------------------*

	STORE 0 TO  ;
    	 PrmSerie,;
		 PrmTipo,;
    	 RtnNro_Doc,;
		 RtnMod_Doc,;
		 RtnCOD_IDFORN,;
		 RtnSerie_Doc,;
		 RtnDocEletro


	PrmSerie = &PrmAlias .serie
	PrmTipo  = &PrmAlias .tipo


	=W_DEFPROC("NOTAENT.SPR")
	=NEDefIDNFDocFiscal(PrmEmpresa,PrmBoletim,PrmForn,;
						PrmSerie,PrmTipo,;
					    RtnNro_Doc,RtnMod_Doc,RtnCOD_IDFORN,;
						RtnSerie_Doc,RtnDocEletro)



	*--------------------------------------------------------*

    PRIVATE LFOk_NFe

	LFOk_NFe = .T.


	
	=W_DEFPROC("DOCFISCA.SPR")
	LFOk_NFe = DFConvrtNEDocFiscal(PrmEmpresa,PrmBoletim,;
              	PrmForn,PrmExibeMsg)




	*--------------------------------------------------------*

	PRIVATE LSXMLObjetivo

	LSXMLObjetivo = PrmObjetivo

	IF LFOk_NFe
		=W_DEFPROC("DOCFISCA.SPR")
		LFOk_NFe =(DFGerXMLDocFiscal(PrmEmpresa,;
									RtnMod_Doc,;
 						            RtnCOD_IDFORN,;
		 							RtnNro_Doc,;
		 							RtnSerie_Doc,;
		 							LSXMLObjetivo,PrmExibeMsg ))



	ENDIF
	*----------------------------------------------------------*

	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe

*--------------------------------------------------------
*   altarada para permitir a subrotina verifica se existe duplicata para o
*    doc fiscal informado
*---------------------------------------------------------
*	   LFOk_NFe = (DFEnviaNFeXML(;
*	   					PrmEmpresa,;
*	   					RtnMod_Doc,;
*	   					RtnNro_Doc))
*---------------------------------------------------------
		LFOk_NFe =(DFEnviaNFeXML(PrmEmpresa,;
									RtnMod_Doc,;
 						            RtnCOD_IDFORN,;
		 							RtnNro_Doc,;
		 							RtnSerie_Doc,;
		 							LSXMLObjetivo ))

	ENDIF


	*----------------------------------------------------------*


	=W_DEFPROC("DOCFISCA.SPR")
	IF LFOk_NFe
			
			
*--------------------------------------------------------
*   altarada para permitir a subrotina verifica se existe duplicata para o
*    doc fiscal informado
*---------------------------------------------------------
*		LSstatus = (DFRespostaNFe;
*		      (;
*				PrmEmpresa,;
*				RtnMod_Doc,;
*	   			RtnNro_Doc,;
*			     "ESPERA",;
*				  RtnStatus,;
*				  RtnRecibo,;
*			      RtnProtocolo,;
*		          RtnChvNFe,;
*		          RtnJstfCanc,;
*		          RtnPrtcCanc;
*			  );
*			)
*
		LSstatus = (DFRespostaNFe;
		      (;
				PrmEmpresa,;
				RtnMod_Doc,;
                RtnCOD_IDFORN,;
	   			RtnNro_Doc,;
	   			RtnSerie_Doc,;
			     "ESPERA",;
				  RtnStatus,;
				  RtnRecibo,;
			      RtnProtocolo,;
		          RtnChvNFe,;
		          RtnJstfCanc,;
		          RtnPrtcCanc;
			  );
			)

			
		IF "ERRO" $ LSstatus

			LSMSG = LEFT(str(PrmBoletim,7)+ "-" + LSstatus,225)

			IF	PrmExibeMsg	 = "SIM"

				=fox_alert(LSmsg,.t.)

			ENDIF
			
		    LFOk_NFe = .F.
		
		ENDIF

	ENDIF


	IF LFOk_NFe
		=W_DEFPROC("NOTAENT.SPR")
		IF NELerRegistro(PrmEmpresa,PrmBoletim,PrmForn)
  	    	=NESetPropVT("NFE_STATUS",RtnStatus)
			=NESetPropVT("NFE_RECIBO",RtnRecibo)
			=NESetPropVT("NFE_PROTOC",RtnProtocolo)

		****	=NESetPropVT("NFE_CHV",RtnChvNFe)


			=NESetPropVT("SITUACAO","C")

			=NESalvarRegistro()
		ENDIF
	ENDIF



	=W_DEFPROC("rotinas.spr")


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF


   *-----<<<< CONSIDERA A NFe MESMO COM ERRO >>>>*------						
   ******* RETURN(.T.) ALTERADO EM  30/01/2012 COM EXPORT IMEDIATA
   *----------------------------------------------------


	*--------------------------------------------------------------*
RETURN(LFOk_NFe)







RETURN(.t.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYTH           NEProcEcrtDt VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   42  
*        Variable:            NEProcEcrtDt                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      56                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyth     &&  NEProcEcrtDt VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NEProcEcrtDt
PARAMETER PrmEmp,PrmDtIni,PrmDtFim



	PRIVATE  LNregistro

	PRIVATE LN_NFregistro

    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTAENT")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF


	=W_DEFPROC("DOCFISCA.SPR")
	=DFVerifyInst()



	SELE &ALSNota
	SET ORDER TO TAG RLDTENTR
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI



	*----------------------------------------------------*
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	LFsegue = .t.

	LNregistro = RECNO()

	COUNT  WHILE !EOF() AND &ALSNota .empresa = PrmEmp ;
				AND &ALSNota .data >= PrmDtIni ;
    	        AND &ALSNota .data <= PrmDtFim ;
             TO LNimpressao
	GO LNregistro
	LNimpressos = 0

    BKregistro  = LNregistro
    BKimpressos = LNimpressos
    BKimpressao = LNimpressao


	*----------------------------------------------------*

	DO WHILE !EOF() ;
					AND	LFsegue = .t. ;
					AND &ALSNota .empresa = PrmEmp ;
					AND &ALSNota .data >= PrmDtIni ;
	                AND &ALSNota .data <= PrmDtFim
		

		DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO

	    LNregistro  = BKregistro
    	LNimpressos = BKimpressos
	    LNimpressao = BKimpressao


		=UPtermo()

	    BKregistro  = LNregistro
    	BKimpressos = LNimpressos
	    BKimpressao = LNimpressao


		IF &ALSNota .nfe_status <> "PROCESSADA" ;
		   AND !( &ALSNota .tipo $ "QLA/SCA")

			LPrmNota = &ALSNota .Nota
	
			LN_NFregistro = RECNO()
			LSExibeMsg = "NAO"

	
			=NEEscriturar(ALSNota,LSExibeMsg)

			SELE  &ALSNota
			SET ORDER TO TAG RLDTENTR
			GO LN_NFregistro
		ENDIF

 		SKIP
		CTR = 	CTR + 1
	ENDDO

	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYTJ           NEPendEcrtDt VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   43  
*        Variable:            NEPendEcrtDt                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      57                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsytj     &&  NEPendEcrtDt VALID
#REGION 2
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION NEPendEcrtDt
PARAMETER PrmEmp,PrmDtIni,PrmDtFim



	PRIVATE  LNregistro

	PRIVATE LN_NFregistro

    PRIVATE ARQNota,ALSNota
	LSalias = ALIAS()

    ARQNota     = NetArqAgain("NOTAENT")
    ALSNota     = Alias()

	IF ( ARQNota) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALSNota")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF




	SELE &ALSNota
	SET ORDER TO TAG RLDTENTR
	SET NEAR ON
	SEEK STR(PrmEmp,3)+DTOS(PrmDtIni)
	SET NEAR OFF


	HINI =TIME()
	CTR = 1
	MSG  = HINI

    SET TALK ON

    SELECT ;
        NT.EMPRESA, ;
        NT.NOTA, ;
        NT.TIPO, ;
        NT.NF_MOD_DOC, ;
        NT.DATA, ;
        NT.CODFORN;
    FROM &ALSNota NT ;
    WHERE ;
	        NT.empresa = PrmEmp ;
	    AND NT.data >= PrmDtIni ;
        AND NT.data <= PrmDtFim ;
        AND NT.nfe_status <> "PROCESSADA" ;
		AND !( NT.tipo $ "QLA/SCA");
	INTO TABLE C:\NFe\pendEnt ;
	ORDER BY ;
        NT.DATA, ;
        NT.NF_MOD_DOC, ;
        NT.NOTA
	
	sele pendEnt
	brows  TITLE  "C:\NFe\pendEnt.dbf"
	use

    SET TALK OFF

	*-----------------------------------------------*
    =up_fecha("&ALSNota")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYTL           NEClcICMS VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   44  
*        Variable:            NEClcICMS                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      58                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsytl     &&  NEClcICMS VALID
#REGION 2
RETURN

FUNCTION NEClcICMS
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria, ;
		PrmPrdtOrigem, Notaite_PK

	
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal


	PRIVATE ARQ_notaite    , ALS_notaite


	PRIVATE LNbaseicms,LNicms
	PRIVATE LNaliq_icms

	PRIVATE LNUFOrigem
	PRIVATE LNUFDestino


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()


    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()


    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()






	IF (ARQ_empresa+ARQ_notaent+ARQ_grfiscal+ARQ_grfiscal+;
	     +ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
        =up_fecha("&ALS_notaite")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	SELE &ALS_notaite
	GO Notaite_PK


	SELE &ALS_notaite
	GO Notaite_PK

    *----------------------------------------------------------*
	LNicms		=	0
    PRIVATE LNreducao
    LNreducao   = &ALS_notaite .alq_rdu
    LNaliq_icms = &ALS_notaite .aliq_icms
    *----------------------------------------------------------*


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	LNicms		=	0



	IF     &ALS_notaent .vlr_icms > 0 ;
	    OR &ALS_notaent .base_icms > 0 ;
	    OR &ALS_notaent .icms_subs > 0



		LNbaseicms    = LNvlrMercadoria

		*-------------------------------------------------------------*
		*  A base de ICMS e reduzida em 4.90% quando o fornecedor for
		* firestone em funcao da mudanca na cobranca de PIS e COFINS
		* que passaram a ser retidos.
		*-------------------------------------------------------------*

		*-------------------------------------------------------------*
		* "02/07/ " cst com reducao da base de calculo
		*--------------------------------------------------------------*
		
		
		
		if &ALS_notaent .reduc_icms > 0
			LNbaseicms  = LNvlrMercadoria * LNreducao
		ELSE
			if &ALS_notaent .codforn = 1
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.049
			endif

			if &ALS_notaent .codforn = 2
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.0519
			endif


		ENDIF

		LNicms	= (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	ENDIF

***	LNicms	= ROUND(LNicms,2)
	

	
	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNicms)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYTO           NEIcmsOper VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   45  
*        Variable:            NEIcmsOper                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      59                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyto     &&  NEIcmsOper VALID
#REGION 2
RETURN

FUNCTION NEIcmsOper
	PARAMETERS LNemp,LNboletim,LNforn, LScod, ;
	     LNvlrMercadoria, PrmPrdtOrigem, Notaite_PK
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal

	PRIVATE ARQ_notaite    , ALS_notaite



	PRIVATE LNbaseicms,LNicms
	PRIVATE LNaliq_icms

	PRIVATE LNUFOrigem
	PRIVATE LNUFDestino


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()


    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()



    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()

	IF (ARQ_empresa+ARQ_notaent+ARQ_grfiscal+;
	    ARQ_grfiscal+ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
        =up_fecha("&ALS_notaite")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE &ALS_notaite
	GO Notaite_PK

    *----------------------------------------------------------*
	LNicms		=	0
    PRIVATE LNreducao
    LNreducao   = &ALS_notaite .alq_rdu
    LNaliq_icms = &ALS_notaite .aliq_icms
    *----------------------------------------------------------*


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*


	IF  &ALS_notaent .icms_subs > 0



		LNbaseicms    = LNvlrMercadoria


		*-------------------------------------------------------------*
		*  A base de ICMS e reduzida em 4.90% quando o fornecedor for
		* firestone em funcao da mudanca na cobranca de PIS e COFINS
		* que passaram a ser retidos.
		*-------------------------------------------------------------*
		
		if &ALS_notaent .reduc_icms > 0
			LNbaseicms  = LNvlrMercadoria * LNreducao
		ELSE
			if &ALS_notaent .codforn = 1
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.049
			endif

			if &ALS_notaent .codforn = 2
				LNbaseicms    = LNvlrMercadoria-LNvlrMercadoria*0.0519
			endif

		ENDIF

		LNicms	= (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	ENDIF
	
**	LNicms	= ROUND(LNicms,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNicms)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYTQ           NEBsBrRetido VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   46  
*        Variable:            NEBsBrRetido                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      60                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsytq     &&  NEBsBrRetido VALID
#REGION 2
RETURN

FUNCTION NEBsBrRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria,;
	 LNipi,Notaite_PK, PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Bruta ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite

	PRIVATE LNicms
	PRIVATE LSufOrigem, LSufDestino

	PRIVATE LNBsBrRetido

	LNBsBrRetido = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()


	IF (ARQ_empresa+ARQ_notaen+ ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	SELE &ALS_notaite
	GO Notaite_PK


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)



    *----------------------------------------------------------*
	LNicms		=	0
    PRIVATE LNreducao
    LNreducao   = &ALS_notaite .alq_rdu
	LNiva       = 	&ALS_notaite .IVA
    *----------------------------------------------------------*

	*-------------------------------------------------------------*

	*-------------------------------------------------------------*


	LNBsBrRetido   = 0
	

	IF &ALS_notaent .icms_subs	> 0


        IF &ALS_notaite .CST $ "1/2/7"
			DO CASE

		  		CASE LNtpmercad = 8  && REDUTOR NAAAO AFETA BASE DO RETIDO
					LNBsBrRetido  = (LNvlrMercadoria + LNipi)

		  		CASE LSufOrigem =  LSufDestino
		  		                    && REDUTOR NAAAO AFETA BASE DO RETIDO
					LNBsBrRetido  = (LNvlrMercadoria + LNipi)

                *------------------------------------------*
                * REGRA REVIZADA COM OLIVEIRA EM 25/11/2011
                * PARA ACERTA TRIBUTACAO NOTA 7605 DE 13/10/2010
                * FORNECEDOR LEXUS IMPORTACAO
                *------------------------------------------*
				CASE &ALS_notaent .reduc_icms > 0
						LNBsBrRetido  = (LNvlrMercadoria  ;
				                * LNreducao) +  LNipi
				


				CASE &ALS_notaent .reduc_icms = 0
					if &ALS_notaent .data >= {01.11.2006}
						DO CASE
							CASE &ALS_notaent .codforn = 1
								LNBsBrRetido    = ;
								(LNvlrMercadoria + LNipi)-;
									(LNvlrMercadoria)*0.049

							CASE &ALS_notaent .codforn = 2
								LNBsBrRetido    = ;
								(LNvlrMercadoria + LNipi)-;
									(LNvlrMercadoria)*0.0519


							OTHERWISE
								LNBsBrRetido   = (LNvlrMercadoria + LNipi)
							
						ENDCASE

					ELSE


						DO CASE
							CASE  &ALS_notaent .codforn = 1
								LNBsBrRetido    = ;
									(LNvlrMercadoria + LNipi)-;
									(LNvlrMercadoria + LNipi)*0.049
									
							CASE  &ALS_notaent .codforn = 2
								LNBsBrRetido    = ;
									(LNvlrMercadoria + LNipi)-;
								    ((LNvlrMercadoria + LNipi)*0.0519)
									
							OTHERWISE
								LNBsBrRetido   = (LNvlrMercadoria + LNipi)
						ENDCASE
					ENDIF
			ENDCASE

		ENDIF
	ENDIF

	LNBsBrRetido = LNBsBrRetido
	
	*----------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsBrRetido)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYTT           ant0613NEfatura VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   47  
*        Variable:            ant0613NEfatura                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      61                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsytt     &&  ant0613NEfatura VALID
#REGION 2
return

*---------------------------------------------------------------*
FUNCTION ant0613NEfatura
	PRIVATE vlr_icms, m.icms_subs
	
	PRIVATE LFretorno
	LFretorno	=  .t.
	*----------------------------------------------------------*
  	SELECT notaite
   	LNnota = m.nota     && EVITA APAGAR N. NOTA
   	SCATTER MEMVAR MEMO
   	DO CASE
		CASE m.natu_oper = 1
		   m.operacao = 'ECP.'   && ENTRADA/COMPRA/PROCESSADA
		CASE m.natu_oper = 2
		   m.operacao = 'ETP.'   && ENTRADA/TRANSFERENCIA/PROCESSADA
		CASE m.natu_oper = 3
		   m.operacao = 'ERP.'   && ENTRADA/REMESSA/PROCESSADA
		CASE m.natu_oper = 4
		   m.operacao = 'EDP.'   && ENTRADA/DEVOLUCAO/PROCESSADA
		CASE m.natu_oper = 5
		   m.operacao = 'EOP.'   && ENTRADA/OUTRAS OPER/PROCESSADA
		CASE m.natu_oper = 6
		   m.operacao = 'SOP.'   && SAIDA/OUTRAS OPER / PROCESSADA
   	ENDCASE

	*---------------------------------------------------------------*
	*  CALCULO DO CUSTO INDIRETO
	*---------------------------------------------------------------*
	
	LNcstind = NEClcIndiretoCusto( ;
					notaent.data_emi, ;
					notaent.totproduto, notaent.vlr_ipi, ;
					notaent.vlrFrete, notaent.vlrdespes, ;
					notaent.vlrseguro,;
					notaite.vlrvenda, notaite.vlripi)

	**********************************
   	m.situacao 	= 'C'+RIGHT(m.situacao,1)
   	m.nota 	   	=  notaent.nota
   	m.dtfat 	=  notaent.data_emi
   	m.custo_ind =  LNcstind



    *-------------- ICMS NORMAL -------------*

    IF m.origem = 1		&& importado
	     m.bsbr_icms  = m.vlrvenda + m.VLRIPI
	ELSE
	     m.bsbr_icms  = m.vlrvenda
	ENDIF

	m.aliq_rdu = 0
	
    IF notaent.reduc_icms > 0
       m.aliq_rdu = notaent.reduc_icms
    ENDIF

	DO CASE
		CASE m.aliq_rdu > 0
		   m.base_calc = m.bsbr_icms * m.aliq_rdu

		CASE notaent.codforn = 1 OR notaent.codforn = 1130
		      m.base_calc = m.bsbr_icms  - ;
			 				(m.bsbr_icms * (4.9/100))
			  m.aliq_rdu  = 4.9/100

		CASE notaent.codforn = 2
		      m.base_calc = m.bsbr_icms  - ;
			 				(m.bsbr_icms * (5.19/100))
			  m.aliq_rdu  = 5.19/100

		OTHERWISE
			m.base_calc = m.bsbr_icms
	ENDCASE	

**    SET STEP ON

	m.vlr_icms = NEClcICMS(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,;
							notaite.origem)

    *-------------- ICMS SOBRE OPERACAO -------------*

    m.bsbricmso  = 0
    m.baseicmso  = 0
	m.icmssoper  = 0


	if notaent.icmssoper > 0

		DO CASE
			CASE m.origem = 1		&& importado
			     m.bsbricmso  = m.vlrvenda + m.VLRIPI + m.custo_ind
			CASE m.tp_mercad = 8		&& importado
			     m.bsbricmso  = m.vlrvenda
			OTHERWISE	
		         m.bsbricmso  = m.vlrvenda  &&  + m.custo_ind
		ENDCASE
	
		DO CASE
			CASE m.aliq_rdu > 0

			 m.baseicmso  = m.bsbricmso * m.aliq_rdu

		     **** m.baseicmso = m.bsbricmso  - ;
				 				(m.bsbricmso * m.aliq_rdu)

			CASE notaent.codforn = 1 OR notaent.codforn = 1130
		      m.baseicmso = m.bsbricmso  - ;
				 				(m.bsbricmso * (4.9/100))


			CASE notaent.codforn = 2
		      m.baseicmso = m.bsbricmso  - ;
				 				(m.bsbricmso * (5.19/100))



			OTHERWISE
				m.baseicmso = m.bsbricmso
		ENDCASE	
	
		m.icmssoper = NEIcmsOper(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,;
							notaite.origem)

	endif
	*---------------------------------------------------*


	m.Base_sbbrt = NEBsBrRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,  ;
							notaite.vlripi,    ;
							recno("NOTAITE"),;
							notaite.origem)
				
	m.Base_subs  = NEBsRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.Base_sbbrt,    ;
							recno("NOTAITE"),;
							notaite.origem)


	m.icms_subs  = NEClcRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.vlr_icms,m.Base_subs,;
							m.icmssoper,    ;
							recno("NOTAITE") ,;
							notaite.origem)


	m.BsEntsbbrt = NEBsEntBrRetido(	notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							notaite.vlrvenda,  ;
							notaite.vlripi,    ;
							notaite.custo_ind, ;
							recno("NOTAITE") ,;
							notaite.origem)
							
	m.BsEntSubs  = NEBsEntRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.BsEntsbbrt, ;
							recno("NOTAITE"), ;
							notaite.origem)

	m.IcmsEntsub = NEClcEntRetido( notaent.empresa,   ;
							notaent.referencia,;
							notaent.codforn,   ;
							notaite.codigo,    ;
							m.vlr_icms,m.BsEntSubs,;
							m.icmssoper,    ;
							recno("NOTAITE"),;
							notaite.origem)





   	IF m.pedido > 0 and LEFT(m.codigo,7) <> "9999999"
		*-----------------------------------------------------------*
		*    So tratar pedido nos diretorios LOJA ou CENTRAL ou
		* para datas com superiores a 2000
		*-----------------------------------------------------------*
		IF notaent.data >= {01.01.2000}
		  *----------------------------------------------------------*
		  =W_DEFPROC("PEDIDO.SPR")
		  IF !PDregistra_qte(notaent.empresa,notaent.pedido,notaite.codigo,;
							notaite.qtde,"REG.ENTRADA")
			RETURN(.F.)
		  ENDIF
		ENDIF
 		 *----------------------------------------------------------*
   ENDIF
**
   SELECT notaite
	=edithand('REGRAVA')

    =W_DEFPROC("NOTAITE.SPR")
	=IE_Refresh(m.empresa,m.orcamento,m.favorecido,m.ordem)


    SELECT itemmov
	m.data = notaent.data
	m.hora = notaent.hora
	m.sld_estq = 0
	m.vlr_estq = 0
	************************************************************
	*    - GARANTIA CONTRA DUPLICACAO							*
	************************************************************
	SET ORDER TO TAG movimento
	SEEK STR(m.empresa,3) + m.codigo + DTOS(m.data) + m.hora +;
			 		 + m.tipo + STR(m.nota,7) + STR(m.ordem,2)
	IF FOUND()
   		=edithand('REGRAVA')
	ELSE
   		=edithand('SAVE')
	ENDIF
   	=W_DEFPROC("moviment.spr")
	=MVatu_cmd(itemmov.empresa,;
				itemmov.codigo,;
				itemmov.classifica,;
				itemmov.data,;
				itemmov.hora,;
				itemmov.tipo,;
				itemmov.nota,;
				itemmov.ordem)
	    					&& ROTINA DE VERIFICACAO E ATUALIZACAO DO SALDO
							&& VAI DEVOLVER m.sld_atu e
	*----------------------------------------------------------*
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYTX           ant0613NEBsRetido VALID            
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   48  
*        Variable:            ant0613NEBsRetido                  
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      62                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsytx     &&  ant0613NEBsRetido VALID
#REGION 2
RETURN

FUNCTION ant0613NEBsRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, ;
	           LNBsBrRetido,Notaite_PK,;
	           PrmPrdtOrigem
	
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Normal ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite
	

	PRIVATE LNipi, LNicms

	PRIVATE LNBsRetido

	PRIVATE LSufOrigem, LSufDestino

	LNBsRetido  = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()



	IF (ARQ_empresa+ARQ_notaent+ ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")

		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaite
	GO Notaite_PK


	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)


    *----------------------------------------------------------*
    * NAO ATUALIZAR O IVA SE O IVA FOR INFORMADO OU SE A ENTRADA
    * JA ESTIVER PROCESSADA
    *----------------------------------------------------------*
	IF (           &ALS_notaent .informaiva  = "S" ;
	      OR LEFT( &ALS_notaent .situacao,1) = "C" ;
	   ) ;
	   OR ;
	   (  DATE() - &ALS_notaent .data > 10 AND &ALS_notaite .IVA > 0)
		LNiva= 	&ALS_notaite .IVA
	ELSE

		=W_DEFPROC("TRIBUTAR.spr")

		LNiva= TRGet_IVA( LSufOrigem  ,LScod, LSufDestino, ;
		         &ALS_notaent .data , PrmPrdtOrigem)

	ENDIF



	*************************************************************


	IF &ALS_notaent .icms_subs	> 0


****	IF (LNtpmercad = 2 or LNtpmercad = 8) AND LNiva > 0

        IF &ALS_notaite .CST $ "1/2/7"

			LNBsRetido   = (LNBsBrRetido) * LNiva

		ENDIF
	ENDIF


*	LNBsRetido = ROUND(LNBsRetido,2)

	*----------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsRetido)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYTZ           antNEClcRetido VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   49  
*        Variable:            antNEClcRetido                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      63                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsytz     &&  antNEClcRetido VALID
#REGION 2
RETURN

FUNCTION antNEClcRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNicms, LNbaseRetido,;
	        LNicmssoper,Notaite_PK,PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite
	


	PRIVATE LNretido
	PRIVATE LNaliq_icms

	PRIVATE LSufOrigem, LSufDestino

	LSalias			= ALIAS()


    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()



	IF (ARQ_empresa+ARQ_notaent +ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
	
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaite
	GO Notaite_PK

	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	*************************************************************



	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)

	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)


    *----------------------------------------------------------*
    * NAO ATUALIZAR O IVA SE O IVA FOR INFORMADO OU SE A ENTRADA
    * JA ESTIVER PROCESSADA
    *----------------------------------------------------------*
	IF (           &ALS_notaent .informaiva  = "S" ;
	      OR LEFT( &ALS_notaent .situacao,1) = "C" ;
	   ) ;
	   OR ;
	   (  DATE() - &ALS_notaent .data > 10 AND &ALS_notaite .IVA > 0)
		LNiva= 	&ALS_notaite .IVA
	ELSE

		=W_DEFPROC("TRIBUTAR.spr")
		LNiva= TRGet_IVA( LSufOrigem  ,LScod, LSufDestino, ;
		         &ALS_notaent .data , PrmPrdtOrigem )
	ENDIF


	LNretido   = 0
	
	IF &ALS_notaent .icms_subs	> 0

*****   IF (LNtpmercad = 2 or LNtpmercad = 8) AND LNiva > 0

        IF &ALS_notaite .CST $ "1/2/7"


			LNretido   = LNbaseRetido * 0.17
			LNretido   = LNretido - LNicms     && - LNicmssoper

		ENDIF
	ENDIF
	*----------------------------------------------------------*

	LNRetido = ROUND(LNRetido,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNretido)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYU2           antNEBsEntBrRetido VALID           
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   50  
*        Variable:            antNEBsEntBrRetido                 
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      64                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyu2     &&  antNEBsEntBrRetido VALID
#REGION 2
RETURN

FUNCTION antNEBsEntBrRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNvlrMercadoria, LNipi, ;
	             LNCustoIndireto,Notaite_PK, PrmPrdtOrigem

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Bruta ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite

	PRIVATE LNicms
	PRIVATE LSufOrigem, LSufDestino

	PRIVATE LNBsBrRetido

	LNBsBrRetido = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()


	IF (ARQ_empresa+ARQ_notaen+ ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaite
	GO Notaite_PK



	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp



	=W_DEFPROC("TRIBUTAR.spr")
	LNOriTpmercad	= TRDef_RgTrbMercad(  &ALS_notaent .uf  ,LScod)

	=W_DEFPROC("TRIBUTAR.spr")
	LNDstTpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)


	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)




    *----------------------------------------------------------*
    * NAO ATUALIZAR O IVA SE O IVA FOR INFORMADO OU SE A ENTRADA
    * JA ESTIVER PROCESSADA
    *----------------------------------------------------------*
	IF (           &ALS_notaent .informaiva  = "S" ;
	      OR LEFT( &ALS_notaent .situacao,1) = "C" ;
	   ) ;
	   OR ;
	   (  DATE() - &ALS_notaent .data > 10 AND &ALS_notaite .IVA > 0)
		LNiva= 	&ALS_notaite .IVA
	ELSE

		=W_DEFPROC("TRIBUTAR.spr")
		LNiva= TRGet_IVA( LSufOrigem  ,LScod, LSufDestino, ;
		         &ALS_notaent .data , PrmPrdtOrigem)
	ENDIF


	*************************************************************


	LNBsBrRetido   = 0
	

	IF &ALS_notaent .icmsentsub	> 0

		*-------------------------------------------------------------*


		IF LNOriTpmercad <> 2 AND LNDstTpmercad = 2 AND LNiva > 0

			DO CASE
				


				CASE &ALS_notaent .reduc_icms > 0
						LNBsBrRetido  = (LNvlrMercadoria + LNipi) ;
			                * &ALS_notaent .reduc_icms


				CASE &ALS_notaent .reduc_icms = 0

					if &ALS_notaent .data >= {01.11.2006}
						DO CASE
							CASE &ALS_notaent .codforn = 1
								LNBsBrRetido    = ;
									(LNvlrMercadoria + LNipi)-;
									((LNvlrMercadoria)*0.049)

							CASE &ALS_notaent .codforn = 2
								LNBsBrRetido    = ;
									(LNvlrMercadoria + LNipi)-;
									((LNvlrMercadoria)*0.0519)
						
							OTHERWISE
								LNBsBrRetido   = (LNvlrMercadoria + LNipi)
						ENDCASE

					ELSE
						if &ALS_notaent .codforn = 1
							LNBsBrRetido    = (LNvlrMercadoria + LNipi)-;
								((LNvlrMercadoria + LNipi)*0.049)
						ELSE	
							LNBsBrRetido   = (LNvlrMercadoria + LNipi)
						ENDIF
					ENDIF
			ENDCASE

			LNBsBrRetido = LNBsBrRetido + LNCustoIndireto

		ENDIF
	ENDIF

	
	
	*----------------------------------------------------------*

	LNBsBrRetido = LNBsBrRetido

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsBrRetido)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYU5           antNEBsEntRetido VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   51  
*        Variable:            antNEBsEntRetido                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      65                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyu5     &&  antNEBsEntRetido VALID
#REGION 2
RETURN

FUNCTION antNEBsEntRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNBsBrRetido,;
	   Notaite_PK, PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor da Base Normal ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite

	PRIVATE LNipi, LNicms

	PRIVATE LNBsRetido
	PRIVATE LSufOrigem, LSufDestino

	LNBsRetido  = 0

	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*

	SELE &ALS_notaite
	GO Notaite_PK



	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)


	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)


    *----------------------------------------------------------*
    * NAO ATUALIZAR O IVA SE O IVA FOR INFORMADO OU SE A ENTRADA
    * JA ESTIVER PROCESSADA
    *----------------------------------------------------------*
	IF (           &ALS_notaent .informaiva  = "S" ;
	      OR LEFT( &ALS_notaent .situacao,1) = "C" ;
	   ) ;
	   OR ;
	   (  DATE() - &ALS_notaent .data > 10 AND &ALS_notaite .IVA > 0)
		LNiva= 	&ALS_notaite .IVA
	ELSE

		=W_DEFPROC("TRIBUTAR.spr")
		LNiva= TRGet_IVA( LSufOrigem  ,LScod, LSufDestino, ;
		         &ALS_notaent .data, PrmPrdtOrigem )
	ENDIF


	*************************************************************


	IF &ALS_notaent .icmsentsubs	> 0
		IF LNtpmercad = 2 AND LNiva > 0
			LNBsRetido   = (LNBsBrRetido) * LNiva
		ENDIF
	ENDIF


	*----------------------------------------------------------*
*	LNBsRetido = ROUND(LNBsRetido,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNBsRetido)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYU8           antNEClcEntRetido VALID            
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAENTA,     Record Number:   52  
*        Variable:            antNEClcEntRetido                  
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      66                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyu8     &&  antNEClcEntRetido VALID
#REGION 2
RETURN

FUNCTION antNEClcEntRetido
	PARAMETERS LNemp,LNboletim,LNforn, LScod, LNicms, LNbaseRetido,;
	   LNicmssoper,Notaite_PK, PrmPrdtOrigem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Calcular o Valor ICMS RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*


	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_notaent    , ALS_notaent
	PRIVATE ARQ_notaite    , ALS_notaite

	PRIVATE LSufOrigem, LSufDestino


	PRIVATE LNretido
	PRIVATE LNaliq_icms


	LSalias			= ALIAS()


    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_notaent  = NetArqAgain("NOTAENT")
    ALS_notaent  = Alias()

    ARQ_notaite  = NetArqAgain("NOTAITE")
    ALS_notaite  = Alias()


	IF (ARQ_empresa+ARQ_notaent+ARQ_notaite) > 100000
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_notaent")
        =up_fecha("&ALS_notaite")
	
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*--------------------------------------------------------------------*
	*--------------------------------------------------------------------*
	SELE &ALS_notaite
	GO Notaite_PK

	SELE &ALS_notaent
	SET ORDER TO TAG boletim
	SEEK STR(LNemp,3)+STR(LNboletim,6)+STR(LNforn,5)


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp


	*************************************************************


	=W_DEFPROC("TRIBUTAR.spr")
	LNtpmercad	= TRDef_RgTrbMercad(  &ALS_empresa .estado  ,LScod)



	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LNemp,LNboletim,LNforn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LNemp,LNboletim,LNforn)




    *----------------------------------------------------------*
    * NAO ATUALIZAR O IVA SE O IVA FOR INFORMADO OU SE A ENTRADA
    * JA ESTIVER PROCESSADA
    *----------------------------------------------------------*
	IF (           &ALS_notaent .informaiva  = "S" ;
	      OR LEFT( &ALS_notaent .situacao,1) = "C" ;
	   ) ;
	   OR ;
	   (  DATE() - &ALS_notaent .data > 10 AND &ALS_notaite .IVA > 0)
		LNiva= 	&ALS_notaite .IVA
	ELSE

		=W_DEFPROC("TRIBUTAR.spr")
		LNiva= TRGet_IVA( LSufOrigem  ,LScod, LSufDestino, ;
		         &ALS_notaent .data,  PrmPrdtOrigem )
	ENDIF


	
	LNretido   = 0
	
	IF &ALS_notaent .icmsentsubs	> 0
		IF LNtpmercad = 2 AND LNiva > 0


			LNretido   = LNbaseRetido * 0.17
			LNretido   = LNretido - LNicms     && - LNicmssoper


		ENDIF
	ENDIF
	*----------------------------------------------------------*

	LNRetido = ROUND(LNRetido,2)

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_notaent")
    =up_fecha("&ALS_notaite")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNretido)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUA           IETeste VALID                      
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:    5   
*        Variable:            IETeste                            
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      67                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyua     &&  IETeste VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IETeste
PARAMETERS PrmTeste
	A=IECreate()

	DO CASE
	   CASE UPPER(PrmTeste) = "IEFIND"
		   	=IESetPropVT("EMPRESA", 1)
			=IESetPropVT("FAVORECIDO", 126646)
			=IESetPropVT("ORCAMENTO", 111111)
			=IESetPropVT("ORDEM", 1)
		    =IEFind()
	ENDCASE
	
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUB           IEVerifyInst VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:    6   
*        Variable:            IEVerifyInst                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      68                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyub     &&  IEVerifyInst VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEVerifyInst
PRIVATE LSpath


	=W_DEFPROC("rotinas.spr")

	IF TYPE("IEDefnPath") = "U" OR EMPTY(IEDefnPath)
		LSpath = UPobterPath("NOTAITE")
	ELSE
		LSpath = IEDefnPath  && QUANDO SE QUER DIRECIONAR O PATH
		                     && INDEPENDENTE DOS PARAMETRO DE
		                     && DIRETORIOS COMUNS
	ENDIF


	IF TYPE("PBNotaIteAlias") = "U" ;
	   		OR EMPTY(PBNotaIteAlias) ;
	   		OR !USED(PBNotaIteAlias)
		=IECreate()
	ELSE
		IF !(LSPath $ DBF(PBNotaIteAlias)) && HOUVE MUDANCA DE DIR BASE
			=IEDestroi()				   && ELIMINA INSTACIA DE OUTRA BASE
			=IECreate()					   && CRIA INSTANCIA NA NOVA BASE
		ENDIF
	ENDIF
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUC           IECreate VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:    7   
*        Variable:            IECreate                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      69                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyuc     &&  IECreate VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IECreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()

	IF TYPE("PBNotaIteAlias") <> "U" ;
	   		AND !EMPTY(PBNotaIteAlias) ;
	   		AND USED(PBNotaIteAlias)
			RETURN(.T.)
	ENDIF
	

	IF TYPE("IEDefnPath") = "U" OR EMPTY(IEDefnPath)
		LSpath = UPobterPath("NOTAITE")
	ELSE
		LSpath = IEDefnPath  && QUANDO SE QUER DIRECIONAR O PATH
		                     && INDEPENDENTE DOS PARAMETRO DE
		                     && DIRETORIOS COMUNS
	ENDIF



	PUBLIC PBNotaIteAlias

	IF USED("NOTAITE")
	     =NetArqAgain(LSpath+"notaite")
	     PBNotaIteAlias     = Alias()
	ELSE
	     =NetArqAgain(LSpath+"notaite")
	     LSAlsTmp     = Alias()
	
	     =NetArqAgain(LSpath+"notaite")
	     PBNotaIteAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBNotaIteAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTNOTAITE[LMaxDim]
    PUBLIC DIMENSION VDNOTAITE[10,3]			&& VETOR PARA PROPRIEDADES
	*-----------------------------------------------------------*
	=IEReadProperty()
	=IESetDerivadas()   && carga dos calculos derivados
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUE           IEDestroi VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:    8   
*        Variable:            IEDestroi                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      70                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyue     &&  IEDestroi VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEDestroi
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBNotaIteAlias) AND USED(PBNotaIteAlias)
		SELECT &PBNotaIteAlias
		USE
	ENDIF	
	RELEASE PBNotaIteAlias
    RELEASE VTNotaIte
    RELEASE VDNotaIte

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUF           IEReadProp VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:    9   
*        Variable:            IEReadProp                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      71                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyuf     &&  IEReadProp VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=IEVerifyInst()

	SELE &PBNotaIteAlias
	SCATTER TO VTNotaite
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUG           IESetDerivadas VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   10   
*        Variable:            IESetDerivadas                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      72                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyug     &&  IESetDerivadas VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IESetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

	=IEVerifyInst()
	*--------------------------------------------------------------*

    VDNotaIte(1,1) = UPPER("IEclcIcmSOper")
   	VDNotaIte(1,2) = .F.
   	VDNotaIte(1,3) = .F.

    VDNotaIte(2,1) = "CUSTO"
   	VDNotaIte(2,2) = 0
   	VDNotaIte(2,3) = .F.

    VDNotaIte(3,1) = UPPER("IEcalcIcmNormal")
   	VDNotaIte(3,2) = .F.
   	VDNotaIte(3,3) = .F.

    VDNotaIte(4,1) = UPPER("IEcalcIcmSubs")
   	VDNotaIte(4,2) = .F.
   	VDNotaIte(4,3) = .F.

    VDNotaIte(5,1) = UPPER("IECalcCusto")
   	VDNotaIte(5,2) = .F.
   	VDNotaIte(5,3) = .F.


    VDNotaIte(6,1) = UPPER("VLR_PIS")
   	VDNotaIte(6,2) = 0
   	VDNotaIte(6,3) = .F.

    VDNotaIte(7,1) = UPPER("VLR_COFINS")
   	VDNotaIte(7,2) = 0
   	VDNotaIte(7,3) = .F.

    VDNotaIte(8,1) = UPPER("IECalcPIS")
   	VDNotaIte(8,2) = .F.
   	VDNotaIte(8,3) = .F.

    VDNotaIte(9,1) = UPPER("IECalcCOFINS")
   	VDNotaIte(9,2) = .F.
   	VDNotaIte(9,3) = .F.

	*----------------------------------------------------------------*
	=IECalcIcmNormal()
	=IEclcIcmSOper()
	=IECalcIcmSubs()
	=IECalcPIS()
	=IECalcCOFINS()
	=IECalcCusto()

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUH           IESetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   11   
*        Variable:            IESetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      73                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyuh     &&  IESetPropVT VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IESetPropVT
PARAMETER  PrmField, PrmValue

	PRIVATE Lvalue
	=IEVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,PrmValue,;
						    PBNotaIteAlias,VTNotaIte,VDNotaIte)

RETURN(Lvalue)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUI           IEGetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   12   
*        Variable:            IEGetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      74                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyui     &&  IEGetPropVT VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEGetPropVT
PARAMETER  PrmField
	PRIVATE Lvalue

	=IEVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,PBNotaIteAlias,VTNotaIte,VDNotaIte)

RETURN(Lvalue)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUJ           IEChk_Identidade VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   13   
*        Variable:            IEChk_Identidade                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      75                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyuj     &&  IEChk_Identidade VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION IEChk_Identidade
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn
	
	=IEVerifyInst()
	*----------------------------------------------------------------*
*	IF ;
*	   !FOUND(PBNotaiteAlias) OR ;
*	   PrmEmp 		 <> IEGetPropVT("EMPRESA") OR ;
*	   PrmBoletim 	 <> IEGetPropVT("ORCAMENTO") OR ;
*	   PrmFavorecido <> IEGetPropVT("FAVORECIDO") OR ;
*	   PrmOrdem   	 <> IEGetPropVT("ORDEM")
	    =IESetPropVT("EMPRESA",PrmEmp)
	    =IESetPropVT("ORCAMENTO",PrmBoletim)
	    =IESetPropVT("FAVORECIDO",PrmFavorecido)
	    =IESetPropVT("ORDEM",PrmOrdem)
		=IEFind()
*	ENDIF
RETURN(.t.)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUK           IE_Refresh VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   14   
*        Variable:            IE_Refresh                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      76                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyuk     &&  IE_Refresh VALID
#REGION 3
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION IE_Refresh
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn
	
	=IEVerifyInst()
	*----------------------------------------------------------------*
    =IESetPropVT("EMPRESA",PrmEmp)
    =IESetPropVT("ORCAMENTO",PrmBoletim)
    =IESetPropVT("FAVORECIDO",PrmFavorecido)
    =IESetPropVT("ORDEM",PrmOrdem)
	=IEFind()
RETURN(.t.)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUL           IEFind VALID                       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   15   
*        Variable:            IEFind                             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      77                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyul     &&  IEFind VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEFind
	PRIVATE LEmpresa, Lfavorecido, Lorcamento, Lordem
	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=IEVerifyInst()

	LEmpresa    = IEGetPropVT("Empresa")
	Lfavorecido = IEGetPropVT("Favorecido")
	LOrcamento  = IEGetPropVT("Orcamento")
	LOrdem      = IEGetPropVT("Ordem")



	SELE &PBNotaIteAlias
	SET ORDER TO TAG CHV_BKP
	SEEK STR(LEmpresa,3)+STR(LFavorecido,14)+STR(Lorcamento,6)+STR(Lordem,3)

	IF FOUND()
		=IEReadProperty()
		=IESetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUM           IEComandText VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   16   
*        Variable:            IEComandText                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      78                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyum     &&  IEComandText VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEComandText
PARAMETER PrmCommand

	PRIVATE LSalias
	LSalias		= 	ALIAS()
	=IEVerifyInst()
	*--------------------------------------------------------------*
	
	&PrmCommand

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUN           IECheq_Relacao VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   17   
*        Variable:            IECheq_Relacao                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      79                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyun     &&  IECheq_Relacao VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IECheq_Relacao

	PRIVATE Lempresa,Lfavorecido,Lorcamento
	PRIVATE Lretorno
	=W_DEFPROC("NOTAENT.spr")
	Lempresa    = NEGetPropVT("EMPRESA")

	=W_DEFPROC("NOTAENT.spr")
	Lfavorecido = NEGetPropVT("FAVORECIDO")

	=W_DEFPROC("NOTAENT.spr")
	Lorcamento  = NEGetPropVT("REFERENCIA")

	Lretorno = .t.
   	IF    Lempresa <> IEGetPropVT("EMPRESA") ;
   	   OR Lfavorecido <> IEGetPropVT("FAVORECIDO") ;
	   OR Lorcamento <>	IESetPropVT("ORCAMENTO")
		Lretorno = .f.
	endif
	
RETURN(Lretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUO           IEcalcicmNormal VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   18   
*        Variable:            IEcalcicmNormal                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      80                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyuo     &&  IEcalcicmNormal VALID
#REGION 3
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION Ubsicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRIO :  -Calcula a Base ICMS NORMAL no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION IECalcIcmNormal

	IF IEGetPropVT("IECalcIcmNormal")  && rotina ja executada
		RETURN
	ENDIF	
	*-------------------------------------------------------------------*						

	PRIVATE  	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn,;
				LNbsbr_Icms,;
				LNaliq_Rdu,;
				LNbase_Icms,;
				LNicms,;
				LNbsbr_SOIcms,;
				LNbase_SOIcms,;
				LNSOicms

	PRIVATE  LPrmEmpresa
	PRIVATE  LPrmBoletim
	PRIVATE  LPrmForn
	PRIVATE  LNBCIcmsCapa				
	PRIVATE  LNIcmsCapa				


	PRIVATE  LNPrdtOrigem



	PRIVATE LDdata
	PRIVATE LSufOrigem
	PRIVATE LSufDestino
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples
	PRIVATE LSch_desti

	PRIVATE LNIcmsRtdCapa

	LNbsbr_Icms		= 0.00
	LNbase_Icms		= 0.00
	LNicms			= 0.00
	LNaliq_Rdu      = 100
	LNIcmsRtdCapa   = 0

	LNBCIcmsCapa    = 0				
	LNIcmsCapa      = 0	


				
	LSProduto       = IEGetPropVT("CODIGO")

    LNPrdtOrigem    = IEGetPropVT("ORIGEM")

	LDdata           = IEGetPropVT("DATA")
	LNvlrMercadoria  = IEGetPropVT("VLRVENDA")
	LNvlrIPI		 = IEGetPropVT("VLRIPI")
	LNcdg_Forn  	 = IEGetPropVT("CODFORN")
	LSch_desti  	 = IEGetPropVT("CH_DESTI")

	LPrmEmpresa		= IEGetPropVT("EMPRESA")
	LPrmBoletim		= IEGetPropVT("ORCAMENTO")



	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)



	=W_DEFPROC("notaent.spr")
	LNIcmsCapa = ;
		 NEGetFieldValue(LPrmEmpresa,LPrmBoletim,LNcdg_Forn,"VLR_ICMS")


	=W_DEFPROC("notaent.spr")
	LNBCIcmsCapa = ;
		 NEGetFieldValue(LPrmEmpresa,LPrmBoletim,LNcdg_Forn,"BASE_ICMS")

    *----------------------------------------------*
    * REGRA INSERIDA EM 29/11/2011 - TRATAR ICMS RETIDO PARA DEF ICMS NORMAL
    *----------------------------------------------*
	=W_DEFPROC("notaent.spr")
	LNIcmsRtdCapa = ;
		 NEGetFieldValue(LPrmEmpresa,LPrmBoletim,LNcdg_Forn,"ICMS_SUBS")

	*--------------------------------------------------------*
	=W_DEFPROC("forneced.spr")
	LNRgFiscFornecedor = FRrgm_Fisc(LNcdg_Forn)


	DO CASE

		CASE LSch_desti   = "3" && INTERNACIONAL
			=W_DEFPROC("tributar.spr")
			LNicmsOrigem    =	TRAlqIcmInUF(LSufDestino) && Aliq Interna
		
    	CASE LSufOrigem = LSufDestino
			=W_DEFPROC("tributar.spr")
			LNicmsOrigem    =	TRAlqIcmInUF(LSufOrigem) && Aliquota Interna
    	OTHERWISE
			=W_DEFPROC("tributar.spr")
			LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem, LNPrdtOrigem)
			                         && Aliquota Externa
	ENDCASE




	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbOrigem=TRDef_RgTrbMercad(LSufOrigem, LSproduto)

	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbDestino=TRDef_RgTrbMercad(LSufDestino, LSproduto)



	*----------------------------------------------------------*
	*                  COMPOSICAO DA REGRA                     *
	*----------------------------------------------------------*

    *----------------------------------------------------------*
    * REGRA APLICADA ANTES DE 12/05/2005
    * Alterada em fun눯o da informa눯o dos indices de redu눯o
    * no proprio corpo na NFE em fun눯o de acordos TARE
    *----------------------------------------------------------*
	

    *----------------------------------------------------------*
    * REGRA APLICADA APOS 12/05/2005
    * Alterada em fun눯o da informa눯o dos indices de redu눯o
    * no proprio corpo na NFE em fun눯o de acordos TARE
    *----------------------------------------------------------*


	LNbsbr_Icms = IEGetPropVT("BSBR_ICMS")

 	LNbase_Icms = IEGetPropVT("BASE_CALC")

	LNaliq_Rdu = IEGetPropVT("ALIQ_RDU")
    *----------------------------------------------------------*
*	IF LNRgTrbDestino = 1 AND LNRgFiscFornecedor = 0  && ICMS NORMAL

	IF LNIcmsCapa > 0 OR LNBCIcmsCapa > 0 OR LNIcmsRtdCapa > 0

	    LNicms = 0.00
    	LNicms =  LNbase_Icms * LNicmsOrigem/100
		*---> Define Icms Sobre Normal
	    LNicms =  LNbase_Icms * LNicmsOrigem/100

	ENDIF



	=IESetPropVT("BSBR_ICMS",LNbsbr_Icms)
	=IESetPropVT("ALIQ_RDU",LNaliq_Rdu)
	=IESetPropVT("BASE_CALC",LNbase_Icms)
	=IESetPropVT("VLR_ICMS", LNicms)
	=IESetPropVT("ALIQ_ICMS",LNicmsOrigem)


	=IESetPropVT("BSBRICMSO",LNbsbr_Icms)
	=IESetPropVT("BASEICMSO",LNbase_Icms)



    *----------------------------------------------------------*
    * REGRA APLICADA APOS 29/11/2011
    * Substituicao da regra que restringe por fornecedor por
    * regra geral que atende todas notas -
    *----------------------------------------------------------*
	*IF LNIcmsCapa > 0 AND ;
	*   ( LNcdg_Forn = 1 OR  LNcdg_Forn = 2 OR LNRgTrbDestino = 8)
    *----------------------------------------------------------*
*	IF LNIcmsRtdCapa > 0
*		=IESetPropVT("BSBRICMSO",LNbsbr_Icms)
*		=IESetPropVT("ALIQ_RDU",LNaliq_Rdu)
*		=IESetPropVT("BASEICMSO",LNbase_Icms)
*		=IESetPropVT("ICMSSOPER", LNicms)
*		=IESetPropVT("ALIQ_ICMS",LNicmsOrigem)
*
*
*		=IESetPropVT("BSBR_ICMS",0.00)
*		=IESetPropVT("BASE_CALC",0.00)
*		=IESetPropVT("VLR_ICMS", 0.00)
*
*	ELSE
		=IESetPropVT("BSBR_ICMS",LNbsbr_Icms)
		=IESetPropVT("ALIQ_RDU",LNaliq_Rdu)
		=IESetPropVT("BASE_CALC",LNbase_Icms)
		=IESetPropVT("VLR_ICMS", LNicms)
		=IESetPropVT("ALIQ_ICMS",LNicmsOrigem)

*	ENDIF	
	*----------------------------------------------------------------*
	=IESetPropVT("IECalcIcmNormal",.T.)  && rotina com valores atuais
RETURN(LNbase_Icms)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUR           IEclcIcmSOper VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   19   
*        Variable:            IEclcIcmSOper                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      81                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyur     &&  IEclcIcmSOper VALID
#REGION 3
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION Ubsicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRIO :  -Calcula a Base ICMS SOBRE OPERACAO no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION IEclcIcmSOper

	IF IEGetPropVT("IEclcIcmSOper")  && rotina ja executada
		RETURN
	ENDIF	
	*-------------------------------------------------------------------*						

	PRIVATE  	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn,;
				LNbsbr_Icms,;
				LNaliq_Rdu,;
				LNbase_Icms,;
				LNicms,;
				LNbsbr_SOIcms,;
				LNbase_SOIcms,;
				LNSOicms

	PRIVATE  LPrmEmpresa
	PRIVATE  LPrmBoletim
	PRIVATE  LPrmForn
	PRIVATE  LNIcmsSoCapa				
	PRIVATE  LNIcmsCapa				
	PRIVATE  LNBCIcmsCapa				

	PRIVATE  LNPrdtOrigem


	PRIVATE LDdata
	PRIVATE LSufOrigem
	PRIVATE LSufDestino
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples


	PRIVATE LNIcmsRtdCapa

	LNbsbr_SOIcms   = 0.00
	LNbase_SOIcms   = 0.00
	LNSOicms        = 0.00
	LNIcmsRtdCapa   = 0
	LNIcmsCapa	    = 0
	LNBCIcmsCapa    = 0
	

				
	LSProduto  = IEGetPropVT("CODIGO")
	
    LNPrdtOrigem    = IEGetPropVT("ORIGEM")
	

	LDdata           = IEGetPropVT("DATA")
	LNvlrMercadoria  = IEGetPropVT("VLRVENDA")
	LNvlrIPI		 = IEGetPropVT("VLRIPI")
	LNcdg_Forn  	 = IEGetPropVT("CODFORN")

	LPrmEmpresa		= IEGetPropVT("EMPRESA")
	LPrmBoletim		= IEGetPropVT("ORCAMENTO")


	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)

	*--------------------------------------------------------*
	=W_DEFPROC("forneced.spr")
	LNRgFiscFornecedor = FRrgm_Fisc(LNcdg_Forn)



	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbOrigem=TRDef_RgTrbMercad(LSufOrigem, LSproduto)

	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbDestino=TRDef_RgTrbMercad(LSufDestino, LSproduto)


	DO CASE
    	CASE LNRgTrbDestino = 8  && IMPORTADA
			=W_DEFPROC("tributar.spr")
			LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) && Aliquota Interna
    	CASE LSufOrigem = LSufDestino
			=W_DEFPROC("tributar.spr")
			LNicmsOrigem    =	TRAlqIcmInUF(LSufOrigem) && Aliquota Interna
		OTHERWISE
			=W_DEFPROC("tributar.spr")
			LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem, LNPrdtOrigem)
			                  && Aliquota Externa
    ENDCASE


	=W_DEFPROC("notaent.spr")
	LNIcmsCapa = ;
		 NEGetFieldValue(LPrmEmpresa,LPrmBoletim,LNcdg_Forn,"VLR_ICMS")

	=W_DEFPROC("notaent.spr")
	LNIcmsSoCapa = ;
		 NEGetFieldValue(LPrmEmpresa,LPrmBoletim,LNcdg_Forn,"ICMSSOPER")



    *----------------------------------------------*
    * REGRA INSERIDA EM 29/11/2011 - TRATAR ICMS RETIDO PARA DEF ICMS NORMAL
    *----------------------------------------------*
	=W_DEFPROC("notaent.spr")
	LNIcmsRtdCapa = ;
		 NEGetFieldValue(LPrmEmpresa,LPrmBoletim,LNcdg_Forn,"ICMS_SUBS")



	*----------------------------------------------------------*
	*                  COMPOSICAO DA REGRA                     *
	*----------------------------------------------------------*

    *----------------------------------------------------------*
    * REGRA APLICADA ANTES DE 12/05/2005
    * Alterada em fun눯o da informa눯o dos indices de redu눯o
    * no proprio corpo na NFE em fun눯o de acordos TARE
    *----------------------------------------------------------*
	

    *----------------------------------------------------------*
    * REGRA APLICADA APOS 12/05/2005
    * Alterada em fun눯o da informa눯o dos indices de redu눯o
    * no proprio corpo na NFE em fun눯o de acordos TARE
    *----------------------------------------------------------*


	LNbsbr_SOIcms = IEGetPropVT("BSBRICMSO")

 	LNbase_SOIcms = IEGetPropVT("BASEICMSO")

	LNaliq_Rdu = IEGetPropVT("ALIQ_RDU")
    *----------------------------------------------------------*

    *----------------------------------------------------------*
    * REGRA APLICADA APOS 29/11/2011
    * Substituicao da regra que restringe por fornecedor por
    * regra geral que atende todas notas -
    *----------------------------------------------------------*
	*IF LNIcmsCapa > 0 AND ;
	*   ( LNcdg_Forn = 1 OR  LNcdg_Forn = 2 OR LNRgTrbDestino = 8)
    *----------------------------------------------------------*
	*IF LNIcmsRtdCapa > 0
	*	LNSOicms = IEGetPropVT("ICMSSOPER")
	*ELSE
	*	IF LNIcmsSoCapa > 0
	*	    LNSOicms = 0.00
    *		LNSOicms =  LNbase_SOIcms * LNicmsOrigem/100
	*	ENDIF
	*ENDIF
    *----------------------------------------------------------*


	IF LNIcmsRtdCapa > 0
	    LNSOicms = 0.00
   		LNSOicms =  LNbase_SOIcms * LNicmsOrigem/100
	ENDIF

	=IESetPropVT("ICMSSOPER",LNSOicms)

	*----------------------------------------------------------------*

	=IESetPropVT("IEclcIcmSOper",.T.)  && rotina com valores atuais

RETURN(LNSOicms)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUT           IEcalcIcmSubs VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   20   
*        Variable:            IEcalcIcmSubs                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      82                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyut     &&  IEcalcIcmSubs VALID
#REGION 3
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION IECalcIcmSubs
	*-------------------------------------------------------------------*						
	*  DESCRIO :  -Calcula a Base ICMS Retido no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION IECalcIcmSubs
	IF IEGetPropVT("IECalcIcmSubs")  && rotina ja executada
		RETURN
	ENDIF	
	*----------------------------------------------------------------*
	
	PRIVATE  	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn,;
				LNbsbr_Icms,;
				LNaliq_Rdu,;
				LNbase_Icms,;
				LNicms,;
				LNbsbr_SOIcms,;
				LNbase_SOIcms,;
				LNicmsSO,;
				LNbsbr_Retido,;
				LNbase_Retido,;
				LNiva,;
				LNicmsRtdSaida,;
				LNicmsRtdEntrada


	PRIVATE  LNPrdtOrigem



	PRIVATE LDdata
	PRIVATE LSufOrigem
	PRIVATE LSufDestino
	PRIVATE LNRetidoDestacado
	PRIVATE LNicmsDestino
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples

				
	LSProduto  = IEGetPropVT("CODIGO")

    LNPrdtOrigem    = IEGetPropVT("ORIGEM")


	LDdata           = IEGetPropVT("DATA")
	LNvlrMercadoria  = IEGetPropVT("VLRVENDA")
	LNvlrIPI		 = IEGetPropVT("VLRIPI")
	LNcdg_Forn  	 = IEGetPropVT("CODFORN")


	LNicms		  	 = IEGetPropVT("VLR_ICMS")


	LNbsbr_SOIcms    = IEGetPropVT("BSBRICMSO")
	LNbase_SOIcms    = IEGetPropVT("BASEICMSO")
	LNicmsSO	  	 = IEGetPropVT("ICMSSOPER")



	LPrmEmpresa		= IEGetPropVT("EMPRESA")
	LPrmBoletim		= IEGetPropVT("ORCAMENTO")

	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)


	=W_DEFPROC("notaent.spr")
	LNRetidoDestacado = ;
	    NEGetRetidoDestacado(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)
	*-----------------------------------------------------------------*

	=W_DEFPROC("tributar.spr")
	LNicmsOrigem	=	TRAlqIcmOuUF(LSufOrigem, LNPrdtOrigem) &&


	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmInUF(LSufDestino) &&


	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbOrigem=TRDef_RgTrbMercad(LSufOrigem, LSproduto)


	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbDestino=TRDef_RgTrbMercad(LSufDestino, LSproduto)



	=W_DEFPROC("TRIBUTAR.spr")
	LNiva= TRGet_IVA(LSufOrigem,LSproduto,LSufDestino,LDdata )


	LNbsbr_Icms = 	IEGetPropVT("BSBR_ICMS")

	*----------------------------------------------------------*
	*                  COMPOSICAO DA REGRA                     *
	*----------------------------------------------------------*
	LNbsbr_Retido   	= IEGetPropVT("BASE_SBBRT")
	LNbase_Retido   	= IEGetPropVT("BASE_SUBS")
	LNbsbrEntRetido   	= IEGetPropVT("BSENTSBBRT")
	LNbaseEntRetido   	= IEGetPropVT("BSENTSUBS")

	LNicmsRtdSaida		= 0.00
	LNicmsRtdEntrada	= 0.00


	*--------------------------------------------------------------*
	*--------------  CALCULO DO ICMS RETIDO NA SAIDA --------------*
	*--------------------------------------------------------------*



	*--------------------------------------------------------------*
	*--------------  CALCULO DO ICMS RETIDO NA SAIDA --------------*
	*--------------------------------------------------------------*

	DO CASE
		CASE LNRgTrbOrigem = 8 && IMPORTADA COM RETENCAO

			  		LNicmsRtdSaida =  ;
	  			       (LNbase_Retido * LNicmsDestino/100) ;
	  			       - LNicms && - LNicmsSO

		CASE LNRgTrbOrigem = 2 ;
			     AND  LNRgTrbDestino = 2  && RETIDO NA SAIDA

			  		LNicmsRtdSaida =  ;
	  			       (LNbase_Retido * LNicmsDestino/100) ;
	  			       - LNicms && - LNicmsSO

		CASE LNRgTrbOrigem = 1 ;
			     AND  LNRgTrbDestino = 2  && RETIDO NA ENTRADA

		  			LNicmsRtdEntrada = ;
	  		        (LNbaseEntRetido * LNicmsDestino/100) ;
	  		        - LNicms  && - LNicmsSO
	ENDCASE




	IF LNicmsRtdSaida > 0.00
		=IESetPropVT("BASE_SBBRT",LNbsbr_Retido)
		=IESetPropVT("BASE_SUBS",LNbase_Retido)
		=IESetPropVT("ICMS_SUBS",LNicmsRtdSaida)

		=IESetPropVT("BSENTSBBRT",0.00)
		=IESetPropVT("BSENTSUBS",0.00)
		=IESetPropVT("ICMSENTSUB",0.00)


	ELSE
		=IESetPropVT("BASE_SBBRT",0.00)
		=IESetPropVT("BASE_SUBS",0.00)
		=IESetPropVT("ICMS_SUBS",0.00)


		=IESetPropVT("BSENTSBBRT",LNbsbrEntRetido)
		=IESetPropVT("BSENTSUBS",LNbaseEntRetido)
		=IESetPropVT("ICMSENTSUB",LNicmsRtdEntrada)
	ENDIF

	*----------------------------------------------------------------*
	=IESetPropVT("IECalcIcmSubs",.T.)  && rotina com valores atuais


RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUX           IECalcCusto VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   21   
*        Variable:            IECalcCusto                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      83                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyux     &&  IECalcCusto VALID
#REGION 3
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION IECalcCusto
	*-------------------------------------------------------------------*						
	*  DESCRIO :  -Calcula o Custo do Produto na Operacao
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION IECalcCusto
	IF IEGetPropVT("IECalcCusto")  && rotina ja executada
		RETURN
	ENDIF	
	*----------------------------------------------------------------*


	PRIVATE  	LDdata,;
				LNEmpresa,;
				LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNicms,;
				LNicmsSobreOperacao,;
				LNCusto_Ind,;
				LNicmsRtdSaida,;
				LNicmsRtdEntrada,;
				LNcusto,;
				LNtp_Mercard,;
				LNvlrPIS,;
				LNvlrCOFINS
				

	LDdata	   	 	    = IEGetPropVT("DATA")
	LNEmpresa		 	= IEGetPropVT("EMPRESA")
	LNvlrMercadoria  	= IEGetPropVT("VLRVENDA")
	LNvlrIPI		 	= IEGetPropVT("VLRIPI")
	LNicms		  	 	= IEGetPropVT("VLR_ICMS")
	LNicmsSobreOperacao	= IEGetPropVT("ICMSSOPER")
	LNCusto_Ind  	 	= IEGetPropVT("CUSTO_IND")
	LNicmsRtdSaida   	= IEGetPropVT("ICMS_SUBS")
    LNicmsRtdEntrada 	= IEGetPropVT("ICMSENTSUB")
    LNtp_Mercad      	= IEGetPropVT("TP_MERCAD")


	IF LNEmpresa = 10  AND LDdata >= CTOD("01.11.2007") ;
	    AND (LNtp_Mercad = 3 OR LNtp_Mercad = 7)
		LNvlrPIS		 	= IEGetPropVT("VLR_PIS")
		LNvlrCOFINS		 	= IEGetPropVT("VLR_COFINS")
	ELSE
		LNvlrPIS		 	= 0
		LNvlrCOFINS		 	= 0
	ENDIF
	

	LNcusto=IEformulaCusto(LNvlrMercadoria,;
						   LNvlrIPI,;
						   LNicms,;
						   LNicmsSobreOperacao,;
						   LNCusto_Ind,;
						   LNicmsRtdSaida,;
						   LNicmsRtdEntrada, ;
						   LNtp_Mercad,;
						   LNvlrPIS,;
						   LNvlrCOFINS)
	
	=IESetPropVT("CUSTO",LNcusto)

	*----------------------------------------------------------------*
	=IESetPropVT("IECalcCusto",.T.)  && rotina com valores atuais

RETURN


FUNCTION IFformulaCusto
PARAMETERS	LNvlrMercadoria,LNvlrIPI,LNicms,LNicmsSobreOperacao,;
	  LNCusto_Ind,LNicmsRtdSaida,LNicmsRtdEntrada, LNtp_Mercad ,;
	   LNvlrPIS, LNvlrCOFINS

	PRIVATE LNcusto

	DO CASE

		CASE  LNtp_Mercad = 8   && IMPORTADA COM RETENCAO TRIBUTADA
			
			LNcusto = LNvlrMercadoria + LNCusto_Ind+;
				 LNicmsRtdEntrada + LNicmsRtdSaida

		CASE  LNtp_Mercad = 1   && TRIBUTADA
			LNcusto = LNvlrMercadoria + LNvlrIPI + LNCusto_Ind+;
				 LNicmsRtdEntrada + LNicmsRtdSaida - LNicms

		OTHERWISE
			LNcusto = LNvlrMercadoria + LNvlrIPI + LNCusto_Ind+;
				 LNicmsRtdEntrada + LNicmsRtdSaida	

	ENDCASE

	LNcusto = LNcusto - (LNvlrPIS + LNvlrCOFINS)

RETURN(LNcusto)

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUY           IEGetCusto VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   22   
*        Variable:            IEGetCusto                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      84                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyuy     &&  IEGetCusto VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEGetCusto
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn
	*----------------------------------------------------------------*
	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IECalcCusto")  && rotina nao esta executada
		=IECalcCusto()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("CUSTO"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYUZ           IEGetBaseCalc VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   23   
*        Variable:            IEGetBaseCalc                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      85                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyuz     &&  IEGetBaseCalc VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEGetBaseCalc
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn
	*----------------------------------------------------------------*
	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmNormal")  && rotina nao esta executada
		=IEcalcIcmNormal()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("BASE_CALC"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYV0           IEGetBsIcmSO VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   24   
*        Variable:            IEGetBsIcmSO                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      86                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyv0     &&  IEGetBsIcmSO VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEGetBsIcmSO
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmNormal")  && rotina nao esta executada
		=IEcalcIcmNormal()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("BASEICMSO"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYV1           IEGetBsSbBrt VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   25   
*        Variable:            IEGetBsSbBrt                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      87                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyv1     &&  IEGetBsSbBrt VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEGetBsSbBrt
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmSubs")  && rotina nao esta executada
		=IEcalcIcmSubs()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("BASE_SBBRT"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYV2           IEGetBsSubs VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   26   
*        Variable:            IEGetBsSubs                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      88                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyv2     &&  IEGetBsSubs VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEGetBsSubs
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmSubs")  && rotina nao esta executada
		=IEcalcIcmSubs()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("BASE_SUBS"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYV3           IERtdoSaida VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   27   
*        Variable:            IERtdoSaida                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      89                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyv3     &&  IERtdoSaida VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IERtdoSaida
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmSubs")  && rotina nao esta executada
		=IEcalcIcmSubs()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("ICMS_SUBS"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYV4           IERtdoEntrada VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   28   
*        Variable:            IERtdoEntrada                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      90                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyv4     &&  IERtdoEntrada VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IERtdoEntrada
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmSubs")  && rotina nao esta executada
		=IEcalcIcmSubs()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("ICMSENTSUB"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYV5           IEicmNormal VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   29   
*        Variable:            IEicmNormal                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      91                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyv5     &&  IEicmNormal VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEicmNormal
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmNormal")  && rotina nao esta executada
		=IEcalcIcmNormal()
	ENDIF	
	*----------------------------------------------------------------*


RETURN(IEGetPropVT("VLR_ICMS"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYV6           IEicmsSO VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   30   
*        Variable:            IEicmsSO                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      92                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyv6     &&  IEicmsSO VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEicmsSO
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IEcalcIcmNormal")  && rotina nao esta executada
		=IEcalcIcmNormal()
	ENDIF	


	IF !IEGetPropVT("IEclcIcmSOper")  && rotina nao esta executada
		=IEclcIcmSOper()
	ENDIF	

	*----------------------------------------------------------------*


RETURN(IEGetPropVT("ICMSSOPER"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYV7           IEGetIPI VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   31   
*        Variable:            IEGetIPI                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      93                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyv7     &&  IEGetIPI VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEGetIPI
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	*----------------------------------------------------------------*

RETURN(IEGetPropVT("VLRIPI"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYV8           IEVerifCustoDistocido VALID        
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   32   
*        Variable:            IEVerifCustoDistocido              
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      94                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyv8     &&  IEVerifCustoDistocido VALID
#REGION 3
return

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Verificar distorcao entre custo atual
	*    registrado no sistema e custo que esta sendo informado
	*------------------------------------------------------------*
	* COMENTARIO..: A rotina permite detectar erros no lancamento
	*               como codigo e ou valores errados
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*

FUNCTION IEVerifCustoDistocido
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem

	PRIVATE LFreturn
	PRIVATE LNCustoEntrada		&& Custo na entrada
	PRIVATE LDdtCusto
	PRIVATE LNAtualCusto		&& Custo no estoque atual
	PRIVATE LSCodigo
	PRIVATE LNDeltaCusto
	PRIVATE LNPercentual

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IECalcCusto")  && rotina nao esta executada
		=IECalcCusto()
	ENDIF	

	LDdtCusto 		= IEGetPropVT("DATA")
	LSCodigo        = IEGetPropVT("CODIGO")	

	=W_DEFPROC("estoque.spr")
	LNAtualCusto = EScustoMedio(PrmEmp,LSCodigo ,LDdtCusto)


	LNCustoEntrada = (IEGetCusto(PrmEmp, PrmFavorecido, ;
				PrmBoletim, PrmOrdem)) / IEGetPropVT("QTDE")


	*--------------------------------------------------------------*
	LNDeltaCusto = abs(LNCustoEntrada - LNAtualCusto)
	LNPercentual = int((LNDeltaCusto/LNAtualCusto)*100)	

	IF LNPercentual > 10
		IF LNDeltaCusto	< 0
			LNPercentual = LNPercentual * -1
		ENDIF
		LSmsg = "Atencao : Variacao de Custo na Ordem de : "+;
				STR(LNPercentual,6)+" % "+;
				" Codigo : "+LSCodigo+chr(13)+;
				" Custo Registrado = "+STR(LNAtualCusto,10,2)+chr(13)+;
				" Custo Neste Doc  = "+STR(LNCustoEntrada,10,2)
				
		=fox_alert(LSmsg,.t.)
	ENDIF
	*--------------------------------------------------------------*
	
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYV9           IEDisplCusto VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   33   
*        Variable:            IEDisplCusto                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      95                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyv9     &&  IEDisplCusto VALID
#REGION 3
return

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....:  Verificar distorcao entre custo atual
	*    registrado no sistema e custo que esta sendo informado
	*------------------------------------------------------------*
	* COMENTARIO..: A rotina permite detectar erros no lancamento
	*               como codigo e ou valores errados
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa
	*		LNboletim......: Nro do Boletim de Entrada
	*		LNforn.........: Codigo do Fornecedor
	*------------------------------------------------------------*

FUNCTION IEDisplCusto
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem

	PRIVATE LFreturn
	PRIVATE LNCustoEntrada		&& Custo na entrada
	PRIVATE LDdtCusto
	PRIVATE LNAtualCusto		&& Custo no estoque atual
	PRIVATE LSCodigo
	PRIVATE LNDeltaCusto
	PRIVATE LNPercentual


	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)

	IF !IEGetPropVT("IECalcCusto")  && rotina nao esta executada
		=IECalcCusto()
	ENDIF	

	LDdtCusto 		= IEGetPropVT("DATA")
	LSCodigo        = IEGetPropVT("CODIGO")	

	=W_DEFPROC("estoque.spr")
	LNAtualCusto = EScustoMedio(PrmEmp,LSCodigo ,LDdtCusto)


	LNCustoEntrada = (IEGetCusto(PrmEmp, PrmFavorecido, ;
				PrmBoletim, PrmOrdem)) / IEGetPropVT("QTDE")


	*--------------------------------------------------------------*
	LNDeltaCusto = abs(LNCustoEntrada - LNAtualCusto)
	LNPercentual = int((LNDeltaCusto/LNAtualCusto)*100)	

		IF LNDeltaCusto	< 0
			LNPercentual = LNPercentual * -1
		ENDIF
		LSmsg = "Atencao : Variacao de Custo na Ordem de : "+;
				STR(LNPercentual,6)+" % "+;
				" Codigo : "+LSCodigo+chr(13)+;
				" Custo Registrado = "+STR(LNAtualCusto,10,2)+chr(13)+;
				" Custo Neste Doc  = "+STR(LNCustoEntrada,10,2)
				
		=fox_alert(LSmsg,.t.)
	*--------------------------------------------------------------*
	
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVA           IEExtrato VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   34   
*        Variable:            IEExtrato                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      96                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyva     &&  IEExtrato VALID
#REGION 3
RETURN

FUNCTION IEExtrato
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Notaite,ALS_Notaite
	PRIVATE ARQ_Tmp,ALS_Tmp
	store "" to ARQ_tmp,ALS_tmp



	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*

	IF  PrmEmpresa <> wp_cod_loja
		LSbase = wp_dircentral
	ELSE
		LSbase = wp_dirdat
	ENDIF

	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Notaite     = NetArqAgain(LSbase+"NOTAITE")
    ALS_Notaite     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Notaite
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	ALS_tmp = ALIAS()

	SELECT  data, ;
			hora,nota,operacao,tipo,qtde,(vlrvenda/QTDE) AS VALOR_UNI,situacao;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF

	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			NOTA			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			SITUACAO 	:H="STAT" :R;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_Notaite")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVC           AIEcalcIcmSubs VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   35   
*        Variable:            AIEcalcIcmSubs                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      97                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvc     &&  AIEcalcIcmSubs VALID
#REGION 3
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION IECalcIcmSubs
	*-------------------------------------------------------------------*						
	*  DESCRIO :  -Calcula a Base ICMS Retido no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION AIECalcIcmSubs
	IF IEGetPropVT("IECalcIcmSubs")  && rotina ja executada
		RETURN
	ENDIF	
	*----------------------------------------------------------------*
	
	PRIVATE  	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn,;
				LNbsbr_Icms,;
				LNaliq_Rdu,;
				LNbase_Icms,;
				LNicms,;
				LNbsbr_SOIcms,;
				LNbase_SOIcms,;
				LNicmsSO,;
				LNbsbr_Retido,;
				LNbase_Retido,;
				LNiva,;
				LNicmsRtdSaida,;
				LNicmsRtdEntrada


	PRIVATE LDdata
	PRIVATE LSufOrigem
	PRIVATE LSufDestino
	PRIVATE LNRetidoDestacado
	PRIVATE LNicmsDestino
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples

				
	LSProduto  = IEGetPropVT("CODIGO")


	LDdata           = IEGetPropVT("DATA")
	LNvlrMercadoria  = IEGetPropVT("VLRVENDA")
	LNvlrIPI		 = IEGetPropVT("VLRIPI")
	LNcdg_Forn  	 = IEGetPropVT("CODFORN")


	LNicms		  	 = IEGetPropVT("VLR_ICMS")


	LNbsbr_SOIcms    = IEGetPropVT("BSBRICMSO")
	LNbase_SOIcms    = IEGetPropVT("BASEICMSO")
	LNicmsSO	  	 = IEGetPropVT("ICMSSOPER")



	LPrmEmpresa		= IEGetPropVT("EMPRESA")
	LPrmBoletim		= IEGetPropVT("ORCAMENTO")

	=W_DEFPROC("notaent.spr")
	LSufOrigem  = NEGetUFOrigem(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)

	=W_DEFPROC("notaent.spr")
	LSufDestino = NEGetUFDestino(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)


	=W_DEFPROC("notaent.spr")
	LNRetidoDestacado = ;
	    NEGetRetidoDestacado(LPrmEmpresa,LPrmBoletim,LNcdg_Forn)
	*-----------------------------------------------------------------*

	=W_DEFPROC("tributar.spr")
	LNicmsOrigem	=	TRAlqIcmouOuUF(LSufOrigem) &&


	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmouInUF(LSufDestino) &&


	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbOrigem=TRDef_RgTrbMercad(LSufOrigem, LSproduto)


	=W_DEFPROC("TRIBUTAR.spr")
	LNRgTrbDestino=TRDef_RgTrbMercad(LSufDestino, LSproduto)



	=W_DEFPROC("TRIBUTAR.spr")
	LNiva= TRGet_IVA(LSufOrigem,LSproduto)


	LNbsbr_Icms = 	IEGetPropVT("BSBR_ICMS")

	*----------------------------------------------------------*
	*                  COMPOSICAO DA REGRA                     *
	*----------------------------------------------------------*
	LNbsbr_Retido   	= IEGetPropVT("BASE_SBBRT")
	LNbase_Retido   	= IEGetPropVT("BASE_SUBS")
	LNbsbrEntRetido   	= IEGetPropVT("BSENTSBBRT")
	LNbaseEntRetido   	= IEGetPropVT("BSENTSUBS")

	LNicmsRtdSaida		= 0.00
	LNicmsRtdEntrada	= 0.00

	*--------------------------------------------------------------*
	*--------------  CALCULO DO ICMS RETIDO NA SAIDA --------------*
	*--------------------------------------------------------------*



	*--------------------------------------------------------------*
	*--------------  CALCULO DO ICMS RETIDO NA SAIDA --------------*
	*--------------------------------------------------------------*

	DO CASE
		CASE LNRgTrbOrigem = 8 && IMPORTADA COM RETENCAO

			  		LNicmsRtdSaida =  ;
	  			       (LNbase_Retido * LNicmsOrigem/100) ;
	  			       - LNicms - LNicmsSO

		CASE LNRgTrbOrigem = 2 ;
			     AND  LNRgTrbDestino = 2  && RETIDO NA SAIDA

			  		LNicmsRtdSaida =  ;
	  			       (LNbase_Retido * LNicmsDestino/100) ;
	  			       - LNicms - LNicmsSO

		CASE LNRgTrbOrigem = 1 ;
			     AND  LNRgTrbDestino = 2  && RETIDO NA ENTRADA

		  			LNicmsRtdEntrada = ;
	  		        (LNbaseEntRetido * LNicmsDestino/100) ;
	  		        - LNicms - LNicmsSO
	ENDCASE




	IF LNicmsRtdSaida > 0.00
		=IESetPropVT("BASE_SBBRT",LNbsbr_Retido)
		=IESetPropVT("BASE_SUBS",LNbase_Retido)
		=IESetPropVT("ICMS_SUBS",LNicmsRtdSaida)

		=IESetPropVT("BSENTSBBRT",0.00)
		=IESetPropVT("BSENTSUBS",0.00)
		=IESetPropVT("ICMSENTSUB",0.00)


	ELSE
		=IESetPropVT("BASE_SBBRT",0.00)
		=IESetPropVT("BASE_SUBS",0.00)
		=IESetPropVT("ICMS_SUBS",0.00)


		=IESetPropVT("BSENTSBBRT",LNbsbrEntRetido)
		=IESetPropVT("BSENTSUBS",LNbaseEntRetido)
		=IESetPropVT("ICMSENTSUB",LNicmsRtdEntrada)
	ENDIF

	*----------------------------------------------------------------*
	=IESetPropVT("IECalcIcmSubs",.T.)  && rotina com valores atuais


RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVF           IEformulaCusto VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   36   
*        Variable:            IEformulaCusto                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      98                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyvf     &&  IEformulaCusto VALID
#REGION 3
RETURN


FUNCTION IEformulaCusto
PARAMETERS	LNvlrMercadoria,LNvlrIPI,LNicms,LNicmsSobreOperacao,;
	  LNCusto_Ind,LNicmsRtdSaida,LNicmsRtdEntrada, LNtp_Mercad ,;
	   LNvlrPIS, LNvlrCOFINS

	PRIVATE LNcusto

	DO CASE
		CASE  LNtp_Mercad = 8   && IMPORTADA COM RETENCAO TRIBUTADA
			
			LNcusto = LNvlrMercadoria + LNCusto_Ind+;
				 LNicmsRtdEntrada + LNicmsRtdSaida
		CASE  LNtp_Mercad = 1   && TRIBUTADA
			LNcusto = LNvlrMercadoria + LNvlrIPI + LNCusto_Ind+;
				 LNicmsRtdEntrada + LNicmsRtdSaida - LNicms
		OTHERWISE
			LNcusto = LNvlrMercadoria + LNvlrIPI + LNCusto_Ind+;
				 LNicmsRtdEntrada + LNicmsRtdSaida	
	ENDCASE

	LNcusto = LNcusto - (LNvlrPIS + LNvlrCOFINS)


RETURN(LNcusto)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVG           IEcalcPis VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   37   
*        Variable:            IEcalcPis                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      99                                 
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvg     &&  IEcalcPis VALID
#REGION 3
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION IEcalcPis
	*-------------------------------------------------------------------*						
	*  DESCRIO :  -Calcula a PIS
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION IEcalcPis
	IF IEGetPropVT("IEcalcPis")  && rotina ja executada
		RETURN
	ENDIF	
	*----------------------------------------------------------------*
	
	PRIVATE  	LSproduto,;
				LNvlrMercadoria,;
				LNvlrPIS,;
				LNCusto_Ind



				
	LSProduto  = IEGetPropVT("CODIGO")

	LNvlrMercadoria  = IEGetPropVT("VLRVENDA")
	LNCusto_Ind	 	= IEGetPropVT("CUSTO_IND")


	*----------------------------------------------------------*
	*--------------  CALCULO DO PIS              --------------*
	*----------------------------------------------------------*

	LNvlrPIS =  ((LNvlrMercadoria+LNCusto_Ind) * 1.65/100)


	=IESetPropVT("VLR_PIS",LNvlrPIS)

	*----------------------------------------------------------------*
	=IESetPropVT("IEcalcPis",.T.)  && rotina com valores atuais


RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVH           IEcalcCOFINS VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   38   
*        Variable:            IEcalcCOFINS                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      100                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvh     &&  IEcalcCOFINS VALID
#REGION 3
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION IEcalcCOFINS
	*-------------------------------------------------------------------*						
	*  DESCRIO :  -Calcula a COFINS
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION IEcalcCOFINS
	IF IEGetPropVT("IEcalcCOFINS")  && rotina ja executada
		RETURN
	ENDIF	
	*----------------------------------------------------------------*
	
	PRIVATE  	LSproduto,;
				LNvlrMercadoria,;
				LNvlrCOFINS,;
				LNCusto_Ind



	LSProduto  = IEGetPropVT("CODIGO")

	LNvlrMercadoria  = IEGetPropVT("VLRVENDA")


	LNCusto_Ind	 	= IEGetPropVT("CUSTO_IND")
	*----------------------------------------------------------*
	*--------------  CALCULO DO PIS              --------------*
	*----------------------------------------------------------*

	LNvlrCOFINS =  ((LNvlrMercadoria+LNCusto_Ind) * 7.6/100)


	=IESetPropVT("VLR_COFINS",LNvlrCOFINS)

	*----------------------------------------------------------------*
	=IESetPropVT("IEcalcCOFINS",.T.)  && rotina com valores atuais


RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVI           IECST VALID                        
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   39   
*        Variable:            IECST                              
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      101                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvi     &&  IECST VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IECST
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)
	*----------------------------------------------------------------*

RETURN(IEGetPropVT("CST"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVJ           IEDefnPath VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   42   
*        Variable:            IEDefnPath                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      102                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvj     &&  IEDefnPath VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEDefnPath
PARAMETER PrmPath

	PUBLIC IEDefnPath

	IEDefnPath = PrmPath

RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVK           IEGetAlias VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   43   
*        Variable:            IEGetAlias                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      103                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvk     &&  IEGetAlias VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEGetAlias

	=IEVerifyInst()

RETURN(PBNotaIteAlias)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVL           PrdtOrigem VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         NOTAITE,     Record Number:   44   
*        Variable:            PrdtOrigem                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      104                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvl     &&  PrdtOrigem VALID
#REGION 3
return
*---------------------------------------------------------------*

FUNCTION IEPrdtOrigem
PARAMETERS PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem
	PRIVATE LFreturn

	=IEChk_Identidade(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem)
	*----------------------------------------------------------------*

RETURN(IEGetPropVT("ORIGEM"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVM           ESPsq_Produtos VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:    4   
*        Variable:            ESPsq_Produtos                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      105                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvm     &&  ESPsq_Produtos VALID
#REGION 4
RETURN
PROCEDURE ESPsq_Produtos
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Pesquisar Produtos em uma Lista
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: GRUPO
	*------------------------------------------------------------*
	* PARAMETROS..:
	*             LScodigo : Codigo do Produto - Pode Ser Utiliza
	*                  para posicionamento parcial
	*------------------------------------------------------------*
	* CHAMADAS.............:
	*------------------------------------------------------------*
	PARAMETERS LScodigo

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_grupo, ALS_grupo

    LSalias      = Alias()
    ARQ_grupo    = NetArqAgain("GRUPO")
    ALS_grupo    = Alias()



	SELE &ALS_grupo
	SET ORDER TO TAG codigo
	SET NEAR ON
	SEEK ALLTRIM(LScodigo)
	SET NEAR OFF
	*----------------------------------------------------------*
	ON KEY LABEL ESCAPE

	SET ORDER TO TAG ordem
	ON KEY LABEL ESCAPE
	DO loc_dlog WITH .T.

	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	IF LASTKEY() <> 27
	   LScodigo = &ALS_grupo .codigo
	ELSE
	   SEEK ALLTRIM(LScodigo)
	   IF !FOUND()
		   LScodigo = ""
	   ENDIF
	ENDIF

	=UP_fecha(ALS_GRUPO)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScodigo)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVN           ESAbresaldo VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:    5   
*        Variable:            ESAbresaldo                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      106                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvn     &&  ESAbresaldo VALID
#REGION 4
RETURN
PROCEDURE ESAbresaldo

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Abrir Registro de Controles de saldo
	* 			do produto informado no periodo informado
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: SALDO, ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Que se quer abrir o Saldo
	*		LSclass........: Classificaso do Produto
	*		LSclass........: Classificaso do Produto
	*		LDdtini........: Referencia do mes inicial
	*		LDdtfim........: Referencia do mes final
	*------------------------------------------------------------*
	* CHAMADAS.............:
	*------------------------------------------------------------*
	PARAMETERS LNemp,LScod,LSclass,LDdtini,LDdtfim

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFsaldo,LFitemmov
	PRIVATE LDdtincrementa, LDdtencerra

	*--------------------------------------------------------------*
	PRIVATE m.sld_ante,m.sld_atu,m.vlr_ante,m.vlr_atu
	PRIVATE m.empresa,m.codigo, m.classifica
	PRIVATE m.qtd_compra,m.vlr_compra,m.qtd_venda,m.vlr_venda,;
			m.qtd_e_tran,m.vlr_e_tran,m.qtd_e_outr,m.vlr_e_outr,;
			m.qtd_s_tran,m.vlr_s_tran,m.qtd_s_outr,m.vlr_s_outr,;
			m.ven_tab,m.ven_contab,m.ven_enc,m.dtabert,m.status
	*--------------------------------------------------------------*
	LSalias			= ALIAS()
	LFsaldo			= NetArq("saldo")
	LFitemmov			= NetArq("itemmov")
	IF (LFsaldo+LFitemmov) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("saldo" ,LFsaldo)
		=UP_fecha("itemmov" ,LFitemmov)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*----------------------------------------------------------------*
	* Redimensiona as datas para permitir o controle do incremento de
	* 1 mes na data inicial dentro do laco
	*----------------------------------------------------------------*
	LDdtincrementa	= LDdtini - DAY(LDdtini) + 1 && 1o DIA DO MES
	LDdtencerra		= LDdtfim -	DAY(LDdtfim) + 1 && 1o DIA DO MES

   	m.sld_ante   = 0
   	m.vlr_ante   = 0

	DO WHILE LDdtincrementa <= LDdtencerra
   		SELECT saldo
	   	SET ORDER TO TAG clas_saldo
   		SET NEAR ON
   		SEEK STR(LNemp,3)+LSclass+;
	        	STR(YEAR(LDdtincrementa),4)+;
    	    	STR(MONTH(LDdtincrementa),2)
	   	SET NEAR OFF

	   	IF  FOUND()
			SKIP -1			&& TESTE SE EXISTE REGISTRO ANTERIOR
	      	IF !BOF() ;
	      		AND saldo.empresa  = LNemp ;
	      		AND saldo.classifica = LSclass
			    	m.sld_ante   = saldo.sld_atu
			    	m.vlr_ante   = saldo.vlr_atu
			ELSE
				SELE itemmov
				SET ORDER TO TAG movsimples
				SET NEAR ON
				SEEK STR(LNemp,3)+LScod+DTOS(LDdtincrementa)
				SET NEAR OFF
				*-------------------------------------------------*
				* PROCURANDO MOVIMENTO ANTERIOR A DATA
				*-------------------------------------------------*
				SKIP -1
				DO WHILE !BOF() ;
						AND itemmov.empresa  = LNemp ;
						AND itemmov.codigo   = LScod ;
						AND itemmov.data >= LDdtincrementa
	
					SKIP -1
				ENDDO
				IF !BOF() 	AND itemmov.empresa  = LNemp ;
							AND itemmov.codigo   = LScod ;
						AND itemmov.data < LDdtincrementa
					* ENCONTROU MOV ANTERIOR

			    	m.sld_ante   = itemmov.sld_estq
			    	m.vlr_ante   = itemmov.vlr_estq
				ENDIF
			ENDIF	
			SELE SALDO
	   		SEEK STR(LNemp,3)+LSclass+;
	        	STR(YEAR(LDdtincrementa),4)+;
    	    	STR(MONTH(LDdtincrementa),2)

			SET FIELDS TO dtregis, hregis, usrregis,deletado
		    SET FIELDS TO sld_ante, vlr_ante
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF

	   	ELSE
			SKIP -1			&& TESTE SE EXISTE REGISTRO ANTERIOR
	      	IF !BOF() ;
	      		AND saldo.empresa  = LNemp ;
	      		AND saldo.classifica = LSclass
			    	m.sld_ante   = saldo.sld_atu
			    	m.vlr_ante   = saldo.vlr_atu
			ELSE
				SELE itemmov
				SET ORDER TO TAG movsimples
				SET NEAR ON
				SEEK STR(LNemp,3)+LScod+DTOS(LDdtincrementa)
				SET NEAR OFF
				*-------------------------------------------------*
				* PROCURANDO MOVIMENTO ANTERIOR A DATA
				*-------------------------------------------------*
				SKIP -1
				DO WHILE !BOF() ;
						AND itemmov.empresa  = LNemp ;
						AND itemmov.codigo   = LScod ;
						AND itemmov.data >= LDdtincrementa
	
					SKIP -1
				ENDDO
				IF !BOF() 	AND itemmov.empresa  = LNemp ;
							AND itemmov.codigo   = LScod ;
						AND itemmov.data < LDdtincrementa
					* ENCONTROU MOV ANTERIOR

			    	m.sld_ante   = itemmov.sld_estq
			    	m.vlr_ante   = itemmov.vlr_estq
				ENDIF
			ENDIF	
	    	m.sld_atu    = m.sld_ante
	    	m.vlr_atu    = m.vlr_ante

   			m.empresa    = LNemp
	    	m.codigo     = LScod
		    m.classifica = LSclass

			STORE 0 TO 	m.qtd_compra,m.vlr_compra,m.qtd_venda,m.vlr_venda,;
					m.qtd_e_tran,m.vlr_e_tran,m.qtd_e_outr,m.vlr_e_outr,;
					m.qtd_s_tran,m.vlr_s_tran,m.qtd_s_outr,m.vlr_s_outr,;
					m.ven_tab,m.ven_contab,m.ven_enc

			m.dtabert   = LDdtincrementa
		    m.status    = 'A'
			SELE SALDO
			=edithand('SAVE')
	
		ENDIF
		LDdtincrementa	= GOMONTH(LDdtincrementa,1) && PROXIMO 1o DIA DO MES
	ENDDO

	=UP_fecha("saldo" ,LFsaldo)
	=UP_fecha("itemmov" ,LFitemmov)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVQ           ESversaldo VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:    6   
*        Variable:            ESversaldo                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      107                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvq     &&  ESversaldo VALID
#REGION 4
RETURN

FUNCTION ESversaldo
	PARAMETERS LNemp,LScod,LDdata,LNqtde,LNJaReserv,;
				LFabreAuto,LFlockreg,LSoperacao,LShora,;
				LSmovEstq

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Verificar Saldo Para  atender solicitacao
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....:
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdata.........: Data na Qual se quer o saldo
	*		LNqtde.........: Qtde Solicitada
	*		LNJaReserv.....: Qtde ja Reservada Anteriormente desta
	*						propria Solicitacao
	*						Ex: SOLICITA 10 mas JA TEM 3 RESERVADO
	*						ATERIORMENTE => TEM QUE ATENDEDER 7
	*						esta qu
	*		LFAbreAuto.....: .f. Nao abre Controle quando nao Existe
	*						 .t. Abre Registro de Saldo para Mes
	*		LSoperacao.....: Indica qual opercao esta originando a
	*						chamada a rotina ex:
	*					"RESERVA" => Processo de Reserva ex: SCGC2.PRG
	*
	*
	*					"SAIDA" => Processo de Saida ex: SCGC2.PRG
	*					"ENTRADA"=>Processo de Entrada ex: SCGC210.SCR
	*							(Para entradas so  necessario localizar
	*							registro de SALDO  e bloquear nao
	*							sendo verificados saldos
	*		LShora.........: Perimite verificar o saldo pelo
	*					movimento (ITEMMOV) localizando o  movimento
	*					anterior do item na data e hora informada
	*					so esta sendo utilizado para REQUISICOES
	*					de saida que podem ser lancadas em datas
	*					anteriores e devem considerar o saldo do
	*					momento (OBS: No caso de recuperacao de
	*							NFS e possivel utilizar esta
	*							tecnica , ver futuro)
	*		LSmovEstq.......: "N"= Operacao nao movimentara estoque
	*								so deseja localiza/block REG.SALDO					
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LFretorno......: .F. ou .T.
	*
	* CHAMADAS.....: SCGC2.PRG,OBJ_ITOR.SCR,SCGCF201
	*				 SCGC210.SCR			
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFsaldo
	PRIVATE LFgrupo
	PRIVATE LFempresa
    PRIVATE LNreal_saldo
 	PRIVATE LNbloq_saldo
	PRIVATE LFgrfiscal
	*------------------------------------------------------------*
	LSalias			= ALIAS()
	LFsaldo			= NetArq("saldo")
	LFgrfiscal		= NetArq("grfiscal")
	LFempresa		= NetArq("empresa")
	LFgrupo			= NetArq("grupo")
	*------------------------------------------------------------*
	IF (LFsaldo+LFgrfiscal+LFempresa+LFgrupo) > 100000
		DO ESver_fecha
      	WAIT WINDOW "(ESversaldo)- Falha Abertura de Tabelas.<ENTER>"
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		DO ESver_fecha
      	WAIT WINDOW ;
      		"(ESversaldo)- Registro de Empresa Nao Localizado. <ENTER>"
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	SELECT grupo
	SET ORDER TO TAG codigo
	SEEK LScod
	IF !FOUND()
		DO ESver_fecha
      	WAIT WINDOW ;
      		"(ESversaldo)- Registro de Produto Nao Localizado.<ENTER>"
		RETURN(.f.)
	ENDIF
	IF  grupo.tp_control = 9   && PRODUTO SEM CONTROLE DA ESTOQUE
		DO ESver_fecha
		RETURN(.T.)
	ENDIF

	*------------------------------------------------------------*
	SELECT GRfiscal
	SET ORDER TO TAG tributacao
	SEEK empresa.estado+LEFT(grupo.classifica,5)
	IF !FOUND()
		SET ORDER TO TAG tributacao
		SEEK empresa.estado+LEFT(grupo.classifica,2)
		IF !FOUND()
			DO ESver_fecha
    	  	WAIT WINDOW ;
			"(ESversaldo)- Registro Fiscal de Produto "+ALLTRIM(LScod)+;
					"  Nao Localizado.<ENTER>"
			RETURN(.f.)
		ENDIF
	ENDIF
	IF  grfiscal.tp_mercad =  7
		DO ESver_fecha
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
    SELECT saldo
    SET ORDER TO TAG clas_saldo
    SEEK STR(LNemp,3)+grupo.classifica+;
        STR(YEAR(LDdata),4)+;
        STR(MONTH(LDdata),2)
    IF !FOUND()
		IF !LFAbreAuto OR;
		   !ESAbresaldo((LNemp),(LScod),(grupo.classifica),;
					(LDdata), (LDdata))
	      	WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
    	           " nao foi aberto para movimentacao. Solicite abertura."
			DO ESver_fecha
			RETURN(.f.)
		ENDIF
    ENDIF

    IF LScod   <> saldo.codigo OR ;
   	   grupo.classifica <> saldo.classifica
		    DO OBJ_ALER.SPR WITH ;
	   		"Os dados do Item "+LScod+chr(13)+;
			"Estao irregulares. Reedite a Doc e verifique o Item."
			DO ESver_fecha
			RETURN(.f.)
    ENDIF
	
	*-----------------------------------------------------------------*
	IF LSmovEstq <> "N" AND !ULatendeOper(LSoperacao)
		DO ESver_fecha
      	WAIT WINDOW  "(ESversaldo)- Estoque Insuficiente. <ENTER>"
		RETURN(.f.)
	ENDIF
	*----------------------------------------------------------------*
	IF LFlockreg		&& BLOQUEAR REGISTRO PARA PROCESSO
	   IF !REGLOCK()
	      	WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
                 " nao pode ser bloqueado para efetivar reserva."
			DO ESver_fecha
			RETURN(.f.)
	   ENDIF
	ENDIF
	*------------------------------------------------------------*
	DO ESver_fecha
RETURN(.T.)


PROCEDURE ESver_fecha
	=UP_fecha("saldo"    ,LFsaldo)
	=UP_fecha("grfiscal" ,LFgrfiscal)
	=UP_fecha("empresa"  ,LFempresa)
	=UP_fecha("grupo"    ,LFgrupo)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



FUNCTION ULatendeOper
PARAMETERS LSoperacao
	*-----------------------------------------------------------------*
	*	Esta Rotina Permite Tratar individualmente o saldo de acordo
	*	com a operacao "RESERVA", "SAIDA" ou "ENTRADA"
	*-----------------------------------------------------------------*
	PRIVATE LFretorno
	LFretorno = .T.	
	DO CASE
		CASE LSoperacao = "RESERVA"
		    LNbloq_saldo = saldo.sld_atu - saldo.reserva + LNJaReserv
			IF LNqtde > LNbloq_saldo
				      WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
			        " ESTOQUE (-) RESERVA =>> "+ALLTRIM(STR(LNbloq_saldo,7))
					LFretorno = .F.	
			ENDIF
		
		CASE LSoperacao = "SAIDA"
		    LNreal_saldo = saldo.sld_atu
		    LNbloq_saldo = saldo.sld_atu - saldo.reserva + LNJaReserv

			DO CASE
				CASE LNqtde > LNreal_saldo
			       WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
			          " ESTOQUE =>> "+ALLTRIM(STR(LNreal_saldo,7))
					LFretorno = .F.	

				CASE LNqtde > LNbloq_saldo
				      WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
			        " ESTOQUE (-) RESERVA =>> "+ALLTRIM(STR(LNbloq_saldo,7))
					LFretorno = .F.	
			ENDCASE
		CASE LSoperacao = "ENTRADA"
			LFretorno = .T.	
	ENDCASE
RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVT           ESsaldo VALID                      
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:    7   
*        Variable:            ESsaldo                            
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      108                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvt     &&  ESsaldo VALID
#REGION 4
RETURN
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar saldo em momento  solicitado
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*						LNemp = 999  faz com que a rotina le-
	*						vante os dados de todas empresas regis-
	*						tradas no arq. empresa
	*		LScod..........: Codigo do Produto
	*		LSclass........: Classificaso do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LNqtde.........: Referencia p/ Retorno
	*		LNcusto........: Referencia p/ Retorno
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*		LNreserva......: Qtde Reservada
	*------------------------------------------------------------*
	*	CHAMADA............: NEsoma_Saldo
	*
	*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNqtde.........: Saldo Total do Estoque na Data
	*		LNcusto........: Valor do Estoque  total
	*		LNreserva......: Parte do Saldo que esta Reservada
	*------------------------------------------------------------*



FUNCTION ESsaldo
	PARAMETERS LNemp,LScod,LSclass,LDdtbase,LNqtde,LNcusto, LShora,;
				LNreserva

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFsaldo,LFitemmov,LFempresa
	PRIVATE TMPcusto

	LNqtde  	= 0
	LNcusto 	= 0
	LNreserva 	= 0

	IF TYPE("LShora") <> "C" or EMPTY(LShora)
		LShora = "99:99:99"			&&  FORCA PESQUISA NO FINAL DO DIA
	ELSE
		LShora = LEFT(LShora,6)+"60" && FORCA PESQUISA NO PROXIMO MINUTO
	ENDIF
	LSalias			= ALIAS()
	LFempresa		= NetArq("empresa")
	LFsaldo			= NetArq("saldo")
	LFitemmov		= NetArq("itemmov")
	IF (LFempresa+LFsaldo+LFitemmov) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("empresa" ,LFempresa)
		=UP_fecha("saldo" ,LFsaldo)
		=UP_fecha("itemmov" ,LFitemmov)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE empresa
	SET ORDER TO TAG empresa
	IF LNemp = 999
		GO TOP
	ELSE
		SEEK LNemp
	ENDIF
	DO WHILE !EOF() AND (LNemp = 999 OR LNemp = empresa.empresa)
		SELECT  itemmov
		SET ORDER TO TAG movimento
		SET NEAR ON
		SEEK STR(empresa.empresa,3)+LScod+dtos(LDdtbase)+LShora
										&& POSICIONA A FRENTE PARA
										&& VOLTAR E PEGAR SALDO DE
										&& FECHAMENTO OU ATUAL DO DIA
		SET NEAR OFF
		IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
			=UP_fecha("empresa" ,LFempresa)
			=UP_fecha("saldo" ,LFsaldo)
			=UP_fecha("itemmov" ,LFitemmov)
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(0)
		ELSE
			SKIP -1
		ENDIF


		IF BOF() OR LScod <> itemmov.codigo ;
			OR empresa.empresa <> itemmov.empresa

		   	SELE saldo
		   	SET ORDER TO TAG emp_mes
	 		SEEK STR(empresa.empresa,3)+STR(YEAR(LDdtbase),4)+;
					STR(MONTH(LDdtbase),2)+LSclass
			IF FOUND()
		   		LNqtde    = LNqtde  + saldo.sld_ante
		   		LNcusto   = LNcusto + saldo.vlr_ante
				LNreserva = LNreserva + saldo.reserva
			ELSE
				SELECT  itemmov
				SKIP				&& avanca p/ pegar dat di 1o lancamento
				IF !BOF() AND LScod = itemmov.codigo AND ;
				  		  empresa.empresa = itemmov.empresa)
				   SELE saldo
				   SEEK STR(empresa.empresa,3)+;
		   	   			STR(YEAR(itemmov.data),4)+;
						STR(MONTH(itemmov.data),2)+LSclass
				   IF FOUND()
		  			    LNqtde    = LNqtde + saldo.sld_ante
					    LNcusto   = LNcusto + saldo.vlr_ante
						LNreserva = LNreserva + saldo.reserva
					ELSE
						&& NAO ENCONTROU NENUMA REFERENCIA ANTERIOR
						&& RECOMPOE A SALDO ANTERIOR ANULANDO OPERACAO
					    TMPcusto = 0
						IF itemmov.sld_estq = 0
						    TMPcusto   = itemmov.vlr_estq
						ELSE						
						    TMPcusto   = itemmov.vlr_estq / itemmov.sld_estq
						ENDIF
						DO CASE
							CASE LEFT(itemmov.operacao,1) = "S"
						    	LNqtde  = LNqtde + itemmov.sld_estq + ;
				    						 itemmov.qtde
								LNreserva = LNreserva + itemmov.sld_rese
							CASE LEFT(itemmov.operacao,1) = "E"
						    	LNqtde  = LNqtde + itemmov.sld_estq - ;
				    						 itemmov.qtde
						ENDCASE	
			    	    LNcusto   = LNcusto + (LNqtde * TMPcusto)
				   ENDIF
				ENDIF
			ENDIF
		ELSE
			IF itemmov.sld_estq > 0	
		    	LNqtde    = LNqtde + itemmov.sld_estq
		    	LNcusto   = LNcusto + itemmov.vlr_estq
				LNreserva = LNreserva + itemmov.sld_rese
			ENDIF
		ENDIF


		IF LNqtde = 0	&& EM ITEMMOV O ULTIMO CUSTO FICA REGISTRADO
						&& QDO O ESTOQUE ZERA PORTANTO DEVE SER ZARADO
						&& POIS A ROTINA DEVE REORNAR O CUSTO ESTOCADO
		    LNcusto   = 0
		ENDIF	
		IF LNemp <> 999		&& PESQUISA SO NA EMPRESA INFORMADA
			EXIT				&& EVITA DESLOCAR REGISTRO DE EMPRESA
								&& QUE ESTA SENDO CONTROLADO EM SCGC800
								&& UPregprevisao
		ENDIF
		SELE EMPRESA
		SKIP
	ENDDO
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("saldo" ,LFsaldo)
	=UP_fecha("itemmov" ,LFitemmov)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNqtde)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVX           EScustoMedio VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:    8   
*        Variable:            EScustoMedio                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      109                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvx     &&  EScustoMedio VALID
#REGION 4
RETURN
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Custo M괺io do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNcusto........: Custo M괺io do Produto no Momento
	*						(Custo Total / Saldo )
	*
	*------------------------------------------------------------*
	*	CHAMADA............: NEsoma_Saldo
	*
	*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNcusto........: Custo M괺io do Produto no Momento
	*						(Custo Total / Saldo )
	*------------------------------------------------------------*

FUNCTION EScustoMedio
	PARAMETERS LNemp,LScod,LDdtbase, LShora, LNcusto

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_saldo    , ALS_saldo
	PRIVATE ARQ_itemmov  , ALS_itemmov
	

	PRIVATE TMPcusto

	LNsaldo  	= 0
	LNcusto 	= 0
	LNreserva 	= 0

	IF TYPE("LShora") <> "C" or EMPTY(LShora)
		LShora = "99:99:99"			&&  FORCA PESQUISA NO FINAL DO DIA
	ELSE
		LShora = LEFT(LShora,6)+"60" && FORCA PESQUISA NO PROXIMO MINUTO
	ENDIF


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_saldo  	= NetArqAgain("SALDO")
    ALS_saldo  	= Alias()

    ARQ_itemmov	= NetArqAgain("ITEMMOV")
    ALS_itemmov	= Alias()


	IF (ARQ_grupo+ARQ_empresa+ARQ_saldo+ARQ_itemmov) > 100000
						 && HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*------------------------

	SELECT  &ALS_itemmov
	SET ORDER TO TAG movimento
	SET NEAR ON
	SEEK STR( &ALS_empresa .empresa,3)+LScod+dtos(LDdtbase)+LShora
									&& POSICIONA A FRENTE PARA
									&& VOLTAR E PEGAR SALDO DE
									&& FECHAMENTO OU ATUAL DO DIA
	SET NEAR OFF
	IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ELSE
		SKIP -1
		DO WHILE !BOF() AND &ALS_itemmov .sld_estq = 0 ;
		                AND LScod = &ALS_itemmov .codigo ;
		                AND &ALS_empresa .empresa = &ALS_itemmov .empresa
			SKIP -1
		ENDDO
	ENDIF
	
	IF BOF() OR LScod <> &ALS_itemmov .codigo ;
			 OR &ALS_empresa .empresa <> &ALS_itemmov .empresa

		SELE &ALS_grupo
		SET ORDER TO TAG codigo

	   	SELE &ALS_saldo
	   	SET ORDER TO TAG emp_mes
 		SEEK STR( &ALS_empresa .empresa,3)+STR(YEAR(LDdtbase),4)+;
					STR(MONTH(LDdtbase),2)+ &ALS_grupo .classifica
		IF FOUND()
	   		LNsaldo    = &ALS_saldo .sld_ante
	   		LNcusto    = &ALS_saldo .vlr_ante
		ELSE
			SELECT  &ALS_itemmov
			SKIP		&& avanca p/ pegar data do 1o lancamento

			IF !BOF() AND LScod = &ALS_itemmov .codigo AND ;
				  		  &ALS_empresa .empresa = &ALS_itemmov .empresa)
			   SELE &ALS_saldo
			   SEEK STR( &ALS_empresa .empresa,3)+;
	   	   			STR(YEAR( &ALS_itemmov .data),4)+;
					STR(MONTH( &ALS_itemmov .data),2)+;
					&ALS_grupo .classifica

			   IF FOUND()
	  			    LNsaldo   = &ALS_saldo .sld_ante
				    LNcusto   = &ALS_saldo .vlr_ante
				ELSE
					&& NAO ENCONTROU NENUMA REFERENCIA ANTERIOR
					&& RECOMPOE A SALDO ANTERIOR ANULANDO OPERACAO

				    TMPcusto = 0
					IF &ALS_itemmov .sld_estq = 0
					    TMPcusto   = &ALS_itemmov .vlr_estq
					ELSE						
					    TMPcusto   = &ALS_itemmov .vlr_estq / ;
					                        &ALS_itemmov .sld_estq
					ENDIF

					DO CASE
						CASE LEFT( &ALS_itemmov .operacao,1) = "S"
					    	LNsaldo  = &ALS_itemmov .sld_estq + ;
					    				 &ALS_itemmov .qtde
						CASE LEFT( &ALS_itemmov .operacao,1) = "E"
					    	LNsaldo  = &ALS_itemmov .sld_estq - ;
					    				&ALS_itemmov .qtde
					ENDCASE	
		    	    LNcusto   = LNcusto + (LNsaldo * TMPcusto)
			   ENDIF
			ENDIF
		ENDIF
	ELSE
    	LNsaldo   = &ALS_itemmov .sld_estq
    	LNcusto   = &ALS_itemmov .vlr_estq
	ENDIF

	*-------------------------------------------------------------*
	
	IF LNsaldo = 0	&& EM ITEMMOV O ULTIMO CUSTO FICA REGISTRADO
					&& QDO O ESTOQUE ZERA PORTANTO DEVE SER ZARADO
					&& POIS A ROTINA DEVE REORNAR O CUSTO ESTOCADO
	    LNcusto   = 0
	ELSE
    	LNcusto   = LNcusto / LNsaldo
	ENDIF	


    =up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
	=up_fecha("&ALS_saldo")
    =up_fecha("&ALS_itemmov")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNcusto)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVY           EScustoEstq VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:    9   
*        Variable:            EScustoEstq                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      110                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvy     &&  EScustoEstq VALID
#REGION 4
RETURN
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Custo M괺io do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNcusto........: Custo M괺io do Produto no Momento
	*						(Custo Total / Saldo )
	*
	*------------------------------------------------------------*
	*	CHAMADA............: NEsoma_Saldo
	*
	*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNcusto........: Custo M괺io do Produto no Momento
	*						(Custo Total / Saldo )
	*------------------------------------------------------------*

FUNCTION EScustoEstq
	PARAMETERS LNemp,LScod,LDdtbase, LShora

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_saldo    , ALS_saldo
	PRIVATE ARQ_itemmov  , ALS_itemmov
	

	PRIVATE TMPcusto,LNcusto

	LNsaldo  	= 0
	LNcusto 	= 0

	IF TYPE("LShora") <> "C" or EMPTY(LShora)
		LShora = "99:99:99"			&&  FORCA PESQUISA NO FINAL DO DIA
	ELSE
		LShora = LEFT(LShora,6)+"60" && FORCA PESQUISA NO PROXIMO MINUTO
	ENDIF


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_saldo  	= NetArqAgain("SALDO")
    ALS_saldo  	= Alias()

    ARQ_itemmov	= NetArqAgain("ITEMMOV")
    ALS_itemmov	= Alias()


	IF (ARQ_grupo+ARQ_empresa+ARQ_saldo+ARQ_itemmov) > 100000
						 && HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*------------------------

	SELECT  &ALS_itemmov
	SET ORDER TO TAG movimento
	SET NEAR ON
	SEEK STR( &ALS_empresa .empresa,3)+LScod+dtos(LDdtbase)+LShora
									&& POSICIONA A FRENTE PARA
									&& VOLTAR E PEGAR SALDO DE
									&& FECHAMENTO OU ATUAL DO DIA
	SET NEAR OFF
	IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ELSE
		SKIP -1
		DO WHILE !BOF() AND &ALS_itemmov .sld_estq = 0 ;
		                AND LScod = &ALS_itemmov .codigo ;
		                AND &ALS_empresa .empresa = &ALS_itemmov .empresa
			SKIP -1
		ENDDO
	ENDIF
	
	IF BOF() OR LScod <> &ALS_itemmov .codigo ;
			 OR &ALS_empresa .empresa <> &ALS_itemmov .empresa

		SELE &ALS_grupo
		SET ORDER TO TAG codigo

	   	SELE &ALS_saldo
	   	SET ORDER TO TAG emp_mes
 		SEEK STR( &ALS_empresa .empresa,3)+STR(YEAR(LDdtbase),4)+;
					STR(MONTH(LDdtbase),2)+ &ALS_grupo .classifica
		IF FOUND()
	   		LNsaldo    = &ALS_saldo .sld_ante
	   		LNcusto    = &ALS_saldo .vlr_ante
		ELSE
			SELECT  &ALS_itemmov
			SKIP		&& avanca p/ pegar data do 1o lancamento

			IF !BOF() AND LScod = &ALS_itemmov .codigo AND ;
				  		  &ALS_empresa .empresa = &ALS_itemmov .empresa)
			   SELE &ALS_saldo
			   SEEK STR( &ALS_empresa .empresa,3)+;
	   	   			STR(YEAR( &ALS_itemmov .data),4)+;
					STR(MONTH( &ALS_itemmov .data),2)+;
					&ALS_grupo .classifica

			   IF FOUND()
	  			    LNsaldo   = &ALS_saldo .sld_ante
				    LNcusto   = &ALS_saldo .vlr_ante
				ELSE
					&& NAO ENCONTROU NENUMA REFERENCIA ANTERIOR
					&& RECOMPOE A SALDO ANTERIOR ANULANDO OPERACAO

				    TMPcusto = 0
					IF &ALS_itemmov .sld_estq = 0
					    TMPcusto   = &ALS_itemmov .vlr_estq
					ELSE						
					    TMPcusto   = &ALS_itemmov .vlr_estq / ;
					                        &ALS_itemmov .sld_estq
					ENDIF

					DO CASE
						CASE LEFT( &ALS_itemmov .operacao,1) = "S"
					    	LNsaldo  = &ALS_itemmov .sld_estq + ;
					    				 &ALS_itemmov .qtde
						CASE LEFT( &ALS_itemmov .operacao,1) = "E"
					    	LNsaldo  = &ALS_itemmov .sld_estq - ;
					    				&ALS_itemmov .qtde
					ENDCASE	
		    	    LNcusto   = LNcusto + (LNsaldo * TMPcusto)
			   ENDIF
			ENDIF
		ENDIF
	ELSE
    	LNsaldo   = &ALS_itemmov .sld_estq
    	LNcusto   = &ALS_itemmov .vlr_estq
	ENDIF

	*-------------------------------------------------------------*
	
	IF LNsaldo = 0	&& EM ITEMMOV O ULTIMO CUSTO FICA REGISTRADO
					&& QDO O ESTOQUE ZERA PORTANTO DEVE SER ZARADO
					&& POIS A ROTINA DEVE REORNAR O CUSTO ESTOCADO
	    LNcusto   = 0
	ENDIF	


    =up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
	=up_fecha("&ALS_saldo")
    =up_fecha("&ALS_itemmov")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNcusto)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYVZ           EScustoAgregado VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   10   
*        Variable:            EScustoAgregado                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      111                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyvz     &&  EScustoAgregado VALID
#REGION 4
RETURN

FUNCTION EScustoAgregado
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Informar Custo M괺io do Produto Recomposto
	*             da Tributa눯o que implicara no custo desembolso
	*			  CUSTO + ICMS + RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNvlrdesembolso.: Custo M괺io do Produto no Momento
	*                       Agregado de Tributos => Custo desembolso
	*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNvlrdesembolso.: Custo M괺io do Produto no Momento
	*                       Agregado de Tributos => Custo desembolso
	*------------------------------------------------------------*
	PARAMETERS LNemp,LScod,LDdtbase, LShora, LNvlrdesembolso

	=W_DEFPROC("rotinas.spr")

	PRIVATE LNcusto
	PRIVATE LNvlrdesembolso

	*--------------------------------------------------------------------*
	* 	Calculo do Custo M괺io Agregando Tributos + Valore Que o Tornam
	* a Representa눯o do Valor Desembolsado
	*			LNCUSTO + LNicms + LNretido
	*--------------------------------------------------------------------*
	LNcusto = 0

	LNcusto	= EScustoMedio(LNemp,LScod,LDdtbase, LShora, LNcusto)

	*--------------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*

	*** LNvlrdesembolso =  ESAgregarTrbt(LNemp,LScod, LNCusto)

	LNvlrdesembolso =  LNcusto



RETURN(LNvlrdesembolso)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYW0           ESAgregarTrbt VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   11   
*        Variable:            ESAgregarTrbt                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      112                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyw0     &&  ESAgregarTrbt VALID
#REGION 4
RETURN

FUNCTION ESAgregarTrbt
	PARAMETERS LNemp,LScod, LNCusto

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Recompor ao valor informado a
	*             Tributa눯o que implicara no custo desembolso
	*			  CUSTO + ICMS + RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNvlrdesembolso.: Custo M괺io do Produto no Momento
	*                       Agregado de Tributos => Custo desembolso
	*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNvlrdesembolso.: Custo Informad do Produto
	*                       Agregado de Tributos => Custo desembolso
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal

	PRIVATE LNipi, LNicms

	PRIVATE LNbaseicms,LNicms,LNretido
	PRIVATE LNvlrdesembolso
	PRIVATE LNaliq_icms


	LNipi		=	0	
	LNicms		=	0



	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_grfiscal+ARQ_grfiscal) > 100000 ;
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	
	SELE &ALS_grupo
	SET ORDER TO TAG codigo

	SEEK LScod
	if not found()
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	endif

	SELE &ALS_grfiscal
	SET ORDER TO TAG tributacao
	SEEK &ALS_empresa .estado+LEFT( &ALS_grupo .classifica,5)

	LNaliq_icms		= 	7	&& % ver possibilidade de pasar em parametro
							&& A aliq_icms esta fixa em 7% porque
							&& os fornecedores sao de Sao Paulo
							&& mas deve ser feito um modelo que
							&& atenda a essa necessidade
							
	LNvlrdesembolso	=	LNcusto
	LNaliq_ipi		=	&ALS_grupo .aliq_ipi

	LNiva			=	&ALS_grfiscal .iva
	LNtpmercad		=	&ALS_grfiscal .tp_mercad

	*************************************************************


	LNbaseicms = (LNcusto*100) / (100+LNaliq_ipi-LNaliq_icms)

	LNicms	   = (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	LNipi	   = (LNbaseicms * LNaliq_ipi)/100

	LNretido   = 0


	IF LNtpmercad = 2 AND LNiva > 0
		LNretido   = (LNbaseicms + LNipi) * LNiva * 0.17 - LNicms
	ENDIF

	LNvlrdesembolso  = LNcusto + LNicms + LNretido


	*----------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNvlrdesembolso)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYW1           ESprc_compra VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   12   
*        Variable:            ESprc_compra                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      113                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyw1     &&  ESprc_compra VALID
#REGION 4
RETURN

**********************************************************************
*	Rotina para calculo do preco de compra e venda
*	chamado por SCGC807 SCGC800A E SCGC240A
**********************************************************************
* PARAMETROS
*
*	LNqtde		: Quantidade solicitada
*	LNtab		: Preco de tabela
*	LNdesc		: Desconto total (Normal ou Com Vendor ja aplicado)
*	LNalqipi	: Aliquota de IPI
*   LNalqfrt	: Taxa de Frete
*	LNicmralq	: Aliquota do retido
*	LNiva		: IVA ou MARCKUP
*	LNicmcalq	: Aliquota do ICM de Credito
*
* VARIAVEIS LOCAIS
*	LNliq		: Preco de Tabela Aplicado o Desconto
*	LNipi		: Valor do IPI sobre preco liquido
*	LNcti		: Custo inicial
*	LNfret		: Valor do frete
*	LNadic		: Adicional
*	LNicmc		: Valor ICM de Credito
*	LNicmr		: Valor ICM Retido
*	LNcto		: Custo Total
*	LNpis		: Aliquota do PIS
*	LNcofins	: Aliquota de Cofins
*	LNpcomra 	: Preco de Compra
*	LNpvd		: Preco de Venda
*
*******************************************************************

PROCEDURE ESprc_compra
	PARAMETERS LNqtde,LNtab,LNdesc,LNalqipi,LNalqfrt,LNicmralq,;
			   LNiva, LNicmcalq, LNvendor,LNliq,LNipi,;
			   LNcti,LNfret,LNadic,;
			   LNicmc, LNicmr, LNcto,;
			   LNpis,LNcofins,LNmargem;
			   LNpcompra,LNpvd

	PRIVATE ALL

	STORE 0 TO   LNliq,LNipi,LNcti,LNfret,LNadic,LNicmc,LNicmr,LNcto

	LNliq 		= ((LNtab * (1 - LNdesc/100)) * LNqtde ) * LNvendor
	LNipi 		= LNliq * (LNalqipi /100)
	LNcti 		= (LNliq + LNipi)
	LNfret		= LNcti * (LNalqfrt / 100)

	LNadic		= (LNicmralq /100) * ;
					LNcti * (1+(LNiva /100))

	LNicmc		= LNliq * (LNicmcalq / 100)

	LNicmr		= LNadic - LNicmc
	LNcto 		= (LNcti + LNadic + LNfret) - LNicmc
	LNpcompra 	= LNliq
	LNpvd	 	= LNcto / (1- (LNpis/100 + LNcofins/100 + LNmargem/100 ))

RETURN




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYW9           EScrtcestq VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   13   
*        Variable:            EScrtcestq                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      114                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyw9     &&  EScrtcestq VALID
#REGION 4
RETURN

**********************************************************************
*******************************************************************

PROCEDURE EScrtcestq
	PARAMETERS PrmDiasAcima
	
	=W_DEFPROC("rotinas.spr")
    PRIVATE LNpeso

	PRIVATE LSalias
	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_prvitstq , ALS_prvitstq

	LSalias			= ALIAS()


    ARQ_empresa  	= NetArqAgain("EMPRESA")
    ALS_empresa  	= Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_prvitstq  	= NetArqAgain("prvitstq")
    ALS_prvitstq  	= Alias()



	SELECT  IT.regional,IT.filial,lj.sigla,IT.codigo,;
		GR.descricao, 	IT.saldo,;
        IT.RVgiromedi AS giromedio, ;
        INT(IIF(IT.RVgiromedi > 0,IT.saldo /IT.RVgiromedi, ;
        			 IIF(IT.saldo>0,9999.00,0.00)))	 as duracao,;
        INT((IT.RVgiromedio*30)) as consumo, ;
        INT(((IT.RVgiromedio*30) - IT.saldo)) as ajuste ;
   	FROM &ALS_empresa LJ,;
   		 &ALS_grupo GR,;
         c:\tmp\prvitstq IT;
   	WHERE       	LJ.empresa = IT.regional ;
   		 and  	GR.codigo  = IT.CODIGO ;
         and 	((IT.saldo > 0 and IT.RVgiromedio = 0) ;
    	 or 	(IT.RVgiromedio > 0));
         and 	IT.filial = 999;
   	ORDER BY  filial, duracao ;
   	into cursor tmp1
   	
	SELECT * FROM tmp1 ;
        WHERE  duracao > PrmDiasAcima  ;
             AND not EMPTY(descricao) ;
	   	ORDER BY  regional,duracao

	REPORT FORM RES1110 TO FILE l:\TMP\PRT0001A.REL

   	=up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
   	=up_fecha("&ALS_prvitstq")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWA           EScrtcestq VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   14   
*        Variable:            EScrtcestq                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      115                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsywa     &&  EScrtcestq VALID
#REGION 4
RETURN

**********************************************************************
*******************************************************************

PROCEDURE EScrtcestq
	PARAMETERS PrmDiasAcima
	
	=W_DEFPROC("rotinas.spr")
    PRIVATE LNpeso

	PRIVATE LSalias
	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_prvitstq , ALS_prvitstq

	LSalias			= ALIAS()


    ARQ_empresa  	= NetArqAgain("EMPRESA")
    ALS_empresa  	= Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_prvitstq  	= NetArqAgain("prvitstq")
    ALS_prvitstq  	= Alias()



	SELECT  GR.codigo, GR.descricao,;
	 	IT.saldo,;
        IT.RVgiromedi AS giromedio, ;
        INT(IIF(IT.RVgiromedi > 0,IT.saldo /IT.RVgiromedi, ;
        			 IIF(IT.saldo>0,9999.00,0.00)))	 as duracao,;
        INT((IT.RVgiromedio*30)) as consumo, ;
        INT(((IT.RVgiromedio*30) - IT.saldo)) as ajuste ;
   	FROM &ALS_empresa LJ,;
   		 &ALS_grupo GR,;
         c:\tmp\prvitstq IT;
   	WHERE       	LJ.empresa = IT.regional ;
   		 and  	GR.codigo  = IT.CODIGO ;
         and 	((IT.saldo > 0 and IT.RVgiromedio = 0) ;
    	 or 	(IT.RVgiromedio > 0));
         and 	IT.filial = 999;
   	ORDER BY  filial, duracao ;
   	into cursor tmp1
   	
	SELECT * FROM tmp1 ;
        WHERE  duracao > PrmDiasAcima  ;
             AND not EMPTY(descricao) ;
	   	ORDER BY  regional,duracao

	REPORT FORM RES1110 TO FILE l:\TMP\PRT0001A.REL

   	=up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
   	=up_fecha("&ALS_prvitstq")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWC           ESextrato VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   15   
*        Variable:            ESextrato                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      116                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsywc     &&  ESextrato VALID
#REGION 4
RETURN

FUNCTION ESextrato
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	store "" to ARQ_tmp,ALS_tmp



	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*


	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF


	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	ALS_tmp = ALIAS()


	SELECT  data, ;
			left(hora,5) AS HORA,;
			LEFT(IIF(nota <> 0,"NF"+STR(nota,7),;
			    LEFT(TIPO,2)+STR(orcamento,6))+SPACE(10),10) as doc,;
			operacao, ;
			tipo,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			sld_estq  AS SALDO, ;
			sld_rese  AS SALDORES,;
			IIF(sld_estq > 0,vlr_estq / sld_estq,0000.00) AS cst_medio,;
			ULgetvlrUni(OPERACAO,EMPRESA,FAVORECIDO,;
			    ORCAMENTO,ORDEM,vlrvenda,QTDE) as VALOR_UNI, ;
			(icms_subs/qtde) AS ICMS_SUBS, ;
			(custo_ind/qtde) AS CUSTO_IND,;
			ESOrigDest(favorecido) AS ORIGEM,;
			IIF(negociacao = 2,"S"," ") AS vdcasada,;
			LEFT(RTRIM(DESCRICAO)+"-"+RTRIM(DESCRCOMPL)+"-"+INFO_COMPL,100) AS descricao;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)


	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			DOC			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			SALDO    	:H="SALDO"	:P="@r ####9" :R,;
			SALDORES 	:H="RES"	:P="@r ####9" :R, ;
			CST_MEDIO	:H="CST.M"	:P="@r ####9.99" :R, ;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			icms_subs	:H="R$.Sbst"	:P="@r ####9.99" :R, ;
			custo_ind	:H="Cust.Ind"	:P="@r ####9.99" :R, ;
			ORIGEM		:H="O/D"    :P="AAA" :R, ;
			vdcasada    :H="ENCOMENDA" :R,;
			descricao   :H="DESCRICAO";
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
    =up_fecha("TMPEXT")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF
	
RETURN


FUNCTION ULgetvlrUni
PARAMETERS PrmOperacao, PrmEmp, PrmFavorecido, ;
              PrmBoletim, PrmOrdem,PrmVlrVenda,PrmQtde

	PRIVATE LNVALOR_UNI

	LNVALOR_UNI = 00000000
	if LEFT(PrmOperacao,1) = "E"
		=W_DEFPROC("notaite.spr")
		LNVALOR_UNI=;
		  IEGetCusto(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem) / PrmQtde
	ELSE
		LNVALOR_UNI= PrmVlrVenda / PrmQtde
	ENDIF

RETURN(LNVALOR_UNI)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWF           ESimpext VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   16   
*        Variable:            ESimpext                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      117                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsywf     &&  ESimpext VALID
#REGION 4
RETURN


PROCEDURE ESimpext
PARAMETERS PrmRel
	DO UPPreImpressao WITH  PrmRel, .F. , .F., .F.
	CLEAR TYPEAHEAD
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWG           ESextRess VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   17   
*        Variable:            ESextRess                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      118                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsywg     &&  ESextRess VALID
#REGION 4
RETURN

FUNCTION ESextRess
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	store "" to ARQ_tmp,ALS_tmp


	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*


	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF


	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
        FOR  LEFT(OPERACAO,1) $ "E/S" ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo ;
		      AND DATA   <= PrmDtFim
		
	SELE 0
	USE &ARQ_tmp
	ALS_tmp = ALIAS()

	SELECT  data, ;
			dtfat AS dataemi,;
			operacao,;
			tipo,;
			IIF(nota <> 0,"NF"+STR(nota,7),LEFT(TIPO,2)+STR(orcamento,6)) as doc,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			IIF(qtde > 0,vlrvenda / Qtde,vlrvenda)   AS VALOR_UNI, ;
			(vlripi * 100 / vlrvenda) AS Aliqipi,;
			iva,;
			ESOrigDest(favorecido) AS ORIGEM;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)

	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407A"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ EXTRATO APOIO AO RESSARCIMENTO MANUAL ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
		BROWSE  FIELDS ;
				DATA		:H="DT.ENT" :R,;
				DATAEMI		:H="DT.EMI" :R,;
				QTDE     	:H="QTDE"	:P="@r ####9" :R,;
				DOC			:H="DOC" :R,;
				VALOR_UNI	:H="R$.UNI"	:P="@r #,##9.99" :R, ;
				ALIQIPI    	:H="IPI"	:P="@r ##" :R,;
				IVA     	:H="IVA"	:P="@r 9.99" :R,;
				TIPO     	:H="TIPO"	  :R,;
				OPERACAO   	:H="OPERACAO"  :R;
				TITLE "[ EXTRATO P/ RESSARCIMENTO ]";
				COLOR SCHEME 10 ;
				  NODELETE NOAPPEND NORMAL  NOEDIT;
			    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	
	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF

RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWI           ESOrigDest VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   18   
*        Variable:            ESOrigDest                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      119                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsywi     &&  ESOrigDest VALID
#REGION 4
RETURN

FUNCTION ESOrigDest
PARAMETERS PrmCGC
	PRIVATE LSalias,LSsigla
	LSalias = Alias()
	IF EMPTY(PrmCGC)
		RETURN("   ")
	ENDIF

	SELECT &ALS_empresa
	SET ORDER TO TAG CGC
	SEEK PrmCGC
	IF FOUND()
		LSsigla = &ALS_empresa .sigla
	else
		LSsigla = "   "
	ENDIF	
	SELE &LSalias
RETURN(LSsigla)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWJ           ESextEntradas VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   19   
*        Variable:            ESextEntradas                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      120                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsywj     &&  ESextEntradas VALID
#REGION 4
RETURN

FUNCTION ESextEntradas
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	PRIVATE LNsaldo
	
	store "" to ARQ_tmp,ALS_tmp
	LNsaldo = 0


	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*


	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF


	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		FOR     LEFT(operacao,1) = "E" ;
		    AND CH_OPERA = "1" ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	go top
	ALS_tmp = ALIAS()
	LNsaldo = 0
	LNctr   = 0

	SELECT  data, ;
			left(hora,5) AS HORA,;
			IIF(nota <> 0,"NF"+STR(nota,7),LEFT(TIPO,2)+STR(orcamento,6)) as doc,;
			operacao, ;
			tipo,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			ULESextrEnt(qtde,movestq,operacao) AS SALDO, ;
			sld_rese  AS SALDORES,;
			IIF(sld_estq > 0,vlr_estq / sld_estq,0) AS cst_medio,;
			IIF(qtde > 0,vlrvenda / Qtde,vlrvenda) as VALOR_UNI, ;
			ESOrigDest(favorecido) AS ORIGEM,;
			IIF(negociacao = 2,"S"," ") AS vdcasada;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			DOC			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			SALDO    	:H="SALDO"	:P="@r ####9" :R,;
			SALDORES 	:H="RES"	:P="@r ####9" :R, ;
			CST_MEDIO	:H="CST.M"	:P="@r ###9.99" :R, ;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			ORIGEM		:H="O/D"    :P="AAA" :R, ;
			vdcasada    :H="ENCOMENDA" :R;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	
	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF

RETURN


FUNCTION ULESextrEnt
PARAMETERS PrmQtde,PrmMovestq,PrmOperacao
	PRIVATE LnRetorno
	IF LNctr   = 0
		LNctr = 1
		RETURN(000000)
	ENDIF

	DO CASE
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "E"
			 LNsaldo = LNsaldo + PrmQtde
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "S"
			 LNsaldo = LNsaldo - PrmQtde
	ENDCASE	
	LnRetorno	 = LNsaldo
RETURN(LnRetorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWM           ESextTrasf VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   20   
*        Variable:            ESextTrasf                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      121                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsywm     &&  ESextTrasf VALID
#REGION 4
RETURN

FUNCTION ESextTrasf
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	PRIVATE LNsaldo
	
	store "" to ARQ_tmp,ALS_tmp
	LNsaldo = 0


	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*

	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF

	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		FOR     LEFT(operacao,1) = "E" ;
		    AND CH_OPERA = "2" ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	go top
	ALS_tmp = ALIAS()
	LNsaldo = 0
	LNctr   = 0

	SELECT  data, ;
			left(hora,5) AS HORA,;
			IIF(nota <> 0,"NF"+STR(nota,7),LEFT(TIPO,2)+STR(orcamento,6)) as doc,;
			operacao, ;
			tipo,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			ULESextrEnt(qtde,movestq,operacao) AS SALDO, ;
			sld_rese  AS SALDORES,;
			IIF(sld_estq > 0,vlr_estq / sld_estq,0) AS cst_medio,;
			IIF(qtde > 0,vlrvenda / Qtde,vlrvenda) as VALOR_UNI, ;
			ESOrigDest(favorecido) AS ORIGEM,;
			IIF(negociacao = 2,"S"," ") AS vdcasada;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			DOC			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			SALDO    	:H="SALDO"	:P="@r ####9" :R,;
			SALDORES 	:H="RES"	:P="@r ####9" :R, ;
			CST_MEDIO	:H="CST.M"	:P="@r ###9.99" :R, ;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			ORIGEM		:H="O/D"    :P="AAA" :R, ;
			vdcasada    :H="ENCOMENDA" :R;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF
	
RETURN


FUNCTION ULESextrEnt
PARAMETERS PrmQtde,PrmMovestq,PrmOperacao
	PRIVATE LnRetorno
	IF LNctr   = 0
		LNctr = 1
		RETURN(000000)
	ENDIF

	DO CASE
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "E"
			 LNsaldo = LNsaldo + PrmQtde
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "S"
			 LNsaldo = LNsaldo - PrmQtde
	ENDCASE	
	LnRetorno	 = LNsaldo
RETURN(LnRetorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWP           ESVld_Produto VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   21   
*        Variable:            ESVld_Produto                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      122                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsywp     &&  ESVld_Produto VALID
#REGION 4
RETURN
PROCEDURE ESVld_Produto
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Pesquisar Produtos em uma Lista
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: GRUPO
	*------------------------------------------------------------*
	* PARAMETROS..:
	*             LScodigo : Codigo do Produto - Pode Ser Utiliza
	*                  para posicionamento parcial
	*------------------------------------------------------------*
	* CHAMADAS.............:
	*------------------------------------------------------------*
	PARAMETERS LScodigo

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_grupo, ALS_grupo
  	PRIVATE LFretorno

    LSalias      = Alias()
    ARQ_grupo    = NetArqAgain("GRUPO")
    ALS_grupo    = Alias()

	SELE &ALS_grupo
	SET ORDER TO TAG codigo
	SEEK ALLTRIM(LScodigo)
	IF !FOUND()
	   LFretorno= .f.
	ELSE
	   LFretorno= .T.
	ENDIF

	=UP_fecha(ALS_GRUPO)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWR           ESGet_Origem VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         ESTOQUE,     Record Number:   22   
*        Variable:            ESGet_Origem                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      123                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsywr     &&  ESGet_Origem VALID
#REGION 4
RETURN
FUNCTION ESGet_Origem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	PARAMETERS LScodigo,PrmOrigem

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_grupo, ALS_grupo
  	PRIVATE LFretorno

    LSalias      = Alias()
    ARQ_grupo    = NetArqAgain("GRUPO")
    ALS_grupo    = Alias()

	SELE &ALS_grupo
	SET ORDER TO TAG codigo
	SEEK ALLTRIM(LScodigo)
	IF FOUND()
	   PrmOrigem= 	&Als_Grupo .origem
	   LFretorno= 	.t.
	ELSE
	   PrmOrigem= 	0
	   LFretorno= .f.
	ENDIF

	=UP_fecha(ALS_GRUPO)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWS           MVAtu_Cmd VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    2  
*        Variable:            MVAtu_Cmd                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      124                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyws     &&  MVAtu_Cmd VALID
#REGION 5
RETURN

******---------------------------------
* APOS A GRAVACAO DO NOVO REGISTRO DE ITEMMOV GERADO POR ENTRADAS,
*	 ESTA ROTINA E ATIVADA  //  ou // PARA CORRECAO DO ESTOQUE
*
*   - VOLTA UM REGISTRO
*	- CAPTURA CUSTO MEDIO ANTERIOR
*	- LOOP NO MOVIMENTO DO PRODUTO
*		-AVANCA UM REGISTRO
*		-RECALCULA CUSTO MEDIO
*
*	- FIM LOOP
*   - ATULIZA VALORES NO CONTROLE DA SALDOS DOS MESES AFETADOS
****************************************
PROCEDURE MVatu_cmd		&& ATUALIZA CUSTO MEDIO COM BASE NO ITEMMOV
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata,;
			PRMhora,;
			PRMtipo,;
			PRMnota,;
			PRMordem

*	IF PRMcodigo = "13010719"
*		set step on
*	endif

    = W_DEFPROC("rotinas.spr")

	SELE Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)


	*------------------------------------------------------------------*
	*   Inicio Efetivo da Rotina Apos o Posicionamento
	*------------------------------------------------------------------*

	PRIVATE sld_ante, vlr_ante, res_ante
	PRIVATE sld_atu, vlr_atu, dt_entrada, dt_saida

	PRIVATE	LNredutor   &&    Indice de reducao de icms em entrada
						&& Transf Internas
	PRIVATE	LSoperacao  &&    Indica a operacao "*" ou "/" que envolvera
						&& o LNredudor

    && Valores Basicos  Saldo

	PRIVATE LNvlratu	&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNsldatu	&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNcstmedio  && CUSTO MEDIO DO PRODUTO
	PRIVATE LNreserva   && saldo em reserva


    && Valores de Detalhementos de Saldo
	PRIVATE m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	

	store 0 to  sld_ante, vlr_ante, res_ante, sld_atu, vlr_atu
	store {} to dt_entrada, dt_saida

			
	store 0 to m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	



	LNvlratu	= 0		&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	LNsldatu	= 0		&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	LNcstmedio  = 0     && CUSTO MEDIO DO PRODUTO
	LNreserva   = 0     && saldo em reserva


    =MVBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)


    =MVObterSaldos( m.sld_ante, m.vlr_ante, m.res_ante,;
                  m.dt_entrada, m.dt_saida,;
    			  LNsldatu, LNvlratu, LNreserva,;
    	          m.qtd_compra, m.vlr_compra, ;
   	              m.qtd_venda , m.vlr_venda , ;
   	              m.qtd_e_tran, m.vlr_e_tran, ;
   	              m.qtd_e_outr, m.vlr_e_outr, ;
   	              m.qtd_s_tran, m.vlr_s_tran, ;
		          m.qtd_s_outr, m.vlr_s_outr, ;
				  m.ven_tab, m.ven_contab, m.ven_enc, ;
	 			  m.reserva)


	************************************************************
	=MVprocessaMvto(PRMempresa,;
					PRMcodigo,;
					PRMclasse,;
					PRMdata,;
					PRMhora,;
					PRMtipo,;
					PRMnota,;
					PRMordem)


	***************************
	****************	ATUALIZANDA SALDOS ABERTOS EM MESES FUTUROS
	****************
    =MVDesBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)
	
	SELE ITEMMOV
	SET ORDER TO TAG movimento
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWU           MVCancelMvto VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    3  
*        Variable:            MVCancelMvto                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      125                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsywu     &&  MVCancelMvto VALID
#REGION 5
RETURN

******---------------------------------
****************************************
PROCEDURE MVCancelMvto
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata,;
			PRMhora,;
			PRMtipo,;
			PRMnota,;
			PRMordem

    = W_DEFPROC("rotinas.spr")

	SELE Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)




	PRIVATE sld_ante, vlr_ante, res_ante
	PRIVATE sld_atu, vlr_atu, dt_entrada, dt_saida

	PRIVATE	LNredutor   &&    Indice de reducao de icms em entrada
						&& Transf Internas
	PRIVATE	LSoperacao  &&    Indica a operacao "*" ou "/" que envolvera
						&& o LNredudor

    && Valores Basicos  Saldo

	PRIVATE LNvlratu	&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNsldatu	&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	PRIVATE LNcstmedio  && CUSTO MEDIO DO PRODUTO
	PRIVATE LNreserva   && saldo em reserva


    && Valores de Detalhementos de Saldo
	PRIVATE m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	

	store 0 to  sld_ante, vlr_ante, res_ante, sld_atu, vlr_atu
	store {} to dt_entrada, dt_saida

			
	store 0 to m.qtd_compra, m.vlr_compra, ;
   	        m.qtd_venda , m.vlr_venda , ;
   	        m.qtd_e_tran, m.vlr_e_tran, ;
   	        m.qtd_e_outr, m.vlr_e_outr, ;
   	        m.qtd_s_tran, m.vlr_s_tran, ;
		    m.qtd_s_outr, m.vlr_s_outr, ;
			m.ven_tab   , m.ven_contab, ;
			m.ven_enc   , m.reserva 	



	LNvlratu	= 0		&& VALOR DO ESTOQUE NA OPERACAO ATUAL
	LNsldatu	= 0		&& SALDO DO ESTOQUE NA OPERACAO ATUAL
	LNcstmedio  = 0     && CUSTO MEDIO DO PRODUTO
	LNreserva   = 0     && saldo em reserva

    =MVBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)

    =MVObterSaldos( m.sld_ante, m.vlr_ante, m.res_ante,;
	              m.dt_entrada, m.dt_saida,;
    			  LNsldatu, LNvlratu, LNreserva,;
    	          m.qtd_compra, m.vlr_compra, ;
   	              m.qtd_venda , m.vlr_venda , ;
   	              m.qtd_e_tran, m.vlr_e_tran, ;
   	              m.qtd_e_outr, m.vlr_e_outr, ;
   	              m.qtd_s_tran, m.vlr_s_tran, ;
		          m.qtd_s_outr, m.vlr_s_outr, ;
				  m.ven_tab, m.ven_contab, m.ven_enc, ;
	 			  m.reserva)
	************************************************************

	*----------------------------------------------------------------*
	*    Efetiva Cancelamento do Registro de Movimento
	*----------------------------------------------------------------*
	
    SELE itemmov
    =edithand('APAGA')

	SELE itmanexo
	SET ORDER TO TAG movanexo
	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)
	IF FOUND()
		=REGLOCK(.T.)
		=edithand('APAGA')
		UNLOCK
	ENDIF

    SELE itemmov
	*----------------------------------------------------------------*


	=MVprocessaMvto(PRMempresa,;
					PRMcodigo,;
					PRMclasse,;
					PRMdata,;
					PRMhora,;
					PRMtipo,;
					PRMnota,;
					PRMordem)

	***************************
	****************	ATUALIZANDA SALDOS ABERTOS EM MESES FUTUROS
	****************
    =MVDesBlqSaldo(PRMempresa, PRMcodigo, PRMclasse, PRMdata)
	
	SELE ITEMMOV
	SET ORDER TO TAG movimento
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWY           MVBlqSaldo VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    4  
*        Variable:            MVBlqSaldo                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      126                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsywy     &&  MVBlqSaldo VALID
#REGION 5
RETURN

******---------------------------------

FUNCTION MVBlqSaldo		&& Bloquear Reg de Saldo
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata

 	SELE saldo	

	************ POSICIONA SALDO CASO NAO TENHA SIDO FEITO ANTES ******
    SET ORDER TO TAG clas_saldo
    SEEK STR(PRMempresa,3)+PRMclasse+;
         STR(YEAR(PRMdata),4)+;
         STR(MONTH(PRMdata),2)

    IF !FOUND()

        =MVIniRegSaldos(PRMempresa,;
        			    PRMdata, ;
        			 	PRMcodigo,;
        			 	m.sld_atu,;
        			 	m.vlr_atu,;
        			 	m.reserva)

 		SELE SALDO
	    SET ORDER TO TAG clas_saldo
        SEEK STR(PRMempresa,3)+PRMclasse+;
    		 STR(YEAR(PRMdata),4)+;
             STR(MONTH(PRMdata),2)
   		IF !FOUND()
			=uperrosys()
			 WAIT WINDOW "ERRO. REG.SALDO NAO LOCALIZADO. <ENTER>..."
			 CLOSE ALL
			 QUIT
		ENDIF
	ENDIF
	*************************************************************

RETURN(reglock(.T.)) 	&& CONFIRMA O BLOQUEIO DO SALDO


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYWZ           MVDesBlqSaldo VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    5  
*        Variable:            MVDesBlqSaldo                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      127                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsywz     &&  MVDesBlqSaldo VALID
#REGION 5
RETURN

******---------------------------------

FUNCTION MVDesBlqSaldo		&& Bloquear Reg de Saldo
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata

 	SELE saldo	

	************ POSICIONA SALDO CASO NAO TENHA SIDO FEITO ANTES ******
    SET ORDER TO TAG clas_saldo
    SEEK STR(PRMempresa,3)+PRMclasse+;
         STR(YEAR(PRMdata),4)+;
         STR(MONTH(PRMdata),2)

    IF FOUND()
	   UNLOCK
	ENDIF

RETURN(reglock(.T.)) 	&& CONFIRMA O BLOQUEIO DO SALDO


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYX0           MVObterSaldos VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    6  
*        Variable:            MVObterSaldos                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      128                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyx0     &&  MVObterSaldos VALID
#REGION 5
RETURN

******---------------------------------

PROCEDURE MVObterSaldos

********************   INICIO DA BUSCA DE SALDOS  **********************
PARAMETERS        m.sld_ante, m.vlr_ante, m.res_ante,;
                  m.dt_entrada, m.dt_saida,;
				  LNsldatu, LNvlratu, LNreserva,;
    	          qtd_compra, vlr_compra, ;
   	              qtd_venda , vlr_venda , ;
   	              qtd_e_tran, vlr_e_tran, ;
   	              qtd_e_outr, vlr_e_outr, ;
   	              qtd_s_tran, vlr_s_tran, ;
		          qtd_s_outr, vlr_s_outr, ;
				  ven_tab, ven_contab, ven_enc, ;
	 			  reserva

    ARQ_Itemmov  = NetArqAgain("ITEMMOV")
    ALS_Itemmov  = Alias()


    ARQ_ItmAnexo  = NetArqAgain("ITMANEXO")
    ALS_ItmAnexo  = Alias()

    ARQ_Saldo    = NetArqAgain("SALDO")
    ALS_Saldo   = Alias()


	* Captar Saldo Inicial do Mes

    SELE &ALS_Saldo
  	SET ORDER TO TAG clas_saldo
    SEEK STR(itemmov.empresa,3)+itemmov.classifica+;
    	    STR(YEAR(itemmov.data),4)+;
            STR(MONTH(itemmov.data),2)
	IF FOUND()
		m.sld_ante 	= &ALS_Saldo .sld_ante
	   	m.vlr_ante 	= &ALS_Saldo .vlr_ante
	   	m.res_ante 	= &ALS_Saldo .res_ante
		m.dt_entrada= &ALS_Saldo .dt_entrada
		m.dt_saida	= &ALS_Saldo .dt_saida

	ELSE
		m.sld_ante = 0	
	   	m.vlr_ante = 0
	   	m.res_ante 	= 0
		m.dt_entrada= {}
		m.dt_saida	= {}
	ENDIF




	SELE &ALS_Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SET NEAR ON

	SEEK STR(itemmov.EMPRESA,3) + itemmov.CODIGO   +;
		 DTOS(itemmov.DATA)     + itemmov.HORA     +;
		 itemmov.TIPO           + STR(itemmov.NOTA,7)      +;
		 STR(itemmov.ORDEM,3)

	SET NEAR OFF


	IF !(BOF() AND EOF())       && ITEMMOV ESTA VAZIO
		SKIP -1
		********************************************************
		* INICIO : ESTE BLOCO DE COMANDO FOI COLOCADO PARA EVITAR
		*          QUE QUANDO UMA RESERVA ESTIVER SENDO CANCELADA
		*          E OUTRO USUARIO INICIAR A ROTINA ATU_CMD O
		*          REGISTRO DE RESERVA QUE ESTA EM PROCESSO "****"
		*		   NAO INTERFIRA NO SALDO PROVOCANDO A MANUTENCAO
		*			DE SALDO DE RESERVA SENDO QUE A MESMA JA SAIU
		********************************************************
		DO WHILE !BOF()
		  IF &ALS_Itemmov .codigo  <> ITEMMOV.CODIGO ;
             OR &ALS_Itemmov .empresa <> ITEMMOV.EMPRESA
				EXIT
		  ENDIF

		  IF SUBS(&ALS_Itemmov .operacao,2,3) <> "***"
				EXIT
		  ENDIF
		  SKIP -1
		ENDDO
		***********************************************************
		* FIM DO BLOCO
		***********************************************************
	ENDIF
	IF BOF() ;
           OR &ALS_Itemmov .codigo      <> ITEMMOV.CODIGO ;
           OR &ALS_Itemmov .empresa     <> ITEMMOV.EMPRESA ;
		   OR YEAR(&ALS_Itemmov .data)  <> YEAR(ITEMMOV.data) ;
 		   OR MONTH(&ALS_Itemmov .data) <> MONTH(ITEMMOV.data)
						

			LNsldatu  = &ALS_Saldo .sld_ante
			LNvlratu  = &ALS_Saldo .vlr_ante
			LNreserva = &ALS_Saldo .res_ante
			m.res_ant = &ALS_Saldo .res_ante
	        STORE 0  TO  qtd_compra, vlr_compra, ;
     	                 qtd_venda , vlr_venda , ;
   	                     qtd_e_tran, vlr_e_tran, ;
   	                     qtd_e_outr, vlr_e_outr, ;
   	                     qtd_s_tran, vlr_s_tran, ;
		                 qtd_s_outr, vlr_s_outr, ;
 			 	         ven_tab, ven_contab, ven_enc, ;
	 			         reserva
	ELSE
		m.sld_ante = &ALS_Saldo .sld_ante
		m.vlr_ante = &ALS_Saldo .vlr_ante
		m.res_ante = &ALS_Saldo .res_ante

		LNsldatu  = &ALS_Itemmov .sld_estq
		LNvlratu  = &ALS_Itemmov .vlr_estq
		LNreserva = &ALS_Itemmov .sld_rese

		SELE &ALS_ItmAnexo
		SET ORDER TO TAG movanexo
		SEEK  STR(&ALS_Itemmov .empresa,3)+;
		          &ALS_Itemmov .codigo+;
			 DTOS(&ALS_Itemmov .data)+;
			      &ALS_Itemmov .hora+;
			      &ALS_Itemmov .tipo+;
			  STR(&ALS_Itemmov .nota,7)+;
			  STR(&ALS_Itemmov .ordem,3)

		IF !FOUND()
			m.qtd_compra = 0
			m.vlr_compra = 0
			m.qtd_venda  = 0
			m.vlr_venda  = 0
			m.qtd_e_tran = 0
			m.vlr_e_tran = 0
			m.qtd_e_outr = 0
			m.vlr_e_outr = 0
			m.qtd_s_tran = 0
			m.vlr_s_tran = 0
			m.qtd_s_outr = 0
			m.vlr_s_outr = 0
			m.ven_tab    = 0
			m.ven_contab = 0
			m.ven_enc    = 0
		ELSE
	        m.qtd_compra	= &ALS_ItmAnexo .q_compra
    	    m.vlr_compra	= &ALS_ItmAnexo .v_compra
        	m.qtd_venda 	= &ALS_ItmAnexo .q_venda
	        m.vlr_venda 	= &ALS_ItmAnexo .v_venda
	        m.qtd_e_tran	= &ALS_ItmAnexo .qe_tran
	        m.vlr_e_tran	= &ALS_ItmAnexo .ve_tran
	        m.qtd_e_outr	= &ALS_ItmAnexo .qe_outr
	        m.vlr_e_outr	= &ALS_ItmAnexo .ve_outr
	        m.qtd_s_tran	= &ALS_ItmAnexo .qs_tran
	        m.vlr_s_tran	= &ALS_ItmAnexo .vs_tran
	        m.qtd_s_outr	= &ALS_ItmAnexo .qs_outr
	        m.vlr_s_outr	= &ALS_ItmAnexo .vs_outr
	        m.ven_tab		= &ALS_ItmAnexo .v_tab
	        m.ven_contab	= &ALS_ItmAnexo .v_contab
	        m.ven_enc		= &ALS_ItmAnexo .v_enc
		ENDIF
	ENDIF

    =up_fecha("&ALS_Itemmov")
    =up_fecha("&ALS_ItmAnexo")
    =up_fecha("&ALS_Saldo")

	SELE itemmov

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYX2           MVIniRegSaldos VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    7  
*        Variable:            MVIniRegSaldos                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      129                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyx2     &&  MVIniRegSaldos VALID
#REGION 5
RETURN

******---------------------------------

PROCEDURE  MVIniRegSaldos   && Inicializa Registro de Saldos
PARAMETER 	LNempresa, LD_data, LScodigo, ;
            SLD_Abertura,;
            VLR_abertura, ;
            SLD_Reserva


        SELE GRUPO
        SET ORDER TO TAG CODIGO
        SEEK LScodigo
        IF !FOUND()
			=uperrosys()
			 WAIT WINDOW "ERRO. REG.PRODUTO NAO LOCALIZADO. <ENTER>..."
			 CLOSE ALL
			 QUIT
        ENDIF

        LSclassifica = Grupo.classifica

		SELE SALDO
		SET ORDER TO TAG emp_mes	
 		SEEK 	STR(LNempresa,3)+;
  			    STR(YEAR(LD_data),4)+;
			    STR(MONTH(LD_data),2)+;
			    LSclassifica
		**************************
	    m.empresa    = LNempresa
	    m.codigo     = LScodigo
	    m.classifica = LSclassifica
	    m.sld_ante   = SLD_Abertura
	    m.vlr_ante   = VLR_abertura
        m.res_ante   = SLD_Reserva
        m.reserva    = SLD_Reserva
		m.qtd_compra = 0
		m.vlr_compra = 0
		m.qtd_venda  = 0
		m.vlr_venda  = 0
		m.qtd_e_tran = 0
		m.vlr_e_tran = 0
		m.qtd_e_outr = 0
		m.vlr_e_outr = 0
		m.qtd_s_tran = 0
		m.vlr_s_tran = 0
		m.qtd_s_outr = 0
		m.vlr_s_outr = 0
		m.ven_tab    = 0
		m.ven_contab = 0
		m.ven_enc    = 0
	    m.status     = 'A'
	    IF FOUND()
	    	=REGLOCK(.T.)
			=edithand('REGRAVA')
	    ELSE
		    m.dtabert    = LD_data
			=edithand('SAVE')
	    ENDIF
	    UNLOCK
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYX4           MVprocessaMvto VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    8  
*        Variable:            MVprocessaMvto                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      130                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyx4     &&  MVprocessaMvto VALID
#REGION 5
RETURN


FUNCTION MVprocessaMvto		&& ATUALIZA CUSTO MEDIO COM BASE NO ITEMMOV
PARAMETERS 	PRMempresa,;
			PRMcodigo,;
			PRMclasse,;
			PRMdata,;
			PRMhora,;
			PRMtipo,;
			PRMnota,;
			PRMordem


	************************************************************

	SELE Itemmov
 	SET ORDER TO TAG movimento   && ORGANIZA NA ORDEM DA GRAVACAO
	SET NEAR ON

	SEEK STR(PRMempresa,3) + ;
			  PRMcodigo    + ;
		 DTOS(PRMdata)     + ;
		 	  PRMhora  + ;
		 	  PRMtipo      + ;
		 STR( PRMnota,7)   + ;
		 STR(PRMordem,3)


	SET NEAR OFF
	
	DO WHILE !EOF() ;
			AND PRMCodigo = itemmov.codigo ;
		    AND PRMEmpresa  = itemmov.empresa
		*-----------------------------------------------------------------*
		*  A condicao :
 		*   (PRMCodigo = itemmov.codigo OR PRMClasse= itemmov.classifica) ;
		*   foicolocada em substituicao a:
 		*   (PRMClasse = itemmov.classifica) ;
 		* POR MOTIVO DE  UMA CORRUPCAO NO CAMPO classifica do itemmov
 		* que provocava a saida do laco e nao processava os movimentos
 		* posteriores ao itemmov danificado. Como o codigo estava intacto
 		* esta condicao permite uma tolerancia a corrupcao do campo
 		* mesmo nao resolvendo o problema
		*-----------------------------------------------------------------*
		MsgStep = STR(PRMempresa,3)+"-"+itemmov.codigo+"-"+;
		          DTOS(itemmov.data)+"-"+itemmov.hora+"-"+;
		          itemmov.tipo+"-"+STR( itemmov.nota,7)+"-"+;
				STR(itemmov.ordem,3)
		wait window MsgStep nowait
 		
		

		SELE itemmov
		=REGLOCK(.T.)		&& BLOQ. ITEMMOV P/ ATUALIZAR

		IF YEAR(saldo.dtabert)  <> YEAR(itemmov.data) or ;
		   MONTH(saldo.dtabert) <> MONTH(itemmov.data)

				****** TESTA MOTIVO DO CHAMADO A ROTINA ********
				***********************************************

			    =MVAtlzSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
						    m.sld_ante, 		m.vlr_ante, ;
						    m.res_ante,;
			    			LNsldatu, 			LNvlratu, ;
							m.qtd_compra, 		m.vlr_compra, ;
  			 				m.qtd_venda , 		m.vlr_venda , ;
 			  				m.qtd_e_tran, 		m.vlr_e_tran, ;
  			  				m.qtd_e_outr, 		m.vlr_e_outr, ;
  			  				m.qtd_s_tran, 		m.vlr_s_tran, ;
  			  				m.qtd_s_outr, 		m.vlr_s_outr)

				* Rotina complementar em funcao do excesso de parametros
				* para MVAtlzSaldos impedir o uso de uma so procedure

			    =MVAtlzComplSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
				  				m.ven_tab, ;
				  				m.ven_contab, ;
								m.ven_enc, ;
				  				m.dt_entrada, ;
				  				m.dt_saida, ;
			  					LNreserva )



				*----------------------------------------------------*
				*   O movimento Passou para uma data fora do mes
				* em que o registro de saldo estava posicionado,
				* entao o reg. de saldo deve ser inicializado no
				* mes seguite mesmo que o movimento tenha saltado
				* mais de um mes, ou seja, pode haver um mes sem
				* REGISTRO DE MOVIMENTO mas nao sem REGISTRO DE SALDO
				*----------------------------------------------------*

				LD_nvdata = GOMONTH(saldo.dtabert,1)


		        =MVIniRegSaldos( saldo.empresa,;
		        			     LD_nvdata,;
		        			     saldo.codigo,;
		        			     LNsldatu,;
		        			     LNvlratu,;
		        			     LNreserva)

				SELE itemmov

				LOOP
		ENDIF




		PRIVATE tipo,operacao, qtde, tp_mercad, cst
		PRIVATE aliq_icms, vlrvenda,base_calc, vlripi, custo_ind
        PRIVATE icms_subs
		PRIVATE preco, ch_opera, ch_desti, codigo, classifica

		PRIVATE movfin,movestq,movvalor,movcusto
		PRIVATE orcamento,codforn


		SCATTER MEMVAR MEMO FIELDS tipo,operacao, qtde, tp_mercad, cst,;
			aliq_icms, vlrvenda,base_calc, vlripi, custo_ind, preco,;
            icms_subs,	ch_opera, ch_desti, codigo, classifica,;
			movfin,movestq,movvalor,movcusto,orcamento,codforn

*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
*>>>>>>>>>>>>>>>>>>>>>>>>>>   MOVIMENTACAO DE SALDOS AUXILIARES
*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		SET DECIMALS TO 8

        =MVGetCustMedio((operacao), (movcusto),LNcstmedio, ;
         							 LNsldatu, LNvlratu)

		*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		LNredutor   = 0
		LSoperacao  = "/"		&& => DIVISAO PELO LNredutor

        =MVGetIndRedutor((operacao), LNredutor,LSoperacao)

		IF LEFT(m.operacao,1) = "E"
			m.dt_entrada  = itemmov.data
		ELSE
			IF LEFT(m.operacao,1) = "S"
					m.dt_saida  = itemmov.data
			ENDIF			
		ENDIF

		*----------------------------------------------------------*
	*	PRIVATE LSUfOrigem
	*	PRIVATE LSUfDestino
		PRIVATE LNcusto

		IF LEFT(itemmov.operacao,1) = "E"		&& ENTRADAS
			=W_DEFPROC("notaite.spr")
			LNcusto= IEGetCusto( itemmov.Empresa, ;
					         itemmov.Favorecido,;
							 itemmov.orcamento , ;					
							 itemmov.ordem)
		ELSE
			LNcusto = 0
		ENDIF

		*----------------------------------------------------------*



		DO MVSetSldEntradas WITH LNcusto

		DO MVSetSldSaida
		
		DO MVSetSaldos WITH PrmEmpresa, LNcusto



		*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		*>>>>>>>>>>>>>>>>>>>>> FIM DOS TESTES DE CONTROLE DE MOVIMENTACAO
		*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
		SET DECIMALS TO 2



		SELE itmanexo
		*****************************************************
        =MVSincrItmAnexo(m.qtd_compra, m.vlr_compra, m.qtd_venda,;
        				m.vlr_venda,  m.qtd_e_tran,    m.vlr_e_tran, ;
        				m.qtd_e_outr, m.vlr_e_outr, m.qtd_s_tran,;
        				m.vlr_s_tran, m.qtd_s_outr, m.vlr_s_outr,;
        				m.ven_tab	, m.ven_contab, m.ven_enc)
		*****************************************************
		m.sld_estq	= LNsldatu
		IF m.sld_estq = 0 OR LNvlratu = 0
		   m.vlr_estq = LNcstmedio && ULTIMO CUSTO
		   LNvlratu	  =  LNcstmedio
		ELSE
		    m.vlr_estq  = LNvlratu
		ENDIF
        IF LNreserva < 0	&& caso de interf. do usua.no reg. de res.
			LNreserva = 0
		ENDIF
		m.sld_rese  = LNreserva

		

		SELE itemmov
		SET FIELDS TO dtregis, hregis, usrregis,deletado
	    SET FIELDS TO sld_estq, vlr_estq, sld_rese
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		*****************************************************
		UNLOCK
		SKIP
	ENDDO

 	SELECT SALDO

	=MVAtlzSaldos(saldo.empresa,saldo.classifica,;
			    			 saldo.dtabert,;
						    m.sld_ante,	m.vlr_ante, ;
                            m.res_ante,;
			    			LNsldatu, 			LNvlratu, ;
							m.qtd_compra, 		m.vlr_compra, ;
   			 				m.qtd_venda , 		m.vlr_venda , ;
   			  				m.qtd_e_tran, 		m.vlr_e_tran, ;
   			  				m.qtd_e_outr, 		m.vlr_e_outr, ;
   			  				m.qtd_s_tran, 		m.vlr_s_tran, ;
   			  				m.qtd_s_outr, 		m.vlr_s_outr)

				* Rotina complementar em funcao do excesso de parametros
				* para MVAtlzSaldos impedir o uso de uma so procedure

    =MVAtlzComplSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
				  				m.ven_tab, ;
				  				m.ven_contab, ;
								m.ven_enc, ;
				  				m.dt_entrada, ;
				  				m.dt_saida, ;
			  					LNreserva )



	PRMdata = saldo.dtabert

 	SELECT SALDO
	UNLOCK
	=MVSldFuturo(PRMempresa,;
				 PRMclasse,;
				 PRMdata,;
				 LNsldatu,;
				 LNvlratu,;
				 LNreserva)

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYX8           MVSincrItmAnexo VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:    9  
*        Variable:            MVSincrItmAnexo                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      131                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyx8     &&  MVSincrItmAnexo VALID
#REGION 5
RETURN

******---------------------------------

PROCEDURE MVSincrItmAnexo
PARAMETERS  m.q_compra, m.v_compra,  m.q_venda, m.v_venda,;
			m.qe_tran , m.ve_tran ,  m.qe_outr, m.ve_outr,;
			m.qs_tran , m.vs_tran ,  m.qs_outr, m.vs_outr,;
			m.v_tab   , m.v_contab,  m.v_enc

			


********************  INICIO DA BUSCA DE SALDOS **********************
	SELE itmanexo
	SET ORDER TO TAG movanexo
	SEEK STR(itemmov.empresa,3)+itemmov.codigo+;
			 DTOS(itemmov.data)+itemmov.hora+itemmov.tipo+;
			 STR(itemmov.nota,7)+STR(itemmov.ordem,3)
	IF !FOUND()
		SELE itmanexo
		SET ORDER TO TAG movanexo
		m.empresa 	= itemmov.empresa
		m.codigo 	= itemmov.codigo
	    m.classifica = itemmov.classifica
		m.data		= itemmov.data
		m.hora		= itemmov.hora
		m.tipo		= itemmov.tipo
		m.nota		= itemmov.nota
		m.ordem		= itemmov.ordem

		=edithand('SAVE')
    ELSE
		***************************
		SET FIELDS TO dtregis, hregis, usrregis,deletado
		SET FIELDS TO ;
  	           	q_compra, v_compra,q_venda, v_venda, qe_tran, ve_tran,;
				qe_outr,ve_outr,qs_tran, vs_tran, qs_outr,vs_outr,;
				v_tab, v_contab, v_enc	
		=edithand('REGRAVA')
		CLEAR FIELDS
		SET FIELDS OFF
		***************************
	ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYX9           MVAtlzSaldos VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   10  
*        Variable:            MVAtlzSaldos                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      132                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyx9     &&  MVAtlzSaldos VALID
#REGION 5
RETURN

******---------------------------------

PROCEDURE MVAtlzSaldos

PARAMETERS   	PRempresa,			PRclassifica,;
				PRdata,;
			    m.sld_ante, 		m.vlr_ante, ;
                m.res_ante,;
	   			m.sld_atu, 			m.vlr_atu, ;
				m.qtd_compra, 		m.vlr_compra, ;
    			m.qtd_venda , 		m.vlr_venda , ;
    			m.qtd_e_tran, 		m.vlr_e_tran, ;
    			m.qtd_e_outr, 		m.vlr_e_outr, ;
    			m.qtd_s_tran, 		m.vlr_s_tran, ;
    			m.qtd_s_outr, 		m.vlr_s_outr


	IF m.sld_atu = 0
		m.sld_atu = 0
		m.vlr_atu = 0
*	ELSE
*        IF m.reserva < 0	&& caso de interf. do usua.no reg. de res.
*			m.reserva = 0
*		ENDIF
	ENDIF




    ARQ_Saldo    = NetArqAgain("SALDO")
    ALS_Saldo    = Alias()

   	SELE &ALS_Saldo
  	SET ORDER TO TAG clas_saldo
    SEEK STR(PRempresa,3)+PRclassifica+;
    		STR(YEAR(PRdata),4)+;
        	STR(MONTH(PRdata),2)

	***************************
	SET FIELDS TO dtregis, hregis, usrregis,deletado
    SET FIELDS TO sld_ante, vlr_ante, ;
                  res_ante,;
			      sld_atu, vlr_atu, qtd_compra, vlr_compra, ;
    			  qtd_venda , vlr_venda , ;
    			  qtd_e_tran, vlr_e_tran, ;
    			  qtd_e_outr, vlr_e_outr, ;
    			  qtd_s_tran, vlr_s_tran, ;
    			  qtd_s_outr, vlr_s_outr, ;
				  ven_tab, ven_contab, ven_enc, ;
				  dt_entrada,dt_saida, reserva

     IF FOUND()
		=edithand('REGRAVA')
	 ELSE
		=edithand('SAVE')
   	 ENDIF	
	CLEAR FIELDS
	SET FIELDS OFF
    UNLOCK
    =up_fecha("&ALS_Saldo")

	***************************

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYXA           MVAtlzComplSaldos VALID            
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   11  
*        Variable:            MVAtlzComplSaldos                  
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      133                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyxa     &&  MVAtlzComplSaldos VALID
#REGION 5
RETURN

******---------------------------------

* Rotina complementar em funcao do excesso de parametros
* para MVAtlzSaldos

PROCEDURE MVAtlzComplSaldos

PARAMETERS   	PRempresa,			PRclassifica,;
				PRdata,;
				m.ven_tab, 			m.ven_contab, ;
				m.ven_enc, ;
				m.dt_entrada, 		m.dt_saida, ;
				m.reserva

    ARQ_Saldo    = NetArqAgain("SALDO")
    ALS_Saldo    = Alias()

   	SELE &ALS_Saldo
  	SET ORDER TO TAG clas_saldo
    SEEK STR(PRempresa,3)+PRclassifica+;
    		STR(YEAR(PRdata),4)+;
        	STR(MONTH(PRdata),2)

	***************************
    SET FIELDS TO  ven_tab, ven_contab, ven_enc, ;
				  dt_entrada,dt_saida, reserva

     IF FOUND()
		=edithand('REGRAVA')
	 ELSE
		=edithand('SAVE')
   	 ENDIF	
	CLEAR FIELDS
	SET FIELDS OFF
    UNLOCK
    =up_fecha("&ALS_Saldo")

	***************************

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYXB           MVGetCustMedio VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   12  
*        Variable:            MVGetCustMedio                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      134                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyxb     &&  MVGetCustMedio VALID
#REGION 5
RETURN

******---------------------------------

PROCEDURE MVGetCustMedio

PARAMETERS  m.operacao, movcusto, LNcstmedio, LNsldatu, LNvlratu

        LNcstmedio = 0
		DO CASE
			CASE  (m.movcusto = "N" 	AND LNsldatu = 0)
		   	   LNcstmedio = LNvlratu  && ASSUME ULTIMO CUSTO ANTES DE ZERAR
			
			CASE  LEFT(m.operacao,1) = "S" AND ;
				  m.movcusto <> "N"  AND LNsldatu = 0

			*-------- ATENDE ex: VLG = COMPLEM DE PRECO EM PRODUTO ZERADO
		   	   LNcstmedio = LNvlratu  && ASSUME ULTIMO CUSTO ANTES DE ZERAR
									  && P/REGISTRAR VLR.DA OPERACAO
									  && DO CONTRARIO SERIA VLR=0 DEVIDO
									  && AO SALDO 0

			CASE  LEFT(m.operacao,1) = "E" AND ;
				  m.movcusto = "S" AND LNsldatu = 0
		       LNcstmedio = 0
		   	   LNvlratu   = 0         && ASSUME NOVO CUSTO A PARTIR DO ZERO
			CASE LNsldatu > 0 	
			   LNcstmedio = LNvlratu / LNsldatu   && ASSUME CUSTO ATUAL
		ENDCASE

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYXC           MVGetIndRedutor VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   13  
*        Variable:            MVGetIndRedutor                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      135                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyxc     &&  MVGetIndRedutor VALID
#REGION 5
RETURN

******---------------------------------

PROCEDURE MVGetIndRedutor

PARAMETERS  m.operacao, LNredutor, LSoperacao

		**************************************
		*   Aplicando o INDICE DE REDUCAO AO VLRVENDA provoca-se a
		* retirada do do VALOR DE ICMS que esta agregada ao valor
		* da mercadoria
		**************************************

		IF itemmov.data   < CTOD("01.05.2003")
		   do ind_ate010503
		ELSE
		   do ind_dep010503
		ENDIF

RETURN


PROCEDURE ind_dep010503

		LNredutor   = 1
		LSoperacao  = "*"		&& => no novo calculo de custo evista
		IF LEFT(m.operacao,1) = "E"
			m.dt_entrada  = itemmov.data
			IF m.tp_mercad <> 2
				LNredutor = 1-(m.aliq_icms /100)  && Extrair ICMS do custo
			ENDIF
		ENDIF
RETURN

PROCEDURE ind_ate010503

		LNredutor   = 0
		LSoperacao  = "/"	&& =>PARA MANTER COERENCIA ANTIGA
		IF LEFT(m.operacao,1) = "E"
			m.dt_entrada  = itemmov.data
			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************
			*********************************************************
			*    Inicio de tratamento nao parametrizavel ( ESPECIFICO)
			*		Para PNEUS Ind,Caminhao,Tratores,Agric,Terrapl
			*	> "00448"  e < "00800"	
			**********************************************************
			IF itemmov.data      >= CTOD("11.10.1997") AND ;
					   m.ch_opera   = "2" AND m.ch_desti   = "1" AND ;
					   m.tp_mercad = 2
					    IF LEFT(itemmov.classifica,5) > "00448" AND ;
						   LEFT(itemmov.classifica,5) < "00800"
							LNredutor = 1.24
						ELSE
							LNredutor = 1.26
						ENDIF				
			ELSE
				IF itemmov.data  >= CTOD("01.09.1999")
					LNredutor = 1-(m.aliq_icms /100)
					LSoperacao  = "*"	&& => MULTIPLICACAO PELO LNredutor
				ELSE
					LNredutor = 1+(m.aliq_icms /100)
					LSoperacao  = "/"	&& =>PARA MANTER COERENCIA ANTIGA
				ENDIF
			ENDIF
			**************************************
			* FIM APLICA INDICE DE REDUCAO AO VLRVENDA
			**************************************
		ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYXE           MVSetSldEntradas VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   14  
*        Variable:            MVSetSldEntradas                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      136                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyxe     &&  MVSetSldEntradas VALID
#REGION 5
RETURN

******---------------------------------

PROCEDURE MVSetSldEntradas
PARAMETERS LNcusto

		DO CASE
			CASE itemmov.data   < CTOD("01.05.2003")
				   do ste_ate010503
			CASE itemmov.data   < CTOD("01.07.2003") && CTOD("20.08.2003")
													 && CTOD("22.07.2003")
				   do ste_dep010503
			OTHERWISE
				   do ste_nvocst
		ENDCASE
RETURN


PROCEDURE ste_nvocst   && INCORPORA ICMS_SUBS AO CUSTO

   		DO CASE
			* ---------------> ENTRADAS PROCESSADAS
			CASE m.operacao = 'ECP.' 	 && ENTRADA\COMPRA\PROCESSADA
 			   	 m.qtd_compra = m.qtd_compra + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S" OR (m.movcusto = "N" AND LNvlratu = 0)
				   	 m.vlr_compra = m.vlr_compra + LNcusto
				 ELSE
				   	 m.vlr_compra = m.vlr_compra  + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ETP.'     &&  ENTRADA\TRANSF.\PROCESSADA
		   		 m.qtd_e_tran = m.qtd_e_tran + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S" OR (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_tran = m.vlr_e_tran + LNcusto
				 ELSE
			   		 m.vlr_e_tran = m.vlr_e_tran + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ERP.' OR ;
			     m.operacao = 'EDP.' OR ;
			     m.operacao = 'EOP.'      &&  ENTRADA\OUTRAS\PROCESSADA
		   		 m.qtd_e_outr = m.qtd_e_outr + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S" OR (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_outr = m.vlr_e_outr + LNcusto
				 ELSE
			   		 m.vlr_e_outr = m.vlr_e_outr + (m.qtde * LNcstmedio)
				 ENDIF

		ENDCASE
RETURN



PROCEDURE ste_dep010503   && INCORPORA ICMS_SUBS AO CUSTO

   		DO CASE
			* ---------------> ENTRADAS PROCESSADAS
			CASE m.operacao = 'ECP.' 	 && ENTRADA\COMPRA\PROCESSADA
 			   	 m.qtd_compra = m.qtd_compra + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
					IF m.ch_desti = "3"		&& ignora ICMS (NAO EMBUTIDO)
					   	 m.vlr_compra = m.vlr_compra ;
				   	 	+ m.vlrvenda + m.vlripi + m.custo_ind +	m.icms_subs
					ELSE
					   	 m.vlr_compra = m.vlr_compra ;
						   	 	+ (m.vlrvenda &LSoperacao LNredutor) ;
				   	 			+ m.vlripi + m.custo_ind + m.icms_subs
					ENDIF
				 ELSE
				   	 m.vlr_compra = m.vlr_compra ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ETP.'     &&  ENTRADA\TRANSF.\PROCESSADA
		   		 m.qtd_e_tran = m.qtd_e_tran + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_tran = m.vlr_e_tran ;
							+ (m.vlrvenda &LSoperacao LNredutor) ;
							+ m.vlripi + m.custo_ind + m.icms_subs
				 ELSE
			   		 m.vlr_e_tran = m.vlr_e_tran ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ERP.' OR ;
			     m.operacao = 'EDP.' OR ;
			     m.operacao = 'EOP.'      &&  ENTRADA\OUTRAS\PROCESSADA
		   		 m.qtd_e_outr = m.qtd_e_outr + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_outr = m.vlr_e_outr ;
				   		 			+ (m.vlrvenda &LSoperacao LNredutor) ;
				   		 			+ m.vlripi + m.custo_ind + m.icms_subs
				 ELSE
			   		 m.vlr_e_outr = m.vlr_e_outr ;
			   		 		+ (m.qtde * LNcstmedio)
				 ENDIF

		ENDCASE
RETURN

PROCEDURE ste_ate010503

   		DO CASE
			* ---------------> ENTRADAS PROCESSADAS
			CASE m.operacao = 'ECP.' 	 && ENTRADA\COMPRA\PROCESSADA
 			   	 m.qtd_compra = m.qtd_compra + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
					IF m.ch_desti = "3"		&& ignora ICMS (NAO EMBUTIDO)
					   	 m.vlr_compra = m.vlr_compra ;
				   	 	+ m.vlrvenda + m.vlripi + m.custo_ind
					ELSE
					   	 m.vlr_compra = m.vlr_compra ;
						   	 	+ (m.vlrvenda &LSoperacao LNredutor) ;
				   	 			+ m.vlripi + m.custo_ind
					ENDIF
				 ELSE
				   	 m.vlr_compra = m.vlr_compra ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ETP.'     &&  ENTRADA\TRANSF.\PROCESSADA
		   		 m.qtd_e_tran = m.qtd_e_tran + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_tran = m.vlr_e_tran ;
							+ (m.vlrvenda &LSoperacao LNredutor) ;
							+ m.vlripi + m.custo_ind
				 ELSE
			   		 m.vlr_e_tran = m.vlr_e_tran ;
			   		    + (m.qtde * LNcstmedio)
				 ENDIF
			CASE m.operacao = 'ERP.' OR ;
			     m.operacao = 'EDP.' OR ;
			     m.operacao = 'EOP.'      &&  ENTRADA\OUTRAS\PROCESSADA
		   		 m.qtd_e_outr = m.qtd_e_outr + m.qtde
				****************************************************
				** AFETA CUSTO MEDIO QUANDO :
				**   - TIPO OPERACAO FOR CONFIGURADO PARA AFETAR O
				** CUSTO <<  m.movcusto = "S" >>
				**   - O PRODUTO NAO POSSUI CUSTO ANTERIOR
				**   	 (m.movcusto = "N" AND LNvlratu = 0)
				****************************************************
 				 IF m.movcusto = "S"  OR ;		
					 (m.movcusto = "N" AND LNvlratu = 0)
			   		 m.vlr_e_outr = m.vlr_e_outr ;
				   		 			+ (m.vlrvenda &LSoperacao LNredutor) ;
				   		 			+ m.vlripi + m.custo_ind
				 ELSE
			   		 m.vlr_e_outr = m.vlr_e_outr ;
			   		 		+ (m.qtde * LNcstmedio)
				 ENDIF

		ENDCASE
RETURN

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYXH           MVSetSldSaidas VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   15  
*        Variable:            MVSetSldSaidas                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      137                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyxh     &&  MVSetSldSaidas VALID
#REGION 5
RETURN

******---------------------------------

PROCEDURE MVSetSldSaidas


		DO CASE

************CASE  m.tp_mercad = 7 AND  LEFT(m.operacao,1) = 'S' && SAIDA

			*-- SERVICO/SAIDA/VENDA/NAO NF DE ENTRADA--------------*
			CASE  m.tp_mercad = 7 AND LEFT(m.operacao,1) = 'S' AND ;
				  m.ch_opera = "1" AND m.tipo <> "ENT"

				 IF m.movestq = "S"
					 m.qtd_venda  = m.qtd_venda  + m.qtde
					 m.vlr_venda = m.vlr_venda   + m.vlrvenda + m.vlripi
				 ENDIF

			*-- SAIDA/VENDA/NAO NF DE ENTRADA--------------*

			CASE  LEFT(m.operacao,1) = 'S' AND ;
				  m.ch_opera = "1" AND m.tipo <> "ENT"
				 IF m.movestq = "S"
					 m.qtd_venda  = m.qtd_venda  + m.qtde
					 m.vlr_venda  = m.vlr_venda  + (LNcstmedio * m.qtde)
			   		 m.ven_contab = m.ven_contab + (m.qtde * LNcstmedio)
				 ENDIF

				 IF m.movvalor <> "N" 	&& Nos 1os MOVIMENTOS o Sim = ESPACO BRANCO
			   		 m.ven_tab 	  = m.ven_tab    + (m.qtde * m.preco)
					 m.ven_enc    = m.ven_enc +  m.vlrvenda	 + m.vlripi
					            && VEND.NO.PRECO FIN.c/ENCARG.
				 ENDIF
	 			 *---- O VALOR DA VENDA COM ENCARGOS = VLRVENDA --*
			CASE LEFT(m.operacao,3) = 'STP' && SAIDA\TRANSF.\PROCESSADAS
				 IF m.movestq = "S"
			   		 m.qtd_s_tran = m.qtd_s_tran + m.qtde
					 *---- CALCULO ESPECIAL PARA TRANSFERENCIAS ------*
					*----------------------------------------------------*
					*      O uso da fun눯o UPcustotransf foi desativado em
					* 27/12/2000 por ser redundante. O custo  apurado na
					* funco equivale ao custo normal que e calculado de
					* forma direta.
					*     O calculo usado na funcao parte do valor
					* registrado na nota de saida e que nao  corrigido
					* quando o custo  alterado pela corre눯o de uma entrada
					* anterior a tranf. EX:
					*     Na filial SIA foi dada entrada de produto em
					* codigo trocado o que elevou o custo deste e logo em
					* seguida foi feita transf. com custo errado. quando
					* a entrada foi corrigida o custo medio ficou correto
					* mas a transf nao foi ajusta.
					*----------------------------------------------------*
					* m.vlr_s_tran = m.vlr_s_tran+(m.qtde * UPcustotrasf())
					*----------------------------------------------------*
			   		 m.vlr_s_tran = m.vlr_s_tran + (m.qtde * LNcstmedio)
				 ENDIF
			CASE LEFT(m.operacao,1) = 'S' AND ;
			     SUBS(m.operacao,3,1) = 'P'	&& SAIDA\? OUTRAS ?\PROCESSADAS
				 IF m.movestq = "S"
			   		 m.qtd_s_outr = m.qtd_s_outr + m.qtde
			   		 m.vlr_s_outr = m.vlr_s_outr + (m.qtde * LNcstmedio)
				 ENDIF
		ENDCASE
RETURN

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYXI           MVSetSaldos VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   16  
*        Variable:            MVSetSaldos                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      138                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyxi     &&  MVSetSaldos VALID
#REGION 5
RETURN

******---------------------------------

PROCEDURE MVSetSaldos
PARAMETERS 	PRMempresa, LNcusto
	
	LSalias	= ALIAS()
    PRIVATE ARQ_Empresa,ALS_Empresa

	LSalias	= ALIAS()
	*-----------------------------------------------------------*


    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa

	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE SALDO ESTOQUE			*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF m.movestq = "S"
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
				IF SUBS(m.operacao,3,1) = "P" && SAIDA PROCESSADA
							LNsldatu   = LNsldatu - m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
				IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
						LNsldatu = LNsldatu + m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "R" AND m.operacao <> "R***"
				LNreserva  = LNreserva + m.qtde
		ENDCASE
	ENDIF


	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE VALOR ESTOQUE		*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA

		DO CASE
			CASE itemmov.data   < CTOD("01.05.2003")
					do Set_ate010503     && usado antes de  01/05/2003

			CASE itemmov.data   < CTOD("01.07.2003") && CTOD("20.08.2003")
													 && CTOD("22.07.2003")
					do Set_dep010503	 && usado depois de  01/05/2003
			OTHERWISE
				    do set_nvocst
		ENDCASE

    ENDIF

    =UP_Fecha("&ALS_Empresa")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN

PROCEDURE set_nvocst

	 DO CASE
		CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
			LNvlratu	= LNcstmedio * LNsldatu

		CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
			*--------------------------------------------------*
			IF m.movcusto = "S" OR (LNvlratu = 0)
				LNvlratu = LNvlratu + LNcusto
			ELSE
				LNvlratu	= LNcstmedio * LNsldatu
			ENDIF
			*-------------------------------------------------------*
	 ENDCASE
RETURN

*--------------------------------------------*
PROCEDURE Set_ate010503

	 DO CASE
		CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
			LNvlratu	= LNcstmedio * LNsldatu

		CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
			*--------------------------------------------------*
			IF m.movcusto = "S" OR (LNvlratu = 0)
				DO CASE
					CASE m.ch_desti = "3"	&& ignora ICMS (NAO
										&& EMBUTIDO) INTERNACIONAL
						LNvlratu = LNvlratu + m.vlrvenda ;
							 + m.vlripi + m.custo_ind
					OTHERWISE
						LNvlratu = LNvlratu ;
							+ (m.vlrvenda &LSoperacao LNredutor) ;
						 	+ m.vlripi + m.custo_ind
				ENDCASE
			ELSE
				LNvlratu	= LNcstmedio * LNsldatu
			ENDIF
			*-------------------------------------------------------*
	 ENDCASE
RETURN

*------------------------------------------------*
PROCEDURE Set_dep010503

	 DO CASE
		CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
			LNvlratu	= LNcstmedio * LNsldatu

		CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
			*--------------------------------------------------*
			IF m.movcusto = "S" OR (LNvlratu = 0)
				DO CASE
					CASE m.ch_desti = "3"	&& ignora ICMS (NAO
										&& EMBUTIDO) INTERNACIONAL
						LNvlratu = LNvlratu + m.vlrvenda ;
							 + m.vlripi + m.custo_ind
					OTHERWISE
						IF m.tp_mercad = 2	&& Regime Substituicao
							LNvlratu = LNvlratu + m.vlrvenda ;
								+ m.vlripi + m.custo_ind + m.icms_subs
						ELSE
							LNvlratu = LNvlratu ;
								+ (m.vlrvenda &LSoperacao LNredutor) ;
							 	+ m.vlripi + m.custo_ind + m.icms_subs
						ENDIF
				ENDCASE
			ELSE
				LNvlratu	= LNcstmedio * LNsldatu
			ENDIF
				*-------------------------------------------------------*
	 ENDCASE
RETURN
*------------------------------------------------*



PROCEDURE ANT2MVSetSaldos
	

	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE SALDO ESTOQUE			*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF m.movestq = "S"
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
				IF SUBS(m.operacao,3,1) = "P" && SAIDA PROCESSADA
							LNsldatu   = LNsldatu - m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
				IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
						LNsldatu = LNsldatu + m.qtde
				ENDIF
			CASE  LEFT(m.operacao,1) = "R" AND m.operacao <> "R***"
				LNreserva  = LNreserva + m.qtde
		ENDCASE
	ENDIF


	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	*	   MOVIMENTACAO DE VALOR ESTOQUE		*
	*>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

	IF SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS

				LNvlratu	= LNcstmedio * LNsldatu

			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS

				*-------------------------------------------------------*
				IF m.movcusto = "S" OR (LNvlratu = 0)
					IF m.ch_desti = "3"		&& ignora ICMS (NAO EMBUTIDO) INTERNACIONAL
						LNvlratu = LNvlratu + m.vlrvenda ;
									 + m.vlripi + m.custo_ind
					ELSE
									
						LNvlratu = LNvlratu ;
								+ (m.vlrvenda &LSoperacao LNredutor) ;
								 	+ m.vlripi + m.custo_ind

					ENDIF
				ELSE
					LNvlratu	= LNcstmedio * LNsldatu
				ENDIF

				*-------------------------------------------------------*


		ENDCASE
	ENDIF

RETURN

*--------------------------------------------------*
* PROCESSO ANTIGO
*--------------------------------------------------*

PROCEDURE AntgMVSetSaldos
		DO CASE
			CASE  LEFT(m.operacao,1) = "S"		&& SAIDAS
				DO CASE
					CASE SUBS(m.operacao,3,1) = "P" && SAIDA PROCESSADA
						 IF m.movestq = "S"
								LNsldatu   = LNsldatu - m.qtde
						 ENDIF
						&& CALCULA CUSTO MEDIO ATUAL
						&& ATUALIZA VALOR ESTOQUE
						LNvlratu	= LNcstmedio * LNsldatu
				ENDCASE
			CASE  LEFT(m.operacao,1) = "E"		&& ENTRADAS
				DO CASE
					CASE SUBS(m.operacao,3,1) = "P" && ENTRADA PROCESSADA
						LNsldatu = LNsldatu + m.qtde
						*----------------------------------------------*
						IF m.movcusto = "S" OR (LNvlratu = 0)


							IF m.ch_desti = "3"	&& ignora ICMS (NAO
												&& EMBUTIDO) INTERNACIONAL
							    LNvlratu = LNvlratu + m.vlrvenda ;
									 + m.vlripi + m.custo_ind
							ELSE
								LNvlratu = LNvlratu ;
									+ (m.vlrvenda &LSoperacao LNredutor) ;
									 	+ m.vlripi + m.custo_ind
							ENDIF

						ELSE
							LNvlratu	= LNcstmedio * LNsldatu
						ENDIF

						*----------------------------------------------*

				ENDCASE

			CASE  LEFT(m.operacao,1) = "R" AND m.operacao <> "R***"
				LNreserva  = LNreserva + m.qtde
		ENDCASE


RETURN

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYXJ           MVSldFuturo VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         MOVIMENT,     Record Number:   17  
*        Variable:            MVSldFuturo                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      139                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyxj     &&  MVSldFuturo VALID
#REGION 5
RETURN

******---------------------------------

FUNCTION MVSldFuturo		&& Bloquear Reg de Saldo
PARAMETERS PRMempresa, ;
			PRMclassifica, ;
			PRMdata, ;
			PRMsldatu, ;
			PRMvlratu, ;
			PRMreserva

 	SELECT SALDO
	SET ORDER TO TAG clas_saldo

    SEEK STR(PRMempresa,3)+PRMclassifica+;
    	    STR(YEAR(PRMdata),4)+;
            STR(MONTH(PRMdata),2)

	IF !EOF()
		SKIP
		m.sld_ante   = PRMsldatu
		m.vlr_ante   = PRMvlratu
        m.res_ante   = PRMreserva
		m.sld_atu 	 = PRMsldatu
		m.vlr_atu    = PRMvlratu
		m.reserva	 = PRMreserva
		m.qtd_compra = 0
		m.vlr_compra = 0
		m.qtd_venda  = 0
		m.vlr_venda  = 0
		m.qtd_e_tran = 0
		m.vlr_e_tran = 0
		m.qtd_e_outr = 0
		m.vlr_e_outr = 0
		m.qtd_s_tran = 0
		m.vlr_s_tran = 0
		m.qtd_s_outr = 0
		m.vlr_s_outr = 0
		m.ven_tab    = 0
		m.ven_contab = 0
		m.ven_enc    = 0
	    m.status     = 'A'
		DO WHILE !EOF() AND PRMclassifica = saldo.classifica ;
						AND PRMempresa	  = saldo.empresa
			=MVAtlzSaldos(saldo.empresa,saldo.classifica,;
			    			 saldo.dtabert,;
						    m.sld_ante, 		m.vlr_ante, ;
						    m.res_ante,;
			    			m.sld_atu, 			m.vlr_atu, ;
							m.qtd_compra, 		m.vlr_compra, ;
   			 				m.qtd_venda , 		m.vlr_venda , ;
   			  				m.qtd_e_tran, 		m.vlr_e_tran, ;
   			  				m.qtd_e_outr, 		m.vlr_e_outr, ;
   			  				m.qtd_s_tran, 		m.vlr_s_tran, ;
   			  				m.qtd_s_outr, 		m.vlr_s_outr)


				* Rotina complementar em funcao do excesso de parametros
				* para MVAtlzSaldos impedir o uso de uma so procedure

			    =MVAtlzComplSaldos(  saldo.empresa	,;
			    				saldo.classifica,;
			    			  	saldo.dtabert,   ;
				  				m.ven_tab, ;
				  				m.ven_contab, ;
				  				m.ven_enc, ;
				  				m.dt_entrada, ;
				  				m.dt_saida, ;
				  				m.reserva )

			***************************
			SELE SALDO
			SKIP
		ENDDO
	ENDIF
	SET ORDER TO TAG emp_mes

RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYXK           PRVlrSaida VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    2     
*        Variable:            PRVlrSaida                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      140                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyxk     &&  PRVlrSaida VALID
#REGION 6
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRVlrSaida
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto, PrmEspecifico

	=W_DEFPROC("rotinas.spr")
	PRIVATE LNvalor
	PRIVATE LSalias

	PRIVATE LNtp_mercad
	
    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_orcamento,ALS_orcamento
    PRIVATE ARQ_clienc,ALS_clienc
    PRIVATE ARQ_tipooper,ALS_tipooper
    PRIVATE ARQ_grupo,ALS_grupo
    PRIVATE ARQ_saldo,ALS_saldo
    PRIVATE ARQ_Preco,ALS_Preco




	LSalias = ALIAS()
	LNvalor = 0

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_orcamento     = NetArqAgain("ORCAMENTO")
    ALS_Orcamento     = Alias()

    ARQ_clienc     = NetArqAgain("clienc")
    ALS_clienc     = Alias()


    ARQ_Tipooper     = NetArqAgain("TIPOOPER")
    ALS_Tipooper     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Saldo     = NetArqAgain("SALDO")
    ALS_Saldo     = Alias()

    ARQ_Preco     = NetArqAgain("PRECO")
    ALS_Preco     = Alias()


	IF (ARQ_Empresa + ARQ_Orcamento+ARQ_tipooper+;
		ARQ_grupo+ARQ_Saldo+ARQ_Preco+Arq_clienc) > 100000
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF
	*---------------------------------------------------------*
    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

	SELECT &ALS_Clienc
	SET ORDER TO tag emporca
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF


	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
        =up_fecha("&ALS_Empresa")
        =up_fecha("&ALS_Orcamento")
        =up_fecha("&ALS_Tipooper")
        =up_fecha("&ALS_Grupo")
        =up_fecha("&ALS_Saldo")
        =up_fecha("&ALS_Preco")
        =up_fecha("&ALS_Clienc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

	*------------------------------------------------------------*
	=W_DEFPROC("TRIBUTAR.SPR")

	DO CASE

        *------------------------------------------------------------*
        * A venda bonificacao deve sair com mesmo valor aplicado as  *
        * transferencias                                             *
        *------------------------------------------------------------*
		Case TYPE("PrmEspecifico") = "C"
		    DO CASE
			  CASE PrmEspecifico = "VENDA BONIFICACAO"
				LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
					ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)
		    ENDCASE

		CASE &ALS_tipooper .ch_opera = "2" && TRANSFERENCIAS
			LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
				ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)

		CASE &ALS_tipooper .tipo = "RDO" && REMESP DEPO.FECHADO
			LNvalor = PRVlrTransf(PrmEmpresa, PrmOrcamento, PrmProduto,;
				ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo)
		OTHERWISE
			LNvalor = PRVlrVenda(PrmEmpresa, PrmOrcamento, PrmProduto,;
	 			ALS_Empresa,ALS_Orcamento,ALS_Preco)

	ENDCASE

	*------------------------------------------------------------*

    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Orcamento")
    =up_fecha("&ALS_Tipooper")
    =up_fecha("&ALS_Grupo")
    =up_fecha("&ALS_Saldo")
    =up_fecha("&ALS_Preco")
    =up_fecha("&ALS_Clienc")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNvalor)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYXS           PRVlrTransf VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    3     
*        Variable:            PRVlrTransf                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      141                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyxs     &&  PRVlrTransf VALID
#REGION 6
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRVlrTransf
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto,;
		ALS_Orcamento,ALS_Tipooper,ALS_Grupo,ALS_Saldo


	=W_DEFPROC("rotinas.spr")
	PRIVATE LNvalor
	PRIVATE LSalias

	PRIVATE LNtp_mercad
	

	LSalias = ALIAS()
	LNvalor = 0

	*---------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF


    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF


	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNvalor)
	ENDIF

	*------------------------------------------------------------*
**    IF &ALS_tipooper .ch_opera = "2" && TRANSFERENCIAS


        DO CASE

		  CASE &ALS_Orcamento .data < CTOD("01.05.2003")
			DO trf_ate010503

		  CASE &ALS_Orcamento .data < CTOD("01.09.2012")
			DO trf_dep010503
          OTHERWISE

			DO trf_dep010912

        ENDCASE



				
****  ENDIF
	*------------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNvalor)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYXV           PRVlrVenda VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    4     
*        Variable:            PRVlrVenda                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      142                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


FUNCTION _3t40zsyxv     &&  PRVlrVenda VALID
#REGION 6
return
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Pre뇇 de Tabela do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*					- TABELA EM VIGOR : Conforme a data passada
	*				como parametro;
	*
	*					- EMPRESA DE REFERENCIA : Duas Empresas podem
	*				usar uma tabela comum para evitar redundancia de
	*				informa뉏es ;
	*					EX : SIA usa tabela 2 (EMPTAB = 2)
	*						 W-3 refere a mesma (EMPTAB = 2)
	*
	*					- PRECO DIFERENCIADO PARA :
	*						Transferencia
	*						Vendas E Outras
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LSnatu_oper....: Indicativo da Natureza da Opercao
	*							(2) = 	Transferencia
	*							(<>2)	=	Outras Operacoes
	*						  Alteram a forma de definir o preco
	*		LSTpOper.......: TIPO Identificador da Operacao Comercial
	*		LScodigo..........: Codigo do produto
    *       LDdata.........: Data para Refereciar a tabela em Vigor
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNpreco........: Preco Localizado
	*		LSclascms......: Grupo de Comissao 		
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRVlrVenda
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto,;
 			ALS_Empresa,ALS_Orcamento,ALS_Preco

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LNpreco
	PRIVATE LNtbVigor, LSsrVigor

	*-----------------------------------------------------------*

	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LNpreco 	= 0
	STORE 0  TO LNtbVigor
	STORE "" TO LSsrVigor

	*-----------------------------------------------------------*
	*-----------------------------------------------------------*
	*--------------------------------------------------------

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF
	

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	*------------------------------------------------------------*

	IF !PRtabvigor(( &ALS_Orcamento .data ),LNtbVigor, LSsrVigor)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	*------------------------------------------------------------*
    SELECT &ALS_preco
   	SET ORDER TO TAG tabela
    IF SEEK(STR( &ALS_empresa .emptab,3);
           +STR( LNtbVigor ,3)+ LSsrVigor + PrmProduto)
       LNpreco 		=   &ALS_preco .preco
    ELSE
        LNpreco 	=	0
	ENDIF
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNpreco)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYY1           PRClas_Cms VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    5     
*        Variable:            PRClas_Cms                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      143                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


FUNCTION _3t40zsyy1     &&  PRClas_Cms VALID
#REGION 6
return
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Pre뇇 de Tabela do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:   A funcao permite identificar :
	*
	*					- TABELA EM VIGOR : Conforme a data passada
	*				como parametro;
	*
	*					- EMPRESA DE REFERENCIA : Duas Empresas podem
	*				usar uma tabela comum para evitar redundancia de
	*				informa뉏es ;
	*					EX : SIA usa tabela 2 (EMPTAB = 2)
	*						 W-3 refere a mesma (EMPTAB = 2)
	*
	*					- PRECO DIFERENCIADO PARA :
	*						Transferencia
	*						Vendas E Outras
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LSnatu_oper....: Indicativo da Natureza da Opercao
	*							(2) = 	Transferencia
	*							(<>2)	=	Outras Operacoes
	*						  Alteram a forma de definir o preco
	*		LSTpOper.......: TIPO Identificador da Operacao Comercial
	*		LScodigo..........: Codigo do produto
    *       LDdata.........: Data para Refereciar a tabela em Vigor
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LSclascms........: Preco Localizado
	*		LSclascms......: Grupo de Comissao 		
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*

FUNCTION PRClas_Cms
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LSclascms
	PRIVATE LNtbVigor, LSsrVigor


    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Preco,ALS_Preco



	*-----------------------------------------------------------*

	LSalias	= ALIAS()
	*-----------------------------------------------------------*

	LSclascms 	= ""
	STORE 0  TO LNtbVigor
	STORE "" TO LSsrVigor

	*-----------------------------------------------------------*
	*-----------------------------------------------------------*
    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Preco     = NetArqAgain("PRECO")
    ALS_Preco     = Alias()

	*--------------------------------------------------------
    IF (ARQ_Empresa + ARQ_Orcamento + ARQ_Preco) > 100000
								    && HOUVE FALHA ABERT
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF

	*--------------------------------------------------------

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF
	

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF


	*------------------------------------------------------------*

	IF !PRtabvigor(( &ALS_Orcamento .data ),LNtbVigor, LSsrVigor)
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
	   	=up_fecha("&ALS_Preco")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LSclascms)
	ENDIF

	*------------------------------------------------------------*
    SELECT &ALS_preco
   	SET ORDER TO TAG tabela
    IF SEEK(STR( &ALS_empresa .emptab,3);
           +STR( LNtbVigor ,3)+ LSsrVigor + PrmProduto)
       LSclascms 		=   &ALS_preco .clas_cms
	ENDIF
	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_Preco")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSclascms)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYY8           PRCusto VALID                      
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    6     
*        Variable:            PRCusto                            
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      144                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyy8     &&  PRCusto VALID
#REGION 6
return

FUNCTION  PRCusto
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn,;
				PrmCUSTO_IND

	PRIVATE LNcusto, LNRtdoSaida, LNRtdoEntrada
	PRIVATE LNtp_mercad
	PRIVATE LNaliq_icms, LNicms
	LNcusto = 0
		

	=W_DEFPROC("tributar.spr")
	LNRtdoSaida = TRRtdoSaida(LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNRtdoEntrada = TRRtdoEntrada(LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn)
	
	=W_DEFPROC("tributar.spr")
	LNaliq_icms = TRAlqIcmInUF(LSufDestino)

	=W_DEFPROC("tributar.spr")
	LNtp_mercad = TRRegTrbMercadoria(LSufDestino,LSproduto)


	LNicms = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicms = TRicmNormal (LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn)
	*---------------------------------------------------------*

	IF LNtp_mercad = 1  && TRIBUTADA
		LNcusto = LNvlrMercadoria + LNvlrIPI + PrmCUSTO_IND+;
				LNRtdoEntrada + LNRtdoSaida	 - LNicms
	ELSE
		LNcusto = LNvlrMercadoria + LNvlrIPI + PrmCUSTO_IND+;
				LNRtdoEntrada + LNRtdoSaida	
	ENDIF

	*---------------------------------------------------------*



RETURN(LNcusto)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYB           PRtabvigor VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    7     
*        Variable:            PRtabvigor                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      145                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyyb     &&  PRtabvigor VALID
#REGION 6
RETURN

FUNCTION PRtabvigor
	PARAMETER LDdata,LNtabela,LSserie
    =W_DEFPROC("rotinas.spr")
    PRIVATE LSalias
	PRIVATE LFcadtab

	LNtabela = 0
   	LSserie  = ""

    LSalias	    = ALIAS()
    LFcadtab	= NetArq("cadtab")
    IF (LFcadtab) > 100000 && HOUVE FALHA ABERT
		=UP_fecha("cadtab" ,LFcadtab)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
    	RETURN(.f.)
    ENDIF
	SELE cadtab
	SET ORDER TO TAG tabela
	GO TOP
	DO WHILE !EOF()
		IF LDdata < cadtab.dtinicio or LDdata > cadtab.dtfim
			skip
			LOOP
		ENDIF
		LNtabela = cadtab.tabela
    	LSserie  = cadtab.serie
		EXIT
	ENDDO
	IF EOF()
	   DO OBJ_ALER.SPR WITH ;
		  "Nao foi encontrada nenhuma Tabela que vigor nesta data "+ ;
		    DTOC(LDdata)
	ENDIF
	=UP_fecha("cadtab" ,LFcadtab)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNtabela <> 0)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYE           PRdesconto VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    8     
*        Variable:            PRdesconto                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      146                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyye     &&  PRdesconto VALID
#REGION 6
RETURN

FUNCTION PRdesconto
    PARAMETER LNemp,LSCodigo,LDdata,LNnat_clie,LNdesconto,LNerro, ;
        PrmVendedor

    = W_DEFPROC("rotinas.spr")
    PRIVATE LSalias
    PRIVATE LFpreco,LFprod_cms,LFempresa
	PRIVATE LNtabela,LSserie
    PRIVATE LFvertab
    PRIVATE LNFuncaoComissao

	LNdesconto  = 0
    LNERRO      = 0
	LNtabela	= 0
	LSserie 	= ""

	IF TYPE("PrmVendedor") = "N"
    	=W_DEFPROC("USUARIO.SPR")
		LNFuncaoComissao = USGetComissFuncao(PrmVendedor)
	ELSE

		LNFuncaoComissao = 0
	ENDIF

    LSalias	    = ALIAS()
    LFpreco     = NetArq("preco")
    LFprod_cms  = NetArq("prod_cms")
    LFempresa   = NetArq("empresa")
    IF (LFpreco+LFprod_cms) > 100000 && HOUVE FALHA ABERT
	    DO ULFchDesconto
	    LNERRO = 99         && OUTRAS FALHAS
    	RETURN(.F.)
    ENDIF
    IF !Prtabvigor(LDdata,LNtabela,LSserie)
	    DO ULFchDesconto
		LNERRO = 1         && NAO HA TABELA EM VIGOR NESTE PERIODO
    	RETURN(.F.)
    ENDI
    IF !Prpromocao(LNemp,LScodigo,LNnat_clie,LDdata,{},0,LNdesconto)
	   SELE empresa
	   SET ORDER TO TAG empresa 	
	   SEEK LNemp
	   IF !FOUND()
	       DO ULFchDesconto
		   LNERRO = 99         && OUTRAS FALHAS
    	   RETURN(.F.)
	   ENDIF
       SELE Preco
       SET ORDE TO tabela
       seek str(empresa.emptab,3)+STR(LNtabela,3)+LSserie+LSCodigo

       IF !FOUND()
		  DO ULFchDesconto
		  LNERRO = 4         && PRODUTO NAO CADASTRO EM TABELA PRECO
          RETURN(.F.)
       ENDI

       LSclas_cms = Preco.clas_cms

       SELE Prod_cms
       SET ORDE TO tabela



	   *--------------------------------------------------------------*	
	   *    O controle de desonto por funcao nao e viavel sendo assim
	   * a comissao fica vinculada a funcao mas o desconto sera o que
	   * estiver cadastrado no nivel padrao = 00
	   *--------------------------------------------------------------*	
       *seek str(LNemp,3)+STR(LNtabela,3)+LSserie+;
       *       LSClas_cms+str(LNFuncaoComissao,2)
       *IF !FOUND()
	   *    seek str(LNemp,3)+STR(LNtabela,3)+LSserie+LSClas_cms+str(0,2)
       *   IF !FOUND()
	   *	  DO ULFchDesconto
	   *      LNERRO = 1   && PRODUTO NAO CADASTRADO NA TABELA PROD_CMS
	   *      RETURN(.F.)
       *   ENDI
       * ENDIF
	   *--------------------------------------------------------------*	

       seek str(LNemp,3)+STR(LNtabela,3)+LSserie+LSClas_cms+str(0,2)
   	   IF !FOUND()
		  DO ULFchDesconto
          LNERRO = 1   && PRODUTO NAO CADASTRADO NA TABELA PROD_CMS
          RETURN(.F.)
   	   ENDI



       Do Case
          Case LNnat_clie = 0
               LNdesconto = prod_cms.desc_varej
          Case LNnat_clie = 1
               LNdesconto = prod_cms.desc_reven
          Case LNnat_clie = 2
               LNdesconto = prod_cms.desc_ppubl
          Case LNnat_clie = 3
               LNdesconto = prod_cms.desc_frota
       EndC
    ENDI

	DO ULFchDesconto

    IF LNdesconto=0
       LNERRO = 2
      ELSE
       LNERRO = 3
    ENDI
RETURN(LNdesconto<>0)

PROCEDURE ULFchDesconto
    =UP_fecha("preco"    ,LFpreco)
	=UP_fecha("prod_cms" ,LFprod_cms)
	=UP_fecha("empresa" ,LFempresa)
	IF !EMPTY(LSalias) AND USED(LSalias)
	   SELECT &LSalias
	ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYG           PRbrow_tab VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:    9     
*        Variable:            PRbrow_tab                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      147                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyyg     &&  PRbrow_tab VALID
#REGION 6
RETURN

FUNCTION PRbrow_Tab
PARAMETERS LNemp,LNempTab,LNtab,LSserie,LDdtsaldo,LScodigo,LSclassifica
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Visualizar Tabela de Precos,Saldos e Reservas
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite visualizar a TABELA DE PRECOS
	*			demontrando SALDO e REZERVAS DE CADA PRODUTO
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LNemptab.......: Empresa de Referencia Para Tabela de Precos
	*		LNtab..........: Codigo da Tabela de Precos
	*		LSserie........: Serie da Tabela de Precos
	*		LDdtsaldo......: Data de Referencia para Consultar
	*						tabela de SALDOS
	*		LScodigo.......: Codigo do Produto que se quer
	*						 Posicionar ou Aproximar ou retornar
	*						 para rotina chamadora
	*		LSclassifica...: Classificao do Produto que se quer
	*						 Posicionar ou Aproximar ou retornar
	*						 para rotina chamadora
	*------------------------------------------------------------*
	*  RETORNO.....:- REGISTRO DO PRODUTO e PRECO POSICIONADO para
	*					ser tratado na rotina
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC201.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSemptmp

	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente



	*------------------------------------------------------------*

	=W_DEFPROC("AUTOPROC.SPR")
	=APTempGeral()

	*------------------------------------------------------------*

	SELE preco
	SET ORDER TO TAG tabela
	SET NEAR ON
	SEEK STR(LNempTab,3)+;
	     STR(LNtab,3)+;
	     LSserie+;
         ALLTRIM(LScodigo)
	SET NEAR OFF


    SELECT saldo
    SET ORDER TO TAG clas_saldo
    SELECT grupo
    SET ORDER TO TAG codigo
    SEEK preco.codigo
		
    SET ORDER TO TAG ordem

    SET RELATION TO STR(LNempTab,3)+STR(LNtab,3)+LSserie+;
                            grupo.codigo INTO preco ADDITIVE
    SET RELATION TO STR(LNemp,3)+grupo.classifica+;
        STR(YEAR(LDdtsaldo),4)+STR(MONTH(LDdtsaldo),2) ;
        	INTO saldo ADDITIVE
*--------
    LSemptmp =  STRTRAN(STR(LNemp,3),' ','0')

	KEYBOARD "{CTRL-F10}"

 	DO loc_dlog WITH .T.,;
		  " grupo.FLG_DESCRI = 'S' OR ;
		  (('&LSemptmp' $ grupo.tab_preco OR grupo.tp_mercad = 7)) ;
		    AND (!EMPTY(preco.codigo) OR ;
			 grupo.cdg_tipo <> 4) ","","B","ULtabres"

	CLEAR FIELDS
	SET FIELDS OFF
    SET ORDER TO TAG classifica
	SET RELATION TO
	*--------------------------------------------------------------*
	POP KEY 	&& reabilita teclas de atalho def. anteriormente
	*-----------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYI           PRpromocao VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:   10     
*        Variable:            PRpromocao                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      148                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyyi     &&  PRpromocao VALID
#REGION 6
RETURN

FUNCTION PRPROMOCAO
PARAMETERS LNemp,LScod,LNNatuclie,LDFIM,LDINICIO,LNPRECO,LNDesconto

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Pre뇇 Promocional
	*------------------------------------------------------------*
	* COMENTARIO..: A funcao permite informar preco e desconto
	*			    promocional atraves de parametros
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....: PROMOCAO
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que se quer obter informacoes
	*		LScod..........: Codigo do produto
    *       LNNotclie......: Tipo do Cliente
    *                        0 - Varejo
    * 						 1 - Revenda
    *     					 2 - Poder Publico
    *						 3 - Frota
	*		LDFim..........: Data Final da Promocao
	*       LDInicio.......: Data Inicial da Promocao
	*       LNPreco........: Preco Promocao
    *       LNDesconto.....: Desconto conforme tipo do cliente
    *       LFretorno......: .t.  => Tem Promocao na data informada
    *                        .f.  => Nao Tem Promocao na data informada
	*------------------------------------------------------------*
	*  RETORNO.....: LFretorno
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA ?
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFretorno, LFpromocao
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LFpromocao		= NetArq("promocao")
	IF (LFpromocao) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("promocao" ,LFpromocao)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF

	LFretorno 	= .f.

    SELE PROMOCAO
    SET ORDE TO PROMOCAO
    SET NEAR ON
    SEEK STR(LNemp,3)+LScod+DTOS(LDfim)
    SET NEAR OFF
    IF promocao.empresa <> LNemp ;
    	OR promocao.codigo <> LScod ;
    	OR LDfim < promocao.dt_inicio ;
    	OR LDfim > promocao.Dt_fim
    	
       LFretorno = .f.
      else
       LFretorno = .t.
	   LDFim 	=  promocao.dt_fim
	   LDInicio =  promocao.dt_inicio
	   LNPreco  =  promocao.preco
	   	Do Case
	    	Case LNNatuclie = 0
	           LNDesconto = promocao.desc_varej
	     	Case LNNatuclie = 1
   	           LNDesconto = promocao.desc_reven
	      	Case LNNatuclie = 2
   	           LNDesconto = promocao.desc_ppubl
	      	Case LNNatuclie = 3
   	           LNDesconto = promocao.desc_frota
   	  	EndC
   	ENDI
	IF LNdesconto = 0
       LFretorno = .f.
	ENDIF
	
	=UP_fecha("promocao" ,LFpromocao)
   IF !EMPTY(LSalias) AND USED(LSalias)
      SELECT &LSalias
   ENDIF
RETURN(LFretorno)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYK           PRVlrTabVgr VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:   11     
*        Variable:            PRVlrTabVgr                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      149                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


FUNCTION _3t40zsyyk     &&  PRVlrTabVgr VALID
#REGION 6
return
	*------------------------------------------------------------*

FUNCTION PRVlrTabVgr
PARAMETERS PrmEmpresa, PrmData,PrmProduto

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias

	PRIVATE LNpreco
	PRIVATE LNtbVigor, LSsrVigor
	PRIVATE LNEmpTab

	*-----------------------------------------------------------*

	LSalias	= ALIAS()
	*-----------------------------------------------------------*
	LNpreco 	= 0
	STORE 0  TO LNtbVigor
	STORE "" TO LSsrVigor

	*-----------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	LNEmpTab = EMGetFieldValue(PrmEmpresa,"EMPTAB")

	*------------------------------------------------------------*

	IF !PRtabvigor(PrmData, LNtbVigor, LSsrVigor)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(LNpreco)
	ENDIF

	*------------------------------------------------------------*
    SELECT preco
   	SET ORDER TO TAG tabela
    IF SEEK(STR( LNEmpTab, 3);
           +STR( LNtbVigor ,3)+ LSsrVigor + PrmProduto)
       LNpreco 		=   preco .preco
    ELSE
        LNpreco 	=	0
	ENDIF
	*------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNpreco)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYL           PRVlrTransf VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:   12     
*        Variable:            PRVlrTransf                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      150                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyyl     &&  PRVlrTransf VALID
#REGION 6
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*



PROCEDURE trf_dep010912

		PRIVATE LSUFdestino


		=W_DEFPROC("TRIBUTAR.SPR")
	   	LNtp_mercad = TRDef_TpMercad(PrmEmpresa,PrmOrcamento,PrmProduto)

		*------------------------------------------------------------*
		SELECT &ALS_Saldo
	   	SET ORDER TO TAG clas_saldo
	   	SEEK STR(PrmEmpresa,3)+ &ALS_grupo .classifica+;
    	    	STR(YEAR( &ALS_Orcament .data ),4)+;
    	    	STR(MONTH( &ALS_Orcament .data ),2)

	   	IF FOUND()

			IF &ALS_saldo .sld_atu = 0
		        LNvalor		=	&ALS_saldo .vlr_atu / 1
			else
		        LNvalor		=	&ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
			ENDIF

			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************

			IF &ALS_tipooper .ch_desti = "1"  && INTERNAS

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2
							LNvalor = LNvalor
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE

			ELSE

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2

						=W_DEFPROC("CLIENC.SPR")
						LSUFdestino = CNGetUFDestino(PrmEmpresa,;
													PrmOrcamento)

						=W_DEFPROC("TRIBUTAR.SPR")
						LNiva = TRGet_IVA(  &als_empresa .estado, ;
								            PrmProduto,;
								            LSUFdestino ,;
								            &ALS_Orcament .data )

						*=W_DEFPROC("TRIBUTAR.SPR")
						*LNiva=TRGet_IVA( &als_empresa .estado, PrmProduto)

						DO CASE
							CASE LNiva = 1.32
								LNvalor = LNvalor * 0.8945
							CASE LNiva = 1.42
								LNvalor = LNvalor * 0.8803
							CASE LNiva = 1.45
								LNvalor = LNvalor * 0.8761
							OTHERWISE							
								LNvalor = LNvalor
						ENDCASE
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE
			ENDIF
	   ENDIF
RETURN





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYN           PRVlrTransf VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:   13     
*        Variable:            PRVlrTransf                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      151                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyyn     &&  PRVlrTransf VALID
#REGION 6
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*



PROCEDURE trf_dep010503

		PRIVATE LSUFdestino


		=W_DEFPROC("TRIBUTAR.SPR")
	   	LNtp_mercad = TRDef_TpMercad(PrmEmpresa,PrmOrcamento,PrmProduto)

		*------------------------------------------------------------*
		SELECT &ALS_Saldo
	   	SET ORDER TO TAG clas_saldo
	   	SEEK STR(PrmEmpresa,3)+ &ALS_grupo .classifica+;
    	    	STR(YEAR( &ALS_Orcament .data ),4)+;
    	    	STR(MONTH( &ALS_Orcament .data ),2)

	   	IF FOUND()

			IF &ALS_saldo .sld_atu = 0
		        LNvalor		=	&ALS_saldo .vlr_atu / 1
			else
		        LNvalor		=	&ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
			ENDIF

			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************

			IF &ALS_tipooper .ch_desti = "1"  && INTERNAS

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2
							LNvalor = LNvalor
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE

			ELSE

				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2

						=W_DEFPROC("CLIENC.SPR")
						LSUFdestino = CNGetUFDestino(PrmEmpresa,;
													PrmOrcamento)

						=W_DEFPROC("TRIBUTAR.SPR")
						LNiva = TRGet_IVA(  &als_empresa .estado, ;
								            PrmProduto,;
								            LSUFdestino ,;
								            &ALS_Orcament .data )

						*=W_DEFPROC("TRIBUTAR.SPR")
						*LNiva=TRGet_IVA( &als_empresa .estado, PrmProduto)

						DO CASE
							CASE LNiva = 1.32
								LNvalor = LNvalor * 0.9055
							CASE LNiva = 1.42
								LNvalor = LNvalor * 0.8917
							CASE LNiva = 1.45
								LNvalor = LNvalor * 0.8877
							OTHERWISE							
								LNvalor = LNvalor
						ENDCASE
					OTHERWISE
							LNvalor = LNvalor
				ENDCASE
			ENDIF
	   ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYP           PRVlrTransf VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         PRECO,     Record Number:   14     
*        Variable:            PRVlrTransf                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      152                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyyp     &&  PRVlrTransf VALID
#REGION 6
return
*---------------------------------------------------------------*
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Valor do Produto Para Transferencia
	*------------------------------------------------------------*

PROCEDURE trf_ate010503

		=W_DEFPROC("TRIBUTAR.SPR")
	   	LNtp_mercad = TRDef_TpMercad(PrmEmpresa,PrmOrcamento,PrmProduto)

		*------------------------------------------------------------*
		SELECT &ALS_Saldo
	   	SET ORDER TO TAG clas_saldo
	   	SEEK STR(PrmEmpresa,3)+ &ALS_grupo .classifica+;
    	    	STR(YEAR( &ALS_Orcament .data ),4)+;
    	    	STR(MONTH( &ALS_Orcament .data ),2)
	   	IF FOUND()
			IF &ALS_saldo .sld_atu = 0
		        LNvalor		=	&ALS_saldo .vlr_atu / 1
			else
		        LNvalor		=	&ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
			ENDIF
			***************************************************************
			*	      TRANSFERENCIA INTERNA DE MERCADORIA COM RETENCAO    *
			*   ENTRA NO CALCULO DE INDICES ESPECIFICOS					  *
			***************************************************************
			IF &ALS_tipooper .ch_desti = "1"
				DO CASE
					CASE	LNtp_mercad = 1
				        LNvalor	= ;
				          LNvalor/((100 -  &als_tipooper .aliq_icms) / 100)
					CASE	LNtp_mercad = 2
						************************************************
						*    Inicio de tratamento nao parametrizavel
						*	( ESPECIFICO)
						*	Para PNEUS Ind,Caminhao,Tratores,Agric,	
						*	Terrapl > "00448"  e < "00800"	
						************************************************
						IF LEFT( &ALS_grupo .classifica,5) > "00448" AND ;
						   LEFT( &ALS_grupo .classifica,5) < "00800"
						        LNvalor = LNvalor * 1.24
						ELSE
						        LNvalor = LNvalor * 1.26
						ENDIF				
					OTHERWISE
						LNvalor = LNvalor
				ENDCASE
			ELSE
		        LNvalor = LNvalor / ((100 - &ALS_tipooper .aliq_icms) / 100)
			ENDIF
	   ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYQ           TRGet_IPIProd VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:    4  
*        Variable:            TRGet_IPIProd                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      153                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyyq     &&  TRGet_IPIProd VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IPIProd
PARAMETERS PrmProduto

    PRIVATE LNipialq

	=W_DEFPROC("GRUPO.SPR")
	LNipialq =GRGetFieldValue(PrmProduto,"ALIQ_IPI")

RETURN(LNipialq)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYR           TRGet_ISSAlq VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:    5  
*        Variable:            TRGet_ISSAlq                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      154                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyyr     &&  TRGet_ISSAlq VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_ISSAlq
PARAMETERS PrmEmpresa


    PRIVATE LNaliq_iss

	=W_DEFPROC("EMPRESA.SPR")
	LNaliq_iss =EMGetFieldValue(PrmEmpresa,"ALIQ_ISS")

RETURN(LNaliq_iss)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYS           TRdefcst VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:    6  
*        Variable:            TRdefcst                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      155                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


FUNCTION _3t40zsyys     &&  TRdefcst VALID
#REGION 7
RETURN

FUNCTION TRdefcst
	PARAMETERS Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto,PrmCst

	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_tab_cst,ALS_tab_cst
	LSalias = ALIAS()

    ARQ_Tab_Cst     = NetArqAgain("TAB_CST")
    ALS_Tab_Cst     = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()



	IF ( ARQ_Tab_Cst)+ ARQ_Tipooper > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ PrmTipo
	IF !FOUND()
		SEEK 's'+  PrmTipo
	ENDIF
	IF !FOUND()
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF



	LScst = " "
	DO CASE
		CASE &Als_tipooper .ch_opera = "4"  && DEVOLUCAO
			LScst =  PrmCST
		OTHERWISE
			SELECT &Als_tab_cst
			SET ORDER TO TAG cst
			SEEK STR(Prmtab_cst,2)+PrmTipo+STR(Prmtp_mercad,1)
			IF !FOUND()
				IF tipooper.ch_opera = "3"
					LScst =  "4"
				ENDIF
			ELSE
				LScst =  RIGHT( &Als_tab_cst .cst,1)
			ENDIF
	ENDCASE
	*------------------------------------------------------------*
    =up_fecha("&ALS_Tab_cst")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYT           TRAlqIcmInUF VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:    7  
*        Variable:            TRAlqIcmInUF                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      156                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyyt     &&  TRAlqIcmInUF VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRAlqIcmInUF
PARAMETERS PrmUF

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    LSAlias      = Alias()
    LNaliq_icms = 0
	*--------------------------------------------------------*
	DO CASE
		CASE PrmUF $ "MG/RJ/SP/PR/SC"
		    LNaliq_icms = 18
		OTHERWISE
		    LNaliq_icms = 17
	ENDCASE
	*--------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYU           TRAlqIcmOuUF VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:    8  
*        Variable:            TRAlqIcmOuUF                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      157                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyyu     &&  TRAlqIcmOuUF VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRAlqIcmOuUF
PARAMETERS PrmUF, PrmOrigemMercadoria

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    LSAlias      = Alias()
    LNaliq_icms = 0


    IF TYPE("PrmOrigemMercadoria") = "L"   && NAO FOI REPASSADO PARAMETRO -
                                           && CHAMADA ROTINA ANTIGA
		PrmOrigemMercadoria = 0

    ENDIF





	*--------------------------------------------------------*

	DO CASE
		CASE PrmOrigemMercadoria = 2
		    LNaliq_icms = 4

		CASE PrmUF $ "MG/RJ/SP/PR/SC"
		    LNaliq_icms = 7
		OTHERWISE
		    LNaliq_icms = 12
	ENDCASE
	*--------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYW           TRCFO VALID                        
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:    9  
*        Variable:            TRCFO                              
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      158                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyyw     &&  TRCFO VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRCFO
PARAMETERS PrmEmpresa, PrmTipo, PrmTp_mercad,PrmOperacao

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*

	*------------------------------------------------------------*

    PRIVATE LScfo
    PRIVATE LSalias
    PRIVATE PrmTp_mercad

    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()


	STORE 0 TO ARQ_Tipooper
	*--------------------------------------------------------
	IF TYPE("TRtipooperALIAS") = "U" OR !USED(TRtipooperALIAS)
		PUBLIC TRtipooperALIAS
	    ARQ_Tipooper     = NetArqAgain("TIPOOPER")
	    TRtipooperALIAS  = Alias()
	ENDIF
    ALS_Tipooper     = TRtipooperALIAS


    LScfo = SPACE(5)
	*--------------------------------------------------------*

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	IF UPPER(PrmOperacao) = "SAIDA"
		SEEK 'S'+ PrmTipo
		IF !FOUND()
			SEEK 's'+  PrmTipo
		ENDIF
	ELSE
		SEEK 'E'+ PrmTipo
		IF !FOUND()
			SEEK 'e'+  PrmTipo
		ENDIF
	ENDIF

	*--------------------------------------------------------*

	IF !FOUND()
   		*=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF

		IF  PrmTipo = "CPM"
		   LScfo = "5.929"
		ENDIF
		
        RETURN(LScfo)
	ENDIF


	*------------------------------------------------------*

	DO CASE


		CASE  PrmTipo = "CPM"
		   LScfo = "5.929"


		CASE PrmTp_mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs


		CASE     PrmTp_mercad = 7 ;
		  	 AND UPPER(PrmOperacao) = "SAIDA" ;
			 AND &Als_tipooper .ch_opera = "1"  && Venda/Compra SERVICO


		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO

		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE

	LScfo = LEFT(ALLTRIM(LScfo)+"   ",5)

	*------------------------------------------------------------*
	*=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LScfo)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYY           ANTTRpct_trib VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   10  
*        Variable:            ANTTRpct_trib                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      159                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsyyy     &&  ANTTRpct_trib VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION ANTTRpct_trib
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto, ;
    LNiva, LNipialq, LNtp_mercad, LScst, ;
    LNaliq_iss, LNaliq_rdu, LNaliq_icms, LScfo


	=W_DEFPROC("rotinas.spr")


 	 PRIVATE LNtab_cst

    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_GrFiscal,ALS_GrFiscal
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper
	PRIVATE LSUForigem, LSUFdestino

    LSAlias      = Alias()

	
    LNiva = 0
    LNipialq = 0
	LNtp_mercad	= 99999   && INVALIDO
	LScst		= " "		&& ASSUME 0
    LNaliq_iss = 0
    LNaliq_rdu = 0
    LNaliq_icms = 0
    LScfo = ""


    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_GrFiscal  = NetArqAgain("GRFISCAL")
    ALS_GrFiscal  = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()


    LNiva = 0
	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto

	*---------------------------------------------------------------*

	SELE &Als_GRfiscal
	SET ORDER TO trb_classe
	SEEK &Als_empresa .estado + LEFT( &Als_grupo .classifica,5)
	IF !FOUND()
		SET ORDER TO trb_sbgrpo
		SEEK &Als_empresa .estado + LEFT( &Als_grupo .classifica,8)
	ENDIF

	*---------------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF


	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    *=========>>>>>>>   OBTER IVA    <<<<<<



	=W_DEFPROC("CLIENC.SPR")
	LSUFdestino = CNGetUFDestino(PrmEmpresa,;
								PrmOrcamento)




	=W_DEFPROC("EMPRESA.SPR")
	LSUForigem = EMGet_UF(PrmEmpresa)


	=W_DEFPROC("TRIBUTAR.SPR")
	LNiva = TRGet_IVA( LSUForigem,;
			            PrmProduto,;
			            LSUFdestino ,;
			            &ALS_Orcament .data )




    *=========>>>>>>>   OBTER ALIQ IPI    <<<<<<

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA
	DO CASE
		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA
		CASE &Als_Grupo .origem = 1
			LNipialq   =  &Als_Grupo .aliq_ipi

		OTHERWISE
			LNipialq   =	0
	ENDCASE


    *=========>>>>>>>   OBTER TP_MERCAD    <<<<<<
	*--------------------------------------------------------
	*	IF &Als_Orcamento .data < {01.03.2000}
	*		LNtp_mercad	= 	&Als_grupo .tp_mercad
	*	ELSE
	*		LNtp_mercad	= 	&Als_grfiscal .tp_mercad
	*	ENDIF
	*--------------------------------------------------------


    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)


	*----------------------------------------------------------------*
	*		Identificar mercadorias em regime de substituicao ESTADUAL
	*	em caso de operacao ITERESTADUAIS com consumidor INSCRITO(2)/
	*	REVENDA(4) ou DEVOLUCOES passa mercadoria para regime tributado
	*----------------------------------------------------------------*
	IF LNtp_mercad = 2	AND &Als_tipooper .ch_desti = "2"
		IF     &Als_grfiscal .subgrupo > "02000" ;
		   AND &Als_grfiscal .subgrupo < "99999" ;
		   AND &Als_grfiscal .subgrupo <> "04042"
			DO CASE
				*----------------------------------------------------*
				* TODAS OPERACOES DIFERENTES DE VENDAS
				*----------------------------------------------------*
				CASE &Als_tipooper .ch_opera <> "1" && TODAS OPER DIFERE
				                                    && DE VENDA
					LNtp_mercad	= 	1
				*----------------------------------------------------*
				* TODAS VENDAS Q NAO FOREM PARA 1-CONSSUMIDOR  OU
				*                               3-CONTR NAO ISCRITO
				*----------------------------------------------------
				CASE !( &Als_tipooper .ch_contr $ "3/1" )
					LNtp_mercad	= 	1
			ENDCASE
		ENDIF
	ENDIF
    *=========>>>>>>>   OBTER CST    <<<<<<





	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

	LNtab_cst = &ALS_empresa .tab_cst

	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
	*---------------------------------------------------------------*

	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto)


    *=========>>>>>>>   OBTER ALIQ ISS    <<<<<<
	LNaliq_iss   =	&Als_empresa .aliq_iss
    *=========>>>>>>>   OBTER ALIQ reducao icms   <<<<<<

	LNaliq_rdu    =  0
	IF &Als_empresa .REDUZ_BASE = 0
		LNaliq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNaliq_rdu   = &Als_empresa .REDUZ_BASE  && USAR ALIQUOTA
			                                        && INFORMADA
		endif
	ENDIF

    *=========>>>>>>>   OBTER ALIQ icms   <<<<<<
	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms = &Als_orcament .aliq_icms && USAR ALIQUOTA
											   && INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA
												     && INFORMADA
	ENDIF
    *=========>>>>>>>   OBTER CFO   <<<<<<


	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE LNTp_Mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE




	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
    do TRFcht_Fecha

RETURN

PROCEDURE TRFcht_Fecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_GrFiscal")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYYZ           TRGet_IPIAlq VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   11  
*        Variable:            TRGet_IPIAlq                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      160                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyyz     &&  TRGet_IPIAlq VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IpiAlq
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto

	=W_DEFPROC("rotinas.spr")

    PRIVATE LNipialq
    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNipialq = 0
	*--------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA

	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
		RETURN(LNipialq)
	ENDIF


    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF
	*------------------------------------------------------------*

	DO CASE
		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA
		CASE &Als_Grupo .origem = 1

			LNipialq   =  TRGet_IPIProd(PrmProduto)

		OTHERWISE
			LNipialq   =	0
	ENDCASE

	*------------------------------------------------------------*

    DO TRFch_IPIAlqFecha

RETURN(LNipialq)

PROCEDURE TRFch_IPIAlqFecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZ0           TRGet_cst VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   12  
*        Variable:            TRGet_cst                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      161                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyz0     &&  TRGet_cst VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_cst
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto,PrmCST

	=W_DEFPROC("rotinas.spr")

    PRIVATE LScst
    PRIVATE LSalias

    PRIVATE LNtab_cst
    PRIVATE LNtp_mercad

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Orcamento,ALS_Orcamento

    LSAlias      = Alias()

    *----------------------------------------------------*
	LScst		= " "		&& ASSUME 0

    *----------------------------------------------------*

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()


    LScst  = " "

	LNtab_cst = 0

	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF

	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

 	LNtab_cst = &ALS_empresa .tab_cst

	*--------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF

	*------------------------------------------------------------*


    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)
	*---------------------------------------------------------------*
	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto)


	*------------------------------------------------------------*

    DO TRFch_CSTFecha

RETURN(LScst)

PROCEDURE TRFch_CSTFecha
	IF LScst = " "
		WP_MSG = "ATENCAO :  Nao foi Encontrada TABELA de C.S.T p/ "+;
			"[ Tab:"+STR(LNtab_cst,2)+;
			" Tipo:"+ &ALS_orcamento .tipo +" Mercad"+;
			STR(LNtp_mercad,1)+chr(13)+;
			"SOLICITE CADASTRO URGENTE !!!!!!."
			DO OBJ_ALER.SPR WITH WP_MSG
	ENDIF

    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Orcamento")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZ1           TRDef_tpMercad VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   13  
*        Variable:            TRDef_tpMercad                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      162                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyz1     &&  TRDef_tpMercad VALID
#REGION 7
RETURN


*--------------------------------------------------------------------*
* ESTA ROTINA ESTA VINCULADA AO ITEM DO ORCAMENTO E DEVE SER DESATIVADA
* EM (TRIBUTAR) QDO FOR MIGRADA PARA ITEM DE (ORCAMENTO OU ITEMMOV)
* COMENTARIO EM 14/05/2009
*---------------------------------------------------------------------*



FUNCTION TRDef_TpMercad
	PARAMETER PrmEmpresa,PrmOrcamento,PrmProduto


	=W_DEFPROC("rotinas.spr")

	PRIVATE LUFEmpresa
	PRIVATE	LNtp_mercad

	=W_DEFPROC("EMPRESA.SPR")
	LUFEmpresa = EMGetFieldValue(PrmEmpresa,"ESTADO")


	*--------------------------------------------------------


	LNtp_mercad	= 99999   && INVALIDO


	LNtp_mercad=;
		TRDef_RgTrbMercad( LUFEmpresa ,PrmProduto)

	*--------------------------------------------------------


RETURN(LNtp_mercad)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZ2           TRGet_rduIcms VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   14  
*        Variable:            TRGet_rduIcms                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      163                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyz2     &&  TRGet_rduIcms VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_rduIcms
PARAMETERS PrmEmpresa, PrmOrcamento

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
    *     Definir melhor as regras de reducao de base de ICMS
    * Por enquanto :
    *   FILIAL ARG => Usa reducao informada no registro da empresa
    *   Outras situacaoes ocorrem conforme a operacao e o indice
    *   deve ser informado no tipooper e atribuido ao orcamento
	*------------------------------------------------------------*

    PRIVATE LNaliq_rdu
    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNaliq_rdu = 0
	*--------------------------------------------------------*


    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF


	*------------------------------------------------------------*

	LNalq_rdu    =  0
	IF &Als_empresa .REDUZ_BASE = 0
		LNalq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNalq_rdu = &Als_empresa .REDUZ_BASE
		ELSE
			LNalq_rdu = &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA

		endif
	ENDIF

	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_rdu)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZ3           TRGet_IcmsAlq VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   15  
*        Variable:            TRGet_IcmsAlq                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      164                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyz3     &&  TRGet_IcmsAlq VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IcmsAlq
PARAMETERS PrmEmpresa, PrmOrcamento

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    PRIVATE ARQ_Empresa   , ALS_Empresa
    PRIVATE ARQ_Orcamento , ALS_Orcamento
    PRIVATE ARQ_Tipooper  , ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNaliq_icms = 0
	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF


	*------------------------------------------------------------*

	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms  =  &Als_orcament .aliq_icms && USAR ALIQUOTA INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA INFORMADA
	ENDIF

	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZB           TRGet_CFO VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   16  
*        Variable:            TRGet_CFO                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      165                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyzb     &&  TRGet_CFO VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_CFO
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*

	*------------------------------------------------------------*

    PRIVATE LScfo
    PRIVATE LSalias
    PRIVATE LNtp_mercad

    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()


    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LScfo = ""
	*--------------------------------------------------------*



	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LScfo)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LScfo)
	ENDIF


	*------------------------------------------------------*


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)

	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE PrmTp_mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE


	*------------------------------------------------------------*
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LScfo)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZC           TRcalc_tribu VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   17  
*        Variable:            TRcalc_tribu                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      166                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyzc     &&  TRcalc_tribu VALID
#REGION 7
RETURN

FUNCTION TRcalc_tribu
	PARAMETERS LNemp,LStipo,LScst,LNvlrvenda,LNtp_mercad;
				LNalq_iss,LNalq_icms,LNalq_ipi,LNalq_rdu,;
				LNiva,;
				LDdata,;
				LSufdesti,;
				LNqtde,;
				LScodprd,;
				LNbsIss,LNvlrIss,;
				LNbsIcms,LNvlrIcms,LNbsIsent,;
				LNbsSbBrt,LNbsSubs,LNicmSub,LNbsOutr,;
		        vTParam

	LNbsIpi      = vTParam[01]
	LNvlrIpi     = vTParam[02]
	LNbsIsIpi    = vTParam[03]
	LNbsbrIcms   = vTParam[04]
    PrmSeg       = vTParam[05]
    LNissrtd     = vTParam[06]
    PrmSbstISS   = vTParam[07]


	*----------------------------------------------------------*
    *    O Numero maximo de parametros passados a uma UDF e 24
    * o vTParam aplia essa condicao (mas por questoes de facilidade o
    * vetor so e utilizado para completar os parametros excedentes)
	*----------------------------------------------------------*


	*------------------------------------------------------------*
	*  CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	*  OBJETIVO.......: Calcular Valores TRIBUTARIAS E FISCAIS
	*------------------------------------------------------------*
	*  COMENTARIO.....:
	*------------------------------------------------------------*
	*  OBS............:
	*------------------------------------------------------------*
	*  TABELAS.......:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LStipo.....:
	*		LScst......: Codigo Situacao Tributaria
	*		LNvlrvenda.: Valor da Venda (Movimentacao)
	*		LNtp_mercad:
	*		LNalq_iss..:
	*		LNalq_icms.:
	*		LNalq_ipi..:
	*		LNalq_rdu..:
	*		LNiva......:
	*		LDdata.....:
	*		LSufdesti..:
	*		LNqtde.....: Para atendeder necessidade no calc base IPI
	*					 da transferencia
	*		LScodprd...: As Rotinas Novas > 22/08/2000 passam o
	*                  Codigo do Produto LEN(LScodprd) = 11 e as
	*                  antigas , que devem ser substituidas usam
	*                  a Classifica눯o LEN(LScodprd) > 11
	*                  => Quando Vier o Codigo => Ler Grupo e Achar a
	*                  Classifica눯o para uso interno desta Rotina
	*
	*	Para atendeder necessidade no calc base IPI
	*					 da transferencia
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNbsIss....:
	*		LNvlrIss...:
	*		LNbsIcms...:
	*		LNvlrIcms..:
	*		LNbsIsent..:
	*		LNbsSbBrt..:
	*		LNbsSubs...:
	*		LNbsOutr...:
	*		LNbsIpi....:
	*		LNvlrIpi...:
	*		LNbsIsIpi..:
	*		LNbsbrIcms.:
	*------------------------------------------------------------*
	* CHAMADAS : OBJ_ITOR.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LNbs_TRIBUTAR		&& BASE PARA TIBUTAR
	PRIVATE LDdtpesq			&& PARA PESQUISA DE BASE IPI TRANSD
	PRIVATE LSclasprd


    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_Saldo,ALS_Saldo

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Saldo  = NetArqAgain("SALDO")
    ALS_Saldo  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

	*------------------------------------------------------------*
	IF LEN(LScodprd) > 11
		LSclasprd = LScodprd
	ELSE
		SELE &ALS_grupo
		SET ORDER TO TAG codigo
		SEEK LScodprd
		IF !FOUND()
			LSclasprd = ""
		ELSE	
			LSclasprd = &ALS_grupo .classifica
		ENDIF
	ENDIF
	*------------------------------------------------------------*
	SELECT &ALS_tipooper
	SET ORDER TO tag tipo
	SEEK "S"+LStipo
	IF !FOUND()
		SEEK "s"+LStipo
		IF !FOUND()
		    DO TRcalc_Fecha
			RETURN(.f.)
		ENDIF
	ENDIF
	*------------------------------------------------------------*
	SELECT &ALS_empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
	    DO TRcalc_Fecha
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	STORE 0 TO LNbsIss,LNvlrIss,LNbsIcms,LNvlrIcms,LNbsIsent,;
			LNbsSbBrt,LNbsSubs,LNbsOutr,LNbsIpi,LNvlrIpi,LNbsIsIpi
			
	STORE 0 TO LNissrtd
	
	*------------------------------------------------------------*
	*		TRIBUTOS INDEPENDENTES DA SITUACAO TRIBUTARIA
	*------------------------------------------------------------*
	*	Calculo envolvendo ISS
	*		-tp_mercad= 7 => SERVICO
	*------------------------------------------------------------*
	LNbsIss		=	0
	LNvlrIss	=	0
	IF LNtp_mercad = 7
		LNbsIss	 =	LNvlrvenda
		LNvlrIss =  ROUND(LNbsIss * ROUND(LNalq_iss  / 100,4),2)
	ENDIF
	
	*------------------------------------------------------------*
	*	Calculo envolvendo ISS RETIDO
	*------------------------------------------------------------*
	LNIssRtd	=	0
	IF PrmSbstISS = 1  && se = 1 segumento retem iss
		LNIssRtd = LNvlrIss
	ENDIF
	
	*------------------------------------------------------------*
	*	Calculo envolvendo IPI
	*		-Devolucao:		A base do IPI e o proprio vlrvenda
	*		-Outras   : 	O IPI ja esta embutido no valor de
	*				de venda. Por isso e necessario retira-lo
	*				para determinar a base Original
	*------------------------------------------------------------*
	LNbsIpi 	= 	0
	LNvlripi 	= 	0
	LNbsIsIp	=	LNvlrvenda
	IF LNalq_Ipi > 0
		DO CASE
			CASE &ALS_tipooper .ch_opera = "4" 	&& DEVOLUCAO
				LNbsIpi  = LNvlrvenda
			CASE &ALS_tipooper .ch_opera = "2" 	&& TRANSFERENCIA
				*----------------------------------------------------*
				*  CASO DAS IMPORTACOES INICIADAS EM 2006
				*----------------------------------------------------*
				LNbsIpi  = LNvlrvenda
			CASE &ALS_tipooper .ch_opera = "2" 	&& TRANSFERENCIA
				*----------------------------------------------------*
				*  CASO ANTIGO QDO AS IMPORTACOES FORAM TRATADAS
				* DE FORMA ERRADA
				*----------------------------------------------------*
				*    	Determina o Ultimo dia do mes Anterior para
				*   data de pesquisa E MES ANTERIOR P/ O REGISTRO DO
				*   SALDO
				*     MOTIVO : A base do ipi nas transferencias
				*			e a media do valor de venda nos meses
				*			anteriores
				*----------------------------------------------------*
				LDdtpesq   = LDdata - DAY(LDdata)
				SELE &ALS_SALDO
				SEEK STR(LNemp,3)+LSclasprd+;
							STR(YEAR(LDdata),4)+;
						 	 STR(MONTH(LDdata),2)
				*----------------------------------------------------*
				*    Caso nao seja possivel determinar a media
				*  sera considerado o custo medio ANTERIOR OU ATUAL
				*	(ULTIMO CASO)
				*----------------------------------------------------*
				DO CASE
					CASE FOUND() AND &ALS_saldo .sld_ante > 0
					   LNbsipi = &ALS_saldo .vlr_ante / &ALI_saldo .sld_ante
					CASE FOUND() AND &ALS_saldo .sld_atu  > 0
					   LNbsipi = &ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
				ENDCASE					
				*----------------------------------------------------*
				DO WHILE LDdtpesq > {31.12.1994}
					SEEK STR(LNemp,3)+LSclasprd+;
							STR(YEAR(LDdtpesq),4)+;
						 	 STR(MONTH(LDdtpesq),2)
					IF !FOUND() OR &ALS_SALDO .qtd_venda = 0
	   					LDdtpesq   = GOMONTH(LDdtpesq,-1)
						LOOP
					ENDIF					
					LNbsipi = &ALS_SALDO .ven_enc / &ALS_SALDO .qtd_venda
					IF LDdata <= {24.06.1998}
						LNbsipi	= LNbsipi * 0.70
					ELSE
						LNbsipi	= LNbsipi * 0.90
					ENDIF						
					EXIT
				ENDDO			
				LNbsipi = LNbsipi * LNqtde
			OTHERWISE
				LNbsIpi  = ROUND(LNvlrvenda/(1+LNalq_ipi/100),2)
		ENDCASE
		LNvlripi 	= ROUND(LNbsIpi * ROUND(LNalq_ipi  / 100,4),2)
		LNbsIsIp	= 0
	ENDIF
	LNvlripi = TRcalc_Difer(LNvlripi,LNqtde,2)
	
	*------------------------------------------------------------*
	*		TRIBUTOS PELA SITUACAO TRIBUTARIA
	*------------------------------------------------------------*
	*  BASE DE INCIDENCIA DE TRIBUTOS
	*    - EM DEVOLUCOES O IPI COMPOE A BASE DE TRIBUTACAO
	*    - NAS OUTRAS OPERACOES O IPI E RETIRADO PARA COMPOR A
	*     BASE
	*------------------------------------------------------------*
	IF &ALS_tipooper .ch_opera $ "4/2" 	&& DEVOLUCAO/TRANSF
		LNbs_TRIBUTAR	= LNvlrvenda
	ELSE
		IF LDdata > {01.01.2000}
			*-----------------------------------------------------*
			&&    O IPI so passou a ser calculado nas saidas a partir
			&& de 01.01.2000 e mesmo assim conssideramos o ipi
			&& como sendo imbutido no valor particado
			&& por isso ele  retirado para compor a tributacao
			&&    Uma checagem mais detalhada indicara uma diferenca
			&& nas notas anteriores a esta data pois o ipi foi calculado
			&& apos a emisso das notas(Contador PEDRO) e nao foi
			&& considerado para tributa눯o
			*----------------------------------------------------*
			LNbs_TRIBUTAR	= LNvlrvenda - LNvlrIpi
		ELSE
			LNbs_TRIBUTAR	= LNvlrvenda
		ENDIF
	ENDIF										
	*------------------------------------------------------------*
	*------>>> BASE BRUTA DE ICMS SEM CONSIDERAR REDUCOES
	DO CASE
		CASE LScst $ "0/1/2/7"		&& ENVOLVE MERCAD TRIBUTADA NORMAL
			LNbsbrIcms	= LNbs_TRIBUTAR
        OTHERWISE
   			LNbsbrIcms	= 0
	ENDCASE

	*------>>> BASE LIQUIDA  DE ICMS CONSIDERANDO  REDUCOES----*
    *    As reducoes podem ser em funcao da operacao = "0/1"
    *  ou em funcao da empresa CST = "2/7"
	*  OBS: As reducoes em funcao da operacao foram introduzidas
	*     apos mudancas no recolhimento de PIS/COFINS em que as NF
	*  da firestone vinham com reducao na base do icms e que em caso
	*  de devolucoes deveriam operar com reducao da base.....
    *----------------------------------------------------------*
	DO CASE
		CASE LScst $ "0/1"		&& ENVOLVE MERCAD TRIBUTADA NORMAL
			LNbsIcms	= LNbsbrIcms - ;
		             ROUND(LNbsbrIcms * LNalq_rdu/100,2)
		CASE LScst $ "2/7"		&& REDUZIR BASE DO ICMS
			LNbsIcms	= LNbsbrIcms - ;
		             ROUND(LNbsbrIcms * LNalq_rdu/100,2)
	ENDCASE

	*------------------------------------------------------------*
	*----------------->>> BASE SUBSTITUICAO <<<------------------*
	*------------------------------------------------------------*



	IF LScst $ "1/3/7/"		
		LNbsSbBrt	= LNbs_TRIBUTAR + LNvlrIpi
		*----> INTERESTADUAL  e CONSUMIDOR INSCRITO
		
		DO CASE

			CASE &ALS_tipooper .ch_desti = "2" ;
			     AND &ALS_tipooper .ch_contr = "2";
			     AND LDdata < CTOD("01.10.11")
                *--------------------------------------------*
                * regra anterior ao protocolo 21/2011 *
                *--------------------------------------------*
	
				LNbssubs = LNbs_TRIBUTAR + LNvlrIpi


			CASE &ALS_tipooper .ch_desti = "2"  ;
			     AND ;
			     (     &ALS_tipooper .ch_contr = "1";
			        OR &ALS_tipooper .ch_contr = "2";
			        OR &ALS_tipooper .ch_contr = "3";
			     )
				 *------------------------------------------------------*
	             * PROTOCOLO INTERESTADUAL 21/2011 CONFAZ EM VIGOR DESDE
    	         * junho/2011 equipara
    	         *  (1) - CONSUMIDOR ESTADUAL
    	         *  (2) - CONSUMIDOR INSCRITO
    	         *  (3) - CONSUMIDOR NAO INSCRITO
	             *  nas operacoes interestaduais
				 *-----------------------------------------------------*

				LNbssubs = LNbs_TRIBUTAR + LNvlrIpi







			CASE LScst $ "1/7" AND LDdata < CTOD("01.01.97")
				LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi) *  1.45)

			CASE LScst $ "3" AND &ALS_tipooper .ch_desti = "1"
				LNbssubs = ((LNbs_TRIBUTAR+LNvlrIpi)   *  1.225)
				*  qualquer situacao de retencao interna sera
				*	 entendida como reem bolso 1.225
				*	 (DEFINIDO COM PEDRO EM 17/04/97)

			CASE LScst $ "3" AND LDdata < CTOD("01.01.97")
				LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi) *  1.225)

			CASE &ALS_tipooper .ch_opera = "4"

				DO CASE
	               CASE LEFT(LSclasprd,2) $ "00/01"  ;
	                    OR LEFT(LSclasprd,5) $ "04042"
						*----------------------------------------------*
    	            	* REGRA TRATAR REDUCAO PIS COFIS PARA PNEUS
    	            	* CAMARAS E PROTETORES
						* Oliveira 21/09/2004 => Em fun눯o da altera눯o
						* do convenio 10/03 a redu눯o (PIS/COFINS) passa
						* a insidir sobre a base de substitui눯o
						*----------------------------------------------*
						IF LDdata < {05.03.2007}
						    LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
						    LNbssubs	= LNbssubs - ;
					             ROUND(LNbssubs * LNalq_rdu/100,2)
						ELSE
					    	LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
					    	LNbssubs	= LNbssubs - ;
			            	 ROUND((LNbs_TRIBUTAR*LNiva) * LNalq_rdu/100,2)

						ENDIF


				   OTHERWISE
						*----------------------------------------------*
    	        	    * REGRA TRATAR REUCAO ICMS PA PECAS
						* Oliveira 21/09/2004 => Em fun눯o da altera눯o
						* do convenio 10/03 a redu눯o (PIS/COFINS) passa
						* a insidir sobre a base de substitui눯o
						*----------------------------------------------*

				    	LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
					ENDCASE

			OTHERWISE
			    LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
		ENDCASE
	ENDIF
	*------------------------------------------------------------*
	*--------------------->>> OUTRAS <<<-------------------------*
	*------------------------------------------------------------*
	DO CASE
		CASE LScst = "0"		&& COM REDUCAO BASE CALCULO ICMS
		                        && atribuido apos mudanca pis cofins
			LNbsisent 	= LNbsbrIcms - LNbsicms
		CASE LScst = "1"		&& COM REDUCAO BASE CALCULO ICMS
		                        && BASICAMENT EM DEVOLUCOE
		                        && TRIBUTADA E COM SUBSTITUICAO
			LNbsisent 	= LNbsbrIcms - LNbsicms
		CASE LScst = "2"		&& COM REDUCAO BASE CALCULO ICMS
			LNbsisent 	= LNbs_TRIBUTAR - LNbsicms
		CASE LScst = "3"		&& ISENT. OU N. TRIB. E COM SUBST. TRIB
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "4"		&& ISENT. OU N. TRIB. E COM SUBST. TRIB
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "5"		&& COM SUSPENSAO OU DIFERIMENTO
			LNbsoutr 	= LNbs_TRIBUTAR
		CASE LScst = "6"		&& ICMS CABRADO ANTES POR SUBSTITUICAO
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "7"		&& COM REDUCAO BASE CALCULO ICMS POR SUBS
			LNbsisent 	= LNbs_TRIBUTAR - LNbsicms
	ENDCASE
	*---------------------- CALCULANDO VALORES ------------------*
	LNvlricms 	= LNbsicms * LNalq_icms / 100

	IF LNbssubs > 0
		IF LSufdesti $ "MG/SP/RJ" AND &ALS_tipooper .ch_opera <> "4"			
			*------ ALIQUOTA INTERNA 18 % ----*
			LNicmSub = ;
			 ((LNbssubs) * 0.18) - (LNbsIcms * LNalq_icms / 100)
		ELSE
        	LNicmSub = ;
        	 ((LNbssubs) * 0.17) - (LNbsIcms * LNalq_icms / 100)
		ENDIF
	ENDIF
	*------------------------------------------------------------*
    DO TRcalc_Fecha

	*------------------------------------------------------------*

	vTParam[01] = LNbsIpi
	vTParam[02] = LNvlrIpi
	vTParam[03] = LNbsIsIpi
	vTParam[04] = LNbsbrIcms
    vTParam[06] = LNissrtd


	*------------------------------------------------------------*
RETURN(.T.)


PROCEDURE TRcalc_Fecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Saldo")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZK           CSTENT VALID                       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   18  
*        Variable:            CSTENT                             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      167                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyzk     &&  CSTENT VALID
#REGION 7
RETURN

PROCEDURE TXMP


           * A ROTINA A SER DESENVOLVIDA DEVE SUBSTITUIR TRECHO DE
           * PROGRAMA ESCRITO EM SCT0310 QUE GERA O SINTEGRA E CORRIGE
           * O CST


			*---------------------------------------------------*			
			*  ATENCAO : Definir Regra para Informar corretamente
			*           CST em NOTAS DE ENTRADA
			*---------------------------------------------------*			

			IF itemmov.cst <> " "
				LScst   = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
					  LIVROENT.cst+ "0"
			ELSE
				DO CASE
					CASE LIVROENT.tp_mercad = 1 ;
					    and LIVROENT.base_calc > 0 ;
					    and LIVROENT.base_calc <> LIVROENT.vlrvenda
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
					CASE LIVROENT.tp_mercad = 1 and LIVROENT.base_calc > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "0"  + "0"
					CASE LIVROENT.tp_mercad = 1 and LIVROENT.base_calc = 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
					CASE   LIVROENT.tp_mercad = 2 ;
					   and LIVROENT.icms_subs > 0 ;
					   and LIVROENT.base_calc > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "1"  + "0"
					CASE LIVROENT.tp_mercad = 2 and LIVROENT.icms_subs > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "6"  + "0"
					CASE LEFT(LIVROENT.codigo,5) = "99999"
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "9"  + "0"
					OTHERWISE
						LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
				ENDCASE
			ENDIF
RETURN

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZL           TRRtdoSaida VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   19  
*        Variable:            TRRtdoSaida                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      168                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyzl     &&  TRRtdoSaida VALID
#REGION 7
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRIO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido  calculado conforme a f줿mula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda no trata de forma parametrizada
	*					 a aliquota interna e at que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa눯o atual
	*					 em termos de Pneul긪dia
	*------------------------------------------------------------------*						

FUNCTION TRRtdoSaida
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNicms,LNbase_Icms,LNbase_Rtdo

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNicmsOrigem       && Aliquota Externa no Estado Origem
	PRIVATE LNicmsDestino      && Aliquota Interna no Estado Destino
 	
    LSAlias      = Alias()

	LNicms = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) &&
	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmInUF(LSufDestino) &&

	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNbase_Rtdo = TREbsRtdoCIVA(LSproduto,;
							LSufOrigem,;
							LSufDestino,;
							LNvlrMercadoria,;
							LNvlrIPI,;
							LNcdg_Forn)


	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2

  		   LNicms =  (LNbase_Rtdo * LNicmsDestino/100)-;
   	    	         (LNbase_Icms  * LNicmsOrigem/100)

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNicms)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZN           TRRtdoEntrada VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   20  
*        Variable:            TRRtdoEntrada                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      169                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyzn     &&  TRRtdoEntrada VALID
#REGION 7
RETURN

FUNCTION TRRtdoEntrada
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn

	=W_DEFPROC("rotinas.spr")
				
	PRIVATE LSalias,LNicms,LNbase_Icms,LNbase_Rtdo

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNicmsOrigem       && Aliquota Externa no Estado Origem
	PRIVATE LNicmsDestino      && Aliquota Interna no Estado Destino
	PRIVATE LNiva			   &&
 	
	LNicms = 0.00
    LSAlias      = Alias()

	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) &&
	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmInUF(LSufDestino) &&
	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNbase_Rtdo = TREbsRtdoCIVA(LSproduto,;
							LSufOrigem,;
							LSufDestino,;
							LNvlrMercadoria,;
							LNvlrIPI,;
							LNcdg_Forn)



	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*


	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 1 and LNRgTrbDestino = 2

  		   LNicms =  (LNbase_Rtdo * LNicmsDestino/100)-;
   	    	         (LNbase_Icms  * LNicmsOrigem/100)


	    ENDIF
	ENDIF


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNicms)

*--------------   descartado em 6/10/2003
*  		   LNicms =  ((LNvlrMercadoria + LNvlrIPI);
*	   			 * LNiva * LNicmsDestino/100)-;
*	             (LNbase_Icms  * LNicmsOrigem/100)
*----------------

*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZO           TRicmNormal VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   21  
*        Variable:            TRicmNormal                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      170                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyzo     &&  TRicmNormal VALID
#REGION 7
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION UITicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRIO :  -Calcula o ICMS NORMAL no Item de Entrada :
	*				-Sera Calculado para TP_MERCAD = 1
	*					(Mercadoria Tributada)
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*-------------------------------------------------------------------*						

FUNCTION TRicmNormal
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
				
	=W_DEFPROC("rotinas.spr")


	PRIVATE LSalias,LNicms,LNbase_Icms
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples

	LNicms = 0.00
    LSAlias      = Alias()

	
	*--------------------------------------------------------*
	=W_DEFPROC("forneced.spr")
	LNRgFiscFornecedor = FRrgm_Fisc(LNcdg_Forn)

    IF 	LSufOrigem = LSufDestino
		=W_DEFPROC("tributar.spr")
		LNicmsOrigem    =	TRAlqIcmInUF(LSufOrigem) && Aliquota Interna
	ELSE
		=W_DEFPROC("tributar.spr")
		LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) && Aliquota Externa
	ENDIF


	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)


	**** IF LNRgTrbOrigem = 1  AND LNRgTrbDestino = 1

	IF LNRgTrbDestino = 1 AND LNRgFiscFornecedor = 0
	    LNicms =  LNbase_Icms * LNicmsOrigem/100
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNicms)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZQ           TREnbsicmNormal VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   22  
*        Variable:            TREnbsicmNormal                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      171                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyzq     &&  TREnbsicmNormal VALID
#REGION 7
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION Ubsicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRIO :  -Calcula a Base ICMS NORMAL no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION TREnbsicmNormal
	PARAMETERS 	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
				
	=W_DEFPROC("rotinas.spr")


	PRIVATE LSalias,LNbase_Icms

    LSAlias      = Alias()

	LNbase_Icms = 0.00

	*--------------------------------------------------------*

    IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 	LNbase_Icms = LNvlrMercadoria - (LNvlrMercadoria * (4.9/100))
	ELSE
	 	LNbase_Icms = LNvlrMercadoria
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNbase_Icms)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZS           TREbsRtdoCIVA VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   23  
*        Variable:            TREbsRtdoCIVA                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      172                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyzs     &&  TREbsRtdoCIVA VALID
#REGION 7
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRIO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido  calculado conforme a f줿mula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda no trata de forma parametrizada
	*					 a aliquota interna e at que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa눯o atual
	*					 em termos de Pneul긪dia
	*------------------------------------------------------------------*						

FUNCTION TREbsRtdoCIVA
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNbase_Retido

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNiva			   &&
 	
    LSAlias      = Alias()

	LNbase_Retido = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")

	LNiva = TRGet_IVA( LSufOrigem,;
			            LSproduto,;
			            LSUFdestino ,;
			            wp_dtoper )

	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2
  	
  		  LNbase_Retido =  (LNvlrMercadoria + LNvlrIPI)

		  IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (4.9/100))
		  ENDIF

		  IF LNcdg_Forn = 2
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (5.19/100))
		  ENDIF

          LNbase_Retido = LNbase_Retido *  LNiva

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNbase_Retido)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZT           TREbsRtdoSIVA VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   24  
*        Variable:            TREbsRtdoSIVA                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      173                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyzt     &&  TREbsRtdoSIVA VALID
#REGION 7
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRIO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido  calculado conforme a f줿mula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda no trata de forma parametrizada
	*					 a aliquota interna e at que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa눯o atual
	*					 em termos de Pneul긪dia
	*------------------------------------------------------------------*						

FUNCTION TREbsRtdoSIVA
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNbase_Retido

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
 	
    LSAlias      = Alias()

	LNbase_Retido = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2
  	
  		  LNbase_Retido =  (LNvlrMercadoria + LNvlrIPI)

		  IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (4.9/100))
		  ENDIF

		  IF LNcdg_Forn = 2
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (5.19/100))
		  ENDIF

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNbase_Retido)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZV           TRcalc_Difer VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   29  
*        Variable:            TRcalc_Difer                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      174                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyzv     &&  TRcalc_Difer VALID
#REGION 7
RETURN

FUNCTION TRcalc_Difer
	PARAMETERS LNValorTotal,LNqtde,Lncasas
	*------------------------------------------------------------*
	PRIVATE LNajuste
	LNajuste = ROUND(LNValorTotal/LNqtde,Lncasas)*LNqtde
RETURN(LNajuste)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZW           TRVincTipo VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   31  
*        Variable:            TRVincTipo                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      175                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


FUNCTION _3t40zsyzw     &&  TRVincTipo VALID
#REGION 7
RETURN

FUNCTION TRVincTipo
	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_TipoOper,ALS_TipoOper
    PRIVATE ARQ_ClasFisc,ALS_ClasFisc
	LSalias = ALIAS()

    ARQ_TipoOper     = NetArqAgain("TIPOOPER")
    ALS_TipoOper     = Alias()

    ARQ_ClasFisc     = NetArqAgain("CLASFISC")
    ALS_ClasFisc     = Alias()

	IF ( ARQ_TipoOper + ARQ_ClasFisc) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&Als_TipoOper")
        =up_fecha("&Als_ClasFisc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = " "
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*


	*-----------------------------------------------*
	*CRIAR CODIGO DA CLASSIFICACAO <CODCLASSIF>
	*-----------------------------------------------*



	SELE &ALS_ClasFisc
	SET ORDER TO TAG CFOP
	GO TOP

	CTRCFOP = 1
	QBRCFOP = CFOP
	DO WHILE !EOF()
		m.CODCLASSIF = INT(VAL(CHRTRAN(CFOP,".","")))*10+CTRCFOP
		=RLOCK()
		REPLACE CODCLASSIF WITH m.CODCLASSIF
		QBRCFOP = CFOP
		SKIP

		IF QBRCFOP = CFOP
			CTRCFOP = CTRCFOP + 1
		ELSE
			CTRCFOP = 1
		ENDIF
	
	ENDDO



	*-----------------------------------------------*
	*ATRIBUIR CODIGO DA CLASSIFICACAO A TABELA TIPOOPER (FOX)
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFO


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODOPERA   WITH &ALS_ClasFisc .CODOPERA
		REPLACE &Als_TipoOper .CODCLASSIF WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO
		


	*-----------------------------------------------*
	*  OPERACOE VICULADAS A CFO SUBSTITUICAO
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFOSUBS


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODCLSSUBS WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO
		

	*-----------------------------------------------*
	*  OPERACOE VICULADAS A CFO SERVICO
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFOSERVICO


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODCLSERVC WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO


	*-----------------------------------------------*
	*  ATRIBUICAO CST
	*-----------------------------------------------*





	*------------------------------------------------------------*
    =up_fecha("&Als_TipoOper")
    =up_fecha("&Als_ClasFisc")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)

*BROWS FIELDS CL.CODOPERA,CL.CODCLASSIF,CL.CFOP,;
*         TP.CFO,TP.CFOSUBS,TP.CFOSERVICO,TP.TIPO,TP.CODOPERA,;
*         TP.CODCLASSIF,TP.CODCLSSUBS,TP.CODCLSERVC


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSYZZ           TRGet_IVA VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   32  
*        Variable:            TRGet_IVA                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      176                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsyzz     &&  TRGet_IVA VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TRGet_IVA
PARAMETERS 	PrmUFOrigem,;
			PrmProduto, ;
			PrmUFDestino,;
			PrmData,;
    		PrmPrdtOrigem,;
    		PrmAlsNF,;
    		PrmAlsIT
    		
    		


	=W_DEFPROC("rotinas.spr")


	IF TYPE("PrmPrdtOrigem") <> "N"
	   PrmPrdtOrigem  = 0   && ASSUME NACIONAL
	ENDIF


	IF TYPE("PrmUFDestino") <> "C"
	    DO OBJ_ALER.SPR WITH ;
		   "ERRO -> CHAMADA DA FUNCAO TRget_IVA NAO FOI ADAPTADA ";
		         +CHR(13)+CHR(13)+;
			   "   <ENTER>  "
				SET STEP ON
	ENDIF

    PRIVATE LNiva
    PRIVATE LSalias
	PRIVATE LSuf

	PRIVATE LNalq_externaUForg, LNalq_internaUFDst


    PRIVATE ALS_Grupo
    PRIVATE ARQ_tab_iva,ALS_tab_iva

    LSAlias      = Alias()


	STORE 0 TO ARQ_Grupo, ARQ_tab_iva
	*--------------------------------------------------------

	=W_DEFPROC("GRUPO.SPR")
    ALS_Grupo    = GRGetAlias()

	*--------------------------------------------------------


	IF TYPE("TRtab_IvaALIAS") = "U" OR !USED(TRtab_IvaALIAS)
		PUBLIC TRtab_IvaALIAS
	    ARQ_tab_iva     = NetArqAgain("TAB_IVA")
	    TRtab_IvaALIAS  = Alias()
	ENDIF

    ALS_tab_iva  = TRtab_IvaALIAS

    LNiva = 0
	*--------------------------------------------------------*

	
	LSuf = PrmUFDestino

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
        DO TRFcht_IVAFecha
        RETURN(LNiva)
	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para Produto  especifico
	*------------------------------------------------------------*

	SELE &ALS_tab_iva
	SET ORDER TO TAG subgrupo
	SEEK LSuf + LEFT( &Als_Grupo .classifica,5)+PrmProduto
    IF !FOUND()
		SEEK "BR"+ LEFT( &Als_Grupo .classifica,5)+PrmProduto
	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para SubGrupo do Produto
	*------------------------------------------------------------*

	IF FOUND()
	    LNiva		= 	&Als_tab_iva .iva
	ELSE
		SELE &ALS_tab_iva
		SEEK LSuf + LEFT( &Als_Grupo .classifica,5)+""
    	IF !FOUND()
			SEEK "BR" + LEFT( &Als_Grupo .classifica,5)+""
		ENDIF

	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para SubGrupo do Produto
	*------------------------------------------------------------*

	IF FOUND()
	    LNiva		= 	&Als_tab_iva .iva
	ELSE
		SELE &ALS_tab_iva
		SEEK LSuf + LEFT( &Als_Grupo .classifica,2)+SPACE(3)
    	IF !FOUND()
			SEEK "BR" + LEFT( &Als_Grupo .classifica,2)+SPACE(3)
		ENDIF

		IF FOUND()
		    LNiva		= 	&Als_tab_iva .iva
		ENDIF
	ENDIF

    *-------------------------------------------------------------*
    * Regras para definicao de IVA Ajustada
	*-------------------------------------------------------------*
	*--ANTIGA---------------------------------------------------*
	*		IF (PrmUFOrigem $ "MT/DF" OR PrmUFDestino  $ "MT/DF");
	*		    	and PrmUFOrigem <> PrmUFDestino ;
	*		    	and PrmData >= {01.06.2008} ;
	*		    	and PrmData <  {01.09.2012}
	*
	*            LNiva = TR_TOIVAAjustada(LNiva)
	*       ENDIF
	*-----------------------------------------------------------*

    LNiva =  TR_InternaIVAAjustada(LNiva)

    LNiva = TR_ICM49IVAjustada(LNiva)

    LNiva = TR_ICM62IVAjustada(LNiva)

    LNiva = TR_ICM92IVAjustada(LNiva)




	*------------------------------------------------------------*

    DO TRFcht_IVAFecha

RETURN(LNiva)

PROCEDURE TRFcht_IVAFecha
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ01           TRCFOPServico VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   34  
*        Variable:            TRCFOPServico                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      177                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz01     &&  TRCFOPServico VALID
#REGION 7
RETURN

*-------------------------------------------------------*
*-----> DEFINECFOP PARA SERVICO
*-------------------------------------------------------*

FUNCTION TRCFOPServico
PARAMETERS PrmUFOrgn, ;
           PrmMuniOrgn,;
           PrmUFDstn,;
           PrmMuniDstn,;
           PrmTp_mercad,;
           PrmOperacao

PRIVATE LScfps

	DO CASE
		CASE PrmTp_mercad <> 7   && nao e servico
			LScfps  = "0000"		
		CASE PrmUFOrgn = PrmUFDstn
			LScfps  = "5933"		
		CASE PrmUFOrgn <> PrmUFDstn
			LScfps  = "6933"		
		OTHERWISE
			LScfps  = "0000"		


    *-------------------------------------------------------------*
    *----> lembrar porque foram colocador os codigos abaixo
    *--> este codegos estava dando erro na NFr
    *-------------------------------------------------------------*
    *
  	*	CASE PrmUFOrgn = PrmUFDstn AND PrmMuniOrgn = PrmMuniDstn
	*		LScfps  = "9101"		
	*	CASE PrmUFOrgn = PrmUFDstn AND PrmMuniOrgn <> PrmMuniDstn
	*		LScfps  = "9102"		
	*	CASE PrmUFOrgn <> PrmUFDstn
	*		LScfps  = "9103"		
	*	OTHERWISE
	*		LScfps  = "0000"		
	ENDCASE
RETURN(LScfps)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ02           TRCST_IPI VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   35  
*        Variable:            TRCST_IPI                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      178                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz02     &&  TRCST_IPI VALID
#REGION 7
RETURN

FUNCTION TRCST_IPI
PARAMETERS PrmVlrIPI,PrmOperacao
	PRIVATE LScstIPI

*---------------------------------------------------------*
* ROTINA ERRADA ATE SET/11
*---------------------------------------------------------*
*	DO CASE
*		CASE PrmOperacao = "SAIDA" AND PrmVlrIPI > 0
*			LScstIPI  = "50"		
*		CASE PrmOperacao = "SAIDA" AND PrmVlrIPI = 0
*			LScstIPI  = "53"		
*		CASE PrmOperacao = "ENTRADA" AND PrmVlrIPI > 0
*			LScstIPI  = "50"		
*		CASE PrmOperacao = "ENTRADA" AND PrmVlrIPI = 0
*			LScstIPI  = "53"		
*		OTHERWISE
*			LScstIPI  = "53"		
*	ENDCASE
*---------------------------------------------------------*


	DO CASE
		CASE PrmOperacao = "SAIDA"
	***		LScstIPI  = "99"		
			LScstIPI  = "53"		
		OTHERWISE
	***		LScstIPI  = "49"		
			LScstIPI  = "03"		
	ENDCASE
	
RETURN(LScstIPI)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ03           TRCST_ISS VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   36  
*        Variable:            TRCST_ISS                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      179                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz03     &&  TRCST_ISS VALID
#REGION 7
RETURN

FUNCTION TRCST_ISS
PARAMETERS PrmVlrISS,PrmOperacao
PRIVATE LScstISS

	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlrISS > 0   &&  servico
			LScstISS  = "00"		
		CASE PrmOperacao = "SAIDA" AND PrmVlrISS = 0   && nao e servico
			LScstISS  = "07"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlrISS > 0   &&  servico
			LScstISS  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlrISS = 0   && nao e servico
			LScstISS  = "07"		
		OTHERWISE
			LScstISS  = "07"		
	ENDCASE
RETURN(LScstISS)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ04           TRGenero VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   37  
*        Variable:            TRGenero                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      180                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz04     &&  TRGenero VALID
#REGION 7
RETURN

FUNCTION TRGenero
PARAMETERS PrmTp_mercad,PrmClassifica,PrmOperacao
PRIVATE LSgenero

	DO CASE
		CASE PrmTp_mercad = 7
			LSgenero  = "00"		
		CASE LefT(Prmclassifica,2) $ "00/01"
			LSgenero  = "40"		
		OTHERWISE
			LSgenero  = "87"		
	ENDCASE
RETURN(LSgenero)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ05           antTRCST_Entrada VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   38  
*        Variable:            antTRCST_Entrada                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      181                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
*
*(ILIVROENT.cst, ILIVROENT.origem, ILIVROENT.tp_mercad,
*		ILIVROENT.base_calc, ILIVROENT.vlrvenda,
*		ILIVROENT.icms_subs, ILIVROENT.codigo
*
*(PrmCstInfo   , PrmOrigem       ,PrmTp_Mercad        ,
*		Prmbase_calc, PrmVlrvenda,;
*		Prmicms_subs, PrmCodigo

FUNCTION _3t40zsz05     &&  antTRCST_Entrada VALID
#REGION 7
RETURN


FUNCTION antTRCST_Entrada
PARAMETERS PrmCstInfo,PrmOrigem,PrmTp_Mercad,Prmbase_calc,PrmVlrvenda,;
		Prmicms_subs, PrmCodigo, Prmtipo

PRIVATE LScst


			*---------------------------------------------------*			
			*  ATENCAO : Definir Regra para Informar corretamente
			*           CST em NOTAS DE ENTRADA
			*---------------------------------------------------*			

		DO CASE
			CASE;
			 Prmtipo $ ;
 			 "CLG/CLH/CFG/CFH/CFM/CID/CLC/CLD/CFC/CFD/CIB/CLE/CLF/CFS/CFE/";
 			 OR ;
			 Prmtipo $ ;
 			 "CFF/CIC/CLJ/CFL/ASC/CEE/ASI/CFJ/CFK/TAB/TBB/TAC/TBC/TAD/TBD/";
 			 OR ;
			 Prmtipo $ ;
 			 "RBV/RBU/RBF/RBH/RBJ/RBM/RBN/RBG/RBI/RBL/RBO/RAC/RBC/RIB/RAA/";
 			 OR ;
			 Prmtipo $ ;
 			 "RBR/RAE/RBE/RID/RBP/RBQ/RCA/RDA/DAF/DBF/DAC/DBC/DBD/DAE/DBE/";
 			 OR ;
			 Prmtipo $ ;
 			 "DAG/DBG/"

			  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "9"  + "0"


			*CASE PrmCstInfo <> " "
			*	LScst   = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
			*		  PrmCstInfo+ "0"


			CASE PrmTp_Mercad = 7
			  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "9"  + "0"

			CASE PrmTp_Mercad = 1
			  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "0"  + "0"


			CASE PrmTp_Mercad = 2
			  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"

			OTHERWISE
				DO CASE
					CASE PrmTp_Mercad = 1 ;
					    and Prmbase_calc > 0 ;
					    and Prmbase_calc <> PrmVlrvenda
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"


					CASE PrmTp_Mercad = 1 and Prmbase_calc > 0
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "0"  + "0"
					CASE PrmTp_Mercad = 1 and Prmbase_calc = 0
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"
					CASE   PrmTp_Mercad = 2 ;
					   and Prmicms_subs > 0 ;
					   and Prmbase_calc > 0
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
					CASE PrmTp_Mercad = 2 and Prmicms_subs > 0
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"
					CASE LEFT(PrmCodigo,5) = "99999"
					  	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "9"  + "0"
					OTHERWISE
						LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"
				ENDCASE
		ENDCASE
		

RETURN(LScst)





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ07           TRcst_Icms VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   39  
*        Variable:            TRcst_Icms                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      182                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


FUNCTION _3t40zsz07     &&  TRcst_Icms VALID
#REGION 7
RETURN

FUNCTION TRcst_Icms
	PARAMETERS Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto,PrmCst


	PRIVATE Lcst
	

	=W_DEFPROC("GRUPO.SPR")
	LSCst =  GRGetOrigem(PrmProduto)

	LSCst =  STR( LSCst,1)
	
	
	LSCst =  LScst + ;
			 TRdefcst(Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto,PrmCst) + ;
			 "0"
	LSCst = CHRTRAN(LSCst," ","0")

RETURN(LScst)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ08           TRCST_PIS VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   40  
*        Variable:            TRCST_PIS                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      183                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz08     &&  TRCST_PIS VALID
#REGION 7
RETURN

FUNCTION TRCST_PIS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "07"		
	ENDCASE
RETURN(LScst)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ09           TRCST_COFINS VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   41  
*        Variable:            TRCST_COFINS                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      184                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz09     &&  TRCST_COFINS VALID
#REGION 7
RETURN

FUNCTION TRCST_COFINS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "01"	   && ANTES "00"	
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "04"      && ANTES "00"
	ENDCASE
RETURN(LScst)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0A           TRCST_IR VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   42  
*        Variable:            TRCST_IR                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      185                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0a     &&  TRCST_IR VALID
#REGION 7
RETURN

FUNCTION TRCST_IR
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "07"		
	ENDCASE
RETURN(LScst)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0B           TRDef_RgTrbMercad VALID            
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   44  
*        Variable:            TRDef_RgTrbMercad                  
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      186                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0b     &&  TRDef_RgTrbMercad VALID
#REGION 7
RETURN

FUNCTION TRDef_RgTrbMercad
	PARAMETER PrmUF,PrmProduto,PrmFormaRetorno
	
	
	
	*-----------------------------------------------------------------*	
	*--> PrmFormaRetorno = 'RETORNAR STRING'
	*   RETORNAR EM FORMATO STRIG (USADO EM DOC FISCAL - EFD E NFe )
	*-----------------------------------------------------------------*	
	




	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE	LSClassifica
	PRIVATE	LNtp_mercad
	LNtp_mercad	= 99999   && INVALIDO
	
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*--------------------------------------------------------

	=W_DEFPROC("GRUPO.spr")
	LSClassifica=GRGetFieldValue(PrmProduto,"CLASSIFICA")


	=W_DEFPROC("GRFISCAL.spr")
	LNtp_mercad	= GFGetTp_Mercadoria(PrmUF, LSClassifica)



*	*--------------------------------------------------------------------*
*	* Rotina estava perdida  em TRIBUTAR TRpct_trib
*	* transcrevi em 06/09/2012 e precisa de uma reavaliacao
*	* para decidir se continua
*	*--------------------------------------------------------------------*
*	*----------------------------------------------------------------*
*	*		Identificar mercadorias em regime de substituicao ESTADUAL
*	*	em caso de operacao ITERESTADUAIS com consumidor INSCRITO(2)/
*	*	REVENDA(4) ou DEVOLUCOES passa mercadoria para regime tributado
*	*----------------------------------------------------------------*
*
*	IF LNtp_mercad = 2	AND &Als_tipooper .ch_desti = "2"
*		IF     left(LSClassifica,5) > "02000" ;
*		   AND left(LSClassifica,5) < "99999" ;
*		   AND left(LSClassifica,5) <> "04042"
*			DO CASE
*				*----------------------------------------------------*
*				* TODAS OPERACOES DIFERENTES DE VENDAS
*				*----------------------------------------------------*
*				CASE &Als_tipooper .ch_opera <> "1" && TODAS OPER DIFERE
*				                                    && DE VENDA
*					LNtp_mercad	= 	1
*				*----------------------------------------------------*
*				* TODAS VENDAS Q NAO FOREM PARA 1-CONSSUMIDOR  OU
*				*                               3-CONTR NAO ISCRITO
*				*----------------------------------------------------
*				CASE !( &Als_tipooper .ch_contr $ "3/1" )
*					LNtp_mercad	= 	1
*			ENDCASE
*		ENDIF
*	ENDIF
*

	*-------------------------------------------------------------*

	IF TYPE('PrmFormaRetorno') = "C" ;
	   AND  PrmFormaRetorno = 'RETORNAR STRING'
	
		DO CASE

			CASE LNtp_mercad = 7
				LNtp_mercad	= "SERVICO"		

			CASE LNtp_mercad = 2
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			CASE LNtp_mercad = 8
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			OTHERWISE
				LNtp_mercad	= "ICMS NORMAL"		

		ENDCASE


	ENDIF





	*-------------------------------------------------------------*


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNtp_mercad)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0C           TRpct_trib VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   45  
*        Variable:            TRpct_trib                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      187                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*
FUNCTION _3t40zsz0c     &&  TRpct_trib VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRpct_trib
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto, ;
    LNiva, LNipialq, LNtp_mercad, LScst, ;
    LNaliq_iss, LNaliq_rdu, LNaliq_icms, LScfo


	=W_DEFPROC("rotinas.spr")


	PRIVATE LSEmpEstado
	PRIVATE LSClassifica
	PRIVATE LSProdOrigem
	PRIVATE LNtab_cst
	PRIVATE LNEmpReduzBase



    PRIVATE LSalias

    PRIVATE ARQ_GrFiscal,ALS_GrFiscal
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper
	PRIVATE LSUForigem, LSUFdestino

    LSAlias      = Alias()

	
    LNiva = 0
    LNipialq = 0
	LNtp_mercad	= 99999   && INVALIDO
*-*	LScst		= " "		&& ASSUME 0
    LNaliq_iss = 0
    LNaliq_rdu = 0
    LNaliq_icms = 0
    LScfo = ""




    ARQ_GrFiscal  = NetArqAgain("GRFISCAL")
    ALS_GrFiscal  = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()


    LNiva = 0
	*--------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	IF !EMLerRegistro(PrmEmpresa)
	    do TRFcht_Fecha
		RETURN
	ENDIF


	=W_DEFPROC("GRUPO.SPR")
	IF !GRLerRegistro(PrmProduto)
	    do TRFcht_Fecha
		RETURN
	ENDIF




	*---------------------------------------------------------------*


	=W_DEFPROC("EMPRESA.SPR")
	LSEmpEstado = EMGet_UF(PrmEmpresa)

	=W_DEFPROC("GRUPO.SPR")
	LSClassifica = GRGetClassifica(PrmProduto)


	=W_DEFPROC("GRUPO.SPR")
	LSProdOrigem = GRGetOrigem(PrmProduto)




	SELE &Als_GRfiscal
	SET ORDER TO trb_classe
	SEEK LSEmpEstado + LEFT( LSClassifica,5)
	IF !FOUND()
		SET ORDER TO trb_sbgrpo
		SEEK LSEmpEstado + LEFT( LSClassifica,8)
	ENDIF

	*---------------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF


	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    *=========>>>>>>>   OBTER IVA    <<<<<<



	=W_DEFPROC("CLIENC.SPR")
	LSUFdestino = CNGetUFDestino(PrmEmpresa,PrmOrcamento)


	=W_DEFPROC("EMPRESA.SPR")
	LSUForigem = EMGet_UF(PrmEmpresa)


	=W_DEFPROC("TRIBUTAR.SPR")
	LNiva = TRGet_IVA( LSUForigem,;
			            PrmProduto,;
			            LSUFdestino ,;
			            &ALS_Orcament .data )




    *=========>>>>>>>   OBTER ALIQ IPI    <<<<<<

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA
	DO CASE

		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA

		CASE LSProdOrigem = 1
			=W_DEFPROC("GRUPO.SPR")
			LNipialq   =  GRGetFieldValue(PrmProduto,"ALIQ_IPI")

		OTHERWISE
			LNipialq   =	0
	ENDCASE


    *=========>>>>>>>   OBTER TP_MERCAD    <<<<<<

    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)

*    *-----------------------------------------------------------------*
*    * A ROTINA ABAIXO FOI DESATIVADA E TRANSFERIDA PARA
*    * FUNCTION TRDef_RgTrbMercad EM 06/09/2012
*	* PARAMETER PrmUF,PrmProduto,PrmFormaRetorno
*    *-----------------------------------------------------------------*
*
*	*----------------------------------------------------------------*
*	*		Identificar mercadorias em regime de substituicao ESTADUAL
*	*	em caso de operacao ITERESTADUAIS com consumidor INSCRITO(2)/
*	*	REVENDA(4) ou DEVOLUCOES passa mercadoria para regime tributado
*	*----------------------------------------------------------------*
*
*
*	*IF LNtp_mercad = 2	AND &Als_tipooper .ch_desti = "2"
*		IF     &Als_grfiscal .subgrupo > "02000" ;
*		   AND &Als_grfiscal .subgrupo < "99999" ;
*		   AND &Als_grfiscal .subgrupo <> "04042"
*			DO CASE
*				*----------------------------------------------------*
*				* TODAS OPERACOES DIFERENTES DE VENDAS
*				*----------------------------------------------------*
*				CASE &Als_tipooper .ch_opera <> "1" && TODAS OPER DIFERE
*				                                    && DE VENDA
*					LNtp_mercad	= 	1
*				*----------------------------------------------------*
*				* TODAS VENDAS Q NAO FOREM PARA 1-CONSSUMIDOR  OU
*				*                               3-CONTR NAO ISCRITO
*				*----------------------------------------------------
*				CASE !( &Als_tipooper .ch_contr $ "3/1" )
*					LNtp_mercad	= 	1
*			ENDCASE
*		ENDIF
*	ENDIF
    *=========>>>>>>>   OBTER CST    <<<<<<


	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LNtab_cst = EMGet_TabCst(PrmEmpresa)


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
	*---------------------------------------------------------------*

	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto,LScst)

    *=========>>>>>>>   OBTER ALIQ ISS    <<<<<<


	=W_DEFPROC("EMPRESA.SPR")
	LNaliq_iss = EMGetFieldValue(PrmEmpresa,"ALIQ_ISS")


    *=========>>>>>>>   OBTER ALIQ reducao icms   <<<<<<
	=W_DEFPROC("EMPRESA.SPR")
	LNEmpReduzBase = EMGetFieldValue(PrmEmpresa,"REDUZ_BASE")


	LNaliq_rdu    =  0


	IF LNEmpReduzBase = 0
		LNaliq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNaliq_rdu   = LNEmpReduzBase  && USAR ALIQUOTA
			                                        && INFORMADA
		endif
	ENDIF

    *=========>>>>>>>   OBTER ALIQ icms   <<<<<<
	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms = &Als_orcament .aliq_icms && USAR ALIQUOTA
											   && INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA
												     && INFORMADA
	ENDIF
    *=========>>>>>>>   OBTER CFO   <<<<<<


	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE LNTp_Mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE




	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
    do TRFcht_Fecha

RETURN

PROCEDURE TRFcht_Fecha
   	=up_fecha("&ALS_GrFiscal")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0H           TRCnvrt_RgTrbMercad VALID          
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   46  
*        Variable:            TRCnvrt_RgTrbMercad                
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      188                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0h     &&  TRCnvrt_RgTrbMercad VALID
#REGION 7
RETURN

FUNCTION TRCnvrt_RgTrbMercad
	PARAMETER PrmTpMercad
	
	
	
	*-----------------------------------------------------------------*	
	*--> PrmFormaRetorno = 'RETORNAR STRING'
	*   RETORNAR EM FORMATO STRIG (USADO EM DOC FISCAL - EFD E NFe )
	*-----------------------------------------------------------------*	
	




	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE	LSClassifica
	PRIVATE	LNtp_mercad
	LNtp_mercad	= 99999   && INVALIDO
	
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*--------------------------------------------------------
	LNtp_mercad	= PrmTpMercad

	*-------------------------------------------------------------*

	
		DO CASE

			CASE LNtp_mercad = 7
				LNtp_mercad	= "SERVICO"		

			CASE LNtp_mercad = 2
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			CASE LNtp_mercad = 8
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			OTHERWISE
				LNtp_mercad	= "ICMS NORMAL"		

		ENDCASE



	*-------------------------------------------------------------*


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNtp_mercad)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0I           TRcst_Entrada VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   47  
*        Variable:            TRcst_Entrada                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      189                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*


FUNCTION _3t40zsz0i     &&  TRcst_Entrada VALID
#REGION 7
RETURN

FUNCTION TRcst_Entrada
PARAMETERS PrmCst,PrmOrigem,PrmTp_Mercad,Prmbase_calc,PrmVlrvenda,;
		Prmicms_subs, PrmProduto, Prmtipo



    Prmtab_cst = 3



	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_tab_cst,ALS_tab_cst
	LSalias = ALIAS()

    ARQ_Tab_Cst     = NetArqAgain("TAB_CST")
    ALS_Tab_Cst     = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()



	IF ( ARQ_Tab_Cst)+ ARQ_Tipooper > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'E'+ PrmTipo
	IF !FOUND()
		SEEK 'e'+  PrmTipo
	ENDIF
	IF !FOUND()
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF



	LScst = " "
	DO CASE
		CASE &Als_tipooper .ch_opera = "4"  && DEVOLUCAO
*****			LScst =  PrmCST
	     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  PrmCST  + "0"
		OTHERWISE
			SELECT &Als_tab_cst
			SET ORDER TO TAG cst
			SEEK STR(Prmtab_cst,2)+PrmTipo+STR(Prmtp_mercad,1)
			IF !FOUND()
				IF tipooper.ch_opera = "3"
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"

				ENDIF
			ELSE
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  LEFT( &Als_tab_cst .cst,1)  + "0"
			ENDIF
	ENDCASE
	*------------------------------------------------------------*
	* EXCECOES
	*------------------------------------------------------------*
    DO CASE
		CASE PrmTipo = "CLA" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "2"  + "0"
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
				CASE Prmicms_subs = 0 AND Prmbase_calc = 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"
			ENDCASE

		CASE PrmTipo = "CLB" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "2"  + "0"

				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
				CASE Prmicms_subs = 0 AND Prmbase_calc = 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"
			ENDCASE
			
		CASE PrmTipo = "CFA" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "7"  + "0"
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE
			
		CASE PrmTipo = "CFB" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "7"  + "0"
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE

		CASE PrmTipo = "CFM" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE
			
		CASE PrmTipo = "CFS" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE

    ENDCASE


	*------------------------------------------------------------*

    =up_fecha("&ALS_Tab_cst")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0J           TR_InternaIVAAjustada VALID        
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   48  
*        Variable:            TR_InternaIVAAjustada              
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      190                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0j     &&  TR_InternaIVAAjustada VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_InternaIVAAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA TERMO DE ACORDO TO/DF/GO
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra para termo de acordo
    *   revenda INTERNA DE pecas no TO
    *   => PECAS
    *      => TO / DF / GO
	*------------------------------------------------------------*
		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*
        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*





 		IF LEFT( &Als_Grupo .classifica,2) = "04" ;
 		   AND 	PrmData >= {01.06.2008} ;
		   AND  PrmData <  {01.01.2013}

	        DO CASE
				CASE (PrmUFOrigem $ "TO" AND PrmUFDestino  $ "TO")
					LNiva = 1.265				

				CASE (PrmUFOrigem $ "DF" AND PrmUFDestino  $ "DF")
					LNiva = 1.596				

				CASE (PrmUFOrigem $ "GO" AND PrmUFDestino  $ "GO")
					LNiva = 1.596				

        	ENDCASE
		ENDIF


        *-------------------------------------------------------------
        * conforme solicitacao do Celio Repassada pelo almir foi revgada
        * a instrucao anterior para DF e GO retornando o IVA interno
        * para 1.400 apartir de 01/01/2012
        *-------------------------------------------------------------

 		IF LEFT( &Als_Grupo .classifica,2) = "04" ;
 		   AND PrmData >=  {01.01.2013}

	        DO CASE
				CASE (PrmUFOrigem $ "TO" AND PrmUFDestino  $ "TO")
					LNiva = 1.265				

				CASE (PrmUFOrigem $ "DF" AND PrmUFDestino  $ "DF")
					LNiva = 1.400				

				CASE (PrmUFOrigem $ "GO" AND PrmUFDestino  $ "GO")
					LNiva = 1.400				
        	ENDCASE
		ENDIF



RETURN(LNIva)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0K           TR_ICM49IVAjustada VALID           
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   49  
*        Variable:            TR_ICM49IVAjustada                 
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      191                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0k     &&  TR_ICM49IVAjustada VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_ICM49IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PECAS
    *      => MT e DF
	*------------------------------------------------------------*

		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*
		DO CASE

			CASE (PrmUFOrigem $ "DF") ;
			    	and PrmUFOrigem <> PrmUFDestino ;
			    	and PrmData >= {01.06.2008} ;
			    	and PrmData <  {01.09.2012}
				*---------------------------------------------------*
				* PROTOCOLO ICMS 49 -8 DE MAI DE 2008 IVA AJUSTAS DF/MT
				*-----------------------------------------------------*
				LFajustaIVA = LFajustaIVA
							&& SO PARA JUSTIFICAR IF AFIRMATIVO

			CASE (PrmUFOrigem $ "MT");
			    	and PrmUFOrigem <> PrmUFDestino ;
			    	and PrmData >= {01.06.2008} ;
			    	and PrmData <  {01.09.2012}
				*------------------------------------------------*
				* PROTOCOLO ICMS 49 -8 DE MAI DE 2008 IVA AJUSTAS DF/MT
				*----------------------------------------------------*
				LFajustaIVA = LFajustaIVA
							&& SO PARA JUSTIFICAR IF AFIRMATIVO
			OTHERWISE
				RETURN(LNIva)
		ENDCASE
		
        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*

	 	DO CASE
			*--------------------------------------------*
			* PECAS E ACESSORIOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "04"
	 		   IF LEFT( &Als_Grupo .classifica,5)  $ "04041/04042/04043"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF

			*--------------------------------------------*
			* PESOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) = "07075"
	 		   IF SUBS( &Als_Grupo .classifica,6,3)  $ "599/699/799/899/999"
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
			*--------------------------------------------*
			* MATERIAL BORRACHARIA
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "05"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
 	
	 	ENDCASE

		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)


			do case
				case LNiva = 1.265				
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.417				
								case LNalq_internaUFDst = 18
									LNiva = 1.435				
								case LNalq_internaUFDst = 19
									LNiva = 1.452			
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.341				
								case LNalq_internaUFDst = 18
									LNiva = 1.358			
								case LNalq_internaUFDst = 19
									LNiva = 1.374			
		                    endcase
					endcase
				case LNiva = 1.400				
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.569				
								case LNalq_internaUFDst = 18
									LNiva = 1.588				
								case LNalq_internaUFDst = 19
									LNiva = 1.607				
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.484				
								case LNalq_internaUFDst = 18
									LNiva = 1.502				
								case LNalq_internaUFDst = 19
									LNiva = 1.521			
		                    endcase
					endcase
			endcase
		ENDIF


RETURN(LNIva)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0L           TR_ICM62IVAjustada VALID           
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   50  
*        Variable:            TR_ICM62IVAjustada                 
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      192                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0l     &&  TR_ICM62IVAjustada VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_ICM62IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PECAS
	*------------------------------------------------------------*

		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*

		IF ;
		   (PrmUFOrigem $ ;
		      "DF/AC/AL/AP/BA/GO/MA/MT/PB/PR/PE/PI/RN/RR/SC/SE/TO");
		    	and PrmUFOrigem <> PrmUFDestino ;
		    	and PrmData >=  {01.09.2012}
			*------------------------------------------------------------*
			* PROTOCOLO ICMS 62 -22 DE JUN DE 2012 IVA AJUSTAS
			*------------------------------------------------------------*
			LFajustaIVA = LFajustaIVA && SO PARA JUSTIFICAR IF AFIRMATIVO
		ELSE
			RETURN(LNIva)
		ENDIF




        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*

	 	DO CASE
			*--------------------------------------------*
			* PECAS E ACESSORIOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "04"
	 		   IF LEFT( &Als_Grupo .classifica,5)  $ "04041/04042/04043"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF

			*--------------------------------------------*
			* PESOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) = "07075"
	 		   IF SUBS( &Als_Grupo .classifica,6,3)  $ "599/699/799/899/999"
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
			*--------------------------------------------*
			* MATERIAL BORRACHARIA
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "05"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
 	
	 	ENDCASE

		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem,PrmPrdtOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)


			do case
				case LNiva = 1.400	OR LNiva = 1.5960
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.7883				
								case LNalq_internaUFDst = 18
									LNiva = 1.8101			
								case LNalq_internaUFDst = 19
									LNiva = 1.8324				
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.6921				
								case LNalq_internaUFDst = 18
									LNiva = 1.7128				
								case LNalq_internaUFDst = 19
									LNiva = 1.7339			
		                    endcase
					endcase
			endcase
		ENDIF

RETURN(LNIva)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0M           TR_ICM92IVAjustada VALID           
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         TRIBUTAR,     Record Number:   51  
*        Variable:            TR_ICM92IVAjustada                 
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      193                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0m     &&  TR_ICM92IVAjustada VALID
#REGION 7
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*
* em 18 de janeiro incorporamos o tratamento da aliquota de 4%



FUNCTION TR_ICM92IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PNEUMATICOS
	*------------------------------------------------------------*

		LFajustaIVA = .f.


        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*

		IF  PrmUFOrigem <> PrmUFDestino ;
		   	and PrmData >=  {01.09.2012}
			*------------------------------------------------------------*
			* PROTOCOLO ICMS 62 -22 DE JUN DE 2012 IVA AJUSTAS
			*------------------------------------------------------------*
			LFajustaIVA = LFajustaIVA && SO PARA JUSTIFICAR IF AFIRMATIVO
		ELSE
			RETURN(LNIva)
		ENDIF

        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*


	 	DO CASE
			*--------------------------------------------*
			* PNEUMATICOS - PNEUS/CAMARAS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) $ "00/01"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA

			*--------------------------------------------*
			* PROTETORES
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) $ "04042"
	 		   IF LEFT( &Als_Grupo .classifica,8)  $ "04042920"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
	 	ENDCASE


		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem,PrmPrdtOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)


			do case
				case LNiva = 1.42				
					do case
						case LNalq_externaUForg	= 4
							LNiva = 1.6424				
						case LNalq_externaUForg	= 7
							LNiva = 1.5911				
						case LNalq_externaUForg	= 12
							LNiva = 1.5055				
					endcase
				case LNiva = 1.32				
					do case
						case LNalq_externaUForg	= 4
							LNiva = 1.5267				
						case LNalq_externaUForg	= 7
							LNiva = 1.479				
						case LNalq_externaUForg	= 12
							LNiva = 1.3995				
					endcase
				case LNiva = 1.45				
					do case
						case LNalq_externaUForg	= 4
							LNiva = 1.6771				
						case LNalq_externaUForg	= 7
							LNiva = 1.6247				
						case LNalq_externaUForg	= 12
							LNiva = 1.5373				
					endcase
			endcase
		ENDIF

RETURN(LNIva)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0T           EMGet_UF VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:    2   
*        Variable:            EMGet_UF                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      194                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0t     &&  EMGet_UF VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_UF
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("ESTADO"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0U           EMGet_Juro VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:    3   
*        Variable:            EMGet_Juro                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      195                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0u     &&  EMGet_Juro VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Juro
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("JUROMES"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0V           verif VALID                        
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:    4   
*        Variable:            verif                              
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      196                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0v     &&  verif VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION UVerifEmp
PARAMETERS LNemp,LSnome,LNkey
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFempresa
	PRIVATE LFretorno
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	LFempresa		= NetArq("empresa")
	IF (LFempresa) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("empresa" ,LFempresa)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	*-----------------------------------------------------------*
	SELECT empresa
	SET ORDER TO TAG empresa
	IF LNkey = 9
	   ON KEY LABEL ESCAPE
	   DO loc_dlog WITH .F.
	   ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	   LNemp	  = empresa.empresa
	ENDIF

	SET NEAR ON
	SEEK LNemp
   	IF LASTKEY() = 27 OR !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LFretorno = .F.
	ELSE
		LSnome  = empresa.sigla
		LFretorno = .T.
	ENDIF
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	=UP_fecha("empresa" ,LFempresa)
RETURN(LFretorno)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0W           EMrodanroNF VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:    5   
*        Variable:            EMrodanroNF                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      197                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0w     &&  EMrodanroNF VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMrodanroNF
PARAMETERS LNemp,LStp_process
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Incrementar Numeracao de Nota/Cupom
	*	
	*------------------------------------------------------------*
	* COMENTARIO..:
	*				
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	*  TABELAS....:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp..........: Empresa que Esta Faturando
	*		LStp_process...: Processo definido em NFDefProcess
	*
	*------------------------------------------------------------*
	*  RETORNO.....:
	*------------------------------------------------------------*
	* EXEMPLO : CHAMADA DO PROGRAMA SCGC2.prg
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	=REGLOCK(.T.)
	DO CASE
		CASE LStp_proces = "NOTA" OR LStp_proces = "NOTA/CUPOM"
			REPLACE empresa.nota WITH empresa.nota + 1 && ULTIMA NOTA GERADA
			REPLACE FLAGIMPNF 	WITH 1
		CASE LStp_proces = "CUPOM"
			REPLACE empresa.ult_cupom  WITH ult_cupom + 1
			REPLACE FLAGIMPCPM 	WITH 1
		CASE LStp_proces = "NF.SERVICO"
			REPLACE empresa.Ult_NFsrvc WITH empresa.Ult_NFsrvc + 1
			REPLACE FLAGIMPSRV 	WITH 1

	ENDCASE
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0X           EMGet_Mora VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:    6   
*        Variable:            EMGet_Mora                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      198                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0x     &&  EMGet_Mora VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Mora
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("MORA"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0Y           EMGet_Sigla VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:    7   
*        Variable:            EMGet_Sigla                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      199                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0y     &&  EMGet_Sigla VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Sigla
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("SIGLA"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ0Z           EMGet_ECFSerie VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:    8   
*        Variable:            EMGet_ECFSerie                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      200                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz0z     &&  EMGet_ECFSerie VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_ECFSerie
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("ECF_SERIE"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ10           EMGet_Municipio VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:    9   
*        Variable:            EMGet_Municipio                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      201                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz10     &&  EMGet_Municipio VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_Municipio
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("CIDADE"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ11           EMGet_TabCst VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   10   
*        Variable:            EMGet_TabCst                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      202                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz11     &&  EMGet_TabCst VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_TabCst
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("TAB_CST"))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ12           EMLerRegistro VALID                
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   11   
*        Variable:            EMLerRegistro                      
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      203                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz12     &&  EMLerRegistro VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMLerRegistro
PARAMETERS  PrmEmp



	PRIVATE LFretorno
	LFretorno = .t.

	LFretorno = EMChk_Identidade(PrmEmp)
RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ13           EMSalvarRegistro VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   12   
*        Variable:            EMSalvarRegistro                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      204                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz13     &&  EMSalvarRegistro VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMSalvarRegistro

	=EMVerifyInst()

	PRIVATE LFretorno
	LFretorno = .t.

	IF !EMExiste()
		SELE &PBEmpresaAlias
		APPEND BLANK
		LFretorno=EMWriteProp()
	ELSE
		SELE &PBEmpresaAlias
		LFretorno=EMWriteProp()
	ENDIF

RETURN(LFretorno)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ14           EMExiste VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   13   
*        Variable:            EMExiste                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      205                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz14     &&  EMExiste VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMExiste
	PRIVATE LEmpresa

	PRIVATE LFreturn

	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=EMVerifyInst()

	LEmpresa    = EMGetPropVT("Empresa")


	SELE &PBEmpresaAlias
	SET ORDER TO TAG empresa
	SEEK Lempresa

	
	IF FOUND()
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ15           EMVerifyInst VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   14   
*        Variable:            EMVerifyInst                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      206                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz15     &&  EMVerifyInst VALID
#REGION 8
return
*---------------------------------------------------------------*



FUNCTION EMVerifyInst
	
PRIVATE LSpath
	=W_DEFPROC("rotinas.spr")
	LSpath = UPobterPath("Empresa")


	DO CASE

		CASE TYPE("PBEmpresalias") = "U" ;
		   		OR EMPTY(PBEmpresaAlias) ;
		   		OR !USED(PBEmpresaAlias)
			=EMCreate()					

		CASE !("EMPRESA.DBF" $ DBF(PBEmpresaAlias))
				* APOS UM CLOSE DATABASE UM OUTRO DBF FOI
				* ABERTO NA AREA ANTES OCUPADA PELO DBF AVALIADO AKI
				RELEASE PBEmpresaAlias
			=EMCreate()					


		CASE  !(LSPath $ DBF(PBEmpresaAlias))
			 	* HOUVE MUDANCA DE DIR BASE
			 	* ELIMINA INSTACIA DE OUTRA BASE
		     	* CRIA INSTANCIA NA NOVA BASE
			=EMDestroi()				
			=EMCreate()					
	ENDCASE

	
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ16           EMCreate VALID                     
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   15   
*        Variable:            EMCreate                           
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      207                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz16     &&  EMCreate VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMCreate
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LSAlsTmp
    PRIVATE LMaxDim
	LSalias		= 	ALIAS()
	
	IF TYPE("PBEmpresaAlias") <> "U" ;
	   		AND !EMPTY(PBEmpresaAlias) ;
	   		AND USED(PBEmpresaAlias)
			RETURN(.T.)
	ENDIF


	PUBLIC PBEmpresaAlias

	IF USED("Empresa")
	     =NetArqAgain("Empresa")
	     PBEmpresaAlias     = Alias()
	ELSE
	     =NetArqAgain("Empresa")
	     LSAlsTmp     = Alias()
	     =NetArqAgain("Empresa")
	     PBEmpresaAlias     = Alias()
		 IF !EMPTY(LSAlsTmp) AND USED(LSAlsTmp)
			SELECT &LSAlsTmp
			USE
		 ENDIF
	ENDIF	

    SELE &PBEmpresaAlias
	LMaxDim = Fcount()
    PUBLIC DIMENSION VTEmpresa[LMaxDim]
    PUBLIC DIMENSION VDEmpresa[2,3]			&& VETOR PARA PROPRIEDADES
	*-----------------------------------------------------------*
	=EMReadProperty()
	=EMSetDerivadas()
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ17           EMDestroi VALID                    
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   16   
*        Variable:            EMDestroi                          
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      208                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz17     &&  EMDestroi VALID
#REGION 8
return
*---------------------------------------------------------------*


FUNCTION EMDestroi

	=W_DEFPROC("rotinas.spr")

	IF TYPE("PBEmpresaAlias") = "U"
		RETURN
	ENDIF

    *--------------------------------------------------------------------*
	*-> QUANDO O SISTEMA APLICA UM CLOSE DATABASE :
	*   EX: EM UPAltDir (Geral.spr)
	*  1- Fecha inclusive a referencia do PBDocFiscaAlias
	*  2- Novas tabelas abertas podem ocupar a area referenciada
	*     por PBDocFiscaAlias
	*  3- Se aplicar um FECHAMENTO a PBDocFiscaAlias estara fechando
	*     outra tabela
	*  4- Entao Verifica-se a coerencia do dbf esperado em PBDocFiscaAlias
	*-------------------------------------------------------------------*
	IF !(USED(PBEmpresaAlias)) OR ;
	   !("EMPRESA.DBF" $ DBF(PBEmpresaAlias))

		RELEASE PBEmpresaAlias
    	RELEASE VTEmpresa
	    RELEASE VDEmpresa
		return(.T.)			
	ENDIF
	PRIVATE LSalias
	LSalias  = Alias()
	IF !EMPTY(PBEmpresaAlias) AND USED(PBEmpresaAlias)
		SELECT &PBEmpresaAlias
		USE
	ENDIF	
	RELEASE PBEmpresaAlias
    RELEASE VTEmpresa
    RELEASE VDEmpresa

	*-----------------------------------------------------------*
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ18           EMReadProp VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   17   
*        Variable:            EMReadProp                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      209                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz18     &&  EMReadProp VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMReadProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=EMVerifyInst()

	SELE &PBEmpresaAlias
	SCATTER TO VTEmpresa
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ19           EMSetDerivadas VALID               
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   18   
*        Variable:            EMSetDerivadas                     
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      210                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz19     &&  EMSetDerivadas VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMSetDerivadas
	PRIVATE LSalias
	PRIVATE LEmpresa
	LSalias		= 	ALIAS()

**	=EMVerifyInst()
	*--------------------------------------------------------------*
    VDEmpresa(1,1) = "NAOINFORMADO"
   	VDEmpresa(1,2) = 0
   	VDEmpresa(1,3) = .F.
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ1A           EMSetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   19   
*        Variable:            EMSetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      211                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz1a     &&  EMSetPropVT VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMSetPropVT
PARAMETER  PrmField, PrmValue
	PRIVATE Lvalue

**	=EMVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTsetValueObj(PrmField,PrmValue,;
						    PBEmpresaAlias,VTEmpresa,VDEmpresa)

RETURN(Lvalue)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ1B           EMGetPropVT VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   20   
*        Variable:            EMGetPropVT                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      212                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz1b     &&  EMGetPropVT VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMGetPropVT
PARAMETER  PrmField

	PRIVATE Lvalue

**	=DFVerifyInst()
	=W_DEFPROC("ROTINAS.SPR")
	Lvalue = RTgetValueObj(PrmField,PBEmpresaAlias,VTEmpresa,VDEmpresa)

RETURN(Lvalue)





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ1C           EMChk_Identidade VALID             
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   21   
*        Variable:            EMChk_Identidade                   
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      213                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz1c     &&  EMChk_Identidade VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMChk_Identidade
PARAMETERS  PrmEmp


	PRIVATE LFretorno
	LFretorno = .t.



	=EMVerifyInst()

    =EMSetPropVT("EMPRESA",PrmEmp)
	LFretorno=EMFind()

RETURN(LFretorno)





*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ1D           EMFind VALID                       
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   22   
*        Variable:            EMFind                             
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      214                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz1d     &&  EMFind VALID
#REGION 8
return
*---------------------------------------------------------------*
FUNCTION EMFind

	PRIVATE Lcodigo
	PRIVATE LFreturn

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	LSalias		= 	ALIAS()

	=EMVerifyInst()

	Lcodigo   = EMGetPropVT("EMPRESA")

	SELE &PBEmpresaAlias
	SET ORDER TO TAG empresa
	SEEK Lcodigo

	IF FOUND()
		=EMReadProperty()
		=EMSetDerivadas()   && carga dos calculos derivados
	    LFreturn = .T.
	ELSE
	    LFreturn = .f.
	ENDIF
	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFreturn)






*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ1E           EMGetFieldValue VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   23   
*        Variable:            EMGetFieldValue                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      215                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz1e     &&  EMGetFieldValue VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMGetFieldValue
PARAMETERS  PrmEmp,PrmField			


	IF !EMChk_Identidade(PrmEmp)
		DO WHILE .T.
			=UPerrosys("Chamada GetFieldValue para Reg. Inexistente!")
		ENDDO
	ENDIF				

RETURN(EMGetPropVT(PrmField))


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ1F           EM_Refresh VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   24   
*        Variable:            EM_Refresh                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      216                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz1f     &&  EM_Refresh VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EM_Refresh
PARAMETERS  PrmEmpresa
	

	PRIVATE LFreturn

	=EMVerifyInst()


	= EMSetPropVT("Empresa"   ,PrmEmpresa)

	*----------------------------------------------------------------*


	=EMFind()
	
RETURN(.t.)




*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ1G           EMWriteProp VALID                  
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   26   
*        Variable:            EMWriteProp                        
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      217                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz1g     &&  EMWriteProp VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMWriteProp
	PRIVATE LSalias
	LSalias		= 	ALIAS()

**	=EMVerifyInst()

	SELE &PBEmpresaAlias
	=RLOCK()
	GATHER FROM  VTEmpresa
	UNLOCK

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(.T.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ1H           EMGetAlias VALID                   
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   28   
*        Variable:            EMGetAlias                         
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      218                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz1h     &&  EMGetAlias VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMGetAlias

	=EMVerifyInst()

RETURN(PBEmpresaAlias)


*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ1I           EMMarcaFlgNF VALID                 
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   30   
*        Variable:            EMMarcaFlgNF                       
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      219                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz1i     &&  EMMarcaFlgNF VALID
#REGION 8
return
*---------------------------------------------------------------*

FUNCTION EMMarcaFlgNF
PARAMETERS LNemp,PrmNivelProcesso
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	* OBJETIVO....: Incrementar Flag Nota/Cupom
	*	
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	*-----------------------------------------------------------*
	LSalias	= ALIAS()
	*------------------------------------------------------------*
	SELECT empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.f.)
	ENDIF
	=REGLOCK(.T.)

	REPLACE FLAGIMPNF 	WITH PrmNivelProcesso

	*--------------------------------------------------------------*
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.t.)



*       靈컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*                                                                
*        _3T40ZSZ1J           EMGet_ECFModelo VALID              
*                                                                
*        Function Origin:                                        
*                                                                
*        From Platform:       MS-DOS                             
*        From Screen:         EMPRESA,     Record Number:   31   
*        Variable:            EMGet_ECFModelo                    
*        Called By:           VALID Clause                       
*        Object Type:         Push Button                        
*        Snippet Number:      220                                
*                                                                
*       聃컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴
*

FUNCTION _3t40zsz1j     &&  EMGet_ECFModelo VALID
#REGION 8
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION EMGet_ECFModelo
PARAMETERS PrmEmp

	=EMChk_Identidade(PrmEmp)

RETURN(EMGetPropVT("TIPO_ECF"))
SSS