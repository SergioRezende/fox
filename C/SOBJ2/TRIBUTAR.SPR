*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º 09/03/2016           TRIBUTAR.SPR              16:14:46 º
*       º                                                         º
*       ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶
*       º                                                         º
*       º Author's Name                                           º
*       º                                                         º
*       º Copyright (c) 2016 Company Name                         º
*       º Address                                                 º
*       º City,     Zip                                           º
*       º                                                         º
*       º Description:                                            º
*       º This program was automatically generated by GENSCRN.    º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º                MS-DOS Window definitions                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              TRIBUTAR/MS-DOS Screen Layout              º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 1
@ 36,0 SAY "ROTINAS AINDA VINCULADAS AO ORCAMENTO (AINDA DEPEDEM DO NRO ORCAMENTO)" ;
	SIZE 1,70, 0
@ 3,0 SAY "ROTINAS GERAIS - COM PARAMETROS MAIS INDEPENDENTES E ESPECIFICOS" ;
	SIZE 1,64, 0
@ 13,3 GET TRGet_IPIProd ;
	PICTURE "@*HN TRGet_IPIProd - Obtem a Aliquota de IPI do Produto" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkfr()
@ 14,3 GET TRGet_ISSAlq ;
	PICTURE "@*HN TRGet_ISSAlq - Obtem Aliquota de ISS" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkfy()
@ 16,6 GET TRdefcst ;
	PICTURE "@*HN TRdefcst - Define CST para Item do Orcamento" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkg6()
@ 28,3 GET TRAlqIcmInUF ;
	PICTURE "@*HN TRAlqIcmInUF - Obetem Aliquota Interna de ICMS na UF informada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkg7()
@ 29,3 GET TRAlqIcmOuUF ;
	PICTURE "@*HN TRAlqIcmOuUF - Obetem Aliquota Externa de ICMS na UF informada" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkg8()
@ 25,3 GET TRCFO ;
	PICTURE "@*HN TRCFO  - Obtem CFO Pela OPERACAO E TIPO MERCADORIA" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkhb()
@ 41,6 GET TRGet_IPIAlq ;
	PICTURE "@*HN 02-TRGet_IPIAlq - Obtem a Aliquota de IPI do produto para o orcamento" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkhj()
@ 42,6 GET TRGet_cst ;
	PICTURE "@*HN 03-TRGet_cst - Obtem CST para o produto no orcamento" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkhs()
@ 30,3 GET TRDef_tpMercad ;
	PICTURE "@*HN TRDef_tpMercad- DESVIO COMPATIBILIZA COM TRDef_RgTrbMercad (DESCARTAR FUTURO)" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkht()
@ 43,6 GET TRGet_rduIcms ;
	PICTURE "@*HN 06-TRGet_rduIcms - Obtem Aliquota de Reducao do ICMS" ;
	SIZE 1,54,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkib()
@ 44,6 GET TRGet_IcmsAlq ;
	PICTURE "@*HN 07-TRGet_IcmsAlq - Obtem Aliquota de ICMS para Orcamento" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkij()
@ 45,6 GET TRGet_CFO ;
	PICTURE "@*HN 08-TRGet_CFO  - Obtem CFO" ;
	SIZE 1,27,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkiq()
@ 39,2 GET TRcalc_tribu ;
	PICTURE "@*HN TRcalc_tribu- Calcula Valores Tributarios Fiscais" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkir()
@ 49,3 GET CSTENT ;
	PICTURE "@*HN ?? - Define CST NF Entrada" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkit()
@ 50,4 GET TRRtdoSaida ;
	PICTURE "@*HN 15-TRRtdoSaida - Ret.Vlr.ICM Retido na Saida" ;
	SIZE 1,46,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkki()
@ 51,4 GET TRRtdoEntrada ;
	PICTURE "@*HN 16-TRRtdoEntrada - Ret.Vlr.ICM Retido na Entrada" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkkq()
@ 52,4 GET TRicmNormal ;
	PICTURE "@*HN 17-TRicmNormal - Ret.Vlr.ICM Normal" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkkw()
@ 53,4 GET TREnbsicmNormal ;
	PICTURE "@*HN 18-TREnbsicmNormal - Ret.Base ICMS Norma Entrada" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkkx()
@ 54,4 GET TREbsRtdoCIVA ;
	PICTURE "@*HN 19-TREbsRtdoCIVA - Ret.Base ICMS Retido Entrada (Com IVA)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkky()
@ 55,4 GET TREbsRtdoSIVA ;
	PICTURE "@*HN 20-TREbsRtdoSIVA - Ret.Base ICMS Retido Entrada (Sem IVA)" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkkz()
@ 1,6 GET TRgrupoALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,17 GET TRgrfiscalALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,28 GET TRtab_IvaALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 1,39 GET TRtipooperALIAS ;
	SIZE 1,10 ;
	DEFAULT " "
@ 40,4 GET TRcalc_Difer ;
	PICTURE "@*HN 11-TRcalc_Difer- Ajusta Diferanca geradas nos tributo percentuais" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkl0()
@ 46,0 SAY "ROTINAS PARA NOVA PLANILHA TRIBUTARIA (OPERCMRC e CLASFISC)" ;
	SIZE 1,59, 0
@ 47,4 GET TRVincTipo ;
	PICTURE "@*HN 16-TRVincTipo - Vincula TIPOOPER a OPERCMRC e A CLASFISC" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkl1()
@ 4,3 GET TRGet_IVA ;
	PICTURE "@*HN TRGet_IVA - Obtem o IVA Ajustada proprio do produto (Pecas)" ;
	SIZE 1,61,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkma()
@ 48,1 SAY "ROTINAS PARA ENTRADA JA USADAS EM SCGC245 (CONTAB NOTAS ENTRADA)" ;
	SIZE 1,64, 0
@ 26,3 GET TRCFOPServico ;
	PICTURE "@*HN TRCFOPServico - Define CFOP para Servico" ;
	SIZE 1,42,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4l10ytkmb()
@ 20,3 GET TRCST_IPI ;
	PICTURE "@*HN TRCST_IPI - Codigo de Situacao Tributaria para IPI" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4l10ytkmc()
@ 21,3 GET TRCST_ISS ;
	PICTURE "@*HN TRCST_ISS - Codigo Sit Tributaria ISS" ;
	SIZE 1,39,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4l10ytkmd()
@ 35,3 GET TRGenero ;
	PICTURE "@*HN TRGenero - Define Genero do Produto" ;
	SIZE 1,37,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4l10ytkme()
@ 15,3 GET TRcst_Icms ;
	PICTURE "@*HN TRcst_Icms - Define CST completo com 3 digitos" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkmf()
@ 22,3 GET TRCST_PIS ;
	PICTURE "@*HN TRCST_PIS - Desenvolver" ;
	SIZE 1,25,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4l10ytkno() ;
	DISABLE
@ 23,3 GET TRCST_COFINS ;
	PICTURE "@*HN TRCST_COFINS - Desenvolver" ;
	SIZE 1,28,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4l10ytknu() ;
	DISABLE
@ 24,3 GET TRCST_IR ;
	PICTURE "@*HN TRCST_IR - Desenvolver" ;
	SIZE 1,24,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _4l10ytko0() ;
	DISABLE
@ 0,0 SAY "ALIASES" ;
	SIZE 1,7, 0
@ 31,5 GET TRDef_RgTrbMercad ;
	PICTURE "@*HN TRDef_RgTrbMercad - Retorna o Regime Tributario da Merc. na UF" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _4l10ytko1()
@ 38,0 GET TRpct_trib ;
	PICTURE "@*HN TRpct_trib - (01 a 09) em Pacote de Tributos - Acelera processo" ;
	SIZE 1,65,1 ;
	DEFAULT 1 ;
	VALID _4l10ytko2()
@ 32,5 GET TRCnvrt_RgTrbMercad ;
	PICTURE "@*HN TRCnvrt_RgTrbMercad - Converte Codigo Reg Trib em String" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	VALID _4l10ytko3()
@ 18,3 GET TRcst_Entrada ;
	PICTURE "@*HN TRcst_Entrada - Define CST para Item do Orcamento" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	VALID _4l10ytko4()
@ 6,5 GET TR_InternaIVAAjustada ;
	PICTURE "@*HN TR_InternaIVAAjustada - AUX. IVA IVA interna (PECAS) TERMO DE ACORDO TO/DF/GO" ;
	SIZE 1,79,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkpd()
@ 7,5 GET TR_ICM49IVAjustada ;
	PICTURE "@*HN TR_ICM49IVAjustada - AUX. (PECAS) -PROT.ICMS 49-8/5/2008 IVA AJUSTAS DF/MT" ;
	SIZE 1,76,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkpe()
@ 10,5 GET TR_ICM62IVAjustada ;
	PICTURE "@*HN TR_ICM62IVAjustada - AUX. (PECAS) -PROT.ICMS 62-22/6/2012 IVA AJUSTAS" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkpf()
@ 8,5 GET TR_ICM92IVAjustada ;
	PICTURE "@*HN TR_ICM92IVAjustada - AUX.(PNEUM)-CONV.ICMS 92-30/9/2011 IVA AJUSTAS" ;
	SIZE 1,69,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkpg()
@ 11,5 GET TR_ICM73IVAjustada ;
	PICTURE "@*HN TR_ICM73IVAjustada - AUX. (PECAS) -PROT.ICMS 73-05/12/2014 IVA AJUSTAS" ;
	SIZE 1,72,1 ;
	DEFAULT 1 ;
	VALID _4l10ytkph()



READ


#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKFR           TRGet_IPIProd VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    4  º
*       º Variable:            TRGet_IPIProd                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      1                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkfr     &&  TRGet_IPIProd VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IPIProd
PARAMETERS PrmProduto

    PRIVATE LNipialq

	=W_DEFPROC("GRUPO.SPR")
	LNipialq =GRGetFieldValue(PrmProduto,"ALIQ_IPI")

RETURN(LNipialq)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKFY           TRGet_ISSAlq VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    5  º
*       º Variable:            TRGet_ISSAlq                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      2                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkfy     &&  TRGet_ISSAlq VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_ISSAlq
PARAMETERS PrmEmpresa


    PRIVATE LNaliq_iss

	=W_DEFPROC("EMPRESA.SPR")
	LNaliq_iss =EMGetFieldValue(PrmEmpresa,"ALIQ_ISS")

RETURN(LNaliq_iss)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKG6           TRdefcst VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    6  º
*       º Variable:            TRdefcst                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      3                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _4l10ytkg6     &&  TRdefcst VALID
#REGION 1
RETURN

FUNCTION TRdefcst
	PARAMETERS Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto,PrmCst

	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_tab_cst,ALS_tab_cst
	LSalias = ALIAS()

    ARQ_Tab_Cst     = NetArqAgain("TAB_CST")
    ALS_Tab_Cst     = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()



	IF ( ARQ_Tab_Cst)+ ARQ_Tipooper > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ PrmTipo
	IF !FOUND()
		SEEK 's'+  PrmTipo
	ENDIF
	IF !FOUND()
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF



	LScst = " "
	DO CASE
		CASE &Als_tipooper .ch_opera = "4"  && DEVOLUCAO
			LScst =  PrmCST
		OTHERWISE
			SELECT &Als_tab_cst
			SET ORDER TO TAG cst
			SEEK STR(Prmtab_cst,2)+PrmTipo+STR(Prmtp_mercad,1)
			IF !FOUND()
				IF tipooper.ch_opera = "3"
					LScst =  "4"
				ENDIF
			ELSE
				LScst =  RIGHT( &Als_tab_cst .cst,1)
			ENDIF
	ENDCASE
	*------------------------------------------------------------*
    =up_fecha("&ALS_Tab_cst")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKG7           TRAlqIcmInUF VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    7  º
*       º Variable:            TRAlqIcmInUF                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      4                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkg7     &&  TRAlqIcmInUF VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRAlqIcmInUF
PARAMETERS PrmUF

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    LSAlias      = Alias()
    LNaliq_icms = 0
	*--------------------------------------------------------*
	DO CASE
		CASE PrmUF $ "DF/TO" AND YEAR(DATE()) >= 2016
		    LNaliq_icms = 18

		CASE PrmUF $ "MG/RJ/SP/PR/SC"
		    LNaliq_icms = 18
		
		CASE PrmUF $ "AM/AP/BA/DF/MA/MG/PB/PR/PE/RN/RS/SP/SE/TO"
		    LNaliq_icms = 18
		

		OTHERWISE
		    LNaliq_icms = 17
	ENDCASE
	*--------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)





*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKG8           TRAlqIcmOuUF VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    8  º
*       º Variable:            TRAlqIcmOuUF                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      5                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkg8     &&  TRAlqIcmOuUF VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRAlqIcmOuUF
PARAMETERS PrmUF, PrmOrigemMercadoria

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    LSAlias      = Alias()
    LNaliq_icms = 0


    IF TYPE("PrmOrigemMercadoria") = "L"   && NAO FOI REPASSADO PARAMETRO -
                                           && CHAMADA ROTINA ANTIGA
		PrmOrigemMercadoria = 0

    ENDIF





	*--------------------------------------------------------*

	DO CASE
		CASE PrmOrigemMercadoria = 2
		    LNaliq_icms = 4

		CASE PrmUF $ "MG/RJ/SP/PR/SC"
		    LNaliq_icms = 7
		OTHERWISE
		    LNaliq_icms = 12
	ENDCASE
	*--------------------------------------------------------*

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKHB           TRCFO VALID                        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:    9  º
*       º Variable:            TRCFO                              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      6                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkhb     &&  TRCFO VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRCFO
PARAMETERS PrmEmpresa, PrmTipo, PrmTp_mercad,PrmOperacao

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*

	*------------------------------------------------------------*

    PRIVATE LScfo
    PRIVATE LSalias
    PRIVATE PrmTp_mercad

    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()


	STORE 0 TO ARQ_Tipooper
	*--------------------------------------------------------
	IF TYPE("TRtipooperALIAS") = "U" OR !USED(TRtipooperALIAS)
		PUBLIC TRtipooperALIAS
	    ARQ_Tipooper     = NetArqAgain("TIPOOPER")
	    TRtipooperALIAS  = Alias()
	ENDIF
    ALS_Tipooper     = TRtipooperALIAS


    LScfo = SPACE(5)
	*--------------------------------------------------------*

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	IF UPPER(PrmOperacao) = "SAIDA"
		SEEK 'S'+ PrmTipo
		IF !FOUND()
			SEEK 's'+  PrmTipo
		ENDIF
	ELSE
		SEEK 'E'+ PrmTipo
		IF !FOUND()
			SEEK 'e'+  PrmTipo
		ENDIF
	ENDIF

	*--------------------------------------------------------*

	IF !FOUND()
   		*=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF

		IF  PrmTipo = "CPM"
		   LScfo = "5.929"
		ENDIF
		
        RETURN(LScfo)
	ENDIF


	*------------------------------------------------------*

	DO CASE


		CASE  PrmTipo = "CPM"
		   LScfo = "5.929"


		CASE PrmTp_mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs


		CASE     PrmTp_mercad = 7 ;
		  	 AND UPPER(PrmOperacao) = "SAIDA" ;
			 AND &Als_tipooper .ch_opera = "1"  && Venda/Compra SERVICO


		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO

		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE

	LScfo = LEFT(ALLTRIM(LScfo)+"   ",5)

	*------------------------------------------------------------*
	*=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LScfo)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKHJ           TRGet_IPIAlq VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   10  º
*       º Variable:            TRGet_IPIAlq                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      7                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkhj     &&  TRGet_IPIAlq VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IpiAlq
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto

	=W_DEFPROC("rotinas.spr")

    PRIVATE LNipialq
    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNipialq = 0
	*--------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA

	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
		RETURN(LNipialq)
	ENDIF


    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
	    DO TRFch_IPIAlqFecha
        RETURN(LNipialq)
	ENDIF
	*------------------------------------------------------------*

	DO CASE
		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA
		CASE &Als_Grupo .origem = 1

			LNipialq   =  TRGet_IPIProd(PrmProduto)

		OTHERWISE
			LNipialq   =	0
	ENDCASE

	*------------------------------------------------------------*

    DO TRFch_IPIAlqFecha

RETURN(LNipialq)

PROCEDURE TRFch_IPIAlqFecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKHS           TRGet_cst VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   11  º
*       º Variable:            TRGet_cst                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      8                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkhs     &&  TRGet_cst VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_cst
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto,PrmCST

	=W_DEFPROC("rotinas.spr")

    PRIVATE LScst
    PRIVATE LSalias

    PRIVATE LNtab_cst
    PRIVATE LNtp_mercad

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Orcamento,ALS_Orcamento

    LSAlias      = Alias()

    *----------------------------------------------------*
	LScst		= " "		&& ASSUME 0

    *----------------------------------------------------*

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()


    LScst  = " "

	LNtab_cst = 0

	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF

	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

 	LNtab_cst = &ALS_empresa .tab_cst

	*--------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF

	*------------------------------------------------------------*


    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
	    DO TRFch_CSTFecha
        RETURN(LScst)
	ENDIF


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)
	*---------------------------------------------------------------*
	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto)


	*------------------------------------------------------------*

    DO TRFch_CSTFecha

RETURN(LScst)

PROCEDURE TRFch_CSTFecha
	IF LScst = " "
		WP_MSG = "ATENCAO :  Nao foi Encontrada TABELA de C.S.T p/ "+;
			"[ Tab:"+STR(LNtab_cst,2)+;
			" Tipo:"+ &ALS_orcamento .tipo +" Mercad"+;
			STR(LNtp_mercad,1)+chr(13)+;
			"SOLICITE CADASTRO URGENTE !!!!!!."
			DO OBJ_ALER.SPR WITH WP_MSG
	ENDIF

    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Orcamento")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKHT           TRDef_tpMercad VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   12  º
*       º Variable:            TRDef_tpMercad                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      9                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkht     &&  TRDef_tpMercad VALID
#REGION 1
RETURN


*--------------------------------------------------------------------*
* ESTA ROTINA ESTA VINCULADA AO ITEM DO ORCAMENTO E DEVE SER DESATIVADA
* EM (TRIBUTAR) QDO FOR MIGRADA PARA ITEM DE (ORCAMENTO OU ITEMMOV)
* COMENTARIO EM 14/05/2009
*---------------------------------------------------------------------*



FUNCTION TRDef_TpMercad
	PARAMETER PrmEmpresa,PrmOrcamento,PrmProduto


	=W_DEFPROC("rotinas.spr")

	PRIVATE LUFEmpresa
	PRIVATE	LNtp_mercad

	=W_DEFPROC("EMPRESA.SPR")
	LUFEmpresa = EMGetFieldValue(PrmEmpresa,"ESTADO")


	*--------------------------------------------------------


	LNtp_mercad	= 99999   && INVALIDO


	LNtp_mercad=;
		TRDef_RgTrbMercad( LUFEmpresa ,PrmProduto)

	*--------------------------------------------------------


RETURN(LNtp_mercad)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKIB           TRGet_rduIcms VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   13  º
*       º Variable:            TRGet_rduIcms                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      10                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkib     &&  TRGet_rduIcms VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_rduIcms
PARAMETERS PrmEmpresa, PrmOrcamento

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
    *     Definir melhor as regras de reducao de base de ICMS
    * Por enquanto :
    *   FILIAL ARG => Usa reducao informada no registro da empresa
    *   Outras situacaoes ocorrem conforme a operacao e o indice
    *   deve ser informado no tipooper e atribuido ao orcamento
	*------------------------------------------------------------*

    PRIVATE LNaliq_rdu
    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNaliq_rdu = 0
	*--------------------------------------------------------*


    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_rdu)
	ENDIF


	*------------------------------------------------------------*

	LNalq_rdu    =  0
	IF &Als_empresa .REDUZ_BASE = 0
		LNalq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNalq_rdu = &Als_empresa .REDUZ_BASE
		ELSE
			LNalq_rdu = &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA

		endif
	ENDIF

	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_rdu)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKIJ           TRGet_IcmsAlq VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   14  º
*       º Variable:            TRGet_IcmsAlq                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      11                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkij     &&  TRGet_IcmsAlq VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_IcmsAlq
PARAMETERS PrmEmpresa, PrmOrcamento

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    PRIVATE LNaliq_icms
    PRIVATE LSalias

    PRIVATE ARQ_Empresa   , ALS_Empresa
    PRIVATE ARQ_Orcamento , ALS_Orcamento
    PRIVATE ARQ_Tipooper  , ALS_Tipooper

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LNaliq_icms = 0
	*--------------------------------------------------------*

    SELE &ALS_Empresa
  	SET ORDER TO TAG empresa
    SEEK PrmEmpresa
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF


	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    =up_fecha("&ALS_Empresa")
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LNaliq_icms)
	ENDIF


	*------------------------------------------------------------*

	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms  =  &Als_orcament .aliq_icms && USAR ALIQUOTA INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA INFORMADA
	ENDIF

	*------------------------------------------------------------*
    =up_fecha("&ALS_Empresa")
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNaliq_icms)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKIQ           TRGet_CFO VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   15  º
*       º Variable:            TRGet_CFO                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      12                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkiq     &&  TRGet_CFO VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRGet_CFO
PARAMETERS PrmEmpresa, PrmOrcamento,PrmProduto

	=W_DEFPROC("rotinas.spr")

	*------------------------------------------------------------*

	*------------------------------------------------------------*

    PRIVATE LScfo
    PRIVATE LSalias
    PRIVATE LNtp_mercad

    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper

    LSAlias      = Alias()


    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

    LScfo = ""
	*--------------------------------------------------------*



	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LScfo)
	ENDIF

	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	   	=up_fecha("&ALS_Orcamento")
   		=up_fecha("&ALS_tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
        RETURN(LScfo)
	ENDIF


	*------------------------------------------------------*


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)

	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE PrmTp_mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE


	*------------------------------------------------------------*
   	=up_fecha("&ALS_Orcamento")
	=up_fecha("&ALS_tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LScfo)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKIR           TRcalc_tribu VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   16  º
*       º Variable:            TRcalc_tribu                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      13                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkir     &&  TRcalc_tribu VALID
#REGION 1
RETURN

FUNCTION TRcalc_tribu
	PARAMETERS LNemp,LStipo,LScst,LNvlrvenda,LNtp_mercad;
				LNalq_iss,LNalq_icms,LNalq_ipi,LNalq_rdu,;
				LNiva,;
				LDdata,;
				LSufdesti,;
				LNqtde,;
				LScodprd,;
				LNbsIss,LNvlrIss,;
				LNbsIcms,LNvlrIcms,LNbsIsent,;
				LNbsSbBrt,LNbsSubs,LNicmSub,LNbsOutr,;
		        vTParam

	LNbsIpi      = vTParam[01]
	LNvlrIpi     = vTParam[02]
	LNbsIsIpi    = vTParam[03]
	LNbsbrIcms   = vTParam[04]
    PrmSeg       = vTParam[05]
    LNissrtd     = vTParam[06]
    PrmSbstISS   = vTParam[07]


	*----------------------------------------------------------*
    *    O Numero maximo de parametros passados a uma UDF e 24
    * o vTParam aplia essa condicao (mas por questoes de facilidade o
    * vetor so e utilizado para completar os parametros excedentes)
	*----------------------------------------------------------*


	*------------------------------------------------------------*
	*  CLASSIFICACAO:  [*****]
	*------------------------------------------------------------*
	*  OBJETIVO.......: Calcular Valores TRIBUTARIAS E FISCAIS
	*------------------------------------------------------------*
	*  COMENTARIO.....:
	*------------------------------------------------------------*
	*  OBS............:
	*------------------------------------------------------------*
	*  TABELAS.......:
	*------------------------------------------------------------*
	*  PARAMETROS..:
	*		LNemp......:
	*		LStipo.....:
	*		LScst......: Codigo Situacao Tributaria
	*		LNvlrvenda.: Valor da Venda (Movimentacao)
	*		LNtp_mercad:
	*		LNalq_iss..:
	*		LNalq_icms.:
	*		LNalq_ipi..:
	*		LNalq_rdu..:
	*		LNiva......:
	*		LDdata.....:
	*		LSufdesti..:
	*		LNqtde.....: Para atendeder necessidade no calc base IPI
	*					 da transferencia
	*		LScodprd...: As Rotinas Novas > 22/08/2000 passam o
	*                  Codigo do Produto LEN(LScodprd) = 11 e as
	*                  antigas , que devem ser substituidas usam
	*                  a Classifica‡Æo LEN(LScodprd) > 11
	*                  => Quando Vier o Codigo => Ler Grupo e Achar a
	*                  Classifica‡Æo para uso interno desta Rotina
	*
	*	Para atendeder necessidade no calc base IPI
	*					 da transferencia
	*------------------------------------------------------------*
	*  RETORNO.....:
	*		LNbsIss....:
	*		LNvlrIss...:
	*		LNbsIcms...:
	*		LNvlrIcms..:
	*		LNbsIsent..:
	*		LNbsSbBrt..:
	*		LNbsSubs...:
	*		LNbsOutr...:
	*		LNbsIpi....:
	*		LNvlrIpi...:
	*		LNbsIsIpi..:
	*		LNbsbrIcms.:
	*------------------------------------------------------------*
	* CHAMADAS : OBJ_ITOR.SCR
	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	*------------------------------------------------------------*
	PRIVATE LNbs_TRIBUTAR		&& BASE PARA TIBUTAR
	PRIVATE LDdtpesq			&& PARA PESQUISA DE BASE IPI TRANSD
	PRIVATE LSclasprd


    PRIVATE LSalias

    PRIVATE ARQ_Empresa,ALS_Empresa
    PRIVATE ARQ_Grupo,ALS_Grupo
    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_Saldo,ALS_Saldo

    LSAlias      = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Grupo     = NetArqAgain("GRUPO")
    ALS_Grupo     = Alias()

    ARQ_Saldo  = NetArqAgain("SALDO")
    ALS_Saldo  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()

	*------------------------------------------------------------*
	IF LEN(LScodprd) > 11
		LSclasprd = LScodprd
	ELSE
		SELE &ALS_grupo
		SET ORDER TO TAG codigo
		SEEK LScodprd
		IF !FOUND()
			LSclasprd = ""
		ELSE	
			LSclasprd = &ALS_grupo .classifica
		ENDIF
	ENDIF
	*------------------------------------------------------------*
	SELECT &ALS_tipooper
	SET ORDER TO tag tipo
	SEEK "S"+LStipo
	IF !FOUND()
		SEEK "s"+LStipo
		IF !FOUND()
		    DO TRcalc_Fecha
			RETURN(.f.)
		ENDIF
	ENDIF
	*------------------------------------------------------------*
	SELECT &ALS_empresa
	SET ORDER TO tag empresa
	SEEK LNemp
	IF !FOUND()
	    DO TRcalc_Fecha
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	STORE 0 TO LNbsIss,LNvlrIss,LNbsIcms,LNvlrIcms,LNbsIsent,;
			LNbsSbBrt,LNbsSubs,LNbsOutr,LNbsIpi,LNvlrIpi,LNbsIsIpi
			
	STORE 0 TO LNissrtd
	
	*------------------------------------------------------------*
	*		TRIBUTOS INDEPENDENTES DA SITUACAO TRIBUTARIA
	*------------------------------------------------------------*
	*	Calculo envolvendo ISS
	*		-tp_mercad= 7 => SERVICO
	*------------------------------------------------------------*
	LNbsIss		=	0
	LNvlrIss	=	0
	IF LNtp_mercad = 7
		LNbsIss	 =	LNvlrvenda
		LNvlrIss =  ROUND(LNbsIss * ROUND(LNalq_iss  / 100,4),2)
	ENDIF
	
	*------------------------------------------------------------*
	*	Calculo envolvendo ISS RETIDO
	*------------------------------------------------------------*
	LNIssRtd	=	0
	IF PrmSbstISS = 1  && se = 1 segumento retem iss
		LNIssRtd = LNvlrIss
	ENDIF
	
	*------------------------------------------------------------*
	*	Calculo envolvendo IPI
	*		-Devolucao:		A base do IPI e o proprio vlrvenda
	*		-Outras   : 	O IPI ja esta embutido no valor de
	*				de venda. Por isso e necessario retira-lo
	*				para determinar a base Original
	*------------------------------------------------------------*
	LNbsIpi 	= 	0
	LNvlripi 	= 	0
	LNbsIsIp	=	LNvlrvenda
	IF LNalq_Ipi > 0
		DO CASE
			CASE &ALS_tipooper .ch_opera = "4" 	&& DEVOLUCAO
				LNbsIpi  = LNvlrvenda
			CASE &ALS_tipooper .ch_opera = "2" 	&& TRANSFERENCIA
				*----------------------------------------------------*
				*  CASO DAS IMPORTACOES INICIADAS EM 2006
				*----------------------------------------------------*
				LNbsIpi  = LNvlrvenda
			CASE &ALS_tipooper .ch_opera = "2" 	&& TRANSFERENCIA
				*----------------------------------------------------*
				*  CASO ANTIGO QDO AS IMPORTACOES FORAM TRATADAS
				* DE FORMA ERRADA
				*----------------------------------------------------*
				*    	Determina o Ultimo dia do mes Anterior para
				*   data de pesquisa E MES ANTERIOR P/ O REGISTRO DO
				*   SALDO
				*     MOTIVO : A base do ipi nas transferencias
				*			e a media do valor de venda nos meses
				*			anteriores
				*----------------------------------------------------*
				LDdtpesq   = LDdata - DAY(LDdata)
				SELE &ALS_SALDO
				SEEK STR(LNemp,3)+LSclasprd+;
							STR(YEAR(LDdata),4)+;
						 	 STR(MONTH(LDdata),2)
				*----------------------------------------------------*
				*    Caso nao seja possivel determinar a media
				*  sera considerado o custo medio ANTERIOR OU ATUAL
				*	(ULTIMO CASO)
				*----------------------------------------------------*
				DO CASE
					CASE FOUND() AND &ALS_saldo .sld_ante > 0
					   LNbsipi = &ALS_saldo .vlr_ante / &ALI_saldo .sld_ante
					CASE FOUND() AND &ALS_saldo .sld_atu  > 0
					   LNbsipi = &ALS_saldo .vlr_atu / &ALS_saldo .sld_atu
				ENDCASE					
				*----------------------------------------------------*
				DO WHILE LDdtpesq > {31.12.1994}
					SEEK STR(LNemp,3)+LSclasprd+;
							STR(YEAR(LDdtpesq),4)+;
						 	 STR(MONTH(LDdtpesq),2)
					IF !FOUND() OR &ALS_SALDO .qtd_venda = 0
	   					LDdtpesq   = GOMONTH(LDdtpesq,-1)
						LOOP
					ENDIF					
					LNbsipi = &ALS_SALDO .ven_enc / &ALS_SALDO .qtd_venda
					IF LDdata <= {24.06.1998}
						LNbsipi	= LNbsipi * 0.70
					ELSE
						LNbsipi	= LNbsipi * 0.90
					ENDIF						
					EXIT
				ENDDO			
				LNbsipi = LNbsipi * LNqtde
			OTHERWISE
				LNbsIpi  = ROUND(LNvlrvenda/(1+LNalq_ipi/100),2)
		ENDCASE
		LNvlripi 	= ROUND(LNbsIpi * ROUND(LNalq_ipi  / 100,4),2)
		LNbsIsIp	= 0
	ENDIF
	LNvlripi = TRcalc_Difer(LNvlripi,LNqtde,2)
	
	*------------------------------------------------------------*
	*		TRIBUTOS PELA SITUACAO TRIBUTARIA
	*------------------------------------------------------------*
	*  BASE DE INCIDENCIA DE TRIBUTOS
	*    - EM DEVOLUCOES O IPI COMPOE A BASE DE TRIBUTACAO
	*    - NAS OUTRAS OPERACOES O IPI E RETIRADO PARA COMPOR A
	*     BASE
	*------------------------------------------------------------*
	IF &ALS_tipooper .ch_opera $ "4/2" 	&& DEVOLUCAO/TRANSF
		LNbs_TRIBUTAR	= LNvlrvenda
	ELSE
		IF LDdata > {01.01.2000}
			*-----------------------------------------------------*
			&&    O IPI so passou a ser calculado nas saidas a partir
			&& de 01.01.2000 e mesmo assim conssideramos o ipi
			&& como sendo imbutido no valor particado
			&& por isso ele ‚ retirado para compor a tributacao
			&&    Uma checagem mais detalhada indicara uma diferenca
			&& nas notas anteriores a esta data pois o ipi foi calculado
			&& apos a emissÆo das notas(Contador PEDRO) e nao foi
			&& considerado para tributa‡Æo
			*----------------------------------------------------*
			LNbs_TRIBUTAR	= LNvlrvenda - LNvlrIpi
		ELSE
			LNbs_TRIBUTAR	= LNvlrvenda
		ENDIF
	ENDIF										
	*------------------------------------------------------------*
	*------>>> BASE BRUTA DE ICMS SEM CONSIDERAR REDUCOES
	DO CASE
		CASE LScst $ "0/1/2/7"		&& ENVOLVE MERCAD TRIBUTADA NORMAL
			LNbsbrIcms	= LNbs_TRIBUTAR
        OTHERWISE
   			LNbsbrIcms	= 0
	ENDCASE

	*------>>> BASE LIQUIDA  DE ICMS CONSIDERANDO  REDUCOES----*
    *    As reducoes podem ser em funcao da operacao = "0/1"
    *  ou em funcao da empresa CST = "2/7"
	*  OBS: As reducoes em funcao da operacao foram introduzidas
	*     apos mudancas no recolhimento de PIS/COFINS em que as NF
	*  da firestone vinham com reducao na base do icms e que em caso
	*  de devolucoes deveriam operar com reducao da base.....
    *----------------------------------------------------------*
	DO CASE
		CASE LScst $ "0/1"		&& ENVOLVE MERCAD TRIBUTADA NORMAL
			LNbsIcms	= LNbsbrIcms - ;
		             ROUND(LNbsbrIcms * LNalq_rdu/100,2)
		CASE LScst $ "2/7"		&& REDUZIR BASE DO ICMS
			LNbsIcms	= LNbsbrIcms - ;
		             ROUND(LNbsbrIcms * LNalq_rdu/100,2)
	ENDCASE

	*------------------------------------------------------------*
	*----------------->>> BASE SUBSTITUICAO <<<------------------*
	*------------------------------------------------------------*



	IF LScst $ "1/3/7/"		
		LNbsSbBrt	= LNbs_TRIBUTAR + LNvlrIpi
		*----> INTERESTADUAL  e CONSUMIDOR INSCRITO
		
		DO CASE



			CASE LSufdesti $ "MT" AND &ALS_tipooper .ch_contr = "4"			
				LNbssubs = LNbs_TRIBUTAR + LNvlrIpi
		
			CASE LSufdesti $ "MT" AND &ALS_tipooper .ch_OPERA = "2"			

				LNbssubs = LNbs_TRIBUTAR + LNvlrIpi




			CASE &ALS_tipooper .ch_desti = "2" ;
			     AND &ALS_tipooper .ch_contr = "2";
			     AND LDdata < CTOD("01.10.2011")
                *--------------------------------------------*
                * regra anterior ao protocolo 21/2011 *
                *--------------------------------------------*
	
				LNbssubs = LNbs_TRIBUTAR + LNvlrIpi


			CASE &ALS_tipooper .ch_desti = "2" ;
			     AND &ALS_tipooper .ch_contr = "2";
			     AND LDdata > CTOD("31.03.2015")


                *--------------------------------------------*
                * revogada por liminar (Oliveira)
                * regra anterior ao protocolo 21/2011 *
                *--------------------------------------------*
	
				LNbssubs = LNbs_TRIBUTAR + LNvlrIpi


			CASE &ALS_tipooper .ch_desti = "2"  ;
			     AND ;
			     (     &ALS_tipooper .ch_contr = "1";
			        OR &ALS_tipooper .ch_contr = "3";
			     ) ;
			     AND LDdata > CTOD("31.03.2015") ;
   			     AND LDdata < CTOD("01.01.2016")      && REVOGADA P/ 2016
			
			
				 *------------------------------------------------------*
	             * PROTOCOLO INTERESTADUAL 21/2011 CONFAZ EM VIGOR DESDE
    	         * junho/2011 equipara
    	         *  (1) - CONSUMIDOR ESTADUAL
    	         *  (2) - CONSUMIDOR INSCRITO
    	         *  (3) - CONSUMIDOR NAO INSCRITO
	             *  nas operacoes interestaduais
				 *-----------------------------------------------------*

				LNbssubs = 0



			CASE &ALS_tipooper .ch_desti = "2"  ;
			     AND ;
			     (     &ALS_tipooper .ch_contr = "1";
			        OR &ALS_tipooper .ch_contr = "2";
			        OR &ALS_tipooper .ch_contr = "3";
			     ) ;
			     AND (LDdata <= CTOD("31.03.2015") OR ;
	   			      LDdata >= CTOD("01.01.2016"))

			
			
				 *------------------------------------------------------*
	             * PROTOCOLO INTERESTADUAL 21/2011 CONFAZ EM VIGOR DESDE
    	         * junho/2011 equipara
    	         *  (1) - CONSUMIDOR ESTADUAL
    	         *  (2) - CONSUMIDOR INSCRITO
    	         *  (3) - CONSUMIDOR NAO INSCRITO
	             *  nas operacoes interestaduais
				 *-----------------------------------------------------*

				LNbssubs = LNbs_TRIBUTAR + LNvlrIpi







			CASE LScst $ "1/7" AND LDdata < CTOD("01.01.97")
				LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi) *  1.45)

			CASE LScst $ "3" AND &ALS_tipooper .ch_desti = "1"
				LNbssubs = ((LNbs_TRIBUTAR+LNvlrIpi)   *  1.225)
				*  qualquer situacao de retencao interna sera
				*	 entendida como reem bolso 1.225
				*	 (DEFINIDO COM PEDRO EM 17/04/97)

			CASE LScst $ "3" AND LDdata < CTOD("01.01.97")
				LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi) *  1.225)

			CASE &ALS_tipooper .ch_opera = "4"

				DO CASE
	               CASE LEFT(LSclasprd,2) $ "00/01"  ;
	                    OR LEFT(LSclasprd,5) $ "04042"
						*----------------------------------------------*
    	            	* REGRA TRATAR REDUCAO PIS COFIS PARA PNEUS
    	            	* CAMARAS E PROTETORES
						* Oliveira 21/09/2004 => Em fun‡Æo da altera‡Æo
						* do convenio 10/03 a redu‡Æo (PIS/COFINS) passa
						* a insidir sobre a base de substitui‡Æo
						*----------------------------------------------*
						IF LDdata < {05.03.2007}
						    LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
						    LNbssubs	= LNbssubs - ;
					             ROUND(LNbssubs * LNalq_rdu/100,2)
						ELSE
					    	LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
					    	LNbssubs	= LNbssubs - ;
			            	 ROUND((LNbs_TRIBUTAR*LNiva) * LNalq_rdu/100,2)

						ENDIF


				   OTHERWISE
						*----------------------------------------------*
    	        	    * REGRA TRATAR REUCAO ICMS PA PECAS
						* Oliveira 21/09/2004 => Em fun‡Æo da altera‡Æo
						* do convenio 10/03 a redu‡Æo (PIS/COFINS) passa
						* a insidir sobre a base de substitui‡Æo
						*----------------------------------------------*

				    	LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
					ENDCASE

			OTHERWISE
			    LNbssubs = ((LNbs_TRIBUTAR + LNvlrIpi ) * LNiva)
		ENDCASE
	ENDIF
	*------------------------------------------------------------*
	*--------------------->>> OUTRAS <<<-------------------------*
	*------------------------------------------------------------*
	DO CASE
		CASE LScst = "0"		&& COM REDUCAO BASE CALCULO ICMS
		                        && atribuido apos mudanca pis cofins
			LNbsisent 	= LNbsbrIcms - LNbsicms
		CASE LScst = "1"		&& COM REDUCAO BASE CALCULO ICMS
		                        && BASICAMENT EM DEVOLUCOE
		                        && TRIBUTADA E COM SUBSTITUICAO
			LNbsisent 	= LNbsbrIcms - LNbsicms
		CASE LScst = "2"		&& COM REDUCAO BASE CALCULO ICMS
			LNbsisent 	= LNbs_TRIBUTAR - LNbsicms
		CASE LScst = "3"		&& ISENT. OU N. TRIB. E COM SUBST. TRIB
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "4"		&& ISENT. OU N. TRIB. E COM SUBST. TRIB
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "5"		&& COM SUSPENSAO OU DIFERIMENTO
			LNbsoutr 	= LNbs_TRIBUTAR
		CASE LScst = "6"		&& ICMS CABRADO ANTES POR SUBSTITUICAO
			LNbsisent 	= LNbs_TRIBUTAR
		CASE LScst = "7"		&& COM REDUCAO BASE CALCULO ICMS POR SUBS
			LNbsisent 	= LNbs_TRIBUTAR - LNbsicms
	ENDCASE
	*---------------------- CALCULANDO VALORES ------------------*
	LNvlricms 	= LNbsicms * LNalq_icms / 100

*-----------------------------------------------------------------------
* FUNCIONOU ATE 03/2016 SUBSTITUIDA PELA ROTINA LOGO ABAIXO
*-----------------------------------------------------------------------
*	IF LNbssubs > 0
*		IF LSufdesti $ "MG/SP/RJ" AND &ALS_tipooper .ch_opera <> "4"			
*			*------ ALIQUOTA INTERNA 18 % ----*
*			LNicmSub = ;
*			 ((LNbssubs) * 0.18) - (LNbsIcms * LNalq_icms / 100)
*		ELSE
*       	LNicmSub = ;
*       	 ((LNbssubs) * 0.17) - (LNbsIcms * LNalq_icms / 100)
*		ENDIF
*	ENDIF
*-----------------------------------------------------------------


	=W_DEFPROC("tributar.spr")
	LNicmsOrigem    =	TRAlqIcmInUF(LSufdesti) && Aliquota Interna

	IF LNbssubs > 0
		*------ ALIQUOTA INTERNA ?? % ----*
		DO CASE
			CASE LSufdesti $ "MT" AND &ALS_tipooper .ch_contr = "4"			
					LNicmSub = ;
					 ((LNbssubs)*15 / 100)
					
		
			CASE LSufdesti $ "MT" AND &ALS_tipooper .ch_OPERA = "2"			
					LNicmSub = ;
					 ((LNbssubs)*15 / 100)
			OTHERWISE		
				LNicmSub = ;
					 ((LNbssubs)*LNicmsOrigem / 100) ;
					 - (LNbsIcms * LNalq_icms / 100)
		ENDCASE
	ENDIF


	*------------------------------------------------------------*
    DO TRcalc_Fecha

	*------------------------------------------------------------*

	vTParam[01] = LNbsIpi
	vTParam[02] = LNvlrIpi
	vTParam[03] = LNbsIsIpi
	vTParam[04] = LNbsbrIcms
    vTParam[06] = LNissrtd


	*------------------------------------------------------------*
RETURN(.T.)


PROCEDURE TRcalc_Fecha
    =up_fecha("&ALS_Empresa")
    =up_fecha("&ALS_Grupo")
   	=up_fecha("&ALS_Saldo")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKIT           CSTENT VALID                       º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   17  º
*       º Variable:            CSTENT                             º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      14                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkit     &&  CSTENT VALID
#REGION 1
RETURN

PROCEDURE TXMP


           * A ROTINA A SER DESENVOLVIDA DEVE SUBSTITUIR TRECHO DE
           * PROGRAMA ESCRITO EM SCT0310 QUE GERA O SINTEGRA E CORRIGE
           * O CST


			*---------------------------------------------------*			
			*  ATENCAO : Definir Regra para Informar corretamente
			*           CST em NOTAS DE ENTRADA
			*---------------------------------------------------*			

			IF itemmov.cst <> " "
				LScst   = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
					  LIVROENT.cst+ "0"
			ELSE
				DO CASE
					CASE LIVROENT.tp_mercad = 1 ;
					    and LIVROENT.base_calc > 0 ;
					    and LIVROENT.base_calc <> LIVROENT.vlrvenda
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
					CASE LIVROENT.tp_mercad = 1 and LIVROENT.base_calc > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "0"  + "0"
					CASE LIVROENT.tp_mercad = 1 and LIVROENT.base_calc = 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
					CASE   LIVROENT.tp_mercad = 2 ;
					   and LIVROENT.icms_subs > 0 ;
					   and LIVROENT.base_calc > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "1"  + "0"
					CASE LIVROENT.tp_mercad = 2 and LIVROENT.icms_subs > 0
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "6"  + "0"
					CASE LEFT(LIVROENT.codigo,5) = "99999"
					  	LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "9"  + "0"
					OTHERWISE
						LScst = CHRTRAN(STR(LIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
				ENDCASE
			ENDIF
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKKI           TRRtdoSaida VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   18  º
*       º Variable:            TRRtdoSaida                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      15                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkki     &&  TRRtdoSaida VALID
#REGION 1
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser 
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido ‚ calculado conforme a f¢rmula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda nÆo trata de forma parametrizada
	*					 a aliquota interna e at‚ que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa‡Æo atual
	*					 em termos de Pneulƒndia
	*------------------------------------------------------------------*						

FUNCTION TRRtdoSaida
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNicms,LNbase_Icms,LNbase_Rtdo

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNicmsOrigem       && Aliquota Externa no Estado Origem
	PRIVATE LNicmsDestino      && Aliquota Interna no Estado Destino
 	
    LSAlias      = Alias()

	LNicms = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) &&
	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmInUF(LSufDestino) &&

	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNbase_Rtdo = TREbsRtdoCIVA(LSproduto,;
							LSufOrigem,;
							LSufDestino,;
							LNvlrMercadoria,;
							LNvlrIPI,;
							LNcdg_Forn)


	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2

  		   LNicms =  (LNbase_Rtdo * LNicmsDestino/100)-;
   	    	         (LNbase_Icms  * LNicmsOrigem/100)

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNicms)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKKQ           TRRtdoEntrada VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   19  º
*       º Variable:            TRRtdoEntrada                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      16                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkkq     &&  TRRtdoEntrada VALID
#REGION 1
RETURN

FUNCTION TRRtdoEntrada
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn

	=W_DEFPROC("rotinas.spr")
				
	PRIVATE LSalias,LNicms,LNbase_Icms,LNbase_Rtdo

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNicmsOrigem       && Aliquota Externa no Estado Origem
	PRIVATE LNicmsDestino      && Aliquota Interna no Estado Destino
	PRIVATE LNiva			   &&
 	
	LNicms = 0.00
    LSAlias      = Alias()

	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) &&
	=W_DEFPROC("tributar.spr")
	LNicmsDestino	=	TRAlqIcmInUF(LSufDestino) &&
	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)
	=W_DEFPROC("tributar.spr")
	LNbase_Rtdo = TREbsRtdoCIVA(LSproduto,;
							LSufOrigem,;
							LSufDestino,;
							LNvlrMercadoria,;
							LNvlrIPI,;
							LNcdg_Forn)



	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*


	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 1 and LNRgTrbDestino = 2

  		   LNicms =  (LNbase_Rtdo * LNicmsDestino/100)-;
   	    	         (LNbase_Icms  * LNicmsOrigem/100)


	    ENDIF
	ENDIF


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNicms)

*--------------   descartado em 6/10/2003
*  		   LNicms =  ((LNvlrMercadoria + LNvlrIPI);
*	   			 * LNiva * LNicmsDestino/100)-;
*	             (LNbase_Icms  * LNicmsOrigem/100)
*----------------

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKKW           TRicmNormal VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   20  º
*       º Variable:            TRicmNormal                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      17                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkkw     &&  TRicmNormal VALID
#REGION 1
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION UITicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula o ICMS NORMAL no Item de Entrada :
	*				-Sera Calculado para TP_MERCAD = 1
	*					(Mercadoria Tributada)
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*-------------------------------------------------------------------*						

FUNCTION TRicmNormal
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
				
	=W_DEFPROC("rotinas.spr")


	PRIVATE LSalias,LNicms,LNbase_Icms
	PRIVATE LNicmsOrigem
	PRIVATE LNRgTrbOrigem
	PRIVATE LNRgTrbDestino
	PRIVATE LNRgFiscFornecedor && 0-Normal 1-Simples

	LNicms = 0.00
    LSAlias      = Alias()

	
	*--------------------------------------------------------*
	=W_DEFPROC("forneced.spr")
	LNRgFiscFornecedor = FRrgm_Fisc(LNcdg_Forn)

    IF 	LSufOrigem = LSufDestino
		=W_DEFPROC("tributar.spr")
		LNicmsOrigem    =	TRAlqIcmInUF(LSufOrigem) && Aliquota Interna
	ELSE
		=W_DEFPROC("tributar.spr")
		LNicmsOrigem    =	TRAlqIcmOuUF(LSufOrigem) && Aliquota Externa
	ENDIF


	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	=W_DEFPROC("tributar.spr")
	LNbase_Icms = TREnbsicmNormal(LSproduto,;
								LNvlrMercadoria,;
								LNvlrIPI,;
								LNcdg_Forn)


	**** IF LNRgTrbOrigem = 1  AND LNRgTrbDestino = 1

	IF LNRgTrbDestino = 1 AND LNRgFiscFornecedor = 0
	    LNicms =  LNbase_Icms * LNicmsOrigem/100
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNicms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKKX           TREnbsicmNormal VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   21  º
*       º Variable:            TREnbsicmNormal                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      18                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkkx     &&  TREnbsicmNormal VALID
#REGION 1
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION Ubsicmsnormal_item
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO :  -Calcula a Base ICMS NORMAL no Item de Entrada :
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*-------------------------------------------------------------------*						

FUNCTION TREnbsicmNormal
	PARAMETERS 	LSproduto,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
				
	=W_DEFPROC("rotinas.spr")


	PRIVATE LSalias,LNbase_Icms

    LSAlias      = Alias()

	LNbase_Icms = 0.00

	*--------------------------------------------------------*

    IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 	LNbase_Icms = LNvlrMercadoria - (LNvlrMercadoria * (4.9/100))
	ELSE
	 	LNbase_Icms = LNvlrMercadoria
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNbase_Icms)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKKY           TREbsRtdoCIVA VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   22  º
*       º Variable:            TREbsRtdoCIVA                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      19                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkky     &&  TREbsRtdoCIVA VALID
#REGION 1
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser 
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido ‚ calculado conforme a f¢rmula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda nÆo trata de forma parametrizada
	*					 a aliquota interna e at‚ que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa‡Æo atual
	*					 em termos de Pneulƒndia
	*------------------------------------------------------------------*						

FUNCTION TREbsRtdoCIVA
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNbase_Retido

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
	PRIVATE LNiva			   &&
 	
    LSAlias      = Alias()

	LNbase_Retido = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")

	LNiva = TRGet_IVA( LSufOrigem,;
			            LSproduto,;
			            LSUFdestino ,;
			            wp_dtoper )

	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2
  	
  		  LNbase_Retido =  (LNvlrMercadoria + LNvlrIPI)

		  IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (4.9/100))
		  ENDIF

		  IF LNcdg_Forn = 2
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (5.19/100))
		  ENDIF

          LNbase_Retido = LNbase_Retido *  LNiva

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNbase_Retido)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKKZ           TREbsRtdoSIVA VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   23  º
*       º Variable:            TREbsRtdoSIVA                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      20                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkkz     &&  TREbsRtdoSIVA VALID
#REGION 1
RETURN

	*-------------------------------------------------------------------*						
    *  FUNCTION TRRtdoSaida
	*-------------------------------------------------------------------*						
	*  DESCRI€ÇO : 	Calcula o ICMS RETIDO no Item de Entrada que Ser 
	*				Usado para Resumo de Entradas
	*-------------------------------------------------------------------*						
	*  PARAMETROS
	*		LNicmsInterno	- Aliquota ICMS UF da Empresa Entrada NF
	*		LNtp_mercadoria	- Tipo Tributacao do Produto
	*		LNvlrMercadoria	- Valor da mercadoria expresso na nota fiscal
	*		LNvlrIPI		- Valor do ipi expresso na nota fiscal
	*		LNAliq_ICMS		- Aliquota Destacada na NF ENTRADA
	*		LNiva			- indice de IVA associado ao produto e , neste
	*						 caso,  gravado junto ao item
	*-------------------------------------------------------------------*						
	*	OUTROS :
	*  		O ICMS retido ‚ calculado conforme a f¢rmula :
	*   	LNicms =  ((vlrvenda + vlrIPI) * iva * icmsinterno/100)-;
	*		             (vlrvenda  * aliq_icms/100)
	*    OBS:
	*     	LNicms     : Resultado com o valor ICMS
	*		icmsinterno: aliquota de icms interna ao estado ediquirinte
	*					obs:
	*					  O sistema ainda nÆo trata de forma parametrizada
	*					 a aliquota interna e at‚ que se implemente usaremos
	*					 a aliquota de 17% que atende nossa situa‡Æo atual
	*					 em termos de Pneulƒndia
	*------------------------------------------------------------------*						

FUNCTION TREbsRtdoSIVA
	PARAMETERS 	LSproduto,;
				LSufOrigem,;
				LSufDestino,;
				LNvlrMercadoria,;
				LNvlrIPI,;
				LNcdg_Forn
			
	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias,LNbase_Retido

	PRIVATE LNRgTrbOrigem      && Regime Tributario na Origem
	PRIVATE LNRgTrbDestino     && Regime Tributario no Destino
 	
    LSAlias      = Alias()

	LNbase_Retido = 0.00
	*---------------------------------------------------------*
	=W_DEFPROC("tributar.spr")
	LNRgTrbOrigem = TRRegTrbMercadoria(LSufOrigem,LSproduto)
	=W_DEFPROC("tributar.spr")
	LNRgTrbDestino = TRRegTrbMercadoria(LSufDestino,LSproduto)

	*---------------------------------------------------------*
	* Mercadoria Substituicao em Operacao Interestadual
	*---------------------------------------------------------*

	IF LSufOrigem <> LSufDestino  && Interestadual

		IF LNRgTrbOrigem = 2 and LNRgTrbDestino = 2
  	
  		  LNbase_Retido =  (LNvlrMercadoria + LNvlrIPI)

		  IF LNcdg_Forn = 1 OR LNcdg_Forn = 1130
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (4.9/100))
		  ENDIF

		  IF LNcdg_Forn = 2
	 		LNbase_Retido = LNbase_Retido - (LNbase_Retido * (5.19/100))
		  ENDIF

	    ENDIF
	ENDIF

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
RETURN(LNbase_Retido)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKL0           TRcalc_Difer VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   28  º
*       º Variable:            TRcalc_Difer                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      21                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkl0     &&  TRcalc_Difer VALID
#REGION 1
RETURN

FUNCTION TRcalc_Difer
	PARAMETERS LNValorTotal,LNqtde,Lncasas
	*------------------------------------------------------------*
	PRIVATE LNajuste
	LNajuste = ROUND(LNValorTotal/LNqtde,Lncasas)*LNqtde
RETURN(LNajuste)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKL1           TRVincTipo VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   30  º
*       º Variable:            TRVincTipo                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      22                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _4l10ytkl1     &&  TRVincTipo VALID
#REGION 1
RETURN

FUNCTION TRVincTipo
	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_TipoOper,ALS_TipoOper
    PRIVATE ARQ_ClasFisc,ALS_ClasFisc
	LSalias = ALIAS()

    ARQ_TipoOper     = NetArqAgain("TIPOOPER")
    ALS_TipoOper     = Alias()

    ARQ_ClasFisc     = NetArqAgain("CLASFISC")
    ALS_ClasFisc     = Alias()

	IF ( ARQ_TipoOper + ARQ_ClasFisc) > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&Als_TipoOper")
        =up_fecha("&Als_ClasFisc")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = " "
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*


	*-----------------------------------------------*
	*CRIAR CODIGO DA CLASSIFICACAO <CODCLASSIF>
	*-----------------------------------------------*



	SELE &ALS_ClasFisc
	SET ORDER TO TAG CFOP
	GO TOP

	CTRCFOP = 1
	QBRCFOP = CFOP
	DO WHILE !EOF()
		m.CODCLASSIF = INT(VAL(CHRTRAN(CFOP,".","")))*10+CTRCFOP
		=RLOCK()
		REPLACE CODCLASSIF WITH m.CODCLASSIF
		QBRCFOP = CFOP
		SKIP

		IF QBRCFOP = CFOP
			CTRCFOP = CTRCFOP + 1
		ELSE
			CTRCFOP = 1
		ENDIF
	
	ENDDO



	*-----------------------------------------------*
	*ATRIBUIR CODIGO DA CLASSIFICACAO A TABELA TIPOOPER (FOX)
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFO


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODOPERA   WITH &ALS_ClasFisc .CODOPERA
		REPLACE &Als_TipoOper .CODCLASSIF WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO
		


	*-----------------------------------------------*
	*  OPERACOE VICULADAS A CFO SUBSTITUICAO
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFOSUBS


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODCLSSUBS WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO
		

	*-----------------------------------------------*
	*  OPERACOE VICULADAS A CFO SERVICO
	*-----------------------------------------------*

	SELE &ALS_TipoOper
	SET ORDER TO TAG CFOSERVICO


	SELE &ALS_ClasFisc
	GO TOP
	SET RELATION TO CFOP INTO TP
	SET SKIP TO TP
	DO WHILE !EOF()
		=RLOCK()
		REPLACE &Als_TipoOper .CODCLSERVC WITH &ALS_ClasFisc .CODCLASSIF
		SKIP
	ENDDO


	*-----------------------------------------------*
	*  ATRIBUICAO CST
	*-----------------------------------------------*





	*------------------------------------------------------------*
    =up_fecha("&Als_TipoOper")
    =up_fecha("&Als_ClasFisc")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)

*BROWS FIELDS CL.CODOPERA,CL.CODCLASSIF,CL.CFOP,;
*         TP.CFO,TP.CFOSUBS,TP.CFOSERVICO,TP.TIPO,TP.CODOPERA,;
*         TP.CODCLASSIF,TP.CODCLSSUBS,TP.CODCLSERVC


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKMA           TRGet_IVA VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   31  º
*       º Variable:            TRGet_IVA                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      23                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkma     &&  TRGet_IVA VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TRGet_IVA
PARAMETERS 	PrmUFOrigem,;
			PrmProduto, ;
			PrmUFDestino,;
			PrmData,;
    		PrmPrdtOrigem,;
    		PrmAlsNF,;
    		PrmAlsIT
    		
    		


	=W_DEFPROC("rotinas.spr")


	IF TYPE("PrmPrdtOrigem") <> "N"
	   PrmPrdtOrigem  = 0   && ASSUME NACIONAL
	ENDIF


	IF TYPE("PrmUFDestino") <> "C"
	    DO OBJ_ALER.SPR WITH ;
		   "ERRO -> CHAMADA DA FUNCAO TRget_IVA NAO FOI ADAPTADA ";
		         +CHR(13)+CHR(13)+;
			   "   <ENTER>  "
				SET STEP ON
	ENDIF

    PRIVATE LNiva
    PRIVATE LSalias
	PRIVATE LSuf

	PRIVATE LNalq_externaUForg, LNalq_internaUFDst


    PRIVATE ALS_Grupo
    PRIVATE ARQ_tab_iva,ALS_tab_iva

    LSAlias      = Alias()


	STORE 0 TO ARQ_Grupo, ARQ_tab_iva
	*--------------------------------------------------------

	=W_DEFPROC("GRUPO.SPR")
    ALS_Grupo    = GRGetAlias()

	*--------------------------------------------------------


	IF TYPE("TRtab_IvaALIAS") = "U" OR !USED(TRtab_IvaALIAS)
		PUBLIC TRtab_IvaALIAS
	    ARQ_tab_iva     = NetArqAgain("TAB_IVA")
	    TRtab_IvaALIAS  = Alias()
	ENDIF

    ALS_tab_iva  = TRtab_IvaALIAS

    LNiva = 0
	*--------------------------------------------------------*

	
	LSuf = PrmUFDestino

    SELE &ALS_Grupo
  	SET ORDER TO TAG codigo
    SEEK PrmProduto
	IF !FOUND()
        DO TRFcht_IVAFecha
        RETURN(LNiva)
	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para Produto  especifico
	*------------------------------------------------------------*

	SELE &ALS_tab_iva
	SET ORDER TO TAG subgrupo
	SEEK LSuf + LEFT( &Als_Grupo .classifica,5)+PrmProduto
    IF !FOUND()
		SEEK "BR"+ LEFT( &Als_Grupo .classifica,5)+PrmProduto
	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para SubGrupo do Produto
	*------------------------------------------------------------*

	IF FOUND()
	    LNiva		= 	&Als_tab_iva .iva
	ELSE
		SELE &ALS_tab_iva
		SEEK LSuf + LEFT( &Als_Grupo .classifica,5)+""
    	IF !FOUND()
			SEEK "BR" + LEFT( &Als_Grupo .classifica,5)+""
		ENDIF

	ENDIF


	*------------------------------------------------------------*
    *      busca IVA para SubGrupo do Produto
	*------------------------------------------------------------*

	IF FOUND()
	    LNiva		= 	&Als_tab_iva .iva
	ELSE
		SELE &ALS_tab_iva
		SEEK LSuf + LEFT( &Als_Grupo .classifica,2)+SPACE(3)
    	IF !FOUND()
			SEEK "BR" + LEFT( &Als_Grupo .classifica,2)+SPACE(3)
		ENDIF

		IF FOUND()
		    LNiva		= 	&Als_tab_iva .iva
		ENDIF
	ENDIF

    *-------------------------------------------------------------*
    * Regras para definicao de IVA Ajustada
	*-------------------------------------------------------------*
	*--ANTIGA---------------------------------------------------*
	*		IF (PrmUFOrigem $ "MT/DF" OR PrmUFDestino  $ "MT/DF");
	*		    	and PrmUFOrigem <> PrmUFDestino ;
	*		    	and PrmData >= {01.06.2008} ;
	*		    	and PrmData <  {01.09.2012}
	*
	*            LNiva = TR_TOIVAAjustada(LNiva)
	*       ENDIF
	*-----------------------------------------------------------*

    LNiva =  TR_InternaIVAAjustada(LNiva)

    LNiva = TR_ICM49IVAjustada(LNiva)

    LNiva = TR_ICM62IVAjustada(LNiva)

    LNiva = TR_ICM92IVAjustada(LNiva)


    LNiva = TR_ICM73IVAjustada(LNiva)


	*------------------------------------------------------------*

    DO TRFcht_IVAFecha

RETURN(LNiva)

PROCEDURE TRFcht_IVAFecha
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKMB           TRCFOPServico VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   33  º
*       º Variable:            TRCFOPServico                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      24                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkmb     &&  TRCFOPServico VALID
#REGION 1
RETURN

*-------------------------------------------------------*
*-----> DEFINECFOP PARA SERVICO
*-------------------------------------------------------*

FUNCTION TRCFOPServico
PARAMETERS PrmUFOrgn, ;
           PrmMuniOrgn,;
           PrmUFDstn,;
           PrmMuniDstn,;
           PrmTp_mercad,;
           PrmOperacao

PRIVATE LScfps

	DO CASE
		CASE PrmTp_mercad <> 7   && nao e servico
			LScfps  = "0000"		
		CASE PrmUFOrgn = PrmUFDstn
			LScfps  = "5933"		
		CASE PrmUFOrgn <> PrmUFDstn
			LScfps  = "6933"		
		OTHERWISE
			LScfps  = "0000"		


    *-------------------------------------------------------------*
    *----> lembrar porque foram colocador os codigos abaixo
    *--> este codegos estava dando erro na NFr
    *-------------------------------------------------------------*
    *
  	*	CASE PrmUFOrgn = PrmUFDstn AND PrmMuniOrgn = PrmMuniDstn
	*		LScfps  = "9101"		
	*	CASE PrmUFOrgn = PrmUFDstn AND PrmMuniOrgn <> PrmMuniDstn
	*		LScfps  = "9102"		
	*	CASE PrmUFOrgn <> PrmUFDstn
	*		LScfps  = "9103"		
	*	OTHERWISE
	*		LScfps  = "0000"		
	ENDCASE
RETURN(LScfps)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKMC           TRCST_IPI VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   34  º
*       º Variable:            TRCST_IPI                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      25                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkmc     &&  TRCST_IPI VALID
#REGION 1
RETURN

FUNCTION TRCST_IPI
PARAMETERS PrmVlrIPI,PrmOperacao
	PRIVATE LScstIPI

*---------------------------------------------------------*
* ROTINA ERRADA ATE SET/11
*---------------------------------------------------------*
*	DO CASE
*		CASE PrmOperacao = "SAIDA" AND PrmVlrIPI > 0
*			LScstIPI  = "50"		
*		CASE PrmOperacao = "SAIDA" AND PrmVlrIPI = 0
*			LScstIPI  = "53"		
*		CASE PrmOperacao = "ENTRADA" AND PrmVlrIPI > 0
*			LScstIPI  = "50"		
*		CASE PrmOperacao = "ENTRADA" AND PrmVlrIPI = 0
*			LScstIPI  = "53"		
*		OTHERWISE
*			LScstIPI  = "53"		
*	ENDCASE
*---------------------------------------------------------*


	DO CASE
		CASE PrmOperacao = "SAIDA"
	***		LScstIPI  = "99"		
			LScstIPI  = "53"		
		OTHERWISE
	***		LScstIPI  = "49"		
			LScstIPI  = "03"		
	ENDCASE
	
RETURN(LScstIPI)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKMD           TRCST_ISS VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   35  º
*       º Variable:            TRCST_ISS                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      26                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkmd     &&  TRCST_ISS VALID
#REGION 1
RETURN

FUNCTION TRCST_ISS
PARAMETERS PrmVlrISS,PrmOperacao
PRIVATE LScstISS

	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlrISS > 0   &&  servico
			LScstISS  = "00"		
		CASE PrmOperacao = "SAIDA" AND PrmVlrISS = 0   && nao e servico
			LScstISS  = "07"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlrISS > 0   &&  servico
			LScstISS  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlrISS = 0   && nao e servico
			LScstISS  = "07"		
		OTHERWISE
			LScstISS  = "07"		
	ENDCASE
RETURN(LScstISS)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKME           TRGenero VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   36  º
*       º Variable:            TRGenero                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      27                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkme     &&  TRGenero VALID
#REGION 1
RETURN

FUNCTION TRGenero
PARAMETERS PrmTp_mercad,PrmClassifica,PrmOperacao
PRIVATE LSgenero

	DO CASE
		CASE PrmTp_mercad = 7
			LSgenero  = "00"		
		CASE LefT(Prmclassifica,2) $ "00/01"
			LSgenero  = "40"		
		OTHERWISE
			LSgenero  = "87"		
	ENDCASE
RETURN(LSgenero)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKMF           TRcst_Icms VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   37  º
*       º Variable:            TRcst_Icms                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      28                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _4l10ytkmf     &&  TRcst_Icms VALID
#REGION 1
RETURN

FUNCTION TRcst_Icms
	PARAMETERS Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto,PrmCst


	PRIVATE Lcst
	

	=W_DEFPROC("GRUPO.SPR")
	LSCst =  GRGetOrigem(PrmProduto)

	LSCst =  STR( LSCst,1)
	
	
	LSCst =  LScst + ;
			 TRdefcst(Prmtab_cst,PrmTipo,Prmtp_mercad,PrmProduto,PrmCst) + ;
			 "0"
	LSCst = CHRTRAN(LSCst," ","0")

RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKNO           TRCST_PIS VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   38  º
*       º Variable:            TRCST_PIS                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      29                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkno     &&  TRCST_PIS VALID
#REGION 1
RETURN

FUNCTION TRCST_PIS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "07"		
	ENDCASE
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKNU           TRCST_COFINS VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   39  º
*       º Variable:            TRCST_COFINS                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      30                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytknu     &&  TRCST_COFINS VALID
#REGION 1
RETURN

FUNCTION TRCST_COFINS
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "01"	   && ANTES "00"	
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "04"      && ANTES "00"
	ENDCASE
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKO0           TRCST_IR VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   40  º
*       º Variable:            TRCST_IR                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      31                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytko0     &&  TRCST_IR VALID
#REGION 1
RETURN

FUNCTION TRCST_IR
PARAMETERS PrmVlr,PrmOperacao
PRIVATE LScst

	*----------------------------------------------------------*
	*-----> O CODIGO ABAIXO E SOMENTE UM EXEMPLO NAO FUNCIONAL
	*        DESENVOLVER A REGRA
	*----------------------------------------------------------*
	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlr> 0
			LScst  = "00"		
		CASE PrmOperacao = "ENTRADA" AND PrmVlr> 0
			LScst  = "00"		
		OTHERWISE
			LScst  = "07"		
	ENDCASE
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKO1           TRDef_RgTrbMercad VALID            º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   42  º
*       º Variable:            TRDef_RgTrbMercad                  º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      32                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytko1     &&  TRDef_RgTrbMercad VALID
#REGION 1
RETURN

FUNCTION TRDef_RgTrbMercad
	PARAMETER PrmUF,PrmProduto,PrmFormaRetorno
	
	
	
	*-----------------------------------------------------------------*	
	*--> PrmFormaRetorno = 'RETORNAR STRING'
	*   RETORNAR EM FORMATO STRIG (USADO EM DOC FISCAL - EFD E NFe )
	*-----------------------------------------------------------------*	
	




	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE	LSClassifica
	PRIVATE	LNtp_mercad
	LNtp_mercad	= 99999   && INVALIDO
	
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*--------------------------------------------------------

	=W_DEFPROC("GRUPO.spr")
	LSClassifica=GRGetFieldValue(PrmProduto,"CLASSIFICA")


	=W_DEFPROC("GRFISCAL.spr")
	LNtp_mercad	= GFGetTp_Mercadoria(PrmUF, LSClassifica)



*	*--------------------------------------------------------------------*
*	* Rotina estava perdida  em TRIBUTAR TRpct_trib
*	* transcrevi em 06/09/2012 e precisa de uma reavaliacao
*	* para decidir se continua
*	*--------------------------------------------------------------------*
*	*----------------------------------------------------------------*
*	*		Identificar mercadorias em regime de substituicao ESTADUAL
*	*	em caso de operacao ITERESTADUAIS com consumidor INSCRITO(2)/
*	*	REVENDA(4) ou DEVOLUCOES passa mercadoria para regime tributado
*	*----------------------------------------------------------------*
*
*	IF LNtp_mercad = 2	AND &Als_tipooper .ch_desti = "2"
*		IF     left(LSClassifica,5) > "02000" ;
*		   AND left(LSClassifica,5) < "99999" ;
*		   AND left(LSClassifica,5) <> "04042"
*			DO CASE
*				*----------------------------------------------------*
*				* TODAS OPERACOES DIFERENTES DE VENDAS
*				*----------------------------------------------------*
*				CASE &Als_tipooper .ch_opera <> "1" && TODAS OPER DIFERE
*				                                    && DE VENDA
*					LNtp_mercad	= 	1
*				*----------------------------------------------------*
*				* TODAS VENDAS Q NAO FOREM PARA 1-CONSSUMIDOR  OU
*				*                               3-CONTR NAO ISCRITO
*				*----------------------------------------------------
*				CASE !( &Als_tipooper .ch_contr $ "3/1" )
*					LNtp_mercad	= 	1
*			ENDCASE
*		ENDIF
*	ENDIF
*

	*-------------------------------------------------------------*

	IF TYPE('PrmFormaRetorno') = "C" ;
	   AND  PrmFormaRetorno = 'RETORNAR STRING'
	
		DO CASE

			CASE LNtp_mercad = 7
				LNtp_mercad	= "SERVICO"		

			CASE LNtp_mercad = 2
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			CASE LNtp_mercad = 8
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			OTHERWISE
				LNtp_mercad	= "ICMS NORMAL"		

		ENDCASE


	ENDIF





	*-------------------------------------------------------------*


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNtp_mercad)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKO2           TRpct_trib VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   43  º
*       º Variable:            TRpct_trib                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      33                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _4l10ytko2     &&  TRpct_trib VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*

FUNCTION TRpct_trib
PARAMETERS PrmEmpresa, PrmOrcamento, PrmProduto, ;
    LNiva, LNipialq, LNtp_mercad, LScst, ;
    LNaliq_iss, LNaliq_rdu, LNaliq_icms, LScfo


	=W_DEFPROC("rotinas.spr")


	PRIVATE LSEmpEstado
	PRIVATE LSClassifica
	PRIVATE LSProdOrigem
	PRIVATE LNtab_cst
	PRIVATE LNEmpReduzBase



    PRIVATE LSalias

    PRIVATE ARQ_GrFiscal,ALS_GrFiscal
    PRIVATE ARQ_Orcamento,ALS_Orcamento
    PRIVATE ARQ_Tipooper,ALS_Tipooper
	PRIVATE LSUForigem, LSUFdestino

    LSAlias      = Alias()

	
    LNiva = 0
    LNipialq = 0
	LNtp_mercad	= 99999   && INVALIDO
*-*	LScst		= " "		&& ASSUME 0
    LNaliq_iss = 0
    LNaliq_rdu = 0
    LNaliq_icms = 0
    LScfo = ""




    ARQ_GrFiscal  = NetArqAgain("GRFISCAL")
    ALS_GrFiscal  = Alias()

    ARQ_Orcamento  = NetArqAgain("ORCAMENTO")
    ALS_Orcamento  = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()


    LNiva = 0
	*--------------------------------------------------------*
	=W_DEFPROC("EMPRESA.SPR")
	IF !EMLerRegistro(PrmEmpresa)
	    do TRFcht_Fecha
		RETURN
	ENDIF


	=W_DEFPROC("GRUPO.SPR")
	IF !GRLerRegistro(PrmProduto)
	    do TRFcht_Fecha
		RETURN
	ENDIF




	*---------------------------------------------------------------*


	=W_DEFPROC("EMPRESA.SPR")
	LSEmpEstado = EMGet_UF(PrmEmpresa)

	=W_DEFPROC("GRUPO.SPR")
	LSClassifica = GRGetClassifica(PrmProduto)


	=W_DEFPROC("GRUPO.SPR")
	LSProdOrigem = GRGetOrigem(PrmProduto)




	SELE &Als_GRfiscal
	SET ORDER TO trb_classe
	SEEK LSEmpEstado + LEFT( LSClassifica,5)
	IF !FOUND()
		SET ORDER TO trb_sbgrpo
		SEEK LSEmpEstado + LEFT( LSClassifica,8)
	ENDIF

	*---------------------------------------------------------------*

	SELECT &ALS_Orcamento
	SET ORDER TO tag geral
	SEEK STR(PrmEmpresa,3)+STR(PrmOrcamento,6)
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF


	*------------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'S'+ &Als_orcamento .tipo
	IF !FOUND()
		SEEK 's'+  &Als_orcamento .tipo  	
	ENDIF
	IF !FOUND()
	    do TRFcht_Fecha
		RETURN
	ENDIF

	*------------------------------------------------------------*
	*------------------------------------------------------------*

    *=========>>>>>>>   OBTER IVA    <<<<<<



	=W_DEFPROC("CLIENC.SPR")
	LSUFdestino = CNGetUFDestino(PrmEmpresa,PrmOrcamento)


	=W_DEFPROC("EMPRESA.SPR")
	LSUForigem = EMGet_UF(PrmEmpresa)


	=W_DEFPROC("TRIBUTAR.SPR")
	LNiva = TRGet_IVA( LSUForigem,;
			            PrmProduto,;
			            LSUFdestino ,;
			            &ALS_Orcament .data )




    *=========>>>>>>>   OBTER ALIQ IPI    <<<<<<

	LNipialq   = &ALS_Orcamento .aliq_ipi	&& USAR ALIQUOTA INFORMADA
	DO CASE

		CASE &Als_tipooper .ch_opera = "4"	&& DEVOLUCAO			
			LNipialq   = &Als_orcamento .aliq_ipi	&& USAR ALIQUOTA
							                        && INFORMADA

		CASE LSProdOrigem = 1
			=W_DEFPROC("GRUPO.SPR")
			LNipialq   =  GRGetFieldValue(PrmProduto,"ALIQ_IPI")

		OTHERWISE
			LNipialq   =	0
	ENDCASE


    *=========>>>>>>>   OBTER TP_MERCAD    <<<<<<

    LNtp_mercad = TRDef_TpMercad(PrmEmpresa, PrmOrcamento,PrmProduto)

*    *-----------------------------------------------------------------*
*    * A ROTINA ABAIXO FOI DESATIVADA E TRANSFERIDA PARA
*    * FUNCTION TRDef_RgTrbMercad EM 06/09/2012
*	* PARAMETER PrmUF,PrmProduto,PrmFormaRetorno
*    *-----------------------------------------------------------------*
*
*	*----------------------------------------------------------------*
*	*		Identificar mercadorias em regime de substituicao ESTADUAL
*	*	em caso de operacao ITERESTADUAIS com consumidor INSCRITO(2)/
*	*	REVENDA(4) ou DEVOLUCOES passa mercadoria para regime tributado
*	*----------------------------------------------------------------*
*
*
*	*IF LNtp_mercad = 2	AND &Als_tipooper .ch_desti = "2"
*		IF     &Als_grfiscal .subgrupo > "02000" ;
*		   AND &Als_grfiscal .subgrupo < "99999" ;
*		   AND &Als_grfiscal .subgrupo <> "04042"
*			DO CASE
*				*----------------------------------------------------*
*				* TODAS OPERACOES DIFERENTES DE VENDAS
*				*----------------------------------------------------*
*				CASE &Als_tipooper .ch_opera <> "1" && TODAS OPER DIFERE
*				                                    && DE VENDA
*					LNtp_mercad	= 	1
*				*----------------------------------------------------*
*				* TODAS VENDAS Q NAO FOREM PARA 1-CONSSUMIDOR  OU
*				*                               3-CONTR NAO ISCRITO
*				*----------------------------------------------------
*				CASE !( &Als_tipooper .ch_contr $ "3/1" )
*					LNtp_mercad	= 	1
*			ENDCASE
*		ENDIF
*	ENDIF
    *=========>>>>>>>   OBTER CST    <<<<<<


	*---------------------------------------------------------------*
    *  Seleciona tabela de situaao 1 ou 2
	*---------------------------------------------------------------*

	=W_DEFPROC("EMPRESA.SPR")
	LNtab_cst = EMGet_TabCst(PrmEmpresa)


	*---------------------------------------------------------------*
    *  Obtem o tipo mercadoria
	*---------------------------------------------------------------*
	*---------------------------------------------------------------*

	LScst = TRdefcst((LNtab_cst),( &ALS_orcamento .tipo),;
									(LNtp_mercad), PrmProduto,LScst)

    *=========>>>>>>>   OBTER ALIQ ISS    <<<<<<


	=W_DEFPROC("EMPRESA.SPR")
	LNaliq_iss = EMGetFieldValue(PrmEmpresa,"ALIQ_ISS")


    *=========>>>>>>>   OBTER ALIQ reducao icms   <<<<<<
	=W_DEFPROC("EMPRESA.SPR")
	LNEmpReduzBase = EMGetFieldValue(PrmEmpresa,"REDUZ_BASE")


	LNaliq_rdu    =  0


	IF LNEmpReduzBase = 0
		LNaliq_rdu    =  &Als_orcamento .aliq_rdu && USAR ALIQUOTA INFORMADA
	ELSE
        if &Als_tipooper .ch_desti = "1"  && Este parametro de reducao so se
                                    && a operacoes dentro do estado
			LNaliq_rdu   = LNEmpReduzBase  && USAR ALIQUOTA
			                                        && INFORMADA
		endif
	ENDIF

    *=========>>>>>>>   OBTER ALIQ icms   <<<<<<
	IF &Als_tipooper .info_icms = "S"
		LNaliq_icms = &Als_orcament .aliq_icms && USAR ALIQUOTA
											   && INFORMADA
	ELSE
		LNaliq_icms  =  &Als_tipooper .aliq_icms && USAR ALIQUOTA
												     && INFORMADA
	ENDIF
    *=========>>>>>>>   OBTER CFO   <<<<<<


	DO CASE
		CASE LNTp_Mercad = 2   && MERCADORIA COM RETENCAO
		   LScfo = &Als_tipooper .cfosubs
		CASE LNTp_Mercad = 7
		   LScfo = &Als_tipooper .cfo					
		   LScfo = LEFT(LScfo,1)+".933"   && PARA SERVICO
		OTHERWISE	
		   LScfo = &Als_tipooper .cfo					&& CFO DEFAULT
	ENDCASE




	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
    do TRFcht_Fecha

RETURN

PROCEDURE TRFcht_Fecha
   	=up_fecha("&ALS_GrFiscal")
   	=up_fecha("&ALS_Orcamento")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKO3           TRCnvrt_RgTrbMercad VALID          º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   44  º
*       º Variable:            TRCnvrt_RgTrbMercad                º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      34                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytko3     &&  TRCnvrt_RgTrbMercad VALID
#REGION 1
RETURN

FUNCTION TRCnvrt_RgTrbMercad
	PARAMETER PrmTpMercad
	
	
	
	*-----------------------------------------------------------------*	
	*--> PrmFormaRetorno = 'RETORNAR STRING'
	*   RETORNAR EM FORMATO STRIG (USADO EM DOC FISCAL - EFD E NFe )
	*-----------------------------------------------------------------*	
	




	*------------------------------------------------------------*
	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE	LSClassifica
	PRIVATE	LNtp_mercad
	LNtp_mercad	= 99999   && INVALIDO
	
	LSalias  = ALIAS()  && P/ RETORNAR A AREA ANTERIOR
	*--------------------------------------------------------
	LNtp_mercad	= PrmTpMercad

	*-------------------------------------------------------------*

	
		DO CASE

			CASE LNtp_mercad = 7
				LNtp_mercad	= "SERVICO"		

			CASE LNtp_mercad = 2
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			CASE LNtp_mercad = 8
				LNtp_mercad	= "SUBSTITUICAO TRIBUTARIA"		

			OTHERWISE
				LNtp_mercad	= "ICMS NORMAL"		

		ENDCASE



	*-------------------------------------------------------------*


	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNtp_mercad)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKO4           TRcst_Entrada VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   45  º
*       º Variable:            TRcst_Entrada                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      35                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


FUNCTION _4l10ytko4     &&  TRcst_Entrada VALID
#REGION 1
RETURN

FUNCTION TRcst_Entrada
PARAMETERS PrmCst,PrmOrigem,PrmTp_Mercad,Prmbase_calc,PrmVlrvenda,;
		Prmicms_subs, PrmProduto, Prmtipo



    Prmtab_cst = 3



	=W_DEFPROC("rotinas.spr")
	PRIVATE LScst
	PRIVATE LSalias

    PRIVATE ARQ_Tipooper,ALS_Tipooper
    PRIVATE ARQ_tab_cst,ALS_tab_cst
	LSalias = ALIAS()

    ARQ_Tab_Cst     = NetArqAgain("TAB_CST")
    ALS_Tab_Cst     = Alias()

    ARQ_Tipooper  = NetArqAgain("TIPOOPER")
    ALS_Tipooper  = Alias()



	IF ( ARQ_Tab_Cst)+ ARQ_Tipooper > 100000 && HOUVE FALHA DE ABERTURA
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF
	*---------------------------------------------------------*
	SELECT &Als_tipooper
	SET ORDER TO TAG tipo
	SEEK 'E'+ PrmTipo
	IF !FOUND()
		SEEK 'e'+  PrmTipo
	ENDIF
	IF !FOUND()
        =up_fecha("&ALS_Tab_cst")
	   	=up_fecha("&ALS_Tipooper")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		LScst = PrmCST
		RETURN(LScst)
	ENDIF



	LScst = " "
	DO CASE
		CASE &Als_tipooper .ch_opera = "4"  && DEVOLUCAO
*****			LScst =  PrmCST
	     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  PrmCST  + "0"
		OTHERWISE
			SELECT &Als_tab_cst
			SET ORDER TO TAG cst
			SEEK STR(Prmtab_cst,2)+PrmTipo+STR(Prmtp_mercad,1)
			IF !FOUND()
				IF tipooper.ch_opera = "3"
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "4"  + "0"

				ENDIF
			ELSE
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  LEFT( &Als_tab_cst .cst,1)  + "0"
			ENDIF
	ENDCASE
	*------------------------------------------------------------*
	* EXCECOES
	*------------------------------------------------------------*
    DO CASE
		CASE PrmTipo = "CLA" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "2"  + "0"
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
				CASE Prmicms_subs = 0 AND Prmbase_calc = 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"
			ENDCASE

		CASE PrmTipo = "CLB" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "2"  + "0"

				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
				CASE Prmicms_subs = 0 AND Prmbase_calc = 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "6"  + "0"
			ENDCASE
			
		CASE PrmTipo = "CFA" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "7"  + "0"
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE
			
		CASE PrmTipo = "CFB" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0 AND Prmbase_calc < PrmVlrvenda
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "7"  + "0"
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE

		CASE PrmTipo = "CFM" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE
			
		CASE PrmTipo = "CFS" AND PrmTp_Mercad = 2

			DO CASE
				CASE Prmicms_subs > 0
			     	LScst = CHRTRAN(STR(PrmOrigem,1)," ","0") + ;
						  "1"  + "0"
			ENDCASE

    ENDCASE


	*------------------------------------------------------------*

    =up_fecha("&ALS_Tab_cst")
   	=up_fecha("&ALS_Tipooper")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScst)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKPD           TR_InternaIVAAjustada VALID        º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   46  º
*       º Variable:            TR_InternaIVAAjustada              º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      36                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkpd     &&  TR_InternaIVAAjustada VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_InternaIVAAjustada
PARAMETERS LNiva




    *-------------------------------------------------------------
    * conforme solicitacao do Celio Repassada pelo almir foi revgada
    * a instrucao anterior para DF e GO retornando o IVA interno
    * para ser orientada pelo cadastro na tabela TAB_IVA e
    * ignorar regras internas do programa
    *
    *-------------------------------------------------------------
     IF 1 =  1
        RETURN(LNIva)
     ENDIF



	*------------------------------------------------------------*
	* IVA TERMO DE ACORDO TO/DF/GO
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra para termo de acordo
    *   revenda INTERNA DE pecas no TO
    *   => PECAS
    *      => TO / DF / GO
	*------------------------------------------------------------*
		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*
        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*





 		IF LEFT( &Als_Grupo .classifica,2) = "04" ;
 		   AND 	PrmData >= {01.06.2008} ;
		   AND  PrmData <  {01.01.2013}

	        DO CASE
				CASE (PrmUFOrigem $ "TO" AND PrmUFDestino  $ "TO")
					LNiva = 1.265				

				CASE (PrmUFOrigem $ "DF" AND PrmUFDestino  $ "DF")
					LNiva = 1.596				

				CASE (PrmUFOrigem $ "GO" AND PrmUFDestino  $ "GO")
					LNiva = 1.596				

        	ENDCASE
		ENDIF


        *-------------------------------------------------------------
        * conforme solicitacao do Celio Repassada pelo almir foi revgada
        * a instrucao anterior para DF e GO retornando o IVA interno
        * para 1.400 apartir de 01/01/2012
        *-------------------------------------------------------------

 		IF LEFT( &Als_Grupo .classifica,2) = "04" ;
 		   AND PrmData >=  {01.01.2013}

	        DO CASE
				CASE (PrmUFOrigem $ "TO" AND PrmUFDestino  $ "TO")
					LNiva = 1.265				

				CASE (PrmUFOrigem $ "DF" AND PrmUFDestino  $ "DF")
					LNiva = 1.400				

				CASE (PrmUFOrigem $ "GO" AND PrmUFDestino  $ "GO")
					LNiva = 1.400				
        	ENDCASE
		ENDIF



RETURN(LNIva)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKPE           TR_ICM49IVAjustada VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   47  º
*       º Variable:            TR_ICM49IVAjustada                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      37                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkpe     &&  TR_ICM49IVAjustada VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_ICM49IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PECAS
    *      => MT e DF
	*------------------------------------------------------------*

		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*
		DO CASE

			CASE (PrmUFOrigem $ "DF") ;
			    	and PrmUFOrigem <> PrmUFDestino ;
			    	and PrmData >= {01.06.2008} ;
			    	and PrmData <  {01.09.2012}
				*---------------------------------------------------*
				* PROTOCOLO ICMS 49 -8 DE MAI DE 2008 IVA AJUSTAS DF/MT
				*-----------------------------------------------------*
				LFajustaIVA = LFajustaIVA
							&& SO PARA JUSTIFICAR IF AFIRMATIVO

			CASE (PrmUFOrigem $ "MT");
			    	and PrmUFOrigem <> PrmUFDestino ;
			    	and PrmData >= {01.06.2008} ;
			    	and PrmData <  {01.09.2012}
				*------------------------------------------------*
				* PROTOCOLO ICMS 49 -8 DE MAI DE 2008 IVA AJUSTAS DF/MT
				*----------------------------------------------------*
				LFajustaIVA = LFajustaIVA
							&& SO PARA JUSTIFICAR IF AFIRMATIVO
			OTHERWISE
				RETURN(LNIva)
		ENDCASE
		
        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*

	 	DO CASE
			*--------------------------------------------*
			* PECAS E ACESSORIOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "04"
	 		   IF LEFT( &Als_Grupo .classifica,5)  $ "04041/04042/04043"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF

			*--------------------------------------------*
			* PESOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) = "07075"
	 		   IF SUBS( &Als_Grupo .classifica,6,3)  $ "599/699/799/899/999"
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
			*--------------------------------------------*
			* MATERIAL BORRACHARIA
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "05"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
 	
	 	ENDCASE

		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)


			do case
				case LNiva = 1.265				
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.417				
								case LNalq_internaUFDst = 18
									LNiva = 1.435				
								case LNalq_internaUFDst = 19
									LNiva = 1.452			
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.341				
								case LNalq_internaUFDst = 18
									LNiva = 1.358			
								case LNalq_internaUFDst = 19
									LNiva = 1.374			
		                    endcase
					endcase
				case LNiva = 1.400				
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.569				
								case LNalq_internaUFDst = 18
									LNiva = 1.588				
								case LNalq_internaUFDst = 19
									LNiva = 1.607				
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.484				
								case LNalq_internaUFDst = 18
									LNiva = 1.502				
								case LNalq_internaUFDst = 19
									LNiva = 1.521			
		                    endcase
					endcase
			endcase
		ENDIF


RETURN(LNIva)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKPF           TR_ICM62IVAjustada VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   48  º
*       º Variable:            TR_ICM62IVAjustada                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      38                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkpf     &&  TR_ICM62IVAjustada VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_ICM62IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PECAS
	*------------------------------------------------------------*

		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*

		IF ;
		   (PrmUFOrigem $ ;
		      "DF/AC/AL/AP/BA/GO/MA/MT/PB/PR/PE/PI/RN/RR/SC/SE/TO");
		    	and PrmUFOrigem <> PrmUFDestino ;
		    	and PrmData >=  {01.09.2012}
			*------------------------------------------------------------*
			* PROTOCOLO ICMS 62 -22 DE JUN DE 2012 IVA AJUSTAS
			*------------------------------------------------------------*
			LFajustaIVA = LFajustaIVA && SO PARA JUSTIFICAR IF AFIRMATIVO
		ELSE
			RETURN(LNIva)
		ENDIF




        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*

	 	DO CASE
			*--------------------------------------------*
			* PECAS E ACESSORIOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "04"
	 		   IF LEFT( &Als_Grupo .classifica,5)  $ "04041/04042/04043"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF

			*--------------------------------------------*
			* PESOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) = "07075"
	 		   IF SUBS( &Als_Grupo .classifica,6,3)  $ "599/699/799/899/999"
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
			*--------------------------------------------*
			* MATERIAL BORRACHARIA
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "05"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
 	
	 	ENDCASE

		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem,PrmPrdtOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)


			do case
				case LNiva = 1.400	OR LNiva = 1.5960
					do case
						case LNalq_externaUForg	= 7
	
							do case
								case LNalq_internaUFDst = 17
									LNiva = 1.7883				
								case LNalq_internaUFDst = 18
									LNiva = 1.8101			
								case LNalq_internaUFDst = 19
									LNiva = 1.8324				
        		         	endcase

					     case LNalq_externaUForg	= 12
        		            do case
								case LNalq_internaUFDst = 17
									LNiva = 1.6921				
								case LNalq_internaUFDst = 18
									LNiva = 1.7128				
								case LNalq_internaUFDst = 19
									LNiva = 1.7339			
		                    endcase
					endcase
			endcase
		ENDIF

RETURN(LNIva)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKPG           TR_ICM92IVAjustada VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   49  º
*       º Variable:            TR_ICM92IVAjustada                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      39                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkpg     &&  TR_ICM92IVAjustada VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*
* em 18 de janeiro incorporamos o tratamento da aliquota de 4%



FUNCTION TR_ICM92IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PNEUMATICOS
	*------------------------------------------------------------*

		LFajustaIVA = .f.


        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*

		IF  PrmUFOrigem <> PrmUFDestino ;
		   	and PrmData >=  {01.09.2012}
			*------------------------------------------------------------*
			* PROTOCOLO ICMS 62 -22 DE JUN DE 2012 IVA AJUSTAS
			*------------------------------------------------------------*
			LFajustaIVA = LFajustaIVA && SO PARA JUSTIFICAR IF AFIRMATIVO
		ELSE
			RETURN(LNIva)
		ENDIF

        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*


	 	DO CASE
			*--------------------------------------------*
			* PNEUMATICOS - PNEUS/CAMARAS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) $ "00/01"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA

			*--------------------------------------------*
			* PROTETORES
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) $ "04042"
	 		   IF LEFT( &Als_Grupo .classifica,8)  $ "04042920"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
	 	ENDCASE


		IF LFajustaIVA = .T.
			LNalq_externaUForg = TRAlqIcmOuUF(PrmUFOrigem,PrmPrdtOrigem)
			LNalq_internaUFDst = TRAlqIcmInUF(PrmUFDestino)




			IF LNalq_internaUFDst = 18  ;
				AND PrmUFDestino $ "DF/TO" ;
				AND YEAR(DATE()) >= 2016

				do case
					case LNiva = 1.42				
						do case
							case LNalq_externaUForg	= 4
								LNiva = 1.6624				
							case LNalq_externaUForg	= 7
								LNiva = 1.6104			
							case LNalq_externaUForg	= 12
								LNiva = 1.5239				
						endcase
						
					case LNiva = 1.32				

						do case
							case LNalq_externaUForg	= 4
								LNiva = 1.5454			
							case LNalq_externaUForg	= 7
								LNiva = 1.4970				
							case LNalq_externaUForg	= 12
								LNiva = 1.4166				
						endcase

					case LNiva = 1.45				

						do case
							case LNalq_externaUForg	= 4
								LNiva = 1.6976				
							case LNalq_externaUForg	= 7
								LNiva = 1.6445				
							case LNalq_externaUForg	= 12
								LNiva = 1.5561				
						endcase
				endcase


			ELSE


				do case
					case LNiva = 1.42				
						do case
							case LNalq_externaUForg	= 4
								LNiva = 1.6424				
							case LNalq_externaUForg	= 7
								LNiva = 1.5911				
							case LNalq_externaUForg	= 12
								LNiva = 1.5055				
						endcase
					case LNiva = 1.32				
						do case
							case LNalq_externaUForg	= 4
								LNiva = 1.5267				
							case LNalq_externaUForg	= 7
								LNiva = 1.479				
							case LNalq_externaUForg	= 12
								LNiva = 1.3995				
						endcase
					case LNiva = 1.45				
						do case
							case LNalq_externaUForg	= 4
								LNiva = 1.6771				
							case LNalq_externaUForg	= 7
								LNiva = 1.6247				
							case LNalq_externaUForg	= 12
								LNiva = 1.5373				
						endcase
				endcase
			ENDIF

	ENDIF			

RETURN(LNIva)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _4L10YTKPH           TR_ICM73IVAjustada VALID           º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         TRIBUTAR,     Record Number:   50  º
*       º Variable:            TR_ICM73IVAjustada                 º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      40                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _4l10ytkph     &&  TR_ICM73IVAjustada VALID
#REGION 1
return
*---------------------------------------------------------------*
*------------------------ < ROT. APOIO >------------------------*
*---------------------------------------------------------------*
*  rotina alterada para tratar IVA AJUSTADA
*---------------------------------------------------------------*


FUNCTION TR_ICM73IVAjustada
PARAMETERS LNiva
	*------------------------------------------------------------*
	* IVA AJUSTADA
	*------------------------------------------------------------*
    *      Verifica aplicacao da regra de iva ajustada:
    *   => PECAS
	*------------------------------------------------------------*

		LFajustaIVA = .f.

        *------------------------------------------------------*
        * 1a - VERIFICACAO DE ENQUADRAMENTO - UF e DATA
        *------------------------------------------------------*

		IF ;
		   (PrmUFOrigem $ ;
		      "DF/TO/GO"  OR PrmUFDestino $ "DF/TO/GO");
		    	and PrmData >  {15.04.2015}
			*------------------------------------------------------------*
			* PROTOCOLO ICMS 73 -05 DE DEZ DE 2014 IVA AJUSTAS
			*------------------------------------------------------------*
			LFajustaIVA = LFajustaIVA && SO PARA JUSTIFICAR IF AFIRMATIVO
		ELSE
			RETURN(LNIva)
		ENDIF




        *------------------------------------------------------*
        * 2a - VERIFICACAO DE ENQUADRAMENTO - PRODUTOS
        *------------------------------------------------------*

	 	DO CASE
			*--------------------------------------------*
			* PECAS E ACESSORIOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "04"
	 		   IF LEFT( &Als_Grupo .classifica,5)  $ "04041/04042/04043"
				  LFajustaIVA = .f.  && Nao aplica IVA AJUSTADA
	 		   ELSE
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF

			*--------------------------------------------*
			* PESOS
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,5) = "07075"
	 		   IF SUBS( &Als_Grupo .classifica,6,3)  $ "599/699/799/899/999"
				  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
	 		   ENDIF
			*--------------------------------------------*
			* MATERIAL BORRACHARIA
			*--------------------------------------------*
	 		CASE LEFT( &Als_Grupo .classifica,2) = "05"
			  LFajustaIVA = .T.  && Aplica IVA AJUSTADA
 	
	 	ENDCASE

		IF LFajustaIVA = .T.

  		    LNiva = 1.7178				

		ENDIF

RETURN(LNIva)
