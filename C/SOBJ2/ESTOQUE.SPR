*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º 25.11.2014            ESTOQUE.SPR              17:05:51 º
*       º                                                         º
*       ÇÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¶
*       º                                                         º
*       º Author's Name                                           º
*       º                                                         º
*       º Copyright (c) 2014 Company Name                         º
*       º Address                                                 º
*       º City,     Zip                                           º
*       º                                                         º
*       º Description:                                            º
*       º This program was automatically generated by GENSCRN.    º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º                MS-DOS Window definitions                º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º          ESTOQUE/MS-DOS Setup Code - SECTION 2          º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 1
RETURN

*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º              ESTOQUE/MS-DOS Screen Layout               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 1
@ 10,0 SAY "----------------------   REDEFICAO DE REGRAS   ----------------------------" ;
	SIZE 1,75, 0
@ 19,1 SAY "-------------------------   CONSULTAS   ----------------------------------" ;
	SIZE 1,74, 0
@ 1,3 GET ESPsq_Produtos ;
	PICTURE "@*HN ESPsq_Produtos - Abre Pesquisa de Produto Order Tabela Ret. CODIGO" ;
	SIZE 1,68,1 ;
	DEFAULT 1 ;
	VALID _47v10n9jc()
@ 7,0 GET ESAbresaldo ;
	PICTURE "@*HN ESAbresaldo-Abre Reg.de Controle de Saldo " ;
	SIZE 1,44,1 ;
	DEFAULT 1 ;
	VALID _47v10n9jp()
@ 8,0 GET ESversaldo ;
	PICTURE "@*HN ESversaldo -Verificar se Existe Saldo Para Atender/Abre Controle " ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _47v10n9jq()
@ 9,0 GET ESsaldo ;
	PICTURE "@*HN obs * ESsaldo    -Informa Saldo Momento Informado Considara DATA e HORA" ;
	SIZE 1,73,1 ;
	DEFAULT 1 ;
	VALID _47v10n9kh()
@ 12,0 GET EScustoMedio ;
	PICTURE "@*HN EScustoMedio - Custo M‚dio do Produto na Empresa X e na Data X" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	VALID _47v10n9kt()
@ 13,0 GET EScustoEstq ;
	PICTURE "@*HN obs * EScustoEstq - Custo do Estoque Produto na Empresa X e na Data X" ;
	SIZE 1,71,1 ;
	DEFAULT 1 ;
	VALID _47v10n9l7()
@ 15,0 GET EScustoAgregado ;
	PICTURE "@*HN EScustoAgregado -Custo M‚dio Agregado de Tributacao , etc" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _47v10n9lj()
@ 16,3 GET ESAgregarTrbt ;
	PICTURE "@*HN ESAgregarTrbt -Agrega Tributos ao Valor Passado Como Custo" ;
	SIZE 1,60,1 ;
	DEFAULT 1 ;
	VALID _47v10n9lk()
@ 17,0 GET ESprc_compra ;
	PICTURE "@*HN ESprc_compra" ;
	SIZE 1,14,1 ;
	DEFAULT 1 ;
	VALID _47v10n9m2()
@ 20,0 GET EScrtcestq ;
	PICTURE "@*HN antEScrtcestq  - SQL sobre pedido p/ critica de estocagem" ;
	SIZE 1,59,1 ;
	DEFAULT 1 ;
	VALID _47v10n9mb()
@ 21,0 GET EScrtcestq ;
	PICTURE "@*HN EScrtcestq  - SQL sobre pedido p/ critica de estocagem" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _47v10n9mi()
@ 22,0 GET ESextrato ;
	PICTURE "@*HN ESextrato - Extrato de Movimentacao de Estoque" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _47v10n9mr()
@ 23,7 GET ESimpext ;
	PICTURE "@*HN ESimpext - Sub rotina para Impressao Extrato " ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	VALID _47v10n9n2()
@ 24,0 GET ESextRess ;
	PICTURE "@*HN ESextRess - Extrato de Ressarcimento" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	VALID _47v10n9n3()
@ 25,7 GET ESOrigDest ;
	PICTURE "@*HN ESOrigDest - Funcao de Apoio aos Extratos" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	VALID _47v10n9nj()
@ 26,0 GET ESextEntradas ;
	PICTURE "@*HN ESextEntradas - Extrato de Movimentacao de Entrada" ;
	SIZE 1,52,1 ;
	DEFAULT 1 ;
	VALID _47v10n9ns()
@ 27,0 GET ESextTrasf ;
	PICTURE "@*HN ESextTrasf - Extrato de Movimentacao de Entrada por Transferencia" ;
	SIZE 1,67,1 ;
	DEFAULT 1 ;
	VALID _47v10n9o3()
@ 2,3 GET ESVld_Produto ;
	PICTURE "@*HN ESVld_Produto - Verifica Validade do Produto Informado" ;
	SIZE 1,56,1 ;
	DEFAULT 1 ;
	VALID _47v10n9of()
@ 3,3 GET ESGet_Origem ;
	PICTURE "@*HN ESGet_Origem - Origem Importado ou Nacional" ;
	SIZE 1,45,1 ;
	DEFAULT 1 ;
	VALID _47v10n9on()



READ


#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º               ESTOQUE/MS-DOS Cleanup Code               º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 1

RETURN








********************************------------***************************
* ROTINAS COPIADAS DA BIBLIOTECA ROTESTOQ
*----------------------------------------------------------------------*
*****************************************************************

********************************************************************
*	UEvendas => Rotina para Verificacao das vendas de um produto
*				solicitado em um periodo
*
*	CHAMADO por SCGC800 : Verificacao de Previsao X Venda Real
*				OBJ_ROL1: Apuracao de Venda real no Periodo
*
********************************************************************


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º   ESTOQUE/MS-DOS Supporting Procedures and Functions    º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

#REGION 1
FUNCTION UEvendas
	PARAMETERS LNempresa,LSclas,LScodigo,LDdtini,LDdtfim,LNemdias,;
				LNqtvenda,LNqtentra,LNvlrvenda
	
	=W_DEFPROC("rotinas.SPR")
	*********************************************************************
	PRIVATE ALL
	LSalias 	= ALIAS()

	LNqtvenda   = 0
	LNqtentra	= 0
	LNvlrvenda  = 0

	LNacmqtvenda   	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO
	LNacmqtentra	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO
	LNacmvlrvenda  	= 0		&& ACUMULAR VLR DO PROD. PRINCIPAL E DO ANEXO

	*********************>>> REGISTRO DE SAIDAS <<<*********************
	*
	*   O saldo formado no so e considerado ate a 2/3 do
	* do periodo devido a pouca influencia nas vendas do periodo
	* das entradas do 1/3 restante
	*
	********************************************************************
	LDdtfimsld = LDdtini 		 		&& data para referenciar saldo apuradao
	LNdiassld  = INT(LNemdias / 3)* 2  && para apurar o saldo formado
							 			&& ate metade do periodo
	LNctrdias = 0
	DO WHILE LNctrdias <= LNdiassld
		IF DOW(LDdtfimsld) <> 1
			LNctrdias = LNctrdias +1
		ENDIF
		LDdtfimsld = LDdtfimsld + 1
	ENDDO
	*******************************************************************
	DO UEvervendas WITH LDdtini,LDdtfim, LNempresa, LScodigo,;
			LDdtfimsld,LNqtvenda,LNqtentra,LNvlrvenda

	LNacmqtvenda   	= LNqtvenda
	LNacmqtentra	= LNqtentra
	LNacmvlrvenda  	= LNvlrvenda

	*******************************************************************
	SELE grupoanx
	SET ORDER TO TAG classifica
	SEEK LSclas
	IF FOUND()
		*******************************************************************
		DO UEvervendas WITH LDdtini,LDdtfim, LNempresa,;
				grupoanx.codanx,;
				LDdtfimsld,LNqtvenda,LNqtentra,LNvlrvenda
		LNacmqtvenda   	= LNacmqtvenda  + LNqtvenda
		LNacmqtentra	= LNacmqtentra  + LNqtentra
		LNacmvlrvenda  	= LNacmvlrvenda + LNvlrvenda
		*******************************************************************
	ENDIF	
	LNqtvenda 	=	LNacmqtvenda
	LNqtentra	=	LNacmqtentra
	LNvlrvenda	=	LNacmvlrvenda

	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
RETURN

********************************************************************

PROCEDURE UEvervendas
	PARAMETERS  LDdtini,LDdtfim, LNempresa, LScodigo,LDdtfimsld,;
				LNqtvenda,LNqtentra,LNvlrvenda,LFdevolucao
	******************************************************************
	*	LFdevolucao	= .F. => Processa as devolucoes abatendo nas vendas
	*	              .T. => Nao abate devolucoes nas vendas
	*
	*	LNempresa 	= 999 => FAZ COM QUE A ROTINA LEVANDE  DADOS DE TODAS
	*						EMPRESAS REGISTRADAS NO ARQ. EMPRESA
	*******************************************************************
	=W_DEFPROC("rotinas.SPR")
	PRIVATE ALL
	LSalias 	= ALIAS()
	LNqtvenda   = 0
	LNqtentra	= 0
	LNvlrvenda  = 0

	SELE empresa
	SET ORDER TO TAG empresa
	IF LNempresa = 999
		GO TOP
	ELSE
		SEEK LNempresa
	ENDIF
	DO WHILE !EOF() AND (LNempresa = 999 OR LNempresa = empresa.empresa)
		SELE itemmov
		SET ORDER TO TAG movimento
		SET NEAR ON
		SEEK STR(empresa.empresa,3)+LScodigo+DTOS(LDdtini)
		SET NEAR OFF
		DO WHILE itemmov.data <= LDdtfim AND ;
				 itemmov.empresa = empresa.empresa AND ;
				 itemmov.codigo  = LScodigo
			IF LEFT(itemmov.operacao,1) = 'S' AND itemmov.ch_opera = "1" 	
			 	LNvlrvenda = LNvlrvenda + itemmov.vlrvenda
				IF itemmov.movestq = "S"
				 	LNqtvenda  = LNqtvenda  + itemmov.qtde
				ENDIF
			ENDIF
			IF !LFdevolucao  && ABATER DEVOLUCOES
				IF LEFT(itemmov.operacao,1) = 'E' AND itemmov.ch_opera = "4" AND ;
				    itemmov.movestq = "S"
				 	LNvlrvenda = LNvlrvenda - itemmov.vlrvenda
					IF (LNqtvenda  - itemmov.qtde) >=  0
				 		LNqtvenda  = LNqtvenda  - itemmov.qtde
					ENDIF
				ENDIF
			ENDIF
		IF itemmov.data <= LDdtfimsld AND LEFT(itemmov.operacao,1) = 'E' ;
				AND itemmov.ch_opera <> "4" AND itemmov.movestq = "S"
				 	LNqtentra  = LNqtentra  + itemmov.qtde
		ENDIF
			***********************************************************
			*  CASO A MERCADORIA SAI POR TRANSFERENCIA OU POR MOV. QUE NAO
			* SEJA VENDA ELA E DESCONSIDERADA
			* DAS ENTRADAS POIS NAO ESTA DESTINADA AO ESTOQUE DE VENDA
			***********************************************************
			IF LEFT(itemmov.operacao,1) = 'S' AND ;
					itemmov.ch_opera <> "1"	&& SAIDAS DEVERSAS DA VENDA
				 IF itemmov.movestq = "S"
					 	LNqtentra  = LNqtentra  - itemmov.qtde
				 ENDIF
				 IF LNqtentra < 0
				 	LNqtentra = 0
				 ENDIF
			ENDIF
			SKIP
		ENDDO	
		IF LNempresa <> 999		&& PESQUISA SO NA EMPRESA INFORMADA
			EXIT
		ENDIF
		SELE empresa
		SKIP
	ENDDO
	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(0)




**********************************************************************
* FUNCTION UEleanexado : Retorna o Codigo ou Codigo Anexado ao Codigo
*						Passado em Parametro
*		LSclas		=>	Codigo a Ser Verificado
*		LSresposta	=>  Indica qual a resposta desejad
*					"ANEXO" = Responder se o Produto Possui algum item
*							Anexado a ele
*					"ANEXADO" = Responder se o Produto esta ANEXADO a
*							outro
*					"QUALQUER"= Responder se existe vinculo em qualqer
*							sentido
***********************************************************************

FUNCTION UEleanexado
PARAMETERS LSclas,LSpergunta
	PRIVATE LSalias, LSresposta

	=W_DEFPROC("rotinas.SPR")

	PRIVATE LFerro
	LSalias = ALIAS()

	LSresposta = ""
    SELE grupoanx
	DO CASE
		CASE LSpergunta = "ANEXO"
			SET ORDER TO TAG classifica
			SEEK LSclas
			IF FOUND()
				LSresposta = grupoanx.codanx	&& E ANEXO DO CODIGO INFORMADO
			ENDIF
		CASE LSpergunta = "ANEXADO"
			SET ORDER TO TAG clasanx
			SEEK LSclas
			IF FOUND()
				LSresposta = grupoanx.codanx	&& E ANEXO DO CODIGO INFORMADO
			ENDIF
		CASE LSpergunta = "QUALQUER"
			LSresposta = UEleanexado(LSclas,"ANEXO")
			IF EMPTY(LSresposta)
				LSresposta = UEleanexado(LSclas,"ANEXADO")
			ENDIF
	ENDCASE
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LSresposta)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9JC           ESPsq_Produtos VALID               º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:    4   º
*       º Variable:            ESPsq_Produtos                     º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      1                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _47v10n9jc     &&  ESPsq_Produtos VALID
#REGION 1
RETURN
PROCEDURE ESPsq_Produtos
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Pesquisar Produtos em uma Lista
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: GRUPO
	*------------------------------------------------------------*
	* PARAMETROS..:
	*             LScodigo : Codigo do Produto - Pode Ser Utiliza
	*                  para posicionamento parcial
	*------------------------------------------------------------*
	* CHAMADAS.............:
	*------------------------------------------------------------*
	PARAMETERS LScodigo

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_grupo, ALS_grupo

    LSalias      = Alias()
    ARQ_grupo    = NetArqAgain("GRUPO")
    ALS_grupo    = Alias()



	SELE &ALS_grupo
	SET ORDER TO TAG codigo
	SET NEAR ON
	SEEK ALLTRIM(LScodigo)
	SET NEAR OFF
	*----------------------------------------------------------*
	ON KEY LABEL ESCAPE

	SET ORDER TO TAG ordem
	ON KEY LABEL ESCAPE
	DO loc_dlog WITH .T.

	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	IF LASTKEY() <> 27
	   LScodigo = &ALS_grupo .codigo
	ELSE
	   SEEK ALLTRIM(LScodigo)
	   IF !FOUND()
		   LScodigo = ""
	   ENDIF
	ENDIF

	=UP_fecha(ALS_GRUPO)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LScodigo)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9JP           ESAbresaldo VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:    5   º
*       º Variable:            ESAbresaldo                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      2                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _47v10n9jp     &&  ESAbresaldo VALID
#REGION 1
RETURN
PROCEDURE ESAbresaldo

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Abrir Registro de Controles de saldo
	* 			do produto informado no periodo informado
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: SALDO, ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Que se quer abrir o Saldo
	*		LSclass........: Classificaso do Produto
	*		LSclass........: Classificaso do Produto
	*		LDdtini........: Referencia do mes inicial
	*		LDdtfim........: Referencia do mes final
	*------------------------------------------------------------*
	* CHAMADAS.............:
	*------------------------------------------------------------*
	PARAMETERS LNemp,LScod,LSclass,LDdtini,LDdtfim

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFsaldo,LFitemmov
	PRIVATE LDdtincrementa, LDdtencerra

	*--------------------------------------------------------------*
	PRIVATE m.sld_ante,m.sld_atu,m.vlr_ante,m.vlr_atu
	PRIVATE m.empresa,m.codigo, m.classifica
	PRIVATE m.qtd_compra,m.vlr_compra,m.qtd_venda,m.vlr_venda,;
			m.qtd_e_tran,m.vlr_e_tran,m.qtd_e_outr,m.vlr_e_outr,;
			m.qtd_s_tran,m.vlr_s_tran,m.qtd_s_outr,m.vlr_s_outr,;
			m.ven_tab,m.ven_contab,m.ven_enc,m.dtabert,m.status
	*--------------------------------------------------------------*
	LSalias			= ALIAS()
	LFsaldo			= NetArq("saldo")
	LFitemmov			= NetArq("itemmov")
	IF (LFsaldo+LFitemmov) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("saldo" ,LFsaldo)
		=UP_fecha("itemmov" ,LFitemmov)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(.F.)
	ENDIF
	*----------------------------------------------------------------*
	* Redimensiona as datas para permitir o controle do incremento de
	* 1 mes na data inicial dentro do laco
	*----------------------------------------------------------------*
	LDdtincrementa	= LDdtini - DAY(LDdtini) + 1 && 1o DIA DO MES
	LDdtencerra		= LDdtfim -	DAY(LDdtfim) + 1 && 1o DIA DO MES

   	m.sld_ante   = 0
   	m.vlr_ante   = 0

	DO WHILE LDdtincrementa <= LDdtencerra
   		SELECT saldo
	   	SET ORDER TO TAG clas_saldo
   		SET NEAR ON
   		SEEK STR(LNemp,3)+LSclass+;
	        	STR(YEAR(LDdtincrementa),4)+;
    	    	STR(MONTH(LDdtincrementa),2)
	   	SET NEAR OFF

	   	IF  FOUND()
			SKIP -1			&& TESTE SE EXISTE REGISTRO ANTERIOR
	      	IF !BOF() ;
	      		AND saldo.empresa  = LNemp ;
	      		AND saldo.classifica = LSclass
			    	m.sld_ante   = saldo.sld_atu
			    	m.vlr_ante   = saldo.vlr_atu
			ELSE
				SELE itemmov
				SET ORDER TO TAG movsimples
				SET NEAR ON
				SEEK STR(LNemp,3)+LScod+DTOS(LDdtincrementa)
				SET NEAR OFF
				*-------------------------------------------------*
				* PROCURANDO MOVIMENTO ANTERIOR A DATA
				*-------------------------------------------------*
				SKIP -1
				DO WHILE !BOF() ;
						AND itemmov.empresa  = LNemp ;
						AND itemmov.codigo   = LScod ;
						AND itemmov.data >= LDdtincrementa
	
					SKIP -1
				ENDDO
				IF !BOF() 	AND itemmov.empresa  = LNemp ;
							AND itemmov.codigo   = LScod ;
						AND itemmov.data < LDdtincrementa
					* ENCONTROU MOV ANTERIOR

			    	m.sld_ante   = itemmov.sld_estq
			    	m.vlr_ante   = itemmov.vlr_estq
				ENDIF
			ENDIF	
			SELE SALDO
	   		SEEK STR(LNemp,3)+LSclass+;
	        	STR(YEAR(LDdtincrementa),4)+;
    	    	STR(MONTH(LDdtincrementa),2)

			SET FIELDS TO dtregis, hregis, usrregis,deletado
		    SET FIELDS TO sld_ante, vlr_ante
			=edithand('REGRAVA')
			CLEAR FIELDS
			SET FIELDS OFF

	   	ELSE
			SKIP -1			&& TESTE SE EXISTE REGISTRO ANTERIOR
	      	IF !BOF() ;
	      		AND saldo.empresa  = LNemp ;
	      		AND saldo.classifica = LSclass
			    	m.sld_ante   = saldo.sld_atu
			    	m.vlr_ante   = saldo.vlr_atu
			ELSE
				SELE itemmov
				SET ORDER TO TAG movsimples
				SET NEAR ON
				SEEK STR(LNemp,3)+LScod+DTOS(LDdtincrementa)
				SET NEAR OFF
				*-------------------------------------------------*
				* PROCURANDO MOVIMENTO ANTERIOR A DATA
				*-------------------------------------------------*
				SKIP -1
				DO WHILE !BOF() ;
						AND itemmov.empresa  = LNemp ;
						AND itemmov.codigo   = LScod ;
						AND itemmov.data >= LDdtincrementa
	
					SKIP -1
				ENDDO
				IF !BOF() 	AND itemmov.empresa  = LNemp ;
							AND itemmov.codigo   = LScod ;
						AND itemmov.data < LDdtincrementa
					* ENCONTROU MOV ANTERIOR

			    	m.sld_ante   = itemmov.sld_estq
			    	m.vlr_ante   = itemmov.vlr_estq
				ENDIF
			ENDIF	
	    	m.sld_atu    = m.sld_ante
	    	m.vlr_atu    = m.vlr_ante

   			m.empresa    = LNemp
	    	m.codigo     = LScod
		    m.classifica = LSclass

			STORE 0 TO 	m.qtd_compra,m.vlr_compra,m.qtd_venda,m.vlr_venda,;
					m.qtd_e_tran,m.vlr_e_tran,m.qtd_e_outr,m.vlr_e_outr,;
					m.qtd_s_tran,m.vlr_s_tran,m.qtd_s_outr,m.vlr_s_outr,;
					m.ven_tab,m.ven_contab,m.ven_enc

			m.dtabert   = LDdtincrementa
		    m.status    = 'A'
			SELE SALDO
			=edithand('SAVE')
	
		ENDIF
		LDdtincrementa	= GOMONTH(LDdtincrementa,1) && PROXIMO 1o DIA DO MES
	ENDDO

	=UP_fecha("saldo" ,LFsaldo)
	=UP_fecha("itemmov" ,LFitemmov)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(.T.)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9JQ           ESversaldo VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:    6   º
*       º Variable:            ESversaldo                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      3                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _47v10n9jq     &&  ESversaldo VALID
#REGION 1
RETURN

FUNCTION ESversaldo
	PARAMETERS LNemp,LScod,LDdata,LNqtde,LNJaReserv,;
				LFabreAuto,LFlockreg,LSoperacao,LShora,;
				LSmovEstq

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Verificar Saldo Para  atender solicitacao
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....:
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdata.........: Data na Qual se quer o saldo
	*		LNqtde.........: Qtde Solicitada
	*		LNJaReserv.....: Qtde ja Reservada Anteriormente desta
	*						propria Solicitacao
	*						Ex: SOLICITA 10 mas JA TEM 3 RESERVADO
	*						ATERIORMENTE => TEM QUE ATENDEDER 7
	*						esta qu
	*		LFAbreAuto.....: .f. Nao abre Controle quando nao Existe
	*						 .t. Abre Registro de Saldo para Mes
	*		LSoperacao.....: Indica qual opercao esta originando a
	*						chamada a rotina ex:
	*					"RESERVA" => Processo de Reserva ex: SCGC2.PRG
	*
	*
	*					"SAIDA" => Processo de Saida ex: SCGC2.PRG
	*					"ENTRADA"=>Processo de Entrada ex: SCGC210.SCR
	*							(Para entradas so ‚ necessario localizar
	*							registro de SALDO  e bloquear nao
	*							sendo verificados saldos
	*		LShora.........: Perimite verificar o saldo pelo
	*					movimento (ITEMMOV) localizando o  movimento
	*					anterior do item na data e hora informada
	*					so esta sendo utilizado para REQUISICOES
	*					de saida que podem ser lancadas em datas
	*					anteriores e devem considerar o saldo do
	*					momento (OBS: No caso de recuperacao de
	*							NFS e possivel utilizar esta
	*							tecnica , ver futuro)
	*		LSmovEstq.......: "N"= Operacao nao movimentara estoque
	*								so deseja localiza/block REG.SALDO					
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LFretorno......: .F. ou .T.
	*
	* CHAMADAS.....: SCGC2.PRG,OBJ_ITOR.SCR,SCGCF201
	*				 SCGC210.SCR			
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")
	PRIVATE LSalias
	PRIVATE LFsaldo
	PRIVATE LFgrupo
	PRIVATE LFempresa
    PRIVATE LNreal_saldo
 	PRIVATE LNbloq_saldo
	PRIVATE LFgrfiscal
	*------------------------------------------------------------*
	LSalias			= ALIAS()
	LFsaldo			= NetArq("saldo")
	LFgrfiscal		= NetArq("grfiscal")
	LFempresa		= NetArq("empresa")
	LFgrupo			= NetArq("grupo")
	*------------------------------------------------------------*
	IF (LFsaldo+LFgrfiscal+LFempresa+LFgrupo) > 100000
		DO ESver_fecha
      	WAIT WINDOW "(ESversaldo)- Falha Abertura de Tabelas.<ENTER>"
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		DO ESver_fecha
      	WAIT WINDOW ;
      		"(ESversaldo)- Registro de Empresa Nao Localizado. <ENTER>"
		RETURN(.f.)
	ENDIF
	*------------------------------------------------------------*
	SELECT grupo
	SET ORDER TO TAG codigo
	SEEK LScod
	IF !FOUND()
		DO ESver_fecha
      	WAIT WINDOW ;
      		"(ESversaldo)- Registro de Produto Nao Localizado.<ENTER>"
		RETURN(.f.)
	ENDIF
	IF  grupo.tp_control = 9   && PRODUTO SEM CONTROLE DA ESTOQUE
		DO ESver_fecha
		RETURN(.T.)
	ENDIF

	*------------------------------------------------------------*
	SELECT GRfiscal
	SET ORDER TO TAG tributacao
	SEEK empresa.estado+LEFT(grupo.classifica,5)
	IF !FOUND()
		SET ORDER TO TAG tributacao
		SEEK empresa.estado+LEFT(grupo.classifica,2)
		IF !FOUND()
			DO ESver_fecha
    	  	WAIT WINDOW ;
			"(ESversaldo)- Registro Fiscal de Produto "+ALLTRIM(LScod)+;
					"  Nao Localizado.<ENTER>"
			RETURN(.f.)
		ENDIF
	ENDIF
	IF  grfiscal.tp_mercad =  7
		DO ESver_fecha
		RETURN(.T.)
	ENDIF
	*------------------------------------------------------------*
    SELECT saldo
    SET ORDER TO TAG clas_saldo
    SEEK STR(LNemp,3)+grupo.classifica+;
        STR(YEAR(LDdata),4)+;
        STR(MONTH(LDdata),2)
    IF !FOUND()
		IF !LFAbreAuto OR;
		   !ESAbresaldo((LNemp),(LScod),(grupo.classifica),;
					(LDdata), (LDdata))
	      	WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
    	           " nao foi aberto para movimentacao. Solicite abertura."
			DO ESver_fecha
			RETURN(.f.)
		ENDIF
    ENDIF

    IF LScod   <> saldo.codigo OR ;
   	   grupo.classifica <> saldo.classifica
		    DO OBJ_ALER.SPR WITH ;
	   		"Os dados do Item "+LScod+chr(13)+;
			"Estao irregulares. Reedite a Doc e verifique o Item."
			DO ESver_fecha
			RETURN(.f.)
    ENDIF
	
	*-----------------------------------------------------------------*
	IF LSmovEstq <> "N" AND !ULatendeOper(LSoperacao)
		DO ESver_fecha
      	WAIT WINDOW  "(ESversaldo)- Estoque Insuficiente. <ENTER>"
		RETURN(.f.)
	ENDIF
	*----------------------------------------------------------------*
	IF LFlockreg		&& BLOQUEAR REGISTRO PARA PROCESSO
	   IF !REGLOCK()
	      	WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
                 " nao pode ser bloqueado para efetivar reserva."
			DO ESver_fecha
			RETURN(.f.)
	   ENDIF
	ENDIF
	*------------------------------------------------------------*
	DO ESver_fecha
RETURN(.T.)


PROCEDURE ESver_fecha
	=UP_fecha("saldo"    ,LFsaldo)
	=UP_fecha("grfiscal" ,LFgrfiscal)
	=UP_fecha("empresa"  ,LFempresa)
	=UP_fecha("grupo"    ,LFgrupo)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN



FUNCTION ULatendeOper
PARAMETERS LSoperacao
	*-----------------------------------------------------------------*
	*	Esta Rotina Permite Tratar individualmente o saldo de acordo
	*	com a operacao "RESERVA", "SAIDA" ou "ENTRADA"
	*-----------------------------------------------------------------*
	PRIVATE LFretorno
	LFretorno = .T.	
	DO CASE
		CASE LSoperacao = "RESERVA"
		    LNbloq_saldo = saldo.sld_atu - saldo.reserva + LNJaReserv
			IF LNqtde > LNbloq_saldo
				      WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
			        " ESTOQUE (-) RESERVA =>> "+ALLTRIM(STR(LNbloq_saldo,7))
					LFretorno = .F.	
			ENDIF
		

        CASE  LSoperacao = "SAIDA" AND  "CENTRAL"  $ DBF("SALDO")
              *---------------------------------------------------*
              * PERMITE SALDO NEGATIVO PARA SAIDA NA CENTRAL
              *---------------------------------------------------*
			LFretorno = .T.	

		CASE LSoperacao = "SAIDA"
		    LNreal_saldo = saldo.sld_atu
		    LNbloq_saldo = saldo.sld_atu - saldo.reserva + LNJaReserv

			DO CASE
				CASE LNqtde > LNreal_saldo
			       WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
			          " ESTOQUE =>> "+ALLTRIM(STR(LNreal_saldo,7))
					LFretorno = .F.	

				CASE LNqtde > LNbloq_saldo
				      WAIT WINDOW RTRIM(transform(LScod,'@R &masc_codi'))+;
			        " ESTOQUE (-) RESERVA =>> "+ALLTRIM(STR(LNbloq_saldo,7))
					LFretorno = .F.	
			ENDCASE
		CASE LSoperacao = "ENTRADA"
			LFretorno = .T.	
	ENDCASE
RETURN(LFretorno)




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9KH           ESsaldo VALID                      º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:    7   º
*       º Variable:            ESsaldo                            º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      4                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _47v10n9kh     &&  ESsaldo VALID
#REGION 1
RETURN
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar saldo em momento  solicitado
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*						LNemp = 999  faz com que a rotina le-
	*						vante os dados de todas empresas regis-
	*						tradas no arq. empresa
	*		LScod..........: Codigo do Produto
	*		LSclass........: Classificaso do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LNqtde.........: Referencia p/ Retorno
	*		LNcusto........: Referencia p/ Retorno
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*		LNreserva......: Qtde Reservada
	*------------------------------------------------------------*
	*	CHAMADA............: NEsoma_Saldo
	*
	*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNqtde.........: Saldo Total do Estoque na Data
	*		LNcusto........: Valor do Estoque  total
	*		LNreserva......: Parte do Saldo que esta Reservada
	*------------------------------------------------------------*



FUNCTION ESsaldo
	PARAMETERS LNemp,LScod,LSclass,LDdtbase,LNqtde,LNcusto, LShora,;
				LNreserva

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE LFsaldo,LFitemmov,LFempresa
	PRIVATE TMPcusto

	LNqtde  	= 0
	LNcusto 	= 0
	LNreserva 	= 0

	IF TYPE("LShora") <> "C" or EMPTY(LShora)
		LShora = "99:99:99"			&&  FORCA PESQUISA NO FINAL DO DIA
	ELSE
		LShora = LEFT(LShora,6)+"60" && FORCA PESQUISA NO PROXIMO MINUTO
	ENDIF
	LSalias			= ALIAS()
	LFempresa		= NetArq("empresa")
	LFsaldo			= NetArq("saldo")
	LFitemmov		= NetArq("itemmov")
	IF (LFempresa+LFsaldo+LFitemmov) > 100000 && HOUVE FALHA DE ABERTURA
		=UP_fecha("empresa" ,LFempresa)
		=UP_fecha("saldo" ,LFsaldo)
		=UP_fecha("itemmov" ,LFitemmov)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE empresa
	SET ORDER TO TAG empresa
	IF LNemp = 999
		GO TOP
	ELSE
		SEEK LNemp
	ENDIF
	DO WHILE !EOF() AND (LNemp = 999 OR LNemp = empresa.empresa)
		SELECT  itemmov
		SET ORDER TO TAG movimento
		SET NEAR ON
		SEEK STR(empresa.empresa,3)+LScod+dtos(LDdtbase)+LShora
										&& POSICIONA A FRENTE PARA
										&& VOLTAR E PEGAR SALDO DE
										&& FECHAMENTO OU ATUAL DO DIA
		SET NEAR OFF
		IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
			=UP_fecha("empresa" ,LFempresa)
			=UP_fecha("saldo" ,LFsaldo)
			=UP_fecha("itemmov" ,LFitemmov)
			IF !EMPTY(LSalias) AND USED(LSalias)
				SELECT &LSalias
			ENDIF
			RETURN(0)
		ELSE
			SKIP -1
		ENDIF


		IF BOF() OR LScod <> itemmov.codigo ;
			OR empresa.empresa <> itemmov.empresa

		   	SELE saldo
		   	SET ORDER TO TAG emp_mes
	 		SEEK STR(empresa.empresa,3)+STR(YEAR(LDdtbase),4)+;
					STR(MONTH(LDdtbase),2)+LSclass
			IF FOUND()
		   		LNqtde    = LNqtde  + saldo.sld_ante
		   		LNcusto   = LNcusto + saldo.vlr_ante
				LNreserva = LNreserva + saldo.reserva
			ELSE
				SELECT  itemmov
				SKIP				&& avanca p/ pegar dat di 1o lancamento
				IF !BOF() AND LScod = itemmov.codigo AND ;
				  		  empresa.empresa = itemmov.empresa)
				   SELE saldo
				   SEEK STR(empresa.empresa,3)+;
		   	   			STR(YEAR(itemmov.data),4)+;
						STR(MONTH(itemmov.data),2)+LSclass
				   IF FOUND()
		  			    LNqtde    = LNqtde + saldo.sld_ante
					    LNcusto   = LNcusto + saldo.vlr_ante
						LNreserva = LNreserva + saldo.reserva
					ELSE
						&& NAO ENCONTROU NENUMA REFERENCIA ANTERIOR
						&& RECOMPOE A SALDO ANTERIOR ANULANDO OPERACAO
					    TMPcusto = 0
						IF itemmov.sld_estq = 0
						    TMPcusto   = itemmov.vlr_estq
						ELSE						
						    TMPcusto   = itemmov.vlr_estq / itemmov.sld_estq
						ENDIF
						DO CASE
							CASE LEFT(itemmov.operacao,1) = "S"
						    	LNqtde  = LNqtde + itemmov.sld_estq + ;
				    						 itemmov.qtde
								LNreserva = LNreserva + itemmov.sld_rese
							CASE LEFT(itemmov.operacao,1) = "E"
						    	LNqtde  = LNqtde + itemmov.sld_estq - ;
				    						 itemmov.qtde
						ENDCASE	
			    	    LNcusto   = LNcusto + (LNqtde * TMPcusto)
				   ENDIF
				ENDIF
			ENDIF
		ELSE
			IF itemmov.sld_estq > 0	
		    	LNqtde    = LNqtde + itemmov.sld_estq
		    	LNcusto   = LNcusto + itemmov.vlr_estq
				LNreserva = LNreserva + itemmov.sld_rese
			ENDIF
		ENDIF


		IF LNqtde = 0	&& EM ITEMMOV O ULTIMO CUSTO FICA REGISTRADO
						&& QDO O ESTOQUE ZERA PORTANTO DEVE SER ZARADO
						&& POIS A ROTINA DEVE REORNAR O CUSTO ESTOCADO
		    LNcusto   = 0
		ENDIF	
		IF LNemp <> 999		&& PESQUISA SO NA EMPRESA INFORMADA
			EXIT				&& EVITA DESLOCAR REGISTRO DE EMPRESA
								&& QUE ESTA SENDO CONTROLADO EM SCGC800
								&& UPregprevisao
		ENDIF
		SELE EMPRESA
		SKIP
	ENDDO
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("saldo" ,LFsaldo)
	=UP_fecha("itemmov" ,LFitemmov)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNqtde)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9KT           EScustoMedio VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:    8   º
*       º Variable:            EScustoMedio                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      5                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _47v10n9kt     &&  EScustoMedio VALID
#REGION 1
RETURN
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Custo M‚dio do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNcusto........: Custo M‚dio do Produto no Momento
	*						(Custo Total / Saldo )
	*
	*------------------------------------------------------------*
	*	CHAMADA............: NEsoma_Saldo
	*
	*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNcusto........: Custo M‚dio do Produto no Momento
	*						(Custo Total / Saldo )
	*------------------------------------------------------------*

FUNCTION EScustoMedio
	PARAMETERS LNemp,LScod,LDdtbase, LShora, LNcusto

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_saldo    , ALS_saldo
	PRIVATE ARQ_itemmov  , ALS_itemmov
	

	PRIVATE TMPcusto

	LNsaldo  	= 0
	LNcusto 	= 0
	LNreserva 	= 0

	IF TYPE("LShora") <> "C" or EMPTY(LShora)
		LShora = "99:99:99"			&&  FORCA PESQUISA NO FINAL DO DIA
	ELSE
		LShora = LEFT(LShora,6)+"60" && FORCA PESQUISA NO PROXIMO MINUTO
	ENDIF


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_saldo  	= NetArqAgain("SALDO")
    ALS_saldo  	= Alias()

    ARQ_itemmov	= NetArqAgain("ITEMMOV")
    ALS_itemmov	= Alias()


	IF (ARQ_grupo+ARQ_empresa+ARQ_saldo+ARQ_itemmov) > 100000
						 && HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*------------------------

	SELECT  &ALS_itemmov
	SET ORDER TO TAG movimento
	SET NEAR ON
	SEEK STR( &ALS_empresa .empresa,3)+LScod+dtos(LDdtbase)+LShora
									&& POSICIONA A FRENTE PARA
									&& VOLTAR E PEGAR SALDO DE
									&& FECHAMENTO OU ATUAL DO DIA
	SET NEAR OFF
	IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ELSE
		SKIP -1
		DO WHILE !BOF() AND &ALS_itemmov .sld_estq = 0 ;
		                AND LScod = &ALS_itemmov .codigo ;
		                AND &ALS_empresa .empresa = &ALS_itemmov .empresa
			SKIP -1
		ENDDO
	ENDIF
	
	IF BOF() OR LScod <> &ALS_itemmov .codigo ;
			 OR &ALS_empresa .empresa <> &ALS_itemmov .empresa

		SELE &ALS_grupo
		SET ORDER TO TAG codigo

	   	SELE &ALS_saldo
	   	SET ORDER TO TAG emp_mes
 		SEEK STR( &ALS_empresa .empresa,3)+STR(YEAR(LDdtbase),4)+;
					STR(MONTH(LDdtbase),2)+ &ALS_grupo .classifica
		IF FOUND()
	   		LNsaldo    = &ALS_saldo .sld_ante
	   		LNcusto    = &ALS_saldo .vlr_ante
		ELSE
			SELECT  &ALS_itemmov
			SKIP		&& avanca p/ pegar data do 1o lancamento

			IF !BOF() AND LScod = &ALS_itemmov .codigo AND ;
				  		  &ALS_empresa .empresa = &ALS_itemmov .empresa)
			   SELE &ALS_saldo
			   SEEK STR( &ALS_empresa .empresa,3)+;
	   	   			STR(YEAR( &ALS_itemmov .data),4)+;
					STR(MONTH( &ALS_itemmov .data),2)+;
					&ALS_grupo .classifica

			   IF FOUND()
	  			    LNsaldo   = &ALS_saldo .sld_ante
				    LNcusto   = &ALS_saldo .vlr_ante
				ELSE
					&& NAO ENCONTROU NENUMA REFERENCIA ANTERIOR
					&& RECOMPOE A SALDO ANTERIOR ANULANDO OPERACAO

				    TMPcusto = 0
					IF &ALS_itemmov .sld_estq = 0
					    TMPcusto   = &ALS_itemmov .vlr_estq
					ELSE						
					    TMPcusto   = &ALS_itemmov .vlr_estq / ;
					                        &ALS_itemmov .sld_estq
					ENDIF

					DO CASE
						CASE LEFT( &ALS_itemmov .operacao,1) = "S"
					    	LNsaldo  = &ALS_itemmov .sld_estq + ;
					    				 &ALS_itemmov .qtde
						CASE LEFT( &ALS_itemmov .operacao,1) = "E"
					    	LNsaldo  = &ALS_itemmov .sld_estq - ;
					    				&ALS_itemmov .qtde
					ENDCASE	
		    	    LNcusto   = LNcusto + (LNsaldo * TMPcusto)
			   ENDIF
			ENDIF
		ENDIF
	ELSE
    	LNsaldo   = &ALS_itemmov .sld_estq
    	LNcusto   = &ALS_itemmov .vlr_estq
	ENDIF

	*-------------------------------------------------------------*
	
	IF LNsaldo = 0	&& EM ITEMMOV O ULTIMO CUSTO FICA REGISTRADO
					&& QDO O ESTOQUE ZERA PORTANTO DEVE SER ZARADO
					&& POIS A ROTINA DEVE REORNAR O CUSTO ESTOCADO
	    LNcusto   = 0
	ELSE
    	LNcusto   = LNcusto / LNsaldo
	ENDIF	


    =up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
	=up_fecha("&ALS_saldo")
    =up_fecha("&ALS_itemmov")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNcusto)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9L7           EScustoEstq VALID                  º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:    9   º
*       º Variable:            EScustoEstq                        º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      6                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _47v10n9l7     &&  EScustoEstq VALID
#REGION 1
RETURN
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Custo M‚dio do Produto
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNcusto........: Custo M‚dio do Produto no Momento
	*						(Custo Total / Saldo )
	*
	*------------------------------------------------------------*
	*	CHAMADA............: NEsoma_Saldo
	*
	*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNcusto........: Custo M‚dio do Produto no Momento
	*						(Custo Total / Saldo )
	*------------------------------------------------------------*

FUNCTION EScustoEstq
	PARAMETERS LNemp,LScod,LDdtbase, LShora

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_saldo    , ALS_saldo
	PRIVATE ARQ_itemmov  , ALS_itemmov
	

	PRIVATE TMPcusto,LNcusto

	LNsaldo  	= 0
	LNcusto 	= 0

	IF TYPE("LShora") <> "C" or EMPTY(LShora)
		LShora = "99:99:99"			&&  FORCA PESQUISA NO FINAL DO DIA
	ELSE
		LShora = LEFT(LShora,6)+"60" && FORCA PESQUISA NO PROXIMO MINUTO
	ENDIF


	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_saldo  	= NetArqAgain("SALDO")
    ALS_saldo  	= Alias()

    ARQ_itemmov	= NetArqAgain("ITEMMOV")
    ALS_itemmov	= Alias()


	IF (ARQ_grupo+ARQ_empresa+ARQ_saldo+ARQ_itemmov) > 100000
						 && HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF

	*------------------------

	SELECT  &ALS_itemmov
	SET ORDER TO TAG movimento
	SET NEAR ON
	SEEK STR( &ALS_empresa .empresa,3)+LScod+dtos(LDdtbase)+LShora
									&& POSICIONA A FRENTE PARA
									&& VOLTAR E PEGAR SALDO DE
									&& FECHAMENTO OU ATUAL DO DIA
	SET NEAR OFF
	IF BOF() AND EOF()       && ITEMMOV ESTA VAZIO
	    =up_fecha("&ALS_empresa")
    	=up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_saldo")
    	=up_fecha("&ALS_itemmov")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ELSE
		SKIP -1
		DO WHILE !BOF() AND &ALS_itemmov .sld_estq = 0 ;
		                AND LScod = &ALS_itemmov .codigo ;
		                AND &ALS_empresa .empresa = &ALS_itemmov .empresa
			SKIP -1
		ENDDO
	ENDIF
	
	IF BOF() OR LScod <> &ALS_itemmov .codigo ;
			 OR &ALS_empresa .empresa <> &ALS_itemmov .empresa

		SELE &ALS_grupo
		SET ORDER TO TAG codigo

	   	SELE &ALS_saldo
	   	SET ORDER TO TAG emp_mes
 		SEEK STR( &ALS_empresa .empresa,3)+STR(YEAR(LDdtbase),4)+;
					STR(MONTH(LDdtbase),2)+ &ALS_grupo .classifica
		IF FOUND()
	   		LNsaldo    = &ALS_saldo .sld_ante
	   		LNcusto    = &ALS_saldo .vlr_ante
		ELSE
			SELECT  &ALS_itemmov
			SKIP		&& avanca p/ pegar data do 1o lancamento

			IF !BOF() AND LScod = &ALS_itemmov .codigo AND ;
				  		  &ALS_empresa .empresa = &ALS_itemmov .empresa)
			   SELE &ALS_saldo
			   SEEK STR( &ALS_empresa .empresa,3)+;
	   	   			STR(YEAR( &ALS_itemmov .data),4)+;
					STR(MONTH( &ALS_itemmov .data),2)+;
					&ALS_grupo .classifica

			   IF FOUND()
	  			    LNsaldo   = &ALS_saldo .sld_ante
				    LNcusto   = &ALS_saldo .vlr_ante
				ELSE
					&& NAO ENCONTROU NENUMA REFERENCIA ANTERIOR
					&& RECOMPOE A SALDO ANTERIOR ANULANDO OPERACAO

				    TMPcusto = 0
					IF &ALS_itemmov .sld_estq = 0
					    TMPcusto   = &ALS_itemmov .vlr_estq
					ELSE						
					    TMPcusto   = &ALS_itemmov .vlr_estq / ;
					                        &ALS_itemmov .sld_estq
					ENDIF

					DO CASE
						CASE LEFT( &ALS_itemmov .operacao,1) = "S"
					    	LNsaldo  = &ALS_itemmov .sld_estq + ;
					    				 &ALS_itemmov .qtde
						CASE LEFT( &ALS_itemmov .operacao,1) = "E"
					    	LNsaldo  = &ALS_itemmov .sld_estq - ;
					    				&ALS_itemmov .qtde
					ENDCASE	
		    	    LNcusto   = LNcusto + (LNsaldo * TMPcusto)
			   ENDIF
			ENDIF
		ENDIF
	ELSE
    	LNsaldo   = &ALS_itemmov .sld_estq
    	LNcusto   = &ALS_itemmov .vlr_estq
	ENDIF

	*-------------------------------------------------------------*
	
	IF LNsaldo = 0	&& EM ITEMMOV O ULTIMO CUSTO FICA REGISTRADO
					&& QDO O ESTOQUE ZERA PORTANTO DEVE SER ZARADO
					&& POIS A ROTINA DEVE REORNAR O CUSTO ESTOCADO
	    LNcusto   = 0
	ENDIF	


    =up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
	=up_fecha("&ALS_saldo")
    =up_fecha("&ALS_itemmov")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LNcusto)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9LJ           EScustoAgregado VALID              º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   10   º
*       º Variable:            EScustoAgregado                    º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      7                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _47v10n9lj     &&  EScustoAgregado VALID
#REGION 1
RETURN

FUNCTION EScustoAgregado
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Informar Custo M‚dio do Produto Recomposto
	*             da Tributa‡Æo que implicara no custo desembolso
	*			  CUSTO + ICMS + RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNvlrdesembolso.: Custo M‚dio do Produto no Momento
	*                       Agregado de Tributos => Custo desembolso
	*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNvlrdesembolso.: Custo M‚dio do Produto no Momento
	*                       Agregado de Tributos => Custo desembolso
	*------------------------------------------------------------*
	PARAMETERS LNemp,LScod,LDdtbase, LShora, LNvlrdesembolso

	=W_DEFPROC("rotinas.spr")

	PRIVATE LNcusto
	PRIVATE LNvlrdesembolso

	*--------------------------------------------------------------------*
	* 	Calculo do Custo M‚dio Agregando Tributos + Valore Que o Tornam
	* a Representa‡Æo do Valor Desembolsado
	*			LNCUSTO + LNicms + LNretido
	*--------------------------------------------------------------------*
	LNcusto = 0

	LNcusto	= EScustoMedio(LNemp,LScod,LDdtbase, LShora, LNcusto)

	*--------------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*

	*** LNvlrdesembolso =  ESAgregarTrbt(LNemp,LScod, LNCusto)

	LNvlrdesembolso =  LNcusto



RETURN(LNvlrdesembolso)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9LK           ESAgregarTrbt VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   11   º
*       º Variable:            ESAgregarTrbt                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      8                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _47v10n9lk     &&  ESAgregarTrbt VALID
#REGION 1
RETURN

FUNCTION ESAgregarTrbt
	PARAMETERS LNemp,LScod, LNCusto

	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*
	* OBJETIVO....: Recompor ao valor informado a
	*             Tributa‡Æo que implicara no custo desembolso
	*			  CUSTO + ICMS + RETIDO
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,SALDO,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*		LScod..........: Codigo do Produto
	*		LDdtbase.......: Data na Qual se quer o saldo
	*		LShora.........: Hora para servir de referencia e
	*						buscar o saldo do momento anterior
	*						quando nao informada assume "99:99:99"
	*						o que forca a leitura do 1o movimento
	*						da proxima data, ou seja, o saldo final
	*						na data informada
	*
	*		LNvlrdesembolso.: Custo M‚dio do Produto no Momento
	*                       Agregado de Tributos => Custo desembolso
	*
	*------------------------------------------------------------*
	*
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNvlrdesembolso.: Custo Informad do Produto
	*                       Agregado de Tributos => Custo desembolso
	*------------------------------------------------------------*

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias

	PRIVATE ARQ_empresa    , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_grfiscal , ALS_grfiscal

	PRIVATE LNipi, LNicms

	PRIVATE LNbaseicms,LNicms,LNretido
	PRIVATE LNvlrdesembolso
	PRIVATE LNaliq_icms


	LNipi		=	0	
	LNicms		=	0



	LSalias			= ALIAS()

    ARQ_empresa = NetArqAgain("EMPRESA")
    ALS_empresa = Alias()

    ARQ_grupo  = NetArqAgain("GRUPO")
    ALS_grupo  = Alias()

    ARQ_grfiscal  = NetArqAgain("GRFISCAL")
    ALS_grfiscal  = Alias()


	IF (ARQ_empresa+ARQ_grfiscal+ARQ_grfiscal) > 100000 ;
							&& HOUVE FALHA DE ABERTURA
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	ENDIF



	*--------------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*


	SELE &ALS_empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	
	SELE &ALS_grupo
	SET ORDER TO TAG codigo

	SEEK LScod
	if not found()
	    =up_fecha("&ALS_empresa")
	    =up_fecha("&ALS_grupo")
	    =up_fecha("&ALS_grfiscal")
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		RETURN(0)
	endif

	SELE &ALS_grfiscal
	SET ORDER TO TAG tributacao
	SEEK &ALS_empresa .estado+LEFT( &ALS_grupo .classifica,5)

	LNaliq_icms		= 	7	&& % ver possibilidade de pasar em parametro
							&& A aliq_icms esta fixa em 7% porque
							&& os fornecedores sao de Sao Paulo
							&& mas deve ser feito um modelo que
							&& atenda a essa necessidade
							
	LNvlrdesembolso	=	LNcusto
	LNaliq_ipi		=	&ALS_grupo .aliq_ipi

	LNiva			=	&ALS_grfiscal .iva
	LNtpmercad		=	&ALS_grfiscal .tp_mercad

	*************************************************************


	LNbaseicms = (LNcusto*100) / (100+LNaliq_ipi-LNaliq_icms)

	LNicms	   = (LNbaseicms * LNaliq_icms)/100  && 2o MEMBRO DA SOMA
	LNipi	   = (LNbaseicms * LNaliq_ipi)/100

	LNretido   = 0


	IF LNtpmercad = 2 AND LNiva > 0
		LNretido   = (LNbaseicms + LNipi) * LNiva * 0.17 - LNicms
	ENDIF

	LNvlrdesembolso  = LNcusto + LNicms + LNretido


	*----------------------------------------------------------------*
	*    Agregar Tributos ao Valor Tomado com Custo
	*--------------------------------------------------------------------*

	*----------------------------------------------------------------*
    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_grupo")
    =up_fecha("&ALS_grfiscal")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN(LNvlrdesembolso)



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9M2           ESprc_compra VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   12   º
*       º Variable:            ESprc_compra                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      9                                  º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _47v10n9m2     &&  ESprc_compra VALID
#REGION 1
RETURN

**********************************************************************
*	Rotina para calculo do preco de compra e venda
*	chamado por SCGC807 SCGC800A E SCGC240A
**********************************************************************
* PARAMETROS
*
*	LNqtde		: Quantidade solicitada
*	LNtab		: Preco de tabela
*	LNdesc		: Desconto total (Normal ou Com Vendor ja aplicado)
*	LNalqipi	: Aliquota de IPI
*   LNalqfrt	: Taxa de Frete
*	LNicmralq	: Aliquota do retido
*	LNiva		: IVA ou MARCKUP
*	LNicmcalq	: Aliquota do ICM de Credito
*
* VARIAVEIS LOCAIS
*	LNliq		: Preco de Tabela Aplicado o Desconto
*	LNipi		: Valor do IPI sobre preco liquido
*	LNcti		: Custo inicial
*	LNfret		: Valor do frete
*	LNadic		: Adicional
*	LNicmc		: Valor ICM de Credito
*	LNicmr		: Valor ICM Retido
*	LNcto		: Custo Total
*	LNpis		: Aliquota do PIS
*	LNcofins	: Aliquota de Cofins
*	LNpcomra 	: Preco de Compra
*	LNpvd		: Preco de Venda
*
*******************************************************************

PROCEDURE ESprc_compra
	PARAMETERS LNqtde,LNtab,LNdesc,LNalqipi,LNalqfrt,LNicmralq,;
			   LNiva, LNicmcalq, LNvendor,LNliq,LNipi,;
			   LNcti,LNfret,LNadic,;
			   LNicmc, LNicmr, LNcto,;
			   LNpis,LNcofins,LNmargem;
			   LNpcompra,LNpvd

	PRIVATE ALL

	STORE 0 TO   LNliq,LNipi,LNcti,LNfret,LNadic,LNicmc,LNicmr,LNcto

	LNliq 		= ((LNtab * (1 - LNdesc/100)) * LNqtde ) * LNvendor
	LNipi 		= LNliq * (LNalqipi /100)
	LNcti 		= (LNliq + LNipi)
	LNfret		= LNcti * (LNalqfrt / 100)

	LNadic		= (LNicmralq /100) * ;
					LNcti * (1+(LNiva /100))

	LNicmc		= LNliq * (LNicmcalq / 100)

	LNicmr		= LNadic - LNicmc
	LNcto 		= (LNcti + LNadic + LNfret) - LNicmc
	LNpcompra 	= LNliq
	LNpvd	 	= LNcto / (1- (LNpis/100 + LNcofins/100 + LNmargem/100 ))

RETURN




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9MB           EScrtcestq VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   13   º
*       º Variable:            EScrtcestq                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      10                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _47v10n9mb     &&  EScrtcestq VALID
#REGION 1
RETURN

**********************************************************************
*******************************************************************

PROCEDURE EScrtcestq
	PARAMETERS PrmDiasAcima
	
	=W_DEFPROC("rotinas.spr")
    PRIVATE LNpeso

	PRIVATE LSalias
	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_prvitstq , ALS_prvitstq

	LSalias			= ALIAS()


    ARQ_empresa  	= NetArqAgain("EMPRESA")
    ALS_empresa  	= Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_prvitstq  	= NetArqAgain("prvitstq")
    ALS_prvitstq  	= Alias()



	SELECT  IT.regional,IT.filial,lj.sigla,IT.codigo,;
		GR.descricao, 	IT.saldo,;
        IT.RVgiromedi AS giromedio, ;
        INT(IIF(IT.RVgiromedi > 0,IT.saldo /IT.RVgiromedi, ;
        			 IIF(IT.saldo>0,9999.00,0.00)))	 as duracao,;
        INT((IT.RVgiromedio*30)) as consumo, ;
        INT(((IT.RVgiromedio*30) - IT.saldo)) as ajuste ;
   	FROM &ALS_empresa LJ,;
   		 &ALS_grupo GR,;
         c:\tmp\prvitstq IT;
   	WHERE       	LJ.empresa = IT.regional ;
   		 and  	GR.codigo  = IT.CODIGO ;
         and 	((IT.saldo > 0 and IT.RVgiromedio = 0) ;
    	 or 	(IT.RVgiromedio > 0));
         and 	IT.filial = 999;
   	ORDER BY  filial, duracao ;
   	into cursor tmp1
   	
	SELECT * FROM tmp1 ;
        WHERE  duracao > PrmDiasAcima  ;
             AND not EMPTY(descricao) ;
	   	ORDER BY  regional,duracao

	REPORT FORM RES1110 TO FILE l:\TMP\PRT0001A.REL

   	=up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
   	=up_fecha("&ALS_prvitstq")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9MI           EScrtcestq VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   14   º
*       º Variable:            EScrtcestq                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      11                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _47v10n9mi     &&  EScrtcestq VALID
#REGION 1
RETURN

**********************************************************************
*******************************************************************

PROCEDURE EScrtcestq
	PARAMETERS PrmDiasAcima
	
	=W_DEFPROC("rotinas.spr")
    PRIVATE LNpeso

	PRIVATE LSalias
	PRIVATE ARQ_empresa  , ALS_empresa
	PRIVATE ARQ_grupo    , ALS_grupo
	PRIVATE ARQ_prvitstq , ALS_prvitstq

	LSalias			= ALIAS()


    ARQ_empresa  	= NetArqAgain("EMPRESA")
    ALS_empresa  	= Alias()

    ARQ_grupo  	= NetArqAgain("GRUPO")
    ALS_grupo  	= Alias()

    ARQ_prvitstq  	= NetArqAgain("prvitstq")
    ALS_prvitstq  	= Alias()



	SELECT  GR.codigo, GR.descricao,;
	 	IT.saldo,;
        IT.RVgiromedi AS giromedio, ;
        INT(IIF(IT.RVgiromedi > 0,IT.saldo /IT.RVgiromedi, ;
        			 IIF(IT.saldo>0,9999.00,0.00)))	 as duracao,;
        INT((IT.RVgiromedio*30)) as consumo, ;
        INT(((IT.RVgiromedio*30) - IT.saldo)) as ajuste ;
   	FROM &ALS_empresa LJ,;
   		 &ALS_grupo GR,;
         c:\tmp\prvitstq IT;
   	WHERE       	LJ.empresa = IT.regional ;
   		 and  	GR.codigo  = IT.CODIGO ;
         and 	((IT.saldo > 0 and IT.RVgiromedio = 0) ;
    	 or 	(IT.RVgiromedio > 0));
         and 	IT.filial = 999;
   	ORDER BY  filial, duracao ;
   	into cursor tmp1
   	
	SELECT * FROM tmp1 ;
        WHERE  duracao > PrmDiasAcima  ;
             AND not EMPTY(descricao) ;
	   	ORDER BY  regional,duracao

	REPORT FORM RES1110 TO FILE l:\TMP\PRT0001A.REL

   	=up_fecha("&ALS_empresa")
   	=up_fecha("&ALS_grupo")
   	=up_fecha("&ALS_prvitstq")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

RETURN




*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9MR           ESextrato VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   15   º
*       º Variable:            ESextrato                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      12                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _47v10n9mr     &&  ESextrato VALID
#REGION 1
RETURN

FUNCTION ESextrato
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	store "" to ARQ_tmp,ALS_tmp



	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*


	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF


	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	ALS_tmp = ALIAS()


	SELECT  data, ;
			left(hora,5) AS HORA,;
			LEFT(IIF(nota <> 0,"NF"+STR(nota,7),;
			    LEFT(TIPO,2)+STR(orcamento,6))+SPACE(10),10) as doc,;
			operacao, ;
			tipo,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			sld_estq  AS SALDO, ;
			sld_rese  AS SALDORES,;
			IIF(sld_estq > 0,vlr_estq / sld_estq,0000.00) AS cst_medio,;
			ULgetvlrUni(OPERACAO,EMPRESA,FAVORECIDO,;
			    ORCAMENTO,ORDEM,vlrvenda,QTDE) as VALOR_UNI, ;
			(icms_subs/qtde) AS ICMS_SUBS, ;
			(custo_ind/qtde) AS CUSTO_IND,;
			ESOrigDest(favorecido) AS ORIGEM,;
			IIF(negociacao = 2,"S"," ") AS vdcasada,;
			LEFT(RTRIM(DESCRICAO)+"-"+RTRIM(DESCRCOMPL)+"-"+INFO_COMPL,100) AS descricao;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)


	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			DOC			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			SALDO    	:H="SALDO"	:P="@r ######9" :R,;
			SALDORES 	:H="RES"	:P="@r ####9" :R, ;
			CST_MEDIO	:H="CST.M"	:P="@r ####9.99" :R, ;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			icms_subs	:H="R$.Sbst"	:P="@r ####9.99" :R, ;
			custo_ind	:H="Cust.Ind"	:P="@r ####9.99" :R, ;
			ORIGEM		:H="O/D"    :P="AAA" :R, ;
			vdcasada    :H="ENCOMENDA" :R,;
			descricao   :H="DESCRICAO";
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
    =up_fecha("TMPEXT")

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF
	
RETURN


FUNCTION ULgetvlrUni
PARAMETERS PrmOperacao, PrmEmp, PrmFavorecido, ;
              PrmBoletim, PrmOrdem,PrmVlrVenda,PrmQtde

	PRIVATE LNVALOR_UNI

	LNVALOR_UNI = 00000000
	if LEFT(PrmOperacao,1) = "E"
		=W_DEFPROC("notaite.spr")
		LNVALOR_UNI=;
		  IEGetCusto(PrmEmp, PrmFavorecido, PrmBoletim, PrmOrdem) / PrmQtde
	ELSE
		LNVALOR_UNI= PrmVlrVenda / PrmQtde
	ENDIF

RETURN(LNVALOR_UNI)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9N2           ESimpext VALID                     º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   16   º
*       º Variable:            ESimpext                           º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      13                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _47v10n9n2     &&  ESimpext VALID
#REGION 1
RETURN


PROCEDURE ESimpext
PARAMETERS PrmRel
	DO UPPreImpressao WITH  PrmRel, .F. , .F., .F.
	CLEAR TYPEAHEAD
RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9N3           ESextRess VALID                    º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   17   º
*       º Variable:            ESextRess                          º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      14                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _47v10n9n3     &&  ESextRess VALID
#REGION 1
RETURN

FUNCTION ESextRess
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	store "" to ARQ_tmp,ALS_tmp


	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*


	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF


	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
        FOR  LEFT(OPERACAO,1) $ "E/S" ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo ;
		      AND DATA   <= PrmDtFim
		
	SELE 0
	USE &ARQ_tmp
	ALS_tmp = ALIAS()

	SELECT  data, ;
			dtfat AS dataemi,;
			operacao,;
			tipo,;
			IIF(nota <> 0,"NF"+STR(nota,7),LEFT(TIPO,2)+STR(orcamento,6)) as doc,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			IIF(qtde > 0,vlrvenda / Qtde,vlrvenda)   AS VALOR_UNI, ;
			(vlripi * 100 / vlrvenda) AS Aliqipi,;
			iva,;
			ESOrigDest(favorecido) AS ORIGEM;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)

	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext WITH "REL407A"

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ EXTRATO APOIO AO RESSARCIMENTO MANUAL ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
		BROWSE  FIELDS ;
				DATA		:H="DT.ENT" :R,;
				DATAEMI		:H="DT.EMI" :R,;
				QTDE     	:H="QTDE"	:P="@r ####9" :R,;
				DOC			:H="DOC" :R,;
				VALOR_UNI	:H="R$.UNI"	:P="@r #,##9.99" :R, ;
				ALIQIPI    	:H="IPI"	:P="@r ##" :R,;
				IVA     	:H="IVA"	:P="@r 9.99" :R,;
				TIPO     	:H="TIPO"	  :R,;
				OPERACAO   	:H="OPERACAO"  :R;
				TITLE "[ EXTRATO P/ RESSARCIMENTO ]";
				COLOR SCHEME 10 ;
				  NODELETE NOAPPEND NORMAL  NOEDIT;
			    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	
	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF

RETURN



*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9NJ           ESOrigDest VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   18   º
*       º Variable:            ESOrigDest                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      15                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _47v10n9nj     &&  ESOrigDest VALID
#REGION 1
RETURN

FUNCTION ESOrigDest
PARAMETERS PrmCGC
	PRIVATE LSalias,LSsigla
	LSalias = Alias()
	IF EMPTY(PrmCGC)
		RETURN("   ")
	ENDIF

	SELECT &ALS_empresa
	SET ORDER TO TAG CGC
	SEEK PrmCGC
	IF FOUND()
		LSsigla = &ALS_empresa .sigla
	else
		LSsigla = "   "
	ENDIF	
	SELE &LSalias
RETURN(LSsigla)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9NS           ESextEntradas VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   19   º
*       º Variable:            ESextEntradas                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      16                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _47v10n9ns     &&  ESextEntradas VALID
#REGION 1
RETURN

FUNCTION ESextEntradas
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	PRIVATE LNsaldo
	
	store "" to ARQ_tmp,ALS_tmp
	LNsaldo = 0


	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*


	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF


	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		FOR     LEFT(operacao,1) = "E" ;
		    AND CH_OPERA = "1" ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	go top
	ALS_tmp = ALIAS()
	LNsaldo = 0
	LNctr   = 0

	SELECT  data, ;
			left(hora,5) AS HORA,;
			IIF(nota <> 0,"NF"+STR(nota,7),LEFT(TIPO,2)+STR(orcamento,6)) as doc,;
			operacao, ;
			tipo,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			ULESextrEnt(qtde,movestq,operacao) AS SALDO, ;
			sld_rese  AS SALDORES,;
			IIF(sld_estq > 0,vlr_estq / sld_estq,0) AS cst_medio,;
			IIF(qtde > 0,vlrvenda / Qtde,vlrvenda) as VALOR_UNI, ;
			ESOrigDest(favorecido) AS ORIGEM,;
			IIF(negociacao = 2,"S"," ") AS vdcasada;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			DOC			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			SALDO    	:H="SALDO"	:P="@r ####9" :R,;
			SALDORES 	:H="RES"	:P="@r ####9" :R, ;
			CST_MEDIO	:H="CST.M"	:P="@r ###9.99" :R, ;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			ORIGEM		:H="O/D"    :P="AAA" :R, ;
			vdcasada    :H="ENCOMENDA" :R;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	
	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF

RETURN


FUNCTION ULESextrEnt
PARAMETERS PrmQtde,PrmMovestq,PrmOperacao
	PRIVATE LnRetorno
	IF LNctr   = 0
		LNctr = 1
		RETURN(000000)
	ENDIF

	DO CASE
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "E"
			 LNsaldo = LNsaldo + PrmQtde
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "S"
			 LNsaldo = LNsaldo - PrmQtde
	ENDCASE	
	LnRetorno	 = LNsaldo
RETURN(LnRetorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9O3           ESextTrasf VALID                   º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   20   º
*       º Variable:            ESextTrasf                         º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      17                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*
FUNCTION _47v10n9o3     &&  ESextTrasf VALID
#REGION 1
RETURN

FUNCTION ESextTrasf
PARAMETERS PrmEmpresa,PrmCodigo,PrmDtIni,PrmDtFim


	PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente

	PrmCodigo = LEFT(PrmCodigo+space(11),11)
	PRIVATE LSAlias
	PRIVATE ARQ_Empresa,ALS_Empresa,ARQ_Itemmov,ALS_Itemmov
	PRIVATE ARQ_Tmp,ALS_Tmp
	PRIVATE LNsaldo
	
	store "" to ARQ_tmp,ALS_tmp
	LNsaldo = 0


	*-------------------------------------------------------------*
	*   Se o extrato solicitado for de empresa diferente da corrente
	* especificado no ambiente o estrato busca dados na CENTRAL
	*-------------------------------------------------------------*

	LSbase = wp_dirdat
	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = wp_dircentral
	ENDIF

	LSAlias = Alias()

    ARQ_Empresa     = NetArqAgain("EMPRESA")
    ALS_Empresa     = Alias()

    ARQ_Itemmov     = NetArqAgain("ITEMMOV")
    ALS_Itemmov     = Alias()

	ARQ_tmp=UPnometmp("EXT")

	SELE &ALS_Itemmov
	SET ORDER TO TAG MOVIMENTO

	SET NEAR ON
	SEEK STR(PrmEmpresa,3)+PrmCodigo+DTOS(PrmDtIni)
	SET NEAR OFF

	IF PrmEmpresa <> empresa OR PrmCodigo <> codigo
		SKIP -1
	ENDIF

	WAIT WINDOW "Aguarde. Gerando Arq. Temporario" NOWAIT

	COPY TO &ARQ_tmp WITH CDX ;
		FOR     LEFT(operacao,1) = "E" ;
		    AND CH_OPERA = "2" ;
		WHILE EMPRESA = PrmEmpresa ;
		      AND CODIGO = PrmCodigo;
		      AND DATA   <= PrmDtFim
	SELE 0
	USE &ARQ_tmp
	go top
	ALS_tmp = ALIAS()
	LNsaldo = 0
	LNctr   = 0

	SELECT  data, ;
			left(hora,5) AS HORA,;
			IIF(nota <> 0,"NF"+STR(nota,7),LEFT(TIPO,2)+STR(orcamento,6)) as doc,;
			operacao, ;
			tipo,;
			IIF(LEFT(OPERACAO,1)="S",qtde*(-1),qtde) AS QTDE,;
			ULESextrEnt(qtde,movestq,operacao) AS SALDO, ;
			sld_rese  AS SALDORES,;
			IIF(sld_estq > 0,vlr_estq / sld_estq,0) AS cst_medio,;
			IIF(qtde > 0,vlrvenda / Qtde,vlrvenda) as VALOR_UNI, ;
			ESOrigDest(favorecido) AS ORIGEM,;
			IIF(negociacao = 2,"S"," ") AS vdcasada;
	FROM &ALS_tmp ;
	ORDER BY DATA,HORA ;
	INTO CURSOR EXTRATO

	KEYBOARD CHR(13)
	=INKEY(1)



	*---------------------------------------------------*
	*---------------------------------------------------*
	SET SYSMENU ON
	PUSH MENU _MSYSMENU
	SET SYSMENU TO _MWINDOW, _MWI_ZOOM,_MWI_MOVE, _MEDIT, _MED_FIND, ;
					_MED_FINDA
	HIDE MENU _MSYSMENU
	ON KEY LABEL F10    KEYBOARD "{CTRL-F10}"
	ON KEY LABEL "PGDN"
	ON KEY LABEL ESCAPE
	ON KEY LABEL P      DO ESimpext

	DEFINE WINDOW OUTPUT ;
		FROM 8, 0 ;
		TO 22,79 ;
		TITLE  "[ MOVIMENTACAO DO PRODUTO ]";
  	FLOAT  STYLE "SCREEN";
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 10

	SET ESCAPE ON
	SET CENTUR OFF
	BROWSE  FIELDS ;
			DATA		:H="DATA" :R,;
			HORA		:H="HORA"  :R,;
			DOC			:H="DOC" :R,;
			OPERACAO 	:H="OPER" :R,;
			TIPO	 	:H="TIP" :R,;
			QTDE     	:H="QTDE"	:P="@r ####9" :R,;
			SALDO    	:H="SALDO"	:P="@r ####9" :R,;
			SALDORES 	:H="RES"	:P="@r ####9" :R, ;
			CST_MEDIO	:H="CST.M"	:P="@r ###9.99" :R, ;
			VALOR_UNI	:H="R$.UNI"	:P="@r ####9.99" :R, ;
			ORIGEM		:H="O/D"    :P="AAA" :R, ;
			vdcasada    :H="ENCOMENDA" :R;
			COLOR SCHEME 10 ;
		    NODELETE NOAPPEND NORMAL  NOEDIT;
		    WINDOW OUTPUT
	RELEASE WINDOW OUTPUT
	CLEAR TYPEAHEAD
	SET ESCAPE OFF
	SET CENTUR ON
	POP MENU _MSYSMENU
	SET SYSMENU OFF
	ON KEY LABEL P
	POP KEY	

	*--------------------------------------------------*
	*--------------------------------------------------*

    =up_fecha("&ALS_empresa")
    =up_fecha("&ALS_itemmov")
    =up_fecha("EXTRATO")
    =up_fecha("&ALS_Tmp")
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF

	IF  PrmEmpresa <> wp_cod_loja
		wp_dirdat = LSbase
	ENDIF
	
RETURN


FUNCTION ULESextrEnt
PARAMETERS PrmQtde,PrmMovestq,PrmOperacao
	PRIVATE LnRetorno
	IF LNctr   = 0
		LNctr = 1
		RETURN(000000)
	ENDIF

	DO CASE
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "E"
			 LNsaldo = LNsaldo + PrmQtde
		CASE PrmMovestq = "S" AND LEFT(PrmOperacao,1) = "S"
			 LNsaldo = LNsaldo - PrmQtde
	ENDCASE	
	LnRetorno	 = LNsaldo
RETURN(LnRetorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9OF           ESVld_Produto VALID                º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   21   º
*       º Variable:            ESVld_Produto                      º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      18                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _47v10n9of     &&  ESVld_Produto VALID
#REGION 1
RETURN
PROCEDURE ESVld_Produto
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Pesquisar Produtos em uma Lista
	*
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: GRUPO
	*------------------------------------------------------------*
	* PARAMETROS..:
	*             LScodigo : Codigo do Produto - Pode Ser Utiliza
	*                  para posicionamento parcial
	*------------------------------------------------------------*
	* CHAMADAS.............:
	*------------------------------------------------------------*
	PARAMETERS LScodigo

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_grupo, ALS_grupo
  	PRIVATE LFretorno

    LSalias      = Alias()
    ARQ_grupo    = NetArqAgain("GRUPO")
    ALS_grupo    = Alias()

	SELE &ALS_grupo
	SET ORDER TO TAG codigo
	SEEK ALLTRIM(LScodigo)
	IF !FOUND()
	   LFretorno= .f.
	ELSE
	   LFretorno= .T.
	ENDIF

	=UP_fecha(ALS_GRUPO)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)


*       ÖÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ·
*       º                                                         º
*       º _47V10N9ON           ESGet_Origem VALID                 º
*       º                                                         º
*       º Function Origin:                                        º
*       º                                                         º
*       º From Platform:       MS-DOS                             º
*       º From Screen:         ESTOQUE,     Record Number:   22   º
*       º Variable:            ESGet_Origem                       º
*       º Called By:           VALID Clause                       º
*       º Object Type:         Push Button                        º
*       º Snippet Number:      19                                 º
*       º                                                         º
*       ÓÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ½
*

FUNCTION _47v10n9on     &&  ESGet_Origem VALID
#REGION 1
RETURN
FUNCTION ESGet_Origem
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	*------------------------------------------------------------*
	PARAMETERS LScodigo,PrmOrigem

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	PRIVATE ARQ_grupo, ALS_grupo
  	PRIVATE LFretorno

    LSalias      = Alias()
    ARQ_grupo    = NetArqAgain("GRUPO")
    ALS_grupo    = Alias()

	SELE &ALS_grupo
	SET ORDER TO TAG codigo
	SEEK ALLTRIM(LScodigo)
	IF FOUND()
	   PrmOrigem= 	&Als_Grupo .origem
	   LFretorno= 	.t.
	ELSE
	   PrmOrigem= 	0
	   LFretorno= .f.
	ENDIF

	=UP_fecha(ALS_GRUPO)
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN(LFretorno)
