*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ 07/16/15             SCT0315.SPR               16:23:35 ╨
*       ╨                                                         ╨
*       гддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╤
*       ╨                                                         ╨
*       ╨ Author's Name                                           ╨
*       ╨                                                         ╨
*       ╨ Copyright (c) 2015 Company Name                         ╨
*       ╨ Address                                                 ╨
*       ╨ City,     Zip                                           ╨
*       ╨                                                         ╨
*       ╨ Description:                                            ╨
*       ╨ This program was automatically generated by GENSCRN.    ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨          SCT0315/MS-DOS Setup Code - SECTION 1          ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [?????]                           		 *
	*------------------------------------------------------------*
	* OBJETIVO....:GERAR  ARQ. SINTEGRA
	*------------------------------------------------------------*
	* COMENTARIO..:
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: EMPRESA,NOTA,NOTAENT,ITEMMOV
	*------------------------------------------------------------*
	* PARAMETROS..:
	*------------------------------------------------------------*
	* RETORNO.....:
	*------------------------------------------------------------*
	*<<<<<<<<<<<<<<<<<<<<<<<         >>>>>>>>>>>>>>>>>>>>>>>>>>>>*
	*------------------------------------------------------------*
	* Ambiente
	*------------------------------------------------------------*
	=W_DEFPROC("ROTINAS.spr")
	ON KEY LABEL ESCAPE

	*------------------------------------------------------------*
	* Variaveis  Controlando Arquivos
	*------------------------------------------------------------*
	PRIVATE LSalias
	PRIVATE LFempresa,LFnota,LFnotaent,LFitemmov,LFfornece,LFgrupo
	PRIVATE LFgrfiscal
	PRIVATE LFtabnbm,LFclasnbm,LFmapaecf,LFtipooper
	PRIVATE LSponteiro

	LSalias			= ALIAS()
	LFempresa		= NetArq("empresa")
	LFnota			= NetArq("nota")
	LFnotaent		= NetArq("notaent")
	LFitemmov		= NetArq("itemmov")
	LFfornece		= NetArq("fornece")
	LFgrupo  		= NetArq("grupo")
	LFgrfiscal 		= NetArq("grfiscal")
	LFTabNbm  		= NetArq("tabnbm")
	LFClasNbm 		= NetArq("clasnbm")
	LFMapaEcf 		= NetArq("mapaecf")
	LFTipooper		= NetArq("tipooper")
	LFCliente		= NetArq("clientes")
	
	IF (LFempresa+LFnota+LFnotaent+LFitemmov+;
		LFfornece+LFgrupo+LFgrfiscal+LFtabnbm+LFclasnbm+LFMapaEcf+;
		LFtipooper+LFcliente) > 100000
		*-----------------------------------------------------*
		* FALHA DE ABERTURA DE TABELAS
		*-----------------------------------------------------*
		DO ULfecha
		RETURN(0)
	ENDIF
	*------------------------------------------------------------*
	* Variaveis  abientais com influencia na biblioteca
	*   deve-se adequar a biblioteca para recebelas via parametro
	*   e nao pelo ambiente com esta sendo feito
	*------------------------------------------------------------*
	PRIVATE wp_ref_local
	PRIVATE isediting
	wp_ref_local 	=  .f.     && NAO POSSUI CONTROLE DE REFRESH LOCAL
	m.isediting		=	.F.

	*------------------------------------------------------------*
	* Variaveis  de uso Especico no Formulario
	*------------------------------------------------------------*
	PRIVATE LFAnSaida,LFStSaida,LFResCfoS,LFResUfS,LNPagina,LFcfosintegra
	PRIVATE LFAnEntrada,LFStEntrada,LFResCfoE,LFResUfE
	PRIVATE LFIpiEntrada,LFIpiSaida,LFIpiProd
	PRIVATE LFCr_ICMS,LFconv_3199
	PRIVATE LFICMProd
	PRIVATE LFModelo
	PRIVATE LFModDoc
	PRIVATE LFDataDoc

	STORE .F. TO LFAnSaida,LFStSaida,LFResCfoS,LFResUfS,LFcfosintegra
	STORE 0   TO LNpagina
	STORE .F. TO LFAnEntrada,LFStEntrada,LFResCfoE,LFResUfE
	STORE .F. TO LFIpiEntrada,LFIpiSaida,LFIpiProd
	STORE .F. TO LFCr_ICMS,LFCRpc_ICMS,LFconv_3199
	STORE .F. TO LFICMProd
	STORE .F. TO LFModelo
	STORE .F. TO LFModDoc
	STORE .F. TO LFDataDoc
	

	LSponteiro = "|"

#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨                MS-DOS Window definitions                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

IF NOT WEXIST("sct0315") ;
	OR UPPER(WTITLE("SCT0315")) == "SCT0315.PJX" ;
	OR UPPER(WTITLE("SCT0315")) == "SCT0315.SCX" ;
	OR UPPER(WTITLE("SCT0315")) == "SCT0315.MNX" ;
	OR UPPER(WTITLE("SCT0315")) == "SCT0315.PRG" ;
	OR UPPER(WTITLE("SCT0315")) == "SCT0315.FRX" ;
	OR UPPER(WTITLE("SCT0315")) == "SCT0315.QPR"
	DEFINE WINDOW sct0315 ;
		FROM INT((SROW()-18)/2),INT((SCOL()-68)/2) ;
		TO INT((SROW()-18)/2)+17,INT((SCOL()-68)/2)+67 ;
		TITLE "GERAR ARQUIVO SINTEGRA" ;
		FOOTER "CT0315" ;
		FLOAT ;
		NOCLOSE ;
		SHADOW ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 1
ENDIF


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨          SCT0315/MS-DOS Setup Code - SECTION 2          ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              SCT0315/MS-DOS Screen Layout               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
IF WVISIBLE("sct0315")
	ACTIVATE WINDOW sct0315 SAME
ELSE
	ACTIVATE WINDOW sct0315 NOSHOW
ENDIF
@ 0,0 TO 17,67 ;
	COLOR SCHEME 23
@ 1,67 TO 16,67 ;
	COLOR SCHEME 24
@ 17,1 TO 17,66 ;
	COLOR SCHEME 24
@ 0,67 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 17,67 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 2,2 TO 4,15 ;
	COLOR SCHEME 23
@ 4,3 TO 4,14 ;
	COLOR SCHEME 24
@ 4,15 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 3,15 SAY "Ё" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 2,15 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 2,3 SAY "[Filial]" ;
	SIZE 1,8, 0
@ 3,6 SAY "-" ;
	SIZE 1,1, 0
@ 2,17 TO 4,41 ;
	COLOR SCHEME 23
@ 4,18 TO 4,40 ;
	COLOR SCHEME 24
@ 4,41 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 3,41 SAY "Ё" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 2,41 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 2,19 SAY "[ Periodo ]" ;
	SIZE 1,11, 0
@ 0,3 SAY "[ Escrita Fiscal - LIVRO DE SAIDA ]" ;
	SIZE 1,35, 0
@ 0,57 SAY "[CT0315]" ;
	SIZE 1,8, 0
@ 5,2 TO 7,30 ;
	COLOR SCHEME 23
@ 7,3 TO 7,29 ;
	COLOR SCHEME 24
@ 7,30 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 6,30 SAY "Ё" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 5,30 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 6,3 SAY "Filtrar Estado Destino" ;
	SIZE 1,22, 0
@ 5,34 TO 14,59 ;
	COLOR SCHEME 23
@ 14,35 TO 14,58 ;
	COLOR SCHEME 24
@ 14,59 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 5,59 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 6,59 TO 13,59 ;
	COLOR SCHEME 24
@ 5,35 SAY "[ Saidas ]" ;
	SIZE 1,10, 0
@ 2,43 TO 4,65 ;
	COLOR SCHEME 23
@ 4,44 TO 4,64 ;
	COLOR SCHEME 24
@ 4,65 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 3,65 SAY "Ё" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 2,65 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 3,51 SAY "/" ;
	SIZE 1,1, 0
@ 2,44 SAY "[Livro / Pg.Inicial]" ;
	SIZE 1,20, 0
@ 3,3 GET m.empresa ;
	SIZE 1,3 ;
	DEFAULT 0 ;
	PICTURE "999" ;
	WHEN _4ee0z4wmh() ;
	VALID _4ee0z4wmi() ;
	ERROR "Empresa Nao Localizada. "
@ 3,7 GET m.nome_emp ;
	SIZE 1,7 ;
	DEFAULT " " ;
	PICTURE "@!K" ;
	WHEN _4ee0z4wmj()
@ 3,18 GET m.dt_inicio ;
	SIZE 1,10 ;
	DEFAULT {  /  /  } ;
	WHEN _4ee0z4wmk() ;
	VALID _4ee0z4wnm()
@ 3,30 GET m.dt_fim ;
	SIZE 1,10 ;
	DEFAULT {  /  /  } ;
	WHEN isediting ;
	VALID m.dt_fim >= m.dt_inicio ;
	MESSAGE "Data Final deve ser maior ou igual a Inicial"
@ 3,48 GET LNlivro ;
	SIZE 1,2 ;
	DEFAULT 0 ;
	PICTURE "99" ;
	WHEN _4ee0z4wns() ;
	VALID LNlivro > 0 ;
	ERROR "Numero deve ser > 0 "
@ 3,53 GET LNpagina ;
	SIZE 1,4 ;
	DEFAULT 0 ;
	PICTURE "9999" ;
	WHEN _4ee0z4wnx() ;
	VALID LNpagina > 0 ;
	ERROR "Numero deve ser > 0 "
@ 6,27 GET LSuf_destino ;
	SIZE 1,2 ;
	DEFAULT " " ;
	WHEN _4ee0z4wny()
@ 6,35 GET LFAnSaida ;
	PICTURE "@*C \<A-Livro Analitico" ;
	SIZE 1,21 ;
	DEFAULT 0 ;
	WHEN _4ee0z4wnz() ;
	VALID _4ee0z4wo0()
@ 7,38 GET LFDataDoc ;
	PICTURE "@*C \<1-Por Data Doc" ;
	SIZE 1,18 ;
	DEFAULT 0 ;
	WHEN _4ee0z4wo1() ;
	VALID _4ee0z4wo2()
@ 8,38 GET LFModDoc ;
	PICTURE "@*C \<2-Por Modelo Doc" ;
	SIZE 1,20 ;
	DEFAULT 0 ;
	WHEN _4ee0z4wo3() ;
	VALID _4ee0z4wp4()
@ 10,35 GET LFStSaida ;
	PICTURE "@*C \<B-Livro Sintetico" ;
	SIZE 1,21 ;
	DEFAULT 0 ;
	WHEN _4ee0z4wpa() ;
	VALID _4ee0z4wpg()
@ 11,35 GET LFResCfoS ;
	PICTURE "@*C \<C-Resumo C.F.O." ;
	SIZE 1,19 ;
	DEFAULT 0 ;
	WHEN isediting ;
	VALID _4ee0z4wph()
@ 12,35 GET LFResUfS ;
	PICTURE "@*C \<D-Resumo Estado" ;
	SIZE 1,19 ;
	DEFAULT 0 ;
	WHEN isediting ;
	VALID _4ee0z4wpi()
@ 13,35 GET LFcfosintegra ;
	PICTURE "@*C \<E-CFO X SINTEGRA" ;
	SIZE 1,20 ;
	DEFAULT 0 ;
	WHEN isediting ;
	VALID _4ee0z4wpj()
@ 15,35 GET LFModelo ;
	PICTURE "@*C \<F-Modelo Encadernacao" ;
	SIZE 1,25 ;
	DEFAULT 0 ;
	WHEN _4ee0z4wpk()
@ 17,5 GET m.imp_btn ;
	PICTURE "@*HN \<Processar" ;
	SIZE 1,11,1 ;
	DEFAULT 1 ;
	WHEN _4ee0z4wpl() ;
	VALID _4ee0z4wqk() ;
	DISABLE
@ 17,48 GET m.edit_btn ;
	PICTURE "@*HN \<Edita" ;
	SIZE 1,7,1 ;
	DEFAULT 1 ;
	WHEN _4ee0z4wqw() ;
	VALID _4ee0z4wr2() ;
	MESSAGE 'Permite a alteracao de dados do registro corrente'
@ 17,58 GET m.canc_btn ;
	PICTURE "@*HN \<Saida" ;
	SIZE 1,7,1 ;
	DEFAULT 1 ;
	VALID _4ee0z4wr3()

IF NOT WVISIBLE("sct0315")
	ACTIVATE WINDOW sct0315
ENDIF

READ CYCLE ;
	ACTIVATE READACT() ;
	DEACTIVATE READDEAC()

RELEASE WINDOW sct0315

#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨               SCT0315/MS-DOS Cleanup Code               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
DO ULfecha
RETURN

**************************************


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨   SCT0315/MS-DOS Supporting Procedures and Functions    ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
PROCEDURE ULfecha
	=UP_fecha("empresa" ,LFempresa)
	=UP_fecha("nota" ,LFnota)
	=UP_fecha("notaent" ,LFnotaent)
	=UP_fecha("itemmov" ,LFitemmov)
	=UP_fecha("fornece" ,LFfornece)
	=UP_fecha("grupo" ,LFgrupo)
	=UP_fecha("grfiscal" ,LFgrfiscal)
	=UP_fecha("tabnbm" ,LFTabNbm)
	=UP_fecha("grupo" ,LFClasNbm)
	=UP_fecha("mapaecf" ,LFMapaEcf)
	=UP_fecha("clientes" ,LFcliente)
	=UP_fecha("tipooper" ,LFtipooper)

	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	ON KEY LABEL ESCAPE
	SET FORMAT TO
RETURN


*-----------------------------------------------------------*
PROCEDURE ULImpLivros
PARAMETERS PrmEmp,PrmDtIni,PrmDtFin,;
		 LFAnSaida, ;
		 LFStSaida, ;
		 LFResCfo,  ;
		 LFResUf, ;
		 LNpagina,;
		 LSuf_destino

	LFLdireciona  = .F. && Ativa PRTSETUP para direcionar impressao DEF(.T.)
	LFLagrega 	  = .F. && Agrega o ??.REL em ??.AGR			    DEF(.F.)
	LFLfimagrega  = .F. && Qdo. Estiver agregando => encerra        DEF(.F.)
	**********************************************************************
	m.inscricao 	= empresa.inscricao
	LDdtimpr  		=  PrmDtIni	&& VAI ORIENTAR A IMPRESSAO MES A MES
	LFcontinua 		= .t.  			&& CAPTURA O VALOR DE LFsegue
	*********************>>> RELATORIO GERAL <<<*********************
	LNpagina = LNpagina - 1   && DESCONTA O VLR. INICIAL DE _PAGENO
	*   DETERMINA O PERIODO DE MES PARA IMPRESSAO ********

	LNEmp = PrmEmp
	LDDtInicio = PrmDtIni
	LDDtFim = PrmDtFin

	LDper_ini = LDDtInicio
	LDper_fim = LDDtFim



	IF LFAnSaida
		DO ULSaiImprel WITH  "ANALITICO",;
							(PrmEmp),(PrmDtIni),(PrmDtFin), LNpagina
	ENDIF


	IF LFStSaida
		DO ULSaiImprel WITH  "SINTETICO",;
							(PrmEmp),(PrmDtIni),(PrmDtFin), LNpagina
	ENDIF

	**************************>>> RESUMO POR CFO
	IF LFResCfo or LFcfosintegra
		DO ULSaiImpcfo WITH  (PrmEmp),(PrmDtIni),(PrmDtFin), LNpagina
	ENDIF
	**************************>>> RESUMO POR UF
	IF LFResUf
		DO ULSaiImpuf WITH  (PrmEmp),(PrmDtIni),(PrmDtFin), LNpagina
	ENDIF
	*-----------------------------

RETURN


*---------------------------------------------------------------*
*  ROTINA IMPRESSAO RELATORIO ANALITICO OU SITETICO
*---------------------------------------------------------------*

PROCEDURE ULSaiImprel
PARAMETERS PrmTipoRel,LNemp, LDTInicio, LDTFim, LNpagina
PRIVATE TMP_ALIAS


	DO CASE
		CASE PrmTipoRel = "ANALITICO"
			TMP_ALIAS = ULUnirAnaliticoLivros()
		CASE PrmTipoRel = "SINTETICO"
			TMP_ALIAS = ULUnirSinteticoLivros()
	ENDCASE

	SELECT &TMP_ALIAS
	GO TOP
	LNctrnota = nota 	&&CONTADOR PRA VERRIFICAR NUMERACAO DE NF
	*******************
	*---->   (INICIALIZACAO DO CONTROLE DE STATUS IMPRESSAO)
	*******************	
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO
	LFsegue = .t.
	LNregistro = RECNO()
    COUNT TO   LNimpressao
	LNimpressos = 0
	GO LNregistro
	*******************
	*---->   (COMPLETADO PREPARACAO DO CONTROLE DE STATUS IMPRESSAO)
	*******************	
	**************************>>> REGISTRO DE SAIDAS
	LF_fim  = .f.
	
	
	IF LFModelo = .t.
	    LSrel = "REL220"      && relatorio padrao p/ impressoras ex: epson
	ELSE

		DO CASE
			CASE LFModDoc = .t.
			    LSrel = "REL220H1"  && POR MODELO

			CASE LFDataDoc = .t.
			    LSrel = "REL220H2"  && POR MODELO
			
			OTHERWISE
			    LSrel = "REL220H"  && relatorio padrao p/ imprs ex: epson
		ENDCASE
    ENDIF
    LSorienta = " WHILE  LFsegue "
	SET TALK OFF

	DO UPimpressao WITH	(LFLdireciona), (LFLagrega), (LFLfimagrega)

	LFcontinua = LFsegue
	************
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	LNpagina = LNpagina + _PAGENO - 1   && DAR SEQU.AO N. PAGINA


	*---------------------------------------------------------*
    =up_fecha(TMP_ALIAS)

	IF USED("LIals_TMPLIVRO")
		SELECT &als_TMPLIVRO
		USE
	ENDIF

RETURN

*----------------------------------------------------------------*
*  VEREIFICAR VALORES DA NOTA NO RELATORIO DE SAIDAS
*----------------------------------------------------------------*
*	FLG_NROS.......: .F. => NAO VERIFICA NUMERACAO (REL220_I)
*                    .T. => VERIFICA NUMERACAO (REL220)
*----------------------------------------------------------------*

FUNCTION ULvervlr
	PARAMETERS LNnota,STATUS,OPERACAO,TOTAL_NOTA,BASE_ICMS,;
			 BASE_ISENT,VLR_IPI,BASE_OUTR,BASE_ISS,BASE_SUBS,FLG_NROS
	*-------------------------------------------------------------*
	* VERIFICACAO DE NUMERACAO DE NOTA
	*-------------------------------------------------------------*
	

*	IF FLG_NROS AND LNnota < 1000000		&& NAO E CUPOM
*		DO WHILE LNctrnota < LNnota
*		   LSnfs = STR(LNctrnota,7)
*		   DO OBJ_MENS.SPR WITH  "Falta Nota Numero : "+LSnfs
*		   LNctrnota = LNctrnota + 1						
*		ENDDO
*		LNctrnota = LNctrnota + 1						
*	ENDIF
	*-------------------------------------------------------------*
	* VERIFICACAO DE VALOR DE NOTA
	*-------------------------------------------------------------*

	IF TOTAL_NOTA <> BASE_ICMS+BASE_ISENT+VLR_IPI+;
					  BASE_OUTR+BASE_ISS+icms_subs
	   LSnfs = STR(LNnota,7)
       WAIT WINDOW "Erro no Fechamento da Nota  Numero : "+LSnfs NOWAIT
	
	ENDIF
RETURN(.T.)



FUNCTION ULini
	LF_fim  = .f.
RETURN(" ")

FUNCTION ULfim
	LF_fim  = .t.
RETURN(" ")


PROCEDURE ULSaiImpuf   && RESUMO POR ESTADO
PARAMETERS LNemp, LDTInicio, LDTFim, LNpagina


	TMP_ALIAS = ULUnirUFResumoLivros()


	SELECT &TMP_ALIAS
	GO TOP
	*******************
	*---->   (INICIALIZACAO DO CONTROLE DE STATUS IMPRESSAO)
	*******************	
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO
	LFsegue = .t.
	LNregistro = RECNO()
    COUNT TO   LNimpressao
	LNimpressos = 0
	GO LNregistro
	*******************
	*---->   (COMPLETADO PREPARACAO DO CONTROLE DE STATUS IMPRESSAO)
	*******************	
	**************************>>> REGISTRO DE SAIDAS

    LSrel = "REL220B"      && relatorio padrao p/ impressoras ex: epson
    LSorienta =  " WHILE  LFsegue "
	DO UPimpressao WITH 	(LFLdireciona), (LFLagrega), (LFLfimagrega)
	LFcontinua = LFsegue

	************
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	LNpagina = LNpagina + _PAGENO - 1   && DAR SEQU.AO N. PAGINA


	*---------------------------------------------------------*
    =up_fecha(TMP_ALIAS)

	IF USED("LIals_TMPLIVRO")
		SELECT &als_TMPLIVRO
		USE
	ENDIF

RETURN



PROCEDURE ULSaiImpcfo   	&& RESUMO POR CFO
PARAMETERS LNemp, LDTInicio, LDTFim, LNpagina


	TMP_ALIAS = ULUnirCFOResumoLivros()


	SELECT &TMP_ALIAS
	GO TOP
	*******************
	*---->   (INICIALIZACAO DO CONTROLE DE STATUS IMPRESSAO)
	*******************	
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO
	LFsegue = .t.
	LNregistro = RECNO()
    COUNT TO   LNimpressao
	LNimpressos = 0
	GO LNregistro
	*******************
	*---->   (COMPLETADO PREPARACAO DO CONTROLE DE STATUS IMPRESSAO)
	*******************	
	**************************>>> REGISTRO DE SAIDAS

    LSrel = "REL220A"      && relatorio padrao p/ impressoras ex: epson
    LSorienta =  " WHILE  LFsegue "
	DO UPimpressao WITH 	(LFLdireciona), (LFLagrega), (LFLfimagrega)
	LFcontinua = LFsegue

	************
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	LNpagina = LNpagina + _PAGENO - 1   && DAR SEQU.AO N. PAGINA


	*---------------------------------------------------------*
    =up_fecha(TMP_ALIAS)

	IF USED("LIals_TMPLIVRO")
		SELECT &als_TMPLIVRO
		USE
	ENDIF

RETURN





*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WMH           m.empresa WHEN                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   41   ╨
*       ╨ Variable:            m.empresa                          ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      1                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wmh     &&  m.empresa WHEN
#REGION 1
ON KEY LABEL ENTER
ON KEY LABEL ESCAPE	KEYBOARD "{END}"
IF LASTKEY() = 15 AND !(isediting)
	KEYBOARD "{ESCAPE}"
ENDIF
RETURN(isediting)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WMI           m.empresa VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   41   ╨
*       ╨ Variable:            m.empresa                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      2                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wmi     &&  m.empresa VALID
#REGION 1
SET PROCEDURE TO EMPRESA.spr
RETURN(UVerifEmp(m.empresa,m.nome_emp,LASTKEY()))




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WMJ           m.nome_emp WHEN                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   42   ╨
*       ╨ Variable:            m.nome_emp                         ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      3                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wmj     &&  m.nome_emp WHEN
#REGION 1
SHOW GET m.nome_emp
ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
RETURN(.f.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WMK           m.dt_inicio WHEN                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   43   ╨
*       ╨ Variable:            m.dt_inicio                        ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      4                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wmk     &&  m.dt_inicio WHEN
#REGION 1
IF isediting
	ON KEY LABEL ESCAPE	KEYBOARD "{END}"
ENDIF
RETURN(isediting)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WNM           m.dt_inicio VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   43   ╨
*       ╨ Variable:            m.dt_inicio                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      5                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wnm     &&  m.dt_inicio VALID
#REGION 1
m.dt_fim = m.dt_inicio
SHOW GET m.dt_fim
ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
RETURN (.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WNS           LNlivro WHEN                       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   45   ╨
*       ╨ Variable:            LNlivro                            ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      6                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wns     &&  LNlivro WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(isediting)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WNX           LNpagina WHEN                      ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   46   ╨
*       ╨ Variable:            LNpagina                           ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      7                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wnx     &&  LNpagina WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(isediting)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WNY           LSuf_destino WHEN                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   47   ╨
*       ╨ Variable:            LSuf_destino                       ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      8                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wny     &&  LSuf_destino WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(isediting)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WNZ           LFAnSaida WHEN                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   48   ╨
*       ╨ Variable:            LFAnSaida                          ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Check Box                          ╨
*       ╨ Snippet Number:      9                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wnz     &&  LFAnSaida WHEN
#REGION 1
ON KEY LABEL ENTER  KEYBOARD "{RIGHTARROW}"
RETURN(isediting)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WO0           LFAnSaida VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   48   ╨
*       ╨ Variable:            LFAnSaida                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Check Box                          ╨
*       ╨ Snippet Number:      10                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wo0     &&  LFAnSaida VALID
#REGION 1
	IF LFAnSaida
		LFStSaida = .f.
		SHOW GET LFStSaida
	ENDIF
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WO1           LFDataDoc WHEN                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   49   ╨
*       ╨ Variable:            LFDataDoc                          ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Check Box                          ╨
*       ╨ Snippet Number:      11                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wo1     &&  LFDataDoc WHEN
#REGION 1
ON KEY LABEL ENTER  KEYBOARD "{RIGHTARROW}"
RETURN(isediting)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WO2           LFDataDoc VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   49   ╨
*       ╨ Variable:            LFDataDoc                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Check Box                          ╨
*       ╨ Snippet Number:      12                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wo2     &&  LFDataDoc VALID
#REGION 1
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WO3           LFModDoc WHEN                      ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   50   ╨
*       ╨ Variable:            LFModDoc                           ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Check Box                          ╨
*       ╨ Snippet Number:      13                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wo3     &&  LFModDoc WHEN
#REGION 1
ON KEY LABEL ENTER  KEYBOARD "{RIGHTARROW}"
RETURN(isediting)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WP4           LFModDoc VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   50   ╨
*       ╨ Variable:            LFModDoc                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Check Box                          ╨
*       ╨ Snippet Number:      14                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wp4     &&  LFModDoc VALID
#REGION 1
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WPA           LFStSaida WHEN                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   51   ╨
*       ╨ Variable:            LFStSaida                          ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Check Box                          ╨
*       ╨ Snippet Number:      15                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wpa     &&  LFStSaida WHEN
#REGION 1
ON KEY LABEL ENTER  KEYBOARD "{RIGHTARROW}"
RETURN(isediting)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WPG           LFStSaida VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   51   ╨
*       ╨ Variable:            LFStSaida                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Check Box                          ╨
*       ╨ Snippet Number:      16                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wpg     &&  LFStSaida VALID
#REGION 1
IF LFStSaida
	LFAnSaida = .f.
	SHOW GET LFAnSaida
ENDIF
RETURN(.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WPH           LFResCfoS VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   52   ╨
*       ╨ Variable:            LFResCfoS                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Check Box                          ╨
*       ╨ Snippet Number:      17                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wph     &&  LFResCfoS VALID
#REGION 1
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WPI           LFResUfS VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   53   ╨
*       ╨ Variable:            LFResUfS                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Check Box                          ╨
*       ╨ Snippet Number:      18                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wpi     &&  LFResUfS VALID
#REGION 1
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WPJ           LFcfosintegra VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   54   ╨
*       ╨ Variable:            LFcfosintegra                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Check Box                          ╨
*       ╨ Snippet Number:      19                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wpj     &&  LFcfosintegra VALID
#REGION 1
RETURN(.T.)



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WPK           LFModelo WHEN                      ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   55   ╨
*       ╨ Variable:            LFModelo                           ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Check Box                          ╨
*       ╨ Snippet Number:      20                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wpk     &&  LFModelo WHEN
#REGION 1
ON KEY LABEL ENTER  KEYBOARD "{RIGHTARROW}"
RETURN(isediting)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WPL           m.imp_btn WHEN                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   56   ╨
*       ╨ Variable:            m.imp_btn                          ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      21                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wpl     &&  m.imp_btn WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WQK           m.imp_btn VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   56   ╨
*       ╨ Variable:            m.imp_btn                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      22                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _4ee0z4wqk     &&  m.imp_btn VALID
#REGION 1
   DO ULgerarBdLivros  WITH 	(m.empresa),(m.dt_inicio),(m.dt_fim)
 		
   DO ULMontarLivros
 		
 		
   DO ULImpLivros  WITH 	(m.empresa),(m.dt_inicio),(m.dt_fim),;
 		(LFAnSaida), ;
		(LFStSaida), ;
		(LFResCfoS), ;
		(LFResUfS), ;
		LNpagina,;
		(LSuf_destino)

RETURN




PROCEDURE ULgerarBdLivros
PARAMETERS PrmEmp,PrmDtIni,PrmDtFin, LFAnSaida, ;
				LFStSaida, LFResCfo, LFResUf, LNpagina, LSuf_destino

	*--------------------------------------------------------------*


	=W_DEfPROC("SCT0310.SPR")
	do  ULDefTmpArq with  PrmEmp,PrmDtIni,PrmDtFin

	ACTIVATE WINDOW SCT0315
	SHOW WINDOW SCT0315 TOP
	CLEAR

	SET TALK ON
	*----------------------------------------------------------*
	*    GERAR ARQ. RESUMO CONTENDO SO AS NOTAS DO PERIODO E DA
	* EMPRESA SELECIONADA PARA ACELERAR OS OUTROS SELECTs
	*----------------------------------------------------------*

	=W_DEfPROC("SCT0310.SPR")
	DO ULSelNFs with PrmEmp,PrmDtIni,PrmDtFin


	*----------------------------------------------------------*
	*  SELECIONANDO REGISTROS DE ENTRADA
	*----------------------------------------------------------*
	=W_DEfPROC("SCT0310.SPR")
	DO ULSelNFe with PrmEmp,PrmDtIni,PrmDtFin

	*----------------------------------------------------------*
	*  MONTA CURSOR DE TIPO DE OPERACAO
	*----------------------------------------------------------*
	=W_DEfPROC("SCT0310.SPR")
	DO ULSelTipo
	*----------------------------------------------------------*


	*----------------------------------------------------------*
	SET TALK off
	*---------------------------------------------------------------*
	=W_DEfPROC("SCT0310.SPR")
	do  ULFchTmpArq
	SHOW WINDOW SCT0315 TOP

RETURN

PROCEDURE ULMontarLivros

	*-------------------------------------------------------------------*
	*	NOTAS DE SAIDA
	*-------------------------------------------------------------------*
	=W_DEfPROC("SCT0310.SPR")
	DO ULLvrSda50
	*---------------------------------------------------------------------*

   	SELE LIVROSAI
	GO TOP

	*-------------------------------------------------------------------*
	*	CUPONS
	*-------------------------------------------------------------------*
	=W_DEfPROC("SCT0310.SPR")
	DO ULLvrAnlCpm
	*-------------------------------------------------------------------*
   	SELE LIVROCPA
	GO TOP


	*-------------------------------------------------------------------*
	*	CUPONS - RESUMO POR DIA (SINTETICO)
	*-------------------------------------------------------------------*
	=W_DEfPROC("SCT0310.SPR")
	DO ULLvrStcoCpm
	*-------------------------------------------------------------------*
   	SELE LCPMSINT
	GO TOP


	*-------------------------------------------------------------------*
	*	COPIAS CUPONS
	*-------------------------------------------------------------------*
*	=W_DEfPROC("SCT0310.SPR")
*	DO ULLvrCopCpm
*	*-------------------------------------------------------------------*
*  	SELE LIVROCOP
*	GO TOP
	*----------------------------------------------------------------*




RETURN	

FUNCTION ULUnirAnaliticoLivros

	*-------------------------------------------------------------------*
	*	NOTAS SAIDA
	*-------------------------------------------------------------------*

   	SELE LIVROSAI
	DBF_SAI = DBF()

	*-------------------------------------------------------------------*
	*	CUPONS - Analitico
	*-------------------------------------------------------------------*

   	SELE LIVROCPA
	DBF_CPM = DBF()

	*-------------------------------------------------------------------*
	*	COPIAS CUPONS
	*-------------------------------------------------------------------*

*  	SELE LIVROCOP
*	DBF_COP = DBF()


	*-------------------------------------------------------------------*

    =W_DEFPROC("rotinas.spr")
	ARQ_tmp=UPnometmp("EXT")

	SELE LIVROSAI
	COPY  TO  &ARQ_tmp
	
    =up_fecha("TMP_LIVRO")
	SELE 0
	USE &ARQ_tmp ALIAS TMP_LIVRO EXCL
	APPEND FROM &DBF_CPM
*	APPEND FROM &DBF_COP
	*----------------------------------------------------------------*

    =up_fecha("ANLTICO")

	DO CASE
		CASE LFModDoc = .T.  &&  ORDENAR POR MODELO E DOC
			SELECT  ULDefMod_Doc(empresa,nota,serie,tipo) AS MOD_DOC,;
				ULDefNro_Doc(empresa,nota) AS NOTA,;
				SERIE, DATA, UF, TIPO,;
	        	FAVORECIDO, SET_CFO AS CFO, ;
		        STATUS, ;
		        IIF(TIPO="CPM","C",IIF(TIPO="ENT","E","S")) AS OPERACAO,;
				CUPOM, ;	
				TOTSERVICO, BASE_ISS,  ALIQ_ISS, VLR_ISS, ;
				BASE_ICMS,	ALIQ_ICMS, VLR_ICMS, ;
				BASE_SBBRT, BASE_SUBS, ICMS_SUBS, ;
				BASE_ISENT, BASE_OUTR, ;
				BASE_ISIPI, BASE_IPI,  VLR_IPI, ;
				TOTPRODUTO, ;
				VLRFRETE, VLRSEGURO, VLRDESPES, ;
				TOTAL_NOTA ;	
			FROM &ARQ_tmp ;
			ORDER BY MOD_DOC,NOTA,DATA ;
		    INTO CURSOR ANLTICO


		CASE LFDataDoc = .T.  &&  ORDENAR POR MODELO E DOC
			SELECT  ULDefMod_Doc(empresa,nota,serie,tipo) AS MOD_DOC,;
				ULDefNro_Doc(empresa,nota) AS NOTA,;
				SERIE, DATA, UF, TIPO,;
	        	FAVORECIDO, SET_CFO AS CFO, ;
		        STATUS, ;
		        IIF(TIPO="CPM","C",IIF(TIPO="ENT","E","S")) AS OPERACAO,;
				CUPOM, ;	
				TOTSERVICO, BASE_ISS,  ALIQ_ISS, VLR_ISS, ;
				BASE_ICMS,	ALIQ_ICMS, VLR_ICMS, ;
				BASE_SBBRT, BASE_SUBS, ICMS_SUBS, ;
				BASE_ISENT, BASE_OUTR, ;
				BASE_ISIPI, BASE_IPI,  VLR_IPI, ;
				TOTPRODUTO, ;
				VLRFRETE, VLRSEGURO, VLRDESPES, ;
				TOTAL_NOTA ;	
			FROM &ARQ_tmp ;
			ORDER BY DATA,MOD_DOC,NOTA ;
		    INTO CURSOR ANLTICO


		OTHERWISE
		
			SELECT  ULDefMod_Doc(empresa,nota,serie,tipo) AS MOD_DOC,;
				ULDefNro_Doc(empresa,nota) AS NOTA,;
				SERIE, DATA, UF, TIPO,;
	        	FAVORECIDO, SET_CFO AS CFO, ;
	    	    STATUS, ;
		        IIF(TIPO="CPM","C",IIF(TIPO="ENT","E","S")) AS OPERACAO,;
				CUPOM, ;	
				TOTSERVICO, BASE_ISS,  ALIQ_ISS, VLR_ISS, ;
				BASE_ICMS,	ALIQ_ICMS, VLR_ICMS, ;
				BASE_SBBRT, BASE_SUBS, ICMS_SUBS, ;
				BASE_ISENT, BASE_OUTR, ;
				BASE_ISIPI, BASE_IPI,  VLR_IPI, ;
				TOTPRODUTO, ;
				VLRFRETE, VLRSEGURO, VLRDESPES, ;
				TOTAL_NOTA ;	
			FROM &ARQ_tmp ;
			ORDER BY DATA,MOD_DOC,NOTA ;
		    INTO CURSOR ANLTICO
	ENDCASE
    =up_fecha("&ARQ_tmp")

RETURN("ANLTICO")


FUNCTION ULDefMod_Doc
   PARAMETERS ;
	 PrmEmpresa,;
	 PrmNota,;
     PrmSerie,;
	 PrmTipo

   Private LSmod_doc
   =W_DEFPROC("NOTA.SPR")
   LSmod_doc = NFDefMod_Doc(PrmEmpresa,;
							 PrmNota,;
						     PrmSerie,;
							 PrmTipo)
RETURN(LSmod_doc)							

FUNCTION ULDefNro_Doc
   PARAMETERS ;
	 PrmEmpresa,;
	 PrmNota


	PRIVATE LSresult

	DO CASE
		CASE  PrmNota >= 2000000 AND PrmNota <= 3000000
			PrmNota = PrmNota-2000000

		CASE  PrmNota >= 3000000 AND PrmNota <= 4000000
			PrmNota = PrmNota-3000000

		CASE  PrmNota >= 4000000 AND PrmNota <= 5000000
			PrmNota = PrmNota-4000000
	ENDCASE

RETURN(PrmNota)


FUNCTION ULUnirSinteticoLivros

	*-------------------------------------------------------------------*
	*	NOTAS SAIDA
	*-------------------------------------------------------------------*

   	SELE LIVROSAI
	DBF_SAI = DBF()

	*-------------------------------------------------------------------*
	*	CUPONS - sintetico
	*-------------------------------------------------------------------*

   	SELE LCPMSINT
	DBF_CPM = DBF()

	*-------------------------------------------------------------------*
	*	COPIAS CUPONS
	*-------------------------------------------------------------------*

*  	SELE LIVROCOP
*	DBF_COP = DBF()


	*-------------------------------------------------------------------*

    =W_DEFPROC("rotinas.spr")
	ARQ_tmp=UPnometmp("EXT")

	SELE LIVROSAI
	COPY  TO  &ARQ_tmp
	
    =up_fecha("TMP_LIVRO")
	SELE 0
	USE &ARQ_tmp ALIAS TMP_LIVRO
	APPEND FROM &DBF_CPM
	APPEND FROM &DBF_COP
	*----------------------------------------------------------------*

    =up_fecha("SINTETC")

	SELECT  NOTA, SERIE, DATA, UF,TIPO, ;
			ULDefMod_Doc(empresa,nota,serie,tipo) AS MOD_DOC,;
	        FAVORECIDO, SET_CFO AS CFO, ;
	        STATUS, ;
	        IIF(TIPO="CPM","C",IIF(TIPO="ENT","E","S")) AS OPERACAO,;
			CUPOM, ;	
			TOTSERVICO, BASE_ISS,  ALIQ_ISS, VLR_ISS, ;
			BASE_ICMS,	ALIQ_ICMS, VLR_ICMS, ;
			BASE_SBBRT, BASE_SUBS, ICMS_SUBS, ;
			BASE_ISENT, BASE_OUTR, ;
			BASE_ISIPI, BASE_IPI,  VLR_IPI, ;
			TOTPRODUTO, ;
			VLRFRETE, VLRSEGURO, VLRDESPES, ;
			TOTAL_NOTA ;	
	FROM &ARQ_tmp ;
	ORDER BY DATA,MOD_DOC,NOTA ;
    INTO CURSOR SINTETC


    =up_fecha("&ARQ_tmp")

RETURN("SINTETC")



FUNCTION ULUnirUFResumoLivros

PRIVATE TMP_ALIAS

	TMP_ALIAS = ULUnirAnaliticoLivros()
	*-------------------------------------------------------------------*
    =up_fecha("RESU_UF")
	SELECT  UF,  ;
			SUM(TOTSERVICO) AS TOTSERVICO, ;
			SUM(BASE_ISS) 	AS BASE_ISS,;
			SUM(VLR_ISS) 	AS VLR_ISS, ;
			SUM(BASE_ICMS) 	AS BASE_ICMS,;
			SUM(VLR_ICMS) 	AS VLR_ICMS, ;
			SUM(BASE_SBBRT) AS BASE_SBBRT,;
			SUM(BASE_SUBS) 	AS BASE_SUBS, ;
			SUM(ICMS_SUBS)  AS ICMS_SUBS,;
			SUM(BASE_ISENT) AS BASE_ISENT,;
			SUM(BASE_OUTR)  AS BASE_OUTR, ;
			SUM(BASE_ISIPI) AS BASE_ISIPI,;
			SUM(BASE_IPI)   AS BASE_IPI,  ;
			SUM(VLR_IPI)    AS VLR_IPI,   ;
			SUM(TOTPRODUTO) AS TOTPRODUTO, ;
			SUM(VLRFRETE)   AS VLRFRETE,  ;
			SUM(VLRSEGURO)  AS VLRSEGURO,;
			SUM(VLRDESPES)  AS VLRDESPES, ;
			SUM(TOTAL_NOTA) AS TOTAL_NOTA ;	
    FROM &TMP_ALIAS ;
	WHERE       status = 1 ;
		   AND  operacao  = "S";
    GROUP BY UF;
    ORDER BY UF;
    INTO CURSOR RESU_UF


RETURN("RESU_UF")



FUNCTION ULUnirCFOResumoLivros

PRIVATE TMP_ALIAS

	TMP_ALIAS = ULUnirAnaliticoLivros()
	*-------------------------------------------------------------------*
    =up_fecha("RESU_CFO")
	SELECT  CFO,  ;
			SUM(TOTSERVICO) AS TOTSERVICO, ;
			SUM(BASE_ISS) 	AS BASE_ISS,;
			SUM(VLR_ISS) 	AS VLR_ISS, ;
			SUM(BASE_ICMS) 	AS BASE_ICMS,;
			SUM(VLR_ICMS) 	AS VLR_ICMS, ;
			SUM(BASE_SBBRT) AS BASE_SBBRT,;
			SUM(BASE_SUBS) 	AS BASE_SUBS, ;
			SUM(ICMS_SUBS)  AS ICMS_SUBS,;
			SUM(BASE_ISENT) AS BASE_ISENT,;
			SUM(BASE_OUTR)  AS BASE_OUTR, ;
			SUM(BASE_ISIPI) AS BASE_ISIPI,;
			SUM(BASE_IPI)   AS BASE_IPI,  ;
			SUM(VLR_IPI)    AS VLR_IPI,   ;
			SUM(TOTPRODUTO) AS TOTPRODUTO, ;
			SUM(VLRFRETE)   AS VLRFRETE,  ;
			SUM(VLRSEGURO)  AS VLRSEGURO,;
			SUM(VLRDESPES)  AS VLRDESPES, ;
			SUM(TOTAL_NOTA) AS TOTAL_NOTA ;	
    FROM &TMP_ALIAS ;
	WHERE       status = 1 ;
		   AND  operacao  = "S";
    GROUP BY CFO;
    ORDER BY CFO;
    INTO CURSOR RESU_CFO


RETURN("RESU_CFO")


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WQW           m.edit_btn WHEN                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   57   ╨
*       ╨ Variable:            m.edit_btn                         ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      23                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _4ee0z4wqw     &&  m.edit_btn WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WR2           m.edit_btn VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   57   ╨
*       ╨ Variable:            m.edit_btn                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      24                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wr2     &&  m.edit_btn VALID
#REGION 1
=btn_val1('EDIT')
RETURN

PROCEDURE BTN_VAL1
	PARAMETER tecla, m.chv_ler, m.chv_compara, m.chv_brow
	LN_prxobj = _CUROBJ
	ON KEY LABEL ENTER
    DO CASE
		CASE tecla = "EDIT" AND !isediting   && INICIA EDICAO
			LFArqSaida = .F.       && ARQ TMP DEVE SER GERADO AO PROCESSAR
			SHOW GET edit_btn,1 PROMPT "\<Ok"
			SHOW GET m.imp_btn  DISABLE
			isediting  = .t.
			_CUROBJ = 1	
		    ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
			ON KEY LABEL END DO BTN_VAL1 WITH 'DELETE'
		CASE tecla = "EDIT" AND isediting     && CONFIRMA EDICAO
			SHOW GET edit_btn,1 PROMPT "\<Edita"
			isediting = .f.
			_CUROBJ = 1	
			IF  m.dt_fim < m.dt_inicio
				SHOW GET m.imp_btn DISABLE
			ELSE
				SHOW GET m.imp_btn  ENABLE
			ENDIF
		    ON KEY LABEL ESCAPE
			ON KEY LABEL END
		CASE tecla = "DELETE" AND isediting     && CANCELA EDICAO
			SHOW GET edit_btn,1 PROMPT "\<Edita"
			isediting = .f.
			_CUROBJ = 1	
			SHOW GET m.imp_btn  DISABLE
		    ON KEY LABEL ESCAPE
			ON KEY LABEL END
	ENDCASE
RETURN

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4EE0Z4WR3           m.canc_btn VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SCT0315,     Record Number:   58   ╨
*       ╨ Variable:            m.canc_btn                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      25                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4ee0z4wr3     &&  m.canc_btn VALID
#REGION 1
ON KEY LABEL ENTER
CLEAR GETS
CLEAR READ
isediting = .f.
RETURN .T.