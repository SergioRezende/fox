*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є 04/10/2006           SCT0310A.SPR              17:22:21 є
*       є                                                         є
*       ЗДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД¶
*       є                                                         є
*       є Author's Name                                           є
*       є                                                         є
*       є Copyright (c) 2006 Company Name                         є
*       є Address                                                 є
*       є City,     Zip                                           є
*       є                                                         є
*       є Description:                                            є
*       є This program was automatically generated by GENSCRN.    є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є                MS-DOS Window definitions                є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

IF NOT WEXIST("sct0310a") ;
	OR UPPER(WTITLE("SCT0310A")) == "SCT0310A.PJX" ;
	OR UPPER(WTITLE("SCT0310A")) == "SCT0310A.SCX" ;
	OR UPPER(WTITLE("SCT0310A")) == "SCT0310A.MNX" ;
	OR UPPER(WTITLE("SCT0310A")) == "SCT0310A.PRG" ;
	OR UPPER(WTITLE("SCT0310A")) == "SCT0310A.FRX" ;
	OR UPPER(WTITLE("SCT0310A")) == "SCT0310A.QPR"
	DEFINE WINDOW sct0310a ;
		FROM INT((SROW()-35)/2),INT((SCOL()-68)/2) ;
		TO INT((SROW()-35)/2)+34,INT((SCOL()-68)/2)+67 ;
		TITLE "UNITE -GERAR ARQUIVO SINTEGRA" ;
		FOOTER "CT0310A" ;
		FLOAT ;
		NOCLOSE ;
		SHADOW ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 1
ENDIF


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є              SCT0310A/MS-DOS Screen Layout              є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

#REGION 1
IF WVISIBLE("sct0310a")
	ACTIVATE WINDOW sct0310a SAME
ELSE
	ACTIVATE WINDOW sct0310a NOSHOW
ENDIF
@ 0,57 SAY "[CT0310U]" ;
	SIZE 1,9, 0
@ 0,3 SAY "[ Unit - Gera Arquivo Para SINTEGRA ]" ;
	SIZE 1,37, 0
@ 2,53 SAY "|" ;
	SIZE 1,1, 0
@ 3,53 SAY "|" ;
	SIZE 1,1, 0
@ 4,53 SAY "|" ;
	SIZE 1,1, 0
@ 5,53 SAY "|" ;
	SIZE 1,1, 0
@ 6,53 SAY "|" ;
	SIZE 1,1, 0
@ 12,54 SAY "--------------" ;
	SIZE 1,14, 0
@ 1,53 SAY "*--Auxiliares-*" ;
	SIZE 1,15, 0
@ 31,3 SAY "-----------------------------------------------------------" ;
	SIZE 1,59, 0
@ 7,53 SAY "|" ;
	SIZE 1,1, 0
@ 9,53 SAY "|" ;
	SIZE 1,1, 0
@ 8,53 SAY "|" ;
	SIZE 1,1, 0
@ 10,53 SAY "|" ;
	SIZE 1,1, 0
@ 11,53 SAY "|" ;
	SIZE 1,1, 0
@ 2,55 GET ULtp_Mercad ;
	PICTURE "@*HN ULtp_Mercad" ;
	SIZE 1,13,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118h6p()
@ 3,55 GET ULIPIProd ;
	PICTURE "@*HN ULIPIProd" ;
	SIZE 1,11,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118h8e()
@ 4,0 GET ULgera_SIN ;
	PICTURE "@*HN ULgera_SIN" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118h8k()
@ 4,31 GET resumo ;
	PICTURE "@*HN \<Resumo CFO SINTEGRA" ;
	SIZE 1,21,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118h8t()
@ 4,55 GET ULALIQICMS ;
	PICTURE "@*HN ULALIQICMS" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118h8u()
@ 5,2 GET ULDefTmpArq ;
	PICTURE "@*HN ULDefTmpArq - Mapeia arquivos Temporarios" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118h8v()
@ 5,55 GET ULIVA ;
	PICTURE "@*HN ULIVA" ;
	SIZE 1,7,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hag()
@ 6,2 GET ULFchTmpArq ;
	PICTURE "@*HN ULFchTmpArq - Fecha arquivos Temporarios" ;
	SIZE 1,43,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hal()
@ 6,55 GET ULdefCfo ;
	PICTURE "@*HN ULdefCfo" ;
	SIZE 1,10,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118has()
@ 7,2 GET ULSelNFs ;
	PICTURE "@*HN ULSelNFs - Seleciona dados de NFS" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hat()
@ 7,55 GET ULCFPS ;
	PICTURE "@*HN ULCFPS" ;
	SIZE 1,8,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hau()
@ 8,2 GET ULSelNFe ;
	PICTURE "@*HN ULSelNFe - Seleciona dados de NFe " ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hbi()
@ 8,55 GET ULCST_IPI ;
	PICTURE "@*HN ULCST_IPI" ;
	SIZE 1,11,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hbu()
@ 9,2 GET ULSelTipo ;
	PICTURE "@*HN ULSelTipo - Monta cursor com Tipo de Operacao" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hc1()
@ 9,55 GET ULCST_ISS ;
	PICTURE "@*HN ULCST_ISS" ;
	SIZE 1,11,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hc6()
@ 10,0 GET ULProcCVN6902 ;
	PICTURE "@*HN ULProcCVN6902" ;
	SIZE 1,15,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hcd()
@ 10,55 GET ULGenero ;
	PICTURE "@*HN ULGenero" ;
	SIZE 1,10,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hce()
@ 11,0 GET UL69R_10 ;
	PICTURE "@*HN UL69R_10 - Descricao de Finalidade" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hcf()
@ 11,55 GET m.val_btn ;
	PICTURE "@*HN \<Validar" ;
	SIZE 1,9,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hd1() ;
	DISABLE
@ 12,0 GET UL69R_11 ;
	PICTURE "@*HN UL69R_11 - Dados Complementares do Informante" ;
	SIZE 1,47,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hd2()
@ 13,0 GET UL69R_50 ;
	PICTURE "@*HN UL69R_50 - NFs Mod 01 ou 01-A// NFe Mod 03 Etc" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hd3()
@ 14,0 GET UL69R_51 ;
	PICTURE "@*HN UL69R_51 - para contribuinte IPI --> IMPLEMENTAR" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hfc() ;
	DISABLE
@ 15,0 GET UL69R_53 ;
	PICTURE "@*HN UL69R_53 - Substituicao Tributaria" ;
	SIZE 1,36,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hfd()
@ 16,0 GET UL69R_54 ;
	PICTURE "@*HN UL69R_54 - Itens - 54 - ENTRADA E SAIDA" ;
	SIZE 1,41,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hgc()
@ 17,6 GET ULitem_6975 ;
	PICTURE "@*HN ULitem_6975-Grava Itens Comerc. Relacionados no TIPO 75" ;
	SIZE 1,57,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hgd()
@ 18,0 GET UL69R_60 ;
	PICTURE "@*HN UL69R_60 - Cupons" ;
	SIZE 1,19,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hhq()
@ 19,0 GET UL69R_70 ;
	PICTURE "@*HN UL69R_70 - Conhecimento de Tranporte" ;
	SIZE 1,38,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hhr()
@ 20,0 GET UL69R_74 ;
	PICTURE "@*HN UL69R_74 - Inventario de Produtos" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hj5()
@ 21,0 GET UL69R_75 ;
	PICTURE "@*HN UL69R_75 - Cadastro de Produtos" ;
	SIZE 1,33,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hjn()
@ 22,0 GET UL69R_90 ;
	PICTURE "@*HN UL69R_90 - *  TOTALIZADORES  - 90" ;
	SIZE 1,35,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hjo()
@ 24,3 GET ULLvrSda50 ;
	PICTURE "@*HN ULLvrSda50 -Monta Cursor LIVRO SAIDAS-(LIVROSAI)" ;
	SIZE 1,50,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hjp()
@ 25,7 GET ULItmSda54 ;
	PICTURE "@*HN ULItmSda54 -Monta Cursor ITENS SAIDAS(ILIVROSAI) " ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hkw()
@ 26,3 GET ULLvrEnt50 ;
	PICTURE "@*HN ULLvrEnt50 -Monta Cursor LIVRO ENTRADAS(LIVROENT)" ;
	SIZE 1,51,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hl6()
@ 27,7 GET ULItmEnt54 ;
	PICTURE "@*HN ULItmEnt54 -Monta Cursor ITENS LIVRO ENTRADAS(ILIVROENT)" ;
	SIZE 1,58,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hl7()
@ 28,3 GET ULLvrSda53 ;
	PICTURE "@*HN ULLvrSda53 -Monta Cursor LIVRO SAIDAS Subst.Trib.(SLIVROSAI)" ;
	SIZE 1,62,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hl8()
@ 29,3 GET ULLvrEnt53 ;
	PICTURE "@*HN ULLvrEnt53 -Monta Cursor LIVRO ENTRADAS Subst.Trib.(SLIVROENT)" ;
	SIZE 1,64,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hm9()
@ 30,3 GET UL69R_60 ;
	PICTURE "@*HN ULLvrCpm -Monta Cursor LIVRO CUPONS(LIVROCPM)" ;
	SIZE 1,48,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hmj()
@ 3,18 GET ULArqItens ;
	PICTURE "@*HN ULArqItens" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	WHEN .f. ;
	VALID _1wv118hn0()

IF NOT WVISIBLE("sct0310a")
	ACTIVATE WINDOW sct0310a
ENDIF

READ CYCLE MODAL ;
	ACTIVATE READACT() ;
	DEACTIVATE READDEAC()

RELEASE WINDOW sct0310a

#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118H6P           ULtp_Mercad VALID                  є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   17  є
*       є Variable:            ULtp_Mercad                        є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      1                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118h6p     &&  ULtp_Mercad VALID
#REGION 1
RETURN

FUNCTION ULtp_Mercad
PARAMETERS PrmCodigo,PrmUF
	PRIVATE Lretorno
	=W_DEFPROC("GRUPO.SPR")
	Lretorno = GRGetTp_Mercadoria(PrmCodigo,PrmUF)

RETURN(Lretorno)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118H8E           ULIPIProd VALID                    є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   18  є
*       є Variable:            ULIPIProd                          є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      2                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118h8e     &&  ULIPIProd VALID
#REGION 1
RETURN

FUNCTION ULIPIProd
PARAMETERS PrmCodigo

	PRIVATE Lretorno
	=W_DEfPROC("TRIBUTAR.SPR")
	Lretorno = TRGet_IPIProd(PrmCodigo)

RETURN(Lretorno)

*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118H8K           ULgera_SIN VALID                   є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   19  є
*       є Variable:            ULgera_SIN                         є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      3                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118h8k     &&  ULgera_SIN VALID
#REGION 1
RETURN

PROCEDURE ULgera_SIN
PARAMETERS PrmEmp,PrmDtIni,PrmDtFin

	do  ULDefTmpArq with  PrmEmp,PrmDtIni,PrmDtFin

	ACTIVATE WINDOW SCT0310A
	SHOW WINDOW SCT0310A TOP
	CLEAR

	SET TALK ON
	*----------------------------------------------------------*
	*    GERAR ARQ. RESUMO CONTENDO SO AS NOTAS DO PERIODO E DA
	* EMPRESA SELECIONADA PARA ACELERAR OS OUTROS SELECTs
	*----------------------------------------------------------*
	DO ULSelNFs with PrmEmp,PrmDtIni,PrmDtFin
	*----------------------------------------------------------*
	*  SELECIONANDO REGISTROS DE ENTRADA
	*----------------------------------------------------------*
	DO ULSelNFe with PrmEmp,PrmDtIni,PrmDtFin
	*----------------------------------------------------------*
	*  MONTA CURSOR DE TIPO DE OPERACAO
	*----------------------------------------------------------*
	DO ULSelTipo
	*----------------------------------------------------------*
	DO ULProcCVN6902 WITH ;
	    (m.empresa),(m.dt_inicio),(m.dt_fim)
	*----------------------------------------------------------*
	SET TALK off
	*---------------------------------------------------------------*
	do  ULFchTmpArq
	SHOW WINDOW SCT0310 TOP

RETURN



*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118H8T           resumo VALID                       є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   20  є
*       є Variable:            resumo                             є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      4                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118h8t     &&  resumo VALID
#REGION 1

PRIVATE dbf_NFSTMP,dbf_NFS
PRIVATE dbf_NFETMP,dbf_NFE

PRIVATE	dbf_NFE

	*---------------------------------------------------------------*

	DO ULLivro3199 WITH ;
	    (m.empresa),(m.dt_inicio),(m.dt_fim)

	SHOW WINDOW SCT0310 TOP

RETURN



*-------------------------------------------------------------------*

PROCEDURE ULLivro3199
PARAMETERS LNemp, LDper_ini, LDper_fim

	PRIVATE LSnome

	LSnome	 =	RIGHT(str(year(LDper_ini)),2)+;
				STR(MONTH(LDper_ini),2)+STR(LNemp,2)+"AG.DAT"
	LSnome	= 	"\SCGC\AGENFA\"+STRTRAN(LSnome," ","0")



	SELECT tipo_50
	zap
	pack
	append from &LSnome ;
			FOR 	TIPO = 50 ;
				AND CFOP > 400 ;
				AND SITUACAO  = "N" TYPE SDF
	

	SELECT tipo_60A
	zap
	pack

	append from &LSnome ;
				FOR 	TIPO = 60 ;
					AND ANALITICO = "A"  TYPE SDF


	SELECT  CFOP 			 AS CFO,  ;
			0				 AS TOTSERVICO, ;
			0			   	 AS BASE_ISS,;
			0			 	 AS VLR_ISS, ;
			SUM(BASE_ICMS/100) 	 AS BASE_ICMS,;
			SUM(VALOR_ICMS/100)  AS VLR_ICMS, ;
			0				 AS BASE_SBBRT,;
			0				 AS BASE_SUBS, ;
			0                AS ICMS_SUBS,;
			SUM(ISENTAS/100) AS BASE_ISENT,;
			SUM(OUTRAS/100)	 AS BASE_OUTR, ;
			0				 AS BASE_ISIPI,;
			0				 AS BASE_IPI,  ;
			0				 AS VLR_IPI,   ;
			0				 AS TOTPRODUTO, ;
			0				 AS VLRFRETE,  ;
			0				 AS VLRSEGURO,;
			0				 AS VLRDESPES, ;
			SUM(VALOR_TOTAL/100) AS TOTAL_NOTA ;	
		FROM tipo_50 ;
	    ORDER BY CFOP ;
	    GROUP BY CFOP ;
    	INTO CURSOR TMP1LIVR

    	
	SELECT  500  			 AS CFO,  ;
			0				 AS TOTSERVICO, ;
			0			   	 AS BASE_ISS,;
			0			 	 AS VLR_ISS, ;
			0			 	 AS BASE_ICMS,;
			0				 AS VLR_ICMS, ;
			0				 AS BASE_SBBRT,;
			0				 AS BASE_SUBS, ;
			0                AS ICMS_SUBS,;
			0				 AS BASE_ISENT,;
			0				 AS BASE_OUTR, ;
			0				 AS BASE_ISIPI,;
			0				 AS BASE_IPI,  ;
			0				 AS VLR_IPI,   ;
			0				 AS TOTPRODUTO, ;
			0				 AS VLRFRETE,  ;
			0				 AS VLRSEGURO,;
			0				 AS VLRDESPES, ;
			SUM(VALOR/100)   AS TOTAL_NOTA ;	
		FROM tipo_60A ;
		WHERE ALIQUOTA $ "I   /F   /ISS " ;
    	INTO CURSOR TMP2LIVR

	SELECT * FROM   TMP2LIVR ;
	UNION ;
	SELECT  500  			 AS CFO,  ;
			0				 AS TOTSERVICO, ;
			0			   	 AS BASE_ISS,;
			0			 	 AS VLR_ISS, ;
			0			 	 AS BASE_ICMS,;
			0				 AS VLR_ICMS, ;
			0				 AS BASE_SBBRT,;
			0				 AS BASE_SUBS, ;
			0                AS ICMS_SUBS,;
			SUM(VALOR/100) 	 AS BASE_ISENT,;
			0				 AS BASE_OUTR, ;
			0				 AS BASE_ISIPI,;
			0				 AS BASE_IPI,  ;
			0				 AS VLR_IPI,   ;
			0				 AS TOTPRODUTO, ;
			0				 AS VLRFRETE,  ;
			0				 AS VLRSEGURO,;
			0				 AS VLRDESPES, ;
			0				 AS TOTAL_NOTA ;	
		FROM tipo_60A ;
		WHERE ALIQUOTA $ "I   " ;
    	INTO CURSOR TMP3LIVR

	SELECT * FROM   TMP3LIVR ;
	UNION ;
	SELECT  500  			 AS CFO,  ;
			SUM(VALOR/100)	 AS TOTSERVICO, ;
			SUM(VALOR/100) 	 AS BASE_ISS,;
			0			 	 AS VLR_ISS, ;
			0			 	 AS BASE_ICMS,;
			0				 AS VLR_ICMS, ;
			0				 AS BASE_SBBRT,;
			0				 AS BASE_SUBS, ;
			0                AS ICMS_SUBS,;
			0			 	 AS BASE_ISENT,;
			0				 AS BASE_OUTR, ;
			0				 AS BASE_ISIPI,;
			0				 AS BASE_IPI,  ;
			0				 AS VLR_IPI,   ;
			0				 AS TOTPRODUTO, ;
			0				 AS VLRFRETE,  ;
			0				 AS VLRSEGURO,;
			0				 AS VLRDESPES, ;
			0				 AS TOTAL_NOTA ;	
		FROM tipo_60A ;
		WHERE ALIQUOTA $ "ISS " ;
    	INTO CURSOR TMP4LIVR


	SELECT * FROM   TMP4LIVR ;
	UNION ;
	SELECT  500  			 AS CFO,  ;
			0				 AS TOTSERVICO, ;
			0				 AS BASE_ISS,;
			0			 	 AS VLR_ISS, ;
			0			 	 AS BASE_ICMS,;
			0				 AS VLR_ICMS, ;
			0				 AS BASE_SBBRT,;
			0				 AS BASE_SUBS, ;
			0                AS ICMS_SUBS,;
			0			 	 AS BASE_ISENT,;
			SUM(VALOR/100)	 AS BASE_OUTR, ;
			0				 AS BASE_ISIPI,;
			0				 AS BASE_IPI,  ;
			0				 AS VLR_IPI,   ;
			0				 AS TOTPRODUTO, ;
			0				 AS VLRFRETE,  ;
			0				 AS VLRSEGURO,;
			0				 AS VLRDESPES, ;
			0				 AS TOTAL_NOTA ;	
		FROM tipo_60A ;
		WHERE ALIQUOTA $ "F   " ;
    	INTO CURSOR TMP5LIVR



	SELECT * FROM   TMP1LIVR ;
	UNION ;
	SELECT  CFO,  ;
			SUM(TOTSERVICO)	 AS TOTSERVICO, ;
			SUM(BASE_ISS)	 AS BASE_ISS,;
			SUM(VLR_ISS) 	 AS VLR_ISS, ;
			SUM(BASE_ISS) 	 AS BASE_ICMS,;
			SUM(VLR_ICMS)	 AS VLR_ICMS, ;
			SUM(BASE_SBBRT)	 AS BASE_SBBRT,;
			SUM(BASE_SUBS)	 AS BASE_SUBS, ;
			SUM(ICMS_SUBS)   AS ICMS_SUBS,;
			SUM(BASE_ISENT)	 AS BASE_ISENT,;
			SUM(BASE_OUTR)	 AS BASE_OUTR, ;
			SUM(BASE_ISIPI)	 AS BASE_ISIPI,;
			SUM(BASE_IPI)	 AS BASE_IPI,  ;
			SUM(VLR_IPI)	 AS VLR_IPI,   ;
			SUM(TOTPRODUTO)	 AS TOTPRODUTO, ;
			SUM(VLRFRETE)	 AS VLRFRETE,  ;
			SUM(VLRSEGURO)	 AS VLRSEGURO,;
			SUM(VLRDESPES)	 AS VLRDESPES, ;
			SUM(TOTAL_NOTA)	 AS TOTAL_NOTA ;		
		FROM TMP5LIVR ;
	    	GROUP BY CFO;
    	INTO CURSOR TMP6LIVR


		SELECT * FROM  TMP6LIVR ;
		    ORDER BY CFO;
    	INTO CURSOR LIVROSAI


	SELECT LIVROSAI
	GO TOP
	
	IF EOF()
 		SELE nota
		UNLOCK
 		RETURN
 	ENDIF		
	GO TOP

	LFLdireciona  = .F. && Ativa PRTSETUP para direcionar impressao DEF(.T.)
	LFLagrega 	  = .F. && Agrega o ??.REL em ??.AGR			    DEF(.F.)
	LFLfimagrega  = .F. && Qdo. Estiver agregando => encerra        DEF(.F.)

*******************
*---->   (INICIALIZACAO DO CONTROLE DE STATUS IMPRESSAO)
*******************	
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO
	LFsegue = .t.
	LNregistro = RECNO()
    COUNT  TO LNimpressao
	LNimpressos = 0
	GO LNregistro
*******************
*---->   (COMPLETADO PREPARACAO DO CONTROLE DE STATUS IMPRESSAO)
**************************>>> REGISTRO DE SAIDAS
    LSrel = "REL220A"      && relatorio padrao p/ impressoras ex: epson

    LSorienta = " WHILE  LFsegue "

	DO UPimpressao WITH 	(LFLdireciona), (LFLagrega), (LFLfimagrega)
	LFcontinua = LFsegue
************
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	LNpagina = LNpagina + _PAGENO - 1   && DAR SEQU AO N. PAGINA
RETURN




*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118H8U           ULALIQICMS VALID                   є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   21  є
*       є Variable:            ULALIQICMS                         є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      5                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118h8u     &&  ULALIQICMS VALID
#REGION 1
RETURN

FUNCTION ULALIQICMS
PARAMETERS PrmUf

	PRIVATE Lretorno
	=W_DEfPROC("TRIBUTAR.SPR")
	Lretorno = TRAlqIcmInUF(PrmUf)

RETURN(Lretorno)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118H8V           ULDefTmpArq VALID                  є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   22  є
*       є Variable:            ULDefTmpArq                        є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      6                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118h8v     &&  ULDefTmpArq VALID
#REGION 1
RETURN

PROCEDURE ULDefTmpArq
PARAMETERS PrmEmp,PrmDtIni,PrmDtFin

	PUBLIC  dbf_NFSTMP, als_NFSTMP, dbf_NFS
	PUBLIC  dbf_ITMTMP, als_ITMTMP, dbf_ITM
	PUBLIC  dbf_TIPTMP, als_TIPTMP, dbf_TIP


	PUBLIC  dbf_NFETMP, als_NFETMP, dbf_NFE		
								&& NOTA FISCAL DE ENTRADA
	PUBLIC TO  dbf_INETMP, als_INETMP, dbf_INE
								 && ITENS DA NF DE ENTRADA

	PUBLIC TO  dbf_MAPA                && MAPAECF


	LSuf_origem = LSuf_destino


	IF !ULArqItens()
		RETURN(.F.)
	ENDIF

	*
	* LOCALIZACAO DO ARQUIVO DE NOTA PARA OPERCAO SELECT ??? FROM <>
	*

	dbf_NFS  		= wp_dirdat+'NOTA.DBF'
	dbf_ITM  		= wp_dirdat+"ITEMMOV.DBF"


	dbf_NFE  		= wp_dirdat+"NOTAENT.DBF"

	dbf_INE  		= wp_dirdat+"NOTAITE.DBF"

	dbf_MAPA  		= wp_dirdat+"MAPAECF.DBF"

	dbf_SALDO  		= wp_dirdat+"SALDO.DBF"

	dbf_GRUPO  		= UPobterPath("GRUPO",.F.)+"GRUPO.DBF"

    IF PrmDtfin < {01.01.2003}
		dbf_TIP  		= "L:\TMP\CFO\TIPOOPER.DBF"
	ELSE
		dbf_TIP         =  UPobterPath("TIPOOPER",.F.)+"TIPOOPER.DBF"
	ENDIF


	*----------------------------------------------------------*
	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "NFS" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
		WAIT WINDOW 'NЖo Foi Possivel Definir Arquivo Temporario'
		RETURN
	ENDIF
	dbf_NFSTMP  = wp_dirtmp+LSaliastmp+".DBF"
	als_NFSTMP  = LSaliastmp

	*----------------------------------------------------------*

	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "ITM" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
		WAIT WINDOW 'NЖo Foi Possivel Definir Arquivo Temporario'
		RETURN
	ENDIF
	dbf_ITMTMP  = wp_dirtmp+LSaliastmp+".DBF"
	als_ITMTMP  = LSaliastmp

	*----------------------------------------------------------*
	*----------------------------------------------------------*

	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "NFE" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
		WAIT WINDOW 'NЖo Foi Possivel Definir Arquivo Temporario'
		RETURN
	ENDIF
	dbf_NFETMP  = wp_dirtmp+LSaliastmp+".DBF"
	als_NFETMP  = LSaliastmp

	*----------------------------------------------------------*

	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "INE" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
		WAIT WINDOW 'NЖo Foi Possivel Definir Arquivo Temporario'
		RETURN
	ENDIF
	dbf_INETMP  = wp_dirtmp+LSaliastmp+".DBF"
	als_INETMP  = LSaliastmp
	*----------------------------------------------------------*

	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "TIP" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
		WAIT WINDOW 'NЖo Foi Possivel Definir Arquivo Temporario'
		RETURN
	ENDIF
	dbf_TIPTMP  = wp_dirtmp+LSaliastmp+".DBF"
	als_TIPTMP  = LSaliastmp

	*----------------------------------------------------------*
	*---------------------------------------------------------------*

RETURN



*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HAG           ULIVA VALID                        є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   23  є
*       є Variable:            ULIVA                              є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      7                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hag     &&  ULIVA VALID
#REGION 1
RETURN

FUNCTION ULIVA
PARAMETERS PrmUF,PrmCodigo

	PRIVATE Lretorno
	=W_DEfPROC("TRIBUTAR.SPR")
	Lretorno = TRGet_IVA(PrmUF,PrmCodigo)

RETURN(Lretorno)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HAL           ULFchTmpArq VALID                  є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   24  є
*       є Variable:            ULFchTmpArq                        є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      8                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118hal     &&  ULFchTmpArq VALID
#REGION 1
RETURN

PROCEDURE ULFchTmpArq

	*---------------------------------------------------------------*
	IF USED("ITENSNEGOC")
		SELECT ITENSNEGOC
		USE
	ENDIF

	SELECT &als_NFSTMP
	USE

	SELECT &als_ITMTMP
	USE

	SELECT &als_INETMP
	USE

	SELECT &als_TIPTMP
	USE

RETURN



*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HAS           ULdefCfo VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   25  є
*       є Variable:            ULdefCfo                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      9                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118has     &&  ULdefCfo VALID
#REGION 1
RETURN

FUNCTION ULdefCfo
PARAMETERS PrmEmpresa, PrmTipo, PrmTp_mercad,PrmOperacao
PRIVATE LScfo
	=W_DEFPROC("TRIBUTAR.SPR")
	LScfo = TRCFO(PrmEmpresa, PrmTipo, PrmTp_mercad, PrmOperacao)
RETURN(LScfo)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HAT           ULSelNFs VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   26  є
*       є Variable:            ULSelNFs                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      10                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hat     &&  ULSelNFs VALID
#REGION 1
RETURN

PROCEDURE ULSelNFs
PARAMETERS PrmEmp,PrmDtIni,PrmDtFim
	*----------------------------------------------------------*
	*  SELECIONANDO REGISTROS DE SAIDA
	*----------------------------------------------------------*
	IF !EMPTY(LSuf_destino)
		SELECT  ;
           NF.CH_OPERA+NF.CH_PRODU+NF.CH_MOTIV+;
              NF.CH_DESTI+NF.CH_CONTR+NF.CH_CONDI+NF.TIPO AS KEY_TIPO,;
			NF.EMPRESA,EMP.CGC,NF.NOTA,NF.SERIE,NF.DATA,NF.HORA,;
			NF.UF,NF.CIDADE,;
			EMP.ESTADO AS UFOrig,EMP.cidade AS MunOrig,;
			NF.UF AS UFDstn,NF.cidade AS MunDstn,;
			NF.CFO,NF.STATUS,NF.OPERACAO,NF.CUPOM,NF.TIPO,NF.FAVORECIDO,;
			NF.TP_PESSOA,NF.INSCRICAO,NF.TOTSERVICO,NF.BASE_ISS,;
			NF.ALIQ_ISS,NF.VLR_ISS,NF.BASE_ICMS,NF.ALIQ_ICMS,NF.VLR_ICMS, ;
			NF.BASE_SBBRT,NF.BASE_SUBS,NF.ICMS_SUBS,NF.BASE_ISENT,;
			NF.BASE_OUTR,NF.BASE_ISIPI,NF.BASE_IPI,NF.VLR_IPI,;
			NF.TOTPRODUTO,NF.VLRFRETE,NF.VLRSEGURO,NF.VLRDESPES, ;
			NF.TOTAL_NOTA ;	
		FROM &dbf_NFS NF, empresa EMP;
		WHERE   emp.empresa = PrmEmp ;
			AND NF.empresa = emp.EMPRESA;
			AND NF.data >= PrmDtIni ;
			AND NF.data <= PrmDtFim ;
			AND NF.ch_opera <> "5" ;
			AND NF.UF = LSuf_destino ;
	    INTO TABLE &dbf_NFSTMP
	ELSE
		SELECT  ;
           NF.CH_OPERA+NF.CH_PRODU+NF.CH_MOTIV+;
              NF.CH_DESTI+NF.CH_CONTR+NF.CH_CONDI+NF.TIPO AS KEY_TIPO,;
			NF.EMPRESA,EMP.CGC,NF.NOTA,NF.SERIE,NF.DATA,NF.HORA,NF.UF,;
			NF.CIDADE,;
			EMP.ESTADO AS UFOrig,EMP.cidade AS MunOrig,;
			NF.UF AS UFDstn,NF.cidade AS MunDstn,;
			NF.CFO,NF.STATUS,NF.OPERACAO,NF.CUPOM,NF.TIPO,NF.FAVORECIDO,;
			NF.TP_PESSOA,NF.INSCRICAO,NF.TOTSERVICO,NF.BASE_ISS,;
			NF.ALIQ_ISS,NF.VLR_ISS,NF.BASE_ICMS,NF.ALIQ_ICMS,NF.VLR_ICMS, ;
			NF.BASE_SBBRT,NF.BASE_SUBS,NF.ICMS_SUBS,NF.BASE_ISENT,;
			NF.BASE_OUTR,NF.BASE_ISIPI,NF.BASE_IPI,NF.VLR_IPI,;
			NF.TOTPRODUTO,NF.VLRFRETE,NF.VLRSEGURO,NF.VLRDESPES, ;
			NF.TOTAL_NOTA ;	
		FROM &dbf_NFS NF, empresa EMP;
		WHERE   emp.empresa = PrmEmp ;
			AND NF.empresa = emp.EMPRESA;
			AND NF.data 	>= PrmDtIni ;
			AND NF.data 	<= PrmDtFim ;
			AND NF.ch_opera <> "5" ;
	    INTO TABLE &dbf_NFSTMP
	ENDIF

	*----------------------------------------------------------*
	*  SELECIONANDO ITENS DO MOVIMENTO  E ITENS DA NF DE SAIDA
	*  somente os faturados (LEFT(situacao,1) = "O")
	*----------------------------------------------------------*

	SELECT   CH_OPERA+CH_PRODU+CH_MOTIV+;
              CH_DESTI+CH_CONTR+CH_CONDI+TIPO AS KEY_TIPO,;
			EMPRESA, NOTA , SERIE, DATA, CODIGO,TP_MERCAD, VLRVENDA,QTDE,;
            CFO, OPERACAO, FAVORECIDO,;
			TIPO,BASE_ISS,  ALIQ_ISS, VLR_ISS, ;
			BASE_CALC,	ALIQ_ICMS, VLR_ICMS, ;
			BASE_SBBRT, BASE_SUBS, ICMS_SUBS, ;
			BASE_ISENT, BASE_OUTR, BASE_ISIPI, BASE_IPI,  VLRIPI, ;
	  	    CLASSIFICA,;
	  	    DESCRICAO,;
	  	    UNIDADE,;
		    ORIGEM,;
		    CST,;
	  	    ALIQ_IPI,;
	  	    IVA;
		FROM &dbf_ITM ;
		WHERE  	!(ch_opera $"56") ;
			AND empresa = PrmEmp ;
			AND data 	>= PrmDtIni ;
			AND data 	<= PrmDtFim ;
			AND LEFT(situacao,1) = "O" ;		
	    INTO TABLE &dbf_ITMTMP

	*---------------------------------------------------------------*
RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HAU           ULCFPS VALID                       є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   27  є
*       є Variable:            ULCFPS                             є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      11                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hau     &&  ULCFPS VALID
#REGION 1
RETURN

FUNCTION ULCFPS
PARAMETERS PrmUFOrgn, PrmMuniOrgn,PrmUFDstn, PrmMuniDstn,PrmTp_mercad,;
           PrmOperacao
PRIVATE LScfps

	DO CASE
		CASE PrmTp_mercad <> 7   && nao e servico
			LScfps  = "0000"		
		CASE PrmUFOrgn = PrmUFDstn AND PrmMuniOrgn = PrmMuniDstn
			LScfps  = "9101"		
		CASE PrmUFOrgn = PrmUFDstn AND PrmMuniOrgn <> PrmMuniDstn
			LScfps  = "9102"		
		CASE PrmUFOrgn <> PrmUFDstn
			LScfps  = "9103"		
		OTHERWISE
			LScfps  = "0000"		
	ENDCASE
RETURN(LScfps)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HBI           ULSelNFe VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   28  є
*       є Variable:            ULSelNFe                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      12                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hbi     &&  ULSelNFe VALID
#REGION 1
RETURN

PROCEDURE ULSelNFe
PARAMETERS  PrmEmp, PrmDtIni, PrmDtFim

	IF !EMPTY(LSuf_destino)
	   SELECT ;
	   	    N.CH_OPERA+N.CH_PRODU+N.CH_MOTIV+;
            N.CH_DESTI+N.CH_CONTR+N.CH_CONDI+N.TIPO AS KEY_TIPO,;
			N.EMPRESA, E.CGC,;
			N.NOTA,N.SERIE,N.DATA,N.DATA_EMI,N.CODFORN,N.HORA,N.UF,N.CFO,;
			N.FAVORECIDO,N.TP_PESSOA,N.INSCRICAO,N.TIPO,N.CH_OPERA,;
			N.CH_PRODU,E.ESTADO AS UFDstn,E.cidade AS MunDstn,;
			N.UF AS UFOrig,N.cidade AS MunOrig,;
	        N.STATUS,N.SITUACAO , ;
			N.TOTSERVICO,N.BASE_ISS,N.ALIQ_ISS, ;
			N.BASE_ICMS,N.ALIQ_ICMS,N.VLR_ICMS, ;
			N.BASE_SBBRT,N.BASE_SUBS,N.ICMS_SUBS, ;
			N.BASE_ISENT,N.BASE_OUTR,N.BASE_ISIPI,N.BASE_IPI,N.VLR_IPI, ;
			N.TOTPRODUTO,N.VLRFRETE,N.VLRSEGURO,N.VLRDESPES, ;
			N.TOTAL_NOTA ;	
		FROM &dbf_NFE NF, empresa EMP ;
		WHERE  	!(ch_opera $"56") ;
			AND LSuf_origem = uf;
			AND LEFT(situacao,1) = "C" ;
			AND emp.empresa = PrmEmp ;
			AND data 	>= PrmDtIni ;
			AND data 	<= PrmDtFim ;
	    INTO TABLE &dbf_NFETMP
	ELSE
	   SELECT ;
	   	    N.CH_OPERA+N.CH_PRODU+N.CH_MOTIV+;
            N.CH_DESTI+N.CH_CONTR+N.CH_CONDI+N.TIPO AS KEY_TIPO,;
			N.EMPRESA, E.CGC,;
			N.NOTA,N.SERIE,N.DATA,N.DATA_EMI,N.CODFORN,N.HORA,N.UF,N.CFO,;
			N.FAVORECIDO,N.TP_PESSOA,N.INSCRICAO,N.TIPO,N.CH_OPERA,;
			N.CH_PRODU,E.ESTADO AS UFDstn,E.cidade AS MunDstn,;
			N.UF AS UFOrig,N.cidade AS MunOrig,;
	        N.STATUS,N.SITUACAO , ;
			N.TOTSERVICO,N.BASE_ISS,N.ALIQ_ISS, ;
			N.BASE_ICMS,N.ALIQ_ICMS,N.VLR_ICMS, ;
			N.BASE_SBBRT,N.BASE_SUBS,N.ICMS_SUBS, ;
			N.BASE_ISENT,N.BASE_OUTR,N.BASE_ISIPI,N.BASE_IPI,N.VLR_IPI, ;
			N.TOTPRODUTO,N.VLRFRETE,N.VLRSEGURO,N.VLRDESPES, ;
			N.TOTAL_NOTA ;	
		FROM &dbf_NFE N, empresa E ;
		WHERE  	!(N.ch_opera $"56") ;
			AND LEFT(N.situacao,1) = "C" ;
			AND e.empresa = PrmEmp ;
			AND N.data 	>= PrmDtIni ;
			AND N.data 	<= PrmDtFim ;
	    INTO TABLE &dbf_NFETMP
	ENDIF



	*----------------------------------------------------------*
	*  SELECIONANDO ITENS DA NF DE ENTRADA
	*----------------------------------------------------------*
	SELECT  ;
			CH_OPERA+CH_PRODU+CH_MOTIV+;
            CH_DESTI+CH_CONTR+CH_CONDI+TIPO AS KEY_TIPO,  *;
		FROM &dbf_ine ;
		WHERE  	!(ch_opera $"56") ;
			AND empresa = PrmEmp ;
			AND data 	>= PrmDtIni ;
			AND data 	<= PrmDtFim ;
	    INTO TABLE &dbf_ineTMP

	*---------------------------------------------------------------*
RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HBU           ULCST_IPI VALID                    є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   29  є
*       є Variable:            ULCST_IPI                          є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      13                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hbu     &&  ULCST_IPI VALID
#REGION 1
RETURN

FUNCTION ULCST_IPI
PARAMETERS PrmVlrIPI,PrmOperacao
PRIVATE LScstIPI

	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlrIPI > 0   && nao e servico
			LScstIPI  = "50"		
		CASE PrmOperacao = "SAIDA" AND PrmVlrIPI = 0   && nao e servico
			LScstIPI  = "53"		
		OTHERWISE
			LScstIPI  = "53"		
	ENDCASE
RETURN(LScstIPI)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HC1           ULSelTipo VALID                    є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   30  є
*       є Variable:            ULSelTipo                          є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      14                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hc1     &&  ULSelTipo VALID
#REGION 1
RETURN

PROCEDURE ULSelTipo

    SELECT CH_OPERA+CH_PRODU+CH_MOTIV+;
              CH_DESTI+CH_CONTR+CH_CONDI+TIPO AS KEY_TIPO,;
            TP.* FROM &dbf_TIP TP ;
	    INTO TABLE &dbf_TIPTMP
	*---------------------------------------------------------------*
RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HC6           ULCST_ISS VALID                    є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   31  є
*       є Variable:            ULCST_ISS                          є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      15                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hc6     &&  ULCST_ISS VALID
#REGION 1
RETURN

FUNCTION ULCST_ISS
PARAMETERS PrmVlrISS,PrmOperacao
PRIVATE LScstISS

	DO CASE
		CASE PrmOperacao = "SAIDA" AND PrmVlrISS > 0   && nao e servico
			LScstISS  = "00"		
		CASE PrmOperacao = "SAIDA" AND PrmVlrISS = 0   && nao e servico
			LScstISS  = "07"		
		OTHERWISE
			LScstISS  = "07"		
	ENDCASE
RETURN(LScstISS)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HCD           ULProcCVN6902 VALID                є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   32  є
*       є Variable:            ULProcCVN6902                      є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      16                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118hcd     &&  ULProcCVN6902 VALID
#REGION 1
RETURN

*-------------------------------------------------------------------*

PROCEDURE ULProcCVN6902
PARAMETERS LNemp, LDper_ini, LDper_fim

	PRIVATE LSnome

	LSnome	 =	RIGHT(str(year(LDper_ini)),2)+;
				STR(MONTH(LDper_ini),2)+STR(LNemp,2)+"AG.DAT"
	LSnome	= 	"\SCGC\AGENFA\"+STRTRAN(LSnome," ","0")
	LNcontrol = FCREATE(LSnome)	
	PRIVATE LNctr_10,LNctr_11,LNctr_50,LNctr_53,LNctr_54,LNctr_60,;
			LNctr_70,LNctr_74,LNctr_75
	STORE 0 TO LNctr_10,LNctr_11,LNctr_50,LNctr_53,LNctr_54,LNctr_60,;
			LNctr_70,LNctr_74,LNctr_75

	=UL69R_10((LNemp),(LNcontrol),(LDper_ini),(LDper_fim),LNctr_10)
	=UL69R_11((LNemp),(LNcontrol),(LDper_ini),(LDper_fim),LNctr_11)
	=UL69R_50((LNemp),(LNcontrol),(LDper_ini),(LDper_fim),LNctr_50)
	=UL69R_53((LNemp),(LNcontrol),(LDper_ini),(LDper_fim),LNctr_53)
	=UL69R_54((LNemp),(LNcontrol),(LDper_ini),(LDper_fim),LNctr_54)
	=UL69R_60((LNemp),(LNcontrol),(LDper_ini),(LDper_fim),LNctr_60)
	=UL69R_70((LNemp),(LNcontrol),(LDper_ini),(LDper_fim),LNctr_70)

	IF LSinventario = "S"
		=UL69R_74((LNemp),(LNcontrol),(LDper_ini),(LDper_fim),LNctr_74)
	endif
	=UL69R_75((LNemp),(LNcontrol),(LDper_ini),(LDper_fim),LNctr_75)

	=UL69R_90((LNemp),(LNcontrol),LNctr_10,LNctr_11,LNctr_50,;
				LNctr_53,LNctr_54,LNctr_60,LNctr_70,LNctr_74,LNctr_75)
	=FCLOSE(LNcontrol)
RETURN



*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HCE           ULGenero VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   33  є
*       є Variable:            ULGenero                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      17                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hce     &&  ULGenero VALID
#REGION 1
RETURN

FUNCTION ULGenero
PARAMETERS PrmTp_mercad,PrmClassifica,PrmOperacao
PRIVATE LSgenero

	DO CASE
		CASE PrmTp_mercad = 7
			LSgenero  = "00"		
		CASE LefT(Prmclassifica,2) $ "00/01"
			LSgenero  = "40"		
		OTHERWISE
			LSgenero  = "87"		
	ENDCASE
RETURN(LSgenero)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HCF           UL69R_10 VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   34  є
*       є Variable:            UL69R_10                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      18                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hcf     &&  UL69R_10 VALID
#REGION 1
RETURN

FUNCTION UL69R_10
	PARAMETERS LNemp, LNctrl, LDper_ini, LDper_fim, LN_Ctr

	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	
	LStipo  		= "10"                                   && 01-tipo
	LScgc			= CHRTRAN(STR(empresa.cgc,14)," ","0")   && 02-cnpj
	LSinsc			= CHRTRAN(empresa.inscricao," ","")      && 03-inscricao
	LSinsc			= CHRTRAN(LSinsc,".","")                 &&
	LSinsc			= CHRTRAN(LSinsc,"/","")                 &&
	LSinsc			= CHRTRAN(LSinsc,"-","")                 &&
	LSinsc			= LEFT(LSinsc+space(14),14)              && 03-inscricao
	LSnome			= LEFT(empresa.nome,35)                  && 04-nome
	LSmunicipio		= LEFT(empresa.cidade,30)                && 05-municipio
	LSestado		= empresa.estado                         && 06-uf
	LSfax			= REPLICATE("0",10)                      && 07-fax
	LSdtini			= STR(YEAR(LDper_ini),4)+;
					  STR(MONTH(LDper_ini),2)+;
					  STR(DAY(LDper_ini),2)
	LSdtini			= CHRTRAN(LSdtini," ","0")				 && 08-dt.inicio
	LSdtfim			= STR(YEAR(LDper_fim),4)+;
					  STR(MONTH(LDper_fim),2)+;
					  STR(DAY(LDper_fim),2)
	LSdtfim			= CHRTRAN(LSdtfim," ","0")				 && 09-dt.final

	IF YEAR(LDper_ini) >= 2004
		LScod_id= "33"                                   && 10/11-Cod.Id
	ELSE
		LScod_id= "23"                                   && 10/11-Cod.Id
	ENDIF
	
	LScod_f			= str(LNfinalidade,1)                    && 12-Cod.Final
	

	LStmp1 			=LStipo+LScgc+LSinsc+LSnome+;
					 LSmunicipio+LSestado+LSfax+;
					 LSdtini+LSdtfim+LScod_id+LScod_f

	=FPUT(LNctrl,LStmp1,126)
	LN_Ctr	=	LN_Ctr + 1
RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HD1           m.val_btn VALID                    є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   35  є
*       є Variable:            m.val_btn                          є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      19                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118hd1     &&  m.val_btn VALID
#REGION 1
PRIVATE dbf_NFSTMP,dbf_NFS
PRIVATE dbf_REZTMP

	LSuf_origem = LSuf_destino


	*
	* LOCALIZACAO DO ARQUIVO DE NOTA PARA OPERCAO SELECT ??? FROM <>
	*

	dbf_NFS  		= wp_dirdat+'NOTA.DBF'
	dbf_MAPA  		= wp_dirdat+"MAPAECF.DBF"



	*----------------------------------------------------------*
	*  TEMPORARIO PARA NOTA DO PERIODO
	*----------------------------------------------------------*
	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "NFS" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
		WAIT WINDOW 'NЖo Foi Possivel Definir Arquivo Temporario'
		RETURN
	ENDIF
	dbf_NFSTMP  = wp_dirtmp+LSaliastmp+".DBF"
	als_NFSTMP  = LSaliastmp
	*----------------------------------------------------------*
	*  TEMPORARIO PARA AGREGAR CUPONS NORMAIS
	*----------------------------------------------------------*
	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "CPM" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
		WAIT WINDOW 'NЖo Foi Possivel Definir Arquivo Temporario'
		RETURN
	ENDIF
	dbf_CPMTMP  = wp_dirtmp+LSaliastmp+".DBF"
	als_CPMTMP  = LSaliastmp
	*----------------------------------------------------------*
	*  TEMPORARIO PARA AGREGAR CUPONS CANCELADOS
	*----------------------------------------------------------*
	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "CAN" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
		WAIT WINDOW 'NЖo Foi Possivel Definir Arquivo Temporario'
		RETURN
	ENDIF
	dbf_CANTMP  = wp_dirtmp+LSaliastmp+".DBF"
	als_CANTMP  = LSaliastmp
	*----------------------------------------------------------*


	*----------------------------------------------------------*
	*  SELECIONANDO REGISTROS DE SAIDA
	*----------------------------------------------------------*

	IF !EMPTY(LSuf_destino)
		SELECT  NOTA , SERIE, DATA, HORA, UF, CFO, ;
			TIPO,FAVORECIDO,TP_PESSOA,INSCRICAO,;
	        STATUS, OPERACAO, CUPOM, ;
			TOTSERVICO, BASE_ISS,  ALIQ_ISS, VLR_ISS, ;
			BASE_ICMS,	ALIQ_ICMS, VLR_ICMS, ;
			BASE_SBBRT, BASE_SUBS, ICMS_SUBS, ;
			BASE_ISENT, BASE_OUTR, BASE_ISIPI, BASE_IPI,  VLR_IPI, ;
			TOTPRODUTO, VLRFRETE, VLRSEGURO, VLRDESPES, ;
			TOTAL_NOTA ;	
		FROM &dbf_NFS ;
		WHERE   	empresa = M.EMPRESA;
			AND data >= M.dt_inicio AND  data <= M.dt_fim ;
			AND ch_opera <> "5" ;
			AND UF = LSuf_destino ;
	    INTO TABLE &dbf_NFSTMP
	ELSE
		SELECT  NOTA , SERIE, DATA, HORA, UF, CFO, ;
	        STATUS, OPERACAO, CUPOM, ;
			TIPO,FAVORECIDO,TP_PESSOA,INSCRICAO,;
			TOTSERVICO, BASE_ISS,  ALIQ_ISS, VLR_ISS, ;
			BASE_ICMS,	ALIQ_ICMS, VLR_ICMS, ;
			BASE_SBBRT, BASE_SUBS, ICMS_SUBS, ;
			BASE_ISENT, BASE_OUTR, BASE_ISIPI, BASE_IPI,  VLR_IPI, ;
			TOTPRODUTO, VLRFRETE, VLRSEGURO, VLRDESPES, ;
			TOTAL_NOTA ;	
		FROM &dbf_NFS ;
		WHERE   	empresa = M.EMPRESA;
			AND data >= M.dt_inicio AND  data <= M.dt_fim ;
			AND ch_opera <> "5" ;
	    INTO TABLE &dbf_NFSTMP
	ENDIF

	*---------------------------------------------------------------*

	DO ULval31R_60 WITH ;
	    (m.empresa),(m.dt_inicio),(m.dt_fim)

	*---------------------------------------------------------------*
	SELECT &als_CPMTMP
	USE

	SELECT &als_CANTMP
	USE

	SELECT &als_NFSTMP
	USE

RETURN

*-------------------------------------------------------------------*

PROCEDURE ULval31R_60
PARAMETERS LNemp, LDper_ini, LDper_fim


	*****************************************************************
	*  REGISTRO CUPONS  - 60 -
	*****************************************************************
	*-------------------------------------------------------------------*
	* PROCESSO SOBRE RESUMO DO MAPAECF
	*-------------------------------------------------------------------*
	
	SELECT  "5.00"   AS CFO ,      ;
			DATA,ALIQUOTA AS ALIQ_ICMS,;
			"XX" AS UF, ;
		 	VLRCONTAB 	    						  AS TOTAL_NOTA,;
		 	(VLRCONTAB-VLRISENT-VLRSERVICO-VLRSUBST)  AS BASE_ICMS,;
			VLRISENT								  AS BASE_ISENT,;
			VLROUTRO								  AS BASE_OUTR,;
			VLRSERVICO      						  AS BASE_ISS,;
			VLRSUBST 								  AS BASE_SUBS,;
			CANCELA;
		FROM &dbf_MAPA ;
		WHERE    data >= LDper_ini;
		   	AND  data <= LDper_fim;
		GROUP BY DATA,ALIQ_ICMS,UF;
    	INTO CURSOR TMP_MAPA

	*-------------------------------------------------------------------*
	* PROCESSO APURANDO CUPONS EMITIDOS E NAO CANCELADOS MAPAECF
	*-------------------------------------------------------------------*

 	SELECT  "5.00" AS CFO ,  ;
			DATA, ;
			ALIQ_ICMS, ;
			"XX"			 	AS UF, ;
		 	SUM(TOTAL_NOTA)  	AS TOTAL_NOTA,;
		 	SUM(BASE_ICMS)   	AS BASE_ICMS,;
			SUM(BASE_ISENT)  	AS BASE_ISENT,;
			SUM(BASE_OUTR)   	AS BASE_OUTR,;
			SUM(BASE_ISS)    	AS BASE_ISS,;
			SUM(BASE_SUBS)   	AS BASE_SUBS,;
			0*SUM(BASE_SUBS)      AS CANCELA;
	FROM &dbf_NFSTMP ;
		WHERE   status = 1 ;
			AND  operacao  = "S" ;
		   	AND  cupom > 0 ;
	GROUP BY DATA,ALIQ_ICMS;
   	INTO TABLE &dbf_CPMTMP

	*-------------------------------------------------------------------*
	* PROCESSO APURANDO CUPONS  CANCELADOS
	*-------------------------------------------------------------------*


 	SELECT  "5.00" AS CFO ,  ;
			DATA, ;
			ALIQ_ICMS, ;
			"XX"			 AS UF, ;
		 	0     AS TOTAL_NOTA,;
		 	0	 AS BASE_ICMS,;
			0	 AS BASE_ISENT,;
			0	 AS BASE_OUTR,;
			0	 AS BASE_ISS,;
			0	 AS BASE_SUBS,;
		 	SUM(TOTAL_NOTA)  AS CANCELA;
	FROM &dbf_NFSTMP ;
		WHERE   status = 2 ;
		    AND  operacao  = "S" ;
		    AND  cupom > 0 ;
	GROUP BY DATA,ALIQ_ICMS;
   	INTO TABLE &dbf_CANTMP

	*-------------------------------------------------------------------*
	* PROCESSO FUSAO CUPONS NORMAIS E CANCELADOS
	*-------------------------------------------------------------------*

   	SELECT  &als_CPMTMP
	append from   &dbf_CANTMP

	*-------------------------------------------------------------------*
	* PROCESSO AGRUPAMENTO DE CUPONS NORMAIS E CANCELADOS
	*-------------------------------------------------------------------*

 	SELECT  "5.00" AS CFO ,  ;
			DATA, ;
			ALIQ_ICMS, ;
			"XX"			 	AS UF, ;
		 	SUM(TOTAL_NOTA)  	AS TOTAL_NOTA,;
		 	SUM(BASE_ICMS)   	AS BASE_ICMS,;
			SUM(BASE_ISENT)  	AS BASE_ISENT,;
			SUM(BASE_OUTR)   	AS BASE_OUTR,;
			SUM(BASE_ISS)    	AS BASE_ISS,;
			SUM(BASE_SUBS)   	AS BASE_SUBS,;
			SUM(CANCELA)        AS CANCELA;
	FROM &dbf_CPMTMP ;
	GROUP BY DATA,ALIQ_ICMS;
   	INTO CURSOR TMP_FATU



	*-------------------------------------------------------------------*
	* PROCESSO TIPO "60" COM BASE NO  MAPA ECF
	*-------------------------------------------------------------------*

	SELECT  M1.CFO ,  ;
			M1.DATA, M1.ALIQ_ICMS, ;
			M1.UF, ;
		 	M1.TOTAL_NOTA 	AS M_TOTAL_NOTA,;
		 	F1.TOTAL_NOTA   AS F_TOTAL_NOTA,;
		 	M1.BASE_ICMS  	AS M_BASE_ICMS,;
		 	F1.BASE_ICMS    AS F_BASE_ICMS,;
			M1.BASE_ISENT	AS M_BASE_ISENT,;
			F1.BASE_ISENT	AS F_BASE_ISENT,;
			M1.BASE_OUTR    AS M_BASE_OUTR,;
			F1.BASE_OUTR    AS F_BASE_OUTR,;
			M1.BASE_ISS     AS M_BASE_ISS,;
			F1.BASE_ISS     AS F_BASE_ISS,;
			M1.BASE_SUBS    AS M_BASE_SUBS,;
			F1.BASE_SUBS    AS F_BASE_SUBS,;
			M1.CANCELA      AS M_CANCELA,;
			F1.CANCELA      AS F_CANCELA;
	 FROM TMP_MAPA  M1, TMP_FATU F1;
		WHERE 	 F1.DATA = M1.DATA;
		     AND F1.ALIQ_ICMS = M1.ALIQ_ICMS ;
   	INTO CURSOR TMP_DIFE

    SELECT * FROM TMP_DIFE ;
     UNION ;
	SELECT  "TOTA"  		AS CFO ,  ;
			{12.12.9999}    AS DATA,;
			0 				AS ALIQ_ICMS, ;
			"XX"            AS UF, ;
		 	SUM(M1.TOTAL_NOTA) 	AS M_TOTAL_NOTA,;
		 	SUM(F1.TOTAL_NOTA)   AS F_TOTAL_NOTA,;
		 	SUM(M1.BASE_ICMS)  	AS M_BASE_ICMS,;
		 	SUM(F1.BASE_ICMS)    AS F_BASE_ICMS,;
			SUM(M1.BASE_ISENT)	AS M_BASE_ISENT,;
			SUM(F1.BASE_ISENT)	AS F_BASE_ISENT,;
			SUM(M1.BASE_OUTR)    AS M_BASE_OUTR,;
			SUM(F1.BASE_OUTR)    AS F_BASE_OUTR,;
			SUM(M1.BASE_ISS)     AS M_BASE_ISS,;
			SUM(F1.BASE_ISS)     AS F_BASE_ISS,;
			SUM(M1.BASE_SUBS)    AS M_BASE_SUBS,;
			SUM(F1.BASE_SUBS)    AS F_BASE_SUBS,;
			SUM(M1.CANCELA)      AS M_CANCELA,;
			SUM(F1.CANCELA)      AS F_CANCELA;
	 FROM TMP_MAPA  M1, TMP_FATU F1;
		WHERE 	 F1.DATA = M1.DATA;
		     AND F1.ALIQ_ICMS = M1.ALIQ_ICMS ;
   	INTO CURSOR TMP_RESU

	LSnome	 =	RIGHT(str(year(LDper_ini)),2)+;
				STR(MONTH(LDper_ini),2)+STR(LNemp,2)+"VL.DBF"
	LSnome	= 	"\SCGC\AGENFA\"+STRTRAN(LSnome," ","0")

	COPY TO &LSnome

	SELE TMP_RESU
	GO BOTT
	
	IF M_TOTAL_NOTA <> F_TOTAL_NOTA
	
		DO OBJ_ALER.SPR  WITH ;
			"CRITICA !!! Use Planilha EXCEL e Verifique o Arq.:"+;
	         LSnome
	ENDIF
	go top
RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HD2           UL69R_11 VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   36  є
*       є Variable:            UL69R_11                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      20                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hd2     &&  UL69R_11 VALID
#REGION 1
RETURN

FUNCTION UL69R_11
	PARAMETERS LNemp, LNctrl, LDper_ini, LDper_fim, LN_Ctr

	SELE empresa
	SET ORDER TO TAG empresa
	SEEK LNemp
	
	LStipo  		= "11"								&& 01-tipo
	LSlogr			= LEFT(empresa.endereco,34)         && 02-logradouro

	IF TYPE("empresa.num") = "U"
		LSnum	= "00001"                       		&& 03-numero
	ELSE
		LSnum	= CHRTRAN(STR(empresa.num,5)," ","0") 	&& 03-numero
	ENDIF
	LScompl			= SPACE(22)                         && 04-complemento
	LSbairro		= LEFT(empresa.bairro,15)              && 05-cep
	LScep			= LEFT(CHRTRAN(empresa.cep," ","0"),8) && 06-bairro
	LScontato		= LEFT(empresa.contato,28)             && 07-contato

	LSfone			= CHRTRAN(UPPER(empresa.fone),"X","0")
	LSfone			= CHRTRAN(LSfone,"(","")
	LSfone			= CHRTRAN(LSfone,")","")
	LSfone			= CHRTRAN(LSfone,"-","")
	LSfone			= CHRTRAN(LSfone," ","")
	LSfone			= REPL("0",12-LEN(LSfone))+LSfone

	LSfone			= LEFT(LSfone,12)                      && 08-fone

	LStmp1 			= LStipo+LSlogr+LSnum+LScompl+LSbairro+LScep+;
					  LScontato+LSfone	
	=FPUT(LNctrl,LStmp1,126)
	LN_Ctr	=	LN_Ctr + 1
RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HD3           UL69R_50 VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   37  є
*       є Variable:            UL69R_50                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      21                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118hd3     &&  UL69R_50 VALID
#REGION 1
return

FUNCTION UL69R_50
	PARAMETERS LNemp, LNctrl, LDper_ini, LDper_fim, LN_Ctr

	*-------------------------------------------------------------------*
	*	NOTAS DE SAIDA
	*-------------------------------------------------------------------*
	DO ULLvrSda50
	*---------------------------------------------------------------------*

   	SELE LIVROSAI
	GO TOP
	LStipo  		= "50"                             && 01-tipo
	DO WHILE !EOF()
		LSmsg = "Saidas (50) "+;
				 	DTOC(LIVROSAI.DATA)+;
					STR(LIVROSAI.NOTA,6)
		WAIT WINDOW LSmsg NOWAIT

		
		*----------------------------------------------------------*
		LScgc	=  CHRTRAN(STR(LIVROSAI.favorecido,14)," ","0")  && 02-cnpj
		*----------------------------------------------------------*
		*     Quando a inscricao que estiver na nota for invalida
		*  o prog buscara a inscricao do cadastro de clientes
		*  pode ocorrer que no momento da emissao da nota a inscricao
		*  estivesse errada.
		*----------------------------------------------------------*

		LSinsc	=  ALLTRIM(LIVROSAI.inscricao)			&& 03-inscricao

		LSdtemi		=	STR(YEAR(LIVROSAI.data),4)+;
						STR(MONTH(LIVROSAI.data),2)+;
						STR(DAY(LIVROSAI.data),2)
		LSdtemi		=   CHRTRAN(LSdtemi," ","0")		&& 04-dt.emissao						

		LSuf	=  LIVROSAI.uf							&& 05-uf

		=W_DEFPROC("CLIENTES.SPR")
		IF !CLInscricao(LSuf,LSinsc,1,0,0,'')
			IF LIVROSAI.favorecido = 0
				LSinsc	=  "ISENTO"
			ELSE
				SELE clientes
				SET ORDER TO TAG cliente
				SEEK LIVROSAI.favorecido
				=W_DEFPROC("CLIENTES.SPR")
				IF  FOUND() AND;
					CLInscricao(clientes.estado,clientes.INSCRICAO,1,0,0,'')
					&& CFOs Inciados em 5 o estado deve ser igual ao do
					&& informante
					DO CASE
						CASE LEFT(LIVROSAI.SET_CFO,1) = "5" ;
							AND clientes.estado = empresa.estado
							LSinsc	=  ALLTRIM(clientes.inscricao)
							LSuf	=	clientes.estado
						CASE LEFT(LIVROSAI.SET_CFO,1) <> "5" ;
							AND clientes.estado <> empresa.estado
							LSinsc	=  ALLTRIM(clientes.inscricao)
							LSuf	=	clientes.estado
					ENDCASE
				ELSE
					LSinsc	=  ALLTRIM(LIVROSAI.inscricao)
				ENDIF		
			ENDIF
		ENDIF
		SELE LIVROSAI
		*----------------------------------------------------------*
		IF "ISENTO" $ UPPER(LSinsc)
			LSinsc	=  "ISENTO"
			LScgc	=  CHRTRAN(STR(0,14)," ","0")
		ELSE
			LSinsc	=  CHRTRAN(LSinsc,".","")
			LSinsc	=  CHRTRAN(LSinsc,"/","")
			LSinsc	=  CHRTRAN(LSinsc,"-","")
			LSinsc	=  CHRTRAN(LSinsc,"(","")
			LSinsc	=  CHRTRAN(LSinsc,")","")
		ENDIF			
		LSinsc			= LEFT(LSinsc+space(14),14)
		IF LIVROSAI.TP_PESSOA = 1
			LScgc	=  CHRTRAN(STR(0,14)," ","0")
		ENDIF			


		LSmodelo 	=   "01" 							&& 06-modelo


		LSserie		=   LIVROSAI.serie+"  "				&& 07-serie

		*--> Obs: no conv69/02 o campo 08-subserie deixou de existir
		LSsubserie  = 	"  "							&& 08-subserie

		*--> Obs: no conv69/02 o campo 08-subserie fui trocado por..
		LSnumero 	= 	CHRTRAN(STR(LIVROSAI.NOTA,7)," ","0")
		LSnumero 	= 	SUBS(LSnumero,2,6)				&& 08-numero
		

		LScfo		=   CHRTRAN(LIVROSAI.SET_CFO,".","")	&& 09-cfo					
		LScfo		=   CHRTRAN(LScfo,".","")						
        LScfo	    =   LEFT(LScfo,4)
		LSemitente  =  "P"                             && 10-emitente

		SELE LIVROSAI
		*-----------------------------------------------------------------*
		*      Quando o registro se referenciar a uma copia de cupom
		* em NF os valores sao zerados devido aos mesmos serem relacio-
		* nados no registro tipo 61
		*-----------------------------------------------------------------*

		IF LIVROSAI.CUPOM = 0   && PORQUE SE <> 0 E NOTA REFERENTE A CUPOM
			LSvalor		=	str(LIVROSAI.total_nota,14,2)	  			
			LSbase_icms	=	str(LIVROSAI.base_icms,14,2)	
			LSvlr_icms	=	ROUND(base_icms*aliq_icms/100 ,2)
			LSbase_isent=	str(LIVROSAI.base_isent,14,2)	
			LSbase_outr	=	str(LIVROSAI.base_outr,14,2)	  					
			LSaliq_icms	=	str(LIVROSAI.aliq_icms,5,2)		  	
		ELSE
			LSvalor		=	str(0,14,2)						
			LSbase_icms	=	str(0,14,2)						
			LSvlr_icms	=	ROUND(0,2)
			LSbase_isent=	str(0,14,2)						
			LSbase_outr	=	str(0,14,2)						
			LSaliq_icms	=	str(LIVROSAI.aliq_icms,5,2)						
		ENDIF	

		LSvalor		=   CHRTRAN(LSvalor," ","0")	    && 11-valor					
		LSvalor		=   CHRTRAN(LSvalor,",","")						
		LSvalor		=   CHRTRAN(LSvalor,".","")						


		LSbase_icms	=   CHRTRAN(LSbase_icms," ","0")    && 12-Base
		LSbase_icms	=   CHRTRAN(LSbase_icms,",","")						
		LSbase_icms	=   CHRTRAN(LSbase_icms,".","")						


		LSvlr_icms	=	STR(LSvlr_icms,14,2)			&& 13-Icms
		LSvlr_icms	=   CHRTRAN(LSvlr_icms," ","0")						
		LSvlr_icms	=   CHRTRAN(LSvlr_icms,",","")						
		LSvlr_icms	=   CHRTRAN(LSvlr_icms,".","")						


		LSbase_isent=   CHRTRAN(LSbase_isent," ","0")	&& 14-isent	
		LSbase_isent=   CHRTRAN(LSbase_isent,",","")						
		LSbase_isent=   CHRTRAN(LSbase_isent,".","")						
		

		LSbase_outr	=   CHRTRAN(LSbase_outr," ","0")	&& 15-Outro
		LSbase_outr	=   CHRTRAN(LSbase_outr,",","")						
		LSbase_outr	=   CHRTRAN(LSbase_outr,".","")						


		LSaliq_icms	=   CHRTRAN(LSaliq_icms," ","0")	&& 16-Aliq			
		LSaliq_icms	=   CHRTRAN(LSaliq_icms,",","")			
		LSaliq_icms	=   CHRTRAN(LSaliq_icms,".","")						

		IF LIVROSAI.status = 2
			LSstatus = "S"								&& 17-situacao
		ELSE
			LSstatus = "N"
		ENDIF		
		************************************************************
		LStmp1		=	LStipo+LScgc+LSinsc+LSdtemi+LSuf+LSmodelo+;
						LSserie+LSnumero+LScfo+LSemitente+LSvalor+;
						LSbase_icms+LSvlr_icms+LSbase_isent+;
						LSbase_outr+LSaliq_icms+LSstatus
		************************************************************
		=FPUT(LNctrl,LStmp1,126)
		LN_Ctr	=	LN_Ctr + 1
		SKIP
	ENDDO
	*-------------------------------------------------------------------*
	*	NOTAS DE ENTRADA
	*-------------------------------------------------------------------*
	DO ULLvrEnt50
	*-------------------------------------------------------------------*

	SELECT LIVROENT
	GO TOP

	LStipo  		= "50"							&& 01-TIPO

	DO WHILE !EOF()
		LSmsg = "Entradas (50) "+;
				 	DTOC(LIVROENT.DATA)+;
					STR(LIVROENT.NOTA,6)
		WAIT WINDOW LSmsg NOWAIT

		*-----------------------------------------------------------*
		SELE fornece
		SET ORDER TO TAG codigo
		SEEK LIVROENT.codforn

		IF FOUND()
			LSinsc	=  ALLTRIM(fornece.inscricao)
			LScgc	=  CHRTRAN(STR(fornece.cgc,14)," ","0")
		ELSE
			LSinsc	=  ALLTRIM(LIVROENT.inscricao)
			LScgc	=  CHRTRAN(STR(LIVROENT.favorecido,14)," ","0")
		ENDIF

		IF "ISENTO" $ UPPER(LSinsc)
			LSinsc	=  "ISENTO"
			LScgc	=  CHRTRAN(STR(0,14)," ","0")		&& 02-cnpj
		ELSE
			LSinsc	=  CHRTRAN(LSinsc,".","")
			LSinsc	=  CHRTRAN(LSinsc,"/","")
			LSinsc	=  CHRTRAN(LSinsc,"-","")
			LSinsc	=  CHRTRAN(LSinsc,"(","")
			LSinsc	=  CHRTRAN(LSinsc,")","")
		ENDIF			
		LSinsc			= LEFT(LSinsc+space(14),14)     && 03-inscricao
		*-----------------------------------------------------------*
		SELECT LIVROENT

		LSdtemi		=	STR(YEAR(LIVROENT.data),4)+;
						STR(MONTH(LIVROENT.data),2)+;
						STR(DAY(LIVROENT.data),2)
		LSdtemi		=   CHRTRAN(LSdtemi," ","0")		&& 04-dt.emissao
		LSuf		=	LIVROENT.uf						&& 05-uf
		LSmodelo 	=   "01" 							&& 06-modelo
		LSserie		=   LIVROENT.serie+"  "				&& 07-serie
		
		*--> Obs: no conv69/02 o campo 08-subserie deixou de existir
		LSsubserie  = 	"  "							&& 08-subserie

		*--> Obs: no conv69/02 o campo 08-subserie fui trocado por..

		LSnumero 	= 	CHRTRAN(STR(LIVROENT.NOTA,6)," ","0")  && 08-numero

		LScfo		=   CHRTRAN(LIVROENT.SET_CFO,".","")						
		LScfo		=   CHRTRAN(LScfo,".","")						

        LScfo	=   LEFT(LScfo,4)						&& 09-cfo

		IF LIVROENT.CGC = LIVROENT.FAVORECIDO
		   LSemitente = "P"
		ELSE
		   LSemitente = "T"
		ENDIF
		


		SELE LIVROENT

		LSvalor		=	str(LIVROENT.total_nota,14,2)	
		LSvalor		=   CHRTRAN(LSvalor," ","0")		 	
		LSvalor		=   CHRTRAN(LSvalor,",","")						
		LSvalor		=   CHRTRAN(LSvalor,".","")			&& 11-valor			

		LSbase_icms	=   IIF(LIVROENT.base_subs > 0, 0, LIVROENT.base_icms)

		LSbase_icms	=	str(LSbase_icms,14,2)						
		LSbase_icms	=   CHRTRAN(LSbase_icms," ","0")						
		LSbase_icms	=   CHRTRAN(LSbase_icms,",","")						
		LSbase_icms	=   CHRTRAN(LSbase_icms,".","")		&& 12-base icms

		LSvlr_icms	=	IIF(LIVROENT.base_subs > 0, 0, LIVROENT.vlr_icms)

		LSvlr_icms	=	str(LSvlr_icms,14,2)						
		LSvlr_icms	=   CHRTRAN(LSvlr_icms," ","0")						
		LSvlr_icms	=   CHRTRAN(LSvlr_icms,",","")						
		LSvlr_icms	=   CHRTRAN(LSvlr_icms,".","")		&& 13-vlr icms

		LSbase_isent=	str(LIVROENT.base_isent,14,2)						
		LSbase_isent=   CHRTRAN(LSbase_isent," ","0")						
		LSbase_isent=   CHRTRAN(LSbase_isent,",","")						
		LSbase_isent=   CHRTRAN(LSbase_isent,".","")	&& 14-isenta
		
		LSbase_outr	=	str(LIVROENT.base_outr,14,2)						
		LSbase_outr	=   CHRTRAN(LSbase_outr," ","0")						
		LSbase_outr	=   CHRTRAN(LSbase_outr,",","")						
		LSbase_outr	=   CHRTRAN(LSbase_outr,".","")		&& 15-outra

		LSaliq_icms	=	str(LIVROENT.aliq_icms,5,2)						
		LSaliq_icms	=   CHRTRAN(LSaliq_icms," ","0")						
		LSaliq_icms	=   CHRTRAN(LSaliq_icms,",","")						
		LSaliq_icms	=   CHRTRAN(LSaliq_icms,".","")		&& 16-aliquota

		LSstatus = "N"									&& 17-situacao
		************************************************************
		LStmp1		=	LStipo+LScgc+LSinsc+LSdtemi+LSuf+LSmodelo+;
						LSserie+LSnumero+LScfo+LSemitente+LSvalor+;
						LSbase_icms+LSvlr_icms+LSbase_isent+;
						LSbase_outr+LSaliq_icms+LSstatus
		************************************************************
		=FPUT(LNctrl,LStmp1,126)
		LN_Ctr	=	LN_Ctr + 1
		SKIP
	ENDDO
RETURN





*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HFC           UL69R_51 VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   38  є
*       є Variable:            UL69R_51                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      22                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hfc     &&  UL69R_51 VALID
#REGION 1
RETURN

FUNCTION UL69R_51
RETURN

*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HFD           UL69R_53 VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   39  є
*       є Variable:            UL69R_53                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      23                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hfd     &&  UL69R_53 VALID
#REGION 1
RETURN

FUNCTION UL69R_53
	PARAMETERS LNemp, LNctrl, LDper_ini, LDper_fim, LN_Ctr


	*----------------------------------------------------------------*
	*  NOTAS DE SAIDA - COM SUBSTITUICAO TRIBUTARIA
	*----------------------------------------------------------------*
	DO ULLvrSda53
    SELE  SLIVROSAI
	*----------------------------------------------------------------*

	LStipo  		= "53"
	DO WHILE !EOF()
		LSmsg = "Subst.Saida (53) "+;
				 	DTOC(SLIVROSAI.DATA)+;
					STR(SLIVROSAI.NOTA,6)
		WAIT WINDOW LSmsg NOWAIT

		*----------------------------------------------------------*
		LScgc	=  CHRTRAN(STR(SLIVROSAI.favorecido,14)," ","0")

		LSinsc	=  ALLTRIM(SLIVROSAI.inscricao)
		LSuf	=	SLIVROSAI.uf
		=W_DEFPROC("CLIENTES.SPR")
		IF !CLInscricao(LSuf,LSinsc,1,0,0,'')
			IF SLIVROSAI.favorecido = 0
				LSinsc	=  "ISENTO"
			ELSE
				SELE clientes
				SET ORDER TO TAG cliente
				SEEK SLIVROSAI.favorecido

				=W_DEFPROC("CLIENTES.SPR")
				IF  FOUND() AND ;
				   CLInscricao(clientes.estado,clientes.INSCRICAO,1,0,0,'')
					&& CFOs Inciados em 5 o estado deve ser igual ao do
					&& informante
					DO CASE
						CASE LEFT(SLIVROSAI.SET_CFO,1) = "5" ;
							AND clientes.estado = empresa.estado
							LSinsc	=  ALLTRIM(clientes.inscricao)
							LSuf	=	clientes.estado
						CASE LEFT(SLIVROSAI.SET_CFO,1) <> "5" ;
							AND clientes.estado <> empresa.estado
							LSinsc	=  ALLTRIM(clientes.inscricao)
							LSuf	=	clientes.estado
					ENDCASE
				ELSE
					LSinsc	=  ALLTRIM(SLIVROSAI.inscricao)
				ENDIF		
			ENDIF
		ENDIF
		SELE SLIVROSAI

		IF "ISENTO" $ UPPER(LSinsc)
			LSinsc	=  "ISENTO"
			LScgc	=  CHRTRAN(STR(0,14)," ","0")
		ELSE
			LSinsc	=  CHRTRAN(LSinsc,".","")
			LSinsc	=  CHRTRAN(LSinsc,"/","")
			LSinsc	=  CHRTRAN(LSinsc,"-","")
			LSinsc	=  CHRTRAN(LSinsc,"(","")
			LSinsc	=  CHRTRAN(LSinsc,")","")
		ENDIF			
		IF SLIVROSAI.TP_PESSOA = 1
			LScgc	=  CHRTRAN(STR(0,14)," ","0")
		ENDIF			


		LSinsc			= LEFT(LSinsc+space(14),14)
		LSdtemi		=	STR(YEAR(SLIVROSAI.data),4)+;
						STR(MONTH(SLIVROSAI.data),2)+;
						STR(DAY(SLIVROSAI.data),2)
		LSdtemi		=   CHRTRAN(LSdtemi," ","0")						
		LSmodelo 	=   "01"

		LSserie		=   SLIVROSAI.serie+"  "

		LSnumero 	= 	CHRTRAN(STR(SLIVROSAI.NOTA,7)," ","0")
		LSnumero 	= 	SUBS(LSnumero,2,6)

		LScfo		=   CHRTRAN(SLIVROSAI.SET_CFO,".","")						
		LScfo		=   CHRTRAN(LScfo,".","")						
        LScfo	    =   LEFT(LScfo,4)

		IF SLIVROSAI.CGC = SLIVROSAI.FAVORECIDO
		   LSemitente = "P"
		ELSE
		   LSemitente = "T"
		ENDIF


		SELE SLIVROSAI


		*-- > Base de Substituicao
		LSbase_icms	=	str(SLIVROSAI.base_subs,14,2)						
		LSbase_icms	=   CHRTRAN(LSbase_icms," ","0")						
		LSbase_icms	=   CHRTRAN(LSbase_icms,",","")						
		LSbase_icms	=   CHRTRAN(LSbase_icms,".","")						

		*-- > ICMS de Substituicao
		LSvlr_icms	=	STR(SLIVROSAI.icms_subs,14,2)
		LSvlr_icms	=   CHRTRAN(LSvlr_icms," ","0")						
		LSvlr_icms	=   CHRTRAN(LSvlr_icms,",","")						
		LSvlr_icms	=   CHRTRAN(LSvlr_icms,".","")						

		*--- > Despesas acessorias
		LSdespesa=	SLIVROSAI.vlrfrete+SLIVROSAI.vlrseguro+SLIVROSAI.vlrdespes
		LSdespesa=	 str(LSdespesa,14,2)						
		LSdespesa=   CHRTRAN(LSdespesa," ","0")						
		LSdespesa=   CHRTRAN(LSdespesa,",","")						
		LSdespesa=   CHRTRAN(LSdespesa,".","")						
		
		IF SLIVROSAI.status = 2
			LSstatus = "S"
		ELSE
			LSstatus = "N"
		ENDIF		

		LSfiler  	=  space(30)
		************************************************************
		LStmp1		=	LStipo+LScgc+LSinsc+LSdtemi+LSuf+LSmodelo+;
						LSserie+LSnumero+LScfo+LSemitente+;
						LSbase_icms+LSvlr_icms+LSdespesa+;
						LSstatus+LSfiler
		************************************************************
		=FPUT(LNctrl,LStmp1,126)
		LN_Ctr	=	LN_Ctr + 1
		SKIP
	ENDDO



	*-------------------------------------------------------------------*
	*	NOTAS DE ENTRADA
	*-------------------------------------------------------------------*

	DO ULLvrEnt53

	*-------------------------------------------------------------------*

	SELE SLIVROENT
	GO TOP

	LStipo  		= "53"
	DO WHILE !EOF()
		LSmsg = "Subst.Entrada (53) "+;
				 	DTOC(SLIVROENT.DATA)+;
					STR(SLIVROENT.NOTA,6)
		WAIT WINDOW LSmsg NOWAIT


		*-----------------------------------------------------------*
		SELE fornece
		SET ORDER TO TAG codigo
		SEEK SLIVROENT.codforn
		IF FOUND()
			LSinsc	=  ALLTRIM(fornece.inscricao)
			LScgc	=  CHRTRAN(STR(fornece.cgc,14)," ","0")
		ELSE
			LSinsc	=  ALLTRIM(SLIVROENT.inscricao)
			LScgc	=  CHRTRAN(STR(SLIVROENT.favorecido,14)," ","0")
		ENDIF

		IF "ISENTO" $ UPPER(LSinsc)
			LSinsc	=  "ISENTO"
			LScgc	=  CHRTRAN(STR(0,14)," ","0")
		ELSE
			LSinsc	=  CHRTRAN(LSinsc,".","")
			LSinsc	=  CHRTRAN(LSinsc,"/","")
			LSinsc	=  CHRTRAN(LSinsc,"-","")
			LSinsc	=  CHRTRAN(LSinsc,"(","")
			LSinsc	=  CHRTRAN(LSinsc,")","")
		ENDIF			
		LSinsc		= LEFT(LSinsc+space(14),14)
		SELECT SLIVROENT

		LSdtemi		=	STR(YEAR(SLIVROENT.data),4)+;
						STR(MONTH(SLIVROENT.data),2)+;
						STR(DAY(SLIVROENT.data),2)
		LSdtemi		=   CHRTRAN(LSdtemi," ","0")						

		LSuf		=	SLIVROENT.uf
		LSmodelo 	=   "01"
*		LSserie		=   "  1"
*		LSsubserie  = 	"  "

		LSserie		=   SLIVROENT.serie+"  "

		LSnumero 	= 	CHRTRAN(STR(SLIVROENT.NOTA,6)," ","0")

		LScfo		=   CHRTRAN(SLIVROENT.SET_CFO,".","")						
		LScfo		=   CHRTRAN(LScfo,".","")						
        LScfo	=   LEFT(LScfo,4)

		IF SLIVROENT.CGC = SLIVROENT.FAVORECIDO
		   LSemitente = "P"
		ELSE
		   LSemitente = "T"
		ENDIF

		SELE SLIVROENT


		*-- > Base de Substituicao
		LSbase_icms	=	str(SLIVROENT.base_subs,14,2)						
		LSbase_icms	=   CHRTRAN(LSbase_icms," ","0")						
		LSbase_icms	=   CHRTRAN(LSbase_icms,",","")						
		LSbase_icms	=   CHRTRAN(LSbase_icms,".","")						

		*-- > ICMS de Substituicao
		LSvlr_icms	=	STR(SLIVROENT.icms_subs,14,2)
		LSvlr_icms	=   CHRTRAN(LSvlr_icms," ","0")						
		LSvlr_icms	=   CHRTRAN(LSvlr_icms,",","")						
		LSvlr_icms	=   CHRTRAN(LSvlr_icms,".","")						

		*--- > Despesas acessorias
		LSdespesa=;
			SLIVROENT.vlrfrete+SLIVROENT.vlrseguro+SLIVROENT.vlrdespes
		LSdespesa=	 str(LSdespesa,14,2)						
		LSdespesa=   CHRTRAN(LSdespesa," ","0")						
		LSdespesa=   CHRTRAN(LSdespesa,",","")						
		LSdespesa=   CHRTRAN(LSdespesa,".","")						
		

		LSstatus = "N"
		LSfiler  	=  space(30)
		************************************************************
		LStmp1		=	LStipo+LScgc+LSinsc+LSdtemi+LSuf+LSmodelo+;
						LSserie+LSnumero+LScfo+LSemitente+;
						LSbase_icms+LSvlr_icms+LSdespesa+;
						LSstatus+LSfiler
		************************************************************
		=FPUT(LNctrl,LStmp1,126)
		LN_Ctr	=	LN_Ctr + 1
		SKIP
	ENDDO

RETURN





*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HGC           UL69R_54 VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   40  є
*       є Variable:            UL69R_54                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      24                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hgc     &&  UL69R_54 VALID
#REGION 1
RETURN

*****************************************************************
*  REGISTRO DE ITENS - 54 - ENTRADA E SAIDA
*****************************************************************
FUNCTION UL69R_54
	PARAMETERS LNemp, LNctrl, LDper_ini, LDper_fim, LN_Ctr
	PRIVATE LNctrOrdem

	*-------------------------------------------------------------------*
	*	ITENS DAS NOTAS DE SAIDA
	*-------------------------------------------------------------------*

	DO ULItmSda54

	*-------------------------------------------------------------------*
	SELE ILIVROSAI
	GO TOP

	DO WHILE !EOF()
	
		LSmsg = "Produtos Saida (54) "+;
				 	DTOC(ILIVROSAI.DATA)+;
					STR(ILIVROSAI.NOTA,6)
		WAIT WINDOW LSmsg NOWAIT

		LStipo  	=   "54"

		
		*----------------------------------------------------------*
		LScgc	=  CHRTRAN(STR(ILIVROSAI.favorecido,14)," ","0")
		*----------------------------------------------------------*

		LSinsc	=  ALLTRIM(ILIVROSAI.inscricao)
		LSuf	=  ILIVROSAI.uf
		=W_DEFPROC("CLIENTES.SPR")
		IF !CLInscricao(LSuf,LSinsc,1,0,0,'')
			IF ILIVROSAI.favorecido = 0
				LSinsc	=  "ISENTO"
			ELSE
				SELE clientes
				SET ORDER TO TAG cliente
				SEEK ILIVROSAI.favorecido
				=W_DEFPROC("CLIENTES.SPR")
				IF  FOUND() AND;
					CLInscricao(clientes.estado,clientes.INSCRICAO,1,0,0,'')
					&& CFOs Inciados em 5 o estado deve ser igual ao do
					&& informante
					DO CASE
						CASE LEFT(ILIVROSAI.SET_CFO,1) = "5" ;
							AND clientes.estado = empresa.estado
							LSinsc	=  ALLTRIM(clientes.inscricao)
							LSuf	=	clientes.estado
						CASE LEFT(ILIVROSAI.SET_CFO,1) <> "5" ;
							AND clientes.estado <> empresa.estado
							LSinsc	=  ALLTRIM(clientes.inscricao)
							LSuf	=	clientes.estado
					ENDCASE
				ELSE
					LSinsc	=  ALLTRIM(ILIVROSAI.inscricao)
				ENDIF		
			ENDIF
		ENDIF

		SELE ILIVROSAI
		IF "ISENTO" $ UPPER(LSinsc)
			LScgc	=  CHRTRAN(STR(0,14)," ","0")
		ENDIF			
		IF ILIVROSAI.TP_PESSOA = 1
			LScgc	=  CHRTRAN(STR(0,14)," ","0")
		ENDIF			
			
		LSmodelo 	=   "01"
		LSserie		=   "  1"

		LSserie		=   ILIVROSAI.serie+"  "


		LSnumero 	= 	CHRTRAN(STR(ILIVROSAI.NOTA,7)," ","0")
		LSnumero 	= 	SUBS(LSnumero,2,6)


		QBR_NOTA   = ILIVROSAI.NOTA
		LNctrordem = 1		&& INDICAR ORDEM DO PRODUTO NA NOTA

		DO WHILE !EOF() AND QBR_NOTA = ILIVROSAI.NOTA
			*---------------------------------------------------*
			&& REGISTRAR ITEM COMERCIALIZADO

			DO ULitem_6975  with ;
			    ILIVROSAI.Codigo,ILIVROSAI.classifica,;
			    ILIVROSAI.descricao,ILIVROSAI.Unidade,ILIVROSAI.Aliq_ipi,;
			     ILIVROSAI.aliq_icms, ILIVROSAI.iva,ILIVROSAI.tp_mercad

			*---------------------------------------------------*			


			LScst   = CHRTRAN(STR(ILIVROSAI.origem,1)," ","0") + ;
					  ILIVROSAI.cst+ "0"

			LSordem = CHRTRAN(STR(LNctrordem,3)," ","0")
			LNctrordem	= LNctrordem + 1
			LScodigo=  LEFT(ILIVROSAI.codigo,10)+space(4)

			LSqtde	= STR(ILIVROSAI.qtde,12,3)			
			LSqtde  = CHRTRAN(LSqtde," ","0")
			LSqtde  = CHRTRAN(LSqtde,",","")
			LSqtde  = CHRTRAN(LSqtde,".","")

			LSvalor	= STR(ILIVROSAI.vlrvenda,13,2)			
			LSvalor = CHRTRAN(LSvalor," ","0")
			LSvalor = CHRTRAN(LSvalor,",","")
			LSvalor = CHRTRAN(LSvalor,".","")

			LSdesconto	= STR(0,13,2)			
			LSdesconto  = CHRTRAN(LSdesconto," ","0")
			LSdesconto  = CHRTRAN(LSdesconto,",","")
			LSdesconto  = CHRTRAN(LSdesconto,".","")

			LSbase_icms = STR(ILIVROSAI.base_calc,13,2)			
			LSbase_icms = CHRTRAN(LSbase_icms," ","0")
			LSbase_icms = CHRTRAN(LSbase_icms,",","")
			LSbase_icms = CHRTRAN(LSbase_icms,".","")

			LSbase_subs = (ILIVROSAI.BASE_SUBS)
			LSbase_subs = STR(LSbase_subs,13,2)			
			LSbase_subs = CHRTRAN(LSbase_subs," ","0")
			LSbase_subs = CHRTRAN(LSbase_subs,",","")
			LSbase_subs = CHRTRAN(LSbase_subs,".","")

			LSvlripi	= STR(ILIVROSAI.vlripi,13,2)			
			LSvlripi	= CHRTRAN(LSvlripi," ","0")
			LSvlripi 	= CHRTRAN(LSvlripi,",","")
			LSvlripi 	= CHRTRAN(LSvlripi,".","")

			LSaliq_icms	=	str(ILIVROSAI.aliq_icms,5,2)						
			LSaliq_icms	=   CHRTRAN(LSaliq_icms," ","0")						
			LSaliq_icms	=   CHRTRAN(LSaliq_icms,",","")						
			LSaliq_icms	=   CHRTRAN(LSaliq_icms,".","")						
			
			LScfo		=   CHRTRAN(ILIVROSAI.SET_cfo,".","")						
   		    LScfo		=   CHRTRAN(LScfo,".","")						
            LScfo	=   LEFT(LScfo,4)

			*******************************************************

			LStmp1		= LStipo+LScgc+LSmodelo+LSserie+;
						  LSnumero+LScfo+LScst+LSordem+;
						  LScodigo+LSqtde+LSvalor+LSdesconto+LSbase_icms+;
						  LSbase_subs+LSvlripi+LSaliq_icms
			=FPUT(LNctrl,LStmp1,126)
			LN_Ctr	=	LN_Ctr + 1
			*******************************************************			
			SKIP
		ENDDO
	ENDDO

	*-------------------------------------------------------------------*
	*	NOTAS DE ENTRADA
	*-------------------------------------------------------------------*
	DO ULItmEnt54
	*-------------------------------------------------------------------*

	SELE ILIVROENT
	GO TOP

	DO WHILE !EOF()
		LSmsg = "Produtos Entrada (54) "+;
				 	DTOC(ILIVROENT.DATA)+;
					STR(ILIVROENT.NOTA,6)
		WAIT WINDOW LSmsg NOWAIT

		LStipo  	= "54"

		*-----------------------------------------------------------*
		SELE fornece
		SET ORDER TO TAG codigo
		SEEK ILIVROENT.codforn
		IF FOUND()
			LSinsc	=  ALLTRIM(fornece.inscricao)
			LScgc	=  CHRTRAN(STR(fornece.cgc,14)," ","0")
		ELSE
			LSinsc	=  ALLTRIM(ILIVROENT.inscricao)
			LScgc	=  CHRTRAN(STR(ILIVROENT.favorecido,14)," ","0")
		ENDIF
		*-----------------------------------------------------------*
		SELE ILIVROENT

		IF "ISENTO" $ UPPER(LSinsc)
			LScgc	=  CHRTRAN(STR(0,14)," ","0")
		ENDIF
		LSmodelo 	=   "01"

		LSserie		=   ILIVROENT.serie+"  "
		LSsubserie  = 	"  "


		LSnumero 	= 	CHRTRAN(STR(ILIVROENT.NOTA,6)," ","0")

		SELE ILIVROENT

		LScfo	=   CHRTRAN(ILIVROENT.SET_cfo,".","")						
	    LScfo	=   CHRTRAN(LScfo,".","")						
        LScfo	=   LEFT(LScfo,4)



		QBR_NOTA   = ILIVROENT.NOTA
		QBR_FORN   = ILIVROENT.CODFORN
		LNctrordem = 1		&& INDICAR ORDEM DO PRODUTO NA NOTA

		DO WHILE !EOF() AND QBR_NOTA = ILIVROENT.NOTA ;
		                AND QBR_FORN = ILIVROENT.CODFORN
		

			*--------------------------------------------------*
			* 	Podem ser identificadas itens de entrada com mesmo
			* numero de nota por isso e feito a verificacao do tipo
			* e do codiforn
			*---------------------------------------------------*
			*---------------------------------------------------*
			DO ULitem_6975  with ;
			    ILIVROENT.Codigo,ILIVROENT.classifica,;
			    ILIVROENT.descricao,ILIVROENT.Unidade,ILIVROENT.Aliq_ipi,;
			     ILIVROENT.aliq_icms, ILIVROENT.iva,ILIVROENT.tp_mercad
			*---------------------------------------------------*			

			*---------------------------------------------------*			
			*  ATENCAO : Definir Regra para Informar corretamente
			*           CST em NOTAS DE ENTRADA
			*---------------------------------------------------*			

			IF ILIVROENT.cst <> " "
				LScst   = CHRTRAN(STR(ILIVROENT.origem,1)," ","0") + ;
					  ILIVROENT.cst+ "0"
			ELSE
				DO CASE
					CASE ILIVROENT.tp_mercad = 1 ;
					    and ILIVROENT.base_calc > 0 ;
					    and ILIVROENT.base_calc <> ILIVROENT.vlrvenda
					  	LScst = CHRTRAN(STR(ILIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
					CASE ILIVROENT.tp_mercad = 1 and ILIVROENT.base_calc > 0
					  	LScst = CHRTRAN(STR(ILIVROENT.origem,1)," ","0") + ;
						  "0"  + "0"
					CASE ILIVROENT.tp_mercad = 1 and ILIVROENT.base_calc = 0
					  	LScst = CHRTRAN(STR(ILIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
					CASE   ILIVROENT.tp_mercad = 2 ;
					   and ILIVROENT.icms_subs > 0 ;
					   and ILIVROENT.base_calc > 0
					  	LScst = CHRTRAN(STR(ILIVROENT.origem,1)," ","0") + ;
						  "1"  + "0"
					CASE ILIVROENT.tp_mercad = 2 and ILIVROENT.icms_subs > 0
					  	LScst = CHRTRAN(STR(ILIVROENT.origem,1)," ","0") + ;
						  "6"  + "0"
					CASE LEFT(ILIVROENT.codigo,5) = "99999"
					  	LScst = CHRTRAN(STR(ILIVROENT.origem,1)," ","0") + ;
						  "9"  + "0"
					OTHERWISE
						LScst = CHRTRAN(STR(ILIVROENT.origem,1)," ","0") + ;
						  "4"  + "0"
				ENDCASE
			ENDIF
					
			LSordem = CHRTRAN(STR(LNctrordem,3)," ","0")
			LNctrordem	= LNctrordem + 1
			LScodigo=  LEFT(ILIVROENT.codigo,10)+space(4)


			LSqtde	= STR(ILIVROENT.qtde,12,3)			
			LSqtde  = CHRTRAN(LSqtde," ","0")
			LSqtde  = CHRTRAN(LSqtde,",","")
			LSqtde  = CHRTRAN(LSqtde,".","")

			LSvalor	= STR(ILIVROENT.vlrvenda,13,2)			
			LSvalor = CHRTRAN(LSvalor," ","0")
			LSvalor = CHRTRAN(LSvalor,",","")
			LSvalor = CHRTRAN(LSvalor,".","")

			LSdesconto	= STR(0,13,2)			
			LSdesconto  = CHRTRAN(LSdesconto," ","0")
			LSdesconto  = CHRTRAN(LSdesconto,",","")
			LSdesconto  = CHRTRAN(LSdesconto,".","")

			LSbase_icms = STR(ILIVROENT.base_calc,13,2)			
			LSbase_icms = CHRTRAN(LSbase_icms," ","0")
			LSbase_icms = CHRTRAN(LSbase_icms,",","")
			LSbase_icms = CHRTRAN(LSbase_icms,".","")

			LSbase_subs = (ILIVROENT.base_calc+ILIVROENT.vlripi)*ILIVROENT.iva
			LSbase_subs = STR(LSbase_subs,13,2)			
			LSbase_subs = CHRTRAN(LSbase_subs," ","0")
			LSbase_subs = CHRTRAN(LSbase_subs,",","")
			LSbase_subs = CHRTRAN(LSbase_subs,".","")

			LSvlripi	= STR(ILIVROENT.vlripi,13,2)			
			LSvlripi	= CHRTRAN(LSvlripi," ","0")
			LSvlripi 	= CHRTRAN(LSvlripi,",","")
			LSvlripi 	= CHRTRAN(LSvlripi,".","")

			LSaliq_icms	=	str(ILIVROENT.aliq_icms,5,2)						
			LSaliq_icms	=   CHRTRAN(LSaliq_icms," ","0")						
			LSaliq_icms	=   CHRTRAN(LSaliq_icms,",","")						
			LSaliq_icms	=   CHRTRAN(LSaliq_icms,".","")						


			LScfo		=   CHRTRAN(ILIVROENT.SET_cfo,".","")						
            LScfo	    =   LEFT(LScfo,4)


			
			*******************************************************			
			LStmp1		= LStipo+LScgc+LSmodelo+LSserie+;
						  +LSnumero+LScfo+LScst+LSordem+;
						  LScodigo+LSqtde+LSvalor+LSdesconto+LSbase_icms+;
						  LSbase_subs+LSvlripi+LSaliq_icms
			=FPUT(LNctrl,LStmp1,126)
			LN_Ctr	=	LN_Ctr + 1
			*******************************************************			
			SKIP
		ENDDO
	ENDDO

RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HGD           ULitem_6975 VALID                  є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   41  є
*       є Variable:            ULitem_6975                        є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      25                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hgd     &&  ULitem_6975 VALID
#REGION 1
RETURN

PROCEDURE ULitem_6975
PARAMETERS PrmCodigo,Prmclassifica,Prmdescricao,PrmUnidade,PrmAliq_ipi,;
     Prmaliq_icms, Prmiva,Prmtp_mercad
	*-----------------------------------------------------------*
	* REGISTRA ITENS COMERCIALIZADOS PARA REGISTRO TIPO 75
	*-----------------------------------------------------------*
	PRIVATE LSalias
	LSalias = ALIAS()

	SELE ITENSNEGOC
	SET ORDER TO TAG CODIGO
	m.codigo	= PrmCodigo
	SEEK m.codigo
	IF !FOUND()
 		IF LEFT(m.codigo,5) <> "99999" AND EMPTY(Prmdescricao)		
			SELE grupo
			SET ORDER TO TAG codigo
			SEEK m.codigo
			IF FOUND()
				m.descricao = grupo.descricao
			ELSE
				m.descricao = Prmdescricao
			ENDIF
		ELSE
			m.descricao = Prmdescricao
			IF empty(m.descricao)
				m.descricao = LEFT("SERVICO"+SPACE(25),25)
			ENDIF
		ENDIF
		*--------------------------------------------------------*
		SELE ITENSNEGOC
 		IF LEFT(m.codigo,5) <> "99999" AND EMPTY(Prmdescricao)		
			m.classifica= Prmclassifica
		ELSE
			m.classifica= "999999999999"
		ENDIF
		m.status	= 1
		m.cdg_tipo	= 4

 		IF LEFT(m.codigo,5) <> "99999" AND EMPTY(Prmdescricao)		
			m.unidade 	= PrmUnidade
		ELSE
			m.unidade 	= "UN"
		ENDIF

		m.aliq_ipi	= PrmAliq_ipi
		m.aliq_icms	= Prmaliq_icms
		m.iva		= Prmiva
		m.tp_mercad = Prmtp_mercad
		=edithand("SAVE")
	ENDIF
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HHQ           UL69R_60 VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   42  є
*       є Variable:            UL69R_60                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      26                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hhq     &&  UL69R_60 VALID
#REGION 1
RETURN

*****************************************************************
*  REGISTRO CUPONS  - 60 -
*****************************************************************
FUNCTION UL69R_60
	PARAMETERS LNemp, LNctrl, LDper_ini, LDper_fim, LN_Ctr

	*-------------------------------------------------------------------*
	* PROCESSO SOBRE RESUMO DO MAPAECF
	*-------------------------------------------------------------------*

	=ULLvrCpm()
	
	*-------------------------------------------------------------------*
	SELECT LIVROCPM
	go top


	DO WHILE !EOF()
		LSmsg = "Resum.Cupons (60) "+;
				 	DTOC(LIVROSAI.DATA)
		WAIT WINDOW LSmsg NOWAIT

		*---------------------------------------------------------
		*--> PROCESSAR SOMENTE O REGISTRO RESUMO DOS CUPONS
		* REGISTROS SAO GERADOS QUANDO PROCESSO O ARQUIVO LIVROSAI
		* RESUMINDO OS CUPONS POR DATA E ALIQUOTA

		LDtqbr		= 	LIVROSAI.data
		LSvalor		= 	0
		LSvlr_icms	= 	0
		LSnroini	=   0
		LSnrofim	=   0
		*--------------------------------------------------------------*
		=W_DEFPROC("NOTA.SPR")
		=NFEcfInforme((LNemp),(LDtqbr),(LDtqbr),LSnroIni,LSnroFim,;
					LSvalor, LSvlr_icms)
		*--------------------------------------------------------------*
		*	Identifica‡Жo do Equipamento
		*--------------------------------------------------------------*
		LStipo  	= "60"
		LSMestre	= "M"
		LSdtemi		=	STR(YEAR(LDtqbr),4)+;
						STR(MONTH(LDtqbr),2)+;
						STR(DAY(LDtqbr),2)
		LSdtemi		=   CHRTRAN(LSdtemi," ","0")						


		LSserie     =   LEFT(empresa.ecf_serie+SPACE(20),20)
		LSnumero 	= 	"001"
		LSmodelo	=	"2D"
		
		LSnroini	=   CHRTRAN(STR(LSnroini,6)," ","0")
		LSnrofim	=   CHRTRAN(STR(LSnrofim,6)," ","0")

		SELE mapaecf
		SET NEAR ON
		SET ORDER TO TAG mapa
		SEEK STR(LNemp,3)+DTOS(LDtqbr)+STR(1,4)+STR(17,5,2)	
		SET NEAR OFF
		IF mapaecf.empresa = LNemp AND ;
		   mapaecf.data    = LDtqbr AND ;
		   mapaecf.ecf		= 1 AND ;
		   mapaecf.aliquota = 17
				LSnroredZ		=	mapaecf.ctrreducao
				LSgtInivalor	=	mapaecf.gt_inicial
				LSgtFimvalor	=	mapaecf.gt_final
		ELSE
			SKIP -1
			DO WHILE !BOF() AND mapaecf.empresa = LNemp
				IF  mapaecf.aliquota = 17
					EXIT
				ENDIF
				SKIP -1
			ENDDO
			IF !BOF()
				LSnroredZ		=	mapaecf.ctrreducao
				LSgtInivalor	=	mapaecf.gt_inicial
				LSgtFimvalor	=	mapaecf.gt_final
			ELSE			
				LSnroredZ		=	0
				LSgtInivalor	=	0
				LSgtFimvalor	=	0
			ENDIF
		ENDIF


		LSctrredZ		=   CHRTRAN(STR(LSnroredZ,6)," ","0")

        LSctrReinic     =   CHRTRAN(STR(0,3)," ","0") && ate ter informacao

		SELECT LIVROSAI
		LNctrRegAnaliticos = 0
		LNvendaBruta = 0
		LNregistro = RECNO()
		DO WHILE !EOF() AND LDTqbr = LIVROSAI.data


			*-------------------------------------------------*
			LNvendaBruta =  LNvendaBruta  + VNDABRUTA
			*-------------------------------------------------*
			SKIP
		ENDDO

		GO LNregistro

		LSbranco_B	=  SPACE(37)

		LSgtVndBrt	=	STR(LNvendaBruta,17,2)
		LSgtVndBrt	=   CHRTRAN(LSgtVndBrt," ","0")						
		LSgtVndBrt	=   CHRTRAN(LSgtVndBrt,",","")						
		LSgtVndBrt	=   CHRTRAN(LSgtVndBrt,".","")						

		LSgtFimvalor	=	STR(LSgtFimvalor,17,2)
		LSgtFimvalor	=   CHRTRAN(LSgtFimvalor," ","0")						
		LSgtFimvalor	=   CHRTRAN(LSgtFimvalor,",","")						
		LSgtFimvalor	=   CHRTRAN(LSgtFimvalor,".","")						



		*******************************************************
		LStmp1		=  LStipo+"M"+LSdtemi+LSserie+LSnumero;
					+LSmodelo+LSnroini+LSnrofim+LSctrredZ+;
					+LSctrReinic+LSgtVndBrt+LSgtFimValor+LSbranco_B

		=FPUT(LNctrl,LStmp1,126)
		LN_Ctr	=	LN_Ctr + 1
		*******************************************************			

		DO WHILE !EOF() AND LDTqbr = LIVROSAI.data

			IF (LIVROSAI.CANCELA) > 0

				LSaliq_icms	=	"CANC"
				LSvalor		=	STR(LIVROSAI.CANCELA,13,2)
				LSvalor		=   CHRTRAN(LSvalor," ","0")						
				LSvalor		=   CHRTRAN(LSvalor,",","")						
				LSvalor		=   CHRTRAN(LSvalor,".","")						
				LSbranco_B	=  SPACE(79)
				*******************************************************
				LStmp1		=  LStipo+"A"+LSdtemi+LSserie+LSaliq_icms+;
					+LSvalor+LSbranco_B
				=FPUT(LNctrl,LStmp1,126)
				LN_Ctr	=	LN_Ctr + 1
				*******************************************************			
			ENDIF
			*******************************************************			

			IF LIVROSAI.base_icms > 0

				LSaliq_icms	=	str(LIVROSAI.aliq_icms,5,2)						
				LSaliq_icms	=   CHRTRAN(LSaliq_icms," ","0")						
				LSaliq_icms	=   CHRTRAN(LSaliq_icms,",","")						
				LSaliq_icms	=   CHRTRAN(LSaliq_icms,".","")						

				LSvalor		=	STR(LIVROSAI.base_icms,13,2)
				LSvalor		=   CHRTRAN(LSvalor," ","0")						
				LSvalor		=   CHRTRAN(LSvalor,",","")						
				LSvalor		=   CHRTRAN(LSvalor,".","")						
		
				LSbranco_B	=  SPACE(79)
				LNctrRegAnaliticos = LNctrRegAnaliticos + 1
				*******************************************************
				LStmp1		=  LStipo+"A"+LSdtemi+LSserie+LSaliq_icms+;
						+LSvalor+LSbranco_B
				=FPUT(LNctrl,LStmp1,126)
				LN_Ctr	=	LN_Ctr + 1
				*******************************************************			
			ENDIF

			IF (LIVROSAI.BASE_ISS) > 0
				LSaliq_icms	=	"ISS "
				LSvalor		=	LIVROSAI.BASE_ISS

				LSvalor		=	STR(LSvalor,13,2)
				LSvalor		=   CHRTRAN(LSvalor," ","0")						
				LSvalor		=   CHRTRAN(LSvalor,",","")						
				LSvalor		=   CHRTRAN(LSvalor,".","")						
				LSbranco_B	=  SPACE(79)
				*******************************************************
				LStmp1		=  LStipo+"A"+LSdtemi+LSserie+LSaliq_icms+;
						+LSvalor+LSbranco_B
				=FPUT(LNctrl,LStmp1,126)
				LN_Ctr	=	LN_Ctr + 1
				*******************************************************			
			ENDIF
	
			*----------------------------------------------------------*
			* ATENЂЗO : NO RESUMO DO LIVRO O VALOR DE MERCADORIAS
			*          VENDIDAS COM RECOLHIMENTO EM REGIME DE
			*		   SUBSTITUIЂЗO SAO LANCADOS  EM "ISENTO"
			*          JA O SINTEGRA LANCA NA OPCAO "F" DE MERCADORIA
			*           EM REGIME SUBSTITUIЂЗO
			*----------------------------------------------------------*
			*   NESTE CASO E ATE SEGUNDA ORDEM ESTAMOS PASSANDO
			* A COLUNA ISENTAS PARA "F"
			*----------------------------------------------------------*

			IF (LIVROSAI.base_isent) > 0
				LSaliq_icms	=	"I   "
				LSvalor 	=	LIVROSAI.base_isent

				LSvalor		=	STR(LSvalor,13,2)
				LSvalor		=   CHRTRAN(LSvalor," ","0")						
				LSvalor		=   CHRTRAN(LSvalor,",","")						
				LSvalor		=   CHRTRAN(LSvalor,".","")						
				LSbranco_B	=  SPACE(79)
				*******************************************************
				LStmp1		=  LStipo+"A"+LSdtemi+LSserie+LSaliq_icms+;
						+LSvalor+LSbranco_B
				=FPUT(LNctrl,LStmp1,126)
				LN_Ctr	=	LN_Ctr + 1
				*******************************************************			
			ENDIF
	

			IF (LIVROSAI.BASE_SUBS) > 0
				LSaliq_icms	=	"F   "
				LSvalor 	=	LIVROSAI.BASE_SUBS

				LSvalor		=	STR(LSvalor,13,2)
				LSvalor		=   CHRTRAN(LSvalor," ","0")						
				LSvalor		=   CHRTRAN(LSvalor,",","")						
				LSvalor		=   CHRTRAN(LSvalor,".","")						
				LSbranco_B	=  SPACE(79)
				*******************************************************
				LStmp1		=  LStipo+"A"+LSdtemi+LSserie+LSaliq_icms+;
						+LSvalor+LSbranco_B
				=FPUT(LNctrl,LStmp1,126)
				LN_Ctr	=	LN_Ctr + 1
				*******************************************************			
			ENDIF
			*******************************************************			
			SKIP
		ENDDO
		SELECT LIVROSAI
		IF EOF()
			EXIT
		ENDIF
	ENDDO
	sele &als_CPMTMP
	use

RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HHR           UL69R_70 VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   43  є
*       є Variable:            UL69R_70                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      27                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hhr     &&  UL69R_70 VALID
#REGION 1
RETURN

*---------------------------------------------------------------------*
*		Conhecimento de Tranporte
*---------------------------------------------------------------------*
FUNCTION UL69R_70
	PARAMETERS LNemp, LNctrl, LDper_ini, LDper_fim, LN_Ctr

	*-------------------------------------------------------------------*
	*	NOTAS DE ENTRADA
	*-------------------------------------------------------------------*
	SELECT 	NF.empresa,NF.nota,NF.serie, NF.codforn,NF.inscricao, ;
			NF.FAVORECIDO,;
	        NF.data, NF.uf, TP.cfo AS SET_CFO, NF.tipo,;
	        NF.total_nota, NF.vlrfrete, NF.vlrseguro, NF.vlrdespes,;
            NF.base_subs, NF.icms_subs, NF.base_icms, 	;
	  		NF.vlr_icms, NF.base_isent,NF.base_outr,;
	  		NF.aliq_icms,NF.status;
		FROM &dbf_NFETMP NF, ;
		     &dbf_TIPTMP TP ;
		WHERE NF.ch_produ = "9" ;
		      AND NF.KEY_TIPO = TP.KEY_TIPO ;	
	    ORDER BY NF.DATA, NF.NOTA ;
	  	INTO CURSOR LIVROENT

	SELECT LIVROENT
	GO TOP

	LStipo  		= "70"

	DO WHILE !EOF()
		LSmsg = "Conh.Frete (70) "+;
				 	DTOC(LIVROENT.DATA)+;
					STR(LIVROENT.NOTA,6)
		WAIT WINDOW LSmsg NOWAIT
		&& SE NAO FOR CONHECIMENTO DE TRANSPORTE

		*-----------------------------------------------------------*
		SELE fornece
		SET ORDER TO TAG codigo
		SEEK LIVROENT.codforn

		IF FOUND()
			LSinsc	=  ALLTRIM(fornece.inscricao)
			LScgc	=  CHRTRAN(STR(fornece.cgc,14)," ","0")
		ELSE
			LSinsc	=  ALLTRIM(LIVROENT.inscricao)
			LScgc	=  CHRTRAN(STR(LIVROENT.favorecido,14)," ","0")
		ENDIF

		IF "ISENTO" $ UPPER(LSinsc)
			LSinsc	=  "ISENTO"
			LScgc	=  CHRTRAN(STR(0,14)," ","0")
		ELSE
			LSinsc	=  CHRTRAN(LSinsc,".","")
			LSinsc	=  CHRTRAN(LSinsc,"/","")
			LSinsc	=  CHRTRAN(LSinsc,"-","")
			LSinsc	=  CHRTRAN(LSinsc,"(","")
			LSinsc	=  CHRTRAN(LSinsc,")","")
		ENDIF			
		LSinsc			= LEFT(LSinsc+space(14),14)
		*-----------------------------------------------------------*
		SELECT LIVROENT

		LSdtemi		=	STR(YEAR(LIVROENT.data),4)+;
						STR(MONTH(LIVROENT.data),2)+;
						STR(DAY(LIVROENT.data),2)
		LSdtemi		=   CHRTRAN(LSdtemi," ","0")						
		LSuf		=	LIVROENT.uf
		LSmodelo 	=   "08"


		IF  LIVROENT.serie $ "1/2"
			LSserie		=   "U"
			LSsubserie  = 	LIVROENT.serie+" "
		ELSE
			LSserie		=   LIVROENT.serie
			LSsubserie  = 	"U "
		ENDIF

		LSnumero 	= 	CHRTRAN(STR(LIVROENT.NOTA,6)," ","0")

	*	SELE TIPOOPER
	*	SET ORDER TO TAG TIPO
	*	SEEK "E"+LIVROENT.tipo
	*	IF FOUND()
	*		LScfo	= tipooper.cfo
    *	ELSE	
	*		LScfo		=   CHRTRAN(LIVROENT.SET_cfo,".","")						
	*	ENDIF

		LScfo		=   CHRTRAN(LIVROENT.SET_cfo,".","")						
		LScfo		=   CHRTRAN(LScfo,".","")						

        LScfo	=   LEFT(LScfo,4)



		SELE LIVROENT

		LSvalor		=	str(LIVROENT.total_nota,14,2)						
		LSvalor		=   CHRTRAN(LSvalor," ","0")						
		LSvalor		=   CHRTRAN(LSvalor,",","")						
		LSvalor		=   CHRTRAN(LSvalor,".","")						

		LSbase_icms	=   IIF(LIVROENT.base_subs > 0, 0, LIVROENT.base_icms)

		LSbase_icms	=	str(LSbase_icms,15,2)						
		LSbase_icms	=   CHRTRAN(LSbase_icms," ","0")						
		LSbase_icms	=   CHRTRAN(LSbase_icms,",","")						
		LSbase_icms	=   CHRTRAN(LSbase_icms,".","")						

		LSvlr_icms	=	IIF(LIVROENT.base_subs > 0, 0, LIVROENT.vlr_icms)

		LSvlr_icms	=	str(LSvlr_icms,15,2)						
		LSvlr_icms	=   CHRTRAN(LSvlr_icms," ","0")						
		LSvlr_icms	=   CHRTRAN(LSvlr_icms,",","")						
		LSvlr_icms	=   CHRTRAN(LSvlr_icms,".","")						

		LSbase_isent=	str(LIVROENT.base_isent,15,2)						
		LSbase_isent=   CHRTRAN(LSbase_isent," ","0")						
		LSbase_isent=   CHRTRAN(LSbase_isent,",","")						
		LSbase_isent=   CHRTRAN(LSbase_isent,".","")						
		
		LSbase_outr	=	str(LIVROENT.base_outr,15,2)						
		LSbase_outr	=   CHRTRAN(LSbase_outr," ","0")						
		LSbase_outr	=   CHRTRAN(LSbase_outr,",","")						
		LSbase_outr	=   CHRTRAN(LSbase_outr,".","")						

		LSCifFob	=	"2"

		LSstatus = "N"
		************************************************************
		LStmp1		=	LStipo+LScgc+LSinsc+LSdtemi+LSuf+LSmodelo+;
						LSserie+LSsubserie+LSnumero+LScfo+LSvalor+;
						LSbase_icms+LSvlr_icms+LSbase_isent+;
						LSbase_outr+LSCifFob+LSstatus
		************************************************************
		=FPUT(LNctrl,LStmp1,126)
		LN_Ctr	=	LN_Ctr + 1
		SKIP
	ENDDO
RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HJ5           UL69R_74 VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   44  є
*       є Variable:            UL69R_74                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      28                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hj5     &&  UL69R_74 VALID
#REGION 1
RETURN

*****************************************************************
*  INVENTARIO PRODUTOS - 74 -
*****************************************************************
FUNCTION UL69R_74
	PARAMETERS LNemp, LNctrl, LDper_ini, LDper_fim, LN_Ctr

	PRIVATE LNtotreg, LNcount
	*-------------------------------------------------------------------*
	*	CADASTRO DOS PRODUTOS COMERCIALIZADOS NO PERIODO
	*-------------------------------------------------------------------*
	SELECT EMPRESA
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		RETURN(.F.)
	ENDIF	

    wl_tmp =  STRTRAN(STR(LNemp,3),' ','0')
			COUNT FOR wl_tmp $ grupo.empresas ;


	SELECT SLD.CODIGO, SLD.SLD_ATU, SLD.VLR_ATU, ;
		    GRP.classifica,;
		    GRP.descricao, GRP.Unidade,	;
		     EMPRESA.cgc, ;
		     EMPRESA.inscricao,;
		     EMPRESA.estado ;
		FROM ;
		     EMPRESA, ;
		     &dbf_GRUPO GRP,;
			 &dbf_SALDO SLD;
		WHERE     ;
				 empresa.EMPRESA     = LNemp ;
			AND  empresa.empresa     = SLD.EMPRESA;
			AND  SLD.SLD_ATU         > 0 ;
			AND  YEAR(SLD.DTABERT)   = YEAR(LDper_fim) ;
			AND  MONTH(SLD.DTABERT)  = MONTH(LDper_fim) ;
			AND  GRP.CODIGO          = SLD.CODIGO ;
			AND  wl_tmp $ GRP.empresas ;
			AND  (STR(GRP.tp_control,1) $ "13" OR ;
			     ( LNemp = 10 AND STR(GRP.tp_control,1) $ "123"));
	ORDER BY SLD.CODIGO;
	INTO CURSOR CRSREG_74
	
	count to LNtotreg
	GO TOP

	DO WHILE !EOF()

		MSG = "TIPO 74 => "+ STR(LN_Ctr) + " de " + STR(LNtotreg)+;
		     "  Produto: "+CRSREG_74.codigo

		WAIT WINDOW MSG NOWAIT


		*---------------------------------------------------*
		&& REGISTRAR ITEM COMERCIALIZADO

		m.tp_mercad	= ULtp_Mercad(CRSREG_74.codigo,CRSREG_74.estado)
		m.Aliq_ipi  = ULIPIProd(CRSREG_74.codigo)
		m.Aliq_icms = ULALIQICMS(CRSREG_74.ESTADO)
		m.IVA		= ULiva(CRSREG_74.estado,CRSREG_74.codigo)

		DO ULitem_6975  with ;
		    CRSREG_74.Codigo,    CRSREG_74.classifica,;
		    CRSREG_74.descricao, CRSREG_74.Unidade, ;
		    m.Aliq_ipi,;
	        m.aliq_icms, ;
	        m.iva,;
	        m.tp_mercad
		*---------------------------------------------------*			



		
		LStipo	= "74"

		LSdfim		=	STR(YEAR(LDper_fim),4)+;
						STR(MONTH(LDper_fim),2)+;
						STR(DAY(LDper_fim),2)
		LSdfim		=   CHRTRAN(LSdfim," ","0")						
	
		LScodigo= LEFT(CRSREG_74.codigo+SPACE(14),14)

		LSqtde		=	str(CRSREG_74.SLD_ATU,14,3)						
		LSqtde		=   CHRTRAN(LSqtde," ","0")						
		LSqtde		=   CHRTRAN(LSqtde,",","")						
		LSqtde		=   CHRTRAN(LSqtde,".","")						

		LSvalor		=	str(CRSREG_74.vlr_ATU,14,2)						
		LSvalor		=   CHRTRAN(LSvalor," ","0")						
		LSvalor		=   CHRTRAN(LSvalor,",","")						
		LSvalor		=   CHRTRAN(LSvalor,".","")						

		LScdg_Posse = "1"
		LScgc	= CHRTRAN(STR(CRSREG_74.cgc,14)," ","0")   && 02-cnpj
		
		LScgc	= CHRTRAN(STR(0,14)," ","0")   && 02-cnpj

		LSinsc	= CHRTRAN(CRSREG_74.inscricao," ","")      && 03-inscricao

		LSinsc	= space(14)

		LSestado = CRSREG_74.estado                         && 06-uf

		*------------------------------------------------------------*
		LSbranco  = SPACE(45)
		*******************************************************
		LStmp1	= LStipo+LSdfim+LScodigo+LSqtde+LSvalor+;
					LScdg_posse+LScgc+LSinsc+LSestado+LSbranco
		=FPUT(LNctrl,LStmp1,126)
		LN_Ctr	=	LN_Ctr + 1
		*******************************************************			
		SELE CRSREG_74
		SKIP
	ENDDO

	=UP_FECHA("CRSREG_74")
RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HJN           UL69R_75 VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   45  є
*       є Variable:            UL69R_75                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      29                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hjn     &&  UL69R_75 VALID
#REGION 1
RETURN

*****************************************************************
*  CADASTRO SE PRODUTOS - 75 -
*****************************************************************
FUNCTION UL69R_75
	PARAMETERS LNemp, LNctrl, LDper_ini, LDper_fim, LN_Ctr

	*-------------------------------------------------------------------*
	*	CADASTRO DOS PRODUTOS COMERCIALIZADOS NO PERIODO
	*-------------------------------------------------------------------*
	SELECT EMPRESA
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		RETURN(.F.)
	ENDIF	

	SELE ITENSNEGOC
	SET ORDER TO TAG CODIGO
	GO TOP
	
	DO WHILE !EOF()
		WAIT WINDOW ITENSNEGOC.codigo+ITENSNEGOC.descricao NOWAIT
		
		LStipo	= "75"
		LSdini		=	STR(YEAR(LDper_ini),4)+;
						STR(MONTH(LDper_ini),2)+;
						STR(DAY(LDper_ini),2)
		LSdini		=   CHRTRAN(LSdini," ","0")						

		LSdfim		=	STR(YEAR(LDper_fim),4)+;
						STR(MONTH(LDper_fim),2)+;
						STR(DAY(LDper_fim),2)
		LSdfim		=   CHRTRAN(LSdfim," ","0")						
	
		LScodigo= LEFT(ITENSNEGOC.codigo+SPACE(14),14)

		LSncm   = SPACE(8)

		LSnome	  = LEFT(ITENSNEGOC.descricao+SPACE(53),53)
		LSunidade = LEFT(ITENSNEGOC.unidade+SPACE(6),6)
		LNtab_cst = empresa.tab_cst
		*---------------------------------------------------------*
		*  Buscar CST para operacao mais comum (VLA)
		*---------------------------------------------------------*
		* =W_DEFPROC("ORCAMENT.SPR")
		* m.cst = ORdefcst((LNtab_cst),("VLA"),(ITENSNEGOC.tp_mercad),;
		*  			ITENSNEGOC.codigo)
		*---------------------------------------------------------*

		=W_DEFPROC("TRIBUTAR.SPR")
		M.cst = TRdefcst((LNtab_cst),("VLA"),(ITENSNEGOC.tp_mercad),;
					ITENSNEGOC.codigo)

		
		*------------------------------------------------------------*
		*LScst     	=  	"0"+m.cst+"0"
		*LScst		=   CHRTRAN(LScst," ","0")						

		LSaliq_ipi	=	str(ITENSNEGOC.aliq_ipi,6,2)						
		LSaliq_ipi	=   CHRTRAN(LSaliq_ipi," ","0")						
		LSaliq_ipi	=   CHRTRAN(LSaliq_ipi,",","")						
		LSaliq_ipi	=   CHRTRAN(LSaliq_ipi,".","")						

		LSaliq_icms	=	str(17,5,2)						
		LSaliq_icms	=   CHRTRAN(LSaliq_icms," ","0")						
		LSaliq_icms	=   CHRTRAN(LSaliq_icms,",","")						
		LSaliq_icms	=   CHRTRAN(LSaliq_icms,".","")						

		LSaliq_rdz	=	str(0,6,2)						
		LSaliq_rdz 	=   CHRTRAN(LSaliq_rdz ," ","0")						
		LSaliq_rdz 	=   CHRTRAN(LSaliq_rdz ,",","")						
		LSaliq_rdz 	=   CHRTRAN(LSaliq_rdz ,".","")						

		LSaliq_iva	=	str(ITENSNEGOC.iva,14,2)						
		LSaliq_iva	=   CHRTRAN(LSaliq_iva," ","0")						
		LSaliq_iva	=   CHRTRAN(LSaliq_iva,",","")						
		LSaliq_iva	=   CHRTRAN(LSaliq_iva,".","")						


		LSbranco  = SPACE(25)
		*******************************************************
		LStmp1	= LStipo+LSdini+LSdfim+LScodigo+LSncm+LSnome+;
					LSunidade+LSaliq_ipi+LSaliq_icms+;
					LSaliq_rdz+LSaliq_iva
		=FPUT(LNctrl,LStmp1,126)
		LN_Ctr	=	LN_Ctr + 1
		*******************************************************			
		SELE ITENSNEGOC
		SKIP
	ENDDO
			
RETURN



*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HJO           UL69R_90 VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   46  є
*       є Variable:            UL69R_90                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      30                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hjo     &&  UL69R_90 VALID
#REGION 1
RETURN

*****************************************************************
*  TOTALIZADORES  - 90 -
*****************************************************************
FUNCTION UL69R_90
	PARAMETERS LNemp,LNctrl,LNctr_10,LNctr_11,LNctr_50,LNctr_53,LNctr_54,;
				LNctr_60,LNctr_70,LNctr_74,LNctr_75

	*-------------------------------------------------------------------*
	*	CADASTRO DOS PRODUTOS COMERCIALIZADOS NO PERIODO
	*-------------------------------------------------------------------*
	SELECT EMPRESA
	SET ORDER TO TAG empresa
	SEEK LNemp
	IF !FOUND()
		RETURN(.F.)
	ENDIF	

	LStipo	= "90"
	LScgc	= 	CHRTRAN(STR(empresa.cgc,14)," ","0")
	LSinsc	= 	CHRTRAN(empresa.inscricao," ","")
	LSinsc	= 	CHRTRAN(LSinsc,".","")
	LSinsc	= 	CHRTRAN(LSinsc,"/","")
	LSinsc	= 	CHRTRAN(LSinsc,"-","")
	LSinsc	= 	LEFT(LSinsc+space(14),14)


	LS_tp50	=	"50"
	LS_ct50	=	CHRTRAN(STR(LNctr_50,8)," ","0")

	LS_tp53	=	"53"
	LS_ct53	=	CHRTRAN(STR(LNctr_53,8)," ","0")

	LS_tp54	=	"54"
	LS_ct54	=	CHRTRAN(STR(LNctr_54,8)," ","0")

	LS_tp60	=	"60"
	LS_ct60	=	CHRTRAN(STR(LNctr_60,8)," ","0")

	LS_tp70	=	"70"
	LS_ct70	=	CHRTRAN(STR(LNctr_70,8)," ","0")

	LS_tp74	=	"74"
	LS_ct74	=	CHRTRAN(STR(LNctr_74,8)," ","0")

	LS_tp75	=	"75"
	LS_ct75	=	CHRTRAN(STR(LNctr_75,8)," ","0")

	LNctr_90=	1
	LS_tp90	=	"90"
	LS_ct90	=	CHRTRAN(STR(LNctr_90,8)," ","0")


	LSspaco =   SPACE(15)

	LS_ctgr	=	LNctr_10+LNctr_11+LNctr_50+LNctr_53+LNctr_54+;
				LNctr_60+LNctr_70+LNctr_74+LNctr_75+LNctr_90

	LS_tpGR	=	"99"
	LS_ctgr	=	CHRTRAN(STR(LS_ctgr,8)," ","0")

	*******************************************************
	LStmp1	= LStipo+LScgc+LSinsc+;
			  LS_tp50+LS_ct50+LS_tp53+LS_ct53+LS_tp54+LS_ct54+;
			  LS_tp60+LS_ct60+LS_tp70+LS_ct70+LS_tp74+LS_ct74+;
			  LS_tp75+LS_ct75+LS_tpGr+LS_ctgr+ LSspaco+"1"

	=FPUT(LNctrl,LStmp1,126)
RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HJP           ULLvrSda50 VALID                   є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   47  є
*       є Variable:            ULLvrSda50                         є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      31                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118hjp     &&  ULLvrSda50 VALID
#REGION 1
return

FUNCTION ULLvrSda50
    =UP_fecha("A1_TMP" ,.T.)
    =UP_fecha("A2_TMP" ,.T.)
    =UP_fecha("A3_TMP" ,.T.)
    =UP_fecha("TMP2" ,.T.)
	
	*-------------------------------------------------------------------*
	*	NOTAS DE SAIDA
	*-------------------------------------------------------------------*
    * vlr_icms =  (base_icms * aliq_icms/100) as vlr_icms,;
	*-------------------------------------------------------------------*
    *-----> NAO CANCELADAS
	*-------------------------------------------------------------------*
	* SQL DIVIDIDO EM DUAS PARTES POIS OCORRE ERRO DE COMANDO MUITO LONGO
	*-------------------------------------------------------------------*
	* PARTE - 1
	*-------------------------------------------------------------------*
	   SELECT ;
   		  N.CGC,;
		  N.empresa, N.nota,N.serie,;
          "1" AS IND_OPER,;
   		  "0" AS IND_EMIT,;
   		  T.COD_MOD_RF AS COD_MOD,;
   		  "00" AS COD_SIT,;
 		  N.cupom, N.favorecido,N.tp_pessoa,;
 		  IIF(N.tp_pessoa=1,STR(N.favorecido,11),STR(0,11)) AS CPF,;
		  IIF(N.tp_pessoa=2,STR(N.favorecido,14),STR(0,14)) AS CNPJ,;
          N.inscricao,;
          N.UFOrig,N.MunOrig,;
          N.UFDstn,N.MunDstn,;
          N.tipo, N.data,N.vlrfrete,N.vlrseguro,;
          N.vlrdespes,N.status,;
          N.total_nota AS VlrNota;
   	FROM  &dbf_TIPTMP T, &dbf_NFSTMP N ;
    WHERE     N.EMPRESA  = PrmEmp;
          AND N.status = 1 ;
          AND N.operacao = "S" ;
   		  AND N.CUPOM = 0 ;
   		  AND T.KEY_TIPO = N.KEY_TIPO ;
   	      AND T.PROCESSO $ "Ss" ;
    GROUP BY N.EMPRESA, N.DATA, N.NOTA ;
    INTO TABLE \TMP\A1_TMP

	*-------------------------------------------------------------------*
	* PARTE - 2 ==> JA UNIFICA COM PARTE - 1
	*-------------------------------------------------------------------*


   SELECT T.*,;
	  	  I.aliq_icms,;
          ULdefCfo(T.empresa,T.tipo,i.tp_mercad,"SAIDA") AS SET_CFO,;
   		  CHRTRAN( STR(i.origem,1)+i.cst," ","0") AS CST,;
          ULCFPS(T.UFOrig,T.MunOrig,;
          	T.UFDstn,T.MunDstn,i.tp_mercad,"SAIDA") AS CFPS,;
          ULCST_ISS(i.vlr_iss,"SAIDA") AS CST_ISS,;
          ULCST_IPI(i.vlripi,"SAIDA") AS CST_IPI,;
          ULGenero(i.tp_mercad,i.classifica,"SAIDA") AS GENERO,;
		 "000" AS CLSCOMNC,;
		 "00" AS CLSGAS,"00" AS CLSAGUA,"00" AS CLSENRG;
   	FROM  \TMP\A1_TMP T, &dbf_ITMTMP I;
    WHERE LEFT(I.OPERACAO,1)="S" ;
   	 	  AND I.EMPRESA=T.EMPRESA AND I.NOTA=T.NOTA ;
   		  AND I.SERIE=T.SERIE ;
    GROUP BY T.EMPRESA,T.DATA,T.NOTA,SET_CFO,I.ALIQ_ICMS ;
    INTO TABLE \TMP\A2_TMP



   SELECT T.*,;
 		  SUM(I.base_calc) AS BASE_ICMS,;
 		  SUM(I.Base_calc * I.aliq_icms/100) AS VLR_ICMS,;
		  SUM(I.base_isent) AS BASE_ISENT,SUM(I.base_outr) AS BASE_OUTR,;
		  SUM(I.base_subs) AS BASE_SUBS,SUM(I.icms_subs) AS ICMS_SUBS,;
		  SUM(I.base_ISS) AS BASE_ISS,SUM(I.vlr_iss) AS VLR_ISS,;
	  	  SUM(I.base_ipi) AS BASE_IPI,SUM(I.vlripi) AS VLR_IPI,;
	 	  SUM(I.base_isipi) AS BASE_ISIPI,0,00 AS VL_OUT_IPI,;
	  	  SUM(I.vlrvenda) AS VLR_ITEM,;
	  	  SUM(I.vlrvenda+I.icms_subs+I.vlripi) AS TOTAL_NOTA;
   	FROM  \TMP\A2_TMP T, &dbf_ITMTMP I;
    WHERE LEFT(I.OPERACAO,1)="S" ;
   	 	  AND I.EMPRESA=T.EMPRESA AND I.NOTA=T.NOTA ;
   		  AND I.SERIE=T.SERIE ;
    GROUP BY T.EMPRESA,T.DATA,T.NOTA,SET_CFO,I.ALIQ_ICMS ;
    INTO TABLE \TMP\A3_TMP

    =UP_fecha("A2_TMP" ,.T.)


	*-------------------------------------------------------------------*
    *-----> CANCELADAS
	*-------------------------------------------------------------------*

SELECT ;
N.CGC,N.empresa, N.nota,N.serie,;
"1"	AS IND_OPER,"0"	AS IND_EMIT,"01" AS COD_MOD,"00" AS COD_SIT,;
N.cupom, N.favorecido,N.tp_pessoa,IIF(N.tp_pessoa=1,STR(N.favorecido,11),STR(0,11)) AS CPF,;
IIF(N.tp_pessoa=2,STR(N.favorecido,14),STR(0,14)) AS CNPJ,;
N.inscricao,N.UFOrig,N.MunOrig,;
N.uf,N.UF AS UFDstn,N.cidade AS MunDstn,N.tipo,N.data,;
N.vlrfrete,N.vlrseguro,N.vlrdespes,N.status,N.total_nota AS VlrNota,;
N.aliq_icms,T.cfo AS SET_CFO,"00" AS CST,"0000" AS CFPS,;
"00" AS CST_ISS,"00" AS CST_IPI,"00" AS GENERO,"000" AS CLSCOMNC,;
"00" AS CLSGAS,"00" AS CLSAGUA,"00" AS CLSENRG,;
N.base_icms,(N.Base_icms * N.aliq_icms/100) AS VLR_ICMS,;
N.base_isent,N.base_outr,N.base_subs,N.icms_subs,;
N.base_iss,N.vlr_iss,N.base_ipi,N.VLR_IPI,;
N.base_isipi,0,00 AS VL_OUT_IPI,0,00 AS VLR_ITEM,;
N.TOTAL_NOTA;
FROM &dbf_NFSTMP N, &dbf_TIPTMP T;
WHERE N.EMPRESA=PrmEmp ;
		  AND N.status=2 AND N.operacao="S";
   		  AND N.CUPOM=0 AND T.KEY_TIPO=N.KEY_TIPO ;
    INTO TABLE \TMP\TMP2


    SELE A3_TMP
    APPEND FROM \TMP\TMP2
	*-------------------------------------------------------------------*
    *-----> UNIAO CANCELADAS E NAO CANCELADAS
	*-------------------------------------------------------------------*
    =UP_fecha("TMP2" ,.T.)


    SELECT * FROM \TMP\A3_TMP ;
     ORDER BY EMPRESA, DATA, NOTA, SET_CFO, ALIQ_ICMS ;
    	INTO TABLE  \TMP\LIVROSAI
*---------------------------------------------------------------------*
	GO TOP
    =UP_fecha("A3_TMP" ,.T.)
	
	
RETURN





*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HKW           ULItmSda54 VALID                   є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   48  є
*       є Variable:            ULItmSda54                         є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      32                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118hkw     &&  ULItmSda54 VALID
#REGION 1
return

FUNCTION ULItmSda54
	*-------------------------------------------------------------------*
	*	ITENS DAS NOTAS DE SAIDA
	*-------------------------------------------------------------------*


   SELECT ;
          "1"  AS IND_OPER,;
          "0"  AS IND_EMIT,;
   		  "01"  AS COD_MOD,;
   		  "00"  AS COD_SIT,;
   		  NF.EMPRESA, NF.NOTA,;
   		  NF.SERIE, NF.CUPOM, NF.FAVORECIDO, NF.TP_PESSOA, NF.INSCRICAO,;
          NF.UF, NF.tipo, NF.data, NF.vlrfrete,;
		  NF.vlrseguro, NF.vlrdespes, NF.status,;
          NF.total_nota AS VlrNota,;
		  ULdefCfo(NF.empresa,NF.tipo,it.tp_mercad,"SAIDA") AS SET_CFO,;
	  	  IT.codigo, IT.CLASSIFICA, IT.DESCRICAO, IT.UNIDADE,;
	  	  IT.ORIGEM,IT.CST,IT.ALIQ_IPI, IT.ALIQ_ICMS,;
	  	  IT.IVA, IT.TP_MERCAD, IT.QTDE, IT.VLRVENDA, IT.BASE_CALC,;
	  	  IT.BASE_SUBS,;
	 	  IT.base_isent,;
		  IT.base_outr, ;
	  	  IT.base_ipi,;
	  	  IT.vlripi,;
	 	  IT.base_isipi,;
		  0,00  AS VL_OUT_IPI;
   	FROM  &dbf_NFSTMP NF,;
   	      &dbf_TIPTMP TP,;
   	      &dbf_ITMTMP IT ;
    WHERE ;
              NF.status = 1 ;
   		  AND NF.operacao = "S" ;
   		  AND NF.CUPOM = 0 ;
   		  AND TP.KEY_TIPO = NF.KEY_TIPO ;
   	      AND TP.PROCESSO $ "Ss" ;
   		  AND LEFT(IT.OPERACAO,1) = "S" ;
   	 	  AND IT.EMPRESA = NF.EMPRESA ;
   		  AND IT.NOTA    = NF.NOTA ;
   		  AND IT.SERIE   = NF.SERIE ;
    ORDER BY NF.EMPRESA, NF.DATA, NF.NOTA, IT.CODIGO ;
  	INTO CURSOR ILIVROSAI

RETURN



*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HL6           ULLvrEnt50 VALID                   є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   49  є
*       є Variable:            ULLvrEnt50                         є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      33                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118hl6     &&  ULLvrEnt50 VALID
#REGION 1
return

FUNCTION ULLvrEnt50

	*-------------------------------------------------------------------*
	*	NOTAS DE ENTRADA
	*		where ch_produ <> "9" faz com que as notas de conhecimento
    *     de transp nao sejam selecionadas
	*-------------------------------------------------------------------*
	SELECT 	;
		N.CGC
		N.empresa,N.nota,N.serie,;
        "0" AS IND_OPER,;
 		"0" AS IND_EMIT,;
   		T.COD_MOD_RF AS AS COD_MOD,;
   		"00" AS COD_SIT,;
        "000000" AS CUPOM,;
		N.FAVORECIDO,n.tp_pessoa,;
	    IIF(N.tp_pessoa=1,STR(N.favorecido,11),STR(0,11)) AS CPF,;
		IIF(N.tp_pessoa=2,STR(N.favorecido,14),STR(0,14)) AS CNPJ,;
        N.codforn,N.inscricao,;
        N.UFOrig,N.MunOrig,;
        N.UFDstn,N.MunDstn,;
        N.uf,;
        N.tipo,N.data,N.data_emi,;
		N.vlrfrete,N.vlrseguro,N.vlrdespes,;
        N.status,;
        (I.vlrvenda+I.vlripi+I.icms_subs) AS VlrNota,;
		N.aliq_icms,;
		ULdefCfo(N.empresa,N.tipo,i.tp_mercad,"ENTRADA") AS SET_CFO;
   	FROM  &dbf_NFETMP N,;
   	      &dbf_TIPTMP T,;
   	      &dbf_INETMP I ;
    WHERE ;
            LEFT(N.situacao,1) = "C";
		AND N.ch_produ <> "9";
        AND N.CH_OPERA <> "5";
   		AND N.KEY_TIPO = T.KEY_TIPO;
   	    AND T.PROCESSO $ "Ee";
   		AND I.KEY_TIPO = N.KEY_TIPO;
   		AND I.EMPRESA = N.EMPRESA;
   		AND I.NOTA = N.NOTA ;
   		AND I.SERIE = N.SERIE;
   		AND I.FAVORECIDO = N.FAVORECIDO ;
    GROUP BY N.EMPRESA,N.DATA,N.NOTA,SET_CFO,I.ALIQ_ICMS;
    INTO CURSOR TMPLIVR


	SELECT 	;
		L.*,;
        "**" AS CST,;
        "***" AS CFPS,;
        "**" AS CST_ISS,;
        "**" AS CST_IPI,;
        "**" AS GENERO,;
        "***" AS CLSCOMNC,;
        "**" AS CLSAGUA,;
        "**" AS CLSENRG,;
	  	IIF(N.BASE_SUBS = 0,N.base_icms,N.base_icms*0) AS BASE_ICMS,;
	  	IIF(N.BASE_SUBS = 0,N.VLR_ICMS,N.VLR_ICMS*0) AS VLR_ICMS,;
		N.BASE_ISENT,(N.base_outr+NF.BASE_ISS)  AS BASE_OUTR, ;
		N.base_subs,N.icms_subs,;
		N.base_ISS,(N.base_subs*N.aliq_iss/100) AS VLR_ISS,;
		N.base_ipi,N.vlr_ipi,N.base_isipi,0.00 as VL_OUT_IPI,;
        I.vlrvenda AS Vlr_Item,;
	  	N.TOTAL_NOTA;
   	FROM  ;
		  TMPLIVR L,;
   	      &dbf_NFETMP N,;
   	      &dbf_TIPTMP T,;
   	      &dbf_INETMP I ;
    WHERE ;
            LEFT(N.situacao,1) = "C";
		AND N.ch_produ <> "9";
        AND N.CH_OPERA <> "5";
   		AND N.KEY_TIPO = T.KEY_TIPO;
   	    AND T.PROCESSO $ "Ee";
   		AND I.KEY_TIPO = N.KEY_TIPO;
   		AND   I.EMPRESA = N.EMPRESA;
   		AND   I.NOTA = N.NOTA ;
   		AND   I.SERIE = N.SERIE;
   		AND   I.FAVORECIDO = N.FAVORECIDO;
   		AND L.EMPRESA = N.EMPRESA;
   		AND L.NOTA = N.NOTA ;
   		AND L.SERIE = N.SERIE;
   		AND L.FAVORECIDO = N.FAVORECIDO ;
    GROUP BY N.EMPRESA,N.DATA,N.NOTA,SET_CFO,I.ALIQ_ICMS;
    INTO CURSOR TMPLIVR

    SELECT * FROM TMPLIVR NF;
	    ORDER BY NF.EMPRESA, NF.DATA, NF.NOTA, NF.SET_CFO, NF.ALIQ_ICMS ;
	    INTO CURSOR LIVROENT
*---------------------------------------------------------------------*
RETURN





*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HL7           ULItmEnt54 VALID                   є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   50  є
*       є Variable:            ULItmEnt54                         є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      34                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118hl7     &&  ULItmEnt54 VALID
#REGION 1
return

FUNCTION ULItmEnt54
	*-------------------------------------------------------------------*
	*	NOTAS DE ENTRADA
	*-------------------------------------------------------------------*
     SELECT ;
  	  	  NF.empresa, NF.nota, NF.serie, NF.CGC,;
  	  	  NF.FAVORECIDO,nf.codforn, NF.TP_PESSOA, NF.INSCRICAO,;
          NF.UF, NF.tipo, NF.data, NF.vlrfrete, NF.vlrseguro,;
		  NF.vlrdespes,NF.status,(IT.vlrvenda+IT.vlripi+IT.icms_subs)  AS VlrNota,;
		  ULdefCfo(NF.empresa,NF.tipo,it.tp_mercad,"ENTRADA") AS SET_CFO,;
	  	  IT.codigo, IT.CLASSIFICA, IT.DESCRICAO, IT.UNIDADE,;
		  IT.ORIGEM,IT.CST,IT.ALIQ_IPI,IT.ALIQ_ICMS,;
	  	  IT.IVA, IT.TP_MERCAD,IT.QTDE,IT.VLRVENDA,IT.BASE_CALC,;
 	  	  IIF(NF.BASE_SUBS = 0,IT.base_calc,IT.base_calc*0) AS BASE_ICMS,;
  	  	  IIF(NF.BASE_SUBS = 0,IT.VLR_ICMS,IT.VLR_ICMS*0) AS VLR_ICMS,;
	  	  IT.BASE_SUBS,IT.ICMS_SUBS,  IT.VLRIPI;
   	FROM  &dbf_NFETMP NF, &dbf_TIPTMP TP, &dbf_INETMP IT ;
    WHERE ;
            LEFT(NF.situacao,1) = "C" ;
		AND NF.ch_produ <> "9" ;
        AND NF.CH_OPERA <> "5" ;
   		AND NF.KEY_TIPO = TP.KEY_TIPO ;
   	    AND TP.PROCESSO $ "Ee" ;
   		AND IT.KEY_TIPO = NF.KEY_TIPO ;
   		AND IT.EMPRESA = NF.EMPRESA ;
   		AND IT.NOTA = NF.NOTA ;
   		AND IT.SERIE = NF.SERIE;
   		AND IT.FAVORECIDO = NF.FAVORECIDO ;
    ORDER BY NF.EMPRESA, NF.DATA, NF.NOTA, IT.CODIGO ;
	INTO CURSOR ILIVROENT


*---------------------------------------------------------------------*
RETURN





*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HL8           ULLvrSda53 VALID                   є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   51  є
*       є Variable:            ULLvrSda53                         є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      35                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118hl8     &&  ULLvrSda53 VALID
#REGION 1
return

FUNCTION ULLvrSda53

	*-------------------------------------------------------------------*
	*	NOTAS DE SAIDA  =>
	*           icms_subs > 0   => Com Valor de Substituicao Tributaria
	*           tipo <> "CPM"   => Nao seja Cupom
	*           Operacao = "S" => Nao se NF de Entrada
	*-------------------------------------------------------------------*
	*-------------------------------------------------------------------*
	*	NOTAS DE SAIDA
	*-------------------------------------------------------------------*
	*-------------------------------------------------------------------*
    *-----> NAO CANCELADAS
	*-------------------------------------------------------------------*

   IF USED("TMP1")
      SELE TMP1
      USE
   ENDIF


   SELECT ;
   		 "01"  AS COD_MOD,;
   		  NF.empresa   , NF.nota,NF.serie,NF.cupom, ;
		  NF.CGC,NF.FAVORECIDO,;
          NF.tp_pessoa, NF.inscricao,NF.uf, ;
		  NF.tipo, NF.data,;
		  NF.vlrfrete, NF.vlrseguro,  NF.vlrdespes, NF.status,;
          NF.total_nota  AS VlrNota,;
		  ULdefCfo(NF.empresa,NF.tipo,it.tp_mercad,"SAIDA") AS SET_CFO,;
	  	  IT.aliq_icms,;
		  SUM(IT.vlrvenda+IT.icms_subs+IT.vlripi)  AS TOTAL_NOTA,;
	  	  SUM(IT.base_subs) AS BASE_SUBS,;
	  	  SUM(IT.icms_subs) AS ICMS_SUBS,;
	  	  SUM(IT.base_calc) AS BASE_ICMS,;
	  	  SUM(IT.Base_calc * IT.aliq_icms/100) AS VLR_ICMS,;
	 	  SUM(IT.base_isent) AS BASE_ISENT ,;
		  SUM(IT.base_outr)  AS BASE_OUTR ;
   	FROM  &dbf_NFSTMP  NF,;
   	      &dbf_TIPTMP  TP,;
   	      &dbf_ITMTMP  IT ;
    WHERE ;
              NF.status = 1             ;
   		  AND NF.operacao =  "S"        ;
          AND NF.icms_subs > 0          ;
   		  AND TP.KEY_TIPO = NF.KEY_TIPO ;
   	      AND TP.PROCESSO $ "Ss"        ;
   		  AND LEFT(IT.OPERACAO,1) = "S" ;
   	 	  AND IT.EMPRESA = NF.EMPRESA   ;
   		  AND IT.NOTA    = NF.NOTA      ;
   		  AND IT.SERIE   = NF.SERIE     ;
          AND IT.icms_subs > 0          ;
    GROUP BY NF.EMPRESA, NF.DATA, NF.NOTA, SET_CFO, IT.ALIQ_ICMS ;
    INTO CURSOR CRSTMP1

    SELECT * FROM CRSTMP1 NF ;
       ORDER BY NF.EMPRESA, NF.DATA, NF.NOTA, NF.SET_CFO, NF.ALIQ_ICMS ;
       INTO TABLE \TMP\TMP1

	*-------------------------------------------------------------------*
    *-----> CANCELADAS
	*-------------------------------------------------------------------*

	SELECT 	;
   		 "01"  AS COD_MOD,;
		NF.empresa , NF.nota,NF.serie,NF.cupom, ;
		NF.CGC, NF.FAVORECIDO,;
        NF.tp_pessoa, NF.inscricao,NF.uf, ;
		NF.tipo, NF.data,;
		NF.vlrfrete, NF.vlrseguro,NF.vlrdespes, NF.status,;
        NF.total_nota AS VlrNota,;
	    TP.cfo  AS SET_CFO,NF.aliq_icms,NF.TOTAL_NOTA,;
	  	NF.base_subs,NF.icms_subs,NF.base_icms,;
	  	(NF.Base_icms * NF.aliq_icms/100) AS VLR_ICMS,;
		NF.base_isent, NF.base_outr ;
   	FROM  &dbf_NFSTMP  NF,;
   	      &dbf_TIPTMP  TP;
    WHERE ;
              NF.status = 2 ;
   		  AND NF.operacao = "S";
          AND NF.icms_subs > 0 ;
   		  AND TP.KEY_TIPO = NF.KEY_TIPO ;
    ORDER BY NF.EMPRESA, NF.DATA, NF.NOTA, SET_CFO, NF.ALIQ_ICMS ;
    INTO TABLE \TMP\TMP2

    SELE TMP1
    APPEND FROM \TMP\TMP2
	*-------------------------------------------------------------------*
    *-----> UNIAO CANCELADAS E NAO CANCELADAS
	*-------------------------------------------------------------------*

    SELECT * FROM \TMP\TMP1 ;
     ORDER BY EMPRESA, DATA, NOTA, SET_CFO, ALIQ_ICMS ;
    	INTO CURSOR SLIVROSAI

	*---------------------------------------------------------------------*
	GO TOP
RETURN





*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HM9           ULLvrEnt53 VALID                   є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   52  є
*       є Variable:            ULLvrEnt53                         є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      36                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118hm9     &&  ULLvrEnt53 VALID
#REGION 1
return

FUNCTION ULLvrEnt53

	*-------------------------------------------------------------------*
	*	NOTAS DE ENTRADA
	*-------------------------------------------------------------------*

	*-------------------------------------------------------------------*
	*	NOTAS DE ENTRADA
	*		where ch_produ <> "9" faz com que as notas de conhecimento
    *     de transp nao sejam selecionadas
	*-------------------------------------------------------------------*


	SELECT 	;
		NF.empresa   , NF.nota,    NF.serie,  ;
		NF.CGC, NF.FAVORECIDO,;
        NF.codforn   , NF.inscricao,NF.uf, ;
		NF.tipo,     NF.data,    NF.data_emi,;
		NF.vlrfrete, NF.vlrseguro,  NF.vlrdespes,;
        NF.total_nota  AS VlrNota,;
	    ULdefCfo(NF.empresa,NF.tipo,it.tp_mercad,"ENTRADA") AS SET_CFO,;
	  	NF.aliq_icms,NF.TOTAL_NOTA,NF.base_subs,NF.icms_subs,;
	  	IIF(NF.BASE_SUBS = 0,NF.base_icms,NF.base_icms*0) AS BASE_ICMS,;
	  	IIF(NF.BASE_SUBS = 0,NF.VLR_ICMS,NF.VLR_ICMS*0) AS VLR_ICMS,;
		NF.BASE_ISENT ,(NF.base_outr+NF.BASE_ISS)  AS BASE_OUTR ;
   	FROM  &dbf_NFETMP NF,;
   	      &dbf_TIPTMP TP,;
   	      &dbf_INETMP IT ;
    WHERE ;
            LEFT(NF.situacao,1) = "C" ;
		AND NF.ch_produ <> "9" ;
        AND NF.CH_OPERA <> "5" ;
   		AND NF.KEY_TIPO  = TP.KEY_TIPO ;
   	    AND TP.PROCESSO  $ "Ee" ;
   		AND IT.KEY_TIPO  = NF.KEY_TIPO ;
   		AND IT.EMPRESA   = NF.EMPRESA ;
   		AND IT.NOTA      = NF.NOTA ;
   		AND IT.SERIE     = NF.SERIE ;
   		AND IT.FAVORECIDO = NF.FAVORECIDO ;
    GROUP BY NF.EMPRESA, NF.DATA, NF.NOTA, SET_CFO, IT.ALIQ_ICMS ;
    INTO CURSOR TMPLIVR

    SELECT * FROM TMPLIVR NF;
      WHERE  NF.ICMS_SUBS > 0 ;
	    ORDER BY NF.EMPRESA, NF.DATA, NF.NOTA, NF.SET_CFO, NF.ALIQ_ICMS ;
	    INTO CURSOR SLIVROENT
*---------------------------------------------------------------------*
RETURN





*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HMJ           UL69R_60 VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   53  є
*       є Variable:            UL69R_60                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      37                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _1wv118hmj     &&  UL69R_60 VALID
#REGION 1
RETURN

*****************************************************************
*  REGISTRO CUPONS  - 60 -
*****************************************************************
FUNCTION ULLvrCpm

	*-------------------------------------------------------------------*
	* PROCESSO SOBRE RESUMO DO MAPAECF
	*-------------------------------------------------------------------*

	*-------------------------------------------------------------------*

	*----------------------------------------------------------*
	*  TEMPORARIO PARA AGREGAR CUPONS NORMAIS
	*----------------------------------------------------------*
	LSarqtmp 	= "" 			&& EX: \TMP\TMP0001
	LSaliastmp 	= "STG" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
		DO OBJ_ALER.SPR  WITH ;
			"FALHA !!! NЖo Foi Possivel Definir Arquivo Temporario"
		RETURN
	ENDIF
	dbf_CPMTMP  = wp_dirtmp+LSaliastmp+".DBF"
	als_CPMTMP  = LSaliastmp
	*----------------------------------------------------------*
	*  TEMPORARIO PARA AGREGAR CUPONS CANCELADOS
	*----------------------------------------------------------*
	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "CAN" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
		DO OBJ_ALER.SPR  WITH ;
			"FALHA !!! NЖo Foi Possivel Definir Arquivo Temporario"
		RETURN
	ENDIF
	dbf_CANTMP  = wp_dirtmp+LSaliastmp+".DBF"
	als_CANTMP  = LSaliastmp
	*----------------------------------------------------------*
	*-------------------------------------------------------------------*
	* PROCESSO APURANDO CUPONS EMITIDOS E NAO CANCELADOS MAPAECF
	*-------------------------------------------------------------------*
 	SELECT  "5.00" AS CFO ,;
			DATA, ;
			ALIQ_ICMS, ;
			"XX"			 	AS UF, ;
		 	SUM(TOTAL_NOTA)  	AS TOTAL_NOTA,;
		 	SUM(BASE_ICMS)   	AS BASE_ICMS,;
			SUM(BASE_ISENT)  	AS BASE_ISENT,;
			SUM(BASE_OUTR)   	AS BASE_OUTR,;
			SUM(BASE_ISS)    	AS BASE_ISS,;
			SUM(BASE_SUBS)   	AS BASE_SUBS,;
			0*SUM(BASE_SUBS)      AS CANCELA,;
			SUM(BASE_ICMS+BASE_ISENT+BASE_OUTR+BASE_ISS+BASE_SUBS) ;
			              AS VNDABRUTA;
 	FROM &dbf_NFSTMP ;
		WHERE   status = 1 ;
			AND  operacao  = "S" ;
		   	AND  cupom > 0 ;
	GROUP BY DATA,ALIQ_ICMS;
   	INTO TABLE &dbf_CPMTMP

	*-------------------------------------------------------------------*
	* PROCESSO APURANDO CUPONS  CANCELADOS
	*-------------------------------------------------------------------*
 	SELECT  "5.00" AS CFO ,  ;
			DATA, ;
			ALIQ_ICMS, ;
			"XX"			 AS UF, ;
		 	0    AS TOTAL_NOTA,;
		 	0	 AS BASE_ICMS,;
			0	 AS BASE_ISENT,;
			0	 AS BASE_OUTR,;
			0	 AS BASE_ISS,;
			0	 AS BASE_SUBS,;
		 	SUM(TOTAL_NOTA)  AS CANCELA,;
			SUM(TOTAL_NOTA)  AS VNDABRUTA;
	FROM &dbf_NFSTMP ;
		WHERE   status = 2 ;
		    AND  operacao  = "S" ;
		    AND  cupom > 0 ;
	GROUP BY DATA,ALIQ_ICMS;
   	INTO TABLE &dbf_CANTMP

	*-------------------------------------------------------------------*
	* PROCESSO FUSAO CUPONS NORMAIS E CANCELADOS
	*-------------------------------------------------------------------*

   	SELECT  &als_CPMTMP
	append from   &dbf_CANTMP

	*-------------------------------------------------------------------*
	* PROCESSO AGRUPAMENTO DE CUPONS NORMAIS E CANCELADOS
	*-------------------------------------------------------------------*

 	SELECT  "5.00" AS CFO ,  ;
			DATA, ;
			ALIQ_ICMS, ;
			"XX"			 	AS UF, ;
		 	SUM(TOTAL_NOTA)  	AS TOTAL_NOTA,;
		 	SUM(BASE_ICMS)   	AS BASE_ICMS,;
			SUM(BASE_ISENT)  	AS BASE_ISENT,;
			SUM(BASE_OUTR)   	AS BASE_OUTR,;
			SUM(BASE_ISS)    	AS BASE_ISS,;
			SUM(BASE_SUBS)   	AS BASE_SUBS,;
			SUM(CANCELA)        AS CANCELA,;
			SUM(VNDABRUTA)      AS VNDABRUTA;
	FROM &dbf_CPMTMP ;
	GROUP BY DATA,ALIQ_ICMS;
   	INTO CURSOR LIVROCPM

RETURN


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _1WV118HN0           ULArqItens VALID                   є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCT0310A,     Record Number:   54  є
*       є Variable:            ULArqItens                         є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      38                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _1wv118hn0     &&  ULArqItens VALID
#REGION 1
RETURN

FUNCTION ULArqItens
	*---------------------------------------------------------*
	* Gerar Arq. Temporario para registrar itens vendidos
	*---------------------------------------------------------*
	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "TMP" 		&&     TMP001
	LSaliastmp = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	IF EMPTY(LSaliastmp)
 		WAIT WINDOW "Nao Foi Possivel Gerar Arq Temporario."
 		SELE notaent
		UNLOCK
 		RETURN(.F.)
 	ENDIF		
	*---------------------------------------------------------*
	IF USED("ITENSNEG")
		SELE ITENSNEGOC
		USE
	ENDIF

	SELE grupo
	WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT

	COPY STRU TO &LSarqtmp WITH CDX

	KEYBOARD CHR(13)
	WAIT WINDOW " "
    SELE 0
	USE &LSarqtmp	ALIAS ITENSNEGOC	EXCLUSIVE	
	KEYBOARD CHR(13)
	WAIT WINDOW " "
RETURN(.T.)
