*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ 31/07/2015            SGC410.SPR               13:42:22 ╨
*       ╨                                                         ╨
*       гддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╤
*       ╨                                                         ╨
*       ╨ Author's Name                                           ╨
*       ╨                                                         ╨
*       ╨ Copyright (c) 2015 Company Name                         ╨
*       ╨ Address                                                 ╨
*       ╨ City,     Zip                                           ╨
*       ╨                                                         ╨
*       ╨ Description:                                            ╨
*       ╨ This program was automatically generated by GENSCRN.    ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨          SGC410/MS-DOS Setup Code - SECTION 1           ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
    = W_DEFPROC("rotinas.spr")
	ON KEY LABEL ESCAPE

	PRIVATE LFitemmov,LFsaldo,LFempresa,LFnota
	PRIVATE LFgrupo,LFgrFiscal,LFtabforn

	PRIVATE LSalias
	PRIVATE wp_ref_local
	PRIVATE isediting
	wp_ref_local =  .f.     && NAO POSSUI CONTROLE DE REFRESH LOCAL
	m.isediting	 =	.F.
	LSalias	     = ALIAS()

    LFempresa    	= NetArq("Empresa")
    LFitemmov    	= NetArq("Itemmov")
	LFsaldo		 	= NetArq("Saldo")
	LFnota		 	= NetArq("nota")
	LFgrupo			= NetArq("grupo")
	LFgrfiscal		= NetArq("grfiscal")
	LFtabforn		= NetArq("tabforn")


    IF (LFempresa+LFitemmov+LFsaldo+LFnota) > 100000    && HOUVE FALHA ABERT
		DO ulfecha
    	RETURN(.F.)
    ENDIF

	IF (LFgrupo+LFgrfiscal+LFtabforn) > 100000    && HOUVE FALHA ABERT
		DO ulfecha
    	RETURN(.F.)

    ENDIF

CONSIDERA = "S"


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨                MS-DOS Window definitions                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

IF NOT WEXIST("sgc410") ;
	OR UPPER(WTITLE("SGC410")) == "SGC410.PJX" ;
	OR UPPER(WTITLE("SGC410")) == "SGC410.SCX" ;
	OR UPPER(WTITLE("SGC410")) == "SGC410.MNX" ;
	OR UPPER(WTITLE("SGC410")) == "SGC410.PRG" ;
	OR UPPER(WTITLE("SGC410")) == "SGC410.FRX" ;
	OR UPPER(WTITLE("SGC410")) == "SGC410.QPR"
	DEFINE WINDOW sgc410 ;
		FROM INT((SROW()-19)/2),INT((SCOL()-77)/2) ;
		TO INT((SROW()-19)/2)+18,INT((SCOL()-77)/2)+76 ;
		TITLE "[ Itens Movimentados ] " ;
		FOOTER "[0100]" ;
		NOFLOAT ;
		NOCLOSE ;
		SHADOW ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 1
ENDIF


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨          SGC410/MS-DOS Setup Code - SECTION 2           ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1

*--------------------------------------------------------------*
*    Os indices de Cofins, Pis, Frete sфo registrados no progr.
* OBJ_807.SPR e sфo tambem utilizados no programa SCGC807 para
* calculo dos precos de compra e venda.
*     Este programa recupera os dados de arq de memoria para
* utiliza┤фo nos calculos de custo de reposi┤фo.
*--------------------------------------------------------------*

STORE 0 TO  aliq_cofins,aliq_pis,aliq_frete,vendor
STORE 1 TO  vendor
STORE 0 TO  PRaliq_cofins,PRaliq_pis,PRaliq_frete,PRvendor

LFtmp = .f.
ON ERROR LFtmp = .t.   && EVITA MENS. DE ERRO QDO ARQ.NAO EXISTIR
RESTORE FROM  temp807A ADDITIVE
ON ERROR DO UPerrosys

IF !LFtmp 	&& nao ocorreu erro, logo recuperou as variaveis
	m.aliq_cofins	=	PRaliq_cofins
	m.aliq_pis	    =	PRaliq_pis
	m.aliq_frete	=	PRaliq_frete
	m.vendor		=	PRvendor
ENDIF
****************************************************************


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨               SGC410/MS-DOS Screen Layout               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
IF WVISIBLE("sgc410")
	ACTIVATE WINDOW sgc410 SAME
ELSE
	ACTIVATE WINDOW sgc410 NOSHOW
ENDIF
@ 1,2 TO 14,72 ;
	COLOR SCHEME 23
@ 14,3 TO 14,71 ;
	COLOR SCHEME 24
@ 14,72 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 2,72 TO 13,72 ;
	COLOR SCHEME 24
@ 1,72 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 0,0 TO 18,75 ;
	COLOR SCHEME 23
@ 18,1 TO 18,74 ;
	COLOR SCHEME 24
@ 18,75 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 1,75 TO 17,75 ;
	COLOR SCHEME 24
@ 0,75 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 15,6 TO 17,22 ;
	COLOR SCHEME 24
@ 17,7 TO 17,21 ;
	COLOR SCHEME 23
@ 16,22 SAY "Ё" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 17,22 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 15,22 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 15,29 TO 17,45 ;
	COLOR SCHEME 24
@ 17,30 TO 17,44 ;
	COLOR SCHEME 23
@ 16,45 SAY "Ё" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 17,45 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 15,45 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 15,52 TO 17,68 ;
	COLOR SCHEME 24
@ 17,53 TO 17,67 ;
	COLOR SCHEME 23
@ 16,68 SAY "Ё" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 17,68 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 15,68 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 6,15 SAY "a" ;
	SIZE 1,1, 0
@ 5,3 TO 7,27 ;
	COLOR SCHEME 23
@ 7,4 TO 7,26 ;
	COLOR SCHEME 24
@ 7,27 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 6,27 SAY "Ё" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 5,27 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 5,5 SAY "[Periodo]" ;
	SIZE 1,9, 0
@ 2,3 TO 4,46 ;
	COLOR SCHEME 23
@ 4,4 TO 4,45 ;
	COLOR SCHEME 24
@ 4,46 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 3,46 SAY "Ё" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 2,46 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 2,5 SAY "[Filial]" ;
	SIZE 1,8, 0
@ 3,8 SAY "-" ;
	SIZE 1,1, 0
@ 0,6 SAY "[ Demonstrativo da Margem de Lucro por Produto ]" ;
	SIZE 1,48, 0
@ 11,40 TO 13,69 ;
	COLOR SCHEME 24
@ 13,41 TO 13,68 ;
	COLOR SCHEME 23
@ 12,69 SAY "Ё" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 13,69 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 11,69 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 0,61 SAY "[SGC410]" ;
	SIZE 1,8, 0
@ 9,4 SAY "Considerar Prazo Medio Para Deflacionar Pre┤o de Venda:" ;
	SIZE 1,55, 0
@ 9,64 SAY "S/N" ;
	SIZE 1,3, 0
@ 3,5 GET m.empresa ;
	SIZE 1,3 ;
	DEFAULT 0 ;
	PICTURE "999" ;
	WHEN _4et0tdl1e() ;
	VALID _4et0tdl1n()
@ 3,9 GET m.nome_emp ;
	SIZE 1,37 ;
	DEFAULT " " ;
	WHEN _4et0tdl1v()
@ 6,4 GET m.dt_inicio ;
	SIZE 1,10 ;
	DEFAULT {  /  /  } ;
	WHEN _4et0tdl22() ;
	VALID _4et0tdl27()
@ 6,17 GET m.dt_fim ;
	SIZE 1,10 ;
	DEFAULT {  /  /  } ;
	WHEN isediting ;
	MESSAGE "Data Final deve ser maior ou igual a Inicial"
@ 9,61 GET CONSIDERA ;
	SIZE 1,1 ;
	DEFAULT " " ;
	PICTURE "@! A" ;
	WHEN _4et0tdl2d()
@ 12,42 GET alt_btn ;
	PICTURE "@*HN Alterar Pis/Cofins/Frete" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	WHEN _4et0tdl2j() ;
	VALID _4et0tdl2k()
@ 16,10 GET m.edit_btn ;
	PICTURE "@*HN \<Edita" ;
	SIZE 1,9,1 ;
	DEFAULT 1 ;
	WHEN _4et0tdl2w() ;
	VALID btn_val1('EDIT') ;
	MESSAGE 'Permite a alteracao de dados do registro corrente'
@ 16,33 GET m.imp_btn ;
	PICTURE "@*HN \<Imprime" ;
	SIZE 1,9,1 ;
	DEFAULT 1 ;
	VALID _4et0tdl31() ;
	DISABLE
@ 16,57 GET exit_btn ;
	PICTURE "@*HN \<Saida" ;
	SIZE 1,7,1 ;
	DEFAULT 1 ;
	VALID _4et0tdl38()

IF NOT WVISIBLE("sgc410")
	ACTIVATE WINDOW sgc410
ENDIF

READ CYCLE ;
	ACTIVATE READACT() ;
	DEACTIVATE READDEAC()

RELEASE WINDOW sgc410

#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨               SGC410/MS-DOS Cleanup Code                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1

DO ULfecha
RETURN



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨   SGC410/MS-DOS Supporting Procedures and Functions     ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
PROC ulfecha

	=UP_fecha("empresa"  ,LFempresa)
	=UP_fecha("itemmov" ,LFitemmov)
	=UP_fecha("saldo"	 ,LFsaldo)
	=UP_fecha("nota"	 ,LFnota)
	=UP_fecha("grupo" ,LFgrupo)
	=UP_fecha("grfiscal" ,LFgrfiscal)
	=UP_fecha("tabforn" ,LFtabforn)

	wp_flgfecha = .F. 		&& defaut nao fechamento da secao
	IF !EMPTY(LSalias)
		SELECT &LSalias
	ENDIF
	ON KEY LABEL ESCAPE
	SET FORMAT TO
RETURN


PROCEDURE BTN_VAL1
	PARAMETER tecla, m.chv_ler, m.chv_compara, m.chv_brow
	LN_prxobj = _CUROBJ
	SHOW GET wp_empresa
	SHOW GET wp_nome_emp

    DO CASE
		CASE tecla = "EDIT" AND !isediting   && INICIA EDICAO
			SHOW GET edit_btn,1 PROMPT "\<Ok"
			SHOW GET m.imp_btn DISABLE
			SHOW GET alt_btn   ENABLE
			isediting = .t.
			_CUROBJ = 1	
		    ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
			ON KEY LABEL END DO BTN_VAL1 WITH 'DELETE'
		CASE tecla = "EDIT" AND isediting     && CONFIRMA EDICAO
			SHOW GET edit_btn,1 PROMPT "\<Edita"
			isediting = .f.
			_CUROBJ = 1	
			SHOW GET m.imp_btn ENABLE
			SHOW GET alt_btn   DISABLE
		    ON KEY LABEL ESCAPE
			ON KEY LABEL END
		CASE tecla = "DELETE" AND isediting     && CANCELA EDICAO
			SHOW GET edit_btn,1 PROMPT "\<Edita"
			isediting = .f.
			_CUROBJ = 1	
			SHOW GET m.imp_btn DISABLE
			SHOW GET alt_btn   DISABLE
		    ON KEY LABEL ESCAPE
			ON KEY LABEL END
	ENDCASE
RETURN

PROCEDURE ULMargProd
	PARAMETERS empresa,dt_inicio,dt_fim
	
	*------------------------------------------------------------*
	*  INICIA GERACAO DE ARQUIVO TEMPORARIO						 *
	*------------------------------------------------------------*
	PRIVATE LNFat_VlrTot   	&& Totaliza o Valor Faturado do Item
	PRIVATE LNMult_VlrDias 	&& Totaliza o (Valor Faturado * Dias de prazo
							&&	M┌dio)

	PRIVATE LNprzMedio  &&     Prazo m┌dio calculado para varias vendas
						&& Qdo se considera varias vendas com prazos e
						&& valores distintos, o prazo medio resultante
						&& ┌ obtido coforme demonstrado abaixo;
						&&                Vlr.Fat  Prz Medio     Vlr*Prz
						&&  Venda 1        10,00      2            20,00
						&&  Venda 2        20,00      5           100,00
						&&  Venda 3        30,00     10           300,00
						&&                -------                -------
						&&  LNFat_VlrTot = 60,00 LNMult_VlrDias = 420,00
						&&
						&&  LNprzMedio = LNMult_VlrDias / LNFat_VlrTot
						&&  LNprzMedio = 420,00 / 60 =  7 dias
						&&
						
	PRIVATE LNtaxa 		&& Identificar a taxa de juros cobrada no prazo
						&& m┌dio determinado
	PRIVATE LNvlravista && Valor Comercializado transferido para A Vista


	PRIVATE LNCustoUnit && Custo unit═rio de reposi┤фo conforme tabela
						&& de fornecedores
	PRIVATE LNvlrUnitario &&   =  LNTOT_VEN / LNTOT_SAI


	PRIVATE LNMrgautrz  	&& Margem autrz Calculada

	PRIVATE LNacmMrgautrz   && Acumula a Margem autrz em Cada Opera┤фo



	PRIVATE LNctrMrgautrz 	&& Conta nro de Registros Acmld em LNacmMrgautrz
	PRIVATE LNMediaMrgautrz && Media da Margem autrz
	PRIVATE LNmaxdesc 		&& Desconto Autorizado na opera┤фo
					    &&    O desconto autorizado varia em cada venda
					    && conforme a natureza do cliente.
					    &&    Para se formar um preco autorizado para o
					    && produto deve-se obter (LNMediaMrgautrz)
		*-------------------------------------------------------------*
		* Produto (XXXX)
		*-------------------------------------------------------------*
		* OPER|PRECO  (-) DESCONTO (=) PRECO   | QTDE NA  | INDICE
 		*     |TABELA               AUTORIZADO | OPERACAO |  (A * Q)
		*-------------------------------------------------------------*
		*	1 |	P1	  (-)   D1	   (=)   A1    |   Q1     |   M1
		*	2 |	P2	  (-) 	D2	   (=)   A2    |   Q2     |   M2
		*	3 |	P3    (-)	D3	   (=)   A3    |   Q3     |   M3
		*		
		*		
		*	N |	PN    (-)	DN	   (=)   AN    |   QN     |   MN
		*-------------------------------------------------------------*
		*                                      |   TQ     |   TM
		*-------------------------------------------------------------*
        * (LNMediaMrgautrz) = TM / TQ
		*-------------------------------------------------------------*



	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "ITM" 		&&     TMP001
	LSaliastmp  = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)
	
	
	IF EMPTY(LSaliastmp)
		IF !EMPTY(LSalias) AND USED(LSalias)
			SELECT &LSalias
		ENDIF
		POP KEY 			&& reabilita teclas de atalho def. anteriormente
		RETURN(.F.)
	ENDIF		
	WAIT WINDOW "AGUARDE. Gerando Arq. Temporario. " NOWAIT

	SELE 0
	
	
	SELE ITEMMOV
	SET ORDE TO DT_MOV
	SET NEAR ON
	SEEK STR(m.empresa,3)+DTOS(m.dt_inicio)
	SET NEAR OFF
	
    COPY TO &LSarqtmp WHILE   ;
    		    empresa = 	m.empresa ;
    		AND data	>= 	m.dt_inicio;
    		AND data	<= 	m.dt_fim WITH CDX
        		


	*-------------------------------------------------------------*
	*   Selecionar apenas movimento de SAIDA(operacao="S") por
	*   VENDA(ch_opera="1") por MOTIVO NORMAL(ch_motiv = "1")
	*-------------------------------------------------------------*
*    FROM   ITEMMOV IT;

	
	WAIT WINDOW "Gerando Arquivo Temporario ! " nowait
	
    SELECT IT.empresa,IT.nota,IT.dtfat,;
    		   IT.codigo,   IT.classifica, IT.preco, ;
    		   IT.operacao, IT.movestq,    IT.data, ;
    		   IT.descricao,IT.qtde,       IT.vlrvenda,;
    		   IT.vlr_estq, IT.sld_estq;
    FROM   &LSarqtmp IT;
    WHERE  ;
    		    IT.empresa 			= 	m.empresa ;
    		AND IT.data				>= 	m.dt_inicio;
    		AND IT.data				<= 	m.dt_fim;
    		AND left(IT.operacao,1) = "S" ;
    		AND IT.movestq 			= "S"  ;
   	     	AND IT.ch_opera 		= "1" ;
   	     	AND IT.ch_motiv 		= "1";
   	     	AND IT.tp_mercad 		<> 7;
	ORDE BY IT.classifica ;
    INTO table \tmp\c_ses010
	GO TOP


	LSarqtmp 	= "" 			&& EX: C:\TMP\TMP0001
	LSaliastmp 	= "MV" 		&&     TMP001
	LSaliastmp  = UPopentmp(wp_dirtmp,LSarqtmp,LSaliastmp,1)




    SELE 0
	CREATE TABLE &LSarqtmp  ;
	   (EMPRESA N(5), CODIGO C(20), CLASSIFICA C(15), DESCRICAO C(40), ;
	    DATA D(8), TOT_QVEN N(12,2), TOT_VVEN N(12,2),;
	    VLRUNIT N(12,2), PRAZOMED N(4), VLRPRESENT N(12,2),CTUNIT N(12,2),;
	    MCREAL N(12,2), mcautrz N(12,2))
    USE

    SELE 0
    USE &LSarqtmp ALIAS C_MVITEM EXCL
	
	
	INDEX ON LEFT(classifica,5)+;
		IIF(LEFT(ALLTRIM(STR(MCREAL,10,2)),1) = "-","-"+;
				STR(9999999999-ABS(MCREAL),10),"9")+;
				STR(ABS(MCREAL),10,2)  TAG ordem ASCENDING
	

	SELE empresa
	SET ORDER TO TAG empresa
	SEEK m.empresa

	SELE c_ses010
*1	
	DO WHILE !EOF()
		STOR 0 TO LNCODIGO, LNTOT_SAI, LNTOT_VEN
	    LNCODIGO 	= C_SES010.CODIGO
		LSCLASS     = C_SES010.CLASSIFICA
		LSDESCRICAO	= C_SES010.DESCRICAO

*1	
		LNFat_VlrTot	= 0
		LNMult_VlrDias 	= 0	
		LNprzMedio		= 0	

		LNCustoUnit		= 0


	
		LNMrgautrz		=	0
		LNacmMrgautrz	=	0
		LNctrMrgautrz	=	0
		LNMediaMrgautrz	=	0
		

*		IF LNcodigo = "15025616"
*			SET STEP ON
*		ENDIF

		DO WHILE !EOF() AND c_SES010.CODIGO = LNCODIGO
			SELE nota
			SET ORDER TO TAG nota
			SEEK STR(c_SES010.EMPRESA,3)+STR(c_SES010.NOTA,7)

			LNTOT_SAI = LNTOT_SAI + c_SES010.QTDE
			LNTOT_VEN = LNTOT_VEN + c_SES010.VLRVENDA
			LNFat_VlrTot	= LNFat_VlrTot + c_SES010.VLRVENDA
			LNMult_VlrDias 	= LNMult_VlrDias + ;
							(c_SES010.VLRVENDA * nota.prazomedio)

			LNmaxdesc = 0
			=W_DEFPROC("PRECO.SPR")
			=PRdesconto((m.empresa),(c_SES010.codigo),;
							(c_SES010.dtfat),(nota.natu_cli),LNmaxdesc,0)
	
			LNMrgautrz		=	c_SES010.preco - ;
								(c_SES010.preco*LNmaxdesc)/100
								
			LNacmMrgautrz	=   LNacmMrgautrz+(LNMrgautrz * c_SES010.qtde)

			LNctrMrgautrz	=	LNctrMrgautrz + c_SES010.qtde

			SELE c_SES010
			SKIP
		ENDD
*1		

		IF CONSIDERA = "S"
			LNprzMedio 		= LNMult_VlrDias / LNFat_VlrTot
		ELSE
			LNprzMedio 		= 0
		ENDIF

		LNtaxa = ROUND((empresa.juromes / 30) * LNprzMedio,2)
		LNvlravista = (LNTOT_VEN / LNTOT_SAI)  / (1+(LNtaxa / 100))


*		IF LNcodigo = "15025616"
*			SET STEP ON
*		ENDIF

  *----------------------------------------------------------
  *		
  *     1a Opcao que pegava custo de reposi┤фo
  *
  *		LNCustoUnit	= ULcalcCusto(m.empresa,LNCODIGO,m.dt_fim)
  *
  *----------------------------------------------------------
 *       IF LNcodigo = "14011816"
  *     	set step on
  *     endif

		=W_DEFPROC("estoque.spr")
		=EScustoAgregado(m.empresa,LNCODIGO,m.dt_fim,"",LNCustoUnit)

	    LNvlrUnitario   =  LNTOT_VEN / LNTOT_SAI

*
*		LNCustoUnit		=	LNCustoUnit + ;
*								((LNvlrUnitario * 3.65)/100)
*
		LNCustoUnit		=	LNCustoUnit


		IF LNctrMrgautrz = 0
			LNMediaMrgautrz	= LNacmMrgautrz
		ELSE
			LNMediaMrgautrz	= LNacmMrgautrz / LNctrMrgautrz
		ENDIF

	    m.Vlr_MCREAL  = LNvlravista 	- LNCustoUnit
	    m.Vlr_mcautrz = LNMediaMrgautrz - LNCustoUnit

		IF LNCustoUnit = 0
		    m.Prc_MCREAL = (m.Vlr_MCREAL * 100)
		    m.Prc_mcautrz = (m.Vlr_mcautrz * 100)
		ELSE
		    m.Prc_MCREAL = (m.Vlr_MCREAL * 100)   / LNvlravista
		    m.Prc_mcautrz = (m.Vlr_mcautrz * 100) / LNMediaMrgautrz
		ENDIF

		SELE C_MVITEM
		APPE BLANK
        REPL EMPRESA    WITH m.empresa
		REPL CODIGO		WITH LNCODIGO
		REPL CLASSIFICA	WITH LSCLASS
		REPL DESCRICAO	WITH LSDESCRICAO
		REPL TOT_QVEN	WITH LNTOT_SAI
		REPL TOT_VVEN	WITH LNTOT_VEN
	    REPL VLRUNIT 	WITH LNvlrUnitario

	    REPL PRAZOMED 	WITH LNprzMedio

	    REPL VLRPRESENT WITH LNvlravista

	    REPL CTUNIT 	WITH LNCustoUnit

	    REPL MCREAL 	WITH m.Prc_MCREAL
	    REPL mcautrz 	WITH m.Prc_mcautrz
	
		SELE C_SES010
	ENDD
	
*1
***********-------
	
	SELE C_MVITEM
	go top
	IF EOF() AND BOF()
 		WAIT WINDOW "Nao Foram encotrados dados para impessao."
		=UP_fecha("C_MVITEM")
		=UP_fecha("c_SES010")
 		RETURN
 	ENDIF		
	
*******************
*---->   (INICIALIZACAO DO CONTROLE DE STATUS IMPRESSAO)
*******************	

	SELE C_MVITEM
	go top
	
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO
	LFsegue     = .t.
	LNregistro  = RECNO()
	LNimpressao = 0
    LNimpressao = RECCOUNT()
	LNimpressos = 0
	GO LNregistro
	
*******************
*---->   (COMPLETADO PREPARACAO DO CONTROLE DE STATUS IMPRESSAO)
*******************	
	LF_fim     = .f.
    LSrel 	   = "REL410"      && relatorio padrao
    LSorienta  = " FOR LFsegue "
	DO UPimpressao WITH 	LFLdireciona, LFLagrega, LFLfimagrega
	LFcontinua = LFsegue
************
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
	=UP_fecha("C_MVITEM")
	=UP_fecha("c_SES010")
RETURN



FUNCTION ULcalcCusto
	*------------------------------------------------------------*
	* CLASSIFICACAO:  [*****]   MODULO INDEPENDENTE				 *
	*------------------------------------------------------------*
	* OBJETIVO....: Informar Custo da Ultima Entrada
	*------------------------------------------------------------*
	* COMENTARIO..: A ultima entrada pode ser uma COMPRA ou uma
	*	TRANSFERENCIA o custo ┌ considerado conforme os dados
	*   disponiveis em itemmov
	*
	*	Custo Unitario Ultima Entrada =
	*		(vlrvenda/qtde)+(vlripi/qtde)+(custo_ind/qtde)+
	*		{ [ ((vlrvenda/qtde)+(vlripi/qtde))*iva*0.17 ] -
	*		(vlrvenda/qtde) *.07 }
	*						
	*
	*------------------------------------------------------------*
	* OBS........ :
	*------------------------------------------------------------*
	* TABELAS....: saldo, itemmov
	*------------------------------------------------------------*
	* PARAMETROS..:
	*		LNemp..........: Empresa de referencia da movimentacao
	*						LNemp = 999  faz com que a rotina le-
	*						vante os dados de todas empresas regis-
	*						tradas no arq. empresa
	*		LScod..........: Codigo do Produto
	*		LDdata.........: Data em que quer obter o custo ou iniciar
	*				a pesquisa retroativa ate encontrar uma entrada
	*------------------------------------------------------------*
	*		LNcusto........: Referencia p/ Retorno
	*------------------------------------------------------------*
	* RETORNO.....:
	*		LNcusto........: Custo da ultima compra
	*------------------------------------------------------------*
	PARAMETERS LNemp,LScod,LDdata

	=W_DEFPROC("rotinas.spr")

	PRIVATE LSalias
	
	LSalias			= ALIAS()

	SELE grupo
	SET ORDER TO TAG codigo
	SEEK LScod

	IF !FOUND()
		WAIT WINDOW "Nao Existe Custo Definido Para : "+LScod+"  <ENTER>"
		SELECT &LSalias
		RETURN(0)
	ENDIF			

	*--------------------------------------------------------------*
	*   1a Tentativa : Procura-se primeiro o custo de reposi┤фo
	*                informado na tabela de pre┤os do fornecedor
	*
	*    	Em 04/04/2001 so temos disponivel tabela da Firetone(00001)
	*  para  Pneus(00.???), Camaras(01.???) e Protetores(04.042)
	*
	*   2a Tentativa : Procura-se o custo de reposi┤фo coma base na
	*                ultima entrada de COMPRA ou TRANSFERENCIA.
	*				   Neste caso podem ocorrer distor┤Дes em fun┤фo
	*                da data da ultima entrada ser muinto afastada
	*				 da data que se estuda, o que apontaria um custo
	*   			 desatualizado.
	*
	*--------------------------------------------------------------*
	
	m.codforn = 1
	
	
	SELE tabforn
	SET ORDER TO TAG  tabela
	SEEK STR(m.codforn,5)+LScod
	IF FOUND()
		STORE 0 TO m.preco_tab,m.desc_t,m.aliq_ipi,;
				m.aliq_icmr,;
				m.IVA, m.aliq_icmc,LNvendor,m.preco_liq,m.vlr_ipi,;
			    m.custo_ini,m.vlr_frete,m.vlr_adicional,;
			    m.vlr_icmc,m.vlr_retido,m.custo_total,;
			    m.margem_liq,;
			    m.preco_compra,m.preco_venda

		SCATTER MEMVAR
		*******************************************************************
		* PARAMETROS
		*
		*	LNqtde		: Quantidade solicitada
		*	LNtab		: Preco de tabela
		*	LNdesc		: Desconto total (Normal ou Com Vendor ja aplicado)
		*	LNalqipi	: Aliquota de IPI
		*   LNalqfrt	: Taxa de Frete
		*	LNicmralq	: Aliquota do retido
		*	LNiva		: IVA ou MARCKUP
		*	LNicmcalq	: Aliquota do ICM de Credito
		*
		* VARIAVEIS LOCAIS
		*	LNliq		: Preco de Tabela Aplicado o Desconto
		*	LNipi		: Valor do IPI sobre preco liquido
		*	LNcti		: Custo inicial
		*	LNfret		: Valor do frete
		*	LNadic		: Adicional
		*	LNicmc		: Valor ICM de Credito
		*	LNicmr		: Valor ICM Retido
		*	LNcto		: Custo Total
		******************************************************************

		IF m.vendor = 1
			LNvendor =  m.avindice
		ELSE
			LNvendor =  m.apindice
		ENDIF

		DO UPcalcusto WITH ;
			 1,m.preco_tab,m.desc_t,m.aliq_ipi,m.aliq_frete,m.aliq_icmr,;
				m.IVA, m.aliq_icmc,LNvendor,m.preco_liq,m.vlr_ipi,;
			    m.custo_ini,m.vlr_frete,m.vlr_adicional,;
			    m.vlr_icmc,m.vlr_retido,m.custo_total,;
			    m.aliq_pis,m.aliq_cofins,m.margem_liq,;
			    m.preco_compra,m.preco_venda

		LNcusto  = m.custo_total

	*--------------------------------------------------------------*

	ELSE

	*--------------------------------------------------------------*

		SELE empresa
		SET ORDER TO TAG empresa
		SEEK LNemp

		SELE grfiscal
		SET ORDER TO TAG tributacao
		SEEK empresa.estado+LEFT(grupo.classifica,5)
		IF !FOUND()
			WAIT WINDOW "Nao Existe Custo Definido Para : "+;
						LScod+"  	<ENTER>"
			SELECT &LSalias
			RETURN(0)
		ENDIF			
		IF grfiscal.tp_mercad = 7 && SERVICO
			SELECT &LSalias
			RETURN(0)
		ENDIF			
		
		SELE saldo
		SET ORDER TO TAG clas_saldo
		SEEK STR(LNemp,3)+grupo.classifica+;
				STR(YEAR(LDdata),4)+STR(MONTH(LDdata),2)

		IF !FOUND()
			WAIT WINDOW "Nao Existe Custo Definido Para : "+;
					LScod+"  <ENTER>"
			SELECT &LSalias
			RETURN(0)
		ENDIF			

		SELE itemmov
		SET ORDER TO TAG movimento
		SET NEAR ON
		IF saldo.dt_entrada < LDdata
			SEEK STR(LNemp,3)+LScod+DTOS(saldo.dt_entrada+1)
		ELSE
			SEEK STR(LNemp,3)+LScod+DTOS(LDdata+1)
		ENDIF
		SET NEAR OFF
		SKIP -1
		LNcusto = 0

		DO WHILE !BOF() AND LNemp = itemmov.empresa ;
					AND LScod = itemmov.codigo
			*---------------------------------------------------------*
			* Aceita Entradas de Compras e Transferencias
			*---------------------------------------------------------*
			IF LEFT(itemmov.operacao,1) = "E"
				IF itemmov.ch_opera = "1" OR itemmov.ch_opera = "2"
					LNcusto = (vlrvenda/qtde)+(vlripi/qtde)+;
						(custo_ind/qtde) + ;
				 	( ( ((vlrvenda/qtde)+(vlripi/qtde))*iva*0.17 ) - ;
					(vlrvenda/qtde) * (aliq_icms/100) )
					EXIT
				ENDIF
			ENDIF
			SKIP -1
		ENDDO
	ENDIF

	SELECT &LSalias
RETURN(LNcusto)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4ET0TDL1E           m.empresa WHEN                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SGC410,     Record Number:   50    ╨
*       ╨ Variable:            m.empresa                          ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      1                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4et0tdl1e     &&  m.empresa WHEN
#REGION 1
ON KEY LABEL ENTER
ON KEY LABEL ESCAPE	KEYBOARD "{END}"
IF LASTKEY() = 15 AND !(isediting)
	KEYBOARD "{ESCAPE}"
ENDIF
RETURN(isediting)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4ET0TDL1N           m.empresa VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SGC410,     Record Number:   50    ╨
*       ╨ Variable:            m.empresa                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      2                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4et0tdl1n     &&  m.empresa VALID
#REGION 1
SELECT empresa
SET ORDER TO TAG empresa
IF LASTKEY() = 9
   ON KEY LABEL ESCAPE
   DO loc_dlog WITH .F.
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
   IF LASTKEY() = 27
		SELECT empresa
		RETURN .F.
	ENDIF
ELSE
	IF !SEEK(m.empresa)
		SELECT empresa
		RETURN .F.
	ENDIF
ENDIF
m.empresa   = empresa
m.nome_emp  = empresa.nome
m.inscricao = empresa.inscricao
SHOW GET m.empresa
SHOW GET m.nome_emp
SELECT empresa
RETURN .T.


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4ET0TDL1V           m.nome_emp WHEN                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SGC410,     Record Number:   51    ╨
*       ╨ Variable:            m.nome_emp                         ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      3                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4et0tdl1v     &&  m.nome_emp WHEN
#REGION 1
ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
RETURN(.f.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4ET0TDL22           m.dt_inicio WHEN                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SGC410,     Record Number:   52    ╨
*       ╨ Variable:            m.dt_inicio                        ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      4                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4et0tdl22     &&  m.dt_inicio WHEN
#REGION 1
IF isediting
	ON KEY LABEL ESCAPE	KEYBOARD "{END}"
ENDIF
RETURN(isediting)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4ET0TDL27           m.dt_inicio VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SGC410,     Record Number:   52    ╨
*       ╨ Variable:            m.dt_inicio                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      5                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4et0tdl27     &&  m.dt_inicio VALID
#REGION 1
m.dt_fim = m.dt_inicio
SHOW GET m.dt_fim
ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
RETURN (.T.)


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4ET0TDL2D           CONSIDERA WHEN                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SGC410,     Record Number:   54    ╨
*       ╨ Variable:            CONSIDERA                          ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Field                              ╨
*       ╨ Snippet Number:      6                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4et0tdl2d     &&  CONSIDERA WHEN
#REGION 1
 ON KEY LABEL ENTER

RETURN(isediting)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4ET0TDL2J           alt_btn WHEN                       ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SGC410,     Record Number:   55    ╨
*       ╨ Variable:            alt_btn                            ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      7                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4et0tdl2j     &&  alt_btn WHEN
#REGION 1
IF isediting
    ON KEY LABEL ENTER  KEYBOARD "{RIGHTARROW}"
	ON KEY LABEL ESCAPE	KEYBOARD "{END}"
ENDIF
RETURN(isediting)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4ET0TDL2K           alt_btn VALID                      ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SGC410,     Record Number:   55    ╨
*       ╨ Variable:            alt_btn                            ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      8                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4et0tdl2k     &&  alt_btn VALID
#REGION 1
	DO OBJ_807.SPR WITH aliq_cofins,aliq_pis,aliq_frete,vendor
	ON KEY LABEL ENTER
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
SHOW WINDOW SGC410 TOP




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4ET0TDL2W           m.edit_btn WHEN                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SGC410,     Record Number:   56    ╨
*       ╨ Variable:            m.edit_btn                         ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      9                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4et0tdl2w     &&  m.edit_btn WHEN
#REGION 1
	 =INKEY(0.0001)
	 ON KEY LABEL ENTER
	 ON KEY LABEL ENTER
	 ON KEY LABEL ENTER
RETURN(.T.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4ET0TDL31           m.imp_btn VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SGC410,     Record Number:   57    ╨
*       ╨ Variable:            m.imp_btn                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      10                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
***************************
FUNCTION _4et0tdl31     &&  m.imp_btn VALID
#REGION 1
LFLdireciona  = .F. && Ativa PRTSETUP para direcionar impressao DEF(.T.)
LFLagrega 	  = .T. && Agrega o ??.REL em ??.AGR			    DEF(.F.)
LFLfimagrega  = .F. && Qdo. Estiver agregando => encerra        DEF(.F.)
**********************************************************************

LFLfimagrega  = .T.  && Qdo. Estiver agregando => encerra        DEF(.F.)

LFcontinua = .t.  			&& CAPTURA O VALOR DE LFsegue

LNpagina = 1

DO ULMargProd WITH 	(m.empresa),(dt_inicio),(dt_fim)

*-----------------------------
SELE GRUPO
SET PRINTER TO SET('PRINTER',1)
SET RELATION TO
SET POINT TO
SET SEPARATOR  TO

SHOW WINDOW SGC410 TOP
SHOW GET m.imp_btn DISABLE
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _4ET0TDL38           exit_btn VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         SGC410,     Record Number:   58    ╨
*       ╨ Variable:            exit_btn                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      11                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _4et0tdl38     &&  exit_btn VALID
#REGION 1
CLEAR GETS
CLEAR READ
isediting = .f.
RETURN .T.