*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є 15/08/2014            SCGC242.SPR              09:43:54 є
*       є                                                         є
*       ЗДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД¶
*       є                                                         є
*       є Author's Name                                           є
*       є                                                         є
*       є Copyright (c) 2014 Company Name                         є
*       є Address                                                 є
*       є City,     Zip                                           є
*       є                                                         є
*       є Description:                                            є
*       є This program was automatically generated by GENSCRN.    є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є          SCGC242/MS-DOS Setup Code - SECTION 1          є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

#REGION 1
***************
*~ WIZARDSCREEN

*---------------------------------------------------------------------*
* ARQUIVOS UTILIZADOS :                                               *
*
* OBJETIVOS : Critica de Movimentaco de Estoque Entradas e Saidas
*	
*---------------------------------------------------------------------*
******>>>> INICIO CONTROLE AMBIENTAL

ON KEY LABEL ESCAPE

PRIVATE isediting,isadding,isreading
PRIVATE wp_record
PRIVATE isreadonly,is2table,wzalias
PRIVATE LS242areant
LS242areant	= ALLTRIM(ALIAS()) && PERMITE RETORNAR A AREA ANTER. A CHAMADA

m.wzalias	=	SELECT()
m.isediting	=	.F.
m.isadding	=	.F.
m.isreading =   .f.
m.is2table 	= 	.F.
wp_flgfecha = 	.F. 		&& defaut nao fechamento da secao
WP_RECORD 	= 	0
wp_ref_local =  .f.     && NAO POSSUI CONTROLE DE REFRESH LOCAL
m.flmodo    =  .f.

LFemp242  	= 	.F.		&& .F. =>  DEVE SER FECHADA NA SAIDA
LFusr242  	= 	.F.		&& .F. =>  DEVE SER FECHADA NA SAIDA
LFctb242  	= 	.F.		&& .F. =>  DEVE SER FECHADA NA SAIDA
LFpcm242  	= 	.F.		&& .F. =>  DEVE SER FECHADA NA SAIDA
LFitm242  	= 	.F.		&& .F. =>  DEVE SER FECHADA NA SAIDA
LFnfs242  	= 	.F.		&& .F. =>  DEVE SER FECHADA NA SAIDA
LFgrv242  	= 	.F.		&& .F. =>  DEVE SER FECHADA NA SAIDA
LFtab242  	= 	.F.		&& .F. =>  DEVE SER FECHADA NA SAIDA
LFprc242  	= 	.F.		&& .F. =>  DEVE SER FECHADA NA SAIDA
LFnfe242  	= 	.F.		&& .F. =>  DEVE SER FECHADA NA SAIDA
LFpdi242  	= 	.F.		&& .F. =>  DEVE SER FECHADA NA SAIDA

******>>>> INICIO CONTROLE ARQUIVOS

*>> parametros repassados a btn_val

VLleitura = ""    && repassa chave de leitura p/ btn_val
VLlerfim  = ""    && repassa chave de leitura p/ btn_val ultimo + 1 REG)
VLcompara = ""    && repassa chave de comparacao p/ btn_val
VLchvlimi = ""    && repassa chave de leitura p/ btn_val

IF !USED("empresa")
	LFemp242  	= .T.
	IF ! NetUse("empresa")
		wp_flgfecha = .t.  && implica no fechamento da secao
	ENDIF
ENDIF
IF !USED("usuario")
	LFusr242  	= .T.
	IF ! NetUse("usuario")
		wp_flgfecha = .t.  && implica no fechamento da secao
	ENDIF
ENDIF
IF !USED("cadtab")
	LFctb242  	= .T.
	IF ! NetUse("cadtab")
		wp_flgfecha = .t.  && implica no fechamento da secao
	ENDIF
ENDIF
IF !USED("prod_cms")
	LFpcm242  	= .T.
	IF ! NetUse("prod_cms")
		wp_flgfecha = .t.  && implica no fechamento da secao
	ENDIF
ENDIF
IF !USED("tab001")
	LFtab242  	= .T.
	IF ! NetUse("tab001")
		wp_flgfecha = .t.  && implica no fechamento da secao
	ENDIF
ENDIF
IF !USED("itemmov")
	LFitm242  	= .T.
	IF ! NetUse("itemmov")
		wp_flgfecha = .t.  && implica no fechamento da secao
	ENDIF
ENDIF
IF !USED("nota")
	LFnfs242  	= .T.
	IF ! NetUse("nota")
		wp_flgfecha = .t.  && implica no fechamento da secao
	ENDIF
ENDIF
IF !USED("notaent")
	LFnfe242  	= .T.
	IF ! NetUse("notaent")
		wp_flgfecha = .t.  && implica no fechamento da secao
	ENDIF
ENDIF
IF !USED("grup_ven")
	LFgrv242  	= .T.
	IF ! NetUse("grup_ven")
		wp_flgfecha = .t.  && implica no fechamento da secao
	ENDIF
ENDIF
IF !USED("preco")
	LFprc242  	= .T.
	IF ! NetUse("preco")
		wp_flgfecha = .t.  && implica no fechamento da secao
	ENDIF
ENDIF
IF !USED("pedite")
	LFpdi242  	= .T.
	IF ! NetUse("pedite")
		wp_flgfecha = .t.  && implica no fechamento da secao
	ENDIF
ENDIF
IF wp_flgfecha
	DO ULfecha
	RETURN
ENDIF


#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є                MS-DOS Window definitions                є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

IF NOT WEXIST("scgc242") ;
	OR UPPER(WTITLE("SCGC242")) == "SCGC242.PJX" ;
	OR UPPER(WTITLE("SCGC242")) == "SCGC242.SCX" ;
	OR UPPER(WTITLE("SCGC242")) == "SCGC242.MNX" ;
	OR UPPER(WTITLE("SCGC242")) == "SCGC242.PRG" ;
	OR UPPER(WTITLE("SCGC242")) == "SCGC242.FRX" ;
	OR UPPER(WTITLE("SCGC242")) == "SCGC242.QPR"
	DEFINE WINDOW scgc242 ;
		FROM INT((SROW()-19)/2),INT((SCOL()-76)/2) ;
		TO INT((SROW()-19)/2)+18,INT((SCOL()-76)/2)+75 ;
		TITLE "[ Critica das Mov. e Vendas]" ;
		FOOTER "[242]" ;
		NOFLOAT ;
		NOCLOSE ;
		SHADOW ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 1
ENDIF


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є          SCGC242/MS-DOS Setup Code - SECTION 2          є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

#REGION 1

******>>>> INICIO CONTROLE LOCAL




*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є              SCGC242/MS-DOS Screen Layout               є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

#REGION 1
IF WVISIBLE("scgc242")
	ACTIVATE WINDOW scgc242 SAME
ELSE
	ACTIVATE WINDOW scgc242 NOSHOW
ENDIF
@ 3,17 SAY "-" ;
	SIZE 1,1, 0
@ 3,7 SAY "Tabela" ;
	SIZE 1,6, 0
@ 1,4 TO 14,70 ;
	COLOR SCHEME 23
@ 14,5 TO 14,69 ;
	COLOR SCHEME 24
@ 14,70 SAY "Щ" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 2,70 TO 13,70 ;
	COLOR SCHEME 24
@ 1,70 SAY "ї" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 0,0 TO 18,75 ;
	COLOR SCHEME 23
@ 18,1 TO 18,74 ;
	COLOR SCHEME 24
@ 18,75 SAY "Щ" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 1,75 TO 17,75 ;
	COLOR SCHEME 24
@ 0,75 SAY "ї" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 15,6 TO 17,22 ;
	COLOR SCHEME 24
@ 17,7 TO 17,21 ;
	COLOR SCHEME 23
@ 16,22 SAY "і" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 17,22 SAY "Щ" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 15,22 SAY "ї" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 15,29 TO 17,45 ;
	COLOR SCHEME 24
@ 17,30 TO 17,44 ;
	COLOR SCHEME 23
@ 16,45 SAY "і" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 17,45 SAY "Щ" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 15,45 SAY "ї" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 15,52 TO 17,68 ;
	COLOR SCHEME 24
@ 17,53 TO 17,67 ;
	COLOR SCHEME 23
@ 16,68 SAY "і" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 17,68 SAY "Щ" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 15,68 SAY "ї" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 5,6 TO 7,20 ;
	COLOR SCHEME 23
@ 7,7 TO 7,19 ;
	COLOR SCHEME 24
@ 7,20 SAY "Щ" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 6,20 SAY "і" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 5,20 SAY "ї" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 5,7 SAY "[Dt.Inicial]" ;
	SIZE 1,12, 0
@ 5,21 TO 7,35 ;
	COLOR SCHEME 23
@ 7,22 TO 7,34 ;
	COLOR SCHEME 24
@ 7,35 SAY "Щ" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 6,35 SAY "і" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 5,35 SAY "ї" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 5,22 SAY "[Dt.Final]" ;
	SIZE 1,10, 0
@ 2,5 TO 4,68 ;
	COLOR SCHEME 23
@ 4,6 TO 4,67 ;
	COLOR SCHEME 24
@ 4,68 SAY "Щ" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 3,68 SAY "і" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 2,68 SAY "ї" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 3,22 SAY "Filial.:" ;
	SIZE 1,8, 0
@ 2,6 SAY "[Tabela de Referencia]" ;
	SIZE 1,22, 0
@ 11,5 TO 13,68 ;
	COLOR SCHEME 23
@ 13,6 TO 13,67 ;
	COLOR SCHEME 24
@ 13,68 SAY "Щ" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 12,68 SAY "і" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 11,68 SAY "ї" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 11,26 SAY "Titulo de Relatorio" ;
	SIZE 1,19, 0
@ 0,10 SAY "[ Critica das Movimentacoes de Estoque Entrada e Saida ]" ;
	SIZE 1,56, 0
@ 0,69 SAY "[242]" ;
	SIZE 1,5, 0
@ 9,7 SAY "Desconto Real maior que:" ;
	SIZE 1,24, 0
@ 9,41 SAY "e menor que:" ;
	SIZE 1,12, 0
@ 3,14 GET m.tbbase ;
	SIZE 1,3 ;
	DEFAULT 0 ;
	PICTURE "999" ;
	WHEN isediting ;
	VALID _4510kux02() ;
	MESSAGE "<TAB> = Zoom  ;  <ESC> = Sai " ;
	ERROR "Codigo de Tabela Nao Confere."
@ 3,18 GET m.sbase ;
	SIZE 1,1 ;
	DEFAULT " " ;
	WHEN isediting ;
	VALID _4510kux03()
@ 3,31 GET m.empbase ;
	SIZE 1,3 ;
	DEFAULT 0 ;
	PICTURE "999" ;
	WHEN isediting ;
	VALID _4510kux04() ;
	MESSAGE "<TAB> = Zoom  ;  <ESC> = Sai " ;
	ERROR "Codigo de Tabela Nao Confere."
@ 6,8 GET m.dt_inicio ;
	SIZE 1,10 ;
	DEFAULT {  /  /  } ;
	WHEN _4510kux0w() ;
	VALID _4510kux10()
@ 6,23 GET m.dt_fim ;
	SIZE 1,10 ;
	DEFAULT {  /  /  } ;
	WHEN _4510kux18() ;
	VALID _4510kux1f() ;
	MESSAGE "Data Final deve ser maior ou igual a Inicial"
@ 5,41 GET m.tp_rel ;
	PICTURE "@*RVN Critica Mov. Internas    ;Critica Descontos Vendas" ;
	SIZE 1,29,0 ;
	DEFAULT 1 ;
	WHEN _4510kux1o()
@ 9,32 GET m.dscini ;
	SIZE 1,8 ;
	DEFAULT 0 ;
	PICTURE "999.99" ;
	WHEN _4510kux1p()
@ 9,54 GET m.dscfim ;
	SIZE 1,8 ;
	DEFAULT 0 ;
	PICTURE "999.99" ;
	WHEN _4510kux1q()
@ 12,7 GET m.titulo ;
	SIZE 1,59 ;
	DEFAULT " " ;
	WHEN _4510kux1r()
@ 16,10 GET m.edit_btn ;
	PICTURE "@*HN \<Edita" ;
	SIZE 1,9,1 ;
	DEFAULT 1 ;
	WHEN _4510kux1s() ;
	VALID btn_val1('EDIT') ;
	MESSAGE 'Permite a alteracao de dados do registro corrente'
@ 16,32 GET m.imp_btn ;
	PICTURE "@*HN \<Imprime" ;
	SIZE 1,9,1 ;
	DEFAULT 1 ;
	VALID _4510kux2h() ;
	DISABLE
@ 16,57 GET exit_btn ;
	PICTURE "@*HN \<Saida" ;
	SIZE 1,7,1 ;
	DEFAULT 1 ;
	VALID _4510kux2u()
@ 3,55 GET m.antimp_btn ;
	PICTURE "@*HN \<antImprime" ;
	SIZE 1,12,1 ;
	DEFAULT 1 ;
	VALID _4510kux30() ;
	DISABLE
@ 3,43 SAY "<999-TODAS>" ;
	SIZE 1,11, 0

IF NOT WVISIBLE("scgc242")
	ACTIVATE WINDOW scgc242
ENDIF


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є     MS-DOSREAD contains clauses from SCREEN scgc242     є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

READ CYCLE ;
	NOLOCK

RELEASE WINDOW scgc242

#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є               SCGC242/MS-DOS Cleanup Code               є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

#REGION 1
DO ULfecha
RETURN



*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є   SCGC242/MS-DOS Supporting Procedures and Functions    є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

#REGION 1
PROCEDURE ULfecha
	IF LFemp242  		&& .t. =>  DEVE SER FECHADA NA SAIDA
		=UP_fecha("empresa")
	ENDIF
	IF LFusr242  		&& .t. =>  DEVE SER FECHADA NA SAIDA
		=UP_fecha("usuario")
	ENDIF
	IF LFctb242  		&& .t. =>  DEVE SER FECHADA NA SAIDA
		=UP_fecha("cadtab")
	ENDIF
	IF LFpcm242  		&& .t. =>  DEVE SER FECHADA NA SAIDA
		=UP_fecha("prod_cms")
	ENDIF
	IF LFitm242  		&& .t. =>  DEVE SER FECHADA NA SAIDA
		=UP_fecha("itemmov")
	ENDIF
	IF LFnfs242  		&& .t. =>  DEVE SER FECHADA NA SAIDA
		=UP_fecha("nota")
	ENDIF
	IF LFnfe242  		&& .t. =>  DEVE SER FECHADA NA SAIDA
		=UP_fecha("notaent")
	ENDIF
	IF LFtab242  		&& .t. =>  DEVE SER FECHADA NA SAIDA
		=UP_fecha("tab001")
	ENDIF
	IF LFgrv242  		&& .t. =>  DEVE SER FECHADA NA SAIDA
		=UP_fecha("grup_ven")
	ENDIF
	IF LFprc242  		&& .t. =>  DEVE SER FECHADA NA SAIDA
		=UP_fecha("grup_ven")
	ENDIF
	IF LFpdi242  		&& .t. =>  DEVE SER FECHADA NA SAIDA
		=UP_fecha("pedite")
	ENDIF
	wp_flgfecha = .F. 		&& defaut nao fechamento da secao
	IF !EMPTY(LS242areant)
		SELECT &LS242areant
	ENDIF
	ON KEY LABEL ESCAPE
	SET FORMAT TO
RETURN

PROCEDURE BTN_VAL1
	PARAMETER tecla, m.chv_ler, m.chv_compara, m.chv_brow
	LN_prxobj = _CUROBJ
    DO CASE
		CASE tecla = "EDIT" AND !isediting   && INICIA EDICAO
			SHOW GET edit_btn,1 PROMPT "\<Ok"
			SHOW GET m.imp_btn DISABLE
			isediting = .t.
			_CUROBJ = 1	
		    ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
			ON KEY LABEL END DO BTN_VAL1 WITH 'DELETE'
			m.codinicio  = " "
			m.descinicio = " "
			m.nivinicio  = 0
			m.codfim     = " "    && CODIGO FINAL INFORMADO
			m.descfim    = " "
			m.nivfim     = 0
		CASE tecla = "EDIT" AND isediting     && CONFIRMA EDICAO
			SHOW GET edit_btn,1 PROMPT "\<Edita"
			isediting = .f.
			_CUROBJ = 1	
			SHOW GET m.imp_btn ENABLE
		    ON KEY LABEL ESCAPE
			ON KEY LABEL END
		CASE tecla = "DELETE" AND isediting     && CANCELA EDICAO
			SHOW GET edit_btn,1 PROMPT "\<Edita"
			isediting = .f.
			_CUROBJ = 1	
			SHOW GET m.imp_btn DISABLE
		    ON KEY LABEL ESCAPE
			ON KEY LABEL END
	ENDCASE
RETURN

*OBS: LNmaxdesc e trabalhada em ULdsc_max(chamada a cada item imp
*	 na orientacao do comando RTEPORT wp_retorno(3) e montada em
*	 UPprzmedio		

FUNCTION ULdsc_max
PARAMETERS PrmEmpresa,PrmCodigo,PrmData,PrmNatu_cli,PrmVendedor


*********************************************************************
*   A variavel LNmaxdesc foi alimentada devida a sua utilizacao no  *
*   relatorio.                                                      *
*********************************************************************
         =W_DEFPROC("preco.spr")
         LNmaxdesc  = 0
         LNalias    = ALIAS()
         LNDesconto = 0



		 =prdesconto(PrmEmpresa,PrmCodigo,PrmData,PrmNatu_cli,;
                                  LNdesconto,0,PrmVendedor)
         LNmaxdesc  = LNDesconto
         =W_DEFPROC("rotinas.spr")
         SELE &LNalias
RETURN(LNmaxdesc)          && DESCONTO INDICADO


FUNCTION ULdescreal

PARAMETERS	PrmPrazo,PrmJuromes,PrmData,PrmPreco,PrmQtde,PrmDesconto,PrmTaxa

***** nota.prazo,empresa.juromes,data,PRECO * QTDE,DESCONTO,TAXA

	*--------------------------------------------------------------*
	* Chamada pelo relatorio 242 esta rotina calcula e retorna o   *
	* desconto real dado em um item vendido						   *
	*--------------------------------------------------------------*

	IF Empty(PrmData)
		RETURN(0)
	ENDIF

	PRIVATE	LNnumpgt,LNprazomedio,LNtaxa

	PRIVATE LNpfinprev,LNpfinprat,LNdif,LNdescreal

	STORE  0 TO 	LNnumpgt,LNprazomedio,LNtaxa

    =W_DEFPROC("ORCAMENT.SPR")
	=ORprzmedio(PrmPrazo,PrmJuromes,LNnumpgt,LNprazomedio,LNtaxa)



	*=>  nao deflacionar qdo prazo medio <= 45dias
	IF PrmData > {15.04.2006} AND LNprazomedio <= 45
		LNtaxa = 0
	ENDIF

    LNpfinprev 	= ROUND(PrmPreco * PrmQtde,2)
    LNpfinprev 	= LNpfinprev  + ROUND(LNpfinprev * ;
       				 ROUND(LNtaxa/ 100,4),2)

    LNpfinprat 	= ROUND((PrmPreco - ;
                  ROUND(PrmPreco * PrmDesconto/100,2)) * PrmQtde,2)
    LNpfinprat 	= LNpfinprat + ROUND(LNpfinprat * ROUND(PrmTaxa / 100,4),2)
	
	LNdif	   	= LNpfinprev - LNpfinprat
	LNdescreal	= (LNdif * 100) / LNpfinprev
RETURN(ROUND(LNdescreal,2))	






FUNCTION ULverpreco		      && COMPARAR PRECO PEDIDO X PRECO FATURADO
PARAMETERS PrmPreco_vend,PrmVlrvenda,PrmQtde

	LNprcpedido = PrmPreco_vend
	LNprcfatura = ROUND(PrmVlrvenda / PrmQtde,2)
RETURN(INT(LNprcpedido) <> INT(LNprcfatura))




FUNCTION ULPrecoTab

PARAMETERS PrmEmpresa,PrmData,PrmCodigo
   PRIVATE LNreturn

	IF PrmEmpresa = 0
		RETURN(0)
	ENDIF


	=W_DEFPROC("PRECO.SPR")
   LNreturn = PRVlrTabVgr(PrmEmpresa, PrmData,PrmCodigo)

Return(LNreturn)


FUNCTION ULCustoMed

PARAMETERS PrmEmpresa,PrmData,PrmCodigo
   PRIVATE LNreturn

	IF PrmEmpresa = 0
		RETURN(0)
	ENDIF


	=W_DEFPROC("ESTOQUE.SPR")
    LNreturn = EScustoMedio(PrmEmpresa,PrmCodigo , PrmData)



Return(LNreturn)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX02           m.tbbase VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   58   є
*       є Variable:            m.tbbase                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Field                              є
*       є Snippet Number:      1                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*

FUNCTION _4510kux02     &&  m.tbbase VALID
#REGION 1
SELECT cadtab
IF LASTKEY() = 9
   ON KEY LABEL ESCAPE
   DO loc_dlog WITH .T.,""
   m.tbbase = cadtab.tabela
   m.sbase  = cadtab.serie
   SHOW GET  m.tbbase
   SHOW GET  m.sbase
   ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
ENDIF
RETURN .T.


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX03           m.sbase VALID                      є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   59   є
*       є Variable:            m.sbase                            є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Field                              є
*       є Snippet Number:      2                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux03     &&  m.sbase VALID
#REGION 1
IF SEEK(STR(m.tbbase,3)+m.sbase)
   SHOW GET  m.tbbase
   SHOW GET  m.sbase
   RETURN .T.
ENDIF
_CUROBJ = 1
RETURN .T.

*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX04           m.empbase VALID                    є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   60   є
*       є Variable:            m.empbase                          є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Field                              є
*       є Snippet Number:      3                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux04     &&  m.empbase VALID
#REGION 1
SELECT empresa

IF m.empbase = 999
	SET ORDER TO TAG empresa
	GO TOP
    m.emptab  = empresa.emptab
    SHOW GET  m.empbase
    SHOW GET  m.emptab
   RETURN .T.
ENDIF

IF LASTKEY() = 9
   ON KEY LABEL ESCAPE
   DO loc_dlog WITH .T.
   m.empbase = empresa.empresa
   m.emptab  = empresa.emptab
   SHOW GET  m.empbase
   SHOW GET  m.emptab
   ON KEY LABEL ESCAPE DO BTN_VAL1
ELSE
	SET ORDER TO TAG empresa
	IF SEEK(m.empbase)
   	   m.empbase = empresa.empresa
	   m.emptab  = empresa.emptab
	   SHOW GET  m.empbase
	   SHOW GET  m.emptab
	ELSE
	   RETURN .F.
	ENDIF
ENDIF
m.empresa = m.empbase

RETURN .T.


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX0W           m.dt_inicio WHEN                   є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   61   є
*       є Variable:            m.dt_inicio                        є
*       є Called By:           WHEN Clause                        є
*       є Object Type:         Field                              є
*       є Snippet Number:      4                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux0w     &&  m.dt_inicio WHEN
#REGION 1
IF isediting
	ON KEY LABEL ESCAPE	KEYBOARD "{END}"
ENDIF
RETURN(isediting)

*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX10           m.dt_inicio VALID                  є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   61   є
*       є Variable:            m.dt_inicio                        є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Field                              є
*       є Snippet Number:      5                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux10     &&  m.dt_inicio VALID
#REGION 1
m.dt_fim = m.dt_inicio
SHOW GET m.dt_fim
ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
RETURN (.T.)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX18           m.dt_fim WHEN                      є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   62   є
*       є Variable:            m.dt_fim                           є
*       є Called By:           WHEN Clause                        є
*       є Object Type:         Field                              є
*       є Snippet Number:      6                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux18     &&  m.dt_fim WHEN
#REGION 1
	ON KEY LABEL ENTER
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
RETURN(isediting)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX1F           m.dt_fim VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   62   є
*       є Variable:            m.dt_fim                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Field                              є
*       є Snippet Number:      7                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux1f     &&  m.dt_fim VALID
#REGION 1
RETURN(m.dt_fim >= m.dt_inicio)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX1O           m.tp_rel WHEN                      є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   63   є
*       є Variable:            m.tp_rel                           є
*       є Called By:           WHEN Clause                        є
*       є Object Type:         Radio Button                       є
*       є Snippet Number:      8                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux1o     &&  m.tp_rel WHEN
#REGION 1
IF isediting
	ON KEY LABEL ENTER KEYBOARD "{RIGHTARROW}"
ENDIF	
RETURN(isediting)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX1P           m.dscini WHEN                      є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   64   є
*       є Variable:            m.dscini                           є
*       є Called By:           WHEN Clause                        є
*       є Object Type:         Field                              є
*       є Snippet Number:      9                                  є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux1p     &&  m.dscini WHEN
#REGION 1
	ON KEY LABEL ENTER
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
RETURN(isediting)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX1Q           m.dscfim WHEN                      є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   65   є
*       є Variable:            m.dscfim                           є
*       є Called By:           WHEN Clause                        є
*       є Object Type:         Field                              є
*       є Snippet Number:      10                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux1q     &&  m.dscfim WHEN
#REGION 1
	ON KEY LABEL ENTER
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
RETURN(isediting)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX1R           m.titulo WHEN                      є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   66   є
*       є Variable:            m.titulo                           є
*       є Called By:           WHEN Clause                        є
*       є Object Type:         Field                              є
*       є Snippet Number:      11                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux1r     &&  m.titulo WHEN
#REGION 1
ON KEY LABEL ENTER
IF !isediting
	RETURN .F.
ENDIF
m.titulo = " Critica de Mov.Estoque Tab.[ "+STR(m.tbbase,3)+"-"+m.sbase+;
		   "] "+DTOC(m.dt_inicio)+" a "+DTOC(m.dt_fim)
RETURN .T.

*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX1S           m.edit_btn WHEN                    є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   67   є
*       є Variable:            m.edit_btn                         є
*       є Called By:           WHEN Clause                        є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      12                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux1s     &&  m.edit_btn WHEN
#REGION 1
	ON KEY LABEL ENTER
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
RETURN(.T.)


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX2H           m.imp_btn VALID                    є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   68   є
*       є Variable:            m.imp_btn                          є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      13                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux2h     &&  m.imp_btn VALID
#REGION 1
	LNmaxdesc  = 0 	&& REGISTRA O DESCONTO MAXIMO LOCALIZADO EM ULdsc_max
					&& E IMPRESSO NO RELATORIO
	**************************************************************
	SELE itemmov



    IF m.empbase = 999  && TODAS
	  SET ORDER TO TAG dt_GERAL
	  SET NEAR ON
	  SEEK DTOS(m.dt_inicio)
	  SET NEAR OFF
	ELSE
	  SET ORDER TO TAG dt_mov
	  SET NEAR ON
	  SEEK STR(m.empbase,3)+DTOS(m.dt_inicio)
	  SET NEAR OFF
	ENDIF



	************************>  GERANDO ARQTMP **********************
	wl_arqtmp = ""
	LNtmp     = 65		&& TABELA ASCII A = 65
	IF !UPabretmp("tmp")
		wp_flgfecha = .t.
	ENDIF
	IF wp_flgfecha
		DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
		UNLOCK
 		RETURN
 	ENDIF
	WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
	SET SAFET OFF
	LStmp = "&wp_dirtmp"+"&wl_arqtmp"
	SELE itemmov
	**************************


    SELE EMPRESA
    LNregEmpTmp = recno()

    SET ORDER TO TAG EMPRESA

	SELE itemmov


	DO CASE

		CASE m.tp_rel = 1			&& CRIT. MOV. INTERNAS


            IF m.empbase = 999  && TODAS
			   COPY TO &LStmp  FOR  ;
			                    ALLTRIM(itemmov.CFO) $ "1.949/5.949" ;
			                    OR ;
			                    ALLTRIM(itemmov.TIPO) $ "QLA/SCA" ;
		    		WHILE  ;
    				  itemmov.data <= m.dt_fim WITH CDX
            ELSE

			   COPY TO &LStmp  FOR  ;
			                    ALLTRIM(itemmov.CFO) $ "1.949/5.949" ;
			                    OR ;
			                    ALLTRIM(itemmov.TIPO) $ "QLA/SCA" ;
		    		WHILE itemmov.empresa = m.empbase AND ;
    				  itemmov.data <= m.dt_fim WITH CDX
            endif

		CASE m.tp_rel = 2			&& CRIT. DE DESCONTOS


            IF m.empbase = 999  && TODAS
		      COPY TO &LStmp  FOR itemmov.ch_opera = "1" AND ;
	    		LEFT(itemmov.operacao,1) = "S" ;
	    		WHILE  ;
    			  itemmov.data <= m.dt_fim WITH CDX
            ELSE
		      COPY TO &LStmp  FOR itemmov.ch_opera = "1" AND ;
	    		LEFT(itemmov.operacao,1) = "S" ;
	    		WHILE itemmov.empresa = m.empbase AND ;
    			  itemmov.data <= m.dt_fim WITH CDX
            ENDIF

		CASE m.tp_rel = 3			&& CRIT. DE PRECO COMPRA

			SELE notaent
			SET ORDER TO TAG nota
			SELE itemmov
			SET RELATION TO ;
				STR(EMPRESA,3)+STR(CODFORN,5)+STR(NOTA,6)+;
					SERIE+LEFT(TIPO,1) INTO notaent
            IF m.empbase = 999  && TODAS
		      COPY TO &LStmp  FOR itemmov.ch_opera = "1" AND ;
	    		LEFT(itemmov.operacao,1) = "E" 	AND ;
	    		notaent.pedido > 0 ;
	    		WHILE  ;
    			  itemmov.data <= m.dt_fim WITH CDX
            ELSE
		      COPY TO &LStmp  FOR itemmov.ch_opera = "1" AND ;
	    		LEFT(itemmov.operacao,1) = "E" 	AND ;
	    		notaent.pedido > 0 ;
	    		WHILE itemmov.empresa = m.empbase AND ;
    			  itemmov.data <= m.dt_fim WITH CDX
            ENDIF

	ENDCASE

	SELE 0
	USE &LStmp  exclu
*	APPEND BLANK
	
	****************************************************************
	* 		Inicio da impressao                                    *
	****************************************************************

	SELE &wl_arqtmp
	SET ORDER TO TAG itensOSI
	GO TOP
*	IF EOF()
*		USE
*		DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
*		UNLOCK
*		RETURN
* 	ENDIF		


	*******************
	*---->   (COMPLETADO PREPARACAO DO CONTROLE DE STATUS IMPRESSAO)
	*******************	
	SELECT tab001
	SET ORDER TO TAG codigo

	SELECT  cadtab
	SET ORDER TO TAG tabela
	SEEK STR(m.tbbase,3)+m.sbase

	SELE prod_cms
	SET ORDER TO TAG tabela

	SELE usuario
	SET ORDER TO TAG usuario

	SELE nota
	SET ORDER TO TAG nota

	SELE notaent
	SET ORDER TO TAG nota

	SELE pedite
	SET ORDER TO TAG pedido


	**********************>>> REGISTRO DE SAIDAS <<<*********************

	DO CASE
		CASE m.tp_rel = 1			&& CRIT. MOV. INTERNAS

		    LSrel = "REL242A"
			LSorienta = "WHILE LFsegue "
			SELECT ;
			    TMP.* ;
			    ULCustoMed(empresa,data - 1,codigo) AS CSTMEDIO;
			  FROM &wl_arqtmp TMP;
			     ORDER BY EMPRESA,natu_cli,NOTA;
			INTO CURSOR TMPCRT







		CASE m.tp_rel = 2			&& CRIT. DESCONTOS
		    LSrel = "REL242"
			LSorienta = " WHILE LFsegue "

			SELECT ULPrecoTab(EMP.empresa,tmp.data,tmp.codigo) AS PRECO,;
					TMP.empresa,;
					tmp.ordem,;
					tmp.natu_cli,;
					tmp.nota,;
					tmp.data,;
					tmp.tipo,;
					tmp.tp_mercad,;
					tmp.codigo,;
					tmp.classifica,;
					tmp.descricao,;
					tmp.qtde,;
					tmp.clas_cms,;
					tmp.vlrvenda,;
					tmp.taxa,;
					tmp.PRAZOMEDIO,;
					NF.NOME,;
					NF.PRAZO,;
					EMP.JUROMES, ;
			        NF.SERV_1,;
			        TB.DESCRICAO AS NATUREZA ;
			FROM &wl_arqtmp TMP,tab001 TB, nota NF, empresa EMP;
		    WHERE ;
	   			    TMP.empresa= NF.empresa ;
	   			AND TMP.nota   = NF.nota ;
		   		AND TMP.empresa= EMP.empresa ;
				AND "NTZ"      = TB.TABELA ;
				AND CHRTRAN(STR(TMP.natu_cli,1)," ","0") = TB.CODIGO ;
			INTO CURSOR TMPCRT1




			SELECT ;
					TMP.*, ;
			    (((TMP.PRECO - (TMP.VlrVenda/tmp.qtde)) * 100) / TMP.PRECO);
			        AS DESCONTO ;
			 FROM TMPCRT1 TMP ;
			INTO CURSOR TMPDST1



			SELECT TMP.*, ;
				ULdescreal(prazo,juromes,data,;
        			PRECO,QTDE,DESCONTO,;
        			TAXA) AS descreal,;
    	        ULdsc_max(empresa,codigo,data,natu_cli,SERV_1) AS dsct_max ;
			FROM TMPDST1 TMP ;
			INTO CURSOR TMPCRT2

			*---------------------------------------------------------*
			* EM 06/06/2007 CONFORME ACERTO COM ELIO E ZE FILHO FOI
			* AMPLIADA A MARGEM DE TOLERANCIA DO DESCONTO PARA 0.30%
			* DO DESCONTO MAXIMO
			*---------------------------------------------------------*


			SELECT TMP.* ;
			FROM TMPCRT2 TMP ;
		    WHERE ;
					descreal >= m.dscini ;
				AND descreal <= m.dscfim ;
				AND desconto >  (dsct_max * 1.030) ;
				AND preco    <  9999 ;
			ORDER BY natu_cli,NOTA,ORDEM;
			INTO CURSOR TMPCRT




			SELE TMPDST1
			USE


			
			SELE TMPCRT1
			USE
			SELE TMPCRT2
			USE
			SELE TMPCRT
			


		CASE m.tp_rel = 3			&& CRIT. PRECO COMPRA
		    LSrel = "REL242B"
			LSorienta = "WHILE LFsegue "
			SELECT * ;
			FROM &wl_arqtmp TMP,notaent NFE, pedite pdd;
			WHERE ;
				    TMP.EMPRESA = NFE.EMPRESA ;
				AND TMP.CODFORN = NFE.CODFORN ;
				AND TMP.NOTA    = NFE.NOTA ;
				AND TMP.SERIE   = NFE.SERIE ;
				AND TMP.TIPO    = NFE.TIPO ;
				AND TMP.EMPRESA = PDD.EMPRESA ;
                AND TMP.CODIGO  = PDD.CODIFO ;
                AND NFE.pedido  = PDD.PEDIDO ;
				AND ULverpreco(pdd.preco_vend,TMP.vlrvenda,TMP.qtde);
			ORDER BY natu_cli,NOTA;
			INTO CURSOR TMPCRT

	ENDCASE

	
	SELE &wl_arqtmp
	USE
	SELE TMPCRT
	COPY TO &LStmp




	SELE 0
	USE &LStmp  exclu
    INDEX ON STR(EMPRESA,3)+STR(natu_cli,1)+STR(NOTA,7) TAG EMP ADDITIVE	
	
	SET ORDER TO TAG EMP
	
	TMPAlias = Alias()
	GO TOP
*	IF EOF() AND BOF()
*	   APPEND BLANK
*	ENDIF





    SELE EMPRESA
    GO TOP

    IF m.empbase = 999  && TODAS

 	   DO WHILE !EOF()
    	   SELE &TMPAlias
		   APPEND BLANK
		   replace empresa with empresa.empresa
		   sele empresa
		   skip
		ENDDO
    ELSE
   	   SELE &TMPAlias
	   APPEND BLANK
	   replace empresa with m.empbase

    ENDIF

    SELE &TMPAlias
    GO TOP



	*******************

    SET RELATION TO ;
  	  EMPRESA INTO empresa


 	SET SKIP TO EMPRESA



	*******************
	*---->   (INICIALIZACAO DO CONTROLE DE STATUS IMPRESSAO)
	*******************	
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO
	LFsegue     = .t.
	LNregistro  = RECNO()
	LNimpressao = RECCOUNT()
	LNimpressos = 0
	GO LNregistro

	
***************************************************************

	DO UPimpressao    && COORDENA TRABALHO DE IMPRESSAO

***************************************************************
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
*-----------------------------
    SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO

    SELE EMPRESA
    GO LNregEmpTmp





	SELE TMPCRT
	USE
	SELE &wl_arqtmp
	USE
	SHOW WINDOW SCGC242 TOP
	SHOW GET m.imp_btn DISABLE

RETURN



*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX2U           exit_btn VALID                     є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   69   є
*       є Variable:            exit_btn                           є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      14                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux2u     &&  exit_btn VALID
#REGION 1
CLEAR READ
CLEAR GETS


*       ЦДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДД·
*       є                                                         є
*       є _4510KUX30           m.antimp_btn VALID                 є
*       є                                                         є
*       є Function Origin:                                        є
*       є                                                         є
*       є From Platform:       MS-DOS                             є
*       є From Screen:         SCGC242,     Record Number:   70   є
*       є Variable:            m.antimp_btn                       є
*       є Called By:           VALID Clause                       є
*       є Object Type:         Push Button                        є
*       є Snippet Number:      15                                 є
*       є                                                         є
*       УДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДДЅ
*
FUNCTION _4510kux30     &&  m.antimp_btn VALID
#REGION 1
	LNmaxdesc  = 0 	&& REGISTRA O DESCONTO MAXIMO LOCALIZADO EM ULdsc_max
					&& E IMPRESSO NO RELATORIO
	**************************************************************
	SELE itemmov
	SET ORDER TO TAG dt_mov
	SET NEAR ON
	SEEK STR(m.empbase,3)+DTOS(m.dt_inicio)
	SET NEAR OFF
	IF EOF() OR itemmov.empresa <> m.empbase ;
			 OR	itemmov.data > m.dt_fim
 		WAIT WINDOW "Nao Foram encotrados dados para impessao."
		UNLOCK
 		RETURN
 	ENDIF		
	************************>  GERANDO ARQTMP **********************
	wl_arqtmp = ""
	LNtmp     = 65		&& TABELA ASCII A = 65
	IF !UPabretmp("tmp")
		wp_flgfecha = .t.
	ENDIF
	IF wp_flgfecha
		DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
		UNLOCK
 		RETURN
 	ENDIF
	WAIT WINDOW "AGUARDE. Gerando Arq. Temporario." NOWAIT
	SET SAFET OFF
	LStmp = "&wp_dirtmp"+"&wl_arqtmp"
	SELE itemmov
	**************************
	DO CASE
		CASE m.tp_rel = 1			&& CRIT. MOV. INTERNAS
			COPY TO &LStmp  FOR itemmov.ch_opera = "5" ;
		    		WHILE itemmov.empresa = m.empbase AND ;
    				  itemmov.data <= m.dt_fim WITH CDX
		CASE m.tp_rel = 2			&& CRIT. DE DESCONTOS
		    COPY TO &LStmp  FOR itemmov.ch_opera = "1" AND ;
	    		LEFT(itemmov.operacao,1) = "S" ;
	    		WHILE itemmov.empresa = m.empbase AND ;
    			  itemmov.data <= m.dt_fim WITH CDX
		CASE m.tp_rel = 3			&& CRIT. DE PRECO COMPRA
			SELE notaent
			SET ORDER TO TAG nota
			SELE itemmov
			SET RELATION TO ;
				STR(EMPRESA,3)+STR(CODFORN,5)+STR(NOTA,6)+;
					SERIE+LEFT(TIPO,1) INTO notaent
		    COPY TO &LStmp  FOR itemmov.ch_opera = "1" AND ;
	    		LEFT(itemmov.operacao,1) = "E" 	AND ;
	    		notaent.pedido > 0 ;
	    		WHILE itemmov.empresa = m.empbase AND ;
    			  itemmov.data <= m.dt_fim WITH CDX
	ENDCASE

	SELE 0
	USE &LStmp  exclu
	APPEND BLANK
	
	****************************************************************
	* 		Inicio da impressao                                    *
	****************************************************************
	SELE &wl_arqtmp
	SET ORDER TO TAG itensOSI
	GO TOP
	IF EOF()
		USE
		DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
		UNLOCK
 		RETURN
 	ENDIF		
	SELECT * FROM  &wl_arqtmp ORDER BY natu_cli,NOTA INTO CURSOR CRS_TMP


	SELE CRS_TMP
	*******************
	*---->   (INICIALIZACAO DO CONTROLE DE STATUS IMPRESSAO)
	*******************	
	DO RELINIC.PRG          && INICIA VAR P/ TERMOMETRO
	LFsegue     = .t.
	LNregistro  = RECNO()
	LNimpressao = RECCOUNT()
	LNimpressos = 0
	GO LNregistro
	*******************
	*---->   (COMPLETADO PREPARACAO DO CONTROLE DE STATUS IMPRESSAO)
	*******************	
	SELECT tab001
	SET ORDER TO TAG codigo

	SELECT  cadtab
	SET ORDER TO TAG tabela
	SEEK STR(m.tbbase,3)+m.sbase

	SELE prod_cms
	SET ORDER TO TAG tabela

	SELE usuario
	SET ORDER TO TAG usuario

	SELE nota
	SET ORDER TO TAG nota

	SELE notaent
	SET ORDER TO TAG nota

	SELE pedite
	SET ORDER TO TAG pedido


	SELE CRS_TMP
	SET RELATION TO STR(empresa,3)+STR(nota,7)    INTO nota
	SET RELATION TO "NTZ"+CHRTRAN(STR(natu_cli,1)," ","0") ;
			INTO tab001  ADDITIVE
	SET RELATION TO ;
				STR(EMPRESA,3)+STR(CODFORN,5)+STR(NOTA,6)+;
					SERIE+LEFT(TIPO,1) INTO notaent ADDITIVE
	SET RELATION TO STR(EMPRESA,3)+STR(notaent.pedido,6)+CODIGO INTO ;
					pedite		ADDITIVE
	**********************>>> REGISTRO DE SAIDAS <<<*********************
	DO CASE
		CASE m.tp_rel = 1			&& CRIT. MOV. INTERNAS
		    LSrel = "REL242A"
			LSorienta = "WHILE LFsegue "
		CASE m.tp_rel = 2			&& CRIT. DESCONTOS
		    LSrel = "REL242"

*			LSorienta = ;
*			  " FOR desconto > ULdsc_max() "+ ;          && linha original
*			  " OR  ULdescreal() > LNmaxdesc  WHILE LFsegue "

			LSorienta = ;
                " FOR desconto > ULdsc_max(CRS_TMP.empresa,"+;
                    "CRS_TMP.codigo,"+;
                      "CRS_TMP.data,CRS_TMP.natu_cli) + 0.05 "+;
			  " AND  (ULdescreal() >= m.dscini "+;
			  " AND ULdescreal()<=m.dscfim) "+ ;
			  " WHILE LFsegue "

		CASE m.tp_rel = 3			&& CRIT. PRECO COMPRA
		    LSrel = "REL242B"
			LSorienta = ;
			  " FOR ULverpreco()  WHILE LFsegue "
	ENDCASE
***************************************************************
	DO UPimpressao    && COORDENA TRABALHO DE IMPRESSAO
***************************************************************
	DO RELFIM.PRG          && FIM VAR P/ TERMOMETRO
*-----------------------------
    SET PRINTER TO SET('PRINTER',1)
	SET RELATION TO
	SET POINT TO
	SET SEPARATOR  TO

	SELE CRS_TMP
	USE
	SELE &wl_arqtmp
	USE
	SHOW WINDOW SCGC242 TOP
	SHOW GET m.imp_btn DISABLE
RETURN