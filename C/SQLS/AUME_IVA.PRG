CLOSE ALL
CLEAR
SET DELE ON
SET TALK ON
SET ESCAPE ON

SELECT DISTINCT CODIGO FROM X:\SCGC\LOJA\ITEMMOV  ;
  INTO CURSOR CODIGO WHERE TP_MERCAD = 2



SELECT ;
	   CODIGO,;
       DESCRICAO,;
	   NOTA AS NF_ENT,;
       IVA,;
       SUM(QTDE)               		AS TQTD_COMPRA,;
       SUM((VLRVENDA+VLRIPI)*IVA)   AS TVLRCOMIVA,;
	   SUM(((VLR_ESTQ/SLD_ESTQ)*QTDE)-ICMS_SUBS)     AS TCUSTO_MED;
  FROM X:\SCGC\LOJA\ITEMMOV IE ;
  WHERE TP_MERCAD = 2;
  	 AND MONTH(DATA) >= 06 AND MONTH(DATA) <= 11;
  	 AND YEAR(DATA) = 2006;
  	 AND CH_OPERA = "1";
  	 AND LEFT(OPERACAO,1) = "E" ;
  	 AND CODIGO IN (SELECT CODIGO FROM CODIGO) ;
  GROUP BY  CODIGO;
  INTO CURSOR TMPCOMPRAS

**  	 AND CH_OPERA = "1"  AND NOTA=241593;


SELECT ;
	   CP.*,;
       TVLRCOMIVA/TQTD_COMPRA AS UVLRCOMIVA,;
       TCUSTO_MED/TQTD_COMPRA AS UTCUSTO_MED;
  FROM TMPCOMPRAS CP;
  INTO CURSOR COMPRAS


  
SELECT CODIGO,;
	   DATA,;
	   NOTA,;
	   SUM(QTDE) AS TQTDEVENDA ,;
	   SUM(VLRVENDA) AS TVLRVENDA,;
	   SUM(VLRVENDA/QTDE) AS UVLRVENDA ;
  FROM X:\SCGC\LOJA\ITEMMOV IT ;
  WHERE ;
  	    MONTH(DATA) = 12;
  	 AND YEAR(DATA) = 2006;
  	 AND CH_OPERA = "1" ;
  	 AND LEFT(OPERACAO,1) = "S" ;
  	 AND LEFT(SITUACAO,1) = "O" ;
  	 AND CODIGO IN (SELECT CODIGO FROM CODIGO) ;
  GROUP BY   CODIGO;
  INTO CURSOR VENDAS
  
**---    JUNCAO  

SELECT ;
	   CP.CODIGO,;
	   CP.NF_ENT,;
	   VD.DATA,;
	   VD.NOTA,;
       CP.DESCRICAO,;
       CP.IVA,;
       CP.TQTD_COMPRA,;
       CP.UVLRCOMIVA,;
       CP.UTCUSTO_MED,;
	   (VD.TVLRVENDA/VD.TQTDEVENDA) AS UVLRVENDA;
  FROM COMPRAS CP , VENDAS VD;
  WHERE  VD.CODIGO = CP.CODIGO;
  GROUP BY  CP.CODIGO;
  INTO CURSOR IVA

SELECT ;
	   (IV.UVLRVENDA-IV.UTCUSTO_MED) * 100 /IV.UVLRVENDA  AS MARGEM,;
	   IIF(UVLRCOMIVA > UVLRVENDA,"ALERTA","       ") AS OBS,;
	   IV.*;
  FROM IVA IV;
  INTO CURSOR IVA
