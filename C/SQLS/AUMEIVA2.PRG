CLOSE ALL
CLEAR
SET DELE ON
SET TALK ON
SET ESCAPE ON

SELECT DISTINCT CODIGO FROM X:\SCGC\LOJA\ITEMMOV  ;
  INTO CURSOR CODIGO WHERE TP_MERCAD = 2



SELECT ;
	   CODIGO,;
       DESCRICAO,;
	   NOTA,;
       IVA,;
       QTDE,;
	   ((VLRVENDA+VLRIPI+CUSTO_IND)/QTDE)*IVA   AS VLRCOMIVA,;
	   ((VLRVENDA+VLRIPI+CUSTO_IND)/QTDE)       AS CUSTO_MED;
  FROM X:\SCGC\LOJA\ITEMMOV IE ;
  WHERE TP_MERCAD = 2;
  	 AND MONTH(DATA) >= 06 AND MONTH(DATA) <= 11;
  	 AND YEAR(DATA) = 2006;
	 AND CODFORN = 1 ;
  	 AND CH_OPERA = "1";
  	 AND LEFT(OPERACAO,1) = "E" ;
  	 AND CODIGO IN (SELECT CODIGO FROM CODIGO) ;
  INTO CURSOR TMPCOMPRAS

SELECT ;
	   CODIGO,;
       DESCRICAO,;
	   NOTA,;
       IVA,;
       MAX(VLRCOMIVA) AS UVLRCOMIVA,;
	   MAX(CUSTO_MED) AS UTCUSTO_MED;
  FROM TMPCOMPRAS ;
  GROUP BY  CODIGO;
  INTO CURSOR COMPRAS


**  	 AND CH_OPERA = "1"  AND NOTA=241593;


  
SELECT CODIGO,;
	   DATA,;
	   NOTA,;
	   TIPO,;
	   NATU_CLI,;
	   COUNT(1)     AS NRO_VENDAS,;     
	   SUM(QTDE) AS TQTDEVENDA ,;
	   SUM(VLRVENDA) AS TVLRVENDA,;
	   SUM(VLRVENDA/QTDE) AS UVLRVENDA ;
  FROM X:\SCGC\LOJA\ITEMMOV IT ;
  WHERE ;
  	    MONTH(DATA) = 12;
  	 AND YEAR(DATA) = 2006;
  	 AND CH_OPERA = "1" ;
  	 AND LEFT(OPERACAO,1) = "S" ;
  	 AND LEFT(SITUACAO,1) = "O" ;
  	 AND CODIGO IN (SELECT CODIGO FROM CODIGO) ;
  GROUP BY   CODIGO,NATU_CLI;
  INTO CURSOR VENDAS
  
**---    JUNCAO  

SELECT ;
       CP.IVA,;
       CP.UVLRCOMIVA,;
       CP.UTCUSTO_MED,;
	   (VD.TVLRVENDA/VD.TQTDEVENDA) AS UVLRVENDA,;
	   VD.TIPO,;
	   VD.NATU_CLI,;
	   CP.CODIGO,;
       CP.DESCRICAO,;
	   CP.NOTA AS NF_ENT,;
	   VD.DATA,;
	   VD.NOTA;
  FROM COMPRAS CP , VENDAS VD;
  WHERE  VD.CODIGO = CP.CODIGO;
  GROUP BY   CP.CODIGO,VD.NATU_CLI ;
  INTO CURSOR IVA

SELECT ;
	   IIF(UVLRCOMIVA > UVLRVENDA,"ALERTA","       ") AS OBS,;
       UTCUSTO_MED,;
       IVA,;
       UVLRCOMIVA,;
	   UVLRVENDA,;
       (UVLRVENDA - UVLRCOMIVA) AS DIF,;
	   CODIGO,;
       DESCRICAO,;
	   TIPO,;
	   NATU_CLI,;
	   NF_ENT,;
	   DATA,;
	   NOTA,;
	   (IV.UVLRVENDA-IV.UTCUSTO_MED) * 100 /IV.UVLRVENDA  AS MARGEM;
  FROM IVA IV;
  INTO TABLE C:\TMP\IVANATU


RETURN


*******************************************************

