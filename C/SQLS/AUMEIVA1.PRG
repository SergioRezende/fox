CLOSE ALL
CLEAR
SET DELE ON
SET TALK ON
SET ESCAPE ON

SELECT DISTINCT CODIGO FROM X:\SCGC\LOJA\ITEMMOV  ;
  INTO CURSOR CODIGO WHERE TP_MERCAD = 2

SELECT ;
	   IE.*;
  FROM X:\SCGC\LOJA\ITEMMOV IE ;
  WHERE TP_MERCAD = 2;
  	 AND YEAR(DATA) = 2006;
	 AND CODFORN = 1 ;
  	 AND CH_OPERA = "1";
  	 AND LEFT(OPERACAO,1) = "E" ;
  	 AND CODIGO IN (SELECT CODIGO FROM CODIGO) ;
  INTO CURSOR NE_TODAS



SELECT ;
	   CODIGO,;	
	   MAX(DATA) AS DATA;
  FROM NE_TODAS IE ;
  WHERE  ;
  	 CODIGO IN (SELECT CODIGO FROM CODIGO) ;
  GROUP BY CODIGO ;
  INTO CURSOR NE_RECENTE


SELECT ;
	   NT.CODIGO,;
       NT.DESCRICAO,;
	   NT.NOTA AS NF_ENT,;
       NT.IVA,;
	   ((NT.VLRVENDA+NT.VLRIPI+NT.CUSTO_IND)/NT.QTDE)*NT.IVA   AS UVLRCOMIVA,;
	   ((NT.VLRVENDA+NT.VLRIPI+NT.CUSTO_IND)/NT.QTDE)       AS UTCUSTO_MED;
  FROM  NE_RECENTE NR,  NE_TODAS NT ;
  WHERE  ;
   	     NR.CODIGO = NT.CODIGO;
  	 AND NR.DATA = NT.DATA;
  INTO CURSOR COMPRAS



**  	 AND CH_OPERA = "1"  AND NOTA=241593;


  
SELECT CODIGO,;
	   DATA,;
	   NOTA,;
	   TIPO,;
	   NATU_CLI,;
	   COUNT(1)     AS NRO_VENDAS,;     
	   SUM(QTDE) AS TQTDEVENDA ,;
	   SUM(VLRVENDA) AS TVLRVENDA,;
	   SUM(VLRVENDA/QTDE) AS UVLRVENDA ;
  FROM X:\SCGC\LOJA\ITEMMOV IT ;
  WHERE ;
  	    MONTH(DATA) = 12;
  	 AND YEAR(DATA) = 2006;
	 AND TIPO <> "VLE";
  	 AND CH_OPERA = "1" ;
  	 AND LEFT(OPERACAO,1) = "S" ;
  	 AND LEFT(SITUACAO,1) = "O" ;
  	 AND CODIGO IN (SELECT CODIGO FROM CODIGO) ;
  GROUP BY   CODIGO,DATA, NOTA;
  INTO CURSOR VENDAS
  
**---    JUNCAO  

SELECT ;
       CP.IVA,;
       CP.UVLRCOMIVA,;
       CP.UTCUSTO_MED,;
	   (VD.TVLRVENDA/VD.TQTDEVENDA) AS UVLRVENDA,;
	   VD.TQTDEVENDA ,;
	   00000000,00  AS IVAVENDA,;
	   VD.TVLRVENDA,;
	   VD.TIPO,;
	   VD.NATU_CLI,;
	   CP.CODIGO,;
       CP.DESCRICAO,;
	   CP.NF_ENT,;
	   VD.DATA,;
	   VD.NOTA AS NF_VENDA;
  FROM COMPRAS CP , VENDAS VD;
  WHERE  VD.CODIGO = CP.CODIGO;
  GROUP BY   CP.CODIGO,VD.DATA, VD.NOTA;
  INTO CURSOR IVA

SELECT ;
	   IIF(UVLRCOMIVA > UVLRVENDA,"ALERTA","       ") AS OBS,;
	   UVLRVENDA,;
       UTCUSTO_MED,;
       IVA,;
       UVLRCOMIVA,;
       IIF(TIPO $"VLG/VLH/VLI/VLJ/VFG/VFH/VFI/VFJ/VFK/VFL/  ;
	       VFM/VFN/VFO/VFP/VFQ/VFR/VLE/VLF",0,1)*(UVLRVENDA - UVLRCOMIVA) AS DIF,;
	   TIPO,;
	   NATU_CLI,;
	   ULNTZ(NATU_CLI) AS NATUREZA,;
	   NF_VENDA,;
	   TQTDEVENDA ,;
	   IIF(TIPO $"VLG/VLH/VLI/VLJ/VFG/VFH/VFI/VFJ/VFK/VFL/  ;
	       VFM/VFN/VFO/VFP/VFQ/VFR/VLE/VLF",0,1)*TQTDEVENDA*UVLRCOMIVA  AS IVAVENDA,;
	   TVLRVENDA,;
	   CODIGO,;
       DESCRICAO,;
	   NF_ENT,;
	   DATA,;
	   (IV.UVLRVENDA-IV.UTCUSTO_MED) * 100 /IV.UVLRVENDA  AS MARGEM;
  FROM IVA IV;
  INTO TABLE C:\TMP\IVANF


RETURN


*******************************************************

FUNCTION ULNTZ
PARAMETERS NTZ
	LNTZ = ""
	DO CASE
		CASE NTZ = 0
			LNTZ = "VAREJO   "
		CASE NTZ = 1
			LNTZ = "REVENDA  "
		CASE NTZ = 2
			LNTZ = "P.PUBLICO"
		CASE NTZ = 3
			LNTZ = "FROTA    "
	ENDCASE
RETURN(LNTZ)
