*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ 03/10/2000            OBJ_ECF.SPR              10:41:38 ╨
*       ╨                                                         ╨
*       гддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╤
*       ╨                                                         ╨
*       ╨ Author's Name                                           ╨
*       ╨                                                         ╨
*       ╨ Copyright (c) 2000 Company Name                         ╨
*       ╨ Address                                                 ╨
*       ╨ City,     Zip                                           ╨
*       ╨                                                         ╨
*       ╨ Description:                                            ╨
*       ╨ This program was automatically generated by GENSCRN.    ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫

PARAMETERS lschamada

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨          OBJ_ECF/MS-DOS Setup Code - SECTION 1          ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1

PRIVATE LNecf

LNecf = 0	&& CONTROLADOR REFERENTE A ECF
LNecf=ECFconecta(wp_TIPOECF)	&&connecta ECF

IF LNecf < 1
	return
ENDIF
=ECFprgpgt(wp_TIPOECF,LNecf)



#REGION 0
REGIONAL m.currarea, m.talkstat, m.compstat

IF SET("TALK") = "ON"
	SET TALK OFF
	m.talkstat = "ON"
ELSE
	m.talkstat = "OFF"
ENDIF
m.compstat = SET("COMPATIBLE")
SET COMPATIBLE FOXPLUS

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨                MS-DOS Window definitions                ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

IF NOT WEXIST("obj_ecf") ;
	OR UPPER(WTITLE("OBJ_ECF")) == "OBJ_ECF.PJX" ;
	OR UPPER(WTITLE("OBJ_ECF")) == "OBJ_ECF.SCX" ;
	OR UPPER(WTITLE("OBJ_ECF")) == "OBJ_ECF.MNX" ;
	OR UPPER(WTITLE("OBJ_ECF")) == "OBJ_ECF.PRG" ;
	OR UPPER(WTITLE("OBJ_ECF")) == "OBJ_ECF.FRX" ;
	OR UPPER(WTITLE("OBJ_ECF")) == "OBJ_ECF.QPR"
	DEFINE WINDOW obj_ecf ;
		FROM 2, 2 ;
		TO 21,77 ;
		TITLE "[ Informacoes Finais Para Faturamento ]" ;
		FOOTER "[OBJ_FATU]" ;
		NOFLOAT ;
		NOCLOSE ;
		NOMINIMIZE ;
		NONE ;
		COLOR SCHEME 1
ENDIF


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨          OBJ_ECF/MS-DOS Setup Code - SECTION 2          ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
*---------------------------------------------------------------------*
* ARQUIVOS UTILIZADOS :                                               *
* OBJETIVO : GERENCIAR CUPOM FISCAL - ECF
*---------------------------------------------------------------------*

PUSH KEY CLEAR		&& desabilita teclas de atalho def. anteriormente
ON KEY LABEL F1		DO HLP2000.SPR WITH  POPUP(),PROMPT(),PROGRAM(),;
							WONTOP(),VARREAD()

******>>>> INICIO CONTROLE AMBIENTAL

ON KEY LABEL ESCAPE  WAIT WINDOW "Para sair selecione <Ok>."

wl_areant 	= ALLTRIM(ALIAS()) && PERMITE RETORNAR A AREA ANTER. A CHAMADA

isediting	= .t.


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨              OBJ_ECF/MS-DOS Screen Layout               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
IF WVISIBLE("obj_ecf")
	ACTIVATE WINDOW obj_ecf SAME
ELSE
	ACTIVATE WINDOW obj_ecf NOSHOW
ENDIF
@ 16,64 TO 18,74 ;
	COLOR SCHEME 24
@ 18,65 TO 18,73 ;
	COLOR SCHEME 23
@ 17,74 SAY "Ё" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 18,74 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 16,74 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 0,0 TO 19,75 ;
	COLOR SCHEME 23
@ 19,1 TO 19,74 ;
	COLOR SCHEME 24
@ 1,75 TO 18,75 ;
	COLOR SCHEME 24
@ 19,75 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 0,75 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 24
@ 16,53 TO 18,63 ;
	COLOR SCHEME 24
@ 18,54 TO 18,62 ;
	COLOR SCHEME 23
@ 17,63 SAY "Ё" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 18,63 SAY "ы" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 16,63 SAY "©" ;
	SIZE 1,1, 0 ;
	COLOR SCHEME 23
@ 0,21 SAY "[ ECF - Emissao de Cupom Fiscal ]" ;
	SIZE 1,33, 0
@ 0,69 SAY "[ECF]" ;
	SIZE 1,5, 0
@ 12,1 SAY "Seq.Comando" ;
	SIZE 1,11, 0
@ 17,1 SAY "Liquido:" ;
	SIZE 1,8, 0
@ 17,26 SAY "Bruto:" ;
	SIZE 1,6, 0
@ 10,67 SAY "Erro:" ;
	SIZE 1,5, 0
@ 10,26 SAY "Menssagem:" ;
	SIZE 1,10, 0
@ 15,26 SAY "Leitura X:" ;
	SIZE 1,10, 0
@ 12,26 SAY "Stat:" ;
	SIZE 1,5, 0
@ 10,1 SAY "Papel :" ;
	SIZE 1,7, 0
@ 12,44 SAY "Ultimo Comando:" ;
	SIZE 1,15, 0
@ 12,14 SAY "Transa┤ao:" ;
	SIZE 1,10, 0
@ 15,1 SAY "Redu┤ao Z:" ;
	SIZE 1,10, 0
@ 2,40 GET m.nro_swe ;
	PICTURE "@*HN \<C-Numero do Cupom" ;
	SIZE 1,19,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx5wu() ;
	VALID _07p0mx5xh()
@ 3,40 GET m.ST_swe ;
	PICTURE "@*HN \<D-Status" ;
	SIZE 1,10,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx5yi() ;
	VALID _07p0mx5z4() ;
	MESSAGE 'Abre Sistema Vendas'
@ 6,40 GET m.utili_swe ;
	PICTURE "@*HN \<I-Utilitarios" ;
	SIZE 1,15,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx60d() ;
	VALID _07p0mx60z() ;
	DISABLE
@ 11,2 GET LSpapel ;
	SIZE 1,20 ;
	DEFAULT " " ;
	WHEN .f.
@ 11,27 GET LSmenserro ;
	SIZE 1,39 ;
	DEFAULT " " ;
	WHEN .f.
@ 11,68 GET LSerro ;
	SIZE 1,1 ;
	DEFAULT " " ;
	WHEN .f.
@ 13,2 GET LSseq ;
	SIZE 1,4 ;
	DEFAULT " " ;
	WHEN .f.
@ 13,15 GET LStransacao ;
	SIZE 1,8 ;
	DEFAULT " " ;
	WHEN .f.
@ 13,27 GET LSstat ;
	SIZE 1,15 ;
	DEFAULT " " ;
	WHEN .f.
@ 13,50 GET LSescape ;
	SIZE 1,2 ;
	DEFAULT " " ;
	WHEN .f.
@ 16,2 GET LSreducao ;
	SIZE 1,20 ;
	DEFAULT " " ;
	WHEN .f.
@ 16,27 GET LSfazx ;
	SIZE 1,17 ;
	DEFAULT " " ;
	WHEN .f.
@ 17,56 GET m.OK_btn ;
	PICTURE "@*HN \<Ok" ;
	SIZE 1,4,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx645() ;
	VALID _07p0mx64w() ;
	MESSAGE 'Abre Sistema Vendas'
@ 17,66 GET m.cft_btn ;
	PICTURE "@*HN \<Saida" ;
	SIZE 1,7,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx661() ;
	VALID _07p0mx66o() ;
	MESSAGE 'Abre Sistema Vendas'
@ 18,2 GET LSliquido ;
	SIZE 1,12 ;
	DEFAULT " " ;
	WHEN .f.
@ 18,27 GET LSbruto ;
	SIZE 1,12 ;
	DEFAULT " " ;
	WHEN .f.
@ 2,2 GET m.LX_swe ;
	PICTURE "@*HN \<1-Leitura X" ;
	SIZE 1,13,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx681() ;
	VALID _07p0mx68n() ;
	MESSAGE 'Abre Sistema Vendas'
@ 3,5 GET m.fatvend_swe ;
	PICTURE "@*HN \<2-Fatura" ;
	SIZE 1,10,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx6af() ;
	VALID _07p0mx6b1()
@ 4,5 GET m.canc_swe ;
	PICTURE "@*HN \<3-Cancelar Cupom Anterior" ;
	SIZE 1,27,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx6ct() ;
	VALID _07p0mx6do()
@ 5,5 GET m.eminfcp_swe ;
	PICTURE "@*HN \<4-Copia Cupom em NF" ;
	SIZE 1,22,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx6m4() ;
	VALID _07p0mx6mp()
@ 6,5 GET m.visual_swe ;
	PICTURE "@*HN \<5-Visualizar Docs. Faturados" ;
	SIZE 1,30,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx6nw() ;
	VALID _07p0mx6oi()
@ 8,2 GET m.redZ_swe ;
	PICTURE "@*HN \<9-Reducao-Z" ;
	SIZE 1,13,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx6qf() ;
	VALID _07p0mx6r1()
@ 7,5 GET m.fchabrt_swe ;
	PICTURE "@*HN \<6-Fechar Cupom em Aberto" ;
	SIZE 1,27,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx6ui() ;
	VALID _07p0mx6v4()
@ 4,40 GET m.forma_swe ;
	PICTURE "@*HN \<E-Programa Forma Pgto" ;
	SIZE 1,23,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx6ym() ;
	VALID _07p0mx6z8() ;
	MESSAGE 'Abre Sistema Vendas'
@ 5,40 GET m.reset_swe ;
	PICTURE "@*HN \<F-RESET - Qdo.Impressora em ERRO" ;
	SIZE 1,34,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx700() ;
	VALID _07p0mx70m() ;
	MESSAGE 'Abre Sistema Vendas'
@ 7,40 GET m.mapaI_swe ;
	PICTURE "@*HN \<K-Mapa Resumo do Dia [IMPRESSAO]" ;
	SIZE 1,34,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx71p() ;
	VALID _07p0mx72a() ;
	MESSAGE 'Abre Sistema Vendas'
@ 8,40 GET m.lermemo ;
	PICTURE "@*HN \<L-Leitura Memoria Fiscal" ;
	SIZE 1,26,1 ;
	DEFAULT 1 ;
	WHEN _07p0mx73c() ;
	VALID _07p0mx73y()

IF NOT WVISIBLE("obj_ecf")
	ACTIVATE WINDOW obj_ecf
ENDIF

READ CYCLE MODAL

RELEASE WINDOW obj_ecf

#REGION 0
IF m.talkstat = "ON"
	SET TALK ON
ENDIF
IF m.compstat = "ON"
	SET COMPATIBLE ON
ENDIF


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨               OBJ_ECF/MS-DOS Cleanup Code               ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
SET DEVICE TO SCREEN

=ECFdesconecta(wp_TIPOECF,LNecf)

IF !EMPTY(wl_areant)
	SELECT &wl_areant
ENDIF

POP KEY 			   && reabilita teclas de controle

RETURN

*--------------  ROTINAS DE APOIO  - ECF ---------------*



*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨   OBJ_ECF/MS-DOS Supporting Procedures and Functions    ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

#REGION 1
PROCEDURE ULpos_ok
 	_CUROBJ = OBJNUM(ok_btn)
RETURN(.T.)

PROCEDURE ULpos_canc
 	_CUROBJ = OBJNUM(cft_btn)
RETURN(.T.)

*<<<<<<<<<<<<<<<<<<<  SUPORTE A ECF >>>>>>>>>>>>>>>>>*

FUNCTION ECFconecta
	PARAMETER LSmarca
	PRIVATE LNecf
	PRIVATE LSporta
	IF wp_ecf $ "RQE"	&& MODOS DE RECUPERACAO DE DADOS
		RETURN(99)	
	ENDIF
	PRIVATE LSalias, LFparametr
	*-------------------------------------------------------------*
	LSalias 	= ALIAS()
	LFparametr	= NetArq("parametr")
	IF (LFparametr) > 100000 && HOUVE FALHA DE ABERTURA
		LSporta = "COM1"
	ELSE
		GO TOP
		LSporta = parametr.porta_ecf
	ENDIF
	IF !EMPTY(LSalias) AND USED(LSalias)
		SELECT &LSalias
	ENDIF
	=UP_fecha("parametr",LFparametr)
	*-------------------------------------------------------------*
	DO CASE
		CASE LSmarca = "TESTE"
			LNecf = 999
		CASE LSmarca = "SWEDA"
			LNecf = FOPEN("C:\sweda\ifsweda.prn",12)
			IF LNecf < 0
				=FCLOSE(LNecf)
				WAIT WINDOW "ERRO ! Comunicacao com ECF "+LSmarca+" <ENTER>"
			ENDIF
  		CASE LSmarca = "BEMATEC"
			LSdirtmp = SYS(5)+CURDIR()
			SET DEFA TO C:\BEMATEC
			LNecf = FOPEN(LSporta,12)
			SET DEFA TO &LSdirtmp
		OTHERWISE
			LNecf = -1
	ENDCASE
RETURN(LNecf)

FUNCTION ECFdesconecta
	PARAMETER LSmarca, LNecf
	PRIVATE LSstatus
	LSstatus = .T.
	DO CASE
		CASE LSmarca $ "TESTE"
				LSstatus = .T.
		CASE LSmarca $ "SWEDA/BEMATEC"
			if !FCLOSE(LNecf)
				WAIT WINDOW "Arquivo ECF nao foi FECHADO  <ENTER> "
				LSstatus = .F.
			endif
		OTHERWISE
			LSstatus = .F.
	ENDCASE
RETURN(LSstatus)


FUNCTION ECFprgpgt			&& PROGRAMA FORMA DE PGTO
	PARAMETER LSmarca, LNecf
	DO CASE
		CASE LSmarca  = "BEMATEC"
		    Linha1 = Chr(27) + Chr(251) + "71|Cheque..........|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
			LSstatus=ECFstatus(wp_TIPOECF,LNecf)
			
		    Linha1 = Chr(27) + Chr(251) + "71|Cartao..........|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
			LSstatus=ECFstatus(wp_TIPOECF,LNecf)
			
		    Linha1 = Chr(27) + Chr(251) + "71|Duplicata.......|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
			LSstatus=ECFstatus(wp_TIPOECF,LNecf)
	ENDCASE
RETURN

FUNCTION ECFx_letura
	PARAMETER LSmarca, LNecf
	PRIVATE LSstatus
	LSstatus = ""
	WAIT WINDOW "Imprimindo Leitura X  " NOWAIT
	DO CASE
		CASE LSmarca = "SWEDA"
			=FWRITE(LNecf,chr(27)+".13}")
		CASE LSmarca = "BEMATEC"
		     Linha1 = Chr(27) + Chr(251) + "06|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
	ENDCASE
	LSstatus = ECFstatus(wp_TIPOECF,LNecf)
RETURN(LSstatus)


FUNCTION ECFlermemo
	PARAMETER LSmarca, LNecf
	PRIVATE LSstatus
	LSstatus = ""
	PRIVATE LDdtinicio,LDdtfim,LFmtvretorno,LFtpdtfim
	PRIVATE LS_di, LS_df, LS_dts

	STORE DATE() TO LDdtinicio,LDdtfim
	LFmtvretorno="NORMAL"
	LFtpdtfim   = .T.
	DO obj_dat1.spr WITH LDdtinicio,LDdtfim,LFmtvretorno,LFtpdtfim
	IF LFmtvretorno <> "ABORTADO"
		WAIT WINDOW "Imprimindo Leitura Memoria Fiscal  " NOWAIT
		DO CASE
			CASE LSmarca = "SWEDA"
				LS_di = SUBST(DTOC(LDdtinicio),1,2)+;
						SUBST(DTOC(LDdtinicio),4,2)+;
						SUBST(DTOC(LDdtinicio),9,2)
				LS_df = SUBST(DTOC(LDdtfim)   ,1,2)+;
						SUBST(DTOC(LDdtfim)   ,4,2)+;
						SUBST(DTOC(LDdtfim)   ,9,2)
				=FWRITE(LNecf,chr(27)+".16"+LS_di+LS_df+"}")
			CASE LSmarca = "BEMATEC"
				LS_dts = SUBST(DTOC(LDdtinicio),1,2)+;
 						 SUBST(DTOC(LDdtinicio),4,2)+;
						 SUBST(DTOC(LDdtinicio),9,2)+"|"+;
						 SUBST(DTOC(LDdtfim)   ,1,2)+;
						 SUBST(DTOC(LDdtfim)   ,4,2)+;
						 SUBST(DTOC(LDdtfim)   ,9,2)+"|I|"
				Linha1 = Chr(27)+Chr(251)+;
			         "08|"+LS_dts+Chr(27)
				=FWrite(LNecf, Linha1, Len(Linha1))
		ENDCASE
	ENDIF
	LSstatus = ECFstatus(wp_TIPOECF,LNecf)
RETURN(LSstatus)



FUNCTION ECFz_letura
	PARAMETER LSmarca, LNecf, LDdata
	PRIVATE LSstatus, LSdata
	LSstatus = ""
	WAIT WINDOW "Imprimindo Leitura Z  " NOWAIT
	DO CASE
		CASE LSmarca = "SWEDA"
			LSdata = 	STR(DAY(LDdata),2)+;
						STR(MONTH(LDdata),2)+;
						SUBS(STR(YEAR(LDdata),4),3)
			
			=FWRITE(LNecf,chr(27)+".14"+LSdata+"}")
		CASE LSmarca = "BEMATEC"
		     Linha1 = Chr(27) + Chr(251) + "05|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
	ENDCASE
	LSstatus = ECFstatus(wp_TIPOECF,LNecf)
RETURN(LSstatus)


FUNCTION ECFnrocupom
	PARAMETER LSmarca, LNecf
	PRIVATE LSstatus,LNnro
	DO CASE
		CASE LSmarca = "TESTE"
			LNnro 	 = INT(RAND()*100)
		CASE LSmarca = "SWEDA"
			=FWRITE(LNecf,chr(27)+".271}")
			LSstatus = FREAD(LNecf,128)
			LNnro 	 = VAL(SUBS(LSstatus,121,4))
		CASE LSmarca = "BEMATEC"
		     Linha1  = Chr(27) + Chr(251) + "30|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
			LSstatus = fread(LNecf,3)
			LSstatus = fread(LNecf,6)
			LNnro    = INT(VAL(LSstatus))
		OTHERWISE
			LNnro 	 = -1
	ENDCASE
RETURN(LNnro)


FUNCTION ECFcanccpm
	PARAMETER LSmarca, LNecf
	PRIVATE LSstatus
	LSstatus = ""
	DO CASE
		CASE LSmarca = "TESTE"
			LSstatus = ECFstatus(wp_TIPOECF,LNecf)
		CASE LSmarca = "SWEDA"
			=FWRITE(LNecf,chr(27)+".05}")
			LSstatus = ECFstatus(wp_TIPOECF,LNecf)
		CASE LSmarca = "BEMATEC"
		     Linha1 = Chr(27) + Chr(251) + "14|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
		    LSstatus=ECFstatus(wp_TIPOECF,LNecf)
			**********************************************************
			* NA BEMATEC SE O CUPOM ESTIVER ABERTO E INJETADO UM ITEM
			* E RECOMANDADO O CANCELAMENTO
			**********************************************************
			IF 	SUBS(LSstatus,7,1) = "E"
				Linha1 = Chr(27)+Chr(251)+;
						"09|0000000000000|.............................|"+;
						"II|0001|00000001|0001|"+Chr(27)
			   =FWrite(LNecf, Linha1, Len(Linha1))
		       Linha1 = Chr(27) + Chr(251) + "14|" + Chr(27)
			   =FWrite(LNecf, Linha1, Len(Linha1))
		       LSstatus=ECFstatus(wp_TIPOECF,LNecf)
			ENDIF
	ENDCASE
RETURN(LSstatus)

FUNCTION ECFabrecupom
	PARAMETER LSmarca, LNecf
	PRIVATE LSstatus
	LSstatus = ""
	DO CASE
		CASE LSmarca = "SWEDA"
			=FWRITE(LNecf,chr(27)+".17}")
		CASE LSmarca = "BEMATEC"
			LScgccpf = ""
			LScgccpf = CHRTRAN(STR(orcament.cliente,14)," ","0")
			LScgccpf = LScgccpf+"000000000000000|"
			Linha1 = Chr(27) + Chr(251) + "00|"+LScgccpf+ Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
	ENDCASE
	LSstatus = ECFstatus(wp_TIPOECF,LNecf)
RETURN(LSstatus)


FUNCTION ECFabrenaof
	PARAMETER LSmarca, LNecf
	PRIVATE LSstatus
	LSstatus = ""
	DO CASE
		CASE LSmarca = "SWEDA"
			=FWRITE(LNecf,chr(27)+".19}")
		CASE LSmarca = "BEMATEC"
		     Linha1 = Chr(27) + Chr(251) + "66|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
	ENDCASE
	LSstatus=ECFstatus(wp_TIPOECF,LNecf)
RETURN(LSstatus)

FUNCTION ECFtextonaof
	PARAMETER LSmarca, LNecf, LNnronota

	PRIVATE LSstatus
	LSstatus = ""
	DO CASE
		CASE LSmarca = "SWEDA"
			LStxt = "2D"+LEFT(ORCAMENT.NOME,40)
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")

			LStxt = "0D"+ORCAMENT.ENDERECO
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")

			LStxt = "0D"+ORCAMENT.BAIRRO+ORCAMENT.CIDADE+"-"+ORCAMENT.ESTADO
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")

			LStxt = "0D"+" "
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")
			LStxt = "0D"+"Recebi(emos)de Pneul┐ndia Comercial Ltda"
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")

			LStxt = "0D"+"os produtos  e  servi┤os  constantes  no"
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")
			LStxt = "0D"+"CUPOM FISCAL indicado  abaixo.          "
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")

			LStxt = "0D"+" "
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")

			LScupom = INT(ECFnrocupom(wp_TIPOECF,LNecf)) + 1  && o pr╒ximo
			LScupom = STR(LScupom,6)

			LStxt = "0D"+"Cupom Nro : "+LScupom+"  em :___/___/___"
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")

			LStxt = "0D"+" "
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")

			LStxt = "0D"+"________________________________________"
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")

			LStxt = "0D"+"   Identificacao e Ass. do Recebedor    "
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")

			LStxt = "0D"+" "
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")

			SELE banco
			SEEK orcament.banco

		 	LSlinha3 =  ""

			if FOUND()
			 	LSlinha3 =  "2D"+LEFT(" Cobr.: "+banco.nome+SPACE(30),35)
			ENDIF
			=FWRITE(LNecf,chr(27)+".08"+LSlinha3+"}")
			**************************************************************
			* =ECFinfdpl NAO PODE RECEBER PARAMETROS POR REFERENCIA
			*			OS DADOS SAO ALTERADOS NA FUNCAO
			**************************************************************
			SET UDFPARMS VALUE
			STORE "" TO wp_retorno
			=ECFinfdpl(LSmarca,orcament.empresa,orcament.valor,;
						 LNnronota,orcament.vlr_ent,;
						 orcament.tp_pgto,orcament.banco,;
						 orcament.prazo)
			SET UDFPARMS REFERENCE		&& DEFAUT DO SYSTEMA
			**************************************************************
			LNind = 0
			FOR LNind = 1 TO 12		&& NRO DE OCORRENCIAS DE WP_RETORNO
				IF EMPTY(wp_retorno(LNind))
					EXIT
				ENDIF
				LSlinha4	= "0D"+wp_retorno(LNind)
				=FWRITE(LNecf,chr(27)+".08"+LSlinha4+"}")
			NEXT

			LStxt = "0D"+" "
			=FWRITE(LNecf,chr(27)+".08"+LStxt+"}")
			LSstatus=ECFstatus(wp_TIPOECF,LNecf)
	ENDCASE
RETURN(LSstatus)

FUNCTION ECFfechacupom
	PARAMETER LSmarca, LNecf
	PRIVATE LSstatus

	LSstatus = ""
	DO CASE
		CASE LSmarca = "SWEDA"
			=FWRITE(LNecf,chr(27)+".12}")
		CASE LSmarca = "BEMATEC"
		     Linha1 = Chr(27) + Chr(251) + "66|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
	ENDCASE
	LSstatus=ECFstatus(wp_TIPOECF,LNecf)
RETURN(LSstatus)

FUNCTION ECFimpcupom
	PARAMETER LSmarca, LNecf,LNnfini,LNnffim,LNvalor
	PRIVATE LSstatus
	LSstatus = ""

	SELECT  orcatmp
	SET ORDER TO TAG itemnota
	SET NEAR ON
	SEEK STR(wp_empresa,3)+LEFT(nota.TIPO,1)+STR(LNnfini,7)
	SET NEAR OFF
	*--------- INICIO - IMPRESSAO DO CUPOM FISCAL -------------------*

	WAIT WINDOW "Imprimindo Cupom Fiscal X  " NOWAIT

	* 1.2	- Cabecalho do cupom	[ OPCAO SO NA SWEDA ]

	DO CASE
		CASE LSmarca = "SWEDA"
			LSoper = STR(nota.operador,4)
			LSvend = STR(nota.serv_1,4)
			LSosi  = STR(nota.NOTA,7)	&& REGISTRO EQUIV. A NOTA
			=FWRITE(LNecf,chr(27)+".0905"+LSvend+"  |01"+LSoper+"}")
			=FWRITE(LNecf,chr(27)+".0929"+LSosi+"}")
	ENDCASE

	* 1.3	- Itens

		SELE orcatmp
		CTR = 0
		DO WHILE !EOF() AND nota.empresa = orcatmp.empresa ;
						AND  orcatmp.nota <= LNnffim
						
			IF !(LEFT(orcatmp.situacao,1) = "O")  && ALGO ERRADO NO ITEM
				SKIP
			ENDIF

			LScod 	=	orcatmp.codigo+SPACE(2)

    	 	CTR = CTR + 0.01
		 	LSqtde	=	STR(orcatmp.qtde,8,3)
			LSqtde	=	CHRTRAN(LSqtde,",","")
			LSqtde	=	CHRTRAN(LSqtde,".","")
			LSqtde	=	CHRTRAN(LSqtde," ","0")

			*-- verificar a impressao de preco unit 0 na nf ---*

			m.LFimpdescto = .f.
		
			LSprun  =	IIF(orcatmp.qtde=0,orcatmp.vlrvenda,;
							orcatmp.vlrvenda / orcatmp.qtde)
			DO CASE
				CASE LSmarca = "SWEDA"
					LSprun	=	STR(LSprun,10,2)
				CASE LSmarca = "BEMATEC"
					LSprun	=	STR(LSprun,9,2)
			ENDCASE
			LSprun  =	CHRTRAN(LSprun,",","")	&& RETIRA VIRGULA
			LSprun  =	CHRTRAN(LSprun,".","")	&& RETIRA VIRGULA
			LSprun  =	CHRTRAN(LSprun," ","0")	&& PREENCHE DE 0

			DO CASE
				CASE LSmarca = "SWEDA"
			 		LSprtot	=	STR(orcatmp.vlrvenda,13,2)
				CASE LSmarca = "BEMATEC"
			 		LSprtot	=	STR(orcatmp.vlrvenda,9,2)
			ENDCASE
			LSprtot	=	CHRTRAN(LSprtot,",","")	&& RETIRA VIRGULA
			LSprtot	=	CHRTRAN(LSprtot,".","")	&& RETIRA VIRGULA
			LSprtot	=	CHRTRAN(LSprtot," ","0")	&& PREENCHE DE 0

			DO CASE
				CASE LSmarca = "SWEDA"
					LSdescr	=	LEFT(orcatmp.descricao+SPACE(24),24)		
				CASE LSmarca = "BEMATEC"
					LSdescr	=	LEFT(orcatmp.descricao+SPACE(29),29)		
			ENDCASE
	
			LSdsct  = "0000"
			*------ INICIO - ENQUADRAMENTO DA TRIBUTACAO -----*
			LStrib = "99"	&& SE NAO  ENQUADRAR 99 PROVOCA ERRO PARA
							&& NAO DEIXAR REGISTRAR O ITEM
			DO CASE
				CASE LSmarca = "SWEDA"
					*<<<<<<<<<<<<  VALORES DE TESTE SWEDA >>>>>>>>>>>
				 	*LSqtde	=	STR(1,8,3)
					*LSqtde	=	CHRTRAN(LSqtde,",","")
					*LSqtde	=	CHRTRAN(LSqtde,".","")
					*LSqtde	=	CHRTRAN(LSqtde," ","0")

					****LSprun	=	STR(0.01,10,2)
					*LSprun  =	CHRTRAN(LSprun,",","")	&& RETIRA VIRGULA
					*LSprun  =	CHRTRAN(LSprun,".","")	&& RETIRA VIRGULA
					*LSprun  =	CHRTRAN(LSprun," ","0")	&& PREENCHE DE 0

		 			*LSprtot	=	STR(0.01,13,2)
					*LSprtot	=	CHRTRAN(LSprtot,",","")	&& RETIR VIRGULA
					*LSprtot	=	CHRTRAN(LSprtot,".","")	&& RETIRAIRGULA
					*LSprtot	=	CHRTRAN(LSprtot," ","0") && PREENCHE 0

					*<<<<<<<<<<<<<<<<<<<------->>>>>>>>>>>>>>>>>>>>>>
	
					DO CASE
						CASE orcatmp.cst = "6"
							 LStrib = "F  "
						CASE orcatmp.cst = "9"
							 LStrib = "T0 "
						CASE orcatmp.cst = "0"
							 LSaliq = INT(orcatmp.aliq_icms)
							 LSaliq = STR(LSaliq,2)
							 LSaliq = CHRTRAN(LSaliq," ","0")
							 DO CASE
								CASE LSaliq = "17"
									LStrib = "T01"								
								CASE LSaliq = "05"
									LStrib = "T02"								
								CASE LSaliq = "07"
									LStrib = "T03"								
								CASE LSaliq = "12"
									LStrib = "T04"
								CASE LSaliq = "25"
									LStrib = "T05"								
							 ENDCASE
						OTHERWISE
							 LStrib = "N  "
					ENDCASE
				CASE LSmarca = "BEMATEC"
					DO CASE
						CASE orcatmp.cst = "6"
							 LStrib = "FF"
						CASE orcatmp.cst = "0"
							 LSaliq = INT(orcatmp.aliq_icms)
							 LSaliq = STR(LSaliq,2)
							 LSaliq = CHRTRAN(LSaliq," ","0")
							 DO CASE
								CASE LSaliq = "07"
									LStrib = "03"								
								CASE LSaliq = "12"
									LStrib = "04"								
								CASE LSaliq = "17"
									LStrib = "01"								
								CASE LSaliq = "25"
									LStrib = "05"								
							 ENDCASE
						CASE orcatmp.cst = "9"
							 LStrib = "02"
						CASE orcatmp.cst = "2"   && REDUCAO NA  BASE DE CALC
							 LSaliq = INT(orcatmp.aliq_icms)
							 LSaliq = STR(LSaliq,2)
							 LSaliq = CHRTRAN(LSaliq," ","0")
							 IF orcatmp.empresa = 8	&& ARG TEM BASE REDUZIDA
							 	LSaliq = "12" && A REDUCAO => ALIQ DE 12%
							 ENDIF
							 DO CASE
								CASE LSaliq = "07"
									LStrib = "03"								
								CASE LSaliq = "12"
									LStrib = "04"								
								CASE LSaliq = "17"
									LStrib = "01"								
								CASE LSaliq = "25"
									LStrib = "05"								
							 ENDCASE
						OTHERWISE
							 LStrib = "NN"
					ENDCASE
			ENDCASE
			*-------------------------------------------------*		
			DO CASE
				CASE LSmarca = "SWEDA"
					=FWRITE(LNecf,chr(27)+".01"+LScod+LSqtde+LSprun+;
							LSprtot+LSdescr+LStrib+"08}")
				CASE LSmarca = "BEMATEC"
				     Linha1 = Chr(27) + Chr(251) + "09|"+;
				     		 LScod+"|"+LSdescr+"|"+LStrib+"|"+;
				     		 LSqtde+"|"+LSprun+"|"+LSdsct+"|"+ Chr(27)
					=FWrite(LNecf, Linha1, Len(Linha1))
			ENDCASE
			LSstatus=ECFstatus(wp_TIPOECF,LNecf)
			IF SUBS(LSstatus,7,1) = "E"
				WAIT WINDOW LSstatus
				EXIT
			ENDIF			
			SKIP		
		ENDDO
		IF SUBS(LSstatus,7,1) = "E"
			WAIT WINDOW "A ECF Nao Acatou o ITEM "+orcatmp.descricao
			WAIT WINDOW LSstatus
			RETURN(2)
		ENDIF			

	* 1.4	- Totalizando

		LSmodpg = CHRTRAN(STR(nota.forma_pgto,2)," ","0")

		LSvalor	=	STR(LNvalor,13,2)			&& VALOR DO FATURAMENTO
		LSvalor	=	CHRTRAN(LSvalor,",","")		&& RETIRA VIRGULA
		LSvalor	=	CHRTRAN(LSvalor,".","")		&& RETIRA PONTO
		LSvalor	=	CHRTRAN(LSvalor," ","0")	&& PREENCHE DE 0

		DO CASE
			CASE LSmarca = "SWEDA"
					*<<<<<<<<<<<<  VALORES DE TESTE SWEDA >>>>>>>>>>>
				*LSvalor	=	CHRTRAN(LSvalor,",","")	&& RETIRA VIRGULA
				*LSvalor	=	CHRTRAN(LSvalor,".","")		&& RETIRA PONTO
				*LSvalor	=	CHRTRAN(LSvalor," ","0")	&& PREENCHE DE 0
					*<<<<<<<<<<<< ----------------------- >>>>>>>>>>>

				=FWRITE(LNecf,chr(27)+".10"+LSmodpg+LSvalor+"}")
				LSstatus=ECFstatus(wp_TIPOECF,LNecf)
			CASE LSmarca = "BEMATEC"
		    	***  INICIA FECHAMENTO COM FORMA DE PGTO ***
			     Linha1 = Chr(27) + Chr(251) + "32|A|0000|"+ Chr(27)
				 =FWrite(LNecf, Linha1, Len(Linha1))
				 LSstatus=ECFstatus(wp_TIPOECF,LNecf)
				 IF SUBS(LSstatus,7,1) <> "E"
					 && EFETUA FORMA DE PAGAMENTO
				     Linha1 = Chr(27) + Chr(251) + "72|"+;
			     			LSmodpg+"|00"+LSvalor+"|"+ Chr(27)
					 =FWrite(LNecf, Linha1, Len(Linha1))
					LSstatus=ECFstatus(wp_TIPOECF,LNecf)
				 ENDIF
		ENDCASE
		IF SUBS(LSstatus,7,1) = "E"
			WAIT WINDOW "A ECF Nao Acatou a TOTALIZACAO DO CUPOM"
			WAIT WINDOW LSstatus
			RETURN(3)
		ENDIF			
	

	* 1.5	- Informando CGC/CPF  e INSCRICAO
		DO CASE
			CASE LSmarca = "SWEDA"
				IF nota.tp_pessoa = 1
					LScgc = "01"+;
						TRANSFORM(STR(nota.favorecido,14),;
									"@R 99.999.999/9999.99")+SPACE(12)
				ELSE
					LScgc = "02"+;
						TRANSFORM(STR(nota.favorecido,14),;
									"@R 999.999.999.999-99")+SPACE(12)
				ENDIF
				=FWRITE(LNecf,chr(27)+".060"+LScgc+"}")
				LSstatus=ECFstatus(wp_TIPOECF,LNecf)
				IF SUBS(LSstatus,7,1) = "E"
					SET DEVICE TO SCREEN
					WAIT WINDOW LSstatus
					RETURN(4)
				ENDIF			
				IF nota.tp_inscr = 1
					LScgc = "03"+nota.inscricao
					=FWRITE(LNecf,chr(27)+".060"+LScgc+"}")
					LSstatus=ECFstatus(wp_TIPOECF,LNecf)
					IF SUBS(LSstatus,7,1) = "E"
						SET DEVICE TO SCREEN
						WAIT WINDOW LSstatus
						RETURN(5)
					ENDIF			
				ENDIF
		ENDCASE

	* 1.6	- Fechando o Cupom

		*<<<<<<<<<<<<<   MONTANDO MENSSAGEM FINAL >>>>>>>>>>>>>>>
		DO CASE
			CASE LSmarca = "SWEDA"
				LSlinha0 = "0"+STRTRAN(LEFT(nota.nome+SPACE(40),40)," ",".")

				IF orcament.tp_pgto = 1  	&& PGTO A VISTA
				 	LSlinha1 =  ""
				ELSE
					SELE banco
					SEEK orcament.banco
				 	LSlinha1 =  ""
					IF FOUND()
					 	LSlinha1 =  "0"+;
					 		LEFT("COBRANCA: "+banco.nome+SPACE(40),40)
							LSlinha1 =  STRTRAN(LSlinha1," ",".")
					ENDIF
				ENDIF
				***********************************************************
				* =ECFinfdpl NAO PODE RECEBER PARAMETROS POR REFERENCIA
				*			OS DADOS SAO ALTERADOS NA FUNCAO
				***********************************************************
				SET UDFPARMS VALUE
				STORE "" TO wp_retorno
				LNnronota = nota.nota
				=ECFinfdpl(LSmarca,orcament.empresa,orcament.valor,;
						 LNnronota,orcament.vlr_ent,;
						 orcament.tp_pgto,orcament.banco,;
						 orcament.prazo)
				SET UDFPARMS REFERENCE		&& DEFAUT DO SYSTEMA
				********************************************************
				LNind = 0
				LSlinha2 = ""
				LSlnaux  = ""
				FOR LNind = 1 TO 12		&& NRO DE OCORRENCIAS DE WP_RETORNO
					IF EMPTY(wp_retorno(LNind))
						EXIT
					ENDIF
					IF LNind = 1
						LSlnaux		= "0Dupl.:"
					ENDIF

					IF LEN(LSlnaux)	>= 41	&& CHEGOU PROX. DO LIMITE 40
											&& OU 2 DUPLIC POR LINHA
						LSlinha2 = LSlinha2+LEFT(LSlnaux,41)
						LSlnaux  = "0"+SUBS(LSlnaux,42)
					ENDIF

					LSlnaux	= LSlnaux+wp_retorno(LNind)
				NEXT

				IF LEN(LSlnaux)	>  1	&& TEM DADOS DE DUPLICATA
					LSlinha2 = LSlinha2+LEFT((LSlnaux+SPACE(42)),41)
				ENDIF
				LSlinha3 = ;
				  "0Servico:"+;
					TRANSF(nota.TOTSERVICO,"@Z *,***,**9.99")+;
				  "Mercad.:"+;
					TRANSF(nota.TOTPRODUTO,"@Z *,***,**9.99")

				LSlinha4 = ""

				LSlinha5 = "0"+SPACE(40)
				LSlinha6 = "0"+SPACE(40)
				LSlinha7 = "0"+REPLICATE("_",40)
				LSlinha8 ="0Recebi Merc. e Serv.deste Cupom              "
				LSlinha8 =  LEFT(STRTRAN(LSlinha8," ","."),41)

				LSlinha9 = "<< REG:" + STR(nota.nota,7)+;
					   " OSI:"+STR(nota.referencia,7)+" >>"+SPACE(40)
				LSlinha9 = "0"+LEFT(LSlinha9,40)
				LSlinha9 =  STRTRAN(LSlinha9," ",".")

				LSlinha9 =  ""

				LSgeral  =   LSlinha0+LSlinha1+LSlinha7+LSlinha8+;
						 LSlinha2+;
						 LSlinha3+LSlinha4+LSlinha5+;
						 LSlinha6+LSlinha9
				IF LEN(LSgeral) > 327
					LSBKPGERAL = LSGERAL
					LSgeral = LEFT(LSgeral,327)
				ENDIF

				=FWRITE(LNecf,chr(27)+".12"+LSgeral+"}")
				LSstatus=ECFstatus(wp_TIPOECF,LNecf)
				IF SUBS(LSstatus,7,1) = "E"
					LSgeral = LEFT(LSgeral,287)
					=FWRITE(LNecf,chr(27)+".12"+LSgeral+"}")
					LSstatus=ECFstatus(wp_TIPOECF,LNecf)
					IF SUBS(LSstatus,7,1) = "E"
						LSgeral = LEFT(LSgeral,246)
						=FWRITE(LNecf,chr(27)+".12"+LSgeral+"}")
					ENDIF			
				ENDIF			
			CASE LSmarca = "BEMATEC"
				LSlinha0 = STRTRAN(LEFT(nota.nome+SPACE(48),48)," ",".")
				IF orcament.tp_pgto = 1  	&& PGTO A VISTA
				 	LSlinha1 =  ""
				ELSE
					SELE banco
					SEEK orcament.banco
				 	LSlinha1 =  ""
					if FOUND()
					 	LSlinha1 =  ;
					 		LEFT("COBRANCA: "+banco.nome+SPACE(48),48)
						LSlinha1 =  STRTRAN(LSlinha1," ",".")
					ENDIF
				ENDIF
				***********************************************************
				* =ECFinfdpl NAO PODE RECEBER PARAMETROS POR REFERENCIA
				*			OS DADOS SAO ALTERADOS NA FUNCAO
				***********************************************************
				SET UDFPARMS VALUE
				STORE "" TO wp_retorno
				LNnronota = nota.nota
				=ECFinfdpl(LSmarca,orcament.empresa,orcament.valor,;
						 LNnronota,orcament.vlr_ent,;
						 orcament.tp_pgto,orcament.banco,;
						 orcament.prazo)
				SET UDFPARMS REFERENCE		&& DEFAUT DO SYSTEMA
				********************************************************
				LNind = 0
				LSlinha2 = ""
				FOR LNind = 1 TO 12		&& NRO DE OCORRENCIAS DE WP_RETORNO
					IF EMPTY(wp_retorno(LNind))
						EXIT
					ENDIF
					IF LNind = 1
						LSlinha2	= "DUPLIATAS: "
					ENDIF
					LSlinha2	= LSlinha2+wp_retorno(LNind)+ " -- "
				NEXT
				LSlinha2 =  STRTRAN(LSlinha2," ",".")
				LSlinha3 = ;
				  "Servico.:"+;
					TRANSF(nota.TOTSERVICO,"@Z *,***,**9.99")+" --- "
				LSlinha4 = ;
				  "Mercadoria.:"+;
					TRANSF(nota.TOTPRODUTO,"@Z *,***,**9.99")+" --- "
				LSlinha5 = ""
				LSlinha6 = ""
				LSlinha7 = REPLICATE("_",48)
				LSlinha8 =" Recebi as Mercadorias e Servicos deste Cupom   "
				LSlinha8 =  STRTRAN(LSlinha8," ",".")
				LSlinha9 = "<< REG:" +STR(nota.nota,7)+;
					   " OSI:"+STR(nota.referencia,7)+" >>"
				LSlinha9 =  STRTRAN(LSlinha9," ",".")
				LSgeral  =   LSlinha0+LSlinha1+LSlinha7+LSlinha8+;
						 LSlinha2+;
						 LSlinha3+LSlinha4+LSlinha5+;
						 LSlinha6+LSlinha9

				LSgeral= LEFT(LSgeral+REPLICATE(".",492),484)
			    LSgeral= Chr(27) + Chr(251)+"34|"+LSgeral+"|"+ Chr(27)
				=FWrite(LNecf, LSgeral,LEN(LSgeral))
		ENDCASE
		LSstatus=ECFstatus(wp_TIPOECF,LNecf)
		IF SUBS(LSstatus,7,1) = "E"
			WAIT WINDOW "A ECF Nao Acatou o FECHAMENTO DO CUPOM"
			WAIT WINDOW LSstatus
			RETURN(6)
		ENDIF			
		*--------- FIM - IMPRESSAO DO CUPOM FISCAL ---------------*
		SET DEVICE TO SCREEN
RETURN(0)



****************************************************************************
* FUCTION ECFinfdpl : PROCESSA DADOS REFERENTES AS DUPLICATAS RETORNANDO
*			UMA STRING COM NUMERO E VENCIMENTO DAS DUPLICATAS
****************************************************************************

FUNCTION ECFinfdpl	
	PARAMETERS	LSmarca,LNempresa, LNvlrfatura ,;
				LNnronota, LNvlrentrada ,;
				LNtp_pgto, LNbanco, ;
				LSprazo

	&&   LNnronota	 =  O NUMERO DA NOTA DEVE SER O DA 1a NOTA CASO
						&& TENHAM SIDO GERADAS DUAS COM BASE NO MESMO ORCAMENTO
						&& PARA EVITAR INFLUENCIA NO AMBENTE NOTA E PRIVATE
						
	&&   LNbanco     =  EM COMPRAS A PRAZO COM A 1a DUPLICATA A
						&& VISTA OU CONTA APRESENTACAO, ESTA 1a E
						&& DIRECIONADA P/ A CARTEIRA E A DEMAIS
						&& P/ O BANCO SOLICITADO. LNbanco GUARDO O
						&& BANCO SOLICITADO P/ USO APOS GERAR A 1a

	PRIVATE 	LNocorrenc,LNposic,LNinicio,LNnumpgt,LNdias,LNserie

	PRIVATE 	LNvlrdupl,LNdifere,LNduplicata,LNvlrdoc,LDdt_venc,;
				CVSTR1,CVSTR2

	IF LNtp_pgto = 1   && VENDA A VISTA
		RETURN
	ENDIF
	LNvlrdupl	=	0
	LNdifere	=	0
	LNduplicata	=	0
	LNvlrdoc	=	0
	LDdt_venc	=	{}
	CVSTR1		=	""
	CVSTR2		=	""


	LNocorrenc 	= 1
    LNposic    	= 0
    LNinicio   	= 1
    LNnumpgt   	= 0
	LNdias	   	= 0
	LNserie	   	= 1

	DO WHILE .t.
        LNposic = AT("/",LSprazo, LNocorrenc)
        LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
		******************************************************************
   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
			EXIT
		ENDIF
		******************************************************************
		IF LNdias = 0 AND LNnumpgt > 0
	        LNnumpgt   = LNnumpgt
		ELSE			
	        LNnumpgt   = LNnumpgt + 1
		ENDIF
		LNocorrenc = LNocorrenc + 1
        LNinicio   = LNposic + 1
	ENDDO

	SET DECIMALS TO 6
	
	IF LNvlrentrada > 0 AND LNnumpgt > 1
		CVSTR1    = STR((LNvlrfatura - LNvlrentrada)/(LNnumpgt - 1) ,25,11)
		CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
		LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
		LNdifere  = LNvlrfatura - (LNvlrdupl * (LNnumpgt - 1) + ;
							+  LNvlrentrada)
    ELSE
		CVSTR1    = STR((LNvlrfatura) / (LNnumpgt) ,25,11)
		CVSTR2    = SUBS(CVSTR1,1,LEN(CVSTR1)-9)
		LNvlrdupl = VAL(CHRTRAN(CVSTR2,",","."))
		LNdifere  = LNvlrfatura - (LNvlrdupl * LNnumpgt)
	ENDIF
**>>>>>
	LNempresa	= nota.empresa
	LNduplicata	= LNnronota
**>>>>>
	LNocorrenc = 1
    LNposic    = 0
    LNinicio   = 1
	LNdias		= 0
	LVindice   = 1

	LNind 		= 1			&& INDICE DO VETOR DE ROTORNO

	DO WHILE .t.
        LNposic = AT("/",LSprazo, LNocorrenc)
        LNdias     = INT(VAL(SUBS(LSprazo,LNinicio,3)))
		**************************************************
   		IF LNposic = 0 OR (LNocorrenc > 1 AND LNdias = 0)
			EXIT
		ENDIF
		**************************************************
		IF LNempresa <> 10
			LNduplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  STR(LNempresa,1)))   && 1 => DUPLICATA
		else
			LNduplicata	= INT( VAL(   CHRTRAN(STR(LNnronota,7)," ","0")+;
								  CHRTRAN(STR(LNserie,1)," ","0")+;
								  "0"))   && 1 => DUPLICATA
		ENDIF
		IF LNvlrentrada > 0 AND LNnumpgt > 1
			LNvlr_doc 	 = LNvlrentrada + LNdifere
			LNvlrentrada = 0
			LNdifere   	 = 0
		ELSE
			LNvlr_doc  = LNvlrdupl + LNdifere
			LNdifere   = 0
		ENDIF
		LDdt_venc  = WP_DTOPER + LNdias

		LNserie    = LNserie + 1
		LNocorrenc = LNocorrenc + 1
        LNinicio   = LNposic + 1
*------------------  P/ IMPRESSAO NA NOTA ------------------------*
		LSdt  = STR(DAY(LDdt_venc),2)+"/"+STR(MONTH(LDdt_venc),2)
		LSdt  = CHRTRAN(LSdt," ","0")
		DO CASE
			CASE LSmarca = "SWEDA"
				LStmp = TRANSF(LNvlr_doc,"@Z 999,999.99")+" - "+LSdt+" ."
				LStmp = LStmp + SPACE(40)
				wp_retorno(LNind)	=  LEFT(LStmp,40)
			CASE LSmarca = "BEMATEC"
				LStmp = TRANSF(LNvlr_doc,"@Z 9,999,999.99")+" - "+LSdt+" "
				wp_retorno(LNind)	=  LStmp
		ENDCASE

		LNind = LNind + 1
*-----------------------------------------------------------------*
	ENDDO
	SET DECIMALS TO 2
RETURN(0)
********************************************************************
FUNCTION ECFsituacao
	PARAMETER LSmarca, LNecf
	PRIVATE LSstatus
	LSstatus = ""
	DO CASE
		CASE LSmarca = "TESTE"
			LSstatus=ECFstatus(wp_TIPOECF,LNecf)
		CASE LSmarca = "SWEDA"
			LSstatus=ECFstatus(wp_TIPOECF,LNecf)
		CASE LSmarca = "BEMATEC"
		     Linha1 = Chr(27) + Chr(251) + "19|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
			LSstatus = ECFstatus(wp_TIPOECF,LNecf)
	ENDCASE
RETURN(LSstatus)

FUNCTION ECFstatus				&& VERIFICA STA
	PARAMETER LSmarca, LNecf
	PRIVATE LSstatus
	LSstatus = ""	&& STATUS DA TRANSACAO
	LSsttimp = ""	&& STATUS DA IMPRESSORA
	DO CASE
		CASE LSmarca = "TESTE"
				LSstatus = "      P.ROCESSADO-"
				LSstat	 = "Concluido"
				LSerro	 = "N"
		CASE LSmarca = "SWEDA"
			=FWRITE(LNecf,chr(27)+".28}")
			LSstatus = FREAD(LNecf,128)
			=FWRITE(LNecf,chr(27)+".23}")
			LSsttimp = FREAD(LNecf,128)
			****************  INTERPRETACAO DO STATUS ***************
			LSseq 		=	SUBS(LSstatus,3,4)
			*
			*	1.	VERIFICANDO A EXECUCAO DO COMANDO
			*
			LSstat		=	""
			DO CASE
				CASE SUBS(LSstatus,7,1) = "C"
					LSstat = "Concluida"
				CASE SUBS(LSstatus,7,1) = "P"
					LSstat = "Pendente"
				CASE SUBS(LSstatus,7,1) = "E"
					LSstat = "Erro Comando"
			ENDCASE

			LStransacao =	SUBS(LSstatus,8,8)
			LSescape	=	SUBS(LSstatus,16,2)
			LSreducao	=	""
			DO CASE
				CASE SUBS(LSstatus,18,1) = "N"
					LSreducao = "Aceita"
				CASE SUBS(LSstatus,18,1) = "S"
					LSreducao = "Realizada"
				CASE SUBS(LSstatus,18,1) = "F"
					LSreducao = "Fazer"
			ENDCASE

			LSliq		=	SUBS(LSstatus,19,12)
			LSbruto		=	SUBS(LSstatus,31,12)
			LSerro		=	SUBS(LSstatus,43,1)
			LSmenserro	=	SUBS(LSstatus,55,40)
			LSLSfazx	=	""
			DO CASE
				CASE SUBS(LSstatus,124,1) = "S"
					LSfazx = "Efetuada"
				CASE SUBS(LSstatus,124,1) = "N"
					LSfazx = "Nao Fez"
				CASE SUBS(LSstatus,124,1) = "F"
					LSfazx = "Fazer"
			ENDCASE

			LSpapel = ""
			DO CASE
				CASE SUBS(LSsttimp,6,1) = "5"
					LSpapel = "TROCAR PAPEL...."
			ENDCASE
			*********************************************************
		CASE LSmarca = "BEMATEC"
			FOR LNleitura = 1 to 3
				DO CASE
					CASE	LNleitura = 1
						RTACK = fread(LNecf,1)
						ACK = ASC(RTACK)
					CASE	LNleitura = 2
						RTST1 = fread(LNecf,1)
						ST1 = ASC(RTST1)
					CASE	LNleitura = 3
						RTST2 = fread(LNecf,1)
						ST2 = ASC(RTST2)
				ENDCASE
			NEXT
			*
			*	1.	VERIFICANDO A EXECUCAO DO COMANDO
			*
			IF ACK <> 6 OR ST2 > 0 	&&  ECF NAO EXECUTOU O COMANDO
				LSstatus = "      E.RRO-"
				LSstat	 = "Erro Comando"
				LSerro	 = "E"
			ELSE
				LSstatus = "      P.ROCESSADO-"
				LSstat	 = "Concluido"
				LSerro	 = "N"
			ENDIF
			*
			*	2.	VERIFICANDO LEITURA Z e OUTROS
			*
			LSreducao	=	""
			LSliq		=	""
			LSbruto		=	""

			LSmenserro	=	""
			DO CASE
				CASE ST1 >=128
					LSmenserro	= "FIM DE PAPEL.........."
				CASE ST1 >=64
					LSmenserro	= "POUCO PAPEL..........."
				CASE ST1 >=32
					LSmenserro	= "ERRO NO RELOGIO......."
				CASE ST1 >=16
					LSmenserro	= "IMPRESSORA EM ERRO...."
				CASE ST1 >=8
					LSmenserro	= "1o DADO CMD N.FOI ESC."
				CASE ST1 >=4
					LSmenserro	= "COMANDO INEXISTENTE..."
				CASE ST1 >=2
					LSmenserro	= "CUPOM ABERTO.........."
				CASE ST1 >=1
					LSmenserro	= "PARAMETROS INVALIDOS.."
			ENDCASE
			DO CASE
				CASE ST2 >=128
					LSmenserro	= LSmenserro+"-TIPO PARAM.INVALIDO.."
				CASE ST2 >=64
					LSmenserro	= LSmenserro+"-MEMORIA FISC.LOTADA.."
				CASE ST2 >=32
					LSmenserro	= LSmenserro+"-ERRO MEMOR. RAM CMOS."
				CASE ST2 >=16
					LSmenserro	= LSmenserro+"-ALIQUOTA NAO PROG...."
				CASE ST2 >=8
					LSmenserro	= LSmenserro+"-ESGOTADA CAPAC.ALIQ.."
				CASE ST2 >=4
					LSmenserro	= LSmenserro+"-CANCELAMENTO NAO PERM"
				CASE ST2 >=2
					LSmenserro	= LSmenserro+"-CGC/IE NAO PROG......"
				CASE ST2 >=1
					LSmenserro	= LSmenserro+"-COMANDO NAO EXECUTADO"
			ENDCASE
			LSLSfazx	=	""

			LSpapel 	= ""
			DO CASE
				CASE ST1 >= 64
					LSpapel = "TROCAR PAPEL......"
			ENDCASE
			*********************************************************
		OTHERWISE
			LSstatus = space(128)
			LSsttimp = space(128)
	ENDCASE

	SHOW GET LSseq	
	SHOW GET LSstat
	SHOW GET LStransacao
	SHOW GET LSescape
	SHOW GET LSreducao
	SHOW GET LSliq
	SHOW GET LSbruto
	SHOW GET LSerro
	SHOW GET LSmenserro
	SHOW GET LSfazx
	SHOW GET LSpapel
RETURN(LSstatus+LSmenserro)



FUNCTION ECFmapa				&& MAPA RESUMO DE CAIXA
	PARAMETER LSmarca, LNecf, LSreducao

	PRIVATE LSalias, LFmapa
	LSalias = ALIAS()
	LFmapa  = .F.
	IF !USED("mapaecf")
		LFmapa = .T.
		IF ! NetUse("mapaecf")
			SELE &LSalias
			return(.F.)
		ENDIF
	ENDIF
	
	DO CASE
		CASE LSmarca = "SWEDA"
			m.ecf 			= 1 			&& NUM. DO ECF
		
			******* INTERPRETACAO DA LEITURA DOS TOTAIS **********
*------------------------------------------>> tipo=1 Tot. da trib=1. 17.00
			=FWRITE(LNecf,chr(27)+".271}")
			
			LSstatus = FREAD(LNecf,128)
			
			m.gt_final		= INT(VAL(SUBS(LSSTATUS,22,15)))/100
												&& Grande Total final
			m.cancela	 	= INT(VAL(SUBS(LSstatus,073,12)))/100
												&& Total de Canc
			m.desconto	 	= INT(VAL(SUBS(LSstatus,093,12)))/100
												&& Total de Desc
			m.ctrreducao 	= INT(VAL(SUBS(LSstatus,041,44)))/100
												&& N╖ de redu┤Дes
			m.tot_liq		= INT(VAL(SUBS(LSstatus,105,12)))/100
												&& total liquido do dia
			m.gt_inicial    = m.gt_final - m.tot_liq
												&& Grande Total inicial
			
*------------------------------------------>> tipo=2 Tot. da trib=1. 17.00
			
			=FWRITE(LNecf,chr(27)+".272}")			
			LSstatus 		= FREAD(LNecf,128)		
	        LSidenttrib1	= SUBS(LSstatus,90,3)	
			m.vlrisent		= VAL(SUBS(LSstatus,14,12))	
			m.vlrnaoincide	= VAL(SUBS(LSstatus,26,37))
			m.vlrsubst		= VAL(SUBS(LSstatus,38,12))
	        m.bs_icm17		= VAL(SUBS(LSstatus,93,12))	
			
*------------------------------------------>> tipo=3 Tot. da trib=2. 05.00
			=FWRITE(LNecf,chr(27)+".273}")			
			LSstatus 		= FREAD(LNecf,128)			
	        LSidenttrib2	= SUBS(LSstatus,02,3)
            m.bs_icm5		= VAL(SUBS(LSstatus,05,12))	
			
*------------------------------------------>> tipo=3 Tot. da trib=3. 07.00
            =FWRITE(LNecf,chr(27)+".273}")			
			LSstatus 		= FREAD(LNecf,128)			
	        LSidenttrib3	= SUBS(LSstatus,17,3)
            m.bs_icm7		= VAL(SUBS(LSstatus,20,12))	
			
*------------------------------------------>> tipo=3 Tot. da trib=4. 12.00
            =FWRITE(LNecf,chr(27)+".273}")			
			LSstatus 		= FREAD(LNecf,128)			
	        LSidenttrib4	= SUBS(LSstatus,32,3)
            m.bs_icm12		= VAL(SUBS(LSstatus,35,12))	
			
*------------------------------------------>> tipo=3 Tot. da trib=5. 25.00
            =FWRITE(LNecf,chr(27)+".273}")				
			LSstatus 		= FREAD(LNecf,128)			
	        LSidenttrib5	= SUBS(LSstatus,47,3)   	
	        m.bs_icm12		= VAL(SUBS(LSstatus,50,12))	
			
*------------------------------------------>> tipo=9 Servi┤os
            =FWRITE(LNecf,chr(27)+".279}")			
			LSstatus 		= FREAD(LNecf,128)			
	        LSidenttrib9	= SUBS(LSstatus,52,4)
			m.cto_inicio	= SUBS(LSstatus,108,04)	    && Cupom Inicial
			m.cto_fim	 	= SUBS(LSstatus,108,04)		&& Cupom Final ??
            m.vlrservico	= INT(VAL(SUBS(LSstatus,56,12)))/100
			
*------------------------------------------>> gt_final = tot. liquido do dia
            =FWRITE(LNecf,chr(27)+".271}")			
			LSstatus 		= FREAD(LNecf,128)	
*           m.gt_final		= VAL(SUBS(LSstatus,105,12))
			
			m.vlrcontab     = m.gt_final - m.gt_inicial - ;
							  m.desconto - m.cancela
			
			IF LSreducao 	= "FAZ REDUCAO"
				=ECFz_letura(wp_TIPOECF,LNecf,wp_dtoper)
			ENDIF
			
		CASE LSmarca = "BEMATEC"
			Linha1  = Chr(27) + Chr(251) + "35|14|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
			LSstatus 		= fread(LNecf,3)
			m.ecf 			= INT(VAL(fread(LNecf,4)))		&& NUM. DO ECF
			
			Linha1  		= Chr(27) + Chr(251) + "62|55|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
			LSstatus 		= fread(LNecf,5)
			
			m.gt_inicial 	= INT(VAL(fread(LNecf,18))) / 100
          	
			LSstatus 		= fread(LNecf,548)				&& DESCARTE
			m.cto_inicio 	= INT(VAL(fread(LNecf,6))) + 1	&& CUPOM INICIAL
	*----------------------------------------------------------------------*
			Linha1  = Chr(27) + Chr(251) + "27|" + Chr(27)
			= FWrite(LNecf, Linha1, Len(Linha1))
			LSstatus 		= fread(LNecf,3)
			m.bs_icm17		= INT(VAL(fread(LNecf,14))) / 100
			m.vlrservico	= INT(VAL(fread(LNecf,14))) / 100
			m.bs_icm7		= INT(VAL(fread(LNecf,14))) / 100
			m.bs_icm12		= INT(VAL(fread(LNecf,14))) / 100
			m.bs_icm25		= INT(VAL(fread(LNecf,14))) / 100
			LSstatus 		= fread(LNecf,154)
			
			m.vlrisent		= INT(VAL(fread(LNecf,14))) / 100
			m.vlrnaoincide	= INT(VAL(fread(LNecf,14))) / 100
			m.vlrsubst		= INT(VAL(fread(LNecf,14))) / 100
			
			Linha1  		= Chr(27) + Chr(251) + "35|04|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
			LSstatus 		= fread(LNecf,3)
			m.cancela	 	= INT(VAL(fread(LNecf,14))) / 100
			
			Linha1  		= Chr(27) + Chr(251) + "35|05|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
			LSstatus 		= fread(LNecf,3)
			m.desconto	 	= INT(VAL(fread(LNecf,14))) / 100
			
			Linha1  		= Chr(27) + Chr(251) + "35|09|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
			LSstatus 		= fread(LNecf,3)
			m.ctrreducao 	= INT(VAL(fread(LNecf,4)))
	*----------------------------------------------------------------*
			IF LSreducao 	= "FAZ REDUCAO"
				=ECFz_letura(wp_TIPOECF,LNecf,wp_dtoper)
			ENDIF
	*----------------------------------------------------------------*
			Linha1  		= Chr(27) + Chr(251) + "62|55|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
			LSstatus 		= fread(LNecf,5)
			m.gt_final	 	= INT(VAL(fread(LNecf,18))) / 100
			
			m.vlrcontab     = m.gt_final - m.gt_inicial - ;
							  m.desconto - m.cancela
			LSstatus 		= fread(LNecf,548)				&& DESCARTE
			m.cto_fim	 	= INT(VAL(fread(LNecf,6))) - 1	&& CUPOM INICIAL
	*----------------------------------------------------------------*
	ENDC	
	SELE mapaecf
	SET ORDER TO TAG mapa
	m.empresa 	= 	wp_empresa
	m.data		=	wp_dtoper
	
	*>>>>>>>>>>>>>>>>> LER ALIQUOTA
	* GRAVACAO PADRAO
	*-------------------------------------------------------
	m.aliquota = 17
	m.base_aliq= m.bs_icm17
	SEEK STR(m.empresa,3)+DTOS(m.data)+STR(m.ecf,4)+STR(m.aliquota,5,2)
	IF FOUND()
		=EDITHAND("REGRAVA")
 	 ELSE
		=EDITHAND("SAVE")
	ENDIF	
	STORE 0 TO CTO_INICIO ,CTO_FIM, GT_FINAL, GT_INICIAL, DESCONTO, ;
				CANCELA, VLRCONTAB,VLRISENT,VLRSUBST,VLRSERVICO,;
				VLROUTRO,CTRREDUCAO
	IF m.bs_icm7 > 0
		m.aliquota = 7
		m.base_aliq= m.bs_icm7
		SEEK STR(m.empresa,3)+DTOS(m.data)+STR(m.ecf,4)+STR(m.aliquota,5,2)
		IF FOUND()
			=EDITHAND("REGRAVA")
		ELSE
			=EDITHAND("SAVE")
		ENDIF	
	ENDIF
	
	IF m.bs_icm12 > 0
		m.aliquota = 12
		m.base_aliq= m.bs_icm12
		SEEK STR(m.empresa,3)+DTOS(m.data)+STR(m.ecf,4)+STR(m.aliquota,5,2)
		IF FOUND()
			=EDITHAND("REGRAVA")
		ELSE
			=EDITHAND("SAVE")
		ENDIF	
	ENDIF
	
	IF m.bs_icm25 > 0
		m.aliquota = 25
		m.base_aliq= m.bs_icm25
		SEEK STR(m.empresa,3)+DTOS(m.data)+STR(m.ecf,4)+STR(m.aliquota,5,2)
		IF FOUND()
			=EDITHAND("REGRAVA")
		ELSE
			=EDITHAND("SAVE")
		ENDIF	
	ENDIF
	IF LFmapa   		&& .t. =>  DEVE SER FECHADA NA SAIDA
		=UP_fecha("mapaecf")
	ENDIF
	SELE &LSalias
RETURN(.T.)


PROC LIXO

	LSstatus 		= fread(LNecf,548)				&& DESCARTE
	m.cto_fim	 	= INT(VAL(fread(LNecf,6))) - 1	&& CUPOM INICIAL
	*------------------------------------------------------------------*
	SELE mapaecf
	SET ORDER TO TAG mapa
	m.empresa 	= 	wp_empresa
	m.data		=	wp_dtoper


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX5WU           m.nro_swe WHEN                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   30   ╨
*       ╨ Variable:            m.nro_swe                          ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      1                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx5wu     &&  m.nro_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX5XH           m.nro_swe VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   30   ╨
*       ╨ Variable:            m.nro_swe                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      2                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx5xh     &&  m.nro_swe VALID
#REGION 1
A=STR(INT(ECFnrocupom(wp_TIPOECF,LNecf)),6)
WAIT WINDOW "Nro Cupom : "+A
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX5YI           m.ST_swe WHEN                      ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   31   ╨
*       ╨ Variable:            m.ST_swe                           ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      3                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx5yi     &&  m.ST_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX5Z4           m.ST_swe VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   31   ╨
*       ╨ Variable:            m.ST_swe                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      4                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx5z4     &&  m.ST_swe VALID
#REGION 1
LSstatus = ""
DO CASE
	CASE wp_TIPOECF = "SWEDA"
		=ECFstatus(wp_TIPOECF,LNecf)
	CASE wp_TIPOECF = "BEMATEC"
		     Linha1 = Chr(27) + Chr(251) + "19|" + Chr(27)
			=FWrite(LNecf, Linha1, Len(Linha1))
			=ECFstatus(wp_TIPOECF,LNecf)
ENDCASE
WAIT WINDOW " <ENTER> "
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX60D           m.utili_swe WHEN                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   32   ╨
*       ╨ Variable:            m.utili_swe                        ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      5                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx60d     &&  m.utili_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX60Z           m.utili_swe VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   32   ╨
*       ╨ Variable:            m.utili_swe                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      6                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*

FUNCTION _07p0mx60z     &&  m.utili_swe VALID
#REGION 1
DO OBJ_MENS.SPR WITH "    Esta opcao nao esta disponibilizada..."

RETURN


LSmsg  = "Confirma Execucao de Utilit═rios ? "
IF !fox_alert(LSmsg)
	RETURN
ENDIF
wp_msg = 'Utilitarios SWEDA...'
LNusuario = nUsr
BTMP   =  'usuario.usuario = LNusuario '
LNusr_ret = 0
DO obj_prmt.SPR WITH   wp_msg , Btmp
IF LNusr_ret = 0
	RETURN
ENDIF
DO CASE
	CASE wp_TIPOECF = "SWEDA"
		!\FPD26\BASE\SWEDA\IFESC97 /N
	CASE wp_TIPOECF = "BEMATEC"
		!C:\BEMATEC\DFI2
ENDCASE
=upapaga()
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX645           m.OK_btn WHEN                      ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   42   ╨
*       ╨ Variable:            m.OK_btn                           ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      7                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx645     &&  m.OK_btn WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX64W           m.OK_btn VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   42   ╨
*       ╨ Variable:            m.OK_btn                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      8                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx64w     &&  m.OK_btn VALID
#REGION 1
CLEAR GETS
CLEAR READ
isediting = .f.
RETURN .T.

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX661           m.cft_btn WHEN                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   43   ╨
*       ╨ Variable:            m.cft_btn                          ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      9                                  ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx661     &&  m.cft_btn WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX66O           m.cft_btn VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   43   ╨
*       ╨ Variable:            m.cft_btn                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      10                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx66o     &&  m.cft_btn VALID
#REGION 1
CLEAR GETS
CLEAR READ
isediting = .f.
CLEAR TYPEAHEAD
CLEAR TYPEAHEAD
ON KEY
KEYBOARD CHR(27)
LFretorno = .f.  && CASO SEJA CANCELADO VOLTA .F.
RETURN .T.

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX681           m.LX_swe WHEN                      ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   46   ╨
*       ╨ Variable:            m.LX_swe                           ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      11                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx681     &&  m.LX_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX68N           m.LX_swe VALID                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   46   ╨
*       ╨ Variable:            m.LX_swe                           ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      12                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx68n     &&  m.LX_swe VALID
#REGION 1
SELECT empresa
SET ORDER TO TAG empresa
SEEK wp_empresa				&& EMPRESA OPERADORA DO SISTEMA
IF empresa.FLAGIMPNF <> 4 OR empresa.FLAGIMPCPM <> 4
	IF empresa.FLAGIMPNF <> 4
		LSnronf = STR(empresa.nota,6)
		DO OBJ_MENS.SPR WITH "   ATENCAO !!! " +CHR(13)+CHR(13)+;
			" O Faturamento Anterior Gerou a Capa da NF. "+LSnronf+;
			" mas nao Concluiu com a impressao. CANCELE A NF."+LSnronf+;
			" e CANCELE O FORMULARIO P/ MANTER SEQUENCIA NUMERACAO"
	ELSE
		LSnronf    = empresa.ult_cupom 						 				
		IF LSnronf < 1000000
			LSnronf = LSnronf + 1000000
		ENDIF
		LSnronf = STR(LSnronf,6)
		DO OBJ_MENS.SPR WITH "   ATENCAO !!! " +CHR(13)+CHR(13)+;
			" O Faturamento Anterior Gerou a Capa do REGISTRO DE CUPOM "+;
			" [NF.] Numero "+LSnronf+;
			" mas nao Concluiu com a impressao. CANCELE O REGISTRO"+LSnronf+;
			" Para Proceguir."
	ENDIF
	sele orcament
	RETURN
ENDIF
sele orcament
=ECFx_letura(wp_TIPOECF,LNecf)
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6AF           m.fatvend_swe WHEN                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   47   ╨
*       ╨ Variable:            m.fatvend_swe                      ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      13                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx6af     &&  m.fatvend_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6B1           m.fatvend_swe VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   47   ╨
*       ╨ Variable:            m.fatvend_swe                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      14                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
*---------------------------------------------------------*
FUNCTION _07p0mx6b1     &&  m.fatvend_swe VALID
#REGION 1
=W_DEFPROC("NOTA.SPR")
=NFrot_fat(LSchamada,"EFETIVAR FATURAMENTO")
*---------------------------------------------------------*
ACTIVATE WINDOWS OBJ_ECF TOP
SHOW WINDOW OBJ_ECF TOP


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6CT           m.canc_swe WHEN                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   48   ╨
*       ╨ Variable:            m.canc_swe                         ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      15                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx6ct     &&  m.canc_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6DO           m.canc_swe VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   48   ╨
*       ╨ Variable:            m.canc_swe                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      16                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx6do     &&  m.canc_swe VALID
#REGION 1
	PRIVATE LSdbant,VLleitura,VLlerfim,VLcompara,VLchvlimi, LNregvolta
	PRIVATE LStipo,LNnf, LNnroNF
	******>>>> INICIO CONTROLE ARQUIVOS
	*>> parametros repassados a btn_val
	VLleitura = "STR(wp_empresa,3)"
                         * repassa chave de leitura p/ btn_val
	VLlerfim  = "STR(wp_empresa+1,3)"
           * repassa chave de leitura p/ btn_val (POSICAO FINAL + 1 REG)

	VLcompara = "nota.empresa = wp_empresa "
                         * repassa chave de comparacao p/ btn_val
	VLchvlimi = "STR(wp_empresa,3)"
	*-----------------------------------------------------------------*
	LSdbant = ALIAS()
	SELE nota
	SET ORDER TO TAG data
	SET NEAR ON
	SEEK VLlerfim
	ON KEY LABEL ESCAPE
	DO loc_dlog WITH .T.,Vlcompara, VLchvlimi,.F.,.F., .F.
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	SET NEAR OFF

	IF LASTKEY() = 27
		SELE orcament
	    RETURN .F.
	ENDIF


	LNnota = nota.nota

**	DO OBJ_ECF2.SPR WITH LNnota	&& PARA INFORMAR O NUMERO DOC P/ CANCELAR

	IF LNnota = 0
	   SELE orcament
	   RETURN
	ENDIF
    LScp1 = STR(LNnota,7)

	wp_msg = "Confirma Solicitacao de Cancelamento p/ "+LScp1
	IF !fox_alert(wp_msg)
	   SELE orcament
	   RETURN
	ENDIF
	wp_msg = 'Informe Seu Codigo e sua Senha p/ CANCELAR..'
	LNusuario = nUsr
	BTMP   =  'usuario.usuario = LNusuario '
	LNusr_ret = 0
	DO obj_prmt.SPR WITH   wp_msg , Btmp
	IF LNusr_ret =  0
	   WAIT WINDOW "Cancelamento nao Efetuado.....<ENTER>"
	   SELE orcament
	   RETURN
	ENDIF

	SELE nota
	SET ORDER TO TAG nota
	SEEK STR(wp_empresa,3)+STR(LNnota,7)
	IF !FOUND()
	   WAIT WINDOW ;
	   "Cancelamento no iniciado. Nao Localizou Reg. no Sistema .<ENTER>"
	   SELE orcament
	   RETURN
	ENDIF

	SELE empresa
	SEEK wp_empresa
	IF !REGLOCK(.T.)
	   WAIT WINDOW ;
	   "Registro Empresa nao Pode ser Bloq. Tente Novamente.<ENTER>"
	   SELE orcament
	   RETURN
	ENDIF
		
		***<<<<<<<<<<<<<<  MONTA NUMERO DE SISTEMA P/ CUPOM >>>>>>>>***
	DO CASE
		CASE LNnota > 999999 OR (nota.cupom > 0 AND nota.tipo <> "CPM")
						&& > 999999 => SOLICITOU CANCELAMENTO DE CUPOM
						&& > 0      => SOLICITOU CANCELAMENTO DE NOTA/CUPOM

			LNcupom = INT(ECFnrocupom(wp_TIPOECF,LNecf))
			IF LNcupom = 0
	    		DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+chr(13)+;
				   "  A ECF esta Retornando Numero de CUPOM = ZERO." +;
				   "Verifique <STATUS>. Verifique <Numero do Cupom>. "+;
				   "Verifique <RESET>. Se Persistir Contacte SUPORTE."
			    SELE orcament
	   			RETURN
			ENDIF

			SELE nota
			IF nota.cupom <> LNcupom
			   LScp1 = STR(LNnota,7)
			   LScp2 = STR(nota.cupom,7)
			   LScp3 = STR(LNcupom,7)
			   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				   "      O numero de DOCUMENTO ["+LScp1+;
				   "] informado p/ cancelamento "+;
				    "esta relacionado ao CUPOM ["+LScp2+;
				    " ] sendo que o ultimo CUPOM localizado pelo "+;
				    "sistema e  ["+LScp3+"]"+;
				    chr(13)+"   Verifique os dados e tente novamente."
			   SELE orcament
			   RETURN
			ENDIF
			IF !REGLOCK(.T.)
			   WAIT WINDOW ;
			   "Reg. Cupom Nao Pode ser Bloqueado Para Cancelamento.<ENTER>"
			   SELE orcament
			   RETURN
			ENDIF
			************************************************	
			LSstatus=ECFcanccpm(wp_TIPOECF,LNecf)
			IF SUBS(LSstatus,7,1) = "E"
			   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				   "      A impressora fiscal nao acatou o cancelamento."+;
				   "Repita o processo e se persistir a negacao entre "+;
				   " em contato com suporte informando o menssagem : "+;
				    LSstatus
			   SELE orcament
			   RETURN
			ENDIF			
			CLEAR TYPEAHEAD
			SELE  NOTA
			SCATTER MEMVAR
			*-----------------------------------------------------------*
			=W_DEFPROC("nota.spr")
			=NFcancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
			*-----------------------------------------------------------*
			***********   LIBERAR STATUS DE PROCESSO EM EMPRESA *******
			SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
			REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
			REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
			*************************************************************
			UNLOCK ALL
		    LScp1 = STR(LNnota,7)
		    DO OBJ_MENS.SPR WITH ;
		    	   "    OK !! " + CHR(13)+CHR(13)+;
				   "    Cumpom cancelado na ECF e no REGISTRO "+chr(13)+;
				   " [ "+LScp1+" ]"

		OTHERWISE			&& SOLICITOU CANCELAMENTO DE NOTA

			SELE nota
			SET ORDER TO TAG nota
			SEEK STR(wp_empresa,3)+STR(LNnota,7)
			IF nota.data <> wp_dtoper
			   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
				   "      A Nota Fiscal informada para cancelamento "+;
				   "nao pertence a data de hoje. Esta operacao so "+;
				   " e permitida em caso de intervencao do suporte."

				wp_msg = 'Usuario Suporte...'
				BTMP   =  'usuario.retroacao = "S"'
				LNusr_ret = 0
				DO obj_prmt.SPR WITH   wp_msg , Btmp
				IF LNusr_ret =  0
				   SELE orcament
				   RETURN
				ENDIF
			ENDIF	
			SCATTER MEMVAR
			*-----------------------------------------------------------*
			=W_DEFPROC("nota.spr")
			=NFcancFatura((nota.empresa),(nota.nota),"AUTOMATICO")
			*-----------------------------------------------------------*
			SELE empresa 			&& DEVE ESTA BLOQ. FUNCINA COM SINALEIRO
			REPLACE FLAGIMPNF 	WITH 4	&& LIBERA FATURAMENTO
			REPLACE FLAGIMPCPM 	WITH 4	&& LIBERA FATURAMENTO
			*************************************************************
			UNLOCK ALL
		    SELE orcament
			RETURN
	ENDCASE
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6M4           m.eminfcp_swe WHEN                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   49   ╨
*       ╨ Variable:            m.eminfcp_swe                      ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      17                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx6m4     &&  m.eminfcp_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6MP           m.eminfcp_swe VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   49   ╨
*       ╨ Variable:            m.eminfcp_swe                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      18                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
	*--------------------------------------------------------*
FUNCTION _07p0mx6mp     &&  m.eminfcp_swe VALID
#REGION 1
	=W_DEFPROC("NOTA.SPR")
	do NFImpCopia
	*--------------------------------------------------------*
	SELECT orcament
	UNLOCK ALL
	ACTIVATE WINDOW OBJ_ECF TOP
	SHOW WINDOW OBJ_ECF TOP
RETURN







*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6NW           m.visual_swe WHEN                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   50   ╨
*       ╨ Variable:            m.visual_swe                       ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      19                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx6nw     &&  m.visual_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6OI           m.visual_swe VALID                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   50   ╨
*       ╨ Variable:            m.visual_swe                       ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      20                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx6oi     &&  m.visual_swe VALID
#REGION 1
	PRIVATE LSdbant,VLleitura,VLlerfim,VLcompara,VLchvlimi, LNregvolta
	PRIVATE LStipo,LNnf, LNnroNF
	******>>>> INICIO CONTROLE ARQUIVOS
	*>> parametros repassados a btn_val
	VLleitura = "STR(wp_empresa,3)"
                         * repassa chave de leitura p/ btn_val
	VLlerfim  = "STR(wp_empresa+1,3)"
           * repassa chave de leitura p/ btn_val (POSICAO FINAL + 1 REG)

	VLcompara = "nota.empresa = wp_empresa "
                         * repassa chave de comparacao p/ btn_val
	VLchvlimi = "STR(wp_empresa,3)"
	*-----------------------------------------------------------------*
	LSdbant = ALIAS()
	SELE nota
	SET ORDER TO TAG data
	SET NEAR ON
	SEEK VLlerfim
	ON KEY LABEL ESCAPE
	DO loc_dlog WITH .T.,Vlcompara, VLchvlimi,.F.,.F., .F.
	ON KEY LABEL ESCAPE KEYBOARD "{BACKTAB}"
	SET NEAR OFF

	SELE orcament
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6QF           m.redZ_swe WHEN                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   51   ╨
*       ╨ Variable:            m.redZ_swe                         ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      21                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx6qf     &&  m.redZ_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6R1           m.redZ_swe VALID                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   51   ╨
*       ╨ Variable:            m.redZ_swe                         ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      22                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx6r1     &&  m.redZ_swe VALID
#REGION 1
	DO OBJ_ALER.SPR WITH ;
   "Atencao !!!!!!" +CHR(13)+;
   "Ao executar a REDU─AO-Z voce estara encerrando as "+;
   " opera┤Дes  do  dia. Tecle <ENTER> e em seguida confirme."

	LSmsg  = "1╖ Confirma┤ao de LEITURA-Z em "+dtoc(wp_dtoper)+;
					". Confirma ? "
	IF !fox_alert(LSmsg)
		RETURN
	ENDIF
	LSmsg  = "2╖ Confirma┤ao de LEITURA-Z em "+dtoc(wp_dtoper)+;
					". Confirma ? "
					
	IF !fox_alert(LSmsg)
		RETURN
	ENDIF
	wp_msg = 'Encerramento das Vendas...'
	LNusuario = nUsr
	BTMP   =  'usuario.usuario = LNusuario '
	LNusr_ret = 0
	DO obj_prmt.SPR WITH   wp_msg , Btmp
	IF LNusr_ret = 0
		RETURN
	ENDIF
	DO CASE
		CASE wp_TIPOECF = "SWEDA"
			LFtmp = ECFmapa(wp_TIPOECF,LNecf,"FAZ REDUCAO")	
							* MAPA REZUMO DE CAIXA
			IF !LFtmp
				 LSmsg = ;
			 		"Nao Foi Possivel Gerar o Mapa Resumo de Caixa."+;
				 	CHR(13)+chr(13)+;
			 		"Prossegue REDUCAO Z e faz Lancamento Manual no Mapa ?"
				 IF fox_alert(lsmsg)
					****************************************
					=ECFz_letura(wp_TIPOECF,LNecf,wp_dtoper)	
							* REDUCAO SEM O MAPA RESUMO
					****************************************
				 ENDIF
			ENDIF		
		CASE wp_TIPOECF = "BEMATEC"
			LFtmp = ECFmapa(wp_TIPOECF,LNecf,"FAZ REDUCAO")	
							* MAPA REZUMO DE CAIXA
			IF !LFtmp
				 LSmsg = ;
			 		"Nao Foi Possivel Gerar o Mapa Resumo de Caixa."+;
				 	CHR(13)+chr(13)+;
			 		"Prossegue REDUCAO Z e faz Lancamento Manual no Mapa ?"
				 IF fox_alert(lsmsg)
					****************************************
					=ECFz_letura(wp_TIPOECF,LNecf,wp_dtoper)	
							* REDUCAO SEM O MAPA RESUMO
					****************************************
				 ENDIF
			ENDIF		
	ENDCASE
RETURN




*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6UI           m.fchabrt_swe WHEN                 ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   52   ╨
*       ╨ Variable:            m.fchabrt_swe                      ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      23                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx6ui     &&  m.fchabrt_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6V4           m.fchabrt_swe VALID                ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   52   ╨
*       ╨ Variable:            m.fchabrt_swe                      ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      24                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx6v4     &&  m.fchabrt_swe VALID
#REGION 1
	PRIVATE LNnrocp, LFcancela
	LNnrocp=(ECFnrocupom(wp_TIPOECF,LNecf))

	IF LNnrocp = 0
	    DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+chr(13)+;
		   "  A ECF esta Retornando Numero de CUPOM = ZERO." +;
		   "Verifique <STATUS>. Verifique <Numero do Cupom>. "+;
		   "Verifique <RESET>. Se Persistir Contacte SUPORTE."
	   SELE orcament
	   RETURN
	ENDIF


	SELE nota
	SET ORDER TO TAG data
	SET NEAR ON
	SEEK STR(wp_empresa+1,3)
	SET NEAR OFF
	LFcancela = .t.
	SKIP -1
	DO WHILE !BOF() AND nota.empresa = wp_empresa
		IF nota.cupom = LNnrocp
			LFcancela = .f.		&& NAO PODE CANCELAR
		    LScp1 = STR(nota.nota,7)
			LScp2 = STR(nota.cupom,7)
		    DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+;
				   "  O numero de CUPOM  ["+LScp2+;
				   "] informado pela ECF   "+;
				    "esta relacionado ao FATURAMENTO NF/REGISTRO ["+LScp1+;
				    " ] " +CHR(13)+;
				    " ESTA OPCAO SO FECHA O CUPOM QUANDO NAO EXISTE"+;
				    " REGISTRO. NESTE CASO CANCELE O "+;
				    " FATURAMENTO E CUPOM SERA CANCELADO."
			EXIT
		ENDIF
		* VOLTA ATE QUATRO CUPONS PARA COMPROVAR NAO HAVER VINCULO
		IF nota.cupom > 0 AND  nota.cupom < LNnrocp - 4
			EXIT		
		ENDIF
		* VOLTA ATE DOIS DIAS PARA COMPROVAR NAO HAVER VINCULO
		IF nota.data < wp_dtoper - 2
			EXIT		
		ENDIF
		SKIP -1
	ENDDO
	if !LFcancela
	   SELE orcament
	   RETURN
	ENDIF

	LScp1 = STR(LNnrocp,7)
	wp_msg = "Confirma Solicitacao de Cancelamento p/ "+LScp1
	IF !fox_alert(wp_msg)
	   SELE orcament
	   RETURN
	ENDIF
	LSstatus=ECFcanccpm(wp_TIPOECF,LNecf)
	IF SUBS(LSstatus,7,1) = "E"
	   DO OBJ_MENS.SPR WITH "    ATENCAO!!"+CHR(13)+CHR(13)+;
	   	"      A impressora fiscal nao acatou o cancelamento."+;
	   	"Repita o processo e se persistir a negacao entre "+;
	   	" em contato com suporte informando o menssagem : "+;
	    LSstatus
	   	SELE orcament
	 	RETURN
	ENDIF			
    DO OBJ_MENS.SPR WITH ;
   	   "    OK !! " + CHR(13)+CHR(13)+;
	   "    Cumpom CANCELADO na ECF  [ "+LScp1+" ]"
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6YM           m.forma_swe WHEN                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   53   ╨
*       ╨ Variable:            m.forma_swe                        ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      25                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx6ym     &&  m.forma_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX6Z8           m.forma_swe VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   53   ╨
*       ╨ Variable:            m.forma_swe                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      26                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx6z8     &&  m.forma_swe VALID
#REGION 1
=ECFprgpgt(wp_TIPOECF,LNecf)
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX700           m.reset_swe WHEN                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   54   ╨
*       ╨ Variable:            m.reset_swe                        ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      27                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx700     &&  m.reset_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX70M           m.reset_swe VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   54   ╨
*       ╨ Variable:            m.reset_swe                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      28                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx70m     &&  m.reset_swe VALID
#REGION 1
LSstatus = ""
DO CASE
	CASE wp_TIPOECF = "SWEDA"
		LSstatus=ECFstatus(wp_TIPOECF,LNecf)
	CASE wp_TIPOECF = "BEMATEC"
	     Linha1 = Chr(27) + Chr(251) + "70|" + Chr(27)
		=FWrite(LNecf, Linha1, Len(Linha1))
		LSstatus=ECFstatus(wp_TIPOECF,LNecf)
ENDCASE
RETURN


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX71P           m.mapaI_swe WHEN                   ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   55   ╨
*       ╨ Variable:            m.mapaI_swe                        ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      29                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx71p     &&  m.mapaI_swe WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX72A           m.mapaI_swe VALID                  ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   55   ╨
*       ╨ Variable:            m.mapaI_swe                        ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      30                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx72a     &&  m.mapaI_swe VALID
#REGION 1
LDdtinicio   = wp_dtoper
DO OBJ_DAT2.SPR WITH LDdtinicio
m.dtprocesso = LDdtinicio
m.empresa	 = wp_empresa

=W_DEFPROC("rotrelat.SPR")
DO UR206B WITH  m.empresa,m.dtprocesso
SELE orcament
SHOW WINDOW OBJ_ECF TOP


*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX73C           m.lermemo WHEN                     ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   56   ╨
*       ╨ Variable:            m.lermemo                          ╨
*       ╨ Called By:           WHEN Clause                        ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      31                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx73c     &&  m.lermemo WHEN
#REGION 1
ON KEY LABEL ENTER
RETURN(.t.)

*       жддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╥
*       ╨                                                         ╨
*       ╨ _07P0MX73Y           m.lermemo VALID                    ╨
*       ╨                                                         ╨
*       ╨ Function Origin:                                        ╨
*       ╨                                                         ╨
*       ╨ From Platform:       MS-DOS                             ╨
*       ╨ From Screen:         OBJ_ECF,     Record Number:   56   ╨
*       ╨ Variable:            m.lermemo                          ╨
*       ╨ Called By:           VALID Clause                       ╨
*       ╨ Object Type:         Push Button                        ╨
*       ╨ Snippet Number:      32                                 ╨
*       ╨                                                         ╨
*       сддддддддддддддддддддддддддддддддддддддддддддддддддддддддд╫
*
FUNCTION _07p0mx73y     &&  m.lermemo VALID
#REGION 1
LFtmp = ECFlermemo(wp_TIPOECF,LNecf)	
SELE orcament
SHOW WINDOW OBJ_ECF TOP
