SET EXCL OFF
SET TALK ON
ON ERROR
SET DELE ON

SET EXCL OFF


*=DuplComData()
=DELDuplSemData()


RETURN

function DELDuplSemData

	CLOSE DATA

*	use Q:\scgc\central\itemmov

*    USE O:\SCGC2013\CENTRAL\ITEMMOV 


	use Q:\scgc\CENTRAL\itemmov

	SET ORDER TO TAG IT_DA_NOTA 


	GO TOP
	VQUEBRA   = STR(EMPRESA,3)+CODIGO+STR(FAVORECIDO,14)+TIPO+STR(NOTA,7)+SERIE+STR(ORDEM,3)
	SKIP

    CTR = 0
    CTRERRO = 0
    CTRACERTO = 0


	SET STEP ON
	DO WHILE !EOF()

      CTR = CTR + 1 


	  IF VQUEBRA = STR(EMPRESA,3)+CODIGO+STR(FAVORECIDO,14)+TIPO+STR(NOTA,7)+SERIE+STR(ORDEM,3)
*    	 DELETE
	     SKIP
         CTRERRO = CTRERRO + 1 
         LOOP
	  ENDIF

	  VQUEBRA   = STR(EMPRESA,3)+CODIGO+STR(FAVORECIDO,14)+TIPO+STR(NOTA,7)+SERIE+STR(ORDEM,3)

      MSG  = "LIDOS : "+STR(CTR,7)+"-";
             + " DUPLICADOS : "+STR(CTRERRO,7)+"-";
             + " ACERTOS : "+STR(CTRACERTO,7)

      WAIT WINDOW  MSG NOWAIT


	  SKIP  
	ENDDO

RETURN



PROCEDURE TESTE


select ;
   EMPRESA,;
   CODIGO,;
   DATA,;
   HORA,;
   TIPO,;
   NOTA,;
   ORDEM,;
   COUNT(1) AS CTR ;
from ;
   itemmov;
where ;
 ( ;
   data = {05.08.2014};
  or ;
   data = {65.08.2014};
 );
group by ;
   EMPRESA,;
   CODIGO,;
   DATA,;
   HORA,;
   TIPO,;
   NOTA,;
   ORDEM ;
 HAVING CTR > 1 ;
ORDER by ;
   EMPRESA,;
   NOTA;
 INTO TABLE L:\TMP\ITDUPL

SET STEP ON 
SELE ITDUPL
SET RELATION TO ;
    STR(EMPRESA,3);
    +CODIGO;
    +DTOS(DATA);
    +HORA;
    +TIPO+STR(NOTA,7)+STR(ORDEM,3) INTO ITEMMOV
BROWS FIELDS ITEMMOV.NOTA

 
 
RETURN


function DuplComData

	CLOSE DATA

	use q:\scgc\central\itemmov
	SET ORDER TO TAG MOVIMENTO OF Q:\SCGC\CENTRAL\ITEMMOV.CDX


	GO TOP
	VQUEBRA   = STR(EMPRESA,3)+CODIGO+DTOS(DATA)+HORA+TIPO+STR(NOTA,7)+STR(ORDEM,3)
	SKIP

	SET STEP ON
	DO WHILE !EOF()
	  IF VQUEBRA = STR(EMPRESA,3)+CODIGO+DTOS(DATA)+HORA+TIPO+STR(NOTA,7)+STR(ORDEM,3)
    	 DELETE
	     SKIP
	  ENDIF
	  VQUEBRA   = STR(EMPRESA,3)+CODIGO+DTOS(DATA)+HORA+TIPO+STR(NOTA,7)+STR(ORDEM,3)
	  SKIP  
	ENDDO

RETURN
